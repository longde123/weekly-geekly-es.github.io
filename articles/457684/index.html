<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÖ üåÇ üì™ Experiencia en la integraci√≥n de la caja de efectivo de Atol con el comercio propio CRM üëö üîπ üë®üèΩ‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, alrededor de la taquilla en l√≠nea, gran emoci√≥n, el 1 de julio de 2019, el √∫ltimo aplazamiento termina, as√≠ que tuve que lidiar con est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experiencia en la integraci√≥n de la caja de efectivo de Atol con el comercio propio CRM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457684/">  Recientemente, alrededor de la taquilla en l√≠nea, gran emoci√≥n, el 1 de julio de 2019, el √∫ltimo aplazamiento termina, as√≠ que tuve que lidiar con este problema.  Aquellos que tienen 1C u otro sistema especialmente no pueden esforzarse, pero si tienes tu propio sistema auto-escrito, entonces la integraci√≥n con las cajas registradoras en l√≠nea tambi√©n recae sobre tus hombros. <br><br>  Mi experiencia es √∫til para la integraci√≥n con los cajeros autom√°ticos Atol en el modo de intercambio de datos de red, su programa puede enviar datos al servidor web Atol tanto en el host local como en la red local, puede enviarlos incluso desde el navegador AJAX, incluso desde el servidor a trav√©s de CURL, por lo tanto, No importa en qu√© idioma est√© escrito su software corporativo, todo es multiplataforma. <br><a name="habracut"></a><br>  Me he encontrado con la boleter√≠a Atol 30f: es una m√°quina de escribir tan simple con una caja negra (FN), es justo cuando toda la l√≥gica para ordenar est√° en un software externo, y no en el software integrado en el cajero.  Adem√°s, los dispositivos de este tipo son relativamente baratos, en comparaci√≥n con sus hom√≥logos de Android. <br><br>  Tambi√©n me gustar√≠a se√±alar que los "especialistas" de algunas empresas involucradas en el soporte no saben en absoluto que Atoll con la versi√≥n 10 tiene un servidor web incorporado en el controlador que acepta trabajos JSON, adem√°s, este controlador tambi√©n se puede instalar en Linux, a juzgar por Por la cantidad de soluciones preparadas en las frambuesas, puedo suponer que tambi√©n se puede instalar all√≠, en la distribuci√≥n de la d√©cima versi√≥n del controlador est√° presente el instalador para el brazo. <br><br>  El esquema planificado es algo como esto: hay CRM que se ejecuta en el servidor en la red local, se abre desde los navegadores, desde el servidor, los cheques se enviar√°n a PHP a trav√©s de curl e impresos en la caja registradora.  Y la caja en s√≠ est√° conectada a cualquier computadora en Windows en la misma red. <br><br>  Dicen que si no activa el cajero, puede funcionar en modo de impresora e imprimir que el cheque no es v√°lido, pero no pude verificarlo, tuve que hacer ventas y devoluciones de centavo. <br><br>  El controlador de la d√©cima versi√≥n se descarga <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Antes de instalar, debe instalar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Java con</a> la misma profundidad de bits que el controlador; de lo contrario, la casilla de verificaci√≥n del servidor web no estar√° disponible, si instala el controlador KKT de 64 bits, Java x64. <br><br>  Parece que, l√≥gicamente, necesita instalar un controlador de 64 bits en un sistema de 64 bits, pero algunos software de 32 bits no podr√°n trabajar con √©l (como esto se aplica a 1C si es de 32 bits). <br><br><img src="https://habrastorage.org/webt/nf/fn/uk/nffnukvhkzk3za8vpcrn567wygi.png"><br><br>  Al final de la instalaci√≥n hay una marca de verificaci√≥n: para configurar el servidor web, si no estaba instalado, debe ir al navegador en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">127.0.0.1</a> : 16732 / settings, marque la casilla "activar servidor" y guardar. <br><br><img src="https://habrastorage.org/webt/gv/fm/9l/gvfm9lfbrzxyntshlyhn7fmx-pc.png"><br><br><img src="https://habrastorage.org/webt/dy/so/pq/dysopqgomkepetfvn-de5vgdj3q.png"><br><br>  Despu√©s de eso, debe reiniciar el servidor a trav√©s de START-&gt; ATOL-&gt; restart ... <br><br>  Tambi√©n quiero advertirle de inmediato que si inicia el servidor web, las aplicaciones locales no podr√°n acceder al KKT, por mucho tiempo trabajo, instalo el controlador, ejecuto la prueba del controlador KKT, y √©l me dice que el puerto est√° ocupado y eso es todo, llam√≥ al soporte t√©cnico del vendedor local, all√≠ dijeron que no sab√≠amos qu√© hacer, luego sobrecargu√© la computadora diez veces, reinstal√© el controlador, nada ayuda. <br><br>  En general, despu√©s de activar y reiniciar el servidor, y antes de apagarlo y verificar la impresi√≥n de texto sin formato a trav√©s de la utilidad suministrada, o simplemente verificar la conexi√≥n, puede continuar. <br><br>  Este servicio web no tiene ninguna protecci√≥n de contrase√±a, por lo que debe configurar de inmediato el firewall de Windows u otro software para que solo las computadoras necesarias puedan acceder al puerto 16732, en mi caso, este es el servidor en el que se ejecuta CRM. <br><br>  <b>La comunicaci√≥n con el servicio web es generalmente un tema separado, muy interesante ...</b> <br><br><ol><li>  Genere un uuid √∫nico para el trabajo. </li><li>  Enviamos la tarea utilizando el m√©todo POST </li><li>  Estamos ansiando un servicio web, esperando el resultado de la tarea con nuestro UUID, puede ser que durante unos segundos nuestra tarea tenga un estado de espera, o puede ocurrir un error si algo est√° mal en la solicitud ... </li></ol><br>  Y luego dar√© una versi√≥n funcional, es adecuada para situaciones en las que el pago es solo un m√©todo, y no tanto en efectivo y en parte no en efectivo, tambi√©n usa el sistema impositivo predeterminado, el IVA a√∫n no se calcula, quer√≠a agregar el c√≥digo, luego distribuirlo, pero Creo que todav√≠a hay personas que necesitan esta informaci√≥n antes del 1 de julio que despu√©s.  Debo decir de inmediato que la clase necesita refinamiento, mucho trabajo sin procesar, sin errores, todo se hizo en un par de horas sin tener en cuenta la lectura de la documentaci√≥n, este c√≥digo es m√°s como un ejemplo y le aconsejo que estudie la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> con gran detalle y la adapte a sus procesos espec√≠ficos. <br><br><div class="spoiler">  <b class="spoiler_title">c√≥digo php para un ejemplo de trabajo con api (utilizado solo con fines educativos)</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AtolWebDriver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$port=<span class="hljs-string"><span class="hljs-string">"16732"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timeout = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $operator; function __construct($addr=false,$port=false) { if ($addr!==false) $this-&gt;addr=$addr; if ($port!==false) $this-&gt;port=$port; } public function CallAPI($method, $data,$_url="/requests") { $url = "http://".$this-&gt;addr.":".$this-&gt;port.$_url; $curl = curl_init($url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl,CURLOPT_TIMEOUT, $this-&gt;timeout); $headers = ['Content-Type: application/json']; curl_setopt($curl,CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data)); $resp = curl_exec($curl); $data = json_decode($resp,1); $code = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); $res= [$data,$code,$resp]; print_r($res); return $res; } //   public function get_res($uuid) { $ready = false; $cnt=0; $res_url = '/requests/'.$uuid; while (!$ready &amp;&amp; ++$cnt&lt;60) { usleep(500000); // ,     list($res,$code,$resp) = $this-&gt;CallAPI('GET',[],$res_url); $ready = ($res['results'][0]['status'] == 'ready'); if ($ready) return $res; } return false; //    } //  public function add_req($uuid,$req) { return $this-&gt;CallAPI('POST', ['uuid'=&gt;$uuid,'request'=&gt;$req]); } //  id   public function gen_uuid() { return exec('uuidgen -r'); } //      public function atol_task($type,$req=[]) { $req['type'] = $type; $uuid = $this-&gt;gen_uuid(); $req = $this-&gt;add_req($uuid,$req); if ($req[1]!='201') return false; //  $res = $this-&gt;get_res($uuid); //  if ($res===false || !isset($res['results'][0])) return false; return $res['results'][0]; } /*    */ //  public function get_shift_status() { $res = $this-&gt;atol_task('getShiftStatus'); if ($res===false) return false; //closed / opened / expired return $res['result']['shiftStatus']['state']; } //  public function open_shift() { $status = $this-&gt;get_shift_status(); //e ,    if ($status=="expired") $this-&gt;close_shift(); if ($status=="opened") return "    "; $res = $this-&gt;atol_task('openShift',['operator'=&gt;$this-&gt;operator]); } //  public function close_shift() { $status = $this-&gt;get_shift_status(); if ($status=="closed") return "    "; $res = $this-&gt;atol_task('closeShift',['operator'=&gt;$this-&gt;operator]); } public function items_prepare($items) { $res_items = []; $summ = 0; while ($item = array_shift($items)) { $res_item = $item; if (!isset($item['type'])) $res_item['type']="position"; if (isset($item['price']) &amp;&amp; isset($item['quantity'])) { $res_item['amount'] = $item['price']*$item['quantity']; $res_item['tax'] = ['type'=&gt;'none']; $summ+=$res_item['amount']; } $res_items[] = $res_item; } return [$res_items,$summ]; } // sell,  sellReturn public function fiskal($type_op="sell",$items,$pay_type="cash") { $data = []; $data['operator'] = $this-&gt;operator; $data['payments'] = []; list($data['items'],$summ) = $this-&gt;items_prepare($items); //+++       $data['payments'][] = ['type'=&gt;$pay_type,'sum'=&gt;$summ]; $res = $this-&gt;atol_task($type_op,$data); } } //  ip   web-  ,      $atol = new AtolWebDriver('192.168.100.10'); //    $atol-&gt;operator = ['name'=&gt;'.']; //       $items = []; $items[] = ['name'=&gt;' ','price'=&gt;0.7,'quantity'=&gt;1]; $items[] = ['name'=&gt;' ','price'=&gt;0.4,'quantity'=&gt;1]; //  $atol-&gt;open_shift(); //  $atol-&gt;fiskal("sell",$items); sleep(10); // ,     //     , ..    $atol-&gt;fiskal("sellReturn",$items); //     sleep(20); // ,   $atol-&gt;close_shift();</span></span></code> </pre> <br></div></div><br>  Hay algunos defectos aqu√≠ que solucionar√© <br><br><ol><li>  Redondeando fracciones al calcular las cantidades, debe redondear a centavos, de lo contrario puede obtener 1.000000001 o 0.999999999 </li><li>  Con la ortograf√≠a correcta del resto de la l√≥gica del programa, esto generalmente no ocurre, pero durante las pruebas me di cuenta del hecho de que la tarea devolvi√≥ un resultado de error, y estaba esperando que estuviera listo </li></ol><br>  Bueno, en el proceso de implementaci√≥n, tengo miedo de detectar muchos m√°s errores, por ejemplo, si una tarea se cuelga durante mucho tiempo en el estado de espera, entonces es mejor eliminarla de la cola; de lo contrario, las tareas subsiguientes se suspender√°n durante varios minutos, detect√© un problema t√©cnico una vez, no esperaba que se imprimiera y aqu√≠ me siento, pero salt√≥ e imprimi√≥ inmediatamente dos cheques seguidos enviados antes ... <br><br>  En general, es posible recolectar adquisiciones del sitio en el futuro, si no tienen cheques en l√≠nea, hasta que haya decidido qu√© adquisici√≥n atornillar.  Pero la soluci√≥n es, probablemente como una idea para una soluci√≥n, el tiempo dir√° c√≥mo se arraigar√° esta taquilla. <br><br>  <b>Advertencia</b> , para aquellos que leen sin atenci√≥n el art√≠culo y no son muy competentes en el tema de seguridad: <b>este servicio web no tiene cifrado (https), no tiene autorizaci√≥n</b> , incluso si se usa solo en la red local: configure la protecci√≥n para el acceso al puerto. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457684/">https://habr.com/ru/post/457684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457652/index.html">C√≥mo organizar 120,000 fotos y para que no haya pruebas, con diferentes niveles de acceso, para el equipo</a></li>
<li><a href="../457658/index.html">Union MS-11: ¬øUn accidente que no exist√≠a?</a></li>
<li><a href="../457660/index.html">C√≥mo ahorrar $ 58 en 5 minutos: usemos diferentes precios en cada pa√≠s contra los vendedores</a></li>
<li><a href="../457666/index.html">Alternativas a la Raspberry Pi</a></li>
<li><a href="../457680/index.html">Instalaci√≥n m√≠nima de CentOS / Fedora / RedHat</a></li>
<li><a href="../457686/index.html">C√≥mo Sberbank recoge el consentimiento para el procesamiento biom√©trico</a></li>
<li><a href="../457690/index.html">Video paranoico de Yandex.Money metap</a></li>
<li><a href="../457692/index.html">Reflexiones sobre los est√°ndares nacionales de NB-Fi y los sistemas de facturaci√≥n</a></li>
<li><a href="../457694/index.html">Los peligros de usar constantes de varios caracteres</a></li>
<li><a href="../457696/index.html">Los peligros de usar constantes de varios caracteres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>