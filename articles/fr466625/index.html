<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¶ ğŸ˜† âš—ï¸ Aller au-delÃ  du pod dans Kubernetes grÃ¢ce aux journaux de montage ğŸ‘¨ğŸ¼â€âš•ï¸ âš›ï¸ ğŸ…ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : Cette note a Ã©tÃ© rÃ©digÃ©e par un chercheur en sÃ©curitÃ© informatique chez Aqua Security, une sociÃ©tÃ© DevSecOps. Elle est une excellent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aller au-delÃ  du pod dans Kubernetes grÃ¢ce aux journaux de montage</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/466625/"> <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Cette note a Ã©tÃ© rÃ©digÃ©e par un chercheur en sÃ©curitÃ© informatique chez Aqua Security, une sociÃ©tÃ© DevSecOps.</i>  <i>Elle est une excellente illustration des subtilitÃ©s de la configuration de Kubernetes, qu'il est important de toujours garder Ã  l'esprit lorsque vous servez des clusters en production.</i>  <i>Bien sÃ»r, si vous pensez Ã  leur sÃ©curitÃ© ...</i> <br><br><img src="https://habrastorage.org/webt/aw/z0/ej/awz0ejuhbrd7tfaoggoapj86e7y.jpeg"><br><br>  Kubernetes se compose de nombreux composants, et parfois leur combinaison d'une certaine maniÃ¨re conduit Ã  des rÃ©sultats inattendus.  Dans cet article, je montrerai comment un pod lancÃ© avec des privilÃ¨ges root et un rÃ©pertoire <code>/var/log</code> montÃ© d'un nÅ“ud peut <b>Ã©tendre le contenu de l'ensemble du systÃ¨me de fichiers hÃ´te Ã  un</b> utilisateur ayant accÃ¨s Ã  ses journaux.  Nous discuterons Ã©galement des solutions Ã  ce problÃ¨me. <a name="habracut"></a><br><br><h2>  Comment Kubernetes voit les journaux </h2><br>  Vous Ãªtes-vous dÃ©jÃ  demandÃ© comment <code>kubectl logs &lt;pod_name&gt;</code> extrait les journaux du pod?  Qui est responsable de la collecte des grumes dans les conteneurs?  Et comment arrivent-ils sur votre ordinateur? <br><br>  Le diagramme suivant illustre le processus: <br><br><img src="https://habrastorage.org/webt/rc/3j/32/rc3j32co5ems4w2xvpztnqw3bwq.jpeg"><br><br>  Kubelet crÃ©e une structure Ã  l'intÃ©rieur du rÃ©pertoire <code>/var/log</code> sur l'hÃ´te qui reprÃ©sente les pods sur l'hÃ´te.  Il y a un fichier <code>0.log</code> (1) dans le rÃ©pertoire de notre <code>0.log</code> , mais en fait c'est un lien symbolique vers le journal du conteneur situÃ© dans <code>/var/lib/docker/containers</code> .  Tout cela du point de vue de l'hÃ´te. <br><br>  Kubelet ouvre le noeud final <code>/logs/</code> (2), qui fonctionne simplement avec le serveur de fichiers HTTP dans le rÃ©pertoire (3), rendant les journaux disponibles pour les demandes provenant du serveur API. <br><br>  Imaginez maintenant que nous avons dÃ©ployÃ© pod avec <code>hostPath</code> montÃ© dans <code>/var/log</code> .  Un tel pod aura accÃ¨s Ã  tous les fichiers journaux de l'hÃ´te.  Bien que cela soit en soi un problÃ¨me potentiel, nous pouvons franchir la prochaine Ã©tape logique.  Et si nous remplaÃ§ons <code>0.log</code> par un lien symbolique pour ... par exemple, <code>/etc/shadow</code> ? <br><br><pre> <code class="plaintext hljs">â”‚ â”œâ”€â”€ var â”‚ â”œâ”€â”€ logs â”‚ â”‚ â”œâ”€â”€ pods â”‚ â”‚ â”‚ â”œâ”€â”€ default_mypod_e7869b14-abca-11e8-9888-42010a8e020e â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ mypod â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ 0.log -&gt; /etc/shadow â”‚ â”‚ â”‚ â”‚ â”‚ â”‚</code> </pre> <br>  Maintenant, en essayant de tÃ©lÃ©charger les journaux Ã  l'aide des journaux <code>kubectl logs</code> sur la machine cliente, nous obtenons: <br><br><pre> <code class="bash hljs">$ kubectl logs mypod failed to get parse <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>: unsupported <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> format: <span class="hljs-string"><span class="hljs-string">"root:*:18033:0:99999:7:::\n"</span></span></code> </pre> <br>  Kubelet suit le lien et lit le contenu du fichier vers lequel il pointe (il peut s'agir de n'importe quel fichier sur le nÅ“ud). <br><br>  Comme JSON Ã©tait attendu, kubectl s'est Ã©crasÃ© aprÃ¨s la premiÃ¨re ligne, cependant, nous pouvons facilement lire les lignes spÃ©cifiques du fichier <code>shadow</code> en exÃ©cutant la commande avec l' <code>â€“-tail=-&lt;line_number&gt;</code> . <br><br>  C'est incroyable.  Puisque kubelet suit le lien symbolique, vous pouvez utiliser ses privilÃ¨ges root pour lire n'importe quel fichier sur le nÅ“ud, simplement en crÃ©ant un lien symbolique Ã  l'intÃ©rieur du pod. <br><br><h2>  Ã‰chapper au pod </h2><br>  Allons encore plus loin.  Nous savons que lors du dÃ©marrage d'un pod dans Kubernetes, le jeton ServiceAccount y est installÃ©.  Ainsi, si le compte de service permet d'accÃ©der aux journaux, nous pouvons accÃ©der directement aux privilÃ¨ges kubelet et root sur le nÅ“ud. <br><br>  J'ai Ã©crit une preuve de concept (POC) dÃ©montrant ce vecteur d'attaque: <br><br><ul><li>  dÃ©ploiement de pod avec point de montage <code>/var/log</code> ; </li><li>  crÃ©er un lien symbolique vers le rÃ©pertoire racine de l'hÃ´te; </li><li>  lecture de la clÃ© privÃ©e ssh de l'utilisateur sur l'hÃ´te. </li></ul><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vidÃ©o suivante</a> montre deux commandes spÃ©ciales qui s'exÃ©cutent Ã  l'intÃ©rieur d'un pod: <br><br><ul><li>  <code>lsh == ls</code> (sur le systÃ¨me de fichiers hÃ´te); </li><li>  <code>cath == cat</code> (sur le systÃ¨me de fichiers hÃ´te). </li></ul><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Malheureusement, ils n'ont pas corrigÃ© l'insertion de contenu d'asciinema sur le hub, bien que nous ayons dÃ©jÃ  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rÃ©solu</a> ce problÃ¨me, nous sommes donc obligÃ©s Â«d'intÃ©grerÂ» la vidÃ©o avec le lien simple ci-dessus.</i> <br><br>  Tous les fichiers impliquÃ©s dans ce POC peuvent Ãªtre trouvÃ©s dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rÃ©fÃ©rentiel GitHub correspondant</a> .  Il existe un autre script POC qui collecte automatiquement les clÃ©s privÃ©es et les jetons ServiceAccount du systÃ¨me de fichiers hÃ´te. <br><br><h2>  Le montage de rÃ©pertoires peut Ãªtre dangereux </h2><br>  Est-ce donc une vulnÃ©rabilitÃ© ou une mauvaise pratique? <br><br>  Le dÃ©ploiement d'un pod avec un <code>hostPath</code> ouvert en Ã©criture dans <code>/var/log</code> est rare (en outre, il existe d'autres faÃ§ons d'abuser du montage de rÃ©pertoires secrets d'hÃ´te dans le pod).  Mais mÃªme si vous saviez que le montage <code>/var/log</code> Ã©tait une pratique douteuse, vous ne vous attendiez probablement pas Ã  ce qu'il vous permette de reprendre le nÅ“ud avec une telle facilitÃ©. <br><br>  Avant la publication, nous avons contactÃ© l'Ã©quipe de sÃ©curitÃ© de Kubernetes pour savoir si elle considÃ©rait cela comme une vulnÃ©rabilitÃ©.  Ils ont conclu que ce n'Ã©tait qu'une triste consÃ©quence de la crÃ©ation d'un rÃ©pertoire hÃ´te privÃ© avec des autorisations d'Ã©criture: les risques impliquÃ©s sont bien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentÃ©s</a> .  Cependant, cette vulnÃ©rabilitÃ© est assez facile Ã  exploiter.  Dans le monde, de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreux projets</a> utilisent cette monture.  Si vous utilisez l'un de ces projets, n'oubliez pas que votre dÃ©ploiement sera vulnÃ©rable Ã  cette faÃ§on de dÃ©tourner l'hÃ´te. <br><br>  Cette mÃ©thode a Ã©tÃ© testÃ©e sur Kubernetes 1.15 et 1.13, mais affecte trÃ¨s probablement d'autres versions. <br><br><h2>  Ã‰limination </h2><br>  Une telle Â«fuiteÂ» n'est possible que si le pod s'exÃ©cute en tant que root.  Cela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">devrait</a> gÃ©nÃ©ralement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ãªtre Ã©vitÃ©</a> .  Aqua CSP vous permet de dÃ©finir une politique avec un minimum d'efforts qui empÃªche les conteneurs de s'exÃ©cuter sous la racine ou accorde des autorisations uniquement Ã  un groupe spÃ©cifique d'images qui ont vraiment besoin de la racine. <br><br>  Une autre faÃ§on consiste simplement Ã  ne pas dÃ©ployer de pods avec <code>hostPath</code> avec des autorisations d'Ã©criture dans <code>/var/log</code> .  Cette approche n'est pas dÃ©finie par dÃ©faut et n'est pas une pratique courante, il est donc nÃ©cessaire de la dÃ©terminer consciemment (cependant, la possibilitÃ© demeure).  Mais comment vÃ©rifier? <br><br>  Nous avons ajoutÃ© un nouveau script (hunter) Ã  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kube-hunter</a> - notre outil Open Source lÃ©ger pour tester Kubernetes - qui vÃ©rifie le cluster pour les pods avec de tels points de montage dangereux.  <i>( <b>Remarque</b> : Kube-hunter Ã©tait prÃ©sent dans une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rÃ©cente revue</a> des utilitaires de sÃ©curitÃ© K8, que nous avons publiÃ©e sur notre blog.)</i> <br><br>  Les utilisateurs d'Aqua peuvent se protÃ©ger de ce risque en utilisant la stratÃ©gie d'exÃ©cution pour empÃªcher le montage de certains volumes: <br><br><img src="https://habrastorage.org/webt/yi/ue/1k/yiue1kwxcn7fonmqvd9n2pfm5oq.png"><br><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Une partie de ce problÃ¨me peut Ãªtre rÃ©solue Ã  l'aide <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des stratÃ©gies de sÃ©curitÃ© des</a> <code>AllowedHostPaths</code> , Ã  savoir <code>AllowedHostPaths</code> .</i>  <i>Cependant, ce n'est pas non plus une protection contre les liens symboliques.</i>  <i>Enfin, comme le suggÃ¨rent les commentaires, nous pouvons simplement limiter le lancement en tant que root, lÃ  encore guidÃ© par la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PSP</a> .</i> <br><br><h2>  RÃ©sumÃ© </h2><br>  Kubernetes est un systÃ¨me complexe avec beaucoup de subtilitÃ©s dans les paramÃ¨tres de sÃ©curitÃ©, qui ne sont pas toujours Ã©vidents pour l'utilisateur moyen et mÃªme expÃ©rimentÃ©.  Dans cet article, j'ai montrÃ© comment, dans certaines circonstances, une journalisation innocente peut entraÃ®ner une vulnÃ©rabilitÃ© potentielle.  Dans la plupart des cas, cela n'est pas possible, mais Kubernetes offre aux utilisateurs une plus grande libertÃ© d'action qui peut affecter la sÃ©curitÃ©.  Il est important de garder cela Ã  l'esprit et de mettre en Å“uvre des contrÃ´les appropriÃ©s pour Ã©viter de telles erreurs. <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dans 19% des images Docker les plus populaires, il n'y a pas de mot de passe pour root</a> Â»; </li><li>  Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">33+ outils de sÃ©curitÃ© Kubernetes</a> Â»; </li><li>  Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Introduction aux stratÃ©gies de rÃ©seau Kubernetes pour les professionnels de la sÃ©curitÃ©</a> Â»; </li><li>  Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Docker et Kubernetes dans des environnements exigeants en matiÃ¨re de sÃ©curitÃ©</a> Â»; </li><li>  Â« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">9 meilleures pratiques de sÃ©curitÃ© chez Kubernetes</a> Â»; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">11 faÃ§ons de (pas) devenir une victime du piratage Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466625/">https://habr.com/ru/post/fr466625/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466607/index.html">"Tout ce que vous lirez sera utilisÃ© contre vous": comment la musique rap est entrÃ©e dans la salle d'audience</a></li>
<li><a href="../fr466609/index.html">Option pour utiliser la blockchain de crypto-monnaie comme moyen de transfert de commandes pour les Ã©lÃ©ments de botnet</a></li>
<li><a href="../fr466611/index.html">Ce que vous ne pouvez pas demander et pourquoi vous ne pouvez pas fÃ©liciter les employÃ©s si vous voulez qu'ils fonctionnent bien</a></li>
<li><a href="../fr466615/index.html">Recettes TeamCity. Signaler Yandex.Taxi</a></li>
<li><a href="../fr466623/index.html">CrÃ©ation d'un curseur de plage de valeurs pour un filtre sans utiliser jQuery</a></li>
<li><a href="../fr466629/index.html">Pourquoi votre application a-t-elle besoin d'accessibilitÃ©</a></li>
<li><a href="../fr466631/index.html">SystÃ¨me de gestion des cas de test QuAck - Les joies simples du test</a></li>
<li><a href="../fr466633/index.html">Chat SSH</a></li>
<li><a href="../fr466635/index.html">Nouvelles du monde d'OpenStreetMap n Â° 475 (08.20.2019-26.08.2019)</a></li>
<li><a href="../fr466637/index.html">Concevoir la machine Ã©lectromÃ©canique de marbre v2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>