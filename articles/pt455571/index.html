<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé§ üîã üì¨ Cursores do banco de dados em Doutrina üíÜüèø üç™ üë®‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usando cursores, voc√™ pode receber em lote do banco de dados e processar uma grande quantidade de dados sem desperdi√ßar mem√≥ria do aplicativo. Estou c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cursores do banco de dados em Doutrina</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/455571/"><p><img src="https://habrastorage.org/webt/a_/l9/rc/a_l9rcqm9ubhpc_gstic1u-rxtq.jpeg" alt="imagem"></p><br><p>  Usando cursores, voc√™ pode receber em lote do banco de dados e processar uma grande quantidade de dados sem desperdi√ßar mem√≥ria do aplicativo.  Estou certo de que todo desenvolvedor da Web enfrentou uma tarefa semelhante pelo menos uma vez, e n√£o apenas uma vez antes de mim.  Neste artigo, mostrarei em que tarefas os cursores podem ser √∫teis e darei c√≥digo pronto para trabalhar com eles no PHP + Doctrine usando o exemplo do PostrgeSQL. </p><a name="habracut"></a><br><h3 id="problema">  O problema </h3><br><p>  Vamos imaginar que temos um projeto PHP, grande e pesado.  Certamente, foi escrito com a ajuda de alguma estrutura.  Por exemplo, Symfony.  Ele tamb√©m usa um banco de dados, por exemplo, PostgreSQL, e o banco de dados possui uma placa para 2.000.000 de registros com informa√ß√µes sobre pedidos.  E o pr√≥prio projeto √© uma interface para esses pedidos, que pode exibi-los e filtr√°-los.  E, deixe-me dizer, isso est√° indo muito bem. </p><br><p>  Agora, fomos solicitados (voc√™ ainda n√£o foi convidado? Eles definitivamente ser√£o solicitados) a carregar o resultado da filtragem de pedidos em um arquivo do Excel.  Vamos apertar um bot√£o com um √≠cone de tabela, que cuspir√° um arquivo com pedidos para o usu√°rio. </p><br><h3 id="kak-obychno-reshayut-i-chem-eto-ploho">  Como √© geralmente decidido e por que √© ruim? </h3><br><p>  Como um programador que ainda n√£o encontrou essa tarefa?  Ele faz SELECT no banco de dados, l√™ os resultados da consulta, converte a resposta em um arquivo do Excel e a entrega ao navegador do usu√°rio.  A tarefa funciona, o teste est√° conclu√≠do, mas os problemas come√ßam na produ√ß√£o. </p><br><p>  Certamente, definimos um limite de mem√≥ria para o PHP em cerca de 1 GB razo√°vel (sem d√∫vida) por processo, e assim que esses 2 milh√µes de linhas n√£o se ajustarem mais a esse gigabyte, tudo quebrar√°.  O PHP trava com um erro de ‚Äúfalta de mem√≥ria‚Äù e os usu√°rios reclamam que o arquivo n√£o foi carregado.  Isso acontece porque escolhemos uma maneira bastante ing√™nua de descarregar dados do banco de dados - todos eles s√£o transferidos primeiro da mem√≥ria do banco de dados (e do disco sob ele) para a RAM do processo PHP, depois s√£o processados ‚Äã‚Äãe carregados no navegador. </p><br><p>  Para que os dados sejam sempre colocados na mem√≥ria, √© necess√°rio retir√°-los do banco de dados em peda√ßos.  Por exemplo, 10.000 registros foram lidos, processados, gravados em um arquivo e v√°rias vezes. </p><br><p>  Bem, pensa o programador que cumpriu nossa tarefa pela primeira vez.  Ent√£o, farei um loop e desinflaremos os resultados da consulta em partes, indicando LIMIT e OFFSET.  Funciona, mas √© uma opera√ß√£o muito cara para o banco de dados e, portanto, o upload do relat√≥rio n√£o come√ßa a levar 30 segundos, mas 30 minutos (n√£o √© t√£o ruim!).  A prop√≥sito, se, al√©m do OFFSET, neste momento, nada mais vem √† mente do programador, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ainda existem muitas maneiras de conseguir</a> o mesmo sem violar o banco de dados. </p><br><p>  Ao mesmo tempo, o pr√≥prio banco de dados possui uma capacidade interna de encadear dados de leitura a partir dele - cursores. </p><br><h3 id="kursory">  Cursores </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um cursor</a> √© um ponteiro para uma linha nos resultados de uma consulta que reside no banco de dados.  Ao us√°-los, podemos executar SELECT n√£o no modo de baixar dados imediatamente, mas abrir o cursor com essa sele√ß√£o.  Em seguida, come√ßamos a receber o fluxo de dados do banco de dados √† medida que o cursor avan√ßa.  Isso nos d√° o mesmo resultado: lemos os dados em partes, mas o banco de dados n√£o faz o mesmo trabalho de encontrar a linha com a qual precisa iniciar, como √© o caso de OFFSET. </p><br><p>  O cursor √© aberto apenas dentro da transa√ß√£o e permanece at√© que a transa√ß√£o esteja ativa (h√° uma exce√ß√£o, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WITH HOLD</a> ).  Isso significa que, se lermos lentamente muitos dados do banco de dados, teremos uma transa√ß√£o longa.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√Äs vezes</a> isso √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ruim</a> , voc√™ precisa entender e aceitar esse risco. </p><br><h3 id="kursory-v-doctrine">  Cursores em Doutrina </h3><br><p>  Vamos tentar implementar o trabalho com cursores no Doctrine.  Primeiro, como √© uma solicita√ß√£o para abrir um cursor? </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> mycursor1 <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> huge_table );</code> </pre> <br><p>  DECLARE cria e abre o cursor para a consulta SELECT especificada.  Ap√≥s criar o cursor, voc√™ pode come√ßar a ler dados dele: </p><br><pre> <code class="sql hljs">FETCH FORWARD 10000 FROM mycursor1; &lt; 10 000 &gt; FETCH FORWARD 10000 FROM mycursor1; &lt;  10 000 &gt; ...</code> </pre> <br><p>  E assim por diante, at√© FETCH retornar uma lista vazia.  Isso significa que eles rolaram at√© o fim. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre> <br><p>  Delineamos uma classe compat√≠vel com o Doctrine que encapsular√° o trabalho com o cursor.  E para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">resolver 80% do problema em 20% do tempo</a> , ele funcionar√° apenas com consultas nativas.  Ent√£o, vamos cham√°-lo de PgSqlNativeQueryCursor. </p><br><p>  Construtor: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeQuery $query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query = $query; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection = $query-&gt;getEntityManager()-&gt;getConnection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName = uniqid(<span class="hljs-string"><span class="hljs-string">'cursor_'</span></span>); assert(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getDriver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PDOPgSqlDriver); }</code> </pre> <br><p>  Aqui eu gero um nome para o futuro cursor. </p><br><p>  Como a classe possui c√≥digo SQL espec√≠fico do PostgreSQL, √© melhor verificar se nosso driver √© PG. </p><br><p>  Da classe, precisamos de tr√™s coisas: </p><br><ol><li>  Ser capaz de abrir o cursor. </li><li>  Ser capaz de retornar dados para n√≥s. </li><li>  Consiga fechar o cursor. </li></ol><br><p>  <strong>Abra o cursor:</strong> </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openCursor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getTransactionNestingLevel() === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \BadMethodCallException(<span class="hljs-string"><span class="hljs-string">'Cursor must be used inside a transaction'</span></span>); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'DECLARE %s CURSOR FOR (%s)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getSQL() )); $query-&gt;execute(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getParameters()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br><p>  Como eu disse, os cursores s√£o abertos em uma transa√ß√£o.  Portanto, aqui verifico que n√£o esquecemos de fazer uma chamada para esse m√©todo dentro de uma transa√ß√£o j√° aberta.  (Gra√ßas a Deus, j√° passou o tempo em que eu seria atra√≠do para abrir uma transa√ß√£o aqui!) </p><br><p>  Para simplificar a tarefa de criar e inicializar um novo NativeQuery, clonei o que foi alimentado no construtor e envolva-o em DECLARE ... CURSOR FOR (here_original_query).  Eu realizo isso. </p><br><p>  <strong>Vamos criar o m√©todo getFetchQuery.</strong>  Ele n√£o retornar√° dados, mas outra solicita√ß√£o que pode ser usada como voc√™ deseja obter os dados desejados em lotes espec√≠ficos.  Isso d√° mais liberdade ao c√≥digo de chamada. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH FORWARD %d FROM %s'</span></span>, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  O m√©todo possui um par√¢metro - esse √© o tamanho do pacote, que se tornar√° parte da solicita√ß√£o retornada por esse m√©todo.  Aplico o mesmo truque com a clonagem de consultas, sobrescrevi os par√¢metros nele e substitu√≠ o SQL pela constru√ß√£o FETCH ... FROM ...; </p><br><p>  Para n√£o esquecer de abrir o cursor antes da primeira chamada para getFetchQuery () (de repente n√£o vou dormir o suficiente), farei uma abertura impl√≠cita diretamente no m√©todo getFetchQuery (): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } ‚Ä¶</code> </pre> <br><p>  E o pr√≥prio m√©todo openCursor () ser√° privado.  N√£o vejo casos em que precise cham√°-lo explicitamente. </p><br><p>  Dentro de getFetchQuery (), eu codifiquei FORWARD para mover o cursor para frente um determinado n√∫mero de linhas.  Mas os modos de chamada FETCH s√£o muito diferentes.  Vamos adicion√°-los tamb√©m? </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_NEXT = <span class="hljs-string"><span class="hljs-string">'NEXT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_PRIOR = <span class="hljs-string"><span class="hljs-string">'PRIOR'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_FIRST = <span class="hljs-string"><span class="hljs-string">'FIRST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_LAST = <span class="hljs-string"><span class="hljs-string">'LAST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_ABSOLUTE = <span class="hljs-string"><span class="hljs-string">'ABSOLUTE'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// with count const DIRECTION_RELATIVE = 'RELATIVE'; // with count const DIRECTION_FORWARD = 'FORWARD'; // with count const DIRECTION_FORWARD_ALL = 'FORWARD ALL'; const DIRECTION_BACKWARD = 'BACKWARD'; // with count const DIRECTION_BACKWARD_ALL = 'BACKWARD ALL';</span></span></code> </pre> <br><p>  Metade deles aceita o n√∫mero de linhas no par√¢metro e a outra metade n√£o.  Aqui est√° o que eu tenho: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, string $direction = self::DIRECTION_FORWARD)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_ABSOLUTE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_RELATIVE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_FORWARD || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_BACKWARD ) { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s %d FROM %s'</span></span>, $direction, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s FROM %s'</span></span>, $direction, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  <strong>Feche o cursor</strong> com CLOSE, n√£o √© necess√°rio aguardar a conclus√£o da transa√ß√£o: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;exec(<span class="hljs-string"><span class="hljs-string">'CLOSE '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><p>  Destruidor: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); } }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui est√° toda a classe na sua totalidade</a> .  Vamos tentar em a√ß√£o? </p><br><p>  Abro algum gravador condicional em algum XLSX condicional. </p><br><pre> <code class="php hljs">$writer-&gt;openToFile($targetFile);</code> </pre> <br><p>  Aqui, recebo o NativeQuery para puxar a lista de pedidos do banco de dados. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> NativeQuery $query */</span></span> $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOrdersRepository($em) -&gt;getOrdersFiltered($dateFrom, $dateTo, $filters);</code> </pre> <br><p>  Com base nesta consulta, declaro um cursor. </p><br><pre> <code class="php hljs">$cursor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PgSqlNativeQueryCursor($query);</code> </pre> <br><p>  E para ele, recebo um pedido para receber dados em lotes de 10.000 linhas. </p><br><pre> <code class="php hljs">$fetchQuery = $cursor-&gt;getFetchQuery(<span class="hljs-number"><span class="hljs-number">10000</span></span>);</code> </pre> <br><p>  Eu itero at√© obter um resultado vazio.  Em cada itera√ß√£o, eu executo FETCH, processo o resultado e escrevo em um arquivo. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $result = $fetchQuery-&gt;getArrayResult(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $writer-&gt;addRow(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toXlsxRow($row)); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($result);</code> </pre> <br><p>  Eu fecho o cursor e o Writer. </p><br><pre> <code class="php hljs">$cursor-&gt;close(); $writer-&gt;close();</code> </pre> <br><p>  Gravo o arquivo no disco em um diret√≥rio para arquivos tempor√°rios e, ap√≥s a conclus√£o da grava√ß√£o, envio-o ao navegador para evitar, novamente, armazenar em buffer a mem√≥ria. </p><br><p>  RELAT√ìRIO PRONTO!  Usamos uma quantidade constante de mem√≥ria do PHP para processar todos os dados e n√£o torturamos o banco de dados com uma s√©rie de consultas pesadas.  E a descarga em si levou um pouco mais de tempo do que a base necess√°ria para atender √† solicita√ß√£o. </p><br><p>  Veja se h√° lugares em seus projetos que podem acelerar / economizar mem√≥ria com o cursor? </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455571/">https://habr.com/ru/post/pt455571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455555/index.html">Pe√ßa para o gerente mec√¢nico</a></li>
<li><a href="../pt455559/index.html">Como um computador qu√¢ntico pode invadir os sistemas modernos de criptografia e reduzir o custo da produ√ß√£o de am√¥nia?</a></li>
<li><a href="../pt455563/index.html">Empresa de pequeno porte: automatize ou n√£o?</a></li>
<li><a href="../pt455565/index.html">A mente pode fingir o universo?</a></li>
<li><a href="../pt455569/index.html">Convidamos voc√™ para a Confer√™ncia Tarantool em 17 de junho</a></li>
<li><a href="../pt455575/index.html">Correspond√™ncia neural: como adaptar o conte√∫do √†s realidades do Google</a></li>
<li><a href="../pt455577/index.html">Li√ß√µes do SDL 2: Li√ß√£o 3 - Eventos</a></li>
<li><a href="../pt455579/index.html">Tupperware: Kubernetes, o assassino do Facebook?</a></li>
<li><a href="../pt455580/index.html">Anima√ß√µes de aplicativos m√≥veis indispens√°veis</a></li>
<li><a href="../pt455582/index.html">Navega√ß√£o na loja: atrav√©s da realidade aumentada at√© a prateleira desejada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>