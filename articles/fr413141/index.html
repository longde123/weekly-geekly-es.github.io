<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåú üêú üíø Classer de grandes quantit√©s de donn√©es sur Apache Spark √† l'aide de mod√®les d'apprentissage automatique arbitraires ü•ò üêì üö°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Partie 2: Solution 
 Bonjour encore! Aujourd'hui, je vais continuer mon histoire sur la fa√ßon dont nous classons de grandes quantit√©s de donn√©es sur A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Classer de grandes quantit√©s de donn√©es sur Apache Spark √† l'aide de mod√®les d'apprentissage automatique arbitraires</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lanit/blog/413141/"><h2>  Partie 2: Solution </h2><br>  Bonjour encore!  Aujourd'hui, je vais continuer mon histoire sur la fa√ßon dont nous classons de grandes quantit√©s de donn√©es sur Apache Spark √† l'aide de mod√®les d'apprentissage automatique arbitraires.  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re partie de l'article,</a> nous avons examin√© l'√©nonc√© du probl√®me lui-m√™me, ainsi que les principaux probl√®mes qui se posent lors de l'organisation de l'interaction entre le cluster sur lequel les donn√©es initiales sont stock√©es et trait√©es, et le service de classification externe.  Dans la deuxi√®me partie, nous consid√©rerons l'une des options pour r√©soudre ce probl√®me en utilisant l'approche Reactive Streams et son impl√©mentation en utilisant la biblioth√®que akka-streams. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6m/bg/fu/6mbgfuuatqlimwnapnl3tlrzn8q.png"></div><a name="habracut"></a><br><h3>  Concept de flux r√©actifs </h3><br>  Pour r√©soudre les probl√®mes d√©crits dans la premi√®re partie, vous pouvez utiliser l'approche, appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Reactive Streams</a> .  Il vous permet de contr√¥ler le processus de transfert des flux de donn√©es entre les √©tapes de traitement, fonctionnant √† diff√©rentes vitesses et ind√©pendamment les uns des autres sans avoir besoin de mise en m√©moire tampon.  Si l'une des √©tapes de traitement est plus lente que la pr√©c√©dente, il est n√©cessaire de signaler l'√©tape la plus rapide sur la quantit√© de donn√©es d'entr√©e qu'elle est pr√™te √† traiter pour le moment.  Cette interaction est appel√©e contre-pression.  Elle consiste dans le fait que les √©tapes les plus rapides traitent exactement autant d'√©l√©ments que n√©cessaire pour l'√©tape la plus lente, et pas plus, puis lib√®rent des ressources informatiques. <br><br>  En g√©n√©ral, Reactive Streams est une sp√©cification pour impl√©menter le mod√®le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Publisher-Subscriber</a> .  Cette sp√©cification d√©finit un ensemble de quatre interfaces (√©diteur, abonn√©, processeur et abonnement) et un contrat pour leurs m√©thodes. <br><br>  Examinons ces interfaces plus en d√©tail: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscriber&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; s)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscription s)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span></span>{ }</code> </pre> <br>  Le mod√®le Publisher-Subscriber a deux c√¥t√©s: la transmission et la r√©ception.  Lors de l'impl√©mentation de Reactive Streams, la classe qui impl√©mente l'interface Publisher est responsable du transfert de donn√©es et l'Abonn√© est responsable de la r√©ception.  Pour √©tablir une communication entre eux, l'Abonn√© doit √™tre enregistr√© aupr√®s de Publisher en appelant sa m√©thode d'abonnement.  Selon la sp√©cification, apr√®s avoir enregistr√© un abonn√©, Publisher doit appeler ses m√©thodes dans l'ordre suivant: <br><br><ol><li>  onSubscribe.  Cette m√©thode est appel√©e imm√©diatement apr√®s l'enregistrement de l'abonn√© aupr√®s de Publisher.  En tant que param√®tre, un objet Subscription lui est transmis via lequel l'Abonn√© demandera des donn√©es √† Publisher.  Cet objet doit √™tre stock√© et appel√© uniquement dans le contexte de cet abonn√©. </li><li>  Une fois que l'Abonn√© a demand√© des donn√©es √† Publisher en appelant la m√©thode de demande sur l'objet Subscription correspondant, Publisher peut appeler la m√©thode Subscriber onNext, en passant l'√©l√©ment suivant. </li><li>  L'abonn√© peut ensuite appeler p√©riodiquement la m√©thode de demande sur l'abonnement, mais Publisher ne peut pas appeler la m√©thode onNext plus que le total demand√© via la m√©thode de demande. </li><li>  Si le flux de donn√©es est fini, apr√®s avoir pass√© tous les √©l√©ments via la m√©thode onNext, Publisher doit appeler la m√©thode onComplete. </li><li>  Si une erreur s'est produite dans Publisher et qu'un traitement ult√©rieur des √©l√©ments n'est pas possible, il doit appeler la m√©thode onError </li><li>  Apr√®s avoir appel√© les m√©thodes onComplete ou onError, l'interaction ult√©rieure de Publisher avec l'abonn√© doit √™tre exclue. </li></ol><br>  Les appels de m√©thode peuvent √™tre consid√©r√©s comme l'envoi de signaux entre l'√©diteur et l'abonn√©.  L'abonn√© signale √† Publisher le nombre d'√©l√©ments qu'il est pr√™t √† traiter, et Publisher, √† son tour, lui signale qu'il existe soit l'√©l√©ment suivant, soit qu'il n'y a plus d'√©l√©ments, ou qu'une erreur s'est produite. <br><br>  Afin d'exclure une autre influence de Publisher et Subscriber l'un sur l'autre, les appels √† toutes les m√©thodes qui impl√©mentent les interfaces Reactive Streams doivent √™tre non bloquants.  Dans ce cas, l'interaction entre eux sera compl√®tement asynchrone. <br><br>  Plus de d√©tails sur la sp√©cification des interfaces Reactive Streams peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Ainsi, en reliant les it√©rateurs d'origine et r√©sultants en les convertissant respectivement en Publisher et Subscriber, nous pouvons r√©soudre les probl√®mes identifi√©s dans la partie pr√©c√©dente de l'article.  Le probl√®me de d√©passement de tampon entre les √©tapes est r√©solu en demandant un certain nombre d'√©l√©ments √† l'Abonn√©.  Le probl√®me de l'ach√®vement r√©ussi ou √©chou√© est r√©solu en envoyant des signaux √† l'Abonn√© via les m√©thodes onComplete ou onError, respectivement.  L'√©diteur devient responsable de l'envoi de ces signaux, qui dans notre cas doivent contr√¥ler le nombre de requ√™tes HTTP envoy√©es et le nombre de r√©ponses re√ßues.  Apr√®s avoir re√ßu la derni√®re r√©ponse et trait√© tous les r√©sultats qui y sont entr√©s, il doit envoyer un signal onComplete.  En cas d'√©chec de l'une des demandes, il doit envoyer un signal onError et cesser d'envoyer d'autres √©l√©ments √† l'Abonn√©, ainsi que de soustraire des √©l√©ments de l'it√©rateur d'origine. <br><br>  L'it√©rateur r√©sultant doit √™tre impl√©ment√© en tant qu'abonn√©.  Dans ce cas, nous ne pouvons pas nous passer d'un tampon dans lequel les √©l√©ments seront √©crits lorsque la m√©thode onNext est appel√©e √† partir de l'interface Subscriber et soustraits √† l'aide des m√©thodes hasNext et next de l'interface Iterator.  En tant qu'impl√©mentation de tampon, vous pouvez utiliser une file d'attente de blocage, par exemple, LinkedBlockedQueue. <br><br>  Un lecteur attentif posera imm√©diatement la question: pourquoi la file d'attente est-elle bloquante, car selon la sp√©cification Reactive Streams, l'impl√©mentation de toutes les m√©thodes devrait √™tre non bloquante?  Mais tout va bien ici: puisque nous demandons √† Publisher un nombre d'√©l√©ments strictement d√©fini, la m√©thode onNext ne sera pas appel√©e plus que ce nombre de fois, et la file d'attente peut toujours ajouter un nouvel √©l√©ment sans bloquer. <br><br>  En revanche, un blocage peut se produire lorsque la m√©thode hasNext est appel√©e en cas de file d'attente vide.  Cependant, tout va bien: la m√©thode hasNext ne fait pas partie du contrat de l'interface Abonn√©, elle est d√©finie dans l'interface Iterator, qui, comme nous l'avons expliqu√© pr√©c√©demment, est une structure de donn√©es bloquante.  Lors de l'appel de la m√©thode suivante, nous soustrayons l'√©l√©ment suivant de la file d'attente, et lorsque sa taille devient inf√©rieure √† un certain seuil, nous devrons demander la partie suivante des √©l√©ments via un appel √† la m√©thode request. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tz/xy/8t/tzxy8tn05km8fox0bkwk_zsxvcg.png" width="650"></div>  <i>Figure 7. Interaction asynchrone avec un service externe √† l'aide de l'approche Reactive Streams</i> <br><br>  Bien s√ªr, dans ce cas, nous ne nous d√©barrasserons pas compl√®tement du blocage des appels.  Cela est d√ª √† une incompatibilit√© de paradigmes entre les flux r√©actifs, qui supposent une interaction compl√®tement asynchrone, et un it√©rateur, qui doit appeler trueN ou false lors de l'appel de la m√©thode hasNext.  Cependant, contrairement √† l'interaction synchrone avec un service externe, les temps d'arr√™t dus aux verrous peuvent √™tre consid√©rablement r√©duits en augmentant la charge globale des c≈ìurs de processeur. <br><br>  Il serait pratique que les d√©veloppeurs Apache Spark dans les futures versions impl√©mentent un analogue de la m√©thode mapPartitions, qui fonctionne avec Publisher et Subscriber.  Cela permettrait une interaction compl√®tement asynchrone, √©liminant ainsi la possibilit√© de bloquer les threads. <br><br><h3>  Akka-streams et akka-http comme impl√©mentation de la sp√©cification Reactive Streams </h3><br>  Actuellement, il existe d√©j√† plus d'une douzaine d'impl√©mentations de la sp√©cification Reactive Streams.  Une telle impl√©mentation est le module akka-streams de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">akka</a> .  Dans le monde de la JVM, akka s'est impos√© comme l'un des moyens les plus efficaces pour √©crire des syst√®mes parall√®les et distribu√©s.  Ceci est obtenu gr√¢ce au fait que le principe de base √©nonc√© dans sa fondation est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le mod√®le d'acteur</a> , qui vous permet d'√©crire des applications hautement comp√©titives sans contr√¥le direct des threads et de leurs pools. <br><br>  Beaucoup de litt√©rature a √©t√© √©crite sur la mise en ≈ìuvre du concept d'acteurs dans l'akka, donc nous ne nous arr√™terons pas l√† (le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel de</a> l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">akka</a> est une tr√®s bonne source d'information, je recommande √©galement l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">akka dans le</a> livre d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">action</a> ).  Ici, nous allons examiner de plus pr√®s le c√¥t√© technologique de la mise en ≈ìuvre dans le cadre de la JVM. <br><br>  En g√©n√©ral, les acteurs n'existent pas par eux-m√™mes, mais forment un syst√®me hi√©rarchique.  Afin de cr√©er un syst√®me d'acteur, vous devez lui allouer des ressources, donc la premi√®re √©tape lorsque vous travaillez avec akka est de cr√©er une instance de l'objet ActorSystem.  Lorsque ActorSystem d√©marre, un pool s√©par√© de threads est cr√©√©, appel√© le r√©partiteur, dans lequel tout le code d√©fini dans les acteurs est ex√©cut√©.  En r√®gle g√©n√©rale, un seul thread ex√©cute le code de plusieurs acteurs, cependant, si n√©cessaire, vous pouvez configurer un r√©partiteur distinct pour un groupe sp√©cifique d'acteurs (par exemple, pour les acteurs interagissant directement avec une API de blocage). <br><br>  L'une des t√¢ches les plus courantes r√©solues √† l'aide d'acteurs est le traitement s√©quentiel des flux de donn√©es.  Auparavant, pour cela, il √©tait n√©cessaire de cr√©er manuellement des cha√Ænes d'acteurs et de s'assurer qu'il n'y avait pas de goulots d'√©tranglement entre eux (par exemple, si un acteur traite les messages plus rapidement que le suivant, il peut alors avoir un d√©bordement de la file d'attente des messages entrants, conduisant √† une erreur OutOfMemoryError). <br><br>  √Ä partir de la version 2.4, le module akka-streams a √©t√© ajout√© √† akka, ce qui vous permet de d√©finir de mani√®re d√©clarative le processus de traitement des donn√©es, puis de cr√©er les acteurs n√©cessaires √† son ex√©cution.  Akka-streams met √©galement en ≈ìuvre le principe de la contre-pression, ce qui √©limine la possibilit√© de d√©border la file d'attente des messages entrants pour tous les acteurs impliqu√©s dans le traitement. <br><br>  Les principaux √©l√©ments permettant de d√©finir le sch√©ma de traitement des flux de donn√©es dans les akka-streams sont Source, Flow et Sink.  En les combinant les uns avec les autres, nous obtenons un graphique ex√©cutable.  Pour d√©marrer le processus de traitement, un mat√©rialiseur est utilis√©, ce qui cr√©e des acteurs travaillant selon le graphe d√©fini par nous (l'interface Materializer et son impl√©mentation ActorMaterializer). <br><br>  Examinons plus en d√©tail les √©tapes Source, Flow et Sink.  La source d√©finit la source de donn√©es.  Akka-streams prend en charge plus d'une douzaine de fa√ßons diff√©rentes de cr√©er des sources, y compris √† partir d'un it√©rateur: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> featuresSource: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Float</span></span>], <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = <span class="hljs-type"><span class="hljs-type">Source</span></span>.fromIterator { () =&gt; featuresIterator }</code> </pre><br>  La source peut √©galement √™tre obtenue en convertissant une source existante: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newSource: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = source.map(item =&gt; transform(item))</code> </pre> <br>  Si la transformation est une op√©ration non triviale, elle peut √™tre repr√©sent√©e comme une entit√© Flow.  Akka-streams prend en charge de nombreuses fa√ßons de cr√©er Flow.  La fa√ßon la plus simple est de cr√©er √† partir d'une fonction: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> someFlow: <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = <span class="hljs-type"><span class="hljs-type">Flow</span></span>.fromFunction((x: <span class="hljs-type"><span class="hljs-type">String</span></span>) =&gt; x.length)</code> </pre> <br>  En combinant Source et Flow, nous obtenons une nouvelle Source. <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newSource: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = oldSource.via(someFlow)</code> </pre> <br>  L'√©vier est utilis√© comme √©tape finale du traitement des donn√©es.  Comme dans le cas de Source, akka-streams fournit plus d'une douzaine d'options Sink diff√©rentes, par exemple, Sink.foreach effectue une certaine op√©ration pour chaque √©l√©ment, Sink.seq collecte tous les √©l√©ments d'une collection, etc. <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> printSink: <span class="hljs-type"><span class="hljs-type">Sink</span></span>[<span class="hljs-type"><span class="hljs-type">Any</span></span>, <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">Done</span></span>]] = <span class="hljs-type"><span class="hljs-type">Sink</span></span>.foreach(println)</code> </pre> <br>  Source, Flow et Sink sont param√©tr√©s respectivement par les types d'√©l√©ments d'entr√©e et / ou de sortie.  De plus, chaque √©tape de traitement peut avoir un certain r√©sultat de son travail.  Pour cela, Source, Flow et Sink sont √©galement param√©tr√©s par un type suppl√©mentaire qui d√©termine le r√©sultat de l'op√©ration.  Ce type est appel√© type de valeur mat√©rialis√©e.  Si l'op√©ration n'implique pas la pr√©sence d'un r√©sultat suppl√©mentaire de son travail, par exemple, lorsque nous d√©finissons Flow through a function, le type NotUsed est utilis√© comme valeur mat√©rialis√©e. <br><br>  En combinant la source, le flux et le puits n√©cessaires, nous obtenons RunnableGraph.  Il est param√©tr√© par un type, qui d√©termine le type de valeur obtenu suite √† l'ex√©cution de ce graphe.  Si n√©cessaire, lors de la combinaison des √©tapes, vous pouvez sp√©cifier le r√©sultat de laquelle des √©tapes sera le r√©sultat de l'ensemble du graphique des op√©rations.  Par d√©faut, le r√©sultat de l'√©tape Source est pris: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> graph: <span class="hljs-type"><span class="hljs-type">RunnableGraph</span></span>[<span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = someSource.to(<span class="hljs-type"><span class="hljs-type">Sink</span></span>.foreach(println))</code> </pre> <br>  Cependant, si le r√©sultat de l'√©tape Sink est plus important pour nous, alors nous devons l'indiquer explicitement: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> graph: <span class="hljs-type"><span class="hljs-type">RunnableGraph</span></span>[<span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">Done</span></span>]] = someSource.toMat(<span class="hljs-type"><span class="hljs-type">Sink</span></span>.foreach(println))(<span class="hljs-type"><span class="hljs-type">Keep</span></span>.right)</code> </pre><br>  Apr√®s avoir d√©fini le graphe des op√©rations, nous devons l'ex√©cuter.  Pour ce faire, runnableGraph doit appeler la m√©thode run.  En tant que param√®tre, cette m√©thode prend un objet ActorMaterializer (qui peut √©galement √™tre dans une port√©e implicite), qui est responsable de la cr√©ation d'acteurs qui effectueront des op√©rations.  En r√®gle g√©n√©rale, un ActorMaterializer est cr√©√© imm√©diatement apr√®s la cr√©ation d'un ActorSystem, attach√© √† son cycle de vie, et l'utilise pour cr√©er des acteurs.  Prenons un exemple: <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//   ActorSystem,       implicit val system = ActorSystem(‚Äúsystem name‚Äù) // ,       ActorSystem implicit val materializer = ActorMaterializer() //    ,       Sink val graph: RunnableGraph[Future[immutable.Seq[Int]]] = Source.fromIterator(() =&gt; (1 to 10).iterator).toMat(Sink.seq)(Keep.right) //   ,    implicit scope. val result: Future[immutable.Seq[Int]] = graph.run()</span></span></code> </pre><br>  Dans le cas de combinaisons simples, vous pouvez vous passer de la cr√©ation d'un RunnableGraph distinct, mais connectez simplement Source √† Sink et d√©marrez-les en appelant la m√©thode runWith sur Source.  Cette m√©thode suppose √©galement qu'un objet ActorMaterializer est pr√©sent dans la port√©e implicite.  De plus, dans ce cas, la valeur mat√©rialis√©e d√©finie dans Sink sera utilis√©e.  Par exemple, en utilisant le code suivant, nous pouvons convertir Source en Publisher √† partir de la sp√©cification Reactive Streams: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">Score</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = <span class="hljs-type"><span class="hljs-type">Source</span></span>.fromIterator(() =&gt; sourceIterator).map(item =&gt; transform(item)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> publisher: <span class="hljs-type"><span class="hljs-type">Publisher</span></span>[<span class="hljs-type"><span class="hljs-type">Score</span></span>] = source.runWith(<span class="hljs-type"><span class="hljs-type">Sink</span></span>.asPublisher(<span class="hljs-literal"><span class="hljs-literal">false</span></span>))</code> </pre><br>  Ainsi, nous avons maintenant montr√© comment obtenir Reactive Streams Publisher en cr√©ant une source √† partir de l'it√©rateur source et en effectuant des transformations sur ses √©l√©ments.  Nous pouvons maintenant l'associer √† un abonn√© qui fournit des donn√©es √† l'it√©rateur r√©sultant.  Reste √† consid√©rer la derni√®re question: comment organiser l'interaction HTTP avec un service externe. <br><br>  La structure d'akka comprend le module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://doc.akka.io/docs/akka-">akka-http</a> , qui vous permet d'organiser une communication asynchrone non bloquante sur HTTP.  De plus, ce module est construit sur la base de flux akka, ce qui vous permet d'ajouter une interaction HTTP comme √©tape suppl√©mentaire dans le graphique des op√©rations de traitement des flux de donn√©es. <br><br>  Pour se connecter √† des services externes, akka-http propose trois interfaces diff√©rentes. <br><br><ol><li>  API au niveau de la demande - est l'option la plus simple pour le cas de demandes uniques √† une machine arbitraire.  √Ä ce niveau, les connexions HTTP sont g√©r√©es de mani√®re enti√®rement automatique et, √† chaque demande, il est n√©cessaire de transmettre l'adresse compl√®te de la machine √† laquelle la demande est envoy√©e. </li><li>  API au niveau de l'h√¥te - appropri√©e lorsque nous savons √† quel port sur quelle machine nous allons acc√©der.  Dans ce cas, akka-http prend le contr√¥le du pool de connexions HTTP, et dans les requ√™tes, il suffit de sp√©cifier le chemin relatif vers la ressource demand√©e. </li><li>  API au niveau de la connexion - vous permet d'obtenir un contr√¥le total sur la gestion des connexions HTTP, c'est-√†-dire l'ouverture, la fermeture et la distribution des demandes sur les connexions. </li></ol><br>  Dans notre cas, l'adresse du service de classification nous est connue √† l'avance, il est donc n√©cessaire d'organiser l'interaction HTTP uniquement avec cette machine particuli√®re.  Par cons√©quent, l'API au niveau de l'h√¥te est la meilleure pour nous.  Voyons maintenant comment le pool de connexions HTTP est cr√©√© lors de son utilisation: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> httpFlow: <span class="hljs-type"><span class="hljs-type">Flow</span></span>[(<span class="hljs-type"><span class="hljs-type">HttpRequest</span></span>,<span class="hljs-type"><span class="hljs-type">Id</span></span>), (<span class="hljs-type"><span class="hljs-type">Try</span></span>[<span class="hljs-type"><span class="hljs-type">HttpResponse</span></span>],<span class="hljs-type"><span class="hljs-type">Id</span></span>), <span class="hljs-type"><span class="hljs-type">Http</span></span>.<span class="hljs-type"><span class="hljs-type">HostConnectionPool</span></span>] = <span class="hljs-type"><span class="hljs-type">Http</span></span>().cachedHostConnectionPool[<span class="hljs-type"><span class="hljs-type">Id</span></span>](hostAddress, portNumber)</code> </pre><br>  Lors de l'appel √† Http (). CachedHostConnectionPool [T] (hostAddress, portNumber) dans l'ActorSystem, qui est dans une port√©e implicite, les ressources sont allou√©es pour cr√©er un pool de connexions, mais les connexions elles-m√™mes ne sont pas √©tablies.  √Ä la suite de cet appel, Flow est renvoy√©, qui re√ßoit une paire d'une demande HTTP et un objet d'identification Id en entr√©e.  L'objet d'identification est n√©cessaire pour faire correspondre la demande avec la r√©ponse correspondante, car l'appel HTTP dans akka-http est une op√©ration asynchrone, et l'ordre dans lequel les r√©ponses sont re√ßues ne correspond pas n√©cessairement √† l'ordre dans lequel les demandes sont envoy√©es.  Par cons√©quent, √† la sortie, Flow donne un couple du r√©sultat de la requ√™te et de l'objet d'identification correspondant. <br><br>  Directement, les connexions HTTP sont √©tablies lorsqu'un graphique (y compris ce flux) est lanc√© (mat√©rialis√©).  Akka-http est impl√©ment√© de telle mani√®re que peu importe le nombre de fois o√π les graphiques contenant httpFlow ont √©t√© mat√©rialis√©s, au sein du m√™me ActorSystem, il y aura toujours un pool commun de connexions HTTP qui sera utilis√© par toutes les mat√©rialisations.  Cela vous permet de mieux contr√¥ler l'utilisation des ressources r√©seau et d'√©viter de les surcharger. <br><br>  Ainsi, le cycle de vie du pool de connexions HTTP est li√© √† l'ActorSystem.  Comme d√©j√† mentionn√©, le cycle de vie du pool de threads lui est √©galement attach√©, dans lequel les op√©rations d√©finies dans les acteurs (ou dans notre cas, d√©finies comme les √©tapes akka-streams et akka-http) sont effectu√©es.  Par cons√©quent, pour atteindre une efficacit√© maximale, nous devons r√©utiliser une instance d'ActorSystem au sein du m√™me processus JVM. <br><br><h3>  Mettre tout cela ensemble: un exemple de mise en ≈ìuvre de l'interaction avec le service de classification </h3><br>  Ainsi, nous pouvons maintenant passer au processus de classification de grands volumes de donn√©es distribu√©es sur Apache Spark en utilisant une interaction asynchrone avec des services externes.  Le sch√©ma g√©n√©ral de cette interaction a d√©j√† √©t√© illustr√© √† la figure 7. <br><br>  Supposons que nous ayons d√©fini un [jeu de donn√©es] initial.  En lui appliquant l'op√©ration mapPartitions, nous devrions obtenir un ensemble de donn√©es, dans lequel chaque identifiant de l'ensemble source est estampill√© avec une certaine valeur obtenue √† la suite de la classification (ensemble de donn√©es [score]).  Pour organiser le traitement asynchrone sur les ex√©cuteurs, nous devons encapsuler la source et les it√©rateurs r√©sultants dans Publisher et Subscriber, respectivement, √† partir de la sp√©cification des flux r√©actifs et les lier ensemble. <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Features</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, vector: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Score</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, score: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">1</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchesRequestCount</span></span></span><span class="hljs-class"> </span></span>= config.getInt(‚ÄúscoreService. batchesRequestCount‚Äù)<span class="hljs-comment"><span class="hljs-comment">//(2) //... val scoreDs: Dataset[Score] = featuresDs.mapPartitions { fi: Iterator[Features] =&gt; val publisher: Publisher[Iterable[Score]] = createPublisher(fi) //(3) val iteratorSubscriber: Iterator[Score] = new IteratorSubscriber(batchesRequestCount) //(4) publisher.subscribe(batchesRequestCount) //(5) iteratorSubscriber //(6) }</span></span></code> </pre> <br>  Dans cette impl√©mentation, il est pris en compte que le service de classification pour un appel peut traiter un groupe de vecteurs de caract√©ristiques √† la fois, par cons√©quent, le r√©sultat de la classification apr√®s un appel √† celui-ci sera √©galement disponible imm√©diatement pour l'ensemble du groupe.  Par cons√©quent, en tant que type de param√®tre pour Publisher, nous n'avons pas seulement Score, comme vous pouvez vous y attendre, mais Iterable [Score].  Ainsi, nous envoyons les r√©sultats de classification de ce groupe √† l'it√©rateur r√©sultant (qui est √©galement un abonn√©) par un seul appel √† la m√©thode onNext.  C'est beaucoup plus efficace que d'appeler onNext pour chaque √©l√©ment.  Nous allons maintenant analyser ce code plus en d√©tail. <br><br><ol><li>  Nous d√©terminons la structure des donn√©es d'entr√©e et de sortie.  En entr√©e, nous aurons un tas d'identifiant avec un vecteur d'entit√©, et en sortie, nous aurons un tas d'identifiant avec une valeur num√©rique obtenue √† la suite de la classification. </li><li>  Nous d√©terminons le nombre de groupes que l'abonn√© demandera √† l'√©diteur √† la fois.  Comme il est suppos√© que ces valeurs se trouveront dans le tampon et attendront d'√™tre lues dans l'it√©rateur r√©sultant, cette valeur d√©pend de la quantit√© de m√©moire allou√©e √† l'ex√©cuteur. </li><li>  Cr√©ez Publisher √† partir de l'it√©rateur source.  Il sera responsable de l'interaction avec le service de classification.  La fonction createPublisher est d√©crite ci-dessous. </li><li>  Cr√©ez un abonn√©, qui sera l'it√©rateur r√©sultant.  Le code de la classe IteratorSubscriber est √©galement donn√© ci-dessous. </li><li>  Enregistrement de l'abonn√© aupr√®s de Publisher. </li><li>  Renvoie IteratorSubscriber comme r√©sultat de l'op√©ration mapPartitions. </li></ol><br>  Consid√©rons maintenant l'impl√©mentation de la fonction createPublisher. <br><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ids</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-comment"><span class="hljs-comment">//(1) val batchSize = config.getInt("scoreService.batchSize") val parallelismLevel = config.getInt("scoreService.parallelismLevel") //(2) //... def createPublisher(fi: Iterator[Features]): Publisher[Iterable[Score]] = { import ActorSystemHolder._ //(3) Source .fromIterator(() =&gt; fi) //(4) .grouped(batchSize) //(5) .map { groupedFeatures: Seq[Features] =&gt; val request: (HttpRequest, Ids) = createHttpRequest(groupedFeatures) //(6) logger.debug(s"Sending request for the first id: ${request._2(0)}") request } .via(httpFlow) //(7) .flatMapMerge(parallelismLevel, { //(8) case (Success(response), ids) if response.status.isSuccess() =&gt; logger.debug(s"Processing successful result for the first id: ${ids(0)}") val resultSource: Source[Iterable[Score], _] = response.entity.dataBytes.reduce(_ ++ _).map { responseBytes =&gt; processSuccessfulResponse(responseBytes, ids) } //(9) resultScore case (Success(response), ids) =&gt; logger.warn( s"Failed result for the first id: ${ids(0)}, HTTP status: ${response.status}" ) response.discardEntityBytes() Source.failed( new IOException(s"Non-successful HTTP status: ${response.status}") ) //(10) case (Failure(ex), ids) =&gt; logger.warn(s"Failed result: an exception has occured", ex) Source.failed(ex) //(11) }) .runWith(Sink.asPublisher(false)) //(12) } def createHttpRequest(featuresSeq: Seq[Features]): (HttpRequest, ProfileIds) = { val requestBytes: Array[Byte] = featuresToMatrixBytes(featuresSeq) val ids: ProfileIds = extractIds(featuresSeq) val httpRequest = HttpRequest( method = HttpMethods.PUT, uri = "/score", entity = requestBytes ) httpRequest -&gt; ids }</span></span></code> </pre><br><ol><li>    -   ,   .         httpFlow,           . </li><li>     :     ,     (batchSize)        (parallelismLevel). </li><li>   implicit scope ActorSystem, ActorMaterializer  httpFlow.        Spark-.  ActorSystemHolder    . </li><li>     akka-streams   .     Source[Features]   . </li><li>            batchSize       . </li><li>     HttpRequest       .   HttpRequest      createHttpRequest.      createPublisher.      feature-,   ,      (            predict).       ,      HTTP-.      ,   HTTP-,    HTTP-, URI      . </li><li>        httpFlow. </li><li>     ,   .      flatMapMerge,        akka-http    Source[ByteString],      ,       .           .  parallelismLevel ,      (     ).      HTTP-:   ,  ,  ,   . </li><li>       :          .      akka    ByteString.    ,    ByteString    O(1),    ByteString        .       ,    ,         .                ,     . </li><li>       HTTP-     ,  Stream .         ,      discardEntityBytes    ,    ,  . </li><li>         .      akka-http    ,       . </li><li>       ,    Publisher,     .    ,    .  false   Sink.asPublisher ,   Publisher    Subscriber-. </li></ol><br>      ,    akka  ActorSystem,        .  ,        Spark ,          .   Spark    JVM , ,        ,     ActorSystem    ActorMatrializer  httpFlow. <br><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActorSystemHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> actorSystem: <span class="hljs-type"><span class="hljs-type">ActorSystem</span></span> = { <span class="hljs-comment"><span class="hljs-comment">//(1) val actorSystemName = s"score-service-client" logger.debug(s"Creating actor system $actorSystemName") val as = ActorSystem(actorSystemName) //(2) logger.debug("Adding shutdown hook for the actor system") scala.sys.addShutdownHook { //(3) logger.debug(s"Terminating actor system $actorSystemName") Await.result(as.terminate(), 30.seconds) //to Mars :) logger.debug(s"The actor system $actorSystemName has been terminated") } as } implicit lazy val materializer: ActorMaterializer = { //(4) logger.debug(s"Creating actor materializer for actor system ${actorSystem.name}") ActorMaterializer() } lazy val httpFlow: Flow[ (HttpRequest,ProfileIds), (Try[HttpResponse], ProfileIds), Http.HostConnectionPool] = { //(5) val httpFlowSettings = ConnectionPoolSettings(actorSystem) logger.debug(s"Creating http flow with settings $httpFlowSettings") Http().cachedHostConnectionPool[ProfileIds]( config.getString("scoreService.host"), config.getInt("scoreService.int"), settings = httpFlowSettings ) } }</span></span></code> </pre><br><ol><li>     ,   ,       ,     . </li><li>    ActorSystem   . </li><li>  ,     ,    ActorSystem,       terminate, ,   ,   ,     .      ,     JVM-. </li><li>    ActorMaterializer,      akka-streams,   ActorSystem. </li><li> ,   httpFlow     .      ,       HTTP-   ActorSystem. </li></ol><br>       Subscriber-    HTTP-. <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueItem</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Item</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">item: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueItem</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Done</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueItem</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Nothing</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Failure</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">cause: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueItem</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Nothing</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">1</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StreamErrorCompletionException</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">cause: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">cause</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">2</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IteratorSubscriber</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">requestSize: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Iterable</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">]] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//(3) private val buffer: BlockingQueue[QueueItem[Iterable[T]]] = new LinkedBlockingQueue[QueueItem[Iterable[T]]]() //(4) private var expecting: Int = 0 //(5) private val subscriptionPromise: Promise[Subscription] = Promise() private lazy val subscription: Subscription = Await.result(subscriptionPromise.future, 5.minutes) //(6) private var currentIterator: Iterator[T] = Iterator.empty //(7) private var isDone = false //(8) override def onSubscribe(s: Subscription): Unit = { subscriptionPromise.success(s) //(9) logger.trace("The iterator has been subscribed") } override def onNext(t: Iterable[T]): Unit = { logger.trace("Putting a next batch to the buffer") buffer.put(Item(t)) //(10) } override def onComplete(): Unit = { logger.debug("The stream has been succesfully completed") buffer.put(Done) //(11) } override def onError(t: Throwable): Unit = { logger.warn("The stream has been completed with error", t) buffer.put(Failure(t)) //(12) } override def hasNext: Boolean = { logger.trace("Asking hasNext") if (currentIterator.hasNext) { //(13) true } else if (isDone) { //(14) false } else { if (expecting &lt; requestSize) { requestNextBatches() //(15) } buffer.take() match { //(16) case Item(batch) =&gt; currentIterator = batch.iterator expecting -= 1 this.hasNext //(17) case Done =&gt; isDone = true false //(18) case Failure(exception) =&gt; throw new StreamErrorCompletionException(exception) //(19) } } } override def next(): T = { val out = currentIterator.next() logger.trace("The next element is {}", out) out //(20) } private def requestNextBatches(): Unit = { logger.debug(s"Requesting {} batches", requestSize) subscription.request(requestSize) expecting += requestSize //(21) } }</span></span></code> </pre><br>  IteratorSubscriber    Producer-Consumer.   ,    Subscriber,  Producer-,  ,   Iterator, ‚Äì Consumer-.      ,     .    Iterator       Apache Spark,    Subscriber ‚Äì  ,  ActorSystem. <br><br>      IteratorSubscriber  . <br><br><ol><li>          .          ,     Done,    ,  Throwable,    . </li><li>      ,        hasNext    . </li><li>  ,    ,        Publisher-. </li><li>    ,     .    LinkedBlockingQueue,      . ,         . </li><li>     ,    .     ,         ,       Publisher-.   ,    ,      Publisher-   .         hasNext  next ( requestNextBatches    hasNext),       ,       . </li><li>  subscriptionPromise  subscription     Subscription,    Publisher    onSubscribe. ,    Reactive Streams        Subscriber-  Publisher-     ,   ,   hasNext   ,  onSubscribe.      ,     subscription,          Publisher-.     lazy   subscription,    Promise. </li><li>       .          hasNext  next,     ,       . </li><li>     ,        ,  hasNext   false     .           hasNext,         . </li><li>    onSubscribe    Publisher-  Subscription    Promise,        subscription. </li><li> onNext  Publisher-,        .      . </li><li>       Publisher   onComplete,          Done. </li><li>    Publisher   onError.       . </li><li>    hasNext     ,      .      ,    true,       .     ,         . </li><li>        ,            false. </li><li>  ,   ,        requestSize,       Publisher.         ,    ,     ,   Publisher-    ,   HTTP-     . </li><li>        .  ,   ,      ,      .  ,       ,     (  ,    ,        subscription), ,     ,   ,      . </li><li>       ,           currentIterator.        ,          . ,       hasNext  ,         (    ,   ),        . </li><li>     ,    false        hasNext. ,     isDone,   ,     .   - ,   hasNext        ,         false.        ,       hasNext  ,    false      ,      .          ,      . </li><li>        ,    ,     ,     . </li><li>  next      .    ,        hasNext,    next        . </li><li>     Publisher-  ,       ,   subscription,       Publisher-.     requestSize.         . </li></ol><br>  ,       ,   ,   : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6m/bg/fu/6mbgfuuatqlimwnapnl3tlrzn8q.png"></div> <i> 8.       .</i> <br><br><h3>  :      </h3><br>      ,        ,      .     ,       HTTP ,      .         . <br><br>    ‚Äì         .    ,     ,       Hadoop ,      .  ,    ,       -       .     ,  ,   hdfs, ,          , ,       . <br><br>  ,         . ,   akka-http              ,         .   ,      -,       -       Apache Spark ,       ,  ,    -. <br><br> ,   ,         .   ,   ,        http-,          ,     . <br><br>          ,         .  ,        ,    .     ,   .  ,         . <br><br>                ,    . ,  ,    Hadoop    ,           ,     . <br><br>  ,  ,  Hadoop-    ,     ,         . <br><br>  ,  ,          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CleverDATA</a> .                      .  ,  ,     ,  ,    ,            .  ,            . <br><br><div class="spoiler"> <b class="spoiler_title">,      .</b> <div class="spoiler_text"><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©veloppeur Java</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ing√©nieur syst√®me</font></font></a> </li></ul><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413141/">https://habr.com/ru/post/fr413141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413129/index.html">25 erreurs d'un programmeur d√©butant</a></li>
<li><a href="../fr413133/index.html">Antipatterns populaires: pagination</a></li>
<li><a href="../fr413135/index.html">Mission de test de r√©vision de code des d√©veloppeurs juniors de React</a></li>
<li><a href="../fr413137/index.html">Classer de grandes quantit√©s de donn√©es sur Apache Spark √† l'aide de mod√®les d'apprentissage automatique arbitraires</a></li>
<li><a href="../fr413139/index.html">Voitures √©lectriques: la r√©volution arrive</a></li>
<li><a href="../fr413143/index.html">Bobby Urban Lite: le nouveau sac √† dos urbain de XD Design</a></li>
<li><a href="../fr413145/index.html">Un analyste aide les entreprises √† gagner de l'argent</a></li>
<li><a href="../fr413147/index.html">Est-il possible d'utiliser Tibero au lieu d'Oracle. Et est-ce n√©cessaire</a></li>
<li><a href="../fr413149/index.html">Entrep√¥t de donn√©es distribu√© dans le concept Data Lake: par o√π commencer</a></li>
<li><a href="../fr413151/index.html">La NSA a propos√© une norme de chiffrement pour les appareils IoT, mais l'ISO l'a rejet√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>