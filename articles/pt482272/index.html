<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèæ ü§∏üèª üöû Escolhendo um data warehouse para Prometheus: Thanos vs VictoriaMetrics üìÆ ü§™ ü•´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal. Abaixo est√° uma transcri√ß√£o do relat√≥rio com o Big Monitoring Meetup 4 . 


 O Prometheus √© um sistema de monitoramento para v√°rios siste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escolhendo um data warehouse para Prometheus: Thanos vs VictoriaMetrics</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482272/"><p>  Ol√° pessoal.  Abaixo est√° uma transcri√ß√£o do <a href="https://www.youtube.com/watch%3Fv%3DHyOXAdQE0Pk" rel="nofollow">relat√≥rio com o Big Monitoring Meetup 4</a> . </p><br><p>  <strong><a href="https://github.com/prometheus" rel="nofollow">O Prometheus</a></strong> √© um sistema de monitoramento para v√°rios sistemas e servi√ßos, com o qual os administradores de sistemas podem coletar informa√ß√µes sobre os par√¢metros atuais dos sistemas e configurar alertas para receber notifica√ß√µes de desvios na opera√ß√£o dos sistemas. </p><br><p>  O relat√≥rio comparar√° <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> e <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> , projetos para o armazenamento de longo prazo das m√©tricas do Prometheus. </p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/vm/ha/hd/vmhahdu2edj4dsc6o3lvzaf-noo.png"></p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HyOXAdQE0Pk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p><img src="https://habrastorage.org/webt/op/ni/ao/opniaodpqcis34bw3f4-twdnsic.png"></p><br><p>  Primeiro, vou falar sobre Prometeu.  Este √© um sistema de monitoramento que coleta m√©tricas de determinados destinos e as salva no armazenamento local.  O Prometheus pode gravar m√©tricas em um reposit√≥rio remoto, pode gerar alertas e regras de grava√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/dl/ji/yn/dljiynnywlw3fcjl7oc3m7lgstw.png"></p><br><h3 id="ogranicheniya-prometheus">  Limita√ß√µes do Prometheus: </h3><br><ul><li>  N√£o possui uma visualiza√ß√£o de consulta global.  √â quando voc√™ tem v√°rias inst√¢ncias independentes do prometheus.  Eles coletam m√©tricas.  E voc√™ deseja fazer uma solicita√ß√£o al√©m de todas essas m√©tricas coletadas de diferentes inst√¢ncias do prometheus.  Prometeu n√£o permite isso. </li><li>  Com o prometheus, o desempenho √© limitado a apenas um servidor.  O Prometheus n√£o pode ser dimensionado automaticamente para v√°rios servidores.  Voc√™ s√≥ pode dividir manualmente seus destinos entre v√°rios Prometheus. </li><li>  O volume de m√©tricas no Prometheus √© limitado a apenas um servidor pelo mesmo motivo que n√£o pode ser dimensionado automaticamente para v√°rios servidores. </li><li>  No Prometheus, n√£o √© t√£o f√°cil organizar a seguran√ßa dos dados. </li></ul><br><p><img src="https://habrastorage.org/webt/t3/wi/lf/t3wilf2sbn7ndupjqbe1wgxqrzw.png"></p><br><h3 id="resheniya-etih-problemzadach">  Resolvendo esses problemas / desafios? </h3><br><p>  As solu√ß√µes s√£o: </p><br><ul><li>  <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> </li><li>  <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> </li><li>  <a href="https://github.com/m3db" rel="nofollow">Uber m3</a> </li><li>  <a href="https://github.com/cortexproject/cortex" rel="nofollow">Cortex</a> </li></ul><br><p>  Todas essas solu√ß√µes de armazenamento remoto coletadas pela Prometheus.  Eles resolvem o problema do armazenamento remoto do slide anterior de diferentes maneiras.  Nesta apresenta√ß√£o, falarei apenas das duas primeiras solu√ß√µes: <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> e <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p>  Pela primeira vez, informa√ß√µes sobre <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> apareceram <a href="https://improbable.io/blog/thanos-prometheus-at-scale" rel="nofollow">neste link</a> .  Ele descreve a arquitetura de <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> e como funciona. </p><br><p><img src="https://habrastorage.org/webt/wg/bq/-b/wgbq-b3pwr1emeewan-q5hszprs.png"></p><br><p>  Thanos pega os dados que o Prometheus salvou no disco local e os copia para o S3, para o <a href="https://cloud.google.com/storage/" rel="nofollow">GCS</a> ou para outro armazenamento de objeto. </p><br><p><img src="https://habrastorage.org/webt/p7/4g/rj/p74grj159fi9xb58vq-hphcrqyi.png"></p><br><p>  Dessa forma, o Thanos fornece uma vis√£o de consulta global.  Voc√™ pode solicitar dados armazenados no armazenamento de objetos de v√°rias inst√¢ncias do Prometheus. </p><br><p><img src="https://habrastorage.org/webt/aj/3u/wi/aj3uwi8dd4wgy-fyogditn--kek.png"></p><br><p>  Thanos suporta PromQL e a <a href="https://prometheus.io/docs/prometheus/latest/querying/api/" rel="nofollow">API de consulta</a> do <a href="https://prometheus.io/docs/prometheus/latest/querying/api/" rel="nofollow">Prometheus</a> . </p><br><p><img src="https://habrastorage.org/webt/sr/t7/ql/srt7qlyoruhbxr5wglfuyhi9jp4.png"></p><br><p>  Thanos usa o c√≥digo Prometheus para armazenar dados. </p><br><p><img src="https://habrastorage.org/webt/3y/ws/ik/3ywsiklzziqimz1aig7uzieblqw.png"></p><br><p>  Thanos est√° sendo desenvolvido pelos mesmos desenvolvedores que o Prometheus. </p><br><p>  Sobre a <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> .  Aqui est√° o <a href="https://medium.com/faun/victoriametrics-creating-the-best-remote-storage-for-prometheus-5d92d66787ac" rel="nofollow">link</a> em que conversamos sobre o <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/z9/q2/wv/z9q2wvhshsoqb1ron0jx47djiwc.png"></p><br><p>  O VictoriaMetrics recebe dados de v√°rios prometheus por meio do protocolo <a href="https://prometheus.io/docs/practices/remote_write/" rel="nofollow">API de grava√ß√£o remota</a> suportado pelo Prometheus. </p><br><p><img src="https://habrastorage.org/webt/pl/xl/ad/plxladg1rdvyudc0wzs5oc2ljsa.png"></p><br><p>  O VictoriaMetrics fornece uma visualiza√ß√£o de consulta global, pois v√°rias inst√¢ncias do Prometheus podem gravar dados em um VictoriaMetrics.  Assim, voc√™ pode fazer solicita√ß√µes para todos esses dados. </p><br><p><img src="https://habrastorage.org/webt/9l/cp/aw/9lcpawp68_pq2mrhzya9okprroy.png"></p><br><p>  O VictoriaMetrics tamb√©m suporta, como Thanos, PromQL e a API de consulta do Prometheus. </p><br><p><img src="https://habrastorage.org/webt/d1/t1/ek/d1t1ek9rbq_ftlasl48scoriyq0.png"></p><br><p>  Ao contr√°rio de Thanos, o c√≥digo fonte do VictoriaMetrics √© escrito do zero e otimizado para velocidade e recursos. </p><br><p><img src="https://habrastorage.org/webt/ps/t6/gu/pst6guuoseu2dicx9tra1bvjhry.png"></p><br><p>  O VictoriaMetrics, diferentemente de Thanos, √© dimensionado vertical e horizontalmente.  H√° uma <a href="" rel="nofollow">vers√£o de n√≥ √∫nico</a> que √© dimensionada verticalmente.  Voc√™ pode come√ßar com um processador e 1 GB de mem√≥ria e aumentar gradualmente para centenas de processadores e 1 TB de mem√≥ria.  VictoriaMetrics pode usar todos esses recursos.  Seu desempenho aumentar√° cerca de 100 vezes em compara√ß√£o com um sistema de n√∫cleo √∫nico. </p><br><p><img src="https://habrastorage.org/webt/tb/s7/t4/tbs7t4unnruaytt7duwambgofne.png"></p><br><p>  A hist√≥ria de Thanos come√ßou em novembro de 2017, quando o primeiro commit p√∫blico apareceu.  Antes disso, o Thanos foi desenvolvido internamente pelo <a href="https://improbable.io/" rel="nofollow">improbable.io</a> . </p><br><p><img src="https://habrastorage.org/webt/ik/g7/dg/ikg7dgnmbyiph40zo7v7kyhxrdy.png"></p><br><p>  Em junho de 2019, houve um marco de lan√ßamento 0.5.0, no qual o protocolo de <a href="https://en.wikipedia.org/wiki/Gossip_protocol" rel="nofollow">fofocas</a> foi <a href="https://thanos.io/proposals/201809_gossip-removal.md/" rel="nofollow">removido</a> .  Ele foi removido de Thanos porque n√£o fez o seu melhor.  Frequentemente, o cluster Thanos n√£o funcionava corretamente, os n√≥s conectados a ele incorretamente devido ao protocolo de fofocas.  Portanto, eles decidiram remov√™-lo de l√°.  Eu acho que essa √© a decis√£o certa. </p><br><p><img src="https://habrastorage.org/webt/5y/bu/cu/5ybucuovkh85tqwsrv3cjre-zmu.png"></p><br><p>  Tamb√©m em junho de 2019, eles enviaram o aplicativo n√∫mero <a href="https://github.com/cncf/toc/pull/256" rel="nofollow">256</a> √† <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> . </p><br><p><img src="https://habrastorage.org/webt/16/rz/x_/16rzx_bswddquoqw4cmw9txobxa.png"></p><br><p>  Depois de alguns meses, Thanos ingressou na <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> , que inclui Prometheus, Kubernetes e outros projetos populares. </p><br><p><img src="https://habrastorage.org/webt/9c/i2/ic/9ci2ictg_n0xtgdcxtklghw4n2w.png"></p><br><p>  Em janeiro de 2018, o desenvolvimento do VictoriaMetrics come√ßou. </p><br><p><img src="https://habrastorage.org/webt/wi/li/co/wiliconuw5mwhyzizzthqk8a2og.png"></p><br><p>  Em setembro de 2018, mencionei publicamente o VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/gd/th/ka/gdthkaxubi8jzg8gedilcotjdje.png"></p><br><p>  Em dezembro de 2018, a vers√£o de n√≥ √∫nico foi publicada. </p><br><p><img src="https://habrastorage.org/webt/ui/r7/23/uir723wmd-l1dwxds6katr8cfco.png"></p><br><p>  Em maio de 2019 <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">, as</a> fontes da vers√£o do n√≥ √∫nico e da cluster <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">foram publicadas</a> . </p><br><p><img src="https://habrastorage.org/webt/a7/tk/ug/a7tkughz1ut9dmlfb6ued1irbh8.png"></p><br><p>  Em junho de 2019, como Thanos, aplicamos a funda√ß√£o CNCF no n√∫mero <a href="https://github.com/cncf/toc/pull/255" rel="nofollow">255</a> .  N√≥s aplicamos um dia antes da Thanos. </p><br><p><img src="https://habrastorage.org/webt/pk/dm/zr/pkdmzr2xn880osldinx6sb10-ai.png"></p><br><p>  Infelizmente, ainda n√£o fomos aceitos l√°.  Precisa de ajuda da comunidade. </p><br><p><img src="https://habrastorage.org/webt/mw/2w/we/mw2wwenfu8tecrrkyrkx-8dhf-8.png"></p><br><p>  Considere os slides mais importantes que mostram a arquitetura de Thanos e VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/1w/by/96/1wby96ev7cqhx7-psbem1b-bf-i.png"></p><br><p>  Vamos come√ßar com Thanos.  Componentes amarelos s√£o componentes do Prometheus.  Tudo o resto s√£o os componentes Thanos.  Vamos come√ßar com o componente mais importante.  O Thanos Sidecar √© um componente instalado ao lado de cada Prometheus.  Ele est√° comprometido em carregar dados do Prometheus do armazenamento local no S3 ou em outro Object Storage. </p><br><p>  Tamb√©m existe um componente como o Thanos Store Gateway, que pode ler esses dados do Object Storage ap√≥s solicita√ß√µes recebidas da Thanos Query.  O Thanos Query implementa o PromQL e a API do Prometheus.  Ou seja, do lado de fora parece um Prometeu.  Ele aceita consultas PromQL, as envia para o Thanos Store Gateway, o Thanos Store Gateway recupera os dados necess√°rios do Object Storage, os envia de volta. </p><br><p>  Mas n√≥s armazenamos dados no Object Storage sem as duas √∫ltimas horas devido √† peculiaridade da implementa√ß√£o do Thanos Sidecar, que n√£o pode carregar as √∫ltimas duas horas no Object Storage S3, porque nessas duas horas o Prometheus ainda n√£o criou arquivos no armazenamento local. </p><br><p>  Como eles decidiram contornar isso?  A Consulta Thanos, al√©m de solicita√ß√µes do Thanos Store Gateway, envia solicita√ß√µes paralelas a todos os Thanos Sidecar localizados ao lado de Prometheus. </p><br><p>  E o Thanos Sidecar, por sua vez, solicita proxies adicionais no Prometheus e obt√©m dados pelas √∫ltimas duas horas. </p><br><p>  Al√©m desses componentes, h√° tamb√©m um componente opcional sem o qual Thanos n√£o se sentir√° bem.  Este √© o Thanos Compact, que mescla arquivos pequenos no Armazenamento de Objetos em arquivos maiores que foram carregados aqui pelo Thanos Sidecar.  O Thanos Sidecar carrega arquivos de dados l√° em duas horas.  Esses arquivos, se voc√™ n√£o os mesclar em arquivos maiores, o n√∫mero deles poder√° aumentar significativamente.  Quanto mais esses arquivos, mais mem√≥ria √© necess√°ria para o Thanos Store Gateway, mais recursos s√£o necess√°rios para transferir dados pela rede, metadados.  O Thanos Store Gateway est√° se tornando ineficiente.  Portanto, voc√™ deve definitivamente executar o Thanos Compact, que mescla arquivos pequenos em arquivos maiores, para que haja menos arquivos e reduza a sobrecarga no Thanos Store Gateway. </p><br><p>  Tamb√©m existe um componente como o Thanos Ruler.  Ele segue as regras de alerta do Prometheus e pode calcular as regras de grava√ß√£o do Prometheus para gravar dados no Armazenamento de Objetos.  Mas este componente n√£o √© recomendado, porque  ele est√° <a href="" rel="nofollow">inclinado a retornar dados incompletos</a> . </p><br><p>  Este √© um esquema simples para Thanos. </p><br><p><img src="https://habrastorage.org/webt/os/em/y4/osemy4ys_bkpy-ngxj7jg-gdmom.png"></p><br><p>  Agora compare com o esquema VictoriaMetrics. </p><br><p>  O VictoriaMetrics possui 2 vers√µes: Vers√£o de n√≥ √∫nico e cluster.  O n√≥ √∫nico √© executado em um √∫nico computador.  O n√≥ √∫nico n√£o possui esses componentes, apenas um bin√°rio.  Esse bin√°rio no slide se parece com esse quadrado.  Tudo o que est√° dentro do quadrado √© o conte√∫do do arquivo bin√°rio da vers√£o de n√≥ √∫nico.  Voc√™ n√£o precisa saber sobre ele.  Basta iniciar o bin√°rio - e tudo funciona para n√≥s. </p><br><p>  A vers√£o do cluster √© mais complicada.  Dentro dele, existem tr√™s componentes diferentes: vmselect, vminsert e vmstorage.  Pelo nome, deve ficar claro o que cada um deles faz.  O componente Inserir aceita dados em diferentes formatos: da API de grava√ß√£o remota Prometheus, protocolo de linha de influxo, protocolo de grafite e protocolo OpenTSDB.  O componente Inserir os aceita, analisa e distribui entre os componentes de armazenamento existentes, onde os dados j√° est√£o armazenados.  O componente Select, por sua vez, aceita consultas PromQL.  Ele implementa o <a href="https://medium.com/%40valyala/promql-tutorial-for-beginners-9ab455142085" rel="nofollow">PromQL</a> , bem como a API de consulta do Prometheus, e pode ser usado como um substituto para o Prometheus no Grafana ou em outros clientes da API do Prometheus.  O Select aceita uma solicita√ß√£o promql, analisa-a, l√™ os dados necess√°rios para executar essa solicita√ß√£o no n√≥ de armazenamento, processa esses dados e retorna uma resposta. </p><br><p><img src="https://habrastorage.org/webt/sb/co/mx/sbcomx2usdrwzbyfgqjubvoichg.png"></p><br><p>  Compare a dificuldade de instalar o Thanos e o VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/hv/gw/r6/hvgwr6nk7yh4nog7rpjac4fn0se.png"></p><br><p>  Vamos come√ßar com Thanos.  Antes de come√ßar a trabalhar com o Thanos, voc√™ precisa criar um bucket no Object Storage, como S3 ou GCS, para que o Thanos Sidecar possa gravar dados l√°. </p><br><p><img src="https://habrastorage.org/webt/st/hk/5s/sthk5swss1mkaalb4p3oiebnesq.png"></p><br><p>  Ent√£o, para cada Prometheus, voc√™ precisar√° instalar o Thanos Sidecar.  Antes disso, lembre-se de desativar a compacta√ß√£o de dados no Prometheus.  A compacta√ß√£o de dados compacta periodicamente os dados no armazenamento local do Prometheus para reduzir o consumo de recursos. </p><br><p>  Ao instalar o Thanos Sidecar no Prometheus, voc√™ deve desativar essa compacta√ß√£o de dados, porque o Thanos Sidecar n√£o pode funcionar normalmente quando a compacta√ß√£o de dados est√° ativada.  Isso significa que seu Prometheus come√ßa a salvar dados em blocos de duas horas e para de mesclar esses blocos em blocos maiores.  Portanto, se voc√™ fizer solicita√ß√µes superiores √†s √∫ltimas duas horas, elas n√£o funcionar√£o da maneira mais eficiente poss√≠vel se a compacta√ß√£o de dados estiver ativada. </p><br><p><img src="https://habrastorage.org/webt/gd/as/pw/gdaspwys_r63cegoxqovl9bcmie.png"></p><br><p>  Portanto, a Thanos recomenda reduzir o tempo de reten√ß√£o de dados no armazenamento local para 6-8 horas, a fim de reduzir essa sobrecarga de um grande n√∫mero de pequenos blocos. </p><br><p>  Depois de instalar o Thanos Sidecar, voc√™ deve instalar dois componentes para cada Object Storage Bucket.  Estes s√£o o Thanos Compactor e o Thanos Store Gateway. </p><br><p><img src="https://habrastorage.org/webt/cw/4f/yk/cw4fyksvnkmp1tcn-clf-2gzx3q.png"></p><br><p>  Depois disso, √© necess√°rio instalar o Thanos Query e configur√°-lo para que ele saiba como se conectar a todo o Thanos Store Gateway que voc√™ possui e tamb√©m saiba como se conectar a todos os Thanos Sidecar. </p><br><p>  Pode haver um pequeno problema. </p><br><p><img src="https://habrastorage.org/webt/vf/sc/30/vfsc30z00pvcnupbdym2jztx09k.png"></p><br><p>  Voc√™ precisa configurar uma conex√£o confi√°vel e segura do Thanos Query para esses componentes.  E se o seu Prometheus estiver localizado em diferentes data centers ou em diferentes VPCs, as conex√µes externas a eles ser√£o proibidas.  Mas, para que o Thanos Query funcione, √© necess√°rio configurar a conex√£o de alguma forma e √© preciso criar uma maneira. </p><br><p>  Se voc√™ possui muitos desses datacenters, a confiabilidade de todo o sistema diminui.  Como o Thanos Query deve estar constantemente conectado a todos os Thanos Sidecar localizados em diferentes datacenters.  A cada solicita√ß√£o recebida, ele encaminhar√° solicita√ß√µes para todos os Thanos Sidecar.  Se a conex√£o for interrompida, voc√™ receber√° um conjunto incompleto de dados ou a resposta "o cluster n√£o funciona". </p><br><p><img src="https://habrastorage.org/webt/rb/ka/aw/rbkaawevhardp1d85mhgdejylxg.png"></p><br><p>  No VictoriaMetrics, as coisas s√£o um pouco mais f√°ceis.  Para a vers√£o de n√≥ √∫nico, basta executar um bin√°rio e tudo funciona. </p><br><p><img src="https://habrastorage.org/webt/co/ui/ll/couillafhtmobnbutejgs6qvszu.png"></p><br><p>  Em uma vers√£o em cluster, basta executar todos os tr√™s tipos de componentes acima em qualquer quantidade que voc√™ precisar ou usar o <a href="https://github.com/VictoriaMetrics/helm-charts/" rel="nofollow">gr√°fico de comando</a> para automatizar o lan√ßamento de componentes no Kubernetes.  Ainda estamos planejando fazer um operador Kubernetes.  O gr√°fico do leme n√£o cobre alguns casos e permite que voc√™ atire na perna.  Por exemplo, permite reduzir o n√∫mero de n√≥s de armazenamento, o que levar√° √† perda de dados. </p><br><p><img src="https://habrastorage.org/webt/jb/ta/0t/jbta0t7qcko6jov_x1ximqkfni0.png"></p><br><p>  Depois de iniciar uma vers√£o bin√°ria ou de cluster, basta adicionar a <a href="" rel="nofollow">configura√ß√£o do URL de grava√ß√£o remota</a> √† configura√ß√£o do Prometheus para que ela comece a gravar dados em paralelo ao armazenamento local e armazenamento remoto.  Como voc√™ notou, essa configura√ß√£o deve funcionar muito mais confi√°vel em compara√ß√£o com a configura√ß√£o Thanos.  N√£o precisamos manter o VictoriaMetrics conectado a todo o Prometheus, porque o pr√≥prio Prometheus se conecta ao VictoriaMetrics e transmite os dados. </p><br><p><img src="https://habrastorage.org/webt/u3/3a/if/u33aifuu7myx3vvs0mkbeysfnei.png"></p><br><p>  Considere as escoltas Thanos e VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/fq/dt/d2/fqdtd27cjx-yktnyozgxoon2pte.png"></p><br><p>  Thanos precisa ficar de olho no Sidecar para que ele n√£o pare de carregar dados no Object Storage.  Eles podem interromper o carregamento desses dados devido a erros de carregamento, por exemplo, sua conex√£o de rede com o Armazenamento de Objetos est√° temporariamente desconectada ou o Armazenamento de Objetos est√° temporariamente indispon√≠vel.  O Thanos Sidecar notar√° isso neste momento, reportar√° um erro, poder√° cair e parar de funcionar.  Se voc√™ n√£o o monitorar, seus dados n√£o ser√£o mais transferidos para o Armazenamento de Objetos.  Se o tempo de reten√ß√£o passar (recomenda-se de 6 a 8 horas), voc√™ perder√° dados que n√£o ca√≠ram no Armazenamento de Objetos. </p><br><p><img src="https://habrastorage.org/webt/z7/bm/cx/z7bmcxgwyscnrnnehhtjvuqipho.png"></p><br><p>  Os compactadores Thanos podem parar de funcionar devido √† <a href="https://github.com/thanos-io/thanos/issues/1919" rel="nofollow">corrida com o Sidecar</a> .  Os compactadores pegam dados do Object Storage e os mesclam em peda√ßos maiores de dados.  Como os compactadores n√£o est√£o sincronizados com o Sidecar, isso pode acontecer: o Sidecar ainda n√£o terminou de escrever o bloco, o Compactador decide que esse bloco est√° completamente gravado.  O compactador come√ßa a l√™-lo.  Ele n√£o l√™ o bloco na √≠ntegra e para de funcionar.  Veja detalhes <a href="https://thanos.io/proposals/201901-read-write-operations-bucket.md/" rel="nofollow">aqui</a> . </p><br><p><img src="https://habrastorage.org/webt/_u/c6/hb/_uc6hbgr_kl9l2an5yl0cs9hfba.png"></p><br><p>  O Store Gateway pode fornecer dados inconsistentes devido √† corrida entre o Compactador e o Sidecar.  √â a mesma coisa, porque o Gateway de loja n√£o est√° de forma alguma sincronizado com o Compactor e o Sidecar.  Consequentemente, uma condi√ß√£o de corrida pode ocorrer quando o Store Gateway n√£o v√™ parte dos dados ou v√™ dados em excesso. </p><br><p><img src="https://habrastorage.org/webt/-y/20/ur/-y20urze7qgwxkrklj8ave_ct3i.png"></p><br><p>  O componente Consulta no Thanos √© padronizado para resultados parciais se alguns Sidecar ou Store Gateway n√£o estiverem dispon√≠veis no momento.  Voc√™ receber√° uma parte dos dados e nem saber√° que nem todos os dados foram recebidos.  Que funciona assim por padr√£o.  Em uma situa√ß√£o semelhante, o VictoriaMetrics retorna os dados marcados como parciais. </p><br><p><img src="https://habrastorage.org/webt/2g/op/wp/2gopwpbh41vviugdebarsjuql4w.png"></p><br><p>  Ao contr√°rio de Thanos, o VictoriaMetrics raramente perde dados.  Mesmo que a conex√£o do Prometheus ao VictoriaMetrics seja interrompida, isso n√£o √© um problema, pois o Prometheus continua registrando novos dados recebidos no Write Ahead Log, que tem 2 horas de tamanho.  Se voc√™ se reconectar ao VictoriaMetrics dentro de duas horas, os dados n√£o ser√£o perdidos.  O Prometheus <a href="https://grafana.com/blog/2019/03/25/whats-new-in-prometheus-2.8-wal-based-remote-write/" rel="nofollow">pode adicionar dados ap√≥s se reconectar ao VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/kg/nl/mv/kgnlmvkqxfagsjhodoybpwzl7am.png"></p><br><p>  Diferentemente do Thanos, que grava dados apenas no armazenamento de objetos ap√≥s duas horas, o Prometheus replica automaticamente os dados por meio do protocolo de grava√ß√£o remota no armazenamento remoto, como o VictoriaMetrics.  Voc√™ n√£o tem medo de perder armazenamento local no Prometheus.  Se, de repente, ele perdeu o armazenamento local, na pior das hip√≥teses, voc√™ perder√° os √∫ltimos segundos de dados que n√£o tiveram tempo de gravar no armazenamento remoto. </p><br><p><img src="https://habrastorage.org/webt/ba/xj/90/baxj90beqmojti9xkubodbkbvdw.png"></p><br><p>  O Kubernetes gerencia automaticamente o cluster, ao contr√°rio de Thanos.  √â dif√≠cil colocar todos os componentes Thanos em um √∫nico cluster Kubernetes, ao contr√°rio dos componentes de cluster VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/gz/lb/6l/gzlb6lg2dkrabcovqcohvovd-mk.png"></p><br><p>  O VictoriaMetrics possui uma atualiza√ß√£o muito simples para a nova vers√£o.  Basta parar o VictoriaMetrics, atualizar os bin√°rios e executar.  Ao parar atrav√©s de um sinal SIGINT, todos os bin√°rios VictoriaMetrics fazem um desligamento completo.  Eles salvam corretamente os dados necess√°rios, fecham corretamente as conex√µes de entrada para n√£o perder nada.  Portanto, voc√™ n√£o perder√° nada ao atualizar. </p><br><p><img src="https://habrastorage.org/webt/qz/yf/8c/qzyf8cvpqlimwabno0zx7v5_rxw.png"></p><br><p>  O VictoriaMetrics possui uma maneira muito simples de expandir um cluster.  Basta adicionar os componentes necess√°rios e continuar trabalhando. </p><br><p><img src="https://habrastorage.org/webt/hl/le/sj/hllesjwiv-f1wosgssd7wp6aclo.png"></p><br><p>  Sobre as armadilhas em Thanos e Victoria Metrics. </p><br><p><img src="https://habrastorage.org/webt/xs/ec/b0/xsecb0yy15vimtsl9k9quqplyiw.png"></p><br><p>  Thanos tem as seguintes armadilhas.  O Prometheus deve armazenar dados nas √∫ltimas duas horas.  Se eles forem perdidos, voc√™ os perder√° completamente, pois eles ainda n√£o conseguiram se registrar no Object Storage, como o S3. </p><br><p><img src="https://habrastorage.org/webt/fg/xo/yo/fgxoyo1q8mihcdy7m_yyio_pyum.png"></p><br><p>  O componente Store Gateway e o componente compactador podem exigir muita mem√≥ria para funcionar com o Armazenamento de Objetos grande, se muitos arquivos pequenos estiverem armazenados l√°.  Quanto maior o n√∫mero e o volume de arquivos, mais o Store Gateway e a mem√≥ria do compactador s√£o necess√°rios para armazenar as meta-informa√ß√µes.  Thanos tem muitos problemas com o <a href="https://github.com/thanos-io/thanos/issues/448" rel="nofollow">Store Gateway e o compactador caindo com a m√©dia de dados gravados</a> . </p><br><p><img src="https://habrastorage.org/webt/-n/k3/rg/-nk3rgph8ghszyegz1j8jx89bio.png"></p><br><p>  Thanos √© elogiado por poder escalar indefinidamente pela quantidade de seu Prometeu.  Na verdade, isso n√£o √© verdade.  Como todas as solicita√ß√µes passam pelo componente Consulta, que deve pesquisar simultaneamente todos os componentes do Gateway de Loja e todos os componentes do Sidecar, retire os dados de l√° e os processe previamente.  Obviamente, a velocidade da consulta √© limitada pelo link fraco mais lento, pelo Gateway de Loja mais lento ou pelo Sidecar mais lento. </p><br><p>  Esses componentes podem ser carregados de maneira desigual.  Por exemplo, voc√™ tem um Prometheus que coleta milh√µes de m√©tricas por segundo.  E h√° o Prometheus, que coleta milhares de m√©tricas por segundo.  O Prometheus, que coleta milh√µes de m√©tricas por segundo, carrega o servidor em que executa muito mais.  Consequentemente, o Sidecar √© mais lento l√°.  Em geral, tudo funciona lentamente l√°.  E o componente Query extrair√° dados muito lentamente a partir da√≠.  Assim, o desempenho de todo o cluster ser√° limitado por esse Sidecar lento. </p><br><p><img src="https://habrastorage.org/webt/mg/an/ra/mganracsmhkyz1_1aq014v_6cfc.png"></p><br><p>  Por padr√£o, Thanos retorna dados parciais se alguns Sidecar e o Store Gateway estiverem indispon√≠veis.  Por exemplo, se voc√™ tiver o Sidecar espalhado pelo mundo em diferentes datacenters, a probabilidade de desconex√£o e indisponibilidade de componentes aumentar√° bastante.  Consequentemente, na maioria dos casos, voc√™ receber√° dados parciais sem nem mesmo saber. </p><br><p><img src="https://habrastorage.org/webt/1t/m2/j7/1tm2j75o5cpscbevahbz4m0wusk.png"></p><br><p>  VictoriaMetrics tamb√©m tem armadilhas.  A primeira armadilha √© uma op√ß√£o que limita a quantidade de RAM usada para o cache do VictoriaMetrics.  Por padr√£o, √© igual a 60% da RAM na m√°quina em que o VictoriaMetrics est√° sendo executado ou 60% da RAM do pod VictoriaMetrics no Kubernetes. </p><br><p>  Se voc√™ alterar incorretamente esse valor, poder√° prejudicar o desempenho do VictoriaMetrics.  Por exemplo, se voc√™ definir o valor muito baixo, os dados poder√£o n√£o caber mais no cache do VictoriaMetrics.  Por isso, ela ter√° que fazer um trabalho extra e carregar o processador com o disco.  Se voc√™ tornar essa op√ß√£o muito grande, aumentar√°, em primeiro lugar, a probabilidade de o VictoriaMetrics travar com erro de falta de mem√≥ria e, em segundo lugar, isso levar√° a pouqu√≠ssima mem√≥ria operacional restante no sistema operacional mem√≥ria para o cache do arquivo.  E o VictoriaMetrics conta com um cache de arquivos para desempenho.  Se n√£o for suficiente, a carga no disco poder√° aumentar bastante.  Portanto, uma dica: n√£o altere o par√¢metro, a menos que seja absolutamente necess√°rio. </p><br><p><img src="https://habrastorage.org/webt/3q/eo/25/3qeo25x5juqpyquhllrhpt9eh34.png"></p><br><p>  A segunda op√ß√£o  Este √© retentionPeriod - o per√≠odo definido como 1 m√™s por padr√£o.  Este √© o momento em que o VictoriaMetrics armazena dados.  Ap√≥s esse per√≠odo, o VictoriaMetrics exclui os dados. </p><br><p>  Muitos executam o VictoriaMetrics sem esse par√¢metro, eles registram dados por um m√™s.  E ent√£o perguntam: por que os dados desapareceram no m√™s anterior?  Como retentionPeriod √© de 1 m√™s por padr√£o.  Portanto, voc√™ precisa conhecer e definir o retentionPeriod correto. </p><br><p><img src="https://habrastorage.org/webt/n1/5a/jm/n15ajmeqozq7zfzc0uv3imzfebw.png"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/k8/b7/br/k8b7brhqxwy1fa1vdurx0yolgra.png"></p><br><p>  Thanos   ,  downsampling: 5-   ,   <a href="https://github.com/thanos-io/thanos/issues%3Futf8%3D%25E2%259C%2593%26q%3Dis%253Aissue%2Bis%253Aopen%2Bdownsampling" rel="nofollow"> </a> .      issue  github,    issues,    downsampling,     ,    ,   . </p><br><p><img src="https://habrastorage.org/webt/iv/nq/4v/ivnq4vtxkkwf_1hs40ttkyhd1ie.png"></p><br><p>  Thanos     Prometheus HA pairs.   Prometheus'            target'  Thanos    Object Storage. Thanos     ,    VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/wn/rv/jh/wnrvjhzqrcx6_o9hoojijeivb8o.png"></p><br><p>  Thanos  alert ,     Thanos.   <a href="" rel="nofollow">    production</a> . </p><br><p><img src="https://habrastorage.org/webt/ti/qp/ci/tiqpcidg_t_ahj9lornrey8_rda.png"></p><br><p>  Thanos ,    Thanos   Prometheus ‚Äî . Thanos  Prometheus      .    Thanos  Prometheus   . </p><br><p><img src="https://habrastorage.org/webt/en/vo/o-/envoo-2amya3w4xo2c5lg-pa1bo.png"></p><br><p>  VictoriaMetrics    ‚Äî MetricsQL.   VictoriaMetrics  PromQL,       big monitoring metup. </p><br><p><img src="https://habrastorage.org/webt/yk/xq/hi/ykxqhipgapygdv7ra2c6rmaitnk.png"></p><br><p> VictoriaMetrics       . VictoriaMetrics       Prometheus,     Influx, OpenTSDB  Graphite. </p><br><p><img src="https://habrastorage.org/webt/0k/zy/jp/0kzyjptb5sbscny1ffsdh2irqau.png"></p><br><p>  VictoriaMetrics         Thanos  Prometheus. </p><br><p>    ,     2-5          Prometheus  Thanos. </p><br><p><img src="https://habrastorage.org/webt/2y/xz/yg/2yxzygpbfnqt3ldibpggeo35rpw.png"></p><br><p>    VictoriaMetrics ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/kk/jd/hy/kkjdhy-zae6bc_3uqu6yp3q1gwy.png"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/79/yz/yw/79yzywujo1uxm6zc5rti6ebjzpq.png"></p><br><p>    Thanos  ,      object storage,   . </p><br><p>     object storage,         ($10   ).      object storage,          ,       AWS ‚Äî  .    ,    $10  $230  1.    ,        Thanos . </p><br><p><img src="https://habrastorage.org/webt/eg/--/mv/eg--mv_wpjcv4m-tojp8l9r60ea.png"></p><br><p>  Thanos      Compact, Store Gateway, Query ,    ,     . </p><br><p><img src="https://habrastorage.org/webt/pz/0v/np/pz0vnpflfebkxmaqi3sbbucktz0.png"></p><br><p>  VictoriaMetrics  .     GCE HDD ,   $40  1.  VictoriaMetrics   HDD ,    SSD,      . VictoriaMetrics   HDD. </p><br><p><img src="https://habrastorage.org/webt/dr/6q/lz/dr6qlzowqew8et2zpev1wkrq4cs.png"></p><br><p><script type="text/javascript">function gtElInit() {var lib = new google.translate.TranslateService();lib.translatePage('ru', 'pt', function () {});}</script><script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=gtElInit&amp;client=wt"></script> O VictoriaMetrics precisa de servidores para componentes: componente √∫nico ou componentes de cluster, que, diferentemente dos componentes Thanos, exigem muito menos CPU, RAM - ser√° mais barato em conformidade. </p><br><p><img src="https://habrastorage.org/webt/ja/72/cr/ja72crhogqpdixrt8jzj-komdcq.png"></p><br><p>  Exemplos de implementa√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/od/ji/fw/odjifwunkpjdwuqq-hbpwswu_cy.png"></p><br><p>  O exemplo de implementa√ß√£o de Thanos √© o Gitlab.  O Gitlab √© totalmente alimentado por Thanos.  Mas n√£o √© t√£o suave.  Se voc√™ olhar para os <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8647" rel="nofollow">problemas</a> deles, poder√° ver que eles constantemente t√™m algum tipo de <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8413" rel="nofollow">problema operacional com o Thanos</a> : n√£o h√° mem√≥ria suficiente para os componentes Store Gateway ou Query.  Eles constantemente precisam aumentar a quantidade de mem√≥ria. </p><br><p>  Por esse motivo, os custos de solu√ß√£o desses problemas aumentam. </p><br><p>  A segunda implementa√ß√£o, que pode ter mais sucesso, √© a empresa Improv√°vel, que iniciou o desenvolvimento de Thanos.  Eles publicaram a fonte de Thanos.  Improv√°vel √© uma empresa que desenvolve mecanismos de jogos. </p><br><p><img src="https://habrastorage.org/webt/t4/yh/y4/t4yhy4gyfrimyzyfopgdwk1ixyc.png"></p><br><p>  Os exemplos p√∫blicos de implementa√ß√£o do VictoriaMetrics s√£o: </p><br><ul><li>  construtor de sites wix.com </li><li>  A Adidas apresenta o VictoriaMetrics e at√© fez uma apresenta√ß√£o no mais recente PromCon 2019 </li><li>  TrafficStars - rede de anunciantes </li><li>  O Seznam.cz √© um popular mecanismo de pesquisa tcheco. </li></ul><br><p>  E depois fui para o nome da empresa, que n√£o posso citar agora.  Eles n√£o concordaram. </p><br><ul><li>  Um grande desenvolvedor de jogos.  Maior que eles Improv√°vel. </li><li>  Um importante desenvolvedor de software gr√°fico. </li><li>  Grande banco russo. </li><li>  Fabricante europeu de turbinas e√≥licas que testou com sucesso o VictoriaMetrics.  Este fabricante implementa o VictoriaMetrics para monitorar dados de turbinas e√≥licas a uma velocidade de 50 amostras por segundo por sensor.  Cada turbina e√≥lica possui v√°rias centenas de sensores.  Eles t√™m v√°rias centenas de turbinas e√≥licas. </li><li>  Companhias a√©reas russas que querem introduzir VictoriaMetrics, mas ainda n√£o podem.  Estamos na fase de contrato com eles. </li></ul><br><p><img src="https://habrastorage.org/webt/lw/0f/r3/lw0fr3hdyce3yw6n0i3ywjnpxhs.png">  Conclus√µes </p><br><p>  VictoriaMetrics e Thanos resolvem problemas semelhantes, mas de maneiras diferentes: </p><br><ul><li>  Visualiza√ß√£o de consulta global </li><li>  escala horizontal </li><li>  reten√ß√£o arbitr√°ria </li></ul><br><p><img src="https://habrastorage.org/webt/pv/-b/ob/pv-bobndxjkjrcukph5xm3sa-98.png"></p><br><p>  Obrigada </p><br><p>  Estamos esperando por voc√™ no nosso <a href="https://t.me/VictoriaMetrics_ru1" rel="nofollow">canal de telegrama</a> . </p><br><p><img src="https://habrastorage.org/webt/gu/0s/w5/gu0sw56ppge1icdy-ensv-wl3f4.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482272/">https://habr.com/ru/post/pt482272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482258/index.html">Como as redes neurais funcionam e por que come√ßaram a trazer muito dinheiro</a></li>
<li><a href="../pt482262/index.html">Como fazer login no Talend Open Studio</a></li>
<li><a href="../pt482264/index.html">Brasil, magia negra, Mortal Kombat, Marte e 15.000 pessoas. Resultados do ano Ontiko</a></li>
<li><a href="../pt482268/index.html">Megaestruturas do futuro: a esfera de Dyson, o motor estelar e a "bomba do buraco negro"</a></li>
<li><a href="../pt482270/index.html">Transmiss√£o WebRTC dentro e ao redor da realidade virtual</a></li>
<li><a href="../pt482274/index.html">5 raz√µes pelas quais voc√™ deve parar de usar o System.Drawing no ASP.NET</a></li>
<li><a href="../pt482276/index.html">GOST R 57580. Das tend√™ncias √† automa√ß√£o eficiente</a></li>
<li><a href="../pt482280/index.html">Como √© feito o cosplay. Fato avan√ßado de Isaac Clarke para Dead Space 2</a></li>
<li><a href="../pt482282/index.html">O fim da era do ARMv7 ou um pouco sobre como portar jogos</a></li>
<li><a href="../pt482284/index.html">"50 tons de marrom" ou "como chegamos a isso"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>