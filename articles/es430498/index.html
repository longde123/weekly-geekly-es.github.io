<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçü§ù‚Äçüë®üèø üç∞ üßó Omitir el Control de cuentas de usuario (UAC) imitando directorios confiables üë©üèæ‚Äçüåæ üöí üë≤üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El experto en seguridad de la informaci√≥n David Wells ha publicado una forma de evitar los controles de la cuenta de usuario de UAC en Windows 10 

 H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Omitir el Control de cuentas de usuario (UAC) imitando directorios confiables</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430498/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ny/uq/43/nyuq43x709tvrsyldvgpxcq1ez0.jpeg"></div><br>  El experto en seguridad de la informaci√≥n David Wells ha publicado una forma de evitar los controles de la cuenta de usuario de UAC en Windows 10 <br><a name="habracut"></a><br>  Hola a todos! <br><br>  Mientras investigaba algunas nuevas soluciones para el Control de cuentas de usuario (UAC), descubr√≠ una soluci√≥n completamente nueva para UAC en el momento de escribir este art√≠culo.  Vale la pena se√±alar que Microsoft no considera UAC como un l√≠mite de seguridad, sin embargo, a√∫n informamos de varios errores en Microsoft y quiero compartir los detalles de la vulnerabilidad que encontr√© aqu√≠.  Este m√©todo se ha probado con √©xito en Windows 10 Build 17134. Antes de profundizar en los detalles de mi hallazgo, primero le dar√© una peque√±a explicaci√≥n sobre c√≥mo funciona el servicio UAC. <br><br>  <b>Imprimaci√≥n Uac</b> <br><br>  Cuando un usuario que es miembro del grupo Administradores desea ejecutar una aplicaci√≥n que requiere privilegios elevados, el UAC muestra una solicitud correspondiente y un usuario que es miembro del grupo Administradores debe confirmar la acci√≥n. Sin embargo, esta solicitud UAC no se produce para TODOS los archivos ejecutables administrativamente en Windows .  Hay algunas excepciones que elevar√°n "autom√°ticamente" los privilegios de un archivo ejecutable sin causar una solicitud de UAC, sin pasar por UAC (¬°para su sorpresa!).  Este grupo particular de ejecutables confiables seleccionados se somete a controles de seguridad adicionales por parte del sistema para asegurarse de que estos archivos sean realmente confiables, por lo tanto, los atacantes de informaci√≥n generalmente no abusan de esta caracter√≠stica.  Este enfoque se us√≥ en m√©todos de derivaci√≥n UAC anteriores y ser√° la base de mi nuevo m√©todo de derivaci√≥n.  Sin embargo, hay algunas lagunas que debemos tomar para que nuestro ataque tenga √©xito.  Echemos un vistazo a los requisitos que deben cumplirse si queremos que nuestro ejecutable sea "elevado autom√°ticamente a privilegios".  Para hacer esto, mostrar√© algunas im√°genes de la biblioteca desmontada appinfo.dll (el servicio AIS que procesa las solicitudes de escalado de privilegios es uno de los componentes principales de UAC). <br><br>  <b>Requisito 1:</b> archivo configurado para elevar autom√°ticamente los privilegios <br><br>  Cuando surge una solicitud de escalada de privilegios para un programa, el servicio AIS (appinfo.dll) realiza una llamada RPC con la ruta ejecutable de destino pasada como argumento.  Este servicio luego asignar√° el contenido ejecutable de destino del archivo a leer.  En el manifiesto del archivo ejecutable, se intenta leer el valor para obtener la clave "autoElevate" (si existe). <br><br>  Figura 1 - Lectura del manifiesto del archivo ejecutable para obtener el valor clave "autoElevate". <br><br><img src="https://habrastorage.org/webt/mk/tv/sl/mktvslanjr3qsewhdydmwz96chc.png"><br><br>  Si se recibe el valor y es Verdadero, el archivo se considerar√° como un archivo ejecutable de privilegios elevados "autom√°tico", que se ejecutar√° con elevaci√≥n de privilegios y no invocar√° el cuadro de di√°logo del servicio UAC (siempre que cumpla los siguientes requisitos mencionados a continuaci√≥n). <br><br>  Figura 2: llamar a "bsearch" para verificar el nombre del archivo ejecutable en la lista de ejecutables "autoelevante" <br><br><img src="https://habrastorage.org/webt/dk/qm/bn/dkqmbnfzsazhanihl0gxyk4lpsc.png"><br><br>  Algunos de estos archivos que est√°n programados en el sistema est√°n en la lista blanca: <br>  'cttunesvr.exe', 'inetmgr.exe', 'migsetup.exe', 'mmc.exe', 'oobe.exe', 'pkgmgr.exe', 'provisionhare.exe', 'provisiontorage.exe', 'spinstall .exe ',' winsat.exe ' <br><br>  <b>Requisito 2:</b> Firmado correctamente <br><br>  Se supone que la segunda condici√≥n para aumentar el privilegio "autom√°ticamente" despu√©s de enviar una solicitud a UAC es realizar una verificaci√≥n de firma utilizando "wintrust!  WTGetSignatureInfo ". <br><br>  Esto significa que el atacante no podr√° simplemente crear su propio archivo de manifiesto o ejecutable necesario para la elevaci√≥n "autom√°tica" de privilegios y tener √©xito, ya que el archivo binario del atacante probablemente se firmar√° incorrectamente y el √∫ltimo requisito, la ejecuci√≥n, tambi√©n fallar√°. de un directorio confiable. <br><br>  <b>Requisito 3:</b> ejecuci√≥n desde un directorio confiable <br><br>  El requisito final para obtener una elevaci√≥n de privilegios "autom√°tica" es que el ejecutable de destino se encuentre en un "directorio confiable", por ejemplo, "C: \ Windows \ System32".  La Figura 3 muestra que AIS realiza esta verificaci√≥n de la ruta con la solicitud de actualizaci√≥n, en cuyo caso una de las rutas consideradas "confiables" es "C: \ Windows \ System32". <br><br>  Figura 3 <br><br><img src="https://habrastorage.org/webt/cx/rq/k1/cxrqk1n2ozxd7hnmkmkf4juvgpo.png"><br><br>  El t√≠tulo de este art√≠culo es "Omitir el Control de cuentas de usuario (UAC) imitando directorios confiables", por lo que probablemente pueda adivinar f√°cilmente lo que suceder√° a continuaci√≥n. <br><br>  <b>Bypass UAC</b> <br><br>  Como se mencion√≥ anteriormente en la secci√≥n de UAC Primer, se realizar√° un privilegio autom√°tico (omisi√≥n de UAC) para archivos ejecutables que: <br><br><ol><li>  Configurado para recibir escalada de privilegios "autom√°tica" </li><li>  Firmado correctamente </li><li>  Ejecutar desde un directorio confiable ("C: \ Windows \ System32") </li></ol><br>  Appinfo.dll (AIS) utiliza la API RtlPrefixUnicodeString para verificar si la ruta del archivo ejecutable coincide con "C: \ Windows \ System32 \" para verificar uno de los directorios de confianza.  Esta es una prueba de concreto bastante reforzado, dada su comparaci√≥n con la ubicaci√≥n del archivo can√≥nico. <br><br>  Por lo tanto, para organizar una omisi√≥n de esta comprobaci√≥n, creo un directorio llamado "C: \ Windows \" (observe el espacio despu√©s de "Windows").  Por supuesto, al usar esta acci√≥n a√∫n no puede pasar la verificaci√≥n RtlPrefixUnicodeString, y tambi√©n mencionar√© que este es un nombre de directorio algo inv√°lido (o al menos "poco amigable"), ya que Windows no permite agregar espacios al final del nombre al crear el directorio (intente ) <br><br>  Sin embargo, utilizando la API CreateDirectory y agregando "\\?  \ "Al nombre del directorio que deseo crear, podemos omitir algunas de estas reglas de filtrado de nombres y enviar una solicitud para crear el directorio directamente al sistema de archivos. <br><br><img src="https://habrastorage.org/webt/yf/tu/p3/yftup388pyrdgxxokxetbkhm8em.png"><br><br>  Esto lleva a la creaci√≥n de un directorio inconveniente que felizmente coexiste en el sistema de archivos junto con el verdadero "C: \ Windows \" (excepto cuando intenta hacer algo con √©l en el Explorador de Windows). <br><br><img src="https://habrastorage.org/webt/z7/4i/kz/z74ikzx_ninr8cegntrm_vwtyfy.png"><br><br>  Ahora que tenemos el directorio "C: \ Windows \", podemos crear el directorio "System32" y copiar uno de los archivos ejecutables firmados (que el sistema permite elevar privilegios "autom√°ticamente") desde el directorio real "C: \ Windows \ System32 ". <br>  Para hacer esto, copi√© "winSAT.exe" (uno de los archivos en la lista blanca de archivos ejecutables de Windows con la elevaci√≥n "autom√°tica" de privilegios permitidos por el sistema). <br>  Cuando intentamos ejecutar este archivo desde nuestro nuevo directorio "C: \ Windows \ System32 \ winSAT.exe", pasar√° por las siguientes API (ver Figura 6) en appinfo.dll antes de realizar una verificaci√≥n de directorio confiable.  Esto es importante y la base de por qu√© funciona esta soluci√≥n. <br><br>  Figura 6 <br><br><img src="https://habrastorage.org/webt/gu/ky/j_/gukyj_juwwrpa-pkz2mzv441pvi.png"><br><br>  Cuando esta ruta inconveniente con un espacio se env√≠a a AIS para solicitar la escalada de privilegios, la ruta se pasa a GetLongPathNameW, que la convierte de nuevo a "C: \ Windows \ System32 \ winSAT.exe" (espacio eliminado). <br><br>  Genial <br><br>  Ahora esta es la l√≠nea donde pas√≥ la verificaci√≥n de directorio v√°lida (usando RtlPrefixUnicodeString) para el resto de la verificaci√≥n. <br><br>  La belleza de mi soluci√≥n es que despu√©s de verificar el directorio confiable, se ejecuta esta ruta convertida, que luego se libera, y el resto de las comprobaciones (y la solicitud final de escalado de privilegios) se realizan con el nombre original del directorio ejecutable (con un espacio adicional). <br><br>  Esto le permite pasar por todas las otras comprobaciones y hace que appinfo.dll acepte mi copia de winSAT.exe como con una elevaci√≥n "autom√°tica" de privilegios (ya que est√° correctamente firmado y agregado a la lista blanca para la elevaci√≥n "autom√°tica" de privilegios). <br><br>  Para utilizar el c√≥digo malicioso, simplemente copi√© el WINMM.dll falso (winSAT.exe importado) en mi directorio actual "C: \ Windows \ System32 \" para falsificar el dll local.  El concepto completo se puede ver en la figura a continuaci√≥n. <br><br>  Figura 7 <br><br><img src="https://habrastorage.org/webt/ko/mj/mj/komjmj6mfh1mexldjb7bqyauqc0.png"><br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace a Github</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430498/">https://habr.com/ru/post/es430498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430488/index.html">Intercambio as√≠ncrono de datos con una aplicaci√≥n remota a trav√©s de SSH</a></li>
<li><a href="../es430490/index.html">Antic√≠pese, eduque, decida: c√≥mo y por qu√© EPAM crea el Centro de Competencias de Java</a></li>
<li><a href="../es430492/index.html">Intel Neural Compute Stick. Mente artificial en una unidad flash USB - 2</a></li>
<li><a href="../es430494/index.html">InfoWatch Traffic Monitor. Al borde de errores y caracter√≠sticas</a></li>
<li><a href="../es430496/index.html">NB-IoT: ¬øc√≥mo funciona? Parte 1</a></li>
<li><a href="../es430500/index.html">Evitar el caos de la base de conocimiento corporativo: nuestra experiencia de confluencia</a></li>
<li><a href="../es430502/index.html">Prueba de carga con langosta</a></li>
<li><a href="../es430504/index.html">M√©todos de pensamiento junior y racional.</a></li>
<li><a href="../es430506/index.html">Dark art of resurrection: c√≥mo recuperar datos de medios da√±ados</a></li>
<li><a href="../es430508/index.html">DevOps: ¬øqu√© es realmente?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>