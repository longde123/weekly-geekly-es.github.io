<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•° üéí üë®üèΩ‚Äçüîß Lector OBD2 - diagn√≥stico del autom√≥vil üê∏ ‚òùüèª üñïüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al crear la aplicaci√≥n, nos enfrentamos a muchas opciones, problemas, etc., con los que trataremos de familiarizarlo en este art√≠culo. Al final result...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lector OBD2 - diagn√≥stico del autom√≥vil</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444726/">  Al crear la aplicaci√≥n, nos enfrentamos a muchas opciones, problemas, etc., con los que trataremos de familiarizarlo en este art√≠culo.  Al final result√≥ que, puede tener un di√°logo con el coche, y bastante productivo.  Naturalmente, para organizar la comunicaci√≥n con el autom√≥vil, debe "establecer contacto", "hacer la pregunta correcta" y comprender correctamente la "respuesta" recibida del autom√≥vil.  En consecuencia, el art√≠culo tendr√° como objetivo explicar la organizaci√≥n del di√°logo en un idioma accesible, as√≠ como decirle qu√© errores puede encontrar en el camino y c√≥mo lidiar con ellos. <br><a name="habracut"></a><br><h3>  Elecci√≥n de conexi√≥n </h3><br>  Inicialmente, es necesario aclarar que se utilizar√° un adaptador ELM327 para conectarse al autom√≥vil.  ELM327 es un microcircuito que le permite convertir los protocolos utilizados en los neum√°ticos de diagn√≥stico de autom√≥viles en el protocolo RS232, al que transferiremos los datos.  Debido al hecho de que la transmisi√≥n de datos a trav√©s del protocolo RS232 ocurre secuencialmente, surge el primer problema: la velocidad de transferencia de datos, que trataremos de eludir en uno de los siguientes p√°rrafos. <br><br>  Existen varias variaciones del adaptador ELM327, que se clasifican seg√∫n el m√©todo de transferencia de datos: Bluetooth, WIFI, USB.  Dado que el objetivo de desarrollo es un dispositivo m√≥vil con Android, puede elegir las dos versiones m√°s adecuadas de ELM327, como Bluetooth y WIFI.  Dado que solo hay una forma de recibir y procesar datos, y solo difieren en las opciones de conexi√≥n al adaptador, puede elegir solo una, organizar un di√°logo con ella y luego agregar las opciones de conexi√≥n restantes. <br><br><h3>  ELM327 1.5 vs ELM327 2.1 </h3><br><img src="https://habrastorage.org/webt/07/xv/ur/07xvurk7pfyn9k3ckfmuy_yc_dc.jpeg"><br><br>  Uno de los primeros problemas que pudo encontrar fue el problema de elegir el adaptador directamente, en nuestro caso Bluetooth.  Resulta que si necesita admitir todos (al menos la mayor√≠a) de los autom√≥viles, debe elegir la versi√≥n v1.5 en lugar de la v2.1, que de hecho debe aclararse varias veces al comprar un adaptador, porque los vendedores intentan entregar la versi√≥n del adaptador no para el que es de hecho, porque  No son particularmente diferentes.  De hecho, en la versi√≥n v2.1 no hay soporte para los protocolos J1850 PWM y J1850 VPW, lo que significa que no podr√° conectarse a autom√≥viles que usen estos protocolos. <br><br><h3>  Conexi√≥n </h3><br>  La conexi√≥n al adaptador se realiza en varias etapas: <br><br><ul><li>  Conexi√≥n a un adaptador (Bluetooth, WIFI) </li><li>  Env√≠o de comandos de inicializaci√≥n (cadena de inicializaci√≥n) </li></ul><br>  Si todo est√° claro con la organizaci√≥n de la conexi√≥n.  El principio de funcionamiento es el mismo que con cualquier chat Bluetooth / WIFI.  Para comprender c√≥mo enviar la cadena de inicializaci√≥n, es necesario estudiar qu√© comandos existen, as√≠ como qu√© funciones realizan. <br><br>  <b>AT Z</b> [restablecer todo] <br>  Restablezca la configuraci√≥n del adaptador a los valores predeterminados de f√°brica. <br>  <b>AT L1-0</b> <br>  Habilitar / deshabilitar saltos de l√≠nea. <br>  <b>AT E1-0</b> <br>  Eco encendido - apagado <br>  <b>AT H1-0</b> <br>  Encabezados activados - desactivados <br>  <b>AT AT0-1-2</b> <br>  Adaptive Timing Off - Adaptive Timing Auto1 - Adaptive Timing Auto2 <br>  <b>AT ST FF</b> <br>  Establecer el tiempo de espera al m√°ximo. <br>  <b>AT D</b> [establecer todo en Predeterminado] <br>  Restablezca la configuraci√≥n al estado inicial configurado por el usuario. <br>  <b>AT DP</b> [Describa el protocolo actual] <br>  El esc√°ner puede determinar independientemente el protocolo del veh√≠culo al que est√° conectado. <br>  <b>AT IB10</b> [establezca la velocidad de <b>transmisi√≥n</b> ISO en 10400] <br>  El comando establece la velocidad en baudios para ISO 9141-2 y <br>  ISO 14230-4 10400 <br>  <b>AT IB96</b> [establezca la velocidad de transmisi√≥n ISO en 9600] <br>  El comando establece la velocidad en baudios para ISO 9141-2 y <br>  ISO 14230-4 9600 para protocolos 3,4,5. <br>  <b>AT SP h</b> [Establecer protocolo h] <br>  El comando de selecci√≥n de protocolo h, donde h: <br><br>  0: autom√°tico; <br>  1 - SAE J1850 PWM (41,6 Kbaudios); <br>  2 - SAE J1850 VPW (10,4 Kbaudios); <br>  3 - ISO 9141-2 (5 baudios de inicio, 10.4 Kbaudios); <br>  4 - ISO 14230-4 KWP (5 baudios init, 10.4 Kbaudios); <br>  5 - ISO 14230-4 KWP (inicio r√°pido, 10.4 Kbaud); <br>  6 - ISO 15765-4 CAN (ID de 11 bits, 500 Kbaudios); <br>  7 - ISO 15765-4 CAN (ID de 29 bits, 500 Kbaudios); <br>  8 - ISO 15765-4 CAN (ID de 11 bits, 250 Kbaud); <br>  9 - ISO 15765-4 CAN (ID de 29 bits, 250 Kbaudios); <br>  <b>AT SP Ah</b> [Establecer protocolo h con Auto] <br><br>  El comando establece el protocolo predeterminado h, si la conexi√≥n que usa el protocolo h falla, entonces el adaptador inicia la selecci√≥n autom√°tica del protocolo. <br><br>  En base a los comandos descritos anteriormente, formamos la cadena de inicializaci√≥n. <br><br><pre><code class="java hljs">initializeCommands = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"ATZ"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATL0"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATE1"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATH1"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATAT1"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATSTFF"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATDP"</span></span>, <span class="hljs-string"><span class="hljs-string">"ATSP0"</span></span>);</code> </pre> <br>  Es aconsejable permitir que el usuario cambie los comandos de inicializaci√≥n, porque para seleccionar la "clave" para algunos autom√≥viles, es necesario elegir configuraciones de adaptadores m√°s adecuadas.  En nuestro caso, se utilizan configuraciones adecuadas para la mayor√≠a de los protocolos est√°ndar. <br><br>  Tambi√©n es aconsejable prestar atenci√≥n al comando APSP0, por lo que establecemos la selecci√≥n autom√°tica de protocolo predeterminada, esto puede llevar alg√∫n tiempo. <br><br>  En consecuencia, si el usuario sabe cu√°l es su protocolo autom√°tico, entonces, utilizando la capacidad de cambiar el protocolo de conexi√≥n, puede cambiar 0 a su n√∫mero de protocolo. <br><br><h3>  Leer datos de diagn√≥stico </h3><br>  Los comandos especiales de PID se utilizan para leer datos de diagn√≥stico. <br>  PID (ID de par√°metro: identificadores de par√°metros de diagn√≥stico a bordo): c√≥digos que se utilizan para consultar el rendimiento de sensores espec√≠ficos del veh√≠culo. <br><br>  Los pids principales se pueden encontrar en Wikipedia, hay un conjunto completo de comandos b√°sicos que todos los autos deber√≠an admitir.  Tambi√©n hay conjuntos de comandos para ciertas marcas y tipos de autom√≥viles, estos conjuntos se proporcionan por una tarifa.  En nuestro caso, la aplicaci√≥n se centra en el diagn√≥stico b√°sico de autom√≥viles, respectivamente, utilizamos el conjunto b√°sico de comandos. <br><br>  Tambi√©n es posible recibir datos actuales del autom√≥vil, mientras que el comando para recibir datos del autom√≥vil tendr√° <b>01</b> al principio, lo que indica que queremos obtener datos reales.  Si queremos obtener los datos guardados del autom√≥vil, al principio del comando debe especificar <b>02</b> .  Por ejemplo, el comando para obtener la velocidad actual del autom√≥vil es <b>010D</b> , y para obtener la velocidad guardada - <b>020D</b> . <br><br>  Si observa cuidadosamente la cantidad de comandos que proporcionan los recursos abiertos, puede notar el problema sobre el que escrib√≠ al principio, es decir, el problema de la velocidad de respuesta del adaptador.  Dado que enviar y recibir comandos es secuencial, para recibir las lecturas del sensor en el momento actual, es necesario esperar una respuesta a todos los comandos anteriores.  En consecuencia, si solicita recibir todos los comandos, existe una alta probabilidad de que la actualizaci√≥n de datos reales ocurra muy lentamente.  Pero este problema se puede resolver si usa los comandos que muestran solo los equipos que existen en el autom√≥vil.  Por ejemplo: <br><br>  0100 - PID compatibles [01 - 20] <br>  0120 - PID compatibles [21 - 40] <br>  0140 - PID compatibles [41 - 60] <br>  0160 - PID admitidos [61 - 80] <br>  0180 - PID compatibles [81 - A0] <br>  01A0 - PID compatibles [A1 - C0] <br><br>  Demostrar√© c√≥mo determinar qu√© sensores est√°n presentes en el autom√≥vil usando uno de los pids.  Por ejemplo: <br><br><ul><li>  0100 \\ solicitud </li><li>  BB1E3211 \\ respuesta del auto <br></li></ul><br>  Traducimos la respuesta del auto a un sistema de n√∫meros binarios <br><br><pre> <code class="plaintext hljs">BB1E3211(16) &gt; 10111011000111100011001000010001(2)</code> </pre> <br>  Usando la siguiente placa podemos determinar qu√© pids son compatibles con nuestro autom√≥vil, comenzando del 01 al 20: <br><br><img src="https://habrastorage.org/webt/-3/ip/o8/-3ipo8j8p5-7hxm45mttq6yizgu.jpeg"><br><br>  En base a los datos obtenidos, podemos determinar que nuestro autom√≥vil admite las siguientes opciones: <br><br><pre> <code class="plaintext hljs"> 01, 03, 04, 05, 07, 08, 0C, 0D, 0E, 0F, 13, 14, 17, 1C, 20</code> </pre> <br>  Ahora, en lugar de enviar a los 32 equipos y esperar una respuesta para ellos, a pesar del hecho de que algunos pueden estar ausentes, usaremos solo 15 equipos.  Pero este no es el l√≠mite de la llamada optimizaci√≥n.  Para que los datos se actualicen a√∫n m√°s r√°pido, le aconsejo que solicite solo datos sobre esos sensores que se muestran en la pantalla.  Aunque esto limita algunas funcionalidades de la aplicaci√≥n.  Por ejemplo, un registro hist√≥rico. <br><br><h3>  Leer y decodificar errores del autom√≥vil </h3><br>  Los errores del autom√≥vil tambi√©n pueden ser diferentes y existen comandos separados para ellos tambi√©n.  Por ejemplo: <br><br><ul><li>  03 - Para mostrar c√≥digos de error guardados </li><li>  0A: para mostrar c√≥digos de error persistentes. </li></ul><br>  Al igual que con otros comandos, los errores del autom√≥vil vienen en forma codificada, respectivamente, como en otros comandos, deben decodificarse para obtener la informaci√≥n necesaria.  D√©jame darte un ejemplo de c√≥mo funciona la decodificaci√≥n de errores.  C√≥digo: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] dtcLetters = {<span class="hljs-string"><span class="hljs-string">'P'</span></span>, <span class="hljs-string"><span class="hljs-string">'C'</span></span>, <span class="hljs-string"><span class="hljs-string">'B'</span></span>, <span class="hljs-string"><span class="hljs-string">'U'</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] hexArray = <span class="hljs-string"><span class="hljs-string">"0123456789ABCDEF"</span></span>.toCharArray(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performCalculations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fault)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String result = fault; String workingData = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> startIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; troubleCodesArray.clear(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.contains(<span class="hljs-string"><span class="hljs-string">"43"</span></span>)) { workingData = result.replaceAll(<span class="hljs-string"><span class="hljs-string">"^43|[\r\n]43|[\r\n]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.contains(<span class="hljs-string"><span class="hljs-string">"47"</span></span>)) { workingData = result.replaceAll(<span class="hljs-string"><span class="hljs-string">"^47|[\r\n]47|[\r\n]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> begin=startIndex; begin &lt; workingData.length(); begin += <span class="hljs-number"><span class="hljs-number">4</span></span>) { String dtc = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> b1 = Utility.hexStringToByteArray(workingData.charAt(begin)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ch1 = ((b1 &amp; <span class="hljs-number"><span class="hljs-number">0xC0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ch2 = ((b1 &amp; <span class="hljs-number"><span class="hljs-number">0x30</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>); dtc += dtcLetters[ch1]; dtc += hexArray[ch2]; dtc += workingData.substring(begin + <span class="hljs-number"><span class="hljs-number">1</span></span>, begin + <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dtc.equals(<span class="hljs-string"><span class="hljs-string">"P0000"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } troubleCodesArray.add(dtc); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Log.e(TAG, <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> + e.getMessage()); } }</code> </pre><br>  Y ahora para la explicaci√≥n. <br><br>  En funci√≥n de la respuesta recibida, podemos obtener un c√≥digo de error, para esto decodificamos el mensaje recibido utilizando las siguientes placas. <br><br>  Primer personaje: <br><br><img src="https://habrastorage.org/webt/9m/cf/vy/9mcfvylfn4rve9gnwyud3lgncqi.jpeg"><br><br>  Segundo personaje: <br><br><img src="https://habrastorage.org/webt/wz/pc/56/wzpc56s9mpsdh5cxt8jncaebteq.jpeg"><br><br>  Se forman 3, 4, 5 caracteres de acuerdo con esta tabla: <br><br><img src="https://habrastorage.org/webt/tr/rb/pi/trrbpitjmnle7ep9pyn_xyohpis.jpeg"><br><br>  En base a esto, podemos intentar analizar la siguiente respuesta 0001000000111110 <br><br><img src="https://habrastorage.org/webt/3_/w8/d9/3_w8d99ffh2uotdv9kaujlbcnee.jpeg"><br><br>  C√≥digo de error: P103E <br><br><h3>  Ep√≠logo </h3><br>  En esta etapa, descubrimos c√≥mo organizar un di√°logo con el adaptador, enviarle comandos, recibir y descifrar sus respuestas.  Esta es una gran parte del trabajo, si considera cu√°nto tiempo lleva estudiar el material, pero al mismo tiempo es bastante interesante.  Fuera de este art√≠culo, hay muchos problemas asociados con la interfaz visual, as√≠ como muchas funciones adicionales, como agregar nuevos pids desde un archivo, una forma est√°ndar y avanzada de conectarse al adaptador y crear gr√°ficos. <br><br>  Matvienko Alexander, Hossein Fakhr. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/444726/">https://habr.com/ru/post/444726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444714/index.html">C√≥mo overclockeamos CAD COMPASS-3D ‚Üí Parte 1</a></li>
<li><a href="../444716/index.html">Un tel√©fono Samsung con una pantalla plegable por $ 2000 muestra un pliegue</a></li>
<li><a href="../444718/index.html">Holograf√≠a amateur: el comienzo del viaje</a></li>
<li><a href="../444720/index.html">Lo que el autor fumaba: agrega la vieja escuela a este loco mundo de juegos</a></li>
<li><a href="../444724/index.html">Arquitectura runet</a></li>
<li><a href="../444728/index.html">Mientras escrib√≠a y publicaba un libro sobre la Universidad Estatal de Mosc√∫, o 12 errores cr√≠ticos</a></li>
<li><a href="../444730/index.html">Por qu√© la tecnolog√≠a sin servidor es una revoluci√≥n en la gesti√≥n de productos</a></li>
<li><a href="../444732/index.html">Optimizaci√≥n del rendimiento apache2</a></li>
<li><a href="../444734/index.html">Habraseminar: historias reales sobre marketing de contenidos</a></li>
<li><a href="../444738/index.html">Pixel art: del borrador al activo del juego</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>