<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🎤 👩🏼‍⚖️ 🍿 Nous obtenons le mot de passe principal du gestionnaire de mots de passe verrouillé 1 Mot de passe 4 🆓 ❇️ 🗞️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nouveaux outils, anciennes méthodes. Nous inversons l'ingénierie et découvrons la faille fatale de 1Password. 

 Tout le monde aime les gestionnaires ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous obtenons le mot de passe principal du gestionnaire de mots de passe verrouillé 1 Mot de passe 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441166/">  <b>Nouveaux outils, anciennes méthodes.</b>  <b>Nous inversons l'ingénierie et découvrons la faille fatale de 1Password.</b> <br><br>  Tout le monde aime les gestionnaires de mots de passe.  Ils sont parfaits pour de nombreuses raisons.  Personnellement, j'ai plus de 200 entrées dans le manager.  Avec autant de données confidentielles en un seul endroit, il est important de comprendre l'étendue des dommages si votre dossier est compromis, qu'il s'agisse de logiciels malveillants, d'exploits ou simplement d'un ordinateur laissé sans surveillance pendant plusieurs minutes.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le Washington Post a</a> récemment publié un article basé sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">étude</a> .  Cet article permet de faire comprendre aux gens que tous les gestionnaires de mots de passe ne sont pas identiques. <br><br>  Je croyais fermement qu'un gestionnaire de mots de passe verrouillé était bien protégé.  Si quelqu'un a accès à mon ordinateur, le maximum peut compter sur un tas d'octets aléatoires, car les informations sont effacées de manière fiable de la mémoire. <br><a name="habracut"></a><br>  Cela est vrai pour 1Password 4 (notez que la dernière version est la septième aujourd'hui).  Avant de passer à celui-ci il y a quelques années, j'ai vérifié qu'il n'y avait vraiment pas de mot de passe en clair lorsque le manager était verrouillé.  Ainsi, en cas de compromis, l'attaquant devra faire face à un stockage chiffré. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/527/994/2ed/5279942edfcbb8687d113731500b6953.png"></div><br>  <i><font color="gray">Le coffre-fort est verrouillé!</font></i> <br><br>  Dans cet état, il n'y a aucune entrée de mot de passe ou mot de passe principal.  Très raisonnable et correct, et 1Password 4 a réussi ce test.  Ou pas? <br><br>  Pour me débarrasser des détails ennuyeux, je dirai tout de suite: nous avons pu restaurer le mot de passe principal à partir d'une instance verrouillée dans 1Password 4, comme indiqué ci-dessous. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br>  <i><font color="gray">Déverrouillez 1Password 4 et récupérez votre mot de passe principal</font></i> <br><br>  L'animation montre que 1Password 4 est d'abord déverrouillé de manière normale, puis verrouillé.  Après cela, nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exécutons</a> notre utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">multipass</a> , qui récupère avec succès le mot de passe.  L'utilitaire exploite un traitement incorrect du champ de saisie de mot de passe dans 1Password 4 pour restaurer le tampon de mot de passe maître obscurci, le désobfusquer, déverrouiller automatiquement 1Password 4 et enfin afficher le mot de passe principal dans la console. <br><br><h1>  Détails ennuyeux </h1><br>  La première étape de l'évaluation d'un gestionnaire de mots de passe consiste à rechercher un mot de passe maître clair en mémoire.  Ceci est possible dans n'importe quel éditeur hexadécimal capable d'interagir avec l'espace mémoire du processus.  Par exemple, l'éditeur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HxD</a> gratuit.  Utilisez-le pour ouvrir l'espace mémoire de 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/38d/87b/b48/38d87bb48b7c4b87f39e44a990cd3f74.png"></div><br><br>  Nous tombons immédiatement dans la première zone lisible de l'espace mémoire de 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ef4/e95/f2d/ef4e95f2d092a6f236ba53fdfd090787.png"></div><br>  <i><font color="gray">Exemple de représentation de la mémoire HxD</font></i> <br><br>  Rien de spécial pour le moment.  Mais vous pouvez faire une recherche.  Par exemple, à quoi ressemble la situation si vous tapez le mot de passe dans la fenêtre de déverrouillage de 1Password 4, mais ne cliquez pas sur le bouton "Déverrouiller": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e6c/d9c/08b/e6cd9c08bee8130e7775a51bd7a91ad0.png"></div><br>  <i><font color="gray">Coffre-fort verrouillé 1 Mot de passe 4 avec le mot de passe principal entré dans le champ</font></i> <br><br>  Le mot de passe est sûrement quelque part dans la mémoire? <br><br>  Nous ouvrons HxD, mais la recherche d'une ligne avec notre mot de passe principal («Z3Superpass #») ne produit aucun résultat. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b41/066/2c0/b410662c04b7e3d642f05ef94eacc7da.png"></div><br><br>  Il semble que 1Password chiffre ou obscurcit en quelque sorte le formulaire lors de sa saisie.  Si la procédure fonctionne correctement, tout va bien. <br><br><h1>  Plonger plus profondément </h1><br>  Pour savoir pourquoi le mot de passe principal est introuvable dans la mémoire alors qu'il est clairement présent dans la boîte de dialogue de déverrouillage, vous devez trouver le code qui interagit avec lui.  Il y a plusieurs façons.  Vous pouvez suivre le traitement des événements du clavier et de la souris en localisant «GetMessage», «PeekMessage», «GetWindowText» ou d'autres API Windows qui gèrent généralement les entrées utilisateur.  Nous trouvons donc le tampon où les frappes sont enregistrées, et à travers eux, nous passons à la routine de cryptage / obscurcissement.  Mais c'est un processus long et sujet aux erreurs, en particulier avec les grands cadres qui gèrent parfois la mémoire de manière très étrange, vous devez donc effectuer de nombreuses copies et conversions pour suivre le tampon. <br><br>  Au lieu de cela, nous utilisons notre propre outil Thread Imager, conçu pour rétroconcevoir des protocoles propriétaires «étranges» au niveau de l'application.  Il vous aidera à déterminer où en mémoire 1Password 4 interagit avec notre mot de passe principal.  L'outil identifie "automatiquement" les zones de code dans 1Password 4 qui interagissent avec un mot de passe obscurci (il met simplement en évidence les instructions qui interagissent avec les données d'intérêt pour une analyse plus approfondie).  Le résultat ressemble à ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6b/c11/157/b6bc1115787869abc9ba25719b7c060a.gif"><br>  <i><font color="gray">Thread Imager trouve le code 1Password 4 qui interagit avec un mot de passe maître non focalisé</font></i> <br><br>  Étant donné que le mot de passe principal est stocké en mémoire sous une forme obscurcie, l'outil doit d'abord indiquer où l'obfuscation se produit. <br><br>  Un fragment du premier résultat montre que la première apparition du mot de passe principal est accompagnée d'une transition de code de l'adresse 0x7707A75D à 0x701CFA10. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/49b/f32/d7a/49bf32d7a1f5b0bf01f12f7d47685dea.png"></div><br>  <i><font color="gray">Une entrée détaillée dans Thread Imager met en évidence la transition de code de 0x7707A75D à 0x701CFA10, tandis que les registres EAX et ECX se réfèrent au tampon avec le mot de passe principal</font></i> <br><br>  L'examen de cet endroit 0x7707A75D dans le débogueur (x64dbg) confirme notre théorie.  En effet, pour la première fois, la chaîne «Z3superpass #» apparaît lorsque la fonction de décodage «RtlRunDecodeUnicodeString» de la bibliothèque ntdll.dll se termine. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/173/cd8/1bb/173cd81bba5c294f9e21c139610ee290.png"><br><br>  Après une petite analyse, il est clair que ces deux fonctions sont utilisées pour masquer le mot de passe: «RtlRunEncodeUnicodeString» et «RtlRunDecodeUnicodeString».  Ainsi, le mot de passe principal est caché de la copie primitive de la mémoire, c'est pourquoi auparavant nous ne pouvions pas le trouver dans l'éditeur hexadécimal. <br><br>  Si vous étudiez le tampon codé à la fin de la fonction RtlRunEncodeUnicodeString, la ligne chiffrée avec le mot de passe principal ressemble à ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">Mot de passe principal crypté</font></i> <br><br>  Après RtlRunDecodeUnicodeString ', il est décodé: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/204/85b/b2b/20485bb2b8b6f40b6509db04bcedf5b1.png"></div><br>  <i><font color="gray">Mot de passe principal déchiffré</font></i> <br><br>  Fait intéressant, cette zone est enregistrée à la même adresse 0x00DFA790 et nous pouvons littéralement observer son changement lors de la saisie d'un mot de passe dans la fenêtre de déverrouillage de 1Password 4: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/d32/83f/3cfd3283fef38c3e5ef0a62630b4372b.gif"></div><br><br><h1>  Vulnérabilité </h1><br>  'RtlRunEncodeUnicodeString' et 'RtlRunDecodeUnicodeString' sont des fonctions simples qui modifient une chaîne avec une simple opération XOR.  Ce n'est pas si mal: il semble que ce soit la méthode standard pour masquer tous les contrôles d'édition natifs de Windows avec le jeu d'indicateurs 'ES_PASSWORD'. <br><br>  Le problème est qu'après le déverrouillage de 1Password 4, le mot de passe principal chiffré n'est pas effacé de la mémoire. <br><br>  Pire, il reste en mémoire même après le verrouillage de 1Password 4. Autrement dit, nous avons un magasin de mots de passe verrouillé, mais avec un mot de passe maître chiffré en mémoire. <br><br>  Et pire encore, puisque nous interagissons avec la boîte de dialogue de saisie du mot de passe principal, la même zone de mémoire est réutilisée avec la même valeur XOR, ce qui nous donne un accès facile au tampon codé pour créer un exploit. <br><br><h1>  Défi </h1><br>  Pour créer un exploit fiable pour 1Password 4, vous devez obtenir une image plus claire de la façon dont le mot de passe principal est traité par les flux de travail du programme.  En utilisant les outils susmentionnés, nous avons construit un diagramme de données de sortie (voir la figure ci-dessous). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/453/5e4/763/4535e476369c9114c5fd62f1ec7480c6.png"><br><br>  Ce diagramme permet de mieux comprendre où et quelles bibliothèques sont impliquées afin d'identifier de manière fiable les zones de la mémoire où vous pouvez récupérer le mot de passe principal. <br><br><h1>  Exploiter </h1><br>  Qu'avons-nous en ce moment?  Nous avons un stockage verrouillé, et quelque part dans la mémoire, un mot de passe masqué est stocké, car le programme n'a pas nettoyé la mémoire correctement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a77/ac0/8f1/a77ac08f195de46d8e546b1f43ab1415.png"></div><br><br>  Pour le récupérer, vous devez appeler la procédure dans 1Password 4, qui lance les «RtlRunEncodeUnicodeString» et «RtlRunDecodeUnicodeString».  Ainsi, il montrera l'emplacement de la mémoire tampon avec le mot de passe principal codé. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">Zone de mémoire avec un mot de passe maître masqué</font></i> <br><br>  Sans ce tampon, il faudrait plonger dans l'abîme des procédures internes et des contrôles Windows et des mécanismes de gestion de la mémoire associés.  Peut-être que cette analyse permet de trouver facilement un tampon, mais nous ne sommes pas allés de cette façon. <br><br>  Il semble que la seule façon d'appeler «RtlRunEncodeUnicodeString» et «RtlRunDecodeUnicodeString» est d'entrer le mot de passe principal dans le caractère de la boîte de dialogue.  Nous obtenons donc le tampon souhaité.  Mais nous ne connaissons pas la longueur du mot de passe. <br><br>  Nous avons résolu ce problème en interceptant du code qui accède au premier caractère de notre tampon, bloquant une tentative de modification.  Cette routine se trouve dans la boucle des messages de contrôle dans comctl32, qui gère le contrôle du tampon des éléments correspondants.  L'appel de 'memmove' avec l'offset 0x70191731 écrase le tampon avec le caractère entré: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/676/8a9/351/6768a9351ed39fe85a98ca9d01368586.png"></div><br>  <i><font color="gray">(Effet secondaire: la ligne en surbrillance (jaune) met à jour toute la ligne de mot de passe)</font></i> <br><br>  Maintenant, nous avons enfin tout ce dont nous avons besoin pour créer un exploit.  Les étapes suivantes nous permettront d'extraire le mot de passe principal: <br><br><ol><li>  Accrochez «memmove» pour éviter d'écraser le premier octet du mot de passe principal. <br></li><li>  Accrochez «RtlRunEncodeUnicodeString» pour obtenir l'emplacement du tampon de mot de passe maître masqué. <br></li><li>  Accrochez «RtlRunDecodeUnicodeString» pour accéder au tampon obscurci obtenu à l'étape précédente. <br></li><li>  Entrer un caractère dans le champ de saisie du mot de passe et refuser l'étape 1 (enregistrer le mot de passe maître entier), rediriger l'étape 2 vers l'étape 3 pour décoder le mot de passe maître masqué. </li></ol><br>  Pour effectuer toutes ces actions, créez une DLL avec le code du gestionnaire pour tous ces hooks.  La bibliothèque est intégrée dans le processus 1Password 4, envoie un caractère à la boîte de dialogue de mot de passe principal, en lançant les étapes memmove, RtlRunEncodeUnicodeString et RtlRunDecodeUnicodeString que nous pouvons intercepter - et faisant notre magie pour récupérer le mot de passe principal masqué.  La plupart de la magie se produit dans le DetourRtlRunEncodeUnicodeString, c'est le crochet pour la fonction 'RtlRunEncodeUnicodeString', illustrée ci-dessous: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c5/652/36e/2c565236ec1efb158e586bd603d0a908.png"></div><br><br>  Ce qui nous amène au résultat final: déverrouiller le référentiel verrouillé 1Password 4 de n'importe quelle version en utilisant la procédure de buggy utilisée par l'API Windows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br><br><h1>  Résumé </h1><br>  Lorsque nous avons exploré pour la première fois l'intérieur de 1Password 4, nous nous attendions à rencontrer une sorte de système de sécurité complexe et nous nous attendions à ce que toutes les informations sensibles soient effacées de la mémoire, comme cela se produit dans les procédures PBKDF2 et dans d'autres domaines où le mot de passe principal est utilisé.  Les entrées correspondantes sont également effacées.  Cependant, en raison d'un oubli, le champ de saisie du mot de passe est considéré comme un contrôle API Windows standard avec un mot de passe caché, ce qui compromet la sécurité de 1Password 4. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr441166/">https://habr.com/ru/post/fr441166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr441150/index.html">Première introduction au protocole HTTP en écrivant le serveur Web Java le plus simple</a></li>
<li><a href="../fr441152/index.html">Comment minimiser les erreurs lors de l'intégration avec des services externes: l'expérience d'un courtier en ligne</a></li>
<li><a href="../fr441154/index.html">Onze perles cachées de Java 11</a></li>
<li><a href="../fr441158/index.html">Comment l'éthique est devenue le problème le plus cher de la Silicon Valley et la philosophie est devenue sa solution la plus pratique</a></li>
<li><a href="../fr441160/index.html">Comment apprendre à savoir quand dire non</a></li>
<li><a href="../fr441168/index.html">QUIC DataChannels: premières étapes</a></li>
<li><a href="../fr441172/index.html">Comment le marché de l'impression 3D a augmenté en 2018 et ce que cela signifie pour les entreprises</a></li>
<li><a href="../fr441174/index.html">OOP est mort, vive OOP</a></li>
<li><a href="../fr441180/index.html">Nuageux avec une chance de publicité non désactivable dans le ciel étoilé</a></li>
<li><a href="../fr441182/index.html">Approche synesthésique de la machine pour détecter les attaques DDoS réseau. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>