<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õüèΩ ‚úäüèº ü§∂üèø QEMU.js: agora a s√©rio e com WASM ü§≥ üòâ üë®üèΩ‚Äçü§ù‚Äçüë®üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Era uma vez, por uma quest√£o de riso, decidi provar a reversibilidade do processo e aprender a gerar JavaScript (ou melhor, Asm.js) a partir do c√≥digo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>QEMU.js: agora a s√©rio e com WASM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451306/"><p>  Era uma vez, por uma quest√£o de riso, decidi <em>provar a reversibilidade do processo</em> e aprender a gerar JavaScript (ou melhor, Asm.js) a partir do c√≥digo da m√°quina.  QEMU foi escolhido para o experimento; algum tempo depois, um artigo foi escrito sobre Habr.  Nos coment√°rios, fui aconselhado a refazer o projeto no WebAssembly, e eu mesmo n√£o estava com vontade de deixar o projeto <em>quase conclu√≠do</em> ... O trabalho continuou, mas muito lentamente, e agora, nesse artigo, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coment√°rio</a> apareceu no t√≥pico "Ent√£o, como ele terminou?".  Para minha resposta detalhada, ouvi "Ele puxa um artigo".  Bem, se puxar, haver√° um artigo.  Talvez algu√©m venha a calhar.  A partir disso, o leitor aprende alguns fatos sobre a gera√ß√£o de c√≥digos do QEMU para o back-end do dispositivo, bem como como escrever um compilador Just-in-Time para um aplicativo da web. </p><a name="habracut"></a><br><h2 id="zadachi">  As tarefas </h2><br><p>  Desde que eu j√° aprendi como "portar" o QEMU para JavaScript, desta vez foi decidido faz√™-lo com sabedoria e n√£o repetir erros antigos. </p><br><h3 id="oshibka-nomer-raz-otvetvitsya-ot-point-release">  N√∫mero de vezes do erro: ramifica√ß√£o do ponto </h3><br><p> Meu primeiro erro foi ramificar minha vers√£o da vers√£o upstream 2.4.1.  Ent√£o me pareceu uma boa id√©ia: se a libera√ß√£o de pontos existe, provavelmente √© mais est√°vel do que um simples 2.4 e, mais ainda, um ramo <code>master</code> .  E como eu planejava adicionar uma boa quantidade de meus erros, n√£o precisava de estranhos.  Ent√£o provavelmente aconteceu.  Mas aqui est√° a m√° sorte: o QEMU n√£o fica parado e, em algum momento, eles at√© anunciaram a otimiza√ß√£o do c√≥digo percentual gerado em 10. "Sim, agora estou congelando", pensei <del>  e interrompeu </del>  .  Aqui, devemos fazer uma digress√£o: devido √† natureza de thread √∫nico do QEMU.js e ao fato de o QEMU original n√£o implicar a aus√™ncia de multithreading (ou seja, √© fundamental que ele possa operar v√°rios caminhos de c√≥digo n√£o relacionados ao mesmo tempo, e n√£o apenas "conectar todos os kernels"), as principais fun√ß√µes dos threads teve que "sair" para poder ligar de fora.  Isso criou alguns problemas naturais de fus√£o.  No entanto, o fato de que algumas das altera√ß√µes do ramo <code>master</code> , com as quais tentei mesclar meu c√≥digo, tamb√©m foram escolhidas na vers√£o point point (e, portanto, no meu ramo), provavelmente tamb√©m n√£o adicionariam conveni√™ncia. </p><br><p>  Em geral, eu decidi que de qualquer maneira o prot√≥tipo faz sentido <del>  jogar fora </del>  desmonte as pe√ßas e construa uma nova vers√£o do zero com base em algo mais atual e agora do <code>master</code> . </p><br><h3 id="oshibka-nomer-dva-tlp-metodologiya">  Erro n√∫mero dois: metodologia TLP </h3><br><p>  De fato, isso n√£o √© um erro, em geral - √© apenas uma caracter√≠stica da cria√ß√£o de um projeto nas condi√ß√µes de completo mal-entendido de "para onde e como mudar?". E, em geral, "chegaremos l√°?".  Nessas condi√ß√µes, a <em>programa√ß√£o</em> era uma op√ß√£o justific√°vel, mas, √© claro, eu absolutamente n√£o queria repeti-la desnecessariamente.  Desta vez, eu queria fazer isso com sabedoria: confirma√ß√µes at√¥micas, altera√ß√µes deliberadas de c√≥digo (e n√£o "agrupar caracteres aleat√≥rios at√© compilar (com avisos)"), como Linus Torvalds disse sobre algu√©m, se voc√™ acredita no Wikitatnik), etc. </p><br><h3 id="oshibka-nomer-tri-ne-znaya-brodu-lezt-v-vodu">  Erro n√∫mero tr√™s: n√£o conhecer o vau para entrar na √°gua </h3><br><p>  Ainda n√£o me livrei completamente disso, mas agora decidi n√£o seguir o caminho de menor resist√™ncia e faz√™-lo "de maneira adulta", ou seja, escrevo meu backend do TCG do zero para n√£o dizer mais tarde: "Sim, √© Claro, devagar, mas n√£o consigo controlar tudo - o TCI est√° escrito assim ... ".  Al√©m disso, inicialmente isso parecia uma solu√ß√£o √≥bvia, pois <em>eu estava gerando c√≥digo bin√°rio</em> .  Como diz o ditado, "eu coletei Ghent, mas n√£o esse": o c√≥digo √©, obviamente, bin√°rio, mas o controle n√£o pode ser transferido para ele exatamente assim - ele precisa ser explicitamente empurrado para o navegador para compila√ß√£o, resultando em um determinado objeto do mundo JS, que ainda precisa salvar em algum lugar.  No entanto, em <del>  normal </del>  Arquiteturas RISC, como eu a entendo, uma situa√ß√£o t√≠pica √© a necessidade de liberar explicitamente o cache de instru√ß√µes para o c√≥digo regenerado - se n√£o √© isso que precisamos, ent√£o, pelo menos, est√° pr√≥ximo.  Al√©m disso, na minha √∫ltima tentativa, aprendi que o controle n√£o parece ser transferido para o meio do bloco de convers√£o; portanto, n√£o precisamos realmente do bytecode interpretado de qualquer deslocamento, e podemos simplesmente gerar por fun√ß√£o no TB. </p><br><h2 id="prishli-i-pnuli">  Veio e chutou </h2><br><p>  Embora eu tenha come√ßado a reescrever o c√≥digo em julho, o pendell m√°gico passou despercebido: geralmente as cartas do GitHub s√£o recebidas como notifica√ß√µes de respostas a solicita√ß√µes de Issues e Pull e, de <em>repente</em> , o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Binaryen como back-end do qemu</a> no contexto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diz</a> : ‚ÄúAqui est√°- ele fez algo assim, talvez ele diga alguma coisa. ‚Äù  Tratava-se de usar a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Binaryen</a> relacionada ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Emscripten</a> para criar um JAS do WASM.  Bem, eu disse que voc√™ tem uma licen√ßa do Apache 2.0 e o QEMU como um todo √© distribu√≠do sob a GPLv2, e eles n√£o s√£o muito compat√≠veis.  De repente, descobriu-se que a licen√ßa poderia ser de <em>alguma forma corrigida</em> (n√£o sei: talvez, altere, talvez o licenciamento duplo, talvez outra coisa ...).  Isso, √© claro, me deixou feliz, porque eu j√° tinha visto o Webinarembly de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">formato bin√°rio</a> v√°rias vezes naquela √©poca e, de alguma forma, era triste e incompreens√≠vel para mim.  Havia uma biblioteca aqui que devorar√° os blocos b√°sicos com o gr√°fico de transi√ß√£o, emitir√° o bytecode e at√© o lan√ßar√° no int√©rprete, se necess√°rio. </p><br><p>  Havia tamb√©m uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carta</a> na lista de discuss√£o da QEMU, mas √© mais prov√°vel que a pergunta "Quem precisa disso?"  E, de <strong>repente</strong> , foi necess√°rio.  No m√≠nimo, voc√™ pode agrupar esses casos de uso se funcionar de maneira mais ou menos inteligente: </p><br><ul><li>  lan√ßando qualquer coisa ensinando sem nenhuma instala√ß√£o </li><li>  virtualiza√ß√£o no iOS, onde, segundo os rumores, o √∫nico aplicativo que tem o direito de gerar c√≥digo em tempo real √© o mecanismo JS (isso √© verdade?) </li><li>  demonstra√ß√£o do mini-SO - disco √∫nico, embutido, todos os tipos de firmware, etc ... </li></ul><br><h2 id="osobennosti-brauzernoy-sredy-vypolneniya">  Recursos do tempo de execu√ß√£o do navegador </h2><br><p>  Como eu disse, o QEMU est√° vinculado ao multithreading, mas n√£o est√° no navegador.  Bem, isto √©, como n√£o ... No come√ßo, n√£o estava l√°, ent√£o os WebWorkers apareceram - pelo que entendi, isso √© multithreading com base na passagem de mensagens <strong>sem vari√°veis</strong> mutuamente <strong>vari√°veis</strong> .  Naturalmente, isso cria problemas significativos ao transportar o c√≥digo existente com base em um modelo de mem√≥ria compartilhada.  Ent√£o, sob press√£o do p√∫blico, foi implementado sob o nome <code>SharedArrayBuffers</code> .  Eles o introduziram gradualmente, comemoraram seu lan√ßamento em diferentes navegadores, comemoraram o ano novo e depois o colapso ... Ap√≥s o que chegaram √† conclus√£o de que √© rude, n√£o rude, a medi√ß√£o do tempo, mas com a ajuda da mem√≥ria compartilhada e um fluxo que incrementa o contador, ainda √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bastante preciso</a> .  Ent√£o, eles desativaram o multithreading com mem√≥ria compartilhada.  Parece que eles mais tarde ligaram novamente, mas, como ficou claro desde o primeiro experimento, h√° vida sem ele e, nesse caso, tentaremos faz√™-lo sem depender de multithreading. </p><br><p>  O segundo recurso √© a impossibilidade de manipula√ß√µes de baixo n√≠vel com a pilha: voc√™ n√£o pode simplesmente pegar, salvar o contexto atual e alternar para um novo com uma nova pilha.  A pilha de chamadas √© gerenciada pela m√°quina virtual JS.  Parece, qual √© o problema, j√° que ainda decidimos gerenciar os fluxos anteriores completamente manualmente?  O fato √© que o bloco de entrada e sa√≠da no QEMU √© implementado atrav√©s de corotinas, e aqui as manipula√ß√µes de pilha de baixo n√≠vel seriam √∫teis para n√≥s.  Felizmente, o Emscipten j√° cont√©m um mecanismo para opera√ß√µes ass√≠ncronas, at√© duas: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Asyncify</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Emterpreter</a> .  O primeiro funciona atrav√©s do incha√ßo significativo do c√≥digo JavaScript gerado e n√£o √© mais suportado.  A segunda √© a atual "maneira correta" e funciona atrav√©s da gera√ß√£o de bytecode para seu pr√≥prio int√©rprete.  Obviamente, funciona devagar, mas n√£o inflaciona o c√≥digo.  √â verdade que o suporte √† corotina para esse mecanismo tinha que ser atribu√≠do por conta pr√≥pria (j√° havia corotinas escritas em Asyncify e havia uma implementa√ß√£o aproximadamente da mesma API para o Emterpreter, voc√™ s√≥ precisava conect√°-las). </p><br><p>  No momento, ainda n√£o consegui dividir o c√≥digo em compilado no WASM e interpretado usando o Emterpreter, para que os dispositivos de bloco ainda n√£o funcionem (veja a pr√≥xima s√©rie, como se costuma dizer ...).  Ou seja, no final, voc√™ deve obter algo t√£o engra√ßado em camadas: </p><br><ul><li>  bloco I / O interpretado.  Bem, o que voc√™ realmente esperava de um NVMe emulado com desempenho nativo?  :) </li><li>  c√≥digo QEMU principal compilado estaticamente (tradutor, outros dispositivos emulados etc.) </li><li>  C√≥digo de convidado compilado dinamicamente WASM </li></ul><br><h2 id="osobennosti-ishodnikov-qemu">  Recursos de fontes QEMU </h2><br><p>  Como voc√™ provavelmente j√° adivinhou, o c√≥digo de emula√ß√£o para arquiteturas convidadas e o c√≥digo para gerar instru√ß√µes da m√°quina host do QEMU s√£o separados.  De fato, h√° ainda um pouco mais complicado: </p><br><ul><li>  existem arquiteturas convidadas </li><li>  existem <em>aceleradores</em> , a saber, o KVM para virtualiza√ß√£o de hardware no Linux (para sistemas de convidados e hosts compat√≠veis), o TCG para gera√ß√£o de c√≥digo JIT em qualquer lugar.  A partir do QEMU 2.9, apareceu o suporte para o padr√£o de virtualiza√ß√£o de hardware HAXM no Windows ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">detalhes</a> ) </li><li>  se o TCG for usado, e n√£o a virtualiza√ß√£o de hardware, ele ter√° suporte separado para gera√ß√£o de c√≥digo para cada arquitetura de host e para um int√©rprete universal </li><li>  ... e tudo mais - perif√©ricos emulados, interface do usu√°rio, migra√ß√£o, repeti√ß√£o de registros etc. </li></ul><br><p>  <em>A prop√≥sito, voc√™ sabia: o</em> QEMU pode emular n√£o apenas o computador inteiro, mas tamb√©m o processador para um processo de usu√°rio separado no kernel host, que √© usado, por exemplo, pelo fuzzer AFL para instrumenta√ß√£o de bin√°rios.  Talvez algu√©m queira portar esse modo de opera√ß√£o QEMU para JS?  ;) </p><br><p>  Como a maioria dos programas gratuitos de longa data, o QEMU √© constru√≠do atrav√©s de uma chamada para <code>configure</code> e <code>make</code> .  Suponha que voc√™ decida adicionar algo: um back-end do TCG, uma implementa√ß√£o de encadeamento, outra coisa.  N√£o se apresse para se alegrar / ficar horrorizado (sublinhe conforme necess√°rio) a perspectiva de se comunicar com o Autoconf - de fato, o <code>configure</code> no QEMU parece ser auto-escrito e n√£o h√° nada para gerar. </p><br><h2 id="webassembly">  Webassembly </h2><br><p>  Ent√£o, o que √© isso - WebAssembly (tamb√©m conhecido como WASM)?  Esta √© uma substitui√ß√£o do Asm.js, agora n√£o mais fingindo ser um c√≥digo JavaScript v√°lido.  Pelo contr√°rio, √© puramente bin√°rio e otimizado, e at√© mesmo escrever um n√∫mero inteiro nele n√£o √© muito simples: √© armazenado no formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LEB128</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compacta√ß√£o</a> . </p><br><p>  Voc√™ j√° deve ter ouvido falar sobre o algoritmo de recoloca√ß√£o do Asm.js. Essa √© a restaura√ß√£o das instru√ß√µes de controle de fluxo de execu√ß√£o de "alto n√≠vel" (ou seja, se-ent√£o-outro, loops etc.) sob as quais os mecanismos JS s√£o ajustados no LLVM IR de baixo n√≠vel, mais perto do c√≥digo da m√°quina executado pelo processador.  Naturalmente, a representa√ß√£o intermedi√°ria do QEMU est√° mais pr√≥xima do segundo.  Parece que aqui est√°, bytecode, o fim do tormento ... E ent√£o os blocos, if-then-else e loops! .. </p><br><p>  E esse √© outro motivo pelo qual o Binaryen √© √∫til: √© claro, ele pode aceitar blocos de alto n√≠vel pr√≥ximos ao que ser√° armazenado no WASM.  Mas tamb√©m pode produzir c√≥digo a partir do gr√°fico de blocos base e transi√ß√µes entre eles.  Bem, eu j√° disse que oculta o formato de armazenamento do WebAssembly atr√°s da conveniente API C / C ++. </p><br><h2 id="tcg-tiny-code-generator">  TCG (Gerador de c√≥digo min√∫sculo) </h2><br><p>  O TCG <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">era originalmente um</a> back <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">-</a> end para o compilador C. Ent√£o, aparentemente, n√£o conseguiu resistir √† concorr√™ncia com o GCC, mas no final encontrou seu lugar no QEMU como um mecanismo de gera√ß√£o de c√≥digo para a plataforma host.  H√° tamb√©m um back-end do TCG que gera algum bytecode abstrato, que √© imediatamente executado pelo int√©rprete, mas decidi sair dessa vez.  No entanto, o fato de o QEMU j√° ter a capacidade de permitir a transi√ß√£o para a TB gerada por meio da fun√ß√£o <code>tcg_qemu_tb_exec</code> foi muito √∫til para mim. </p><br><p>  Para adicionar um novo backend do TCG ao QEMU, √© necess√°rio criar um subdiret√≥rio <code>tcg/&lt; &gt;</code> (neste caso, <code>tcg/binaryen</code> ) e h√° dois arquivos nele: <code>tcg-target.h</code> <code>tcg-target.inc.c</code> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registre</a> tudo isso √© <code>configure</code> .  Voc√™ pode colocar outros arquivos l√°, mas, como voc√™ pode adivinhar pelos nomes desses dois, eles ser√£o inclu√≠dos em algum lugar: um como um arquivo de cabe√ßalho comum (ele ser√° inclu√≠do em <code>tcg/tcg.h</code> e esse j√° estar√° em outros arquivos nos diret√≥rios <code>tcg</code> , <code>accel</code> e n√£o apenas), o outro apenas como trecho de c√≥digo em <code>tcg/tcg.c</code> , mas tem acesso a suas fun√ß√µes est√°ticas. </p><br><p>  Tendo decidido que gastaria muito tempo com os procedimentos detalhados, como funciona, simplesmente copiei os "esqueletos" desses dois arquivos de outra implementa√ß√£o de back-end, indicando honestamente isso no cabe√ßalho da licen√ßa. </p><br><p>  O <code>tcg-target.h</code> cont√©m principalmente configura√ß√µes na forma de <code>#define</code> s: </p><br><ul><li>  quantos registros e qual a largura da arquitetura de destino (temos - tanto quanto queremos, existem tantos - a quest√£o √© mais do que o navegador gerar√° em um c√≥digo mais eficiente em uma arquitetura "completamente de destino") </li><li>  alinhamento das instru√ß√µes do host: no x86, e no TCI, as instru√ß√µes n√£o se alinham, mas vou colocar no buffer de c√≥digo nenhuma instru√ß√£o, mas ponteiros para as estruturas da biblioteca Binaryen, ent√£o direi: 4 bytes </li><li>  que instru√ß√µes opcionais o back-end pode gerar - ligue tudo o que encontramos em Binaryen, deixe o acelerador dividir o resto em outros mais simples </li><li>  qual tamanho aproximado do cache TLB √© solicitado pelo back-end.  O fato √© que, no QEMU, tudo √© s√©rio: embora existam fun√ß√µes auxiliares que carregam / armazenam, levando em considera√ß√£o a MMU convidada (e onde agora est√° sem ela?), Elas salvam seu cache de tradu√ß√£o na forma de uma estrutura, cujo processamento √© conveniente para incorporar diretamente para os blocos de tradu√ß√£o.  A quest√£o √©: qual deslocamento nessa estrutura √© tratado com mais efici√™ncia por uma pequena e r√°pida sequ√™ncia de comandos </li><li>  aqui voc√™ pode alterar o objetivo de um ou dois registros reservados, ativar a chamada de TB atrav√©s de uma fun√ß√£o e, opcionalmente, descrever algumas pequenas fun√ß√µes <code>inline</code> , como <code>flush_icache_range</code> (mas esse n√£o √© o nosso caso) </li></ul><br><p>  O <code>tcg-target.inc.c</code> , √© claro, geralmente √© muito maior e cont√©m v√°rias fun√ß√µes necess√°rias: </p><br><ul><li>  inicializa√ß√£o, indicando, inter alia, restri√ß√µes sobre quais instru√ß√µes com quais operandos podem trabalhar.  Copiado insolentemente por mim de outro back-end </li><li>  fun√ß√£o que aceita uma instru√ß√£o de bytecode interno </li><li>  aqui voc√™ pode colocar fun√ß√µes auxiliares e tamb√©m aqui voc√™ pode usar fun√ß√µes est√°ticas em <code>tcg/tcg.c</code> </li></ul><br><p>  Para mim, escolhi a seguinte estrat√©gia: nas primeiras palavras do pr√≥ximo bloco de transmiss√£o, escrevi quatro ponteiros: a marca de in√≠cio (um certo valor pr√≥ximo a <code>0xFFFFFFFF</code> , que determinava o estado atual da TB), o contexto, o m√≥dulo gerado e o n√∫mero m√°gico para depura√ß√£o.  Primeiro, o r√≥tulo foi definido como <code>0xFFFFFFFF - n</code> , onde <code>n</code> √© um n√∫mero positivo pequeno e, a cada vez que o interpretador era aumentado em 1. Quando alcan√ßava <code>0xFFFFFFFE</code> , ocorria a compila√ß√£o, o m√≥dulo era armazenado na tabela de fun√ß√µes, importado para um pequeno "iniciador", no qual A execu√ß√£o deixou <code>tcg_qemu_tb_exec</code> e o m√≥dulo foi exclu√≠do da mem√≥ria QEMU. </p><br><p>  Parafraseando os cl√°ssicos: "Muleta, quanto proger se entrela√ßou nesse som para o cora√ß√£o ...".  No entanto, a mem√≥ria estava vazando em algum lugar.  E era uma mem√≥ria gerenciada pelo QEMU!  Eu tinha um c√≥digo que, ao escrever a pr√≥xima instru√ß√£o (ou seja, um ponteiro), excluiu aquela cujo link estava neste local anteriormente, mas que n√£o ajudou.  Na verdade, no caso mais simples, o QEMU aloca mem√≥ria na inicializa√ß√£o e grava o c√≥digo gerado l√°.  Quando o buffer termina, o c√≥digo √© descartado e o pr√≥ximo come√ßa a ser escrito em seu lugar. </p><br><p>  Tendo estudado o c√≥digo, percebi que a muleta com n√∫mero m√°gico nos permitia n√£o cair na destrui√ß√£o da pilha, liberando algo errado no buffer n√£o inicializado na primeira passagem.  Mas quem substitui o buffer ignorando minha fun√ß√£o posteriormente?  Como os desenvolvedores do Emscripten aconselharam, tendo encontrado um problema, eu carreguei o c√≥digo resultante de volta para o aplicativo nativo, coloquei o Mozilla Record-Replay nele ... Em geral, como resultado, percebi uma coisa simples: um <code>struct TranslationBlock</code> com sua descri√ß√£o √© alocado para cada bloco.  Adivinhe onde ... Est√° certo, bem na frente do bloco, no buffer.  Tendo percebido isso, decidi amarr√°-lo com muletas (pelo menos algumas), e simplesmente joguei o n√∫mero m√°gico e transferi as palavras restantes para o <code>struct TranslationBlock</code> , criando uma lista de v√≠nculo √∫nico que voc√™ pode acessar rapidamente ao redefinir o cache de tradu√ß√£o e liberar mem√≥ria. </p><br><p>  Algumas muletas permaneceram: por exemplo, ponteiros marcados no buffer de c√≥digo - alguns deles s√£o simplesmente <code>BinaryenExpressionRef</code> , ou seja, eles examinam express√µes que precisam ser linearmente colocadas na unidade base gerada, parte - a condi√ß√£o de transi√ß√£o entre os WBs, parte - para onde ir.  Bem, j√° existem blocos preparados para o Relooper, que devem ser conectados de acordo com as condi√ß√µes.  Para distinguir entre eles, √© utilizado o pressuposto de que todos est√£o alinhados com pelo menos quatro bytes, para que voc√™ possa usar com seguran√ßa os dois bits inferiores do r√≥tulo, basta lembrar de remov√™-lo, se necess√°rio.  A prop√≥sito, esses r√≥tulos j√° s√£o usados ‚Äã‚Äãno QEMU para indicar o motivo da sa√≠da do ciclo do TCG. </p><br><h2 id="ispolzovanie-binaryen">  Usando Binaryen </h2><br><p>  Os m√≥dulos no WebAssembly cont√™m fun√ß√µes, cada uma contendo um corpo que representa uma express√£o.  Express√µes s√£o opera√ß√µes un√°rias e bin√°rias, blocos constitu√≠dos por listas de outras express√µes, fluxo de controle etc.  Como eu j√° disse, o fluxo de controle aqui √© organizado precisamente como ramifica√ß√µes de alto n√≠vel, loops, chamadas de fun√ß√£o etc.  Argumentos para fun√ß√µes s√£o passados ‚Äã‚Äãn√£o na pilha, mas explicitamente, como em JS.  Existem vari√°veis ‚Äã‚Äãglobais, mas eu n√£o as usei, ent√£o n√£o vou falar sobre elas. </p><br><p>  As fun√ß√µes tamb√©m possuem vari√°veis ‚Äã‚Äãlocais, numeradas do zero, do tipo: int32 / int64 / float / double.  As primeiras n vari√°veis ‚Äã‚Äãlocais s√£o os argumentos passados ‚Äã‚Äãpara a fun√ß√£o.  Observe que, embora tudo aqui n√£o seja totalmente de baixo n√≠vel em termos de fluxo de controle, mas n√∫meros inteiros ainda n√£o carregam o sinal / sinal n√£o assinado: como o n√∫mero se comportar√° depende do c√≥digo de opera√ß√£o. </p><br><p>  De um modo geral, o Binaryen fornece uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C-API simples</a> : voc√™ cria um m√≥dulo, <strong>nele</strong> cria express√µes - un√°rias, bin√°rias, blocos de outras express√µes, fluxo de controle etc.  Ent√£o voc√™ cria uma fun√ß√£o, cujo corpo voc√™ precisa especificar uma express√£o.  Se voc√™, como eu, tiver um gr√°fico de transi√ß√£o de baixo n√≠vel, o componente relooper o ajudar√°.  Pelo que entendi, √© poss√≠vel usar o controle de alto n√≠vel do fluxo de execu√ß√£o no bloco, desde que n√£o ultrapasse os limites do bloco - ou seja, √© poss√≠vel criar uma ramifica√ß√£o de caminho r√°pido / caminho lento interno dentro do c√≥digo de processamento de cache TLB interno, mas n√£o h√° como interferir no fluxo de controle "externo" .  Quando voc√™ libera o relooper, seus blocos s√£o liberados, quando voc√™ libera um m√≥dulo, express√µes, fun√ß√µes, etc., alocadas em sua <em>arena</em> desaparecem. </p><br><p>  No entanto, se voc√™ deseja interpretar o c√≥digo em movimento sem a cria√ß√£o e exclus√£o desnecess√°rias da inst√¢ncia do interpretador, pode fazer sentido transferir essa l√≥gica para um arquivo C ++ e, a partir da√≠, controlar diretamente toda a biblioteca da API C ++, ignorando os wrappers finalizados. </p><br><p>  Assim, para gerar o c√≥digo, voc√™ precisa </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    (  ) BinaryenSetAPITracing(0); BinaryenSetOptimizeLevel(3); BinaryenSetShrinkLevel(2); //   BinaryenModuleRef MODULE = BinaryenModuleCreate(); //    ( ,   ) helper_type BinaryenAddFunctionType(MODULE, "helper-func", BinaryenTypeInt32(), int32_helper_args, ARRAY_SIZE(int32_helper_args)); // (int23_helper_args ^W ) //  -  // ...     -  :) //    BinaryenAddFunction(MODULE, "tb_fun", tb_func_type, func_locals, FUNC_LOCALS_COUNT, expr); BinaryenAddFunctionExport(MODULE, "tb_fun", "tb_fun"); ... BinaryenSetMemory(MODULE, (1 &lt;&lt; 15) - 1, -1, NULL, NULL, NULL, NULL, NULL, 0, 0); BinaryenAddMemoryImport(MODULE, NULL, "env", "memory", 0); BinaryenAddTableImport(MODULE, NULL, "env", "tb_funcs"); //       assert (BinaryenModuleValidate(MODULE)); BinaryenModuleOptimize(MODULE);</span></span></code> </pre> <br><p> ‚Ä¶    ‚Äî ,     ,   ‚Äî   . </p><br><p>    --,  : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>]; BinaryenModuleOptimize(MODULE); BinaryenSetMemory(MODULE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sz = BinaryenModuleWrite(MODULE, buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf)); BinaryenModuleDispose(MODULE); EM_ASM({ var <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Module(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uint8Array(wasmMemory.buffer, $<span class="hljs-number"><span class="hljs-number">0</span></span>, $<span class="hljs-number"><span class="hljs-number">1</span></span>)); var fptr = $<span class="hljs-number"><span class="hljs-number">2</span></span>; var instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Instance(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, { <span class="hljs-string"><span class="hljs-string">'env'</span></span>: { <span class="hljs-string"><span class="hljs-string">'memory'</span></span>: wasmMemory, <span class="hljs-comment"><span class="hljs-comment">// ... } ); //       instance! }, buf, sz);</span></span></code> </pre> <br><p>  -     QEMU  JS        ,    (     ),     .    ,         translation block,   ,           <code>struct TranslationBlock</code> . </p><br><p> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> <em>(    )</em>     Firefox.  Chrome  <em>-  </em>  ,  -       WebAssembly,          ... </p><br><p>     . ,    ,   - .  ,    <em> </em>    . ,      WebAssembly  ,       JS,      ,     ,     . </p><br><p> <strong><strong> :</strong></strong>     32- ,         Binaryen, -     -   2  32-  .   ,     Binaryen       .   ? </p><br><div class="spoiler"> <b class="spoiler_title">-</b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu n√£o testei isso no final, mas meu primeiro pensamento foi "E se eu colocasse o Linux de 32 bits?" </font><font style="vertical-align: inherit;">A parte superior do espa√ßo de endere√ßo ser√° ocupada pelo kernel. </font><font style="vertical-align: inherit;">A √∫nica quest√£o √© quanto ser√° ocupado: 1 ou 2 Gb.</font></font></p></div></div><br><div class="spoiler"> <b class="spoiler_title">- (  )</b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s inflamos a bolha na parte superior do espa√ßo de endere√ßo. </font><font style="vertical-align: inherit;">Eu mesmo n√£o entendo por que funciona - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j√°</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve haver uma pilha </font><font style="vertical-align: inherit;">no mesmo lugar </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas "somos praticantes: tudo funciona para n√≥s, mas ningu√©m sabe o porqu√™ ...".</font></font></p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 2gbubble.c // Usage: LD_PRELOAD=2gbubble.so &lt;program&gt; #include &lt;sys/mman.h&gt; #include &lt;assert.h&gt; void __attribute__((constructor)) constr(void) { assert(MAP_FAILED != mmap(1u &gt;&gt; 31, (1u &gt;&gt; 31) - (1u &gt;&gt; 20), PROT_NONE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0)); }</span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... n√£o √© compat√≠vel com Valgrind, mas, felizmente, Valgrind √© muito eficaz para afastar todos de l√° :) </font></font></p><br><p> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez algu√©m d√™ uma explica√ß√£o melhor de como esse c√≥digo funciona ...</font></font></em> </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451306/">https://habr.com/ru/post/pt451306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451294/index.html">Como adicionei fun√ß√µes ao carro via CAN, n√£o consigo programar</a></li>
<li><a href="../pt451296/index.html">Anunciado pelo ML.NET 1.0</a></li>
<li><a href="../pt451298/index.html">Como criar um console de jogos com um estojo solicitando uma placa de circuito impresso</a></li>
<li><a href="../pt451302/index.html">Principais empresas de terceiriza√ß√£o de TI</a></li>
<li><a href="../pt451304/index.html">Yandex "tip": como maximizar os lucros em uma assinatura paga</a></li>
<li><a href="../pt451310/index.html">Voc√™ sente falta do PDA?</a></li>
<li><a href="../pt451314/index.html">Produ√ß√£o de placas de circuito impresso LUT'om de A a Z</a></li>
<li><a href="../pt451316/index.html">Sobre uma Faculdade de F√≠sica</a></li>
<li><a href="../pt451318/index.html">An√∫ncio do Dart 2.3: otimizado para o desenvolvimento da interface do usu√°rio</a></li>
<li><a href="../pt451320/index.html">Por que o firmware aberto √© importante para seguran√ßa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>