<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵 🚉 👩🏿‍🎤 我们通过道路质量对俄罗斯城市进行评级 🥘 🙍🏽 👩🏻‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我再一次开车在我的家乡绕过另一个坑，我想：在我们的国家中是否存在这样的“好”道路，所以我决定我们应该用我们国家的道路质量客观地评估情况。 

 任务形式化 
 在俄罗斯，对道路质量的要求在GOST R 50597-2017“道路与道路。 在确保道路安全的条件下可接受的运行状态要求。 控制方法。” 该...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们通过道路质量对俄罗斯城市进行评级</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437542/"><img src="https://habrastorage.org/webt/qg/pm/pf/qgpmpfivqp5xqw2c8-qvxjp4-dq.jpeg"><br><br> 我再一次开车在我的家乡绕过另一个坑，我想：在我们的国家中是否存在这样的“好”道路，所以我决定我们应该用我们国家的道路质量客观地评估情况。 <br><a name="habracut"></a><br><h2> 任务形式化 </h2><br> 在俄罗斯，对道路质量的要求在GOST R 50597-2017“道路与道路。 在确保道路安全的条件下可接受的运行状态要求。 控制方法。” 该文件定义了覆盖行车道，路边，分隔带，人行道，人行道等的要求，并确定了损坏的类型。 <br><br> 由于确定道路的所有参数的任务非常艰巨，因此我决定自己缩小范围，仅关注确定道路覆盖范围缺陷的问题。 在GOST R 50597-2017中，对道路涂层的以下缺陷进行了区分： <br><br><ul><li> 坑洼 </li><li> 休息时间 </li><li> 缩编 </li><li> 班次 </li><li> 梳子 </li><li> 追踪 </li><li> 汗水粘合剂 </li></ul><br> 我决定解决这些缺陷。 <br><br><h2> 资料收集 </h2><br> 在哪里可以得到描绘道路足够大的照片，甚至参考地理位置？ 答案来自水钻-Yandex（或Google）地图上的全景图，但是，经过一番搜索，我发现了更多其他选择： <br><br><ul><li> 为相关请求发布图片搜索引擎； </li><li> 用于接收投诉的网站上的照片（罗斯山，愤怒的公民，美德等） </li><li>  Opendatascience提示一个项目以标记的数据集检测道路缺陷<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-github.com/sekilab/RoadDamageDetector</a> </li></ul><br> 不幸的是，对这些选项的分析表明，它们对我而言不太合适：发出搜索引擎的声音很多（很多不是道路的照片，各种渲染等），来自投诉站点的照片仅包含严重违反沥青表面的照片，在这些站点上有很多违反覆盖率小的照片，而没有违反覆盖率的照片，RoadDamageDetector项目的数据集是在日本收集的，不包含违反覆盖率大的样本以及完全没有覆盖率的道路。 <br><br> 由于其他选项不合适，因此我们将使用Yandex全景图（我排除了Google全景图选项，因为该服务在俄罗斯的城市较少，并且更新频率也不高）。 他决定在人口超过10万的城市以及联邦中心收集数据。 我列出了城市名称列表-其中有176个城市，后来发现只有149个城市名称。 我不会深入探讨解析图块的功能，我会说最终得到了149个文件夹（每个城市一个文件夹），其中总共有170万张照片。 例如，对于Novokuznetsk，该文件夹如下所示： <br><br><img src="https://habrastorage.org/webt/aw/fa/73/awfa73gw128fyrvl8au2b_brjb8.png"><br><br> 根据下载的照片数量，城市分布如下： <br><br><div class="spoiler">  <b class="spoiler_title">桌子</b> <div class="spoiler_text"><table><tbody><tr><th> 城市名 <br></th><th> 照片数量，件 <br></th></tr><tr><td> 莫斯科 <br><br></td><td>  86048 <br><br></td></tr><tr><td> 圣彼得堡 <br><br></td><td>  41376 <br><br></td></tr><tr><td> 萨拉斯克 <br><br></td><td>  18880 <br><br></td></tr><tr><td> 波多尔斯克 <br><br></td><td>  18560 <br><br></td></tr><tr><td> 克拉斯诺戈尔斯克 <br><br></td><td>  18208 <br><br></td></tr><tr><td> 柳伯特西 <br><br></td><td>  17760 <br><br></td></tr><tr><td> 加里宁格勒 <br><br></td><td>  16928 <br><br></td></tr><tr><td> 科洛姆纳 <br><br></td><td>  16832 <br><br></td></tr><tr><td> 密志 <br><br></td><td>  16192 <br><br></td></tr><tr><td> 海参div <br><br></td><td>  16096 <br><br></td></tr><tr><td> 巴拉希卡 <br><br></td><td>  15968 <br><br></td></tr><tr><td> 彼得罗扎沃茨克 <br><br></td><td>  15968 <br><br></td></tr><tr><td> 叶卡捷琳堡 <br><br></td><td>  15808 <br><br></td></tr><tr><td> 大诺夫哥罗德 <br><br></td><td>  15744 <br><br></td></tr><tr><td> 纳贝雷兹尼·切尔尼（Naberezhnye Chelny） <br><br></td><td>  15680 <br><br></td></tr><tr><td> 克拉斯诺达尔 <br><br></td><td>  15520 <br><br></td></tr><tr><td> 下诺夫哥罗德 <br><br></td><td>  15488 <br><br></td></tr><tr><td> 希姆基 <br><br></td><td>  15296 <br><br></td></tr><tr><td> 图拉 <br><br></td><td>  15296 <br><br></td></tr><tr><td> 新西伯利亚 <br><br></td><td>  15264 <br><br></td></tr><tr><td> 特维尔 <br><br></td><td>  15200 <br><br></td></tr><tr><td> 米亚斯 <br><br></td><td>  15104 <br><br></td></tr><tr><td> 伊万诺沃 <br><br></td><td>  15072 <br><br></td></tr><tr><td> 沃洛格达 <br><br></td><td>  15008 <br><br></td></tr><tr><td> 茹科夫斯基 <br><br></td><td>  14976 <br><br></td></tr><tr><td> 科斯特罗马 <br><br></td><td>  14912 <br><br></td></tr><tr><td> 萨马拉 <br><br></td><td>  14880 <br><br></td></tr><tr><td> 科罗廖夫 <br><br></td><td>  14784 <br><br></td></tr><tr><td> 卡卢加 <br><br></td><td>  14720 <br><br></td></tr><tr><td>  Cherepovets <br><br></td><td>  14720 <br><br></td></tr><tr><td> 塞瓦斯托波尔 <br><br></td><td>  14688 <br><br></td></tr><tr><td> 普希金诺 <br><br></td><td>  14528 <br><br></td></tr><tr><td> 雅罗斯拉夫尔 <br><br></td><td>  14464 <br><br></td></tr><tr><td> 乌里扬诺夫斯克 <br><br></td><td>  14400 <br><br></td></tr><tr><td> 顿河畔罗斯托夫 <br><br></td><td>  14368 <br><br></td></tr><tr><td> 多莫杰多沃 <br><br></td><td>  14304 <br><br></td></tr><tr><td> 卡门斯克-乌拉尔斯基 <br><br></td><td>  14208 <br><br></td></tr><tr><td> 普斯科夫 <br><br></td><td>  14144 <br><br></td></tr><tr><td> 约什卡尔奥拉 <br><br></td><td>  14080 <br><br></td></tr><tr><td> 刻赤 <br><br></td><td>  14080 <br><br></td></tr><tr><td> 摩尔曼斯克 <br><br></td><td>  13920 <br><br></td></tr><tr><td> 陶里亚蒂 <br><br></td><td>  13920 <br><br></td></tr><tr><td> 弗拉基米尔 <br><br></td><td>  13792 <br><br></td></tr><tr><td> 老鹰 <br><br></td><td>  13792 <br><br></td></tr><tr><td> 西克特夫卡 <br><br></td><td>  13728 <br><br></td></tr><tr><td> 多尔格普鲁德尼 <br><br></td><td>  13696 <br><br></td></tr><tr><td> 汉蒂·曼西斯克 <br><br></td><td>  13664 <br><br></td></tr><tr><td> 喀山 <br><br></td><td>  13600 <br><br></td></tr><tr><td> 恩格斯 <br><br></td><td>  13440 <br><br></td></tr><tr><td> 阿尔汉格尔斯克 <br><br></td><td>  13280 <br><br></td></tr><tr><td> 布良斯克 <br><br></td><td>  13216 <br><br></td></tr><tr><td> 鄂木斯克 <br><br></td><td>  13120 <br><br></td></tr><tr><td> 赛兹兰 <br><br></td><td>  13088 <br><br></td></tr><tr><td> 克拉斯诺亚尔斯克 <br><br></td><td>  13056 <br><br></td></tr><tr><td> 谢尔科沃 <br><br></td><td>  12928 <br><br></td></tr><tr><td> 奔萨 <br><br></td><td>  12864 <br><br></td></tr><tr><td> 车里雅宾斯克 <br><br></td><td>  12768 <br><br></td></tr><tr><td> 切博克萨雷 <br><br></td><td>  12768 <br><br></td></tr><tr><td> 下塔吉尔 <br><br></td><td>  12672 <br><br></td></tr><tr><td> 斯塔夫罗波尔 <br><br></td><td>  12672 <br><br></td></tr><tr><td> 拉门斯科耶 <br><br></td><td>  12640 <br><br></td></tr><tr><td> 伊尔库茨克 <br><br></td><td>  12608 <br><br></td></tr><tr><td> 安加尔斯克 <br><br></td><td>  12608 <br><br></td></tr><tr><td> 秋明州 <br><br></td><td>  12512 <br><br></td></tr><tr><td> 奥丁佐沃 <br><br></td><td>  12512 <br><br></td></tr><tr><td> 乌法 <br><br></td><td>  12512 <br><br></td></tr><tr><td> 马加丹 <br><br></td><td>  12512 <br><br></td></tr><tr><td> 烫发 <br><br></td><td>  12448 <br><br></td></tr><tr><td> 基洛夫 <br><br></td><td>  12256 <br><br></td></tr><tr><td> 下涅卡姆斯克 <br><br></td><td>  12224 <br><br></td></tr><tr><td> 马哈奇卡拉 <br><br></td><td>  12096 <br><br></td></tr><tr><td> 下涅瓦尔托夫斯克 <br><br></td><td>  11936 <br><br></td></tr><tr><td> 库尔斯克 <br><br></td><td>  11904 <br><br></td></tr><tr><td> 索契 <br><br></td><td>  11872 <br><br></td></tr><tr><td> 坦波夫 <br><br></td><td>  11840 <br><br></td></tr><tr><td> 皮雅提哥尔斯克 <br><br></td><td>  11808 <br><br></td></tr><tr><td> 伏尔加东斯克 <br><br></td><td>  11712 <br><br></td></tr><tr><td> 梁赞 <br><br></td><td>  11680 <br><br></td></tr><tr><td> 萨拉托夫 <br><br></td><td>  11616 <br><br></td></tr><tr><td> 捷尔任斯克 <br><br></td><td>  11456 <br><br></td></tr><tr><td> 奥伦堡 <br><br></td><td>  11456 <br><br></td></tr><tr><td> 土墩 <br><br></td><td>  11424 <br><br></td></tr><tr><td> 伏尔加格勒 <br><br></td><td>  11264 <br><br></td></tr><tr><td> 伊热夫斯克 <br><br></td><td>  11168 <br><br></td></tr><tr><td> 金口 <br><br></td><td>  11136 <br><br></td></tr><tr><td> 利佩茨克 <br><br></td><td>  11072 <br><br></td></tr><tr><td> 基斯洛沃茨克 <br><br></td><td>  11072 <br><br></td></tr><tr><td> 苏尔古特 <br><br></td><td>  11040 <br><br></td></tr><tr><td> 马格尼托哥尔斯克 <br><br></td><td>  10912 <br><br></td></tr><tr><td> 斯摩棱斯克 <br><br></td><td>  10784 <br><br></td></tr><tr><td> 哈巴罗夫斯克 <br><br></td><td>  10752 <br><br></td></tr><tr><td> 科佩斯克 <br><br></td><td>  10688 <br><br></td></tr><tr><td>  Maykop <br><br></td><td>  10656 <br><br></td></tr><tr><td> 彼得罗巴甫洛夫斯克-堪察加斯基 <br><br></td><td>  10624 <br><br></td></tr><tr><td> 塔甘罗格 <br><br></td><td>  10560 <br><br></td></tr><tr><td> 巴瑙尔 <br><br></td><td>  10528 <br><br></td></tr><tr><td> 塞尔吉夫·波萨德（Sergiev Posad） <br><br></td><td>  10368 <br><br></td></tr><tr><td> 埃莉斯塔 <br><br></td><td>  10304 <br><br></td></tr><tr><td> 斯特利塔马克 <br><br></td><td>  9920 <br><br></td></tr><tr><td> 辛菲罗波尔 <br><br></td><td>  9824 <br><br></td></tr><tr><td> 托木斯克 <br><br></td><td>  9760 <br><br></td></tr><tr><td>  Orekhovo-Zuevo <br><br></td><td>  9728 <br><br></td></tr><tr><td> 阿斯特拉罕 <br><br></td><td>  9664 <br><br></td></tr><tr><td>  Evpatoria <br><br></td><td>  9568 <br><br></td></tr><tr><td> 诺金斯克 <br><br></td><td>  9344 <br><br></td></tr><tr><td> 赤太 <br><br></td><td>  9216 <br><br></td></tr><tr><td> 别尔哥罗德 <br><br></td><td>  9120 <br><br></td></tr><tr><td> 比斯克 <br><br></td><td>  8928 <br><br></td></tr><tr><td> 雷宾斯克 <br><br></td><td>  8896 <br><br></td></tr><tr><td> 谢韦罗德文斯克 <br><br></td><td>  8832 <br><br></td></tr><tr><td> 沃罗涅日 <br><br></td><td>  8768 <br><br></td></tr><tr><td> 布拉戈维申斯克 <br><br></td><td>  8672 <br><br></td></tr><tr><td> 新罗西斯克 <br><br></td><td>  8608 <br><br></td></tr><tr><td> 乌兰乌德 <br><br></td><td>  8576 <br><br></td></tr><tr><td> 谢尔普霍夫 <br><br></td><td>  8320 <br><br></td></tr><tr><td> 阿穆尔河畔科姆索莫尔斯克 <br><br></td><td>  8192 <br><br></td></tr><tr><td> 阿巴坎 <br><br></td><td>  8128 <br><br></td></tr><tr><td> 诺里尔斯克 <br><br></td><td>  8096 <br><br></td></tr><tr><td> 南萨哈林斯克 <br><br></td><td>  8032 <br><br></td></tr><tr><td> 奥布宁斯克 <br><br></td><td>  7904 <br><br></td></tr><tr><td> 埃森图基 <br><br></td><td>  7712 <br><br></td></tr><tr><td> 巴塔斯克 <br><br></td><td>  7648 <br><br></td></tr><tr><td> 沃尔日斯基 <br><br></td><td>  7584 <br><br></td></tr><tr><td> 新切尔卡斯克 <br><br></td><td>  7488 <br><br></td></tr><tr><td> 别尔茨克 <br><br></td><td>  7456 <br><br></td></tr><tr><td>  Arzamas <br><br></td><td>  7424 <br><br></td></tr><tr><td>  Pervouralsk <br><br></td><td>  7392 <br><br></td></tr><tr><td> 克麦罗沃 <br><br></td><td>  7104 <br><br></td></tr><tr><td>  Elektrostal <br><br></td><td>  6720 <br><br></td></tr><tr><td> 德本特 <br><br></td><td>  6592 <br><br></td></tr><tr><td> 雅库茨克 <br><br></td><td>  6528 <br><br></td></tr><tr><td> 慕罗姆 <br><br></td><td>  6240 <br><br></td></tr><tr><td> 涅夫捷尤甘斯克 <br><br></td><td>  5792 <br><br></td></tr><tr><td> 罗伊托夫 <br><br></td><td>  5696 <br><br></td></tr><tr><td> 比罗比詹 <br><br></td><td>  5440 <br><br></td></tr><tr><td> 新库比雪夫斯克 <br><br></td><td>  5248 <br><br></td></tr><tr><td>  Salekhard <br><br></td><td>  5184 <br><br></td></tr><tr><td> 新库兹涅茨克 <br><br></td><td>  5152 <br><br></td></tr><tr><td>  Novy Urengoy <br><br></td><td>  4736 <br><br></td></tr><tr><td>  Noyabrsk <br><br></td><td>  4416 <br><br></td></tr><tr><td> 新切贝克萨尔斯克 <br><br></td><td>  4352 <br><br></td></tr><tr><td> 叶列兹 <br><br></td><td>  3968 <br><br></td></tr><tr><td> 卡斯皮斯克 <br><br></td><td>  3936 <br><br></td></tr><tr><td> 斯塔里·奥斯科尔（Stary Oskol） <br><br></td><td>  3840 <br><br></td></tr><tr><td>  Artyom <br><br></td><td>  3744 <br><br></td></tr><tr><td> 热列兹诺戈尔斯克 <br><br></td><td>  3584 <br><br></td></tr><tr><td> 萨拉瓦特 <br><br></td><td>  3584 <br><br></td></tr><tr><td> 普罗科别耶夫斯克 <br><br></td><td>  2816 <br><br></td></tr><tr><td> 戈尔诺-阿尔泰斯克 <br><br></td><td>  2464 <br><br></td></tr></tbody></table><br></div></div><br><h2> 准备训练数据集 </h2><br> 这样，数据集就被组装好了，现在，如何获得路段和周围物体的照片，以找出上面显示的沥青的质量？ 我决定在原始照片的中间正中间的下方切出一块尺寸为350 * 244像素的照片。 然后将裁切的裁片水平缩小到244像素。 生成的图像（大小为244 * 244）将作为卷积编码器的输入： <br><br><img src="https://habrastorage.org/webt/ya/tt/s8/yatts8qbzq9ddnxql_cydrmfeug.png"><br><br> 为了更好地了解我处理的数据，我对自己标记的前2000张照片，其余的照片由Yandex.Tolki员工进行了标记。 在他们面前，我用以下措词提出了一个问题。 <br><br> 指明您在照片中看到的路面： <br><br><ol><li> 土壤/瓦砾 </li><li> 铺路石，瓷砖，人行道 </li><li> 铁轨，铁轨 </li><li> 水，大水坑 </li><li> 沥青 </li><li> 照片中没有道路/异物/汽车遮挡不可见 </li></ol><br> 如果表演者选择“沥青”，则会出现一个菜单，用于评估其质量： <br><br><ol><li> 出色的覆盖率 </li><li> 轻微的单裂纹/浅的单坑 </li><li> 大裂缝/网格裂缝/单个小坑洼 </li><li> 大坑洞/深坑洞/涂层被破坏 </li></ol><br> 正如任务的测试运行所示，Y。Toloki的执行者在工作的完整性上并没有不同-他们不小心用鼠标单击了字段并认为任务已完成。 我必须添加控制问题（作业中有46张照片，其中12张是控制照片），并允许延迟接受。 作为控制问题，我使用了自己标记的照片。 我自动执行了延迟验收-Y. Toloka允许您将工作结果上传到CSV文件，并加载对响应进行验证的结果。 验证答案的工作方式如下-如果任务包含控制问题的5％以上的不正确答案，则认为该任务未完成。 此外，如果承包商指示的答案在逻辑上接近于真，则认为他的答案是正确的。 <br> 结果，我得到了大约3万张带标签的照片，我决定将这些照片分三类进行培训： <br><br><ul><li>  “好”-标有“沥青：出色的涂层”和“沥青：轻微的单裂缝”的照片 </li><li>  “中间”-标有“铺路石，瓷砖，人行道”，“铁路，铁轨”和“沥青：大裂缝/网格裂缝/单个小坑洼”的照片 </li><li>  “大”-贴有“土壤/碎石”，“水，大水坑”和“沥青：大量坑洼/深坑洼/被毁路面”的照片 </li><li> 标记为“照片中没有路/异物/汽车遮盖不可见”的照片很少（22个。）我将它们排除在以后的工作之外 </li></ul><br><h2> 分类器开发和培训 </h2><br> 因此，收集并标记数据后，我们便进行分类器的开发。 通常，对于图像分类的任务，尤其是在小数据集上进行训练时，使用现成的卷积编码器，将新的分类器连接到其输出。 我决定使用没有隐藏层，大小为128的输入层和大小为3的输出层的简单分类器。我决定立即使用在ImageNet上训练的几个现成的选项作为编码器： <br><br><ul><li>  Xception </li><li>  Resnet </li><li> 起始时间 </li><li>  Vgg16 </li><li>  Densenet121 </li><li> 移动网 </li></ul><br> 这是使用给定编码器创建Keras模型的函数： <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(typeModel)</span></span></span><span class="hljs-function">:</span></span> conv_base = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"nasnet"</span></span>): conv_base = keras.applications.nasnet.NASNetMobile(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"xception"</span></span>): conv_base = keras.applications.xception.Xception(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"resnet"</span></span>): conv_base = keras.applications.resnet50.ResNet50(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"inception"</span></span>): conv_base = keras.applications.inception_v3.InceptionV3(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"densenet121"</span></span>): conv_base = keras.applications.densenet.DenseNet121(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"mobilenet"</span></span>): conv_base = keras.applications.mobilenet_v2.MobileNetV2(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(typeModel == <span class="hljs-string"><span class="hljs-string">"vgg16"</span></span>): conv_base = keras.applications.vgg16.VGG16(include_top=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>), weights=<span class="hljs-string"><span class="hljs-string">'imagenet'</span></span>) conv_base.trainable = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> model = Sequential() model.add(conv_base) model.add(Flatten()) model.add(Dense(<span class="hljs-number"><span class="hljs-number">128</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, kernel_regularizer=regularizers.l2(<span class="hljs-number"><span class="hljs-number">0.0002</span></span>))) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.3</span></span>)) model.add(Dense(<span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)) model.compile(optimizer=keras.optimizers.Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-4</span></span>), loss=<span class="hljs-string"><span class="hljs-string">'binary_crossentropy'</span></span>, metrics=[<span class="hljs-string"><span class="hljs-string">'accuracy'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model</code> </pre> <br> 为了进行培训，我使用了带有增强功能的生成器（由于Keras内置的增强功能似乎不足，因此我使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Augmentor</a>库）： <br><br><ul><li> 斜坡 </li><li> 随机失真 </li><li> 转弯 </li><li> 换色 </li><li> 班次 </li><li> 改变对比度和亮度 </li><li> 添加随机噪声 </li><li> 作物 </li></ul><br> 扩充后，照片如下所示： <br><br><img src="https://habrastorage.org/webt/yc/qy/uh/ycqyuh1no4h57-or062y3epc4yy.png"><br><br> 生成器代码： <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_datagen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> train_dir=<span class="hljs-string"><span class="hljs-string">'~/data/train_img'</span></span> test_dir=<span class="hljs-string"><span class="hljs-string">'~/data/test_img'</span></span> testDataGen = ImageDataGenerator(rescale=<span class="hljs-number"><span class="hljs-number">1.</span></span> / <span class="hljs-number"><span class="hljs-number">255</span></span>) train_generator = datagen.flow_from_directory( train_dir, target_size=img_size, batch_size=<span class="hljs-number"><span class="hljs-number">16</span></span>, class_mode=<span class="hljs-string"><span class="hljs-string">'categorical'</span></span>) p = Augmentor.Pipeline(train_dir) p.skew(probability=<span class="hljs-number"><span class="hljs-number">0.9</span></span>) p.random_distortion(probability=<span class="hljs-number"><span class="hljs-number">0.9</span></span>,grid_width=<span class="hljs-number"><span class="hljs-number">3</span></span>,grid_height=<span class="hljs-number"><span class="hljs-number">3</span></span>,magnitude=<span class="hljs-number"><span class="hljs-number">8</span></span>) p.rotate(probability=<span class="hljs-number"><span class="hljs-number">0.9</span></span>, max_left_rotation=<span class="hljs-number"><span class="hljs-number">5</span></span>, max_right_rotation=<span class="hljs-number"><span class="hljs-number">5</span></span>) p.random_color(probability=<span class="hljs-number"><span class="hljs-number">0.7</span></span>, min_factor=<span class="hljs-number"><span class="hljs-number">0.8</span></span>, max_factor=<span class="hljs-number"><span class="hljs-number">1</span></span>) p.flip_left_right(probability=<span class="hljs-number"><span class="hljs-number">0.7</span></span>) p.random_brightness(probability=<span class="hljs-number"><span class="hljs-number">0.7</span></span>, min_factor=<span class="hljs-number"><span class="hljs-number">0.8</span></span>, max_factor=<span class="hljs-number"><span class="hljs-number">1.2</span></span>) p.random_contrast(probability=<span class="hljs-number"><span class="hljs-number">0.5</span></span>, min_factor=<span class="hljs-number"><span class="hljs-number">0.9</span></span>, max_factor=<span class="hljs-number"><span class="hljs-number">1</span></span>) p.random_erasing(probability=<span class="hljs-number"><span class="hljs-number">1</span></span>,rectangle_area=<span class="hljs-number"><span class="hljs-number">0.2</span></span>) p.crop_by_size(probability=<span class="hljs-number"><span class="hljs-number">1</span></span>, width=<span class="hljs-number"><span class="hljs-number">244</span></span>, height=<span class="hljs-number"><span class="hljs-number">244</span></span>, centre=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) train_generator = keras_generator(p,batch_size=<span class="hljs-number"><span class="hljs-number">16</span></span>) test_generator = testDataGen.flow_from_directory( test_dir, target_size=img_size, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, class_mode=<span class="hljs-string"><span class="hljs-string">'categorical'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (train_generator, test_generator)</code> </pre> <br> 该代码显示扩充不用于测试数据。 <br><br> 有了经过调整的生成器，您就可以开始训练模型，我们将分两个阶段执行该模型：首先，仅训练我们的分类器，然后完全训练整个模型。 <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evalModelstep1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(typeModel)</span></span></span><span class="hljs-function">:</span></span> K.clear_session() gc.collect() model=createModel(typeModel) traiGen,testGen=getDatagen() model.fit_generator(generator=traiGen, epochs=<span class="hljs-number"><span class="hljs-number">4</span></span>, steps_per_epoch=<span class="hljs-number"><span class="hljs-number">30000</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span>, validation_steps=len(testGen), validation_data=testGen, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evalModelstep2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model)</span></span></span><span class="hljs-function">:</span></span> early_stopping_callback = EarlyStopping(monitor=<span class="hljs-string"><span class="hljs-string">'val_loss'</span></span>, patience=<span class="hljs-number"><span class="hljs-number">3</span></span>) model.layers[<span class="hljs-number"><span class="hljs-number">0</span></span>].trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> model.trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> model.compile(optimizer=keras.optimizers.Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-5</span></span>), loss=<span class="hljs-string"><span class="hljs-string">'binary_crossentropy'</span></span>, metrics=[<span class="hljs-string"><span class="hljs-string">'accuracy'</span></span>]) traiGen,testGen=getDatagen() model.fit_generator(generator=traiGen, epochs=<span class="hljs-number"><span class="hljs-number">25</span></span>, steps_per_epoch=<span class="hljs-number"><span class="hljs-number">30000</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span>, validation_steps=len(testGen), validation_data=testGen, callbacks=[early_stopping_callback] ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">full_fit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> model_names=[ <span class="hljs-string"><span class="hljs-string">"xception"</span></span>, <span class="hljs-string"><span class="hljs-string">"resnet"</span></span>, <span class="hljs-string"><span class="hljs-string">"inception"</span></span>, <span class="hljs-string"><span class="hljs-string">"vgg16"</span></span>, <span class="hljs-string"><span class="hljs-string">"densenet121"</span></span>, <span class="hljs-string"><span class="hljs-string">"mobilenet"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> model_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> model_names: print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) print(model_name) print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) print(<span class="hljs-string"><span class="hljs-string">"#########################################"</span></span>) model = evalModelstep1(model_name) model = evalModelstep2(model) model.save(<span class="hljs-string"><span class="hljs-string">"~/data/models/model_new_"</span></span>+str(model_name)+<span class="hljs-string"><span class="hljs-string">".h5"</span></span>)</code> </pre><br> 调用full_fit（）并等待。 我们等待了很长时间。 <br><br> 结果，我们将有六个训练有素的模型，我们将在标记数据的单独部分上检查这些模型的准确性；我收到以下信息： <br><br><table><tbody><tr><td><p> 型号名称 </p><br></td><td><p> 准确度％ </p><br></td></tr><tr><td><p>  Xception </p><br></td><td><p>  87.3 </p><br></td></tr><tr><td><p>  Resnet </p><br></td><td><p>  90.8 </p><br></td></tr><tr><td><p> 起始时间 </p><br></td><td><p>  90.2 </p><br></td></tr><tr><td><p>  Vgg16 </p><br></td><td><p>  89.2 </p><br></td></tr><tr><td><p>  Densenet121 </p><br></td><td><p>  90.6 </p><br></td></tr><tr><td><p> 移动网 </p><br></td><td><p>  86.5 </p><br></td></tr></tbody></table><br> 总的来说，并没有很多，但是由于培训样本如此之小，人们不能期望更多。 为了稍微提高精度，我通过平均以下方式组合了模型的输出： <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_meta_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> model_names=[ <span class="hljs-string"><span class="hljs-string">"xception"</span></span>, <span class="hljs-string"><span class="hljs-string">"resnet"</span></span>, <span class="hljs-string"><span class="hljs-string">"inception"</span></span>, <span class="hljs-string"><span class="hljs-string">"vgg16"</span></span>, <span class="hljs-string"><span class="hljs-string">"densenet121"</span></span>, <span class="hljs-string"><span class="hljs-string">"mobilenet"</span></span> ] model_input = Input(shape=(<span class="hljs-number"><span class="hljs-number">244</span></span>,<span class="hljs-number"><span class="hljs-number">244</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)) submodels=[] i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> model_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> model_names: filename= <span class="hljs-string"><span class="hljs-string">"~/data/models/model_new_"</span></span>+str(model_name)+<span class="hljs-string"><span class="hljs-string">".h5"</span></span> submodel = keras.models.load_model(filename) submodel.name = model_name+<span class="hljs-string"><span class="hljs-string">"_"</span></span>+str(i) i+=<span class="hljs-number"><span class="hljs-number">1</span></span> submodels.append(submodel(model_input)) out=average(submodels) model = Model(inputs = model_input,outputs=out) model.compile(optimizer=keras.optimizers.Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-4</span></span>), loss=<span class="hljs-string"><span class="hljs-string">'binary_crossentropy'</span></span>, metrics=[<span class="hljs-string"><span class="hljs-string">'accuracy'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model</code> </pre><br> 得出的准确度为91.3％。 基于这个结果，我决定停下来。 <br><br><h2> 使用分类器 </h2><br> 最终，分类器已准备就绪，可以投入使用！ 我准备输入数据并运行分类器-一天多一点，处理了170万张照片。 现在最有趣的部分是结果。 立即将相对数量的道路中的前十个城市和后十个城市带入覆盖范围良好的道路： <br><br><img src="https://habrastorage.org/webt/mf/vl/xu/mfvlxuvjesvy2leqhplfnik4mm8.png"><br><br><div class="spoiler">  <b class="spoiler_title">全表（可点击图片）</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9d8/4fd/38c/9d84fd38c07014be4f68499489ce19bc.png"></a> <br></div></div><br><br> 这是联邦科目的道路质量等级： <br><br><img src="https://habrastorage.org/webt/ih/kq/xq/ihkqxqskkfcfib90gc68ivmxo2i.png"><br><br><div class="spoiler">  <b class="spoiler_title">满桌</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/md/6j/-m/md6j-mv6jt27zsxgu8wkd2pimmy.png"><br></div></div><br> 联邦地区评分： <br><br><img src="https://habrastorage.org/webt/ro/qq/ry/roqqryu12toajz6cgeals3vzuxc.png"><br><br> 整个俄罗斯的道路质量分布： <br><br><img src="https://habrastorage.org/webt/ow/rt/h1/owrth1ro6yu3svxdpwiyfedzeby.png"><br><br> 好，就是这样，每个人都可以自己得出结论。 <br><br> 最后，我将提供每个类别中最好的照片（在该类别中获得了最高的评价）： <br><br><div class="spoiler">  <b class="spoiler_title">图片</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/k9/yf/dl/k9yfdlmiuynquyqhoxjuowvzcsu.jpeg"><br></div></div><br><br>  PS在评论中，很正确地指出了有关照片接收年份的统计数据。 我更正并给出一张桌子： <br><table><tbody><tr><td><p> 年份 </p><br></td><td><p> 照片数量，件 </p><br></td></tr><tr><td>  2008年 </td><td>  37 </td></tr><tr><td>  2009年 </td><td>  13 </td></tr><tr><td>  2010 </td><td>  157030 </td></tr><tr><td>  2011年 </td><td>  60724 </td></tr><tr><td>  2012年 </td><td>  42387 </td></tr><tr><td>  2013年 </td><td>  12148 <br><br></td></tr><tr><td>  2014年 </td><td>  141021 <br><br></td></tr><tr><td>  2015年 </td><td>  46143 <br><br></td></tr><tr><td>  2016年 </td><td>  410385 <br><br></td></tr><tr><td>  2017年 </td><td>  324279 <br><br></td></tr><tr><td>  2018年 </td><td>  581961 <br><br></td></tr></tbody></table></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437542/">https://habr.com/ru/post/zh-CN437542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437532/index.html">机器人移动行业终于变得更加现实</a></li>
<li><a href="../zh-CN437534/index.html">如何在空中应用中实施Retentioneering</a></li>
<li><a href="../zh-CN437536/index.html">本周最佳Angular-摘要1（1月18日至1月25日）</a></li>
<li><a href="../zh-CN437538/index.html">神经网络AlphaStar以10−1的比分击败专业人士StarCraft II</a></li>
<li><a href="../zh-CN437540/index.html">如何处理团队冲突</a></li>
<li><a href="../zh-CN437544/index.html">电子书显示器与智能手机和平板电脑有什么区别？</a></li>
<li><a href="../zh-CN437546/index.html">Windows AD域中的Linux机器（使用sssd和krb5）</a></li>
<li><a href="../zh-CN437548/index.html">uBlock Origin不仅会受到Chromium中新API的影响，还会受到其他扩展的影响</a></li>
<li><a href="../zh-CN437550/index.html">周末阅读：10种乙烯基材料-从生产到家庭聆听和护理</a></li>
<li><a href="../zh-CN437552/index.html">游览Promobot的生产。 首席技术官访谈</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>