<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë´ üë©üèø‚Äçüè≠ üë©‚Äçüé® Aventuras em um fluxo separado. Relat√≥rio Yandex üç¢ üë∞ üëéüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como trabalhar com imagens no cliente, mantendo uma interface de usu√°rio suave? O desenvolvedor de interface Pavel Smirnov falou sobre isso com base n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aventuras em um fluxo separado. Relat√≥rio Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453626/"> Como trabalhar com imagens no cliente, mantendo uma interface de usu√°rio suave?  O desenvolvedor de interface Pavel Smirnov falou sobre isso com base na experi√™ncia de desenvolver pesquisa de fotografias no mercado.  No relat√≥rio, voc√™ pode aprender como usar Web Workers e OffscreenCanvas corretamente. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/t_/ku/-u/t_ku-uoatzm936x50sn7rzjab5w.jpeg"></a> <br><br>  - Por meia hora, falaremos sobre aventuras.  Vou falar sobre a minha aventura e realmente espero que meu relat√≥rio o inspire e voc√™ fa√ßa o mesmo em casa. <br><br><a name="habracut"></a>  Primeiro, eu queria falar sobre algumas tecnologias novas ou n√£o muito novas que nossos navegadores nos fornecem e que nos permitem fazer coisas legais.  Mas parece-me que n√£o seria muito divertido, porque todos podem ir ao MDN e ler alguma coisa.  Portanto, vou contar a hist√≥ria de um recurso que fiz com a equipe do Market. <br><br>  Vamos me apresentar novamente primeiro.  Meu nome √© Pasha, sou desenvolvedor de interfaces na equipe do Market. <br><br><img src="https://habrastorage.org/webt/bc/vy/s_/bcvys_xxtyt4hekvl26k-9zdlga.jpeg"><br><br>  Eu trato principalmente de interfaces m√≥veis - pesquisa de mapa, cart√£o de oferta.  Tamb√©m reescrevi o c√≥digo da pilha antiga para a nova e, em seguida, da nova para uma pilha ainda mais nova.  E tento melhorar minhas interfaces.  Aqui vale a pena dizer o que √© uma boa interface. <br><br>  Boas interfaces t√™m caracter√≠sticas diferentes.  Em primeiro lugar, √© conveniente; em segundo lugar, √© bonito; em terceiro lugar, √© acess√≠vel.  Mas uma das caracter√≠sticas que eu quero falar hoje √© a velocidade.  E a velocidade geralmente se manifesta na suavidade de seu trabalho.  Mesmo pequenos frisos podem mudar bastante a experi√™ncia do usu√°rio de nossas interfaces. <br><br><img src="https://habrastorage.org/webt/p-/ww/kw/p-wwkw03iuh5yrgyfc-fjvubma8.jpeg"><br><br>  Vamos seguir para o plano da minha conversa hoje.  Primeiro, falaremos sobre a tarefa que eu fiz: encontrar uma foto no mercado.  Em seguida, mostrarei quais problemas tive que resolver para implementar essa funcionalidade.  Aqui, lembramos um pouco de como seu script funciona no navegador e analisamos as tecnologias que me ajudaram.  Pequeno spoiler: s√£o Web Workers e OffscreenCanvas. <br><br>  Vamos voltar √† tarefa.  Alguns meses atr√°s, Luba, nosso gerente de produtos, se aproximou de mim.  Lyuba lida com os problemas de escolher um produto no mercado.  Agora, temos v√°rias op√ß√µes para encontrar mercadorias.  Uma delas √© inserir algo na barra de pesquisa. <br><br><img src="https://habrastorage.org/webt/ul/m6/tn/ulm6tnl0vt8kdewxzrr1ofgfch0.jpeg"><br><br>  Por exemplo, "compre um iPhone X vermelho em Samara".  E n√≥s vamos encontrar algo.  Ou podemos usar a √°rvore de cat√°logos.  Neste cat√°logo, temos categorias e subcategorias. <br><br>  Mas e se eu quiser encontrar algo no mercado, sem saber como √© chamado, mas ou tenho uma foto dessa coisa ou a vejo na festa de algu√©m? <br><br><img src="https://habrastorage.org/webt/hz/0t/ne/hz0tnecdwmrqd4slxosbd4ghtgs.jpeg"><br><br>  Vou contar um caso real.  Uma vez fui com meus amigos a um caf√©.  Pedimos limonada l√°, voc√™ sabe, em tal jarro, e esse jarro tinha uma coisa t√£o estranha.  Eu at√© guardei uma foto.  Ele foi projetado para que, quando voc√™ derramar limonada em um copo, o gelo n√£o entre nele.  N√≥s pensamos que era uma coisa legal, mas t√≠nhamos opini√µes diferentes sobre como essa coisa era chamada e, em geral, para que ela era destinada.  Portanto, encontramos no Yandex.Pictures. <br><br>  Mas eu pensei - seria legal se eu n√£o apenas pudesse procurar por essa coisa, mas tamb√©m compr√°-la imediatamente, ou pelo menos descobrir o pre√ßo, ler coment√°rios, recursos etc. Nesse momento, nossos sonhos coincidiram com Qualquer, e decidimos fazer essa funcionalidade no mercado. <br><br>  Como √© essa funcionalidade?  Ele permite que o usu√°rio fa√ßa upload de uma foto ou foto; voc√™ pode tirar uma foto imediatamente e envi√°-la ao mercado.  Analisamos esta foto usando as tecnologias de pesquisa Yandex, localizamos um produto e mostramos ao usu√°rio os resultados com esses produtos.  Parece simples, mas se fosse assim t√£o simples, n√£o faria o meu relat√≥rio.  Para garantir que tipo de recurso √© esse, deixe-me mostr√°-lo. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assista √† primeira demonstra√ß√£o</a></i> <br><br>  Eu vou mostrar na produ√ß√£o.  Vamos primeiro fazer upload da mesma coisa que est√°vamos procurando e ver o que acontece. <br><br>  Encontramos alguns produtos e, especificamente, essa coisa.  Essa coisa √© chamada de filtro.  Para encontrar outra coisa, fotografei um livro na mesa de um colega ontem, vamos procur√°-lo.  Aqui est√° um livro desses, talvez algu√©m o tenha lido.  √â chamado "C√≥digo Perfeito".  Ele tamb√©m o encontra de alguma forma, e por algum motivo com um limite de 18 anos ou mais.  Provavelmente isso √© um pouco estranho. <br><br>  Vamos voltar ao nosso relat√≥rio.  Que problemas eu encontrei?  O primeiro problema √© que o usu√°rio come√ßa a baixar qualquer coisa, incluindo imagens enormes.  Por exemplo, meu telefone tira fotos de tr√™s a quatro megabytes, o que √© bastante.  Enviar essas fotos para o back-end √© ineficiente.  Leva muito tempo, leva muito tempo para analis√°-los, ent√£o voc√™ precisa fazer algo sobre isso.  Mas aqui tudo √© simples - vamos cortar, compactar, redimensionar esta foto no cliente. <br><br><img src="https://habrastorage.org/webt/gs/qm/fo/gsqmfoelkfhdlcmhijbrpl1u3b8.jpeg"><br><br>  Como vamos fazer isso?  N√≥s temos um arquivo.  E, de alguma forma, vamos ler este arquivo.  Leremos usando a API FileReader.  Vou dizer brevemente o que √©. <br><br><img src="https://habrastorage.org/webt/ii/c0/ip/iic0ipw8vjdg5mpre0x6yw3ye_q.jpeg"><br><br>  Essa √© uma API do navegador que nos permite ler o arquivo baixado e fazer algo com ele.  Voc√™ pode ler de diferentes maneiras, veremos agora.  Aqui est√£o seus recursos, e temos algum tipo de objeto que nos retornou da entrada pelo evento de mudan√ßa.  Vamos tentar ler. <br><br><img src="https://habrastorage.org/webt/dd/t6/ya/ddt6yaay0twlpecj1rkwxhzob1w.jpeg"><br><br>  O c√≥digo ficar√° assim.  N√£o h√° nada complicado aqui ainda.  Temos um objeto Reader criado a partir do construtor FileReader, no qual travamos o desenvolvedor do evento load.  Em seguida, leremos esse arquivo como DataURL.  DataURL - uma sequ√™ncia que representa o conte√∫do do arquivo codificado atrav√©s do Base64.  Como lemos, precisamos cort√°-lo de alguma forma.  Primeiro, vamos carregar tudo em uma imagem.  Temos um elemento tag ou img e o carregamos ali mesmo. <br><br><img src="https://habrastorage.org/webt/38/fo/oe/38fooeukiuqzgzmprkjqvpelgfw.jpeg"><br><br>  O c√≥digo ser√° algo parecido com isto.  Criamos um elemento img, pelo evento load Reader, carregamos nossa linha no atributo src e faremos tudo mais quando nossa linha terminar de carregar no img. <br><br>  Faremos o que quisemos - cortar a imagem.  Vamos compact√°-lo e, aqui, o Canvas nos ajudar√°, uma ferramenta muito poderosa.  Ele permite que voc√™ fa√ßa muito.  Mas aqui apenas desenhamos nossa imagem nesta tela e, se o tamanho da imagem exceder o m√°ximo permitido, vamos ajust√°-los um pouco.  Al√©m disso, podemos capturar esta imagem com o Canvas da taxa de compress√£o desejada. <br><br><img src="https://habrastorage.org/webt/if/zs/ny/ifzsnym6-fi7xyx8evc-_dvv4ni.jpeg"><br><br>  Algo assim.  Outro pequeno aviso: o c√≥digo aqui √© bastante simplificado, n√£o especifico tudo.  Temos manipula√ß√£o de erros e outras coisas, mas para que tudo caiba no slide e fique claro no relat√≥rio, omiti alguns detalhes. <br><br>  Temos tamanhos de imagem, apenas olhamos para eles.  Existem algumas constantes permitidas para n√≥s.  Se os tamanhos das figuras excederem nossas constantes, apenas as recortamos sob elas e ajustamos nossa tela para os mesmos tamanhos. <br><br>  A seguir, desenharemos nossa imagem nesta tela. <br><br><img src="https://habrastorage.org/webt/3n/c1/gr/3nc1gr71oyygkviglnhv9hwfzeg.jpeg"><br><br>  Pegue o contexto 2D, precisamos de uma imagem 2D e tente desenhar usando o m√©todo drawImage.  DrawImage √© um m√©todo interessante que aceita, se n√£o me engano, nove par√¢metros.  Mas eles n√£o s√£o todos obrigat√≥rios, usaremos apenas cinco.  Tomamos Image e esses dois zeros, isso √© deslocamento ou recuo da imagem.  Precisamos do ponto superior esquerdo.  Desenhe com as dimens√µes que precisamos. <br><br>  Al√©m disso, a partir deste Canvas, pegaremos nossa string Base64 codificada em DataURL exatamente da mesma maneira e a transformaremos em blob - um objeto especial que √© conveniente enviar ao servidor.  Parece ser tudo.  Tudo funciona.  A imagem √© cortada, a imagem √© enviada, a imagem √© reconhecida. <br><br>  Mas ent√£o eu comecei a perceber algo.  Quando testei esta solu√ß√£o, quando carreguei uma imagem, especialmente em dispositivos fracos, minha interface ficou um pouco mais lenta.  O bot√£o n√£o foi pressionado e o elemento n√£o foi rolado.  Voc√™ sentiu que seu c√≥digo funciona em 99% dos casos e funciona bem, mas √†s vezes simplesmente n√£o funciona?  E voc√™ pode test√°-lo e provavelmente ningu√©m notar√°.  E os usu√°rios, provavelmente, n√£o notar√£o, especialmente em dispositivos fracos. <br><br>  Isso nunca aconteceu comigo, e eu decidi consertar.  Isso acabou sendo um problema.  Se a imagem √© grande, durante as manipula√ß√µes com corte, compacta√ß√£o, levou algum tempo e, nesse pequeno e pequeno tempo, nossa interface n√£o respondeu. <br><br>  No come√ßo, descobri por que isso est√° acontecendo.  Aqui, vale a pena lembrar um pouco como o JavaScript funciona no navegador.  N√£o vou entrar em detalhes, este √© um t√≥pico para um grande relat√≥rio.  Apenas lembre-se de alguns pontos. <br><br><img src="https://habrastorage.org/webt/rx/bq/-n/rxbq-nzhacdcemzt89xme0h331w.jpeg"><br><br>  Temos o JavaScript em execu√ß√£o em um √∫nico segmento, vamos cham√°-lo de principal.  E temos algo no navegador como um loop de eventos.  Aqui dizemos imediatamente que este √© um modelo.  Em alguns navegadores, o loop de eventos √© organizado de maneira diferente, mas, como o nome indica, geralmente √© um loop.  Ele processa determinadas tarefas na fila em ordem. <br><br>  Um momento desagrad√°vel: at√© que ele processe uma tarefa, ele n√£o passar√° para a pr√≥xima.  Vou mostrar a demo que vi, ela mostra.  Ela √© um cl√°ssico. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assista √† segunda demo</a></i> <br><br>  Eu tenho uma imagem GIF e anima√ß√£o CSS executada de diferentes maneiras: uma usando o translatex, a outra usando a posi√ß√£o: relativa √† esquerda, a terceira usando o JavaScript, a saber requestAnimationFrame.  √â aqui que o ouri√ßo est√° girando.  O que eu farei? <br><br>  Vou bloquear o segmento principal por cinco segundos.  Voc√™ sabe, geralmente os caras dur√µes calculam o en√©simo n√∫mero de Fibonacci, mas escrevi um loop sem fim com uma pausa em cinco segundos. <br><br>  O que vai acontecer?  Voc√™ notou imediatamente que o ouri√ßo parou de girar e o gato inferior, que √© animado usando o translatex, tamb√©m parou de andar.  Mas vamos ver a mesma demonstra√ß√£o em outro navegador, por exemplo, Safari.  O gato GIF parou de correr. <br><br>  Por que estou mostrando tudo isso?  Em primeiro lugar, os navegadores s√£o diferentes, voc√™ deve considerar isso.  Em segundo lugar, quando nosso fluxo √© bloqueado por algo, algumas coisas param de funcionar.  Por exemplo - anima√ß√£o JavaScript.  Ou vamos mostrar que o texto n√£o se destacar√° mais, que os bot√µes n√£o ser√£o mais pressionados. <br><br>  Este √© um exemplo muito abstrato.  N√£o vamos bloquear o fluxo por cinco segundos, mas assuma nossa tarefa, fa√ßa upload de uma foto, corte-a, aperte-a e desenhe-a aqui.  N√£o o enviaremos a lugar algum, n√£o ser√° muito revelador. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assista √† terceira demonstra√ß√£o</a></i> <br><br>  Eu tenho um poderoso MacBook aqui e, para tornar tudo mais convincente, desaceleraremos o processador em seis vezes.  Isso permite que voc√™ fa√ßa o DevTools.  Envie nossa foto.  O C√≥digo Perfeito nos ajudar√° novamente.  Como vemos, o mesmo acontece com o bloqueio do thread principal. <br><br>  Vamos voltar √† nossa tarefa e pensar em como vamos lidar com isso. <br><br><img src="https://habrastorage.org/webt/us/bk/y1/usbky1tcsqcmijlpm7yvhzqejxu.jpeg"><br><br>  A prop√≥sito, se voc√™ olhar para o criador de perfil, veremos isso.  No quadro vermelho est√° o nosso microtask, que bloqueia o segmento principal.  Vemos que ele bloqueia por quase cinco segundos.  Est√° em um computador bastante poderoso e, em dispositivos mais fracos, ser√° ainda mais percept√≠vel. <br><br>  Vamos para a solu√ß√£o.  Direi imediatamente o que usei e o que fiz e depois analisaremos todas essas coisas.  Primeiro, usei Web Workers.  Eles nos permitem colocar algumas tarefas em um thread separado.  E segundo, no contexto de Web Workers, o DOM n√£o est√° dispon√≠vel para n√≥s.  Para lidar com essa situa√ß√£o, usaremos outras ferramentas.  A imagem n√£o estar√° dispon√≠vel para n√≥s, o Canvas cl√°ssico est√° dispon√≠vel e, portanto, usamos o Canvas e alguns outros truques. <br><br><img src="https://habrastorage.org/webt/fy/vw/f1/fyvwf1psmu5-m4szo28ffv7qykm.jpeg"><br><br>  Vamos rapidamente lembrar o que s√£o os Trabalhadores, para que servem.  Eles permitem que voc√™ execute o JavaScript em um thread separado, n√£o principalmente.  E o fluxo de Trabalhadores n√£o interfere no fluxo de renderiza√ß√£o da interface principal.  Portanto, podemos executar algumas tarefas computacionais complexas sem diminuir a velocidade da nossa interface. <br><br>  Temos uma ferramenta que permite transferir algo para os trabalhadores e devolver algo dos trabalhadores.  Vamos ver um exemplo. <br><br><img src="https://habrastorage.org/webt/tl/3n/gt/tl3ngt03saazi4u4c-jrw2qpsjs.jpeg"><br><br>  Ent√£o criamos nosso Worker usando o construtor.  L√° voc√™ precisa transferir o caminho para o arquivo.  Podemos at√© passar blob.  E n√≥s temos um manipulador de eventos de mensagem.  Nesse caso, ele simplesmente exibir√° algo na tela.  Em seguida, podemos enviar alguns dados para o nosso trabalhador. <br><br><img src="https://habrastorage.org/webt/dz/d4/zq/dzd4zq9kr9xsjub1pznwor1m0cy.jpeg"><br><br>  Qual √© o suporte?  Tudo est√° bem aqui.  Trabalhadores √© uma ferramenta bem conhecida, n√£o nova, mas muitos dos meus amigos pensam que nem sempre s√£o suportados.  Isto n√£o √© verdade. <br><br><img src="https://habrastorage.org/webt/qq/0p/iq/qq0piq8knelh8flsttmdu3nvmxc.jpeg"><br><br>  Agora vamos dar uma olhada em OffscreenCanvas.  Como j√° vimos, o Canvas √© uma ferramenta muito poderosa, mas, infelizmente, n√£o est√° dispon√≠vel para n√≥s no contexto de Web Workers, portanto, usaremos uma alternativa.  Essa √© uma coisa relativamente nova chamada OffscreenCanvas.  Ele permite que voc√™ fa√ßa as mesmas coisas que o Canvas, apenas fora da tela, ou seja, no contexto de Web Workers.  Obviamente, podemos fazer isso tamb√©m no contexto da janela, mas agora n√£o o faremos. <br><br><img src="https://habrastorage.org/webt/g4/26/zz/g426zzs7plg7015gze3pivfyedc.jpeg"><br><br>  O que h√° com suporte?  Como voc√™ pode ver, h√° muito vermelho.  Normalmente, o OffscreenCanvas √© suportado apenas no Chrome.  Tamb√©m existe uma op√ß√£o no Firefox, mas at√© agora existe uma flag e o Canvas funciona apenas com o contexto WebGL.  Aqui voc√™ pode perguntar - por que estou falando de algo t√£o legal como o OffscreenCanvas, que n√£o funciona em nenhum lugar? <br><br><img src="https://habrastorage.org/webt/ut/pg/po/utpgpozecg0ufn847t-jpfuleqe.jpeg"><br><br>  Uma pequena digress√£o.  Temos alguns n√≠veis de suporte ao navegador no mercado.  E n√≥s temos duas quantidades.  Um valor caracteriza o navegador, ao qual n√£o oferecemos suporte.  Isso representa cerca de metade da porcentagem de popularidade do navegador. <br><br>  E h√° uma segunda quantidade.  Inclui os navegadores que suportamos, mas apenas funcionalidades cr√≠ticas.  Aqui, sem Trabalhadores, toda a funcionalidade de pesquisa funciona, mas com pequenos frisos.  Eu acho que est√° tudo bem, e nossa equipe acredita que est√° tudo bem.  Vamos ver como vamos implementar isso. <br><br><img src="https://habrastorage.org/webt/eo/p7/0l/eop70llp8tzton82fokyhi9c17e.jpeg"><br><br>  Aqui est√° um diagrama do que faremos.  Temos at√© arquivos que leremos atrav√©s do FileReader.  Por√©m, no fluxo principal, o enviaremos aos Web Workers, onde ser√° cortado, compactado e retornar√° para n√≥s, e j√° o enviaremos ao servidor. <br><br><img src="https://habrastorage.org/webt/uq/zx/x_/uqzxx_ifbctkux0m1o1ogw5pauu.jpeg"><br><br>  Vamos ver o c√≥digo para o nosso Worker.  Primeiro, criamos uma inst√¢ncia OffscreenCanvas com a largura e altura que precisamos. <br><br>  Al√©m disso, como eu disse, o elemento Image n√£o est√° dispon√≠vel para n√≥s no contexto Workers, ent√£o aqui usamos o m√©todo createImageBitmap, que nos tornar√° a estrutura de dados que caracteriza nossa imagem. <br><br>  Do interessante: vemos aqui o eu.  Aqueles que n√£o est√£o familiarizados com os Trabalhadores da Web, isso aponta para o contexto de execu√ß√£o.  N√£o importa para n√≥s aqui, janela ou isso, usamos a n√≥s mesmos.  Este m√©todo √© ass√≠ncrono, usei aqui a espera por compacidade e conveni√™ncia, por que n√£o? <br><br>  Em seguida, obtemos a mesma imagem e fazemos a mesma coisa que fizemos antes.  Desenhe na tela e retorne. <br><br>  Do simples.  Costum√°vamos pegar o DataURL e converter tudo em blob.  Mas aqui o m√©todo convertToBlob est√° imediatamente dispon√≠vel para n√≥s.  Por que n√£o o usei antes?  Porque o apoio foi pior.  Mas desde que percorremos todo o caminho at√© aqui e usamos o OffscreenCanvas, o que nos impede de usar o convertToBlob? <br><br><img src="https://habrastorage.org/webt/a2/c-/bs/a2c-bssaaa8knh26p10fdta__zc.jpeg"><br><br>  Retornaremos esse blob basicamente um fluxo, de onde o enviaremos ao servidor.  Ou, como nas demos, desenhe-o. <br><br>  Ent√£o, criamos um Worker no thread principal, ouvimos algumas mensagens dele e vamos desenhar ou enviar para o servidor.  N√£o h√° nada importante aqui.  O trabalhador aceitar√° nossos arquivos. <br><br>  Vamos voltar √† nossa demonstra√ß√£o. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assista √† quarta demo</a></i> <br><br>  A mesma demonstra√ß√£o, os mesmos tr√™s gatos e um porco-espinho.  Vou ativar a regulagem novamente, diminuindo a velocidade do processador seis vezes.  Vou fazer upload da mesma foto.  Como vemos, no momento em que a imagem foi desenhada, as anima√ß√µes n√£o pararam, o ouri√ßo continuou a girar, a interface permaneceu e conseguimos o que quer√≠amos. <br><br>  Mas essa decis√£o pode ser melhorada? <br><br><img src="https://habrastorage.org/webt/sc/jo/x0/scjox0apap-ojlx03_gfvauava8.jpeg"><br><br>  Aqui, a prop√≥sito, o criador de perfil.  Aqui n√£o vemos os enormes microtasks pelos cinco segundos que vimos antes. <br><br>  Melhoria √© poss√≠vel.  Usando objetos transfer√≠veis.  Aqui vale a pena voltar novamente.  Quando passamos nosso DataURL ou blob atrav√©s do mecanismo postMessage, copiamos esses dados.  Provavelmente isso n√£o √© muito eficaz.  Seria legal evit√°-lo.  Portanto, temos um mecanismo que permite transferir dados para Web Workers como se estivessem em um pacote. <br><br>  Por que digo "curtir"?  Quando transferimos esses dados para os Trabalhadores, perdemos o controle sobre eles no fluxo principal - n√£o podemos interagir com eles de nenhuma maneira.  H√° uma segunda limita√ß√£o aqui.  N√£o podemos transferir todos os tipos de dados para Web Workers.  N√£o podemos fazer isso com uma string; faremos de maneira diferente. <br><br><img src="https://habrastorage.org/webt/7s/ai/ml/7saimltvcz1_i2iwgxbfeoyqaxq.jpeg"><br><br>  Vamos dar uma olhada no c√≥digo.  Em primeiro lugar, transmitimos dados de maneira um pouco diferente.  Aqui est√° o nosso postMessage.  Veja bem, existe uma matriz com loadEvent.target.result.  Essa interface nos permite transferir nossos dados como objetos transfer√≠veis, perdendo o controle sobre eles. <br><br>  A prop√≥sito, quem escreve em Rust provavelmente ouvir√° algo familiar.  E leremos nosso arquivo n√£o como uma string, mas como um ArrayBuffer.  Este √© um fluxo de dados bin√°rios do Lidar aos quais n√£o h√° acesso direto.  Portanto, teremos que fazer outra coisa com eles. <br><br><img src="https://habrastorage.org/webt/5j/o6/t8/5jo6t8mnnnnlquvzvnsnluqs__4.jpeg"><br><br>  Voltar para os nossos ImageWorkers.  Aqui ficou muito mais interessante.  Primeiro, pegamos nosso buffer e fazemos uma coisa terr√≠vel como Uint8ClampedArray.  Esta √© uma matriz digitada.  Como o nome indica, os dados s√£o os n√∫meros dos sinais, ou seja, n√∫meros de zero a 255 que representar√£o o pixel da nossa imagem. <br><br>  O terceiro argumento, passamos por uma coisa t√£o estranha, como a largura, multiplicada pela altura, multiplicada por quatro.  Por que exatamente quatro?  Exatamente, RGBA.  Existem tr√™s valores por cor e um por canal alfa. <br><br>  A seguir, criaremos o ImageData a partir dessa matriz, um tipo de dados especial que pode ser facilmente desenhado na tela.  Nada interessante aqui.  N√≥s apenas pegamos um array e passamos para o construtor.  Al√©m disso, da mesma maneira, desenhamos nossa imagem na tela, mas usando um m√©todo diferente, em ImageData.  Al√©m disso, tudo √© o mesmo de antes. <br><br>  Vamos passar para as conclus√µes.  Hoje falei sobre uma tarefa que n√£o realizava h√° muito tempo.  O que eu notei nele? <br><br><img src="https://habrastorage.org/webt/0l/ay/mp/0laympqckrdgl8mbdfc7zozrgfa.jpeg"><br><br>  A suavidade da interface √© muito importante.  Quando o usu√°rio fica um pouco atrasado, congela um pouco, o bot√£o n√£o √© pressionado, isso pode levar a uma forte deteriora√ß√£o do UX.  Navegadores funcionam de maneira diferente.  Vimos um exemplo esf√©rico com o Safari e o Yandex.Browser.  Vimos que, se voc√™ verificou a suavidade de sua interface em um navegador, deveria olhar para os outros. <br><br>  Voc√™ precisa fazer algo com o bloqueio de scripts se eles continuarem por um longo tempo.  No meu caso, eu coloquei na Web Workers.  Mas provavelmente existem outras abordagens, voc√™ pode de alguma forma dividi-las em outras menores, aqui voc√™ tem que pensar.            ,  Web Workers,        . <br><br>   ?        .   .     .    ,      200     ,       . <br><br>     Web Workers  .   ,   ,         . <br><br>    : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">How Browsers Work: Behind the scenes of modern web browsers</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> WebGL/Three.js   OffscreenCanvas  -</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OffscreenCanvas ‚Äî Speed up Your Canvas Operations with a Web Worker</a> </li></ul><br>  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453626/">https://habr.com/ru/post/pt453626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453612/index.html">Futebol nas nuvens - moda ou uma necessidade?</a></li>
<li><a href="../pt453614/index.html">Reposit√≥rio local (offline) do npm</a></li>
<li><a href="../pt453616/index.html">O que h√° de errado com a lei federal ‚ÄúSobre assinaturas eletr√¥nicas‚Äù (63-FZ) e como corrigi-la</a></li>
<li><a href="../pt453618/index.html">Como trabalhamos com id√©ias e como nasceu a LANBIX</a></li>
<li><a href="../pt453622/index.html">Programador de chips G-Shield: escrevendo certificados digitais para chips na fase de produ√ß√£o</a></li>
<li><a href="../pt453628/index.html">Quanto voc√™ pagar√° em 20 anos?</a></li>
<li><a href="../pt453634/index.html">Escola de An√°lise de Sistemas do Banco Alfa</a></li>
<li><a href="../pt453642/index.html">Analisador inteligente para um n√∫mero escrito em palavras</a></li>
<li><a href="../pt453644/index.html">Entrevista - 10 perguntas sobre Swift. Parte 3</a></li>
<li><a href="../pt453646/index.html">Normaliza√ß√£o de dados em banco de dados distribu√≠do, microsservi√ßos e ERP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>