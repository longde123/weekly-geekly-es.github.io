<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüëß üí™üèº üö∞ Recursos de renderiza√ß√£o no Metro: Exodus c raytracing üï∞Ô∏è üöó üôÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pref√°cio 
 Ap√≥s o lan√ßamento do √∫ltimo jogo da s√©rie Metro, passei v√°rias horas estudando seu trabalho interno e decidi compartilhar algo que poderia ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Recursos de renderiza√ß√£o no Metro: Exodus c raytracing</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447194/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6c/122/9f2/b6c1229f21aaaefc416b180a41759690.jpg" alt="imagem"></div><br><h3>  Pref√°cio </h3><br>  Ap√≥s o lan√ßamento do √∫ltimo jogo da s√©rie Metro, passei v√°rias horas estudando seu trabalho interno e decidi compartilhar algo que poderia parecer interessante do ponto de vista tecnol√≥gico.  N√£o conduzirei uma an√°lise detalhada nem estudarei o c√≥digo desmontado dos shaders, mas mostrarei as decis√µes de alto n√≠vel tomadas pelos desenvolvedores no processo de cria√ß√£o do jogo. <br><br>  No momento, os desenvolvedores ainda n√£o falaram sobre as t√©cnicas de renderiza√ß√£o usadas no jogo.  A √∫nica fonte oficial de informa√ß√£o √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noreferrer noopener">relat√≥rio</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="noreferrer noopener">GDC</a> , que n√£o pode ser encontrado em nenhum outro lugar da Internet.  E isso √© irritante, porque o jogo roda em um mecanismo propriet√°rio muito interessante que evoluiu dos jogos anteriores da s√©rie Metro.  Este √© um dos primeiros jogos a usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DXR</a> . <br><br>  Nota: este artigo n√£o √© uma descri√ß√£o completa e voltarei a ele se encontrar algo que valha a pena adicionar.  Talvez eu tenha perdido alguma coisa, porque alguns aspectos aparecem apenas nas pr√≥ximas etapas do jogo, ou apenas olhei para os detalhes. <br><br><h3>  Primeiros passos </h3><br>  Levei v√°rios dias para encontrar um ambiente capaz de trabalhar com este jogo.  Depois de testar v√°rias vers√µes do RenderDoc e PIX, decidi estudar os resultados do tra√ßado de raios usando a Nvidia NSight.  Eu queria aprender renderiza√ß√£o sem raytracing, mas o NSight tamb√©m me permitiu explorar os detalhes desse recurso, ent√£o decidi deix√°-lo ativado.  No restante da renderiza√ß√£o, o PIX √© um bom ajuste.  As capturas de tela foram tiradas usando os dois aplicativos. <br><a name="habracut"></a><br>  O NSight tem uma desvantagem - ele n√£o suporta salvar a captura em um arquivo, portanto n√£o pude retornar aos quadros que estava estudando. <br><br>  No come√ßo do meu trabalho, tamb√©m encontrei outro problema que n√£o tinha nada a ver com aplicativos de depura√ß√£o de quadros: as fun√ß√µes de rastreamento de raios exigiam a instala√ß√£o da atualiza√ß√£o mais recente do Windows, mas o jogo permitia que elas fossem inclu√≠das nas op√ß√µes sem instalar a atualiza√ß√£o.  Nesse caso, a inclus√£o de fun√ß√µes causou o travamento do jogo na inicializa√ß√£o.  A GeForce Experience tamb√©m n√£o disse nada sobre a necessidade da vers√£o correta do Windows para ativar esses recursos.  Esse problema precisa ser resolvido nos dois lados. <br><br>  Por uma quest√£o de completude, fiz capturas de um jogo rodando com o m√°ximo de par√¢metros poss√≠veis, mas sem DLSS. <br><br><h3>  An√°lise de quadros </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/541/f12/e34/541f12e34559d73faa7eb743915e5cdd.png"></div><br>  <i>Moldura acabada</i> <br><br>  Uma breve an√°lise da renderiza√ß√£o demonstra um conjunto bastante padr√£o de fun√ß√µes, com exce√ß√£o da ilumina√ß√£o global realizada pelo tra√ßado de raios (GI tra√ßado por raios). <br><br>  Antes de renderizar a imagem, a escala do quadro anterior √© reduzida na fila de computa√ß√£o e o brilho m√©dio √© calculado. <br><br>  A fila gr√°fica come√ßa com a renderiza√ß√£o de part√≠culas de distor√ß√£o (got√≠culas na c√¢mera), que s√£o aplicadas no est√°gio de p√≥s-processamento.  Ent√£o, uma r√°pida passagem preliminar das profundidades cria uma parte das profundidades em frente ao Gbuffer;  parece que s√≥ d√° um al√≠vio. <br><br>  O passe GBuffer preenche 4 destinos de renderiza√ß√£o de acordo com o diagrama abaixo e tamb√©m conclui o preenchimento do buffer de profundidade. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a67/9ef/332/a679ef3320584af81cc4d3c6970fecd1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97b/c7d/d77/97bc7dd7753e655aec4a8279851e78be.png"></div><br>  <i>1. Alvo no formato RGBA8 com albedo e, possivelmente, Oclus√£o Ambiental no canal alfa;</i>  <i>Em algumas superf√≠cies, parece muito escuro.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ff/a5f/972/8ffa5f972989ecb5104c92cf1e56ddc0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/580/93a/6e158093ac061f9c993fc5d954d3a383.png"></div><br>  <i>2. Alvo no formato RGB10A2 com normais e, possivelmente, uma m√°scara de dispers√£o de subsuperf√≠cie no canal alfa.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aed/cab/600/aedcab600ed86cab9d6fff32d005365b.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/7e8/64e/d9e7e864ecc5794d64a9f0923153f673.png"></div><br>  <i>3. Alvo no formato RGBA8 com outros par√¢metros de material, provavelmente metalicidade e rugosidade no canal alfa.</i>  <i>Curiosamente, os canais RGB neste caso cont√™m exatamente os mesmos dados.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/aaf/aa7/2aeaafaa75ea48daa6c9671ef02024e4.png"></div><br>  <i>4. Alvo no formato RG16F com vetores de movimento 2D.</i> <br><br>  Depois que as profundidades s√£o completamente preenchidas, um buffer de profundidade linear √© constru√≠do e sua escala diminui.  Tudo isso √© feito na fila de computa√ß√£o.  Na mesma fila, o buffer √© preenchido com algo semelhante √† ilumina√ß√£o direcional sem usar sombras. <br><br>  Na fila de gr√°ficos, a GPU rastreia os raios da ilumina√ß√£o global, mas falarei mais sobre isso abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/205/368/6b1/2053686b1cb719229dc0ccce1540e5c1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/879/607/0ab/8796070abae27e9695fb82d6f5789375.png"></div><br>  A fila de computa√ß√£o calcula oclus√£o do ambiente, reflex√µes e algo semelhante ao reconhecimento de borda. <br><br>  Na fila gr√°fica, um mapa de sombras de quatro est√°gios √© renderizado em um mapa de profundidade de 32 bits do tamanho 6k * 6k.  Mais sobre isso abaixo.  Ap√≥s a conclus√£o do mapa de sombras direcionadas, a resolu√ß√£o da terceira cascata, por raz√µes desconhecidas, diminui para 768 * 768. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a85/203/3e2/a852033e230487f7be913e94ee87a7fa.png"></div><br>  No meio do processo de renderiza√ß√£o de sombras, h√° um momento curioso: o atlas de impostores √© complementado por alguns objetos antes de renderizar sombras locais da ilumina√ß√£o (sobre quais impostores podem ser encontrados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Os buffers do impostor e os buffers de sombra de ilumina√ß√£o local tamb√©m s√£o texturas de 6k * 6k. <br><br>  Depois que todas as sombras s√£o conclu√≠das, o c√°lculo da ilumina√ß√£o come√ßa.  Essa parte da renderiza√ß√£o √© bastante incompreens√≠vel, porque existem muitas renderiza√ß√µes que executam algumas a√ß√µes misteriosas e, portanto, requerem estudo adicional. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e07/838/016/e078380165142b63cce7e340155e4aef.png"></div><br>  A renderiza√ß√£o da cena termina com objetos iluminados frontalmente (olhos, part√≠culas).  Os efeitos visuais s√£o renderizados em um buffer de meia resolu√ß√£o, ap√≥s o qual s√£o compostos com objetos opacos usando o zoom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d95/88c/66e/d9588c66ecb2dbd09b0386fc481771c1.png"></div><br>  A imagem final √© obtida pela corre√ß√£o de tons e c√°lculo de flora√ß√£o (diminua e aumente a resolu√ß√£o do quadro com corre√ß√£o de tons).  Por fim, a interface do usu√°rio √© renderizada em um buffer separado e, juntamente com a composi√ß√£o de bloom, √© sobreposta na parte superior da cena. <br><br>  N√£o encontrei a parte em que a suaviza√ß√£o √© realizada, ent√£o deixarei para mais tarde. <br><br><h3>  Rastreamento global de raios de luz </h3><br>  Algumas informa√ß√µes sobre a ilumina√ß√£o global realizada pela GI rastreada por raios.  Essa estrutura aceleradora cobre uma grande √°rea do mundo do jogo, provavelmente v√°rias centenas de metros, mantendo detalhes muito altos em todos os lugares.  Parece estar fluindo de alguma forma.  A cena da estrutura de acelera√ß√£o n√£o coincide com a cena rasterizada, por exemplo, os edif√≠cios na imagem abaixo n√£o s√£o vis√≠veis na forma rasterizada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e98/f99/6d9/e98f996d9c2ad589d81fb6c5abac1208.png"></div><br>  <i>Vista superior</i> <br><br>  Aqui podemos ver quatro pe√ßas em torno da posi√ß√£o do jogador.  Tamb√©m √© aparente a falta de geometria sendo testada no canal alfa.  As √°rvores t√™m troncos, mas sem folhagem, sem grama, sem arbustos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/500/53a/089/50053a0898f262725ade46d2b5dadb88.png"></div><br>  <i>Fechar vista</i> <br><br>  Na visualiza√ß√£o em close, os detalhes e a densidade dos objetos s√£o melhor visualizados.  Cada objeto de uma cor diferente tem sua pr√≥pria estrutura aceleradora no n√≠vel inferior.  Somente nesta imagem existem v√°rias centenas deles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83e/5e8/dff/83e5e8dfff1709a0d38b1f4c5d012282.png"></div><br>  <i>Itens do jogador sob os p√©s</i> <br><br>  Curiosamente, os itens do jogador tamb√©m fazem parte da estrutura de acelera√ß√£o, mas por algum motivo est√£o localizados sob seus p√©s. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/969/c2b/203/969c2b203e8abecbd7718e061db99984.png"></div><br>  <i>Esfolamento quebrado?</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/366/620/78d/36662078d0930dfb66fb3bf1d928f022.png"></div><br>  <i>Esfolamento quebrado de novo?</i> <br><br>  Alguns dos objetos esfolados parecem quebrados na estrutura acelerada.  Um dos problemas observados √© esticar a malha (nas pernas da crian√ßa).  Outro problema leva ao fato de que diferentes partes do personagem com esfolamento est√£o em posi√ß√µes diferentes.  N√£o h√° alongamento, mas as partes s√£o separadas uma da outra.  Parece que nada disso √© vis√≠vel na ilumina√ß√£o global de rastreamento de raios, ou pelo menos n√£o consegui perceber isso no jogo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/647/c7c/c2b/647c7cc2beab467af7223ed97f80fa08.png"></div><br>  <i>Um grande n√∫mero de objetos</i> <br><br>  Em um plano mais geral, voc√™ pode ver quantos objetos diferentes existem na estrutura de acelera√ß√£o.  A maioria deles n√£o contribuir√° realmente para os resultados dos c√°lculos da ilumina√ß√£o global.  Tamb√©m √© visto aqui que n√£o h√° esquema LOD.  Todos os objetos s√£o adicionados com todos os detalhes.  Seria interessante saber se isso tem algum efeito no tra√ßado de raios (eu diria que sim). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/11b/0ec/64f11b0ec3d0882a84503875c5a1cb20.png"></div><br>  <i>LOD ultra-alto, cada escala e switch totalmente modelados</i> <br><br>  Outra captura de tela mostra um enorme detalhe de objetos, mesmo longe do player.  Cada interruptor e cada escala nesta imagem s√£o claramente leg√≠veis, mesmo sem texturas.  O local em que movi a c√¢mera para tirar essa captura de tela est√° localizado a dezenas de metros do player e a elimina√ß√£o desses detalhes n√£o teria piorado a qualidade da imagem.  Talvez a atualiza√ß√£o da estrutura de acelera√ß√£o usando LOD fosse muito cara, mas h√° uma alta probabilidade de que essa atualiza√ß√£o possa ser executada de forma ass√≠ncrona.  Definitivamente vale a pena explorar esse ponto com mais detalhes. <br><br><h3>  Renderiza√ß√£o de sombras direcionais </h3><br>  A parte principal da renderiza√ß√£o de sombras √© simples e n√£o requer men√ß√£o especial, mas h√° pontos interessantes aqui. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/016/0ea/d160160ea9d4dc571c97440f77d103a0.png"></div><br>  <i>Malhas para as quais √© improv√°vel a proje√ß√£o de sombras</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/369/857/cb1/369857cb17bf6baeaae52295930b4ac5.png"></div><br>  <i>Enorme detalhe nos mapas de sombras</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e0/708/9ba/0e07089ba7b63f9c055a95a8ed783f09.png"></div><br>  <i>Malhas que parecem usar o buffer de √≠ndice incorreto</i> <br><br>  Parece que, como estruturas em acelera√ß√£o, a renderiza√ß√£o de sombra inclui absolutamente tudo.  Existem objetos que quase n√£o contribuem para o mapa de sombras, mas ainda s√£o renderizados.  Gostaria de saber se isso acontece por causa da permiss√£o ou se n√£o h√° uma maneira f√°cil no mecanismo de exclu√≠-los? <br><br>  Existem objetos que s√£o dif√≠ceis de perceber, mesmo com sombras no espa√ßo da tela.  N√£o demora muito para renderiz√°-los, mas seria interessante ver se eles podem ser removidos para economizar um pouco de tempo. <br><br>  Ao estudar a malha, parece que algumas das malhas renderizadas no mapa de sombra t√™m buffers de √≠ndice quebrados, mas ap√≥s o shader de v√©rtice, eles parecem corretos (os resultados s√£o os mesmos no PIX e no NSight).  Este √© o melhor exemplo que consegui encontrar, mas est√° longe de ser o √∫nico.  Talvez este seja algum tipo de posi√ß√£o de embalagem especial? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/079/80b/5d907980beab8411086ae95a3cd1069e.png"></div><br>  <i>As malhas parecem ter pouca apar√™ncia</i> <br><br>  Esfolar parece estar causando problemas n√£o apenas na acelera√ß√£o de estruturas.  Curiosamente, isso n√£o leva a artefatos vis√≠veis na tela. <br><br><h2>  Parte 2 </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png" alt="imagem"></div><br><h3>  Altera√ß√£o menor </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/177/37b/efe17737bab902e3b3d1e4ae2a29edbf.png"></div><br>  Na parte anterior, escrevi que o terceiro alvo de renderiza√ß√£o do buffer GBuffer provavelmente cont√©m metalidade, mas parece que ele realmente cont√©m cores especulares.  No come√ßo, n√£o vi nenhuma cor e n√£o entendi por que os tr√™s canais RGB cont√™m os mesmos dados, mas provavelmente porque n√£o havia reflexos de cores na cena.  Para esta arma, o buffer cont√©m muito mais cores diferentes. <br><br>  Tamb√©m esqueci de adicionar minha textura favorita, que encontrei no processo de pesquisar a renderiza√ß√£o do jogo.  Definitivamente, vale a pena mencionar, porque demonstra a natureza ca√≥tica do desenvolvimento de jogos quando nem sempre √© poss√≠vel limp√°-lo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bb/5b4/288/7bb5b428878a0be20dbe80d599256d80.png"></div><br>  <i>"Melhore-me!"</i> <br><br><h3>  Composi√ß√£o de transpar√™ncia e anti-aliasing </h3><br>  Tentando descobrir como a resolu√ß√£o do buffer de transpar√™ncia de meio tamanho aumenta e como o jogo executa o antialiasing, notei algo interessante.  Eu precisava de uma cena em que houvesse muito mais contraste para que fosse claramente vis√≠vel o que estava acontecendo.  Felizmente, consegui capturar um quadro no qual a arma do jogador se move levemente entre os quadros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0c/974/612/a0c9746122e45a19786bdf51521015a9.png"></div><br>  <i>Antes de renderizar transpar√™ncia</i> <br><br>  Parece que antes de compor o buffer de transpar√™ncia, o buffer j√° cont√©m uma imagem totalmente renderizada e, como n√£o h√° arestas n√≠tidas nesse quadro, √© l√≥gico supor que esses s√£o os dados do quadro anterior. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c56/bd5/b89/c56bd5b8938a315f97def63dc7b8b214.png"></div><br>  <i>Ap√≥s compor a transpar√™ncia do quadro atual</i> <br><br>  Ao adicionar transpar√™ncia ao quadro atual, podemos observar arestas quebradas individuais.  Isso aconteceu porque a arma mudou ligeiramente para a direita.  Algumas nuvens s√£o tornadas transparentes, mas s√£o cortadas no horizonte (o que √© opaco), de modo que a composi√ß√£o n√£o altera o fundo, mas j√° √© renderizada sobre a malha da arma do quadro anterior usando o buffer de profundidade do quadro atual. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/7a1/e93/64f7a1e9340dfe180e4807cf7c4da5be.png"></div><br>  <i>Depois de adicionar opacidade ao quadro atual</i> <br><br>  Ap√≥s v√°rias chamadas de empate, s√£o realizadas malhas de composi√ß√£o e opacas.  Parece n√£o haver raz√£o espec√≠fica para fazer isso nesta ordem.  √â l√≥gico compor o buffer de transpar√™ncia nos dados de objetos opacos do quadro atual, mas isso n√£o acontece e seria interessante saber o porqu√™. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/963/bce/f23/963bcef23544573444acf29bf7a83a87.png"></div><br>  <i>Ap√≥s TAA</i> <br><br>  Depois de concluir o quadro completo, o passe do TAA (Suaviza√ß√£o Temporal) suaviza as bordas.  Eu j√° estava interessado nisso antes, porque n√£o via onde a suaviza√ß√£o ocorre.  Mas pulei isso porque imediatamente ap√≥s essa chamada de empate, a amostragem para baixo para o passe de in√≠cio √© iniciada e sinto falta dessa chamada de empate. <br><br><h3>  Reflexo da lente </h3><br>  Normalmente, n√£o quero analisar efeitos individuais, mas h√° muitas maneiras de implementar o reflexo de lente, por isso fiquei curioso sobre quais desenvolvedores escolheram. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png"></div><br>  <i>Alargamento da lente na composi√ß√£o pronta</i> <br><br>  Na maioria dos casos, o reflexo da lente √© quase impercept√≠vel, mas esse √© um efeito bonito.  √â dif√≠cil mostrar na captura de tela, ent√£o n√£o vou me esfor√ßar muito nisso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a32/554/efc/a32554efc67afb79416b6ce2fe337148.png"></div><br>  <i>Reflexo da lente no buffer de bloom</i> <br><br>  Ap√≥s a pesquisa, encontrei uma chamada de desenho que adiciona esse efeito, e acabou sendo uma chamada ap√≥s o √∫ltimo est√°gio de aumento da resolu√ß√£o da flora√ß√£o.  Nesse buffer, o efeito √© muito mais percept√≠vel. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a3/f38/078/8a3f38078dc5d6c6451030ee3eb5c53b.png"></div><br>  <i>Geometry Lens flare</i> <br><br>  Se voc√™ observar a geometria, o reflexo da lente √© bem simples.  Pelo menos 6 quadrados est√£o envolvidos na cria√ß√£o do resultado final na tela, mas n√£o h√° s√©ries de quadrados menores que se aproximem da posi√ß√£o do sol.  Podemos concluir que esta √© uma solu√ß√£o bastante padr√£o, embora alguns desenvolvedores processem o reflexo da lente diretamente na cena do ponto de encontro, enquanto outros calculam o efeito como p√≥s-processamento. <br><br><h3>  Renderiza√ß√£o do terreno </h3><br>  Em todos os jogos de mundo aberto, uma das dificuldades mais interessantes √© renderizar terreno.  Decidi que poderia parecer interessante estudar esse aspecto, mas, francamente, um pouco decepcionado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/125/7a6/89b/1257a689b93f0f7a0239b5514ce911af.png"></div><br>  √Ä primeira vista, um fragmento do relevo parece estar sendo executado algum tipo de mosaico.  A maneira como o relevo √© deformado durante o movimento torna l√≥gico supor que h√° algum deslocamento adicional.  Al√©m disso, em um PC, o jogo usa ativamente o mosaico, por isso seria l√≥gico us√°-lo em relevo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99d/214/a4d/99d214a4dc8c15862b7e385edda0c25e.png"></div><br>  Talvez eu tenha definido os par√¢metros errados, mas o jogo renderiza todos os fragmentos do al√≠vio sem mosaico.  Para cada fragmento do relevo, ela usa essa grade uniforme de 32 * 32.  Tamb√©m n√£o h√° LOD. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/744/aa8/4bc/744aa84bce83c87e8c2a49338f7c8c13.png"></div><br>  Observando um fragmento do relevo ap√≥s o vertex shader, voc√™ pode ver que a maioria dos pares de v√©rtices se fundiram para formar uma grade 16 * 16 quase perfeita, com exce√ß√£o de alguns lugares que exigem mais precis√£o (provavelmente devido √† curvatura do relevo).  A deforma√ß√£o mencionada acima provavelmente ocorre devido √† leitura das texturas mip do mapa de eleva√ß√£o do relevo quando o relevo est√° longe da c√¢mera. <br><br><h3>  Truques de rastreamento de raio </h3><br>  E agora sobre o que todo mundo estava esperando. <br><br><h4>  Streaming de dados </h4><br>  Um dos aspectos mais interessantes de qualquer implementa√ß√£o de DXR no momento √© a maneira como voc√™ trabalha com dados.  O mais importante √© como os dados s√£o carregados nas estruturas em acelera√ß√£o e como s√£o atualizados.  Para testar isso, fiz duas capturas e comparei as estruturas de acelera√ß√£o no NSight. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3fc/7b7/0d2/3fc7b70d22199c5be429417fd6ed92a9.png"></div><br>  <i>O jogador est√° dentro do navio</i> <br><br>  Na primeira captura, eu estava dentro de um navio quebrado, vis√≠vel no meio desta imagem.  Apenas os objetos mais pr√≥ximos s√£o carregados, exceto as grandes rochas na borda do mapa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc4/e41/2fa/dc4e412fa02b74f7ca4384a53e1b8100.png"></div><br>  <i>O player foi para o canto superior esquerdo desta imagem.</i> <br><br>  Na segunda captura, afastei-me da borda do mapa e estava mais perto da borda superior esquerda da imagem.  A nave e tudo ao seu redor ainda est√° carregada, mas novos objetos tamb√©m foram carregados.  Curiosamente, n√£o consigo definir nenhuma estrutura de bloco.  Os objetos podem ser carregados / removidos da estrutura de acelera√ß√£o com base na dist√¢ncia e visibilidade (talvez limitando o paralelogramo?).  Al√©m disso, a borda superior direita parece mais detalhada, embora tenha se afastado dela.  Seria interessante saber mais sobre isso. <br><br><h4>  Al√≠vio e o que est√° por baixo </h4><br>  V√°rios aspectos da implementa√ß√£o do DXR no Metro: Exodus em rela√ß√£o ao terreno podem ser mencionados. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e97/386/8bf/e973868bf7b0bd40cfc58c0d94678acf.png"></div><br>  Em primeiro lugar, √© interessante que as estruturas em acelera√ß√£o n√£o contenham malhas de al√≠vio (com exce√ß√£o de casos especiais).  Esses monstros realmente rodam no jogo no ch√£o, mas, a julgar pelos dados do NSight, voc√™ pode pensar que eles est√£o voando.  Isso nos coloca uma quest√£o interessante: a implementa√ß√£o da ilumina√ß√£o global pode de alguma forma levar em conta o terreno (possivelmente usando um mapa de altura e material de relevo) ou n√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/03e/860/a7a03e8601a37c6459eff55cc7dda39f.png"></div><br>  No momento seguinte, eu nunca teria notado se o al√≠vio estivesse no lugar.  Observando o in√≠cio do n√≠vel na estrutura acelerada do NSight, notei algumas malhas sob o relevo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/458/b77/ec3/458b77ec37a3db2b1d8ca0b3f1694dd8.png"></div><br>  Os artistas frequentemente, por v√°rias raz√µes, colocam malhas de depura√ß√£o abaixo do n√≠vel, mas geralmente s√£o exclu√≠das antes do lan√ßamento do jogo.  Nesse caso, essas malhas n√£o apenas sobreviveram at√© o lan√ßamento, mas tamb√©m se tornaram parte da estrutura de acelera√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/27d/64a/15d/27d64a15df609c55b8742d77637fca22.png"></div><br>  Al√©m dos mencionados acima, encontrei outras malhas espalhadas sob o relevo.  Basicamente, eles n√£o merecem muita men√ß√£o, mas este foi muito interessante - este √© um personagem logo abaixo do ponto de partida do n√≠vel.  Ele ainda tem sua pr√≥pria piscina. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53f/5dd/66c/53f5dd66c2b959793151e3a59d1309a5.png"></div><br>  Finalmente, o √∫ltimo elemento curioso da estrutura de acelera√ß√£o s√£o as malhas unilaterais que olham para fora do n√≠vel.  A menos que sejam considerados bilaterais, h√° muito pouca chance de que eles contribuam para a imagem do jogo.  Mesmo que as malhas sejam de dois lados, elas est√£o t√£o longe da √°rea de jogo que provavelmente apenas esticam a estrutura de acelera√ß√£o.  √â interessante ver que eles n√£o s√£o filtrados.  Esta imagem tamb√©m mostra um dos casos especiais da "malha de al√≠vio" no canto inferior direito, entre o trem e o edif√≠cio. <br><br><h4>  Decapita√ß√£o com esfolamento </h4><br>  Eu j√° falei sobre os problemas de descascar malhas, mas nesse n√≠vel notei outra coisa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d1/0dd/a8c/1d10dda8c75112713b51c32771bb8ecb.png"></div><br>  Em primeiro lugar, esse monstro mostra os dois erros em uma imagem, que notei acima.  Ainda estou imaginando o que os causou. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/523/265/dd7/523265dd72a9613800831592706bd510.png"></div><br>  Tamb√©m notei que essas pequenas criaturas, como morcegos, n√£o t√™m cabe√ßa na estrutura acelerada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fd/1a9/801/6fd1a9801d440a719602ab30eb33a88e.png"></div><br>  Outro exemplo  Observe o buraco onde a cabe√ßa deve estar.  N√£o vi um √∫nico caso em que a cabe√ßa estivesse vis√≠vel. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e7f/51e/741/e7f51e74194bf8cccf8e430e6ec8513d.png"></div><br>  O mesmo tipo de criatura no modo de rasteriza√ß√£o.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Observe que a cabe√ßa est√° claramente vis√≠vel. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebd/d67/2ea/ebdd672ea50f7717c4b66afeb20b4cf8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E aqui est√° a estrutura de arame da cabe√ßa. </font></font><br><br><h3>  Em conclus√£o </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© tudo por hoje. </font><font style="vertical-align: inherit;">Espero que voc√™ tenha gostado desse olhar para o interior do Metro: Exodus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuarei a explorar a renderiza√ß√£o do jogo, mas n√£o publicarei novas partes do artigo, a menos que encontre partes especiais que sejam interessantes para as pessoas ou algo que valha a pena compartilhar.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447194/">https://habr.com/ru/post/pt447194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447182/index.html">Sistemas operacionais: tr√™s pe√ßas f√°ceis. Parte 3: API do processo (tradu√ß√£o)</a></li>
<li><a href="../pt447184/index.html">O que √© a oferta inicial de troca (IEO) e como ela √© diferente da OIC?</a></li>
<li><a href="../pt447186/index.html">Como lan√ßar um prot√≥tipo de ML em um dia. Relat√≥rio Yandex.Taxi</a></li>
<li><a href="../pt447190/index.html">Previs√µes de matem√°ticos. Analisamos os principais m√©todos para detectar anomalias</a></li>
<li><a href="../pt447192/index.html">Que papel a tecnologia pode desempenhar na arte antiga da mistura de especiarias?</a></li>
<li><a href="../pt447196/index.html">7. Introdu√ß√£o ao Ponto de Verifica√ß√£o R80.20. Controle de acesso</a></li>
<li><a href="../pt447198/index.html">Miss√£o lunar "Bereshit": acidente de pouso-queda na lua</a></li>
<li><a href="../pt447204/index.html">17 de abril: Palestra aberta "O caminho do desenvolvedor de jogos: da id√©ia ao lan√ßamento" e uma biblioteca de jogos na Escola Superior de Direito</a></li>
<li><a href="../pt447208/index.html">Dias da SQA - Revis√£o da UE</a></li>
<li><a href="../pt447210/index.html">@Pythonetc compilation Mar√ßo de 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>