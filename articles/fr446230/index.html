<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’ ğŸ› ï¸ ğŸ›ï¸ Surveillance et gestion Ã  distance des pÃ©riphÃ©riques basÃ©s sur Linux / OpenWrt / Lede via le port 80, suite ğŸ‘ ğŸ‘¸ğŸ¿ ğŸ‘¨ğŸ¼â€ğŸ”§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ceci est la derniÃ¨re partie de l'article, voici le dÃ©but . 

 La derniÃ¨re fois que j'ai Ã©crit sur la faÃ§on dont j'ai implÃ©mentÃ© la surveillance des ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance et gestion Ã  distance des pÃ©riphÃ©riques basÃ©s sur Linux / OpenWrt / Lede via le port 80, suite</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446230/">  Ceci est la derniÃ¨re partie de l'article, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici le dÃ©but</a> . <br><br>  La derniÃ¨re fois que j'ai Ã©crit sur la faÃ§on dont j'ai implÃ©mentÃ© la surveillance des appareils, nous allons maintenant nous concentrer sur la gestion.  Dans les discussions avec les "technophiles" de la part du client, je rencontre souvent une perception limitÃ©e des capacitÃ©s de ces petits appareils (avec de faibles ressources mÃ©moire et performances), beaucoup de gens pensent que "le maximum dont nous avons besoin est d'envoyer un redÃ©marrage, pour quelque chose de plus sÃ©rieux - nous enverrons une Ã©quipe" . <br><br>  Mais la pratique montre que ce n'est pas entiÃ¨rement vrai. <br><a name="habracut"></a><br>  Voici une courte liste des tÃ¢ches courantes courantes: <br><br><ol><li>  Diagnostics et dÃ©pannage du rÃ©seau.  DerriÃ¨re le port Ethernet de votre routeur, un autre matÃ©riel a gÃ©nÃ©ralement sa propre adresse IP interne.  Parfois, il peut (avoir besoin) de "ping".  Ou la gestion des tunnels - si un routeur qui ne monte pas soudainement sur un routeur passant par un modem 3G, mais nous voyons le routeur lui-mÃªme. </li><li>  Service systÃ¨me.  Mise Ã  niveau du micrologiciel, mise Ã  niveau du script de service. </li><li>  Acte d'Ã©quilibre.  Cela pourrait Ãªtre appelÃ© "perversions", mais le concept de "balancer" comme, je cite, <i>"la capacitÃ© d'un artiste de cirque Ã  maintenir l'Ã©quilibre dans une position instable du corps"</i> est plus appropriÃ©.  Des situations similaires se produisent en raison du budget limitÃ© du client.  Voici quelques exemples, mais parce que  ils n'ont aucun rapport direct avec le sujet du rÃ©cit, mettez-les dans des notes </li></ol><br><div class="spoiler">  <b class="spoiler_title">Surveillance Wifi</b> <div class="spoiler_text">  Un sujet Ã  la mode au cours des cinq derniÃ¨res annÃ©es concerne principalement les chaÃ®nes de vente au dÃ©tail fÃ©dÃ©rales.  Vous vous promenez lentement Ã  travers les parquets, et votre tÃ©lÃ©phone mobile avec Wi-Fi activÃ©, dans une tentative de Â«collerÂ» Ã  un thread rÃ©seau, envoie rÃ©guliÃ¨rement des paquets de demande de sonde qui peuvent Ãªtre analysÃ©s pour calculer la frÃ©quence Ã  laquelle vous venez dans ce magasin, pour quoi marcher les trajectoires et ainsi de suite.  Ensuite, les donnÃ©es sont collectÃ©es, analysÃ©es, des cartes thermiques sont dessinÃ©es et les gestionnaires pour de telles images "coupent" l'argent de la direction ou des investisseurs.  En attendant .... "il n'y a pas d'argent, mais vous tenez bon ...", et le rÃ©sultat (rÃ©el) doit dÃ©jÃ  Ãªtre montrÃ©, la bonne vieille chanson est incluse "Oui, oui, alors bien sÃ»r nous mettrons tsiska et tout ce que nous voulons, mais maintenant nous avons besoin montrez le rÃ©sultat au client!  Soit dit en passant, ils ont oubliÃ© de dire que le client a permis Ã  notre Ã©quipement d'Ãªtre connectÃ© Ã  son hotspot via le Wi-Fi, mais de maniÃ¨re gÃ©nÃ©rale, c'est comme si nous Ã©tions des clients invitÃ©s. "  Et maintenant, vous devez crÃ©er des routeurs-Ã©quilibreurs - plusieurs sous-interfaces WiFi montent, dont l'une s'accroche Ã  un hotspot, et la seconde surveille l'environnement, dÃ©charge frÃ©nÃ©tiquement le rÃ©sultat de tcpdump en elle-mÃªme, puis le contenu du fichier est compressÃ© dans l'archive et risque de mourir de "suralimentation" essayer de cracher le contenu sur le serveur ftp.  Il n'est pas surprenant que le routeur-Ã©quilibreur "tombe en panne" et doive Ãªtre ressuscitÃ© Ã  distance. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Rayon</b> <div class="spoiler_text">  Ici, il est plus facile de dÃ©crire la situation avec quelque chose comme cette dÃ©claration du client: <i>Â«Nous voulons un rÃ©seau dÃ©centralisÃ© de hotspots qui fonctionnent sur des Ã©quipements dont le modÃ¨le n'est pas connu Ã  l'avance, via des canaux, mais que nous ne connaissons pas encore.</i>  <i>Ah, ils ont oubliÃ© de dire, nous voulons non seulement montrer des publicitÃ©s aux clients, mais aussi analyser tout autour du lieu d'installation du hotspot.</i>  <i>Non, nous ne savons pas encore pourquoi, mais nous arriverons, nâ€™en doutons pas, nous avons pu trouver cette idÃ©e Â»</i> <br></div></div><br>  Et nous ne devons pas oublier qu'en raison de la masse de circonstances incertaines Ã  l'avance, le contrÃ´le doit Ãªtre effectuÃ© dans des conditions non standard, lorsque nous ne pouvons pas nous connecter directement au routeur via ip: le port et sommes obligÃ©s d'attendre simplement une activitÃ© de celui-ci.  Si nous l'ignorons, le dialogue entre le serveur et le routeur peut Ãªtre reprÃ©sentÃ© comme ceci: <br><br><ul><li>  <b>Routeur</b> : salut.  Je suis un tel routeur, y a-t-il des tÃ¢ches pour moi? </li><li>  <b>Serveur</b> : tel ou tel routeur je vous ai enregistrÃ© que vous Ãªtes vivant.  Voici la tÃ¢che: montrez-moi le rÃ©sultat de la commande ifconfig? </li><li>  <b>Routeur</b> : salut.  Je suis un tel routeur, la derniÃ¨re fois que vous m'avez demandÃ© de montrer le rÃ©sultat d'ifconfig, le voici.  Y a-t-il des tÃ¢ches pour moi? </li><li>  <b>Serveur</b> : tel ou tel routeur je vous ai enregistrÃ© que vous Ãªtes vivant.  Il n'y a pas de tÃ¢ches pour vous. </li></ul><br>  La question la plus intÃ©ressante: comment un routeur distant peut-il envoyer une certaine quantitÃ© d'informations?  Dans la derniÃ¨re partie, j'ai dÃ©crit que sur le routeur en raison de ressources limitÃ©es, il n'y a qu'un wget "dÃ©pouillÃ©" qui ne fonctionne que via GET et rien d'autre, il n'y a pas de client ftp ou curl.  Plus prÃ©cisÃ©ment, nous avons besoin d'une mÃ©thode universelle, quelles que soient les caractÃ©ristiques de l'assemblage d'images.  J'ai dÃ©cidÃ© d'utiliser wget.  Plus prÃ©cisÃ©ment, comment j'ai Â«arrÃªtÃ©Â» - je n'avais tout simplement pas le choix :) <br><br><div class="spoiler">  <b class="spoiler_title">RÃ©servation immÃ©diate</b> <div class="spoiler_text">  Ma solution de gestion fonctionne, mais trÃ¨s limitÃ©e et je suis sÃ»re qu'elle est tordue, mÃªme si elle convient Ã  la plupart de mes clients.  Comment il serait possible de le faire judicieusement - d'Ã©crire un petit utilitaire qui envoie des donnÃ©es binaires via le 80e port.  Incluez-le (utilitaire) dans le firmware du routeur et utilisez bash pour y accÃ©der.  Mais la rÃ©alitÃ© est que: a) vous devez rapidement b) peut-Ãªtre que vous devez tout faire sur le "zoo du routeur" existant c) "ne faites pas de mal!"  - si le routeur fonctionne et effectue d'autres tÃ¢ches, essayez d'apporter des modifications qui affecteront les fonctionnalitÃ©s existantes. <br></div></div><br>  Passons Ã  la mise en Å“uvre.  Supposons que votre client veuille de zabbix redÃ©marrer le routeur facilement et naturellement, en un Â«clic de sourisÂ».  Aujourd'hui, nous allons commencer la description de la mise en Å“uvre avec zabbiksa. <br><br>  Dans le menu "Administration" -&gt; "Scripts" ajoutez un nouveau script.  Nous l'appelons Â«RebootÂ», en tant que commande, nous Ã©crivons Â«php /usr/share/zabbix/reboot.php {HOST.HOST}Â» <br><br><img src="https://habrastorage.org/webt/pf/hg/on/pfhgongtotx7njamqfnrnxcqvhg.jpeg"><br><br>  Plus loin: Menu "Surveillance" -&gt; "DonnÃ©es rÃ©centes" -&gt; "Faites un clic droit sur le nÅ“ud du rÃ©seau."  Voici Ã  quoi ressemblera le menu aprÃ¨s l'ajout d'un script. <br><br><img src="https://habrastorage.org/webt/4k/um/go/4kumgoc08rhijg8sz5jq_e1t3z4.jpeg"><br>  En consÃ©quence, nous mettons le script reboot.php dans le rÃ©pertoire / usr / share / zabbix (vous pouvez en avoir un autre, j'utilise le rÃ©pertoire racine zabbixa). <br><br><div class="spoiler">  <b class="spoiler_title">Clause de non-responsabilitÃ© pour la sÃ©curitÃ©</b> <div class="spoiler_text">  Pour plus de clartÃ© dans le script, j'utilise uniquement l'ID du routeur, mais je n'utilise pas le mot de passe.  Dans la version de travail, ce n'est pas recommandÃ©!  Pourquoi ai-je fait cela: parce que la grande question est de savoir oÃ¹ stocker les mots de passe des routeurs?  Dans zabbixe lui-mÃªme dans "l'inventaire"?  Pratique contradictoire.  En option: restreindre l'accÃ¨s externe au fichier reboot.php lui-mÃªme <br></div></div><br>  Fichier Reboot.php <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//      $user = $argv[1]; // .      -   !            . //$password = $argv[2]; $conn=new mysqli("localhost","db_user","db_password","db_name"); if (mysqli_connect_errno()) { exit(); } $conn-&gt;set_charset("utf8"); // ""  reboot     task  users.   task    . $sql_users=$conn-&gt;prepare("UPDATE users SET task='reboot' WHERE id=? AND status='active';"); $sql_users-&gt;bind_param('s', $user); $sql_users-&gt;execute(); $sql_users-&gt;close(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  En fait, tout.  La question Â«comment obtenir le rÃ©sultat de l'exÃ©cution d'une commande du cÃ´tÃ© de l'appareilÂ» reste ouverte.  ConsidÃ©rez le problÃ¨me en utilisant la commande ifconfig comme exemple.  Cette commande peut Ãªtre envoyÃ©e Ã  l'appareil: <br><br><pre> <code class="bash hljs">message=`ifconfig`; wget <span class="hljs-string"><span class="hljs-string">"http://xn--80abgfbdwanb2akugdrd3a2e5gsbj.xn--p1ai/a.php?u=user&amp;p=password!&amp;m=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$message</span></span></span><span class="hljs-string">"</span></span> -O /tmp/out.txt</code> </pre> <br>  oÃ¹: <br>  <i>message = `ifconfig`</i> - nous affectons le rÃ©sultat de la sortie de la commande ifconfig Ã  la variable $ message <br>  <i>wget " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xn - 80abgfbdwanb2akugdrd3a2e5gsbj.xn - p1ai / a.php</a></i> - notre script a.php qui enregistre les routeurs et reÃ§oit des messages d'eux <br>  <i>u = utilisateur &amp; p = mot de passe! &amp; m = $ message</i> - informations d'identification et la valeur de la variable de demande m - attribue le contenu de la variable $ message <br>  <i>-O /tmp/out.txt</i> - nous n'avons pas besoin de sortie dans le fichier /tmp/out.txt dans ce cas, mais si vous ne spÃ©cifiez pas ce paramÃ¨tre, wget ne fonctionne pas <br><br><div class="spoiler">  <b class="spoiler_title">Pourquoi Ã§a marche de travers</b> <div class="spoiler_text">  Parce que c'est un trou de sÃ©curitÃ© potentiel.  l'erreur la plus inoffensive qui puisse se produire est, par exemple, si le symbole Â«&amp;Â» apparaÃ®t dans la sortie de votre commande.  Par consÃ©quent, il est nÃ©cessaire de filtrer tout ce qui est envoyÃ© par les routeurs et tout ce qui arrive au serveur.  <b>Ouais, j'ai vraiment honte.</b>  Pour ma dÃ©fense, je peux seulement Ã©crire - que l'article entier est consacrÃ© Ã  la faÃ§on de gÃ©rer les routeurs avec un firmware non dÃ©fini Ã  l'avance, avec des canaux de communication non dÃ©finis Ã  l'avance. <br></div></div><br>  Eh bien, j'ai touchÃ© l'avenir: je n'ai pas compris comment reflÃ©ter les rÃ©sultats (par exemple, le rÃ©sultat de la commande) qui arrivent sur le serveur Ã  l'aide des outils zabbix standard. <br><br>  Je vous rappelle que <a href="">toutes les sources peuvent Ãªtre extraites du dÃ©pÃ´t Git</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446230/">https://habr.com/ru/post/fr446230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446212/index.html">Profondeurs SIEM: corrÃ©lations prÃªtes Ã  l'emploi. Partie 5. MÃ©thodologie pour dÃ©velopper des rÃ¨gles de corrÃ©lation</a></li>
<li><a href="../fr446214/index.html">OS1: un noyau primitif sur Rust pour x86. Partie 3. Carte mÃ©moire, exception de dÃ©faut de page, tas et allocations</a></li>
<li><a href="../fr446218/index.html">Le game designer n'est pas trÃ¨s diffÃ©rent d'un psycho. Comment nous avons crÃ©Ã© le jeu CMAN</a></li>
<li><a href="../fr446222/index.html">Utilisation des potentiels thermiques pour l'analyse de territoire</a></li>
<li><a href="../fr446228/index.html">AmÃ©liorer la qualitÃ© de la classification des textes en connectant Wikipedia</a></li>
<li><a href="../fr446234/index.html">Comment des bÃ©nÃ©voles du monde entier crÃ©ent des Ã©missions en direct de l'ICPC-2019</a></li>
<li><a href="../fr446236/index.html">Yandex amÃ©liorera les algorithmes de reconnaissance vocale</a></li>
<li><a href="../fr446238/index.html">Exploiter les chargeurs de dÃ©marrage signÃ©s pour contourner le dÃ©marrage sÃ©curisÃ© UEFI</a></li>
<li><a href="../fr446242/index.html">La procrastination comme outil de voyage dans le temps</a></li>
<li><a href="../fr446244/index.html">Extensions Chrome pour le dÃ©veloppement Web et travailler avec GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>