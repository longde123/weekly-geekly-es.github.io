<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💝 🛠️ 🛎️ Surveillance et gestion à distance des périphériques basés sur Linux / OpenWrt / Lede via le port 80, suite 🐑 👸🏿 👨🏼‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ceci est la dernière partie de l'article, voici le début . 

 La dernière fois que j'ai écrit sur la façon dont j'ai implémenté la surveillance des ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance et gestion à distance des périphériques basés sur Linux / OpenWrt / Lede via le port 80, suite</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446230/">  Ceci est la dernière partie de l'article, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici le début</a> . <br><br>  La dernière fois que j'ai écrit sur la façon dont j'ai implémenté la surveillance des appareils, nous allons maintenant nous concentrer sur la gestion.  Dans les discussions avec les "technophiles" de la part du client, je rencontre souvent une perception limitée des capacités de ces petits appareils (avec de faibles ressources mémoire et performances), beaucoup de gens pensent que "le maximum dont nous avons besoin est d'envoyer un redémarrage, pour quelque chose de plus sérieux - nous enverrons une équipe" . <br><br>  Mais la pratique montre que ce n'est pas entièrement vrai. <br><a name="habracut"></a><br>  Voici une courte liste des tâches courantes courantes: <br><br><ol><li>  Diagnostics et dépannage du réseau.  Derrière le port Ethernet de votre routeur, un autre matériel a généralement sa propre adresse IP interne.  Parfois, il peut (avoir besoin) de "ping".  Ou la gestion des tunnels - si un routeur qui ne monte pas soudainement sur un routeur passant par un modem 3G, mais nous voyons le routeur lui-même. </li><li>  Service système.  Mise à niveau du micrologiciel, mise à niveau du script de service. </li><li>  Acte d'équilibre.  Cela pourrait être appelé "perversions", mais le concept de "balancer" comme, je cite, <i>"la capacité d'un artiste de cirque à maintenir l'équilibre dans une position instable du corps"</i> est plus approprié.  Des situations similaires se produisent en raison du budget limité du client.  Voici quelques exemples, mais parce que  ils n'ont aucun rapport direct avec le sujet du récit, mettez-les dans des notes </li></ol><br><div class="spoiler">  <b class="spoiler_title">Surveillance Wifi</b> <div class="spoiler_text">  Un sujet à la mode au cours des cinq dernières années concerne principalement les chaînes de vente au détail fédérales.  Vous vous promenez lentement à travers les parquets, et votre téléphone mobile avec Wi-Fi activé, dans une tentative de «coller» à un thread réseau, envoie régulièrement des paquets de demande de sonde qui peuvent être analysés pour calculer la fréquence à laquelle vous venez dans ce magasin, pour quoi marcher les trajectoires et ainsi de suite.  Ensuite, les données sont collectées, analysées, des cartes thermiques sont dessinées et les gestionnaires pour de telles images "coupent" l'argent de la direction ou des investisseurs.  En attendant .... "il n'y a pas d'argent, mais vous tenez bon ...", et le résultat (réel) doit déjà être montré, la bonne vieille chanson est incluse "Oui, oui, alors bien sûr nous mettrons tsiska et tout ce que nous voulons, mais maintenant nous avons besoin montrez le résultat au client!  Soit dit en passant, ils ont oublié de dire que le client a permis à notre équipement d'être connecté à son hotspot via le Wi-Fi, mais de manière générale, c'est comme si nous étions des clients invités. "  Et maintenant, vous devez créer des routeurs-équilibreurs - plusieurs sous-interfaces WiFi montent, dont l'une s'accroche à un hotspot, et la seconde surveille l'environnement, décharge frénétiquement le résultat de tcpdump en elle-même, puis le contenu du fichier est compressé dans l'archive et risque de mourir de "suralimentation" essayer de cracher le contenu sur le serveur ftp.  Il n'est pas surprenant que le routeur-équilibreur "tombe en panne" et doive être ressuscité à distance. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Rayon</b> <div class="spoiler_text">  Ici, il est plus facile de décrire la situation avec quelque chose comme cette déclaration du client: <i>«Nous voulons un réseau décentralisé de hotspots qui fonctionnent sur des équipements dont le modèle n'est pas connu à l'avance, via des canaux, mais que nous ne connaissons pas encore.</i>  <i>Ah, ils ont oublié de dire, nous voulons non seulement montrer des publicités aux clients, mais aussi analyser tout autour du lieu d'installation du hotspot.</i>  <i>Non, nous ne savons pas encore pourquoi, mais nous arriverons, n’en doutons pas, nous avons pu trouver cette idée »</i> <br></div></div><br>  Et nous ne devons pas oublier qu'en raison de la masse de circonstances incertaines à l'avance, le contrôle doit être effectué dans des conditions non standard, lorsque nous ne pouvons pas nous connecter directement au routeur via ip: le port et sommes obligés d'attendre simplement une activité de celui-ci.  Si nous l'ignorons, le dialogue entre le serveur et le routeur peut être représenté comme ceci: <br><br><ul><li>  <b>Routeur</b> : salut.  Je suis un tel routeur, y a-t-il des tâches pour moi? </li><li>  <b>Serveur</b> : tel ou tel routeur je vous ai enregistré que vous êtes vivant.  Voici la tâche: montrez-moi le résultat de la commande ifconfig? </li><li>  <b>Routeur</b> : salut.  Je suis un tel routeur, la dernière fois que vous m'avez demandé de montrer le résultat d'ifconfig, le voici.  Y a-t-il des tâches pour moi? </li><li>  <b>Serveur</b> : tel ou tel routeur je vous ai enregistré que vous êtes vivant.  Il n'y a pas de tâches pour vous. </li></ul><br>  La question la plus intéressante: comment un routeur distant peut-il envoyer une certaine quantité d'informations?  Dans la dernière partie, j'ai décrit que sur le routeur en raison de ressources limitées, il n'y a qu'un wget "dépouillé" qui ne fonctionne que via GET et rien d'autre, il n'y a pas de client ftp ou curl.  Plus précisément, nous avons besoin d'une méthode universelle, quelles que soient les caractéristiques de l'assemblage d'images.  J'ai décidé d'utiliser wget.  Plus précisément, comment j'ai «arrêté» - je n'avais tout simplement pas le choix :) <br><br><div class="spoiler">  <b class="spoiler_title">Réservation immédiate</b> <div class="spoiler_text">  Ma solution de gestion fonctionne, mais très limitée et je suis sûre qu'elle est tordue, même si elle convient à la plupart de mes clients.  Comment il serait possible de le faire judicieusement - d'écrire un petit utilitaire qui envoie des données binaires via le 80e port.  Incluez-le (utilitaire) dans le firmware du routeur et utilisez bash pour y accéder.  Mais la réalité est que: a) vous devez rapidement b) peut-être que vous devez tout faire sur le "zoo du routeur" existant c) "ne faites pas de mal!"  - si le routeur fonctionne et effectue d'autres tâches, essayez d'apporter des modifications qui affecteront les fonctionnalités existantes. <br></div></div><br>  Passons à la mise en œuvre.  Supposons que votre client veuille de zabbix redémarrer le routeur facilement et naturellement, en un «clic de souris».  Aujourd'hui, nous allons commencer la description de la mise en œuvre avec zabbiksa. <br><br>  Dans le menu "Administration" -&gt; "Scripts" ajoutez un nouveau script.  Nous l'appelons «Reboot», en tant que commande, nous écrivons «php /usr/share/zabbix/reboot.php {HOST.HOST}» <br><br><img src="https://habrastorage.org/webt/pf/hg/on/pfhgongtotx7njamqfnrnxcqvhg.jpeg"><br><br>  Plus loin: Menu "Surveillance" -&gt; "Données récentes" -&gt; "Faites un clic droit sur le nœud du réseau."  Voici à quoi ressemblera le menu après l'ajout d'un script. <br><br><img src="https://habrastorage.org/webt/4k/um/go/4kumgoc08rhijg8sz5jq_e1t3z4.jpeg"><br>  En conséquence, nous mettons le script reboot.php dans le répertoire / usr / share / zabbix (vous pouvez en avoir un autre, j'utilise le répertoire racine zabbixa). <br><br><div class="spoiler">  <b class="spoiler_title">Clause de non-responsabilité pour la sécurité</b> <div class="spoiler_text">  Pour plus de clarté dans le script, j'utilise uniquement l'ID du routeur, mais je n'utilise pas le mot de passe.  Dans la version de travail, ce n'est pas recommandé!  Pourquoi ai-je fait cela: parce que la grande question est de savoir où stocker les mots de passe des routeurs?  Dans zabbixe lui-même dans "l'inventaire"?  Pratique contradictoire.  En option: restreindre l'accès externe au fichier reboot.php lui-même <br></div></div><br>  Fichier Reboot.php <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//      $user = $argv[1]; // .      -   !            . //$password = $argv[2]; $conn=new mysqli("localhost","db_user","db_password","db_name"); if (mysqli_connect_errno()) { exit(); } $conn-&gt;set_charset("utf8"); // ""  reboot     task  users.   task    . $sql_users=$conn-&gt;prepare("UPDATE users SET task='reboot' WHERE id=? AND status='active';"); $sql_users-&gt;bind_param('s', $user); $sql_users-&gt;execute(); $sql_users-&gt;close(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  En fait, tout.  La question «comment obtenir le résultat de l'exécution d'une commande du côté de l'appareil» reste ouverte.  Considérez le problème en utilisant la commande ifconfig comme exemple.  Cette commande peut être envoyée à l'appareil: <br><br><pre> <code class="bash hljs">message=`ifconfig`; wget <span class="hljs-string"><span class="hljs-string">"http://xn--80abgfbdwanb2akugdrd3a2e5gsbj.xn--p1ai/a.php?u=user&amp;p=password!&amp;m=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$message</span></span></span><span class="hljs-string">"</span></span> -O /tmp/out.txt</code> </pre> <br>  où: <br>  <i>message = `ifconfig`</i> - nous affectons le résultat de la sortie de la commande ifconfig à la variable $ message <br>  <i>wget " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xn - 80abgfbdwanb2akugdrd3a2e5gsbj.xn - p1ai / a.php</a></i> - notre script a.php qui enregistre les routeurs et reçoit des messages d'eux <br>  <i>u = utilisateur &amp; p = mot de passe! &amp; m = $ message</i> - informations d'identification et la valeur de la variable de demande m - attribue le contenu de la variable $ message <br>  <i>-O /tmp/out.txt</i> - nous n'avons pas besoin de sortie dans le fichier /tmp/out.txt dans ce cas, mais si vous ne spécifiez pas ce paramètre, wget ne fonctionne pas <br><br><div class="spoiler">  <b class="spoiler_title">Pourquoi ça marche de travers</b> <div class="spoiler_text">  Parce que c'est un trou de sécurité potentiel.  l'erreur la plus inoffensive qui puisse se produire est, par exemple, si le symbole «&amp;» apparaît dans la sortie de votre commande.  Par conséquent, il est nécessaire de filtrer tout ce qui est envoyé par les routeurs et tout ce qui arrive au serveur.  <b>Ouais, j'ai vraiment honte.</b>  Pour ma défense, je peux seulement écrire - que l'article entier est consacré à la façon de gérer les routeurs avec un firmware non défini à l'avance, avec des canaux de communication non définis à l'avance. <br></div></div><br>  Eh bien, j'ai touché l'avenir: je n'ai pas compris comment refléter les résultats (par exemple, le résultat de la commande) qui arrivent sur le serveur à l'aide des outils zabbix standard. <br><br>  Je vous rappelle que <a href="">toutes les sources peuvent être extraites du dépôt Git</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446230/">https://habr.com/ru/post/fr446230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446212/index.html">Profondeurs SIEM: corrélations prêtes à l'emploi. Partie 5. Méthodologie pour développer des règles de corrélation</a></li>
<li><a href="../fr446214/index.html">OS1: un noyau primitif sur Rust pour x86. Partie 3. Carte mémoire, exception de défaut de page, tas et allocations</a></li>
<li><a href="../fr446218/index.html">Le game designer n'est pas très différent d'un psycho. Comment nous avons créé le jeu CMAN</a></li>
<li><a href="../fr446222/index.html">Utilisation des potentiels thermiques pour l'analyse de territoire</a></li>
<li><a href="../fr446228/index.html">Améliorer la qualité de la classification des textes en connectant Wikipedia</a></li>
<li><a href="../fr446234/index.html">Comment des bénévoles du monde entier créent des émissions en direct de l'ICPC-2019</a></li>
<li><a href="../fr446236/index.html">Yandex améliorera les algorithmes de reconnaissance vocale</a></li>
<li><a href="../fr446238/index.html">Exploiter les chargeurs de démarrage signés pour contourner le démarrage sécurisé UEFI</a></li>
<li><a href="../fr446242/index.html">La procrastination comme outil de voyage dans le temps</a></li>
<li><a href="../fr446244/index.html">Extensions Chrome pour le développement Web et travailler avec GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>