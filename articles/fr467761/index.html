<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîß üöΩ üçÆ √ânergie, chaleur et eau, troisi√®me partie: allez √† la radio ü¶á ‚≠êÔ∏è üë¶üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entr√©e 
 Dans le processus de choix des solutions pour une maison intelligente, j'essaie de contourner les solutions en bo√Æte qui n√©cessitent une comm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√ânergie, chaleur et eau, troisi√®me partie: allez √† la radio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467761/"><h2>  Entr√©e </h2><br>  Dans le processus de choix des solutions pour une maison intelligente, j'essaie de contourner les solutions en bo√Æte qui n√©cessitent une communication avec des clouds externes ou qui ont leurs propres applications, en particulier des solutions sans possibilit√© de se connecter directement √† l'appareil.  Toutes les mesures disponibles sont r√©duites √† une seule interface - zabbix, o√π un syst√®me d'alerte des parties prenantes est organis√©.  Les boutons de contr√¥le sont impl√©ment√©s dans une interface Web localis√©e. <br><br><h2>  Articles pr√©c√©dents: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re partie</a> (temp√©rature 1 fil, ups, compteur d'eau ...) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deuxi√®me partie</a> (netping, gidrolock, capteurs de pression ...) <br><br><h2>  T√¢ches r√©solues dans cet article </h2><br><ul><li>  Protection extensible et flexible contre les fuites d'eau avec alerte zabbix </li><li>  Autres appareils √† 433 MHz: sonnette, porte ouverte, etc. </li><li>  Nous poussons 1 fil dans MQTT </li></ul><br><h2>  Syst√®me de protection contre les fuites </h2><br><h3>  Configuration requise: </h3><br><ul><li>  beaucoup de capteurs dispers√©s dans la maison (dans mon cas - 6 pi√®ces √† diff√©rents endroits) </li><li>  pas de fils aux capteurs </li><li>  arr√™t rapide en cas de d√©tection de fuite </li><li>  toutes les informations d'√©tat actuelles dans zabbix.  Il y a une alerte </li></ul><br><h3>  Composition du syst√®me </h3><br><ul><li>  Raspberry PI </li><li>  Tuner USB RTL2832U </li><li>  Capteurs de fuite 433 mhz </li><li>  Grue Netping + gidrolock (voir article pr√©c√©dent) pour fermer le coffre </li></ul><a name="habracut"></a><br><h3>  √Ä propos du fer </h3><br>  Dans un article pr√©c√©dent, j'ai d√©crit la solution consistant √† couper l'alimentation en eau √† l'aide de netping.  J'ai un capteur filaire pour cette solution.  Ceci est pratique si tous les points o√π des fuites peuvent se produire sont approximativement au m√™me endroit.  Dans mon cas, netping est install√© directement √† l'entr√©e de l'autoroute et contr√¥le la grue √©lectrom√©canique Gidrolock au m√™me endroit (voir l'article pr√©c√©dent).  La diffusion netping + gidrolock + capteur filaire en tous points est co√ªteuse et encombrante.  De plus, je n'ai plus la possibilit√© de faire glisser de nouveaux fils autour de la maison.  L'occupation des prises et la respiration des grues √©lectriques est une solution m√©diocre.  La solution est attendue - nous utilisons le chevauchement de la route commune bas√© sur les signaux des capteurs radio r√©partis sur les sites. <br>  D'apr√®s ce qui a √©t√© trouv√© sur Internet - un tas de diff√©rents capteurs radio de syst√®mes finis.  Certains peuvent √™tre achet√©s s√©par√©ment, je n'ai pas achet√© de contr√¥leurs pour capteurs, afin de ne pas produire d'√©l√©ments suppl√©mentaires dans le circuit. <br><br>  Comment puis-je attraper 433 mhz?  Il s'av√®re - un tuner TV sur un chipset sp√©cifique.  Et maintenant, il vaut un sou (j'ai pris Avito pour 300r) comme ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b84/efb/7c8/b84efb7c88ad3e4a89edbb470a653843.png" alt="image"><br><br>  J'ai command√© une antenne s√©par√©e pour cela sur 12dbi, car l'actuelle ne couvrait pas toute la maison. <br><br>  Depuis que j'ai essay√© de minimiser les composants de contr√¥le du circuit, il y avait un d√©sir de resserrer le tuner dans mon routeur domestique avec Openwrt, qui √©tait jusque-l√† le c≈ìur de la solution de maison intelligente pour 1 fil, modbus, capteurs / protocoles wifi, mais, malheureusement, j'ai √©puis√© certaines de ses ressources ( l'espace sur le lecteur flash int√©gr√© pour les logiciels n√©cessaires se termine, le processeur se charge de quelque chose - il y aura d√©j√† des probl√®mes avec le r√©seau, et nous avons encore 4k pour regarder en ligne :), + il y a d√©j√† trop de choses accroch√©es sur USB, ce qui affecte la stabilit√© de la collecte de donn√©es).  Il a √©t√© d√©cid√© de transf√©rer progressivement les fonctionnalit√©s de la maison intelligente vers un appareil externe - rarpberry pi (l'une des premi√®res versions √©tait √† port√©e de main). <br><br><h3>  √Ä propos des logiciels </h3><br>  Apr√®s avoir jou√© avec un tuner TV en sdr-sharp sur un ordinateur de bureau avec des fen√™tres (apr√®s avoir essay√© d'attraper les radios et les n√©gociations des avions d'autres personnes), j'ai commenc√© √† regarder si les capteurs eux-m√™mes voyaient le ¬´sifflement¬ª.  Oui, il voit parfaitement: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37e/68a/4d6/37e68a4d69b575f74e47db6ae45b0d4b.jpg" alt="image"><br><br><h4>  R√©glage framboise </h4><br>  J'ai choisi le raspbian natif.  J'ai √©crit la derni√®re image sur la cl√© USB sous mac / linux: <br><br><pre><code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=2019-07-10-raspbian-buster-lite.img of=/dev/disk2 bs=1048576 conv=sync</code> </pre> <br>  D√©marrez, configurez le r√©seau et ssh. <br><br>  Ensuite - mettez les paquets de framboises rtl-sdr, rtl_433: <br><br><pre> <code class="bash hljs">sudo apt-get install cmake build-essential python-pip libusb-1.0-0-dev libusb-1.0 python-numpy git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/merbanan/rtl_433.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rtl_433/ mkdir build <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build cmake .. make make install</code> </pre> <br>  rtl_433 poss√®de des protocoles int√©gr√©s qui d√©chiffrent les donn√©es de diff√©rents appareils fonctionnant dans la gamme 433 MHz. <br><br><h4>  Nous commen√ßons rtl_433 </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6</code> </pre> <br>  Nous abaissons les capteurs dans l'eau et obtenons les ch√©ris: <br><br><pre> <code class="bash hljs">time : 2019-09-17 15:04:39 model : Smoke detector GS 558 id : 16919 unit : 1 learn : 0 Raw Code : c842e1</code> </pre><br>  D√©tecteur de fum√©e?  Ok, mettons la chanson "Smoke on the water" sur l'alerte de ces capteurs ... :) <br>  Mais s√©rieusement - nous avons l'identifiant de chaque capteur, selon lequel √† l'avenir nous comprendrons o√π exactement nous avons une fuite (et nous fermerons de toute fa√ßon). <br><br><h4>  √Ä propos des capteurs de fuite </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/47a/255/60d/47a25560dd09554b0749dc171502c71b.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/710/dd8/917/710dd891751f85699ed64c30b180c443.png" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/b56/f4b/a31/b56f4ba310bd674da8b16171c5112806.png" alt="image"><br><br>  Apr√®s avoir install√© la partie logicielle, j'ai remarqu√© que les capteurs avec aliexpress (photo de gauche) envoient un seul signal lorsque l'eau p√©n√®tre dans les contacts.  Plus un seul signal si l'eau cesse de fermer les contacts.  Cela ne me convient en aucune fa√ßon (comportement attendu: envoyer constamment un signal d'alarme lorsque le capteur d√©tecte de l'eau, car un seul signal peut √™tre perdu).  Un comportement similaire est observ√© si vous fermez les contacts avec un fil.  Mais ce qui est √©trange - l'alarme se produit toutes les 2-3 secondes, si vous fermez les contacts avec vos mains (peau).  Ici, j'ai encore deux hypoth√®ses: soit les Chinois foir√©s avec des mesures de r√©sistance, soit les capteurs ont un autre mode de fonctionnement dans lequel ils se comportent diff√©remment (par exemple, coupl√©s avec un contr√¥leur), ou il y a d'autres fr√©quences (jusqu'√† ce que je trouve ) <br><br>  <i>Soit dit en passant, √©crivez dans les commentaires, peut-√™tre que quelqu'un a travaill√© avec ces capteurs, peut-il en quelque sorte "apprendre" √† envoyer un signal sur une fuite en permanence?</i> <br><br>  J'ai mis ces capteurs de c√¥t√©, dans l'arsenal √©tait un autre de rubetek (photo de droite) et achet√© √† Leroy: GAL SHW-1005 (photo du milieu). <br><br>  Le comportement du capteur rubetek semblait compl√®tement impr√©visible (la r√©action impr√©visible ¬´voit de l'eau / ne voit pas¬ª). <br><br>  Mais le capteur de Leroy en mouvement a montr√© exactement ce dont j'avais besoin: il y a de l'eau - je le spamme dans l'air, il n'y a pas d'eau - je me tais.  Son seul inconv√©nient est un rayon d'action plus petit que les autres capteurs.  Mais le probl√®me a √©t√© r√©solu en achetant une antenne plus sensible pour le r√©cepteur. <br><br><h4>  MQTT </h4><br>  Comment envoyer la sortie rtl_433 √† zabbix?  Nourrir l'agent?  Envoyer √† zabbix_sender, analyser le processus?  Peut-√™tre via syslog? <br><br>  Ici, vous devez vous rappeler que mon zabbix est quelque part dans les nuages.  Et il n'est certainement pas n√©cessaire de bloquer l'eau √† l'aide de ses d√©clencheurs.  Le sol de la maison sera inond√© jusqu'√† ce qu'il prenne une d√©cision (le cas √©ch√©ant). <br><br>  La bonne nouvelle est que rtl_433 peut envoyer des informations sur MQTT.  Hors de la bo√Æte.  Dans le m√™me temps, les donn√©es sont envoy√©es au courtier au format json. <br><br>  Il vous faut donc: <br><br><ul><li>  Placez un courtier en moustiques local (faites-le sur la framboise). </li><li>  Fusionnez les informations dans le courtier avec le sujet souhait√©, afin de pouvoir les analyser ult√©rieurement. </li><li>  Connectez-vous au courtier localement sur la framboise et envoyez des commandes √† netping </li><li>  Connectez-vous au courtier depuis l'endroit o√π la redirection vers zabbix aura lieu (le serveur zabbix dans mon cas est √©galement un client MQTT) </li></ul><br><h4>  Installation-setup moustique MQTT: </h4><br><pre> <code class="bash hljs">apt-get install mosquitto mosquitto-clients systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mosquitto systemctl start mosquitto</code> </pre> <br><h4>  Nous envoyons des informations au courtier en indiquant l'ID de l'appareil: </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.88e6 -F mqtt://127.0.0.1,events=/433/[id]</code> </pre> <br>  Dans le client mqtt, nous obtiendrons quelque chose comme ceci: <br><br><pre> <code class="bash hljs">mosquitto_sub -h 127.0.0.1 -t <span class="hljs-string"><span class="hljs-string">'#'</span></span> (   ) /433/16919 {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-18 11:55:29"</span></span>,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:16919,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:1,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"c842e1"</span></span>}</code> </pre> <br><h4>  Script pour se connecter au courtier et envoyer la commande √† netping </h4><br>  J'ai esquiss√© un client de script MQTT simple qui vous permet d'ex√©cuter le script associ√© au sujet lorsque le sujet sp√©cifi√© dans la configuration appara√Æt.  Ainsi, lorsqu'un certain capteur est d√©clench√© et que des informations √† ce sujet apparaissent sur l'Air (par exemple, / 433/16919), vous pouvez effectuer une action (dans le cas de netping, envoyer une demande de bouclage de la grue pour fermer la grue, voir l'article pr√©c√©dent).  Un lien vers le script se trouve √† la fin de l'article. <br><br><h4>  Redirection dans zabbix </h4><br>  J'ai utilis√© la solution mqtt-zabbix pr√™te √† l'emploi.  A son niveau, on comprend dans quel √©l√©ment envoyer la valeur (par id). <br><br>  Dans keys.cfg, sp√©cifiez: <br><br><pre> <code class="bash hljs">/433/16919,mqtt.ventilation.waterleak::hostname</code> </pre> <br>  o√π hostname est le nom d'h√¥te avec le type de clochard d'√©l√©ment dans Zabbix. <br><br>  Important !!!  Le nom d'h√¥te dans les param√®tres doit correspondre au nom √† envoyer dans le script, le type d'√©l√©ment (√©l√©ment de donn√©es) doit √™tre adapt√© aux donn√©es envoy√©es (par exemple, pour json - text), sinon vous d√©tecterez des erreurs du formulaire: <br><br><pre> <code class="bash hljs">2019-09-18 14:29:48,749 Got response from Zabbix: {u<span class="hljs-string"><span class="hljs-string">'info'</span></span>: u<span class="hljs-string"><span class="hljs-string">'processed: 0; failed: 1; total: 1; seconds spent: 0.000055'</span></span>, u<span class="hljs-string"><span class="hljs-string">'response'</span></span>: u<span class="hljs-string"><span class="hljs-string">'success'</span></span>}</code> </pre> <br>  De plus, il est difficile d'obtenir plus de d√©bogage (et pourquoi √©chou√©) √† partir de zabbix. <br><br>  Nous configurons /etc/mqtt-zabbix/mqtt-zabbix.cfg (sp√©cifiez le courtier ip mqtt et l'adresse du serveur zabbix). <br><br><h3>  Quoi d'autre pour se connecter au 433? </h3><br>  <i>Oui, n'importe quoi!</i>  <i>:)</i> <br><br><h4>  Capteurs de station m√©t√©o </h4><br>  En bricolant avec des capteurs de fuite sans fil, j'ai accidentellement capt√© le signal d'un capteur externe d'une station m√©t√©o.  Cela ressemblait √† ceci: <br><br><pre> <code class="bash hljs">time : 2019-09-19 10:48:54 Protocol : 56 model : TFA pool temperature sensor Id : 182 Channel : 3 Temperature: 19.3 C Modulation: ASK Freq : 433.9 MHz RSSI : -0.1 dB SNR : 35.0 dB Noise : -35.2 dB time : 2019-09-20 10:57:29 Protocol : 12 brand : OS model : THN132N House Code: 4 Channel : 3 Battery : OK Celsius : 20.00 C Modulation: ASK Freq : 432.9 MHz RSSI : -0.2 dB SNR : 31.5 dB Noise : -31.7 dB</code> </pre><br>  Ainsi, le bonus √©tait la possibilit√© de surveiller la temp√©rature des points sur l'air avec affichage en zabbix.  Juste dans certaines pi√®ces, je ne peux pas √©tirer le c√¢ble. <br><br><h4>  Sonnette </h4><br>  De nombreux appels radio fonctionnent dans la m√™me gamme de fr√©quences ~ 433 MHz.  Ainsi, nous pouvons intercepter la pression sur le bouton d'appel (il n'est m√™me pas n√©cessaire d'avoir l'appel lui-m√™me, juste le bouton suffit).  Pourquoi?  Par exemple, pour configurer une notification suppl√©mentaire par SMS / t√©l√©gramme / quoi que ce soit ou afficher l'image de la cam√©ra sur le moniteur. <br><br>  J'ai achet√© un appel: Evology QA-688-E RU. <br><br>  Pour que le bouton rtl_433 puisse voir le bouton d'appel, vous devez activer les protocoles ¬´test¬ª, par exemple en ex√©cutant l'option ¬´G¬ª ou en sp√©cifiant un protocole suppl√©mentaire sp√©cifique, en m√™me temps, nous ajouterons la sortie d'informations sur le protocole et la fr√©quence: <br><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6 -G -M protocol -M level -F mqtt://127.0.0.1,events=/433/[id] &amp;</code> </pre> <br>  Entrez dans MQTT: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 10:57:00"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:72,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"RF-tech"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"battery"</span></span>:<span class="hljs-string"><span class="hljs-string">"LOW"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature_C"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"button"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.84822,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.5981,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.77488,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}</code> </pre> <br>  Ici, vous pouvez voir id = 0.  En m√™me temps, j'avais plusieurs appareils identifi√©s comme RF-tech.  Tous avaient un identifiant √©gal √† 0. Par cons√©quent, tous les appareils dans zabbix sont affich√©s comme un seul √©l√©ment.  Il est possible de distinguer exactement quel appareil a fonctionn√©, uniquement par fr√©quence. <br><br>  Nous tirons la fr√©quence dans un √©l√©ment d√©pendant distinct: mqtt.outside.doorbell.freq avec un pr√©traitement JSON √† $ .freq (zabbix peut le faire √† partir de la 4√®me version). <br><br>  Sur cet √©l√©ment, cr√©ez un d√©clencheur avec l'expression: <br><br><pre> <code class="bash hljs">{HOME_PI:mqtt.outside.doorbell.freq.last()}&gt;433.8 and {HOME_PI:mqtt.outside.doorbell.freq.last()}&lt;433.81 and {HOME_PI:mqtt.outside.doorbell.freq.nodata(30)}=0</code> </pre> <br>  C'est-√†-dire  si tout √† coup une valeur appara√Æt dans l'√©l√©ment g√©n√©ral mqtt.outside.doorbell.freq (nodata) et que la fr√©quence est dans la plage sp√©cifi√©e entre 433,8 et 433,81, nous pouvons conclure qu'ils nous appellent (et par exemple, pour dupliquer un appel √† SMS). <br><br><h4>  Capteurs de porte / fen√™tre </h4><br>  J'ai un capteur de p√©n√©tration de rubetek.  Envoie ce qui suit: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:86,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:12262,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:16,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"e5fcd0"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:7,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"close"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:21"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:14,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"open"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85005,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-11.0148,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:25.1088,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-36.1236}</code> </pre> <br>  D√®s que le dernier capteur radio a √©t√© ajout√© √† zabbix, j'ai voulu tout refaire sur MQTT.  Catalogage pratique, vous pouvez d√©terminer le sujet-ah et l'emplacement et les types d'appareils.  Vous obtenez la diffusion g√©n√©rale de tous les √©v√©nements. <br><br><h2>  1 fil vers MQTT </h2><br>  Je veux que tout soit dans MQTT, au moins pour le m√™me type d'impl√©mentation.  Je veux obtenir un "√©ther" g√©n√©ral des √©v√©nements et une approche g√©n√©rale en r√©action √† ces √©v√©nements.  Bien s√ªr, zabbix r√©sout le probl√®me de r√©action et je laisse des alertes dessus.  Mais je veux rendre la gestion plus l√©g√®re, proche du syst√®me et de "l'√©ther". <br><br>  Des solutions pr√™tes √† l'emploi pour relayer les √©tats des capteurs d'un r√©seau 1 fil √† MQTT existent, mais elles ne me convenaient pas.  Les solutions pr√™tes √† l'emploi sur le n≈ìud portent soit un tas de d√©pendances derri√®re elles, soit ont mang√© le processeur de framboise entier.  Certaines des solutions du top 10 de la recherche Google sont abandonn√©es par les auteurs, certaines ne sont prises en charge que par des capteurs de temp√©rature.  Il existe √©galement une classe de passerelles collectant des informations via l'interface gpio.  Tout cela ne me convenait pas. <br><br>  J'ai un syst√®me de pseudo-fichiers mont√© avec des p√©riph√©riques 1wire dans / mnt / 1wire, c'est l√† que je veux obtenir toutes les informations n√©cessaires.  Pour ce faire, il suffit de faire une simple ligne sur bash, en envoyant des donn√©es via mosquitto_pub pour chacun des capteurs.  Cependant, il y a des questions de lancement de ces scripts (par-dessus la couronne, pour conduire dans une sorte de d√©mon?), Pr√©sentation normale des donn√©es (obtenir le m√™me json), ajout d'un nouveau capteur, etc. Plus la pens√©e s'est d√©velopp√©e, plus les b√©quilles sont n√©es.  Il s'est av√©r√© plus facile d'√©crire une passerelle pour encore un autre owfs √† mqtt pour cette t√¢che. <br><br>  Il y a un fichier de configuration dans lequel nous devons entrer l'id des capteurs et ces fichiers de fuse.OWFS que nous voulons publier sur mqtt. <br><br>  La sortie dans mqtt est le json suivant: <br><br><pre> <code class="bash hljs">/1wire/28.0425260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"30"</span></span>} /1wire/28.bf16270a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.9375"</span></span>} /1wire/26.da2f71010000 {<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"25.2812"</span></span>, <span class="hljs-string"><span class="hljs-string">"IAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"CA"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"VAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.91"</span></span>, <span class="hljs-string"><span class="hljs-string">"VDD"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.59"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2438"</span></span>} /1wire/28.48b3010b0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"40.5625"</span></span>} /1wire/1d.6a9306000000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2423"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.B"</span></span>: <span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.A"</span></span>: <span class="hljs-string"><span class="hljs-string">"9219"</span></span>} /1wire/28.61cc260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"12.5"</span></span>}</code> </pre> <br>  Ajouter √† l'ex√©cution automatique, d√©finissez l'intervalle d'interrogation.  Le probl√®me est r√©solu. <br><br><h3>  Les r√©f√©rences </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/merbanan/rtl_433</a> - un outil pour d√©coder les protocoles radio <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/kylegordon/mqtt-zabbix</a> - MQTT sur Zabbix <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/unlo/1wire2mqtt</a> - 1 fil dans MQTT, client MQTT qui vous permet d'ex√©cuter des scripts lorsque la rubrique appara√Æt </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467761/">https://habr.com/ru/post/fr467761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467749/index.html">GCP: analyse de la pile informatique de Google Cloud Platform</a></li>
<li><a href="../fr467751/index.html">Comment fonctionne un messager d√©centralis√© sur la blockchain</a></li>
<li><a href="../fr467753/index.html">Record du monde pour la transmission de donn√©es sans fil: 40 Gb / s par 11 kilom√®tres</a></li>
<li><a href="../fr467755/index.html">Prions, calcium, microbiote, hormones alimentaires et Alzheimer</a></li>
<li><a href="../fr467759/index.html">Conception de syst√®me d'exploitation de type Unix - Espace d'adressage virtuel (6)</a></li>
<li><a href="../fr467763/index.html">Toute la v√©rit√© sur RTOS. Article # 33. Utilisation du syst√®me d'exploitation en temps r√©el Nucleus SE</a></li>
<li><a href="../fr467765/index.html">Wi-Fi et de nombreuses autres abr√©viations. Comment obtenir des donn√©es sur des n≈ìuds Wi-Fi dans une application Android et ne pas gonfler</a></li>
<li><a href="../fr467767/index.html">Plus d'√©quipements pour les abonn√©s JSON-RPC</a></li>
<li><a href="../fr467771/index.html">Comme un auto-rechargeur vert junior a √©crit son <s> hot </s>. Partie 2. CSS</a></li>
<li><a href="../fr467775/index.html">5 mythes sur les affaires: pourquoi le client a tort et comment d√©passer Apple</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>