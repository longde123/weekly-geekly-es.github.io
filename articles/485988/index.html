<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÇ üìá üå∂Ô∏è [Case Locomizer] C√≥mo acelerar el c√°lculo de un mapa de calor en 20,000 veces en dos a√±os y medio üöû üö∏ ü§¶üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo es una continuaci√≥n de la serie Case Locomizer, ver tambi√©n 



- Qu√© conocimiento se puede extraer realmente de un conjunto de datos an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Case Locomizer] C√≥mo acelerar el c√°lculo de un mapa de calor en 20,000 veces en dos a√±os y medio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485988/"><blockquote>  Este art√≠culo es una continuaci√≥n de la serie Case Locomizer, ver tambi√©n <br><br><ul><li> <a href="https://habr.com/ru/post/485484">Qu√© conocimiento se puede extraer realmente de un conjunto de datos an√≥nimo con coordenadas de usuario</a> </li><li>  Open One Ring: un kit de herramientas para la configuraci√≥n flexible de procesos complejos de procesamiento de datos en Spark en la nube (¬°pr√≥ximamente!) </li></ul></blockquote><br>  Hola <br><br><img src="https://habrastorage.org/webt/fj/uo/jz/fjuojzz4hen-a54ybf62phjmlvk.png" alt="FDC: TC, EMR, IDEA" title="FDC: TC, EMR, IDEA"><br><br>  ¬øSabes qu√© es una autopsia?  Esta es una historia sobre c√≥mo llegamos a esa vida. <br><br>  No estoy seguro de ti, pero me encanta leer historias sobre el proceso de desarrollo de un software altamente especializado o de bajo nivel.  Los colegas pueden tener una idea interesante con la que trabajar, y siempre es curioso seguir lo que sucedi√≥ con el programa desde el prototipo hasta el producto maduro, que hace algo de magia en un √°rea tem√°tica desconocida. <br><br>  Adem√°s, si solo lanzo un enlace a un repositorio con dicho software, es poco probable que alguien pueda obtener una idea de qu√© es y por qu√©, y para qu√© tareas puede ser √∫til.  Incluso si traduzco del ingl√©s tres docenas de p√°ginas de instrucciones para comenzar.  Sin embargo, el marco de <a href="https://spark.apache.org/">Spark</a> no es solo otro oficio en lo angular, debe entenderse <s>que los</s> autores <s>fumaron</s> por qu√© fue escrito de esta manera y no de otra manera. <br><br>  Este art√≠culo es una introducci√≥n hist√≥rica a One Ring.  No tiene c√≥digo, y la historia es m√°s popular que cient√≠fica.  Pero solo sobre el desarrollo, y sobre nada m√°s, excepto por dos a√±os y medio de desarrollo. <br><a name="habracut"></a><br>  La √∫ltima vez, habl√© con suficiente detalle (espero que sea suficiente) sobre las dificultades de extraer datos de conjuntos de datos an√≥nimos en el carril central, y al final me encontr√© con una intriga no d√©bil.  Dejemos su resoluci√≥n por √∫ltima vez, y hoy hablaremos sobre el largo y dif√≠cil camino hacia la perfecci√≥n de nuestra herramienta principal: <br><br><ul><li>  Big data es grande </li><li>  Nuestro caso no es est√°ndar </li><li>  Prototipo en C # y PostGIS </li><li>  Primer acercamiento a Hadoop MapReduce </li><li>  El advenimiento de CI y Spark </li><li>  Tercera aproximaci√≥n en GeoSpark </li><li>  Analistas japoneses y migraci√≥n de Azure a AWS </li><li>  Ash Nazg Durbatuluk, Ash Nazg Gimbatul, Ash Nazg Trakatuluk, Ag Burzum Ishi Krimpatul !! </li><li>  Optimizaci√≥n y geocatarsis con Uber H3 </li><li>  En todo blanco </li></ul><br><h3>  Big data es grande </h3><br>  Big data no se trata de tama√±o. <br><br>  Puede haber decenas, o incluso cientos de millones de registros en un conjunto de datos mensual en la regi√≥n del Gran Londres, pero eso no es mucho.  Una sola iteraci√≥n en ellos desde el principio hasta el final se basa en la velocidad de lectura lineal del disco.  Si la unidad es una SSD, tomar√° unos segundos. <br><br>  (Le recuerdo que el conjunto de datos en cuesti√≥n es un conjunto de archivos CSV con un conjunto de campos espec√≠ficos para el proveedor. La agrupaci√≥n de registros con las coordenadas de usuarios an√≥nimos en un archivo se produce a lo largo de las fronteras de la regi√≥n administrativa del pa√≠s, prefectura o ciudad. Los archivos se generan en la fecha seleccionada, diaria o <a href="https://habr.com/ru/post/485484">mensualmente. M√°s</a> detalles se <a href="https://habr.com/ru/post/485484">describen</a> en la parte anterior, <a href="https://habr.com/ru/post/485484">ejec√∫telos en diagonal</a> si no hay suficiente contexto). <br><br>  Nuestro proceso es de varios pasos.  Las heur√≠sticas iniciales de enriquecimiento de datos sin procesar que funcionan solo en un solo modo de iteraci√≥n son r√°pidas, y puede escribirlas al menos en Python, al menos en C ++, incluso en PHP.  Incluso en una m√°quina d√©bil, el procesamiento ser√° r√°pido. <br><br>  Si el conjunto de datos est√° en alg√∫n lugar de la nube, entonces, siempre que el controlador se coloque en la misma nube, no hay ning√∫n problema en particular para acceder, repasar y guardar el resultado al lado.  Adem√°s, generalmente el archivo ya est√° all√≠, porque los proveedores de datos con gran placer subir√°n el archivo a su almacenamiento en la nube, lo que le dar√° un enlace de descarga.  Solo resta desplegar la m√°quina virtual, y todas las bibliotecas para acceder al repositorio ser√°n cuidadosamente puestas por el proveedor, todas las claves de acceso est√°n registradas, solo tome la API en sus manos y √∫sela.  Ser√° r√°pido tambi√©n. <br><br>  Bueno, con los primeros pasos, todo est√° claro.  Tomaron el archivo, lo revisaron varias veces, volvieron a colocar la versi√≥n procesada.  Pero, ¬øqu√© sucede si los pasos posteriores de nuestro algoritmo requieren alg√∫n conjunto de c√°lculos ligeramente m√°s complejos para cada registro? <br><br>  Tome algo como determinar la distancia entre un par de coordenadas.  Existe un m√©todo <a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine</a> extremadamente r√°pido ("haversinuses" seg√∫n la versi√≥n de la sala), que proporciona una precisi√≥n aceptable a distancias cortas y permite no tomar el geoide <abbr title="Sistema geod√©sico mundial '84, ahora geoide est√°ndar">WGS84</abbr> , cuyo c√°lculo funciona mucho m√°s lentamente. <br><br>  En s√≠ mismo, resulta que tal c√°lculo no cuesta tanto si es √∫nico.  E incluso si hay decenas de millones de ellos, esto, en principio, no tiene sentido. <br><br>  Y ahora tomamos el caso de nuestro algoritmo patentado, cuando necesitamos calcular la distancia de cada se√±al a cada PDI de la categor√≠a seleccionada, y descartar aquellos que est√°n m√°s all√° de medio kil√≥metro (una distancia que es f√°cil de caminar). <br><br>  Para la regi√≥n del Gran Londres, aproximadamente un mill√≥n de establecimientos caen en <abbr title="Punto de inter√©s">PDI</abbr> espec√≠ficos en la categor√≠a de tiendas y puntos de venta.  Y como dije, en el conjunto mensual de datos docenas, cientos de millones de registros vienen por √©l.  Y as√≠ llegamos ... <br><br><h2>  1,000,000 POIs √ó N, 000,000 se√±ales = N, 000,000,000,000 distancias. </h2><br>  Oh, ven  Trillones de c√°lculos de distancia y comparaciones de umbral constante. <br><br>  La situaci√≥n cl√°sica con el <abbr title="Un conjunto cuyos elementos son todos los pares de elementos ordenados posibles de los conjuntos originales">producto cartesiano</abbr> .  Dos conjuntos no muy potentes individualmente dan f√°cilmente N √ó 10 <sup>12</sup> resultados intermedios, ¬°y esto es solo un mes en una regi√≥n!  Tal cantidad ya se est√° convirtiendo en calidad.  No solo el tama√±o del resultado intermedio ya es un problema grave, ya que no cabe en la memoria por completo, y es necesario procesarlo inmediatamente en el lugar de recepci√≥n, sino que la cantidad de c√°lculos necesarios para obtenerlo requiere demasiado tiempo de computadora.  Y si para un registro, teniendo en cuenta todas las demoras en la transmisi√≥n a trav√©s de la red y otros costos generales, solo se gastan 100 nanosegundos, entonces millones de segundos son d√≠as y semanas de c√°lculos en una secuencia. <br><br>  O, si necesitamos eliminar un segmento de la poblaci√≥n general, por ejemplo, la condici√≥n "no tiene en cuenta los intereses de los usuarios que viven en un √°rea determinada", entonces tendremos que comparar el device_id de cada registro del conjunto de datos enriquecido de toda la regi√≥n con un conjunto en el que cientos de miles de registros con excluidos los residentes de device_id de esta √°rea.  Y estas son comparaciones de cadenas de muchas maneras, no tan r√°pido como para dos entradas.  Una vez m√°s, hay una especie de incre√≠ble n√∫mero de ceros en la evaluaci√≥n de una operaci√≥n simple, y los tenemos para un conjunto completo de heur√≠sticas para un proyecto promedio con una docena, o incluso m√°s. <br><blockquote>  Big Data son datos que, debido a su tama√±o, hacen que sea necesario utilizar t√©cnicas algor√≠tmicas especiales debido a lo inapropiado o poco pr√°ctico del procesamiento directo. </blockquote><br>  ... incluso si el resultado final del c√°lculo se contrae en una pantalla de la tabla de Excel. <br><br>  Puede intentar paralelizar el controlador "ingenuo" por la cantidad de procesadores virtuales disponibles en la m√°quina donde ejecutamos el c√°lculo.  Puede dividir el conjunto de datos en partes y ejecutar el c√°lculo de diamantes de imitaci√≥n en una docena de m√°quinas virtuales en la nube.  Pero todo esto no dar√° un resultado cualitativamente excelente.  Escalar "en ancho" proporciona <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25BD_%25D1%2583%25D0%25B1%25D1%258B%25D0%25B2%25D0%25B0%25D1%258E%25D1%2589%25D0%25B5%25D0%25B9_%25D0%25B4%25D0%25BE%25D1%2585%25D0%25BE%25D0%25B4%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">rendimientos decrecientes a</a> partir de un cierto ancho.  Y ciertamente surgir√° el problema de la sincronizaci√≥n y la partici√≥n, y administrar una flota completa de m√°quinas virtuales costar√° mucho tiempo y dinero.  Mantenerlos encendidos todo el tiempo es costoso, y comenzar y detenerse bajo demanda es una labor intensiva. <br><br>  Por lo tanto, para Big Data, se utilizan sistemas de software especiales del ecosistema Hadoop, que ya tiene controles de escala, as√≠ como un conjunto especial de algoritmos que permiten al mamut comer en peque√±as porciones sin riesgo de atragantarse con la cantidad astron√≥mica de datos intermedios, y simplifica enormemente la vida de un desarrollador de Big Data.  Pero no puede simplemente tomar y comenzar a usar Hadoop.  Primero necesitas hacer un plan. <br><br>  Especialmente si ... <br><br><h3>  Nuestro caso no es est√°ndar </h3><br>  Si pregunta c√≥mo las oficinas involucradas en an√°lisis en grandes conjuntos de datos construyen sus procesos, resulta que se utilizan dos enfoques principales en la pr√°ctica mundial. <br><br><h4>  Enfoque n√∫mero 1.  Lago de datos </h4><br>  Para los datos que se acumulan con el tiempo y siguen siendo relevantes para siempre, se dise√±a un tipo especial de almacenamiento, el llamado " <a href="https://habr.com/ru/post/485180/">lago de datos</a> ". <br><br>  La arquitectura de dichos repositorios est√° optimizada para un acceso aleatorio r√°pido.  Muchos de los conjuntos de datos recopilados se traducen a un formato especializado que le permite realizar r√°pidamente selecciones y cortes de criterios m√∫ltiples por conjuntos de columnas.  A diferencia de las bases de datos relacionales y orientadas a documentos tradicionales, el almacenamiento de columnas se usa en lagos de datos.  Por lo general, son finales, es decir, el formato de los contenedores con los datos es tal que despu√©s de rellenar e indexar, los datos en el mismo conjunto de datos nunca cambian nuevamente.  Por ejemplo, archivos de parquet que no requieren modificaci√≥n. <br><br>  Despu√©s de eso, una multitud de <abbr title="analista">analistas</abbr> de datos, <abbr title="cientifico">satanistas</abbr> o <abbr title="analista">analistas de</abbr> datos <abbr title="analista">, se</abbr> apresuran, y en software especializado ("computadoras port√°tiles" como Jupyter) recopila estad√≠sticas, indicadores, etc.  en l√≠nea  Estas estad√≠sticas se descargan del lago en alg√∫n lugar hacia afuera, o simplemente se agregan en forma de los mismos archivos finales para la agregaci√≥n posterior. <br><br><h4>  Enfoque n√∫mero 2.  Transmisi√≥n de datos </h4><br>  Para los datos que llegan en tiempo real y necesitan ser procesados ‚Äã‚Äãr√°pidamente (es decir, transmisi√≥n de datos), se dise√±an buses de datos o colas de mensajes. <br><br>  En una infraestructura con un bus de datos, hay generadores en un extremo y consumidores en el otro, y los flujos de datos en s√≠ est√°n compuestos de eventos. <br><br>  Se generan generadores, y los consumidores, en tiempo real o casi real, analizan eventos, acumulando algunos resultados finales, que nuevamente pueden generar eventos que el pr√≥ximo conjunto de agregadores consumir√° a trav√©s del mismo bus, y as√≠ sucesivamente hasta que se obtenga el resultado final, plegado en el repositorio de resultados finales. <br><br>  Es conducido por Apache Kafka y almacenamiento r√°pido como Aerospike. <br><br><h4>  Nuestro caso </h4><br>  Pero nuestro caso no encaja en estos dos enfoques. <br><br>  En primer lugar, no tiene sentido que mantengamos un lago de datos, porque el conjunto de datos rara vez dura m√°s de un a√±o (las pistas de usuarios para 2016 en 2019 ya no son necesarias para nadie), y cada vez que los clientes necesitan una parte completamente impredecible de todos los datos acumulados.  Adem√°s, debido al hecho de que para cada segmento de la poblaci√≥n y categor√≠a se crea su propia plantilla, todav√≠a estamos obligados a tomar solo la pieza requerida, y fusionarlos en un lago com√∫n no tiene mucho sentido.  Es m√°s f√°cil mantener cada conjunto de datos mensual en su forma original: archivos CSV en su propio directorio separado.  La ruta al archivo se obtiene ... / proveedor / pa√≠s / regi√≥n / subregi√≥n / a√±o / mes / archivos de conjunto de datos, y un subconjunto se selecciona simplemente por la m√°scara de nombre de archivo, por ejemplo, ... / Tamoco / UK / Greater_London / * / 2019 / {6, 7.8} / *. Csv. <br><br>  En segundo lugar, la naturaleza de los conjuntos de datos es discreta, no de transmisi√≥n.  Por supuesto, uno podr√≠a, por supuesto, calcular directamente algunos indicadores directamente en el proceso de carga en el almacenamiento de la red, pero los mapas de calor terminados para la regi√≥n de Mosc√∫ y la regi√≥n vecina de la Regi√≥n de Mosc√∫ no se correlacionan con el mapa de calor terminado de la regi√≥n combinada de Mosc√∫ y Regi√≥n ( debido al hecho de que muchos viven en la regi√≥n y trabajan en Mosc√∫), y todav√≠a no sabemos de antemano qu√© regi√≥n necesitaremos.  Tal vez ni Mosc√∫, ni Regi√≥n de Mosc√∫, sino solo alguna Ciudad 17.  Es muy costoso conducir la heur√≠stica y calcular indicadores para todos los conjuntos de datos. <br><br>  Como resultado, debemos seleccionar r√°pidamente un subconjunto de los conjuntos de datos acumulados, implementar r√°pidamente una granja de c√≥mputo que sea adecuada para la energ√≠a, realizar r√°pidamente un proceso de c√°lculo √∫nico pero estandarizado, escupir el resultado y ... quiz√°s nunca m√°s volver a un subconjunto o una granja de este tama√±o , no a la plantilla.  Y no podemos mantener un cl√∫ster de rendimiento bien ajustado en nuestro propio hardware, que cubrir√≠a las necesidades de todos nuestros proyectos, desde el m√°s peque√±o hasta el m√°s dif√≠cil, ya que son demasiado diferentes. <br><br>  No creo que seamos tan √∫nicos.  En conversaciones con colegas, surge regularmente la necesidad de instrumentaci√≥n de casos de <abbr title="Babah !, gran boom, flash, explosi√≥n de ametralladora, etc.">estallido</abbr> similares, pero aqu√≠ todos construyen el proceso a su manera.  Por lo general, las soluciones para casos no est√°ndar se unen al transportador existente desde los enfoques No. 1 o No. 2 en el lateral;  nuestro proceso consiste completamente en proyectos privados, tenemos todas las tareas como "burst". <br><br>  Bien ahora.  Durante dos a√±os y un centavo, pudimos encontrar un kit de herramientas para automatizar mi trabajo tanto como sea posible, y es precisamente esto lo que presentar√© para uso general en la tercera parte de mi historia.  Mientras tanto, hablemos sobre la evoluci√≥n, y todos esos errores y problemas, corrigiendo y resolviendo que hemos llegado a un proceso sostenible por experiencia. <br><br><h3>  Prototipo en C # y PostGIS </h3><br>  Todo comenz√≥ hace unos a√±os.  Dos tipos muy inteligentes llamados <a href="https://www.forbes.ru/tehnologii/336439-na-kletochnom-urovne-kak-zarabatyvat-na-sinteze-marketinga-i-biologii">Alexei Polyakov y Alexei Polyakov</a> , no se r√≠an, en realidad son hom√≥nimos, pero de diferentes partes del mundo, un bi√≥logo y un vendedor, decidieron aplicar el m√©todo de la disertaci√≥n sobre el comportamiento colectivo de las poblaciones celulares en cultivos celulares, probado experimentalmente hasta ratones , a publicidad y marketing. <br><br>  Funcion√≥ en las personas. <br><br>  Y luego surgi√≥ el proyecto Locomizer.  Digo "proyecto" porque es como una startup con una <abbr title="Ltd., solo en Londres">LLC</abbr> para celebrar contratos, pero no del todo.  Los miembros de nuestro equipo est√°n dispersos por todo el mundo, trabajan en diferentes lugares y oficinas como aut√≥nomos o subcontratistas (y no todos a tiempo completo), y utilizamos nuestros algoritmos para clientes muy diferentes con diferentes modelos de interacci√≥n a medida que recibimos o encontramos pedidos.  Hay suscripciones, pero m√°s tareas privadas de una sola vez. <br><br>  Pero eso es ahora.  Y hace unos a√±os, todo era a√∫n m√°s ca√≥tico.  Quien escribi√≥ la primera implementaci√≥n de software para calcular la velocidad, generalmente no lo s√©.  (Si de repente conoces a estos h√©roes desconocidos, sal√∫dalos). Al final de mi √∫ltimo <a href="https://habr.com/ru/post/437610/">art√≠culo</a> sobre la carrera de un programador en una ciudad en particular, escrib√≠ literalmente lo siguiente: "Vine a hablar al lugar donde trabajo ahora, y el primer ministro declar√≥ desde el umbral que El proyecto es infernal.  Nada  Nuevamente, SIG, solo los c√°lculos se basan en MapReduce (y lo quiero en Spark), mapas en ArcGIS, y todo esto gira en nubes que nadie puede idear.  En mi opini√≥n, ¬°una gran opci√≥n! ‚Äù, En ese momento ya era as√≠, y solo puedo restaurar la primera etapa del desarrollo del proyecto en c√≥digo a partir de los recuerdos de <a href="https://habr.com/ru/users/mitra_kun/" class="user_link">mitra_kun</a> , que apareci√≥ en el proyecto solo un a√±o antes. <br><br>  Las heur√≠sticas rudimentarias para procesar conjuntos de datos sin procesar se escribieron en PHP, Python y C ++, y el c√°lculo principal de la velocidad para el mapa de calor se realiz√≥ mediante un programa en C #. <br><br><img src="https://habrastorage.org/webt/ni/yp/qc/niypqcxxu3ugnbt1mx16ecnuhds.png" alt="Todo el proyecto en C #" title="Todo el proyecto en C #" align="right"><br><br>  Ella trabaj√≥ as√≠: <br><br><ol><li>  Primero, leemos directamente la cadena en la matriz del archivo del conjunto de datos. </li><li>  Ejec√∫talo para siempre, construye una tabla hash en polzakz. </li><li>  La base de POI es una tabla literal en una base de datos PostgreSQL con campos PostGIS de tipo GEOMETRY, y para calcular la distancia entre cada se√±al de usuario y cada POI, la funci√≥n ST_DISTANCE se <a href="https://postgis.net/docs/ST_Distance.html">extrae a</a> trav√©s de un peque√±o <a href="https://postgis.net/docs/ST_Distance.html">almacenamiento</a> , el resultado se agrega a una tabla hash con una clave para cada usuario. </li><li>  Luego hacemos foreach en la tabla con la acumulaci√≥n del resultado del puntaje de inter√©s para cada clave en la matriz. </li><li>  Una vez m√°s, grupo, para cada categor√≠a. </li><li>  Despu√©s del final del c√°lculo, que toma completamente de un par de horas a una semana, el resultado se agrega al archivo CSV ... </li><li>  ... y luego a√∫n se procesa manualmente, se superpone en el mapa y se visualiza en <a href="https://desktop.arcgis.com/ru/">ArcGIS</a> . </li></ol><br>  Est√° claro que el volumen m√°ximo procesado est√° limitado por la memoria disponible en la m√°quina, y la velocidad de las consultas individuales a la base de datos provoca una cierta alarma. <br><br><h3>  Primer acercamiento a Hadoop MapReduce </h3><br>  Se calcul√≥ algo sobre el prototipo local, se prob√≥ la idoneidad de los tratamientos aplicados para preparar conjuntos de datos y construir mapas de calor, y surgi√≥ la pregunta de c√≥mo poner el trabajo en marcha.  Bueno, es importante no tratar la puesta de sol manualmente, sino usar las capacidades de alguna plataforma, preferiblemente escrita por ballenas de la industria, y escalar al menos al m√≠nimo. <br><br>  Como dije, la plataforma est√°ndar de procesamiento de big data es el ecosistema Hadoop.  Un gran conjunto de bibliotecas heterog√©neas, que incluyen un sistema de archivos distribuido, planificadores para tareas paralelas, abstracciones relativamente convenientes sobre reducci√≥n de mapas, motores para ejecutar consultas e incluso un mont√≥n de cosas para el an√°lisis de datos.  Y toda esta infraestructura de software est√° disponible en la nube de diferentes proveedores en forma de paquetes integrados, y se automatizar√°, pero m√°s sobre eso m√°s adelante. <br><br>  Ok Google, busca Hadoop.  Mis predecesores tomaron el prototipo y reescribieron el c√°lculo principal de C # a Java, reemplazando literalmente todo foreach con el correspondiente Mapper y Reductor Hadup, y tomaron todos los pasos para preparar y enriquecer conjuntos de datos en utilidades separadas en lenguajes de scripts para que se desarrollen m√°s r√°pido, porque con el advenimiento de diferentes Los algoritmos de los clientes comenzaron a evolucionar activamente.  Por separado, comenzamos a escribir un back-end para la interfaz de usuario web en Spring (no es la mejor soluci√≥n, si no hay experiencia previa en el desarrollo de Java, ser√≠a mejor escribir en PHP), con un frente en Node.js con integraci√≥n de mapas de ArcGIS. <br><br><img src="https://habrastorage.org/webt/oq/i3/ye/oqi3yehxn8ybmjbh0j1g0f4sqj4.png" alt="Una peque√±a parte de un proyecto Java." title="Una peque√±a parte de un proyecto Java." align="left"><br><br>  Levantaron el "gran grupo" de Hadoop en cinco m√°quinas virtuales en Microsoft Azure para este caso.  Por que Azure  En primer lugar, para las startups hay un gran descuento durante los primeros a√±os.  En segundo lugar, ArcGIS Desktop para Windows para la visualizaci√≥n de mapas ya estaba implementado en esta nube. <br><br>  El cl√∫ster de Hadoop se implement√≥ manualmente, y no desde el servicio Azure HDInsight correspondiente, que era dif√≠cil de configurar.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cada una de las m√°quinas de cl√∫ster, plantearon Postgre + PostGIS (una decisi√≥n bastante dudosa, porque MR y la base est√°n comenzando a competir por el procesador), para no recorrer distancias a un servidor separado. Creamos un peque√±o script que dispers√≥ las r√©plicas de la base de datos de POI en los nodos del cl√∫ster. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El proyecto segu√≠a siendo un prototipo, solo un poco m√°s avanzado. PostGIS todav√≠a se us√≥ porque apareci√≥ geofencing, y los muchachos a√∫n no sab√≠an c√≥mo se podr√≠a implementar con un trabajo m√≠nimo. Parec√≠a que todo era terriblemente lento, y la cantidad de pasos que deb√≠an hacerse manualmente exced√≠a una docena y media.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fue en ese momento cuando me interes√≥ la propuesta de un poco conocido en nuestra peque√±a pero muy TI ciudad (en Izhevsk hay m√°s de siete docenas de oficinas con personal de desarrollo, donde trabajan unos tres mil programadores), una oficina con un nombre absolutamente gen√©rico "Tecnolog√≠as de la informaci√≥n rusa", que De repente, sin ninguna raz√≥n, se necesit√≥ un Desarrollador Java Senior con amplia experiencia en implementaci√≥n y automatizaci√≥n, y al menos escuch√≥ del o√≠do sobre Big Data y las nubes. Bueno, cuando escuch√© un poco sobre nubes y big data. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cuanto a todo lo dem√°s, tengo m√°s que suficiente experiencia :( Por lo tanto, lo primero que dije cuando vi el c√≥digo y el estado de los procesos fue en las mejores tradiciones de Artemy Lebedev, en voz alta y mucho. No lo repetir√©.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, si el c√≥digo y los procesos son de una calidad comprensible, definitivamente tienen un lugar para la optimizaci√≥n. Para empezar, al menos puede enviar solicitudes a PostGIS de una en una, pero en lotes, alrededor de 5000 puntos a la vez. Las bases de datos est√°n, por regla general, bien optimizadas para la resoluci√≥n de productos cartesianos. Se dice que, hecho, el almacenamiento con la llamada ST_DISTANCE se reescribi√≥ de tal manera que devuelva inmediatamente una gran matriz para un paquete de puntos, y desde cero el c√°lculo se aceler√≥ de inmediato 40 veces, porque ahora no era necesario establecer una conexi√≥n a la base de datos con tanta frecuencia, y tantos √≠ndices en geometr√≠a en la tabla con POI comenz√≥ a trabajar con gran sentido.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es cierto que un desagradable error esot√©rico se introdujo directamente en el c√°lculo, debido al hecho de que el prototipo no se transfiri√≥ completamente de C # a Java. Los chicos no entendieron el punto de una variable importante, y el TK formal en el prototipo no los alcanz√≥ en absoluto, perdi√≥ en alg√∫n lugar del camino. Luego restauramos todos los algoritmos a partir de descripciones fragmentarias, pero esto ya fue mucho m√°s tarde. Sin embargo, este error en su conjunto no estrope√≥ el resultado del c√°lculo, simplemente redujo el contraste del mapa de calor.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero no obtendr√° mucho rendimiento de MapReduce, porque el asignador lee los datos de HDFS y los escribe de nuevo, y el siguiente reductor en la cadena hace lo mismo, y as√≠ sucesivamente hasta que se completen todos los pasos. </font><font style="vertical-align: inherit;">Tambi√©n es muy inconveniente administrar un proceso de varios pasos, especialmente si el algoritmo tiene ramas debido a la configuraci√≥n. </font><font style="vertical-align: inherit;">Todo el algoritmo es un c√≥digo r√≠gido, y si desea reordenar los pasos de alguna manera, debe moverlos a m√≥dulos separados con su propio lanzador y envolver alg√∫n tipo de l√≥gica en el exterior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, sacar PostGIS del c√°lculo, incluso si duplica la base de datos en cada nodo del cl√∫ster, sigue siendo una idea muy dolorosa.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El advenimiento de CI y Spark </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ¬°Automat√≠zalo! - mi segundo gran </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de inter√©s rofessionalny despu√©s enterprayznogo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rogrammirovaniya en un sapo ... Y no. En segundo lugar - es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> itstsa, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asta y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> udingi, entonces que haya una tercera - es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> procesos y su automatizaci√≥n. (Yo, como </font><font style="vertical-align: inherit;">chef </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ovar, me encanta que todo est√© en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hashtag # </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cookies).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El trabajo manual conlleva demasiados peligros. Las personas no son confiables y a menudo cometen errores, incluso si hacen lo mismo, por lo que es mucho m√°s eficiente pasar un tiempo formalizando el flujo general del proyecto y escribiendo un script que no fallar√° al llamar a la utilidad para copiar el conjunto de datos del almacenamiento a largo plazo al en l√≠nea, y no mezclar√° el orden de los pasos, que seguir caminando el rastrillo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La caminata con rake fue el problema m√°s serio que primero ten√≠a que resolverse. Primero, lo implement√© en un peque√±o equipo virtual </font></font><a href="https://www.jetbrains.com/teamcity/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y configur√≥ el ensamblaje con la ejecuci√≥n de todas las pruebas para que el artefacto verificado est√© siempre a mano y no sea necesario lanzarlo al cl√∫ster manualmente. El segundo paso fue escribir un contenedor para comenzar una tarea de MR con el conjunto de datos y el conjunto de par√°metros especificados en el cl√∫ster directamente desde el mismo TC, con la misma copia autom√°tica de los conjuntos de datos originales en el cl√∫ster y los resultados del c√°lculo en el almac√©n de resultados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y el tercer paso, que tom√≥ mucho tiempo por costumbre, fue automatizar la implementaci√≥n del cl√∫ster, ajustar sus par√°metros e iniciar el c√°lculo en un conjunto de datos integrado en Azure Blob Storage. De repente, hubo proyectos para los que comenz√≥ a perderse un grupo est√°tico de cinco m√°quinas virtuales y / o cuyos conjuntos de datos no se deben mezclar con un volcado de archivos antiguos en HDFS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Azure HDInsight es en realidad</font></font><a href="https://www.cloudera.com/downloads/hortonworks-sandbox/hdp.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hortonworks HDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (descanse en paz para √©l), y algunos de sus ajustes se realizan en la API, y algunos solo se pueden registrar a trav√©s de </font></font><abbr title="Interfaz de usuario web para configurar, espeluznante como cualquier interfaz de usuario web de empresa"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ambari</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La implementaci√≥n de un cl√∫ster en funci√≥n de la carga de la nube puede llevar hasta una hora, y el ciclo de ajuste, es decir, verificar el efecto de cualquier conjunto de configuraciones en el rendimiento de nuestro c√≥digo, puede llevar todo un d√≠a. </font><font style="vertical-align: inherit;">La versi√≥n local de HDP Sandbox en la m√°quina virtual consume 11 gigas de RAM, y es monstruosamente exigente en el subsistema de disco, por lo que incluso la depuraci√≥n local es extremadamente desagradable, y su configuraci√≥n es ligeramente diferente de la versi√≥n en la nube. </font><font style="vertical-align: inherit;">Dediqu√© mucho tiempo a los experimentos, pero al menos descubr√≠ c√≥mo funciona todo y qu√© hacer si el c√°lculo de repente se queda en el medio con el siguiente OOM, porque tambi√©n es bastante desagradable analizar los registros manualmente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mientras trabajaba con HDP, otro programador comenz√≥ a unificar las etapas dispares de preparar conjuntos de datos en Apache Spark. Spark resolvi√≥ el problema de escribir / leer constantemente datos intermedios que ocurren entre los pasos de un c√°lculo, y en general, se dise√±√≥ teniendo en cuenta todos los lugares malos de la RM, y puede hacerlo muchas veces m√°s de forma inmediata. Y el perezoso </font></font><abbr title="Conjunto de datos distribuidos resilientes, una estructura de datos con excelentes propiedades alrededor de las cuales se construye Spark"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RDD de</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Spark </font><font style="vertical-align: inherit;">es algo muy √∫til. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al mismo tiempo, escrib√≠ una secuencia de comandos de Azure Templates en PowerShell para configurar el nodo perimetral para PostGIS, una instancia separada de nariz gruesa en el cl√∫ster, con un mont√≥n de n√∫cleos y memoria para acelerar las solicitudes, as√≠ como una serie de pasos preliminares para preparar conjuntos de datos, que primero se colocaron en su disco local, y luego cargado en HDFS en el cl√∫ster.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, el enlace del script, que inicialmente pens√≥ que funcionar√≠a tanto de manera interactiva como por lotes en TC como una compilaci√≥n separada, aprendi√≥ gradualmente a ejecutar una combinaci√≥n arbitraria de pasos en MR, Spark y otros paquetes de software que no utilizamos desde el paquete HDInsight, pero todav√≠a con parametrizaci√≥n rudimentaria. Sin embargo, transferir los par√°metros de compilaci√≥n a un repositorio vecino con un conjunto de archivos .ini (para cada componente de la plataforma y para cada paso del proceso), y mantener las plantillas de proceso en las ramas de este repositorio result√≥ ser una pr√°ctica tan conveniente que todav√≠a lo usamos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya progreso. Con la automatizaci√≥n de una rutina manual, el tiempo de preparaci√≥n para el c√°lculo se redujo cuatro veces, sin mencionar los errores humanos, que se redujeron mucho. Pero a√∫n no es el momento del c√°lculo en s√≠.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tercera aproximaci√≥n en GeoSpark </font></font></h3><br>  Tard√≥ unos seis meses.  En este momento, un conjunto de heur√≠sticas depuradas y probadas se hab√≠a acumulado gradualmente, ya con aplicaciones separadas en Spark, y no con scripts, y se desarrollaron algunas plantillas de proceso t√≠picas.  Ahora era necesario optimizarlos. <br><br>  El segundo programador, que no ten√≠a experiencia previa ni en un equipo ni en una empresa, actu√≥ con sus m√≥dulos de manera bastante directa: despu√©s de completar la transferencia de una heur√≠stica a Spark, simplemente copi√≥ todo el proyecto y comenz√≥ a reemplazar el antiguo algoritmo con el nuevo.  Como resultado, cuando hab√≠a ocho de esos m√≥dulos paralelos, cada uno con un conjunto de par√°metros similar pero ligeramente diferente, un poco de excelente sem√°ntica de llamadas, y tambi√©n una gran cantidad de c√≥digo de servicio duplicado, comenzaron a plantear otro problema.  Cuanto m√°s c√≥digo, m√°s tiempo se dedica a su soporte, especialmente si no deja de evolucionar todo este tiempo.  Y debido a la constante copiar y pegar, los par√°metros no utilizados y otra basura comenzaron a acumularse en ellos. <br><br>  Una vez que termin√© con el problema de la automatizaci√≥n y me ocup√© de la configuraci√≥n de los cl√∫steres, ahora ya pod√≠a retomar los m√≥dulos de preparaci√≥n de datos y la heur√≠stica.  Para empezar, tom√© todo el c√≥digo que se repite en un proyecto separado de Commons, enchufado como un <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">subm√≥dulo git</a> , y en los m√≥dulos de c√°lculo se convirti√≥ en varias veces menos un desastre.  Reun√≠ una plantilla para una heur√≠stica t√≠pica, y ya surgi√≥ un nuevo proyecto, sin la necesidad de reemplazar piezas de c√≥digo y sin suciedad innecesaria en la historia de los commits.  El desarrollo comenz√≥ a ser m√°s r√°pido. <br><br>  El siguiente gran problema a ser derrotado provino de la l√≥gica de calcular las se√±ales de producto cartesiano √ó POI. <br><br>  Solo el procesamiento por lotes lo transfiere a la base de datos, pero no reduce el n√∫mero de operaciones, incluso si la base de datos utiliza efectivamente √≠ndices y optimizaci√≥n de consultas.  Ser√≠a l√≥gico no considerar la distancia para esos pares donde obviamente excede el umbral que necesitamos.  Pero, ¬øc√≥mo descartar pares con una distancia mayor que el umbral sin calcular esta distancia? <br><br>  Respuesta: <abbr title="Tal como se aplica a Spark: dividir RDD en partes, por qu√© no deja de ser un todo √∫nico, sino que puede procesarse en pedazos">particione</abbr> las se√±ales y los PDI en una cuadr√≠cula geom√©trica. <br><br>  Adem√°s, el mapa de calor ya consiste en una cuadr√≠cula de pol√≠gonos.  Y si selecciona el tama√±o de celda de esta cuadr√≠cula de la manera correcta, entonces para cada PDI del pol√≠gono seleccionado es bastante posible limitarnos a calcular las distancias a las se√±ales que caen en el mismo pol√≠gono, sus celdas vecinas, y eso es todo.  El resto puede descartarse; ciertamente quedar√°n fuera de los l√≠mites de relevancia. <br><br>  Spark ya tiene una herramienta preparada para trabajar con redes: <abbr title="No voy a dar un enlace. La calidad de este proyecto es demasiado deprimente para m√≠ :(">GeoSpark</abbr> .  El segundo programador comenz√≥ a usarlo y apareci√≥ la operaci√≥n preliminar "arrastrar el conjunto de datos a la red".  Pero no mejor√≥ mucho, un problema grave fue reemplazado por otro problema grave. <br><br>  Ahora bien, este era el problema de la "cola larga": usuarios, en los que el n√∫mero de se√±ales es de millones.  No hay tantos, pero si se acumulan en el centro de la ciudad, donde el POI es alto, y se acumulan all√≠, por suerte, entonces no importa c√≥mo particiones en geometr√≠a (al menos <a href="https://en.wikipedia.org/wiki/Voronoi_diagram">Voronoi</a> , al menos <a href="https://en.wikipedia.org/wiki/Quadtree">quadtree</a> ), todav√≠a habr√° pol√≠gonos donde el n√∫mero de comparaciones excede una cantidad razonable.  Pero tambi√©n debe verificar los pol√≠gonos vecinos donde la densidad es tan alta. <br><br>  Y si el 99% de las particiones con pol√≠gonos de baja saturaci√≥n funcionan r√°pidamente, entonces el 1% de las estaciones de trabajo de Spark con c√©lulas de alta densidad contin√∫an colgando a la victoria, comen memoria como si estuvieran inconscientes y estropean todas las frambuesas.  Spark est√° tratando de tener todo en mente, y si hay una fuerte variaci√≥n en el tama√±o de las particiones en RDD, entonces todo el ajuste para el consumo de memoria vuela por el desag√ºe, porque tiene que hacerse para el m√°s grande. <br><br>  Result√≥ que el 99% del c√°lculo se aceler√≥ con particiones geom√©tricas cientos de veces, y el 1% de la cola larga redujo la optimizaci√≥n completa a casi nada. <br><br>  En general, la transici√≥n a GeoSpark produjo una ganancia de cinco veces, pero solo en el tama√±o de los ejecutores que eran muy ineficientes en la memoria y, en consecuencia, los cl√∫steres con m√°quinas virtuales costosas.  En resumen, la partici√≥n geom√©trica para geodatos de alta densidad result√≥ ser un callej√≥n sin salida. <br><br>  Y luego hubo felicidad en la persona del escritorio anal√≠tico de una de las mayores telecomunicaciones japonesas.  Una peque√±a empresa subsidiaria basada en datos de geolocalizaci√≥n recopilados por la empresa principal. <br><br><h3>  Analistas japoneses y migraci√≥n de Azure a AWS </h3><br>  Los japoneses tienen una mentalidad interesante.  Ellos mismos no tienen prisa, pero si solo se les da un gaijin para morderse el dedo, ambas manos se cortan.  ¬°Nunca le des a los japoneses fechas espec√≠ficas!  Y si llama, tome al menos tres veces el suministro.  Ser√° monstruosamente largo y dif√≠cil coordinar los t√©rminos de referencia, y no solo la famosa meticulosidad japonesa interferir√°, sino tambi√©n la diferencia de pensamiento.  Puede que simplemente no quede tiempo para implementar la versi√≥n final de los TOR. <br><br>  El proyecto para integrarse con la "hija" de las telecomunicaciones japonesas casi mata a nuestro proyecto.  Las perspectivas brillaban para convertirse en un proveedor exclusivo de datos para el loco mercado publicitario japon√©s, y el negocio es un poco ... eh, puedo hacerlo sin comentarios. <br><br>  En primer lugar, no Azure.  Solo AWS, solo hardcore. <br><br>  En segundo lugar, el frente deb√≠a modificarse para satisfacer sus necesidades, que cambiaban constantemente a lo largo del proyecto.  Los especialistas en marketing de esta oficina constantemente quer√≠an algo que ellos mismos no sab√≠an exactamente y que realmente no pod√≠an articular, y tuvo que rehacerse diez veces por etapa, cambiando la l√≥gica de c√°lculo para los pr√≥ximos nuevos indicadores sobre la marcha. <br><br> <a href=""><img src="https://habrastorage.org/webt/3n/oy/y1/3noyy1wt6pjuqik6ukzfnmcmy9a.png" alt="Pido disculpas por la calidad, una captura de pantalla del informe de error, no quedan m√°s" title="Pido disculpas por la calidad, una captura de pantalla del informe de error, no quedan m√°s"></a> <br><br>  En alg√∫n momento, me asust√© un poco e hice un conjunto de "operaciones elementales", unas 15 acciones primitivas en RDD con llamadas a m√©todos b√°sicos como uniones, mapeo, anotaciones de valores predeterminados, suma de valores de columna, y otras operaciones peque√±as de este tipo, para que r√°pidamente cambia la l√≥gica de la cadena de c√°lculo, como si fuera un conjunto de sentencias SQL. <br><br>  (Regular Spark SQL no es aplicable en nuestro caso debido al hecho de que no hay una escritura estricta o un conjunto estricto de campos. En el conjunto de datos, en cualquier momento puede agregar tantos campos adicionales como desee, y cambia durante el flujo del proceso Es muy dif√≠cil prescribir metadatos en condiciones que cambian constantemente). <br><br>  La tarea de alto nivel era esta: elegir una regi√≥n arbitraria de Jap√≥n y construir un mapa de calor durante un per√≠odo de tiempo arbitrario utilizando un conjunto arbitrario de categor√≠as con un mont√≥n de indicadores para el vertedero.  ¬øQu√© tipo de indicadores, c√≥mo contarlos? El cliente mismo no entendi√≥ realmente esto. <br><br>  El conjunto de datos de prueba (es decir, peque√±o) con se√±ales de usuario para 2016-2017, en el que tuvimos que resolver la tecnolog√≠a, son 5 terabytes de datos, 14,000,000,000 de registros.  Solo en Tokio, hay varios millones de puntos de inter√©s, y en la red en la regi√≥n de Hokkaido, 1,600,000 c√©lulas. <br><br>  Y las tarjetas para las dos mil categor√≠as para cada una de las 47 perfecciones japonesas deben considerarse "sobre la marcha", ya que deben venderse como un servicio en la nube. <br><br>  Una gran tarea para romper el cerebro.  En alg√∫n lugar tres o cuatro √≥rdenes de magnitud m√°s altas que nuestras capacidades en t√©rminos de "velocidad de c√°lculo" y "volumen de datos". <br><br>  Despu√©s de entristecernos, decidimos hacer un c√°lculo previo para cada regi√≥n (gracias a los dioses sinto√≠stas, los japoneses no necesitaron unir las regiones) y un mes para que el mapa de calor se construyera de acuerdo con los puntajes previamente preparados.  No lo deje en tiempo real, sino unos minutos o decenas (para el centro de Tokio) minutos.  El c√°lculo previo tom√≥ varios meses con grupos de 25 de las m√°quinas virtuales m√°s potentes disponibles en la regi√≥n de Tokio AWS. <br><br>  Pero para ejecutar en AWS, primero ten√≠a que reescribir la automatizaci√≥n bajo la API de AWS.  Y diferentes nubes, aunque ofrecen servicios similares desde el exterior, son internamente completamente diferentes.  Es bueno que en este momento PowerShell ya haya alcanzado la versi√≥n 6 del candidato de lanzamiento, y los scripts de enlace de Azur para implementar el cl√∫ster y ejecutar el c√°lculo podr√≠an ser portados y ejecutados audazmente en Linux TeamCity (porque implementar servidores en Windows en AWS es una idea )  M√°s precisamente, no porte, pero abra una secuencia de comandos existente en un monitor y escriba una implementaci√≥n paralela para otra nube en el segundo. <br><br>  Adem√°s, AWS es mucho m√°s antiguo y, por lo tanto, m√°s arcaico que Azure, es arquitect√≥nico y hay mucho m√°s trabajo manual para configurar el nivel inferior de infraestructura.  Y la subasta local para la venta de recursos inform√°ticos agrega un dolor de cabeza cuando es posible que no tenga los autom√≥viles del tama√±o correcto al precio deseado, y el cliente no asigne un presupuesto para el c√°lculo completo del precio. <br><br>  Pero el ecosistema Hadoop en s√≠ mismo en la encarnaci√≥n amaz√≥nica, EMR, est√° m√°s cerca de la vainilla, y trabajar con √©l es m√°s f√°cil que con HDInsight.  Bueno, al menos con algo result√≥ ser m√°s f√°cil. <br><br>  Pero no con S3.  Aqu√≠ los problemas salieron de donde no esperaban.  S3 tiene l√≠mites indocumentados.  Por ejemplo, en un cubo no puede haber m√°s de ~ 11,000,000 de objetos, porque en alg√∫n lugar de las profundidades de la API hacen la clasificaci√≥n de claves en orden lexicogr√°fico para cada (¬°cada!) Solicitud, y el b√∫fer asignado para ello simplemente no permite la clasificaci√≥n m√°s l√≠neas, especialmente si son largas.  Para acelerar el c√°lculo, no fusionamos particiones al final, y en alg√∫n momento nos topamos con este l√≠mite, despu√©s de lo cual el proceso simplemente se detuvo. <br><br>  Seg√∫n la mente, la fusi√≥n debe hacerse, e incluso hay una herramienta: la utilidad s3-dist-cp, pero su uso es un dolor de cabeza por separado.  Los depredadores para extraterrestres escribieron la utilidad con seguridad, se comporta de manera tan intuitiva.  Y tiene un defecto fatal: bajo el archivo combinado, necesita tanto espacio en HDFS como todos los originales.  Y fusionar decenas de miles de archivos de partici√≥n de cientos de bytes a decenas de megabytes de tama√±o, distribuidos en un grupo de 25 m√°quinas, durar√° mucho tiempo. <br><br>  Sin embargo, ya con un mill√≥n de objetos en el dep√≥sito, S3 comienza a trotar silenciosamente las solicitudes.  Y en condiciones de consistencia eventual, esto generalmente es un desastre: Spark, sin esperar al siguiente escritorio el n√∫mero acordado de veces, puede caer.  Hay una soluci√≥n: usar el complemento de Amazon propiedad de EMRFS, pero funciona por encima de DynamoDB, y esto es algo muy costoso.  Y con sus propios l√≠mites en el n√∫mero de solicitudes por segundo. <br><br>  En resumen, en condiciones de falta total de tiempo, decidimos volver al esquema est√°tico: implementar un cl√∫ster permanente en instancias de un tama√±o bastante peque√±o (aunque costoso, pero m√°s barato que DynamoDB), fusionar todos los terabytes de los conjuntos de datos originales y calculados en HDFS en √©l, y leer las tarjetas localmente. <br><br>  Pero el siguiente giro de la trama fue la demanda japonesa de cambiar de la cuadr√≠cula hexagonal generada a <abbr title="No volver√© a dar un enlace, no encontrar√° informaci√≥n sobre esta cuadr√≠cula en japon√©s, y ning√∫n traductor en l√≠nea puede hacer frente a este documento normalmente. Nuestro Tokio Alexei Polyakov es japon√©s, pudo traducir de alguna manera">Japan Mesh</abbr> , el m√©todo est√°ndar para ellos de la divisi√≥n geogr√°fica con celdas rectangulares que dependen solo de las coordenadas del punto.  Una cosa muy buena, ya que le permite abandonar el paso computacionalmente pesado de "tirar de se√±ales a la red". <br><br>  La desventaja es que la malla de malla de Jap√≥n solo es aplicable a Jap√≥n y a los territorios insulares que hist√≥ricamente afirma ser, pero no al resto del mundo.  Pero al menos para los japoneses fue posible abandonar el lento GeoSpark y dividir las se√±ales de manera uniforme sin referencia a la geometr√≠a externa.  Y con la partida de la "cola larga", el c√°lculo inmediatamente se aceler√≥ nuevamente una vez m√°s a las 10. <br><br>  Es desafortunado que esto sucedi√≥ despu√©s de que todos descubrimos los hex√°gonos, gastando mucho dinero y tiempo en vano.  Un grupo con terabytes de conjuntos de datos preparados tuvo que ser simplemente desechado. <br><br>  Y en cualquier caso, en alg√∫n lugar en el medio del trabajo, los japoneses a√∫n pidieron transferir toda la infraestructura de una cuenta de AWS a otra.  Y como si no le importara todo el trabajo realizado en la configuraci√≥n.  Bueno, logr√© hacer un script para la plantilla CloudFormation en el momento de la transici√≥n, por lo que la migraci√≥n fue m√°s o menos fluida. <br><br>  Como la cereza final del pastel, los japoneses finalmente decidieron que el frente no se rindi√≥ a ellos, y sacar√≠an los c√°lculos manualmente a pedido de sus clientes, as√≠ que gracias a nosotros por los algoritmos (por primera vez los documentamos en detalle y encontramos algunos errores), y por ahora.  Bueno ... buena suerte y hasta luego. <br><br>  Brrr  Recuerdo este proyecto con horror y un estremecimiento. <br><br><h3>  Ash Nazg Durbatuluk, Ash Nazg Gimbatul, Ash Nazg Trakatuluk, Ag Burzum Ishi Krimpatul !! </h3><br>  Pero desde el punto de vista positivo, adem√°s de documentar todos los algoritmos, tambi√©n hubo mejoras generales. <br><br>  Aprendimos un estudiante en Java Junior, y realiz√≥ un estudio de un mont√≥n de bibliotecas geogr√°ficas, como resultado de lo cual finalmente logr√≥ elegir la correcta y descartarla del entorno PostGIS. <br><br>  Los intentos anteriores no tuvieron √©xito debido a la poca precisi√≥n.  En el radio de tres kil√≥metros, los Haversins nos dan un error ya notable, y la mayor√≠a de las bibliotecas que intentamos tomar desde el principio eran p√©simas en las latitudes al norte de San Petersburgo, como resultado de las cuales aparecieron agujeros o doble superposici√≥n en la cuadr√≠cula.  Y los finlandeses somos clientes frecuentes, por lo que es fundamental que todo funcione correctamente en sus latitudes. <br><br>  Hasta que descubrimos que necesit√°bamos una lib con un geoide normal (preferiblemente el mismo que en PostGIS, WGS84), los resultados no coincid√≠an con los resultados esperados.  Pero despu√©s de cambiar a GeographicLib, se elimin√≥ el cuello de botella en forma de conexiones Postgre, y la etapa final de c√°lculo de la velocidad se aceler√≥ 40 veces.  Golovnyak se fue con la configuraci√≥n adicional de una instancia RDS separada debajo de la base y carg√≥ un volcado con POI, que se traslad√≥ a los conjuntos de datos habituales en S3.  ¬°Unificaci√≥n! <br><br>  Al mismo tiempo, el mismo estudiante desenterr√≥ y corrigi√≥ el error que causaba que las tarjetas parecieran m√°s p√°lidas de lo que realmente eran.  Bueno, cuando hay una tarea sin l√≠mites de tiempo, envidio a los estudiantes. <br><br>  Otro punto importante.  Una vez, por en√©sima vez, mirando secuencias de comandos vinculantes que llaman un m√≥dulo Spark tras otro, pens√©, pero ¬øcon qu√© tipo de demonio los cortocircuitamos? <br><br>  ¬øPor qu√© guardar resultados intermedios cada vez en S3 o HDFS, si el RDD final del m√≥dulo anterior puede simplemente ser redirigido a la entrada del siguiente en la cadena?  Apenas dicho que hecho, MetaRunner fue escrito en un par de horas.  La presencia de bienes comunes ayud√≥ mucho en esto, los m√≥dulos estaban bastante estandarizados para entonces, especialmente porque los par√°metros de cada uno de los m√≥dulos ya estaban en las mismas tareas.ini, con prefijos de teclas correspondientes a sus nombres. <br>  Su atenci√≥n se presenta con un diagrama de bloques de un mapa (el paso final antes de emitir al frente, pero no la versi√≥n final), escrito en operaciones elementales: <br><br> <a href=""><img src="https://habrastorage.org/webt/al/ke/4h/alke4hk9txojjq8j8lwauoihvqs.png" alt="Diagrama de flujo del proceso de preparaci√≥n del mapa de calor" title="Diagrama de flujo del proceso de preparaci√≥n del mapa de calor"></a> <br><br>  Si se deshace de 24 llamadas intermedias a HDFS, espec√≠ficamente este c√°lculo se acelera unas 50 veces. <br><br>  Pero, ¬øqu√© sucede si agrega soporte variable a la plantilla de proceso para que no tenga que regenerar task.ini cada vez que cambie los par√°metros en la Tienda de propiedades? <br><br>  - Ash Nazg!  Grit√©  Los colegas se miraron perplejos.  Un tipo tiene un techo debido a estos japoneses, pero bueno, sucede. <br>  "Ash nazg ... burzum-ishi krimpatul", gru√±√≠ gru√±endo (no funcion√≥ muy bien), y fui al primer ministro para discutir la fusi√≥n de los 15 (el n√∫mero de heur√≠sticas y servicios auxiliares estaba creciendo gradualmente) de los m√≥dulos de c√°lculo en un solo repositorio. <br><br>  Si cortocircuitamos los m√≥dulos entre s√≠, entonces no trabaje m√°s con el revestimiento de todos los JAR individuales en el classpath de la chispa, y deje que todo el paquete de la l√≥gica Locomizer patentada (y nuestras operaciones auxiliares) se ensamblen en un JAR gordo.  Al mismo tiempo y localmente, ahora ser√° posible ejecutarlo sin un cl√∫ster.  Y lo que es importante, la l√≥gica para analizar tareas.ini se puede transferir desde enlaces de PowerShell a c√≥digo Java, donde la sustituci√≥n de variables es mucho m√°s simple. <br><br>  Colegas que relinchan sobre la propuesta de llamar al proyecto "El anillo de la omnipotencia", un anillo, pero un poco de patetismo saludable nunca doler√°. <br><br>  Habiendo aprovechado el momento de la pr√≥xima ronda de coordinaci√≥n interminable de TK en el frente, reun√≠ todos los m√≥dulos en un mont√≥n.  Maven es una herramienta avanzada para resolver dependencias en un proyecto de m√∫ltiples m√≥dulos, por lo que result√≥ eliminar los √∫ltimos fragmentos de c√≥digo duplicado, unificar versiones de todas las bibliotecas y hacer opciones de compilaci√≥n para entornos locales y en la nube.  Adem√°s, cada m√≥dulo permanece en su propio subproyecto, y su autor puede trabajar en √©l de manera bastante independiente, sin interferir con el resto. <br><br>  Por cierto, considero que este enfoque con la cristalizaci√≥n de abstracciones y la construcci√≥n de alg√∫n tipo de arquitectura a partir de un conjunto existente de entidades homog√©neas es m√°s que un intento de dise√±ar un nivel abstracto por adelantado e implementarlo en tareas particulares.  Sin las pr√°cticas establecidas y los patrones de uso, es in√∫til dise√±ar una arquitectura: no se pueden prever todos los casos de antemano, y las opciones para el comportamiento de los usuarios del sistema pueden diferir radicalmente de las ideas del dise√±ador. <br><br>  Con la l√≥gica unificada de procesamiento de los par√°metros, fue posible hacer un modelo de objeto unificado distinto para la configuraci√≥n del m√≥dulo, y hacer verificaciones normales de la validez y consistencia de las configuraciones de los m√≥dulos entre s√≠ dentro del mismo proceso.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto es especialmente importante con los conjuntos de datos en formato CSV: el control del n√∫mero y el orden de los campos en cada registro RDD, as√≠ como la correcci√≥n de la transferencia del conjunto de datos en s√≠ desde la salida de un m√≥dulo a la entrada de varios posteriores, se basan completamente en el lado de la llamada. </font><font style="vertical-align: inherit;">Y si hay un punto de control, entonces ya se puede hacer bien.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© no vamos m√°s alto y trabajamos con RDD y no con marcos de datos? </font><font style="vertical-align: inherit;">Por la misma raz√≥n que no usamos Spark SQL. </font><font style="vertical-align: inherit;">Pero adem√°s, la implementaci√≥n en Spark es la etapa final y final del c√≥digo, que comienza con un documento t√©cnico, se depura completamente en Python y solo entonces se optimiza en unos pocos pasos para la versi√≥n m√°s productiva. </font><font style="vertical-align: inherit;">Y cuanto m√°s cerca de las primitivas de la biblioteca base, generalmente se ejecuta m√°s r√°pido el c√≥digo.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... si las manos del desarrollador crecen fuera de sus hombros y su cabeza est√° brillante. Te√≥ricamente </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resulta que, en nuestras condiciones, es mucho m√°s f√°cil conducir la l√≠nea del CSV original en forma de un texto nativo de Hadoup compacto (bajo el cap√≥ es solo una matriz de bytes), y describir solo aquellas columnas que la operaci√≥n actual conoce, y solo para ello. Adem√°s, de acuerdo con los resultados de los experimentos, los marcos de datos proporcionan una sobrecarga de consumo de memoria mayor que la necesidad de analizar CSV en la entrada de cada operaci√≥n y comprimir de nuevo a Texto en la salida. Bueno y, sin embargo, es importante para nosotros poder particionar manualmente los RDD intermedios despu√©s de cada paso, porque los nuevos conjuntos de datos del almacenamiento se pueden mezclar con ellos (esto es claramente visible en el diagrama), por lo que a√∫n debe bajar un nivel, sin importar c√≥mo le gustar√≠a permanecer en el nivel Libro blanco de l√≥gica.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero en el c√≥digo de "bajo nivel" en Java, tambi√©n hay ventajas. Por ejemplo, si describe los par√°metros de operaci√≥n (as√≠ como los RDD esperados y generados) en los metadatos, puede generar autom√°ticamente documentaci√≥n y un ejemplo de configuraci√≥n para ellos, y no escribirlos m√°s manualmente. Y los muelles siempre ser√°n relevantes, despu√©s de cada construcci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El archivo de configuraci√≥n task.ini en s√≠, de un conjunto heterog√©neo de par√°metros para cada m√≥dulo, se convirti√≥ inmediatamente en un programa en una especie de lenguaje de programaci√≥n declarativo. No muy bello, pero internamente l√≥gico y relativamente legible para los humanos. Terminarlo a DSL real con su propia sintaxis no es un problema, pero no lo hice como innecesario. Pero un poco m√°s tarde, sin embargo, agreg√≥ una vista a JSON para el futuro frente con un editor visual.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un proceso en corto circuito, en promedio, recibi√≥ otras tres o cinco veces m√°s r√°pido que una cadena de llamadas individuales a trabajos de Spark. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No cien veces, porque ahora, en el marco del mismo trabajo de Spark, se podr√≠an mezclar pasos de tareas de diferente complejidad computacional y saturaci√≥n de datos. Como resultado, el ajuste fino de los par√°metros del cl√∫ster para cada una de las partes de un proceso de varios pasos ha perdido cualquier significado pr√°ctico. Pero gradualmente, y para tal opci√≥n, se encontraron algunos patrones generales que permitieron seleccionar ajustes preestablecidos de tama√±os de cl√∫ster, basados ‚Äã‚Äãsolo en el tama√±o del conjunto de datos inicial y el n√∫mero total de pasos en la plantilla del proceso de procesamiento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para resumir esta etapa, al final de nuestro trabajo con los japoneses, ya ten√≠amos herramientas bastante desarrolladas:</font></font><br><br><ul><li>          ,           , </li><li> ,    ,             DSL  , </li><li>   ,    ‚Äî   , </li><li>      AWS,           . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero lo que no funcion√≥ fue el frente. </font><font style="vertical-align: inherit;">La antigua interfaz de usuario web de Locomizer est√° irremediablemente desactualizada, nunca logramos terminar el nuevo japon√©s a un estado sano antes de que lo abandonaran por completo. </font><font style="vertical-align: inherit;">S√≠, y el c√≥digo de back-end para esta IU, escrito con mi pie izquierdo en una oscura noche de octubre, no pude peinar hasta el final simplemente por el gran volumen.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimizaci√≥n y geocatarsis con Uber H3 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de exhalar, volvimos a proyectos privados. El estado de √°nimo despu√©s de que los japoneses fue, francamente, todo el equipo era muy regular. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero finalmente me libr√© de la necesidad de mantener un respaldo en el frente con su Bogomersssky, holm, holm, spring. (Esta es mi opini√≥n personal. EE, no me gusta solo un poco menos, porque tiene menos autog√≠a y valores predeterminados impl√≠citos; por lo tanto, no importa qu√© terrible empresa es escribir REST). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hubo un tiempo para mirar dentro de cada m√≥dulo con una adicci√≥n.</font></font><br><blockquote>     ‚Äî        ,       .            ,    ,    ,       .   -      .       ‚Äî            .       ,         ‚Äî    . </blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No es que hubiera estado mirando mi c√≥digo de compa√±eros sin prestar atenci√≥n. Simplemente todos se dedican a la tarea que se le ha encomendado, y mientras √©l la lleva a cabo con el resultado deseado, no interfiera con el desarrollador que hace su trabajo. Si el algoritmo funciona correctamente, y esto se confirma mediante pruebas, entonces todo est√° bien. De acuerdo con la velocidad del trabajo, es aceptable, o de lo contrario, la decisi√≥n la toma el primer ministro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No intervengo hasta que reconozco un alto riesgo de apoyo adicional en la decisi√≥n tomada por el desarrollador al implementar una nueva tarea. Y los m√≥dulos viejos y feos, escritos bajo el zar Gorokh por alguien que hab√≠a abandonado el proyecto durante mucho tiempo, pero necesarios para los negocios, se mantendr√°n en un nivel viable, tal como sea, y no importa cu√°nto huele a ellos. Suena c√≠nico, pero soy un pragm√°tico, no un idealista, el resultado del trabajo es m√°s importante para m√≠ que la belleza del c√≥digo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero a veces es necesario aclarar la deuda t√©cnica para que √©l no entierre el proyecto bajo su propio peso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark es una biblioteca de muy alto nivel. Le permite realizar operaciones en RDD de varias maneras, lo que da el mismo resultado, y cada m√©todo puede tener varias opciones excelentes. Debe leer detenidamente la descripci√≥n de cada uno de ellos y, en caso de duda, acceder a la fuente para comprender cu√°l es el √≥ptimo en cuyo caso. El resultado ser√° el mismo, pero la diferencia en la velocidad de su c√°lculo puede ser varias veces, y si la l√≥gica de alguna heur√≠stica despliega cien l√≠neas de c√≥digo en Spark, entonces debe ser especialmente cuidadoso para usar las formas m√°s apropiadas de transformar los datos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lenguajes de alto nivel: son tales que te hacen pensar de manera abstracta.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero al mismo tiempo, el desarrollador debe ser consciente del bajo nivel, sin importar cu√°nto se dispare en altas abstracciones. Por ejemplo, que cualquier lambda pasada al m√©todo .map (), dentro del cual se asigna la memoria para alg√∫n objeto en negrita, se llama nuevamente para cada registro y reasigna el mismo objeto, y a ninguna de las JVM existentes le gustan las asignaciones repetidas en negrita. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y si piensa en el soporte de c√≥digo, ser√≠a bueno tener partes del algoritmo que est√©n conectadas por l√≥gica interna, pero al mismo tiempo completamente aisladas con algunos valores de par√°metros, aislar del resto del c√≥digo, especialmente si estas partes est√°n al principio o al final del algoritmo. Por lo general, se pueden sacar en una operaci√≥n separada, al mismo tiempo, las pruebas con cobertura completa de todos los casos se acortar√°n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sol√≠a ‚Äã‚Äãser prematuro hacer la optimizaci√≥n, pero ahora es el momento en que es el momento, y durante un par de meses me sumerg√≠ de lleno en una fascinante inmersi√≥n en las entra√±as de los m√≥dulos computacionales con c√≥digo de perfil escrito durante dos a√±os por mis colegas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando me zambull√≠ all√≠, One Ring ten√≠a 29 operaciones (algunos m√≥dulos contienen m√°s de uno). Cuando surgi√≥, 43, y cada uno m√°s r√°pido que el original, desde un peque√±o porcentaje hasta decenas de veces. Pero, lo que es m√°s valioso, aquellas operaciones que anteriormente estaban bloqueadas con datos en particiones de 10,000 elementos, ahora se mastican f√°cilmente en piezas en un mill√≥n de registros. En algunos lugares, tuve que sacrificar la flexibilidad y la legibilidad del c√≥digo, en algunos lugares cost√≥ un simple reemplazo de .map () con .mapPartition (), pero el c√≥digo dej√≥ de fallar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solo hab√≠a un cuello de botella: geofencing en una regi√≥n arbitraria. Segu√≠a siendo una extra√±a soluci√≥n h√≠brida con una malla externa. Era posible usar Japan Mesh para Jap√≥n, pero para el resto del mundo era necesario buscar una variante adecuada de una cuadr√≠cula din√°mica, que depende solo de las coordenadas del punto y es conveniente de usar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tal opci√≥n fue encontrada: </font></font><a href="https://uber.github.io/h3/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uber H3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seg√∫n tengo entendido, el √°rbol hexagonal est√° encriptado en el nombre H3, y esta es una cuadr√≠cula geogr√°fica con excelentes caracter√≠sticas. Es estable en todo el rango de coordenadas, monstruosamente r√°pido (se llama el c√≥digo nativo), proporciona celdas de tama√±o uniforme sin espacios en toda la tierra, y le permite hacer un mont√≥n de opciones diferentes para cubrir pol√≠gonos, puntos y trazados. Adem√°s, una celda de cuadr√≠cula hexagonal tiene un n√∫mero m√≠nimo de vecinos, y el siguiente nivel cubre las siete celdas de la anterior estrictamente por encima del centro de la celda subyacente, lo cual es conveniente al construir mapas de agregaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con la transici√≥n a H3, parece que el rompecabezas se ha desarrollado completamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si comparamos con lo que era al principio, hace 2.5 a√±os, luego de las semanas que se gastaron en un desafortunado mapa de calor en un conjunto de datos a un par de millones de se√±ales, llegamos a los minutos que se gastan en docenas de tarjetas con conjuntos de datos, cuyo tama√±o el analista de datos no presta mucha atenci√≥n (debe refunfu√±ar cuando establece el valor predeterminado demasiado alto para el tama√±o del cl√∫ster si escribir el resultado en S3 lleva m√°s tiempo que el c√°lculo en s√≠). Y ya no mira a TC por s√≠ mismo, simplemente obstruye la matriz de par√°metros en alg√∫n lugar de su casa y extrae el n√∫mero requerido de compilaciones necesarias con la pit√≥n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregue una nueva operaci√≥n: solo necesita implementar correctamente la clase Operation (tambi√©n puede usar Scala si lo desea), encerrarla con metadatos, incluirla en su configuraci√≥n y luego One Ring descubrir√° si est√° llamando a la nueva heur√≠stica o procesando la cadena correctamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, todo funciona tanto localmente como en AWS. </font><font style="vertical-align: inherit;">Tambi√©n estar√° en alguna otra nube si es compatible con S3, y Spark puede ser arrastrado a trav√©s de </font></font><abbr title="Lanzador REST para Spark"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Livy all√≠</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y eliminamos todas las dem√°s dependencias externas.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En todo blanco </font></font></h3><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ¬øGandalf?</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero todav√≠a no tenemos un frente para lanzar procesos flexibles. Y las plantillas de tales procesos deben escribirse a la antigua usanza en VSCode, pero quer√≠a ser un mouse en un editor similar a Visio. Algo as√≠: </font><font style="vertical-align: inherit;">incluso hice un peque√±o servicio REST como parte de One Ring, que tiene todo lo que necesitas para escribir un editor de este tipo, pero la √∫ltima vez que trabaj√© en el frente fue hace unos 10 a√±os, y no en el curso de las tendencias actuales. No es para JSF que lo clavo, ni siquiera ser√° retro, sino que ya ser√° una especie de necro. Ser√≠a bueno convertirlo en un SPA est√°tico en algo moderno. Solo que no tengo idea de qu√©. </font><font style="vertical-align: inherit;">Mi </font><s><font style="vertical-align: inherit;">ego√≠sta</font></s><font style="vertical-align: inherit;"> inter√©s personal en revelar el c√≥digo </font><a href="https://github.com/PastorGL/OneRing"><font style="vertical-align: inherit;">One Ring</font></a></font><br><br> <a href=""><img src="https://habrastorage.org/webt/g2/su/hr/g2suhrumf4-lmrwasnribe2zokc.png" alt="Interfaz Mocap para editar un proceso." title="Interfaz Mocap para editar un proceso."></a> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><s><font style="vertical-align: inherit;"></font></s><font style="vertical-align: inherit;"></font><a href="https://github.com/PastorGL/OneRing"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Terminar√© el repositorio con contenido, pero puedes verlo ahora), espero, est√° claro. </font><font style="vertical-align: inherit;">Y si hay alguien lo suficientemente valiente como para abordar </font></font><a href="https://github.com/PastorGL/OneRing/issues/1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta tarea</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , escribir√© una tarea t√©cnica sensata con especificaciones.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero, en general, nosotros, el equipo de ingenieros de datos, no queremos mantener la herramienta terminada en nuestro armario. </font><font style="vertical-align: inherit;">Estamos seguros: ser√° √∫til no solo para nosotros. </font><font style="vertical-align: inherit;">Y no solo para las necesidades de SIG, sino en general cualquier procesamiento de conjuntos de datos con pasos de procesamiento parametrizables.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el art√≠culo final (o en un par de art√≠culos, nuevamente, algo lleva demasiado tiempo) te dir√© c√≥mo construir, ejecutar, expandir y usar One Ring para tus tareas de investigaci√≥n. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* El c√≥digo fuente de One Ring OSS no incluye algoritmos heur√≠sticos patentados de Locomizer. </font><font style="vertical-align: inherit;">Pero su repositorio contendr√° interfaces y descripciones, seg√∫n las cuales las implementaciones gratuitas de estas heur√≠sticas se pueden recrear utilizando el m√©todo de sala limpia, es decir, sin indicaciones de mi parte por el c√≥digo.</font></font></i> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agradecimientos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... a sus colegas Gregory </font></font><a href="https://github.com/pomadchin"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pomadchin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por sus comentarios sustantivos sobre el tema, y </font></font><a href="https://habr.com/ru/users/sshikov/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sshikov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por una evaluaci√≥n independiente de la legibilidad del texto, y tambi√©n a Anton </font></font><a href="https://habr.com/ru/users/dartov/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dartov Zadorozhny</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por sus comentarios inesperados sobre el art√≠culo anterior de la serie.</font></font></div></div><p>Source: <a href="https://habr.com/ru/post/485988/">https://habr.com/ru/post/485988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485968/index.html">Y de nuevo eludir las cerraduras. RouterOS + BGP + OSPF</a></li>
<li><a href="../485970/index.html">Treinta entrevistas principales recientemente: desarrollo, dise√±o, ciencia y estilo de vida</a></li>
<li><a href="../485972/index.html">M√©todos de an√°lisis de regresi√≥n en ciencia de datos</a></li>
<li><a href="../485974/index.html">Raspberry Pi y SIM7600E 4G HAT Modem</a></li>
<li><a href="../485986/index.html">Las 5 principales tendencias de localizaci√≥n en 2020</a></li>
<li><a href="../485998/index.html">LyX: Observaciones generales. Parte 2</a></li>
<li><a href="../486000/index.html">ADSM3. Sistemas IPAM / DCIM</a></li>
<li><a href="../486006/index.html">Almacenar el estado del chat en la pila</a></li>
<li><a href="../486010/index.html">Hacer una demostraci√≥n para un tel√©fono antiguo - AONDEMO</a></li>
<li><a href="../486014/index.html">Recorrido de SLAC: Laboratorio nacional de aceleraci√≥n del Departamento de Energ√≠a de EE. UU. En Stanford</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>