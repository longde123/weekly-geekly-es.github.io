<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👭 👩🏼‍🏫 🛀🏼 Cara merakit gambar Oracle DB untuk Testcontainers 👨‍👨‍👦‍👦 🐥 🎥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kode harus diuji pada DBMS yang akan digunakan. Testcontainers adalah pustaka yang memungkinkan Anda untuk menggunakan hampir semua DBMS dalam unit te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara merakit gambar Oracle DB untuk Testcontainers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480106/"><p>  Kode harus diuji pada DBMS yang akan digunakan.  Testcontainers adalah pustaka yang memungkinkan Anda untuk menggunakan hampir semua DBMS dalam unit test dengan kemudahan yang sama seperti database yang disematkan seperti HSQLDB atau H2.  Hanya akan ada gambar buruh pelabuhan </p><br><img src="https://habrastorage.org/webt/hn/x3/ho/hnx3hojiqvya8flignz-mqkrk6s.jpeg"><br><p>  Artikel ini dikhususkan untuk perakitan gambar buruh pelabuhan yang nyaman untuk digunakan dengan Testcontainers.  Ketika saya mencoba membuatnya, saya punya masalah, dan di sini saya membagikan solusi saya. <br>  Saya akan mengumpulkan gambar untuk Oracle 11, karena kecil dan saya punya cukup versi 11.  Dengan versi lain, pendekatannya hampir sama. </p><br><p>  Untuk memperjelas cara menggunakan gambar, akan ada juga kode Java yang menunjukkan penggunaan gambar untuk menguji aplikasi Boot Musim Semi.  Metode menghubungkan ke testcontainers yang saya berikan mungkin bukan yang terbaik.  Tapi pertama-tama, dia menunjukkan cara menggunakan pengaturan yang ditentukan saat membuat gambar.  Kedua, itu sederhana.  Dan ketiga, hampir tidak terikat dengan Spring, bahkan dapat terjebak dalam kode Java, di mana tidak ada yang lain kecuali public static void main. </p><br><p>  Diasumsikan bahwa pembaca dangkal akrab dengan Docker dan Testcontaners, dan juga mengenal Java dengan baik.  Untuk membangun, Anda perlu menggunakan linux, jika Anda membangun di bawah Windows, Anda harus menggunakan msys2 atau sesuatu seperti itu. </p><br><p>  Kode demo diunggah ke github di sini <a href="https://github.com/poxu/testcontainers-spring-demo" rel="nofollow">https://github.com/poxu/testcontainers-spring-demo</a> Skrip yang dikoreksi untuk merakit gambar dapat dilihat di garpu instruksi Oraklov saya <a href="https://github.com/poxu/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/poxu/docker-images/tree/ master / OracleDatabase / SingleInstance</a> </p><a name="habracut"></a><br><h1>  Bangun gambar Docker </h1><br><p>  Oracle tidak menyediakan gambar untuk buruh pelabuhan, tetapi memposting petunjuk terperinci tentang cara merakitnya di github. </p><br><p>  Sayangnya, tidak mungkin untuk menggunakan gambar-gambar ini di dalam wadah tes karena wadah yang diluncurkan dari gambar ini dimulai dari dua hingga 20 menit. </p><br><p>  Untuk digunakan dalam unit test, ini tidak dapat diterima, jadi Anda perlu membuat perubahan sendiri pada skrip, tetapi pertama-tama, lebih baik mencoba merakit wadah sesuai dengan instruksi yang diberikan oleh Oracle.  Saya akan membuat menceritakan kembali secara singkat di sini, instruksi yang lebih lengkap terdapat di tautan ini <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance</a> </p><br><h2>  Perakitan gambar sesuai dengan instruksi dari Oracle </h2><br><p>  Pertama, Anda harus mengkloning repositori dengan instruksi tentang cara merakit gambar. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/oracle/docker-images.git</code> </pre> <br><p>  Kemudian dapatkan paket rpm untuk versi ekspres resmi dari Oracle 11.2.0.2. Tidak terlalu sulit, Anda hanya perlu mendaftar di situs Oracle, buka halaman unduh Oracle DBMS, pilih versi 11.2.0.2 XE di sana dan unduh file rpm yang dikemas oracle-xe-11.2.0 -1.0.x86 ~ 64 ~ .rpm.zip. </p><br><p>  Letakkan file di repositori git yang diunduh di direktori docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / </p><br><p>  Selanjutnya, buka direktori docker-images / OracleDatabase / SingleInstance / dockerfiles dan jalankan perintah </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x</code> </pre> <br><p>  Docker akan mengumpulkan gambar yang disebut oracle / database: 11.2.0.2-xe berdasarkan yang Anda butuhkan untuk membuat wadah dengan perintah ini </p><br><pre> <code class="bash hljs">docker run --rm --name vanilla_oracle_test_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ oracle/database:11.2.0.2-xe</code> </pre> <br><p>  Kontainer mulai beberapa menit, karena setelah memulai itu membuat database baru, dan proses ini tidak cepat. </p><br><p>  Setelah beberapa menit, spanduk akan muncul di konsol </p><br><blockquote>  ############################ <br>  DATABASE SIAP MENGGUNAKAN! <br>  ############################ </blockquote><p>  Setelah itu, Anda dapat terhubung ke database menggunakan login SISTEM, kata sandinya 123, alamat koneksi adalah localhost dan SID adalah XE. </p><br><p>  Jika semuanya berfungsi, maka Anda dapat melanjutkan ke proses membuat gambar di bawah testcontainers.  Jika tidak, lebih baik melalui manual dari Oracle dan mencari tahu apa yang salah. </p><br><p>  Seperti yang sudah kita ketahui, wadah mulai untuk waktu yang lama karena fakta bahwa setelah mulai database dibuat.  Dalam beberapa kasus, ini mungkin nyaman, tetapi sekarang ini menyebabkan kerusakan total.  Hal ini diperlukan untuk membuat wadah siap digunakan segera setelah diluncurkan. </p><br><h2>  Perbaikan gambar manual </h2><br><p>  Salah satu cara untuk mendapatkan gambar dari database selesai adalah menunggu sampai wadah dimulai dan pembuatan database selesai, dan kemudian simpan wadah ke gambar baru. </p><br><p>  Penting untuk tidak memulai wadah dengan argumen --rm, jika tidak buruh pelabuhan akan memukulnya segera setelah berhenti. </p><br><pre> <code class="bash hljs">docker commit --message <span class="hljs-string"><span class="hljs-string">"container for unit tests"</span></span> &lt;container id&gt; my/oracle-11.2.0.2-for-unit-tests</code> </pre> <br><p>  Ini akan membuat gambar baru dari wadah, yang akan diluncurkan tidak hanya beberapa menit, tetapi 20 - 30 detik. </p><br><h2>  Modifikasi proses perakitan gambar untuk mendapatkan gambar selesai segera setelah perakitan </h2><br><p>  Tentu saja, ada baiknya untuk memiliki instruksi untuk merakit gambar dalam bentuk kode sehingga Anda dapat memulai perakitan dengan satu perintah dan tidak perlu menunggu wadah untuk memulai dan membuat gambar berdasarkan pada itu dengan tangan Anda. </p><br><p>  Baris terakhir dari dockerfile menunjukkan perintah yang dieksekusi setelah start </p><br><pre> <code class="bash hljs">CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><p>  \ $ ORACLE ~ BASE ~ / \ $ RUN ~ FILE ~ menunjuk ke file docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / runOracle.sh </p><br><p>  Jika Anda menghentikan wadah ini dan kemudian menjalankannya lagi, sebagai akibatnya, untuk pertama kalinya, skrip akan membuat database, dan untuk kedua kalinya hanya akan memulainya.  Dapat diasumsikan bahwa jika Anda menjalankan skrip pada tahap perakitan gambar, gambar akan dikumpulkan dari database yang sudah dibuat. </p><br><p>  Tetapi dalam perjalanan untuk mengimplementasikan rencana yang berani ini, satu komplikasi muncul. </p><br><p>  Script berjalan selamanya, yaitu, sampai sinyal tiba di wadah bahwa pekerjaan harus diselesaikan.  Ini diselesaikan dengan cukup sederhana.  Baris terakhir file runOracle.sh berisi perintah tunggu.  Kami tahu bahwa pada tahap perakitan Anda tidak perlu menunggu apa pun, Anda harus menyelesaikan pekerjaan dan oleh karena itu kami akan menempatkan pernyataan bersyarat dalam naskah. </p><br><p>  Ini akan memeriksa apakah argumen --running-while-building tidak diteruskan ke file dan jika argumen ini disahkan, maka jangan menunggu sinyal, tetapi cukup mengganggu pekerjaan.  Yaitu, lakukan seperti ini: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"--running-while-building"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$childPID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><p>  Nah, di dockerfile kami menambahkan panggilan skrip lain, hanya pada tahap perakitan.  Ini akan menjadi seperti ini. </p><br><pre> <code class="bash hljs">RUN <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span> --running-while-building CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><h2>  Diperlukan perubahan untuk digunakan dalam pengujian </h2><br><h3 id="ustranit-ispolzovanie-tomov">  Hilangkan penggunaan volume </h3><br><p>  Perlu menemukan garis </p><br><blockquote>  VOLUME ["\ $ ORACLE ~ BASE ~ / oradata"] </blockquote><p>  Dan mengomentarinya.  Tidak perlu menggunakan volume, karena semua perubahan akan dilemparkan setelah setiap pengujian dijalankan, tetapi masalah dengan menggunakan volume dapat dengan mudah muncul saat menyalin gambar. </p><br><h3 id="udalit-nenuzhnye-fayly">  Hapus file yang tidak perlu </h3><br><p>  Perlu menambahkan baris </p><br><pre> <code class="bash hljs">rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jdbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/md &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/nls/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/odbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/public &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin/rman &amp;&amp; \</code> </pre> <br><p>  Tepat sebelum garis </p><br><pre> <code class="bash hljs">chmod ug+x <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/*.sh</code> </pre> <br><p>  Ini akan menghapus dari gambar semua file yang tidak diperlukan untuk tujuan pengujian.  Semakin kecil gambar, semakin baik. </p><br><h3 id="ubrat-razbienie-obraza-na-sloi">  Hapus pemisahan gambar </h3><br><p>  Untuk mengurangi gambar, Anda harus membuatnya menggunakan argumen <strong>squash</strong> .  Ini akan menghapus pemisahan menjadi lapisan-lapisan dari gambar, yang selanjutnya akan mengurangi volumenya.  Argumen squash bersifat eksperimental, jadi Anda harus mengaktifkannya secara terpisah.  Dalam sistem operasi yang berbeda, ini dilakukan dengan cara yang berbeda. </p><br><p>  Untuk meneruskan argumen ke buruh pelabuhan, docker-images / OracleDatabase / SingleInstance / dockerfiles / buildDockerImage.sh menyediakan argumen -o.  Artinya, untuk meneruskan argumen --squash ke buruh pelabuhan, Anda perlu memanggil buildDockerImage.sh seperti ini </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -o <span class="hljs-string"><span class="hljs-string">'--squash'</span></span></code> </pre> <br><h3 id="pomenyat-nazvanie-obraza">  Ubah nama gambar </h3><br><p>  Sampai saat ini, gambar tersebut sangat berbeda dari apa yang diusulkan Oracle untuk dilakukan, sehingga harus diganti namanya.  Untuk melakukan ini, Anda harus mengedit file buildDockerImage.sh itu sendiri. Skrip mengambil nama gambar dari variabel IMAGE ~ NAME ~, yang nilainya diatur langsung dalam file tersebut. </p><br><p>  Di sini </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="oracle/database:$VERSION-$EDITION"</code> </pre> <br><p>  Saya berubah menjadi </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="my/oracle-for-habr:$VERSION-$EDITION"</code> </pre> <br><h3 id="zadat-parol-k-bd">  Setel Kata Sandi DB </h3><br><p>  Kata sandi ini diatur dalam variabel lingkungan ORACLE ~ PWD ~ selama awal pertama wadah.  Tapi kami memiliki pengaturan basis data selama pembuatan gambar, jadi variabel perlu ditentukan pada tahap ini.  Jika kemampuan untuk mengatur kata sandi untuk setiap perakitan melalui baris perintah tidak diperlukan, maka Anda dapat memasukkannya di dockerfile: </p><br><pre> <code class="plaintext hljs">ENV ORACLE_PWD=123</code> </pre> <br><p>  Jika untuk sesuatu yang Anda butuhkan untuk dapat menentukan kata sandi lagi dengan setiap build, maka untuk meneruskan argumen ke buruh pelabuhan, Anda dapat kembali menggunakan -o </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x -o <span class="hljs-string"><span class="hljs-string">'--squash --build-arg ORACLE_PWD=123'</span></span></code> </pre> <br><p>  Ini akan mentransfer variabel lingkungan ORACLE ~ PWD ~ ke dockerfile, tetapi dockerfile tidak akan meneruskannya ke skrip yang dijalankan selama build.  Agar dia melakukan ini, Anda perlu menambahkan instruksi ARG ke dockerfile. </p><br><pre> <code class="plaintext hljs">ARG ORACLE_PWD=default</code> </pre> <br><p>  Kata sandi, karena mungkin sudah menjadi jelas, akan menjadi 123, dan jika Anda tidak lulus ORACLE ~ PWD ~ ke buildDockerImage.sh maka default. </p><br><p>  Terkadang Oracle percaya bahwa kata sandi itu buruk dan tidak ingin berfungsi, jadi mungkin perlu mengganti 123 dengan yang lain </p><br><h2>  Tes meningkatkan gambar yang dihasilkan </h2><br><p>  Sekarang Anda dapat mencoba menjalankan wadah berdasarkan gambar </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  Argumen --shm-size = "1g" penting di sini, tanpanya wadah dimulai, tetapi Oracle 11.2.0.2 sendiri tidak dapat berfungsi.  Ini, untuk berjaga-jaga, tidak berarti bahwa wadah akan membutuhkan satu gigabyte RAM, ia memakan sekitar 100 megabyte. </p><br><p>  Jika wadah telah naik secara normal, Anda dapat mencoba untuk terhubung ke database, yang terletak di sana. </p><br><p>  Alamat dasar - kemungkinan besar hosting lokal <br>  Port - 1234 <br>  Pengguna - SISTEM <br>  Kata sandi - 123 </p><br><p>  Jika dimulai secara normal, maka Anda dapat melanjutkan ke langkah berikutnya. </p><br><h2>  Skrip inisialisasi DB </h2><br><p>  Agar program dapat bekerja dengan database dari gambar, perlu ada sirkuit di sana setelah peluncuran.  Anda dapat membuat sirkuit ini pada tahap pembuatan, tapi saya lebih suka melakukannya saat wadah dimulai. </p><br><p>  Setelah memulai, wadah akan mencari di direktori <em>u01 / app / oracle / scripts / startup</em> dan jalankan semua skrip sql yang ditemukan di sana, yang dapat Anda gunakan dengan meletakkan file di sana yang akan membuat sirkuit.  Sesuatu seperti itu. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passwordnoquotes; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">QUOTA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unlimited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESOURCE</span></span>, DBA <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER;</code> </pre> <br><p>  Semua ini perlu ditambahkan ke file init ~ db ~ .sql, dan file tersebut dilemparkan ke dalam wadah menggunakan -v </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ -v <span class="hljs-variable"><span class="hljs-variable">${PWD}</span></span>/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  \ $ {PWD} Ini digunakan karena jalur absolut ke file diperlukan, ketika menggunakan Windows, Anda perlu menentukannya dengan cara yang berbeda.  Jika, setelah memulai, skema TEST ~ USER ~ berhasil dibuat, maka Anda dapat melanjutkan untuk mengacaukan wadah yang baru dibuat ke pengujian. </p><br><h1>  Menggunakan gambar dalam kode Java </h1><br><p>  Saat pengujian menggunakan database bawaan, sebagai aturan, masalah yang sama muncul.  Jika konfigurasi tidak dapat diambil dari cache, maka Spring mengumpulkannya lagi.  Secara khusus, itu menciptakan kembali database bawaan, yang tentu saja sangat memperlambat tes.  Saya memecahkan masalah dengan brute force hanya dengan membuat bagian mengangkat kontainer menjadi satu.  Yang asli, kondominium. </p><br><p>  Untuk Oracle XE, Testcontainers memiliki kelas yang disiapkan khusus.  Pertama-tama, kelas ini tahu bahwa kita berbicara tentang sebuah wadah dengan DBMS dan bahwa untuk menentukan bahwa itu dinaikkan, kita harus mencoba untuk terhubung ke database menggunakan jdbc. </p><br><p>  Objek kelas ini akan menunggu kontainer diangkat dengan sendirinya, Anda hanya perlu memberi tahu yang mana log dengan kata sandi untuk digunakan. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazyOracleContainer.ORACLE_CONTAINER; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OracleContainer ORACLE_CONTAINER = makeContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       testcontainers.properties //  oracle.container.image final var dockerImageName = "my/oracle-for-habr"; final var container = new OracleContainer(dockerImageName) //    ,  testcontainers //  ,  ,  //   .withUsername("SYSTEM").withPassword("123") // ,  testcontainers  //     .withExposedPorts(1521, 5500) //      shared memory //    .withSharedMemorySize(2147483648L) //   ,       // -v /path/to/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql //    init_db.sql   .withClasspathResourceMapping("init_db.sql" , "/u01/app/oracle/scripts/startup/init_db.sql" , BindMode.READ_ONLY); container.start(); return container; } } }</span></span></code> </pre> <br><p>  Juga, testcontainers, ketika diluncurkan, memetakan port internal wadah ke port eksternal kosong yang ditentukan secara acak.  Karena itu, Anda tidak perlu takut bahwa wadah tidak akan naik, karena pelabuhan sudah digunakan oleh seseorang.  Port eksternal dapat diperoleh dari kontainer menggunakan metode getOraclePort (). </p><br><p>  Anda juga bisa mendapatkan alamat kontainer menggunakan metode getContainerIpAddress (), tetapi kontainer apa pun memiliki metode ini. </p><br><p>  Setelah panggilan pertama ke metode getContainer, wadah tidak akan dibuat ulang, tetapi yang sudah ada akan dikembalikan.  Metode ini sekarang dapat digunakan di Java telanjang atau dalam konfigurasi Spring untuk mendapatkan objek dengan wadah dari mana Anda dapat menarik keluar port dan alamat untuk koneksi. </p><br><p>  Misalnya, Anda bisa membuat penginisialisasi, yang, ketika meningkatkan konteks, akan menimpa atribut pegas yang bertanggung jawab untuk menghubungkan ke database. </p><br><h2>  Kelas untuk melampirkan Testcontainers ke Spring </h2><br><p>  Setelah menaikkan wadah, penginisialisasi menimpa properti yang bertanggung jawab untuk URL untuk menghubungkan ke database, login, kata sandi dan semua itu. </p><br><p>  Tetapi, jika tidak ada pengaturan evilcorp.testcontainers.enabled di application.properties, maka wadah tidak akan diangkat dan semuanya akan bekerja seolah-olah tidak ada yang terhubung dengan testcontainers. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.util.TestPropertyValues; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ConfigurableApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(TestcontainersInitializer.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   Testcontainers final String testcontainersEnabled = applicationContext.getEnvironment().getProperty("evilcorp.testcontainers.enabled"); if (!"true".equals(testcontainersEnabled)) { return; } OracleContainer oracleContainer = StaticOracleContainer.getContainer(); oracleContainer.followOutput(s -&gt; log.debug(() -&gt; s.getUtf8String())); // IP       //  ,    // (linux, MacOs, Windows  ) , //    oracleContainer.getContainerIpAddress() //    // // Testcontainers     //   ,    oracleContainer.getOraclePort() //  ,         final String jdbcUrl = "jdbc:oracle:thin:@//" + oracleContainer.getContainerIpAddress() + ":" + oracleContainer.getOraclePort() + "/XE"; //      init_db.sql //      final String user = "TEST_USER"; final String password = "passwordnoquotes"; TestPropertyValues.of( "spring.jpa.properties.hibernate.default_schema=" + user, "spring.datasource.driver-class-name=oracle.jdbc.OracleDriver", "spring.jpa.database-platform=org.hibernate.dialect.Oracle10gDialect", "spring.datasource.username=" + user, "spring.datasource.password=" + password, "spring.datasource.url=" + jdbcUrl, "spring.liquibase.url=" + jdbcUrl, "spring.liquibase.user=" + user, "spring.liquibase.password=" + password ).applyTo(applicationContext.getEnvironment(), TestPropertyValues.Type.MAP, "test"); } }</span></span></code> </pre> <br><p>  Konfigurasi ini dapat digunakan dalam uji booting pegas untuk menimpa pengaturan database dengan cepat. </p><br><h2>  Tes menggunakan Testcontainers </h2><br><p>  Tes hanya menulis objek ke database, dan kemudian membacanya, tidak ada yang istimewa. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.evilcorp.demo.entity.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.BeforeEach; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.ContextConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertEquals; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotSame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertTrue; <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = {TestcontainersInitializer.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersSpringDemoApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> UserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User createdUser; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createdUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); createdUser.setName(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>); userRepository.save(createdUser); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userRepositoryLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNotNull(userRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Optional&lt;User&gt; loadedUser = userRepository.findById(createdUser.getUserId()); assertTrue(loadedUser.isPresent()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>, loadedUser.get().getName()); assertNotSame(createdUser, loadedUser.get()); } }</code> </pre> <br><p>  Dan ya, tambahkan dependensi ke pom.xml </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>oracle-xe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Itulah tentang bagaimana Anda dapat membuat gambar galangan Oracle DBMS dan menggunakannya dalam kode Java.  Tetap hanya menempatkan gambar dalam repositori korporat artefak dan mengatur peluncuran tes di dalam wadah buruh pelabuhan lain.  Tetapi ini adalah kisah yang sangat berbeda. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id480106/">https://habr.com/ru/post/id480106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id480096/index.html">Akhir masa kanak-kanak: hak cipta atas karya yang dibuat oleh kecerdasan buatan (AI)</a></li>
<li><a href="../id480098/index.html">JH Rainwater "Cara merumput kucing": di sisi lain pembangunan</a></li>
<li><a href="../id480100/index.html">Pemula Tentang SEO</a></li>
<li><a href="../id480102/index.html">November Manajemen Produk Digest</a></li>
<li><a href="../id480104/index.html">9 trik HTML yang berguna</a></li>
<li><a href="../id480108/index.html">Fisika dalam Proyek Persatuan Menggunakan Pertarungan Bergerak sebagai Contoh</a></li>
<li><a href="../id480110/index.html">uMCPIno: Menulis Protokol Sederhana dengan Pengiriman yang Dijamin untuk Arduino</a></li>
<li><a href="../id480112/index.html">Perbedaan antara C ++ / Visual Basic dan Java pada tingkat umum (untuk pemula dan siswa)</a></li>
<li><a href="../id480114/index.html">Semua tentang pajak untuk freelancer IT. IE dan wiraswasta. Bagian 1</a></li>
<li><a href="../id480116/index.html">Posisi Mail.ru Group pada pengembangan opensource di Rusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>