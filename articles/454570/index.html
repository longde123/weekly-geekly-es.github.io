<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê§ üë©üèΩ‚Äçüöí üßñüèæ Recreando un viejo juego de DOS en C ++ 17 ‚õ™Ô∏è ü•¶ üí≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2016, comenc√© a trabajar en un proyecto de pasatiempos para realizar ingenier√≠a inversa del juego Duke Nukem II y recrear su motor desde cero. El p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Recreando un viejo juego de DOS en C ++ 17</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454570/">  En 2016, comenc√© a trabajar en un proyecto de pasatiempos para realizar ingenier√≠a inversa del juego <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">Duke Nukem II</a> y recrear su motor desde cero.  El proyecto se llama Rigel Engine y est√° disponible en c√≥digo abierto ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">su p√°gina en GitHub</a> ).  Hoy, m√°s de dos a√±os y medio despu√©s, en mi motor, ya puedes ver todo el episodio shareware del juego original con un juego casi id√©ntico al original.  Aqu√≠ hay un video con el pasaje del primer nivel: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Z3gCS5LvC2s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Que puede hacer el?  Rigel Engine funciona como un reemplazo completo para el binario original de DOS ( <code>NUKEM2.EXE</code> ).  Puede copiarlo en el directorio del juego y considera todos los datos que contiene, o especificar la ruta a los datos del juego como argumento de la l√≠nea de comando.  El motor est√° construido y ejecutado bajo Windows, Mac OS X y Linux.  Est√° basado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">SDL</a> y OpenGL 3 / OpenGL ES 2, y est√° escrito en C ++ 17. <br><br>  Implementa la l√≥gica del juego de todos los enemigos y la mec√°nica del juego del episodio Shareware, adem√°s de la mayor√≠a del sistema de men√∫s.  Adem√°s, puede importar juegos guardados y una tabla de puntaje alto del juego original en √©l. <br><a name="habracut"></a><br>  Adem√°s, el motor tiene ventajas sobre el original: <br><br><ul><li>  No se requiere emulador ni hardware antiguo, no se necesita configuraci√≥n </li><li>  No hay pantallas de carga: seleccione "nuevo juego" en el men√∫, presione Entrar e inmediatamente comience el juego </li><li>  Se pueden reproducir varios efectos de sonido al mismo tiempo, lo cual era imposible en el original </li><li>  No existen restricciones sobre el n√∫mero de efectos simult√°neos de part√≠culas, explosiones, etc. </li><li>  Guarde archivos y listas de puntajes para cada jugador </li><li>  Men√∫s mucho m√°s receptivos </li></ul><br>  Hasta ahora, no considero que el motor Rigel est√© completamente "listo".  Pero esta es una gran etapa de desarrollo y una buena oportunidad para volver a escribir sobre el motor (publicaciones antiguas publicadas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">aqu√≠</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">aqu√≠</a> ).  Comencemos por echar un vistazo al estado actual del c√≥digo y descubrir c√≥mo llegu√© a √©l. <br><br><h2>  ¬øCu√°nto c√≥digo hay en el motor? </h2><br>  Al momento de escribir, RigelEngine consta de 270 archivos fuente que contienen m√°s de 25 mil l√≠neas de c√≥digo (sin comentarios / l√≠neas vac√≠as).  De estos, 10 archivos y 2.5 mil l√≠neas son pruebas unitarias.  Un desglose detallado de l√≠neas vac√≠as y comentarios est√° disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">aqu√≠</a> . <br><br>  ¬øQu√© hay en todo este c√≥digo?  Un poco de infraestructura com√∫n y funciones de soporte, cosas b√°sicas como el renderizado y un mont√≥n de peque√±as piezas de l√≥gica.  Adem√°s de todo esto, las partes m√°s grandes son: <br><br><ul><li>  analizadores / descargadores para 14 formatos de archivo diferentes utilizados en el juego original: 2 mil l√≠neas de c√≥digo (LOC) </li><li>  l√≥gica de comportamiento / l√≥gica de juego para 24 enemigos / objetos hostiles - 3.8k LOC </li><li>  l√≥gica de juego para 14 elementos interactivos y mec√°nica del juego - 2k LOC </li><li>  l√≥gica de control del jugador - 1.2k LOC </li><li>  154 entradas de configuraci√≥n (el valor de salud de cada enemigo, el n√∫mero de puntos recibidos por los elementos recogidos, etc.) - 1k LOC </li><li>  31 especificaciones para efectos de destrucci√≥n (efectos desencadenados por la destrucci√≥n de un enemigo u otro objeto destructible) - 254 LOC </li><li>  c√≥digo de control de la c√°mara - 159 LOC </li><li>  int√©rprete de lenguaje de descripci√≥n del men√∫ del juego / escena - 643 LOC </li><li>  El HUD y otro c√≥digo de UI es 818 LOC </li><li>  5 pantallas / modos fuera del men√∫, por ejemplo, la animaci√≥n inicial, la pantalla de bonificaci√≥n, etc.  - 789 LOC </li></ul><br>  Por supuesto, todo este c√≥digo necesitaba ser escrito, y esto nos lleva a la siguiente pregunta. <br><br><h2>  ¬øCu√°nto trabajo tom√≥? </h2><br>  Aunque han pasado dos a√±os y medio desde el inicio del proyecto, no he trabajado en ello todo este tiempo.  Durante un par de meses no hice un proyecto en absoluto, en algunos otros solo pas√© varias horas en √©l.  Pero hubo momentos en que trabaj√© en el motor Rigel de manera bastante activa.  Mirando el cronograma de confirmaci√≥n en Github, puede tener una idea aproximada de c√≥mo se distribuy√≥ mi trabajo a lo largo del tiempo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c55/7f6/ee0/c557f6ee023574c46aea645b0001824d.png"></div><br>  De acuerdo con el cronograma, vemos que se realizaron 1081 confirmaciones en la rama maestra.  Sin embargo, incluso antes de crear el repositorio, estaba trabajando en uno cerrado, en el que hab√≠a 247 confirmaciones m√°s, lo que en total nos da 1328 confirmaciones.  Adem√°s, hab√≠a varias ramas prototipo que utilic√© para investigaci√≥n y experimentaci√≥n, pero nunca las combin√© con la principal;  Adem√°s, antes de fusionarme, a veces comprim√≠a grandes historias de commit en otras m√°s cortas. <br><br>  Tambi√©n debo decir que la escritura de c√≥digos no fue la √∫nica parte del proyecto; la ingenier√≠a inversa fue otra parte importante.  Pas√© unas horas estudiando el c√≥digo desmontado del archivo ejecutable original en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">Ida Pro</a> (en la versi√≥n gratuita), tomando notas, escribiendo pseudoc√≥digo y planificando la implementaci√≥n de los elementos de mi versi√≥n.  Adem√°s, prob√© activamente el juego original, lanz√°ndolo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">DOSBox</a> y en el equipo original (diferentes m√°quinas 386 y 486 compradas en eBay).  Recolect√© niveles de prueba para la observaci√≥n separada de enemigos espec√≠ficos y el estudio de la mec√°nica del juego, grab√© videoclips usando DOSBox y mir√© los cuadros cuadro por cuadro para confirmar mis conclusiones hechas mientras estudiaba el c√≥digo del ensamblador.  Despu√©s de que el enemigo o la mec√°nica del juego se dieron cuenta, generalmente grab√© un video clip de mi versi√≥n y lo compar√© cuadro por cuadro con el original para confirmar la precisi√≥n de mi implementaci√≥n. <br><br>  Aqu√≠ hay algunas fotos de mis notas: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/884/da3/b64/884da3b64a95ce531a3d5dbb456265bc.jpg"></div><br>  <i>C√≥digo de control de c√°mara de ingenier√≠a inversa.</i>  <i>Un rect√°ngulo grande indica la pantalla.</i>  <i>Las l√≠neas discontinuas muestran las zonas que un jugador puede mover sin mover la c√°mara.</i>  <i>Si est√° interesado, el c√≥digo de control de la c√°mara se puede encontrar <a href="" rel="noopener">aqu√≠</a> .</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec4/2d3/5c6/ec42d35c6ee85e375b8ed6d94d37e24d.jpg"></div><br>  <i>Notas generales para ayudarlo a comprender el c√≥digo de ensamblaje.</i>  <i>A la izquierda est√° el procedimiento para actualizar el juego original a un alto nivel.</i>  <i>A la derecha hay notas en los campos de bits que indican el estado de algunos objetos del juego.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/839/677/f8f/839677f8f3f9854d8e8ce6d349da396c.jpg"></div><br>  <i>Transcripci√≥n de c√≥digo ensamblador en pseudoc√≥digo.</i>  <i>Por lo general, lo hago de forma mec√°nica, transcribo sin pensar en lo que est√° haciendo el c√≥digo y luego uso la versi√≥n en pseudoc√≥digo para comprender la l√≥gica subyacente.</i>  <i>Y en base a esto, ya se me ocurri√≥ mi implementaci√≥n.</i>  <i>Vea el c√≥digo terminado <a href="" rel="noopener">aqu√≠</a> .</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8da/fd3/848/8dafd384867291ec44dc8bb9d9ff15b2.jpg"></div><br>  <i>Pseudoc√≥digo de una versi√≥n limpia de la l√≥gica enemiga</i>  <i>Los encabezados indican el estado de la m√°quina de estados, el siguiente c√≥digo explica lo que debe suceder en los estados respectivos.</i>  <i>Fue creado sobre la base del pseudoc√≥digo bruto obtenido al transcribir el c√≥digo del ensamblador.</i>  <i>El c√≥digo listo se puede encontrar <a href="" rel="noopener">aqu√≠</a> .</i> <br><br>  Al final, el trabajo en el proyecto result√≥ ser muy emocionante, y aprend√≠ mucho de √©l: sobre ingenier√≠a inversa, ensamblador x86 de 16 bits, programaci√≥n VGA de bajo nivel, restricciones severas que los desarrolladores de juegos de PC tuvieron que enfrentar a principios de los 90;  Adem√°s, hice muchos descubrimientos sobre las caracter√≠sticas internas del juego original y cu√°n extra√±os y extra√±os se implementaron algunos de ellos: este tema en s√≠ mismo merece una serie separada de publicaciones. <br><br><h2>  Que sigue </h2><br>  Adem√°s de agregar las √∫ltimas funciones restantes y finalizar el soporte para la versi√≥n registrada, tengo varias ideas para mejorar y expandir las capacidades de Rigel Engine, sin mencionar la limpieza y refactorizaci√≥n del c√≥digo, como de costumbre, la mejor manera de crear una arquitectura de software se hace evidente solo despu√©s de que se completa la creaci√≥n de este software. <br><br>  En cuanto a futuras mejoras, estos son algunos de los puntos que pens√© en implementar: <br><br><ul><li>  Movimiento suave con interpolaci√≥n.  El juego actualiza su l√≥gica aproximadamente 15 veces por segundo, y en el juego original tambi√©n es la velocidad de fotogramas para el renderizado.  Por otro lado, el Rigel Engine puede funcionar f√°cilmente con una frecuencia de 60 FPS y superior.  Por el momento, estos cuadros adicionales no ofrecen ninguna ventaja, pero creo que pueden usarse para cuadros intermedios con el fin de lograr un desplazamiento y movimiento de objetos m√°s suaves.  La l√≥gica del juego seguir√° funcionando a la misma velocidad, pero los objetos se mover√°n suavemente y no "saltar√°n" con un incremento de 8 p√≠xeles, como lo est√°n haciendo ahora.  Anteriormente, cre√© un prototipo de dicho sistema, y ‚Äã‚Äãse ve muy bien, aunque debe mejorarse. </li><li>  Soporte para gamepad.  En el juego original hay soporte para joysticks, y DosBox puede emularlos en gamepads modernos, pero su configuraci√≥n puede ser dif√≠cil: se requiere preparaci√≥n de la configuraci√≥n y calibraci√≥n en el juego.  Sin mencionar que no todos los botones del controlador son compatibles, pero para usar el men√∫ a√∫n debe tomar un teclado.  Por lo tanto, creo que la compatibilidad con el controlador nativo mejorar√° significativamente la jugabilidad. </li><li>  Mejora de sonido.  Actualmente, todos los efectos de sonido tienen el mismo volumen.  Los objetos que producen sonido, por ejemplo, campos de fuerza, se vuelven audiblemente agudos cuando golpean la pantalla, y se rompen tan bruscamente.  Ten√≠a curiosidad por c√≥mo sonar√≠an si el volumen de efectos en la distancia se desvanec√≠a.  Por ejemplo, apenas pod√≠amos escuchar el campo de fuerza cuando a√∫n no estaba en la pantalla, y al acercarnos se volver√≠a m√°s fuerte. </li><li>  C√°mara remota / ver la mayor parte del nivel.  El juego no fue dise√±ado para esto, por lo que esta posibilidad puede da√±ar el juego: el jugador comenzar√° a ver enemigos que no est√°n activos fuera de la pantalla, y cosas por el estilo.  Pero todav√≠a me pregunto c√≥mo se ver√° y jugar√°.  Al final, los jugadores a menudo se quejaron de este juego por su incapacidad para ver una parte suficiente del nivel.  Ser√≠a interesante agregar la opci√≥n de apagar el HUD o reemplazarlo por uno m√°s m√≠nimo con transparencia. </li><li>  Aumenta la resoluci√≥n de los gr√°ficos.  Esta caracter√≠stica a menudo se encuentra en muchos puertos / recreaci√≥n de juegos, y ser√≠a genial agregarla aqu√≠.  El motor ya le permite reemplazar los gr√°ficos de sprites con sus propias im√°genes, pero hasta ahora no pueden ser de mayor resoluci√≥n, porque todo se procesa en un peque√±o b√∫fer con un aumento posterior en la escala.  Primero, debe reemplazar este enfoque para que la escala se pueda realizar para objetos individuales. </li></ul><br>  No tengo ninguna hoja de ruta para el futuro, por lo que puedo implementar estos puntos en cualquier orden.  Pero antes de todo esto, el siguiente paso ser√° la integraci√≥n de Dear ImGui para ensamblar a√∫n m√°s el men√∫ de opciones, que a√∫n no est√° en el juego;  Adem√°s, habilitar√° o deshabilitar√° las mejoras anteriores.  ¬°Al final, dir√© que agradecer√© cualquier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener">ayuda para trabajar en GitHub</a> ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454570/">https://habr.com/ru/post/454570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454552/index.html">Docker-compose C√≥mo esperar hasta que el contenedor est√© listo</a></li>
<li><a href="../454556/index.html">Noticias del mundo de OpenStreetMap No. 462 (21.05.2019-27.05.2019)</a></li>
<li><a href="../454558/index.html">PHP Digest No. 157 (20 de mayo - 3 de junio de 2019)</a></li>
<li><a href="../454562/index.html">¬øPor qu√© el concepto de bytecode no es tan relevante como lo era antes?</a></li>
<li><a href="../454568/index.html">Mozilla calific√≥ la distribuci√≥n de paquetes web firmada digitalmente de Google como "mala"</a></li>
<li><a href="../454574/index.html">Aprendizaje autom√°tico en microfinanzas: construyendo un modelo de puntuaci√≥n para clientes con un historial de cr√©dito vac√≠o</a></li>
<li><a href="../454576/index.html">Los autores de GandCrab dejan de funcionar: afirman haber robado lo suficiente</a></li>
<li><a href="../454578/index.html">C√≥mo conectar la galer√≠a PhotoSwipe en la vista web de Android</a></li>
<li><a href="../454582/index.html">¬øSe debe almacenar la longitud de la matriz en una variable local en C #?</a></li>
<li><a href="../454584/index.html">Escuela de desarrollo de interfaz: an√°lisis de tareas para Minsk y un nuevo conjunto en Mosc√∫</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>