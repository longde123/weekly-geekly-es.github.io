<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüíª üàÇÔ∏è üõÄüèΩ Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 1 üßú üçÖ ‚úåüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Estamos publicando la primera parte de la traducci√≥n de otro art√≠culo de la serie sobre c√≥mo funciona Instagram con Python. El primer art√≠culo de esta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/475240/">  Estamos publicando la primera parte de la traducci√≥n de otro art√≠culo de la serie sobre c√≥mo funciona Instagram con Python.  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer</a> art√≠culo de esta serie habl√≥ sobre las caracter√≠sticas del c√≥digo del servidor de Instagram, que es un monolito que cambia con frecuencia y c√≥mo las herramientas de verificaci√≥n de tipos est√°ticos ayudan a administrar este monolito.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El segundo</a> material se trata de escribir la API HTTP.  Aqu√≠ hablaremos sobre los enfoques para resolver algunos de los problemas que Instagram encontr√≥ al usar Python en su proyecto.  El autor del material espera que la experiencia de Instagram sea √∫til para aquellos que puedan tener problemas similares. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/0h/_k/s9/0h_ks9h22wcs8uc2ohwld0f6uau.png"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Resumen de la situaci√≥n</font> </h2><br>  Veamos el siguiente m√≥dulo, que, a primera vista, parece completamente inocente: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mywebframework <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> db, route VALID_NAME_RE = re.compile(<span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9]+$"</span></span>) @route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span>     name: str</code> </pre> <br>  ¬øQu√© c√≥digo se ejecutar√° si alguien importa este m√≥dulo? <br><br><ul><li>  Primero, se ejecutar√° el c√≥digo asociado con la expresi√≥n regular que compila la cadena en un objeto de plantilla. </li><li>  Luego se <code>@route</code> decorador <code>@route</code> .  Si confiamos en lo que vemos, entonces podemos suponer que aqu√≠, tal vez, la representaci√≥n correspondiente se registra en el sistema de mapeo de URL.  Esto significa que la importaci√≥n habitual de este m√≥dulo lleva al hecho de que en otro lugar el estado global de la aplicaci√≥n est√° cambiando. </li><li>  Ahora vamos a ejecutar todo el c√≥digo del cuerpo de la clase <code>Person</code> .  Puede contener cualquier cosa.  El <code>Model</code> clase base puede tener una metaclase o <code>__init_subclass__</code> m√©todo <code>__init_subclass__</code> , que, a su vez, puede contener alg√∫n otro c√≥digo que se ejecute al importar nuestro m√≥dulo. </li></ul><br><h2>  <font color="#3AC1EF">Problema # 1: inicio lento del servidor y reinicio</font> </h2><br>  La √∫nica l√≠nea de c√≥digo para este m√≥dulo que (posiblemente) no se ejecuta cuando se importa es <code>return "Hello World!"</code>  .  Es cierto, ¬°con certeza no podemos decir esto!  Como resultado, resulta que al importar este m√≥dulo simple que consta de ocho l√≠neas (y a√∫n sin usarlo en nuestro programa), podemos provocar el lanzamiento de cientos o incluso miles de l√≠neas de c√≥digo Python.  Y esto sin mencionar que la importaci√≥n de este m√≥dulo provoca una modificaci√≥n de la asignaci√≥n de URL global ubicada en alg√∫n otro lugar del programa. <br><br>  Que hacer  Ante nosotros es parte de la consecuencia del hecho de que Python es un lenguaje interpretado din√°mico.  Esto nos permite resolver con √©xito varios problemas utilizando m√©todos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">metaprogramaci√≥n</a> .  Pero, sin embargo, ¬øqu√© tiene de malo este c√≥digo? <br><br>  De hecho, este c√≥digo est√° en perfecto orden.  Esto es as√≠ siempre y cuando alguien lo use en bases de c√≥digo relativamente peque√±as, en las que trabajan peque√±os equipos de programadores.  Este c√≥digo no causa problemas siempre y cuando la persona que lo usa tenga garantizado mantener un cierto nivel de disciplina en c√≥mo se usan exactamente las caracter√≠sticas de Python.  Pero algunos aspectos de este dinamismo pueden convertirse en un problema si hay millones de l√≠neas de c√≥digo en el proyecto en las que est√°n trabajando cientos de programadores, muchos de los cuales no tienen un conocimiento profundo de Python. <br><br>  Por ejemplo, una de las grandes caracter√≠sticas de Python es la velocidad de los pasos involucrados en el desarrollo por fases.  Es decir, el resultado de los cambios en el c√≥digo se puede ver literalmente inmediatamente despu√©s de realizar dichos cambios, sin la necesidad de compilar el c√≥digo.  Pero si estamos hablando de un proyecto con un tama√±o de varios millones de l√≠neas (y un diagrama de dependencia bastante confuso de este proyecto), entonces esta ventaja de Python comienza a convertirse en una desventaja. <br><br>  Se tarda m√°s de 20 segundos en iniciar nuestro servidor.  Y a veces, cuando no prestamos la debida atenci√≥n a la optimizaci√≥n, este tiempo aumenta a aproximadamente un minuto.  Esto significa que el desarrollador necesita 20-60 segundos para ver los resultados de los cambios realizados en el c√≥digo.  Esto se aplica a lo que puede ver en el navegador, e incluso a la velocidad de ejecuci√≥n de las pruebas unitarias.  Desafortunadamente, esta vez es suficiente para que una persona se distraiga con algo y se olvide de lo que hab√≠a hecho antes.  La mayor parte de este tiempo, literalmente, se gasta en importar m√≥dulos y crear funciones y clases. <br><br>  En cierto modo, esto es lo mismo que esperar los resultados de compilar un programa escrito en alg√∫n otro idioma.  Pero por lo general, la compilaci√≥n se puede hacer de forma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">incremental</a> .  El punto es que puede recompilar solo lo que ha cambiado y lo que depende directamente del c√≥digo cambiado.  Como resultado, generalmente la compilaci√≥n de proyectos, realizada despu√©s de hacer peque√±os cambios, es r√°pida.  Pero cuando se trabaja con Python, debido a que los comandos de importaci√≥n pueden tener cualquier tipo de efectos secundarios, no hay una manera confiable y segura de reiniciar el servidor de forma incremental.  Al mismo tiempo, la escala de los cambios no es importante y cada vez que tengamos que reiniciar completamente el servidor, importando todos los m√≥dulos, volviendo a crear todas las clases y funciones, volviendo a compilar todas las expresiones regulares, etc.  Por lo general, desde el momento del √∫ltimo reinicio del servidor, el 99% del c√≥digo no ha cambiado, pero a√∫n tenemos que hacer lo mismo una y otra vez para ingresar los cambios. <br><br>  Adem√°s de ralentizar a los desarrolladores, esto lleva al desperdicio improductivo de grandes cantidades de recursos del sistema.  El hecho es que estamos trabajando en un modo de implementaci√≥n continua de cambios, lo que significa una recarga constante del c√≥digo del servidor de producci√≥n. <br><br>  De hecho, aqu√≠ est√° nuestro primer problema: inicio lento y reinicio del servidor.  Este problema surge debido al hecho de que el sistema tiene que realizar constantemente una gran cantidad de acciones repetitivas durante la importaci√≥n de c√≥digo. <br><br><h2>  <font color="#3AC1EF">Problema # 2: Efectos secundarios de los comandos de importaci√≥n inseguros</font> </h2><br>  Aqu√≠ hay otra tarea que, como result√≥, los desarrolladores a menudo resuelven al importar m√≥dulos.  Esto es cargar configuraciones desde el almacenamiento de red de configuraciones: <br><br><pre> <code class="python hljs">MY_CONFIG = get_config_from_network_service()</code> </pre> <br>  Adem√°s de ralentizar el inicio del servidor, tampoco es seguro.  Si el servicio de red no est√° disponible, esto no solo conducir√° al hecho de que recibimos mensajes de error con respecto a la imposibilidad de cumplir con algunas solicitudes.  Esto har√° que el servidor no se inicie. <br><br>  Espesemos los colores e imaginemos que alguien agreg√≥ al m√≥dulo responsable de inicializar un servicio de red importante, un c√≥digo que se ejecuta durante la importaci√≥n.  El desarrollador simplemente no sab√≠a d√≥nde agregarle este c√≥digo, por lo que lo coloc√≥ en un m√≥dulo que se importa en las primeras etapas de inicio del servidor.  Result√≥ que este esquema funciona, por lo que la soluci√≥n se consider√≥ exitosa y el trabajo continu√≥. <br><br>  Pero luego alguien m√°s agreg√≥ en otro lugar el equipo de importaci√≥n, que a primera vista era inofensivo.  Como resultado, a trav√©s de una cadena de importaciones con una profundidad de doce m√≥dulos, esto condujo al hecho de que el m√≥dulo que descarga la configuraci√≥n de la red ahora se importa al m√≥dulo que inicializa el servicio de red correspondiente. <br><br>  Ahora resulta que estamos tratando de usar el servicio antes de que se inicialice.  El sistema se bloquea naturalmente.  En el mejor de los casos, si estamos hablando de un sistema en el que las interacciones son completamente deterministas, esto puede llevar al hecho de que el desarrollador pasar√° una o dos horas descubriendo c√≥mo un cambio menor condujo a una falla en algo, con √©l, Parece desconectado.  Pero en situaciones m√°s complejas, esto puede conducir a una "ca√≠da" del proyecto en producci√≥n.  Sin embargo, no hay formas universales de usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">linter</a> para combatir tales problemas o prevenirlos. <br><br>  La ra√≠z del problema radica en dos factores, cuya interacci√≥n conduce a consecuencias devastadoras: <br><br><ol><li>  Python permite que los m√≥dulos tengan efectos secundarios arbitrarios e inseguros que ocurren durante la importaci√≥n. </li><li>  El orden de importaci√≥n del c√≥digo no se establece expl√≠citamente y no se controla.  En la escala de un proyecto, una especie de "importaci√≥n integral" consiste en los comandos de importaci√≥n contenidos en todos los m√≥dulos.  En este caso, el orden de importaci√≥n de los m√≥dulos puede variar seg√∫n el punto de entrada del sistema utilizado. </li></ol><br>  <i><font color="#999999">Continuar√° ...</font></i> <br><br>  <b>Estimados lectores!</b>  ¬øHa encontrado problemas con respecto al inicio lento de proyectos de Python? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475240/">https://habr.com/ru/post/475240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475218/index.html">Protocolos criptogr√°ficos: definiciones, registros, propiedades, clasificaci√≥n, ataques.</a></li>
<li><a href="../475226/index.html">Pasant√≠a en la Fundaci√≥n Haxe</a></li>
<li><a href="../475228/index.html">Tenedor de n√≥mina. Eres un programador para mam√°</a></li>
<li><a href="../475236/index.html">Nunca ignores el entrenamiento de refuerzo de nuevo.</a></li>
<li><a href="../475238/index.html">Cronolog√≠a de Blade Runner: noviembre de 2019. ¬øEl pron√≥stico se hizo realidad?</a></li>
<li><a href="../475242/index.html">Uso de m√≥dulos estrictos en proyectos de Python a gran escala: experiencia de Instagram. Parte 2</a></li>
<li><a href="../475244/index.html">Nuevas caracter√≠sticas de JavaScript esperadas que debe conocer</a></li>
<li><a href="../475246/index.html">Programaci√≥n asincr√≥nica de Python: una breve descripci√≥n</a></li>
<li><a href="../475248/index.html">El uso de polyfills al escribir aplicaciones de navegador cruzado</a></li>
<li><a href="../475250/index.html">Como Redash not√≥ y solucion√≥ un problema que caus√≥ la degradaci√≥n del rendimiento del c√≥digo Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>