<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👂🏼 🎩 🏉 تخزين طويل الأجل لمقاييس بروميثيوس (أليكسي بالازتشينكو ، بيركونا) ⛹🏻 🚠 🧚🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="في وقت قصير ، أصبح Prometheus أحد أكثر أدوات المراقبة شعبية. شكرا ، على وجه الخصوص ، والسرعة العالية في عملها. يعد التخزين المحلي الخاص به مكانًا رائع...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تخزين طويل الأجل لمقاييس بروميثيوس (أليكسي بالازتشينكو ، بيركونا)</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441136/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  في وقت قصير ، أصبح Prometheus أحد أكثر أدوات المراقبة شعبية.  شكرا ، على وجه الخصوص ، والسرعة العالية في عملها.  يعد التخزين المحلي الخاص به مكانًا رائعًا لتخزين المقاييس على المدى القصير والعمل معهم.  في بعض الأحيان ، تريد الاحتفاظ بالمقاييس الموزعة لشهور وسنوات ، وتقليص البيانات القديمة تلقائيًا ، ولكن دون تغيير واجهة التعامل معها. </p><br><p style=";text-align:right;direction:rtl">  حول هذا ، فك تشفير تقرير أليكسي Palazhchenko في RootConf 2018. في التقرير: Prometheus ، التخزين المحلي TSDB ، التخزين عن بعد ، Prometheus ، PromQL ، TSDB ، Clickhouse ، PromHouse ، InfluxDB قليلاً. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/LXllYmb0RTk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p style=";text-align:right;direction:rtl">  من يهتم ، من فضلك ، تحت القط. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  أصدقاء!  مرحبا بالجميع!  اسمي أليكسي Palazhchenko.  أنا أعمل في بيركونا.  أود أن أخبركم عن التخزين طويل المدى للمقاييس في بروميثيوس. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/rw/vv/4v/rwvv4v4zpjhn5tlmrclgeii9mkq.png"></p><br><p style=";text-align:right;direction:rtl">  أنا أعمل في Percona وأنتج منتجًا يُسمى مراقبة وإدارة percona.  هذا هو الحل المعبأ الذي حدده عملائنا لأنفسهم.  PMM مفتوح المصدر بالكامل.  وهو يتألف من Prometheus ، و Grafana للرسوم البيانية ، وبرنامج تحليلات الاستعلام المخصص ، والملف الخاص بنا الذي يتيح لك القيام ببعض الإدارة.  على سبيل المثال ، يمكنك إضافة هدف كشط إلى بروميثيوس.  هذه هي مصادر جديدة سيأخذ منها المقاييس دون الحاجة إلى إدخال حاوية أو جهاز ظاهري يدويًا وتحرير ملف التكوين. </p><br><p style=";text-align:right;direction:rtl">  من المهم أن نفهم أن هذه ليست ادارة العلاقات.  ليس لدينا الإنتاج.  يقع إنتاجنا مع عملائنا.  للتجربة على ذلك ليست جيدة جدا.  لدينا أقرب شيء يمكن أن يسمى الإنتاج - هذا هو <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://pmmdemo.percona.com/</a> .  في وقت التقرير ، كان لا بد من إيقاف pmmdemo.percona.com بسبب الناتج المحلي الإجمالي. </p><br><p style=";text-align:right;direction:rtl">  نحن نقدم PMM للعملاء - حل محاصر: حاوية الرصيف أو الجهاز الظاهري.  انهم جميعا مثل بروميثيوس.  بعض الأشخاص الذين ينظرون إلى بروميثيوس لأول مرة يصادفون نموذج السحب.  للمبتدئين ، وهذا غير مريح.  عموما محادثة كبيرة منفصلة.  يمكنك الجدال حول طرق السحب أو الدفع.  في المتوسط ​​، هذا هو نفس الشيء تقريبا. </p><br><p style=";text-align:right;direction:rtl">  بعض الأشياء في بروميثيوس رائعة للغاية. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  لغة بروميثيوس للاستعلام هي في الحقيقة شيء رائع لا يوجد لديه مثيل في أي مكان. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  الشيء الثاني الذي يعجبك هو اكتشاف الخدمة.  إذا كان لديك نوع من البنية التحتية الديناميكية ، kubernetes ، فإنك لا تحتاج تلقائيًا إلى إضافة جميع الأهداف للمراقبة بيديك.  إذا كان ثابتًا - يمكن أيضًا القيام بذلك بكل بساطة.  تحتاج إلى استخدام ملف التكوين. </p><br></li></ul><br><p style=";text-align:right;direction:rtl">  عملاء بروميثيوس يعجبهم.  انهم يريدون الحفاظ على المقاييس أطول وأطول.  شخص ما يستخدم بروميثيوس للمراقبة التشغيلية فقط.  لكن هناك من يريد الحفاظ على المقاييس لفترة أطول ، ومشاهدة ديناميات ، مقارنة مع الرسوم البيانية قبل عام.  في الوقت نفسه ، ليس الهدف من التخزين طويل المدى للمقاييس هو هدف مشروع بروميثيوس.  في البداية ، تم إنشاؤه من أجل تخزين المقاييس لفترة قصيرة.  SoundCloud بتخزين المقاييس في بضعة أيام فقط.  هناك آليات في بروميثيوس تتيح لك القيام بذلك لفترة أطول ، لكنها مرتبة قليلاً على الجانب.  لذلك ، يمكننا اتخاذ قرار بشأن نظام Prometheus البيئي دون تغيير جوهر النظام نفسه.  بناءً عليها ، يمكننا اتخاذ قرارنا الخاص داخل النظام البيئي نفسه. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ws/1n/7k/ws1n7kpa7ohpkxwpxuli5dcpwuc.png"></p><br><p style=";text-align:right;direction:rtl">  هذا ليس تقريرًا عن الحلول الجاهزة.  هذا هو تقرير حول تجربتنا ، عن آلامنا ، عن محاولاتنا.  إذا كنت تتوقع أنه بعد هذا التقرير قمت بتنزيل مستودع أو حاوية عامل ميناء ، قم بتشغيله وسيعمل ، ثم هذا ليس كذلك.  ولكن في الوقت نفسه ، فهي قريبة بما فيه الكفاية لتكون كذلك.  لدينا بعض الأسس.  انهم جميعا مفتوحة المصدر.  يمكنك أن تجرب.  أنها ليست جاهزة للإنتاج حتى الآن.  لكن بالمعلومات الموجودة في هذا التقرير ، يمكنك فهم السبب ، فما الذي يمكن عمله بشكل أفضل.  يمكنك اتخاذ قرارك الخاص الذي يناسبك. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ej/4j/sm/ej4jsmldkwk-bsme40kqehzilqc.png"></p><br><p style=";text-align:right;direction:rtl">  كيف يتم تخزين المقاييس في بروميثيوس؟  هناك التخزين المحلي.  هناك تخزين عن بعد.  هذه هي في الواقع عالمين مختلفين.  أنها تتقاطع ضعيفة.  لذلك ، ينقسم التقرير أيضًا إلى قسمين. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jm/ic/81/jmic81mrsu49j-zxv6spn9aopac.png"></p><br><p style=";text-align:right;direction:rtl">  إذا كنت في تقرير سابق في القاعة الرئيسية ، حيث كان هناك مقدمة جيدة في Prometheus ، فأنت تعلم أن التخزين المحلي عبارة عن مكتبة منفصلة تسمى TSDB.  TSDB لا علاقة له مع OpenTSDB.  TSDB عبارة عن حزمة Go منفصلة يمكنك استخدامها من برنامج Go.  على مستوى مكتبة TSDB ، لا يوجد عميل أو خادم. </p><br><p style=";text-align:right;direction:rtl">  تم تحسين هذه المكتبة للعمل مع بيانات السلاسل الزمنية.  على سبيل المثال ، يحتوي TSDB على ترميز دلتا ، والذي يسمح لك بتخزين ليس الأرقام نفسها ، ولكن التغييرات بين هذه الأرقام.  هذا يسمح لك بتخزين 1 بايت بدلاً من 16 بايت.  1 بايت للوقت و 1 بايت للقيمة.  أي أنك تخزن في المتوسط ​​1 أو 2 بايت على وجه التحديد بسبب هذا الضغط الجيد. </p><br><p style=";text-align:right;direction:rtl">  تم تحسين TSDB لنماذج السحب.  يتم إضافة البيانات فقط هناك.  لا يمكن لـ Prometheus كتابة البيانات التاريخية.  لا يوجد API لهذا الغرض.  دلتا الحد الأقصى هو حوالي 5 دقائق.  إذا كانت البيانات قديمة ، فلن يتم قبولها. </p><br><p style=";text-align:right;direction:rtl">  لا يوجد <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">tsdb مضمن مختلط # 313</a> في TSDB.  هناك مشكلة مفتوحة تم فيها مناقشة حول حقيقة أن هناك عمومًا مشروعات تقوم بروميثيوس بشيء وهناك اختزال هناك.  حتى الآن ، الحل هو أن TSDB لن يضيف اختزال. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/5q/pb/vt/5qpbvtptau3gz7ygcxb9cl3nmzg.png"></p><br><p style=";text-align:right;direction:rtl">  كيف نحصل على البيانات من TSDB؟  TSDB هي قاعدة بيانات على القرص.  يمكنك العمل معه إذا كنت تكتب برنامج Go.  ولكن إذا لم تكتب برنامجًا في Go ، فهناك واجهة برمجة تطبيقات JSON تتيح لك إجراء استعلامات استعلام.  إذا كنت قد استخدمت Prometheus في أي وقت من الأوقات وقمت بإنشاء مخطط على الأقل ، فأنت تعرف واجهة برمجة تطبيقات Query القياسية ، حيث توجد معلمة استعلام يمكنك من خلالها تنفيذ أي استعلام PromQL ووقت اختياريًا.  إذا لم يكن هناك وقت ، فسيتم أخذ الوقت الحالي. </p><br><p style=";text-align:right;direction:rtl">  يتم تمييز استعلام معين على الشريحة ، والتي نادراً ما تراها في الحياة الواقعية.  هذا هو الاختراق.  هذا يسمح لنا بسحب جميع المقاييس التي لدى بروميثيوس.  كيف يعمل؟  على مستوى PromQL يقال أنه من المستحيل أن تكتب مثل هذا التعبير من شأنه أن يمسك في كل وقت seriers.  هذا مكتوب مباشرة في القواعد.  تقول قاعدة أخرى أنه لا يمكنك إنشاء تطابق تكون فيه جميع القيم فارغة.  إذا كتبت ببساطة الأقواس ، فلن ينجح ذلك.  إذا كتبت الاسم لا يساوي أي شيء (ليس قيمة فارغة) ، فلن يعمل.  ولكن هذا اختراق حقيقي يتيح لك القيام بذلك.  ومع ذلك ، لم يتم توثيقه بشكل خاص.  هناك تعليقات في الكود نفسه أن هذا يعمل. </p><br><p style=";text-align:right;direction:rtl">  الاستعلام الثاني هو query_range ، الذي يقوم بنفس الشيء ، لكنه يعرض لك البيانات في نطاق وبخطوة ما.  فهو يجعل استعلامًا أساسيًا عدة مرات لكل خطوة من البداية إلى النهاية.  هذا هو API المستخدمة لرسم الرسومات.  يستخدم API الأول للحصول على قيم فورية. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/nc/cm/cs/nccmcsyofzxubtca8yoyas7p6ag.png"></p><br><p style=";text-align:right;direction:rtl">  لدينا واجهة برمجة التطبيقات لاسترداد البيانات الوصفية.  إذا كنا نرغب في الحصول على جميع أسماء المقاييس ، فإننا نقوم بإجراء استعلام مثل هذا ، حيث تكون المطابقة عبارة عن مجموعة من المقاييس.  قد يكون هناك العديد من الحجج ، ولكن في هذه الحالة نمرر نفس المطابقة ، والتي يعود كل شيء إلينا. </p><br><p style=";text-align:right;direction:rtl">  واجهة برمجة التطبيقات الوصفية الثانية ، والتي تُرجعنا قيمة جميع التصنيفات.  إذا كنا نريد أن نرى قائمة بجميع الوظائف ، فبدلاً من label_name ، نكتب الوظيفة ونحصل على هذه القائمة.  ترجع واجهات برمجة التطبيقات هذه JSON إلينا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/qe/ku/j4/qekuj4lgm4zp-x07kvhoorux_w0.png"></p><br><p style=";text-align:right;direction:rtl">  هناك واجهة برمجة تطبيقات أخرى تُرجع جميع مقاييس Prometheus نفسها بتنسيق موطن للمصدرين.  يسمى التنسيق expfmt.  في Prometheus نفسها ، هناك واجهة برمجة تطبيقات في الاتحاد تسمح لك بتقديم مثل هذا الطلب.  ما هذا؟  الخيار الأسهل ، إذا كان لديك بعض الأكواد التي تعمل بالفعل مع expfmt ، فلن تحتاج إلى إعادة تدريبه للعمل مع بعض واجهات برمجة التطبيقات المخصصة JSON.  هذا التنسيق أسهل كثيرًا في التدفق ، لأنه إذا كان لديك JSON في مكان ما في المستوى الأعلى من الكائن ، فغالبًا ما تحتاج إلى تحليل هذا الكائن بالكامل.  هنا يمكن أن يتم ذلك سطرا سطرا. </p><br><p style=";text-align:right;direction:rtl">  الشيء الأكثر أهمية هو أنه واجهة برمجة تطبيقات منفصلة.  يعمل تماما مثل التصدير الحقيقي.  يمكنك أن تأخذ بروميثيوس الأخرى لكشطها.  هذه هي وظيفة منتظمة مع المعلمات المعتادة.  تحتاج إلى تمرير المعلمة - استعلام url.  إذا قمت بتقديم طلب حليقة ، فستحصل على نفس الشيء هنا.  نحصل على جميع المقاييس للقيمة الزمنية الحالية.  التحذير الوحيد: يجب عليك تعيين honor_labels حتى لا يؤدي Prometheus ، الذي سيقوم بإلغاء بروميثيوس آخر من خلال واجهة برمجة التطبيقات هذه ، إلى فرك قيمة تسمية الوظيفة والمثيل.  باستخدام واجهة برمجة تطبيقات الاتحاد هذه ، يمكنك تحميل جميع البيانات من بروميثيوس إلى آخر. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/64/lc/yy/64lcyynloe47gbkjlelzyddss60.png"></p><br><p style=";text-align:right;direction:rtl">  كيف يمكن استخدام هذا؟ </p><br><p style=";text-align:right;direction:rtl">  أولاً ، الشيء الأكثر أهمية هو أنك لست بحاجة إلى القيام بذلك.  تم تحسين TSDB في أوضاع التشغيل المختلفة.  إذا كان لديك بروميثيوس يلغي الكثير من البيانات ، فإنه يفعل الكثير من I / O.  إذا كنت تستخدم واجهة برمجة تطبيقات الاتحاد ، فستزيد كمية إخراج المدخلات بحوالي مرتين.  هناك فروق دقيقة.  اعتمادًا على عدد المرات التي تتخلص فيها من الاتحاد الفيدرالي وعدد مرات كشط الأهداف.  إذا لم يتم تغيير الوقت ، فهذا يضاعف العبء حقًا.  لذلك ، إذا كنت ترغب في توسيع نطاق بروميثيوس الخاص بك وتمكين الاتحاد ، فسوف يقتل.  سوف الحمل مضاعفة. </p><br><p style=";text-align:right;direction:rtl">  اللحظة الثانية.  سوف تكون تخطي البيانات.  سوف تحصل على تعارض في البيانات.  لماذا هذا  واجهة برمجة التطبيقات هذه ، مثل أي API تقريبًا في بروميثيوس ، ليست ذرية.  في حالة وصول بيانات جديدة ، ستنتهي عملية إلغاء جديدة في الوقت الذي لا يزال فيه طلب الاتحاد الخاص بك قيد التقدم ، يمكنك الحصول على بيانات واحدة لسلسلة زمنية واحدة وبيانات جديدة لآخر.  إذا كانت سلسلة زمنية غير مرتبطة ، فهي ليست مخيفة عمومًا.  ولكن إذا كان لديك ملخص أو رسم بياني ، والذي يمثل على مستوى expfmt بعدة مقاييس أساسية ، فسيكون هناك تضارب بينهما. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/_0/5h/lk/_05hlkpn57b8klhjwborhup4bds.png"></p><br><p style=";text-align:right;direction:rtl">  كيف يمكننا حل هذه المشكلة الذرية؟  لدى Prometheus قواعد تسجيل تتيح لك إنشاء سلسلة زمنية جديدة من سلسلة زمنية موجودة.  هذا يمكن القيام به في كثير من الأحيان أقل.  هذه هي طريقة واحدة للقيام اختزال.  على سبيل المثال ، قم بإلغاء الهدف كل ثانية ، لكننا نريد بعد ذلك تجميع node_cpu في دقيقة واحدة.  يتيح لك التجميع في الإصدار 2.0 من بروميثيوس القيام بهذه المجموعات بالتسلسل.  يتم تنفيذ القواعد الموجودة في نفس المجموعة بشكل متسلسل.  في هذه المرحلة ، لا توجد مشكلة ذرية ، ولا توجد مشكلة في أن البيانات ستتغير في العملية.  ولكن هذا لا يحل مشكلة حقيقة أنه من المقبول أن بعض البيانات الأخرى التي ترتبط منطقيا مع هذا ، ولكن ليست مرتبطة من وجهة نظر نموذج البيانات.  لا يوجد أي ذرية نقية بعد.  هناك مشكلة مفتوحة حول هذا الموضوع.  يمكنك القيام به لقطات.  يمكنك إنشاء استعلام PromQL إلى قاعدة بيانات TSDB وإسقاط جميع العينات التي تكون أقل من بعض قيمة الوقت الذي بدأ في التقييم من القيم التي تم الحصول عليها.  ستكون هذه أسهل طريقة ، لكن لم يتم القيام بها حتى الآن. </p><br><p style=";text-align:right;direction:rtl">  من المهم أن نفهم أن قواعد التسجيل يجب أن تتم على البروميثيوس الأدنى ، وليس على القاعدة التي يفعلها الاتحاد.  خلاف ذلك ، سوف تتخطى القمم ، والرصد الخاص بك لن يعمل بشكل صحيح. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/kp/jf/hd/kpjfhdz8boamndunerhcx2vgebq.png"></p><br><p style=";text-align:right;direction:rtl">  كيف يمكننا استخدام هذه المجموعة من هذه الأشياء لإجراء الاختزال والتخزين على المدى الطويل. </p><br><p style=";text-align:right;direction:rtl">  أول واحد.  لقد أنشأنا اتحادًا وتنزيل جميع البيانات من بروميثيوس.  هذا التعبير المنتظم الغريب يشبه zoidberg - إنه في الواقع مجرد القولون.  علامة النجمة على يسار ويمين القولون.  نستخدم الاسم القياسي لقواعد التسجيل ، مما يضيف نقطتين إلى المنتصف.  عند تقسيم الاسم الأصلي ، سيكون هناك مستوى تجميع على اليسار ، ووظيفة على اليمين.  والقولون العادي متري لا.  إذا كان هناك نقطتين ، فهذه علامة على أن هذا تجميع.  بعد ذلك ، نستخدم هذا الاسم المتري في الرسم البياني لدينا.  إذا كنا نريد جدولنا الزمني ، فإن لوحة القيادة لدينا في grafana تعمل مع Prometheus الرئيسي ، ومع من هم أعلى ، يمكننا استخدام التعبير <strong>أو</strong> .  نأخذ إما متري واحد أو آخر ، وهذا يتوقف على أي واحد هو.  يمكننا خداع واستخدام إعادة التسمية لإعادة تسمية المقياس الجديد إلى الاسم القديم.  هذا هو نهج خطير إلى حد ما.  يمكنك تهجئة المرفقات العادية بشكل غير صحيح وسيكون لديك تعارض في سلسلة زمنية.  سوف بروميثيوس كتابة العديد من التحذيرات إلى السجل.  سترى هذا ، ولكن العثور على السبب يمكن أن يكون صعبا للغاية.  ولكن إذا تم القيام به بعناية ، على سبيل المثال ، إنشاء هذه التعبيرات العادية برمجيًا ، فإن هذا سوف ينجح.  بعد ذلك ، سيكون لديك لوحة معلومات عادية حيث يتم استخدام node_cpu فقط.  اعتمادًا على بروميثيوس المستخدم ، ستتلقى إما بيانات أولية أو بيانات مجمعة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/hd/ft/1x/hdft1xwgw_61j7tab_3feehhsgy.png"></p><br><p style=";text-align:right;direction:rtl">  كما قلت ، يمكن إنشاء قواعد التسجيل بكل بساطة.  نحن فقط الحصول على جميع السلاسل الزمنية من خلال api التي أظهرتها بالفعل.  نقوم بإنشاء قواعد ويجب أن تستخدم هذه القواعد الوظائف والمشغلين الصحيحين.  لا حاجة لاستخدام معدل مع مقياس هناك.  هذا لن يعمل بشكل صحيح.  يجب أن تستخدم فقط مع العد.  على المستوى الذي تعمل فيه ، قد لا تتوفر لديك معلومات حول أنواع البيانات.  على سبيل المثال ، إذا كنت تستخدم expfmt.  هناك معلومات حول الأنواع.  إذا كان JSON API ليس هناك.  نتيجة لذلك ، فإن التعبير الذي تنشئه تلقائيًا قد لا يكون له أي معنى مادي.  لذلك ، يمكنك استخدام قائمة بيضاء أو قائمة سوداء هناك.  بناءً على هذا ، قم بإنشاء القاعدة التي تحتاجها ، أو قم بإلقاء تلك القواعد التي لا معنى لها.  هناك أداة promtool تتيح لك التحقق من أن القواعد التي قمت بإنشائها ، والتكوين الذي أنشأته ، أمر منطقي.  لديها بناء الجملة الصحيح. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/om/wc/fv/omwcfvvh7mc8bky3zkble7vimqm.png"></p><br><p style=";text-align:right;direction:rtl">  إذا كان لدينا Grafana وكان هناك العديد من Prometheus ، نحتاج إلى معرفة أي Prometheus لإرسال الطلب إليه.  كيف نفعل هذا؟ </p><br><p style=";text-align:right;direction:rtl">  إحدى الطرق هي وضع وكيل خاص يبحث في الوقت في الطلب ، واعتمادًا على هذا ، حدد Prometheus.  تحتوي الاستعلامات على وقت البدء ووقت الانتهاء.  بناءً على ذلك ، يمكنك القيام بالتوجيه بيديك.  يمكن للمرء أن يكتب نوعا من البرنامج الذي يفعل هذا.  في الممارسة العملية ، يتم ذلك عن طريق nginx باستخدام وحدة lua أو برنامج صغير. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ff/ve/vz/ffvevzimxzpnrjrqirbkuqssiqm.png"></p><br><p style=";text-align:right;direction:rtl">  هل نحن حقًا بحاجة إلى واجهة برمجة تطبيقات؟  هل يمكننا العمل مع TSDB مباشرة؟  هناك فارق بسيط.  أولاً ، إذا حاولنا استخدام TSDB ، الذي تستخدمه بروميثيوس الآن ، فلن نتمكن من القيام بذلك.  هناك ملف قفل خاص يمنع هذا.  إذا كتبنا رمزًا سيتجاهل هذا الأمر ويحاول قراءة البيانات أو كتابتها ، فنحن نضمن إتلافها.  علاوة على ذلك ، حتى القراءة.  ما الذي يمكن عمله؟  يمكننا قراءة البيانات من خلال واجهة برمجة التطبيقات وإنشاء TSDB جنبًا إلى جنب.  ثم توقف عن بروميثيوس واستبدله بـ TSDB.  ولكن في الوقت نفسه ، يمكننا استنزاف الأداء إذا قرأنا جميع البيانات من خلال واجهة برمجة التطبيقات.  سأتحدث عن هذا بعد قليل. </p><br><p style=";text-align:right;direction:rtl">  الخيار الثاني.  يمكنك نسخ (إنشاء نسخة احتياطية ساخنة) هذه الملفات ، أي نسخ كما هي.  نعم ، سوف تتضرر.  عندما تفتح ، سيكون لديك تحذير من تلف البيانات.  انهم بحاجة الى ان تكون ثابتة.  قد تفقد البيانات الجديدة.  لكن هذا لا يهمنا.  نريد اختزال البيانات القديمة.  يمكن إجراء الاختزال باستخدام PromQL.  ولكن هناك فارق بسيط.  يصعب تمزيقه من Prometheus أكثر من TSDB.  إذا كنت معتادًا على إدارة Go و التبعية ، فإن البائع PromQL هو ألم كبير.  أنا لا أنصحك.  تجنب هذا إذا كان ذلك ممكنا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/2z/ii/fs/2ziifscme6pqm1ppf1n9ripipuq.png"></p><br><p style=";text-align:right;direction:rtl">  نمر إلى التخزين البعيد.  هل عمل أي شخص مع Remote Storage في بروميثيوس؟  قليل الأيدي.  التخزين عن بُعد عبارة عن واجهة برمجة تطبيقات موجودة منذ فترة طويلة.  الآن في الإصدار 2.2 التخزين عن بعد - تم وضع علامة على أنها تجريبية.  علاوة على ذلك ، من المعروف أن واجهة برمجة تطبيقات التخزين البعيد ستتغير بالتأكيد. </p><br><p style=";text-align:right;direction:rtl">  التخزين عن بعد يسمح لك بالعمل فقط مع البيانات الخام.  لا يوجد PromQL في الإدخال أو الإخراج.  عندما تقرأ ، لا يمكنك استخدام القوة الكاملة لـ PromQL.  يقوم بشكل أساسي بضخ جميع البيانات من Remote Storage التي تطابق الحالة.  مزيد من PromQL يعمل بالفعل معهم.  هذا له حمولة كبيرة جدا.  تحتاج إلى ضخ الكثير من البيانات عبر الشبكة.  لذلك ، في الإصدار 2.3 من بروميثيوس ، والذي لم يتم إصداره بعد ، لكن تم تأجيله بالفعل ، ستتم قراءة تلميح.  سنتحدث عن هذا في وقت لاحق قليلا. </p><br><p style=";text-align:right;direction:rtl">  لا واجهة برمجة تطبيقات للبيانات الوصفية حتى الآن.  لا يمكنك إنشاء واجهة برمجة التطبيقات التي ترجع جميع السلاسل الزمنية من التخزين البعيد.  إذا قمت بتقديم طلب إلى API من Prometheus ، فلن يعمل في التخزين البعيد.  سيعود لك السلسلة الزمنية الموجودة في قاعدة البيانات المحلية.  إذا تم تعطيل قاعدة البيانات المحلية الخاصة بك ، فسوف يعيدك 0. والتي قد تكون غير متوقعة بعض الشيء.  الآن يستخدم API هذا ProtoBuf وسيتم تغييره بالتأكيد إلى gRPC في المستقبل.  لم يفعلوا ذلك بعد ، لأن gRPC يتطلب HTTP2.  وفي الممارسة العملية لديهم مشاكل معه. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lc/7v/ij/lc7vijvha-gtzs_oj74xszwk488.png"></p><br><p style=";text-align:right;direction:rtl"> واجهة برمجة تطبيقات الكتابة تبدو هكذا.  يحتوي الطلب على مجموعة من التسميات.  تحدد مجموعة التسميات بشكل فريد السلسلة الزمنية.  <code>__name__</code> هو مجرد تسمية تحمل اسمًا خاصًا.  والعينات هي مجموعة من الوقت والقيم - int64 و float64.  عند التسجيل ، يكون الأمر غير مهم.  من المفترض أن قاعدة البيانات التي تكتب هذا بنفسها ستفعل كل شيء بشكل صحيح.  قد تقوم بروميثيوس ببعض التحسينات ولا تقوم بترتيبها مرة أخرى.  وفقا لذلك ، طلب الكتابة هو مجرد سلسلة زمنية قليلة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xd/qr/ud/xdqrudjh5lpomcepkdmkjcfegt0.png"></p><br><p style=";text-align:right;direction:rtl">  تكوين الكتابة له تكوين مرن إلى حد ما.  هناك العديد من الخيارات لتكوين تزامن الكتابة.  ما يطلق عليه بروميثيوس شاردس هو في الأساس طلبات تنافسية.  يمكنك تحديد الحد الأقصى لعدد العينات في طلب واحد ، والحد الأقصى للطلبات المتوازية ، والمهلة الزمنية ، وكيفية التكرار ، أي التراجع.  بالنسبة للعديد من قواعد البيانات ، 100 عينة في المرة الواحدة - يمكن أن يكون هذا صغيرًا جدًا.  إذا كنت تستخدم ClickHouse ، كما نفعل ، فبالطبع يجب زيادة القيمة بشكل كبير.  خلاف ذلك ، سيكون غير فعال للغاية. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/eb/gk/ew/ebgkewr7k-i2yho9mh7dbogcipm.png"></p><br><p style=";text-align:right;direction:rtl">  واجهة برمجة تطبيقات القراءة عن بُعد تبدو هكذا.  إنه مجرد نطاق زمني من البداية إلى النهاية ومجموعة مطابقة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/hv/kn/jo/hvknjowgf6h9pebjvvhbspe7jac.png"></p><br><p style=";text-align:right;direction:rtl">  المطابقة هي في الأساس مجموعة من أزواج الاسم والقيمة - تسمية عادية ونوع الحالة.  في المقارنة ، هناك المساواة أو عدم المساواة أو التعبيرات العادية.  هذا هو محدد السلسلة الزمنية المعتاد الذي تراه في PromQL.  لا توجد ميزات هنا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ri/hu/ap/rihuap_py_s_hrp0oywqnyx6yee.png"></p><br><p style=";text-align:right;direction:rtl">  الجواب عبارة عن سلسلة زمنية قليلة تطابق هذا الاستعلام.  هنا يجب فرز العينات حسب الوقت.  مرة أخرى ، هذا يساعد بروميثيوس على توفير وحدة المعالجة المركزية قليلاً - لا حاجة للفرز.  ولكن من المفترض أن قاعدة البيانات الخاصة بك يجب أن تفعل هذا.  في معظم الحالات ، سيكون الأمر كذلك ، لأنه على الأرجح ، سيكون هناك فهرس في الوقت المحدد. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zu/yd/fx/zuydfxti6mozpsz5v60f_i1laic.png"></p><br><p style=";text-align:right;direction:rtl">  بروميثيوس 2.3 قدم قراءة تلميح.  ما هذا  هذه فرصة لإخبار Prometheus بالوظيفة الداخلية التي تعمل مع السلسلة الزمنية المطلوبة والتي سيتم تطبيقها.  هذا يمكن أن يكون إما وظيفة أو عامل التجميع.  قد يكون معدل.  بمعنى ، يطلق عليه func ، ولكن في الحقيقة يمكن أن يكون sum ، والذي من وجهة نظر PromQL ليس في الواقع وظيفة على الإطلاق.  هذا هو المشغل.  وخطوة.  في المثال السابق ، كان هناك معدل 1 دقيقة.  هنا معدل هو وظيفة ودقيقة واحدة في المللي ثانية كخطوة.  يمكن تجاهل هذا التلميح بواسطة قاعدة البيانات البعيدة.  في الوقت نفسه ، لا يوجد أي إشارة في الإجابة سواء تم تجاهله أم لا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/6_/ms/9_/6_ms9_zh9txqwdafxjoenbdn8so.png"></p><br><p style=";text-align:right;direction:rtl">  ما هو تكوين القراءة؟ </p><br><p style=";text-align:right;direction:rtl">  أولاً ، يوجد مثل هذا التكوين required_matchers.  هذا يسمح لك بإرسال طلب تخزين عن بعد يطابق التعبير.  لقراءة البيانات المجمعة من "التخزين البعيد" ، يجب عليك استخدام استعلام يحتوي على نقطتين. </p><br><p style=";text-align:right;direction:rtl">  هناك خيار يسمح لك بقراءة أو عدم قراءة البيانات الحديثة من وحدة التخزين عن بُعد ، الموجودة في TSDB.  عادة في التكوين القياسي ، يوجد TSDB محلي صغير مكتوب على القرص المحلي.  انها تخزن هناك لعدة ساعات أو عدة أيام.  تتم قراءة البيانات التي تستخدمها الآن ، والتي يتم استخدامها للتنبيهات ، والتي يتم استخدامها لإنشاء لوحة المعلومات ، فقط من TSDB المحلي.  إنه سريع ، لكنه لا يسمح لنا بتخزين الكثير من البيانات. </p><br><p style=";text-align:right;direction:rtl">  سيتم قراءة البيانات التاريخية القديمة من وحدة التخزين عن بُعد.  هذا يجعل من الواضح كيفية اتصال التخزين المحلي والتخزين عن بعد مع بعضهما البعض.  لا يوجد إلغاء البيانات المكررة. </p><br><p style=";text-align:right;direction:rtl">  أساسا ما يحدث.  يتم أخذ البيانات من وحدة التخزين المحلية ، ويتم أخذ البيانات من وحدة التخزين عن بُعد في حالة تمكين read_recent.  هم فقط دمج معا.  يبدو أن هذه ليست مشكلة.  إذا افترضنا أننا لم نخفض حجم البيانات الحديثة ، فهذه البيانات هي بالضبط نفس البيانات ، فهي تتزامن تمامًا مع البيانات المحلية ، وسيكون لدينا ضعف عدد العينات ، ويجب ألا نؤثر على أي وظائف.  ليس حقا  هناك وظيفة irate () وزوج لها للمقياس ، مما يعيدنا إلى الفرق بين القيمتين الأخيرتين.  إنها تنظر إلى الوراء في النطاق الزمني المشار إليه ، ولكنها تستخدم فقط القيمتين الأخيرتين.  إذا كان لدينا آخر قيمتين لها نفس الوقت ، فسيكون الفرق صفراً.  هذا خطأ ومن المستحيل تقريبًا العثور عليه.  تم إصلاحه قبل أربعة أيام فقط.  هذه <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">تذكرة</a> لأي شخص مهتم. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/-q/3w/dw/-q3wdw3czygpvkk009lrnhumska.png"></p><br><p style=";text-align:right;direction:rtl">  ومن المثير للاهتمام ، أن القراءة عن بُعد تم تنفيذها من قبل بروميثيوس منذ الإصدار 1.8.  هذه هي الطريقة التي تسمح لك بقراءة بيانات Prometheus القديمة عند الترحيل إلى الإصدار 2.x.  تنصح الطريقة الرسمية بتوصيله كقراءة عن بعد.  سيتم طرح البيانات حسب الحاجة. </p><br><p style=";text-align:right;direction:rtl">  يمكن استخدام القراءة عن بُعد للقيام بتوجيه الاستعلام دون وكيل.  في إحدى الشرائح السابقة ، أوضحت أنه ، وفقًا للوقت ، يمكننا القيام بالتوجيه على أحد بروميثيوس أو آخر.  بنفس الطريقة ، يمكننا تجنب هذا.  فقط قم بتوصيل Prometheus أدناه وهو للقراءة عن بعد - وسيتم قراءة البيانات من هناك.  ولكن هناك تعديل لحقيقة أنه بالطبع سيتم ضخ الكثير من البيانات.  خاصة إذا كنت لا تستخدم تلميح الاستعلام. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gq/op/fz/gqopfzpgoe3kidpqufnedn5gfrk.png"></p><br><p style=";text-align:right;direction:rtl">  لماذا clickhouse؟ </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  لحلنا البحثي ، اخترنا ClickHouse ، لأننا نظرنا فيه لفترة طويلة.  لدينا أشخاص يشاركون باستمرار في أداء قاعدة البيانات ، والتحقق باستمرار من قواعد البيانات الجديدة.  تعمل شركتنا في قواعد البيانات مفتوحة المصدر. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  نود حقا أدائها الخام.  قوتها من حيث وحدة المعالجة المركزية ، والوقت وهلم جرا ، جيدة جدا.  تتحدث معظم هذه الأنظمة عن قابلية التوسع غير المحدودة ، ولكن لا تتحدث كثيرًا عن الكفاءة لخادم واحد.  يقوم العديد من عملائنا بتخزين المقاييس على زوج من الخوادم. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  المدمج في النسخ المتماثل ، sharding. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  GraphiteMergeTree هو محرك خاص لتخزين بيانات الجرافيت.  في البداية كان مهتمًا جدًا بنا. </p><br></li></ul><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ot/nk/sn/otnksno5uhhcgn7j5-fp5xnxneq.png"></p><br><p style=";text-align:right;direction:rtl">  تم تصميم المحرك من أجل مجموعة بيانات الجرافيت (ترقق وتجميع / حساب). </p><br><p style=";text-align:right;direction:rtl">  يقوم الجرافيت بتخزين البيانات الكاملة في ClickHouse ، ويمكنه استلامها ، ويضيف كذلك أنه مع التخفيف من استخدام الجرافيت ، يتم استخدام MergeTree بدون ترقق.  الشعور هو أن البيانات ممتلئة دائمًا ، ولا يتم الكتابة عليها ، إنها مجرد تحسين للقراءة.  لكن عموما ليس سيئا.  عندما نقوم بالقراءة ، لا نقوم بضخ البيانات ، يتم تجميعها تلقائيًا ، نحصل على القليل من البيانات - هذا جيد.  الجانب السلبي بالنسبة لنا هو أن يتم تخزين جميع البيانات. </p><br><p style=";text-align:right;direction:rtl">  كنت أستعد في بداية الشهر للتقرير.  يأتي شخص ما في محادثة برقية ويسأل - "Downsample بيانات GraphiteMergeTree"؟  أنا أكتب بالفعل لا.  الوثائق تقول لا.  لكن الشخص الآخر في الدردشة يرد "نعم ، تحتاج إلى تحسين الاتصال".  تشغيل ، تحقق - نعم الحقيقة.  الوثائق هي في الأساس خطأ.  ثم قرأت شفرة المصدر ، والتحقق ، اتضح أن هناك الأمثل ، وتحسين النهائي.  تم إنشاء Optify final في الأصل خصيصًا لـ GraphiteMergeTree.  في الواقع الاختزال يفعل.  ولكن يجب أن يطلق عليه بيديه. </p><br><p style=";text-align:right;direction:rtl">  يحتوي GraphiteMergeTree على نموذج بيانات مختلف.  ليس لديه تسميات.  كتابة كل ذلك بفعالية باسم المقاييس لا يعمل بشكل جيد للغاية. </p><br><p style=";text-align:right;direction:rtl">  يتم تخزين مقاييس الاسم في جدول واحد.  اسم المقاييس له طول مختلف.  يؤدي هذا إلى حقيقة أننا إذا قمنا بإجراء بحث فهرس باسم المقياس ، نظرًا لأن الطول مختلف ، فلن يكون هذا المؤشر فعالًا كما لو كان لهذا المؤشر قيمة طول ثابتة.  لأنك بحاجة إلى إجراء بحث في الملفات.  من المستحيل تحديد مكان الهبوط بدقة من أجل إجراء بحث ثنائي. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/c3/v4/zf/c3v4zfriducmhoahjwujmp1zdga.png"></p><br><p style=";text-align:right;direction:rtl">  لذلك ، جعلوا مخططهم الخاص.  توضح الشريحة كيف نقوم بتخزين السلاسل الزمنية في قاعدة البيانات.  التاريخ الذي تحتاجه ClickHouse هو بصمة.  إذا نظرت إلى مصادر Prometheus أو TSDB ، فأنت تعلم أن بصمة الإصبع هي عبارة عن مجموعة اختبارية سريعة قصيرة بشكل أساسي لسلسلة زمنية الاسم الكامل.  البصمة هي مزيج من جميع التسميات والمفاتيح والقيم.  الاسم هو تسمية عادية.  نستخدم نفس الخوارزمية للتوافق.  الخصم من شيء يمكن أن تكون مريحة.  البصمة هي نفسها ويمكن التحقق منها في TSDB والتخزين لدينا هي نفسها.  يتم تخزين الملصقات في JSON خاص ، والذي يسمح ClickHouse للعمل معها مع وظائفها القياسية.  هذا مضغوط JSON بدون مسافات ، مع تسمية مبسطة قليلاً.  لا يستخدم هذا الجدول أثناء التشغيل.  يتم تخزينه دائمًا في ذاكرة الحل الفعلي لدينا ، والذي يسمى PromHouse.  يتم استخدامه فقط عندما نبدأ تشغيل الخادم من أجل معرفة السلسلة الزمنية.  انها مطروحة.  مع وصول سلسلة زمنية جديدة ، نسجلها هناك.  يمكن لجميع مثيلات PromHouse المتعددة قراءة نفس الجدول.  يخبرنا ReplacingMergeTree أن هذه السلاسل الزمنية - هناك عدة حالات مختلفة - تكتب نفس السلاسل الزمنية.  سوف يجادلون - ولن تكون هناك مشكلة هنا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ms/lg/1t/mslg1tnbc97nrlauwcr9ekj-p3k.png"></p><br><p style=";text-align:right;direction:rtl">  نقوم بتخزين العينات في جدول منفصل بكفاءة عالية.  مع قيمة طول ثابتة ، تكون بصمة الإصبع هذه هي نفس الوقت والقيمة.  نحصل على 24 بايت لكل عينة.  لديها طول ثابت بدقة.  يتم تخزين كل عمود على حدة.  بحث بصمات الأصابع فعال لأننا نعرف أن الحجم ثابت.  لا توجد مشكلة مثل GraphitmergeTree عندما تكون سلسلة.  نستخدم التقسيم المخصص.  مؤشر بصمة الأساسي والوقت. </p><br><p style=";text-align:right;direction:rtl">  24 بايت هو نسخة مبسطة.  في الواقع ، يضغط جيدا.  في الواقع يستخدم مساحة أقل.  في أحدث اختباراتنا ، تكون نسبة الضغط حوالي 1 إلى 42. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wu/5y/24/wu5y2499vjvrcm37ct1gudfrpym.png"></p><br><p style=";text-align:right;direction:rtl">  كيف يمكننا إجراء الاختزال اليدوي إذا كان لدينا GraphiteMergeTree ، ولكن ليس بنفس الطريقة التي نرغب فيها.  في الواقع ، يمكننا أن نفعل ذلك باليد.  كما فعلت سابقا تقاسم ، التقسيم ، عندما لم يكن هناك شيء مدمج.  نصنع طاولة جديدة بأيدينا.  عندما تأتي إلينا عينة زمنية ، نحدد الجدول الذي نكتب إليه. </p><br><p style=";text-align:right;direction:rtl">  نختار الوقت من الاستعلام الذي نقرأ منه الجدول.  إذا حدثت القراءة على الحدود ، فسنقرأ عدة جداول.  التالي نحمل هذه البيانات.  يمكن للمرء استخدام طريقة العرض لهذا.  على سبيل المثال ، قم بعمل طريقة عرض لعدة جداول ، مما يسمح بقراءتها في استعلام واحد.  ولكن هناك خطأ في ClickHouse: المسند من العرض لا يتم استبداله في الاستعلامات.  لذلك ، إذا قمت بتقديم طلب في العرض ، فسيذهب إلى جميع الجداول.  عرض لا يمكننا استخدام. </p><br><p style=";text-align:right;direction:rtl">  كيف نفعل الاختزال؟  نخلق جدول مؤقت.  انسخ الإدخال في بيانات محددة منه باستخدام الوظائف الصحيحة. </p><br><p style=";text-align:right;direction:rtl">  نجعل إعادة تسمية التي هي الذرية تحت القفل العالمي.  نحن نعيد تسمية الجدول الحالي إلى القديم.  جديدة إلى القائمة.  نسقط الجدول القديم.  لدينا بيانات لمدة 148 يومًا.  ما هي المشكلة هنا؟  تضاف الى تبدو جميلة.  في الواقع ، نحن بحاجة إلى تطبيق الوظائف الصحيحة ، التجميع الصحيح للقيام به.  في الممارسة العملية ، لا يمكن القيام بذلك بطلب واحد كبير.  حتى عدد قليل من الطلبات الكبيرة لا يمكن تقديمها.  هذا يجب القيام به من التعليمات البرمجية.  يرسل الرمز عددًا كبيرًا من الطلبات الصغيرة.  لقد بذلنا قصارى جهدنا للقيام بذلك مع الطلبات الكبيرة ، ولكن هذا ليس فعالًا للغاية.  تستغرق بيانات الاختزال من يوم واحد حتى الآن أقل من يوم واحد.  حسب كمية البيانات ، قد يستغرق الأمر وقتًا طويلاً. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/7c/94/h4/7c94h4t2bbvk5x-3acoftonomxa.png"></p><br><p style=";text-align:right;direction:rtl">  سيكون ClickHouse تحديث / حذف.  حذف بالفعل حصلت على الإصدار الأول.  إذا نجح التحديث / الحذف ، فيمكن تبسيط نظام بيانات الاختزال. </p><br><p style=";text-align:right;direction:rtl">  ثانياً ، لدى ClickHouse مهمة إنشاء ضغط مخصص (دلتا ، دلتا إلى دلتا).  هذا ما يفعله TSDB.  هذا مناسب تمامًا لبيانات السلاسل الزمنية.  هذا مفيد بشكل خاص إذا كنا قادرين على اختيار نوع الضغط وفقًا لأنواع البيانات.  على سبيل المثال ، العداد ، الذي ينمو فقط - لهذا ، يعد ضغط دلتا دلتا مناسبًا.  مقياس يتقلب حول الحجم ، وبالتالي فإن الدلتا تعمل بشكل جيد. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/od/mv/hx/odmvhxcnnite5wum9k9gwfifbec.png"></p><br><p style=";text-align:right;direction:rtl">  هناك التخزين الأخرى التي تعمل.  هناك InfluxDB الذي يعمل خارج الصندوق.  من المعتاد أن تأنيبه للسرعة ، لكن ما ينجح في هذا المجال وليس عليك أن تفعل شيئًا جيدًا. </p><br><p style=";text-align:right;direction:rtl">  هناك OpenTSDB والجرافيت ، وهو للكتابة فقط.  المحول القياسي من بروميثيوس لا يعمل حقًا. </p><br><p style=";text-align:right;direction:rtl">  هناك CrateDB.  هناك TimescaleDB الذي شوكة PostgreSQL لقواعد بيانات السلاسل الزمنية.  يقولون أن هذا يعمل بشكل جيد ، لكننا نحن أنفسنا لم نجربه. </p><br><p style=";text-align:right;direction:rtl">  هناك Cortex ، والذي كان يعرف أيضًا باسم مشروع فرانكشتاين.  هذا يصفه جيدا.  هذا هو الرجال الذين يحاولون اتخاذ قرار بناءً على اتحاد بروميثيوس.  يقومون بتخزين البيانات في S3. </p><br><p style=";text-align:right;direction:rtl">  هناك ثانوس. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  لديه هندسة مثيرة للاهتمام للغاية.  هناك بروميثيوس الذي يستخدم TSDB المحلية.  يتم إنشاء كتلة بينهما.  يوجد بجانب كل سيارة بروميثيوس جانب جانبي خاص يقبل الطلبات عبر واجهة برمجة التطبيقات للقراءة والكتابة عن بُعد.  انه يعيد توجيه هذه الطلبات إلى بروميثيوس.  يمكن لـ Prometheus استخدام واجهات برمجة التطبيقات للقراءة والكتابة عن بُعد.  جميع السيارات الجانبية مترابطة وبين أساتذة واجهة برمجة التطبيقات المخصصة عبر gRPC ، النسخ المتماثل متاح ، وهناك إعادة تظليل. </li><li style=";text-align:right;direction:rtl">  العمارة المتطورة. </li><li style=";text-align:right;direction:rtl">  انها رطبة جدا.  قبل شهرين ، كان ينهار من ركلة جزاء عندما بدأت. </li></ul><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/a9/rc/zm/a9rczmkse4viit4vvr4hgqfcuts.png"></p><br><p style=";text-align:right;direction:rtl">  باستخدام نموذج السحب لا يكتب الكثير من البيانات.  تحتاج إلى الانتظار لمدة عام كامل لملء البيانات السنوية.  نحن نحاول أن نكتبها بطريقة أو بأخرى. </p><br><p style=";text-align:right;direction:rtl">  لا توجد كتابة عن بعد في بروميثيوس ، وبالتالي ، لن تعمل كتابة الكثير من البيانات إلى TSDB المحلي. </p><br><p style=";text-align:right;direction:rtl">  المشكلة الثانية.  إذا قمنا بإنشاء بيانات لاختبار الإجهاد ، فغالبًا ما تهتز جيدًا.  على سبيل المثال ، إذا أخذنا البيانات الحالية وقمنا بإنشاء 100 حالة ، وهذه هي نفس البيانات ، فسيكون معامل الضغط جميلًا لدرجة أنه لا يحدث في الواقع. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/fy/mc/uk/fymcukkdoo3hi78gkw1eb2ipvsk.png"></p><br><p style=";text-align:right;direction:rtl">  لقد كتبنا مصدرًا مزيفًا يشبه المصدر العادي الذي يمكن لـ بروميثيوس أن يثبته: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  عندما تأتي الخردة ، يذهب إلى مصدر ما في المنبع.  يأخذ البيانات منه. </li><li style=";text-align:right;direction:rtl">  يولد العديد من الحالات.  دعنا نقول 1 هو scrapie ، وحصلنا على 100 في الإخراج. </li><li style=";text-align:right;direction:rtl">  يغير البيانات قليلاً: زائد ناقص 10٪ للعداد والقياس. </li><li style=";text-align:right;direction:rtl">  لا يغير القيم البسيطة 0 أو 1. لأنه إذا كان هناك مقياس UP يستجيب فإنه يوضح ما إذا كانت الخدمة قيد التشغيل: نعم - 1 أو لا - 0. وليس من الواضح جدًا ماذا يعني 098 UP. </li><li style=";text-align:right;direction:rtl">  نحن لا نغير الأعداد الصحيحة إلى الأعداد الصحيحة والعكس صحيح. </li><li style=";text-align:right;direction:rtl">  إنه يعطي فقط البيانات بتنسيق expfmt المعتاد. </li></ul><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/c0/ja/hc/c0jahc5ryn-oxhwxnke_vaj1mia.png"></p><br><p style=";text-align:right;direction:rtl">  أداة التحميل التي تقوم بتحميل البيانات.  قراءة البيانات: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  يمكن القراءة من الملفات بتنسيقها الخاص </li><li style=";text-align:right;direction:rtl">  ربما من القراءة عن بعد </li><li style=";text-align:right;direction:rtl">  يمكن أن تقرأ من بعض المصدرين </li></ul><br><p style=";text-align:right;direction:rtl">  يكتب في أشكال مختلفة.  بما في ذلك / dev / null ، إذا كنا نرغب في اختبار بالضبط كيف تعمل القراءة بسرعة. </p><br><p style=";text-align:right;direction:rtl">  الآن هي أداة اختبار التحميل ليس فقط لـ PromHouse ، ولكن أيضًا لأي حل يستخدم القراءة عن بُعد أو Prometheus. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/qr/xa/-2/qrxa-2wg58troaskuqhqowwicq4.png"></p><br><p style=";text-align:right;direction:rtl">  نريد إضافة ذاكرة التخزين المؤقت للقراءة ، لأنه في اختباراتنا كان عنق الزجاجة في كثير من الأحيان مصدرًا مزيفًا ، حيث تولد بيانات لفترة طويلة.  يمكن أن نخبئهم.  فليكن جيدًا بشكل غير واقعي.  لكننا لن تبطئ.  لم يكن لدينا لانتظار أيام لاختبار الإجهاد. </p><br><p style=";text-align:right;direction:rtl">  نوع من الترشيح على الطاير ، نوع من التعديل على الطاير. </p><br><p style=";text-align:right;direction:rtl">  الدعم الأصلي ل TSDB.  من أجل العمل مع قاعدة البيانات على القرص ، وليس من خلال API. </p><br><p style=";text-align:right;direction:rtl">  التركيز على الدقة للهجرة.  أنا مرة واحدة وضعت pmmdemo.percona.com: متصلة ، تلقى جميع المقاييس.  إذا قمت بذلك بطريقة أصلية ، فإن Prometheus يفتح TSDB ، ويجمع كل السلاسل الزمنية من القرص ، ويزيد الفهارس ، ثم يزحف إلى ملفات كبيرة ، ويدرك أنه موجود بالفعل.  عند هذه النقطة ، كل شيء يمكن أن يستلقي. </p><br><p style=";text-align:right;direction:rtl">  تتمثل الطريقة الساذجة في أخذ السلسلة الزمنية بأكملها والقراءة من البيانات القديمة إلى الجديدة.  في تلك اللحظة سوف يستلقي.  ما عليك القيام به هو عكس ذلك.  تحتاج أولاً إلى الحصول على قائمة السلاسل الزمنية مع بعض الاستعلامات ذات التعبيرات المعتادة.  على سبيل المثال ، سلسلة زمنية تبدأ في A. ثم أعطني سلسلة زمنية تبدأ في B. ثم قم بتحميلها بالضبط بواسطة المقاييس ، وليس حسب الوقت.  هذا غير منطقي ، لكن هكذا يعمل.  هذا هو فارق بسيط إذا كنت تفعل شيئا من هذا القبيل.  إذا رأيت أن OOM Killer قد حدث هناك ، فعندئذ ستعلم أنه بسببك. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mz/z9/kh/mzz9khnykox-3r2wlp_lpgphil4.png"></p><br><p style=";text-align:right;direction:rtl">  نتائج اختبار الحمل ، لن يكون هناك أي رسوم بيانية.  يستغرق اختبار الحمل الكثير من الوقت ، ولسوء الحظ ، نظرًا لحدوث خطأ في التكوين ، حدث كل شيء خطأ.  لذلك ، لم تنجح النتائج. </p><br><p style=";text-align:right;direction:rtl">  سوف نكتب على مدونة Percona عندما نقوم بإجراء اختبار الحمل. </p><br><p style=";text-align:right;direction:rtl">  أستطيع أن أقول النتائج دون الرسوم البيانية.  كان التسجيل خطيا.  قفزت القراءة ولم تكن سريعة جدا.  قراءة البيانات الحالية ليست مهمة للغاية بالنسبة لنا.  يمكن تسريعها من خلال تلميحات القراءة.  يمكنك تمكين read_recent لتحسين القراءة.  وللبيانات القديمة ، وهذا يعمل بشكل جيد. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/b6/7f/4w/b67f4wmgkuzi6zyqnitxlwuv2t8.png"></p><br><p style=";text-align:right;direction:rtl">  الناس يريدون تخزين طويل الأجل.  هناك مثل هذا الطلب.  لقد تحدثنا عن PromHouse في PromCon.  كان هناك موضوع ساخن جدا.  Thanos تتطور بنشاط. </p><br><p style=";text-align:right;direction:rtl">  إنه بالفعل ممكن الآن.  هناك حل لهذا.  هناك API.  هناك بعض التكامل.  ولكن كل هذا يحتاج إلى الانتهاء من ملف.  لا توجد حلول جاهزة للإنتاج. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ms/qk/ec/msqkechijgscjucb7sx8knkzwx0.png"></p><br><p style=";text-align:right;direction:rtl">  روابط أن ننظر فيها.  الرابط الأول هو مستودع PromHouse.  الرابط الثاني هو المكان الذي من المحتمل أن يتحرك فيه.  الآن في مستودع واحد وهناك عدة أشياء مختلفة؟  لا علاقة وثيقة للغاية.  لذلك ، سوف تحتاج إلى نقلها. </p><br><p style=";text-align:right;direction:rtl">  سوف تحتوي مدونتنا على معلومات حول الأداء وبعض الأخبار. </p><br><p style=";text-align:right;direction:rtl">  أسئلة: </p><br><p style=";text-align:right;direction:rtl">  سؤال: هل راجعت الشائعات حول InfluxDB؟ </p><br><p style=";text-align:right;direction:rtl">  الجواب: لم يكن جيدًا.  أصبح أفضل بكثير.  كل هذه القصص عن حقيقة أن InfluxDB بطيء ، ينهار - إنها تدور حول الإصدار القديم.  النسخة الحالية مستقرة.  لن أقول؟  أنه يعمل بسرعة.  لكنه يعمل بشكل مستقر.  إيجابيات InfluxDB في رأيي: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  أولاً ، ليست هناك حاجة للقيام بشيء قريب ، لأن InfluxDB يعمل خارج الصندوق. </li><li style=";text-align:right;direction:rtl">  ثانياً ، في ClickHouse ، كما هو الحال في الحلول الأخرى المستندة إلى قاعدة البيانات ، ولكن ليس TSDB ، يمكنك استخدام لغة استعلام مألوفة لك.  لغة استعلام InfluxDB تشبه SQL.  يمكنك إجراء تحليلات عليه ، وهو أمر صعب القيام به على PromQL.  إذا كنت تستخدم TimeScaleDB - هناك SQL الحقيقي. </li></ul><br><p style=";text-align:right;direction:rtl">  السؤال: هل محرك GraphiteMergeTree يعمل فقط للتسجيل؟  إذا كنا نريد عرض الرسوم البيانية ، فهل يلزم إعداد Grafana على الجرافيت لإظهار تخزين طويل الأجل؟ </p><br><p style=";text-align:right;direction:rtl">  الجواب: نعم.  التكامل في Prometheus نفسه يعمل فقط للتسجيل.  يكتب فقط البيانات.  إذن من غرافانا تذهب إلى الجرافيت. </p><br><p style=";text-align:right;direction:rtl">  سؤال: ويفقد الملصقات عندما يكتب؟ </p><br><p style=";text-align:right;direction:rtl">  الإجابة: هناك تكوين يوضح ما يجب القيام به معهم ، وكيفية إدراجه ، ومكان إدراجه. </p><br><p style=";text-align:right;direction:rtl">  معلومات من الجمهور: قال أفيتو إنهم يكتبون حلهم للتسجيلات من بروميثيوس إلى الجرافيت. </p><br><p style=";text-align:right;direction:rtl">  سؤال: كان هناك استنتاج مفاده أنه مع تسجيل كل شيء على ما يرام على خادم تخزين طويل الأجل. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mz/z9/kh/mzz9khnykox-3r2wlp_lpgphil4.png">  هناك تدفق مليون المقاييس (5 دقائق أو 15 دقيقة).   raid 6 sata      ? </p><br><p style=";text-align:right;direction:rtl"> :  PMM      —  .   downsampling    c 14   1 .  ,       .          .    .     . </p><br><p style=";text-align:right;direction:rtl"> :   IOPS  ? </p><br><p style=";text-align:right;direction:rtl"> :     . </p><br><p style=";text-align:right;direction:rtl"> :      </p><br><p style=";text-align:right;direction:rtl"> :        .  ,        .  , ,  . </p><br><p style=";text-align:right;direction:rtl"> :     InfluxDB,        InfluxDB? </p><br><p style=";text-align:right;direction:rtl"> :    read_recent.    ,      remote storage.    InfluxDB .    .  read_recent ,   . </p><br><p style=";text-align:right;direction:rtl"> : ,     Prometheus.     InfluxDB. Grafana   Prometheus. Prometheus   PromQL     ,    InfluxDB? </p><br><p style=";text-align:right;direction:rtl"> : . </p><br><p style=";text-align:right;direction:rtl"> : Prometheus     InfluxDB      Grafana? </p><br><p style=";text-align:right;direction:rtl"> : .    Prometheus  2.2        ,    . </p><br><p style=";text-align:right;direction:rtl"> PS       : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">valyala</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">gecube</a> <br>   ,   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar441136/">https://habr.com/ru/post/ar441136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar441126/index.html">ايجابيات كاذبة في PVS-Studio: كيف عمق حفرة الأرنب</a></li>
<li><a href="../ar441128/index.html">الخيار الصحيح: دراسة عملية للقدرات الإدراكية للقرود الأنثروبويدية</a></li>
<li><a href="../ar441130/index.html">أداء موقع متوازن. الجزء 1: الاستراتيجية</a></li>
<li><a href="../ar441132/index.html">حتى أن Roskomnadzor لا يأتي فجأة</a></li>
<li><a href="../ar441134/index.html">العواطف ، العمل المستقل</a></li>
<li><a href="../ar441138/index.html">في الوقت الحقيقي حلول الدردشة مقابل منصات الدردشة - جعل اختيارك</a></li>
<li><a href="../ar441140/index.html">تطوير WebAssembly: أشعل النار الحقيقي والأمثلة</a></li>
<li><a href="../ar441142/index.html">12 نقطة من نمو التحويل ، أو المحتوى الذي يبيع حقًا</a></li>
<li><a href="../ar441146/index.html">الشبكات اللاسلكية الصناعية: أي واحد تختار؟</a></li>
<li><a href="../ar441148/index.html">كيفية التعامل مع الأخطاء بشكل صحيح: الصمت ليس جيدًا دائمًا</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>