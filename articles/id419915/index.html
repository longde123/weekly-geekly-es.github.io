<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏻‍🤝‍🧑🏻 🌋 😱 Bonding dan server SSH di initramfs 🏩 🙏🏽 ⛱️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Setiap sistem adalah kompromi antara keamanan dan kegunaan. 


 Dalam NAS yang dibangun , ada masalah serius: tidak mungkin untuk reboot sistem tanpa ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bonding dan server SSH di initramfs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419915/"><p><img src="https://habrastorage.org/webt/mc/mz/-h/mcmz-h3bsxctbh1ka8wxdtdnvqs.png"></p><br><p>  Setiap sistem adalah kompromi antara keamanan dan kegunaan. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dalam NAS yang dibangun</a> , ada masalah serius: tidak mungkin untuk reboot sistem tanpa berada di tempat, yang mengurangi tingkat ketersediaan data. </p><br><p>  Masalah ini tidak kritis, sampai saat mereka mulai mematikan listrik darurat: selama tiga bulan, dua kali selama beberapa jam.  UPS dirancang untuk malfungsi jangka pendek dan tidak seharusnya bekerja dengan baterai selama lebih dari setengah jam (walaupun sebenarnya sekitar satu jam), dan dengan setiap shutdown seperti itu, untuk menghidupkan kembali sistem, saya harus pergi ke kota lain. </p><a name="habracut"></a><br><p>  Berkat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">petunjuk</a> dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">ValdikSS</a> , masalah ini telah diatasi.  Tapi ... </p><br><p><img src="https://habrastorage.org/webt/l0/xu/c3/l0xuc38iobnzstjrcx204y9opeg.jpeg"></p><br><p>  Saya membutuhkan ikatan antarmuka dan penguncian SSH jarak jauh.  Dan saya tidak menemukan manual yang dapat dilakukan segera sehingga berfungsi seperti yang saya butuhkan. </p><br><p>  Oleh karena itu, saya membawa versi solusi saya dengan ikatan dan IP dinamis, di mana sistem dapat dibuka, baik secara lokal maupun jarak jauh. </p><br><p>  <strong>Saya mengingatkan Anda bahwa untuk melakukan pengaturan ini, Anda harus memiliki akses fisik lokal ke NAS dan kemampuan boot cadangan.</strong> </p><br><h1 id="bonding-v-initramfs">  Ikatan di initramfs </h1><br><p>  Karena, di NAS, dua antarmuka digabungkan menjadi satu saluran, diputuskan untuk juga melakukan ini saat boot. </p><br><p>  Dari pertanyaan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Menggunakan NFS-root dengan antarmuka terikat"</a> Saya mengambil skrip.  Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Cara mengelola ikatan linux tanpa ifenslave menggunakan sysfs"</a> membantu mengatur ikatan. </p><br><p>  Pertama, Anda perlu memasukkan modul dalam initramfs yang digunakan untuk mengoperasikan jaringan.  Ini dilakukan dengan perintah berikut: </p><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> m _; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> /sbin/modinfo -F filename <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$m</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> &lt;/proc/modules | sed -nr <span class="hljs-string"><span class="hljs-string">"s@^/lib/modules/`uname -r`/kernel/drivers/net(/.*)?/([^/]+)\.ko\$@\2@p"</span></span> &gt;&gt; /etc/initramfs-tools/modules</code> </pre> <br><p>  Sekarang salin kedua skrip ke <code>/etc/initramfs-tools/scripts/</code> . </p><br><p>  Yang pertama diperlukan untuk meningkatkan antarmuka dalam ikatan: </p><br><div class="spoiler">  <b class="spoiler_title">/ etc / initramfs-tools / scripts / init-premount / 00_bonding_init</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e PREREQS="" case $1 in prereqs) echo "${PREREQS}"; exit 0;; esac BOND_MASTER=${BOND_MASTER:-bond0} echo "Network interfaces loaded: " echo `ls /sys/class/net` if [ ! -e "/sys/class/net/${BOND_MASTER}" ]; then echo "Creating bonding master 'bond0'..." echo "+${BOND_MASTER}" &gt; /sys/class/net/bonding_masters fi echo "Master interface: ${BOND_MASTER}" for x in $cmdline; do case $x in bondslaves=*) bondslaves="${x#bondslaves=}" ;; esac done IFS="," for x in $bondslaves; do echo "+$x" &gt; "/sys/class/net/${BOND_MASTER}/bonding/slaves" done</span></span></code> </pre> </div></div><br><p>  Yang kedua adalah untuk menonaktifkan antarmuka ikatan saat memuat berlanjut: </p><br><div class="spoiler">  <b class="spoiler_title">/ etc / initramfs-tools / scripts / init-bottom / iface_down</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e PREREQS="" case $1 in prereqs) echo "${PREREQS}"; exit 0;; esac if [ ! -d /sys/class/net/bond0 ]; then exit 0 fi echo "Remove bonding interface..." for x in $cmdline; do case $x in bondslaves=*) bondslaves="${x#bondslaves=}" ;; esac done IFS="," for x in $bondslaves; do echo "-$x" &gt; /sys/class/net/bond0/bonding/slaves done echo "-bond0" &gt; /sys/class/net/bonding_masters</span></span></code> </pre> </div></div><br><p>  Jika ini tidak dilakukan, jaringan tidak akan berfungsi setelah booting. </p><br><p>  Jangan lupa untuk memberi izin pada skrip untuk dieksekusi: </p><br><pre> <code class="bash hljs">chmod +x /etc/initramfs-tools/scripts/init-premount/00_bonding_init /etc/initramfs-tools/scripts/init-bottom/iface_down</code> </pre> <br><p>  Tetap hanya untuk mengatur antarmuka yang akan dimasukkan dalam ikatan dan parameter untuk mendapatkan alamat. <br>  Alamat tersebut akan diperoleh melalui DHCP, karena  Bonding akan memiliki MAC yang sama dengan setelah boot, karena router akan mengeluarkan IP tetap dan meneruskan port. </p><br><p>  Saya mendapatkan antarmuka secara otomatis dari mereka yang termasuk dalam ikatan <code>bond0</code> saat NAS sedang berjalan: </p><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/\(GRUB_CMDLINE_LINUX_DEFAULT=\)\"\(.*\)\"/\1\"\2 </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(echo -n ip=:::::bond0:dhcp bondslaves=$(sed -e 's/ /,/' /sys/class/net/bond0/bonding/slaves)</span></span></span><span class="hljs-string">)\"/"</span></span> /etc/default/grub</code> </pre> <br><p>  Akhirnya, perbarui konfigurasi GRUB dan gambar initramfs: </p><br><pre> <code class="bash hljs">update-grub update-initramfs -u -k $(uname -r)</code> </pre> <br><p>  Itu saja.  Jika semuanya dikonfigurasi dengan benar, setelah me-reboot dan memulai skrip startup dalam initrmafs, ping pada IP NAS akan hilang, meskipun faktanya OS belum dimuat. </p><br><p>  Saya perhatikan bahwa pengaturan ikatan di Dracut menjadi lebih mudah, karena <a href="">sudah ada skrip dalam pengiriman</a> . </p><br><h1 id="ssh-server-v-initramfs">  Server SSH di initramfs </h1><br><p>  Instal paket untuk mengaktifkan Dropbear SSH di initramfs: </p><br><pre> <code class="bash hljs">apt-get install dropbear-initramfs</code> </pre> <br><p>  Dropbear SSH akan dimasukkan dalam initrmafs secara otomatis, dan itu akan mulai jika setidaknya satu antarmuka jaringan dengan alamat IP dinaikkan pada tahap awal booting. </p><br><p>  Setelah itu, konversikan kunci Dropbear ke format OpenSSH dan tutup dengan kata sandi: </p><br><pre> <code class="bash hljs">/usr/lib/dropbear/dropbearconvert dropbear openssh \ /etc/dropbear/dropbear_rsa_host_key \ id_rsa dropbearkey -y -f /etc/dropbear/dropbear_rsa_host_key | \ grep <span class="hljs-string"><span class="hljs-string">"^ssh-rsa "</span></span> &gt; id_rsa.pub ssh-keygen -p -f id_rsa</code> </pre> <br><p>  Kunci <code>id_rsa</code> ke mesin yang dengannya pembuka kunci akan dilakukan.  Saya akan berasumsi bahwa itu akan disalin ke <code>~/.ssh/dropbear</code> . </p><br><p>  Di <code>/etc/dropbear-initramfs/authorized_keys</code> , sidik jari kunci dan parameter untuk setiap kunci harus ditentukan. </p><br><p>  Untuk saat ini, tambahkan saja sidik jari dari satu tombol, dan Anda perlu menjalankan perintah berikut: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command="/bin/unlock"'</span></span> $(cat id_rsa.pub) &gt;&gt; /etc/dropbear-initramfs/authorized_keys</code> </pre> <br><p>  Tidak diperlukan pembungkus yang disebutkan dalam artikel, <code>/bin/unlock</code> - skrip sistem (cryptroot-unlock). </p><br><p>  Inilah yang akan terlihat pada <code>/etc/dropbear-initramfs/authorized_keys</code> pada akhirnya: </p><br><pre> <code class="plaintext hljs">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command="/bin/unlock" ssh-rsa AAAA...XDa root@nas</code> </pre> <br><p>  Perbarui gambar konfigurasi dan initramfs GRUB dan reboot: </p><br><pre> <code class="bash hljs">update-grub update-initramfs -u -k $(uname -r) reboot</code> </pre> <br><p>  <em>Dari mesin tempat Anda menyalin kunci,</em> sekarang mungkin untuk terhubung ke NAS dan membuka kunci: </p><br><pre> <code class="plaintext hljs">$ ssh -i .ssh/dropbear/id_rsa_initram -o UserKnownHostsFile=.ssh/dropbear/known_hosts root@nas.NAS.cloudns.cc Enter passphrase for key '.ssh/dropbear/id_rsa_initram': X11 forwarding request failed on channel 0 Please unlock disk root_crypt1 (/dev/disk/by-id/ata-Samsung_SSD_850_PRO_256GB-part3):</code> </pre> <br><p>  Setelah itu, konsol akan terus mendapatkan kesalahan tentang tidak adanya argumen ( <code>ash: -gt: argument expected</code> ), tetapi membuka kunci akan hilang.  Ini adalah kesalahan dalam skrip pembuka kunci sistem yang tidak memengaruhi apa pun (kesalahan diperbaiki dengan mudah, tetapi pembungkusnya tidak menyembuhkannya). </p><br><p>  Rincian lebih lanjut dapat ditemukan di artikel ini: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Buka kunci dari root terenkripsi LUKS di Ubuntu / Debian</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Membuka kunci melalui SSH ubuntu-server terenkripsi penuh 12,04</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Membuka kunci LUKS terenkripsi LVM menggunakan Dropbear SSH di Ubuntu Server 04.14.1</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Buka kunci sistem terenkripsi penuh melalui SSH</a> . </li></ul><br><h1 id="otladka">  Debugging </h1><br><p>  Untuk debugging, Anda dapat memasukkan panggilan ke <code>/bin/sh</code> dalam skrip <code>00_bonding_init</code> setelah: </p><br><pre> <code class="plaintext hljs">case $1 in prereqs) echo "${PREREQS}"; exit 0;; esac</code> </pre> <br><p>  Ketika masalah ikatan diselesaikan, ganti <code>command="/bin/unlock"</code> dengan <code>command="/bin/sh"</code> di <code>authorized_keys</code> . </p><br><p>  Setelah terhubung melalui SSH, Anda akan disajikan dengan shell yang dapat Anda gunakan untuk debugging. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id419915/">https://habr.com/ru/post/id419915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id419903/index.html">Yang paling mengganggu pengguna Anda menurut Google</a></li>
<li><a href="../id419905/index.html">Industri peluncuran Inggris membangunkan dan menetapkan tujuan - setengah abad setelah Black Arrow</a></li>
<li><a href="../id419907/index.html">Kiat Peluncuran Game Seluler: Bagian 2, Peluncuran Global</a></li>
<li><a href="../id419911/index.html">Membangun orbit benda langit menggunakan Python</a></li>
<li><a href="../id419913/index.html">IKEA dan rumah pintar. Bagian 2</a></li>
<li><a href="../id419917/index.html">Neural networks: implementasi tugas tentang jamur pada Tensor Flow dan Python</a></li>
<li><a href="../id419919/index.html">Kontrol versi di dalam SQL Server</a></li>
<li><a href="../id419921/index.html">Cara menjatuhkan 10 juta paket per detik</a></li>
<li><a href="../id419923/index.html">Pekerjaan sementara saya, jam tangan motherboard</a></li>
<li><a href="../id419925/index.html">Kontrol versi file individual menggunakan GitHub Gist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>