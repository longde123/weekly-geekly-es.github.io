<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📭 🤞🏽 😄 6 kisah praktis dari hari kerja SRE kami 😔 👨🏿‍⚖️ 👐🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Infrastruktur web modern terdiri dari banyak komponen untuk berbagai keperluan, dengan jelas dan tidak terlalu saling berhubungan. Ini menjadi sangat ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 kisah praktis dari hari kerja SRE kami</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br>  Infrastruktur web modern terdiri dari banyak komponen untuk berbagai keperluan, dengan jelas dan tidak terlalu saling berhubungan.  Ini menjadi sangat jelas ketika mengoperasikan aplikasi yang menggunakan tumpukan perangkat lunak yang berbeda, yang dengan munculnya layanan microsoft mulai terjadi secara harfiah pada setiap langkah.  Faktor-faktor eksternal (API pihak ketiga, layanan, dll.) Ditambahkan ke "kesenangan" umum, yang memperumit gambaran yang sudah sulit. <br><br>  Secara umum, bahkan jika aplikasi ini akan disatukan oleh ide-ide dan solusi arsitektur umum, untuk menghilangkan masalah yang tidak biasa di dalamnya sering harus mengarungi alam liar yang tidak dikenal berikutnya.  Apakah masalah seperti itu terjadi hanya masalah waktu.  Ini adalah contoh dari praktik terbaru kami yang ditujukan untuk artikel ini.  Pemain: Golang, Sentry, RabbitMQ, nginx, PostgreSQL dan lainnya. <a name="habracut"></a><br><br><h2>  Sejarah No. 1.  Golang dan HTTP / 2 </h2><br>  Menjalankan tolok ukur yang melakukan banyak permintaan HTTP ke aplikasi web telah menghasilkan hasil yang tidak terduga.  Aplikasi Go sederhana dalam proses benchmark digunakan untuk aplikasi Go lain yang terletak di belakang masuknya / openresty.  Ketika HTTP / 2 diaktifkan, kami mendapatkan kesalahan dengan kode 400 untuk beberapa permintaan. Untuk memahami alasan perilaku ini, kami menghapus aplikasi Go di ujung dari rantai dan membuat lokasi sederhana di Ingress, yang selalu mengembalikan 200. Perilaku tersebut tidak berubah! <cut></cut><br><br>  Kemudian diputuskan untuk mereproduksi skrip di luar lingkungan Kubernetes - pada perangkat keras yang berbeda.  Hasilnya adalah Makefile, dengan bantuan dua wadah diluncurkan: dalam satu - tolok ukur yang menuju ke nginx, di yang lain - di Apache.  Keduanya mendengarkan HTTP / 2 dengan sertifikat yang ditandatangani sendiri.  Waktu operasi terakhir lihat di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://github.com/flant/examples/tree/master/2019/09-">repositori ini</a> . <br><br>  Jalankan benchmark dengan <code>concurrency=200</code> : <br><br>  1.1.  Nginx: <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2.  Apache: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br>  Kami berasumsi bahwa intinya di sini adalah implementasi HTTP / 2 yang kurang ketat di Apache. <br><br>  Mari kita coba dengan <code>concurrency=1000</code> : <br><br>  2.1.  Nginx: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2.  Apache: <br><br><pre> <code class="plaintext hljs">… ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br>  Pada saat yang sama, kami mencatat bahwa hasilnya <i>tidak direproduksi setiap waktu</i> : beberapa peluncuran berlalu tanpa masalah. <br><br>  Pencarian untuk masalah pada github proyek Golang mengarah ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="># 25009</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="># 32441</a> .  Melalui mereka kami pergi ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PR 903</a> : menonaktifkan HTTP / 2 di Go secara default! <br><br>  Menafsirkan hasil benchmark tanpa menyelam jauh ke dalam arsitektur server web di atas cukup sulit.  Dalam kasus tertentu, itu cukup untuk menonaktifkan HTTP / 2 untuk layanan yang ditentukan. <br><br><h2>  Sejarah No. 2.  Simfoni dan penjaga tua </h2><br>  Dalam salah satu proyek, versi kerangka PHP symfony yang sangat lama (v2.3) masih berfungsi.  Klien Raven tua dan kelas tulisan-sendiri dalam PHP terlampir padanya “dalam kit”, yang sedikit menyulitkan untuk debugging. <br><br>  Setelah transfer salah satu layanan di Kubernetes ke Sentry, yang digunakan untuk melacak kesalahan dalam aplikasi proyek ini, peristiwa tiba-tiba berhenti datang.  Untuk mereproduksi perilaku ini, kami menggunakan contoh dari situs web Sentry, mengambil dua opsi dan menyalin DSN dari pengaturan Sentry.  Secara visual, semuanya berfungsi: pesan kesalahan (diduga) dikirim satu demi satu. <br><br>  Opsi pemeriksaan JavaScript: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  Demikian pula dalam Python: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br>  Namun, mereka tidak masuk ke Sentry.  Saat mengirim pesan, ilusi dibuat bahwa pesan itu dikirim, karena klien segera menghasilkan hash untuk masalah ini. <br><br>  Akibatnya, masalah diselesaikan dengan sangat sederhana: pengiriman acara pergi ke HTTP, dan layanan Sentry hanya mendengarkan HTTPS.  Arahan ulang dari HTTP ke HTTPS disediakan, tetapi klien lama (kode di sisi symfony) tidak dapat mengikuti arahan ulang, yang tidak diharapkan secara default hari ini. <br><br><h2>  Sejarah No. 3.  RabbitMQ dan proksi pihak ketiga </h2><br>  Dalam satu proyek, cloud Evotor digunakan untuk menghubungkan register kas.  Bahkan, ini berfungsi sebagai proksi: permintaan POST dari Evotor langsung ke RabbitMQ - melalui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">plugin STOMP</a> diimplementasikan melalui koneksi WebSocket. <br><br>  Salah satu pengembang membuat permintaan pengujian menggunakan Postman dan menerima respons yang diharapkan dari <code>200 OK</code> , namun, permintaan melalui cloud menyebabkan <code>405 Method Not Allowed</code> . <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405 Metode Tidak Diizinkan</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Permintaan tcpdump dari Evotor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Permintaan tcpdump dibuat oleh curl</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br>  Mata seorang insinyur yang terlatih segera melihat perbedaannya: <br><br><ul><li>  curl: <code>POST /api/queues/%2Fclient…</code> </li><li>  Evotor: <code>POST /api/queues//client…</code> </li></ul><br>  Masalahnya adalah bahwa dalam satu kasus, suatu hal yang tidak dapat dipahami (untuk RabbitMQ) <code>//vhost</code> , dan dalam kasus lain - <code>%2Fvhost</code> , yang merupakan perilaku yang diharapkan ketika: <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br>  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">masalah</a> proyek RabbitMQ tentang topik ini, pengembang menjelaskan: <br><br><blockquote>  Kami tidak akan mengganti% -encoding.  Ini cara standar penyandian jalur URL dan telah berlangsung lama.  Dengan asumsi bahwa% -encoding dalam alat berbasis HTTP akan hilang karena bahkan kerangka kerja yang paling populer dengan asumsi jalur URL seperti itu "jahat" adalah picik dan naif.  Nama host virtual default dapat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">diubah ke nilai apa pun</a> (seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">nilai</a> yang tidak menggunakan garis miring atau karakter lain yang memerlukan%-encoding) dan setidaknya dengan rilis BOSH Penting dari RabbitMQ, host virtual default tetap dihapus pada waktu penyebaran. . </blockquote><br>  Masalahnya diselesaikan tanpa keterlibatan lebih lanjut dari teknisi kami (di sisi Evotor setelah menghubungi mereka). <br><br><h2>  Sejarah No. 4.  Gen dalam PostgreSQL </h2><br>  PostgreSQL memiliki indeks yang sangat berguna, yang sering dilupakan.  Kisah ini dimulai dengan keluhan tentang rem dalam aplikasi.  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel terbaru,</a> kami telah memberikan contoh perkiraan alur kerja saat menganalisis situasi seperti itu.  Dan di sini APM kami - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Atatus</a> - menunjukkan gambar berikut: <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br>  Pada jam 10 pagi ada peningkatan waktu yang dihabiskan aplikasi untuk bekerja dengan database.  Seperti yang diharapkan, alasannya terletak pada respons lambat dari DBMS.  Bagi kami, menganalisis kueri, mengidentifikasi area masalah, dan indeks "menggantung" adalah rutin yang dapat dipahami.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Okmeter yang</a> kami gunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">banyak</a> membantu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di dalamnya</a> : ada dua panel standar untuk memantau status server dan kemampuan untuk <i>dengan cepat</i> membangun server kami sendiri - dengan output metrik yang bermasalah: <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  Grafik memuat CPU menunjukkan bahwa salah satu basis data dimuat 100%.  Mengapa  Panel PostgreSQL baru akan meminta: <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br>  Penyebab masalah segera terlihat - konsumen CPU utama: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br>  Mempertimbangkan rencana kerja kueri yang bermasalah, kami menemukan bahwa pemfilteran menurut bidang tabel yang diindeks memberi terlalu banyak pilihan: database menerima lebih dari 70 ribu baris oleh <code>id</code> dan <code>field_1</code> , dan kemudian mencari substring di antara mereka.  Ternyata <code>LIKE</code> pada substring iterates atas sejumlah besar data teks, yang mengarah ke perlambatan serius dalam eksekusi permintaan dan peningkatan beban CPU. <br><br>  <i>Di sini Anda dapat dengan benar melihat bahwa masalah arsitektur tidak dikesampingkan (koreksi logika aplikasi atau bahkan mesin teks lengkap diperlukan ...), tetapi tidak ada waktu untuk pengerjaan ulang, tetapi seharusnya bekerja dengan cepat 15 menit yang lalu.</i>  <i>Pada saat yang sama, kata pencarian sebenarnya adalah pengidentifikasi (dan mengapa tidak di bidang yang terpisah? ..), yang menghasilkan satuan garis.</i>  <i>Bahkan, jika kita dapat membuat indeks pada bidang teks ini, semua yang lain akan menjadi tidak perlu.</i> <br><br>  Solusi terakhir saat ini adalah menambahkan indeks GIN untuk <code>field_2</code> .  Itu pahlawan hari itu - "jin" yang sama.  Singkatnya, GIN adalah semacam indeks yang berkinerja sangat baik dalam pencarian teks lengkap, mempercepatnya secara kualitatif.  Anda dapat membaca lebih lanjut tentang itu, misalnya, dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">materi yang luar biasa ini</a> . <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br>  Seperti yang Anda lihat, operasi sederhana ini memungkinkan untuk menghapus beban tambahan, dan dengan itu - dan menghemat uang untuk klien. <br><br><h2>  Sejarah No. 5.  Caching s3 di nginx </h2><br>  Penyimpanan awan yang kompatibel dengan S3 telah lama berada dalam daftar teknologi yang digunakan oleh banyak proyek.  Jika Anda memerlukan penyimpanan gambar yang andal untuk situs Anda atau untuk data jaringan saraf, Amazon S3 adalah pilihan yang bagus.  Keandalan penyimpanan dan ketersediaan data yang tinggi (dan kurangnya kebutuhan untuk "pagar taman") sangat menawan. <br><br>  Namun, terkadang untuk menghemat uang - karena biasanya pembayaran untuk S3 berlaku untuk permintaan dan lalu lintas - solusi yang baik adalah dengan menginstal server proxy caching di depan penyimpanan.  Metode ini akan mengurangi biaya ketika datang, misalnya, ke avatar pengguna, yang ada banyak di setiap halaman. <br><br>  Tampaknya lebih mudah daripada mengambil nginx dan mengatur proxy dengan caching, validasi ulang, pembaruan latar belakang, dan blackjack lainnya?  Namun, seperti di tempat lain, ada beberapa nuansa ... <br><br>  Konfigurasi perkiraan proxy seperti itu dengan caching tampak seperti ini: <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br>  Dan secara umum, ini berhasil: gambar ditampilkan, semuanya baik-baik saja dengan cache ... namun, masalah dengan klien AWS S3 muncul.  Secara khusus, klien dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">aws-sdk-php</a> berhenti bekerja.  Analisis nginx log menunjukkan bahwa upstream mengembalikan kode 403 untuk permintaan HEAD, dan responsnya mengandung kesalahan spesifik: <code>SignatureDoesNotMatch</code> .  Ketika kami melihat bahwa nginx membuat permintaan GET ke hulu, semuanya jatuh ke tempatnya. <br><br>  Faktanya adalah bahwa klien S3 menandatangani setiap permintaan, dan server memeriksa tanda tangan ini.  Dalam hal proxy sederhana, semuanya berfungsi dengan baik: permintaan mencapai server tidak berubah.  Namun, ketika caching diaktifkan, nginx mulai mengoptimalkan kerja dengan backend dan menggantikan permintaan HEAD dengan GET.  Logikanya sederhana: lebih baik untuk mengambil dan menyimpan seluruh objek, dan kemudian semua permintaan HEAD dari cache juga.  Namun, dalam kasus kami, permintaan tidak dapat diubah, karena ditandatangani. <br><br>  Pada dasarnya ada dua solusi: <br><br><ol><li>  Jangan mengarahkan klien S3 melalui proxy; </li><li>  jika "perlu", matikan opsi <code>proxy_cache_convert_head</code> dan tambahkan <code>$request_method</code> ke kunci caching.  Dalam hal ini, nginx mengirimkan permintaan HEAD "apa adanya" dan menyimpan responsnya secara terpisah. </li></ol><br><h2>  Sejarah No. 6.  DDoS dan Konten Pengguna Google </h2><br>  Minggu malam tidak menandakan masalah sampai - tiba-tiba!  - Antrian cache invalidation pada edge server belum bertambah, yang memberikan traffic ke pengguna nyata.  Ini adalah gejala yang sangat aneh: lagipula, cache diimplementasikan dalam memori dan tidak terikat ke hard drive.  Pembilasan cache dalam arsitektur yang digunakan adalah operasi yang murah, jadi kesalahan ini hanya dapat muncul jika bebannya sangat tinggi.  Ini dikonfirmasi oleh fakta bahwa server yang sama mulai memberi tahu kemunculan 500 kesalahan <i>(garis merah pada grafik di bawah)</i> . <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br>  Lonjakan yang tajam menyebabkan overruns CPU: <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br>  Analisis cepat menunjukkan bahwa permintaan tidak datang ke domain utama, tetapi dari log menjadi jelas bahwa mereka berada di vhost default.  Sepanjang jalan, ternyata banyak pengguna Amerika datang ke sumber daya Rusia.  Keadaan seperti itu selalu segera menimbulkan pertanyaan. <br><br>  Setelah mengumpulkan data dari log nginx, kami mengungkapkan bahwa kami berurusan dengan botnet tertentu: <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br>  Pola yang dapat dimengerti dilacak dalam log: <br><br><ul><li>  agen-pengguna sejati; </li><li>  permintaan ke root URL dengan argumen GET acak untuk menghindari masuk ke cache; </li><li>  perujuk menunjukkan bahwa permintaan tersebut berasal dari mesin pencari. </li></ul><br>  Kami mengumpulkan alamat dan memverifikasi afiliasinya - semuanya milik <code>googleusercontent.com</code> , dengan dua subnet (107.178.192.0/18 dan 34.64.0.0/10).  Subnet ini berisi mesin virtual GCE dan berbagai layanan, seperti terjemahan halaman. <br><br>  Untungnya, serangan itu tidak berlangsung lama (sekitar satu jam) dan secara bertahap menurun.  Tampaknya algoritme pelindung di dalam Google telah berfungsi, sehingga masalahnya diselesaikan "dengan sendirinya." <br><br>  Serangan ini tidak merusak, tetapi menimbulkan pertanyaan berguna untuk masa depan: <br><br><ul><li>  Mengapa anti-ddos tidak berfungsi?  Layanan eksternal digunakan, yang kami kirimkan permintaan yang sesuai.  Namun, ada banyak alamat ... </li><li>  Bagaimana melindungi diri Anda dari ini di masa depan?  Dalam kasus kami, bahkan opsi untuk menutup akses berdasarkan geografis dimungkinkan. </li></ul><br><h2>  PS </h2><br>  Baca juga di blog kami: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dari kehidupan dengan Kubernetes: Bagaimana orang-orang Spanyol tidak mengeluh tentang server HTTP</a> "; </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6 bug sistem yang menghibur dalam pengoperasian Kubernetes [dan solusi mereka]</a> ”; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">3 kasus luar biasa tentang subsistem jaringan Linux</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id471892/">https://habr.com/ru/post/id471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id471880/index.html">Ide untuk Geek Halloween, atau waktu untuk memilih GeekMask</a></li>
<li><a href="../id471882/index.html">Daftar terbuka acara PHP, pembicara dan penyelenggara di GitHub</a></li>
<li><a href="../id471884/index.html">10 utilitas ApexSQL gratis untuk mengelola database Microsoft SQL Server</a></li>
<li><a href="../id471886/index.html">VMmanager 6: memperkenalkan kotak dan membandingkan dengan generasi sebelumnya</a></li>
<li><a href="../id471890/index.html">Inferensi Variasi - apa itu dan apa yang dimakannya?</a></li>
<li><a href="../id471896/index.html">Inside Playbook. Fitur jaringan di Ansible Engine 2.9 yang baru</a></li>
<li><a href="../id471904/index.html">Resource Planner di HPE InfoSight</a></li>
<li><a href="../id471906/index.html">Bahaya optimasi yang tidak tepat</a></li>
<li><a href="../id471908/index.html">Keindahan nomor prima yang tak terduga</a></li>
<li><a href="../id471912/index.html">Belajar Bahasa Inggris: 7 cara praktis untuk memperluas kosakata Anda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>