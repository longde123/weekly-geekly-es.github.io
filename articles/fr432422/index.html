<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∏ üêô ü•Ä Mode hors ligne sur iOS et caract√©ristiques de son impl√©mentation sur Realm üîë üò® üõçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Publi√© par Ekaterina Semashko, d√©veloppeur iOS junior fort, DataArt 

 Un peu sur le projet: une application mobile pour la plateforme iOS, √©crite en ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mode hors ligne sur iOS et caract√©ristiques de son impl√©mentation sur Realm</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataart/blog/432422/"><img src="https://habrastorage.org/webt/mz/rf/z2/mzrfz2k1ntkzycx5hxev_211qrc.jpeg"><br><br>  <i>Publi√© par Ekaterina Semashko, d√©veloppeur iOS junior fort, DataArt</i> <br><br>  Un peu sur le projet: une application mobile pour la plateforme iOS, √©crite en Swift.  Le but de l'application est la possibilit√© de partager des cartes de r√©duction entre les employ√©s de l'entreprise et leurs amis. <br><br>  L'un des objectifs du projet √©tait d'apprendre et de pratiquer les technologies et les biblioth√®ques populaires.  Le domaine a √©t√© choisi pour le stockage des donn√©es locales, Alamofire a √©t√© utilis√© pour travailler avec le serveur, Google Sign-In a √©t√© utilis√© pour l'authentification, PINRemoteImage a √©t√© utilis√© pour le t√©l√©chargement d'images. <br><br>  Les principales fonctions de l'application: <br><br><ul><li>  ajouter une carte, la modifier et la supprimer; </li><li>  visualiser les cartes des autres; </li><li>  rechercher des cartes par nom de magasin / nom d'utilisateur; </li><li>  Ajoutez des cartes √† vos favoris pour un acc√®s rapide. </li></ul><br>  La possibilit√© d'utiliser l'application sans se connecter au r√©seau a √©t√© suppos√©e d√®s le d√©but, mais uniquement en mode lecture.  C'est-√†-dire  nous pouvions afficher des informations sur les cartes, mais nous ne pouvions pas les modifier sans Internet.  Pour cela, l'application avait toujours une copie de toutes les cartes et marques de la base de donn√©es du serveur, ainsi qu'une liste de favoris pour l'utilisateur actuel.  La recherche a √©galement √©t√© mise en ≈ìuvre localement. <br><br>  Plus tard, nous avons d√©cid√© de nous d√©velopper hors ligne en ajoutant un mode d'enregistrement.  Les informations sur les modifications apport√©es par l'utilisateur ont √©t√© stock√©es et synchronis√©es lorsqu'une connexion Internet est apparue.  La mise en ≈ìuvre d'un tel mode hors ligne en lecture-√©criture sera discut√©e. <a name="habracut"></a><br><br><hr><br>  Que faut-il pour un mode hors ligne complet dans une application mobile?  Nous devons supprimer la d√©pendance de l'utilisateur √† la qualit√© de la connexion Internet, en particulier: <br><br><ol><li>  Supprimez la d√©pendance des r√©ponses √† l'utilisateur de ses actions dans l'interface utilisateur du serveur.  Tout d'abord, la requ√™te va interagir avec le stockage local, puis elle sera envoy√©e au serveur. </li><li>  Marquez et stockez les modifications locales. </li><li>  Impl√©mentez un m√©canisme de synchronisation - lorsqu'une connexion Internet appara√Æt, vous devez envoyer les modifications au serveur. </li><li>  Montrez √† l'utilisateur quelles modifications sont synchronis√©es, lesquelles ne le sont pas. </li></ol><br><h2>  Approche hors ligne </h2><br>  Tout d'abord, j'ai d√ª changer le m√©canisme existant pour interagir avec le serveur et la base de donn√©es.  L'objectif √©tait d'emp√™cher l'utilisateur de d√©pendre de la pr√©sence ou de l'absence d'Internet.  Tout d'abord, il doit interagir avec l'entrep√¥t de donn√©es local et les demandes de serveur doivent √™tre en arri√®re-plan. <br><br>  Dans la version pr√©c√©dente, il y avait une forte connexion entre la couche de stockage de donn√©es et la couche r√©seau.  Le m√©canisme de travail avec les donn√©es √©tait le suivant: d'abord une demande a √©t√© faite au serveur via la classe NetworkManager, nous avons attendu le r√©sultat, apr√®s que les donn√©es ont √©t√© enregistr√©es dans la base de donn√©es via la classe Repository.  Ensuite, le r√©sultat a √©t√© donn√© √† l'interface utilisateur, comme le montre le diagramme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tw/n9/8d/twn98dmriqa0uuzej10hjhntw78.png"></div><br>  Pour impl√©menter l'approche hors ligne en premier, j'ai s√©par√© la couche de stockage de donn√©es et la couche r√©seau, introduisant une nouvelle classe Flow qui contr√¥lait l'ordre dans lequel NetworkManager et le r√©f√©rentiel √©taient appel√©s.  Maintenant, les donn√©es sont d'abord enregistr√©es dans la base de donn√©es via la classe Repository, puis le r√©sultat est envoy√© √† l'interface utilisateur et l'utilisateur continue de travailler avec l'application.  En arri√®re-plan, une demande est faite au serveur, apr√®s la r√©ponse, les informations dans la base de donn√©es et l'interface utilisateur sont mises √† jour. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wi/ru/yd/wiruyd-reybblt8x0zp1lzcgd14.png"></div><br><h2>  Travailler avec des identificateurs d'objet </h2><br>  Avec la nouvelle architecture, plusieurs nouvelles t√¢ches sont apparues, dont une avec des objets id.  Auparavant, nous les recevions du serveur lors de la cr√©ation de l'objet.  Mais maintenant, l'objet a √©t√© cr√©√© localement, en cons√©quence, il √©tait n√©cessaire de g√©n√©rer un identifiant et, apr√®s la synchronisation, de les mettre √† jour avec ceux en cours.  Je suis tomb√© sur la premi√®re limitation de Realm: apr√®s avoir cr√©√© un objet, vous ne pouvez pas changer sa cl√© primaire. <br><br>  La premi√®re option consistait √† abandonner la cl√© primaire de l'objet, √† faire de id un champ r√©gulier.  Mais en m√™me temps, les avantages de l'utilisation de la cl√© primaire ont √©t√© perdus: l'indexation du domaine, qui acc√©l√®re la r√©cup√©ration de l'objet, la possibilit√© de mettre √† jour l'objet avec le drapeau de cr√©ation (cr√©er un objet s'il n'existe pas) et le respect de l'unicit√© de l'objet. <br><br>  Je voulais enregistrer la cl√© primaire, mais cela ne pouvait pas √™tre l'ID de l'objet depuis le serveur.  En cons√©quence, la solution de travail √©tait d'avoir deux identifiants, l'un d'eux serveur, un champ facultatif et le second local, qui serait la cl√© primaire. <br><br>  Par cons√©quent, un identifiant local est g√©n√©r√© sur le client lors de la cr√©ation locale de l'objet, et dans le cas o√π l'objet provenait du serveur, il est √©gal √† l'identifiant du serveur.  √âtant donn√© que dans la source unique d'application de v√©rit√©, il existe une base de donn√©es, lors de la r√©ception de donn√©es du serveur, l'objet est mis √† jour avec l'identifiant local actuel et ne fonctionne qu'avec lui.  Lors de l'envoi de donn√©es au serveur, l'identifiant du serveur est transmis. <br><br><h2>  Stockage des modifications non synchronis√©es </h2><br>  Les modifications apport√©es aux objets qui n'ont pas encore √©t√© envoy√©s au serveur doivent √™tre stock√©es localement.  Cela peut √™tre impl√©ment√© des mani√®res suivantes: <br><br><ol><li>  Ajout de champs √† des objets existants </li><li>  stocker des objets non synchronis√©s dans des tables s√©par√©es; </li><li>  le stockage des modifications de champs individuels dans un certain format. </li></ol><br><br>  Je n'utilise pas d'objets Realm directement dans mes classes, mais je fais leur mappage par moi-m√™me pour √©viter les probl√®mes de multithreading.  L'interface des mises √† jour automatiques se fait √† l'aide d'√©chantillons de r√©sultats de mise √† jour automatique, o√π je m'abonne aux demandes de mise √† jour.  Seule la premi√®re approche fonctionnait avec mon architecture actuelle, donc le choix s'est port√© sur l'ajout de champs aux objets existants. <br><br>  L'objet cartographique a subi le plus de modifications: <br><br><ul><li>  synchronis√© - y a-t-il des donn√©es sur le serveur; </li><li>  supprim√© - vrai, si la carte est supprim√©e uniquement localement, la synchronisation est requise. </li></ul><br>  Identifiants discut√©s dans la partie pr√©c√©dente: <br><br><ul><li>  localId - la cl√© primaire de l'entit√© dans l'application, soit √©gale √† l'ID du serveur, soit g√©n√©r√©e localement; </li><li>  serverId - id du serveur. </li></ul><br>  Il convient √©galement de mentionner le stockage d'images.  En substance, le champ Attachment diskURL a √©t√© ajout√© au champ serverURL de l'image sur le serveur, qui stocke l'adresse de l'image locale non synchronis√©e.  Lors de la synchronisation de l'image, l'image locale a √©t√© supprim√©e afin de ne pas obstruer la m√©moire de l'appareil. <br><br><h2>  Synchronisation du serveur </h2><br>  Pour synchroniser avec le serveur, le travail avec l'accessibilit√© a √©t√© ajout√©, de sorte que lorsque Internet appara√Æt, le m√©canisme de synchronisation d√©marre. <br><br>  Tout d'abord, il v√©rifie s'il y a des modifications √† apporter √† la base de donn√©es.  Ensuite, une demande est envoy√©e au serveur pour une diffusion de donn√©es r√©elle, par cons√©quent, les modifications qui n'ont pas besoin d'√™tre envoy√©es au client sont √©limin√©es (par exemple, la modification d'un objet qui a d√©j√† √©t√© supprim√© sur le serveur).  Les modifications restantes mettent en file d'attente les demandes au serveur. <br><br>  Pour envoyer des modifications, il √©tait possible d'impl√©menter des mises √† jour group√©es, d'envoyer les modifications dans un tableau ou de faire une demande importante pour synchroniser toutes les donn√©es.  Mais √† ce moment-l√†, le d√©veloppeur principal √©tait d√©j√† occup√© dans un autre projet et ne nous a aid√©s que pendant notre temps libre, nous cr√©ons donc une demande pour chaque type de changement. <br><br>  J'ai impl√©ment√© la file d'attente via OperationQueue et envelopp√© chaque demande dans une op√©ration asynchrone.  Certaines op√©rations d√©pendent les unes des autres, par exemple, nous ne pouvons pas charger l'image de la carte avant de cr√©er la carte, j'ai donc ajout√© la d√©pendance de l'op√©ration d'image √† l'op√©ration de carte.  En outre, l'op√©ration de t√©l√©chargement d'images sur le serveur a re√ßu une priorit√© inf√©rieure √† tout le monde, et je les ai ajout√©es √† la file d'attente √©galement en raison de leur lourdeur. <br><br>  Lors de la planification du mode hors ligne, la grande question √©tait de r√©soudre les conflits avec le serveur lors de la synchronisation.  Mais lorsque nous sommes arriv√©s √† ce point lors de la mise en ≈ìuvre, nous avons r√©alis√© que le cas o√π un utilisateur modifie les m√™mes donn√©es sur diff√©rents appareils est tr√®s rare.  Il nous suffit donc de mettre en ≈ìuvre le dernier m√©canisme de victoires de l'auteur.  Lors de la synchronisation, la priorit√© est toujours donn√©e aux modifications non envoy√©es sur le client, elles ne sont pas effac√©es. <br><br>  La gestion des erreurs en est encore √† ses balbutiements, si la synchronisation √©choue, l'objet sera ajout√© √† la file d'attente des modifications la prochaine fois qu'Internet appara√Ætra.  Et puis, s'il est toujours hors de synchronisation apr√®s la fusion, l'utilisateur d√©cidera de le laisser ou de le supprimer. <br><br><h2>  Solution de contournement suppl√©mentaire lors de l'utilisation de Realm </h2><br>  Lorsque vous travaillez avec Realm face √† plusieurs autres probl√®mes.  Peut-√™tre que cette exp√©rience sera √©galement utile √† quelqu'un. <br><br>  Lors du tri par cha√Æne, l'ordre suit l'ordre des caract√®res en UTF-8, il n'y a pas de prise en charge de la recherche sensible √† la casse.  Nous sommes confront√©s √† une situation o√π les noms en minuscules viennent apr√®s les noms en majuscules, par exemple: Magnet, Pyaterochka, Ribbon.  Si la liste est tr√®s grande, tous les noms en minuscules seront en bas, ce qui est tr√®s d√©sagr√©able. <br><br>  Pour conserver l'ordre de tri, quel que soit le cas, nous avons d√ª introduire un nouveau champ lowercasedName, le mettre √† jour lors de la mise √† jour du nom et le trier par lui. <br><br>  De plus, un nouveau champ a √©t√© ajout√© pour le tri par la pr√©sence d'une carte dans les favoris, car cela n√©cessite essentiellement une sous-requ√™te pour les relations de l'objet. <br><br>  Lors de la recherche dans Realm, il existe la m√©thode CONTAINS [c]% @ pour les recherches non sensibles √† la casse.  Mais, h√©las, cela ne fonctionne qu'avec l'alphabet latin.  Pour les marques russes, nous avons √©galement d√ª cr√©er des champs s√©par√©s et les rechercher.  Mais plus tard, il s'est av√©r√© √™tre entre nos mains d'exclure les caract√®res sp√©ciaux lors de la recherche. <br><br><hr><br>  Comme vous pouvez le voir, pour les applications mobiles, il est tout √† fait possible d'impl√©menter un mode hors ligne avec enregistrement des modifications et synchronisation avec peu de sang, et parfois m√™me avec des modifications minimes sur le backend. <br><br>  Malgr√© certaines difficult√©s, vous pouvez utiliser Realm pour l'impl√©menter, tout en b√©n√©ficiant de tous les avantages sous la forme de mises √† jour en direct, d'une architecture sans copie et d'une API pratique. <br><br>  Il n'y a donc aucune raison de refuser √† tout moment √† vos utilisateurs l'acc√®s aux donn√©es, quelle que soit la qualit√© de la connexion. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432422/">https://habr.com/ru/post/fr432422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432412/index.html">Highload ++: Comment aider le syst√®me ERP √† faire face √† 500 000 requ√™tes par seconde</a></li>
<li><a href="../fr432414/index.html">De vieux secrets au d√©bogage rapide: animation du code source</a></li>
<li><a href="../fr432416/index.html">Types d√©pendants - L'avenir des langages de programmation</a></li>
<li><a href="../fr432418/index.html">Analyser des expressions lambda en Java</a></li>
<li><a href="../fr432420/index.html">Introduction √† Git Merge et Git Rebase: pourquoi et quand les utiliser</a></li>
<li><a href="../fr432424/index.html">Infrastructure certifi√©e HyperFlex pour SAP HANA</a></li>
<li><a href="../fr432426/index.html">D√©bogage d'un bogue qui ne joue pas</a></li>
<li><a href="../fr432428/index.html">Bus centralis√© vs Service Mesh: comment transformer un mitap en bataille</a></li>
<li><a href="../fr432432/index.html">La nouvelle technologie Oc√© ColorWave am√©liore l'impression</a></li>
<li><a href="../fr432434/index.html">Les d√©veloppeurs de Rover de nouvelle g√©n√©ration utilisent l'IA pour augmenter l'efficacit√© de Rover</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>