<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüî¨ ‚òÑÔ∏è üí° Probar el c√≥digo de SQL Server con tSQLt ü•† üÜö üò®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: Este art√≠culo es una versi√≥n ampliada de mi informe sobre SQA Days # 25. 

 Seg√∫n mi experiencia de comunicaci√≥n con colegas, puedo decir que pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Probar el c√≥digo de SQL Server con tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/461133/">  <i>FYI: Este art√≠culo es una versi√≥n ampliada de mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> sobre SQA Days # 25.</i> <br><br>  Seg√∫n mi experiencia de comunicaci√≥n con colegas, puedo decir que probar el c√≥digo en una base de datos no es una pr√°ctica com√∫n.  Esto puede ser un peligro potencial.  La l√≥gica en la base de datos est√° escrita por las mismas personas que escriben el c√≥digo "regular".  En consecuencia, los errores tambi√©n pueden estar presentes all√≠, y tambi√©n pueden tener consecuencias negativas para el producto, el negocio y los consumidores.  No importa si se trata de procedimientos almacenados que ayudan al backend o de ETL que convierten datos en almacenamiento; existe un riesgo y las pruebas pueden reducirlo significativamente.  Quiero decirle qu√© es tSQLt y c√≥mo nos ayuda a probar el c√≥digo en SQL Server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><br><a name="habracut"></a><br><h1>  Contexto </h1><br>  Hay un gran almac√©n en SQL Server que contiene varios datos de investigaci√≥n cl√≠nica.  Se llena de varias fuentes (principalmente bases de datos orientadas a documentos).  Dentro del servidor, los datos se convierten repetidamente usando ETL.  En el futuro, estos datos se pueden cargar en bases de datos m√°s peque√±as para que las utilicen las aplicaciones web que resuelven algunos peque√±os problemas espec√≠ficos.  Algunos de los clientes del cliente tambi√©n solicitan una API para sus necesidades internas.  En la implementaci√≥n de tales API, a menudo se utilizan procedimientos almacenados y consultas. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  En general, el c√≥digo est√° en el lado DBMS en orden. <br><br>
<h1>  ¬øPor qu√© se necesita todo esto? </h1><br>  Como ya se entendi√≥ de la introducci√≥n, el c√≥digo en la base de datos es el mismo c√≥digo <br>  aplicaciones, como el resto, y tambi√©n puede haber errores. <br><br>  Creo que muchas personas son conscientes de la dependencia del precio del error en el momento de su descubrimiento, cuyo descubrimiento generalmente se atribuye a Barry Bohem.  Un error cometido en una etapa temprana y detectado en una etapa posterior puede ser m√°s costoso debido a la necesidad de pasar por muchas etapas (codificaci√≥n, unidad, integraci√≥n, prueba del sistema, etc.) repetidamente tanto para localizar el error como para devolver el c√≥digo corregido a La etapa en la que se identific√≥ el problema.  Este efecto tambi√©n es relevante para el caso del almac√©n.  Si un error se introdujo en alg√∫n ETL y los datos sufren m√∫ltiples transformaciones, entonces si se detecta un error en los datos, deber√°: <br><br><ol><li>  Siga todos los pasos de la conversi√≥n de regreso a la localizaci√≥n del problema. </li><li>  Soluciona el problema. </li><li>  Vuelva a obtener los datos corregidos (no se excluyen las correcciones manuales). </li><li>  Verifique que los datos incorrectos causados ‚Äã‚Äãpor el error no aparecieron en otro lugar. </li></ol><br>  No olvides que no vendemos peluches.  Un error en un campo como la investigaci√≥n cl√≠nica puede causar da√±os no solo a las empresas, sino tambi√©n a la salud de las personas. <br><br><h1>  ¬øC√≥mo hacer la prueba? </h1><br>  Como estamos hablando de pruebas de c√≥digo, nos referimos a pruebas de unidad e integraci√≥n.  Estas cosas son muy ensayales e implican una regresi√≥n constante.  Estrictamente hablando, nadie realiza tales pruebas manualmente (bueno, tal vez con la excepci√≥n de algunos casos completamente degenerados). <br><br>  Una buena ventaja: las pruebas pueden ser un material auxiliar al documentar el c√≥digo.  Por cierto, los requisitos del cliente pueden verse as√≠ (hacer clic): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Excel, dos columnas con requisitos + informaci√≥n de soporte dispersa en otras columnas + marcado diferido, lo cual es m√°s confuso de lo que ayuda.  Si es necesario, restaurar los deseos originales puede ser dif√≠cil.  Las pruebas pueden ayudar a capturar con mayor precisi√≥n los matices de la implementaci√≥n (por supuesto, no debe considerarlos como el equivalente de la documentaci√≥n). <br><br>  Desafortunadamente, con la complejidad del c√≥digo, la complejidad de las pruebas crece y este efecto puede nivelarse. <br><br>  Las pruebas pueden servir como una capa adicional de seguridad contra las morsas espont√°neas.  Las autoevaluaciones en CI debido al formalismo ayudan a hacer frente a este problema. <br><br>  Si nuestra elecci√≥n recay√≥ en el camino de la automatizaci√≥n, entonces debemos decidir las herramientas para su implementaci√≥n. <br><br><h1>  ¬øC√≥mo hacer la prueba? </h1><br>  En el caso de probar el c√≥digo en la base de datos, distingo dos enfoques: impulsado por SQL, es decir, funcionando directamente en el DBMS, y no impulsado por SQL.  Pude resaltar los siguientes matices: <br><div class="scrollable-table"><table><tbody><tr><th>  Impulsado por SQL <br></th><th>  No alimentado por sql <br></th></tr><tr><td>  Requiere la instalaci√≥n de objetos en la base de datos <br></td><td>  Se requiere la instalaci√≥n de herramientas externas adicionales en la base de datos <br></td></tr><tr><td>  Las pruebas siempre son independientes de las tecnolog√≠as utilizadas en la aplicaci√≥n fuera de la base de datos. <br></td><td>  Las pruebas pueden depender de tecnolog√≠as utilizadas fuera de la base de datos. <br></td></tr><tr><td>  El marco siempre est√° vinculado a un DBMS espec√≠fico </td><td>  El marco a menudo admite m√∫ltiples DBMS. </td></tr><tr><td>  Para escribir pruebas solo se requiere conocimiento del DBMS;  para el desarrollo, puede usar probadores manuales o DBA </td><td>  Escribir ex√°menes usualmente requiere conocimiento adicional de cualquier lenguaje de programaci√≥n y / o tecnolog√≠a;  a menudo necesitan ayuda de programadores <br></td></tr><tr><td>  La ejecuci√≥n a nivel de DBMS permite el uso de falsificaciones y afirmaciones m√°s avanzadas <br></td><td>  La ejecuci√≥n externa puede limitar las capacidades de la herramienta <br></td></tr></tbody></table></div>  En SQL Server, tenemos alguna opci√≥n: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informaci√≥n general </th></tr><tr><th>  Titulo </th><th>  El enfoque </th><th>  Arquitectura </th><th>  Escrito en </th><th>  Pruebas para </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  No alimentado por sql </td><td>  Fitnessess </td><td>  C # / java </td><td>  Markdown de Wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  No alimentado por sql </td><td>  RSpec (orientado a BDD) </td><td>  Rub√≠ </td><td>  Rub√≠ </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  No alimentado por sql </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Fechas </th></tr><tr><th>  Titulo </th><th>  Primera aparici√≥n </th><th>  √öltimo compromiso </th><th>  √öltimo lanzamiento </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  2007-07-27 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  2006-12-16 (0.9) <br>  2007-07-21 (0.91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  2003-03-12 </td><td>  2003-03-12 </td><td>  2003-03-12 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  Las posibilidades </th></tr><tr><th>  Titulo </th><th>  CLR no requerido </th><th>  Salida XML </th><th>  Pruebas envueltas en una transacci√≥n </th><th>  Falso </th><th>  Manejadores de errores </th><th>  Aserciones </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Genial </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Muy malo </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Mal </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Genial </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Bueno  hay matices </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  - </td><td>  Bueno  hay matices </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Genial  hay matices </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Otros </th></tr><tr><th>  Titulo </th><th>  La documentaci√≥n </th><th>  Comunidad </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  Genial  hay matices </td><td>  Genial </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  Mal </td><td>  Mal </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  Genial </td><td>  Mal </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  Genial </td><td>  Mal </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  Genial </td><td>  Esta bien </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  Genial </td><td>  Esta bien </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  Genial </td><td>  Genial </td></tr></tbody></table></div>  Las evaluaciones de "bueno-malo" son subjetivas, lo siento, sin esto, en ninguna parte. <br><br>  Explicaci√≥n: "Primera aparici√≥n" es la fecha m√°s temprana en el camino de la vida del marco que logr√© encontrar, es decir, la primera versi√≥n o confirmaci√≥n. <br><br>  Puede notar que las alternativas basadas en SQL se han abandonado por bastante tiempo, y tSQLt es la √∫nica opci√≥n compatible.  Funcionalmente, tSQLt tambi√©n gana.  Lo √∫nico es que, en t√©rminos de afirmaciones, TST cuenta con una opci√≥n ligeramente m√°s rica que tSQLt, que, sin embargo, es poco probable que supere sus desventajas. <br><br>  Hay matices en la documentaci√≥n de tSQLt, pero hablar√© de esto m√°s adelante. <br><br>  En el mundo sin SQL, las cosas no son tan sencillas.  Se est√°n desarrollando alternativas, aunque no s√∫per activas.  DbFit es una herramienta interesante basada en el marco de FitNesse.  Ofrece pruebas de escritura en el marcado de wiki.  Slacker tambi√©n es una cosa curiosa: el enfoque BDD al escribir pruebas para la base de datos. <br><br>  Discutir√© las aserciones en sistemas no basados ‚Äã‚Äãen SQL.  Exteriormente, hay menos de ellos, y uno podr√≠a decir que son peores debido a esto.  Pero aqu√≠ vale la pena considerar que son fundamentalmente diferentes de tSQLt.  No todo es tan simple. <br><br>  La √∫ltima l√≠nea es "NUnit, etc."  - Es m√°s bien un recordatorio.  Muchos de los marcos de pruebas unitarias familiares en el trabajo diario pueden usarse en bases de datos auxiliares usando bibliotecas auxiliares.  La tabla tiene mucha N / A, porque esta l√≠nea, de hecho, incluye muchas herramientas.  Los "matices" en la columna de afirmaci√≥n provienen del mismo punto: en diferentes herramientas, su conjunto puede variar y la cuesti√≥n de la aplicabilidad a la base de datos est√° abierta. <br><br>  Como otra m√©trica interesante, podemos considerar las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tendencias de Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Matices: <br><br><ol><li>  No inclu√≠ Slacker, porque este nombre puede significar muchas cosas (y solicitudes como "Slacker framework" no son particularmente visibles en los gr√°ficos). </li><li>  En aras de la curiosidad, se agreg√≥ la tendencia TST, pero tampoco refleja mucho el estado de las cosas, ya que es una abreviatura que significa muchas cosas diferentes. </li><li>  No inclu√≠ NUnit y sus an√°logos, ya que estos eran originalmente marcos para probar el c√≥digo de las aplicaciones, y sus tendencias no son indicativas de nuestro contexto. </li></ol><br>  En general, podemos decir que tSQLt se ve favorablemente en el contexto de los an√°logos. <br><br><h1>  ¬øQu√© es tSQLt? </h1><br>  tSQLt, como se puede adivinar, es un marco de prueba de unidad basado en SQL. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sitio oficial</a> <br><br>  El soporte de SQL Server ha sido anunciado desde 2005 SP2.  Nunca he podido mirar tan lejos en el pasado, pero tenemos 2012 en el servidor de desarrollo, tengo localmente 2017 - no hubo problemas. <br><br>  El c√≥digo abierto, una licencia de Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√° disponible en GitHub</a> .  Puede bifurcar, contrabandear, usar de forma gratuita en proyectos comerciales y, lo m√°s importante, no tener miedo a los marcadores en el CLR. <br><br><h1>  Mec√°nica de trabajo </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Los casos de prueba son procedimientos almacenados.  Se combinan en clases de prueba (conjunto de pruebas en t√©rminos de xUnit). <br><br>  Las clases de prueba no son m√°s que esquemas de bases de datos regulares.  Se diferencian de otros esquemas por registro en las tablas marco.  Puede realizar dicho registro llamando a un procedimiento: tSQLt.NewTestClass. <br><br>  Dentro de la clase de prueba, tambi√©n es posible definir un procedimiento de configuraci√≥n que se ejecutar√° antes de ejecutar cada caso de prueba individual. <br><br>  No se requiere un procedimiento de desmontaje para restaurar el sistema al finalizar el caso de prueba.  Cada caso de prueba junto con el procedimiento de Configuraci√≥n se realiza en una transacci√≥n separada, que se revierte despu√©s de recopilar los resultados.  Esto es muy conveniente, pero tiene algunos efectos negativos, que discutiremos a continuaci√≥n. <br><br>  El marco le permite ejecutar casos de prueba individuales, clases de prueba completas o todas las clases de prueba registradas a la vez. <br><br><h1>  Caracter√≠sticas por ejemplo </h1><br>  Al no tener el deseo de volver a contar una gu√≠a oficial ya simple, hablar√© sobre las posibilidades del marco utilizando ejemplos. <br><br>  <i>Descargo de responsabilidad:</i> <br><br><ul><li>  <i>los ejemplos est√°n simplificados;</i> </li><li>  <i>en el original, no todo el c√≥digo de prueba fue escrito por m√≠, es m√°s bien el fruto de la creatividad colectiva;</i> </li><li>  <i>El ejemplo 2 se invent√≥ para demostrar m√°s completamente las capacidades de tSQLt.</i> </li></ul><br><h3>  Ejemplo 1: CsvSql </h3><br>  A pedido de uno de los clientes del cliente, se implement√≥ lo siguiente.  La base de datos en los campos de Nvarchar (MAX) almacena consultas SQL.  Para ver estas consultas, se atornilla una interfaz m√≠nima.  El backend utiliza los conjuntos de resultados que devuelven estas solicitudes para generar el archivo CSV para que se devuelva mediante la llamada API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Los conjuntos de resultados son bastante pesados ‚Äã‚Äãy contienen muchas columnas.  Un ejemplo condicional de tal conjunto de resultados: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Este conjunto de resultados son algunos datos de ensayos cl√≠nicos.  Echemos un vistazo m√°s de cerca a c√≥mo se considera ClinicsNum: la cantidad de cl√≠nicas involucradas en el estudio.  Tenemos dos tablas: [Prueba] y [Cl√≠nica]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Hay FK: [Cl√≠nica]. [TrialID] -&gt; [Trial]. [TrialID].  Obviamente, para calcular el n√∫mero de cl√≠nicas, solo necesitamos el COUNT habitual (*). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  ¬øC√≥mo probamos tal solicitud?  Para empezar, podemos usar el pr√°ctico c√≥digo auxiliar: FakeTable, que simplificar√° en gran medida el trabajo posterior. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  FakeTable hace una cosa simple: renombra tablas viejas y crea nuevas en su lugar.  Los mismos nombres, las mismas columnas, pero sin restricci√≥n'ov y trigger'ov. <br><br>  ¬øPor qu√© necesitamos esto? <br><br><ol><li>  Puede haber algunos datos en la base de datos de prueba que pueden interferir con las pruebas.  Gracias a FakeTable, no dependemos de ellos. </li><li>  Para la prueba, como regla general, debe completar solo algunas columnas.  Puede haber muchos de ellos en la tabla, y algunos tendr√°n restricciones.  De esta manera, simplificamos la instalaci√≥n posterior de los datos de prueba: solo insertaremos los que sean realmente necesarios para el caso de prueba. </li><li>  Definitivamente no afectaremos a ning√∫n disparador al insertar datos de prueba y no tenemos que preocuparnos por los efectos posteriores no deseados. </li></ol><br>  Luego, inserte los datos de prueba que necesitamos: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  Obtenemos nuestra consulta de la base de datos, creamos la tabla Actual y la llenamos con el conjunto de resultados de nuestra consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Relleno esperado - valores esperados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Quiero llamar su atenci√≥n sobre el hecho de que en la tabla Esperada solo tenemos una columna, mientras que en Actual tenemos un conjunto completo. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Esto se debe a la funci√≥n del procedimiento AssertEqualsTable, que usaremos para verificar los valores. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Compara solo aquellas columnas que est√°n presentes en ambas tablas que se comparan.  Esto es muy conveniente en nuestro caso, ya que la consulta de prueba devuelve muchas columnas, cada una de las cuales tiene su propia l√≥gica, a veces muy confusa.  No queremos inflar los casos de prueba, por lo que esta funci√≥n es muy √∫til para nosotros.  Por supuesto, esta es una espada de doble filo.  Si en Actual se llena autom√°ticamente un conjunto de columnas a trav√©s de SELECT TOP 0 y en alg√∫n momento sale repentinamente una columna adicional, entonces ese caso de prueba no captar√° este momento.  Para manejar tales situaciones, necesita hacer verificaciones adicionales. <br><br><h3>  Procedimientos hermanos AssertEqualsTable </h3><br>  Vale la pena mencionar que tSQLt contiene dos procedimientos similares a AssertEqualsTable.  Estos son AssertEqualsTableSchema y AssertResultSetsHaveSameMetaData.  El primero hace lo mismo que AssertEqualsTable, pero en los metadatos de la tabla.  El segundo hace una comparaci√≥n similar, pero en los metadatos de los conjuntos de resultados. <br><br><h3>  Ejemplo 2: restricciones </h3><br>  En el ejemplo anterior, vimos c√≥mo puede eliminar la restricci√≥n.  Pero, ¬øy si necesitamos verificarlos?  T√©cnicamente, esto tambi√©n es parte de la l√≥gica, y tambi√©n puede considerarse como un candidato para la cobertura de la prueba. <br><br>  Considere la situaci√≥n del ejemplo anterior.  Dos tablas: [Prueba] y [Cl√≠nica];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Intentemos escribir un caso de prueba para probar esta restricci√≥n.  Al principio, como la √∫ltima vez, falsificamos mesas. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  El objetivo es el mismo: eliminar las restricciones innecesarias.  Queremos cheques aislados sin gestos innecesarios. <br><br>  A continuaci√≥n, devolvemos la restricci√≥n que necesitamos al lugar mediante el procedimiento ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Aqu√≠ hemos reunido una configuraci√≥n conveniente para la verificaci√≥n directa.  La verificaci√≥n en s√≠ misma consistir√° en el hecho de que un intento de insertar datos conducir√° inevitablemente a una excepci√≥n.  Para que el caso de prueba funcione correctamente, necesitamos detectar esta misma excepci√≥n.  El controlador de excepciones ExpectException nos ayudar√° con esto. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Despu√©s de instalar el controlador, puede intentar insertar el no insertable. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Excepci√≥n atrapada.  Pase de prueba <br><br><h3>  Procedimientos de la hermana ApplyConstraint </h3><br>  Los desarrolladores de TSQLt nos ofrecen un enfoque similar para probar los desencadenantes.  Puede usar el procedimiento ApplyTrigger para devolver un activador a la tabla falsa.  Adem√°s, todo es como en el ejemplo anterior: activamos el activador, verificamos el resultado. <br><br><h3>  ExpectNoException - el ant√≥nimo de ExpectException </h3><br>  Para los casos en los que definitivamente no deber√≠a ocurrir una excepci√≥n, existe un procedimiento ExpectNoException.  Funciona de la misma manera que una ExpectException, excepto que la prueba se considera fallida si ocurre una excepci√≥n. <br><br><h3>  Ejemplo 3: sem√°foro </h3><br>  La situaci√≥n es la siguiente.  Hay una serie de procedimientos almacenados y servicios de Windows.  El comienzo de su ejecuci√≥n puede ser causado por varios eventos externos.  En este caso, el orden permisible de su ejecuci√≥n es fijo.  Se utiliza un sem√°foro para diferenciar el acceso a las tablas de la base de datos.  Es un grupo de procedimientos almacenados. <br><br>  Por ejemplo, considere uno de estos procedimientos.  Tenemos dos mesas: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  La tabla [Proceso] contiene una lista de procesos permitidos para la ejecuci√≥n, [ProcStatus] - una lista de estados de estos procesos. <br><br>  ¬øQu√© hace nuestro procedimiento?  Cuando se llama, se produce una serie de comprobaciones: <br><br><ol><li>  El nombre del proceso a iniciar, pasado en el par√°metro del procedimiento, se busca en el campo [Nombre] de la tabla [Proceso]. </li><li>  Si se encontr√≥ el nombre del proceso, se verifica si actualmente es posible iniciarlo: el indicador [IsRunable] de la tabla [Proceso]. </li><li>  Si result√≥ que el proceso es aceptable para la ejecuci√≥n, queda por asegurarse de que a√∫n no se est√© ejecutando.  En la tabla [ProcStatus], se verifica la ausencia de registros sobre este proceso con el estado = 'InProg'. </li></ol><br>  Si todo est√° bien, entonces se agrega un nuevo registro sobre este proceso con el estado 'InProg' a ProcStatus (esto se considera un lanzamiento), la ID de este registro se devuelve con el par√°metro ProcStatusId.  Si falla alguna verificaci√≥n, entonces esperamos lo siguiente: <br><br><ol><li>  Se env√≠a una carta al administrador del sistema. </li><li>  Devuelve ProcStatusId = -1. </li><li>  No se agrega una nueva entrada en [ProcStatus]. </li></ol><br>  Escribamos un caso de prueba para probar el caso cuando el proceso no est√° en la lista de los aceptables. <br><br>  Para mayor comodidad, aplique inmediatamente FakeTable.  Aqu√≠ no es tan fundamentalmente importante, pero puede ser √∫til: <br><br><ol><li>  Estamos garantizados para deshacernos de cualquier informaci√≥n que pueda interferir con la ejecuci√≥n correcta del caso de prueba. </li><li>  Simplificaremos m√°s la verificaci√≥n de entradas faltantes en ProcStatus. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Para enviar un mensaje, se utiliza el procedimiento [SendEmail] escrito por nuestros programadores.  Para verificar el env√≠o de una carta a los administradores, debemos atender su llamada.  Para este caso, tSQLt nos ofrece usar SpyProcedure. <br><br><pre> <code class="sql hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  SpyProcedure hace lo siguiente: <br><br><ol><li>  Crea una tabla con el formato [dbo]. [SendEmail_SpyProcedureLog]. </li><li>  Al igual que FakeTable, reemplaza el procedimiento original con el suyo, con el mismo nombre, pero que contiene la l√≥gica de registro.  Si lo desea, puede agregar cualquiera de sus propias l√≥gicas. </li></ol><br>  Como puede suponer, el registro se produce en la tabla [dbo]. [SendEmail_SpyProcedureLog].  Esta tabla contiene la columna [_ID_]: el n√∫mero de secuencia de la llamada al procedimiento.  Las columnas posteriores llevan los nombres de los par√°metros pasados ‚Äã‚Äãal procedimiento, y los valores pasados ‚Äã‚Äãen las llamadas se recopilan en ellos.  Si es necesario, tambi√©n se pueden verificar. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  Lo √∫ltimo que debemos hacer antes de llamar al sem√°foro y verificar es crear una variable en la que colocaremos el ID de registro de la tabla [ProcStatus] (m√°s precisamente, -1, porque el registro no se agregar√°). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ProcStatusId <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>;</code> </pre> <br>  Llama al sem√°foro: <br><br><pre> <code class="sql hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; <span class="hljs-comment"><span class="hljs-comment">--    -1</span></span></code> </pre> <br>  Eso es todo, ahora tenemos todos los datos necesarios para la verificaci√≥n.  Comencemos por verificar el env√≠o. <br>  letras: <br><br><pre> <code class="sql hljs">IF NOT EXISTS (   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'SendEmail has not been run.'</span></span>;</code> </pre> <br>  En este caso, decidimos no verificar los par√°metros transmitidos durante el env√≠o, sino simplemente verificar el hecho mismo.  Le llamo la atenci√≥n sobre el procedimiento tSQLt.Fail.  Le permite fallar "oficialmente" el caso de prueba.  Si necesita construir una construcci√≥n espec√≠fica, tSQLt.Fail le permitir√° hacer esto. <br><br>  Luego, verifique la ausencia de entradas en [dbo]. [ProcStatus]: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  Aqu√≠ es donde la FakeTable que aplicamos al principio nos ayud√≥.  Gracias a √©l, podemos esperar el vac√≠o.  Sin ella, para una verificaci√≥n precisa, deber√≠amos, en el buen sentido, comparar el n√∫mero de registros antes y despu√©s del sem√°foro. <br><br>  Igualdad ProcStatusId = -1 podemos verificar f√°cilmente con AssertEquals: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals es minimalista: simplemente compara dos valores, nada sobrenatural. <br><br><h3>  AssertEquals Procedimientos para hermanos </h3><br>  Para comparar valores, contamos con una serie de procedimientos: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Asertivo </li></ul><br>  Creo que sus nombres hablan por s√≠ mismos.  Lo √∫nico que vale la pena se√±alar es la existencia de un procedimiento AssertEqualsString separado.  La cuesti√≥n es que AssertEquals / AssertNotEquals / AssertLike funciona con SQL_VARIANT, y NVARCHAR (MAX) no se aplica a √©l, y por lo tanto, los desarrolladores de tSQLt tuvieron que asignar un procedimiento separado para probar NVARCHAR (MAX). <br><br><h3>  Funci√≥n falsa </h3><br>  FakeFunction con algo de estiramiento puede llamarse un procedimiento similar a SpyProcedure.  Este falso le permite reemplazar cualquier funci√≥n con la m√°s simple necesaria.  Dado que las funciones en SQL Server funcionan seg√∫n el principio de un tubo con pasta de dientes, dan el resultado a trav√©s del "√∫nico agujero tecnol√≥gico", entonces, desafortunadamente, no se proporciona ninguna funcionalidad de registro.  Solo un reemplazo para la l√≥gica. <br><br><h1>  Trampas </h1><br>  Vale la pena se√±alar algunas dificultades que puede encontrar al trabajar con tSQLt.  En este caso, por dificultades me refiero a algunos problemas problem√°ticos que surgieron debido a las limitaciones de SQL Server y / o que los desarrolladores del marco no pueden resolver. <br><br><h3>  Cancelaci√≥n / corrupci√≥n de transacciones </h3><br>  El primer y m√°s importante problema que enfrent√≥ nuestro equipo fue la cancelaci√≥n de transacciones.  SQL Server no sabe c√≥mo deshacer las transacciones anidadas por separado, solo todo en su conjunto, hasta el m√°s externo.  Dado el hecho de que tSQLt envuelve cada caso de prueba en una transacci√≥n separada, esto se convierte en un problema.  Despu√©s de todo, una reversi√≥n de transacci√≥n dentro del procedimiento de prueba puede interrumpir la ejecuci√≥n de la prueba, causando un error de ejecuci√≥n no descriptivo. <br><br>  Para evitar este problema, utilizamos puntos de guardado.  La idea es simple.  Antes de comenzar una transacci√≥n en el procedimiento de prueba, verificamos si ya estamos dentro de la transacci√≥n.  Si resulta que s√≠, estamos suponiendo que se trata de una transacci√≥n tSQLt, coloque savepoint en lugar de comenzar.  Luego, si es necesario, volveremos a este punto de guardado, y no al comienzo de la transacci√≥n.  Anidar como tal no lo es. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/zk/0u/jc/zk0ujc2gmggccs7bg7icraan3da.png"></div><br>  El problema se complica por la corrupci√≥n de la transacci√≥n.  Si de repente algo sali√≥ mal y la excepci√≥n funcion√≥, entonces la transacci√≥n puede quedar condenada.  Tal transacci√≥n no solo se puede confirmar, sino que tambi√©n se revierte al punto de guardado, solo se revierte todo. <br><br>  Dado todo lo anterior, debe aplicar el siguiente dise√±o: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Considere el c√≥digo en partes.  Primero necesitamos determinar si estamos dentro de una transacci√≥n: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Despu√©s de recibir el indicador @isNestedTransaction, ejecute el bloque TRY y configure el punto de guardado o el inicio de la transacci√≥n, seg√∫n la situaci√≥n. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Despu√©s de que hayamos hecho algo √∫til, confirme, si este es un comienzo "real" del procedimiento. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Por supuesto, si este es un lanzamiento de un caso de prueba, no necesitamos comprometer nada.  Al final de la ejecuci√≥n, tSQLt simplemente revertir√° todos los cambios.  Si de repente algo sali√≥ mal y entramos en el bloque CATCH, entonces lo primero que debe hacer es averiguar si nuestra transacci√≥n puede incluso confirmarse. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Podemos retroceder al punto de guardado solo si <br><br><ol><li>  transacci√≥n commitable </li><li>  se lleva a cabo una prueba, es decir  El punto de salvar existe. </li></ol><br>  En otros casos, necesitamos revertir toda la transacci√≥n. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  S√≠, desafortunadamente, si durante una ejecuci√≥n de prueba obtuvimos una transacci√≥n no confirmable, a√∫n recibimos un error en la ejecuci√≥n del caso de prueba. <br><br><h3>  FakeTable y problema con clave externa </h3><br>  Considere las tablas familiares [Prueba] y [Cl√≠nica]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Recordamos el [TrialID] FK.  ¬øQu√© problemas puede causar esto?  En los ejemplos dados anteriormente, aplicamos FakeTable a ambas tablas a la vez.  Si lo aplicamos solo en [Prueba], obtenemos la siguiente situaci√≥n: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Un intento de insertar una entrada en [Cl√≠nica], de esta manera, puede llegar a ser un fracaso (incluso si preparamos todos los datos necesarios en la versi√≥n falsa de la tabla [Prueba]). <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclusi√≥n: debes fingir todo o no falsificar nada.  En el segundo caso, es obvio que la base debe estar preparada de antemano para la prueba. <br><br><h3>  SpyProcedure sobre procedimientos del sistema </h3><br>  Desgraciadamente, espiar las llamadas a los procedimientos del sistema fallar√°. <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  En el ejemplo del sem√°foro, rastreamos llamadas al procedimiento [SendEmail] escrito por nuestros desarrolladores.  En este caso, escribir un procedimiento separado se debe a la necesidad de recopilar y procesar informaci√≥n adicional antes de enviar mensajes directamente.  En general, uno debe estar mentalmente preparado para el hecho de que puede tener que escribir procedimientos de capa intermedia para algunos procedimientos del sistema con el √∫nico fin de realizar pruebas. <br><br><h1>  Ventajas </h1><br><h3>  Instalaci√≥n r√°pida </h3><br>  La instalaci√≥n se realiza en 2 etapas y dura aproximadamente 2 minutos.  Solo necesita activar el CLR en el servidor, si a√∫n no lo ha hecho, y ejecutar un solo script.  Todo, puede agregar la primera clase de prueba y escribir casos de prueba. <br><br><h3>  Desarrollo r√°pido </h3><br>  tSQLt es una herramienta f√°cil de aprender.  Me tom√≥ un peque√±o d√≠a dominarlo.  Le pregunt√© a mis colegas que trabajaban con el marco, y result√≥ que todos pasar√≠an aproximadamente un d√≠a. <br><br><h3>  Implementaci√≥n r√°pida en CI </h3><br>  Tom√≥ aproximadamente 2 horas configurar la integraci√≥n en CI en nuestro proyecto.  El tiempo, por supuesto, puede variar, pero en general esto no es un problema, y ‚Äã‚Äãla integraci√≥n puede llevarse a cabo muy r√°pidamente. <br><br><h3>  Amplia gama de herramientas </h3><br>  Esta es una evaluaci√≥n subjetiva, pero, en mi opini√≥n, la funcionalidad proporcionada por tSQLt es bastante rica y cubre la mayor parte de las necesidades en la pr√°ctica.  Para casos raros cuando no hay suficientes falsificaciones y afirmaciones incorporadas, hay, por supuesto, tSQLt.Fail. <br><br><h3>  Documentaci√≥n conveniente </h3><br>  La documentaci√≥n oficial es conveniente y consistente.  Con su ayuda, puede comprender f√°cilmente la esencia del uso de tSQLt en poco tiempo, incluso si esta es su primera herramienta de prueba unitaria. <br><br><h3>  Salida conveniente </h3><br>  Los datos se pueden obtener en una forma de texto muy clara: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Tambi√©n puede extraer de la base de datos (cliqueable) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... u obtener en formato XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  La √∫ltima opci√≥n le permite integrar f√°cilmente pruebas en CI.  En particular, todo funciona para nosotros bajo Atlassian Bamboo. <br><br><h3>  Soporte Redgate </h3><br>  Las ventajas incluyen soporte para un proveedor tan grande de herramientas DBA como RedGate.  SQL Test, su complemento para SQL Server Management Studio, funciona con tSQLt desde el primer momento.  Adem√°s, RedGate brinda asistencia al desarrollador principal de tSQLt con el entorno de desarrollo, como afirma el propio desarrollador en los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">grupos de Google</a> . <br><br><h1>  Desventajas </h1><br><h3>  No hay falsificaciones de mesa temporales </h3><br>  tSQLt no permite tablas temporales falsas.  Si es necesario, puede usar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento no oficial</a> .  Desafortunadamente, este complemento solo es compatible con SQL Server 2016+. <br><br><h3>  Sin acceso a bases de datos externas </h3><br>  No funcionar√° mantener una base separada solo para almacenar el marco.  tSQLt est√° dise√±ado para probar lo que contiene en la misma base de datos.  Falso, por desgracia, no funcionar√°. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Las afirmaciones parecen funcionar, pero nadie garantiza su rendimiento, por supuesto. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Errores de documentaci√≥n </h3><br>  A pesar de que escrib√≠ anteriormente sobre la consistencia y accesibilidad de la documentaci√≥n, tambi√©n contiene problemas.  Hay algunos momentos desactualizados en √©l. <br><br>  Ejemplo 1. La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚ÄúGu√≠a de inicio r√°pido‚Äù</a> sugiere descargar el marco de SourceForge.  Se despidieron de SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en 2015</a> . <br><br>  Ejemplo 2. La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gu√≠a ApplyConstraint</a> del ejemplo utiliza la construcci√≥n pesada con el procedimiento Fail para detectar la excepci√≥n, que ser√≠a m√°s f√°cil y visual de reemplazar con ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* []     ExceptException ? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Y esto es natural, porque tiene lugar ... <br><br><h3>  Abandono parcial </h3><br>  Hay un largo descanso en el desarrollo de tSQLt desde principios de 2016 hasta junio de 2019. S√≠, desafortunadamente, esta herramienta est√° parcialmente abandonada.  En 2019, poco a poco, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">juzgar por GitHub</a> , el desarrollo a√∫n avanz√≥.  Aunque los Grupos de Google oficiales <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tienen un hilo</a> en el que se le pregunt√≥ directamente a Sebastian, el desarrollador principal de tSQLt, sobre el destino del desarrollo.  La √∫ltima pregunta se hizo el 2 de marzo de 2019, la respuesta a√∫n no se ha recibido. <br><br><h3>  Problema con SQL Server 2017 </h3><br>  Si est√° utilizando SQL Server 2017, entonces para usted, posiblemente instalar tSQLt requerir√° alguna manipulaci√≥n adicional.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El caso es que, por primera vez desde 2012, SQL Server realiz√≥ cambios de seguridad. </font><font style="vertical-align: inherit;">En el nivel del servidor, se agreg√≥ el indicador "Seguridad estricta de CLR", que proh√≠be la creaci√≥n de ensamblajes sin firmar (incluso SEGURO). </font><font style="vertical-align: inherit;">Una descripci√≥n detallada del problema merece un art√≠culo separado (y, afortunadamente, todo ya est√° bien </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descrito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y los art√≠culos posteriores de la serie). </font><font style="vertical-align: inherit;">Solo prep√°rate mentalmente para ello. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por supuesto, este inconveniente podr√≠a atribuirse a "dificultades", cuya soluci√≥n no depende de los desarrolladores de tSQLt, pero es posible resolver este problema a nivel de marco, aunque requiere un poco de tiempo. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub ya tiene un problema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sin embargo, con su permiso, se ha retrasado desde octubre de 2017 (consulte la subcl√°usula anterior).</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alternativas (¬±) para otros DBMS </font></font></h1><br>        . tSQLt      . ,    (CLR,   T-SQL     SQL ),        ,       . ,     tSQLt  ,       SQL-powered   . <br><br> ,  PostgreSQL       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ptTAP</a> .      ¬´¬ª PL/pgSQL      TAP.  MySQL  ,       ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MyTAP</a> .       Oracle,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utPLSQL</a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Una herramienta de desarrollo muy poderosa y activa (incluso dir√≠a, m√°s que).</font></font><br><br><h1>  Conclusi√≥n </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiz√°s, con toda la informaci√≥n anterior, quer√≠a transmitir dos pensamientos principales. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primero es la utilidad de probar el c√≥digo en una base de datos. </font><font style="vertical-align: inherit;">Ya sea que est√© sentado en SQL Server, Oracle o MySQL, no importa. </font><font style="vertical-align: inherit;">Si tiene una cierta cantidad de l√≥gica no probada almacenada en la base de datos, entonces asume riesgos adicionales. </font><font style="vertical-align: inherit;">Los errores en el c√≥digo de la base de datos son capaces, como los errores en el resto del c√≥digo, de causar da√±os al producto y, como resultado, a la compa√±√≠a que lo suministra. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La segunda idea es elegir una herramienta. </font><font style="vertical-align: inherit;">Si usted, como yo, trabaja con SQL Server, entonces tSQLt es, si no 100% ganador, entonces definitivamente vale la pena su atenci√≥n. </font><font style="vertical-align: inherit;">Incluso a pesar del lento desarrollo reciente, sigue siendo una herramienta relevante que facilita enormemente las pruebas.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuentes que me ayudaron (lista incompleta)</font></font></b> <div class="spoiler_text"> DbFit ‚Äî Automated Open Source Database Testing: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br> DbFit Documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br> Slacker wiki: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br> TST documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br> NUnit Assertions: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br> utTSQL code: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br> Junit Class Assert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br> pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://pgtap.org/</a> <br><br> utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://utplsql.org/</a> <br><br> MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/hepabolu/mytap</a> <br><br> tSQLt Google groups: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br> tSQLt official website: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://tsqlt.org/</a> <br><br> tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br> Google trends: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://bit.ly/2x7BQL6</a> <br><br> How to ROLLBACK a transaction when testing using tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br> What are the Pros and Cons of Manual Unit Testing against the Automated Unit Testing?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against-the-automated-unit-tes#2948354</a> <br><br> The Good, the Bad, and the UgleÃÖeÃÖ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br> Rex Black, Erik Van Veenendal, Dorothy Graham, Foundations of Software Testing, Third edition, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461133/">https://habr.com/ru/post/461133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461121/index.html">Peque√±os experimentos multitarea en un microcontrolador</a></li>
<li><a href="../461125/index.html">La tarea de crear c√≥digos num√©ricos secuenciales para numerar mensajes en el c√≥digo fuente en Visual Studio (ej. C #)</a></li>
<li><a href="../461127/index.html">An√°lisis de rendimiento de VM en VMware vSphere. Parte 3: Almacenamiento</a></li>
<li><a href="../461129/index.html">Sobre kote, esposa, dos hijos, la idea ... y no solo. Historia con continuaci√≥n</a></li>
<li><a href="../461131/index.html">Carro carro ROS Parte 2. Software</a></li>
<li><a href="../461137/index.html">C√≥mo desarrollamos un dispositivo para monitorear la atenci√≥n de los conductores. Vive Yandex.Taxi</a></li>
<li><a href="../461141/index.html">Mi primer d√≠a con Haiku: ella es inesperadamente buena</a></li>
<li><a href="../461143/index.html">Sobre los problemas actuales del dise√±o del juego y las formas de resolverlos. Vista desde abajo</a></li>
<li><a href="../461145/index.html">Qu√© debe liderar un equipo: roles, responsabilidades y habilidades</a></li>
<li><a href="../461147/index.html">C√≥mo ahorrar 64 horas combinando teclas en PowerPoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>