<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò® üêü üë®üèΩ‚Äçüé® Como criamos um reposit√≥rio r√°pido e confi√°vel de visualiza√ß√µes de an√∫ncios üë∑üèº üõãÔ∏è ‚õπüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma das fun√ß√µes discretas mas importantes de nossos sites de an√∫ncios √© salvar e exibir o n√∫mero de visualiza√ß√µes. Nossos sites assistem a visualiza√ß√µ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como criamos um reposit√≥rio r√°pido e confi√°vel de visualiza√ß√µes de an√∫ncios</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/kolesa/blog/431902/"> Uma das fun√ß√µes discretas mas importantes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nossos sites de an√∫ncios</a> √© salvar e exibir o n√∫mero de visualiza√ß√µes.  Nossos sites assistem a visualiza√ß√µes de an√∫ncios h√° mais de 10 anos.  A implementa√ß√£o t√©cnica da funcionalidade conseguiu mudar v√°rias vezes durante esse per√≠odo, e agora √© um (micro) servi√ßo Go, trabalhando com Redis como cache e fila de tarefas e com MongoDB como armazenamento persistente.  Alguns anos atr√°s, ele aprendeu a trabalhar n√£o apenas com a soma de visualiza√ß√µes de an√∫ncios, mas tamb√©m com estat√≠sticas para cada dia.  Mas ele aprendeu a fazer tudo isso com muita rapidez e confiabilidade recentemente. <br><br><img src="https://habrastorage.org/webt/ee/nn/jp/eennjposwyrztis3a7s6cbkhq2e.png" alt="imagem"><br><br>  No total, o servi√ßo processa ~ 300 mil solicita√ß√µes de leitura e ~ 9.000 solicita√ß√µes de grava√ß√£o por minuto, 99% das quais s√£o executadas em at√© 5 ms.  Esses, √© claro, n√£o s√£o indicadores astron√¥micos e nem o lan√ßamento de foguetes em Marte - mas tamb√©m n√£o √© uma tarefa trivial que possa parecer o simples armazenamento de n√∫meros.  Aconteceu que fazer tudo isso, garantindo o armazenamento de dados sem perdas e lendo valores consistentes e relevantes, requer algum esfor√ßo, que discutiremos a seguir. <br><a name="habracut"></a><br><h3>  Tarefas do projeto e vis√£o geral </h3><br>  Embora os contadores de exibi√ß√£o n√£o sejam t√£o cr√≠ticos para os neg√≥cios quanto, por exemplo, processar pagamentos ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solicita√ß√µes de empr√©stimo</a> , eles s√£o importantes antes de tudo para nossos usu√°rios.  As pessoas ficam fascinadas ao rastrear a popularidade de seus an√∫ncios: algumas at√© ligam para o suporte quando percebem informa√ß√µes de visualiza√ß√£o imprecisas (isso aconteceu com uma das implementa√ß√µes de servi√ßos anteriores).  Al√©m disso, armazenamos e exibimos estat√≠sticas detalhadas nas contas pessoais dos usu√°rios (por exemplo, para avaliar a efic√°cia do uso de servi√ßos pagos).  Tudo isso nos faz cuidar de salvar cada evento de visualiza√ß√£o e exibir os valores mais relevantes. <br><br>  Em geral, a funcionalidade e os princ√≠pios do projeto s√£o assim: <br><br><ul><li>  A p√°gina da web ou a tela do aplicativo faz uma solicita√ß√£o por tr√°s dos contadores de exibi√ß√£o de an√∫ncios (a solicita√ß√£o geralmente √© ass√≠ncrona para priorizar a sa√≠da de informa√ß√µes b√°sicas).  E se a p√°gina do an√∫ncio for exibida, o cliente solicitar√° que voc√™ aumente e retorne a quantidade atualizada de visualiza√ß√µes. </li><li>  Ao processar solicita√ß√µes de leitura, o servi√ßo tenta obter informa√ß√µes do cache Redis e complementa o desconhecido concluindo uma solicita√ß√£o ao MongoDB. </li><li>  Os pedidos de grava√ß√£o s√£o enviados para 2 estruturas no rabanete: a fila de atualiza√ß√£o incremental (processada em segundo plano, de forma ass√≠ncrona) e o cache do n√∫mero total de visualiza√ß√µes. </li><li>  Um processo em segundo plano no mesmo servi√ßo l√™ elementos da fila, os acumula no buffer local e os grava periodicamente no MongoDB. </li></ul><br><h3>  Contadores de exibi√ß√£o de registros: armadilhas </h3><br>  Embora as etapas descritas acima pare√ßam bastante simples, o problema aqui √© a organiza√ß√£o da intera√ß√£o entre o banco de dados e as inst√¢ncias de microsservi√ßo, para que os dados n√£o sejam perdidos, duplicados e atrasados. <br><br>  Usar apenas um reposit√≥rio (por exemplo, apenas o MongoDB) resolveria alguns desses problemas.  De fato, o servi√ßo funcionava antes, at√© que enfrentamos os problemas de escala, estabilidade e velocidade. <br><br>  Uma implementa√ß√£o ing√™nua de mover dados entre armazenamentos pode levar, por exemplo, a essas anomalias: <br><br><ul><li>  Perda de dados durante a grava√ß√£o competitiva no cache: <br><ol><li>  O processo <b>A</b> aumenta a contagem de visualiza√ß√µes no cache do Redis, mas descobre que ainda n√£o h√° dados para essa entidade (pode ser uma nova declara√ß√£o ou uma antiga que foi extrudada do cache), portanto, o processo deve primeiro obter esse valor do MongoDB. <br></li><li>  O processo <b>A</b> obt√©m a contagem de visualiza√ß√µes do MongoDB - por exemplo, o n√∫mero 5;  depois adiciona 1 a ele e grava no Redis <b>6</b> . </li><li>  O processo <b>B</b> (iniciado, por exemplo, por outro usu√°rio do site que tamb√©m inseriu o mesmo an√∫ncio) simultaneamente faz o mesmo. </li><li>  O processo <b>A</b> grava um valor de <b>6</b> no Redis. </li><li>  O processo <b>B</b> grava um valor de <b>6</b> no Redis. </li><li>  Como resultado, uma vis√£o √© perdida devido √† corrida ao gravar dados. <br>  <i>O cen√°rio n√£o √© t√£o improv√°vel: por exemplo, temos um servi√ßo pago que coloca um an√∫ncio na p√°gina principal do site.</i>  <i>Para um novo an√∫ncio, esse curso de eventos pode levar √† perda de muitas visualiza√ß√µes ao mesmo tempo devido ao seu repentino influxo.</i> </li></ol></li><li>  Um exemplo de outro cen√°rio √© a perda de dados ao mover visualiza√ß√µes do Redis para o MongoDb: <br><br><ol><li>  O processo seleciona um valor pendente do Redis e o armazena na mem√≥ria para posterior grava√ß√£o no MongoDB. </li><li>  Uma solicita√ß√£o de grava√ß√£o falha (ou o processo falha antes de ser executado). </li><li>  Os dados s√£o perdidos novamente, o que se tornar√° aparente na pr√≥xima vez que o valor em cache for enviado e substitu√≠do pelo valor do banco de dados. </li></ol><br></li></ul><br>  Outros erros podem ocorrer, cujas raz√µes tamb√©m est√£o na natureza n√£o at√¥mica das opera√ß√µes entre os bancos de dados, por exemplo, um conflito ao excluir e aumentar as visualiza√ß√µes da mesma entidade. <br><br><h3>  Gravando contagens de exibi√ß√£o: solu√ß√£o </h3><br>  Nossa abordagem para armazenar e processar dados neste projeto √© baseada na expectativa de que, a qualquer momento, o MongoDB possa falhar com maior probabilidade do que o Redis.  Isso, √© claro, n√£o √© uma <i>regra</i> absoluta - pelo menos n√£o para todos os projetos -, mas em nosso ambiente estamos realmente acostumados a observar tempos limite peri√≥dicos para consultas no MongoDB causadas pelo desempenho de opera√ß√µes de disco, que anteriormente era um dos motivos da perda de alguns eventos. <br><br>  Para evitar muitos dos problemas mencionados acima, usamos filas de tarefas para grava√ß√£o adiada e lua-scripts, que possibilitam alterar atomicamente dados em v√°rias estruturas de rabanete ao mesmo tempo.  Com isso em mente, os detalhes para salvar visualiza√ß√µes s√£o os seguintes: <br><br><ol><li>  Quando um pedido de grava√ß√£o cai no microsservi√ßo, ele executa o script lua <b>IncrementIfExists</b> para aumentar o contador apenas se ele j√° existir no cache.  O script retornar√° imediatamente <b>-1</b> se n√£o houver dados para a entidade sendo exibida no rabanete;  caso contr√°rio, aumenta o valor das visualiza√ß√µes no cache via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HINCRBY</a> , adiciona o evento √† fila para armazenamento subsequente no MongoDB (chamado <i>fila pendente por</i> n√≥s) via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LPUSH</a> e retorna a quantidade atualizada de visualiza√ß√µes. <br></li><li>  Se IncrementIfExists retornar um n√∫mero positivo, esse valor ser√° retornado ao cliente e a solicita√ß√£o ser√° encerrada. <br><br>  Caso contr√°rio, o microsservi√ßo pega o contador de visualiza√ß√µes do MongoDb, o incrementa em 1 e o envia para o rabanete. <br></li><li>  A <b>grava√ß√£o</b> no rabanete √© realizada por meio de outro script lua - <b>Upsert</b> - que salva o n√∫mero total de visualiza√ß√µes no cache, se ainda estiver vazio, ou aumenta em 1 se outra pessoa conseguir preencher o cache entre as etapas 1 e 3. <br></li><li>  Upsert tamb√©m adiciona um evento de exibi√ß√£o √† fila pendente e retorna uma quantia atualizada, que √© ent√£o enviada ao cliente. <br></li></ol><br>  Devido ao fato de os scripts lua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">serem executados atomicamente</a> , evitamos muitos problemas em potencial que podem ser causados ‚Äã‚Äãpor uma grava√ß√£o competitiva. <br><br>  Outro detalhe importante √© garantir a transfer√™ncia segura de atualiza√ß√µes da fila pendente para o MongoDB.  Para fazer isso, usamos o modelo "fila confi√°vel" descrito na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redis</a> , que reduz significativamente as chances de perda de dados, criando uma c√≥pia dos elementos processados ‚Äã‚Äãem uma fila separada e outra at√© que eles sejam finalmente armazenados em um armazenamento persistente. <br><br>  Para entender melhor todas as etapas do processo, preparamos uma pequena visualiza√ß√£o.  Primeiro, vejamos um cen√°rio normal e bem-sucedido (as etapas est√£o numeradas no canto superior direito e s√£o descritas em detalhes abaixo): <br><br><img src="https://habrastorage.org/webt/0v/al/bq/0valbqz3kj6du62z0foxfcb6bay.gif" alt="imagem"><br><br><ol><li>  O microsservi√ßo recebe uma solicita√ß√£o de grava√ß√£o </li><li>  O manipulador de solicita√ß√£o o passa para um lua-script que grava a pesquisa no cache (tornando-o imediatamente leg√≠vel) e na fila para processamento adicional. </li><li>  A goroutine em segundo plano (periodicamente) executa a opera√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BRPopLPush</a> , que move atomicamente um elemento de uma fila para outra (chamamos de ‚Äúfila de processamento‚Äù - uma fila com elementos atualmente processados).  O mesmo elemento √© ent√£o armazenado em um buffer na mem√≥ria do processo. <br></li><li>  Outra solicita√ß√£o de grava√ß√£o chega e est√° sendo processada, o que nos deixa com 2 elementos no buffer e 2 na fila de processamento. </li><li>  Ap√≥s algum tempo limite, o processo em segundo plano decide liberar o buffer no MongoDB.  A grava√ß√£o de v√°rios valores do buffer √© realizada por uma √∫nica solicita√ß√£o, o que afeta positivamente a taxa de transfer√™ncia.  Al√©m disso, antes da grava√ß√£o, o processo tenta combinar v√°rias visualiza√ß√µes em uma, resumindo seus valores para os mesmos an√∫ncios. <br>  <i>Em cada um dos nossos projetos, s√£o usadas 3 inst√¢ncias de microsservi√ßo, cada uma com seu pr√≥prio buffer, que √© salvo no banco de dados a cada 2 segundos.</i>  <i>Durante esse per√≠odo, aproximadamente 100 elementos s√£o acumulados em um buffer.</i> <i><br></i> </li><li>  Ap√≥s uma grava√ß√£o bem-sucedida, o processo remove itens da fila de processamento, sinalizando que o processamento foi conclu√≠do com √™xito. <br></li></ol><br>  Quando todos os subsistemas est√£o em ordem, algumas dessas etapas podem parecer redundantes.  E o leitor atento tamb√©m pode ter uma pergunta sobre o que faz o esquilo que dorme no canto inferior esquerdo. <br>  Tudo √© explicado ao considerar o cen√°rio em que o MongoDB n√£o est√° dispon√≠vel: <br><br><img src="https://habrastorage.org/webt/hl/jd/bs/hljdbsmwzxn6i2k5xfgj2mm02em.gif" alt="Um exemplo de servi√ßo quando o MongoDB falha"><br><br><ol><li>  A primeira etapa √© id√™ntica aos eventos do cen√°rio anterior: o servi√ßo recebe 2 solicita√ß√µes para registrar visualiza√ß√µes e process√°-las. <br></li><li>  O processo perde a conex√£o com o MongoDB (o pr√≥prio processo, √© claro, ainda n√£o sabe sobre isso). <br>  O manipulador Gorutin, como antes, est√° tentando liberar seu buffer no banco de dados - mas desta vez sem sucesso.  Ela volta a aguardar a pr√≥xima itera√ß√£o. <br></li><li>  Outra goroutine de segundo plano acorda e verifica a fila de processamento.  Ela descobre que os elementos foram adicionados a ela h√° muito tempo;  concluindo que o processamento falhou, ela os move de volta para a fila pendente. <br></li><li>  Depois de um tempo, a conex√£o com o MongoDB √© restaurada. <br></li><li>  A primeira goroutine em segundo plano tenta novamente executar uma opera√ß√£o de grava√ß√£o - desta vez com √™xito - e, finalmente, remove permanentemente itens da fila de processamento. <br></li></ol><br>  Nesse esquema, existem v√°rios tempos limite e heur√≠sticos importantes derivados de testes e senso comum: por exemplo, os itens s√£o movidos de volta da fila de processamento para a fila pendente ap√≥s 15 minutos de inatividade.  Al√©m disso, a goroutine respons√°vel por esta tarefa executa um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bloqueio</a> antes da execu√ß√£o, para que v√°rias inst√¢ncias do microsservi√ßo n√£o tentem restaurar as visualiza√ß√µes "congeladas" simultaneamente. <br><br>  A rigor, mesmo essas medidas n√£o fornecem garantias teoricamente fundamentadas (por exemplo, ignoramos cen√°rios como o processo congela por 15 minutos) - mas, na pr√°tica, funciona de maneira bastante confi√°vel. <br><br>  Tamb√©m neste esquema, existem pelo menos mais duas vulnerabilidades conhecidas por n√≥s que s√£o importantes para estar ciente de: <br><br><ul><li>  Se o microsservi√ßo falhar imediatamente ap√≥s salvar com √™xito no MongoDb, mas antes de limpar a lista de filas de processamento, esses dados ser√£o considerados n√£o salvos - e ap√≥s 15 minutos ser√£o salvos novamente. <br>  <i>Para reduzir a probabilidade de um cen√°rio como esse, fornecemos tentativas repetidas para remover da fila de processamento em caso de erros.</i>  <i>Na realidade, ainda n√£o observamos esses casos em produ√ß√£o.</i> <br></li><li>  Quando voc√™ reinicia, o rabanete pode perder n√£o apenas o cache, mas tamb√©m algumas visualiza√ß√µes n√£o salvas das filas, pois est√° configurado para salvar periodicamente os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instant√¢neos de RDB a</a> cada poucos minutos. <br>  <i>Embora na teoria isso possa ser um problema s√©rio (especialmente se o projeto lida com dados realmente cr√≠ticos), na pr√°tica os n√≥s s√£o extremamente raramente reiniciados.</i>  <i>Ao mesmo tempo, de acordo com o monitoramento, os elementos passam em filas por menos de 3 segundos, ou seja, a quantidade poss√≠vel de perdas √© muito limitada.</i> <br></li></ul><br>  Pode parecer que h√° mais problemas do que gostar√≠amos.  No entanto, de fato, o cen√°rio do qual defendemos inicialmente - a falha do MongoDB - √© realmente uma amea√ßa muito mais real, e o novo esquema de processamento de dados garante com sucesso a disponibilidade do servi√ßo e evita perdas. <br><br>  Um exemplo v√≠vido disso foi quando a inst√¢ncia do MongoDB em um dos projetos ficou absurdamente indispon√≠vel a noite toda.  Durante todo esse tempo, as contagens de exibi√ß√£o acumularam e giraram em um rabanete de uma fila para outra, at√© que finalmente foram salvas no banco de dados ap√≥s a resolu√ß√£o do incidente;  a maioria dos usu√°rios nem percebeu a falha. <br><br><h3>  A contagem de visualiza√ß√µes de leitura </h3><br>  As solicita√ß√µes de leitura s√£o muito mais simples que as solicita√ß√µes de grava√ß√£o: o microsservi√ßo primeiro verifica o cache no rabanete;  tudo o que n√£o √© encontrado no cache √© preenchido com dados do MongoDb e retornado ao cliente. <br><br>  N√£o h√° grava√ß√£o de ponta a ponta no cache durante as opera√ß√µes de leitura para evitar a sobrecarga de prote√ß√£o contra grava√ß√µes competitivas.  O hitrate do cache permanece bom, pois, na maioria das vezes, ele j√° ser√° aquecido gra√ßas a outras solicita√ß√µes de grava√ß√£o. <br><br>  As estat√≠sticas di√°rias de exibi√ß√£o s√£o lidas diretamente no MongoDB, pois s√£o solicitadas com muito menos frequ√™ncia e o armazenamento em cache √© mais dif√≠cil.  Isso tamb√©m significa que, quando o banco de dados n√£o est√° dispon√≠vel, as estat√≠sticas de leitura param de funcionar;  mas afeta apenas uma pequena parte dos usu√°rios. <br><br><h3>  Esquema de armazenamento de dados do MongoDB </h3><br>  O esquema de coleta do MongoDB para o projeto √© baseado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nessas recomenda√ß√µes dos pr√≥prios desenvolvedores do banco de dados</a> e tem a seguinte apar√™ncia: <br><br><ul><li>  As visualiza√ß√µes s√£o salvas em 2 cole√ß√µes: em uma existe o valor total, na outra - estat√≠sticas por dia. <br></li><li>  Os dados na cole√ß√£o de estat√≠sticas s√£o organizados com base em <b>um documento por an√∫ncio por m√™s</b> .  Para novos an√∫ncios, um documento preenchido com trinta e um zero para o m√™s atual √© inserido na cole√ß√£o;  De acordo com o artigo mencionado acima, isso permite que voc√™ aloque imediatamente espa√ßo suficiente para um documento no disco, para que o banco de dados n√£o precise mov√™-lo ao adicionar dados. <br>  <i>Esse item torna o processo de leitura de estat√≠sticas um pouco estranho (as solicita√ß√µes precisam ser geradas por meses no lado do microsservi√ßo), mas, em geral, o esquema permanece bastante intuitivo.</i> <br></li><li>  A opera√ß√£o <b>upsert</b> √© usada para registrar, a fim de atualizar e, se necess√°rio, criar um documento para a entidade desejada dentro da mesma solicita√ß√£o. <br></li></ul><br>  N√£o usamos os recursos transacionais do MongoDb para atualizar v√°rias cole√ß√µes ao mesmo tempo, o que significa que corremos o risco de que os dados possam ser gravados em apenas uma cole√ß√£o.  Por enquanto, simplesmente registramos esses casos;  existem poucos, e at√© agora isso n√£o apresenta o mesmo problema significativo que outros cen√°rios. <br><br><h3>  Teste </h3><br>  N√£o confiaria em minhas pr√≥prias palavras que os cen√°rios descritos realmente funcionam se n√£o fossem cobertos por testes. <br><br>  Como a maioria do c√≥digo do projeto trabalha em conjunto com rabanetes e MongoDb, a maioria dos testes s√£o de integra√ß√£o.  O ambiente de teste √© suportado atrav√©s do docker-compose, o que significa que ele pode ser implantado rapidamente, fornece reprodutibilidade redefinindo e restaurando o estado a cada inicializa√ß√£o e possibilita a experi√™ncia sem afetar os bancos de dados de outras pessoas. <br><br>  Neste projeto, existem 3 √°reas principais de teste: <br><br><ol><li>  Valida√ß√£o da l√≥gica de neg√≥cios em cen√°rios t√≠picos, os chamados  caminho feliz.  Esses testes respondem √† pergunta - quando todos os subsistemas est√£o em ordem, o servi√ßo funciona de acordo com os requisitos funcionais? </li><li>  Verificar cen√°rios negativos em que o servi√ßo deve continuar seu trabalho.  Por exemplo, o servi√ßo realmente n√£o perde dados quando o MongoDb falha? <br>  Temos certeza de que as informa√ß√µes permanecem consistentes com intervalos peri√≥dicos, congelamentos e opera√ß√µes de grava√ß√£o competitivas? </li><li>  Verificar cen√°rios negativos em que n√£o esperamos que o servi√ßo continue, mas ainda deve ser fornecido um n√≠vel m√≠nimo de funcionalidade.  Por exemplo, n√£o h√° chance de o servi√ßo continuar salvando e fornecendo dados quando nem rabanete nem mongo estiverem dispon√≠veis - mas queremos ter certeza de que, nesses casos, n√£o trava, mas espera recupera√ß√£o do sistema e volta ao trabalho. </li></ol><br>  Para verificar cen√°rios sem √™xito, o c√≥digo l√≥gico da empresa de servi√ßos funciona com as interfaces do cliente de banco de dados, que nos testes necess√°rios s√£o substitu√≠das por implementa√ß√µes que retornam erros e / ou simulam atrasos na rede.  Tamb√©m simulamos a opera√ß√£o paralela de v√°rias inst√¢ncias de servi√ßo usando o padr√£o " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">objeto de ambiente</a> ".  Essa √© uma variante da conhecida abordagem de "invers√£o de controle", na qual as fun√ß√µes n√£o acessam as depend√™ncias, mas as recebem atrav√©s do objeto de ambiente passado nos argumentos.  Entre outras vantagens, a abordagem permite simular v√°rias c√≥pias independentes do servi√ßo em um teste, cada uma com seu pr√≥prio conjunto de conex√µes com o banco de dados e reproduz com mais ou menos efici√™ncia o ambiente de produ√ß√£o.  Alguns testes executam cada uma dessas inst√¢ncias em paralelo e garantem que todos vejam os mesmos dados e que n√£o haja condi√ß√µes de corrida. <br><br>  Tamb√©m realizamos um teste de estresse rudimentar, mas ainda bastante √∫til, baseado em <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cerco</a> , que ajudou a estimar aproximadamente a carga permitida e a velocidade de resposta do servi√ßo. <br><br><h3>  Sobre desempenho </h3><br>  Para 90% das solicita√ß√µes, o tempo de processamento √© muito pequeno e, o mais importante - est√°vel;  Aqui est√° um exemplo de medidas em um dos projetos ao longo de v√°rios dias: <br><br><img src="https://habrastorage.org/webt/ln/bk/zy/lnbkzy7-wnykbaelv4vzsd8b53q.png" alt="imagem"><br><br>  Curiosamente, um registro (que na verdade √© uma opera√ß√£o de grava√ß√£o + leitura, porque retorna valores atualizados) √© um pouco mais r√°pido que a leitura (mas apenas do ponto de vista de um cliente que n√£o observa o registro atrasado real). <br>  Um aumento regular da manh√£ nos atrasos √© um efeito colateral do trabalho de nossa equipe de an√°lise, que coleta suas pr√≥prias estat√≠sticas diariamente com base nos dados do servi√ßo, criando uma "carga artificial artificial" para n√≥s. <br><br>      :           (          ‚Äî          MongoDB),       (      ),     : <br><br><img src="https://habrastorage.org/webt/6f/pz/v9/6fpzv9b8lmswdsjhmrn4gk_qugw.png" alt="imagem"><br><br><h3>  Conclus√£o </h3><br> ,  -  , ,   Redis                . <br><br>       , 95%    ,     .      ,                .           5. <br><br>        Go, Redis  MongoDB             .                 ,       .         ,      ‚Äî      . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt431902/">https://habr.com/ru/post/pt431902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431886/index.html">Al Lowy carregou sua cole√ß√£o de c√≥digos fonte dos produtos Sierra no eBay</a></li>
<li><a href="../pt431888/index.html">"Acho que as id√©ias da equipe s√£o as mais importantes no desenvolvimento de um produto."</a></li>
<li><a href="../pt431890/index.html">Como fazer um pedido na troca freelance</a></li>
<li><a href="../pt431894/index.html">Em dezembro, eles decidir√£o sobre o registro obrigat√≥rio de esta√ß√µes base LPWAN</a></li>
<li><a href="../pt431898/index.html">√â tudo sobre o Agile - 2: Recursos de implementa√ß√£o do Agile</a></li>
<li><a href="../pt431904/index.html">Como descarregamos especialistas em RH: informa√ß√µes para emiss√£o de folhas de pagamento</a></li>
<li><a href="../pt431906/index.html">PIFR - um m√©todo de gerar uma m√°scara 3D, independentemente do √¢ngulo de rota√ß√£o da face</a></li>
<li><a href="../pt431908/index.html">Configurando a API do Tinkoff Bank. Como est√° sua intui√ß√£o ....? Ou uma m√∫sica sobre Oauth 2.0</a></li>
<li><a href="../pt431910/index.html">PSEFABRIC - uma nova abordagem para gerenciamento e automa√ß√£o de rede. Passo para o ideal</a></li>
<li><a href="../pt431912/index.html">O maior bot-no foi preso nos EUA: o que isso significa para a comunidade digital?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>