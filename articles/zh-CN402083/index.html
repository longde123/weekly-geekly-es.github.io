<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¦ ğŸ¥ª ğŸ¼ å°†Seekçƒ­åƒä»ªè¿æ¥åˆ°STM32 ğŸ“™ ğŸ‘©ğŸ½â€ğŸ’¼ ğŸ‘©ğŸ¿â€ğŸ”§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å°†çƒ­åƒä»ªè¿æ¥åˆ°å¾®æ§åˆ¶å™¨ï¼Ÿ æ²¡é—®é¢˜ï¼ ç‰¹åˆ«æ˜¯å¦‚æœå®ƒæ˜¯å¸¦æœ‰USBä¸»æœºæ¥å£çš„STM32å’ŒDadgetçš„Seekçƒ­æˆåƒä»ªï¼ 


 é€šè¿‡SeekThermalçƒ­æˆåƒä»ªçš„çœ¼ç›ç„Šæ¥çƒ™é“ 

 å¼•è¨€ 
 æˆ‘è®¤ä¸ºæ¯ä¸ªäººéƒ½æ›¾ç»é‡åˆ°è¿‡åƒçƒ­æˆåƒä»ªè¿™æ ·çš„å°å·¥å…·ï¼Œè‡³å°‘ä»–ä»¬å·²ç»è¯»è¿‡äº†ã€‚ åœ¨è¿™äº›è®¾å¤‡ä¸­ï¼Œæœ‰æ•´ä¸ªå°é…ä»¶çš„å­ç±»ï¼Œå®ƒä»¬ä¸...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å°†Seekçƒ­åƒä»ªè¿æ¥åˆ°STM32</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dadget/blog/402083/"> å°†çƒ­åƒä»ªè¿æ¥åˆ°å¾®æ§åˆ¶å™¨ï¼Ÿ æ²¡é—®é¢˜ï¼ ç‰¹åˆ«æ˜¯å¦‚æœå®ƒæ˜¯å¸¦æœ‰USBä¸»æœºæ¥å£çš„STM32å’ŒDadgetçš„Seekçƒ­æˆåƒä»ªï¼ <br><br><img src="https://habrastorage.org/files/3ad/79a/d94/3ad79ad944a24f2daa5ab8b49aae3376.jpg"><br>  <i>é€šè¿‡SeekThermalçƒ­æˆåƒä»ªçš„çœ¼ç›ç„Šæ¥çƒ™é“</i> <br><a name="habracut"></a><br><h4> å¼•è¨€ </h4><br> æˆ‘è®¤ä¸ºæ¯ä¸ªäººéƒ½æ›¾ç»é‡åˆ°è¿‡åƒçƒ­æˆåƒä»ªè¿™æ ·çš„å°å·¥å…·ï¼Œè‡³å°‘ä»–ä»¬å·²ç»è¯»è¿‡äº†ã€‚ åœ¨è¿™äº›è®¾å¤‡ä¸­ï¼Œæœ‰æ•´ä¸ªå°é…ä»¶çš„å­ç±»ï¼Œå®ƒä»¬ä¸æ˜¯ç‹¬ç«‹çš„è®¾å¤‡ï¼Œè€Œæ˜¯ç”¨ä½œè®¡ç®—æœºæˆ–æ™ºèƒ½æ‰‹æœºçš„æœºé¡¶ç›’ã€‚ <br><br> ä»Šå¤©ï¼Œæˆ‘ä»¬å°†è®¨è®ºå°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Seek</a>çƒ­æˆåƒä»ªè¿æ¥åˆ°STM32å¾®æ§åˆ¶å™¨ã€‚ è€ŒDadgetå…¬å¸ä¸ºæˆ‘æä¾›äº†æ­¤è®¾å¤‡ã€‚ åœ¨Geektimesçš„å¹¿é˜”å‘å±•ä¸­ï¼Œäººä»¬ä¸æ­¢ä¸€æ¬¡åœ°è€ƒè™‘äº†è¿™ç§çƒ­æˆåƒä»ªï¼šå®ƒä¸»è¦æ¶µç›–äº†å…¶åœ¨Androidä¸Šçš„å·¥ä½œï¼Œä»¥åŠæœ‰å…³å°†è¯¥è®¾å¤‡è¿æ¥åˆ°PCçš„æ–‡ç« ã€‚ åœ¨æˆ‘çš„è¯„è®ºä¸­ï¼Œæˆ‘æƒ³è°ˆè°ˆæˆ‘è‡ªå·±é€šè¿‡USBä¸»æœºå°†Seekçƒ­æˆåƒä»ªè¿æ¥åˆ°STM32å¾®æ§åˆ¶å™¨çš„ç»å†ã€‚ <br><br><h4> ç¡¬ä»¶è¦æ±‚ </h4><br> æ²¡æœ‰é‚£ä¹ˆå…·ä½“ï¼ æ‚¨æ‰€æœ‰çš„STM32åº”è¯¥å…·æœ‰ä¸€ä¸ªèƒ½å¤Ÿåœ¨ä¸»æœºæ¨¡å¼ä¸‹å·¥ä½œçš„USBæ¥å£å’Œä¸€äº›ç”¨äºæ§åˆ¶LCDå±å¹•çš„æ¥å£ã€‚ æœ€æ˜æ˜¾çš„é€‰æ‹©æ˜¯é‡‡ç”¨STM32F4-å‘ç°ã€‚ æˆ‘æ‰‹ä¸Šæœ‰STM32F746G-å‘ç°æ¿ã€‚ å› æ­¤ï¼Œè¯´æ˜å°†é’ˆå¯¹è¯¥æ¿ï¼Œä½†æ˜¯ï¼ å› ä¸º å¦‚æœä»£ç æ˜¯åœ¨CubeMXç¯å¢ƒä¸­ç”Ÿæˆçš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªEVMã€‚ æˆ‘è®¤ä¸ºæˆ‘ä¸ºæ­¤é¡¹ç›®æ”¯ä»˜çš„æ¬¾é¡¹è¿‡å¤šã€‚ <br><br><h4> è½¯ä»¶éƒ¨åˆ† </h4><br> é€šè¿‡USBè¿›è¡Œé€šä¿¡æ—¶ï¼Œæ­¤çƒ­åƒä»ªä¸ä¼šå®ç°ä»»ä½•ç±»åˆ«ã€‚ æ‰€æœ‰äº¤äº’éƒ½ç›´æ¥è¿›è¡Œï¼Œæ‰¹é‡è¯·æ±‚é€šè¿‡ç«¯ç‚¹è¿›è¡Œã€‚ é€šè¿‡å°†å‘½ä»¤ï¼ˆè¯·æ±‚ï¼‰å‘é€åˆ°æ§åˆ¶ç«¯ç‚¹ï¼Œæ‚¨å¯ä»¥æ‰“å¼€çƒ­æˆåƒä»ªï¼Œè¿›è¡Œæ ¡å‡†ï¼Œå¹¶ä½¿å…¶ä¼ è¾“ä¸€å¸§æˆ–å‡ å¸§ã€‚ æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®ºå›ä¸­</a>ä»‹ç»äº†Seek Thermalçš„ç‰¹åˆ«è¯¦ç»†çš„å·¥ä½œã€‚ <br><br> å› æ­¤ï¼Œä¸ºäº†ä½¿çƒ­åƒä»ªèƒ½å¤Ÿä¸STM32å¾®æ§åˆ¶å™¨ä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ï¼š <br><br>  1ï¼‰ä»¥ä»»ä½•æ‚¨å–œæ¬¢çš„æ¿å­çš„USBä¸»æœºä¸ºä¾‹ï¼ˆæˆ‘ä»¥STM32F7 CubeMXæ ·æœ¬é›†ä¸­çš„STM32 USBä¸»æœºCDCä¸ºä¾‹ï¼‰ï¼› <br>  2ï¼‰æŠ›å‡ºè®¾å¤‡ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼› <br>  3ï¼‰ç¼–å†™æ–¹ä¾¿çš„åŒ…è£…ç¨‹åºï¼Œä»¥ä½¿ç”¨è¯»/å†™åŠŸèƒ½æ¥æ§åˆ¶ç«¯ç‚¹å’Œæ•°æ®ç«¯ç‚¹ï¼› <br>  4ï¼‰ç¼–å†™å°†åŸå§‹æ•°æ®è½¬æ¢ä¸ºæ˜¾ç¤ºå†…å®¹çš„å‡½æ•°ï¼› <br>  5ï¼‰ä½¿ç”¨LUTï¼ˆå½©è‰²æŸ¥æ‰¾è¡¨ï¼‰å°†å•è‰²å›¾åƒç€è‰²ã€‚ è¿™ç§ç¼ºé™·å‡ºç°åœ¨STM32ç³»åˆ—å¾®æ§åˆ¶å™¨ä¸­ï¼Œå¯ä»¥ç”¨LCDå±å¹•ç‹¬ç«‹æ§åˆ¶ã€‚ <br><br> é¦–å…ˆï¼Œè®©æˆ‘ä»¬åšä¸€äº›ç±»ä¼¼äºlibusbçš„æ–‡ç« ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ç”¨ä»¥ä¸‹ä»£ç é“¾æ¥HALåº“ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">libusbçš„è¿‡ç¨‹ä»£ç </b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libusb_control_transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(libusb_device_handle* dev_handle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request_type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bRequest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wLength, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span><span class="hljs-function"> </span></span>{ hUSBHost.Control.setup.b.bmRequestType = request_type; hUSBHost.Control.setup.b.bRequest = bRequest; hUSBHost.Control.setup.b.wValue.w = wValue; hUSBHost.Control.setup.b.wIndex.w = wIndex; hUSBHost.Control.setup.b.wLength.w = wLength; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> status; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { status = USBH_CtlReq(&amp;hUSBHost, data, wLength); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (status == USBH_BUSY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != USBH_OK) { hUSBHost.RequestState = CMD_SEND; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wLength; } }</code> </pre> <br></div></div><br> ç„¶åï¼Œæˆ‘ä»¬åœ¨<a href="">è¿™é‡Œ</a> <i>æŸ¥çœ‹vendor_transfer</i>è¿‡ç¨‹ã€‚ å¦å¤–ï¼Œæ³¨æ„è¯·æ±‚<i>struct Request</i>çš„åˆ—è¡¨ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå®³å¤„ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">vendor_transferç¨‹åºä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vendor_transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> direction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bmRequestType = (direction ? LIBUSB_ENDPOINT_IN : LIBUSB_ENDPOINT_OUT) | LIBUSB_REQUEST_TYPE_VENDOR | LIBUSB_RECIPIENT_INTERFACE; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bRequest = req; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> wValue = value; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> wIndex = index; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * aData = data; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> wLength = size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!direction) { <span class="hljs-comment"><span class="hljs-comment">// to device #ifdef LOG_DEBUG USBH_UsrLog("ctrl_transfer(0x%x, 0x%x, 0x%x, 0x%x, %d)", bmRequestType, bRequest, wValue, wIndex, wLength); printf(" ["); for (int i = 0; i &lt; wLength; i++) { printf(" %02x", data[i]); } printf(" ]\n"); #endif res = libusb_control_transfer(handle, bmRequestType, bRequest, wValue, wIndex, aData, wLength, timeout); #ifdef LOG_DEBUG if (res != wLength) { USBH_UsrLog("Bad returned length: %d\n", res); } #endif } else { // from device #ifdef LOG_DEBUG USBH_UsrLog("ctrl_transfer(0x%x, 0x%x, 0x%x, 0x%x, %d)", bmRequestType, bRequest, wValue, wIndex, wLength); #endif res = libusb_control_transfer(handle, bmRequestType, bRequest, wValue, wIndex, aData, wLength, timeout); #ifdef LOG_DEBUG if (res != wLength) { USBH_UsrLog("Bad returned length: %d\n", res); } printf(" -&gt; ["); for (int i = 0; i &lt; res; i++) { printf(" %02x", data[i]); } printf(" ]\n"); #endif } return res; }</span></span></code> </pre><br></div></div><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™æ¥æ”¶å›¾ç‰‡çš„è¿‡ç¨‹ã€‚  CDCç¤ºä¾‹ä¸­æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„è¦è¯„è®ºçš„ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">USBæ•°æ®æ¥æ”¶ç¨‹åº</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CAM_ProcessReception</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(USBH_HandleTypeDef *phost)</span></span></span><span class="hljs-function"> </span></span>{ USBH_URBStateTypeDef URB_Status = USBH_URB_IDLE; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> length = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> data_rx_state = CDC_RECEIVE_DATA; size = FRAME_WIDTH * FRAME_HEIGHT; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bufsize = size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bsize = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (data_rx_state != CDC_IDLE) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(data_rx_state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CDC_RECEIVE_DATA: USBH_BulkReceiveData (phost, &amp;rawdata[bsize], <span class="hljs-number"><span class="hljs-number">512</span></span>, InPipe); data_rx_state = CDC_RECEIVE_DATA_WAIT; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CDC_RECEIVE_DATA_WAIT: URB_Status = USBH_LL_GetURBState(phost, InPipe); <span class="hljs-comment"><span class="hljs-comment">/*Check the status done for reception*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(URB_Status == USBH_URB_DONE ) { length = USBH_LL_GetLastXferSize(phost, InPipe); bsize+= length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(((bufsize - length) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (bsize &lt; bufsize)) <span class="hljs-comment"><span class="hljs-comment">//TODO { data_rx_state = CDC_RECEIVE_DATA; } else { data_rx_state = CDC_IDLE; } #if (USBH_USE_OS == 1) osMessagePut ( phost-&gt;os_event, USBH_CLASS_EVENT, 0); #endif } break; default: break; } } return data_rx_state; }</span></span></code> </pre><br></div></div><br> å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼åœ¨å±å¹•ä¸Šç»˜åˆ¶æ¥æ”¶åˆ°çš„æ•°æ®ã€‚ æˆ‘æ³¨æ„åˆ°åœ¨æ•°æ®çš„ç¬¬20ä¸ªå­—èŠ‚ï¼ˆå³16ä½åƒç´ é˜µåˆ—ï¼‰ä¸­ï¼Œå­˜å‚¨äº†æœ‰å…³å¸§ç±»å‹çš„ä¿¡æ¯ã€‚ æœ‰å‡ ç§ç±»å‹çš„æ¡†æ¶ã€‚ æˆ‘ä»¬å¯¹æ ¡å‡†æ¡†æ¶å’Œå·¥ä½œæ¡†æ¶æ„Ÿå…´è¶£ã€‚ å½“çƒ­åƒä»ªå…³é—­çª—å¸˜å¹¶æ‹æ‘„â€œæš—åº¦â€ç…§ç‰‡æ—¶ï¼Œå°†è·å¾—æ ¡å‡†å¸§ã€‚ æ‹æ‘„æ™®é€šç…§ç‰‡æ—¶ï¼Œå¿«é—¨ä¼šæ‰“å¼€ã€‚ å› æ­¤ï¼Œåœ¨å·¥ä½œæ—¶ï¼Œæ‚¨æ€»æ˜¯ä¼šå¬åˆ°è®¾å¤‡ç‚¹å‡»å¿«é—¨çš„å£°éŸ³ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å±å¹•ç»˜åˆ¶æ­¥éª¤</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BSP_LCD_DrawArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Xpos, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Ypos, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bit_pixel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pbmp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> index2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// uint32_t address; //uint32_t input_color_mode = 0; //uint32_t Color; static int pixel; static int calib_pixel=0; uint8_t Component; static int v; uint8_t frame_type; frame_type = *(__IO uint8_t *) (pbmp + 20); switch (frame_type) { case 6: calib_pixel = (*(uint16_t*)pbmp); minpixel = calib_pixel; //calib_pixel = bswap_16(calib_pixel); break; case 3: /* Convert picture to ARGB8888 pixel format */ for(index=0; index &lt; height; index++) { for(index2=0; index2 &lt; width; index2++) { pixel = (*(uint16_t*)pbmp); //pixel = bswap_16(pixel); //v = pixel - calib_pixel; //v += 0x8000; if (maxpixel &lt; pixel) maxpixel = pixel; if (minpixel &gt; pixel) minpixel = pixel; if (pixel &lt; 0) { pixel = 0; } if (pixel &gt; 0xFFFF) { pixel = 0xFFFF; } v = map(pixel, 6000, 13000, 0, 255); //v = (v - MAX) * 255 / (MIN - MAX); if (v &lt; 0) v = 0; if (v &gt; 255) v = 255; BSP_LCD_DrawPixel(index2+270, index+100, (0xFF &lt;&lt; 24) | (uint8_t)v &lt;&lt; 16 | (uint8_t)v &lt;&lt; 8 | (uint8_t)v); pbmp += 2; } } break; case 4: break; } }</span></span></code> </pre><br></div></div><br> æœ€åï¼Œä»ä¸­å¯ä»¥çœ‹åˆ°ä¸»å¾ªç¯-å‰ªåˆ‡äº†ä»€ä¹ˆåœ°æ–¹ï¼Œæ’å…¥äº†ä»€ä¹ˆåœ°æ–¹ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ä¸»å¾ªç¯</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DELAY1 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> USB_PIPE_NUMBER 0x81 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FRAME_WIDTH 208 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FRAME_HEIGHT 156 uint8_t OutPipe, InPipe; uint8_t usb_device_state; uint8_t rawdata[FRAME_HEIGHT*FRAME_WIDTH*2]; uint8_t data[64]; USBH_StatusTypeDef status; uint8_t transf_size; int size; int main(void) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Enable the CPU Cache */</span></span></span><span class="hljs-meta"> CPU_CACHE_Enable(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* STM32F7xx HAL library initialization: - Configure the Flash ART accelerator on ITCM interface - Configure the Systick to generate an interrupt each 1 msec - Set NVIC Group Priority to 4 - Low Level Initialization */</span></span></span><span class="hljs-meta"> HAL_Init(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Configure the System clock to have a frequency of 200 MHz */</span></span></span><span class="hljs-meta"> SystemClock_Config(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Init CDC Application */</span></span></span><span class="hljs-meta"> CDC_InitApplication(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Init Host Library */</span></span></span><span class="hljs-meta"> USBH_Init(&amp;hUSBHost, USBH_UserProcess, 0); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Add Supported Class */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//USBH_RegisterClass(&amp;hUSBHost, USBH_CDC_CLASS); /* Start Host Process */ USBH_Start(&amp;hUSBHost); /* Run Application (Blocking mode) */ while (1) { /* USB Host Background task */ USBH_Process(&amp;hUSBHost); if (hUSBHost.gState == HOST_CHECK_CLASS) { switch (usb_device_state) { case 1: status = USBH_Get_StringDesc(&amp;hUSBHost,hUSBHost.device.DevDesc.iManufacturer, data , 64); if (status == USBH_OK) { USBH_UsrLog("## Manufacturer : %s", (char *)data); HAL_Delay(1000); usb_device_state = 1; } break; case 2: status = USBH_Get_StringDesc(&amp;hUSBHost, hUSBHost.device.DevDesc.iProduct, data , 64); if (status == USBH_OK) { USBH_UsrLog("## Product : %s", (char *)data); HAL_Delay(1000); usb_device_state = 2; } break; case 0: InPipe = USBH_AllocPipe(&amp;hUSBHost, 0x81); status = USBH_OpenPipe(&amp;hUSBHost, InPipe, 0x81, hUSBHost.device.address, hUSBHost.device.speed, USB_EP_TYPE_BULK, USBH_MAX_DATA_BUFFER); if (status == USBH_OK) usb_device_state = 3; break; case 3: HAL_Delay(1); const uint8_t data0[2] = {0x00, 0x00}; vendor_transfer(0, SET_OPERATION_MODE, 0, 0, data0, 2); vendor_transfer(0, SET_OPERATION_MODE, 0, 0, data0, 2); vendor_transfer(0, SET_OPERATION_MODE, 0, 0, data0, 2); data[0] = 0x01; vendor_transfer(0, TARGET_PLATFORM, 0, 0, data, 1); data[0] = 0x00; data[1] = 0x00; vendor_transfer(0, SET_OPERATION_MODE, 0, 0, data); transf_size = vendor_transfer(1, GET_FIRMWARE_INFO, 0, 0, data, 4); transf_size = vendor_transfer(1, READ_CHIP_ID, 0, 0, data, 12); const uint8_t data1[6] = { 0x20, 0x00, 0x30, 0x00, 0x00, 0x00 }; vendor_transfer(0, SET_FACTORY_SETTINGS_FEATURES, 0, 0, data1, 6); transf_size = vendor_transfer(1, GET_FACTORY_SETTINGS, 0, 0, data, 64); const uint8_t data2[6] = { 0x20, 0x00, 0x50, 0x00, 0x00, 0x00 }; vendor_transfer(0, SET_FACTORY_SETTINGS_FEATURES, 0, 0, data2, 6); transf_size = vendor_transfer(1, GET_FACTORY_SETTINGS, 0, 0, data, 64); const uint8_t data3[6] = { 0x0c, 0x00, 0x70, 0x00, 0x00, 0x00 }; vendor_transfer(0, SET_FACTORY_SETTINGS_FEATURES, 0, 0, data3, 6); transf_size = vendor_transfer(1, GET_FACTORY_SETTINGS, 0, 0, data, 24); const uint8_t data4[6] = { 0x06, 0x00, 0x08, 0x00, 0x00, 0x00 }; vendor_transfer(0, SET_FACTORY_SETTINGS_FEATURES, 0, 0, data4, 6); vendor_transfer(1, GET_FACTORY_SETTINGS, 0, 0, data, 12); const uint8_t data5[2] = { 0x08, 0x00 }; vendor_transfer(0, SET_IMAGE_PROCESSING_MODE, 0, 0, data5, 2); vendor_transfer(1, GET_OPERATION_MODE, 0, 0, data,2); const uint8_t data6[2] = { 0x08, 0x00 }; vendor_transfer(0, SET_IMAGE_PROCESSING_MODE, 0, 0, data6, 2); const uint8_t data7[2] = { 0x01, 0x00 }; vendor_transfer(0, SET_OPERATION_MODE, 0, 0, data7, 2); vendor_transfer(1, GET_OPERATION_MODE, 0, 0, data, 2); USBH_UsrLog("SeeK Thermal Init Done.\n"); size = FRAME_WIDTH * FRAME_HEIGHT; int bufsize = size * sizeof(uint16_t); status = CDC_IDLE; usb_device_state = 4; break; case 4: //while(1 ){ // request a frame data[0] = (uint8_t)(size &amp; 0xff); data[1] = (uint8_t)((size&gt;&gt;8)&amp;0xff); data[2] = 0; data[3] = 0; if (status == CDC_IDLE) vendor_transfer(0, 0x53, 0, 0, data, 4); status = CAM_ProcessReception(&amp;hUSBHost); if (status == CDC_IDLE) BSP_LCD_DrawArray(10, 10, FRAME_WIDTH, FRAME_HEIGHT, 16, rawdata); usb_device_state = 4; break; } } } }</span></span></span></span></code> </pre><br></div></div><br><h4> ç»“è®º </h4><br> ä½¿ç”¨å¾®æ§åˆ¶å™¨çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çƒ­åƒä»ª</a>çš„æ“ä½œçœ‹ä¸Šå»æ¯”ä½¿ç”¨æ™ºèƒ½æ‰‹æœºçš„æ“ä½œå¿«å¾—å¤šã€‚ æˆ‘æ¨èè¿™ä¸ªå°å·¥å…·æ¥è¯„ä¼°ç”µå­è®¾å¤‡çš„çƒ­å›¾åƒã€‚ çƒ­åƒä»ªçš„ç„¦è·å¯è°ƒï¼Œæ‚¨ç”šè‡³å¯ä»¥è€ƒè™‘æ¿ä¸Šçš„å•ä¸ªç”µå­ç»„ä»¶ï¼ æ€»ä¹‹ï¼Œæ‚¨å¯ä»¥ä»è¯¥è§†é¢‘ä¸­è¯„ä¼°çƒ­åƒä»ªçš„é€Ÿåº¦ï¼ˆå¤§çº¦8-9 fpsï¼‰ <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/c5nP_0Eil9A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><div class="spoiler">  <b class="spoiler_title">ç»™æ½œåœ¨ä¹°å®¶çš„ä¿¡æ¯</b> <div class="spoiler_text"> æ‚¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯ä»¥</a>é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŒ‡å®šGEEKT-ST2ä¿ƒé”€ä»£ç </a>ä»¥10ï¼…çš„æŠ˜æ‰£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è´­ä¹°Seek Thermal Thermal Imager</a> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN402083/">https://habr.com/ru/post/zh-CN402083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN402073/index.html">åœ¨SpaceXçš„ä¸€é¡¹æ–°åº”ç”¨ä¸­ï¼Œäº’è”ç½‘åˆ†å‘å«æ˜Ÿçš„æ•°é‡å·²å¢åŠ åˆ°12,000</a></li>
<li><a href="../zh-CN402075/index.html">iPad Pro 2é¢„è®¡å°†æä¾›7ä¸ªåŠŸèƒ½+é¢„è®¡å‘å¸ƒæ—¥æœŸ</a></li>
<li><a href="../zh-CN402077/index.html">é»‘æ´ä¸­ä¿¡æ¯æ¶ˆå¤±çš„æ‚–è®ºç®€ä»‹</a></li>
<li><a href="../zh-CN402079/index.html">æ“ä½œç³»ç»Ÿå’Œè§†é¢‘ä¿å­˜åœ¨DNAä¸­ï¼Œç„¶åæ— è¯¯è¯»å–</a></li>
<li><a href="../zh-CN402081/index.html">æˆ‘ä»¬åˆ†å‘è…ºä½“ï¼Œä»¥ç»„ç»‡å„¿ç«¥æœºå™¨äººä¿±ä¹éƒ¨</a></li>
<li><a href="../zh-CN402087/index.html">æ‰¾å‡ºè°æ˜¯æœ€èªæ˜çš„äººï¼Œæˆ–è€…ä¸ºæˆ‘çš„ç¯é™æ¸©</a></li>
<li><a href="../zh-CN402089/index.html">é€šè¿‡ç©è€æ¥æ•™å­©å­æœºå™¨äººï¼šBQ Zowiæœºå™¨äºº</a></li>
<li><a href="../zh-CN402091/index.html">åœ¨è·å…°å’Œç¾å›½å…·æœ‰ä¸“ç”¨é©±åŠ¨å™¨çš„VPSï¼ˆKVMï¼‰ï¼Œæ¯ä¸ªäººå…è´¹ä½¿ç”¨1-3ä¸ªæœˆï¼Œæå®¢æ—¶é—´å¯è·å¾—1ä¸ªæœˆçš„å¥–åŠ±</a></li>
<li><a href="../zh-CN402093/index.html">å¤§è„‘çš„é”™è§‰ã€‚ ä¸ºä»€ä¹ˆæ­£ä¹‰ä¸é€»è¾‘ä¸ç›¸å®¹</a></li>
<li><a href="../zh-CN402095/index.html">æ¶ˆæä¸»ä¹‰ã€‚ æŠ•è¯‰ä¸ºè‰ºæœ¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>