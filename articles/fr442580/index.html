<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤠 💇🏼 🔡 Rétro-ingénierie au format binaire utilisant les fichiers Korg .SNG comme exemple ⌨️ 🆑 🎂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous vivons à une époque incroyable. Autour de nous, une multitude de technologies: téléphones, ordinateurs, montres intelligentes et autres gadgets. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rétro-ingénierie au format binaire utilisant les fichiers Korg .SNG comme exemple</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442580/"><img src="https://habrastorage.org/webt/ve/-p/e3/ve-pe3tgqlv4dwca26xozjh6t2s.jpeg"><br><br>  Nous vivons à une époque incroyable.  Autour de nous, une multitude de technologies: téléphones, ordinateurs, montres intelligentes et autres gadgets.  Chaque jour, les fabricants lancent de plus en plus d'appareils sur le marché.  La plupart d'entre eux sont destinés à une vie courte et lumineuse (ou pas): une puissante société de marketing au moment de la sortie, 1-2 ans de support complet par le fabricant, puis un lent oubli.  Les appareils simples peuvent fonctionner pendant des années après la fin de la période d'assistance officielle.  Avec les appareils intelligents, cela devient plus difficile.  C'est bien si le gadget continue de fonctionner au moins après la déconnexion des serveurs / services du fabricant.  Et c'est une chance si la prochaine mise à jour du système d'exploitation, des pilotes ou d'autres logiciels ne bat pas la compatibilité. <br><a name="habracut"></a><br>  Malheureusement, les événements se développent de plus en plus selon un scénario pessimiste.  Et 5 à 10 ans après l'achat, nous avons entre nos mains des appareils techniquement solides, qui ne peuvent néanmoins pas être utilisés en raison du manque de support logiciel.  Bien sûr, un gadget cassé est désagréable.  Mais beaucoup plus désagréable s'il existe des données utilisateur dans un format incompatible avec quoi que ce soit.  Ces données peuvent être considérées comme perdues si l'appareil cesse de fonctionner.  Dans mon cas, le pire n'est pas encore arrivé, mais les alarmes sonnent déjà. <br><br>  Il y a donc la célèbre société Korg, qui produit des équipements musicaux de très haute qualité.  En 2010, j'ai acheté un synthétiseur de cette société pour pratiquer la musique comme passe-temps.  La microstation Korg est un modèle assez avancé.  Entre autres choses, il a un séquenceur à bord pour enregistrer ses pistes et peut écrire des données sur une carte mémoire au format SNG propriétaire.  Il est possible d'exporter vers un format midi commun, mais presque toutes les métadonnées sont perdues: informations sur les effets et filtres superposés, divers réglages d'instruments virtuels, etc.  Le problème principal pour moi personnellement est la vitesse de transition vers l'enregistrement des idées musicales.  La muse est une création fantaisiste, et la plupart du temps je tombe sur une idée intéressante simplement en improvisant ou en jouant quelque chose de simple.  Plus vite j'appuie sur le bouton d'enregistrement sans me promener dans le menu, plus je peux répéter et enregistrer un fragment intéressant, qui à l'avenir pourrait faire partie d'une œuvre à part entière.  Bien sûr, cette approche est imparfaite, mais nous parlons d'un passe-temps.  D'une manière ou d'une autre, depuis près de dix ans, j'ai accumulé environ mille croquis musicaux et croquis au format SNG. <br><br>  La cloche sonna sous la forme d'une série de pépins du synthétiseur, nécessitant un clignotement de l'appareil.  Et j'ai pensé à convertir toutes mes données accumulées au format Midi, d'autant plus que cela facilitera beaucoup leur stockage, leur organisation et leur édition.  La recherche du convertisseur dans Google n'a rien donné.  Il y a beaucoup de demandes sur toutes sortes de forums, l'histoire dure depuis 20 ans, sinon plus.  Tout ce que j'ai trouvé était l'ancien utilitaire Windows de quelqu'un d'autre, naturellement incompatible avec mes fichiers. <br><br>  Et puis j'ai décidé d'essayer de voir en quoi consiste ce format SNG?  Peut-être que quelque part à l'intérieur, il y a des données MIDI normales que vous pouvez facilement extraire et enregistrer? <br><br><h3>  Une tentative de résoudre le problème "front" </h3><br>  Ainsi, à partir des instructions du synthétiseur, vous pouvez découvrir que le format SNG est un conteneur dans lequel les soi-disant «chansons» sont stockées.  Chaque chanson contient 16 pistes de séquenceur avec des données musicales, ainsi que des paramètres pour les sons et les effets.  Lors de l'exportation au format Midi via le menu du synthétiseur, chaque «morceau» est exporté vers un fichier .MID distinct, et tous les paramètres de sons et d'effets sont perdus.  Parce que  Je joue mes idées sous la forme la plus simple et sans effets, le problème est précisément un grand nombre de fichiers SNG et l'inconvénient du processus de conversion manuelle.  Voyons si ce processus peut être accéléré ou automatisé. <br><br>  Rappelons d'abord ce que sont les données MIDI.  En termes simples, il s'agit d'un flux d'événements musicaux: appuyer et relâcher une touche, appuyer et relâcher une pédale de sustain, changer le tempo, le patch (instrument virtuel) et d'autres paramètres.  Chaque événement contient un delta temporel à partir du moment de l'événement précédent et des données, par exemple, l'intensité et la hauteur de la note.  Le format de fichier midi est très simple: en plus des en-têtes et des données elles-mêmes, il n'y a pratiquement rien. <br><img src="https://habrastorage.org/webt/va/4r/jr/va4rjrzdye1cuhhufe1j5nvfdqk.jpeg"><br>  <i>Le rose est un événement Note On.</i>  <i>Le jaune pâle est un delta du temps.</i>  <i>Bleu - Événement Note Off.</i> <br><br>  Essayons de chercher nos données midi dans le fichier SNG.  Pour ce faire, écrivez une séquence de plusieurs notes sur le synthétiseur et exportez-la dans les deux formats.  Parce que  Puisque nous ne savons pas exactement où se trouvent les données musicales dans les fichiers binaires, nous allons essayer de répéter le processus avec différentes séquences de notes. <br><br>  Ci-après, j'utilise l'éditeur Hex Synalyze It!  Ses capacités à l'avenir nous seront très utiles.  En attendant, utilisez simplement la fonction de comparaison binaire. <br><img src="https://habrastorage.org/webt/ap/rc/um/aprcumsiubha7hfzvasa3cbsxd0.jpeg"><br>  En fait, seul le nom de la «chanson» coïncidait.  En comparant deux fichiers SNG avec des séquences de notes différentes, nous pouvons approximativement deviner où exactement les données musicales sont stockées, mais pour l'instant cela ne nous aidera en aucune façon - le format des données est différent.  Le fichier lui-même est dix fois plus volumineux que le fichier Midi et semble contenir beaucoup d'informations supplémentaires.  Vous pouvez voir la signature KORG dans les quatre premiers octets et quelques autres lignes, y compris le nom du «morceau» et les noms des patchs (tons) assignés aux pistes. <br><br><h3>  Analyse de la structure des blocs de données </h3><br>  Cela pourrait être accompli si, heureusement, il n'y avait pas d'outils qui facilitaient l'analyse et la compréhension de la structure des données binaires.  Le même programme Synalaze It! Nous aidera à cela, ce qui vous permet de créer et d'appliquer une «grammaire» pour l'analyse des fichiers binaires. <br><br>  La grammaire est une structure descriptive hiérarchique qui vous permet de représenter des données binaires sous une forme lisible par l'homme.  Le programme vous permet de télécharger la grammaire pour certains formats.  Par exemple, pour le même midi: <br><img src="https://habrastorage.org/webt/5j/fh/f1/5jfhf1mz0twm0_8pajoitnmcvxe.jpeg"><br>  Pour le format SNG, aucune grammaire toute prête n'était attendue.  Eh bien, voyons ce que nous pouvons extraire du fichier par nous-mêmes. <br><br>  Commençons par le titre.  En règle générale, cette partie contient la signature du fichier, les informations de version, les tailles et les décalages des blocs de données.  Après avoir comparé plusieurs fichiers SNG différents, nous trouvons les parties invariables et prêtons une attention particulière à celles qui changent <br><img src="https://habrastorage.org/webt/xp/dc/1i/xpdc1inosnksf1cl567lhuef62w.jpeg"><br>  Créez une structure de titre dans l'éditeur de grammaire.  Les 4 premiers octets sont évidemment la signature du fichier.  Supposons que les 4 octets suivants sont versionnés.  Les quelques dizaines d'octets suivants ne changent pas et ne contiennent rien d'intéressant - nous allons créer pour eux des données binaires de la taille appropriée.  Mais alors le plaisir commence.  Vous pouvez remarquer certains modèles dans le comportement des octets aux décalages 0x13 et 0x1b.  La seconde semble correspondre au nombre de «chansons» dans notre fichier.  Et le premier augmente également avec la quantité de données dans l'en-tête - cela semble être la taille, seul le compte à rebours ne vient pas du début du fichier, mais de l'octet suivant 0x14.  À ce stade, nous ne pouvons que deviner le type de données numériques.  Supposons que la taille soit de type UInt32, c'est-à-dire  prend 4 octets.  Ajoutez-les à notre structure.  Maintenant, nous pouvons définir la taille de la structure d'en-tête (taille + 20). <br><img src="https://habrastorage.org/webt/av/ad/kt/avadkttmovx2nj_aj1gqdlnvvsk.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Grammaire avec structure d'en-tête de fichier ajoutée</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ol/xd/lw/olxdlwqbmnyjybfbcrsvujibxta.jpeg"><br></div></div><br>  Voyons ce qui vient ensuite.  Si vous regardez attentivement, vous remarquerez que les abréviations à trois lettres sont dispersées dans le fichier: SNG1, SDK1, SGS1, etc.  Ces caractères se trouvent dans tous les fichiers SNG, nous pouvons donc supposer que ce sont des signatures de certains blocs.  De plus, notre titre s'est terminé avec beaucoup de succès juste avant l'une de ces signatures.  Comparez le comportement des 4 octets suivants dans des fichiers de tailles différentes.  On peut voir que les valeurs augmentent avec l'augmentation de la quantité de données. <br><img src="https://habrastorage.org/webt/kb/w-/4k/kbw-4kahz2btt_qwz-wd37pb-gu.jpeg"><br>  Quelques expériences, analyses et calculs supplémentaires, et l'image suivante commence à émerger: <br><br><img src="https://habrastorage.org/webt/ld/jn/iy/ldjniyrqi4s8a_n_unggs2-b0sq.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">Vue graphique alternative</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gj/tn/bv/gjtnbvwnqv4yr2nz0zdrl9irupg.jpeg"><br></div></div><br>  Ainsi, notre fichier est constitué d'une hiérarchie de blocs assez simple.  Il existe des blocs parents qui peuvent contenir plusieurs blocs enfants.  Il existe des blocs de feuilles (dans la terminologie des arbres binaires) qui ne contiennent pas d'autres blocs. <br><br>  Puis la magie commence.  <b>Avec seulement quelques structures de grammaire, nous pouvons analyser complètement la structure du fichier de bloc</b> <br><br>  Créez donc une structure de modèle DataChunk avec les champs suivants (la taille est indiquée entre crochets): <br><br>  id: String [4] <br>  taille: Int [4] <br>  hiérarchie: Int [4] <br>  données: structure <br><br>  Créez maintenant une structure parentChunk qui hérite de DataChunk.  Dans la propriété de la hiérarchie, spécifiez Fixed Value 0x400 - c'est un signe du bloc parent.  Assurez-vous de cocher la case Doit correspondre. <br><br>  De même, créez childChunk.  Dans ce cas, la hiérarchie aura deux valeurs: 0x240100 et 0x100 <br><br>  Ajoutez des références aux structures parentChunk et childChunk à la structure parentChunk de données - de cette façon, nous créons la récursivité. <br><br>  Enfin, ajoutez une référence à la structure parentChunk dans le nœud principal. <br><img src="https://habrastorage.org/webt/jj/d3/gq/jjd3gq-5q330yazk-6q8fl1naa8.jpeg"><br>  L'ordre des éléments dans la structure de données de parentChunk doit être Variable, il est également nécessaire de définir le nombre minimum et maximum d'enfants de cette structure: 0 et Illimité, respectivement. <br><br>  Appliquons les changements, et le tour est joué - notre fichier est bien analysé dans les blocs principaux <br><img src="https://habrastorage.org/webt/ny/qx/pz/nyqxpztkqdknd1scoh63o28ezkq.jpeg"><br>  Nous ne savons toujours rien des données elles-mêmes, mais nous pouvons désormais naviguer beaucoup plus facilement dans le fichier et nous concentrer sur la recherche des informations dont nous avons besoin. <br><br><h3>  Analyser un bloc contenant une table des matières d'un fichier </h3><br>  Pour la formation, essayons d'analyser un bloc simple, par exemple, SDK1.  Apparemment, il contient quelque chose comme une table des matières - une liste de chansons et probablement quelques décalages / tailles. <br><img src="https://habrastorage.org/webt/zr/-r/dq/zr-rdqiljqlnsflxebu5e2nx8q0.jpeg"><br>  Créez une structure sdk1Chunk qui hérite de childChunk.  Nous éditerons le champ ID, indiquant la signature de notre bloc dans le champ Valeurs fixes.  N'oubliez pas la case à cocher Doit correspondre.  Dans les données de bloc, on peut observer un motif de répétition assez évident: le nom du «morceau» et des données jusqu'ici inconnues.  Notez que la taille des fragments répétés est de 64 octets.  De plus, en comparant les versions de fichiers avec un nombre différent de «chansons», vous pouvez déterminer que le nombre est stocké dans les quatre premiers octets.  En utilisant des calculs simples et en faisant plusieurs hypothèses, nous obtenons la version suivante de la structure dans la grammaire: <br><img src="https://habrastorage.org/webt/oo/mh/p3/oomhp3mjkz5pymbcxksszwdrn8w.jpeg"><br>  Ici, j'ai créé une structure enfant SongInfo de 64 octets et indiqué la possibilité de répéter numSongs fois.  Voici le résultat de l'application de la grammaire: <br><img src="https://habrastorage.org/webt/0w/bi/th/0wbithoju1jbjec30hjxmo7tiwu.jpeg"><br>  Une analyse plus approfondie des dossiers reste une question technique.  J'ai changé les réglages généraux du «morceau» et les paramètres des pistes individuelles sur le synthétiseur.  En comparant les versions de fichiers avec diverses modifications, vous pouvez améliorer et affiner la grammaire.  Après un nombre suffisamment important de telles itérations, il n'y a presque pas de données non reconnues dans le fichier.  J'ai été un peu emporté par le processus et j'ai trié presque toutes les sections du fichier, même si cela n'était pas nécessaire pour la tâche d'origine. <br><br><div class="spoiler">  <b class="spoiler_title">Une petite partie de la grammaire d'un fichier SNG après 8 heures d'analyse</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/td/zt/2b/tdzt2btswihzm3dxjubmbztvaa0.jpeg"><br></div></div><br>  Les détails de ce processus me manqueront - à l'avenir, nous nous concentrerons directement sur l'analyse des données musicales. <br><br>  Mais plus à ce sujet dans la partie suivante.  Nous y rencontrerons une tâche intéressante de conversion de données (elle est tout à fait appropriée pour les entretiens), essayons de la résoudre avec un petit script et entendons un résultat de conversion de test assez inhabituel. <br><br><h3>  Résultats préliminaires </h3><br>  Le besoin de fichiers binaires de rétro-ingénierie peut survenir de manière inattendue.  Par exemple, pour analyser le micrologiciel de l'appareil, convertir à partir de formats de données rares, analyser les menaces numériques ou même modifier de manière triviale les sauvegardes de jeu.  Des outils modernes vous permettent de résoudre ces problèmes rapidement et efficacement.  Il y a environ 10 ans, je recherchais le micrologiciel d'un ordinateur portable et ce processus pourrait prendre plusieurs semaines.  Il a ensuite fallu écrire manuellement des scripts pour analyser les blocs de données et disposer les structures.  Avec une nouvelle approche partiellement automatisée, j'ai créé une grammaire de fichiers presque complète en seulement quelques jours. <br><br>  Vous pouvez démarrer l'analyse du fichier binaire en recherchant des chaînes - elles peuvent donner les premiers indices et accélérer le processus d'analyse.  Les fichiers binaires sont souvent constitués de blocs de données organisés selon une structure hiérarchique ou linéaire.  Si vous traitez avec cette structure, une analyse plus approfondie sera beaucoup plus facile.  L'en-tête du fichier peut donner des indications sur les décalages / tailles des blocs de données.  Dans les premières étapes, il est logique de se concentrer sur la description des structures et des blocs évidents.  La tâche d'analyse est grandement simplifiée par la possibilité de créer de nouvelles versions de fichiers avec différents réglages, paramètres et données.  Il existe un certain nombre de difficultés associées à des types de données inconnus et à l'ordre des octets dans leur représentation binaire (Endianness).  Nous aborderons ces questions dans la partie suivante. <br><br><h3>  Lecture recommandée </h3><br>  Andreas Pehnack.  Comment aborder l'analyse de format de fichier binaire </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442580/">https://habr.com/ru/post/fr442580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442570/index.html">Règles Sigma. Craft ou nouvelle norme pour SOC</a></li>
<li><a href="../fr442572/index.html">Utilisation de l'outil de configuration de Datapath</a></li>
<li><a href="../fr442574/index.html">Création de la base d'une théorie généralisée des réseaux de neurones</a></li>
<li><a href="../fr442576/index.html">Overclockers de longue durée: comment le refroidissement liquide a commencé à dominer dans les centres de données</a></li>
<li><a href="../fr442578/index.html">Version Linux 5.0</a></li>
<li><a href="../fr442582/index.html">Comment nous avons essayé le mobbing</a></li>
<li><a href="../fr442584/index.html">Documents sur le bâtiment: petites joies de l'automatisation sur l'exemple de la Tour Sombre</a></li>
<li><a href="../fr442586/index.html">La vulnérabilité dans Telegram permet de contourner le mot de passe du code local de n'importe quelle longueur</a></li>
<li><a href="../fr442588/index.html">Poser une question à l'auteur de Lua</a></li>
<li><a href="../fr442590/index.html">Trucs et astuces de Digital Forensics: Comment trouver une connexion VPN active dans le vidage de mémoire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>