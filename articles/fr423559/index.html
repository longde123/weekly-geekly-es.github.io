<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÑÔ∏è üßòüèª üì≤ Sauvegarde et restauration des ressources Kubernetes avec Heptio Ark üîì üêî üëó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous avez probablement d√ª reconstruire le cluster Kubernetes apr√®s un √©chec. Avez-vous eu une strat√©gie de sauvegarde intelligente qui ne n√©cessite pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegarde et restauration des ressources Kubernetes avec Heptio Ark</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/423559/"><p>  Vous avez probablement d√ª reconstruire le cluster Kubernetes apr√®s un √©chec.  Avez-vous eu une strat√©gie de sauvegarde intelligente qui ne n√©cessite pas de labour pendant plusieurs jours?  Oui, vous pouvez sauvegarder sur un cluster etcd, mais que faire si seulement une partie du cluster tombe ou si vous utilisez des volumes persistants comme AWS EBS? </p><br><p>  Dans de tels cas, le moyen le plus simple consiste √† utiliser l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Heptio Ark</a> . </p><a name="habracut"></a><br><p>  Avec Heptio, vous pouvez effectuer des sauvegardes de l'ensemble du cluster, des espaces de noms individuels ou des types de ressources et effectuer des sauvegardes dans les d√©lais.  Pour moi, le principal avantage de Heptio Ark est son int√©gration avec divers fournisseurs de services cloud, par exemple AWS, Azure, Google Cloud, etc. Donc, quand il est sauvegard√©, il prend des instantan√©s des volumes persistants utilis√©s. </p><br><p>  Voyons comment installer cet utilitaire et comment il effectue des sauvegardes simples et planifi√©es, puis les restaure. </p><br><p>  Il y aura un article s√©par√© sur la sauvegarde des volumes permanents. </p><br><h2 id="ustanovka">  L'installation </h2><br><p>  Vous trouverez les instructions d'installation ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">examples / README.md.</a>  Ce processus cr√©era plusieurs d√©finitions de ressources personnalis√©es, des r√®gles RBAC (contr√¥le d'acc√®s bas√© sur les r√¥les) qui permettent √† Heptio de sauvegarder et de se d√©ployer.  Par d√©faut, ils se trouvent dans l'espace de noms heptio-ark. </p><br><p>  Important!  Apr√®s une installation r√©ussie, vous devez configurer heptio-ark pour indiquer au serveur quel fournisseur de services cloud utiliser et o√π stocker les sauvegardes.  Voici √† quoi ressemble cette configuration: </p><br><pre><code class="plaintext hljs">apiVersion: ark.heptio.com/v1 kind: Config metadata: namespace: heptio-ark name: default backupStorageProvider: name: aws bucket: heptio-backup-bucket config: region: eu-central-1 backupSyncPeriod: 30m gcSyncPeriod: 30m scheduleSyncPeriod: 1m restoreOnlyMode: false</code> </pre> <br><p>  Vous pouvez l'appliquer √† l'aide de la commande </p><br><pre> <code class="plaintext hljs"> kubectl apply -f heptio.yaml</code> </pre> <br><p>  Heptio sait maintenant dans quel seau sauvegarder.  L'emplacement de stockage de sauvegarde doit √™tre accessible √† partir des foyers d'heptio-serveur, vous pouvez donc utiliser le profil d'instance avec acc√®s √† ce compartiment ou Kube2IAM pour les profils d'instance dynamiques bas√©s sur le foyer. </p><br><p>  Enfin, pour les sauvegardes, les planifications et la r√©cup√©ration, vous devez t√©l√©charger la CLI Heptio Ark depuis le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><p>  Presque toutes les commandes peuvent √™tre ex√©cut√©es en tant que d√©finitions de ressources personnalis√©es via YAML ou JSON. </p><br><h2 id="rezervnoe-kopirovanie">  Sauvegarde </h2><br><p>  Dans ce petit exemple, j'ai cr√©√© un simple d√©ploiement NGINX, et avant lui un service dans l'espace de noms du <strong>serveur web</strong> : </p><br><pre> <code class="plaintext hljs">$ kubectl get all NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE deploy/nginx 1 1 1 1 28s NAME DESIRED CURRENT READY AGE rs/nginx-66f5756f9b 1 1 1 28s NAME READY STATUS RESTARTS AGE po/nginx-66f5756f9b-c88ck 1/1 Running 0 28s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE svc/nginx ClusterIP 10.32.0.183 &lt;none&gt; 80/TCP 28s</code> </pre> <br><p>  Faisons une sauvegarde √† partir de l'interface CLI Heptio Ark: </p><br><pre> <code class="plaintext hljs">$ ark backup create nginx-simple --include-namespaces webserver</code> </pre> <br><p>  Cette commande sauvegarde uniquement l'espace de noms du <strong>serveur Web</strong> .  Sans ce param√®tre, Heptio Ark cr√©era une sauvegarde compl√®te de toutes les ressources du cluster Kubernetes.  La sauvegarde prendra un certain temps.  Une copie sera enregistr√©e dans le <strong>compartiment</strong> sp√©cifi√© dans S3 ( <strong>heptio-backup-bucket</strong> ).  Pour afficher l'√©tat et la liste de toutes les sauvegardes, entrez la commande suivante dans la CLI: </p><br><pre> <code class="plaintext hljs">$ ark backup get NAME STATUS CREATED EXPIRES SELECTOR nginx-simple Completed 2018-07-08 17:35:09 +0200 CEST 29d &lt;none&gt;</code> </pre> <br><p>  Comme vous pouvez le voir, la sauvegarde est termin√©e. </p><br><h2 id="vosstanovlenie-bekapov">  R√©cup√©ration de sauvegarde </h2><br><p>  Supprimons l'espace de noms du serveur Web (en ligne): </p><br><pre> <code class="plaintext hljs">$ kubectl delete ns heptio-test</code> </pre> <br><p>  Maintenant, restaurez l'espace de noms apr√®s une suppression ¬´al√©atoire¬ª, et √† nouveau √† partir de l'interface CLI Heptio Ark: </p><br><pre> <code class="plaintext hljs">$ ark restore create --from-backup nginx-simple Restore request "nginx-simple-20180708173924" submitted successfully. Run `ark restore describe nginx-simple-20180708173924` for more details.</code> </pre> <br><p>  Vous devez voir que l'espace de noms et toutes les ressources (d√©ploiement, jeu de r√©plicas, sous-service et service) sont restaur√©s: </p><br><pre> <code class="plaintext hljs">$ kubectl get all NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE deploy/nginx 1 1 1 1 20s NAME DESIRED CURRENT READY AGE rs/nginx-66f5756f9b 1 1 1 20s NAME READY STATUS RESTARTS AGE po/nginx-66f5756f9b-9mjvg 1/1 Running 0 20s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE svc/nginx ClusterIP 10.32.0.77 &lt;none&gt; 80/TCP 20s</code> </pre> <br><h2 id="struktura-rezervnoy-kopii">  Structure de sauvegarde </h2><br><p>  Pour afficher la structure de sauvegarde, chargez-la simplement du compartiment dans S3 ou entrez la commande Heptio Ark: </p><br><pre> <code class="plaintext hljs">$ ark backup download nginx-simple Backup nginx-simple has been successfully downloaded to $PWD/nginx-simple-data.tar.gz</code> </pre> <br><p><img src="https://habrastorage.org/webt/ce/_w/-4/ce_w-4fypbzo8uczxhovphip6e4.png"></p><br><p>  Dans le fichier webserver.json de notre espace de noms, nous voyons une ressource d'espace de noms r√©guli√®re. </p><br><pre> <code class="plaintext hljs">{ "apiVersion":"v1", "kind":"Namespace", "metadata": { "annotations": { "kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"v1\",\"kind\":\"Namespace\",\"metadata\":{\"annotations\":{},\"name\":\"webserver\",\"namespace\":\"\"}}\n" }, "creationTimestamp":"2018-07-08T15:26:44Z", "name":"webserver", "resourceVersion":"3364", "selfLink":"/api/v1/namespaces/webserver", "uid":"52698ae7-82c3-11e8-8529-0645eb60c3f4" }, "spec": { "finalizers":["kubernetes"] }, "status": { "phase":"Active" } }</code> </pre> <br><p>  Si nous n'avons pas besoin d'une r√©cup√©ration compl√®te, nous pouvons restaurer uniquement une partie √† l'aide de la commande Heptio Ark ou aller directement √† la sauvegarde et restaurer cette partie via kubectl. </p><br><pre> <code class="plaintext hljs">$ ark schedule create nginx-schedule --schedule="* 10 * * *" --include-namespaces webserver Schedule "nginx-schedule" created successfully.</code> </pre> <br><h2 id="zapusk-bekapa-po-raspisaniyu">  Sauvegarde planifi√©e </h2><br><p>  Heptio Ark peut effectuer des t√¢ches planifi√©es.  Nous indiquons quelles ressources et espaces de noms doivent √™tre inclus dans la sauvegarde ou exclus de celle-ci et quand effectuer la sauvegarde: </p><br><pre> <code class="plaintext hljs">$ ark schedule create nginx-schedule --schedule="* 10 * * *" --include-namespaces webserver Schedule "nginx-schedule" created successfully.</code> </pre> <br><p>  Dans ce cas, une sauvegarde sera cr√©√©e chaque jour √† 10 heures et n'inclura que l'espace de noms du serveur Web.  Dans l'interface CLI Heptio Ark, nous voyons qu'un planning est apparu et Heptio Ark a d√©j√† cr√©√© la premi√®re sauvegarde: </p><br><pre> <code class="plaintext hljs">$ ark schedule get NAME STATUS CREATED SCHEDULE BACKUP TTL LAST BACKUP SELECTOR nginx-schedule Enabled 2018-07-08 17:49:00 +0200 CEST * 10 * * * 720h0m0s 25s ago &lt;none&gt; $ ~/Downloads/ark backup get NAME STATUS CREATED EXPIRES SELECTOR nginx-schedule-20180708154900 Completed 2018-07-08 17:49:00 +0200 CEST 29d &lt;none&gt; nginx-simple Completed 2018-07-08 17:35:09 +0200 CEST 29d &lt;none&gt;</code> </pre> <br><p>  Ici, il est indiqu√© que les sauvegardes planifi√©es sont supprim√©es apr√®s 720 heures, c'est-√†-dire apr√®s 30 jours.  Lorsque vous cr√©ez une sauvegarde ou une planification, vous pouvez sp√©cifier la dur√©e de vie de la copie - TTL.  Apr√®s cette p√©riode, la sauvegarde sera supprim√©e du r√©f√©rentiel, dans notre cas AWS. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423559/">https://habr.com/ru/post/fr423559/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423549/index.html">√âv√©nements num√©riques √† Moscou du 17 au 23 septembre</a></li>
<li><a href="../fr423551/index.html">R√©sum√© de la conf√©rence TREND</a></li>
<li><a href="../fr423553/index.html">Nouveau au printemps 5. Migration du projet vers le printemps 5</a></li>
<li><a href="../fr423555/index.html">√Ä propos de la motivation avec le pr√©fixe "Super"</a></li>
<li><a href="../fr423557/index.html">B√©b√©, internet et parents. Comment √©viter les pi√®ges, b√©n√©ficier et rester amis?</a></li>
<li><a href="../fr423563/index.html">VPS.today - catalogue de serveurs virtuels</a></li>
<li><a href="../fr423565/index.html">Manette de jeu de Sega Mega Drive et Raspberry Pi Part 1 (pr√©paratoire et √† trois boutons)</a></li>
<li><a href="../fr423567/index.html">Encore une fois sur l'intelligence artificielle</a></li>
<li><a href="../fr423569/index.html">Nous d√©finissons simplement et pr√©cis√©ment la langue des messages</a></li>
<li><a href="../fr423571/index.html">Toutes sortes de choses dans MetaPost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>