<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñºÔ∏è üï† üëï M√©tadonn√©es S3 dans PostgreSQL. Conf√©rence Yandex ü§ó üßëüèæ‚Äçü§ù‚Äçüßëüèæ ü§∑üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit de la deuxi√®me conf√©rence avec J. Subbotnik sur les bases de donn√©es - la premi√®re que nous avons publi√©e il y a quelques semaines. 

 Le ch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M√©tadonn√©es S3 dans PostgreSQL. Conf√©rence Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/417241/"> Il s'agit de la deuxi√®me conf√©rence avec J. Subbotnik sur les bases de donn√©es - la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re que</a> nous avons publi√©e il y a quelques semaines. <br><br>  Le chef du groupe SGBD √† usage g√©n√©ral Dmitry Sarafannikov a parl√© de l'√©volution de l'entrep√¥t de donn√©es dans Yandex: comment nous avons d√©cid√© de cr√©er une interface compatible S3, pourquoi nous avons choisi PostgreSQL, sur quel type de r√¢teau nous avons march√© et comment y faire face. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HqPYXZDt3VA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - Bonjour √† tous!  Je m'appelle Dima, dans Yandex je fais des bases de donn√©es. <a name="habracut"></a>  Je vais vous dire comment nous avons fait S3, comment nous en sommes venus √† faire exactement S3 et quel type de stockage √©tait auparavant.  Le premier d'entre eux est Elliptics, il est publi√© en open source, disponible sur GitHub.  Beaucoup l'ont peut-√™tre rencontr√©. <br><img src="https://habrastorage.org/webt/ji/kg/05/jikg05jprfdg32gcrus0iunyha4.jpeg"><br>  Il s'agit essentiellement d'une table de hachage distribu√©e avec une cl√© de 512 bits, r√©sultat de SHA-512.  Il forme un porte-cl√©s qui est divis√© au hasard entre les machines.  Si vous souhaitez y ajouter des machines, les cl√©s sont redistribu√©es, un r√©√©quilibrage se produit.  Ce r√©f√©rentiel a ses propres probl√®mes li√©s notamment au r√©√©quilibrage.  Si vous avez un nombre suffisamment important de cl√©s, alors avec des volumes en constante augmentation, vous devez constamment y vider des voitures, et sur un tr√®s grand nombre de cl√©s, le r√©√©quilibrage peut tout simplement ne pas converger.  C'√©tait un probl√®me assez important. <br><br>  Mais en m√™me temps, ce stockage est id√©al pour les donn√©es plus ou moins statiques, lorsque vous t√©l√©chargez une grande quantit√© de donn√©es uniques, puis que vous y lancez une charge en lecture seule.  Pour de telles d√©cisions, il s'int√®gre parfaitement. <br><br>  Nous allons plus loin.  Les probl√®mes de r√©√©quilibrage √©taient assez graves, donc le stockage suivant est apparu. <br><img src="https://habrastorage.org/webt/s6/p-/0q/s6p-0qu2vq5zqtguekkjpyvljf4.jpeg"><br>  Quelle est son essence?  Ce n'est pas du stockage de valeur-cl√©, c'est du stockage de valeur.  Lorsque vous y t√©l√©chargez un objet ou un fichier, il vous r√©pond avec une cl√©, par laquelle vous pouvez ensuite r√©cup√©rer ce fichier.  Qu'est-ce que √ßa donne?  Th√©oriquement, un acc√®s en √©criture √† cent pour cent, si vous avez de l'espace libre dans le stockage.  Si vous avez une machine √† √©crire, vous √©crivez simplement √† d'autres qui ne sont pas couch√©s sur lesquels il y a de l'espace libre, vous obtenez d'autres cl√©s et r√©cup√©rez calmement vos donn√©es. <br><br>  Ce stockage est tr√®s simple √† mettre √† l'√©chelle, vous pouvez le jeter avec du fer, cela fonctionnera.  C'est tr√®s simple, fiable.  Son seul inconv√©nient: le client ne g√®re pas la cl√©, et tous les clients doivent stocker les cl√©s quelque part, stocker le mappage de leurs cl√©s.  C'est g√™nant pour tout le monde.  En fait, c'est une t√¢che tr√®s similaire pour tous les clients, et chacun la r√©sout √† sa mani√®re dans ses m√©ta-bases, etc. Cela n'est pas pratique.  Mais en m√™me temps, je ne veux pas perdre la fiabilit√© et la simplicit√© de ce stockage, en fait il fonctionne avec la vitesse du r√©seau. <br><br>  Ensuite, nous avons commenc√© √† regarder S3.  Il s'agit d'un stockage cl√©-valeur, le client g√®re la cl√©, l'ensemble du stockage est divis√© en soi-disant compartiments.  Dans chaque compartiment, l'espace cl√© va de moins l'infini √† plus l'infini.  La cl√© est une sorte de cha√Æne de texte.  Et nous nous y sommes install√©s, sur cette option.  Pourquoi S3? <br><br>  Tout est assez simple.  √Ä ce moment, de nombreux clients pr√™ts √† l'emploi pour divers langages de programmation ont d√©j√† √©t√© √©crits, de nombreux outils pr√™ts √† l'emploi pour stocker quelque chose dans S3, par exemple, des sauvegardes de base de donn√©es, ont d√©j√† √©t√© √©crits.  Andrew a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√©</a> de l'un des exemples.  Il existe d√©j√† une API raisonnablement bien pens√©e qui circule sur les clients depuis des ann√©es, et vous n'avez rien √† inventer l√†-bas.  L'API a de nombreuses fonctionnalit√©s pratiques telles que les listes, les t√©l√©chargements en plusieurs parties, etc.  Nous avons donc d√©cid√© de rester dessus. <br><br>  Comment faire S3 √† partir de notre stockage?  Qu'est-ce qui vous vient √† l'esprit?  Puisque les clients eux-m√™mes stockent le mappage des cl√©s, nous prenons simplement, mettons la base de donn√©es √† c√¥t√© d'eux, et nous y stockons le mappage de ces cl√©s.  Lors de la lecture, nous trouverons simplement les cl√©s et le stockage dans notre base de donn√©es, et donnerons au client ce qu'il veut.  Si vous l'esquissez sch√©matiquement, comment se produit le remplissage? <br><img src="https://habrastorage.org/webt/99/kr/9t/99kr9tmubs8skxzhbl-yrxmq4iq.jpeg"><br>  Il y a une certaine entit√©, ici on l'appelle Proxy, le soi-disant backend.  Il accepte le fichier, le t√©l√©charge dans le stockage, obtient la cl√© √† partir de l√† et l'enregistre dans la base de donn√©es. Tout est assez simple. <br><img src="https://habrastorage.org/webt/jx/m3/q8/jxm3q8hbv-qzn7qohrpaqw8cgv8.jpeg"><br>  Comment est le re√ßu?  Le proxy trouve la cl√© n√©cessaire dans la base de donn√©es, va avec la cl√© de stockage, t√©l√©charge l'objet √† partir de l√†, la donne au client.  Tout est simple aussi. <br><img src="https://habrastorage.org/webt/tb/w3/hw/tbw3hwknk1vjapsvw9af7pvquig.jpeg"><br>  Comment est la suppression?  Lors de la suppression directement du stockage, le proxy ne fonctionne pas, car il est difficile de coordonner la base de donn√©es et le stockage, il va donc simplement dans la base de donn√©es, lui dit que cet objet est supprim√©, l√†, l'objet est d√©plac√© vers la file d'attente de suppression, puis en arri√®re-plan un professionnel sp√©cialement form√© le robot prend ces cl√©s, les supprime du stockage et de la base de donn√©es.  Tout ici est √©galement assez simple. <br><br>  Nous avons choisi PostgreSQL comme base de donn√©es pour cette m√©tabase. <br><br>  Vous savez d√©j√† que nous l'aimons beaucoup.  Avec le transfert de Yandex.Mail, nous avons acquis une expertise suffisante dans PostgreSQL, et lorsque diff√©rents services de messagerie ont d√©m√©nag√©, nous avons d√©velopp√© plusieurs mod√®les dits de partage.  L'un d'eux s'est bien comport√© sur la S3 avec de l√©g√®res modifications, mais cela s'est bien pass√©. <br><br>  Quelles sont les options de partage?  Il s'agit d'un grand r√©f√©rentiel. √Ä l'√©chelle de Yandex, vous devez imm√©diatement penser qu'il y aura de nombreux objets, vous devez imm√©diatement r√©fl√©chir √† la fa√ßon de tout partager.  Vous pouvez scinder par hachage au nom de l'objet, c'est le moyen le plus fiable, mais cela ne fonctionnera pas ici, car S3 a, par exemple, des listes qui devraient afficher la liste des cl√©s dans l'ordre tri√©, lorsque vous mettez en cache, tous les triages dispara√Ætront, vous devez supprimer tous les objets afin que la sortie soit conforme √† la sp√©cification API. <br><br>  L'option suivante, vous pouvez partitionner par hachage au nom ou par identifiant du compartiment.  Un compartiment peut vivre dans un fragment de base de donn√©es. <br><br>  Une autre option consiste √† r√©partir les plages cl√©s.  √Ä l'int√©rieur du seau, il y a de l'espace de moins l'infini √† plus l'infini, nous pouvons le diviser en n'importe quel nombre de plages, nous appelons cette plage un morceau, il ne peut vivre que dans un seul √©clat. <br><img src="https://habrastorage.org/webt/yw/d3/vh/ywd3vh23mont7zoqjcw6xmcmrbi.jpeg"><br>  Nous avons choisi la troisi√®me option, le d√©coupage par morceaux, car purement th√©oriquement, il peut y avoir un nombre infini d'objets dans un seau, et il ne rentrera pas b√™tement dans une seule pi√®ce de fer.  Il y aura de gros probl√®mes, nous allons donc couper et organiser les fragments comme nous le souhaitons.  C‚Äôest tout. <br><img src="https://habrastorage.org/webt/yu/l-/cu/yul-cuz5u4eb5w1hrtzfguio9ro.jpeg"><br>  Que s'est-il pass√©?  La base de donn√©es enti√®re se compose de trois composants.  S3 Proxy - un groupe d'h√¥tes, il existe √©galement une base de donn√©es.  PL / Proxy sont sous l'√©quilibreur, les demandes de ce backend volent l√†-bas.  En outre S3Meta, un tel groupe de basses, qui stocke des informations sur les seaux et les morceaux.  Et S3DB, des fragments o√π les objets sont stock√©s, une file d'attente de suppression.  S'il est repr√©sent√© sch√©matiquement, il ressemble √† ceci. <br><img src="https://habrastorage.org/webt/3y/0n/y9/3y0ny9npaewsndqfusttbvlqczk.jpeg"><br>  Une demande arrive √† S3Proxy, elle va √† S3Meta et S3DB et √©met des informations vers le haut. <br><img src="https://habrastorage.org/webt/uw/1s/j1/uw1sj1zph_sjghozg404mmdzhnw.jpeg"><br>  Examinons plus en d√©tail.  S3Proxy, les fonctions qu'il contient sont cr√©√©es dans le langage proc√©dural PLProxy, c'est un tel langage qui vous permet d'ex√©cuter des proc√©dures ou requ√™tes stock√©es √† distance.  Voici √† quoi ressemble le code de la fonction ObjectInfo, essentiellement une demande Get. <br><br>  Le cluster LProxy a l'op√©rateur Cluster, dans ce cas, db_ro.  Qu'est-ce que cela signifie? <br><img src="https://habrastorage.org/webt/59/f8/sp/59f8spslkiczmbu6arwngghstoq.jpeg"><br>  S'il s'agit d'une configuration de fragment de base de donn√©es typique, il existe un ma√Ætre et deux r√©pliques.  Le ma√Ætre entre dans le cluster db_rw, les trois h√¥tes entrent dans db-ro, c'est l√† que vous pouvez envoyer une demande en lecture seule et une demande d'√©criture est envoy√©e √† db_rw.  Le cluster db_rw comprend tous les ma√Ætres de tous les fragments. <br><br>  La prochaine instruction RUN ON, elle prend soit la valeur all, ce qui signifie de s'ex√©cuter sur tous les fragments soit un tableau ou une sorte de fragment.  Dans ce cas, il re√ßoit le r√©sultat de la fonction get_object_shard en entr√©e; c'est le num√©ro du fragment sur lequel se trouve l'objet donn√©. <br><br>  Et cible - qui fonctionne pour appeler le fragment distant.  Il appellera cette fonction et remplacera les arguments qui ont vol√© dans cette fonction. <br><img src="https://habrastorage.org/webt/kw/y3/ib/kwy3ib0cemkqipnlkceiaf_vny8.jpeg"><br>  La fonction get_object_shard est √©galement √©crite en PLProxy, d√©j√† un cluster meta_ro, la requ√™te volera vers le fragment S3Meta, qui renverra cette fonction get_bucket_meta_shard. <br><br>  S3Meta peut √©galement √™tre fragment√©, nous l'avons √©galement pos√©, bien que cela ne soit pas pertinent, mais il existe une opportunit√©.  Et il appellera la fonction get_object_shard sur S3Meta. <br><img src="https://habrastorage.org/webt/cx/t2/am/cxt2amhwudlblfjx2l8vrrzsxce.jpeg"><br>  get_bucket_meta_shard n'est qu'un hachage de texte au nom d'un bucket, nous avons m√©lang√© S3Meta juste par un hachage au nom d'un bucket. <br><img src="https://habrastorage.org/webt/sd/r9/1x/sdr91x352qh8xpccft-yay_ozqq.jpeg"><br>  Consid√©rez S3Meta ce qui s'y passe.  L'information la plus importante qui soit est une table avec des morceaux.  J'ai coup√© un peu certaines informations inutiles, la chose la plus importante qui reste est bucket_id, la cl√© de d√©but, la cl√© de fin et le fragment dans lequel se trouve ce morceau. <br><img src="https://habrastorage.org/webt/-n/74/zv/-n74zv7ncle8hcvuj7-_utprjta.jpeg"><br>  √Ä quoi ressemblerait une requ√™te sur une telle table, qui nous renverrait le morceau dans lequel, par exemple, se trouve l'objet de test?  Comme √ßa.  Moins l'infini sous forme de texte, nous l'avons pr√©sent√© comme une valeur nulle, il y a de tels points subtils que vous devez v√©rifier start_key et end_key pour Null. <br><img src="https://habrastorage.org/webt/ay/1f/cl/ay1fclvy9w-_0xillystohcq8v4.jpeg"><br>  La demande ne semble pas tr√®s bonne et le plan est encore pire.  Comme une des options pour un plan pour une telle demande, BitmapOr.  Et 6 000 os valent un tel plan. <br><img src="https://habrastorage.org/webt/qn/m6/ze/qnm6zelrf6qh2q1gpf4-eaxgzle.jpeg"><br>  Comment peut-il en √™tre autrement?  Il y a une chose merveilleuse dans PostgreSQL comme l'index gist, qui peut indexer le type de plage, la plage est essentiellement ce dont nous avons besoin.  Nous avons fait ce type, la fonction s3.to_keyrange nous renvoie, en fait, la plage.  Nous pouvons v√©rifier avec l'op√©rateur contains, trouver le morceau dans lequel se trouve notre cl√©.  Et pour cela, la contrainte d'exclusion est construite ici, ce qui garantit la non-intersection de ces morceaux.  Nous devons autoriser, de pr√©f√©rence au niveau de la base de donn√©es, une certaine contrainte pour nous assurer que les morceaux ne peuvent pas se croiser, de sorte qu'une seule ligne soit renvoy√©e en r√©ponse √† la demande.  Sinon, ce ne sera pas ce que nous voulions.  Voici √† quoi ressemble le plan d'une telle demande, l'index_scan habituel.  Cette condition s'inscrit compl√®tement dans la condition d'indexation, et un tel plan ne compte que 700 os, 10 fois moins. <br><img src="https://habrastorage.org/webt/fz/ii/el/fziielc9cnipflupcktsoowvmle.jpeg"><br>  Qu'est-ce que la contrainte d'exclusion? <br><img src="https://habrastorage.org/webt/f8/zc/ai/f8zcaicub3p9ob_7n2fkcefww3k.jpeg"><br>  Cr√©ons une table de test avec deux colonnes, et y ajoutons deux contraintes, une unique que tout le monde conna√Æt, et une exclure la contrainte, qui a des param√®tres √©gaux, de tels op√©rateurs.  Mettons-le avec deux op√©rateurs √©gaux, une telle plaque a √©t√© construite. <br><img src="https://habrastorage.org/webt/2o/gb/jx/2ogbjxuanf1sfqxvsaz2nm81a9o.jpeg"><br>  Ensuite, nous essayons d'ins√©rer deux lignes identiques, nous obtenons l'erreur de violation de l'unicit√© de la cl√© sur la premi√®re contrainte.  Si nous l'abandonnons, nous avons d√©j√† viol√© la contrainte d'exclusion.  Il s'agit d'un cas courant de contrainte unique. <br><img src="https://habrastorage.org/webt/rf/jo/5c/rfjo5cabxypgt7ox6nfrptpccgc.jpeg"><br>  En fait, une contrainte unique est la m√™me contrainte d'exclusion avec les op√©rateurs √©gaux, mais dans le cas d'une contrainte d'exclusion, vous pouvez cr√©er des cas plus g√©n√©raux. <br><img src="https://habrastorage.org/webt/t4/r5/pw/t4r5pw1rosp_z4hdf72djmkddfy.jpeg"><br>  Nous avons de tels indices.  Si vous regardez de pr√®s, vous verrez que ce sont les deux index et, en g√©n√©ral, ils sont les m√™mes.  Vous vous demandez probablement pourquoi dupliquer cette entreprise.  Je vais te le dire. <br><img src="https://habrastorage.org/webt/lj/rr/tp/ljrrtplgolj6ipalh4quhrpbqq8.jpeg"><br>  Les index sont une telle chose, en particulier l'index gist, que la table vit sa propre vie, les mises √† jour se produisent, sont divis√©es, et ainsi de suite, l'index va mal l√†-bas, il cesse d'√™tre optimal.  Et il existe une telle pratique, en particulier l'extension pg repack, les index sont reconstruits p√©riodiquement, de temps en temps ils sont reconstruits. <br><br>  Comment reconstruire un index sous une contrainte unique?  Cr√©er cr√©er un index actuellement, cr√©er le m√™me index calmement √† c√¥t√© sans le verrouiller, puis l'expression alter table de la contrainte user_index est telle ou telle.  Et tout, tout est clair et bon ici, √ßa marche. <br><br>  Dans le cas de la contrainte d'exclusion, vous ne pouvez la reconstruire que par le verrouillage de r√©indexation, plus pr√©cis√©ment, votre index sera exclusivement bloqu√©, et en fait il vous restera toutes les requ√™tes.  C'est inacceptable, l'index gist peut √™tre construit assez longtemps.  Par cons√©quent, nous gardons √† c√¥t√© du deuxi√®me index, qui est plus petit en volume, prend moins de place, le planeur l'utilise et nous pouvons reconstruire cet index de mani√®re comp√©titive sans le bloquer. <br><img src="https://habrastorage.org/webt/4t/5i/j_/4t5ij__ami8qcaik9hwlvyku4sk.jpeg"><br>  Voici un graphique de la consommation du processeur.  La ligne verte repr√©sente la consommation du processeur dans user_space, elle passe de 50% √† 60%.  √Ä ce stade, la consommation baisse fortement, c'est le moment o√π l'indice est reconstruit.  Nous avons reconstruit l'index, supprim√© l'ancien, la consommation de notre processeur a fortement chut√©.  Il s'agit d'un probl√®me d'index essentiel, et c'est un bon exemple de la fa√ßon dont cela peut √™tre. <br><br>  Lorsque nous avons fait tout cela, nous avons commenc√© sur la version 9.5 S3DB, selon le plan, nous avions pr√©vu d'empiler 10 milliards d'objets dans chaque fragment.  Comme vous le savez, plus d'un milliard et m√™me des probl√®mes ant√©rieurs commencent lorsqu'une table a plusieurs lignes, tout devient bien pire.  Il y a une pratique de s√©paration.  √Ä cette √©poque, il y avait deux options, soit standard par h√©ritage, mais cela ne fonctionne pas tr√®s bien, car il existe une vitesse de s√©lection de partition lin√©aire.  Et √† en juger par le nombre d'objets, nous avons besoin de beaucoup de partitions.  Les gars de Postgres Pro ont ensuite sci√© activement l'extension pg_pathman. <br><img src="https://habrastorage.org/webt/hs/vp/ex/hsvpexzv7ox6fs7ajmyctotqlcw.jpeg"><br>  Nous avons choisi pg_pathman, nous n'avions pas d'autre choix.  M√™me version 1.4.  Et comme vous pouvez le voir, nous utilisons 256 partitions.  Nous avons divis√© la table enti√®re des objets en 256 partitions. <br><br>  Que fait pg_pathman?  √Ä l'aide de cette expression, vous pouvez cr√©er 256 partitions partitionn√©es par hachage √† partir de la colonne d'ench√®res. <br><img src="https://habrastorage.org/webt/5k/5h/x7/5k5hx738e1mzf4f2jcimr7snb9g.jpeg"><br>  Comment fonctionne pg_pathman? <br><img src="https://habrastorage.org/webt/e7/_b/c2/e7_bc24xsopwt5pvme1xw27lhj4.jpeg"><br>  Il enregistre ses crochets dans le planeur, et plus loin sur les demandes il remplace, en substance, le plan.  Nous voyons qu'il n'a pas recherch√© 256 partitions pour une requ√™te de recherche r√©guli√®re d'un objet avec le test de nom, mais a imm√©diatement d√©termin√© qu'il √©tait n√©cessaire de monter dans la table objects_54, mais tout ne se passait pas bien ici, pg_pathman a ses propres probl√®mes.  Tout d'abord, il y avait pas mal de bugs au d√©but, pendant qu'il sciait, mais gr√¢ce aux gars de Postgres Pro, ils les ont rapidement corrig√©s et corrig√©s. <br><br>  Le premier probl√®me est la difficult√© de le mettre √† jour.  Le deuxi√®me probl√®me concerne les d√©clarations pr√©par√©es. <br><br>  Examinons plus en d√©tail.  En particulier, la mise √† jour.  En quoi consiste pg_pathman? <br><img src="https://habrastorage.org/webt/zj/fp/on/zjfpond4kxp6jbx23zuuls_xxmc.jpeg"><br>  Il se compose essentiellement de code C, qui est empaquet√© dans une biblioth√®que.  Et il se compose d'une partie SQL, de toutes sortes de fonctions pour cr√©er des partitions, etc.  De plus, les interfaces avec les fonctions qui sont dans la biblioth√®que.  Ces deux parties ne peuvent pas √™tre mises √† jour en m√™me temps. <br><br>  De l√† surgissent des difficult√©s, quelque chose comme cet algorithme pour mettre √† jour la version de pg_pathman, nous roulons d'abord un nouveau paquet avec une nouvelle version, mais PostgreSQL a des anciennes versions charg√©es en m√©moire, il l'utilise.  C'est imm√©diatement dans tous les cas, la base doit √™tre red√©marr√©e. <br><br>  Ensuite, nous appelons la fonction set_enable_parent, elle active la fonction dans la table parent, qui est d√©sactiv√©e par d√©faut.  Ensuite, d√©sactivez pathman, red√©marrez la base de donn√©es, dites ALTER EXTENSION UPDATE, √† ce moment-l√†, tout tombe dans la table parent. <br><br>  Ensuite, activez pathman et ex√©cutez la fonction, qui se trouve dans l'extension, qui transf√®re les objets de la table parent qui les ont attaqu√©s pendant cette courte p√©riode de temps, les transf√®re vers les tables o√π ils doivent se trouver.  Et puis d√©sactivez l'utilisation de la table parent, recherchez-la. <br><img src="https://habrastorage.org/webt/i0/vi/wp/i0viwpliiv3stsq2vhn2xoid9su.jpeg"><br>  Le probl√®me suivant est celui des d√©clarations pr√©par√©es. <br><img src="https://habrastorage.org/webt/7a/kn/3v/7akn3vmg3-owux9ywqyqocpn1e0.jpeg"><br>  Si nous bloquons la m√™me demande ordinaire, recherchez par ench√®re et cl√©, essayez de l'ex√©cuter.  Jouez cinq fois - tout va bien.  Nous r√©alisons le sixi√®me - nous voyons un tel plan.  Et √† cet √©gard, nous voyons les 256 partitions.  Si vous regardez attentivement ces conditions, nous voyons le dollar 1, le dollar 2, c'est le plan dit g√©n√©rique, le plan g√©n√©ral.  Les cinq premi√®res requ√™tes ont √©t√© construites individuellement, des plans individuels ont √©t√© utilis√©s pour ces param√®tres, pg_pathman pourrait d√©terminer imm√©diatement, car le param√®tre est connu √† l'avance, il pourrait imm√©diatement d√©terminer la table o√π aller.  Dans ce cas, il ne peut pas faire cela.  Par cons√©quent, le plan doit avoir les 256 partitions, et lorsque l'ex√©cuteur teste cela, il va et prend un verrou partag√© pour les 256 partitions et les performances d'une telle solution ne sont pas tout de suite.  Il perd tout simplement tous ses avantages, et toute demande se d√©roule de fa√ßon insens√©e. <br><img src="https://habrastorage.org/webt/pg/ny/vr/pgnyvrsmxkaizxhi1ifdazcith8.jpeg"><br>  Comment en sommes-nous sortis?  J'ai d√ª tout envelopper dans les proc√©dures stock√©es en ex√©cution, en SQL dynamique, afin que les instructions pr√©par√©es ne soient pas utilis√©es et que le plan soit construit √† chaque fois.  C‚Äôest comme √ßa que √ßa fonctionne. <br><br>  L'inconv√©nient est que vous devez entasser tout le code dans des structures qui touchent ces tables.  C'est plus difficile √† lire ici. <br><img src="https://habrastorage.org/webt/rh/6i/p9/rh6ip927nxvaryx5lq7uw80kc_w.jpeg"><br>  Comment est la distribution des objets?  Dans chaque fragment S3DB, les compteurs de morceaux sont stock√©s, il y a √©galement des informations sur les morceaux qui se trouvent dans ce fragment et les compteurs sont stock√©s pour eux.  Pour chaque op√©ration de mutation sur un objet - ajout, suppression, modification, r√©√©criture - ces compteurs pour le changement de bloc.  Afin de ne pas mettre √† jour la m√™me ligne lorsque le versement actif se trouve dans ce bloc, nous utilisons une technique assez standard lorsque nous ins√©rons un compteur delta dans une table s√©par√©e, et une fois par minute, un robot sp√©cial passe en revue et agr√®ge tout cela, met √† jour les compteurs au niveau du bloc . <br><img src="https://habrastorage.org/webt/xe/rn/hv/xernhvrnmssloj0y6mngbtwi9zg.jpeg"><br>  De plus, ces compteurs sont livr√©s √† S3Meta avec un certain retard, il y a d√©j√† une image compl√®te du nombre de compteurs dans quel segment, alors vous pouvez regarder la distribution par fragments, combien d'objets se trouvent dans quel fragment, et sur cette base, une d√©cision est prise √† l'endroit o√π se trouve le nouveau fragment.  Lorsque vous cr√©ez un compartiment, par d√©faut, un seul morceau est cr√©√© de moins l'infini √† plus l'infini, selon la distribution actuelle des objets que S3Meta conna√Æt, il tombe dans une sorte de fragment. <br><br>  Lorsque vous versez des donn√©es dans ce compartiment, toutes ces donn√©es sont vers√©es dans ce bloc, lorsqu'une certaine taille est atteinte, un robot sp√©cial vient et partage ce bloc. <br><img src="https://habrastorage.org/webt/6g/9x/jx/6g9xjxmouaqfyz9-lt-d-qnl-fy.jpeg"><br>  Nous faisons de petits morceaux.  Nous faisons cela de sorte que dans ce cas, ce petit morceau puisse √™tre gliss√© dans un autre fragment.  Comment se produit une s√©paration de morceaux?  Voici un robot r√©gulier, il va et divise ce morceau dans S3DB avec une validation en deux phases et met √† jour les informations dans S3Meta. <br><img src="https://habrastorage.org/webt/9p/ec/pg/9pecpg4ivr6x4fbtp4dwgv6rhie.jpeg"><br>  Le transfert de morceaux est une op√©ration l√©g√®rement plus compliqu√©e; il s'agit d'un commit en deux phases sur trois bases, S3Meta et deux fragments, S3DB, glisse de l'une √† l'autre. <br><img src="https://habrastorage.org/webt/re/1o/so/re1osogppbljsj7camywvynnjg4.jpeg"><br>  S3 a une fonctionnalit√© telle que les listes, c'est la chose la plus difficile, et elle a √©galement pos√© des probl√®mes.  En fait, les listes, vous dites S3 - montrez-moi les objets que j'ai.  Le param√®tre surlign√© en rouge est d√©sormais Null.  Ce param√®tre, d√©limiteur, s√©parateur, vous permet de sp√©cifier les listes avec quel s√©parateur vous souhaitez. <br><img src="https://habrastorage.org/webt/ws/pg/ld/wspgldab_p7mtvwl1p-2rahx48s.jpeg"><br>  Qu'est-ce que cela signifie?  Si le d√©limiteur n'est pas d√©fini, on voit que l'on nous donne simplement une liste de fichiers.  Si nous d√©finissons le d√©lim√®tre, S3 devrait essentiellement nous montrer les dossiers.  Je dois comprendre qu'il existe de tels dossiers, et en fait, il affiche tous les dossiers et fichiers du dossier actuel.  Le dossier actuel est pr√©fix√©, ce param√®tre est Null.  On voit qu'il y a 10 dossiers. <br><br>  Toutes les cl√©s ne sont pas stock√©es dans une sorte d'arborescence hi√©rarchique, comme dans le syst√®me de fichiers.  Chaque objet est stock√© sous forme de cha√Æne et ils ont un simple pr√©fixe commun.  S3 doit lui-m√™me comprendre qu'il s'agit d'un cul. <br><img src="https://habrastorage.org/webt/pi/3p/dq/pi3pdqgonztctekxsrwxg_go5ra.jpeg"><br>  Une telle logique n'est pas suffisante pour le SQL d√©claratif; il est assez facile de le d√©crire avec du code imp√©ratif.      ,     PL/pgSQL.       ,   repeatable read.      ,      . ,  -     - ,    . <br><br>        Recursive CTE,       ,   -  ,       execute  PL/pgSQL.   ,      .  , ,  ,    list objects. ,     . <br><img src="https://habrastorage.org/webt/bn/ng/t5/bnngt5vw2so41bmailmlzscffom.jpeg"><br>   ,    . <br><br>      .       ,         . <br><img src="https://habrastorage.org/webt/df/am/2x/dfam2xo8k6ohr6gkv9mo1d5pmsa.jpeg"><br>     Docker,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Behave</a>   Behave   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  .  ,   , ,    . <br><br>      .   ,    ,   CPU  S3Meta. Gist index    CPU,         , . CPU  S3Meta   .   ,      .       PLProxy  ,        S3Meta  S3DB.  ,      .          S3Meta   .  ,    . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la r√©plication logique, il y a un certain nombre de probl√®mes que nous allons r√©soudre, nous allons essayer de le pousser en amont. </font><font style="vertical-align: inherit;">La deuxi√®me option - vous pouvez refuser l'histogramme, essayez de mettre cette plage de texte dans btree. </font><font style="vertical-align: inherit;">Ce n'est pas un type unidimensionnel, et btree ne fonctionne qu'avec des types unidimensionnels. </font><font style="vertical-align: inherit;">Mais la condition que les morceaux ne se chevauchent pas avec nous nous permettra de mettre notre cas en btree. </font><font style="vertical-align: inherit;">Pas plus tard qu'hier, nous avons cr√©√© un prototype qui fonctionne. </font><font style="vertical-align: inherit;">Il est impl√©ment√© sur les fonctions PL / pgSQL. </font><font style="vertical-align: inherit;">Nous avons obtenu une acc√©l√©ration notable, nous allons optimiser dans cette direction.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417241/">https://habr.com/ru/post/fr417241/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417231/index.html">Merch d'entreprise avec interface utilisateur humaine</a></li>
<li><a href="../fr417233/index.html">Code Google en 2017</a></li>
<li><a href="../fr417235/index.html">Comment les magasins en ligne perdent de l'argent en raison d'une adresse de bon de commande</a></li>
<li><a href="../fr417237/index.html">Ce que les d√©veloppeurs √©coutent: des classiques aux bandes sonores de jeux - nous discutons de tous les plus int√©ressants</a></li>
<li><a href="../fr417239/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 261 (9 juillet - 15 juillet)</a></li>
<li><a href="../fr417243/index.html">Installer 3CX SBC Session Edge Controller sur Windows, Raspberry Pi ou Debian 9</a></li>
<li><a href="../fr417245/index.html">Erlang pour l'IoT</a></li>
<li><a href="../fr417247/index.html">VSCE # 1: Podcast des entrepreneurs m√©diatiques</a></li>
<li><a href="../fr417249/index.html">La US Audit Chamber pr√©vient: SpaceX et Boeing attendent de nouveaux retards, une interruption des vols am√©ricains vers l'ISS est possible</a></li>
<li><a href="../fr417251/index.html">Utilisation de l'oeil de poisson sur Raspberry Pi 3 avec ROS - Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>