<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç± üìä üç£ Cr√©ez votre propre contr√¥leur de jeu üñ±Ô∏è üõÅ üê¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Source d'inspiration 
 Lors d'expositions de jeux, les d√©veloppeurs d' Objects in Space ont montr√© une d√©monstration de leur jeu avec un contr√¥leur su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ez votre propre contr√¥leur de jeu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442816/"><h2>  Source d'inspiration </h2><br>  Lors d'expositions de jeux, les d√©veloppeurs d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Objects in Space</a> ont montr√© une d√©monstration de leur jeu avec un contr√¥leur sur le cockpit d'un √©norme vaisseau spatial.  Il a √©t√© compl√©t√© par des boutons lumineux, des appareils analogiques, des voyants d'√©tat, des interrupteurs, etc ... Cela affecte grandement l'immersion dans le jeu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e96/44d/1ad/e9644d1ad417a9a97f888feea64d0e8a.jpg"></div><br>  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">didacticiel Arduino a √©t√©</a> publi√© sur le site Web du jeu avec une description du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">protocole de communication</a> pour ces contr√¥leurs. <br><br>  <strong>Je veux cr√©er la m√™me chose pour mon jeu</strong> <br><br>  Dans cet exemple, je d√©penserai environ 40 $ pour ajouter de beaux, gros et lourds commutateurs au cockpit d'un simulateur de course.  Les principaux co√ªts sont associ√©s √† ces commutateurs - si j'utilisais de simples commutateurs / boutons, le prix serait deux fois moins √©lev√©!  Il s'agit d'un v√©ritable √©quipement qui peut supporter 240 watts de puissance, et je n'en laisserai sortir que 0,03 watts environ. <br><br>  Avertissement: j'ai d√©cid√© d'√©conomiser de l'argent, je laisse donc un lien vers un site chinois bon march√© o√π j'ach√®te un tas de composants / outils diff√©rents.  L'un des inconv√©nients de l'achat de composants bon march√© est qu'ils n'ont souvent pas de documentation, donc dans cet article, je vais r√©soudre ce probl√®me. <br><a name="habracut"></a><br><h2>  Composants principaux </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Arduino Mega2560</a> - 9 $ <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Panneau de course du commutateur d'allumage</a> - 26 $ <br></li><li>  Un tas de fils de connexion ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">"m√¢le √† m√¢le"</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">"m√¢le √† femelle"</a> , etc ...) - 2 $ </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5c/e18/fb6/f5ce18fb6e69f6d2dd322d5295a8c7db.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c43/2d0/b89/c432d0b89b271194d7e3c72a96f4a458.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/454/485/de1/454485de13be106ba6733352efa8c249.jpg"></div><br><h2>  Outils en vedette </h2><br><ul><li>  Fer √† souder ( <em>cela vaut la peine d'en choisir un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon</a> , mais c'est aussi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon march√© pour</a> faire face au travail</em> ) </li><li>  Soudure ( <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec colophane 60/40</a> - il est facile de travailler avec, bien qu'il soit nocif pour l'environnement</em> .) <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tubes thermor√©tractables</a> ( <em>et s√®che-cheveux industriels, s√®che-cheveux ou briquet</em> ) ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ruban √©lectrique</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pistolet √† colle</a> ( <em>et tiges dessus</em> ), ou une sorte d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©poxy</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Multim√®tre</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pinces / pinces pour d√©nuder les fils</a> , ou simplement des ciseaux, si vous avez besoin d'√©conomiser de l'argent. </li></ul><br><h2>  Logiciels </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Arduino IDE</a> pour programmer le processeur Arduino </li><li>  Pour cr√©er un contr√¥leur qui appara√Æt comme un v√©ritable contr√¥leur / joystick USB mat√©riel: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">FLIP</a> pour flasher le nouveau firmware du contr√¥leur USB Arduino </li><li>  Biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Arduino-USB</a> sur Github </li></ul></li><li>  Pour cr√©er un contr√¥leur avec lequel le jeu communique directement ( <em>ou qui appara√Æt comme un contr√¥leur / joystick USB virtuel</em> ) <ul><li>  Ma biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">ois_protocol</a> sur github <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">Pilote VJoy</a> si vous souhaitez utiliser le contr√¥leur comme contr√¥leur / joystick USB virtuel. </li></ul></li></ul><br><h2>  Avertissement </h2><br>  J'ai √©tudi√© l'√©lectronique au lyc√©e, appris √† utiliser un fer √† souder, appris que les fils rouges doivent √™tre connect√©s au rouge et le noir au noir ... Volts, amp√®res, r√©sistance et les √©quations qui les connectent - c'est tout ce que ma formation formelle en √©lectronique a √©t√© √©puis√©e. <br><br>  Pour moi, c'√©tait un projet de formation, donc √ßa pourrait avoir de mauvais conseils ou des erreurs! <br><br><h1>  Partie 1. Assembler le contr√¥leur! </h1><br><h2>  Nous travaillons avec des commutateurs sans documentation ... </h2><br>  Comme indiqu√© ci-dessus, j'ach√®te des pi√®ces bon march√© chez un d√©taillant √† faible marge, donc la premi√®re chose √† faire est de comprendre comment ces commutateurs / boutons fonctionnent. <br><br><h3>  Bouton-poussoir / interrupteur simple </h3><br>  Avec le bouton, tout est simple - il n'y a pas de LED et seulement deux contacts.  Basculez le multim√®tre en mode continuit√© / num√©rotation ( <img src="https://habrastorage.org/getpro/habr/post_images/628/15d/e9f/62815de9fa4516b533fa2a44197455da.gif">  ) et toucher les sondes des diff√©rents contacts - OL (boucle ouverte, circuit ouvert) s'affichera √† l'√©cran: cela signifie qu'il n'y a pas de connexion entre les deux sondes.  Ensuite, nous appuyons sur le bouton, en touchant toujours les sondes de contact - quelque chose comme 0,1Œ© devrait maintenant √™tre affich√© √† l'√©cran et le multim√®tre √©mettra un bip ( <em>indiquant qu'il y a une tr√®s faible r√©sistance entre les sondes - un circuit ferm√©</em> ). <br><br>  Nous savons maintenant que lorsque le bouton est enfonc√©, le circuit se ferme et lorsqu'il est enfonc√©, il s'ouvre.  Dans le diagramme, cela peut √™tre d√©crit comme un simple interrupteur: <img src="https://habrastorage.org/getpro/habr/post_images/ff1/078/8d9/ff10788d996450509595baba45cad58e.png"><br><br><h2>  Nous connectons le commutateur √† Arduino </h2><br>  Trouvez deux broches sur la carte Arduino: √©tiquet√©es GND et √©tiquet√©es ¬´2¬ª (ou tout autre nombre arbitraire - ce sont des broches d'E / S √† usage g√©n√©ral que nous pouvons contr√¥ler via un logiciel). <br><br>  Si nous connectons le commutateur de cette mani√®re, puis nous ordonnons √† Arduino de configurer la broche 2 en tant que broche INPUT, nous obtenons le circuit illustr√© √† gauche (dans la figure ci-dessous).  Lorsque le bouton est enfonc√©, la broche 2 sera directement connect√©e √† la masse / 0V, et lorsqu'elle est enfonc√©e, la broche 2 ne sera connect√©e √† rien.  Cet √©tat ( <em>non connect√© √† quoi que ce soit</em> ) est appel√© "flottant" (√©tat de haute imp√©dance) et, malheureusement, ce n'est pas un tr√®s bon √©tat pour nos besoins.  Lorsque nous lisons les donn√©es d'un contact dans le logiciel (en <em>utilisant digitalRead (2)</em> ), nous obtenons LOW si le contact est mis √† la terre, et un r√©sultat impr√©visible (LOW ou HIGH) si le contact flotte! <br><br>  Pour r√©soudre ce probl√®me, nous pouvons configurer le contact pour qu'il soit en mode INPUT_PULLUP, qui se connecte √† la r√©sistance √† l'int√©rieur du processeur et cr√©e le circuit illustr√© √† droite.  Dans ce circuit, avec l'interrupteur ouvert, la broche 2 a un chemin de + 5V, donc quand elle est lue, le r√©sultat sera toujours √âLEV√â.  Lorsque l'interrupteur est ferm√©, le contact aura toujours un chemin avec une r√©sistance √©lev√©e √† + 5V, ainsi qu'un chemin sans r√©sistance √† la terre / 0V, qui "gagne", donc quand nous lisons le contact, nous obtenons un BAS. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/450/a26/fa9/450a26fa93dae881e4f2aca3f68d52ad.png"></div><br>  Pour les d√©veloppeurs de logiciels, l'ordre peut sembler invers√© - lorsque nous cliquons sur le bouton, nous lisons false / LOW, et lorsqu'ils sont d√©prim√©s, nous lisons true / HIGH. <br><br>  Vous pouvez faire le contraire, mais le processeur n'a que des r√©sistances de pull-up int√©gr√©es et il n'y a pas de r√©sistances de pull-down, nous allons donc nous en tenir √† ce mod√®le. <br><br>  Le programme le plus simple pour Arduino, qui lit l'√©tat du commutateur et informe le PC de son √©tat, ressemble √† celui illustr√© ci-dessous.  Vous pouvez cliquer sur le bouton de t√©l√©chargement dans l'IDE Arduino puis ouvrir le moniteur s√©rie (dans le menu Outils) pour voir les r√©sultats. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); pinMode(<span class="hljs-number"><span class="hljs-number">2</span></span>, INPUT_PULLUP); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = digitalRead(pin); Serial.println( state == HIGH ? <span class="hljs-string"><span class="hljs-string">"Released"</span></span> : <span class="hljs-string"><span class="hljs-string">"Pressed"</span></span> ); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>);<span class="hljs-comment"><span class="hljs-comment">//artifically reduce the loop rate so the output is at a human readable rate... }</span></span></code> </pre> <br><h2>  D'autres commutateurs avec presque aucune documentation ... </h2><br><h3>  Interrupteur LED √† trois broches </h3><br>  Heureusement, sur les interrupteurs principaux de mon panneau, il y a des marques de trois contacts: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43a/9c1/8e7/43a9c18e7e7c13e8ce02744fe8320bb6.jpg"></div><br>  Je ne sais pas trop comment cela fonctionne, nous allons donc remettre le multim√®tre en mode continu et toucher toutes les paires de contacts lorsque l'interrupteur est activ√© et d√©sactiv√© ... cependant, cette fois, le multim√®tre n'√©met aucun bip lorsque nous touchons les sondes [GND] et [+] avec " allumez!  La seule configuration dans laquelle le multim√®tre √©met <em>un</em> bip ( <em>d√©tecte une connexion</em> ) est lorsque le commutateur est sur ¬´on¬ª et que les sondes sont sur [+] et [lampe]. <br><br>  La LED √† l'int√©rieur du commutateur bloque les mesures de continuit√©, donc √† partir des tests ci-dessus, nous pouvons supposer que la LED est connect√©e directement √† la broche [GND], et non aux contacts [+] et [lampe].  Ensuite, nous passerons le multim√®tre en mode de test de diode (symbole <img src="https://habrastorage.org/getpro/habr/post_images/aa4/e65/abe/aa4e65abeb894a55aa7074cbb67543aa.jpg">  ) et v√©rifiez √† nouveau la paire de contacts, mais cette fois la polarit√© est importante ( <em>sonde rouge et noire</em> ).  Maintenant, si nous connectons la sonde rouge √† [lampe] et la noire √† [GND], alors la LED s'allumera et 2.25V sera affich√© sur le multim√®tre.  Il s'agit de la tension continue de la diode ou de la tension minimale requise pour l'allumer.  Quelle que soit la position du commutateur, 2,25 V de [lampe] √† [GND] fait s'allumer la LED.  Si nous connectons la sonde rouge √† [+] et la noire √† [GND], la LED ne s'allumera que lorsque l'interrupteur est activ√©. <br><br>  D'apr√®s ces lectures, nous pouvons supposer que l'int√©rieur de ce commutateur ressemble √† quelque chose comme le diagramme ci-dessous: <br><br><ol><li>  [+] et [lampe] sont court-circuit√©s lorsque l'interrupteur est activ√© / ferm√©. <br></li><li>  Une tension positive de [lampe] √† [GND] allume toujours la LED. <br></li><li>  Une tension positive de [+] √† [GND] n'allume la LED que lorsque l'interrupteur est activ√© / ferm√©. </li></ol><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd6/34a/728/bd634a728856e82e71eecafa5d42d8a4.png"></div><br>  Honn√™tement, nous ne pouvons que deviner la pr√©sence d'une r√©sistance.  La LED <strong>doit</strong> √™tre connect√©e √† la r√©sistance appropri√©e afin de limiter le courant qui lui est fourni, sinon elle s'√©teindra.  Le mien n'a pas br√ªl√© et il semble qu'il fonctionne correctement.  Sur le forum du site Web du vendeur, j'ai trouv√© un article qui parle d'une r√©sistance install√©e prenant en charge jusqu'√† 12 V, ce qui m'a fait gagner du temps pour v√©rifier / calculer une r√©sistance appropri√©e. <br><br><h3>  Nous connectons le commutateur √† Arduino </h3><br>  Le moyen le plus simple consiste √† utiliser le commutateur avec Arduino, en ignorant la broche [lampe]: connectez [GND] au GND dans Arduino et connectez [+] √† l'un des contacts Arduino num√©rot√©s, par exemple 3. <br><br>  Si nous configurons la broche 3 comme INPUT_PULLUP ( <em>comme pour le bouton pr√©c√©dent</em> ), nous obtiendrons le r√©sultat ci-dessous.  La partie sup√©rieure gauche montre la valeur que nous recevrons en ex√©cutant ¬´digitalRead (3)¬ª dans le code Arduino. <br><br>  Lorsque l'interrupteur est allum√© / ferm√©, nous lisons le BAS et la LED s'allume!  Pour utiliser un tel commutateur dans cette configuration, nous pouvons utiliser le m√™me code Arduino que dans l'exemple de bouton. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd5/cc5/8ba/fd5cc58ba50f376abbd42806718b0f92.png"></div><br><h3>  Probl√®mes de cette solution </h3><br>  Apr√®s la connexion √† l'Arduino, le circuit complet ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/92c/305/f91/92c305f91bf0cf6fac213e2eba1db65e.png"></div><br>  Cependant, ici, nous pouvons voir que lorsque l'interrupteur est ferm√©, en plus de la petite r√©sistance de limitation de courant devant la LED (je suppose que sa r√©sistance est de 100 Ohms), il y a aussi une r√©sistance de rappel de 20 kOhm, ce qui r√©duit encore la quantit√© de courant traversant la LED.  Cela signifie que bien que le circuit fonctionne, la LED ne sera pas tr√®s lumineuse. <br><br>  Un autre inconv√©nient de ce sch√©ma est que nous n'avons pas de contr√¥le logiciel sur la LED - elle est allum√©e lorsque l'interrupteur est allum√© et d√©sactiv√©e dans le cas contraire. <br><br>  Vous pouvez voir ce qui se passe si nous connectons la broche [lampe] √† 0V ou + 5V. <br><br>  Si [la lampe] est connect√©e √† 0V, alors la LED est constamment √©teinte ( <em>quelle que soit la position du commutateur</em> ), et la reconnaissance de position Arduino est toujours effectu√©e.  Cela nous permet de d√©sactiver par programmation la LED! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a55/de7/6d3/a55de76d395358050d3c96139e47df73.png"></div><br>  Si [la lampe] est connect√©e √† + 5V, alors la LED est constamment allum√©e ( <em>quelle que soit la position de l'interrupteur</em> ), <strong>cependant, la</strong> reconnaissance de la position Arduino est cass√©e - HIGH sera toujours lu √† partir du contact. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/310/ea5/4a8/310ea54a861f7f89bc624261abd71ce5.png"></div><br><h3>  Nous connectons correctement ce commutateur √† Arduino </h3><br>  Nous pouvons surmonter les limitations d√©crites ci-dessus ( <em>faible courant / luminosit√© de la LED et le manque de contr√¥le de programme sur la LED</em> ) en √©crivant plus de code!  Pour r√©soudre le conflit entre la capacit√© de contr√¥ler la LED et la reconnaissance de position qui a √©t√© interrompue √† cause de cela, nous pouvons s√©parer les deux t√¢ches √† temps, c'est-√†-dire √©teindre temporairement la LED lors de la lecture du contact du capteur (3). <br><br>  Tout d'abord, connectez la broche [lampe] √† une autre broche Arduino √† usage g√©n√©ral, par exemple √† 4, afin de pouvoir contr√¥ler la lampe. <br><br>  Pour cr√©er un programme qui lira correctement la position de l'interrupteur et contr√¥lera la LED (nous la ferons clignoter), il suffit d'√©teindre la LED avant de lire l'√©tat de l'interrupteur.  La LED s'√©teindra juste une fraction de milliseconde, donc le scintillement ne devrait pas √™tre perceptible: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pinSwitch = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pinLed = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//connect to the PC Serial.begin(9600); //connect our switch's [+] connector to a digital sensor, and to +5V through a large resistor pinMode(pinSwitch, INPUT_PULLUP); //connect our switch's [lamp] connector to 0V or +5V directly pinMode(pinLed, OUTPUT); } void loop() { int lampOn = (millis()&gt;&gt;8)&amp;1;//make a variable that alternates between 0 and 1 over time digitalWrite(pinLed, LOW);//connect our [lamp] to +0V so the read is clean int state = digitalRead(pinSwitch); if( lampOn ) digitalWrite(pinLed, HIGH);//connect our [lamp] to +5V Serial.println(state);//report the switch state to the PC }</span></span></code> </pre> <br>  Dans Arduino Mega, les broches 2-13 et 44-46 peuvent utiliser la fonction analogWrite, qui ne g√©n√®re pas r√©ellement de tension de 0V √† + 5V, mais l'approche en utilisant une onde carr√©e.  Si vous le souhaitez, vous pouvez l'utiliser pour contr√¥ler la luminosit√© de la LED!  Ce code fera pulser la lumi√®re, pas seulement le scintillement: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lampState = (millis()&gt;&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">0xFF</span></span>;<span class="hljs-comment"><span class="hljs-comment">//make a variable that alternates between 0 and 255 over time digitalWrite(pinLed, LOW);//connect our [lamp] to +0V so the read is clean int state = digitalRead(pinSwitch); if( lampState &gt; 0 ) analogWrite(pinLed, lampState); }</span></span></code> </pre> <br><h2>  Conseils d'assemblage </h2><br>  Le message est d√©j√† assez volumineux, donc je n'ajouterai pas le tutoriel sur la soudure, vous pouvez le chercher sur Google! <br><br>  Cependant, je donnerai les conseils les plus √©l√©mentaires: <br><br><ul><li>  Lorsque vous connectez des fils avec de grands contacts m√©talliques, assurez-vous d'abord que le fer √† souder est chaud et chauffez le contact m√©tallique pendant un certain temps.  Le sens de la soudure est de former un joint permanent en cr√©ant un alliage, mais si une seule partie du joint est chaude, vous pouvez facilement obtenir un ¬´joint froid¬ª qui ressemble √† un joint, mais qui n'est pas r√©ellement connect√©. <br></li><li>  Lors de la connexion des deux fils, mettez d' <i>abord</i> sur l'un d'eux un morceau de tube thermor√©tractable - apr√®s la connexion, le tube ne peut pas √™tre mis.  Cela semble √©vident, mais je l'oublie constamment et je dois utiliser du ruban √©lectrique √† la place du tube ... Retirez le tube r√©tractable de la connexion afin qu'il ne chauffe pas √† l'avance.  Apr√®s avoir v√©rifi√© la connexion soud√©e, faites glisser le tube dessus et chauffez-le. <br></li><li>  Les petits fils de connexion minces que j'ai mentionn√©s au d√©but conviennent bien aux connexions sans soudure (par exemple, lorsqu'ils sont connect√©s √† un Arduino!), Mais plut√¥t fragiles.  Apr√®s le soudage, utilisez un pistolet √† colle pour les fixer et √©liminer toutes les contraintes de la connexion elle-m√™me.  Par exemple, les fils rouges dans l'image ci-dessous peuvent √™tre accidentellement tir√©s pendant le fonctionnement, donc apr√®s la soudure, je les ai fix√©s avec une goutte de colle chaude: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0d/fa0/1d4/a0dfa01d48145b489d680cc6e7f43bc8.jpg"></div></li></ul><br><h1>  Partie 2. Nous transformons l'appareil en contr√¥leur de jeu! </h1><br>  Pour que le syst√®me d'exploitation reconnaisse l'appareil en tant que contr√¥leur de jeu USB, vous avez besoin d'un code assez simple, mais, malheureusement, vous devez √©galement remplacer le micrologiciel de la puce USB Arduino par un autre, qui peut √™tre pris ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">https://github.com/harlequin-tech/arduino-usb</a> . <br><br>  Mais apr√®s avoir t√©l√©charg√© ce firmware sur Arduino, l'appareil devient un joystick USB et cesse d'√™tre Arduino.  Par cons√©quent, pour le reprogrammer, vous devez re-flasher le firmware Arduino d'origine.  Ces it√©rations sont assez douloureuses - chargez le code Arduino, flashez le firmware du joystick, testez, flashez le firmware Arduino, r√©p√©tez ... <br><br>  Un exemple de programme pour Arduino pouvant √™tre utilis√© avec ce micrologiciel est illustr√© ci-dessous - il configure les trois boutons en tant qu'entr√©es, lit leurs valeurs, copie les valeurs dans la structure de donn√©es attendue par ce micrologiciel, puis envoie les donn√©es.  Laver, savon, r√©p√©ter. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// define DEBUG if you want to inspect the output in the Serial Monitor // don't define DEBUG if you're ready to use the custom firmware #define DEBUG //Say we've got three buttons, connected to GND and pins 2/3/4 int pinButton1 = 2; int pinButton2 = 3; int pinButton3 = 4; void setup() { //configure our button's pins properly pinMode(pinButton1, INPUT_PULLUP); pinMode(pinButton2, INPUT_PULLUP); pinMode(pinButton3, INPUT_PULLUP); #if defined DEBUG Serial.begin(9600); #else Serial.begin(115200);//The data rate expected by the custom USB firmware delay(200); #endif } //The structure expected by the custom USB firmware #define NUM_BUTTONS 40 #define NUM_AXES 8 // 8 axes, X, Y, Z, etc typedef struct joyReport_t { int16_t axis[NUM_AXES]; uint8_t button[(NUM_BUTTONS+7)/8]; // 8 buttons per byte } joyReport_t; void sendJoyReport(struct joyReport_t *report) { #ifndef DEBUG Serial.write((uint8_t *)report, sizeof(joyReport_t));//send our data to the custom USB firmware #else // dump human readable output for debugging for (uint8_t ind=0; ind&lt;NUM_AXES; ind++) { Serial.print("axis["); Serial.print(ind); Serial.print("]= "); Serial.print(report-&gt;axis[ind]); Serial.print(" "); } Serial.println(); for (uint8_t ind=0; ind&lt;NUM_BUTTONS/8; ind++) { Serial.print("button["); Serial.print(ind); Serial.print("]= "); Serial.print(report-&gt;button[ind], HEX); Serial.print(" "); } Serial.println(); #endif } joyReport_t joyReport = {}; void loop() { //check if our buttons are pressed: bool button1 = LOW == digitalRead( pinButton1 ); bool button2 = LOW == digitalRead( pinButton2 ); bool button3 = LOW == digitalRead( pinButton3 ); //write the data into the structure joyReport.button[0] = (button1?0x01:0) | (button2?0x02:0) | (button3?0x03:0); //send it to the firmware sendJoyReport(joyReport) }</span></span></code> </pre> <br><h1>  Partie 3. Nous int√©grons l'appareil √† notre propre jeu! </h1><br>  Si vous avez le contr√¥le du jeu avec lequel l'appareil doit interagir, vous pouvez √©galement communiquer directement avec le contr√¥leur - il n'est pas n√©cessaire de le rendre visible pour le syst√®me d'exploitation comme un joystick!  Au d√©but de l'article, j'ai mentionn√© les objets dans l'espace;  c'est l'approche utilis√©e par ses d√©veloppeurs.  Ils ont cr√©√© un simple protocole de communication ASCII qui permet au contr√¥leur et au jeu de communiquer entre eux.  √ânum√©rez simplement les ports s√©rie du syst√®me ( <em>ce sont des ports COM sur Windows; au fait, <a href="" rel="external nofollow">regardez √† quel point il a l'air horrible en C</a></em> ), trouvez le port auquel le p√©riph√©rique appel√© ¬´Arduino¬ª est connect√©, et commencez √† lire / √©crire ASCII √† partir de ce lien. <br><br>  Du c√¥t√© Arduino, nous utilisons simplement les fonctions Serial.print qui ont √©t√© utilis√©es dans les exemples ci-dessus. <br><br>  Au d√©but de cet article, j'ai √©galement mentionn√© ma biblioth√®que pour r√©soudre ce probl√®me: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">https://github.com/hodgman/ois_protocol</a> . <br><br>  Il contient du code C ++ qui peut √™tre int√©gr√© dans le jeu et utilis√© comme ¬´serveur¬ª, et du code Arduino qui peut √™tre ex√©cut√© dans le contr√¥leur pour l'utiliser comme ¬´client¬ª. <br><br><h2>  Personnaliser Arduino </h2><br>  Dans <a href="" rel="external nofollow">example_hardware.h,</a> j'ai cr√©√© des classes pour abstraire des boutons / boutons radio individuels;  par exemple, "Switch" est un simple bouton du premier exemple., et "LedSwitch2Pin" est un commutateur avec une LED contr√¥l√©e du deuxi√®me exemple. <br><br>  L'exemple de code pour ma barre de boutons est dans <a href="" rel="external nofollow">example.ino</a> . <br><br>  √Ä titre d'exemple, disons que nous avons un seul bouton qui doit √™tre envoy√© au jeu et une LED contr√¥l√©e par le jeu.  Le code Arduino requis ressemble √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ois_protocol.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//instantiate the library OisState ois; //inputs are values that the game will send to the controller struct { OisNumericInput myLedInput{"Lamp", Number}; } inputs; //outputs are values the controller will send to the game struct { OisNumericOutput myButtonOutput{"Button", Boolean}; } outputs; //commands are named events that the controller will send to the game struct { OisCommand quitCommand{"Quit"}; } commands; int pinButton = 2; int pinLed = 3; void setup() { ois_setup_structs(ois, "My Controller", 1337, 42, commands, inputs, outputs); pinMode(pinButton, INPUT_PULLUP); pinMode(pinLed, OUTPUT); } void loop() { //read our button, send it to the game: bool buttonPressed = LOW == digitalRead(pin); ois_set(ois, outputs.myButtonOutput, buttonPressed); //read the LED value from the game, write it to the LED pin: analogWrite(pinLed, inputs.myLedInput.value); //example command / event: if( millis() &gt; 60 * 1000 )//if 60 seconds has passed, tell the game to quit ois_execute(ois, commands.quitCommand); //run the library code (communicates with the game) ois_loop(ois); }</span></span></span></span></code> </pre> <br><h2>  Personnalisez le jeu </h2><br>  Le code du jeu est √©crit dans le style "en-t√™te unique".  Pour importer la biblioth√®que, incluez <a href="" rel="external nofollow">oisdevice.h</a> dans le jeu. <br><br>  Dans un seul fichier CPP, avant d'ex√©cuter l'en-t√™te #include, √©crivez #define OIS_DEVICE_IMPL et #define OIS_SERIALPORT_IMPL - cela ajoutera le code source des classes au fichier CPP.  Si vous avez vos propres instructions, journaux, cha√Ænes ou vecteurs, il existe plusieurs autres macros OIS_ * que vous pouvez d√©finir avant d'importer l'en-t√™te pour tirer parti des capacit√©s du moteur. <br><br>  Pour r√©pertorier les ports COM et cr√©er une connexion avec un p√©riph√©rique sp√©cifique, vous pouvez utiliser le code suivant: <br><br><pre> <code class="cpp hljs">OIS_PORT_LIST portList; OIS_STRING_BUILDER sb; SerialPort::EnumerateSerialPorts(portList, sb, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = portList.begin(); it != portList.end(); ++it ) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> label = it-&gt;name + <span class="hljs-string"><span class="hljs-string">'('</span></span> + it-&gt;path + <span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-comment"><span class="hljs-comment">/*device selection choice*/</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> gameVersion = <span class="hljs-number"><span class="hljs-number">1</span></span>; OisDevice* device = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OisDevice(it-&gt;id, it-&gt;path, it-&gt;name, gameVersion, <span class="hljs-string"><span class="hljs-string">"Game Title"</span></span>); ... } }</code> </pre> <br>  Apr√®s avoir re√ßu une instance OisDevice, vous devez appeler r√©guli√®rement sa fonction membre Poll (par exemple, dans chaque trame), vous pouvez obtenir l'√©tat actuel de la sortie du contr√¥leur √† l'aide de DeviceOutputs (), utiliser les √©v√©nements de p√©riph√©rique √† l'aide de PopEvents () et envoyer des valeurs au p√©riph√©rique √† l'aide de SetInput (). <br><br>  Un exemple d'application faisant tout cela peut √™tre trouv√© ici: <a href="" rel="external nofollow">example_ois2vjoy / main.cpp</a> . <br><br><h1>  Partie 4. Et si je veux les parties 2 et 3 en m√™me temps? </h1><br>  Pour que le contr√¥leur fonctionne dans d'autres jeux (partie 2), vous devez installer votre propre firmware et un programme Arduino, mais pour que le contr√¥leur soit enti√®rement programm√© par le jeu, nous avons utilis√© le firmware Arduino standard et un autre programme Arduino.  Mais que se passe-t-il si nous voulons avoir les deux possibilit√©s en m√™me temps? <br><br>  L'exemple d'application auquel j'ai donn√© le lien ci-dessus ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">ois2vjoy</a> ) r√©sout ce probl√®me. <br><br>  Cette application communique avec le p√©riph√©rique OIS (le programme de la partie 3), puis sur le PC convertit ces donn√©es en donn√©es r√©guli√®res de contr√¥leur / joystick, qui sont ensuite transf√©r√©es vers le contr√¥leur <em>virtuel</em> / p√©riph√©rique de joystick.  Cela signifie que vous pouvez autoriser votre contr√¥leur √† utiliser en permanence la biblioth√®que OIS (aucun autre micrologiciel n'est requis), et si nous voulons l'utiliser comme un contr√¥leur / joystick normal, il suffit d'ex√©cuter l'application ois2vjoy sur le PC, qui effectue la conversion. <br><br><h1>  Partie 5. Ach√®vement </h1><br>  J'esp√®re que quelqu'un a trouv√© cet article utile ou int√©ressant.  Merci d'avoir lu jusqu'au bout! <br><br>  Si vous √™tes curieux, je vous invite √† participer au d√©veloppement de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external nofollow">ois_protocol</a> !  Je pense que ce sera formidable de d√©velopper un protocole unique pour prendre en charge toutes sortes de contr√¥leurs faits maison dans les jeux et encourager les jeux √† prendre directement en charge les contr√¥leurs faits maison! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442816/">https://habr.com/ru/post/fr442816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442806/index.html">Le programme pr√©liminaire DUMP-2019 est pr√™t. Intervenants de Evil Martians, Tinkoff.ru, HTML Academy, SkyEng, 2GIS</a></li>
<li><a href="../fr442808/index.html">Nous vous invitons √† la Droid Party - une r√©union consacr√©e aux probl√®mes pratiques de d√©veloppement d'applications et d'appareils Android</a></li>
<li><a href="../fr442810/index.html">Mythes de la physique populaire, suite: gravit√©</a></li>
<li><a href="../fr442812/index.html">"Je ne vois aucune raison d'utiliser Python pour travailler avec Spark, √† part la paresse"</a></li>
<li><a href="../fr442814/index.html">10 ans se sont √©coul√©s, et personne n'a compris comment utiliser la blockchain. Et l√† encore?</a></li>
<li><a href="../fr442818/index.html">10 erreurs courantes en anglais √©crit et comment y faire face</a></li>
<li><a href="../fr442820/index.html">Coroutines personnalis√©es dans Unity avec pr√©f√©rence et courtisanes</a></li>
<li><a href="../fr442822/index.html">Centre de donn√©es en mer et en orbite: ont-ils une signification pratique?</a></li>
<li><a href="../fr442824/index.html">Bienvenue dans la Silicon Valley</a></li>
<li><a href="../fr442826/index.html">L'ing√©nierie sociale comme dramaturgie, ou ce que le domaine du phishing et le fusil Tchekhov ont en commun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>