<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç± üóÉÔ∏è üë©üèæ‚Äçü§ù‚Äçüë©üèº Evolution de CI dans l'√©quipe de d√©veloppement mobile ü§∞üèª üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø ‚ö°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, la plupart des produits logiciels sont d√©velopp√©s en √©quipes. Les conditions de r√©ussite du d√©veloppement d'une √©quipe peuvent √™tre pr√©se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Evolution de CI dans l'√©quipe de d√©veloppement mobile</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/447608/">  Aujourd'hui, la plupart des produits logiciels sont d√©velopp√©s en √©quipes.  Les conditions de r√©ussite du d√©veloppement d'une √©quipe peuvent √™tre pr√©sent√©es sous la forme d'un sch√©ma simple. <br><br><img src="https://habrastorage.org/webt/wd/yv/we/wdyvwe6jcuq9yygmffhk5-eqnlo.png"><br><br>  Apr√®s avoir √©crit le code, vous devez vous assurer qu'il: <br><br><ol><li>  √áa marche. </li><li>  Cela ne casse rien, y compris le code que vos coll√®gues ont √©crit. </li></ol><br>  Si les deux conditions sont remplies, vous √™tes sur la voie du succ√®s.  Afin de v√©rifier facilement ces conditions et de ne pas fermer une voie rentable, ils ont propos√© une int√©gration continue. <br><br>  CI est un workflow dans lequel vous int√©grez votre code dans le code produit g√©n√©ral aussi souvent que possible.  Et pas seulement int√©grer, mais aussi v√©rifier en permanence que tout fonctionne.  √âtant donn√© que vous devez v√©rifier souvent et souvent, vous devriez penser √† l'automatisation.  Vous pouvez tout v√©rifier sur la traction manuelle, mais cela n'en vaut pas la peine, et c'est pourquoi. <br><a name="habracut"></a><br><ul><li>  <strong>Les gens sont chers</strong> .  Une heure de travail d'un programmeur co√ªte plus cher qu'une heure de travail d'un serveur. </li><li>  <strong>Les gens ont tort</strong> .  Par cons√©quent, des situations peuvent survenir lorsqu'elles ex√©cutent des tests sur la mauvaise branche ou collectent le mauvais commit pour les testeurs. </li><li>  <strong>Les gens sont paresseux</strong> .  P√©riodiquement, lorsque je termine une t√¢che, j'ai la pens√©e: ¬´Mais qu'y a-t-il √† v√©rifier?  J'ai √©crit deux lignes - stopudovo tout fonctionne! ¬ª  Je pense que pour certains d'entre vous, de telles pens√©es me viennent parfois √† l'esprit.  Mais vous devez toujours v√©rifier. </li></ul><br>  Comment Nikola√Ø Nesterov ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">nnesterov</a> ), participant √† tous les changements √©volutifs de l'application Android CI / CD, explique comment l'int√©gration continue a √©t√© introduite et d√©velopp√©e dans l'√©quipe de d√©veloppement mobile Avito, comment ils ont atteint 0 √† 450 assemblages par jour et que les machines de construction collectent 200 heures par jour. . <br><br>  L'histoire est construite sur l'exemple de l'√©quipe Android, mais la plupart des approches s'appliquent √©galement sur iOS. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lz8MNATTUCU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Il √©tait une fois, une personne travaillait dans l'√©quipe Avito Android.  Par d√©finition, il n'avait besoin de rien de l'int√©gration continue: il n'y avait personne avec qui s'int√©grer. <br><br>  Mais l'application a grandi, de plus en plus de nouvelles t√¢ches sont apparues, respectivement, l'√©quipe a grandi.  √Ä un moment donn√©, il √©tait temps d'√©tablir plus formellement le processus d'int√©gration du code.  Il a √©t√© d√©cid√© d'utiliser Git flow. <br><br><img src="https://habrastorage.org/webt/rv/qa/jd/rvqajd0kgcao3w0-vw6lnomjpc8.png"><br><br>  Le concept de flux Git est connu: il existe une branche de d√©veloppement commune dans le projet, et pour chaque nouvelle fonctionnalit√©, les d√©veloppeurs coupent une branche distincte, la valident, la poussent, et lorsqu'ils veulent injecter leur code dans la branche de d√©veloppement, ouvrent la demande de tirage.  Pour partager les connaissances et discuter des approches, nous avons introduit une r√©vision du code, c'est-√†-dire que les coll√®gues doivent v√©rifier et confirmer le code de chacun. <br><br><h2>  Ch√®ques </h2><br>  Regarder le code avec vos yeux est cool, mais pas suffisant.  Par cons√©quent, des contr√¥les automatiques sont introduits. <br><br><ul><li>  Tout d'abord, nous v√©rifions le <strong>montage de l'ARC</strong> . </li><li>  Beaucoup de <strong>tests Junit</strong> . </li><li>  <strong>Nous consid√©rons la couverture du code</strong> , car nous ex√©cutons les tests. </li></ul><br>  Pour comprendre comment ces contr√¥les doivent √™tre ex√©cut√©s, regardons le processus de d√©veloppement dans Avito. <br><br>  Sch√©matiquement, il peut √™tre repr√©sent√© comme suit: <br><br><ul><li>  Le d√©veloppeur √©crit le code sur son ordinateur portable.  Vous pouvez ex√©cuter des v√©rifications d'int√©gration ici - avec un crochet de validation ou simplement ex√©cuter des v√©rifications en arri√®re-plan. </li><li>  Une fois que le d√©veloppeur a ex√©cut√© le code, il ouvre la demande d'extraction.  Pour que son code entre dans la branche develop, vous devez passer par une revue de code et collecter le nombre requis de confirmations.  Vous pouvez activer les v√©rifications et les builds ici: jusqu'√† ce que toutes les builds r√©ussissent, la demande de pull ne peut pas √™tre fusionn√©e. </li><li>  Une fois la demande d'extraction fusionn√©e et le code en cours de d√©veloppement, vous pouvez choisir un moment opportun: par exemple, la nuit, lorsque tous les serveurs sont libres, et effectuez les contr√¥les √† votre guise. </li></ul><br>  Personne n'aimait faire des tests sur son ordinateur portable.  Lorsque le d√©veloppeur a termin√© la fonctionnalit√©, il souhaite la lancer rapidement et ouvrir la demande d'extraction.  Si √† ce moment de longues v√©rifications sont lanc√©es, ce n'est pas seulement tr√®s agr√©able, mais cela ralentit √©galement le d√©veloppement: pendant que l'ordinateur portable v√©rifie quelque chose, il est impossible de travailler normalement dessus. <br><br>  Nous avons vraiment aim√© faire des v√©rifications la nuit, car il y a beaucoup de temps et de serveurs, vous pouvez vous promener.  Mais, malheureusement, lorsque le code de fonctionnalit√© est entr√© en d√©veloppement, le d√©veloppeur a d√©j√† beaucoup moins de motivation pour r√©parer les erreurs trouv√©es par CI.  Je me surprenais p√©riodiquement √† penser quand je regardais dans le rapport du matin sur toutes les erreurs trouv√©es que je les corrigerais un peu plus tard, car maintenant √† Jira se trouve une nouvelle t√¢che cool que je veux juste commencer √† faire. <br><br>  Si les v√©rifications bloquent la demande d'extraction, la motivation est suffisante, car jusqu'√† ce que les versions deviennent vertes, le code ne se d√©veloppe pas, ce qui signifie que la t√¢che ne sera pas termin√©e. <br><br>  En cons√©quence, nous avons choisi cette strat√©gie: la nuit, nous effectuons le maximum de contr√¥les possibles, les plus critiques d'entre eux et, surtout, rapidement, nous ex√©cutons sur une demande de tirage.  Mais nous ne nous arr√™tons pas l√† - nous optimisons simultan√©ment la vitesse de r√©ussite des contr√¥les afin qu'ils passent du mode nuit aux contr√¥les sur demande de traction. <br><br>  √Ä cette √©poque, tous nos assemblages sont all√©s assez rapidement, nous avons donc simplement inclus l'assemblage ARC, les tests Junit et le calcul de la couverture de code avec le bloqueur de demande d'extraction.  Ils l'ont allum√©, y ont r√©fl√©chi et ont abandonn√© la couverture du code parce qu'ils pensaient que nous n'en avions pas besoin. <br><br>  <strong><em>Il nous a fallu deux jours pour terminer la configuration de base du CI (ci-apr√®s, une estimation temporaire est approximative, n√©cessaire pour l'√©chelle).</em></strong> <br><br>  Apr√®s cela, ils ont commenc√© √† r√©fl√©chir davantage - v√©rifions-nous correctement?  Lan√ßons-nous correctement les builds sur demande pull? <br><br>  Nous avons commenc√© la construction sur le dernier commit de la branche avec laquelle la demande de tirage est ouverte.  Mais la v√©rification de cette validation ne peut que montrer que le code que le d√©veloppeur a √©crit fonctionne.  Mais ils ne prouvent pas qu'il n'a rien cass√©.  En fait, vous devez v√©rifier l'√©tat de la branche de d√©veloppement apr√®s que la fonctionnalit√© y a √©t√© inject√©e. <br><br><img src="https://habrastorage.org/webt/g7/sw/gn/g7swgnopkxqajjm-73mz9oxwbng.png"><br><br>  Pour ce faire, nous avons √©crit un simple script bash <strong>premerge.sh:</strong> <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash set -e git fetch origin develop git merge origin/develop</span></span></code> </pre> <br>  Ici, tous les derniers changements de develop sont simplement remont√©s et fusionn√©s dans la branche actuelle.  Nous avons ajout√© le script premerge.sh comme premi√®re √©tape de toutes les g√©n√©rations et avons commenc√© √† v√©rifier exactement ce que nous voulons, √† savoir l' <strong>int√©gration</strong> . <br><br>  <strong><em>Il a fallu trois jours pour localiser le probl√®me, trouver une solution et √©crire ce script.</em></strong> <br><br>  L'application s'est d√©velopp√©e, de plus en plus de t√¢ches sont apparues, l'√©quipe s'est agrandie et premerge.sh a parfois commenc√© √† nous laisser tomber.  En d√©veloppement p√©n√©tr√®rent des changements conflictuels qui bris√®rent l'assembl√©e. <br><br>  Un exemple de la fa√ßon dont cela se produit: <br><br><img src="https://habrastorage.org/webt/xc/dm/e-/xcdme-bg7rwxkmgip5pgh4hlc8u.png"><br><br>  Deux d√©veloppeurs commencent en m√™me temps √† scier les fonctionnalit√©s A et B. Le d√©veloppeur de la fonctionnalit√© A d√©couvre la fonction <code>answer()</code> inutilis√©e dans le projet et, comme un bon √©claireur, la supprime.  Dans le m√™me temps, le d√©veloppeur de la fonctionnalit√© B ajoute un nouvel appel √† cette fonction dans sa branche. <br><br>  Les d√©veloppeurs terminent le travail et en m√™me temps ouvrent la demande de pull.  Les builds d√©marrent, premerge.sh v√©rifie les deux requ√™tes pull pour un nouvel √©tat de d√©veloppement - toutes les v√©rifications sont vertes.  Apr√®s que les fonctionnalit√©s de demande de tirage A sont fusionn√©es, les fonctionnalit√©s de demande de tirage B sont fusionn√©es ... Boom!  D√©velopper des pauses car dans le code de d√©veloppement, il existe un appel √† une fonction inexistante. <br><br><img src="https://habrastorage.org/webt/zk/im/_r/zkim_rji20ahq4fyztlnc-twxwi.png"><br><br>  Lorsqu'il ne va pas se d√©velopper, c'est une <strong>catastrophe locale</strong> .  Toute l'√©quipe ne peut pas collecter et donner quoi que ce soit pour les tests. <br><br>  Il se trouve que j'ai √©t√© le plus souvent impliqu√© dans des t√¢ches d'infrastructure: analyse, r√©seau, bases de donn√©es.  Autrement dit, j'ai √©crit les fonctions et les classes que les autres d√©veloppeurs utilisent.  Pour cette raison, je me suis tr√®s souvent retrouv√© dans de telles situations.  J'ai m√™me eu une telle photo en m√™me temps. <br><br><img src="https://habrastorage.org/webt/xo/vj/6e/xovj6ea0xjjvuoxfgnrrhbskxta.jpeg"><br><br>  Comme cela ne nous convenait pas, nous avons commenc√© √† √©laborer des options sur la fa√ßon de pr√©venir cela. <br><br><h2>  Comment ne pas casser le d√©veloppement </h2><br>  Premi√®re option: <strong>reconstruire toutes les demandes d'extraction lors du d√©veloppement de la mise √† niveau.</strong>  Si, dans notre exemple, une demande d'extraction avec la fonctionnalit√© A commence par se d√©velopper, la demande d'extraction de la fonctionnalit√© B sera reconstruite et, en cons√©quence, les v√©rifications √©choueront en raison d'une erreur de compilation. <br><br>  Pour comprendre combien de temps cela prendra, consid√©rons un exemple avec deux RP.  Nous ouvrons deux PR: deux builds, deux lancements de tests.  Une fois le premier PR vers√© dans le d√©veloppement, le second doit √™tre reconstruit.  Au total, deux lancements de ch√®ques PR n√©cessitent trois PR: 2 + 1 = 3. <br><br>  En principe, c'est normal.  Mais nous avons examin√© les statistiques, et une situation typique dans notre √©quipe √©tait de 10 RP ouverts, puis le nombre de contr√¥les est la somme de la progression: 10 + 9 + ... + 1 = 55. Autrement dit, pour accepter 10 RP, vous devez reconstruire 55 fois.  Et c'est dans une situation id√©ale, lorsque tous les contr√¥les passent la premi√®re fois, lorsque personne n'ouvre une demande d'extraction suppl√©mentaire pendant que ces dix sont en cours de traitement. <br><br>  Imaginez-vous un d√©veloppeur qui doit d'abord avoir le temps d'appuyer sur le bouton ¬´fusionner¬ª, car si cela est fait par un voisin, vous devrez attendre jusqu'√† ce que tous les assemblages recommencent ... Non, cela ne fonctionnera pas, cela ralentira s√©rieusement le d√©veloppement. <br><br>  La deuxi√®me fa√ßon possible: <strong>collecter la demande de tirage apr√®s la r√©vision du code.</strong>  Autrement dit, ouvrez la demande d'extraction, collectez le nombre de mises √† jour n√©cessaires aupr√®s de vos coll√®gues, corrigez ce dont vous avez besoin, puis ex√©cutez les versions.  S'ils r√©ussissent, la pull pull fusionne avec develop.  Dans ce cas, il n'y a pas de red√©marrage suppl√©mentaire, mais le retour ralentit beaucoup.  En tant que d√©veloppeur, lorsque j'ouvre une demande de pull, je veux imm√©diatement voir s'il va le faire.  Par exemple, si un test se bloque, vous devez le corriger rapidement.  Dans le cas d'une construction retard√©e, le feedback ralentit, ce qui signifie tout le d√©veloppement.  Cela ne nous convenait pas non plus. <br><br>  En cons√©quence, il ne restait que la troisi√®me option - faire du <strong>v√©lo</strong> .  Tout notre code, toutes nos sources sont stock√©es dans le r√©f√©rentiel du serveur Bitbucket.  En cons√©quence, nous avons d√ª d√©velopper un plugin pour Bitbucket. <br><br><img src="https://habrastorage.org/webt/kf/ye/yx/kfyeyxalmkommukvjics9uvinn4.png"><br><br>  Ce plugin remplace le m√©canisme de fusion des demandes de tirage.  Le d√©but est standard: PR s'ouvre, tous les assemblages d√©marrent, la r√©vision du code passe.  Mais une fois la r√©vision du code termin√©e et le d√©veloppeur d√©cidant de cliquer sur ¬´fusionner¬ª, le plugin v√©rifie pour voir dans quel √©tat les v√©rifications de d√©veloppement ont √©t√© ex√©cut√©es.  Si, apr√®s les builds, d√©veloppez r√©ussi √† mettre √† jour, le plugin ne vous permettra pas de fusionner une telle requ√™te pull dans la branche principale.  Il red√©marrera simplement les builds par rapport au nouveau d√©veloppement. <br><br><img src="https://habrastorage.org/webt/_v/_s/0z/_v_s0zaf1bjvxn8oiwekagtj37a.png"><br><br>  Dans notre exemple avec des modifications conflictuelles, ces versions √©choueront en raison d'une erreur de compilation.  En cons√©quence, le d√©veloppeur de la fonctionnalit√© B devra corriger le code, red√©marrer les v√©rifications, puis le plugin appliquera automatiquement la demande de pull. <br><br>  Avant d'impl√©menter ce plugin, nous avions en moyenne 2,7 tests par demande de pull.  Avec le plugin, il y a eu 3,6 lancements.  Cela nous convenait. <br><br>  Il est √† noter que ce plugin a un inconv√©nient: il ne red√©marre la build qu'une seule fois.  C'est-√†-dire, de toute fa√ßon, une petite fen√™tre reste √† travers laquelle des changements conflictuels peuvent entrer dans se d√©velopper.  Mais la probabilit√© de cela n'est pas √©lev√©e, et nous avons fait ce compromis entre le nombre de d√©marrages et la probabilit√© d'√©chec.  Pendant deux ans, il n'a tourn√© qu'une seule fois, donc probablement pas en vain. <br><br>  <strong><em>Il nous a fallu deux semaines pour √©crire la premi√®re version du plugin pour Bitbucket.</em></strong> <br><br><h3>  Nouveaux ch√®ques </h3><br>  Pendant ce temps, notre √©quipe a continu√© de cro√Ætre.  De nouveaux ch√®ques ont √©t√© ajout√©s. <br><br>  Nous avons pens√©: pourquoi r√©parer les erreurs si elles peuvent √™tre √©vit√©es?  Et ils ont donc introduit <strong>l'analyse de code statique</strong> .  Nous avons commenc√© avec lint, qui est inclus dans le SDK Android.  Mais √† cette √©poque, il ne savait pas du tout comment travailler avec le code Kotlin, et nous avons d√©j√† 75% de l'application √©crite en Kotlin.  Par cons√©quent, <strong>les v√©rifications</strong> int√©gr√©es d' <strong>Android Studio</strong> ont √©t√© ajout√©es aux peluches <strong>.</strong> <br><br>  Pour ce faire, je devais √™tre tr√®s pervers: prendre Android Studio, l'emballer dans Docker et l'ex√©cuter sur CI avec un moniteur virtuel pour qu'il pense qu'il fonctionnait sur un vrai ordinateur portable.  Mais √ßa a march√©. <br><br>  Toujours √† cette √©poque, nous avons commenc√© √† √©crire de nombreux <strong>tests d'instrumentation</strong> et √† mettre en ≈ìuvre des <strong>tests de capture d'√©cran</strong> .  C'est quand une capture d'√©cran de r√©f√©rence est g√©n√©r√©e pour une petite vue s√©par√©e, et le test est qu'une capture d'√©cran est prise de la vue et compar√©e directement avec la r√©f√©rence pixel par pixel.  S'il y a un √©cart, cela signifie qu'une mise en page est partie quelque part ou que quelque chose ne va pas dans les styles. <br><br>  Mais les tests d'instrumentation et les tests de capture d'√©cran doivent √™tre ex√©cut√©s sur des appareils: sur des √©mulateurs ou sur des appareils r√©els.  √âtant donn√© qu'il existe de nombreux tests et qu'ils poursuivent souvent, vous avez besoin d'une ferme enti√®re.  Pour d√©marrer votre propre ferme est trop laborieux, nous avons donc trouv√© une option pr√™te √† l'emploi - Firebase Test Lab. <br><br><h3>  Laboratoire de test Firebase </h3><br>  Il a √©t√© choisi parce que Firebase est un produit Google, c'est-√†-dire qu'il doit √™tre fiable et ne mourra probablement jamais.  Les prix sont abordables: 5 $ de l'heure pour un vrai appareil, 1 $ de l'heure pour un √©mulateur. <br><br>  <strong><em>Il a fallu environ trois semaines pour mettre en ≈ìuvre le Firebase Test Lab dans notre CI.</em></strong> <br><br>  Mais l'√©quipe a continu√© de grandir et Firebase, malheureusement, a commenc√© √† nous laisser tomber.  A cette √©poque, il n'avait pas de SLA.  Parfois, Firebase nous faisait attendre que le nombre requis d'appareils pour les tests devienne gratuit et ne commen√ßait pas √† les ex√©cuter tout de suite, comme nous le voulions.  L'attente en ligne a pris jusqu'√† une demi-heure, et c'est tr√®s long.  Les tests d'instrumentation ont fonctionn√© √† chaque PR, les retards ont beaucoup ralenti le d√©veloppement, puis une facture mensuelle est venue avec un montant rond.  En g√©n√©ral, il a √©t√© d√©cid√© d'abandonner Firebase et de voir en interne, puisque l'√©quipe s'est suffisamment d√©velopp√©e. <br><br><h3>  Docker + python + bash </h3><br>  Nous avons pris docker, rempli d'√©mulateurs, √©crit un programme Python simple qui, au bon moment, augmente le bon nombre d'√©mulateurs dans la bonne version et les arr√™te lorsque cela est n√©cessaire.  Et, bien s√ªr, quelques scripts bash - o√π sans eux? <br><br>  <strong><em>Il a fallu cinq semaines pour cr√©er notre propre environnement de test.</em></strong> <br><br>  Par cons√©quent, chaque demande d'extraction comportait une liste de v√©rifications de fusion compl√®te et bloquante: <br><br><ul><li>  Assembl√©e de l'ARC; </li><li>  Tests Junit </li><li>  Lint; </li><li>  Ch√®ques Android Studio; </li><li>  Tests d'instrumentation; </li><li>  Tests de capture d'√©cran. </li></ul><br>  Cela a emp√™ch√© de nombreuses pannes possibles.  Techniquement, tout a fonctionn√©, mais les d√©veloppeurs se sont plaints que l'attente des r√©sultats √©tait trop longue. <br><br>  Trop longtemps, c'est combien?  Nous avons t√©l√©charg√© les donn√©es de Bitbucket et TeamCity vers le syst√®me d'analyse et nous avons r√©alis√© que le <strong>temps d'attente moyen √©tait de 45 minutes</strong> .  Autrement dit, un d√©veloppeur, ouvrant une demande d'extraction, s'attend en moyenne √† des r√©sultats de construction de 45 minutes.  √Ä mon avis, c'est beaucoup et vous ne pouvez pas travailler comme √ßa. <br><br>  Bien s√ªr, nous avons d√©cid√© d'acc√©l√©rer toutes nos versions. <br><br><h2>  Acc√©l√©rez </h2><br>  √âtant donn√© que les versions sont souvent align√©es, la premi√®re chose que nous avons <strong>achet√©e est le fer</strong> - un d√©veloppement approfondi est le plus simple.  Les builds ont cess√© de faire la queue, mais le temps d'attente n'a diminu√© que l√©g√®rement, car certains ch√®ques √† eux seuls √©taient en d√©route depuis tr√®s longtemps. <br><br><h3>  Nous supprimons les ch√®ques trop longs </h3><br>  Notre int√©gration continue pourrait d√©tecter ces types d'erreurs et de probl√®mes. <br><br><ul><li>  <strong>Je ne vais pas</strong> .  CI peut d√©tecter une erreur de compilation lorsque, en raison de modifications contradictoires, quelque chose ne va pas.  Comme je l'ai dit, alors personne ne peut rien collecter, le d√©veloppement augmente et tout le monde devient nerveux. </li><li>  <strong>Un bug de comportement</strong> .  Par exemple, lorsque l'application est cr√©√©e, mais lorsque vous cliquez sur le bouton, elle se bloque ou le bouton n'est pas appuy√© du tout.  C'est mauvais car un tel bug peut atteindre l'utilisateur. </li><li>  <strong>Bug dans la mise en page</strong> .  Par exemple, un bouton est enfonc√©, mais d√©plac√© de 10 pixels vers la gauche. </li><li>  <strong>Augmentation de la dette technique</strong> . </li></ul><br>  En regardant cette liste, nous avons r√©alis√© que seuls les deux premiers points sont critiques.  Nous voulons d'abord attraper de tels probl√®mes.  Les bogues dans la mise en page sont d√©tect√©s au stade de la r√©vision de la conception, puis facilement corrig√©s.  Travailler avec la dette technique n√©cessite un processus et une planification distincts, nous avons donc d√©cid√© de ne pas v√©rifier la demande de pull. <br><br>  Sur la base de cette classification, nous avons secou√© toute la liste des ch√®ques.  <strong>Biff√© Lint</strong> et report√© son lancement pour la nuit: juste pour qu'il fasse √©tat du nombre de probl√®mes dans le projet.  Nous avons accept√© de travailler s√©par√©ment avec la dette technique, mais nous avons <strong>compl√®tement refus√© les contr√¥les Android Studio</strong> .  Android Studio de Docker pour lancer des inspections semble int√©ressant, mais il apporte beaucoup de probl√®mes de support.  Toute mise √† jour des versions d'Android Studio est un combat contre les bugs obscurs.  Il √©tait √©galement difficile de maintenir les tests de capture d'√©cran, car la biblioth√®que ne fonctionnait pas de mani√®re tr√®s stable, il y avait des faux positifs.  <strong>Les tests de capture d'√©cran ont √©t√© supprim√©s de la liste des v√©rifications</strong> . <br><br>  En cons√©quence, nous avons laiss√©: <br><br><ul><li>  Assembl√©e de l'ARC; </li><li>  Tests Junit </li><li>  Tests d'instrumentation. </li></ul><br><br><h3>  Cache distant Gradle </h3><br>  Sans de lourds contr√¥les, les choses se sont am√©lior√©es.  Mais il n'y a pas de limite √† la perfection! <br><br>  Notre application a d√©j√† √©t√© divis√©e en environ 150 modules gradle.  Habituellement, dans ce cas, le cache distant Gradle fonctionne bien, et nous avons d√©cid√© de l'essayer. <br><br>  Le cache distant Gradle est un service qui peut mettre en cache des artefacts de construction pour des t√¢ches individuelles dans des modules distincts.  Gradle, au lieu de r√©ellement compiler le code, renverse le cache distant via HTTP et demande si quelqu'un a d√©j√† effectu√© cette t√¢che.  Si oui, t√©l√©chargez simplement le r√©sultat. <br><br>  <strong><em>Le d√©marrage du cache distant Gradle est facile car Gradle fournit une image Docker.</em></strong>  <strong><em>Nous avons r√©ussi √† le faire en trois heures.</em></strong> <br><br>  Il suffisait de lancer Docker et d'enregistrer une ligne dans le projet.  Mais bien que vous puissiez le d√©marrer rapidement pour que tout fonctionne bien, cela prendra beaucoup de temps. <br><br>  Voici un graphique des √©checs de cache. <br><br><img src="https://habrastorage.org/webt/je/0j/an/je0jansmt1nkhgiqhwybnmc2_fs.png"><br><br>  Au tout d√©but, le pourcentage de rat√©s apr√®s le cache √©tait d'environ 65. Trois semaines plus tard, nous avons r√©ussi √† porter cette valeur √† 20%.  Il s'est av√©r√© que les t√¢ches collect√©es par l'application Android ont d'√©tranges d√©pendances transitoires, √† cause desquelles Gradle a rat√© le cache. <br><br>  En connectant le cache, nous avons consid√©rablement acc√©l√©r√© l'assemblage.  Mais en dehors de l'assemblage, les tests d'instrumentation sont toujours √† la poursuite, et ils la poursuivent depuis longtemps.  Peut-√™tre que tous les tests ne doivent pas √™tre poursuivis pour chaque demande d'extraction.  Pour le savoir, nous utilisons l'analyse d'impact. <br><br><h3>  Analyse d'impact </h3><br>  Sur demande pull, nous construisons git diff et trouvons les modules Gradle modifi√©s. <br><br><img src="https://habrastorage.org/webt/yg/xn/ki/ygxnkisjdskb-qkqxoccaywcu5a.png"><br><br>  Il est logique d'ex√©cuter uniquement les tests d'instrumentation qui testent les modules modifi√©s et tous les modules qui en d√©pendent.  Il ne sert √† rien d'ex√©cuter des tests pour les modules voisins: le code n'y a pas chang√© et rien ne peut casser. <br><br>  Les tests d'instrumentation ne sont pas si simples, car ils doivent √™tre situ√©s dans le module d'application de niveau sup√©rieur.  Nous avons appliqu√© une heuristique d'analyse de bytecode pour comprendre √† quel module chaque test appartient. <br><br>  <strong><em>Il a fallu environ huit semaines pour mettre √† niveau les tests d'instrumentation afin de tester uniquement les modules impliqu√©s.</em></strong> <br><br>  Les mesures d'acc√©l√©ration de la v√©rification ont fonctionn√© avec succ√®s.  De 45 minutes, nous avons atteint environ 15. Un quart d'heure pour attendre la construction est d√©j√† normal. <br><br>  Mais maintenant, les d√©veloppeurs ont commenc√© √† se plaindre qu'il ne leur est pas clair quelles versions sont lanc√©es, o√π le journal se penchera, pourquoi la construction est rouge, quel test est tomb√©, etc. <br><br><img height="487" src="https://habrastorage.org/webt/ez/ev/wl/ezevwlalp50tf9bcret2aff7fte.png"><br><br>  Les probl√®mes de feedback ralentissent le d√©veloppement, nous avons donc essay√© de fournir les informations les plus compr√©hensibles et d√©taill√©es sur chaque PR et build.  Nous avons commenc√© par des commentaires sur Bitbucket pour PR, indiquant quelle version est tomb√©e et pourquoi, avons √©crit des messages cibl√©s dans Slack.  En fin de compte, ils ont cr√©√© un tableau de bord pour la page PR avec une liste de toutes les versions en cours d'ex√©cution et leur √©tat: en ligne, d√©marrages, plantages ou fins.  Vous pouvez cliquer sur la construction et acc√©der √† son journal. <br><br><img src="https://habrastorage.org/webt/d5/hu/fr/d5hufrypmfupj3g8k4snhrksy9w.png"><br><br>  <strong><em>Six semaines ont √©t√© consacr√©es √† des commentaires d√©taill√©s.</em></strong> <br><br><h2>  Plans </h2><br>  Nous passons √† la derni√®re histoire.  Apr√®s avoir r√©solu la question du feedback, nous sommes pass√©s √† un nouveau niveau - nous avons d√©cid√© de construire notre propre ferme d'√©mulateurs.  Lorsqu'il existe de nombreux tests et √©mulateurs, ils sont difficiles √† g√©rer.  En cons√©quence, tous nos √©mulateurs sont pass√©s √† un cluster k8s avec une gestion flexible des ressources. <br><br>  De plus, il existe d'autres plans. <br><br><ul><li>  <strong>Retour Lint</strong> (et autres analyses statiques).  Nous travaillons d√©j√† dans ce sens. </li><li>  Ex√©cutez tous les <strong>tests de bout en bout</strong> sur le bloqueur de relations publiques sur toutes les versions du SDK. </li></ul><br>  Nous avons donc retrac√© l'histoire du d√©veloppement de l'int√©gration continue dans Avito.  Maintenant, je veux donner quelques conseils du point de vue de l'exp√©riment√©. <br><br><h1>  Astuces </h1><br>  Si je pouvais donner un seul conseil, ce serait ceci: <br><br><blockquote>  Veuillez faire attention aux scripts shell! </blockquote><br>  Bash est un outil tr√®s flexible et puissant, il est tr√®s pratique et rapide d'y √©crire des scripts.  Mais avec lui, vous pouvez tomber dans le pi√®ge et nous y sommes malheureusement tomb√©s. <br><br>  Tout a commenc√© avec des scripts simples qui s'ex√©cutaient sur nos machines de g√©n√©ration: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash ./gradlew assembleDebug</span></span></code> </pre> <br>  Mais, comme vous le savez, tout se d√©veloppe et se complique avec le temps - ex√©cutons un script √† partir d'un autre, passons-y quelques param√®tres - √† la fin, j'ai d√ª √©crire une fonction qui d√©termine √† quel niveau de bash d'imbrication nous sommes maintenant pour remplacer les guillemets n√©cessaires, pour que tout commence. <br><br><img src="https://habrastorage.org/webt/rt/o6/vp/rto6vp4hs-ucbefd_3pbzehvx0a.png"><br><br>  Vous pouvez imaginer le travail impliqu√© dans le d√©veloppement de tels scripts.  Je vous conseille de ne pas tomber dans ce pi√®ge. <br><br>  Que peut-on remplacer? <br><br><ul><li>  Tout langage de script.  L'√©criture en <strong>Python ou Kotlin Script est</strong> plus pratique car c'est de la programmation, pas des scripts. </li><li>  Ou d√©crivez toute la logique de construction sous la forme de <strong>t√¢ches Gradle personnalis√©es</strong> pour votre projet. </li></ul><br>  Nous avons d√©cid√© de choisir la deuxi√®me option, et maintenant nous supprimons syst√©matiquement tous les scripts bash et √©crivons beaucoup de shuffles gradle personnalis√©s. <br><br>  <strong>Astuce n ¬∞ 2: conservez votre infrastructure dans le code.</strong> <br><br>  Cela est pratique lorsque la configuration d'int√©gration continue n'est pas stock√©e dans l'interface Jenkins ou TeamCity UI, etc., mais sous forme de fichiers texte directement dans le r√©f√©rentiel du projet.  Cela donne la possibilit√© de version.  Il ne sera pas difficile de revenir en arri√®re ou de collecter du code sur une autre branche. <br><br>  Les scripts peuvent √™tre stock√©s dans le projet.  Et que faire de l'environnement? <br><br>  <strong>Conseil n ¬∞ 3: Docker peut vous aider avec l'environnement.</strong> <br><br>  Cela aidera certainement les d√©veloppeurs Android, iOS pas encore, malheureusement. <br><br>  Voici un exemple de fichier docker simple contenant jdk et android-sdk: <br><br><pre> <code class="plaintext hljs">FROM openjdk:8 ENV SDK_URL="https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip" \ ANDROID_HOME="/usr/local/android-sdk" \ ANDROID_VERSION=26 \ ANDROID_BUILD_TOOLS_VERSION=26.0.2 # Download Android SDK RUN mkdir "$ANDROID_HOME" .android \ &amp;&amp; cd "$ANDROID_HOME" \ &amp;&amp; curl -o sdk.zip $SDK_URL \ &amp;&amp; unzip sdk.zip \ &amp;&amp; rm sdk.zip \ &amp;&amp; yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses # Install Android Build Tool and Libraries RUN $ANDROID_HOME/tools/bin/sdkmanager --update RUN $ANDROID_HOME/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS_VERSION}" \ "platforms;android-${ANDROID_VERSION}" \ "platform-tools" RUN mkdir /application WORKDIR /application</code> </pre><br>  Apr√®s avoir √©crit ce fichier docker (je vais vous dire un secret, vous ne pouvez pas l'√©crire, mais le tirer pr√™t de GitHub) et collecter l'image, vous obtenez une machine virtuelle sur laquelle vous pouvez cr√©er l'application et ex√©cuter des tests Junit. <br><br>  Les deux principaux arguments expliquant pourquoi cela a du sens sont l'√©volutivit√© et la r√©p√©tabilit√©.  En utilisant docker, vous pouvez rapidement lever une douzaine d'agents de build qui auront exactement le m√™me environnement que l'ancien.  Cela facilite la vie des ing√©nieurs CI.  Pousser android-sdk dans docker est assez simple, avec des √©mulateurs un peu plus compliqu√©s: vous devez travailler un peu (enfin, ou t√©l√©charger √† nouveau le fichier fini depuis GitHub). <br><br>  <strong>Astuce num√©ro 4: n'oubliez pas que les contr√¥les sont effectu√©s non pas pour le plaisir des ch√®ques, mais pour les personnes.</strong> <br><br>  Un retour rapide et, surtout, clair est tr√®s important pour les d√©veloppeurs: ce qu'ils ont cass√©, quel test est tomb√©, o√π le journal de construction. <br><br>  <strong>Conseil n ¬∞ 5: Soyez pragmatique avec l'int√©gration continue.</strong> <br><br>  Comprenez clairement quels types d'erreurs vous souhaitez √©viter, combien vous √™tes pr√™t √† d√©penser en ressources, en temps, en temps d'ordinateur.  Des contr√¥les trop longs peuvent, par exemple, √™tre reprogramm√©s du jour au lendemain.  Et ceux qui commettent des erreurs peu importantes devraient √™tre compl√®tement abandonn√©s. <br><br>  <strong>Astuce num√©ro 6: utilisez des outils pr√™ts √† l'emploi.</strong> <br><br>  Maintenant, il existe de nombreuses entreprises qui fournissent des CI de cloud. <br><br><img src="https://habrastorage.org/webt/7a/dr/k3/7adrk3z_1xnccybehwal8sfi-pi.png"><br><br>  Pour les petites √©quipes, c'est une bonne issue.  Vous n'avez rien √† entretenir, payez simplement de l'argent, r√©cup√©rez votre application et m√™me effectuez des tests d'instrumentation. <br><br>  <strong>Conseil n ¬∞ 7: dans une grande √©quipe, les solutions internes sont plus rentables.</strong> <br><br>  Mais t√¥t ou tard, avec la croissance de l'√©quipe, les solutions internes deviendront plus rentables.  Il y a un point avec ces d√©cisions.  En √©conomie, il existe une loi des rendements d√©croissants: dans tout projet, chaque am√©lioration ult√©rieure est de plus en plus difficile, n√©cessite de plus en plus d'investissement. <br><br>  L'√©conomie d√©crit toute notre vie, y compris l'int√©gration continue.  J'ai construit un horaire de travail pour chaque √©tape de notre d√©veloppement d'int√©gration continue. <br><br><img src="https://habrastorage.org/webt/es/za/8w/esza8woeimanj5auez2iz9js7di.png"><br><br>  On voit que toute am√©lioration est de plus en plus difficile.  En regardant ce graphique, nous pouvons comprendre que le d√©veloppement de l'int√©gration continue doit √™tre coh√©rent avec la croissance de la taille de l'√©quipe.  Pour une √©quipe de deux personnes, passer 50 jours √† d√©velopper une batterie d'√©mulateurs internes est une id√©e insens√©e.  Mais en m√™me temps, pour une grande √©quipe, ne pas faire du tout d'int√©gration continue est √©galement une mauvaise id√©e, en raison de probl√®mes d'int√©gration, de correction des communications, etc.  cela prendra encore plus de temps. <br><br>  Nous avons commenc√© avec le fait que l'automatisation est n√©cessaire parce que les gens sont chers, ils se trompent et sont paresseux.  Mais les gens automatisent aussi.  Par cons√©quent, tous ces m√™mes probl√®mes s'appliquent √† l'automatisation. <br><br><ul><li>  L'automatisation co√ªte cher.  N'oubliez pas l'horaire de travail. </li><li>  Dans l'automatisation, les gens font des erreurs. </li><li>  L'automatisation est parfois tr√®s paresseuse, car tout fonctionne comme √ßa.  Sinon, pourquoi am√©liorer, pourquoi toute cette int√©gration continue? </li></ul><br>     :  20%   .     ,      .  ,   , ,    - ,     develop,    . ,           ,    -   . <br><br> <strong> Continuous Integration.   .</strong> <br><br><blockquote> ,        ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AppsConf</a>        .            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .     22-23   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447608/">https://habr.com/ru/post/fr447608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447592/index.html">WhatsApp dans la paume de votre main: o√π et comment pouvez-vous d√©tecter les artefacts m√©dico-l√©gaux?</a></li>
<li><a href="../fr447594/index.html">Instruments personnalis√©s: quand le panneau ne suffit pas</a></li>
<li><a href="../fr447598/index.html">√âcrire un jeu de cartes m√©moire sur Swift</a></li>
<li><a href="../fr447604/index.html">Dents lisses, C ++ et math√©matiques - comment sont-ils li√©s? Conversation avec Align</a></li>
<li><a href="../fr447606/index.html">Collecteur de d√©chets CLRium # 5: Peter - √âpuis√©</a></li>
<li><a href="../fr447610/index.html">Comment prendre le contr√¥le de votre infrastructure r√©seau. Chapitre Trois S√©curit√© du r√©seau. Troisi√®me partie</a></li>
<li><a href="../fr447612/index.html">Centre de donn√©es spatiales. Traduction de texte du lancement du serveur dans la stratosph√®re</a></li>
<li><a href="../fr447614/index.html">Vous ne pourrez pas r√©soudre ce probl√®me lors de l'entretien</a></li>
<li><a href="../fr447616/index.html">Connecter Aquastorozh √† Smart Home sur Z-Wave</a></li>
<li><a href="../fr447618/index.html">La base de donn√©es du service de streaming Kanopy a divulgu√© jusqu'√† 40 millions d'entr√©es de journal sur les films visionn√©s par les utilisateurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>