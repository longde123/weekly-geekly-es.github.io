<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ—ï¸ â“ ğŸ’„ EnquÃªte sur une archive inconnue ğŸ–¨ï¸ ğŸ¤· â›²ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DÃ©localisation. Nouvelle ville. Recherche d'emploi. MÃªme pour un professionnel de l'informatique, cela peut prendre beaucoup de temps. Une sÃ©rie d'ent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>EnquÃªte sur une archive inconnue</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450394/">  DÃ©localisation.  Nouvelle ville.  Recherche d'emploi.  MÃªme pour un professionnel de l'informatique, cela peut prendre beaucoup de temps.  Une sÃ©rie d'entretiens qui, en gÃ©nÃ©ral, sont trÃ¨s similaires les uns aux autres.  Et comme cela arrive gÃ©nÃ©ralement lorsque vous avez dÃ©jÃ  trouvÃ© un emploi, aprÃ¨s un certain temps, un bureau intÃ©ressant est annoncÃ©. <br><br>  Il Ã©tait difficile de comprendre ce qu'elle faisait spÃ©cifiquement, cependant, son domaine d'intÃ©rÃªt Ã©tait la recherche sur les logiciels d'autres personnes.  Cela semble intrigant, bien que lorsque vous rÃ©alisez que cela ne semble pas Ãªtre un fournisseur qui publie des logiciels de cybersÃ©curitÃ©, vous vous arrÃªtez une seconde et commencez Ã  gratter vos navets. <br><br><img src="https://lh3.googleusercontent.com/Wm2cSc19nc9XsapzlEW-eGMZBZCEgSbZFCSj6hdNNlkqCa40ksCXrYv8ual-VfYF3rcn5OoM9X2OwIJY07u_dD5Lo_7mzZU4D7rQuu164GIDE2_IjBu_J1dIMsjD4uDgyep3yipN"><br><a name="habracut"></a><br>  En bref: ils ont jetÃ© l'archive et ont proposÃ© de l'examiner en tant que tÃ¢che de test et d'essayer de calculer une certaine signature sur la base des donnÃ©es d'entrÃ©e prÃ©sentÃ©es.  Il convient de noter que j'avais trÃ¨s peu d'expÃ©rience dans de telles activitÃ©s et, probablement, c'est pourquoi lors de la premiÃ¨re itÃ©ration de la solution, je n'avais que quelques heures - alors la motivation pour le faire est tombÃ©e Ã  nÃ©ant.  Et oui, bien sÃ»r, la premiÃ¨re chose que j'ai essayÃ© de l'exÃ©cuter sur le tÃ©lÃ©phone / l'Ã©mulateur - cette application n'est pas valide. <br><br>  <b>Ce que nous avons: une</b> archive avec l'extension <b>".apk"</b> .  J'ai placÃ© la tÃ¢che elle-mÃªme sous le spoiler pour qu'elle ne soit pas indexÃ©e par les moteurs de recherche: que faire si les gars ne l'aiment pas, que je mette la solution sur Habr? <br><br><div class="spoiler">  <b class="spoiler_title">TÃ¢che elle-mÃªme</b> <div class="spoiler_text">  L'APK contient des fonctionnalitÃ©s pour gÃ©nÃ©rer des signatures pour un tableau associatif. <br>  Essayez d'obtenir une signature pour l'ensemble de donnÃ©es suivant: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"LeetD3vM4st3R"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"__s33cr$$tV4lu3__"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"34765983265937875692356935636464"</span></span> }</code> </pre> <br></div></div><br><h2>  Retroussez les manches </h2><br>  On dit que l'archive contient la fonctionnalitÃ© de signature d'un tableau associatif.  Par l'extension de fichier, nous comprenons immÃ©diatement que nous avons affaire Ã  une application Ã©crite pour Android.  Nous dÃ©ballons d'abord l'archive.  En fait, il s'agit d'une archive ZIP rÃ©guliÃ¨re, et tout archiveur y fera face Ã  la lÃ©gÃ¨re.  J'ai utilisÃ© l'utilitaire apktool et, comme il s'est avÃ©rÃ©, j'ai accidentellement contournÃ© quelques rÃ¢teaux.  Oui, cela arrive (gÃ©nÃ©ralement le contraire, oui?).  Le sort est assez simple: <br><br><pre> <code class="bash hljs">apktool d task.zip</code> </pre> <br>  Il s'avÃ¨re que le code et les ressources dans le fichier apk sont Ã©galement stockÃ©s dans des fichiers binaires sÃ©parÃ©s, et d'autres logiciels seront nÃ©cessaires pour les extraire.  apktool a implicitement extrait les octets de classe, les ressources et les a dÃ©composÃ©s dans une hiÃ©rarchie de fichiers naturelle.  Vous pouvez continuer. <br><br><pre> <code class="bash hljs">â”œâ”€â”€ AndroidManifest.xml â”œâ”€â”€ apktool.yml â”œâ”€â”€ lib â”‚   â””â”€â”€ arm64-v8a â”œâ”€â”€ original â”‚   â”œâ”€â”€ AndroidManifest.xml â”‚   â””â”€â”€ META-INF â”œâ”€â”€ res â”‚   â”œâ”€â”€ anim â”‚   â”œâ”€â”€ color â”‚   â”œâ”€â”€ drawable â”‚   â”œâ”€â”€ layout â”‚   â”œâ”€â”€ layout-watch-v20 â”‚   â”œâ”€â”€ mipmap-anydpi-v26 â”‚   â”œâ”€â”€ values â”‚   â””â”€â”€ values-af â”œâ”€â”€ smali â”‚   â”œâ”€â”€ android â”‚   â”œâ”€â”€ butterknife â”‚   â”œâ”€â”€ com â”‚   â”œâ”€â”€ net â”‚   â””â”€â”€ org â””â”€â”€ unknown   â””â”€â”€ org</code> </pre> <br>  Nous voyons une hiÃ©rarchie similaire (Ã  gauche sa version simplifiÃ©e) et essayons de comprendre par oÃ¹ commencer.  Il convient de noter que j'ai nÃ©anmoins Ã©crit une fois quelques petites applications pour Android, donc l'essence d'une partie des rÃ©pertoires et, en gÃ©nÃ©ral, les principes des applications Android de l'appareil, sont Ã  peu prÃ¨s clairs pour moi. <br><br>  Pour commencer, je dÃ©cide de simplement Â«parcourirÂ» les fichiers.  J'ouvre AndroidManifest.xml et commence Ã  lire de maniÃ¨re significative.  Mon attention est attirÃ©e par un Ã©trange attribut <br><br><pre> <code class="xml hljs">android:supportsRtl="true"</code> </pre> <br>  Il s'avÃ¨re qu'il est responsable du support des langues avec la lettre "de droite Ã  gauche" dans l'application.  Nous commenÃ§ons Ã  tendre.  Pas bon. <br><br>  De plus, mon regard s'accroche au dossier inconnu.  En dessous se trouve une hiÃ©rarchie du formulaire: <b>org.apache.commons.codec.language.bm</b> et un grand nombre de fichiers texte au contenu obscur.  Google le nom complet du paquet et il se trouve ce qui est stockÃ© ici, quelque chose liÃ© Ã  l'algorithme de recherche de mots phonÃ©tiquement similaires Ã  celui donnÃ©.  Franchement, ici, j'ai commencÃ© Ã  m'efforcer davantage.  AprÃ¨s avoir fouillÃ© un peu dans les rÃ©pertoires, j'ai trouvÃ© le code lui-mÃªme, puis le plaisir a commencÃ©.  Je n'ai pas Ã©tÃ© accueilli par le bytecode Java habituel, avec lequel j'ai rÃ©ussi Ã  jouer, mais autre chose.  TrÃ¨s similaire, mais diffÃ©rent. <br><br>  En fin de compte, Android a sa propre machine virtuelle - Dalvik.  Et, comme toute machine virtuelle respectÃ©e, elle a son propre bytecode.  Il semble que lors de la premiÃ¨re tentative pour rÃ©soudre ce problÃ¨me, c'est sur cette triste note que j'ai annoncÃ© l'entracte, saluÃ©, baissÃ© le rideau et jetÃ© le tout pendant 4 mois jusqu'Ã  ce que ma curiositÃ© me finisse complÃ¨tement. <br><br><h2>  Retroussez les manches [2] </h2><br>  "Mais ne peut-il en Ãªtre ainsi pour que tout soit plus facile?"  - C'est la question que je me suis posÃ©e quand j'ai commencÃ© la tÃ¢che pour la deuxiÃ¨me fois.  J'ai commencÃ© Ã  chercher sur Internet un dÃ©compilateur de smali Ã  Java.  J'ai seulement vu qu'il est impossible de mener Ã  bien ce processus clairement.  FronÃ§ant un peu les sourcils, il se rendit Ã  Github et introduisit quelques phrases clÃ©s dans la ligne de recherche.  Le premier est venu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">smali2java</a> . <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> gradle build java -jar smali2java.jar ..</code> </pre> <br>  Erreurs  Je vois une Ã©norme trace de pile et des erreurs sur plusieurs pages du terminal.  AprÃ¨s avoir lu un peu sur l'essence du contenu (et restreindre les Ã©motions de la taille de la trace de la pile), je trouve que cet outil fonctionne sur la base d'une grammaire dÃ©crite et le bytecode qu'elle a rencontrÃ© clairement ne lui correspond pas.  J'ouvre le bytecode smali et j'y vois des annotations, des mÃ©thodes synthÃ©tiques et d'autres constructions Ã©tranges.  Il n'y avait rien de tel dans le bytecode Java!  Combien de temps?  Supprimer! <br><br><div class="spoiler">  <b class="spoiler_title">Plus de dÃ©tails</b> <div class="spoiler_text">  Il s'est avÃ©rÃ© que la machine virtuelle Dalvik (ainsi que la JVM) n'est pas consciente de l'existence de concepts tels que les classes internes / externes (lire les classes imbriquÃ©es), et le compilateur gÃ©nÃ¨re les mÃ©thodes dites Â«synthÃ©tiquesÂ» pour fournir l'accÃ¨s de la classe imbriquÃ©e Ã  des champs externes, par exemple. <br><br><h4>  A titre d'exemple: </h4><br>  Si la classe externe (OuterClass) a un champ <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OuterClass</span></span></span><span class="hljs-class"> </span></span>{ List a; ... }</code> </pre> <br>  Pour que la classe privÃ©e puisse accÃ©der au champ de la classe externe, le compilateur gÃ©nÃ©rera implicitement la mÃ©thode suivante: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> synthetic java.util.<span class="hljs-function"><span class="hljs-function">List </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OuterClass p1)</span></span></span><span class="hljs-function"> </span></span>{ p1 = p1.a; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; }</code> </pre> <br>  De plus, grÃ¢ce Ã  une telle cuisine Â«compartiment moteurÂ», le travail de certains autres mÃ©canismes fournis par la langue est atteint. <br><br>  Vous pouvez commencer Ã  Ã©tudier cette question plus en dÃ©tail Ã  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partir d'ici</a> . </div></div><br>  N'aide pas.  Il jure mÃªme Ã  un bytecode apparemment pas suspect.  J'ouvre le code source du dÃ©compilateur, lis et vois quelque chose de trÃ¨s Ã©trange: mÃªme les programmeurs hindous (avec tout le respect que je leur dois) n'auraient pas Ã©crit cela.  Une pensÃ©e se glisse: pas vraiment le code gÃ©nÃ©rÃ©.  Je rejette l'idÃ©e pendant environ 30 minutes, essayant de comprendre quelle est l'erreur.  COMPLIQUÃ‰.  J'ouvre Ã  nouveau Github - et vraiment, un analyseur gÃ©nÃ©rÃ© par la grammaire.  Et voici le gÃ©nÃ©rateur lui-mÃªme.  Tout ranger et essayer d'approcher de l'autre cÃ´tÃ©. <br><br>  <i>Il convient de noter qu'un peu plus tard, j'ai toujours essayÃ© de changer la grammaire et, par endroits, mÃªme le bytecode lui-mÃªme afin que le dÃ©compilateur puisse encore le digÃ©rer.</i>  <i>Mais mÃªme lorsque le bytecode est devenu valide en termes de grammaire du dÃ©compilateur, le programme ne m'a tout simplement rien retournÃ©.</i>  <i>Open source ...</i> <br><br>  Je feuillette le bytecode et tombe sur des constantes que je ne connais pas.  Googler, je rencontre la mÃªme chose dans le livre sur les applications Android inversÃ©es.  Je rappelle que ce n'est que l'ID attribuÃ© par le prÃ©processeur du compilateur, qui est affectÃ© aux ressources de l'application Android (la constante de temps d'Ã©criture du code est R. *).  Au cours de la prochaine demi-heure, j'examinerai briÃ¨vement quels registres sont responsables de quoi, dans quel ordre les arguments sont passÃ©s, et j'explore gÃ©nÃ©ralement la syntaxe. <br><br><h2>  Ã€ quoi Ã§a ressemble? </h2><br><img src="https://lh4.googleusercontent.com/6vy-LnmhLmjl2TnDiAoA632c026jlrPG7zFlclZNXJRdpethXv_iFjRtzwyvQWrqkd1LUKixzHfzXAyDj4c28JAzqVYTmP9uqJTmUYgjJd8Yx5pEDkd0cad34bNg9LYDf3r2jFVj" width="350" height="496" align="left">  J'ai trouvÃ© la disposition de la fenÃªtre principale de l'application, et j'ai dÃ©jÃ  compris ce qui se passait dans l'application: sur l'Ã©cran principal (ActivitÃ©), il y a un RecyclerView (conditionnellement, une vue qui peut rÃ©utiliser des objets d'interface utilisateur qui ne sont pas actuellement affichÃ©s pour l'utilisation de la mÃ©moire) avec des champs de saisie des paires clÃ© / valeur, quelques boutons chargÃ©s d'ajouter une nouvelle paire clÃ© / valeur Ã  un certain conteneur abstrait et un bouton qui gÃ©nÃ¨re une signature (signature) pour ce conteneur. <br><br>  En regardant les annotations et en observant une certaine quantitÃ© de code Ã©trangement similaire Ã  celui gÃ©nÃ©rÃ©, je commence Ã  google.  Le projet utilise la bibliothÃ¨que ButterKnife, qui permet d'utiliser des annotations pour <b>gonfler () -&gt; bind () les</b> Ã©lÃ©ments d'interface utilisateur automatiquement.  S'il y a des annotations dans la classe, le processeur d'annotation ButterKnife crÃ©e implicitement une autre classe de classeur de la forme <b>&lt;original_class&gt; __ViewBinding</b> , qui fait tout le sale boulot sous le capot.  En fait, j'ai obtenu toutes ces informations d'un seul fichier MainActivity aprÃ¨s avoir recrÃ©Ã© manuellement la similitude de la source Java Ã  partir de celui-ci.  AprÃ¨s une demi-heure, j'ai rÃ©alisÃ© que les annotations de cette bibliothÃ¨que peuvent Ã©galement dÃ©finir un rappel sur les actions des boutons et j'ai trouvÃ© les fonctions clÃ©s qui Ã©taient rÃ©ellement responsables de l'ajout d'une paire clÃ© / valeur au conteneur et de la gÃ©nÃ©ration d'une signature. <br><br>  <i>Bien sÃ»r, pendant l'Ã©tude, j'ai dÃ» entrer dans les Â«abatsÂ» de diverses bibliothÃ¨ques et plug-ins, car mÃªme les beaux landos avec cookies ne couvrent pas tous les cas d'utilisation et les dÃ©tails, ce qui, pour tout Â«reverseÂ», je pense, est une pratique courante.</i> <br><br><h2>  La paresse est l'amie d'un programmeur </h2><br>  AprÃ¨s avoir passÃ© un peu plus de temps sur la deuxiÃ¨me source, j'Ã©tais complÃ¨tement fatiguÃ© et j'ai rÃ©alisÃ© qu'il n'Ã©tait pas possible de cuisiner de la bouillie.  Je grimpe Ã  nouveau sur Github, et cette fois je regarde de plus prÃ¨s.  Je trouve le projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Smali2PsuedoJava</a> - un dÃ©compilateur en Â«code pseudo-JavaÂ».  MÃªme si cet utilitaire, au moins quelque chose peut conduire Ã  une apparence humaine, alors pour moi l'auteur est une chope de sa biÃ¨re prÃ©fÃ©rÃ©e (enfin, ou du moins mettre un astÃ©risque sur Github, pour commencer). <br><br>  Et Ã§a marche vraiment!  Effet sur le visage: <br><br><img src="https://lh6.googleusercontent.com/4yxBPy1Wt7_J7uLey66rp_qHwomfvAW_B1C6g3CsrS0DR73J_U42t4JgobNaGIUXVstTEVIaHriawFfRVZL4IqUEObjCL8RdLUv5VCGKiv_jeAxBclaXZlsMvmFUzFuuuuxfshw7"><br><br><h2>  Rencontrez Cipher.so </h2><br>  Un peu plus tard, en Ã©tudiant le pseudo-code Java du projet et en le comparant incrÃ©dule avec le bytecode smali, je trouve une Ã©trange bibliothÃ¨que dans le code - Cipher.so.  Google, je dÃ©couvre que c'est le cryptage d'un ensemble de valeurs de temps de compilation Ã  l'intÃ©rieur de l'archive APK.  Cela est gÃ©nÃ©ralement nÃ©cessaire lorsque l'application utilise des constantes du formulaire: adresses IP, informations d'identification pour une base de donnÃ©es externe, jetons d'autorisation, etc.  - ce qui peut Ãªtre obtenu Ã  l'aide de l'ingÃ©nierie inverse de l'application.  Certes, l'auteur Ã©crit clairement que ce projet est abandonnÃ©, disent-ils, partez.  Cela devient intÃ©ressant. <br><br>  Cette bibliothÃ¨que donne accÃ¨s aux valeurs via la bibliothÃ¨que Java, oÃ¹ la mÃ©thode spÃ©cifique est la clÃ© qui nous intÃ©resse.  Cela ne fait que nourrir mon intÃ©rÃªt et je commence Ã  grimper plus profondÃ©ment. <br><br>  En bref, que fait Cipher.so et comment cela fonctionne-t-il: <br><br><ul><li>  dans le fichier Gradle de notre projet les clÃ©s et les valeurs correspondantes sont enregistrÃ©es <br></li><li>  toutes les valeurs clÃ©s seront automatiquement compressÃ©es dans une bibliothÃ¨que dynamique distincte (.so), qui sera gÃ©nÃ©rÃ©e au moment de la compilation.  Oui - oui, sera gÃ©nÃ©rÃ©. <br></li><li>  alors ces clÃ©s peuvent Ãªtre obtenues Ã  partir des mÃ©thodes Java gÃ©nÃ©rÃ©es par Cipher.so <br></li><li>  aprÃ¨s la crÃ©ation de l'APK, les noms des clÃ©s sont hachÃ©s par MD5 (pour plus de sÃ©curitÃ©, bien sÃ»r) <br></li></ul><br>  AprÃ¨s avoir trouvÃ© la bibliothÃ¨que dynamique dont j'ai besoin dans le dossier d'archives, je procÃ¨de Ã  sa sÃ©lection.  Pour commencer, en tant qu'inverse expÃ©rimentÃ© (non), j'essaie de commencer par un simple - je dÃ©cide de regarder la section avec des constantes et des lignes intÃ©ressantes dans un binaire de type ELF.  Malheureusement, les utilisateurs du Mac prÃªt Ã  l'emploi sont manquants, et avant le dÃ©but, nous disons le chÃ©ri: <br><br><pre> <code class="bash hljs">brew install binuitls</code> </pre> <br>  Et n'oubliez pas d'Ã©crire le chemin vers <b>/ usr / local</b> dans PATH, car <i>brew</i> vous protÃ¨ge de tout de maniÃ¨re gentleman ... <br><br><pre> <code class="bash hljs">greadelf -p .rodata lib/arm64-v8a/libcipher-lib.so | head -n 15</code> </pre> <br>  Nous limitons la sortie aux 15 premiÃ¨res lignes, sinon cela peut entraÃ®ner un choc pour un ingÃ©nieur non prÃ©parÃ©. <br><br><img src="https://lh6.googleusercontent.com/-ka6awAjaQ6zTDJ4sogEHaqBEG2QL3il5HTS1M-HchKGBg4hK5qe__lAtEKtcL7CT0i_lhqtiEZYYRsnTpLmbc10hdpVTMcAeRP0bGJE87jUBvtkncNMJ3s5YtjgGXk0duZeHIrY"><br><br>  Aux adresses infÃ©rieures, nous remarquons des lignes suspectes.  Comme je l'ai dÃ©couvert, en Ã©tudiant les sources de Cipher.so, les clÃ©s et les valeurs sont placÃ©es dans le <b>std :: map</b> habituel <b>:</b> cela donne peu d'informations, mais nous savons que dans le binaire lui-mÃªme, avec les mots de passe cryptÃ©s, il y a aussi des clÃ©s obscurcies. <br><br>  Comment est le cryptage des valeurs?  En Ã©tudiant la source, j'ai trouvÃ© que le cryptage se produit en utilisant AES - le systÃ¨me de cryptage symÃ©trique standard.  Donc, s'il y a des valeurs chiffrÃ©es, alors la clÃ© devrait Ãªtre Ã  proximitÃ© ... AprÃ¨s l'avoir Ã©tudiÃ© pendant un certain temps, je suis tombÃ© sur un problÃ¨me dans le mÃªme projet avec le titre provocateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Stockage de clÃ© non sÃ©curisÃ©: les secrets sont trÃ¨s faciles Ã  retrouver"</a> .  En fait, j'ai dÃ©couvert que la clÃ© est stockÃ©e sous forme claire dans le binaire et j'ai trouvÃ© l'algorithme de dÃ©cryptage.  Dans l'exemple, la clÃ© Ã©tait Ã  l'adresse zÃ©ro, et bien que j'ai compris que le compilateur pouvait la placer Ã  un autre endroit dans la section .rodata du fichier binaire, j'ai dÃ©cidÃ© que cette unitÃ© suspecte Ã  l'adresse zÃ©ro Ã©tait la clÃ©. <br><br>  <b>Tentative n Â° 1: je</b> procÃ¨de au dÃ©chiffrement des valeurs et je crois que la clÃ© de chiffrement est la mÃªme.  L'erreur.  OpenSSL laisse entendre que quelque chose ne va pas.  AprÃ¨s avoir lu un peu les sources de Cipher.so, je comprends que si l'utilisateur ne spÃ©cifie pas de clÃ© lors de l'assemblage, alors la clÃ© par dÃ©faut est utilisÃ©e - <i>Cipher.so@DEFAULT</i> . <br><br>  <b>Tentative n Â° 2:</b> erreur Ã  nouveau.  Hmm ... Est-ce vraiment redÃ©fini par cette constante?  Il est assez simple de se tromper: confondre du code Ã©crit en Gradle, avec un formatage Â«disparuÂ».  Je vÃ©rifie encore.  Tout semble Ãªtre ainsi. <br><br>  Au lieu des clÃ©s se trouvent leurs hachages MD5, puis j'essaie de tenter ma chance et d'ouvrir un service avec des tables arc-en-ciel.  Voila - l'une des clÃ©s est le mot "mot de passe".  Il n'y a pas de seconde.  Bien sÃ»r, cela ne nous donne pas grand-chose.  Ces deux clÃ©s se trouvent respectivement aux adresses 240 et 2a2.  En principe, il est facile de les reconnaÃ®tre immÃ©diatement - 32 caractÃ¨res (MD5). <br><br>  J'ai tout vÃ©rifiÃ© Ã  nouveau et j'ai essayÃ© de faire le dÃ©chiffrement avec toutes les autres lignes (qui se trouvent dans les adresses infÃ©rieures) comme clÃ© de dÃ©chiffrement - tout est en vain. <br>  Donc, il y a une autre clÃ© secrÃ¨te, l'algorithme des actions semble Ãªtre correct.  Je jette cette tÃ¢che de cÃ´tÃ© et essaie de ne pas m'enterrer. <br><br>  AprÃ¨s avoir fouillÃ© un peu dans l'algorithme de signature de conteneur, je vois toujours des appels Ã  la bibliothÃ¨que et au code Cipher.so qui utilisent Ã©galement les fonctions cryptographiques de la bibliothÃ¨que Java. <br><br><h2>  Une Ã©nigme (que je n'ai jamais rÃ©solue) </h2><br>  Dans la fonction responsable du chiffrement, au tout dÃ©but, il y a une vÃ©rification des clÃ©s dans le conteneur. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] a(java/util/Map p1) { v0 = p1.size() v1 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 != <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_0 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; :cond_0 v0 = <span class="hljs-string"><span class="hljs-string">"user"</span></span>; v0 = p1.containsKey(v0) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 == <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_1 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; ...</code> </pre><br>  LittÃ©ralement: s'il existe une clÃ© "utilisateur", alors ce conteneur n'est pas signÃ© (une signature nulle est retournÃ©e).  Un sentiment Ã©trange: il semble que le problÃ¨me soit rÃ©solu, mais il semble en quelque sorte Ã©trangement simple.  Alors pourquoi tout inventer?  S'Ã©garer?  Alors pourquoi n'ai-je pas Ã©tudiÃ© ce code couramment auparavant?  Hmm ... <br><br>  Non, pas vrai.  J'ai spÃ©cifiÃ© la rÃ©ponse d'un certain utilisateur dans un messager bleu, dont les contacts m'ont Ã©tÃ© fournis lors de la mission.  Creuser plus loin.  Peut-Ãªtre que la clÃ© d'entrÃ©e / valeur dÃ©finie change d'une maniÃ¨re ou d'une autre lorsqu'elle est ajoutÃ©e au conteneur?  J'ai lu attentivement le code. <br><br>  Veuillez noter que le dÃ©compilateur a supprimÃ© les annotations du code smali.  Et s'il enlevait quelque chose d'important?  Je vÃ©rifie les fichiers principaux - il semble, rien de significatif.  Tout ce qui est important est en place, mais le sens n'est pas perdu.  Je vÃ©rifie les fonctions de rappel qui sont responsables de l'Ã©criture d'une paire clÃ© / valeur de TextBox conditionnelle dans des conteneurs internes.  Je n'ai rien trouvÃ© de criminel. <br><br>  Je suis devenu aussi sceptique que possible Ã  propos de chaque ligne de code - je ne peux plus faire confiance Ã  personne. <br><br>  Solution simple # 2: j'ai remarquÃ© que la procÃ©dure de signature commence par la vÃ©rification de la prÃ©sence d'une valeur (sous-chaÃ®ne dans la chaÃ®ne) dans la signature du certificat avec lequel l'application a Ã©tÃ© signÃ©e. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@OnClick</span></span> <span class="hljs-comment"><span class="hljs-comment">//   protected void huvot324yo873yvo837yvo() { String signature = "no data"; boolean result = some_packages.isKeyInSignature(this); if result { Map map = new HashMap(); ...</span></span></code> </pre> <br>  Le sens lui-mÃªme, bien sÃ»r, se trouve cryptÃ© dans ce malheureux binar.  Et en fait, si cette valeur n'est pas dans la signature, l'algorithme ne signera rien, mais renverra simplement la chaÃ®ne Â«pas de donnÃ©esÂ», comme signature ... Encore une fois, nous sommes pris pour Cipher ... <br><br><h2>  Combat final de dÃ©chiffrement de clÃ©s </h2><br>  Pour comprendre l'ampleur de la tragÃ©die, je me suis confondu comme ceci: <br><br>  J'ai fait un vidage hexadÃ©cimal de cette section et j'ai regardÃ© dans les deux premiÃ¨res lignes, dont les soupÃ§ons ne se sont pas dissipÃ©s dÃ¨s le dÃ©but. <br><br><img src="https://lh4.googleusercontent.com/J4lmChj6kk0lWWy23D8QngSgnJlNfd-xDP1XyBnw1wyQ_U1NBRLYyx2BFZ4y9D1HXEjcSeCKVvZC3xgVCpx-VSV0bIHD5dcmsfdaX4jrmH-uRFsRMc9VJrqpUEMDEEaijeSTPRbk"><br><br>  Si vous faites attention, le caractÃ¨re qui sÃ©pare les lignes ici est '0x00'.  Il est Ã©galement couramment utilisÃ© par la bibliothÃ¨que C standard, dans les fonctions de chaÃ®ne.  De lÃ , ce n'est pas moins intÃ©ressant, quel genre de caractÃ¨re spatial se trouve au milieu de la premiÃ¨re ligne?  Ensuite, des tentatives folles commencent, oÃ¹ la clÃ© est: <br><br><ul><li>  toute la premiÃ¨re rangÃ©e <br></li><li>  premiÃ¨re ligne avant l'espace <br></li><li>  premiÃ¨re ligne de l'espace Ã  la fin <br></li><li>  ... <br></li></ul><br>  Le degrÃ© de paranoÃ¯a peut dÃ©jÃ  Ãªtre estimÃ©.  Lorsque vous ne comprenez pas Ã  quel point la tÃ¢che doit Ãªtre difficile et astucieuse, vous commencez Ã  conduire.  Et pourtant, pas Ã§a.  Puis la pensÃ©e m'est venue Ã  l'esprit: "L'algorithme fonctionne-t-il correctement Ã  partir d'un problÃ¨me sur ma machine?".  En gÃ©nÃ©ral, la sÃ©quence d'actions y est logique et ne soulÃ¨ve pas de questions, mais la question est: les commandes de ma machine font-elles ce qu'elles exigent d'eux?  Alors qu'en pensez-vous? <br><br>  AprÃ¨s avoir vÃ©rifiÃ© toutes les Ã©tapes manuellement, il s'est avÃ©rÃ© que <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"some_base64_input"</span></span> | openssl base64 -d</code> </pre> <br>  sur certains arguments d'entrÃ©e, il renvoie soudainement une chaÃ®ne vide.  Hmm. <br><br>  En le remplaÃ§ant par le premier dÃ©codeur base64 sur la machine et en triant les principaux candidats, une clÃ© appropriÃ©e a Ã©tÃ© immÃ©diatement trouvÃ©e et les clÃ©s ont Ã©tÃ© dÃ©chiffrÃ©es en consÃ©quence. <br><br><h2>  RÃ©cupÃ©ration des signatures d'un certificat </h2><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isKeyInSignature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(android.content.Context p1)</span></span></span><span class="hljs-function"> </span></span>{ v0 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> TRY_0{ v1 = p1.getPackageManager() p0 = p1.getPackageName() v2 = <span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-comment"><span class="hljs-comment">// GET_SIGNATURES PackageInfo p0 = v1.getPackageInfo(p0, v2) android.content.pm.Signature[] p0 = p0.signatures; // Order are not guaranteed v1 = p0.length; v2 = 0x0; :goto_0 if (v2 &gt;= v1) goto :cond_1 v3 = p0[v2]; String v3 = v3.toCharsString() String v4 = net.idik.lib.cipher.so.CipherClient.a() v3 = v3.contains(v4) }TRY_0 catch TRY_0 (android/content/pm/PackageManager$NameNotFoundException) goto :catch_0; if (v3 == 0) goto :cond_0 p1 = 0x1; return p1; :cond_0 v2 = v2 + 0x1; goto :goto_0 :catch_0 p0 = Thrown Exception p1.printStackTrace() :cond_1 return v0; }</span></span></code> </pre> <br>  Voici Ã  quoi ressemble le pseudocode gÃ©nÃ©rÃ© aprÃ¨s mes modifications mineures.  Confond quelques choses: <br><br><ul><li>  mauvaise connaissance de la cryptographie et de la "cuisine" des certificats des appareils <br></li><li>  selon la documentation, cette mÃ©thode ne garantit pas l'ordre des certificats dans la collection retournÃ©e, et en consÃ©quence, il ne serait pas possible de boucler dans le mÃªme ordre - et si l'application Ã©tait signÃ©e avec plus d'un certificat? <br></li><li>  manque de connaissances sur la faÃ§on d'extraire le certificat de l'APK, Ã©tant donnÃ© qu'il n'est pas clair ce que fait Android Runtime dans ce cas <br></li></ul><br>  J'ai dÃ» approfondir toutes ces questions et le rÃ©sultat a Ã©tÃ© le suivant: <br><br><ul><li>  le certificat lui-mÃªme se trouve dans le rÃ©pertoire <i>original / META-INF / CERT.RSA</i> <i><br></i> <br>  dans ce rÃ©pertoire, il n'y a qu'un seul fichier avec cette extension - ce qui signifie que l'application est signÃ©e avec un seul certificat <br></li><li>  Sur le site sur l'ingÃ©nierie de recherche des applications Android, une liste a Ã©tÃ© trouvÃ©e qui peut extraire la signature dont nous avons besoin comme le fait Android.  Selon l'auteur, au moins. <br></li></ul><br>  En exÃ©cutant ce code, je peux comprendre la signature, et en rÃ©alitÃ©, la clÃ© dont nous avons besoin est une sous-chaÃ®ne.  Allez-y.  La solution simple n Â° 2 est en train d'Ãªtre balayÃ©e. <br><br>  En effet, la clÃ© est dans le certificat, il ne reste plus qu'Ã  comprendre ce qui va suivre, car si nous avons la clÃ© Â«utilisateurÂ», nous obtenons tous Ã©galement une signature nulle, et comme nous l'avons appris plus haut, c'est la mauvaise rÃ©ponse. <br><br><h2>  Ã‰crivez soigneusement la documentation! </h2><br>  De plus amples recherches sur le fait que les donnÃ©es saisies dans les champs de texte sont modifiÃ©es sont rejetÃ©es faute de preuves.  La paranoÃ¯a roule avec une vigueur renouvelÃ©e: peut-Ãªtre que le code qui a tirÃ© la signature du certificat est incorrect ou est-ce une implÃ©mentation de code pour les anciennes versions d'Android?  J'ouvre de nouveau la documentation et je vois ce qui suit: ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://developer.android.com/reference/android/content/pm/Signature.html#toChars ()</a> ): <br><br><img src="https://lh5.googleusercontent.com/1TZ3rj6hzTEWw5YHEl1EWnANjsiqpzGR-tTrXP_Nc6jt42ANPf1QW-fmP-mh7Y2MhgMcZF0Z8CpskzT_ge65C0YCcryiWjjpG0UuPeqkUCsde1qcQgm5NbeqFj4KO3QkdtvHM3v2"><br><br>  <b>Remarque: la</b> fonction code la signature sous forme de texte ASCII.  Le rÃ©sultat que j'ai reÃ§u ci-dessus Ã©tait une reprÃ©sentation hexadÃ©cimale des donnÃ©es.  Cette API m'a paru Ã©trange, mais si vous croyez Ã  la documentation, il s'avÃ¨re que j'ai de nouveau Ã©tÃ© bloquÃ©, et la clÃ© chiffrÃ©e n'est pas une sous-chaÃ®ne de la signature.  AprÃ¨s m'Ãªtre assis pensivement sur le code pendant un moment, je n'ai pas pu le supporter et j'ai ouvert le code source de cette classe.  <a href="">https://android.googlesource.com/platform/frameworks/base/+/e639da7/core/java/android/content/pm/Signature.java</a> <br><br>  La rÃ©ponse ne tarda pas Ã  venir.  Et en fait, dans le code lui-mÃªme - une peinture Ã  l'huile: le format de sortie est une chaÃ®ne hexadÃ©cimale ordinaire.  Et maintenant, pensez: soit je ne comprends pas quelque chose, soit la documentation est Ã©crite Â«lÃ©gÃ¨rementÂ» incorrectement.  N'ayant aucunement grondÃ©, je me mis Ã  nouveau au travail. <br><br><h2>  RÃ©sumÃ© </h2><br>  Les n heures suivantes se sont Ã©coulÃ©es: <br><br><ul><li>       RecyclerView        ..  ,           StackOverflow <br></li><li>    ,    ,   Java.    ,    -       (Â«userÂ»)     .       . <br></li></ul><br>  ,        (             ). <br><br>  Non. ,     .  ,    ,  ,       ,     .  .  â€”      ,     ,    ,  . <br><br>  ,       ,        .    .       ,           . , -   ,      ,      Â« Â»,    ,      . <br><br>  -    c        â€“      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">arturbrsg</a> . <br><br> Stay tuned. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450394/">https://habr.com/ru/post/fr450394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450374/index.html">Carte d'extension de RAM pour Apple IIgs</a></li>
<li><a href="../fr450376/index.html">Comment Yandex.Taxi recherche des voitures quand elles ne le sont pas</a></li>
<li><a href="../fr450378/index.html">GitLab 11.10</a></li>
<li><a href="../fr450384/index.html">L'histoire d'une petite Ã©tude de code hÃ©ritÃ©e</a></li>
<li><a href="../fr450386/index.html">Interfaces en tant que types de donnÃ©es abstraits dans Go</a></li>
<li><a href="../fr450396/index.html">Comment amÃ©liorer votre anglais Ã©crit: conseils pratiques et outils utiles</a></li>
<li><a href="../fr450398/index.html">Les poisons les plus intrÃ©pides</a></li>
<li><a href="../fr450410/index.html">Terraformer - Infrastructure Ã  coder</a></li>
<li><a href="../fr450416/index.html">Comment les fournisseurs VPN de shareware vendent vos donnÃ©es</a></li>
<li><a href="../fr450418/index.html">L'art de crÃ©er des modÃ¨les 3D organiques: les ombrages sous-cutanÃ©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>