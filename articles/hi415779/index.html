<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯС▒ЁЯП┐ ЁЯСГ ЁЯФж рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдПрдирдПрдПрд╕ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди ЁЯМЩ ЁЯзЭ ЁЯТд</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ , NAS рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреЗ рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред 
 рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рдЖ рдЧрдпрд╛ рд╣реИред 
 рдирд┐рд░реАрдХреНрд╖рдг 


 рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдкреВрд▓ рдХреЗ рд╕...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдПрдирдПрдПрд╕ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415779/"><p><img src="https://habrastorage.org/getpro/habr/post_images/b93/ed1/af9/b93ed1af987a1fda471d1080d6b804e5.jpg"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ</a> , NAS рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреЗ рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред <br>  рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рдЖ рдЧрдпрд╛ рд╣реИред </p><a name="habracut"></a><br><h2 id="proverka">  рдирд┐рд░реАрдХреНрд╖рдг </h2><br><p>  рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдкреВрд▓ рдХреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рдЬрд╛рдВрдЪ рдЕрд╡рд╢реНрдп рдХрд░реЗрдВ: </p><br><pre><code class="hljs lua">zpool <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> -v</code> </pre> <br><p>  рдкреВрд▓ рдФрд░ рдЗрд╕рдореЗрдВ рд╕рднреА рдбрд┐рд╕реНрдХ рдСрдирд▓рд╛рдИрди рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред </p><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдореИрдВ рдорд╛рдирддрд╛ рд╣реВрдВ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдЪрд░рдг рдореЗрдВ рд╕рдм рдХреБрдЫ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ</a> рдЕрдиреБрд╕рд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдпрд╛ рдЖрдк рдЦреБрдж рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдордЭрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХреНрдпрд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВред </p><br><h2 id="udobstva">  рд╕реБрд╡рд┐рдзрд╛ </h2><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдпрд╣ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдкреНрд░рдмрдВрдзрди рдХрд╛ рдзреНрдпрд╛рди рд░рдЦрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдпрджрд┐ рдЖрдкрдиреЗ рд╢реБрд░реБрдЖрдд рд╕реЗ рд╣реА рдРрд╕рд╛ рдирд╣реАрдВ рдХрд┐рдпрд╛ред <br>  рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА: </p><br><ul><li>  SSH рд╕рд░реНрд╡рд░: <code>apt-get install openssh-server</code> ред  рдпрджрд┐ рдЖрдк SSH рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВ, <del>  рд▓рд┐рдирдХреНрд╕ рдкрд░ NAS рдХрд░рдирд╛ рдмрд╣реБрдд рдЬрд▓реНрджреА рд╣реИ </del>  рдЖрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЗрд╕ рд▓реЗрдЦ</a> рдореЗрдВ рдЗрд╕рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ, рдлрд┐рд░ рдХрд┐рд╕реА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдХ рдореИрдиреБрдЕрд▓ рдХрд╛</a> рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">tmux</a> рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реНрдХреНрд░реАрди</a> : <code>apt-get install tmux</code> ред  SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реЙрдЧ рдЗрди рдХрд░рддреЗ рд╕рдордп рд╕рддреНрд░ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдХрдИ рд╡рд┐рдВрдбреЛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред </li></ul><br><p>  SSH рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдкрдХреЛ SSH рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдЗрди рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдЗрдирдкреБрдЯ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдХреНрд╖рдо рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ): </p><br><pre> <code class="bash hljs">zfs create rpool/home/user adduser user cp -a /etc/skel/.[!.]* /home/user chown -R user:user /home/user</code> </pre> <br><p>  рджреВрд░рд╕реНрде рдкреНрд░рд╢рд╛рд╕рди рдХреЗ рд▓рд┐рдП, рдпрд╣ рдкрд░реНрдпрд╛рдкреНрдд рдиреНрдпреВрдирддрдо рд╣реИред </p><br><p>  рдлрд┐рд░ рднреА, рдЬрдмрдХрд┐ рдЖрдкрдХреЛ рдХреАрдмреЛрд░реНрдб рдФрд░ рдореЙрдирд┐рдЯрд░ рдХреЛ рдХрдиреЗрдХреНрдЯ рд░рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ  рдХрд░реНрдиреЗрд▓ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддреЗ рд╕рдордп рдЖрдкрдХреЛ рд░реАрдмреВрдЯ рдХрд░рдиреЗ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рдФрд░ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рд╕рдм рдХреБрдЫ рд▓реЛрдб рд╣реЛрдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред </p><br><p>  рд╡рд░реНрдЪреБрдЕрд▓ KVM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИ, рдЬреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">IME</a> рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рд╡рд╣рд╛рдВ рдПрдХ рдХрдВрд╕реЛрд▓ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдЗрд╕реЗ рдЬрд╛рд╡рд╛ рдПрдкреНрд▓реЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ рдмрд╣реБрдд рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдирд╣реАрдВ рд╣реИред </p><br><h2 id="nastroyka">  рд╕рдорд╛рдпреЛрдЬрди </h2><br><h3 id="podgotovka-kesha">  рдХреИрд╢ рдХреА рддреИрдпрд╛рд░реА </h3><br><p>  рдЬрд╣рд╛рдВ рддрдХ тАЛтАЛрдЖрдкрдХреЛ рдпрд╛рдж рд╣реИ, рдореЗрд░реЗ рджреНрд╡рд╛рд░рд╛ рд╡рд░реНрдгрд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ L2ARC рдХреЗ рддрд╣рдд рдПрдХ рдЕрд▓рдЧ SSD рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрднреА рддрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди "рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП" рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><p>  рд╡реИрдХрд▓реНрдкрд┐рдХ, рд▓реЗрдХрд┐рди рдЗрд╕ SSD рдХреЛ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рднрд░рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреА рдЬрд╛рддреА рд╣реИ (рд╕реИрдорд╕рдВрдЧ EVO рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ blkdiscard рдХреЗ рдмрд╛рдж рд╢реВрдиреНрдп рд╕реЗ рднрд░рд╛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рд╕рднреА SSD рдкрд░ рд╡реИрд╕реЗ рднреА рдирд╣реАрдВ): </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/dev/disk/by-id/ata-Samsung_SSD_850_EVO bs=4M &amp;&amp; blkdiscard /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><h3 id="otklyuchenie-szhatiya-logov">  рд▓реЙрдЧ рд╕рдВрдкреАрдбрд╝рди рдЕрдХреНрд╖рдо рдХрд░рдирд╛ </h3><br><p>  рдЬреЗрдбрдПрдлрдПрд╕ рдкрд░, рд╕рдВрдкреАрдбрд╝рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЧрдЬрд╝рд┐рдк рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реЙрдЧ рд╕рдВрдкреАрдбрд╝рди рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╢рд╛рдирджрд╛рд░ рд╣реЛрдЧрд╛ред <br>  рдмрдВрдж рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/logrotate.d/* ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep -Eq <span class="hljs-string"><span class="hljs-string">"(^|[^#y])compress"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> sed -i -r <span class="hljs-string"><span class="hljs-string">"s/(^|[^#y])(compress)/\1#\2/"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><h3 id="obnovlenie-sistemy">  рд╕рд┐рд╕реНрдЯрдо рдЕрдкрдбреЗрдЯ </h3><br><p>  рдпрд╣рд╛рдБ рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИ: </p><br><pre> <code class="bash hljs">apt-get dist-upgrade --yes reboot</code> </pre> <br><h3 id="sozdanie-snepshota-dlya-novogo-sostoyaniya">  рдПрдХ рдирдП рд░рд╛рдЬреНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛рдирд╛ </h3><br><p>  рд░реАрдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдирдИ рдХрд╛рд░реНрдпрд╢реАрд▓ рд╕реНрдерд┐рддрд┐ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдкрд╣рд▓реЗ рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрдирд╛ рд╣реЛрдЧрд╛: </p><br><pre> <code class="bash hljs">zfs destroy rpool/ROOT/debian@install zfs snapshot rpool/ROOT/debian@install</code> </pre> <br><h2>  рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рд╕рдВрдЧрдарди </h2><br><h3 id="podgotovka-razdelov-dlya-slog">  SLOG рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд╛рдЬрди </h3><br><p>  рд╕рд╛рдорд╛рдиреНрдп рдЬреЗрдбрдПрдлрдПрд╕ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдкрд╣рд▓реА рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдПрд╕рдПрд▓рдУрдЬреА рдХреЛ рдПрд╕рдПрд╕рдбреА рдкрд░ рд░рдЦрд╛ рдЬрд╛рдПред <br>  рдЖрдкрдХреЛ рдпрд╛рдж рджрд┐рд▓рд╛рддрд╛ рд╣реВрдВ рдХрд┐ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ SLOG рджреЛ SSDs рдкрд░ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рд╣реИ: рдЗрд╕рдХреЗ рд▓рд┐рдП, LUKS-XTS рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдкреНрд░рддреНрдпреЗрдХ SSD рдХреЗ рдЪреМрдереЗ рдЦрдВрдб рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдмрдирд╛рдП рдЬрд╛рдПрдВрдЧреЗ: </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/etc/keys/slog.key bs=1 count=4096 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Micron_1100-part4 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt1 /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt2 /dev/disk/by-id/ata-Micron_1100-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab</code> </pre> <br><h3 id="podgotovka-razdelov-dlya-l2arc-i-podkachki">  L2ARC рдФрд░ рд╕реНрд╡реИрдк рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд╛рдЬрди </h3><br><p>  рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рд╕реНрд╡реИрдк рдФрд░ l2arc рдХреЗ рддрд╣рдд рд╡рд┐рднрд╛рдЬрди рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="bash hljs">sgdisk -n1:0:48G -t1:8200 -c1:part_swap -n2::196G -t2:8200 -c2:part_l2arc /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><p>  рд╕реНрд╡реИрдк рд╡рд┐рднрд╛рдЬрди рдФрд░ L2ARC рдХреЛ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдХреБрдВрдЬреА рдкрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛  рд░рд┐рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрдиреНрд╣реЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рдирд╛ рд╣рдореЗрд╢рд╛ рд╕рдВрднрд╡ рд╣реИред <br>  рдЗрд╕рд▓рд┐рдП, рдХреНрд░рд┐рдкреНрдЯреИрдм рдореЗрдВ, рд╕рд╛рджреЗ рдореЛрдб рдореЗрдВ рд╡рд┐рднрд╛рдЬрди рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ / рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрдВрдХреНрддрд┐ рд▓рд┐рдЦреА рдЧрдИ рд╣реИ: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> swap_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part1 /dev/urandom swap,cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> l2arc_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part2 /dev/urandom cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab</code> </pre> <br><p>  рдлрд┐рд░ рдЖрдкрдХреЛ рдбреЗрдореЙрди рдХреЛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░рдиреЗ рдФрд░ рд╕реНрд╡реИрдк рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'vm.swappiness = 10'</span></span> &gt;&gt; /etc/sysctl.conf sysctl vm.swappiness=10 systemctl daemon-reload systemctl start systemd-cryptsetup@swap_crypt.service <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /dev/mapper/swap_crypt none swap sw,discard 0 0 &gt;&gt; /etc/fstab swapon -av</code> </pre> <br><p>  рдХреНрдпреЛрдВрдХрд┐  рдПрд╕рдПрд╕рдбреА рдкрд░ <code>swapiness</code> рдХрд╛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, <code>swapiness</code> рдкреИрд░рд╛рдореАрдЯрд░, рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ 60 рд╣реИ, рдХреЛ 10 рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><p>  L2ARC рдХрд╛ рдЕрднреА рдЗрд╕ рд╕реНрддрд░ рдкрд░ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рд▓рд┐рдП рдЕрдиреБрднрд╛рдЧ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рддреИрдпрд╛рд░ рд╣реИ: </p><br><pre> <code class="bash hljs">$ ls /dev/mapper/ control l2arc_crypt root_crypt1 root_crypt2 slog0_crypt1 slog0_crypt2 swap_crypt tank0_crypt0 tank0_crypt1 tank0_crypt2 tank0_crypt3</code> </pre> <br><h3 id="puly-tankn">  рддрд╛рд▓ рдЯреИрдВрдХ </h3><br><p>  <code>tank0</code> рдкреВрд▓ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, <code>tank1</code> рдХреЛ рд╕рд╛рджреГрд╢реНрдп рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><p>  рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕рдорд╛рди рд╡рд┐рднрд╛рдЬрди рдирд╣реАрдВ рдмрдирд╛рдиреЗ рдФрд░ рддреНрд░реБрдЯрд┐рдпреЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдкреВрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╡рд┐рднрд╛рдЬрди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ <a href="">рд╕реНрдХреНрд░рд┐рдкреНрдЯ</a> рд▓рд┐рдЦреА рд╣реИ: </p><br><div class="spoiler">  <b class="spoiler_title">create_crypt_pool.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash KEY_SIZE=512 POOL_NAME="$1" KEY_FILE="/etc/keys/${POOL_NAME}.key" LUKS_PARAMS="--verbose --cipher aes-xts-plain64:sha${KEY_SIZE} --key-size $KEY_SIZE" [ -z "$1" ] &amp;&amp; { echo "Error: pool name empty!" ; exit 1; } shift [ -z "$*" ] &amp;&amp; { echo "Error: devices list empty!" ; exit 1; } echo "Devices: $*" read -p "Is it ok? " a [ "$a" != "y" ] &amp;&amp; { echo "Bye"; exit 1; } dd if=/dev/urandom of=$KEY_FILE bs=1 count=4096 phrase="?" read -s -p "Password: " phrase echo read -s -p "Repeat password: " phrase1 echo [ "$phrase" != "$phrase1" ] &amp;&amp; { echo "Error: passwords is not equal!" ; exit 1; } echo "### $POOL_NAME" &gt;&gt; /etc/crypttab index=0 for i in $*; do echo "$phrase"|cryptsetup $LUKS_PARAMS luksFormat "$i" || exit 1 echo "$phrase"|cryptsetup luksAddKey "$i" $KEY_FILE || exit 1 dev_name="${POOL_NAME}_crypt${index}" echo "${dev_name} $i $KEY_FILE luks" &gt;&gt; /etc/crypttab cryptsetup luksOpen --key-file $KEY_FILE "$i" "$dev_name" || exit 1 index=$((index + 1)) done echo "###" &gt;&gt; /etc/crypttab phrase="=====================================================" phrase1="=================================================" unset phrase unset phrase1</span></span></code> </pre> </div></div><br><p>  рдЕрдм, рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдЖрдкрдХреЛ рдбреЗрдЯрд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреВрд▓ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="bash hljs">./create_crypt_pool.sh zpool create -o ashift=12 -O atime=off -O compression=lz4 -O normalization=formD tank0 raidz1 /dev/disk/by-id/dm-name-tank0_crypt*</code> </pre> <br><p>  <code>ashift=12</code> рдкреИрд░рд╛рдореАрдЯрд░ рдкрд░ рдиреЛрдЯреНрд╕ рдХреЗ рд▓рд┐рдП, рдореЗрд░реЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд┐рдЫрд▓реЗ</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓реЗрдЦ</a> рдФрд░ рдЙрди рдкрд░ рдЯрд┐рдкреНрдкрдгреА рджреЗрдЦреЗрдВред </p><br><p>  рдкреВрд▓ рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдореИрдВрдиреЗ SSD рдкрд░ рдЕрдкрдирд╛ рд▓реЙрдЧ рдЖрдЙрдЯ рдХрд┐рдпрд╛: </p><br><pre> <code class="bash hljs">zpool add tank0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mirror /dev/disk/by-id/dm-name-slog0_crypt1 /dev/disk/by-id/dm-name-slog0_crypt2</code> </pre> <br><p>  рднрд╡рд┐рд╖реНрдп рдореЗрдВ, OMV рд╕реНрдерд╛рдкрд┐рдд рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХреЗ рд╕рд╛рде, GUI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреВрд▓ рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bu/bc/qj/bubcqjn_frfc3plifb9ehgzxco0.png" alt="ZFS рдирд┐рд░реНрдорд╛рдг OMV WEB GUI рдореЗрдВ рдЧрд┐рд░ рдЧрдпрд╛"></a> </p><br><h3 id="vklyuchenie-importa-pulov-i-avtomontirovaniya-tomov-pri-zagruzke">  рдкреВрд▓ рдореЗрдВ рдкреВрд▓ рдЖрдпрд╛рдд рдФрд░ рдСрдЯреЛ-рдорд╛рдЙрдВрдЯ рд╡реЙрд▓реНрдпреВрдо рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ </h3><br><p>  рдСрдЯреЛ-рдорд╛рдЙрдВрдЯ рдкреВрд▓ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧрд╛рд░рдВрдЯреА рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдВ: </p><br><pre> <code class="bash hljs">rm /etc/zfs/zpool.cache systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-scan.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-mount.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-cache.service</code> </pre> <br><p>  рдЗрд╕ рд╕реНрддрд░ рдкрд░, рдбрд┐рд╕реНрдХ рд╕рдмрд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреВрд░рд╛ рд╣реЛ рдЧрдпрд╛ рд╣реИред </p><br><h2>  рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо </h2><br><p>  рдПрдирдПрдПрд╕ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреА рдиреАрдВрд╡ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдУрдПрдорд╡реА рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓рд╛ рдХрджрдо рд╣реИред </p><br><h3 id="ustanovka-omv">  OMV рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ </h3><br><p>  OMV рдХреЛ рдПрдХ рдбрд┐рдмреЗрдЯ рдкреИрдХреЗрдЬ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдирд┐рд░реНрджреЗрд╢реЛрдВ</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред </p><br><p>  <code>add_repo.sh</code> рд╕реНрдХреНрд░рд┐рдкреНрдЯ OMV Arrakis рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЛ <code>/etc/apt/ sources.list.d</code> <code>add_repo.sh</code> рдЬреЛрдбрд╝рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдмреИрдЪ рд╕рд┐рд╕реНрдЯрдо рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЛ рджреЗрдЦрддрд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">add_repo.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &lt;&lt;EOF &gt;&gt; /etc/apt/sources.list.d/openmediavault.list deb http://packages.openmediavault.org/public arrakis main <span class="hljs-comment"><span class="hljs-comment"># deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis main ## Uncomment the following line to add software from the proposed repository. # deb http://packages.openmediavault.org/public arrakis-proposed main # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis-proposed main ## This software is not part of OpenMediaVault, but is offered by third-party ## developers as a service to OpenMediaVault users. deb http://packages.openmediavault.org/public arrakis partner # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis partner EOF</span></span></code> </pre> </div></div><br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдореВрд▓ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ, рднрд╛рдЧреАрджрд╛рд░ рднрдВрдбрд╛рд░ рд╢рд╛рдорд┐рд▓ рд╣реИред </p><br><p>  рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдФрд░ рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЖрджреЗрд╢ рдЪрд▓рд╛рдиреЗ рд╣реЛрдВрдЧреЗред </p><br><div class="spoiler">  <b class="spoiler_title">рдУрдПрдорд╡реА рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрджреЗрд╢ред</b> <div class="spoiler_text"><pre> <code class="bash hljs">./add_repo.sh <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=C <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEBIAN_FRONTEND=noninteractive <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> APT_LISTCHANGES_FRONTEND=none apt-get update apt-get --allow-unauthenticated install openmediavault-keyring apt-get update apt-get --yes --auto-remove --show-upgraded \ --allow-downgrades --allow-change-held-packages \ --no-install-recommends \ --option Dpkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confdef"</span></span> \ --option DPkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confold"</span></span> \ install postfix openmediavault <span class="hljs-comment"><span class="hljs-comment"># Initialize the system and database. omv-initsystem</span></span></code> </pre> </div></div><br><p>  OMV рд╕реНрдерд╛рдкрд┐рддред  рдпрд╣ рдЕрдкрдиреЗ рдХрд░реНрдиреЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рд╕реНрдерд╛рдкрдирд╛ рдХреЗ рдмрд╛рдж рд░рд┐рдмреВрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИред </p><br><p>  рд░рд┐рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, OpenMediaVault рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкреЛрд░реНрдЯ 80 рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реЛрдЧрд╛ (IP рдкрддреЗ рджреНрд╡рд╛рд░рд╛ NAS рдкрд░ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдкрд░ рдЬрд╛рдПрдВ): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/eo/sf/ra/eosfraeilpg2dn770ef5bvr-ple.png"></a> </p><br><p>  рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо / рдкрд╛рд╕рд╡рд░реНрдб <code>admin/openmediavault</code> ред </p><br><h3 id="nastroyka-omv">  OMV рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ </h3><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрдзрд┐рдХрд╛рдВрд╢ рд╡рд┐рдиреНрдпрд╛рд╕ WEB-GUI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рдПрдЧрд╛ред </p><br><h4 id="ustanovka-bezopasnogo-soedineniya">  рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ </h4><br><p>  рдЕрдм рдЖрдкрдХреЛ рднрд╡рд┐рд╖реНрдп рдореЗрдВ HTTPS рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП WEB рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдФрд░ NAS рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рдкрд╛рд╕рд╡рд░реНрдб рдЯреИрдм рдкрд░ рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рд╕рд╛рдорд╛рдиреНрдп рд╕реЗрдЯрд┐рдВрдЧреНрд╕-&gt; рд╡реЗрдм рдкреНрд░рд╢рд╛рд╕рдХ рдкрд╛рд╕рд╡рд░реНрдб"</em> ред <br>  рдЯреИрдм рдкрд░ рдПрдХ рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдкреНрд░рдорд╛рдг рдкрддреНрд░-&gt; рдПрд╕рдПрд╕рдПрд▓",</em> <em>"рдРрдб-&gt; рдХреНрд░рд┐рдПрдЯ" рдЪреБрдиреЗрдВ</em> ред </p><br><p>  рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдЙрд╕реА рдЯреИрдм рдкрд░ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ld/6j/_m/ld6j_mgp4tx6auirzlkfnwium2c.png" alt="рдкреНрд░рдорд╛рдгрдкрддреНрд░"></a> </p><br><p>  рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рдж, <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рд╕рд╛рдорд╛рдиреНрдп рд╕реЗрдЯрд┐рдВрдЧреНрд╕" рдЯреИрдм рдкрд░,</em> <em>"рд╕рдХреНрд╖рдо рдПрд╕рдПрд╕рдПрд▓ / рдЯреАрдПрд▓рдПрд╕"</em> рдЪреЗрдХрдмреЙрдХреНрд╕ рдХреЛ <em>рд╕рдХреНрд╖рдо рдХрд░реЗрдВ</em> ред </p><br><p>  рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреВрд░реНрдг рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдПрдХ рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рдЕрдВрддрд┐рдо рд╕рдВрд╕реНрдХрд░рдг OMV рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ред </p><br><p>  рдЕрдм рдЖрдкрдХреЛ 443 рдХреЛ рдкреЛрд░реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП OMV рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдпрд╛ рдмреНрд░рд╛рдЙрдЬрд░ рдореЗрдВ рдЖрдИрдкреА рдореЗрдВ <code>https://</code> рдкреНрд░реАрдлрд┐рдХреНрд╕ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p>  рдпрджрд┐ рдЖрдк рдЯреИрдм <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рд╕рд╛рдорд╛рдиреНрдп рд╕реЗрдЯрд┐рдВрдЧреНрд╕"</em> рдкрд░ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдореЗрдВ рдХрд╛рдордпрд╛рдм рд░рд╣реЗ, рддреЛ рдЖрдкрдХреЛ "рдлреЛрд░реНрд╕ рдПрд╕рдПрд╕рдПрд▓ / рдЯреАрдПрд▓рдПрд╕" рдЪреЗрдХрдмреЙрдХреНрд╕ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p>  <strong>рдкреЛрд░реНрдЯ 80 рдФрд░ 443 рдХреЛ 10080 рдФрд░ 10443 рдореЗрдВ рдмрджрд▓реЗрдВ</strong> ред <br>  рдФрд░ рдирд┐рдореНрди рдкрддреЗ рдкрд░ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ: <code>https://IP_NAS:10443</code> ред <br>  рдкреЛрд░реНрдЯ рдмрджрд▓рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдкреЛрд░реНрдЯ 80 рдФрд░ 443 рдирдЧрдиреЗрдХреНрд╕-рд░рд┐рд╡рд░реНрд╕-рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд╕рд╛рде рдбреЙрдХ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред </p><br><h3 id="pervichnye-nastroyki">  рдкреНрд░рд╛рдердорд┐рдХ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ </h3><br><p>  рдиреНрдпреВрдирддрдо рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдЬреЛ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдП: </p><br><ul><li>  рдЯреИрдм рдкрд░ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рджрд┐рдирд╛рдВрдХ рдФрд░ рд╕рдордп"</em> рд╕рдордп рдХреНрд╖реЗрддреНрд░ рдорд╛рди рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ рдФрд░ рдПрдирдЯреАрдкреА рд╕рд░реНрд╡рд░ рд╕реЗрдЯ рдХрд░реЗрдВред </li><li>  рдЯреИрдм рдкрд░ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдирд┐рдЧрд░рд╛рдиреА"</em> рдкреНрд░рджрд░реНрд╢рди рдЖрдВрдХрдбрд╝реЛрдВ рдХреЗ рд╕рдВрдЧреНрд░рд╣ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИред </li><li>  рдЯреИрдм <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдПрдирд░реНрдЬреА рдореИрдиреЗрдЬрдореЗрдВрдЯ" рдкрд░ рдпрд╣</em> рд╕рдВрднрд╡рдд: "рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ" рдХреЛ рдмрдВрдж рдХрд░рдиреЗ рдХреЗ рд▓рд╛рдпрдХ рд╣реИ рддрд╛рдХрд┐ рдУрдПрдорд╡реА рдкреНрд░рд╢рдВрд╕рдХреЛрдВ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рди рдХрд░реЗред </li></ul><br><h3 id="set">  рдиреЗрдЯрд╡рд░реНрдХ </h3><br><p>  рдпрджрд┐ рджреВрд╕рд░рд╛ NAS рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдЕрднреА рддрдХ рдХрдиреЗрдХреНрдЯ рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ, рддреЛ рдЗрд╕реЗ рд░рд╛рдЙрдЯрд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВред </p><br><p>  рддреЛ: </p><br><ul><li>  <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдиреЗрдЯрд╡рд░реНрдХ" рдЯреИрдм рдкрд░,</em> рд╣реЛрд╕реНрдЯ рдирд╛рдо рдХреЛ "рдПрдирдПрдПрд╕" (рдпрд╛ рдЬреЛ рднреА рдЖрдкрдХреЛ рдкрд╕рдВрдж рд╣реИ) рд╕реЗрдЯ рдХрд░реЗрдВред </li><li>  рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЪрд┐рддреНрд░ рдореЗрдВ рджрд┐рдЦрд╛рдП рдЧрдП рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рд▓рд┐рдП рдмреЙрдиреНрдбрд┐рдВрдЧ рд╕реЗрдЯ рдХрд░реЗрдВ: <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдиреЗрдЯрд╡рд░реНрдХ-&gt;</em> рдЗрдВрдЯрд░рдлреЗрд╕- <em>&gt; рдРрдб-&gt; рдмреЙрдиреНрдб"</em> ред </li><li>  рдЯреИрдм рдкрд░ рдЖрд╡рд╢реНрдпрдХ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдо рдЬреЛрдбрд╝реЗрдВ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдиреЗрдЯрд╡рд░реНрдХ-&gt; рдлрд╝рд╛рдпрд░рд╡реЙрд▓"</em> ред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, SSH рдХреЗ рд▓рд┐рдП рдкреЛрд░реНрдЯреНрд╕ 10443, 10080, 443, 80, 22 рддрдХ рдкрд╣реБрдВрдЪ рдФрд░ ICMP рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ / рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/rb/fi/ab/rbfiabiimceoohildwosfu_egju.png" alt="рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛"></a> </p><br><p>  рдирддреАрдЬрддрди, рд╕рдВрдмрдВрдз рдореЗрдВ рдЗрдВрдЯрд░рдлреЗрд╕ рджрд┐рдЦрд╛рдИ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреЛ рд░рд╛рдЙрдЯрд░ рдХреЛ рдПрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдПрдХ рдЖрдИрдкреА рдкрддрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░реЗрдЧрд╛: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ag/wr/y8/agwry8ynozq7dhgov16pzzwmrs0.png" alt="рдмреЙрдиреНрдбрд┐рдВрдЧ рдХрд╛ рджрд╛рдпрд░рд╛"></a> </p><br><p>  рдпрджрд┐ рд╡рд╛рдВрдЫрд┐рдд рд╣реИ, рддреЛ рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдПрд╕рдПрд╕рдмреА рдХреЛ рд╡реЗрдм GUI рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yk/oa/i4/ykoai4l9risd46whpuutbnyi1um.png" alt="Ssh рдиреЗрд╣рд░реВ"></a> </p><br><h3 id="repozitorii-i-moduli">  рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдФрд░ рдореЙрдбреНрдпреВрд▓ </h3><br><p>  рдЯреИрдм рдкрд░ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдЕрдкрдбреЗрдЯ рдкреНрд░рдмрдВрдзрди-&gt; рд╕реЗрдЯрд┐рдВрдЧ"</em> <em>"рд╕рдореБрджрд╛рдп рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдЕрдкрдбреЗрдЯ</em> <em>"</em> рдЪрд╛рд▓реВ рдХрд░реЗрдВред </p><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">OMV рдПрдХреНрд╕рдЯреНрд░рд╛ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА</a> рдЬреЛрдбрд╝реЗрдВред <br>  рдпрд╣ рдмрд╕ рдкреНрд▓рдЧрдЗрди рдпрд╛ рдкреИрдХреЗрдЬ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдордВрдЪ</a> рдкрд░ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><p>  <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдкреНрд▓рдЧрдЗрдиреНрд╕"</em> рдкреГрд╖реНрда рдкрд░ рдЖрдкрдХреЛ "рдУрдкрдирдореАрдбрд┐рдпрд╛рдореВрд▓реНрдЯ-рдСрд╕реНрд╡реЗрдХреНрд╕реНрдЯреНрд░рд╛рд╕реЙрд░реНрдЧ" рдкреНрд▓рдЧрдЗрди рдЦреЛрдЬрдиреЗ рдФрд░ рдЗрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рд╕рд┐рд╕реНрдЯрдо рдореЗрдиреВ рдореЗрдВ "рдУрдПрдорд╡реА-рдПрдХреНрд╕реНрдЯреНрд░рд╛" рдЖрдЗрдХрди рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛ (рдЗрд╕реЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)ред </p><br><p>  рд╡рд╣рд╛рдВ рдЬрд╛рдПрдВ рдФрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ: </p><br><ul><li>  OMV-Extras.orgред  рдПрдХ рд╕реНрдерд┐рд░ рднрдВрдбрд╛рд░ рдЬрд┐рд╕рдореЗрдВ рдХрдИ рдкреНрд▓рдЧрдЗрдиреНрд╕ рд╣реЛрддреЗ рд╣реИрдВред </li><li>  OMV-Extras.org рдЯреЗрд╕реНрдЯрд┐рдВрдЧред  рдЗрд╕ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рдХреБрдЫ рдкреНрд▓рдЧрдЗрдиреНрд╕ рд╕реНрдерд┐рд░ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рдирд╣реАрдВ рд╣реИрдВред </li><li>  рдбреЙрдХрд░ рд╕реАрдИред  рджрд░рдЕрд╕рд▓, рдбреЙрдХрд░ред </li></ul><br><p>  рдЯреИрдм рдкрд░ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; OMV рдПрдХреНрд╕рдЯреНрд░рд╛-&gt; рдХрд░реНрдиреЗрд▓"</em> рдЖрдк рдЕрдкрдиреА рдЬрд░реВрд░рдд рдХрд╛ рдХрд░реНрдиреЗрд▓ рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ Proxmox рд╕реЗ рдХрд░реНрдиреЗрд▓ рд╢рд╛рдорд┐рд▓ рд╣реИ (рдореИрдВрдиреЗ рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рдЗрдВрд╕реНрдЯреЙрд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдореБрдЭреЗ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдЕрднреА рддрдХ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдЗрд╕рдХреА рдЕрдиреБрд╢рдВрд╕рд╛ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реВрдВ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dq/se/jq/dqsejqlsyn0x6wdbyfeb2kvlwmc.png"></a> </p><br><p>  рдЖрд╡рд╢реНрдпрдХ рдкреНрд▓рдЧрдЗрдиреНрд╕ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ ( <em>рдЗрдЯреИрд▓рд┐рдХ рдореЗрдВ</em> <strong>рдмреЛрд▓реНрдб</strong> рдмрд┐рд▓реНрдХреБрд▓ рдЖрд╡рд╢реНрдпрдХ - рд╡реИрдХрд▓реНрдкрд┐рдХ, рдЬрд┐рд╕реЗ рдореИрдВрдиреЗ рдЗрдВрд╕реНрдЯреЙрд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ): </p><br><div class="spoiler">  <b class="spoiler_title">рдкреНрд▓рдЧрдЗрдиреНрд╕ рдХреА рд╕реВрдЪреАред</b> <div class="spoiler_text"><ul><li>  openmediavault-apttoolред  рдмреИрдЪ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдиреНрдпреВрдирддрдо рдЬреАрдпреВрдЖрдИред  <em>"рд╕реЗрд╡рд╛рдПрдБ-&gt; Apttool"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  openmediavault-anacronред  рдПрдХ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдЕрдиреБрд╕реВрдЪрдХ рдХреЗ рд╕рд╛рде рдЬреАрдпреВрдЖрдИ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдЬреЛрдбрд╝рддрд╛ рд╣реИред  <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдПрдирд╛рдХреНрд░реЙрди"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  openmediavault-рдмреИрдХрдЕрдкред  рднрдВрдбрд╛рд░рдг рдореЗрдВ рдмреИрдХрдЕрдк рдкреНрд░рдгрд╛рд▓реА рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рдПрдХ рдкреЗрдЬ рдЬреЛрдбрд╝рддрд╛ рд╣реИ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдмреИрдХрдЕрдк"</em> ред </li><li>  openmediavault-diskstatsред  рдбрд┐рд╕реНрдХ рдкреНрд░рджрд░реНрд╢рди рдкрд░ рдЖрдВрдХрдбрд╝реЗ рдПрдХрддреНрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </li><li>  <em>openmediavault-dnsmasq</em>  рдЖрдкрдХреЛ NAS рдкрд░ DNS рд╕рд░реНрд╡рд░ рдФрд░ DHCP рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдХреНрдпреЛрдВрдХрд┐ рдореИрдВ рдПрдХ рд░рд╛рдЙрдЯрд░ рдкрд░ рдРрд╕рд╛ рдХрд░рддрд╛ рд╣реВрдВ, рдореБрдЭреЗ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред </li><li>  <strong>openmediavault-docker-gui</strong> ред  рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдкреНрд░рдмрдВрдзрди рдЗрдВрдЯрд░рдлрд╝реЗрд╕ред  <em>"рд╕реЗрд╡рд╛-&gt; рдбреЙрдХрдЯрд░"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  <strong>openmediavault-ldap</strong>  LDAP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдердиред  <em>"рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рдмрдВрдзрди -&gt; рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗрд╡рд╛"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  <em>openmediavault-letencrypt</em> ред  GUI рд╕реЗ рдПрдирдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдердиред  рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдирдЧреНрдиреЗрдХреНрд╕-рд░рд┐рд╡рд░реНрд╕-рдкреНрд░реЙрдХреНрд╕реА рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдореНрдмреЗрдбрд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред </li><li>  <strong>openmediavault-luksenc рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди</strong> ред  LUKS рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рд╕рдорд░реНрдердиред  рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдбрд┐рд╕реНрдХ рдУрдПрдорд╡реА рдЗрдВрдЯрд░рдлреЗрд╕ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗред  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  <strong>openmediavault-nut</strong> ред  рдпреВрдкреАрдПрд╕ рдХрд╛ рд╕рдорд░реНрдердиред  <em>"</em> рд╕реЗрд╡рд╛- <em>&gt; рдпреВрдкреАрдПрд╕"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  <strong>openmediavault-omvextrasorg</strong>  рдУрдПрдорд╡реА рдПрдХреНрд╕рдЯреНрд░рд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред </li><li>  openmediavault-resetpermsред  рдЖрдкрдХреЛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░рдиреЗ рдФрд░ рд╕рд╛рдЭрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдкрд░ рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рд╕реВрдЪреА рд░реАрд╕реЗрдЯ рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред  <em>"рдкреНрд░рд╡реЗрд╢ рдирд┐рдпрдВрддреНрд░рдг -&gt; рд╕рд╛рдорд╛рдиреНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ -&gt; рд░реАрд╕реЗрдЯ рдЕрдиреБрдорддрд┐рдпрд╛рдБ"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  openmediavault рдорд╛рд░реНрдЧред  рд░реВрдЯрд┐рдВрдЧ рдкреНрд░рдмрдВрдзрди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рдкреНрд▓рдЧрдЗрдиред  <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдиреЗрдЯрд╡рд░реНрдХ-&gt; рд╕реНрдЯреЗрдЯрд┐рдХ рд░реВрдЯ"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  openmediavault-рд╕рд┐рдорд▓рд┐рдВрдХред  рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рдмрдирд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рдкреГрд╖реНрда рдХреЛ <em>"рд╕реЗрд╡рд╛-&gt; рдкреНрд░рддреАрдХ"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  openmediavault-unionfilesystemsред  UnionFS рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣ рднрд╡рд┐рд╖реНрдп рдореЗрдВ рдХрд╛рдо рдЖ рд╕рдХрддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдбреЙрдХрдЯрд░ рдПрдХ рдмреИрдХреЗрдВрдб рдХреЗ рд░реВрдк рдореЗрдВ ZFS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рд╕рдВрдШ рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо"</em> рдЬреЛрдбрд╝рддрд╛ рд╣реИред </li><li>  <em>openmediavault-virtualbox</em> ред  рдпрд╣ GUI рдореЗрдВ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдкреНрд░рдмрдВрдзрди рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдПрдореНрдмреЗрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </li><li>  <strong>openmediavault-zfs</strong> ред  рдкреНрд▓рдЧрдЗрди OpenMediaVault рдореЗрдВ ZFS рд╕рдорд░реНрдерди рдЬреЛрдбрд╝рддрд╛ рд╣реИред  рд╕реНрдерд╛рдкрдирд╛ рдХреЗ рдмрд╛рдж, <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; ZFS"</em> рдкреГрд╖реНрда рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛ред </li></ul></div></div><br><h3 id="diski">  рдбрд┐рд╕реНрдХ </h3><br><p>  рд╕рднреА рдбрд┐рд╕реНрдХ рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдУрдПрдорд╡реА рджрд┐рдЦрд╛рдИ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рдбрд┐рд╕реНрдХ" рдЯреИрдм</em> рдХреЛ рджреЗрдЦрдХрд░ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВред  рдпрджрд┐ рд╕рднреА рдбрд┐рд╕реНрдХ рджрд┐рдЦрд╛рдИ рдирд╣реАрдВ рджреЗ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рд╕реНрдХреИрди рдЪрд▓рд╛рдПрдВред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ju/i3/rs/jui3rsmgmatghluwuk0rknsqfrq.png" alt="рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдбрд┐рд╕реНрдХ"></a> </p><br><p>  рд╡рд╣рд╛рдВ, рд╕рднреА HDD рдкрд░, рд▓реЗрдЦрди рдХреИрд╢рд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рд╕реВрдЪреА рд╕реЗ рдбрд┐рд╕реНрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдФрд░ "рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ" рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ)ред </p><br><p>  рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд╕рднреА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдЕрдиреБрднрд╛рдЧ <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди" рдЯреИрдм</em> рдкрд░ рджрд┐рдЦрд╛рдИ рджреЗ рд░рд╣реЗ рд╣реИрдВ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dy/nw/kv/dynwkvuhbnglzeqe3sin_vqda7i.png" alt="рдЕрд▓рдЧ рдХрд┐рдП рдЧрдП рд╡рд┐рднрд╛рдЬрди"></a> </p><br><p>  рдЕрдм рдпрд╣ SMART рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ, рдЬреЛ рдмрдврд╝рддреА рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛ рдХреЗ рд╕рд╛рдзрди рдХреЗ рд░реВрдк рдореЗрдВ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: </p><br><ul><li>  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рд╕реНрдорд╛рд░реНрдЯ-&gt; рд╕реЗрдЯрд┐рдВрдЧреНрд╕" рдЯреИрдм рдкрд░ рдЬрд╛рдПрдВ</em> ред  рд╕реНрдорд╛рд░реНрдЯ рдЪрд╛рд▓реВ рдХрд░реЗрдВред </li><li>  рдЙрд╕реА рдЬрдЧрд╣ рдореЗрдВ, рдбрд┐рд╕реНрдХ рдХреЗ рддрд╛рдкрдорд╛рди рд╕реНрддрд░ (рдорд╣рддреНрд╡рдкреВрд░реНрдг, рдЖрдорддреМрд░ рдкрд░ 60 рд╕реА, рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбрд┐рд╕реНрдХ рдХрд╛ рдЗрд╖реНрдЯрддрдо рддрд╛рдкрдорд╛рди рд╢рд╛рд╕рди</a> 15-45 рд╕реА) рдХреЗ рдореВрд▓реНрдпреЛрдВ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред </li><li>  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рд╕реНрдорд╛рд░реНрдЯ-&gt; рдбрд┐рд╡рд╛рдЗрд╕" рдЯреИрдм рдкрд░ рдЬрд╛рдПрдВ</em> ред  рдкреНрд░рддреНрдпреЗрдХ рдбреНрд░рд╛рдЗрд╡ рдХреЗ рд▓рд┐рдП рдирд┐рдЧрд░рд╛рдиреА рдЪрд╛рд▓реВ рдХрд░реЗрдВред <br> <a href=""><img src="https://habrastorage.org/webt/83/r-/dc/83r-dcwtrhth5icaketuw1zlis8.png"></a> </li><li>  <em>"рд╕рдВрдЧреНрд░рд╣рдг-&gt; рд╕реНрдорд╛рд░реНрдЯ-&gt; рдЕрдиреБрд╕реВрдЪрд┐рдд рдкрд░реАрдХреНрд╖рдг" рдЯреИрдм рдкрд░ рдЬрд╛рдПрдВ</em> ред  рдкреНрд░рддреНрдпреЗрдХ рдбрд┐рд╕реНрдХ рдХреЗ рд▓рд┐рдП рджрд┐рди рдореЗрдВ рдПрдХ рдмрд╛рд░ рд▓рдШреБ рдЖрддреНрдо-рдкрд░реАрдХреНрд╖рдг рдФрд░ рдорд╣реАрдиреЗ рдореЗрдВ рдПрдХ рдмрд╛рд░ рдПрдХ рд▓рдВрдмрд╛ рдЖрддреНрдо-рдкрд░реАрдХреНрд╖рдг рдЬреЛрдбрд╝реЗрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рддрд╛рдХрд┐ рд╕реНрд╡-рдкрд░реАрдХреНрд╖рдг рдЕрд╡рдзрд┐ рдУрд╡рд░рд▓реИрдк рди рд╣реЛред <br> <a href=""><img src="https://habrastorage.org/webt/lh/u8/qf/lhu8qffcenb8utgcekfoy_j0oee.png"></a> </li></ul><br><p>  рдЗрд╕ рдкрд░, рдбрд┐рд╕реНрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкреВрд░реНрдг рдорд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><h3 id="faylovye-sistemy-i-obschie-katalogi">  рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдФрд░ рд╕рд╛рдЭрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ </h3><br><p>  рдЖрдкрдХреЛ рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛ред <br>  рдпрд╣ рдХрдВрд╕реЛрд▓ рд╕реЗ рдпрд╛ OMV WEB рдЗрдВрдЯрд░рдлреЗрд╕ ( <em>рд╕реНрдЯреЛрд░реЗрдЬ-&gt; ZFS-&gt; рд╕реЗрд▓реЗрдХреНрдЯ рдЯреИрдВрдХ рдЯреИрдВрдХ0-&gt; рдРрдб рдмрдЯрди -&gt; рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо</em> ) рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">FS рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрджреЗрд╢ рджреЗрддрд╛ рд╣реИред</b> <div class="spoiler_text"><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/books zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/music zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/pictures zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/downloads zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o compression=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/videos</code> </pre> </div></div><br><p>  рдкрд░рд┐рдгрд╛рдо рдирд┐рдореНрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕рдВрд░рдЪрдирд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ua/uy/yk/uauyykwki2nmmmpj6pe3-lqxrie.png"></a> </p><br><p>  рдЙрд╕рдХреЗ рдмрд╛рдж, <em>"рдПрдлрдПрд╕ рдПрдХреНрд╕реЗрд╕ рдореИрдиреЗрдЬрд┐рдВрдЧ рд░рд╛рдЗрдЯреНрд╕-&gt; рдЬрдирд░рд▓ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ-&gt; рдРрдб"</em> рдкреЗрдЬ рдкрд░ рд╕рд╛рдЭрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдмрдирд╛рдП рдЧрдП рдПрдлрдПрд╕ <em>рдЬреЛрдбрд╝реЗрдВ</em> ред <br>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ <em>"рдбрд┐рд╡рд╛рдЗрд╕"</em> рдкреИрд░рд╛рдореАрдЯрд░ ZFS рдореЗрдВ рдмрдирд╛рдИ рдЧрдИ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрде рдХреЗ рдмрд░рд╛рдмрд░ рд╣реИ, рдФрд░ рд╕рднреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП <em>"рдкрде"</em> рдкреИрд░рд╛рдореАрдЯрд░ "/" рд╣реИред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xc/9v/da/xc9vdaubqewzyhqfm80k_751fo8.png"></a> </p><br><h3 id="rezervnoe-kopirovanie">  рдмреИрдХрдЕрдк </h3><br><p>  рдмреИрдХрдЕрдк рджреЛ рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">OMV рдмреИрдХрдЕрдк рдкреНрд▓рдЧрдЗрди</a> ред  рд╕рд┐рд╕реНрдЯрдо рдмреИрдХрдЕрдк рдХреЗ рд▓рд┐рдП рдУрдПрдорд╡реА рдкреНрд▓рдЧрдЗрдиред </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">zfs- рдСрдЯреЛ-рд╕реНрдиреИрдкрд╢реЙрдЯ</a> ред  рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рд╢реЗрдбреНрдпреВрд▓ рдкрд░ ZFS рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛рдиреЗ рдФрд░ рдкреБрд░рд╛рдиреЗ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдПред </li></ul><br><p>  рдпрджрд┐ рдЖрдк рдкреНрд▓рдЧрдЗрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рддреНрд░реБрдЯрд┐ рдорд┐рд▓рддреА рд╣реИ: </p><br><pre> <code class="hljs vhdl">lsblk: /dev/<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> device</code> </pre> <br><p>  рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреИрд╕рд╛ рдХрд┐</a> рдЗрд╕ "рдмрд╣реБрдд рд╣реА рдЧреИрд░-рдорд╛рдирдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди" рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдУрдПрдорд╡реА рдбреЗрд╡рд▓рдкрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ</a> , рдпрд╣ рдкреНрд▓рдЧрдЗрди рдХреЛ рдордирд╛ рдХрд░рдирд╛ рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>zfs send/receive</code></a> рдХреЗ рд░реВрдк рдореЗрдВ ZFS рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред <br>  рдпрд╛, рднреМрддрд┐рдХ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдкреИрд░рд╛рдореАрдЯрд░ "рд░реВрдЯ рдбрд┐рд╡рд╛рдЗрд╕" рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░реЗрдВ, рдЬрд╣рд╛рдВ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br>  рдореЗрд░реЗ рд▓рд┐рдП рдкреНрд▓рдЧрдЗрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдФрд░ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╕реЗ рдУрдПрд╕ рдХрд╛ рдмреИрдХрдЕрдк рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ, рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХреБрдЫ рдХреЛ zfs рднреЗрдЬрдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдЗрд╕рд▓рд┐рдП рдореИрдВ рджреВрд╕рд░рд╛ рд╡рд┐рдХрд▓реНрдк рдкрд╕рдВрдж рдХрд░рддрд╛ рд╣реВрдВред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q8/hm/k9/q8hmk9guerk2it7d1xe4tuzvtak.png" alt="рдмреИрдХрдЕрдк"></a> </p><br><p>  рдмреИрдХрдЕрдк рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкрд╣рд▓реЗ <code>tank0/apps/backup</code> рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ ZFS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрдирд╛рдПрдВ, рдлрд┐рд░ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдмреИрдХрдЕрдк" рдореЗрдиреВ</em> рдореЗрдВ <em>"рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдлрд╝реЛрд▓реНрдбрд░"</em> рдкреИрд░рд╛рдореАрдЯрд░ рдлрд╝реАрд▓реНрдб рдореЗрдВ "+" <em>рдкрд░</em> рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдФрд░ рдмрдирд╛рдП рдЧрдП рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рд▓рдХреНрд╖реНрдп рдФрд░ <em>"рдкрде"</em> рдлрд╝реАрд▓реНрдб рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред "/" рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред </p><br><p>  Zfs-auto-snapshot рдХреЗ рд╕рд╛рде рднреА рд╕рдорд╕реНрдпрд╛рдПрдВ рд╣реИрдВред  рдпрджрд┐ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рд╡рд╣ рд╣рд░ рдШрдВрдЯреЗ, рд╣рд░ рджрд┐рди, рд╣рд░ рд╣рдлреНрддреЗ, рд╣рд░ рдорд╣реАрдиреЗ рдПрдХ рд╕рд╛рд▓ рдХреЗ рд▓рд┐рдП рддрд╕реНрд╡реАрд░реЗрдВ рд▓реЗрдЧрд╛ред <br>  рдкрд░рд┐рдгрд╛рдо рдпрд╣ рд╣реИ рдХрд┐ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рдХреНрдпрд╛ рд╣реИ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/af/_j/gw/af_jgw_evodbuhm07iqwpjh-he8.png" alt="Zfs- рдСрдЯреЛ-рд╕реНрдиреИрдкрд╢реЙрдЯ рд╕реЗ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╡рд┐рдЬреНрдЮрд╛рдкрди"></a> </p><br><p>  рдпрджрд┐ рдЖрдк рдкрд╣рд▓реЗ рд╣реА рдЗрд╕ рдкрд╛рд░ рдЖ рдЪреБрдХреЗ рд╣реИрдВ, рддреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕реНрдиреИрдкрд╢реЙрдЯ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрди рдХреЛрдб рдЪрд▓рд╛рдПрдБ: </p><br><pre> <code class="hljs powershell">zfs list <span class="hljs-literal"><span class="hljs-literal">-t</span></span> snapshot <span class="hljs-literal"><span class="hljs-literal">-o</span></span> name <span class="hljs-literal"><span class="hljs-literal">-S</span></span> creation | grep <span class="hljs-string"><span class="hljs-string">"@zfs-auto-snap"</span></span> | tail <span class="hljs-literal"><span class="hljs-literal">-n</span></span> +<span class="hljs-number"><span class="hljs-number">1500</span></span> | xargs <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> zfs destroy <span class="hljs-literal"><span class="hljs-literal">-vr</span></span></code> </pre> <br><p>  рдлрд┐рд░ рдХреНрд░реЛрди рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП zfs-auto-snapshot рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред <br>  рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдкрдХреЛ рд╣рд░ рдШрдВрдЯреЗ рдЪрд┐рддреНрд░ рд▓реЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдмрд╕ <code>/etc/cron.hourly/zfs-auto-snapshot</code> рд╣рдЯрд╛рдПрдВред </p><br><h3 id="e-mail-uvedomleniya">  рдИрдореЗрд▓ рд╕реВрдЪрдирд╛рдПрдВ </h3><br><p>  рдИ-рдореЗрд▓ рджреНрд╡рд╛рд░рд╛ рдЕрдзрд┐рд╕реВрдЪрдирд╛ рдХреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд╕рд╛рдзрдиреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЗрдВрдЧрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред <br>  рдЗрд╕рд▓рд┐рдП, рдЕрдм рдЖрдкрдХреЛ рдИрдореЗрд▓ рдЕрдзрд┐рд╕реВрдЪрдирд╛ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br>  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд╕рд░реНрд╡рд░реЛрдВ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ рдкрд░ рдПрдХ рдмреЙрдХреНрд╕ рдХреЛ рдкрдВрдЬреАрдХреГрдд рдХрд░реЗрдВ (рдпрджрд┐ рдЖрдк рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрд╕рдПрдордЯреАрдкреА рд╕рд░реНрд╡рд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕рдХреЗ рдХрд╛рд░рдг рд╣реИрдВ)ред </p><br><p>  рдлрд┐рд░ рдЖрдкрдХреЛ <em>"рд╕рд┐рд╕реНрдЯрдо-&gt; рдЕрдзрд┐рд╕реВрдЪрдирд╛"</em> рдкреГрд╖реНрда рдкрд░ рдЬрд╛рдиреЗ рдФрд░ рджрд░реНрдЬ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><ul><li>  SMTP рд╕рд░реНрд╡рд░ рдкрддрд╛ред </li><li>  SMTP рд╕рд░реНрд╡рд░ рдкреЛрд░реНрдЯред </li><li>  рдкреНрд░рдпреЛрдХреНрддрд╛ рдирд╛рдоред </li><li>  рдкреНрд░реЗрд╖рдХ рдкрддрд╛ (рдЖрдорддреМрд░ рдкрд░ рдкрддреЗ рдХрд╛ рдкрд╣рд▓рд╛ рдШрдЯрдХ рдирд╛рдо рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ)ред </li><li>  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб </li><li>  "рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛" рдлрд╝реАрд▓реНрдб рдореЗрдВ, рдЖрдкрдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рдкрддрд╛ рдЬрд┐рд╕ рдкрд░ NAS рд╕реВрдЪрдирд╛рдПрдВ рднреЗрдЬреЗрдЧрд╛ред </li></ul><br><p>  рдПрд╕рдПрд╕рдПрд▓ / рдЯреАрдПрд▓рдПрд╕ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЕрддреНрдпрдзрд┐рдХ рдЙрдЪрд┐рдд рд╣реИред </p><br><p>  рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рдпреИрдВрдбреЗрдХреНрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╕реЗрдЯрдЕрдк рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/4j/pb/2m/4jpb2mwgystnu_3yc9vf9l16soo.png" alt="рдИрдореЗрд▓ рд╕реВрдЪрдирд╛"></a> </p><br><h2 id="nastroyka-seti-vne-nas">  NAS рдХреЗ рдмрд╛рд╣рд░ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрдЯрдЕрдк </h2><br><h3 id="ip-adres">  рдЖрдИрдкреА тАЛтАЛрдПрдбреНрд░реЗрд╕ </h3><br><p>  рдореИрдВ рдПрдХ рд╕рдлреЗрдж рд╕реНрдерд┐рд░ рдЖрдИрдкреА рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рдЬрд┐рд╕рдХреА рд▓рд╛рдЧрдд рдкреНрд░рддрд┐ рдорд╛рд╣ 100 рд░реВрдмрд▓ рд╣реИред  рдпрджрд┐ рднреБрдЧрддрд╛рди рдХрд░рдиреЗ рдХреА рдХреЛрдИ рдЗрдЪреНрдЫрд╛ рдирд╣реАрдВ рд╣реИ рдФрд░ рдЖрдкрдХрд╛ рдкрддрд╛ рдЧрддрд┐рд╢реАрд▓ рд╣реИ, рд▓реЗрдХрд┐рди NAT рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ, рддреЛ рдЪрдпрдирд┐рдд рд╕реЗрд╡рд╛ рдХреЗ рдПрдкреАрдЖрдИ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрд╛рд╣рд░реА DNS рд░рд┐рдХреЙрд░реНрдб рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред <br>  рдлрд┐рд░ рднреА, рдпрд╣ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдПрдХ рдЧреИрд░-рдПрдирдПрдЯреА рдкрддрд╛ рдЕрдЪрд╛рдирдХ рдПрдирдПрдЯреА рдкрддрд╛ рдмрди рд╕рдХрддрд╛ рд╣реИ: рдПрдХ рдирд┐рдпрдо рдХреЗ рд░реВрдк рдореЗрдВ, рдкреНрд░рджрд╛рддрд╛ рдХреЛрдИ рдЧрд╛рд░рдВрдЯреА рдирд╣реАрдВ рджреЗрддреЗ рд╣реИрдВред </p><br><h3 id="router">  рд░реВрдЯрд░ </h3><br><p>  рд░рд╛рдЙрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ, рдореЗрд░реЗ рдкрд╛рд╕ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдорд┐рдХрд░реЛрдЯрд┐рдХ рд░рд╛рдЙрдЯрд░рдмреЛрд░реНрдб рд╣реИ</a> , рдЬреЛ рдиреАрдЪреЗ рджреА рдЧрдИ рддрд╕реНрд╡реАрд░ рдореЗрдВ рдПрдХ рдХреЗ рд╕рдорд╛рди рд╣реИред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ni/mv/a8/nimva8ju1vg2doqcnwd7s0_xcmw.jpeg" alt="рдорд╛рдпрд░реЛрдЯрд┐рдХ рд░рд╛рдЙрдЯрд░рдмреЛрд░реНрдб"></a> </p><br><p>  рд░рд╛рдЙрдЯрд░ рдкрд░ рддреАрди рдЪреАрдЬреЗрдВ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ: </p><br><ul><li>  NAS рдХреЗ рд▓рд┐рдП рд╕реНрдереИрддрд┐рдХ рдкрддреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред  рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдкрддреЗ рдбреАрдПрдЪрд╕реАрдкреА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рд░реА рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдФрд░ рдореБрдЭреЗ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдореИрдХ рдкрддреЗ рд╡рд╛рд▓реЗ рдПрдбреЗрдкреНрдЯрд░ рдХреЛ рд╣рдореЗрд╢рд╛ рдПрдХ рд╣реА рдЖрдИрдкреА рдкрддрд╛ рдорд┐рд▓рддрд╛ рд╣реИред  рд░рд╛рдЙрдЯрд░рдУрдПрд╕ рдореЗрдВ, рдпрд╣ <em>"рдЖрдИрдкреА-&gt; рдбреАрдПрдЪрд╕реАрдкреА рд╕рд░реНрд╡рд░" рдЯреИрдм</em> рдкрд░ <em>"рдореЗрдХ рд╕реНрдЯреИрдЯрд┐рдХ"</em> рдмрдЯрди рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </li><li>  DNS рд╕рд░реНрд╡рд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ рддрд╛рдХрд┐ "nas" рдирд╛рдо рдХреЗ рд╕рд╛рде-рд╕рд╛рде ".nas" рдФрд░ ".NAS.cloudns.cc" рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдирд╛рдо (рдЬрд╣рд╛рдВ "NAS" ClouDNS рдпрд╛ рдЗрд╕реА рддрд░рд╣ рдХреА рд╕реЗрд╡рд╛ рдкрд░ рдЬрд╝реЛрди рд╣реИ) рдпрд╣ IP рд╕рд┐рд╕реНрдЯрдо рджреЗрддрд╛ рд╣реИред  RouterOS рдореЗрдВ рдпрд╣ рдХрд╣рд╛рдБ рдХрд░рдирд╛ рд╣реИ, рдиреАрдЪреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдПрдХ рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд╕рд╛рде рдирд╛рдо рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рджреНрд╡рд╛рд░рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: " <code>^.*\.nas$|^nas$|^.*\.NAS.cloudns.cc$</code> "ред </li><li>  рдкреЛрд░реНрдЯ рдлрд╝реЙрд░рд╡рд░реНрдбрд┐рдВрдЧ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред  рд░рд╛рдЙрдЯрд░рдУрдПрд╕ рдореЗрдВ, рдпрд╣ <em>"рдЖрдИрдкреА-&gt; рдлрд╝рд╛рдпрд░рд╡реЙрд▓" рдЯреИрдм</em> рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдореИрдВ рдЗрд╕ рдкрд░ рдЖрдЧреЗ рдирд╣реАрдВ рд░рд╣реВрдВрдЧрд╛ред </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/wu/2d/3n/wu2d3ng2xlqaleslb__9a72vtpo.png" alt="рд░рд╛рдЙрдЯрд░рдУрдПрд╕ рдбреАрдПрдирдПрд╕ рд▓реЙрдЧрд┐рди рдореЗрдВ"></a> </p><br><h3 id="cloudns">  ClouDNS </h3><br><p>  CLUDNS рд╕рд░рд▓ рд╣реИред  рдПрдХ рдЦрд╛рддрд╛ рдмрдирд╛рдПрдБ, рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВред  рдЖрдкрдХреЗ рд╕рд╛рде рдПрдирдПрд╕ рд░рд┐рдХреЙрд░реНрдб рдкрд╣рд▓реЗ рд╣реА рдкрдВрдЬреАрдХреГрдд рд╣реЛ рдЬрд╛рдПрдЧрд╛ред  рдЕрдЧрд▓рд╛, рдиреНрдпреВрдирддрдо рд╕реЗрдЯрдЕрдк рдЖрд╡рд╢реНрдпрдХ рд╣реИред </p><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рдЖрд╡рд╢реНрдпрдХ рдЬрд╝реЛрди рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдПрдирдПрдПрд╕ рдирд╛рдо рдХреЗ рд╕рд╛рде рдЬрд╝реЛрди рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рд▓рд╛рд▓ рд░рдВрдЧ рдореЗрдВ рд╣рд╛рдЗрд▓рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдПрдХ рдЕрд▓рдЧ рдирд╛рдо рдХреЗ рд╕рд╛рде рдмрдирд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ)ред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/3k/0u/wj3k0ueaouj9tdslhubqtdz49os.png" alt="ClouDNS рдореЗрдВ рдПрдХ рдЬрд╝реЛрди рдмрдирд╛рдирд╛"></a> </p><br><p>  рджреВрд╕рд░реЗ, рдЗрд╕ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдП-рд░рд┐рдХреЙрд░реНрдб</a> рджрд░реНрдЬ рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП: </p><br><ul><li>  <strong>nas</strong> , <strong>www</strong> , <strong>omv</strong> , <strong>control</strong> рдФрд░ рдПрдХ <strong>рдЦрд╛рд▓реА рдирд╛рдо</strong> ред  OMV рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред </li><li>  <strong>ldap</strong>  PhpLdapAdmin рдЗрдВрдЯрд░рдлрд╝реЗрд╕ </li><li>  <strong>рдПрд╕ рдкреА рдПрд╕</strong> ред  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░рдлрд╝реЗрд╕ред </li><li>  <strong>рдкрд░реАрдХреНрд╖рдг</strong> ред  рдЯреЗрд╕реНрдЯ рд╕рд░реНрд╡рд░ред </li></ul><br><p>  рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЬреЛрдбрд╝рддреЗ рд╣реА рд╢реЗрд╖ рдбреЛрдореЗрди рдирд╛рдо рдЬреБрдбрд╝ рдЬрд╛рдПрдВрдЧреЗред <br>  рдЬрд╝реЛрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ, рдлрд┐рд░ <em>"рдирдпрд╛ рд░рд┐рдХреЙрд░реНрдб рдЬреЛрдбрд╝реЗрдВ"</em> , рдП-рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗрдВ, рдЬрд╝реЛрди рдХрд╛ рдирд╛рдо рдФрд░ рд░рд╛рдЙрдЯрд░ рдХрд╛ рдЖрдИрдкреА рдкрддрд╛ рджрд░реНрдЬ рдХрд░реЗрдВ рдЬрд┐рд╕рдХреЗ рдкреАрдЫреЗ рдПрдирдПрдПрд╕ рд╣реИред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ym/9o/s2/ym9os2upazemboftovtmasp3h1u.png" alt="рдПрдХ рд░рд┐рдХреЙрд░реНрдб рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛"></a> </p><br><p>  рджреВрд╕рд░реЗ, рдЖрдкрдХреЛ рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  ClouDNS рдореЗрдВ рдЗрд╕рдХрд╛ рднреБрдЧрддрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ рднреБрдЧрддрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдЕрдиреНрдп рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ, рдпрд╣ рдореБрдлрд╝реНрдд рд╣реИред  рдпрджрд┐ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕рд╛ рдмреЗрд╣рддрд░ рд╣реИ, рдФрд░ рдпрд╣ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓реЗрдХреНрд╕рд┐рдХрди</a> рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╣реИ, рддреЛ рдХреГрдкрдпрд╛ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдореЗрдВ рд▓рд┐рдЦреЗрдВред </p><br><p>  рдПрдкреАрдЖрдИ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЖрдкрдХреЛ рд╡рд╣рд╛рдБ рдПрдХ рдирдпрд╛ рдПрдкреАрдЖрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ah/tc/rp/ahtcrpidjt3gvlnuc-udwjj0no8.png" alt="ClouDNS рдПрдкреАрдЖрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛрдбрд╝рдирд╛"></a> </p><br><p>   <em>"IP address"</em>   IP :  ,     API.  ,    ,    API,   <strong>auth-id</strong>  <strong>auth-password</strong> .      Lexicon,  . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/z_/6k/yv/z_6kyvkyj9gqlbi_s-dudfoirzs.png"></a> </p><br><p>    ClouDNS . </p><br><h2>   </h2><br><h3 id="nastroyka-docker">  Docker </h3><br><p>     openmediavault-docker-gui,  docker-ce      . </p><br><p> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">docker-compose</a> ,         : </p><br><pre> <code class="bash hljs">apt-get install docker-compose</code> </pre> <br><p>       : </p><br><pre> <code class="bash hljs">zfs create -p /tank0/docker/services</code> </pre> <br><p>  ,       <code>/var/lib/docker</code> .     ( ,   SSD),  ,  ,         . </p><br><p> ..,              <br>   .   . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wn/by/ec/wnbyecyxrlrsf0cssx78zqmoxdu.png"></a> </p><br><p>   ,         . <br>       ,      GUI ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">    </a> , ..       ,     . </p><br><p>        <code>/var/lib</code>   : </p><br><pre> <code class="bash hljs">service docker stop zfs create -o com.sun:auto-snapshot=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -p /tank0/docker/lib rm -rf /var/lib/docker ln -s /tank0/docker/lib /var/lib/docker service docker start</code> </pre> <br><p>  : </p><br><pre> <code class="bash hljs">$ ls -l /var/lib/docker lrwxrwxrwx 1 root root 17 Apr 7 12:35 /var/lib/docker -&gt; /tank0/docker/lib</code> </pre> <br><p>     : </p><br><pre> <code class="bash hljs">docker network create docker0</code> </pre> <br><p>     Docker       . </p><br><h3 id="nastroyka-konteynera-s-nginx-reverse-proxy">    nginx-reverse-proxy </h3><br><p>    Docker ,     . </p><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a> ,   . </p><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">nginx-proxy</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">letsencrypt-dns</a> . </p><br><p> ,    OMV    10080  10443,        80  443. </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-proxy: networks: - docker0 restart: always image: jwilder/nginx-proxy ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:ro - ./vhost.d:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/vhost.d - ./html:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>share/nginx/html - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>docker.sock:ro - ./local-config:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/conf.d - ./nginx.tmpl:<span class="hljs-regexp"><span class="hljs-regexp">/app/</span></span>nginx.tmpl labels: - <span class="hljs-string"><span class="hljs-string">"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"</span></span> letsencrypt-dns: image: adferrand/letsencrypt-dns volumes: - ./certs/letsencrypt:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>letsencrypt environment: - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER=cloudns"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_OPTIONS=--delegated NAS.cloudns.cc"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD"</span></span></code> </pre> </div></div><br><p>      : </p><br><ul><li> nginx-reverse-proxy тАФ c  . </li><li> letsencrypt-dns тАФ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">ACME </a> Let's Encrypt. </li></ul><br><p>       nginx-reverse-proxy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">jwilder/nginx-proxy</a> . </p><br><p> <code>docker0</code> тАФ  ,    ,    docker-compose. <br> <code>nginx-proxy</code> тАФ   ,  .     docker0.  ,  80  443   ports      (,       ,           docker0,   ). <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>restart: always</code></a> ,       . </p><br><p> : </p><br><ul><li>   <strong><code>certs</code></strong>   <strong><code>/etc/nginx/certs</code></strong> тАФ   ,  ,   Let's Encrypt.           ACME . </li><li> <code>./vhost.d:/etc/nginx/vhost.d</code> тАФ    .   . </li><li> <code>./html:/usr/share/nginx/html</code> тАФ  .     . </li><li> <strong><code>/var/run/docker.sock</code></strong> ,   <strong><code>/tmp/docker.sock</code></strong> тАФ      Docker  .    docker-gen   . </li><li> <strong><code>./local-config</code></strong> ,   <strong><code>/etc/nginx/conf.d</code></strong> тАФ    nginx.    ,   . </li><li> <strong><code>./nginx.tmpl</code></strong> ,   <strong><code>/app/nginx.tmpl</code></strong> тАФ     nginx,   docker-gen  . </li></ul><br><p>  letsencrypt-dns    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">adferrand/letsencrypt-dns</a> .     ACME   Lexicon,     DNS . </p><br><p>   <code>certs/letsencrypt</code>   <code>/etc/letsencrypt</code>  . </p><br><p>   ,        : </p><br><ul><li> <strong><code>LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM</code></strong> тАФ   Let's Encrypt.     ,      . </li><li> <strong><code>LEXICON_PROVIDER=cloudns</code></strong> тАФ   Lexicon.    тАФ <code>cloudns</code> . </li><li> <strong><code>LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD --delegated=NAS.cloudns.cc</code></strong> тАФ CLOUDNS_ID        ClouDNS  . CLOUDNS_PASSWORD тАФ  ,      API. NAS.cloudns.cc,  NAS тАФ   DNS .  cloudns  ,          (cloudns.cc),  ClouDNS API     . </li></ul><br><p>        :      . <br>  ,      ,   ,     ,    Let's encrypt: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls ./certs/letsencrypt/ accounts archive csr domains.conf keys live renewal renewal<span class="hljs-literal"><span class="hljs-literal">-hooks</span></span></code> </pre> <br><p>  ,      ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/nginx.tmpl</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">{{ <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer := where <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"ID"</span></span> .<span class="hljs-type"><span class="hljs-type">Docker</span></span>.<span class="hljs-type"><span class="hljs-type">CurrentContainerID</span></span> | first }} {{ define <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Address</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> we got the containers from swarm and this container<span class="hljs-string"><span class="hljs-string">'s port is published to host, use host IP:PORT */}} {{ if and .Container.Node.ID .Address.HostPort }} # {{ .Container.Node.Name }}/{{ .Container.Name }} server {{ .Container.Node.Address.IP }}:{{ .Address.HostPort }}; {{/* If there is no swarm node or the port is not published on host, use container'</span></span>s <span class="hljs-type"><span class="hljs-type">IP</span></span>:<span class="hljs-type"><span class="hljs-type">PORT</span></span> */}} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }}:{{ .<span class="hljs-type"><span class="hljs-type">Address</span></span>.<span class="hljs-type"><span class="hljs-type">Port</span></span> }}; {{ end }} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} down; {{ else }} server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span>, pass it through; otherwise, pass along the # scheme used to connect to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span>, pass it through; otherwise, pass along the # server port the client connected to map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_port; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">Upgrade</span></span>, set <span class="hljs-type"><span class="hljs-type">Connection</span></span> to <span class="hljs-comment"><span class="hljs-comment">"upgrade"</span></span>; otherwise, delete any # <span class="hljs-type"><span class="hljs-type">Connection</span></span> header that may have been passed to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection { default upgrade; <span class="hljs-string"><span class="hljs-string">''</span></span> close; } # <span class="hljs-type"><span class="hljs-type">Apply</span></span> fix for very long server names server_names_hash_bucket_size <span class="hljs-number"><span class="hljs-number">128</span></span>; # <span class="hljs-type"><span class="hljs-type">Default</span></span> dhparam {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/dhparam/dhparam.pem"</span></span>) }} ssl_dhparam /etc/nginx/dhparam/dhparam.pem; {{ end }} # <span class="hljs-type"><span class="hljs-type">Set</span></span> appropriate <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> header map <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl { default off; https on; } gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; log_format vhost <span class="hljs-string"><span class="hljs-string">'$host $remote_addr - $remote_user [$time_local] '</span></span> <span class="hljs-string"><span class="hljs-string">'"$request" $status $body_bytes_sent '</span></span> <span class="hljs-string"><span class="hljs-string">'"$http_referer" "$http_user_agent"'</span></span>; access_log off; {{ if <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }} resolver {{ <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }}; {{ end }} {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/proxy.conf"</span></span>) }} include /etc/nginx/proxy.conf; {{ else }} # <span class="hljs-type"><span class="hljs-type">HTTP</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header <span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_host; proxy_set_header <span class="hljs-type"><span class="hljs-type">Upgrade</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade; proxy_set_header <span class="hljs-type"><span class="hljs-type">Connection</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Real</span></span>-<span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>emote_addr; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">For</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_add_x_forwarded_for; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port; # <span class="hljs-type"><span class="hljs-type">Mitigate</span></span> httpoxy attack (see <span class="hljs-type"><span class="hljs-type">README</span></span> for details) proxy_set_header <span class="hljs-type"><span class="hljs-type">Proxy</span></span> <span class="hljs-comment"><span class="hljs-comment">""</span></span>; {{ end }} {{ <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 := eq (or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">ENABLE_IPV6</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; } {{ if (and (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; ssl_session_tickets off; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ range <span class="hljs-string"><span class="hljs-string">$h</span></span>ost, <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers := groupByMulti <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_HOST"</span></span> <span class="hljs-comment"><span class="hljs-comment">","</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost := trim <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp := hasPrefix <span class="hljs-comment"><span class="hljs-comment">"~"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name := when <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp (sha1 <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} # {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} upstream {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }} { {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen := len <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork := <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"ingress"</span></span>) (or (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span>) (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"host"</span></span>))) }} ## <span class="hljs-type"><span class="hljs-type">Can</span></span> be connected with <span class="hljs-comment"><span class="hljs-comment">"{{ $containerNetwork.Name }}"</span></span> network {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> only <span class="hljs-number"><span class="hljs-number">1</span></span> port exposed, use that */}} {{ if eq <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen <span class="hljs-number"><span class="hljs-number">1</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := index <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> more than one port exposed, use the one matching <span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> env var, falling back to standard web port <span class="hljs-number"><span class="hljs-number">80</span></span> */}} {{ else }} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>ort := coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> <span class="hljs-comment"><span class="hljs-comment">"80"</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := where <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-comment"><span class="hljs-comment">"Port"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ort | first }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{ end }} {{ else }} # <span class="hljs-type"><span class="hljs-type">Cannot</span></span> connect to network of this container server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} {{ end }} } {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host := or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">DEFAULT_HOST</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server := index (dict <span class="hljs-string"><span class="hljs-string">$h</span></span>ost <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host <span class="hljs-comment"><span class="hljs-comment">"default_server"</span></span>) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_PROTO</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"http"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>roto := trim (or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_PROTO"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"http"</span></span>) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">NETWORK_ACCESS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.NETWORK_ACCESS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HTTPS_METHOD</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HTTPS_METHOD"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">SSL_POLICY</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.SSL_POLICY"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HSTS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>sts := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HSTS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_ROOT</span></span> <span class="hljs-type"><span class="hljs-type">By</span></span> containers w/ use fastcgi root */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_ROOT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"/var/www/public"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the first cert name defined by containers w/ the same vhost */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName := (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.CERT_NAME"</span></span>)) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the best matching cert by name for the vhost. */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := (closest (dir <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs"</span></span>) (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost))}} {{/* vhostCert is actually a filename so remove any suffixes since they are added later */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".crt"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".key"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{/* <span class="hljs-type"><span class="hljs-type">Use</span></span> the cert specified on the container or fallback to the best vhost match */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ert := (coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert) }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https := (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"nohttps"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ert <span class="hljs-comment"><span class="hljs-comment">""</span></span>) (or (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)))) ) }} {{ if <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https }} {{ if eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-string"><span class="hljs-string">$h</span></span>ost<span class="hljs-string"><span class="hljs-string">$r</span></span>equest_uri; } {{ end }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Modern"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Old"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">SSLv3</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-2-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:AES128-GCM-SHA256:AES128-SHA256:AES256-GCM-SHA384:AES256-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-1-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2016-08"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-05"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-03"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-02"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA'</span></span>; {{ end }} ssl_prefer_server_ciphers on; ssl_session_timeout <span class="hljs-number"><span class="hljs-number">5</span></span>m; ssl_session_cache shared:<span class="hljs-type"><span class="hljs-type">SSL</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>m; ssl_session_tickets off; {{ if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ else if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_dhparam {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>sts <span class="hljs-comment"><span class="hljs-comment">"off"</span></span>)) }} add_header <span class="hljs-type"><span class="hljs-type">Strict</span></span>-<span class="hljs-type"><span class="hljs-type">Transport</span></span>-<span class="hljs-type"><span class="hljs-type">Security</span></span> <span class="hljs-comment"><span class="hljs-comment">"{{ trim $hsts }}"</span></span> always; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ end }} {{ if or (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ if (and (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">500</span></span>; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ end }} {{ end }}</code> </pre> </div></div><br><p> ,    nginx     <code>/etc/nginx/certs/%s.crt</code>  <code>/etc/nginx/certs/%s.pem</code> ,  %s тАФ   (  тАФ  ,      ). </p><br><p>        <code>/etc/nginx/certs/letsencrypt/live/%s/{fullchain.pem, privkey.pem}</code> ,            : </p><br><pre> <code class="hljs perl">{{ $is_https := (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $https_method <span class="hljs-string"><span class="hljs-string">"nohttps"</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $cert <span class="hljs-string"><span class="hljs-string">""</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> $cert)) ) (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.crt"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.key"</span></span> $cert)) ) ) ) }}</code> </pre> <br><p>    ,        <code>domains.conf</code> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/certs/letsencrypt/domains.conf</b> <div class="spoiler_text"><pre> <code class="hljs css">*<span class="hljs-selector-class"><span class="hljs-selector-class">.NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span></code> </pre> </div></div><br><p>     .  ,           ,     ,     <code>client_max_body_size</code>     20,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/local-config/max_upload_size.conf</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">20G</span></span>;</code> </pre> </div></div><br><p>  ,   : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up</code> </pre> <br><p>   (   ),  Ctrl+C        : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up <span class="hljs-literal"><span class="hljs-literal">-d</span></span></code> </pre> <br><h3 id="nastroyka-konteynera-s-testovym-serverom">      </h3><br><p>   тАФ   nginx,     . ,       ,     . <br>       ,      NAS. </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a> . </p><br><p>   docker-compose : </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/test_nginx/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: nginx-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> image: nginx:alpine expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span> environment: - "VIRTUAL_HOST=test.NAS.cloudns.cc" - "VIRTUAL_PROTO=http" - "VIRTUAL_PORT=80" - CERT_NAME=NAS.cloudns.cc networks: - docker0</code> </pre> </div></div><br><p>        : </p><br><ul><li> <code>docker0</code> тАФ  .    . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>expose</code></a> тАФ    ,   .  ,  80   HTTP  443   HTTPS. </li><li> <code>VIRTUAL_HOST=test.NAS.cloudns.cc</code> тАФ      ,   nginx-reverse-proxy      . </li><li> <code>VIRTUAL_PROTO=http</code> тАФ    nginx-reverse-proxy     .   ,  HTTP. </li><li> <code>VIRTUAL_PORT=80</code> тАФ      nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> тАФ   .   ,     ,    . NAS тАФ  DNS . </li><li> <code>networks</code> тАФ      ,    nginx-reverse-proxy     <code>docker0</code> . </li></ul><br><p>  ,    .  <code>docker-compose up</code> ,    <code>test.NAS.cloudns.cc</code> . </p><br><p>       : </p><br><pre> <code class="bash hljs">$ docker-compose up Creating testnginx_nginx-local_1 Attaching to testnginx_nginx-local_1 nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 612 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537"</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.2.3"</span></span> nginx-local_1 | 2018/07/29 15:32:02 [error] 8<span class="hljs-comment"><span class="hljs-comment">#8: *2 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.22.0.5, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "test.NAS.cloudns.cc", referrer: "https://test.NAS.cloudns.cc/" nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] "GET /favicon.ico HTTP/1.1" 404 572 "https://test.NAS.cloudns.cc/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537" "192.168.2.3"</span></span></code> </pre> <br><p>     : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/-v/q3/wj-vq3xwns34rsn_tr8zvycwiei.png" alt="рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ Nginx"></a> </p><br><p> ,  ,    ,    ,   :     . </p><br><p>      ,   Ctrl+C,   <code>docker-compose down</code> . </p><br><h3 id="nastroyka-konteynera-s-local-rpoxy">    local-rpoxy </h3><br><p>   ,      nginx-default  ,     nas, omv        10080  10443   . </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-local: restart: always image: nginx:alpine expose: - 80 - 443 environment: - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=NAS.cloudns.cc,nas,nas.*,www.*,omv.*,nas-controller.nas"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PROTO=http"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PORT=80"</span></span> - CERT_NAME=NAS.cloudns.cc volumes: - ./<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-config:/etc/nginx/conf.d networks: - docker0</code> </pre> </div></div><br><p>   docker-compose    ,        . <br> ,   ,  ,     <code>NAS.cloudns.cc</code> .    ,     NAS    DNS ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/local-config/default.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the # scheme used to connect to this server map $http_x_forwarded_proto $proxy_x_forwarded_proto { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> $scheme; } # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the # server port the client connected to map $http_x_forwarded_port $proxy_x_forwarded_port { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> $server_port; } # Set appropriate X-Forwarded-Ssl header map $scheme $proxy_x_forwarded_ssl { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> off; https on; } access_log on; error_log on; # HTTP <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto; proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl; proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port; # Mitigate httpoxy attack (see README <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details) proxy_set_header Proxy <span class="hljs-string"><span class="hljs-string">""</span></span>; server { server_name _; # This is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span>; } server { server_name www.* nas.* omv.* <span class="hljs-string"><span class="hljs-string">""</span></span>; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; location / { proxy_pass https:<span class="hljs-comment"><span class="hljs-comment">//172.21.0.1:10443/; } } # nas-controller server { server_name nas-controller.nas; listen 80 ; location / { proxy_pass https://nas-controller/; } }</span></span></code> </pre> </div></div><br><ul><li> <code>172.21.0.1</code> тАФ  .       443,        OMV   HTTPS.        . </li><li> <code>https://nas-controller/</code> тАФ -,      IPMI,     nas,   nas-controller.nas,       nas-controller.   . </li></ul><br><h2>    LDAP </h2><br><h3 id="nastroyka-ldap-servera">  LDAP- </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">LDAP-</a> тАФ      . <br>     Docker .  ,  ,       . </p><br><p>    LDIF-  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/ldap/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: "2" networks: ldap: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap: image: "osixia/openldap:1.2.0" hostname: "open-ldap" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: - "LDAP_ORGANISATION=NAS" - "LDAP_DOMAIN=nas.nas" - "LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD" - "LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD" - "LDAP_TLS=true" - "LDAP_TLS_ENFORCE=false" - "LDAP_TLS_CRT_FILENAME=ldap_server.crt" - "LDAP_TLS_KEY_FILENAME=ldap_server.key" - "LDAP_TLS_CA_CRT_FILENAME=ldap_server.crt" volumes: - ./certs:/container/service/slapd/assets/certs - ./ldap_data/var/lib:/var/lib/ldap - ./ldap_data/etc/ldap/slapd.d:/etc/ldap/slapd.d networks: - ldap ports: - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span> - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>::<span class="hljs-number"><span class="hljs-number">636</span></span>:<span class="hljs-number"><span class="hljs-number">636</span></span> phpldapadmin: image: "osixia/phpldapadmin:0.7.1" hostname: "nas.nas" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">443</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> volumes: - ./certs:/container/service/phpldapadmin/assets/apache2/certs environment: - VIRTUAL_HOST=ldap.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">443</span></span> - VIRTUAL_PROTO=https - CERT_NAME=NAS.cloudns.cc - "PHPLDAPADMIN_LDAP_HOSTS=open-ldap-server" #- "PHPLDAPADMIN_HTTPS=false" - "PHPLDAPADMIN_HTTPS_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_HTTPS_KEY_FILENAME=private/ldap_server.key" - "PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=allow" ldap-ssp: image: openfrontier/ldap-ssp:https volumes: #- ./ssp/mods-enabled/ssl.conf:/etc/apache2/mods-enabled/ssl.conf - /etc/ssl/certs/ssl-cert-snakeoil.pem:/etc/ssl/certs/ssl-cert-snakeoil.pem - /etc/ssl/private/ssl-cert-snakeoil.key:/etc/ssl/private/ssl-cert-snakeoil.key <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> environment: - VIRTUAL_HOST=ssp.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">80</span></span> - VIRTUAL_PROTO=http - CERT_NAME=NAS.cloudns.cc - "LDAP_URL=ldap://open-ldap-server:389" - "LDAP_BINDDN=cn=admin,dc=nas,dc=nas" - "LDAP_BINDPW=ADMIN_PASSWORD" - "LDAP_BASE=ou=users,dc=nas,dc=nas" - "MAIL_FROM=admin@nas.nas" - "PWD_MIN_LENGTH=8" - "PWD_MIN_LOWER=3" - "PWD_MIN_DIGIT=2" - "SMTP_HOST=" - "SMTP_USER=" - "SMTP_PASS="</code> </pre> </div></div><br><p>     : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>open-ldap</code></a> тАФ LDAP-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>phpldapadmin</code></a> тАФ WEB-   .       ,   ... </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>ldap-ssp</code></a> тАФ WEB-    . </li></ul><br><p> LDAP-    ,     : </p><br><ul><li> <code>LDAP_ORGANISATION=NAS</code> тАФ  .   . </li><li> <code>LDAP_DOMAIN=nas.nas</code> тАФ .  .    ,    . </li><li> <code>LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD</code> тАФ  . </li><li> <code>LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD</code> тАФ   . </li></ul><br><p> -,       "  ",  . </p><br><p> : </p><br><ul><li> <code>/container/service/slapd/assets/certs</code>     <code>certs</code> тАФ .   . </li><li> <code>./ldap_data/</code> тАФ  ,        .  LDAP   . </li></ul><br><p>      <code>ldap</code> ,    389 ( LDAP)  636 (LDAP  SSL,   )    . </p><br><p> PhpLdapAdmin    :     LDAP   <code>ldap</code>    443   <code>docker0</code> ,  ,      nginx-reverse-proxy. </p><br><p> : </p><br><ul><li> <code>VIRTUAL_HOST=ldap.*</code> тАФ ,  nginx-reverse-proxy   . </li><li> <code>VIRTUAL_PORT=443</code> тАФ   nginx-reverse-proxy. </li><li> <code>VIRTUAL_PROTO=https</code> тАФ   nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> тАФ  ,   . </li></ul><br><p>        SSL    . </p><br><p> SSP   HTTP      . <br> ,     ,       . </p><br><p>    тАФ             LDAP. </p><br><ul><li> <code>LDAP_URL=ldap://open-ldap-server:389</code> тАФ    LDAP  (.  <code>links</code> ). </li><li> <code>LDAP_BINDDN=cn=admin,dc=nas,dc=nas</code> тАФ      . </li><li> <code>LDAP_BINDPW=ADMIN_PASSWORD</code> тАФ  ,     ,    open-ldap. </li><li> <code>LDAP_BASE=ou=users,dc=nas,dc=nas</code> тАФ   ,      . </li></ul><br><p>         LDAP   LDAP : </p><br><pre> <code class="bash hljs">apt-get install ldap-utils ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/inititialize_ldap.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/base.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,cn=config"</span></span> -W -f ldifs/gitlab_attr.ldif</code> </pre> <br><p>  <code>gitlab_attr.ldif</code>  ,   Gitlab (  )   . <br>         . </p><br><div class="spoiler"> <b class="spoiler_title">  LDAP </b> <div class="spoiler_text"><pre> <code class="bash hljs">$ ldapsearch -x -H ldap://172.21.0.1 -b dc=nas,dc=nas -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W Enter LDAP Password: <span class="hljs-comment"><span class="hljs-comment"># extended LDIF # # LDAPv3 # base &lt;dc=nas,dc=nas&gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # nas.nas dn: dc=nas,dc=nas objectClass: top objectClass: dcObject objectClass: organization o: NAS dc: nas # admin, nas.nas dn: cn=admin,dc=nas,dc=nas objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator ... # ldap_users, groups, nas.nas dn: cn=ldap_users,ou=groups,dc=nas,dc=nas cn: ldap_users gidNumber: 500 objectClass: posixGroup objectClass: top # search result search: 2 result: 0 Success # numResponses: 12 # numEntries: 11</span></span></code> </pre> </div></div><br><p>    LDAP  .      WEB-. </p><br><h3 id="nastroyka-omv-dlya-vhoda-po-ldap">  OMV    LDAP </h3><br><p>  LDAP    , OMV       :  , ,   ,          ,    тАФ  . </p><br><p> LDAP      . </p><br><p>    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0e/fq/yp/0efqypb4eevkfvm1dx5hccpxcae.png" alt="LDAP рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП OMV рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ"></a> </p><br><h2>     </h2><br><p>     ,     ,     NAS  USB. <br>          . <br>     NUT  GUI OMV. <br>    <em>"-&gt;"</em> ,  ,      ,  ,  "eaton". </p><br><p>   <em>"  "</em>  : </p><br><pre> <code class="hljs pgsql">driver = usbhid-ups port = auto <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> = "Eaton 9130 700 VA" vendorid = <span class="hljs-number"><span class="hljs-number">0463</span></span> pollinterval = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><ul><li> <code>driver = usbhid-ups</code> тАФ    USB,    USB HID. </li><li> <code>vendorid</code> тАФ    ,      <code>lsusb</code> . </li><li> <code>pollinterval</code> тАФ     c. </li></ul><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a> . </p><br><p>  <code>lsusb</code> ,     : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsusb Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub --&gt; Bus 001 Device 003: ID 0463:ffff MGE UPS Systems UPS Bus 001 Device 004: ID 046b:ff10 American Megatrends, Inc. Virtual Keyboard and Mouse Bus 001 Device 002: ID 046b:ff01 American Megatrends, Inc. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></span></code> </pre> <br><p> <em>" "</em>    "  ". <br>    ,    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0v/1e/5c/0v1e5ceg5axff7qac7gnqqlv5dc.png" alt="рдпреВрдкреАрдПрд╕ рд╕реЗрдЯрдЕрдк"></a> </p><br><p>     .    ,        . <br>     . </p><br><h2>  рдирд┐рд╖реНрдХрд░реНрд╖ </h2><br><p>       .   ,       ,     ,   ,   . <br>      тАФ  . </p><br><p>    -, OMV   . </p><br><p>     WEB-,       ,   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/tb/p3/ja/tbp3jabundd-ifinj76eimw-me0.png"></a> </p><br><p>  Docker     WEB-: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ol/1o/h_/ol1oh_koe2adncdkhh9qozsufkm.png"></a> </p><br><p>  , OMV    . </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fq/n7/v2/fqn7v20f3vq1ekj7ygcg1jbv2cu.png" alt="рдиреЗрдЯрд╡рд░реНрдХ рдЙрдкрдпреЛрдЧ рдЕрдиреБрд╕реВрдЪреА"></a> </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/52/k4/3e/52k43eckcekf7bxfxqmsbnv4hlm.png" alt="рдореЗрдореЛрд░реА рдЙрдкрдпреЛрдЧ рдЧреНрд░рд╛рдл"></a> </p><br><p>   CPU: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qn/e8/ir/qne8ir6ndfbl17zyvzzl5vyexs0.png" alt="рд╕реАрдкреАрдпреВ рдЙрдкрдпреЛрдЧ рдЧреНрд░рд╛рдл"></a> </p><br><h2 id="nerealizovannoe">  </h2><br><ul><li>    тАФ   . ,     -  .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>docker-compose exec</code></a> ,       . </li><li> LDAP      ,     ( SSL ,      ..). </li><li>          ,    ,    . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" class="user_link">ValdikSS</a>      DropbearSSH,   initramfs     .     . </li></ul><br><p>   . <br>  ! </p><br><p><img src="https://habrastorage.org/webt/n0/dy/xy/n0dyxyaz2tzyp5q1vvdskj1fr9c.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi415779/">https://habr.com/ru/post/hi415779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi415769/index.html">TeamCity рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Android рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ UI рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд▓реЙрдиреНрдЪ рд╕реЗрдЯ рдХрд░реЗрдВ</a></li>
<li><a href="../hi415771/index.html">рдХрдореНрдкрд╛рдЗрд▓рд░ рдЬрд╛рдУ: SSA рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝реЗрд╢рди рд░реВрд▓реНрд╕ рдбрд┐рдЯреЗрд▓реНрд╕ рд▓реИрдВрдЧреНрд╡реЗрдЬ</a></li>
<li><a href="../hi415773/index.html">рдЧреИрд░-рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ: рд╕реНрдХреЗрд▓реЗрдмрд┐рд▓рд┐рдЯреА</a></li>
<li><a href="../hi415775/index.html">рдПрдХ рд╢рд╛рдВрдд рд╕рдореНрдореЗрд▓рди рдХреЗ рд▓рд┐рдП рдПрдХ рд░рд┐рдкреЛрд░реНрдЯ рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд░рд▓, рд▓реЗрдХрд┐рди рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ</a></li>
<li><a href="../hi415777/index.html">рд╡рд┐рдХрд╛рд╕ рдореЗрдВ рдкрд╣рд▓реА рдорд╢реАрди рд▓рд░реНрдирд┐рдВрдЧ рдЪреИрдореНрдкрд┐рдпрдирд╢рд┐рдк</a></li>
<li><a href="../hi415781/index.html">рднреМрддрд┐рдХрд╡рд┐рджреЛрдВ рдХреЛ рдХреНрдпреЛрдВ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕рд┐рджреНрдзрд╛рдВрдд "рд╣рд░ рдЪреАрдЬ рдХрд╛ рд╕рд┐рджреНрдзрд╛рдВрдд" рд╣реЛ рд╕рдХрддрд╛ рд╣реИ</a></li>
<li><a href="../hi415783/index.html">рд╕реНрдЯрд╛рд░ рдбрд┐рд╕реНрдХ рд╣рдореЗрдВ рдЧреНрд░рд╣реЛрдВ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреЗ рд░рд╣рд╕реНрдпреЛрдВ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi415785/index.html">рд╕реНрдкреЗрд╕рдПрдХреНрд╕ ISS рдХреЛ рдХреГрддреНрд░рд┐рдо рдмреБрджреНрдзрд┐рдорддреНрддрд╛ рд░реЛрдмреЛрдЯ рднреЗрдЬрддрд╛ рд╣реИ</a></li>
<li><a href="../hi415789/index.html">рдХрдВрдкреНрдпреВрдЯрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рд▓рд┐рдП рдкреЗрдЯреЗрдВрдЯ рдПрд▓реНрдЧреЛрд░рд┐рджрдо</a></li>
<li><a href="../hi415791/index.html">рд╕реНрдорд╛рд░реНрдЯ рдХреЙрдиреНрдЯреНрд░реИрдХреНрдЯ рдХрд╛ рдЕрдиреБрдХреВрд▓рдиред рдХреИрд╕реЗ рд╕реЙрд▓рд┐рдбрд┐рдЯреА рдкреНрд░рдХрд╛рд░ рд▓реЗрдирджреЗрди рд▓рд╛рдЧрдд рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>