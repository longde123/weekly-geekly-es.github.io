<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è∏Ô∏è ‚ôëÔ∏è üßëüèø L√≥gica de jogo comum no cliente e no servidor üêæ üë®üèø‚Äç‚öïÔ∏è üì•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No Pixonic DevGAMM Talks, nosso DTO Anton Grigoriev tamb√©m falou. N√≥s da empresa j√° dissemos que estamos trabalhando em um novo jogo de tiro PvP e Ant...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L√≥gica de jogo comum no cliente e no servidor</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/429312/">  No Pixonic DevGAMM Talks, nosso DTO Anton Grigoriev tamb√©m falou.  N√≥s da empresa j√° dissemos que estamos trabalhando em um novo jogo de tiro PvP e Anton compartilhou algumas das nuances da arquitetura deste projeto.  Ele contou como desenvolver o desenvolvimento para que as mudan√ßas na l√≥gica do jogo do cliente apare√ßam no servidor automaticamente (e vice-versa) e se √© poss√≠vel n√£o escrever c√≥digo, mas minimizar o tr√°fego.  Abaixo est√° um registro e uma transcri√ß√£o do relat√≥rio. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/eFd4WZBHqDw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  N√£o vou aprender como fazer algo, vou falar sobre como fizemos.  Para que voc√™ n√£o pise no mesmo rake e possa usar nossa experi√™ncia.  H√° um ano e meio, n√≥s na empresa n√£o sab√≠amos como fazer atiradores em celulares.  Voc√™ diz como √©, voc√™ tem rob√¥s de guerra, 100 milh√µes de downloads, 1,5 milh√£o de DAUs.  Mas neste jogo, os rob√¥s s√£o muito lentos, e quer√≠amos fazer um jogo r√°pido, e a arquitetura dos War Robots n√£o permitia isso. <br><br>  Sab√≠amos como e o que fazer, mas n√£o t√≠nhamos experi√™ncia.  Ent√£o contratamos uma pessoa que teve essa experi√™ncia e dissemos: fa√ßa o mesmo que voc√™ j√° fez cem vezes, s√≥ que melhor.  Ent√£o eles se sentaram e come√ßaram a pensar em arquitetura. <br><br><img src="https://habrastorage.org/webt/ta/cm/lz/tacmlz5phqxz6vg6kvpdjwjklaq.png"><br><br>  Veio para o Sistema de componentes de entidades (ECS).  Eu acho que muitas pessoas sabem o que √©.  Todos os objetos do mundo s√£o representados por entidades.  Por exemplo, um jogador, sua arma, algum objeto no mapa.  Eles possuem propriedades descritas pelos componentes.  Por exemplo, o componente Transform √© a posi√ß√£o do jogador no espa√ßo, e o componente Health √© a sa√∫de dele.  Existe l√≥gica - √© separada e representada por sistemas.  Normalmente, os sistemas s√£o o m√©todo Execute (), que passa por componentes de um determinado tipo e faz algo com eles, com o mundo do jogo.  Por exemplo, o MoveSystem passa por todos os componentes do Movement, analisa a velocidade desse componente, o par√¢metro e, com base nisso, calcula a nova posi√ß√£o do objeto, ou seja,  escreve para transformar. <br><br>  Essa arquitetura tem caracter√≠sticas pr√≥prias.  Ao desenvolver o ECS, voc√™ precisa pensar e fazer as coisas de maneira diferente.  Uma das vantagens √© a composi√ß√£o, e n√£o a heran√ßa m√∫ltipla.  Lembre-se deste rhombic com heran√ßa m√∫ltipla em C ++?  Todos os seus problemas.  Este n√£o √© o caso da ECS. <br><br><img src="https://habrastorage.org/webt/eh/0e/2-/eh0e2-7mx_yl1ls4gp65yobizew.png"><br><br>  O segundo recurso √© a separa√ß√£o da l√≥gica e dos dados, sobre os quais eu j√° falei.  O que isso nos d√°?  Podemos armazenar o estado do mundo e sua hist√≥ria em lotes, podemos serializ√°-los, podemos enviar esses dados pela rede e alter√°-los em tempo real.  S√£o apenas dados na mem√≥ria - podemos alterar qualquer valor a qualquer momento.  Portanto, √© muito conveniente alterar a l√≥gica do jogo (ou para depurar). <br><br>  Tamb√©m √© muito importante acompanhar a ordem de chamada do sistema.  Todos os sistemas v√£o um ap√≥s o outro, s√£o chamados pelo m√©todo Execute () e, idealmente, devem ser independentes.  Na pr√°tica, isso n√£o acontece.  Um sistema muda algo no mundo, outro sistema o usa.  E se quebrarmos essa ordem, o jogo ser√° diferente.  Provavelmente n√£o muito, mas definitivamente n√£o √© o mesmo de antes. <br><br>  Por fim, um dos principais e mais importantes recursos para n√≥s √© que podemos executar o mesmo c√≥digo no cliente e no servidor. <br><br>  D√™ ao desenvolvedor uma oportunidade, e ele encontrar√° 99 maneiras e motivos para tomar sua decis√£o, e n√£o usar os existentes.  Eu acho que muitos fizeram isso.  Est√°vamos procurando a estrutura do ECS na √©poca.  Consideramos Entitas, Artemis C #, Ash.net e nossa pr√≥pria solu√ß√£o, que pode ser escrita a partir da experi√™ncia de um especialista que veio at√© n√≥s. <br><br><img src="https://habrastorage.org/webt/v8/sb/dt/v8sbdteegwxn_milbcee_wc6qde.png"><br><br>  N√£o tente ler o que est√° escrito no slide, pois n√£o √© t√£o importante.  O importante √© a quantidade de verde e vermelho nas colunas.  Verde significa que a solu√ß√£o suporta os requisitos, vermelho - n√£o suporta, amarelo - suporta, mas n√£o completamente. <br><br>  Na coluna, o ECS √© potencialmente a nossa solu√ß√£o.  Como voc√™ pode ver, √© mais legal - n√≥s podemos oferecer suporte a muito mais requisitos.  Como resultado, n√£o apoiamos alguns deles (principalmente porque n√£o eram necess√°rios), e alguns, sem os quais n√£o pod√≠amos trabalhar mais, tiveram que ser feitos.  Escolhemos arquitetura, trabalhamos por um longo tempo, criamos uma vers√£o minimamente jog√°vel e ... fakap. <br><br><img src="https://habrastorage.org/webt/5d/hg/7r/5dhg7r6qkdvxzcbj1svjtshafvk.png"><br><br>  Acabou sendo a vers√£o mais n√£o jog√°vel.  O jogador constantemente revertia, freia, o servidor pendia no meio da partida.  Era imposs√≠vel jogar.  Quais foram as raz√µes para as falhas? <br><br>  Raz√£o # 1 e o mais importante √© a inexperi√™ncia.  Mas como assim?  Contratamos uma pessoa experiente que deveria fazer tudo lindamente.  Sim, mas, na realidade, demos a ele apenas parte do trabalho.  Dissemos: "Aqui est√° um servidor de jogo para voc√™, trabalhe nele."  E em nossa arquitetura (mais sobre isso mais adiante), o cliente desempenha um papel muito importante.  E foi essa parte que demos a um homem que n√£o tinha a experi√™ncia necess√°ria.  N√£o, ele √© um bom programador, senor - simplesmente n√£o havia experi√™ncia.  I.e.  ele n√£o tinha id√©ia de que tipo de rake poderia haver. <br><br>  Raz√£o # 2 - aloca√ß√µes irrealistas.  80 KB / quadro.  √â muito ou n√£o?  Se levarmos em conta que temos 30 quadros por segundo, em um segundo obteremos 2,5 MB e, para uma correspond√™ncia de 5 minutos, j√° haver√° mais de 600 MB.  Em suma, muito.  O coletor de lixo come√ßa a tentar intensamente liberar toda essa mem√≥ria (quando exigimos cada vez mais dela), o que leva a picos.  Dado que quer√≠amos 30 quadros por segundo, esses picos interferiram muito conosco.  Al√©m disso, no cliente e no servidor. <br><br>  O principal motivo das aloca√ß√µes foi o fato de alocarmos constantemente matrizes de dados.  Quase todas as vezes em todos os quadros.  LINQ usado, express√µes lambda e Photon.  O Photon √© uma biblioteca de rede que estamos familiarizados e usamos nos rob√¥s de guerra.  E tudo parece estar bem, mas aloca mem√≥ria toda vez que envia ou recebe dados. <br><br>  Se resolvermos os primeiros problemas (reescrevemos para nossas cole√ß√µes personalizadas, fizemos o cache), praticamente n√£o havia nada a ser feito com o Photon, porque √© uma biblioteca de terceiros.  S√≥ foi poss√≠vel reduzir o tamanho do pacote e t√≠nhamos 5 Kbytes.  Muito?  Sim  Existe MTU - esse √© o tamanho m√≠nimo real do pacote enviado por UDP, sem dividir o pacote em pequenas partes.  √â aproximadamente 1,5 Kbytes e tivemos 5 (em m√©dia, havia mais). <br><br>  Assim, o Photon cortou nossa embalagem em pequenas e enviou cada pe√ßa como confi√°vel, ou seja,  com entrega garantida.  Cada vez que a pe√ßa n√£o chegava, ele a enviava repetidamente.  Temos ainda mais lat√™ncia e a rede funcionou mal. <br><br>  Todas essas aloca√ß√µes levaram ao fato de que recebemos um quadro de cerca de 100 milissegundos quando foram necess√°rios 33. E a√≠, renderiza√ß√£o, simula√ß√£o e outras a√ß√µes - tudo isso leva a CPU.  Todos esses problemas s√£o complexos, ou seja,  era imposs√≠vel decidir um, e tudo ficaria bem.  Era necess√°rio resolv√™-los todos de uma vez. <br><br>  E outro pequeno problema que ocorreu durante o desenvolvimento - um grande n√∫mero de reposit√≥rios.  5 est√° escrito no slide, mas parece-me que havia ainda mais deles.  Todos esses reposit√≥rios (para o cliente, o servidor do jogo, c√≥digo comum, configura√ß√µes e outras coisas) foram conectados por sub-m√≥dulos nos dois reposit√≥rios principais do cliente e do servidor do jogo.  Foi dif√≠cil trabalhar com isso.  Os programadores podem trabalhar com Git, SVN, mas tamb√©m existem artistas, designers, etc.  Eu acho que muitos tentaram ensinar um artista ou designer a trabalhar com um sistema de controle de vers√£o.  Isso √© realmente dif√≠cil, portanto, se o seu designer sabe como faz√™-lo - cuide dele, ele √© um funcion√°rio valioso.  No nosso caso, at√© os programadores enlouqueceram e, como resultado, reduzimos tudo para um reposit√≥rio. <br><br>  Essa foi uma √≥tima solu√ß√£o para o problema.  Temos uma pasta com um servidor l√° e uma pasta com um cliente.  O servidor consiste em um projeto de servidor de jogo, um gerador de c√≥digo e ferramentas auxiliares. <br><br><img src="https://habrastorage.org/webt/ws/rg/6e/wsrg6ecn8sdodaa-uh1r_koqtoq.png"><br><br>  Um cliente √© um cliente Unity e c√≥digo comum.  Um c√≥digo comum √© uma estrutura de dados mundiais, ou seja,  Entidades, componentes e simula√ß√£o do sistema.  Esse c√≥digo √© gerado principalmente pelo gerador do servidor.  √â usado pelo servidor.  I.e.  Essa √© uma parte comum para o cliente e o servidor. <br><br>  Vida  Pegamos o TeamCity, configuramos em nosso reposit√≥rio, coletamos e implantamos o servidor.  Toda vez que um cliente altera a l√≥gica geral, um servidor de jogo √© montado aqui - agora, um programador de servidor n√£o √© necess√°rio para isso.  Geralmente h√° um servidor, um cliente e algum recurso.  O cliente o v√™ em casa, o servidor em casa e, algum dia, ele funcionar√° para eles.  No nosso caso, n√£o √© assim - o cliente pode escrever esse recurso e tudo funciona no servidor. <br><br>  A partida consiste em uma parte comum (designada como ECS) e uma apresenta√ß√£o (essas s√£o classes unit√°rias de MonoBehavior, GameObjects, modelos, efeitos - tudo o que o mundo representa).  Eles n√£o est√£o conectados. <br><br><img src="https://habrastorage.org/webt/gh/dp/xf/ghdpxftm1m0fo6gqp51bmkifrw0.png"><br><br>  Entre eles, est√£o os apresentadores, que trabalham com as duas partes.  Como voc√™ entende, esse √© o MVP (Model-View-Presenter) e qualquer uma dessas partes pode ser substitu√≠da, se necess√°rio.  H√° outra parte que funciona com a rede (no slide - Rede).  Isso √© serializa√ß√£o de informa√ß√µes sobre o mundo, serializa√ß√£o de entrada, envio para o servidor, recebimento pelo servidor, conex√£o com o servidor, etc. <br><br>  Mais curtidas.  Pegamos e substitu√≠mos esta pe√ßa por um pacote que n√£o √© real, pela rede, mas virtual.  Criamos um objeto dentro do cliente e enviamos mensagens a ele.  Ele implementa uma simula√ß√£o de servidor - agora esse objeto faz tudo o que aconteceu no servidor do jogo.  Os jogadores restantes s√£o substitu√≠dos por bots. <br><br><img src="https://habrastorage.org/webt/tn/gk/l3/tngkl3sijbk-emyfrzvwivkxyw0.png"><br><br>  Feito.  Temos o jogo e a capacidade de test√°-lo sem um servidor de jogo.  O que isso significa?  Isso significa que o artista, depois de criar um novo efeito, pode clicar no bot√£o Reproduzir no editor, chegar imediatamente √† partida no mapa e ver como ele funciona.  Ou depure para programadores clientes o que eles escreveram. <br><br>  Mas fomos al√©m e anexamos a essa camada emula√ß√£o o jitter ping dos atrasos da rede (√© quando os pacotes na rede n√£o chegam na ordem em que foram enviados) e outras coisas da rede.  Como resultado, conseguimos uma correspond√™ncia praticamente real sem um servidor de jogos.  Funciona, verificado. <br><br>  Vamos voltar √† gera√ß√£o de c√≥digo. <br><br><img src="https://habrastorage.org/webt/vb/jd/kb/vbjdkbu6g6ot2a1jdyak4o84v8m.png"><br><br>  Eu j√° disse que temos um gerador de c√≥digo em um servidor de jogos.  Existe uma linguagem espec√≠fica de dom√≠nio, que na verdade √© uma classe C # simples.  Nesse caso, a classe Health.  Marcamos com nossos atributos.  Por exemplo, h√° um atributo de componente.  Ele diz que a sa√∫de √© um componente em nosso mundo.  Com base nesse atributo, o gerador criar√° uma nova classe C # na qual haver√° v√°rias coisas.  Eles podem ser escritos √† m√£o, mas ser√£o gerados.  Por exemplo, o m√©todo de adicionar um componente √† Entidade, o m√©todo de procurar componentes, serializar dados etc.  H√° um atributo do tipo DontSend, que diz que n√£o √© necess√°rio enviar um campo pela rede - o servidor n√£o precisa dele ou o cliente n√£o precisa.  Ou o atributo Mach, que informa que o jogador tem um valor m√°ximo de vida de mil.  O que isso nos d√°?  Em vez de um campo que ocupa 32 bits (int), enviamos 10 bits - tr√™s vezes menos.  Esse gerador de c√≥digo nos permitiu reduzir o tamanho do pacote de 5 KB para 1. <br><br><img src="https://habrastorage.org/webt/1u/bx/bx/1ubxbxiuebsnmqh7v822vjo-xgs.png"><br><br>  1 KB &lt;1,5 - ou seja,  Conhecemos o MTU.  O Photon parou de cortar e a rede ficou muito melhor.  Quase todos os seus problemas se foram.  Mas fomos al√©m e fizemos uma compacta√ß√£o delta. <br><br><img src="https://habrastorage.org/webt/bg/m1/gp/bgm1gpgzxdlktns_-3rentd-ceo.png"><br><br>  √â quando voc√™ envia um estado completo e, em seguida, apenas suas altera√ß√µes.  N√£o acontece que o mundo inteiro imediatamente tenha mudado completamente.  Apenas algumas partes est√£o mudando constantemente e essas mudan√ßas s√£o muito menores em tamanho do que o pr√≥prio estado.  Recebemos uma m√©dia de 300 bytes, ou seja,  17 vezes menos do que era originalmente. <br><br>  Por que isso √© necess√°rio se voc√™ j√° entrou no MTU?  O jogo est√° em constante crescimento, novos recursos aparecem, e com eles aparecem objetos, entidades, novos componentes.  O tamanho dos dados est√° aumentando.  Se par√°ssemos com 1 KB, em breve retornar√≠amos ao mesmo problema.  Agora, tendo reescrito para compacta√ß√£o delta, n√£o chegaremos a isso muito em breve. <br><br>  Agora a parte mais doce.  Sincronizar  Se voc√™ joga atiradores, sabe o que √© Lag de Entrada - quando voc√™ clica no bot√£o e o personagem come√ßa a se mover ap√≥s algum tempo, por exemplo, meio segundo.  Para alguns jogos do g√™nero mob, isso √© normal.  Mas no jogo de tiro, voc√™ quer que o her√≥i atire e cause dano ali. <br><br><img src="https://habrastorage.org/webt/5q/ts/4t/5qts4t4xpvyygxwgkrjzffuzwam.png"><br><br>  Por que o Input Lag est√° acontecendo?  O cliente coleta a entrada (entrada) do jogador e a envia para o servidor do jogo (o envio leva tempo).  Em seguida, o servidor do jogo processa (novamente, hora) e envia o resultado de volta (novamente, hora).  Isso √© um atraso.  Como remov√™-lo?  Existe uma coisa chamada previs√£o - o cliente n√£o espera por uma resposta do servidor e come√ßa imediatamente a tentar fazer a mesma coisa que o servidor do jogo, ou seja,  finge.  Pega a entrada do player e inicia a simula√ß√£o.  Simulamos apenas um cliente local, porque n√£o conhecemos a opini√£o de outros jogadores - eles n√£o v√™m at√© n√≥s.  Portanto, rodamos o sistema de simula√ß√£o apenas no nosso player. <br><br>  Em primeiro lugar, permite reduzir o tempo de simula√ß√£o.  O cliente inicia a simula√ß√£o assim que recebe a entrada e est√° v√°rias etapas adiante em rela√ß√£o ao servidor do jogo.  Digamos que nesta foto ele esteja simulando o tick 20.  Neste ponto, o servidor do jogo simula o tick # 15 no passado.  O cliente v√™ o resto do mundo, novamente, no passado, ele mesmo - no futuro.  Enquanto ele envia o 20¬∫ tick para o servidor, enquanto essa entrada chega, o servidor do jogo j√° come√ßar√° a simular o 18¬∫ tick ou j√° o 20¬∫.  Se o dia 18, ele o coloca no buffer, chega ao dia 20, processa e retorna o resultado. <br><br>  Digamos que agora ele esteja simulando o tick n¬∫ 15.  Processado, retorna o resultado para o cliente.  O cliente tem algum tipo de 15¬∫ tick simulado, 15¬∫ estado de jogo e o mundo do jogo que ele previu.  A compara√ß√£o com o servidor come√ßa.  Na verdade, ele n√£o compara o mundo inteiro, mas apenas o seu cliente, porque n√£o somos respons√°veis ‚Äã‚Äãpelo resto do mundo.  N√≥s somos apenas respons√°veis ‚Äã‚Äãpor n√≥s mesmos.  Se o jogador coincidiu, est√° tudo bem, o que significa que simulamos corretamente, a f√≠sica funcionou corretamente e nenhuma colis√£o ocorreu.  Em seguida, continuamos a simular o 20¬∫ tick, o 21¬∫ e assim por diante. <br><br>  Se o cliente / jogador n√£o corresponder, significa que est√°vamos enganados em algum lugar.  Exemplo: como a f√≠sica n√£o √© determin√≠stica, ela n√£o calculou corretamente nossa posi√ß√£o ou algo aconteceu.  Talvez apenas um bug.  Em seguida, o cliente obt√©m o estado do servidor do jogo, porque o servidor j√° o confirmou (ele confia no servidor - se n√£o confiasse, os jogadores trapaceariam) e simular√° o restante dos dias 15 a 20.  Porque esse ramo do tempo agora est√° errado. <br><br>  Crie um novo ramo de tempo, ou seja,  mundos paralelos.  N√≥s estimulamos novamente esses cinco ticks em um tick.  Uma vez que nossa simula√ß√£o levou 5 milissegundos, mas se precisarmos simular 10 ticks, j√° s√£o 50 milissegundos e n√£o ca√≠mos em nossos 30 milissegundos.  Eles otimizaram e obtiveram um milissegundo - agora 10 ticks s√£o processados ‚Äã‚Äãem 10 milissegundos.  Porque ainda h√° renderiza√ß√£o. <br><br>  Todas essas coisas funcionam no cliente, e a demos √† pessoa sem a experi√™ncia necess√°ria.  Menos - tivemos um fakap e mais - que o programador agora sabe como faz√™-lo corretamente. <br><br><img src="https://habrastorage.org/webt/zt/ph/j9/ztphj9138fs3coanbgqad_ef15w.png"><br><br>  Este esquema tem caracter√≠sticas pr√≥prias.  O cliente na foto √† esquerda est√° tentando rastrear o inimigo.  Ele est√° no 20¬∫ tick, o oponente est√° no 15¬∫ tick.  Porque o ping e o cliente est√£o 5 vezes √† frente do servidor.  O cliente atira e precisa acertar e causar danos, talvez at√© um tiro na cabe√ßa.  Mas a imagem √© diferente no servidor - quando o servidor come√ßa a simular o vig√©simo tick, o inimigo j√° pode se mover.  Por exemplo, se o inimigo estava se movendo.  Em teoria, n√£o devemos entender.  Mas se isso funcionasse assim, ningu√©m jogaria atiradores online devido a erros constantes.  Dependendo do ping, a probabilidade de acertar tamb√©m mudou: quanto pior o ping, pior fica.  Portanto, eles fazem isso de maneira diferente. <br><br>  O servidor leva e rola o mundo inteiro para a teca na qual o jogador viu o mundo.  O servidor sabe quando foi, reverte para o 15¬∫ tick e v√™ a figura √† esquerda.  Ele v√™ que o jogador deveria ter acertado e causa dano ao seu oponente j√° no 20¬∫ tick.  Est√° tudo bem.  Quase.  Se o inimigo fugiu e correu atr√°s de um obst√°culo, j√° atiramos na cabe√ßa atrav√©s do muro.  Mas este √© um problema conhecido, os jogadores sabem disso e n√£o se preocupem.  Portanto, funciona, n√£o h√° nada a ser feito sobre isso. <br><br><img src="https://habrastorage.org/webt/fy/f3/4g/fyf34g2zncwjpautyl5n-ea68qe.png"><br><br>  Assim, atingimos 30 ticks por segundo, 30 quadros por segundo.  Agora, aproximadamente 600 jogadores est√£o jogando no nosso servidor ao mesmo tempo.  Existem 6 jogadores na partida, ou seja,  cerca de 100 correspond√™ncias.  N√£o temos um programador de servidor, n√£o precisamos dele.  Os clientes escrevem toda a l√≥gica no editor do Unity, Rider, em C # e funcionam em um servidor de jogos.  Quase sempre.  Reduzimos o tamanho do pacote em 17 vezes e alocamos a mem√≥ria em 80 vezes - agora menos de um kilobyte no cliente e no servidor.  O ping m√©dio foi de 200 a 250 ms, agora √© 150. 200 √© o padr√£o para jogos em rede m√≥vel, diferente de um PC, onde tudo acontece muito mais r√°pido, especialmente em uma rede local. <br><br><img src="https://habrastorage.org/webt/k8/sb/ko/k8sbkorut9xfqgnvrkiy5ngrljc.png"><br><br>  Planejamos isolar o que est√° escrito em uma estrutura separada para us√°-lo em outros projetos.  Mas at√© agora, n√£o se fala em c√≥digo aberto.  E adicione interpola√ß√£o l√°.  Agora temos 30 ticks por segundo, podemos desenhar conforme o tick.  Mas existem jogos em que 20 ticks por segundo ou 10. s√£o suficientes, portanto, se empatarmos 10 vezes por segundo, os personagens se mover√£o em empurr√µes.  Portanto, √© necess√°ria interpola√ß√£o.  N√≥s escrevemos nossa pr√≥pria biblioteca de rede em vez do Photon - n√£o h√° aloca√ß√µes de mem√≥ria l√°. <br><br>  Ainda existem partes que voc√™ n√£o pode escrever com as m√£os, mas gera c√≥digo.  Por exemplo, quando enviamos o estado do mundo para um cliente, cortamos os dados que ele n√£o precisa.  Enquanto fazemos isso com as m√£os e quando um novo recurso aparece, e esquecemos de cortar esses dados, algo d√° errado.  De fato, isso pode ser gerado marcando algum atributo. <br><br><h3>  Perguntas da plat√©ia </h3><br>  <b>- O que voc√™ est√° usando para gera√ß√£o de c√≥digo?</b>  <b>Sua pr√≥pria decis√£o?</b> <br><br>  - Tudo √© simples - m√£os.  Pensamos em preparar algo, mas acabou sendo mais r√°pido escrever com as pr√≥prias m√£os.  Siga este caminho, funcionou bem ent√£o e agora. <br><br>  <b>- Voc√™ recusou o desenvolvedor do servidor, mas n√£o reduziu apenas o tempo de desenvolvimento devido ao fato de o mesmo c√≥digo ser reutilizado.</b>  <b>O Unity n√£o suporta a vers√£o mais recente do C #, possui seu pr√≥prio mecanismo sob o cap√¥.</b>  <b>Voc√™ n√£o pode usar o .NET Core, n√£o pode usar os recursos mais recentes, determinadas estruturas e muito mais.</b>  <b>O desempenho n√£o sofre cerca de um ter√ßo disso?</b> <br><br>  - Quando come√ßamos a fazer tudo isso, pensamos que, para usar n√£o classes, mas estruturas, deveria ter funcionado muito mais r√°pido.  Escrevemos um prot√≥tipo de como ficar√° no c√≥digo, como os programadores usar√£o essas estruturas para escrever l√≥gica.  E era terrivelmente desconfort√°vel.  Decidimos as aulas e o desempenho que temos agora √© suficiente para n√≥s. <br><br>  <b>- Como voc√™ mora agora sem interpola√ß√£o?</b>  <b>E como voc√™ finge ser um jogador se o instant√¢neo n√£o aparece no quadro certo?</b> <br><br>  - Temos interpola√ß√£o, mas n√£o √© visual, mas naqueles pacotes que chegam pela rede.  Digamos que temos os 18, 19 e 20 estados.  18-,  20-,  19-  ,     ‚Äî    .      ,     . <br><br> <b>‚Äî    ,    ?</b> <br><br> ‚Äî    2D ‚Äî    ,          .      :     UDP,    ,    :     ,        .     . <br><br> <b>‚Äî         ?</b> <br><br>  "Sim, claro."  -    (  ,      ,    ),    2 :    ,    . <br><br> <b>‚Äî       .     ?   ?    1000   ,  ?  ,    ?</b> <br><br> ‚Äî   ,   .        ,       -,     ,   .  ,    30 . <br><br> <b>‚Äî      ,       ?</b> <br><br> ‚Äî . ,       (     ),     .    ‚Äî ,     , .  -   ,      ,        .  , ,  ,        ,   .    . <br><br> <b>‚Äî         ECS,   ,     ?      ?</b> <br><br> ‚Äî 30    ,      . 80     ,    .      . <br><br> <b>‚Äî     prediction.    20-  - ,      ,          -   ‚Äî    ,  ? ,         .   -  ?</b> <br><br> ‚Äî   :          .     (, 15-)  16-,17-,18-   . <br><br> <b>‚Äî      ?</b> <br><br> ‚Äî ,          .    , , .     Entity (   ),    .          ‚Äî       ,      . ID  ,        . <br><br> <b>‚Äî  -    ‚Äî     ,   ,     ,    ?   ,      ?</b> <br><br> ‚Äî , ,  .  3D    ,     ‚Äî    ,             ,  - .      ,   ,     .   top-down,   ‚Äî    .      .     ,   ,       ,    .     . <br><br> <b>‚Äî       ?</b> <br><br> ‚Äî   .  Isso tamb√©m acontece. <br><br> <b>‚Äî    ,        ,    - .  -         .   -  ,      ,   , 500 , ,     -     - .   ?</b> <br><br> ‚Äî  . <br><br><img src="https://habrastorage.org/webt/5q/ts/4t/5qts4t4xpvyygxwgkrjzffuzwam.png"><br><br>     , ..   20-    20- ,      .    ‚Äî    ,      .   :    20-  ,          ?       ,    . ,      ‚Äî -     .      ,   .      ,  ¬´    - ,  21-,  18-¬ª. : ¬´,    - ¬ª.   . <br><br> <b>‚Äî ..    ,           ?</b> <br><br> ‚Äî ,      . <br><br> <b>‚Äî    reliable UDP ‚Äî   -  ?</b> <br><br> ‚Äî  Photon,  Photon  reliable UDP, unreliable, c     . <br><br> <b>‚Äî    ?</b> <br><br> ‚Äî    ,   -.     ,      . ,   .    ,    .      ,         .     100%,     ,   80%,    . <br><br> <b>‚Äî  ?</b> <br><br> ‚Äî ,   , Photon   ,     MTU. <br><br> <b>‚Äî      ?   ?</b> <br><br> ‚Äî  ,   ,  ,      .     .  ,  .    ,   ,       ,    . <br><br> <b>‚Äî  ,    ,    ?</b> <br><br> ‚Äî   ,     .       ,     . , ,  . , -   .     ,   .   ,      . <br><br> <b>‚Äî       /   ‚Äî     -  .      ,     .</b> <br><br> ‚Äî   ,            . ,   (    ),       -,     ,     -.  ,   .    ‚Äî  ,   . <br><br> <b>‚Äî     ,  -  .      ?</b> <br><br> ‚Äî    ,    .             : ECS,    .       , ECS  .   ,   ECS .  ,       .  ,  ,   ,   (  ,   ,    ,  ,    ,   ).    2D ,   ,     3D ‚Äî    .  3D    , ,   .       .   - ,    .   ,       - -,      . <br><br> <b>‚Äî    ,  ECS      ,   .   ,  ,    C#?</b> <br><br> ‚Äî    ‚Äî . <br><br> <b>‚Äî ..     ES  ?   , ECS ‚Äî      ,         ,    ,       . .. ECS ‚Äî     ,     .</b> <br><br> ‚Äî   ,  ,     .     ,  .   ‚Äî   ,    ,    .   ,    O  -  ,    ,    . <br><br> <b>‚Äî ,   ECS-  ?</b> <br><br> ‚Äî  -, ECS    ,   ,   (   )    ‚Äî   ,     .    ,      ‚Äî   .  ‚Äî    ,     ,    .     ,   , ,   .. <br><br><h3>    Pixonic DevGAMM Talks </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> Consul   stateful-</a> ( , DevOps   BIT.GAMES); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CICD:        </a> ( ,   Pixonic); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     -  Quake Champions</a> ( , backend- Saber Interactive); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> -  - Tacticool</a> ( , Lead Software Engineer  PanzerDog); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> ECS, C# Job System  SRP    </a> ( , Field Engineer  Unity); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> KISS  </a> ( , Lead Game Programmer  1C Game Studios); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cucumber  :  BDD-    </a> ( , Technical Product Manager, ALICE Platform). </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429312/">https://habr.com/ru/post/pt429312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429298/index.html">Atualiza√ß√µes no VPS.today</a></li>
<li><a href="../pt429302/index.html">Usando UTF-8 em cabe√ßalhos HTTP</a></li>
<li><a href="../pt429306/index.html">Sexta-feira. Besteira 4.3</a></li>
<li><a href="../pt429308/index.html">Como deixei uma startup em uma grande empresa</a></li>
<li><a href="../pt429310/index.html">Contrata√ß√£o, ca√ßa, treinamento e desenvolvimento de rubis. √Årea de RH na confer√™ncia RubyRussia-2018</a></li>
<li><a href="../pt429314/index.html">Vis√£o geral das plataformas populares de criptomoedas</a></li>
<li><a href="../pt429316/index.html">Opera√ß√µes com n√∫meros complexos</a></li>
<li><a href="../pt429318/index.html">IPhone SMT Solver</a></li>
<li><a href="../pt429320/index.html">Sberbank Data Science Day transmiss√£o ao vivo 10 de novembro</a></li>
<li><a href="../pt429322/index.html">nanoCAD Mechanics 9.0: o b√°sico do design moderno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>