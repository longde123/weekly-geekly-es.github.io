<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∂ ü¶Ç üë©üèª‚Äçüîß Tutorial do DataPower ü•î üßìüèø üõí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Material co-escrito por wedmeed 


 Em 2017, quando nosso projeto come√ßou no Vietn√£, encontramos o novo IBM DataPower para n√≥s. O IBM DataPower √© um p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tutorial do DataPower</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neoflex/blog/442686/"><p>  Material co-escrito por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">wedmeed</a> </p><br><p> Em 2017, quando nosso projeto come√ßou no Vietn√£, encontramos o novo IBM DataPower para n√≥s.  O IBM DataPower √© um produto de gateway entre clientes e back-end projetado para filtragem, roteamento, enriquecimento ou outras transforma√ß√µes de mensagens que passam por ele (daqui em diante referidos como pedidos).  Era necess√°rio aprender rapidamente, n√£o havia tempo para o ac√∫mulo, por isso fomos convidados a nos familiarizar com ele, ap√≥s o que houve muitas horas de confer√™ncia pelo Skype com nosso colega de Moscou, que nos transmitiu seu conhecimento e experi√™ncia com este produto. <br></p><br><p>  O auto-estudo foi baseado no estudo da documenta√ß√£o e na exibi√ß√£o de v√≠deos de treinamento da Internet - e aqui eu estava esperando uma captura.  Eu praticamente n√£o consegui encontrar informa√ß√µes em russo.  Ali√°s, meu conhecimento da l√≠ngua inglesa naquela √©poca n√£o era do mais alto n√≠vel, al√©m de ter sido meu primeiro projeto e, provavelmente, esses fatores complicaram minha vida.  Isso me fez escrever um artigo de treinamento em russo e da maneira mais simples poss√≠vel para desenvolvedores iniciantes que se depararam com este produto e est√£o tentando entender rapidamente seus conceitos b√°sicos.  O artigo n√£o o livrar√° da leitura da documenta√ß√£o, mas facilitar√° a vida nos est√°gios iniciais do entendimento de "como funciona". <br></p><br><p>  Tamb√©m √© importante notar que a estrutura dada na pr√°tica ser√° pr√≥xima do projeto real, o que permitir√° que voc√™ a use como base, expandindo e complementando seus requisitos.  Em conclus√£o, algumas palavras sobre o projeto j√° implementado, bem como alguns recursos que merecem aten√ß√£o, ser√£o dados nas se√ß√µes de Teoria. </p><br><img src="https://habrastorage.org/webt/rm/at/lk/rmatlkcfuvcjxvgireijushp7yc.jpeg"><br><a name="habracut"></a><br><h2>  Parte 1. Instalando o DataPower com a Docker Toolbox </h2><br><p>  Instale e execute o aplicativo Docker Toolbox.  Imediatamente ap√≥s a inicializa√ß√£o, voc√™ ver√° o endere√ßo IP da m√°quina, atrav√©s do qual o DataPower estar√° dispon√≠vel no futuro: <br></p><br><img src="https://habrastorage.org/webt/zs/qa/wn/zsqawn2jksqp8j8gfl5gwslnks4.png"><br><br><p>  Para iniciar a imagem, voc√™ precisa alterar algumas configura√ß√µes da m√°quina virtual (relevante para a vers√£o IDG.2018.4.1.0) e reinici√°-la: <br></p><br><ol><li>  Pare a m√°quina docker com o comando: <br><br><pre><code class="plaintext hljs">docker-machine stop</code> </pre> </li><li>  Sistema -&gt; Placa M√£e -&gt; Mem√≥ria principal: m√≠nimo 4096Mb; <br></li><li>  Sistema -&gt; Processador: m√≠nimo 2; <br></li><li>  Exibir -&gt; Tela -&gt; Mem√≥ria de v√≠deo: pelo menos 128 Mb; <br></li><li>  Iniciamos a m√°quina docker com o comando: <br><br><pre> <code class="plaintext hljs">docker-machine start</code> </pre> <br>  <i>Nota</i>  <i>Se solicitado a reiniciar o ambiente da m√°quina docker, execute:</i> <br><br><pre> <code class="plaintext hljs">docker-machine env</code> </pre> </li><li>  Em seguida, voc√™ precisa esvaziar a imagem do IBM DataPower: <br><br><pre> <code class="plaintext hljs">docker pull ibmcom/datapower</code> </pre> </li><li>  Em seguida, inicie o cont√™iner do docker com o seguinte comando: <br><br><pre> <code class="plaintext hljs">docker run -it \ -v $PWD/config:/drouter/config \ -v $PWD/local:/drouter/local \ -e DATAPOWER_ACCEPT_LICENSE=true \ -e DATAPOWER_INTERACTIVE=true \ -p 9090:9090 \ -p 3630:3630 \ -p 9022:22 \ -p 7170:7170 \ --name idg \ ibmcom/datapower</code> </pre></li><li>  Ap√≥s concluir o comando, pressione Enter e digite <b>admin / admin</b> como o nome de usu√°rio e a senha. <br></li><li>  Para iniciar a Web Management Interface, use os comandos: <br><br><pre> <code class="plaintext hljs">co</code> </pre> <br>  e <br><br><pre> <code class="plaintext hljs">web-mgmt 0 9090</code> </pre> </li><li>  Ap√≥s todas essas etapas, execute no navegador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://192.168.99.100:9090/</a> <br></li></ol><br><h2>  Parte 2. Dom√≠nios </h2><br><h3>  2.1  Teoria </h3><br><p>  Os dom√≠nios no DataPower permitem separar ferramentas de administra√ß√£o e desenvolvimento, al√©m de fornecer seguran√ßa. <br></p><br><p>  Ap√≥s a instala√ß√£o, existe apenas um dom√≠nio padr√£o a partir do qual os dom√≠nios do aplicativo podem ser criados.  Cada dom√≠nio possui sua pr√≥pria configura√ß√£o de par√¢metros. <br></p><br><p>  Alguns recursos e par√¢metros comuns podem ser definidos apenas no dom√≠nio padr√£o, incluindo interfaces de rede, usu√°rios e controle de acesso, dom√≠nios de aplicativos e outros. <br></p><br><p>  Um dom√≠nio de aplicativo √© uma se√ß√£o de desenvolvimento para servi√ßos de processamento de solicita√ß√µes.  Os servi√ßos definidos nele n√£o podem ser compartilhados com outro dom√≠nio de aplicativo.  Os dom√≠nios de aplicativos podem ser reiniciados separadamente e independentemente, sem a necessidade de uma reinicializa√ß√£o completa do DataPower. <br></p><br><p>  Voc√™ pode criar, reiniciar, redefinir, pausar, renovar ou excluir dom√≠nios.  Voc√™ pode encontrar informa√ß√µes mais detalhadas sobre todos os recursos de administra√ß√£o na documenta√ß√£o oficial. <br></p><br><p>  Um pouco sobre o projeto conclu√≠do.  Foram utilizados tr√™s dom√≠nios: <br></p><br><ul><li>  padr√£o - o dom√≠nio padr√£o que cont√©m recursos e par√¢metros compartilhados; </li><li>  tronco - o dom√≠nio principal que cont√©m tudo o necess√°rio para processar solicita√ß√µes; </li><li>  configura√ß√µes - configura√ß√µes e dom√≠nio de seguran√ßa, os arquivos locais cont√™m informa√ß√µes sobre regras de roteamento de servi√ßo e configura√ß√µes de seguran√ßa. </li></ul><br><p>  A necessidade de transferir todas as configura√ß√µes para um dom√≠nio separado surgiu em conex√£o com a busca de um caminho de implanta√ß√£o mais simples.  Como em muitos projetos, os ambientes dev, test e prod foram separados, e a transfer√™ncia para um dom√≠nio de configura√ß√µes separado nos permitiu instalar todos os principais dom√≠nios do ambiente dev em outros ambientes por meio de exporta√ß√£o / importa√ß√£o, sem o risco de perder as configura√ß√µes do ambiente. <br></p><br><h3>  2.2  Pr√°tica </h3><br><ul><li>  No campo de pesquisa, digite "dom√≠nio", selecione "Dom√≠nio do aplicativo" e clique em "Adicionar" <br><img src="https://habrastorage.org/webt/uo/k_/gs/uok_gsaxjifcklt56rs9wmiujhm.png"></li><li>  Aqui voc√™ precisa especificar o nome do dom√≠nio, comentar (se desejar) e ativar a auditoria e o log.  Preencha os campos e aplique as altera√ß√µes <br><img src="https://habrastorage.org/webt/3b/6w/ts/3b6wtsfrlvxcxgb7jgpkmm6u1rq.png"></li><li>  Da mesma forma, adicione outro dom√≠nio "tronco" </li><li>  V√° para Revisar altera√ß√µes <br><img src="https://habrastorage.org/webt/p-/nh/cp/p-nhcpeur45dhrzahmpffom9pq8.png"></li><li>  e salve a configura√ß√£o do dom√≠nio <br><img src="https://habrastorage.org/webt/1u/8n/si/1u8nsi-zblkkqdsrpa7lnqcgw8g.png"></li><li>  Voc√™ pode verificar o status dos objetos criados, indo para o dom√≠nio padr√£o na √°rvore de navega√ß√£o em Status -&gt; Principal -&gt; Status do Objeto <br><img src="https://habrastorage.org/webt/uz/qo/q4/uzqoq4kek4qdgkfkhovrjmiridm.png"></li><li>  Escolha <b><i>Visualizar por: tipos</i></b> <br><img src="https://habrastorage.org/webt/fj/5_/6z/fj5_6zg-kidxhkt5as0omzfvsiw.png"></li><li>  Encontre o dom√≠nio do aplicativo na lista e verifique o status dos objetos: cada um deles deve ser salvo, ligado e no estado ativo.  Nesse caso, continue no pr√≥ximo cap√≠tulo. </li></ul><br><img src="https://habrastorage.org/webt/xa/ii/kj/xaiikjxfdhsy19lez-rxo2xmeug.png"><br><br><h2>  Parte 3. Gerenciadores de Filas </h2><br><p>  O gerenciador de filas n√£o √© um componente obrigat√≥rio do IBM DataPower, mas √© atrav√©s do exemplo do MQ que voc√™ pode mostrar a pot√™ncia total deste produto.  Usaremos o MQ da IBM.  Durante o teste descrito no Cap√≠tulo 6, precisaremos enviar uma mensagem para o gerenciador de filas local.  Neste artigo, farei isso usando o utilit√°rio rfhutil, mas voc√™ pode usar qualquer m√©todo dispon√≠vel para voc√™.  Para testar, voc√™ precisar√° criar uma conex√£o do DP com o gerenciador de filas local usando o MQ Queue Manager. </p><br><cut></cut><br><h3>  3.1  Teoria </h3><br><p>  O gerenciador de filas fornece troca de dados entre o gateway e os gerenciadores de filas remotas. </p><br><p>  Voc√™ tamb√©m pode configurar o MQ Queue Manager Group, o que aumentar√° a toler√¢ncia a falhas do sistema.  Isso pode ser √∫til, por exemplo, se voc√™ deseja conectar o cliente a qualquer um dos conjuntos de gerenciadores de filas de trabalho e, em alguns casos, que podem ser encontrados na documenta√ß√£o oficial. </p><br><p>  Pela experi√™ncia do projeto, apenas um recurso deve ser observado: ao mesmo tempo, quer√≠amos tentar implementar o balanceamento de carga usando o DataPower, em particular usando grupos de gerenciadores de filas, mas, na pr√°tica, n√£o encontramos essa oportunidade.  Uma solu√ß√£o alternativa √© criar um cluster de gerenciadores de filas. </p><br><br><h3>  3.2  Pr√°tica </h3><br><h4>  3.2.1  Prepara√ß√£o </h4><br><ol><li>  Instale o WebSphere MQ; </li><li>  Crie um gerenciador de filas LOCAL_DP_QM local, acess√≠vel na porta 3630; </li><li>  Configurar canal DP.SVRCONN; <br><br><p>  Ao criar um canal, os seguintes comandos podem ser √∫teis: </p><br><pre> <code class="plaintext hljs">strmqm LOCAL_DP_QM /*  mq*/ runmqsc LOCAL_DP_QM /*   mq*/ DEFINE CHANNEL (DP.SVRCONN) CHLTYPE(SVRCONN) MCAUSER('evlasenko') /* */ SET CHLAUTH('DP.SVRCONN') TYPE(USERMAP) CLNTUSER('evlasenko') USERSRC(channel) ADDRESS('*') ACTION(ADD) /*      */ SET CHLAUTH(DP.SVRCONN) TYPE(BLOCKUSER) USERLIST('nobody') /*   */ ALTER LISTENER (SYSTEM.DEFAULT.LISTENER.TCP) TRPTYPE(TCP) PORT(3630) control(QMGR) /*    3630*/ ALTER AUTHINFO (SYSTEM.DEFAULT.AUTHINFO.IDPWOS) AUTHTYPE(IDPWOS) CHCKCLNT(OPTIONAL) /* */ REFRESH SECURITY TYPE(CONNAUTH) /*  */ endmqm LOCAL_DP_QM /*  mq*/ strmqm LOCAL_DP_QM /*  mq*/ END</code> </pre><br></li><li>  Crie as filas DP.IIB.REQIN e DP.IIB.RESIN </li><li>  Execute rfhutil com o nome do usu√°rio para quem o canal foi criado.  Na linha Nome do gerenciador de filas (√† qual se conectar), escreva: <br><br><pre> <code class="plaintext hljs">DP.SVRCONN/TCT/127.0.0.1(3630)</code> </pre> <br></li><li>  Tente carregar a lista de nomes de filas; n√£o deve haver erros na janela de mensagem.  A conex√£o com o canal foi verificada. <br></li></ol><br><h4>  3.2.2  Criar IBM MQ Queue Manager </h4><br><ol><li>  V√° para o dom√≠nio do tronco. </li><li>  Na pesquisa, digite MQ, selecione IBM MQ Queue Manager e clique em Incluir. </li><li>  Voc√™ precisa especificar o nome (TEST_QM), o nome do host do gerenciador de filas, o nome do gerenciador de filas e o nome do canal, bem como o tempo limite.  Configure e salve as altera√ß√µes. <br><img src="https://habrastorage.org/webt/di/sg/x1/disgx1dt8szkq9uoicnlepcn9lg.png"><br></li></ol><br><p>  Verifique o status do objeto do gerenciador de filas da mesma maneira que verifica o status dos dom√≠nios.  Para fazer isso, selecione Status do objeto e o filtro Exibir por: tipos do dom√≠nio de tronco.  Na se√ß√£o "IBM MQ Queue Manager", localize o objeto apropriado e verifique seu status. </p><br><h2>  Parte 4. Gateways Multiprotocolo </h2><br><h3>  4.1  Teoria </h3><br><p>  O Multi-Protocol Gateway (MPG) √© um gateway de multiprotocolo que permite receber solicita√ß√µes de clientes usando v√°rios protocolos e depois transferi-los para diferentes servidores usando v√°rios protocolos.  O protocolo usado pelo cliente pode n√£o corresponder ao protocolo usado pelo servidor de acesso remoto. </p><br>  Nas configura√ß√µes principais do MPG, voc√™ pode definir os seguintes componentes: <br><br><ul><li>  XML Manager - controla a compila√ß√£o e o cache de folhas de estilo (xsl, xslt), cache de documentos. </li><li>  Pol√≠tica - consiste em regras, cada uma das quais define um conjunto de a√ß√µes aplicadas √† mensagem que passa pelo gateway. </li><li>  Configura√ß√µes das partes frontal e traseira (URL de configura√ß√£o, tipos de mensagens recebidas e enviadas, tempos limite e muito mais). </li></ul><br><p>  Algumas palavras sobre o projeto: </p><br><p>  O projeto usa 4 gateways de multiprotocolo (roteamento, 2 transformacionais para diferentes sistemas finais e outro projetado para receber arquivos do dom√≠nio de configura√ß√µes).  O diagrama abaixo mostra o esquema de intera√ß√£o geral: </p><br><img src="https://habrastorage.org/webt/p9/ea/yb/p9eayb25jpeoiazqjd0sitssuf4.png"><br><p>  A quantidade de MPG pode variar dependendo da arquitetura da solu√ß√£o como um todo.  No nosso caso, o DataPower enfrenta um barramento de integra√ß√£o (IIB) e microsservi√ßos, que apresentam diferen√ßas significativas nas interfaces (json / http versus xml / mq), por isso foi decidido fazer MPGs transformacionais para cada back-end espec√≠fico e nome√°-lo de acordo.  Para todos os clientes, trabalhamos em json / http; portanto, o roteamento MPG √© um deles.  Os principais MPGs consistem em tr√™s regras para o processamento de mensagens - solicita√ß√£o, resposta e erros.  Cada regra consiste nas a√ß√µes necess√°rias, como transforma√ß√£o, log, roteamento e outras. </p><br><p>  Dos recursos - se na pol√≠tica voc√™ usar a a√ß√£o ConvertQueryParamToXML, esteja atento ao InputConversion.  Se voc√™ definir a Codifica√ß√£o padr√£o como JSON e tentar enviar uma solicita√ß√£o GET, ficar√° surpreso ao descobrir que a mensagem n√£o passou por nenhuma transforma√ß√£o especificada e n√£o encontrou nenhum rastro.  Esse recurso ajudar√° a superar a cria√ß√£o de uma regra separada para solicita√ß√µes GET. </p><br><h3>  4.2  Pr√°tica </h3><br><h4>  4.2.1  Prepara√ß√£o </h4><br><p>  Voc√™ pode encontrar todos os arquivos necess√°rios para o trabalho no link <a href="">https://github.com/EvgenyaVlasenko/IBM_DataPower.git</a> <br></p><h4>  4.2.1.1  Tronco de dom√≠nio </h4><br><ol><li>  V√° para o dom√≠nio do tronco. </li><li>  No painel de controle, selecione Gerenciamento de arquivos. </li><li>  No diret√≥rio local, crie a seguinte estrutura de diret√≥rios e coloque os arquivos correspondentes (cada arquivo cont√©m uma breve descri√ß√£o de quais fun√ß√µes ele executa, al√©m de uma discuss√£o mais detalhada sobre isso posteriormente no artigo). <br><img src="https://habrastorage.org/webt/oj/am/i9/ojami90qdgg81ojuyr88pmeuzd0.png"><br></li></ol><br><h4>  4.2.1.2  Configura√ß√µes de dom√≠nio </h4><br><ol><li>  V√° para o dom√≠nio de configura√ß√µes. </li><li>  No painel de controle, selecione Gerenciamento de arquivos. </li><li>  No diret√≥rio local, crie a seguinte estrutura de diret√≥rios e coloque os arquivos apropriados (os arquivos tamb√©m cont√™m uma breve descri√ß√£o deles). <br><img src="https://habrastorage.org/webt/mf/9r/ne/mf9rnemyu8mcb01ad_wi6__ozj0.png"><br></li></ol><br><h3>  4.2.2  Criar GetFileMPG </h3><br><p>  Primeiro, crie um MPG auxiliar simples que retorne arquivos do dom√≠nio de configura√ß√µes. </p><br><ol><li>  V√° para o dom√≠nio de configura√ß√µes. </li><li>  No painel de controle, selecione Gateway de protocolo m√∫ltiplo e clique em Criar. </li><li>  Especifique o nome (GetFileMPG), descri√ß√£o (opcional) e tipo de back-end (din√¢mico).  De fato, como n√£o haver√° chamada para o back-end e apenas o arquivo ser√° retornado do sistema local, neste exemplo, voc√™ pode especificar qualquer tipo de back-end. <br><img src="https://habrastorage.org/webt/ds/g7/5g/dsg75gxvgo-7caldbmytubddg6i.png"><br></li><li>  Especifique os tipos de solicita√ß√£o e resposta.  A especifica√ß√£o expl√≠cita de tipos reduzir√° o n√∫mero de verifica√ß√µes em linha.  A especifica√ß√£o do tipo de passagem permite que voc√™ n√£o crie uma regra (nesse caso, para transformar a resposta).  Se especificarmos o Tipo de solicita√ß√£o tamb√©m como Passagem, n√£o poderemos processar a mensagem de nenhuma maneira.  Esta op√ß√£o n√£o nos conv√©m, portanto, restringimos o tipo de solicita√ß√£o usando N√£o XML. <br><br><img src="https://habrastorage.org/webt/qx/nx/l_/qxnxl_j3ki9e8hcc215zropuix8.png"><br></li><li>  Clique em + e selecione o manipulador de HTTP para criar um novo protocolo do lado da frente. <br><br><img src="https://habrastorage.org/webt/dc/gq/pq/dcgqpqgpx284pxkoqdqhivwjbku.png"><br></li><li>  Aqui voc√™ deve especificar um nome, endere√ßo IP, porta e uma lista de m√©todos permitidos.  Preste aten√ß√£o ao endere√ßo IP.  Se voc√™ especificar 0.0.0.0, todos poder√£o acessar esse gateway.  Se 127.0.0.1 - apenas outros gateways dentro do mesmo DataPower.  Como existem par√¢metros de seguran√ßa entre as configura√ß√µes, usamos a segunda op√ß√£o.  Preencha os campos e clique em "Aplicar", o protocolo ser√° adicionado automaticamente ao gateway. <br><br><img src="https://habrastorage.org/webt/xn/y5/-r/xny5-rfrolidwemexqwg25-tkec.png"><br></li><li>  Clique em + para adicionar uma nova pol√≠tica. <br><br><img src="https://habrastorage.org/webt/ju/y0/q6/juy0q6_osmjfnwd2v5xev97wvta.png"><br></li><li>  Preencha o nome da pol√≠tica "GetFilePolicy". <br></li><li>  Crie uma nova regra, preencha o nome e a dire√ß√£o da regra.  Como realmente n√£o h√° back-end e apenas o arquivo desejado √© retornado, haver√° apenas uma regra (cliente para servidor). <br><br><img src="https://habrastorage.org/webt/cv/4c/z_/cv4cz_dfzc5sjxu4i7as6iluzne.png"><br></li><li>  Clique duas vezes na a√ß√£o Corresponder para configur√°-la, selecione uma regra existente e aplique as altera√ß√µes.  Seria ideologicamente correto definir um limite para a capacidade de receber apenas solicita√ß√µes Get, mas dentro da estrutura da tarefa de treinamento, voc√™ pode escolher uma existente. <br></li><li>  Adicione outra a√ß√£o - GatewayScript, arrastando-o para a regra e configure-o.  Como transforma√ß√£o, usaremos o arquivo preparado, que no sistema de arquivos local: /// encontrar√° o arquivo por nome no URI da solicita√ß√£o de entrada e o colocar√° no corpo da mensagem.  O resultado da opera√ß√£o ser√° transferido diretamente para o buffer de sa√≠da da regra.  Salve as altera√ß√µes. <br><br><img src="https://habrastorage.org/webt/ai/pr/va/aiprvaljftoye2gr5tf1xjf4s_u.png"><br></li><li>  O resultado final da pol√≠tica deve ficar assim: <br><br><img src="https://habrastorage.org/webt/rm/q0/on/rmq0onkkkvygnyevy574vsgz3ns.png"><br></li><li>  A cria√ß√£o do MPG est√° conclu√≠da, salve as altera√ß√µes. <br></li><li>  Voc√™ pode verificar o sucesso de sua cria√ß√£o usando o Status do objeto, semelhante √† verifica√ß√£o do status dos dom√≠nios e do gerenciador de filas.  Para fazer isso, selecione Status do objeto e o filtro Exibir por: servi√ßos no dom√≠nio de configura√ß√µes.  Na se√ß√£o "Gateway de protocolo m√∫ltiplo", procure o objeto correspondente e verifique seu status. <br></li><li>  Voc√™ n√£o pode chamar esse MPG de fora, pois voc√™ o protegeu com ip.  Altere temporariamente o ip de 127.0.0.1 para 0.0.0.0 e a porta de 7171 para 7170 e execute a seguinte consulta: <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/trunk/route/routeRules.xml"</code> </pre><br></li><li>  Voc√™ deve obter a seguinte resposta: <br><br><img src="https://habrastorage.org/webt/e5/m8/3n/e5m83ngxz17e8lahsicaxs6lj5s.png"><br></li><li>  Novamente, altere o ip e a porta para o 127.0.0.1:7171 original. <br></li></ol><br><h4>  4.2.3  Criando RoutingMPG </h4><br><p>  Agora crie RoutingMPG.  Com base na solicita√ß√£o de entrada e nas regras de roteamento, ele determinar√° onde e com quais par√¢metros a solicita√ß√£o deve ser enviada. </p><br><ol><li>  V√° para o dom√≠nio do tronco. </li><li>  Crie um novo gateway multiprotocolo de acordo com as cl√°usulas 2-10 da se√ß√£o 4.2.2 usando os seguintes valores: <br><ul><li>  3 - nome: RoutingMPG, tipo de back-end: Din√¢mico (para a capacidade de rotear solicita√ß√µes para diferentes MPGs, se necess√°rio). </li><li>  4 - Rq: n√£o xml, Rs: n√£o xml. </li><li>  6 - nome: RoutingHTTP_FSH, ip: 0.0.0.0, porta: 7170, + M√©todo Get. </li><li>  8 - nome: RoutingPolicy. </li><li>  9 - nome: RoutingPolicy_rule_req, dire√ß√£o: cliente para servidor. </li></ul><br></li><li>  Adicione mais uma a√ß√£o para rotear a solicita√ß√£o: para fazer isso, arraste a a√ß√£o ‚ÄúRota‚Äù para a regra, clique duas vezes nela para configur√°-la, preencha os campos e aplique as altera√ß√µes.  O arquivo route.xsl recebe o arquivo de configura√ß√µes de roteamento do dom√≠nio de configura√ß√µes por meio do GetFileMPG criado anteriormente.  Depois disso, com base no URI, as configura√ß√µes necess√°rias para esta opera√ß√£o j√° est√£o selecionadas no arquivo.  Alguns deles s√£o usados ‚Äã‚Äãpara roteamento e outros s√£o adicionados aos cabe√ßalhos para uso em outros MPGs.  Os par√¢metros de entrada e sa√≠da determinam a maneira de trabalhar apenas com o corpo da mensagem e de forma alguma afetam cabe√ßalhos e vari√°veis.  Portanto: input from null - j√° que as informa√ß√µes do corpo da mensagem n√£o s√£o usadas para roteamento.  A sa√≠da √© nula - pois o resultado da transforma√ß√£o √© apenas uma altera√ß√£o nas informa√ß√µes de servi√ßo. <br><br><img src="https://habrastorage.org/webt/bb/q0/nh/bbq0nh2dtogav5pyfoeneb3t66m.png"><br></li><li>  Da mesma forma, crie mais 2 regras e salve todas as altera√ß√µes: <br><ul><li>  Dire√ß√£o: Servidor-Cliente, nome: RoutingPolicy_rule_resp; <br>  Transforma√ß√£o: Entrada INPUT, Sa√≠da NULL, local do arquivo de transforma√ß√£o: ///RoutingMPG/transform/resp.xslt.  O arquivo resp.xslt recebe o status http da resposta MPG de transforma√ß√£o e o define explicitamente como a resposta RoutingMPG.  Se isso n√£o for feito, o c√≥digo padr√£o ser√° definido como 200, mesmo se ocorrer um erro na transforma√ß√£o MPG. <br></li><li>  Dire√ß√£o: Erro, nome: RoutingPolicy_rule_error; <br>  Transforma√ß√£o: INPUT de Entrada, PIPE de Sa√≠da (de acordo com a documenta√ß√£o, usar PIPE entre dois n√≥s de a√ß√£o adjacentes como INPUT e OUTPUT pode eliminar processamento adicional e reduzir a quantidade de mem√≥ria usada), o arquivo de transforma√ß√£o √© local: ///RoutingMPG/transform/errors.xsl.  O arquivo errors.xsl recebe o c√≥digo e o texto do erro da resposta do MPG de transforma√ß√£o e gera uma mensagem de erro JSON no formato esperado pelo cliente. <br></li></ul><br></li><li>  O resultado final da pol√≠tica deve ficar assim: <br><br><img src="https://habrastorage.org/webt/um/kx/x-/umkxx-3kwx3hi1dzmc1e80ko-wa.png"><br></li><li>  A cria√ß√£o do MPG est√° conclu√≠da, salve as altera√ß√µes. <br></li><li>  Usando, por exemplo, o utilit√°rio curl, execute a seguinte consulta: <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/dp/test/transformMessage"</code> </pre> <br></li><li>  Se voc√™ receber o seguinte erro, tudo ser√° feito corretamente.  Esse erro significa que a mensagem foi recebida e processada com √™xito, mas a tentativa de chamar o back-end (neste caso, IIBMPG) n√£o teve √™xito.  V√° para o pr√≥ximo passo. <br><br><img src="https://habrastorage.org/webt/8g/iq/tl/8giqtlzspsyix66vnl7mkcxnelk.png"><br></li></ol><br><h4>  4.2.4  Cria√ß√£o do IIBMPG </h4><br><p>  O pr√≥ximo passo √© criar um MPG transformacional.  Suponha que o sistema externo esteja no formato de solicita√ß√£o JSON e o interno seja XML.  Precisamos transformar a mensagem de entrada para que o sistema interno possa entend√™-la.  Vale ressaltar que isso nem sempre √© uma simples convers√£o de toda a mensagem.  Geralmente, √© necess√°rio transmitir uma mensagem truncada ou aumentada, √†s vezes com uma estrutura completamente redesenhada. </p><br><ol><li>  V√° para o dom√≠nio do tronco. </li><li>  Crie um novo gateway multiprotocolo de acordo com as cl√°usulas 2-10 da se√ß√£o 4.2.2 usando os seguintes valores: <br><ul><li>  3 - nome: IIBMPG, tipo de back-end: Din√¢mico </li><li>  4 - Rq: JSON, Rs: XML </li><li>  6 - nome: IIBHTTP_FSH, ip: 127.0.0.1 (apenas solicita√ß√µes do mesmo DataPower), porta: 7172, + M√©todo Get </li><li>  8 - Nome: IIBPolicy </li><li>  9 - nome: IIBPolicy_rule_req, dire√ß√£o: cliente para servidor </li></ul><br></li><li>  Adicione uma descri√ß√£o.  Com base no X-DP-Transform-Name nos cabe√ßalhos da solicita√ß√£o, o arquivo IIBRuleRoute.xsl recebe do arquivo local: ///IIB/route/IIBRouteRules.xml os nomes dos arquivos de transforma√ß√£o da solicita√ß√£o, resposta e erro desse servi√ßo e define seus valores para as vari√°veis ‚Äã‚Äãde contexto correspondentes var: // contexto / IIB / reqTransform, var: // contexto / IIB / ansTransform, var: // contexto / IIB / errTransform.  Outros valores dos cabe√ßalhos (url, uri, expirar, timeout) tamb√©m s√£o colocados em vari√°veis ‚Äã‚Äãde contexto. <br><br><img src="https://habrastorage.org/webt/xo/6b/ek/xo6bekae8dsumpvosfe5xnbhneg.png"><br></li><li>  Adicione outra a√ß√£o arrastando Avan√ßado √† sua regra e selecionando Converter Par√¢metros de Consulta em XML na lista, configure.  Voc√™ precisa adicionar um novo mapa de convers√£o de entrada, fornecendo um nome (cmnJSONParseCNVM) e o tipo necess√°rio (JSON). <br><br><img src="https://habrastorage.org/webt/ir/az/gb/irazgbszkybdgjkor1otjvrllqc.png"><br><br><img src="https://habrastorage.org/webt/yd/tk/2x/ydtk2xhbveh4j6z1gsweidcyhak.png"><br></li><li>  Adicione a transforma√ß√£o ap√≥s a convers√£o padr√£o e configure-a.  Nesse caso, a vari√°vel definida na transforma√ß√£o anterior √© usada para indicar o arquivo de transforma√ß√£o.  Isso √© feito para que a transforma√ß√£o seja universal e o pr√≥prio arquivo seja substitu√≠do "on the fly", dependendo da mensagem de entrada.  O corpo da mensagem est√° pronto.  O pr√≥ximo passo √© rotear a mensagem, e o corpo da mensagem n√£o ser√° alterado. Por isso, criamos a vari√°vel dpvar_1 e salvamos o resultado nela.  √â essa vari√°vel que apontamos para a entrada da a√ß√£o Results.  Salve as altera√ß√µes. <br><br><img src="https://habrastorage.org/webt/yz/cf/do/yzcfdogrjturkuvvmqx7bio_ex4.png"><br></li><li>  Adicione uma a√ß√£o de roteamento e defina os seguintes par√¢metros.  O arquivo IIBURLRoute.xsl recebe os valores das vari√°veis ‚Äã‚Äãde contexto, algumas delas s√£o definidas como vari√°veis ‚Äã‚Äãde solicita√ß√£o de servi√ßo e, do resto, forma um URI para a solicita√ß√£o ao sistema de destino, que tamb√©m armazena na vari√°vel de servi√ßo. <br><br><img src="https://habrastorage.org/webt/kl/vk/cf/klvkcfgcro60wznqwo0ibxdncys.png"><br></li><li>  Da mesma forma, crie mais 2 regras e salve todas as altera√ß√µes: <br><ul><li>  Dire√ß√£o: Servidor-Cliente, nome: IIBPolicy_rule_resp; <br>  Transforma√ß√£o: INPUT de entrada, PIPE de sa√≠da, arquivo de transforma√ß√£o var: // context / IIB / ansTransform (vari√°vel de contexto para substituir a transforma√ß√£o da resposta "on the fly"). </li><li>  Dire√ß√£o: Erro, nome: IIBPolicy_rule_error; <br>  Transforma√ß√£o: Entrada NULL, PIPE de Sa√≠da, arquivo de transforma√ß√£o var: // context / IIB / errTransform (vari√°vel de contexto para substituir a transforma√ß√£o de erro em tempo real). </li></ul><br></li><li>  O resultado final da pol√≠tica deve ficar assim: <br><img src="https://habrastorage.org/webt/qi/d9/7u/qid97ursvmwifemzxbfdtudjkjc.png"><br></li><li>  A cria√ß√£o do MPG est√° conclu√≠da, salve as altera√ß√µes. <br></li></ol><br><h2>  Parte 5. Teste </h2><br><h3>  5.1  Prepara√ß√£o </h3><br><ol><li>  Fa√ßa o download, por exemplo, do utilit√°rio rfhutil para ler e gravar mensagens na fila; </li><li>  Os arquivos de teste est√£o localizados na pasta de testes do mesmo diret√≥rio que os arquivos do projeto. </li></ol><br><h3>  5.2  Verifica√ß√£o de integridade </h3><br><ol><li>  Envie a solicita√ß√£o usando o utilit√°rio curl (para a solicita√ß√£o abaixo, o diret√≥rio atual deve ser o mesmo que exemplo.json). <br><br><pre> <code class="plaintext hljs">curl -vv -k "http://192.168.99.100:7170/dp/test/transformMessage" -H "Content-Type: application/json" --data-binary @example.json</code> </pre> <br></li><li>  Abra 2 inst√¢ncias do utilit√°rio rfhutil e subtraia a mensagem da fila DP.IIB.REQIN com a primeira inst√¢ncia; <br></li><li>  V√° para a guia MQMD e copie o MessageID; <br></li><li>  Na segunda inst√¢ncia, abra o arquivo rs.xml, na guia MQMD, insira o identificador da mensagem no CorrelID e coloque a mensagem na fila DP.IIB.RESIN; <br></li><li>  Voc√™ deve obter uma resposta semelhante: <br><br><img src="https://habrastorage.org/webt/mn/kj/xj/mnkjxj0lyafkvo7hjgpyytuytee.png"><br></li><li>  Repita as etapas 1 a 3; <br></li><li>      rs_error.xml       correllId; <br></li><li>     <br><br><img src="https://habrastorage.org/webt/_y/i5/hb/_yi5hbw1lnrfwsuryyln9z3rdic.png"><br></li></ol><br><h2>  6.  </h2><br><h3>  6.1  Teoria </h3><br><p> Log Targets   ,         . <br></p><br><p>     Log Targets    .     ,      4     1000Kb,      .              2-4    .       ,        .  , DataPower,  , ,   ,        ,      ,      -  MPG,     . <br></p><br><h3> 6.2.  </h3><br><ol><li>    trunk; </li><li>    Log Target   ; </li><li>      : <br><ul><li> (IIB_LOG); </li><li> (File); </li><li>  (Text); </li><li>  timestamp(zulu); </li><li>   (logtemp:///IIB.log ‚Äî  IIBMPG); </li><li>  (1000). <br><img src="https://habrastorage.org/webt/ev/sm/mj/evsmmjxy8m6suwkbaeojvgcudf8.png"><br></li></ul><br></li><li>   .        MPG   IIBMPG. <br><br><img src="https://habrastorage.org/webt/lq/vl/5l/lqvl5lvc_w8powdnufq6emgjgwc.png"><br></li><li>    ,     ,    (  ,        ). <br><br><img src="https://habrastorage.org/webt/ia/tu/98/iatu98v3l0fioelwktk8uwu-6fw.png"><br></li><li>         ; <br></li><li>    ; <br></li><li>          . <br></li><li>      Log Targets    MPG. <br></li><li>   : <br><ul><li>             , ,         . <br><br><img src="https://habrastorage.org/webt/z2/ix/vt/z2ixvtjk8eidxsfbbe6mmfcecnc.png"><br></li><li>        . <br><br><img src="https://habrastorage.org/webt/go/ik/wl/goikwl1pdvlzhiyd_d7gqpffzo8.png"><br></li></ul><br></li></ol><br><h2>  7.  -    </h2><br><ol><li>       ‚Äì  ,   .    ‚Äì  ,   ,     -    . <br></li><li>      .       View Logs.      ,  ¬´  ¬ª, ¬´   ¬ª     . <br></li><li>       .           .       MPG       Show Probe -&gt; Enable Probe.         .   ,        . <br><br><img src="https://habrastorage.org/webt/re/6s/mh/re6smhejkm-i8cdmmeky6ch6cmy.png"><br></li><li>   ,      . <br></li></ol><br><p>     ‚Äì    . <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442686/">https://habr.com/ru/post/pt442686/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442676/index.html">Onde os sonhos levam: subterr√¢neo</a></li>
<li><a href="../pt442678/index.html">Maior projeto em litografia est√©reo: esqueleto gigantesco impresso em uma impressora 3D</a></li>
<li><a href="../pt442680/index.html">As tecnologias de substitui√ß√£o sensorial permitir√£o ver o mundo com a ajuda dos sons: como funciona a neuroplasticidade do c√©rebro humano</a></li>
<li><a href="../pt442682/index.html">O que digitar e como montar um projeto C ++</a></li>
<li><a href="../pt442684/index.html">Desempenho equilibrado do site. Parte 3: Conte√∫do</a></li>
<li><a href="../pt442688/index.html">An√°lise de dados Scala - uma necessidade urgente ou uma oportunidade agrad√°vel?</a></li>
<li><a href="../pt442690/index.html">Miss√£o lunar "Bereshit" - selfie no fundo da Terra</a></li>
<li><a href="../pt442692/index.html">Blockchain sem intermedi√°rios: como enviamos t√≠tulos para um registro distribu√≠do</a></li>
<li><a href="../pt442694/index.html">Um dos gigantes do streaming lan√ßado na √çndia e atraiu um milh√£o de usu√°rios em uma semana</a></li>
<li><a href="../pt442696/index.html">S for Security: seguran√ßa das coisas na Internet e relat√≥rios no InoThings ++ 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>