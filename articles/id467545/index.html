<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💆🏾 👨🏽‍🤝‍👨🏻 👚 ShIoTiny: jam tanpa pegas atau waktu nyata dan cara bekerja dengannya 🉑 😗 ♂️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tentang apa artikel ini 

 Kami melanjutkan serangkaian artikel tentang ShIoTiny - pengontrol yang dapat diprogram secara visual berdasarkan chip ESP8...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ShIoTiny: jam tanpa pegas atau waktu nyata dan cara bekerja dengannya</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467545/"><img src="https://habrastorage.org/webt/pv/8m/zb/pv8mzbyp-nmax1aoau00apxxuly.jpeg"><br><br>  <b>Tentang apa artikel ini</b> <br><br>  Kami melanjutkan serangkaian artikel tentang <b>ShIoTiny</b> - pengontrol yang dapat diprogram secara visual berdasarkan chip <b>ESP8266</b> . <br><br>  Artikel ini <b>berbicara</b> tentang jam waktu-nyata dalam pengontrol <b>ShIoTiny</b> , sinkronisasi waktu dan penggunaan simpul untuk bekerja dengan jam. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><b>Situs</b> Proyek <b>ShIoTiny</b></a> <br><br>  <b>Artikel sebelumnya dalam seri.</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ShIoTiny: otomatisasi kecil, Internet, atau "enam bulan sebelum liburan"</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ShIoTiny: node, tautan, dan acara atau fitur program menggambar</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ShIoTiny: ventilasi kamar basah (contoh proyek)</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ShIoTiny dan dunia sekitarnya: menghubungkan sensor ke input biner, pantulan kontak, dan masalah lainnya</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ShIoTiny dan dunia: sensor analog atau ADC untuk yang terkecil</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Firmware biner, sirkuit pengontrol, dan dokumentasi</a> <br><a name="habracut"></a><br><h3>  Entri </h3><br>  Hari ini kita berbicara tentang waktu.  Bukan tentang waktu, dalam arti di mana para filsuf telah berdebat tentang hal itu selama berabad-abad dan ujung-ujungnya tidak terlihat dalam perdebatan ini.  Dan tentang waktu yang kita lihat pada jam dan menurut mana kita pergi bekerja, ke sekolah atau terburu-buru berkencan. <br><br>  Masalahnya adalah bahwa jam real-time non-volatile dalam chip <b>ESP8266</b> dan pengontrol <b>ShIoTiny</b> hilang.  Cidera kelahiran kontroler <b>ShIoTiny</b> ini sepenuhnya salahku.  Tapi apa yang sudah dilakukan sudah dilakukan. <br><br>  Segera setelah firmware melihat cahaya, publik, yang marah dengan sikap saya waktu nyata, mulai menyodok hidung saya pada cacat ini. <br><br>  Karena kesalahan perlu diperbaiki, dan kali ini setidaknya tidak dengan darah, saya pergi untuk memenuhi peningkatan jumlah pengguna firmware saya dan melakukan apa yang saya bisa.  Yaitu, saya menambahkan node ke firmware controller <b>ShIoTiny</b> yang membuatnya lebih atau kurang nyaman untuk bekerja dengan ini secara real time. <br><br><h3>  Tentang ShIoTiny Watch </h3><br>  Seperti yang telah disebutkan, tidak ada "jam dengan baterai" di <b>ShIoTiny</b> .  Tetapi pada saat yang sama, hitungan mundur mulai dari 1 Januari 1970 diterapkan. <br><br>  Ini adalah waktu yang sama yang disebut UNIX-time, disimpan dalam variabel tipe <b>time_t</b> dalam bahasa C / C ++ dan yang akan berakhir pada 19 Januari 2038 dalam sistem 32-bit. <br><br>  Tapi jangan takut.  Saya pikir pada tahun 2038 setiap orang akan memiliki waktu untuk membuat tipe <b>time_t</b> 64-bit dan masalah akan diselesaikan dalam 292 miliar tahun ke depan.  Ya, ada hal lain yang akan kami buat. <br><br>  Perhatikan bahwa waktu dalam format <b>time_t</b> kadang-kadang disebut (dalam artikel saya juga) - timestamp atau, dalam bahasa Rusia, <b>timestamp</b> . <br><br>  Tetapi kembali ke controller kita.  Jadi, ada jam di dalamnya, tetapi jam ini diatur ulang ke 0 setelah mematikan daya.  Ini <b>mengarah</b> pada kesimpulan sepele bahwa masalah utama penghitungan waktu pada pengontrol <b>ShIoTiny</b> adalah kebutuhan untuk menyinkronkan jam pengontrol ketika daya dihidupkan.  Sisanya murni masalah teknis. <br><br><h3>  Sinkronisasi waktu </h3><br>  Cara lama untuk menyinkronkan waktu di Internet adalah server <b>NTP</b> .  Dan ide pertama adalah membuat simpul yang menyinkronkan waktu dengan server <b>NTP yang</b> diberikan. <br><br>  Tetapi, menghirup udara segar dan merenungkan labu saya, saya menyadari bahwa pendekatan ini secara ideologis salah. <br><br>  Bukan fakta bahwa pengguna ingin mengeluarkan pengontrol dengan firmware <b>ShIoTiny</b> di Internet.  Dan waktu untuk sinkronisasi dapat dikirim tidak hanya dari server <b>NTP</b> , tetapi juga melalui <b>UDP-multicast,</b> atau dengan kualitas koneksi yang diketahui - melalui <b>MQTT</b> . <br><br>  Oleh karena itu, keputusan yang menentukan dibuat - untuk memisahkan node untuk menerima waktu dari server <b>NTP</b> dan mengatur waktu sistem. <br><br>  Secara total, dua node dikembangkan untuk sinkronisasi waktu: node untuk menerima waktu dari server <b>NTP Waktu NTP</b> <br><br><img src="https://habrastorage.org/webt/ym/27/br/ym27brh824hmp7rw33-teekhkum.png"><br><br>  dan <b>Atur</b> simpul instalasi jam sistem <b>Waktu</b> <br><br><img src="https://habrastorage.org/webt/hc/ux/h9/hcuxh97i2xfof8neay76nrb9cpw.png"><br><br>  Node menerima waktu dari server <b>NTP</b> sebagai parameter menerima nama atau alamat IP dari server <b>NTP</b> dan, dipisahkan oleh koma, periode waktu dari server <b>NTP</b> dalam hitungan menit.  Secara default, waktu diminta dari server <b>NTP</b> setiap 60 menit atau 1 jam.  Pada output, simpul ini menetapkan 0 hingga waktu disinkronkan atau cap waktu adalah hasil dari sinkronisasi terakhir dengan server. <br><br>  Node pemasangan jam sistem menerima cap waktu sebagai input dan menyetel jam sistem sesuai dengan label ini. <br><br>  Skema paling sederhana untuk menyinkronkan jam sistem dengan server <b>NTP</b> ditunjukkan pada gambar. <br><br><img src="https://habrastorage.org/webt/gg/jx/fd/ggjxfdr-vc1qyg49jltaywrjtli.png"><br><br>  Periode sinkronisasi tidak diatur dan 60 menit secara default.  Gambar menunjukkan cap waktu. <br><br>  Saya perhatikan bahwa tidak boleh ada lebih dari satu simpul untuk menerima waktu dari server <b>NTP</b> dan lebih dari satu simpul untuk mengatur waktu sistem dalam skema program. <br><br>  Jika Anda memerlukan skema sinkronisasi eksotis, maka Anda dapat menggunakan <b>UDP-multicast</b> atau <b>MQTT</b> .  Skema ini sangat mirip. <br><br>  Untuk sinkronisasi <b>UDP-multicast</b> , kira-kira sama seperti pada gambar. <br><br><img src="https://habrastorage.org/webt/d9/vm/mh/d9vmmhwjiouw-bim7xsk7jdwoik.png"><br><br>  Dan untuk sinkronisasi melalui <b>MQTT</b> (saya tidak menyarankan, tentu saja, tetapi dalam kasus yang ekstrim) - seperti itu. <br><br><img src="https://habrastorage.org/webt/em/yp/fq/emypfq7h46bxluup4k7zj5_rplk.png"><br><br>  Saya harap sekarang semuanya jelas dengan sinkronisasi jam sistem pengontrol <b>ShIoTIny</b> .  Mari kita beralih ke node waktu penerimaan dan pemrosesan. <br><br><h3>  Jam berapa sekarang? </h3><br>  Pertanyaannya sederhana, tetapi kadang tidak mudah dijawab.  Lagi pula, waktu di setiap titik di Bumi berbeda.  Tanah air kami yang luas mencakup dari Kaliningrad ke Kamchatka sebanyak 11 zona waktu. <br><br>  Server <b>NTP</b> , tergantung pada pengaturannya, dapat mengembalikan stempel waktu yang terkait dengan zona waktu yang berbeda.  Biasanya, cap waktu ini terkait dengan <b>UTC</b> - waktu universal. <br><br>  Tetapi biasanya kita membutuhkan waktu lokal di daerah di mana controller kita bekerja.  Bagaimana caranya berada di sini? <br><br>  Dan itu sangat sederhana - untuk mendapatkan cap waktu dari jam sistem pengontrol <b>ShIoTIny</b> , simpul <b>Get Time</b> dikembangkan, di mana Anda dapat mengatur zona waktu sebagai offset waktu dari -12 jam menjadi +12 jam relatif terhadap jam sistem pengontrol. <br><br>  Misalkan kita mendapatkan waktu dari server <b>pool.ntp.org</b> dan menyinkronkan jam sistem, seperti dalam contoh kita sebelumnya.  Server ini mengembalikan waktu universal.  Kami membutuhkan lokal, seperti Tomsk, seperti milik saya.  Saya tahu bahwa Tomsk berada di zona waktu <b>UTC + 7</b> .  Jadi, mari kita atur unit penerima waktu untuk mengimbangi +7 atau hanya 7. Seperti pada gambar di bawah ini. <br><br><img src="https://habrastorage.org/webt/sc/t0/en/sct0en2l8lmwbvucefraveh2rbw.png"><br><br>  Dan jika kita tinggal di provinsi Alberta Kanada, shiftnya adalah -7 jam.  Ingat hal utama - <b>zona waktu diatur dalam simpul untuk memperoleh waktu dalam jam</b> .  Dan diatur dalam bentuk offset relatif terhadap waktu jam sistem.  Cap waktu diatur pada output unit penerima waktu.  Mungkin ada beberapa node untuk mendapatkan waktu di sirkuit. <br><br><h3>  Periksa jamnya </h3><br>  Sangat nyaman bagi mesin untuk bekerja dengan waktu dalam format timestamps <b>time_t</b> .  Bagaimanapun, ini hanya bilangan bulat yang menunjukkan jumlah detik relatif ke titik awal - 1 Januari 1970.  Dalam format ini, Anda dapat dengan mudah menemukan jarak antara dua titik waktu, menghitung titik dan sebagainya.  Ini hanya penambahan dan pengurangan bilangan bulat. <br><br>  Tetapi manusia bukanlah mesin.  Dia jauh lebih nyaman dengan representasi waktu yang biasa dalam bentuk satu tahun, bulan, hari, jam, menit dan detik.  Jadi kita manusia diatur. <br><br>  Oleh karena itu, simpul-simpul terjemahan cap waktu ke dalam satuan-satuan perubahan waktu yang akrab bagi orang tersebut diperkenalkan, dan sebaliknya, sintesis cap waktu dari satuan-satuan perubahan waktu yang dapat dimengerti oleh orang tersebut.  Node-node ini disebut, masing-masing, <b>Split Time</b> dan <b>Synth Time</b> . <br><br>  Bagaimana semua ini bekerja jelas dari gambar di bawah ini. <br><br><img src="https://habrastorage.org/webt/d_/xd/xl/d_xdxlxtdrynelvluhzdi74ratu.png"><br><br>  Saya perhatikan bahwa node <b>Membagi Waktu</b> dan <b>Waktu</b> <b>Sintasi</b> bulan (bulan) dan hari dalam seminggu (wday) dihitung dari nol.  Untuk bulan: 0-Januari, 11-Desember.  Selama berhari-hari dalam minggu 0-Minggu, 6-Sabtu. <br>  Output lain: hari dalam sebulan (hari), tahun (tahun), jam (jam), min (menit), detik (detik) - dihitung dalam bentuk yang biasa.  Jam, menit, detik - dari 0 hingga 59. Hari dalam sebulan - tergantung pada bulan dari hari pertama hingga tanggal 30 atau 31 dan, untuk bulan Februari, hingga tanggal 28 atau 29. <br>  Ya, setahun - dia tahun.  2019 sekarang. <br>  Saya harap semuanya jelas. <br><br><h3>  Contoh sistem </h3><br>  Agar tidak berdasar, saya akan memberikan contoh penggunaan jam tangan.  Tentu saja disederhanakan. <br><br>  Misalkan kita memiliki ruang lembab yang ingin kita paksa ventilasi.  Tapi tidak selalu, tetapi hanya bila kelembabannya lebih tinggi dari level yang diberikan dan hanya pada malam hari.  Di malam hari - agar tidak mengganggu orang di siang hari dengan suara kipas.  Nah, di sini kita estetika dan kita peduli pada orang. <br><br>  Mari kita coba implementasikan ini. <br><br><img src="https://habrastorage.org/webt/yp/wi/_4/ypwi_4ckfmwujmthsq1e0tlfrl8.png"><br><br>  Semua bagian sirkuit sudah tidak asing lagi bagi kami.  Waktu disinkronkan dari server <b>NTP</b> .  Meskipun tidak disinkronkan, simpul <b>Waktu NTP</b> mengembalikan 0 dan kipas memungkinkan relai dinonaktifkan.  Untuk ini, elemen teratas <b>dan</b> menurut skema bertanggung jawab. <br><br>  Setelah waktu disinkronkan, nyala / mati kipas ditentukan oleh waktu saat ini dan tingkat kelembaban.  Segera setelah tingkat kelembaban melebihi <b>70%</b> dan waktunya dari <b>pukul 23:00</b> hingga <b>06:00</b> , kipas angin akan menyala dan tidak akan mengeringkan ruangan. <br><br>  Tentu saja, lebih baik untuk mengganti konstanta waktu dan kelembaban dalam proyek nyata dengan parameter yang disimpan dalam <b>FLASH</b> dan ditetapkan, misalnya, menurut <b>MQTT</b> .  Ya, dan kondisi sistem saat ini - tingkat kelembaban, arus, waktu, status kipas - juga tidak ada salahnya untuk mempublikasikan di jaringan untuk mengontrol sistem dari smartphone.  Tapi ini sudah saya tinggalkan ruang untuk imajinasi Anda. <br><br><h3>  Kesimpulan </h3><br>  Jadi kami memperkenalkan pengontrol kami dengan waktu nyata lebih dekat. <br><br>  <i>Saya ingin mengucapkan terima kasih kepada semua orang yang mengirimi saya surat kritik membangun dan saran tentang peningkatan perangkat lunak.</i>  <i><b>Terima kasih teman-teman!</b></i> <br><br>  Seperti biasa - kritik konstruktif disambut.  Selain itu, komentar dan saran dipersilahkan. <br><br>  Anda dapat mengirim semua kritik, komentar, saran seperti biasa dalam komentar atau melalui surat: <b>shiotiny@yandex.ru</b> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id467545/">https://habr.com/ru/post/id467545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id467529/index.html">CQM adalah tampilan berbeda dalam pembelajaran mendalam untuk mengoptimalkan pencarian bahasa alami</a></li>
<li><a href="../id467531/index.html">Mesin keadaan reaktif</a></li>
<li><a href="../id467533/index.html">Mendengarkan suara bising informasi: musik dan video yang seharusnya tidak ditemukan oleh siapa pun</a></li>
<li><a href="../id467539/index.html">Forum CA / B Memilih Penghapusan Sertifikat SSL menjadi 397 Hari</a></li>
<li><a href="../id467543/index.html">Ssh-chat, bagian 2</a></li>
<li><a href="../id467547/index.html">Bypass ILV mengunci dengan DNSTap dan BGP</a></li>
<li><a href="../id467549/index.html">SpaceX berencana untuk menggunakan jaringan Internet satelit lebih awal dari yang direncanakan</a></li>
<li><a href="../id467551/index.html">Frontend Weekly Digest (9 - 15 September 2019)</a></li>
<li><a href="../id467555/index.html">Seberapa baik Anda mengenal CSS? (+ uji mini)</a></li>
<li><a href="../id467557/index.html">Intisari bahan-bahan segar dari dunia front-end untuk minggu terakhir No. 380 (8-15 September, 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>