<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèª üë©üèæ‚ÄçüöÄ üíÖ OceanLotus: atualiza√ß√£o de Malvari para macOS üß¢ ü•Ç üôÜüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em mar√ßo de 2019, o VirusTotal, um popular servi√ßo de verifica√ß√£o on-line, enviou uma nova amostra de malware para o macOS do cibergrupo OceanLotus. O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: atualiza√ß√£o de Malvari para macOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/447530/"> Em mar√ßo de 2019, o VirusTotal, um popular servi√ßo de verifica√ß√£o on-line, enviou uma nova amostra de malware para o macOS do cibergrupo OceanLotus.  O arquivo execut√°vel de backdoor possui os mesmos recursos da vers√£o anterior do malvari que estudamos para o macOS, mas sua estrutura foi alterada e ficou mais dif√≠cil de detectar.  Infelizmente, n√£o conseguimos encontrar o conta-gotas associado a esta amostra, portanto ainda n√£o conhecemos o vetor de infec√ß√£o. <br><br>  Recentemente, publicamos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">post sobre o OceanLotus</a> e como os operadores tentam garantir persist√™ncia, acelerar a execu√ß√£o do c√≥digo e minimizar tra√ßos de presen√ßa nos sistemas Windows.  Tamb√©m √© sabido que esse grupo cibern√©tico tem um componente para o macOS.  Esta postagem descreve em detalhes as altera√ß√µes na vers√£o mais recente do Malware para macOS em compara√ß√£o com a vers√£o anterior ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descrita pela Trend Micro</a> ), bem como como a an√°lise pode automatizar a descriptografia de cadeias usando a API IDA Hex-Rays. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b9/2i/bc/b92ibc95cbufdprulqgxtcrrh2q.jpeg"></div><a name="habracut"></a><br><h2>  An√°lise </h2><br>  As tr√™s partes a seguir descrevem a an√°lise de amostra com o hash SHA-1 <code>E615632C9998E4D3E5ACD8851864ED09B02C77D2</code> .  O arquivo √© chamado <b>flashlightd</b> ; os produtos antiv√≠rus da ESET o detectam como OSX / OceanLotus.D. <br><br><h4>  Prote√ß√£o anti-depura√ß√£o e sandbox </h4><br>  Como todos os bin√°rios do OceanLotus macOS, a amostra √© empacotada com UPX, mas a maioria das ferramentas de identifica√ß√£o de empacotador n√£o a reconhece como tal.  Provavelmente porque eles cont√™m principalmente uma assinatura, dependendo da presen√ßa da string "UPX", al√©m disso, as assinaturas de Mach-O s√£o menos comuns e n√£o s√£o atualizadas com tanta frequ√™ncia.  Esse recurso dificulta a detec√ß√£o de est√°tica.  Curiosamente, ap√≥s descompactar, o ponto de entrada est√° no in√≠cio da se√ß√£o <code>__cfstring</code> no segmento <code>.TEXT</code> .  Existem atributos de sinalizador nesta se√ß√£o, como mostrado na imagem abaixo. <br><br><img src="https://habrastorage.org/webt/9f/-e/nv/9f-envxqfnhv8qxtp-gjeitht1q.png"><br>  <i>Figura 1. Atributos da se√ß√£o MACH-O __cfstring</i> <br><br>  Conforme mostrado na Figura 2, o local do c√≥digo na se√ß√£o <code>__cfstring</code> permite enganar algumas ferramentas de desmontagem, exibindo o c√≥digo como seq√º√™ncias de caracteres. <br><br><img src="https://habrastorage.org/webt/qw/q0/s3/qwq0s3-lc2tj86cb3wtcx91y8d0.png"><br>  <i>Figura 2. O c√≥digo de backdoor √© definido pelo IDA como dados</i> <br><br>  Depois de iniciar o arquivo bin√°rio, cria um fluxo como um meio de prote√ß√£o contra a depura√ß√£o, cujo √∫nico objetivo √© verificar constantemente a presen√ßa de um depurador.  Para esta discuss√£o: <br><br><ul><li>  Tenta desengatar qualquer depurador chamando <code>ptrace</code> com <code>PT_DENY_ATTACH</code> como o par√¢metro de solicita√ß√£o </li><li>  Verifica se algumas portas de exce√ß√£o est√£o abertas chamando <code>task_get_exception_ports</code> </li><li>  Verifica se o depurador est√° conectado, conforme mostrado na figura abaixo, verificando a presen√ßa do sinalizador <code>P_TRACED</code> no processo atual </li></ul><br><img src="https://habrastorage.org/webt/hi/cz/hd/hiczhdrsr9kgk9kkhfr72fv_xsg.png"><br>  <i>Figura 3. Verificando a conex√£o do depurador usando a fun√ß√£o sysctl</i> <br><br>  Se o c√£o de guarda detectar a presen√ßa de um depurador, a fun√ß√£o de <code>exit</code> ser√° chamada.  Al√©m disso, a amostra verifica o ambiente executando dois comandos: <br><br> <code>ioreg -l | grep -e "Manufacturer"  sysctl hw.model</code> <br> <br>  Depois disso, a amostra verifica o valor de retorno em uma lista codificada de strings de sistemas de virtualiza√ß√£o conhecidos: <b>acle</b> , <b>vmware</b> , <b>virtualbox</b> ou <b>paralelos</b> .  Por fim, o comando a seguir verifica se a m√°quina √© um dos seguintes ‚ÄúMBP‚Äù, ‚ÄúMBA‚Äù, ‚ÄúMB‚Äù, ‚ÄúMM‚Äù, ‚ÄúIM‚Äù, ‚ÄúMP‚Äù e ‚ÄúXS‚Äù.  Estes s√£o c√≥digos de modelo de sistema, por exemplo, "MBP" significa MacBook Pro, "MBA" significa MacBook Air, etc. <br><br> <code>system_profiler SPHardwareDataType 2&gt;/dev/null | awk '/Boot ROM Version/ {split($0, line, ":");printf("%s", line[2]);}</code> <br> <br><h4>  Principais adi√ß√µes </h4><br>  Apesar do fato de as equipes de backdoor n√£o terem mudado desde o estudo da Trend Micro, notamos v√°rias outras modifica√ß√µes.  Os servidores de C&amp;C usados ‚Äã‚Äãnesta amostra s√£o bastante novos, a data de sua cria√ß√£o √© 22/10/2018. <br><br><ul><li>  <b>daff.faybilodeau [.] com</b> </li><li>  <b>sarc.onteagleroad [.] com</b> </li><li>  <b>au.charlineopkesston [.] com</b> </li></ul><br>  URL do recurso alterado para <code>/dp/B074WC4NHW/ref=gbps_img_m-9_62c3_750e6b35</code> . <br>  O primeiro pacote enviado ao servidor C&amp;C cont√©m mais informa√ß√µes sobre a m√°quina host, incluindo todos os dados coletados pelos comandos da tabela abaixo. <br><br><img src="https://habrastorage.org/webt/xb/9k/xo/xb9kxohiu-1pdfbxnxbcrmnewqq.png"><br><br>  Al√©m dessa altera√ß√£o na configura√ß√£o, a amostra n√£o usa a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">libcurl</a> para filtragem de rede, mas uma biblioteca externa.  Para encontr√°-lo, o backdoor tenta descriptografar cada arquivo no diret√≥rio atual usando o AES-256-CBC com a chave <code>gFjMXBgyXWULmVVVzyxy</code> com zeros.  Cada arquivo √© descriptografado e salvo como <code>/tmp/store</code> , e uma tentativa de carreg√°-lo como uma biblioteca foi feita usando a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dlopen</a> .  Quando uma tentativa de descriptografia leva a uma chamada <code>dlopen</code> bem-sucedida, o backdoor recupera as <code>Boriry</code> exportadas <code>Boriry</code> e <code>ChadylonV</code> , que parecem ser respons√°veis ‚Äã‚Äãpela comunica√ß√£o em rede com o servidor.  Como n√£o temos um conta-gotas ou outros arquivos do local de origem da amostra, n√£o podemos analisar esta biblioteca.  Al√©m disso, como o componente √© criptografado, a regra YARA com base nessas linhas n√£o corresponder√° ao arquivo encontrado no disco. <br><br>  Conforme descrito no artigo acima, o <i>cliendID</i> √© criado.  Esse identificador √© um hash MD5 do valor de retorno de um dos seguintes comandos: <br><br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ifconfig en0 | awk \'/ether /{print $2}\'</code>  <code>ifconfig en0 | awk \'/ether /{print $2}\'</code> (obtenha o endere√ßo MAC) <br>  - comando desconhecido (" <code>\x1e\x72\x0a</code> "), usado em amostras anteriores <br><br>  Antes do hash, o caractere "0" ou "1" √© adicionado ao valor retornado, indicando a presen√ßa de privil√©gios de root.  Esse <i>clientID</i> √© armazenado em <code>/Library/Storage/File System/HFS/25cf5d02-e50b-4288-870a-528d56c3cf6e/pivtoken.appex</code> se o c√≥digo estiver sendo executado como raiz ou em ~ / Library / SmartCardsServices / Technology / PlugIns / drivers / snippets.ecgML em todos os outros casos.  Um arquivo geralmente √© oculto usando a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">_chflags</a> ; seu registro de data e hora √© alterado usando o comando <code>touch ‚Äìt</code> com um valor aleat√≥rio. <br><br><h4>  Decodificando strings </h4><br>  Como nas vers√µes anteriores, as seq√º√™ncias de caracteres s√£o criptografadas usando AES-256-CBC (chave hexadecimal: <code>9D7274AD7BCEF0DED29BDBB428C251DF8B350B92</code> com zeros e IV √© preenchido com zeros) usando a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CCCrypt</a> .  A chave foi alterada em rela√ß√£o √†s vers√µes anteriores, mas como o grupo ainda usa o mesmo algoritmo de criptografia de cadeia, a descriptografia pode ser automatizada.  Al√©m desta postagem, estamos lan√ßando um script IDA que usa a API Hex-Rays para descriptografar cadeias presentes em um arquivo bin√°rio.  Esse script pode ajudar na an√°lise futura do OceanLotus e na an√°lise de amostras existentes que ainda n√£o conseguimos obter.  O script √© baseado em um m√©todo universal para receber argumentos passados ‚Äã‚Äãpara uma fun√ß√£o.  Ele tamb√©m est√° procurando configura√ß√µes de destino.  O m√©todo pode ser reutilizado para obter uma lista de argumentos da fun√ß√£o e depois pass√°-la para um retorno de chamada. <br><br>  Conhecendo o prot√≥tipo da fun√ß√£o de <i>descriptografia</i> , o script encontra todas as refer√™ncias cruzadas para essa fun√ß√£o, todos os argumentos, descriptografa os dados e coloca texto sem formata√ß√£o dentro do coment√°rio no endere√ßo da refer√™ncia cruzada.  Para que o script funcione corretamente, ele deve ter o alfabeto definido pelo usu√°rio usado pela fun√ß√£o de decodifica√ß√£o base64 e uma vari√°vel global contendo o comprimento da chave deve ser definida (neste caso, DWORD, consulte a Figura 4). <br><br><img src="https://habrastorage.org/webt/eh/24/ci/eh24cifpohyeyx3jvtsyodn6v8s.png"><br>  <i>Figura 4. Defini√ß√£o da vari√°vel global key_len</i> <br><br>  Na janela Fun√ß√£o, voc√™ pode clicar com o bot√£o direito do mouse na fun√ß√£o de descriptografia e clicar em "Extrair e descriptografar argumentos".  O script deve colocar as linhas descriptografadas nos coment√°rios, como mostra a Figura 5. <br><br><img src="https://habrastorage.org/webt/sy/or/e5/syore5rq9pnlbtdp_f4l4bq0aoe.png"><br>  <i>Figura 5. O texto descriptografado √© colocado no coment√°rio</i> <br><br>  Assim, as linhas descriptografadas s√£o convenientemente colocadas juntas na janela <i>refexs</i> da IDA para esta fun√ß√£o, como mostra a Figura 6. <br><br><img src="https://habrastorage.org/webt/sl/v8/ok/slv8okoh1m44vxl1wpcv8hxqleo.png"><br>  <i>Figura 6. Xrefs para a fun√ß√£o f_decrypt</i> <br><br>  O script final pode ser encontrado no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> . <br><br><h2>  Conclus√£o </h2><br>  Como j√° mencionado, a OceanLotus est√° constantemente aprimorando e atualizando seu conjunto de ferramentas.  Desta vez, o grupo cibern√©tico aprimorou o malware para trabalhar com usu√°rios de Mac.  O c√≥digo n√£o mudou muito, mas como muitos usu√°rios de Mac ignoram os produtos de seguran√ßa, proteger o Malware da detec√ß√£o √© de import√¢ncia secund√°ria. <br><br>  Os produtos da ESET j√° detectaram esse arquivo no momento do estudo.  Como a biblioteca de rede usada para a comunica√ß√£o C&amp;C agora est√° criptografada em disco, o protocolo de rede exato usado pelos atacantes ainda n√£o √© conhecido. <br><br><h2>  Indicadores de compromisso </h2><br>  Indicadores de compromisso e atributos MITRE ATT e CK tamb√©m est√£o dispon√≠veis no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447530/">https://habr.com/ru/post/pt447530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447516/index.html">Como fizemos o overclock do CAD COMPASS-3D ‚Üí Parte 2</a></li>
<li><a href="../pt447520/index.html">Recursos de classifica√ß√£o autom√°tica por n√≠veis no armazenamento Qsan XCubeSAN</a></li>
<li><a href="../pt447522/index.html">Que coisas √∫teis podem ser extra√≠das dos logs de uma esta√ß√£o de trabalho baseada no Windows</a></li>
<li><a href="../pt447526/index.html">Bicicleta pr√≥pria para sincronizar MariaDB e Sphinx</a></li>
<li><a href="../pt447528/index.html">Quem √© respons√°vel pela qualidade?</a></li>
<li><a href="../pt447532/index.html">Splunk Universal Forwarder no Docker como um coletor de logs do sistema</a></li>
<li><a href="../pt447534/index.html">O cosmonauta Aleksandr Laveykin sobre o melhor filme espacial, for√ßa G de 20g e pouso suave</a></li>
<li><a href="../pt447536/index.html">Implemente o IdM. Prepara√ß√£o para implementa√ß√£o pelo cliente</a></li>
<li><a href="../pt447538/index.html">CUBA 7: o que h√° de novo?</a></li>
<li><a href="../pt447540/index.html">Workshop RHEL 8 Beta: Criando aplicativos da Web ao vivo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>