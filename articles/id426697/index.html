<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüé® üîô üßëüèΩ‚Äçü§ù‚Äçüßëüèª Bekerja dengan perangkat LibUsb dari bawah Android üåä üöõ üë®üèΩ‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suatu hari, saya membutuhkan satu perangkat yang dikendalikan melalui USB dari program desktop untuk juga dikontrol melalui aplikasi Android. Keunikan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bekerja dengan perangkat LibUsb dari bawah Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426697/">  Suatu hari, saya membutuhkan satu perangkat yang dikendalikan melalui USB dari program desktop untuk juga dikontrol melalui aplikasi Android.  Keunikannya adalah bahwa HID, CDC dan kelas perangkat standar lainnya tidak digunakan.  Transfer data dilakukan melalui transfer Massal dan titik akhir.  Dasar bekerja dengan usb adalah perpustakaan libusb. <br><a name="habracut"></a><br>  Kami akan membuat aplikasi pengujian yang memungkinkan untuk mentransfer dan menerima data sewenang-wenang dari perangkat. <br><br>  Saya akan menyentuh pada poin-poin penting, dan tautan ke kode lengkap akan ada di akhir. <br><br>  Untuk memulainya, kami bertindak sesuai dengan dokumentasi resmi untuk bekerja dengan UsbHost. <br>  Tambahkan baris ke manifes <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.usb.host"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  Jika kita ingin perangkat terdeteksi secara otomatis dan aplikasi dimulai, maka dalam manifes untuk aktivitas utama kita menulis yang berikut ini. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.usb.action.USB_DEVICE_ATTACHED"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.usb.action.USB_DEVICE_ATTACHED"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@xml/device_filter"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Tentukan untuk perangkat kami VID dan PID-nya di file dengan resources device_filter.xml <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">usb-device</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">product-id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0037"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vendor-id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8742"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Kami mendapatkan manajer usb dalam metode onCreate. <br><br><pre> <code class="hljs lisp">mUsbManager = (<span class="hljs-name"><span class="hljs-name">UsbManager</span></span>) getSystemService(<span class="hljs-name"><span class="hljs-name">Context</span></span>.USB_SERVICE)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  Selanjutnya, kita mendapatkan daftar perangkat yang terhubung ke USB, dan di antaranya kita mencari perangkat kelas USB_CLASS_PER_INTERFACE yang kita butuhkan. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">UsbDevice </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UsbManager usbManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (UsbDevice usbDevice : usbManager.getDeviceList().values()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usbDevice.getDeviceClass() == UsbConstants.USB_CLASS_PER_INTERFACE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> usbDevice; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { UsbInterface usbInterface = findInterface(usbDevice); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usbInterface != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> usbDevice; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-function">UsbInterface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UsbDevice usbDevice)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nIf = <span class="hljs-number"><span class="hljs-number">0</span></span>; nIf &lt; usbDevice.getInterfaceCount(); nIf++) { UsbInterface usbInterface = usbDevice.getInterface(nIf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usbInterface.getInterfaceClass() == UsbConstants.USB_CLASS_PER_INTERFACE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> usbInterface; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br>  Selanjutnya, kita menemukan antarmuka yang kita butuhkan, jangan lupa untuk memeriksa izin, beralih ke semua titik kontrolnya, di antaranya kita pilih titik baca dan tulis, dan akhirnya terhubung. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initUsbDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ PendingIntent mPermissionIntent = PendingIntent.getBroadcast(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(ACTION_USB_PERMISSION), <span class="hljs-number"><span class="hljs-number">0</span></span>); IntentFilter filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(ACTION_USB_PERMISSION); registerReceiver(mUsbReceiver, filter); mUsbManager.requestPermission(mUsbDevice, mPermissionIntent); mUsbInterface = findInterface(mUsbDevice); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nEp = <span class="hljs-number"><span class="hljs-number">0</span></span>; nEp &lt; mUsbInterface.getEndpointCount(); nEp++) { UsbEndpoint tmpEndpoint = mUsbInterface.getEndpoint(nEp); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmpEndpoint.getType() != UsbConstants.USB_ENDPOINT_XFER_BULK) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mOutEndpoint == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; (tmpEndpoint.getDirection() == UsbConstants.USB_DIR_OUT)) { mOutEndpoint = tmpEndpoint; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mInEndpoint == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; (tmpEndpoint.getDirection() == UsbConstants.USB_DIR_IN)) { mInEndpoint = tmpEndpoint; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mOutEndpoint == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"no endpoints"</span></span>, Toast.LENGTH_LONG).show(); } mConnection = mUsbManager.openDevice(mUsbDevice); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mConnection == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"can't open device"</span></span>, Toast.LENGTH_SHORT).show(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } mConnection.claimInterface(mUsbInterface, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); startIoManager(); }</code> </pre><br>  Untuk bekerja dengan I / O, buffering data, asinkron, dan hal-hal praktis lainnya, kelas manajer tambahan digunakan, tetapi pada dasarnya, pertukaran data dikurangi menjadi kode berikut. <br><br>  Membaca: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">mConnection</span></span>.bulkTransfer(mInEndpoint, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, size, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">READ_TIMEOUT</span></span></span><span class="hljs-class">);</span></span></code> </pre><br>  Rekam: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> bytesWritten = mConnection.bulkTransfer(mOutEndpoint, Arrays.copyOfRange(data, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> + size), size, WRITE_TIMEOUT);</code> </pre><br>  Dengan cara ini, paket-paket BulkTransfer ditransmisikan dan diterima. <br><br>  Akibatnya, aplikasi sederhana kami dapat mengirim dan menerima data sewenang-wenang. <br><br><img src="https://habrastorage.org/webt/0s/ny/ci/0snyci1qzmzruumwydxl3tb9asa.png"><br><br><img src="https://habrastorage.org/webt/v1/jc/ak/v1jcakkp-zys1jvyskibeqtrssy.png"><br><br>  Itu berhasil! <br><br>  Proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">aplikasi tes</a> ini <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di GitHub</a> <br><br>  Tautan yang bermanfaat: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Perpustakaan untuk bekerja dengan FT232 dan perangkat CDC lainnya di Android.</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi Android resmi untuk bekerja dengan UsbHost.</a> <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id426697/">https://habr.com/ru/post/id426697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id426687/index.html">Membuat case robot dengan anggaran terbatas. Vakum membentuk</a></li>
<li><a href="../id426689/index.html">Kami bertanggung jawab atas pasar orang lain: apa yang dikatakan jejaring sosial tentang CRM</a></li>
<li><a href="../id426691/index.html">Programmer cuti sakit</a></li>
<li><a href="../id426693/index.html">Layanan navigasi robot di lapangan golf. Membangun jalan dan menghindari rintangan</a></li>
<li><a href="../id426695/index.html">Kamera visi mesin untuk penggemar. Bagaimana cara menggunakan kamera untuk navigasi offline?</a></li>
<li><a href="../id426699/index.html">Pengujian Python dengan pytest. Sederhana, Cepat, Efisien, dan Dapat diskalakan. Kata Pengantar dan Pengantar</a></li>
<li><a href="../id426701/index.html">Flutter - tampilan baru pada pengembangan lintas platform</a></li>
<li><a href="../id426703/index.html">Apa yang menarik dari DataVizDay di Minsk</a></li>
<li><a href="../id426705/index.html">Hyperledger Fabric Pengembangan dan Pengujian Kontrak Pintar</a></li>
<li><a href="../id426707/index.html">Sistem persetujuan. Bagaimana kami menemukan sepeda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>