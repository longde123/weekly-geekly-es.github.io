<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíØ üëò üîß Monolith √† microservices. Point de vue infrastructure üßë‚Äçü§ù‚Äçüßë üö¥üèª üî†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je voudrais partager mon histoire sur l'application de migration de monolithes dans des microservices. S'il vous pla√Æt, gardez √† l'esprit que c'√©tait ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monolith √† microservices. Point de vue infrastructure</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437186/"><p><img src="https://habrastorage.org/webt/9-/yd/06/9-yd0651cdfemyxqsuo8hecigpm.png"></p><br><p>  Je voudrais partager mon histoire sur l'application de migration de monolithes dans des microservices.  S'il vous pla√Æt, gardez √† l'esprit que c'√©tait entre 2012 et 2014. Il s'agit de la transcription de ma pr√©sentation √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dotnetconf (RU)</a> .  Je vais partager une histoire sur la modification de chaque partie de l'infrastructure. </p><a name="habracut"></a><br><h1 id="project-description">  Description du projet </h1><br><p><img src="https://habrastorage.org/webt/xx/ui/gi/xxuigia4vy1hxggqqzh9rapnleq.png" alt="description du projet"></p><br><p> L'id√©e principale du projet √©tait d'explorer des articles √† partir d'Internet, de l'analyser, d'enregistrer et de cr√©er un flux utilisateur.  D'une part, notre infrastructure devait √™tre fiable, mais d'autre part, nous √©tions sur un budget.  En cons√©quence, nous avons convenu que: </p><br><ul><li>  La d√©gradation des performances du syst√®me est autoris√©e. </li><li>  Certaines parties de notre infrastructure pourraient √™tre en panne pendant 30 minutes. </li><li>  En cas de catastrophe, le temps d'arr√™t peut √™tre de quelques jours. </li></ul><br><h1 id="crawlers">  Rampeurs </h1><br><p><img src="https://habrastorage.org/webt/ue/hz/7g/uehz7getj-pxvftz5k8owjpm3ss.png" alt="Rampeurs"></p><br><p>  C'√©tait une simple partie de l'infrastructure.  Les robots doivent t√©l√©charger, analyser et enregistrer.  La premi√®re impl√©mentation √©tait un seul robot, cependant, le monde changeait et beaucoup de robots diff√©rents sont apparus.  Les crawlers communiquaient entre eux par MsSQL. </p><br><p>  Les temps d'arr√™t n'√©taient pas un probl√®me pour les robots, il √©tait donc tr√®s facile de les faire √©voluer: </p><br><ul><li>  Automatisez la mise √† disposition. </li><li>  Ajoutez des mesures commerciales. </li><li>  Collectez les erreurs. </li></ul><br><h1 id="mssql">  Msql </h1><br><p><img src="https://habrastorage.org/webt/si/xp/cl/sixpcl7jggtkciqn47cjrbr0sis.png" alt="Msql"></p><br><p>  Notre base de donn√©es √©tait d'environ 1 To. </p><br><h2 id="mssql-cluster">  Cluster MsSQL </h2><br><p>  Il y avait diff√©rentes fa√ßons de cr√©er un cluster: </p><br><ol><li>  Mise en miroir SQL. </li><li>  Cluster de basculement Windows - ce n'√©tait pas un cas car il n'y avait pas de san / Nas. </li><li>  AlwaysOn - c'√©tait compl√®tement nouveau pour nous et il n'y avait aucune expertise, donc ce n'√©tait pas un cas pour nous. </li></ol><br><p>  En cons√©quence, nous avons d√©cid√© d'utiliser le 1er.  Je voudrais noter que nous n'avons pas utilis√© de t√©moin en raison du mode asynchrone, nous avons donc cr√©√© des scripts pour le commutateur automatique ma√Ætre -&gt; esclave et esclave manuel -&gt; ma√Ætre. </p><br><h2 id="mssql-perfomance">  Performances MsSQL </h2><br><p><img src="https://habrastorage.org/webt/ab/fa/hy/abfahya7iiildt32myzsm9sm6jc.png" alt="Msql"></p><br><p>  L'horloge tournait, une performance se d√©gradait, nous recherchions des goulots d'√©tranglement.  Parfois, ce n'√©tait pas facile, c'est-√†-dire que l'optimisation des requ√™tes SQL par disque io, lorsque, nous avons constat√© que les performances √©taient faibles en raison du manque de RAM.  Mais ce n'√©tait pas suffisant, en tant que solution temporaire, nous avons migr√© du HDD vers le SSD.  D'une part, cela a consid√©rablement augment√© les performances, mais d'autre part, ce n'√©tait pas une solution √† long terme. </p><br><h1 id="message-queue">  File d'attente des messages </h1><br><p><img src="https://habrastorage.org/webt/e-/cx/hx/e-cxhxer9x0dk3avntdiwpbvbcs.png" alt="File d'attente des messages"></p><br><p>  Notre application a √©t√© migr√©e vers une file d'attente de messages.  Nous √©crivions uniquement les r√©sultats dans la base de donn√©es.  En cons√©quence, nous avons r√©duit la charge de la base de donn√©es.  Mais nous avons rencontr√© un probl√®me: comment organiser un cluster de files d'attente de messages?  Au d√©but, nous avons cr√©√© un standby √† froid. </p><br><h1 id="web">  WEB </h1><br><p><img src="https://habrastorage.org/webt/h0/2x/cy/h02xcyis8eh7miz8tn-dz3vdbzy.png" alt="WEB"></p><br><p>  Un composant WebPart se composait de deux parties: contenu statique et contenu dynamique utilisateur. </p><br><h2 id="web-static">  WEB statique </h2><br><p><img src="https://habrastorage.org/webt/rc/lc/ek/rclcekb2jkvua3xc8avbogjnbxq.png" alt="WEB statique"></p><br><p>  La partie statique WEB de l'infrastructure √©tait d'environ 2 To, elle devait: </p><br><ul><li>  Stockez des images. </li><li>  Convertissez des images. </li><li>  Explorer l'image d'origine et recadrer si n√©cessaire. </li></ul><br><p><img src="https://habrastorage.org/webt/qz/7q/qm/qz7qqm_wh_veujcnwo6a44u9abi.png" alt="WEB statique"></p><br><p>  Il y avait 2 probl√®mes majeurs: comment synchroniser des fichiers et comment cr√©er un cluster Web.  Il y avait plusieurs fa√ßons de synchroniser des fichiers: acheter un stockage, utiliser DFS et enregistrer des fichiers sur chaque serveur.  Ce fut une d√©cision difficile, cependant, nous avons d√©cid√© de choisir la 3e voie.  Pour le cluster Web, nous avons d√©cid√© d'utiliser NLB &amp; CDN. </p><br><h2 id="web-balancer">  √âquilibreur WEB </h2><br><p><img src="https://habrastorage.org/webt/nt/e6/9f/nte69fci_xqh_j5rvayg-o6x9fu.png" alt="√âquilibreur WEB"></p><br><p>  Ce n'est pas vraiment une bonne id√©e d'utiliser un seul serveur pour un projet √† forte charge, vous devez √©quilibrer le trafic d'une mani√®re ou d'une autre.  Il y avait 4 fa√ßons dans notre cas: </p><br><ol><li>  √âquilibreur mat√©riel - c'√©tait trop cher pour nous. </li><li>  IIS &amp; ARR - c'√©tait trop compliqu√© √† supporter. </li><li>  Nginx - c'√©tait assez bon, cependant, nous avons rencontr√© des probl√®mes avec les bilans de sant√©. </li><li>  Haproxy - c'√©tait une solution avec l'un des plus petits frais g√©n√©raux. </li></ol><br><p><img src="https://habrastorage.org/webt/zs/jo/am/zsjoam1tong9nbn84r1hoc5qmo8.png" alt="haproxy"><br>  Nous avons choisi la 4√®me voie.  Nous √©quilibrions haproxy par round robin DNS et utilisateurs par cookie. </p><br><h1 id="mongodb">  Mongodb </h1><br><p><img src="https://habrastorage.org/webt/e4/vk/je/e4vkjevef6tp419eee7hiokv3_w.png" alt="Mongodb"></p><br><p>  Quelques mois plus tard, nous avons d√ª constater que les performances SQL n'√©taient plus suffisantes.  C'√©tait un probl√®me sophistiqu√©, cependant, apr√®s de longues conversations, nous avons d√©cid√© de choisir la <em>tol√©rance</em> de <em>disponibilit√©</em> et de <em>partition</em> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">th√©or√®me CAP</a> .  En cons√©quence, nous avons impl√©ment√© un cluster MongoDB (partitionnement et r√©plique).  Il y a eu une exp√©rience int√©ressante: comment cr√©er une sauvegarde MongoDB, comment mettre √† niveau et beaucoup de bogues MongoDB. </p><br><h1 id="backups--monitoring">  Sauvegardes et surveillance </h1><br><p>  Nous avons impl√©ment√© la r√®gle 3-2-1: </p><br><ul><li>  Au moins 3 exemplaires. </li><li>  Au moins 2 types de stockage diff√©rents. </li><li>  Au moins 1 copie doit √™tre stock√©e quelque part √† l'ext√©rieur. </li></ul><br><p>  Nous avons √©galement cr√©√© et test√© un plan de reprise apr√®s sinistre.  Vous pouvez lire sur la surveillance <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><h2 id="applications-updates">  Mises √† jour des applications </h2><br><p><img src="https://habrastorage.org/webt/9-/yd/06/9-yd0651cdfemyxqsuo8hecigpm.png" alt="Infrastructure"></p><br><p>  Comme vous pouvez le voir, l'infrastructure n'√©tait pas aussi simple que possible.  Nous avons d√ª le mettre √† jour d'une mani√®re ou d'une autre.  La mise √† jour occasionnelle ressemblait √†: </p><br><ol><li>  Faites un peu de pr√©paration. </li><li>  Migration de Ran. </li><li>  Mettez √† jour les applications Web. </li><li>  Mettre √† jour les applications backend. </li></ol><br><p>  Toutes les √©tapes logiques √©taient identiques pour les environnements de mise en sc√®ne / pr√©prod / production, mais elles √©taient l√©g√®rement diff√©rentes dans les d√©tails.  Nous avons donc cr√©√© des scripts PowerShell avec la magie OOP.  C'√©tait un processus continu d'am√©lioration de notre infrastructure CI / CD. </p><br><h1 id="conclusion">  Conclusion </h1><br><table><thead><tr><th></th><th>  2012 </th><th>  2014 </th></tr></thead><tbody><tr><td>  Serveurs </td><td>  3 </td><td>  60 </td></tr><tr><td>  RAM Go </td><td>  72 </td><td>  800 </td></tr><tr><td>  SSD GB </td><td>  200 </td><td>  10 000 </td></tr><tr><td>  MsSQL gb </td><td>  150 </td><td>  700 </td></tr><tr><td>  MongoDB GB </td><td>  0 </td><td>  700 </td></tr><tr><td>  Articles par jour </td><td>  10 000 </td><td>  150 000 </td></tr></tbody></table><br><p>  C'√©tait une histoire incroyable sur le transfert de 3 PC de bureau dans une infrastructure fiable.  Soyez patient et faites des plans. </p><br><h1 id="ps">  PS </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dotnetconf (RU)</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Diapositives (RU)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU)</a> </li><li>  C'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">crosspost</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437186/">https://habr.com/ru/post/fr437186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437174/index.html">.NET, TensorFlow et les moulins √† vent de Kaggle - le voyage commence</a></li>
<li><a href="../fr437176/index.html">Application pour iOS et Android sur Kotlin + Flutter UI</a></li>
<li><a href="../fr437180/index.html">JVM de Sib√©rie dure: grande interview sur Excelsior JET</a></li>
<li><a href="../fr437182/index.html">Interception d'appels syst√®me dans le module du noyau Linux</a></li>
<li><a href="../fr437184/index.html">Nikolay Durov a termin√© √† 90% le d√©veloppement de la plate-forme Telegram Open Network</a></li>
<li><a href="../fr437190/index.html">√Ä propos de la surveillance</a></li>
<li><a href="../fr437194/index.html">Liste de contr√¥le du cloud ou comment le client nous a √©valu√©s</a></li>
<li><a href="../fr437196/index.html">Global Game Jam 2019 (annonce)</a></li>
<li><a href="../fr437198/index.html">Global Game Jam 2019 (annonce)</a></li>
<li><a href="../fr437200/index.html">Comment nous avons test√© le glisser-d√©poser en HTML5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>