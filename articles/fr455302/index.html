<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô†Ô∏è üë¥üèº üß† Framework d'API Golang üßëüèº‚Äçü§ù‚Äçüßëüèº üëáüèº üë∏üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le processus de faire connaissance avec Golang, j'ai d√©cid√© de cr√©er le cadre de l'application, qui me sera utile pour travailler √† l'avenir. Le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Framework d'API Golang</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455302/"><p>  Dans le processus de faire connaissance avec Golang, j'ai d√©cid√© de cr√©er le cadre de l'application, qui me sera utile pour travailler √† l'avenir.  Le r√©sultat a √©t√©, √† mon avis, une bonne pi√®ce, que j'ai d√©cid√© de partager, et en m√™me temps de discuter des moments qui se sont produits lors de la cr√©ation du cadre. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/599/73a/8a9/59973a8a925f690405c0f171fdd53048.jpg" alt="image"></p><br><p>  En principe, la conception du langage Go laisse entendre qu'il n'a pas besoin de faire des applications √† grande √©chelle (je veux dire le manque de g√©n√©riques et un m√©canisme de gestion des erreurs peu puissant).  Mais nous savons toujours que la taille des applications ne diminue g√©n√©ralement pas, mais le plus souvent au contraire.  Par cons√©quent, il est pr√©f√©rable de cr√©er imm√©diatement un framework sur lequel il sera possible de cha√Æner de nouvelles fonctions sans sacrifier le support du code. </p><a name="habracut"></a><br><p>  J'ai essay√© d'ins√©rer moins de code dans l'article, mais j'ai ajout√© des liens vers des lignes de code sp√©cifiques sur Github dans l'espoir qu'il serait plus pratique de voir l'image enti√®re. </p><br><p>  Tout d'abord, j'ai esquiss√© un plan pour ce qui devrait √™tre dans la demande.  Puisque je parlerai de chaque √©l√©ment s√©par√©ment dans l'article, je donnerai d'abord le principal de cette liste comme contenu. </p><br><ul><li>  Choisissez le gestionnaire de packages </li><li> Choisissez un cadre pour cr√©er une API </li><li>  S√©lectionnez l'outil pour l'injection de d√©pendance (DI) </li><li>  Itin√©raires de demande Web </li><li>  R√©ponses JSON / XML selon les en-t√™tes de demande </li><li>  ORM </li><li>  Migrations </li><li>  Cr√©er des classes de base pour les couches de mod√®le Service-&gt; Repository-&gt; Entity </li><li>  D√©p√¥t CRUD de base </li><li>  Service CRUD de base </li><li>  Contr√¥leur CRUD de base </li><li>  Demande de validation </li><li>  Configurations et variables d'environnement </li><li>  Commandes de la console </li><li>  Journalisation </li><li>  Int√©gration de l'enregistreur avec Sentry ou un autre syst√®me d'alerte </li><li>  D√©finition d'une alerte pour les erreurs </li><li>  Tests unitaires avec red√©finition des services via DI </li><li>  Pourcentage et carte de code de couverture de test </li><li>  Swagger </li><li>  Docker compose </li></ul><br><h2 id="menedzher-paketov">  Gestionnaire de paquets </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apr√®s avoir lu les</a> descriptions des diff√©rentes impl√©mentations, j'ai choisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">govendor</a> et pour le moment j'√©tais satisfait du choix.  La raison est simple - elle vous permet d'installer des d√©pendances √† l'int√©rieur du r√©pertoire avec l'application, de stocker des informations sur les packages et leurs versions. </p><br><p>  Les informations sur les packages et leurs versions sont stock√©es dans un <a href="">fichier</a> vendor.json.  Il y a aussi un inconv√©nient √† cette approche.  Si vous ajoutez un package avec ses d√©pendances, ainsi que des informations sur le package, des informations sur ses d√©pendances seront √©galement incluses dans le fichier.  Le fichier se d√©veloppe rapidement et il n'est plus possible de d√©terminer clairement quelles d√©pendances sont les principales et quelles sont les d√©riv√©es. </p><br><p>  Dans PHP composer ou dans npm, les principales d√©pendances sont d√©crites dans un seul fichier, et toutes les d√©pendances principales et d√©riv√©es et leurs versions sont automatiquement enregistr√©es dans le fichier de verrouillage.  Cette approche est plus pratique √† mon avis.  Mais pour l'instant, la mise en ≈ìuvre du gouverneur m'a suffi. </p><br><h2 id="freymvork">  Cadre </h2><br><p>  Du framework je n'ai pas besoin de grand chose, d'un routeur pratique, de la validation des requ√™tes.  Tout cela a √©t√© trouv√© dans le populaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gin</a> .  Il s'est arr√™t√© dessus. </p><br><h2 id="dependency-injection">  Injection de d√©pendance </h2><br><p>  Avec DI, j'ai d√ª souffrir un peu.  D'abord choisi Dig.  Et au d√©but, tout √©tait super.  Services d√©crits, Dig construit davantage les d√©pendances, de mani√®re pratique.  Mais il s'est av√©r√© que les services ne pouvaient pas √™tre red√©finis, par exemple, pendant les tests.  Par cons√©quent, √† la fin, je suis arriv√© √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conclusion</a> que j'ai pris un simple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sarulabs / di de</a> conteneur de service. </p><br><p>  Je devais juste le fourche, car hors de la bo√Æte, il vous permet d'ajouter des services et interdit de les red√©finir.  Et lors de l'√©criture d'autotests, √† mon avis, il est plus pratique d'initialiser le conteneur comme dans l'application, puis de red√©finir certains services, en sp√©cifiant des stubs √† la place.  Dans fork, il a ajout√© une m√©thode pour remplacer la description du service. </p><br><p> Mais √† la fin, √† la fois dans le cas de Dig et dans le cas du conteneur de service, j'ai d√ª mettre les tests dans un package s√©par√©.  Sinon, il s'av√®re que les tests sont ex√©cut√©s s√©par√©ment dans des packages ( <code>go test model/service</code> ), mais ils ne d√©marrent pas imm√©diatement pour l'ensemble de l'application ( <code>go test ./...</code> ), en raison des d√©pendances cycliques qui surviennent dans ce cas. </p><br><h2 id="otvety-v-formate-jsonxml-v-sootvetstvii-s-zagolovkami-zaprosa">  R√©ponses JSON / XML selon les en-t√™tes de demande </h2><br><p>  Dans Gin, je ne l'ai pas trouv√©, j'ai donc ajout√© une <a href="">m√©thode</a> au contr√¥leur de base qui g√©n√®re une r√©ponse en fonction de l'en-t√™te de la demande. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c BaseController)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context *gin.Context, obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, code </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> context.GetHeader(<span class="hljs-string"><span class="hljs-string">"Accept"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"application/xml"</span></span>: context.XML(code, obj) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: context.JSON(code, obj) } }</code> </pre><br><h2 id="orm">  ORM </h2><br><p>  Avec ORM n'a pas ressenti le long tourment du choix.  Il y avait beaucoup de choix.  Mais selon la description des fonctionnalit√©s, j'ai aim√© GORM, qui est l'un des plus populaires au moment de la s√©lection.  Il existe un support pour les SGBD les plus couramment utilis√©s.  Au moins PostgreSQL et MySQL sont d√©finitivement l√†.  Il propose √©galement des m√©thodes de gestion du sch√©ma de base que vous pouvez utiliser lors de la cr√©ation de migrations. </p><br><h2 id="migracii">  Migrations </h2><br><p>  Pour les migrations, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opt√© pour</a> le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">package gorm-goose</a> .  Je mets un package s√©par√© globalement et commence la migration vers celui-ci.  Au d√©but, une telle impl√©mentation √©tait g√™nante, car la connexion √† la base de donn√©es devait √™tre d√©crite dans un <a href="">fichier db / dbconf.yml distinct</a> .  Mais il s'est av√©r√© que la cha√Æne de connexion qu'elle contient pouvait √™tre d√©crite de telle mani√®re que la valeur soit prise dans la variable d'environnement. </p><br><pre> <code class="plaintext hljs">development: driver: postgres open: $DB_URL</code> </pre> <br><p>  Et c'est assez pratique.  Au moins avec docker-compose, je n'ai pas eu √† dupliquer la <a href="">cha√Æne de connexion</a> . </p><br><p>  Gorm-goose prend √©galement en charge les annulations de migration, ce que je trouve tr√®s utile. </p><br><h2 id="bazovyy-crud-repozitoriy">  D√©p√¥t CRUD de base </h2><br><p>  Je pr√©f√®re que tout ce qui fait r√©f√©rence aux ressources soit plac√© dans une couche de r√©f√©rentiel distincte.  √Ä mon avis, avec cette approche, le code de logique m√©tier est plus propre.  Dans ce cas, le code logique m√©tier sait seulement qu'il doit travailler avec les donn√©es qu'il prend dans le r√©f√©rentiel.  Et ce qui se passe dans le r√©f√©rentiel, la logique m√©tier n'est pas importante.  Le r√©f√©rentiel peut fonctionner avec une base de donn√©es relationnelle, avec un stockage KV, avec un disque, ou peut-√™tre avec l'API d'un autre service.  Le code logique m√©tier sera le m√™me dans tous ces cas. </p><br><p>  Le r√©f√©rentiel CRUD impl√©mente l' <a href="">interface</a> suivante </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> CrudRepositoryInterface <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { BaseRepositoryInterface GetModel() (entity.InterfaceEntity) Find(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (entity.InterfaceEntity, error) List(parameters ListParametersInterface) (entity.InterfaceEntity, error) Create(item entity.InterfaceEntity) entity.InterfaceEntity Update(item entity.InterfaceEntity) entity.InterfaceEntity Delete(id <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) error }</code> </pre> <br><p>  Autrement dit, CRUD impl√©mente les op√©rations <code>Create()</code> , <code>Find()</code> , <code>List()</code> , <code>Update()</code> , <code>Delete()</code> et la m√©thode <code>GetModel()</code> . </p><br><p>  √Ä propos de <a href="">GetModel ()</a> .  Il existe un r√©f√©rentiel de base <code>CrudRepository</code> qui impl√©mente les op√©rations CRUD de base.  Dans les r√©f√©rentiels qui l'int√®grent en eux-m√™mes, il suffit d'indiquer avec quel mod√®le ils doivent travailler.  Pour ce faire, la m√©thode <code>GetModel()</code> doit renvoyer un mod√®le GORM.  Ensuite, nous avons d√ª utiliser le r√©sultat de <code>GetModel()</code> utilisant la r√©flexion dans les m√©thodes CRUD. </p><br><p>  <a href="">Par exemple</a> </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c CrudRepository)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity.InterfaceEntity, error)</span></span></span></span> { item := reflect.New(reflect.TypeOf(c.GetModel()).Elem()).Interface() err := c.db.First(item, id).Error <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item, err }</code> </pre> <br><p>  En effet, dans ce cas, il a fallu abandonner le typage statique au profit du typage dynamique.  √Ä de tels moments, le manque de g√©n√©riques dans la langue est particuli√®rement ressenti. </p><br><p>  Pour que les r√©f√©rentiels qui fonctionnent avec des mod√®les sp√©cifiques impl√©mentent leurs propres r√®gles de filtrage des listes dans la m√©thode <code>List()</code> , j'ai d'abord impl√©ment√© la liaison tardive afin que la m√©thode responsable de la construction de la requ√™te de s√©lection soit appel√©e √† partir de la m√©thode <code>List()</code> .  Et cette m√©thode pourrait √™tre impl√©ment√©e dans un r√©f√©rentiel sp√©cifique.  Il est difficile d'abandonner en quelque sorte les sch√©mas de pens√©e qui se sont form√©s en travaillant avec d'autres langues.  Mais en le regardant avec un regard neuf et en appr√©ciant ¬´l'√©l√©gance¬ª du chemin choisi, il l'a refait √† une approche plus proche de Go.  Pour ce faire, simplement dans <code>CrudRepository</code> via l'interface, <a href="">un g√©n√©rateur de requ√™tes est</a> d√©clar√©, qui est d√©j√† <a href=""><code>  List()</code></a> . </p><br><pre> <code class="go hljs">listQueryBuilder ListQueryBuilderInterface</code> </pre><br><p>  Cela s'av√®re assez dr√¥le.  Limiter le langage √† une liaison tardive, ce qui semble √† premi√®re vue comme une faille, encourage une s√©paration plus claire du code. </p><br><h2 id="bazovyy-crud-servis">  Service CRUD de base </h2><br><p>  Il n'y a rien d'int√©ressant ici, car il n'y a pas de logique m√©tier dans le cadre.  Les appels des m√©thodes CRUD au r√©f√©rentiel sont simplement <a href="">mandat√©s</a> . </p><br><p>  Dans la couche services, la logique m√©tier doit √™tre impl√©ment√©e. </p><br><h2 id="bazovyy-crud-kontroller">  Contr√¥leur CRUD de base </h2><br><p>  Le contr√¥leur impl√©mente <a href="">les m√©thodes CRUD</a> .  Ils traitent les param√®tres de la demande, le contr√¥le est transf√©r√© √† la m√©thode de service correspondante, et en fonction de la r√©ponse du service, une r√©ponse est form√©e pour le client. </p><br><p>  Avec le contr√¥leur, j'ai eu la m√™me histoire qu'avec le r√©f√©rentiel concernant les listes de filtrage.  En cons√©quence, j'ai refait l'impl√©mentation avec une liaison tardive maison et ajout√© un <a href="">hydrateur</a> , qui, en fonction des param√®tres de la demande, forme une structure avec des param√®tres pour filtrer la liste. </p><br><p>  Dans l'hydrateur fourni avec le contr√¥leur CRUD, seuls les param√®tres de pagination sont trait√©s.  Dans les contr√¥leurs sp√©cifiques dans lesquels le contr√¥leur CRUD est int√©gr√©, l' <a href="">hydrateur</a> peut √™tre <a href="">red√©fini</a> . </p><br><h2 id="validaciya-zaprosov">  Demande de validation </h2><br><p>  La validation est effectu√©e par Gin.  Par exemple, lors de l'ajout d'un enregistrement (m√©thode <code>Create()</code> ), il suffit de <a href="">d√©corer les</a> √©l√©ments de la structure d'entit√© </p><br><pre> <code class="go hljs">Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`binding:"required"`</span></span></code> </pre> <br><p>  La m√©thode <a href=""><code>ShouldBindJSON()</code></a> du <a href=""><code>ShouldBindJSON()</code></a> prend en charge la v√©rification des param√®tres de requ√™te pour la conformit√© aux exigences d√©crites dans le d√©corateur. </p><br><h2 id="konfigi-i-peremennye-okruzheniya">  Configurations et variables d'environnement </h2><br><p>  J'ai vraiment aim√© l'impl√©mentation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Viper</a> , surtout en conjonction avec Cobra. </p><br><p>  Lire la configuration que j'ai <a href="">d√©crite dans main.go.</a>  Les param√®tres de base qui ne contiennent pas de secrets sont d√©crits <a href="">dans le fichier base.env</a> .  Vous pouvez les remplacer dans le fichier .env qui est ajout√© √† .gitignore.  En .env, vous pouvez d√©crire des valeurs secr√®tes pour l'environnement. </p><br><p>  Les variables d'environnement ont une priorit√© plus √©lev√©e. </p><br><h2 id="konsolnye-komandy">  Commandes de la console </h2><br><p>  Pour la description des commandes de la console, j'ai choisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cobra</a> .  Qu'il est bon d'utiliser Cobra avec Viper.  Nous pouvons <a href="">d√©crire la commande</a> </p><br><pre> <code class="go hljs">serverCmd.PersistentFlags().StringVar(&amp;serverPort, <span class="hljs-string"><span class="hljs-string">"port"</span></span>, defaultServerPort, <span class="hljs-string"><span class="hljs-string">"Server port"</span></span>)</code> </pre> <br><p>  Et <a href="">liez la variable d'environnement</a> √† la valeur du param√®tre de commande </p><br><pre> <code class="go hljs">viper.BindPFlag(<span class="hljs-string"><span class="hljs-string">"SERVER_PORT"</span></span>, serverCmd.PersistentFlags().Lookup(<span class="hljs-string"><span class="hljs-string">"port"</span></span>))</code> </pre> <br><p>  En fait, toute l'application de ce framework est console.  Le serveur Web est lanc√© par l'une des commandes de la console du serveur. </p><br><pre> <code class="bash hljs">gin -i run server</code> </pre> <br><h2 id="logirovanie">  Journalisation </h2><br><p>  J'ai choisi le package <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">logrus</a> pour la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journalisation</a> , car il contient tout ce dont j'ai g√©n√©ralement besoin: d√©finir les niveaux de journalisation, o√π se connecter, ajouter des hooks, par exemple, pour envoyer des journaux au syst√®me d'alerte. </p><br><h2 id="integraciya-loggera-s-sistemoy-alertinga">  Int√©gration de l'enregistreur avec le syst√®me d'alerte </h2><br><p>  J'ai choisi Sentry, car tout s'est av√©r√© assez simple gr√¢ce √† l'int√©gration facile avec logrus: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">logrus_sentry</a> .  J'ai fait les <a href="">param√®tres</a> avec l'URL de Sentry <code>SENTRY_DSN</code> et le d√©lai pour envoyer √† Sentry <code>SENTRY_TIMEOUT</code> .  Il s'est av√©r√© que par d√©faut, le d√©lai d'attente est petit, sinon erron√©, 300 ms, et de nombreux messages n'ont pas √©t√© remis. </p><br><h2 id="nastroyka-alertinga-dlya-oshibok">  D√©finition d'une alerte pour les erreurs </h2><br><p>  J'ai fait un traitement de panique s√©par√©ment pour le <a href="">serveur Web</a> et pour <a href="">les commandes de la console</a> . </p><br><h2 id="yunit-testy-s-pereopredeleniem-servisov-cherez-di">  Tests unitaires avec red√©finition des services via DI </h2><br><p>  Comme indiqu√© ci-dessus, un package s√©par√© devait √™tre allou√© pour les tests unitaires.  √âtant donn√© que la biblioth√®que s√©lectionn√©e pour cr√©er un conteneur de services ne permettait pas de red√©finir les services, dans fork a ajout√© une m√©thode pour red√©finir la description des services.  De ce fait, dans le test unitaire, vous pouvez <a href="">utiliser</a> la m√™me description de services que dans l'application </p><br><pre> <code class="go hljs">dic.InitBuilder()</code> </pre> <br><p>  Et <a href="">red√©finissez</a> seulement certaines descriptions de service dans les talons de cette fa√ßon </p><br><pre> <code class="go hljs">dic.Builder.Set(di.Def{ Name: dic.UserRepository, Build: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctn di.Container)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NewUserRepositoryMock(), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, })</code> </pre> <br><p>  Ensuite, vous pouvez <a href="">cr√©er un conteneur</a> et utiliser les services n√©cessaires dans le test: </p><br><pre> <code class="go hljs">dic.Container = dic.Builder.Build() userService := dic.Container.Get(dic.UserService).(service.UserServiceInterface)</code> </pre> <br><p>  Ainsi, nous testerons userService, qui au lieu du vrai r√©f√©rentiel utilisera le stub fourni. </p><br><p>  Pourcentage et carte de code de couverture de test <br>  J'√©tais compl√®tement satisfait de l'utilitaire standard de test go. </p><br><p>  Vous pouvez ex√©cuter des tests individuellement </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/unit/user_service_test.go -v</code> </pre> <br><p>  Vous pouvez ex√©cuter tous les tests en m√™me temps </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v</code> </pre> <br><p>  Vous pouvez cr√©er une carte de couverture et calculer le pourcentage de couverture </p><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ./... -v -coverpkg=./... -coverprofile=coverage.out</code> </pre> <br><p>  Et voir une carte de la couverture du code avec des tests dans un navigateur </p><br><pre> <code class="bash hljs">go tool cover -html=coverage.out</code> </pre> <br><h2 id="swagger">  Swagger </h2><br><p>  Il existe un projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gin-swagger</a> pour Gin, qui peut √™tre utilis√© √† la fois pour g√©n√©rer des sp√©cifications pour Swagger et pour g√©n√©rer une documentation bas√©e sur celui-ci.  Mais, comme il s'est av√©r√©, afin de g√©n√©rer des sp√©cifications pour des op√©rations sp√©cifiques, il est n√©cessaire d'indiquer des commentaires sur des fonctions sp√©cifiques du contr√¥leur.  Cela ne s'est pas av√©r√© tr√®s pratique pour moi, car je ne voulais pas dupliquer le code d'op√©rations CRUD dans chaque contr√¥leur.  Au lieu de cela, dans des contr√¥leurs sp√©cifiques, j'incorpore simplement un contr√¥leur CRUD comme d√©crit ci-dessus.  Je ne voulais pas vraiment non plus cr√©er de fonctions de stub pour cela. </p><br><p>  Par cons√©quent, je suis arriv√© √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conclusion</a> que la sp√©cification est g√©n√©r√©e √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">goswagger</a> , car dans ce cas, les op√©rations <a href="">peuvent √™tre d√©crites sans √™tre li√©es √† des fonctions sp√©cifiques</a> . </p><br><pre> <code class="bash hljs">swagger generate spec -o doc/swagger.yml</code> </pre> <br><p>  Soit dit en passant, avec goswagger, vous pouvez m√™me aller de l'inverse et g√©n√©rer le code du serveur Web bas√© sur la sp√©cification Swagger.  Mais avec cette approche, il y avait des difficult√©s √† utiliser ORM, et je l'ai finalement abandonn√©. </p><br><p>  La documentation est g√©n√©r√©e √† l'aide de gin-swagger, pour cela un fichier de sp√©cifications pr√©-g√©n√©r√© est <a href="">indiqu√©</a> . </p><br><h2 id="docker-compose">  Docker compose </h2><br><p>  Dans le cadre, j'ai ajout√© une description de deux conteneurs - <a href="">pour le code et pour la base</a> .  Au d√©but du conteneur avec le code, nous attendons que le conteneur avec la base soit compl√®tement lanc√©.  Et √† chaque d√©marrage, nous effectuons des migrations si n√©cessaire.  Les param√®tres de connexion √† la base de donn√©es pour les migrations sont d√©crits, comme mentionn√© ci-dessus, dans <a href="">dbconf.yml</a> , o√π il √©tait possible d'utiliser la <a href="">variable d'environnement</a> pour transf√©rer les param√®tres de connexion √† la base de donn√©es. </p><br><p>  Merci de votre attention.  Dans le processus, j'ai d√ª m'adapter aux caract√©ristiques de la langue.  Je serais int√©ress√© de conna√Ætre l'opinion de coll√®gues qui ont pass√© plus de temps avec Go.  Certes, certains moments pourraient √™tre rendus plus √©l√©gants, donc je serai heureux de recevoir des critiques utiles.  Lien vers le cadre: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/zubroide/go-api-boilerplate</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455302/">https://habr.com/ru/post/fr455302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455286/index.html">Dents de sagesse: ne peuvent pas √™tre enlev√©es</a></li>
<li><a href="../fr455288/index.html">Nouvelles de la semaine: bloqueur de publicit√©s pour entreprises dans les cl√©s de chiffrement Chrome, FSB et Yandex, la communication devient plus ch√®re</a></li>
<li><a href="../fr455290/index.html">Le guide complet de Prom√©th√©e en 2019</a></li>
<li><a href="../fr455292/index.html">Comment augmenter 4 fois la dur√©e d'ex√©cution des appareils avec auto-alimentation</a></li>
<li><a href="../fr455294/index.html">Guide: comment choisir un v√©lo √©lectrique en utilisant Twitter comme exemple - parler de cadres</a></li>
<li><a href="../fr455306/index.html">R√©ponses √† vos questions sur les raisons pour lesquelles vous avez besoin d'un √©diteur pour publier un livre</a></li>
<li><a href="../fr455308/index.html">Endroit prometteur</a></li>
<li><a href="../fr455310/index.html">Attaques sur les canaux de contournement: d√©sormais non seulement les PC mais aussi les smartphones sont attaqu√©s (revue analytique)</a></li>
<li><a href="../fr455312/index.html">Additionneur complet un bit sur des puces inhabituelles</a></li>
<li><a href="../fr455314/index.html">Qu'est-ce qu'un r√©seau de services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>