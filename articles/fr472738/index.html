<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚û∞ üë∑üèª üë©üèª‚Äç‚öñÔ∏è Comment mettre √† niveau un projet existant d'ASP.NET MVC vers ASP.NET Core. Guide pratique ü§ôüèø üí° üë®üèø‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce message est n√© de notre exp√©rience de la migration d'un projet existant d'ASP.NET MVC vers ASP.NET Core. Nous avons essay√© de rassembler l'ensemble...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment mettre √† niveau un projet existant d'ASP.NET MVC vers ASP.NET Core. Guide pratique</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472738/">  Ce message est n√© de notre exp√©rience de la migration d'un projet existant d'ASP.NET MVC vers ASP.NET Core.  Nous avons essay√© de rassembler l'ensemble du processus de migration sous une forme structur√©e et de d√©crire les divers goulots d'√©tranglement afin que les d√©veloppeurs puissent continuer √† s'appuyer sur ce mat√©riel et suivre la feuille de route pour r√©soudre ces probl√®mes. <br><br>  Quelques mots sur notre projet.  Nous sommes une plate-forme de commerce √©lectronique open source sur ASP.NET, qui, au moment du transfert, existait d√©j√† avec succ√®s depuis 9 ans.  Nous avons fait la migration il y a 2 ans - mais nos mains ne sont venues l'√©crire que maintenant.  √Ä cette √©poque, nous √©tions l'un des premiers grands projets √† avoir d√©cid√© d'une telle d√©marche. <br><br><h2>  Pourquoi passer √† ASP.NET Core? </h2><br>  Avant de passer aux √©tapes de migration d'ASP.NET MVC vers ASP.NET Core, quelques mots sur les avantages de cette plateforme. <br><br><img src="https://habrastorage.org/webt/wo/xg/ue/woxgueorhrjz_brki1qktunkqhe.png"><br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Avantages d'ASP.NET Core</b> <div class="spoiler_text">  Ainsi, ASP.NET Core est d√©j√† un framework assez bien connu et d√©velopp√©, qui a d√©j√† subi plusieurs mises √† jour majeures, ce qui signifie qu'il est aujourd'hui assez stable, technologiquement avanc√© et r√©sistant aux attaques XSRF / CSRF. <br><br>  <b>La multiplateforme</b> est l'une des caract√©ristiques qui lui permettent de gagner de plus en plus en popularit√©.  √Ä partir de maintenant, votre application Web peut fonctionner dans les environnements Windows et Unix. <br><br>  <b>Modularit√©</b> - ASP.NET Core se pr√©sente enti√®rement sous la forme de packages NuGet, cela vous permet d'optimiser l'application, y compris les packages n√©cessaires s√©lectionn√©s.  Cela am√©liore les performances de la solution et r√©duit le temps n√©cessaire √† la mise √† niveau des pi√®ces individuelles.  Il s'agit de la deuxi√®me fonctionnalit√© importante qui permet aux d√©veloppeurs d'int√©grer de mani√®re plus flexible de nouvelles fonctionnalit√©s dans leur solution. <br><br>  <b>Les performances</b> sont une autre √©tape vers la cr√©ation d'une application hautes performances, ASP.NET Core traite 2300% de requ√™tes en plus par seconde qu'ASP.NET 4.6, et 800% de requ√™tes en plus par seconde que node.js.  Vous pouvez examiner vous-m√™me les tests de performances d√©taill√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><img src="https://habrastorage.org/webt/wb/vg/oi/wbvgoixwdbcfr0m8l0myjywrlpq.png"><br><br>  <b>Le middleware</b> est le nouveau pipeline modulaire l√©ger et hautes performances pour les requ√™tes in-app.  Chaque √©l√©ment de middleware traite une demande HTTP, puis d√©cide de renvoyer le r√©sultat ou transmet le morceau de middleware suivant.  Cette approche donne au d√©veloppeur un contr√¥le total sur le pipeline HTTP et contribue au d√©veloppement de modules simples pour l'application, ce qui est important pour un projet open source en pleine croissance. <br><br>  ASP.NET Core MVC fournit des fonctionnalit√©s qui simplifient le d√©veloppement Web.  NopCommerce utilisait d√©j√† des fonctionnalit√©s telles que le mod√®le Model-View-Controller, la syntaxe Razor, la liaison et la validation de mod√®le, mais de nouveaux outils sont apparus: <br><br><ul><li>  Tag Helpers.  Il s'agit d'un code c√¥t√© serveur pour contribuer √† la cr√©ation et au rendu des √©l√©ments HTML dans les fichiers Razor. </li><li>  Afficher les composants.  Il s'agit d'un nouvel outil, similaire aux vues partielles, mais beaucoup plus puissant.  nopCommerce utilise des composants de vue lorsque la r√©utilisation de la logique de rendu est requise et lorsque la t√¢che est trop complexe pour une vue partielle. </li><li>  Le point de vue de DI.  Bien que la plupart des donn√©es affich√©es dans les vues proviennent du contr√¥leur, nopCommerce a des vues dans lesquelles l'injection de d√©pendance est plus pratique. </li></ul><br>  Bien s√ªr, ASP.NET Core a beaucoup plus de fonctionnalit√©s, mais nous venons d'examiner les plus int√©ressantes. </div></div><br>  Parlons maintenant de ce que vous devez consid√©rer lors du portage de votre application vers une nouvelle plateforme. <br><br><h2>  La migration </h2><br>  Le texte contiendra un grand nombre de liens vers la documentation officielle d'ASP.NET Core pour vous aider √† obtenir des informations plus d√©taill√©es sur le sujet.  Particuli√®rement pertinent pour les d√©veloppeurs confront√©s √† une t√¢che similaire pour la premi√®re fois. <br><br><h3>  √âtape 1. Pr√©paration des outils </h3><br>  La premi√®re chose que vous devez faire est de mettre √† niveau Visual Studio 2017 vers la version 15.3 ou sup√©rieure.  Et installez la derni√®re version du SDK .NET Core. <br><br>  Avant de commencer la migration, il est recommand√© d'utiliser l'outil d'analyse de portabilit√© .NET <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">.Net Portability Analyzer</a> .  C'est un bon point de d√©part pour comprendre √† quel point la transition d'une plate-forme √† une autre sera laborieuse.  Mais, bien s√ªr, cet outil ne r√©sout pas tous les probl√®mes et, dans le processus, il y aura de nombreux pi√®ges.  Ensuite, les principales √©tapes qui devront √™tre franchies seront d√©crites et les solutions utilis√©es dans notre projet seront pr√©sent√©es. <br><br>  La toute premi√®re chose dont vous avez besoin est de mettre √† jour les liens vers les biblioth√®ques utilis√©es dans le projet qui prendraient en charge .NET Standard. <br><br><h3>  √âtape 2. Analyse de compatibilit√© des packages NuGet pour prendre en charge la norme .Net </h3><br>  Si vous utilisez des packages NuGet dans votre projet, vous devez v√©rifier s'ils sont compatibles avec .NET Core.  Pour cela, vous pouvez utiliser l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NuGetPackageExplorer</a> . <br><br><h3>  √âtape 3. .NET Core utilise le nouveau format de fichier csproj </h3><br>  Il est important d'utiliser la nouvelle approche pour ajouter des liens tiers introduits dans .NET Core: lorsqu'une nouvelle biblioth√®que de classes est ajout√©e √† la solution, vous devez ouvrir le fichier de projet principal et remplacer son contenu par ce qui suit: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sdk</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.NET.Sdk"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp2.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.AspNetCore.App"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2.2.6"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Les liens des biblioth√®ques connect√©es seront t√©l√©charg√©s automatiquement.  Plus d'informations sur le mappage entre les propri√©t√©s project.json et CSPROJ peuvent √™tre trouv√©es dans la documentation officielle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h3>  √âtape 4. Mise √† jour de l'espace de noms </h3><br>  Vous devez supprimer toutes les utilisations de System.Web et les remplacer par Microsoft.AspNetCore. <br><br><h3>  √âtape 5. Vous devez configurer le fichier Startup.cs.  au lieu d'utiliser global.asax </h3><br>  ASP.NET Core dispose d'un nouveau m√©canisme de chargement de l'application.  Le point d'entr√©e de l'application devient <code>Startup</code> et la d√©pendance au fichier <i>Global.asax</i> dispara√Æt.  <code>Startup</code> enregistre la suite middleware dans l'application.  <code>Startup</code> doit inclure la m√©thode <code>Configure</code> .  Dans <code>Configure</code> ajoutez le middleware requis au pipeline. <br><br>  <b>Probl√®mes Startup.cs</b> <br><br><ol><li>  Configuration du middleware pour les requ√™tes MVC et WebAPI </li><li>  Param√®tres de configuration pour: </li></ol><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gestion des exceptions</a> <br><p>  √âtant donn√© que dans le processus de transition, vous devrez in√©vitablement faire face √† diff√©rents types de collisions, vous devez imm√©diatement pr√©parer et configurer la gestion des exceptions dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">environnement de</a> d√©veloppement.  √Ä l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UseDeveloperExceptionPage</a> , un middleware est ajout√© pour intercepter les exceptions. </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Routage MVC</a> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'enregistrement de nouveaux itin√©raires a</a> √©galement √©t√© modifi√©.  IRouteBuilder est d√©sormais utilis√© √† la place de RouteCollection, une nouvelle fa√ßon d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">enregistrer les contraintes</a> (IActionConstraint) </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Filtres MVC / WebAPI</a> <br><p>  Il est n√©cessaire de r√©√©crire les filtres conform√©ment √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouvelle impl√©mentation d'ASP.NET Core</a> . </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Formateurs</a> MVC / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WebAPI</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mod√®les de reliure</a> </li></ul><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//add basic MVC feature var mvcBuilder = services.AddMvc(); //add custom model binder provider (to the top of the provider list) mvcBuilder.AddMvcOptions(options =&gt; options.ModelBinderProviders.Insert(0, new NopModelBinderProvider())); /// &lt;summary&gt; /// Represents model binder provider for the creating NopModelBinder /// &lt;/summary&gt; public class NopModelBinderProvider : IModelBinderProvider { /// &lt;summary&gt; /// Creates a nop model binder based on passed context /// &lt;/summary&gt; /// &lt;param name="context"&gt;Model binder provider context&lt;/param&gt; /// &lt;returns&gt;Model binder&lt;/returns&gt; public IModelBinder GetBinder(ModelBinderProviderContext context) { if (context == null) throw new ArgumentNullException(nameof(context)); var modelType = context.Metadata.ModelType; if (!typeof(BaseNopModel).IsAssignableFrom(modelType)) return null; //use NopModelBinder as a ComplexTypeModelBinder for BaseNopModel if (context.Metadata.IsComplexType &amp;&amp; !context.Metadata.IsCollectionType) { //create binders for all model properties var propertyBinders = context.Metadata.Properties .ToDictionary(modelProperty =&gt; modelProperty, modelProperty =&gt; context.CreateBinder(modelProperty)); return new NopModelBinder(propertyBinders, EngineContext.Current.Resolve&lt;ILoggerFactory&gt;()); } //or return null to further search for a suitable binder return null; } }</span></span></code> </pre> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Domaines</a> </li></ul><br><br><pre> <code class="java hljs">app.UseMvc(routes =&gt; { routes.MapRoute(<span class="hljs-string"><span class="hljs-string">"areaRoute"</span></span>, <span class="hljs-string"><span class="hljs-string">"{area:exists}/{controller=Admin}/{action=Index}/{id?}"</span></span>); routes.MapRoute( name: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"{controller=Home}/{action=Index}/{id?}"</span></span>); });</code> </pre> <br>  Dans le m√™me temps, le dossier portant le nom Area, dans lequel se trouve le dossier Admin, doit √™tre plac√© √† la racine de l'application.  D√©sormais, l'attribut <code>[Area("Admin")] [Route("admin")]</code> sera utilis√© pour connecter le contr√¥leur √† cette zone. <br>  Il ne reste plus qu'√† cr√©er des vues pour toutes les actions d√©crites dans le contr√¥leur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3o/eo/rp/3oeorp_vjlbwlisc1kbavvvaeoe.png"></div><br><pre> <code class="java hljs">[Area(<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>)] [Route(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdminController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } }</code> </pre> <br>  <b>Validation</b> <br><br>  Maintenant, vous n'avez pas besoin de transmettre IFormCollection aux contr√¥leurs, car dans ce cas, la validation du serveur asp.net est d√©sactiv√©e - MVC supprime toute validation suppl√©mentaire si IFormCollection n'est pas nul.  La solution au probl√®me peut √™tre d'ajouter cette propri√©t√© au mod√®le, cela nous √©vitera de passer directement √† la m√©thode du contr√¥leur.  Cette r√®gle n'est valide que si un mod√®le est pr√©sent, mais s'il n'y a pas de mod√®le, alors il n'y aura pas de validation. <br><br>  Les propri√©t√©s enfants ne sont plus automatiquement valid√©es.  Il doit √™tre sp√©cifi√© manuellement. <br><br><h3>  √âtape 6. Transfert des gestionnaires HTTP et des modules HTTP vers le middleware </h3><br>  Les gestionnaires HTTP et les modules HTTP sont essentiellement tr√®s similaires au concept de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.microsoft.com/ru-ru/aspnet/core/migration/">middleware dans ASP.NET Core</a> , mais contrairement aux modules, l'ordre des middlewares est bas√© sur l'ordre dans lequel ils sont ins√©r√©s dans le pipeline de demande.  L'ordre des modules, pour la plupart, est bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> √©v√©nements du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cycle de vie de l'application</a> .  L'ordre du middleware pour les r√©ponses est l'inverse de l'ordre des requ√™tes, et l'ordre des modules pour les requ√™tes et les r√©ponses est le m√™me. Sur cette base, vous pouvez proc√©der √† la mise √† niveau. <br><br>  Alors, ce qui reste √† mettre √† jour: <br><br><ul><li>  Migration de modules pour Middleware (AuthenticationMiddleware, CultureMiddleware, etc.) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.microsoft.com/en-us/aspnet/core/migration/">Gestionnaires</a> du middleware </li><li>  Utilisation d'un nouveau middleware </li></ul><br>  L'authentification dans notre projet n'utilise pas le syst√®me d'informations d'identification int√©gr√©; √† ces fins, le middleware AuthenticationMiddleware est utilis√©, d√©velopp√© conform√©ment √† la nouvelle structure ASP.NET Core. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthenticationMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly RequestDelegate _next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AuthenticationMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IAuthenticationSchemeProvider schemes, RequestDelegate next)</span></span></span><span class="hljs-function"> </span></span>{ Schemes = schemes ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(nameof(schemes)); _next = next ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(nameof(next)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IAuthenticationSchemeProvider Schemes { get; set; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpContext context)</span></span></span><span class="hljs-function"> </span></span>{ context.Features.Set&lt;IAuthenticationFeature&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationFeature { OriginalPath = context.Request.Path, OriginalPathBase = context.Request.PathBase }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handlers = context.RequestServices.GetRequiredService&lt;IAuthenticationHandlerProvider&gt;(); foreach (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scheme in await Schemes.GetRequestHandlerSchemesAsync()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (await handlers.GetHandlerAsync(context, scheme.Name) is IAuthenticationRequestHandler handler &amp;&amp; await handler.HandleRequestAsync()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ignored } } var defaultAuthenticate = await Schemes.GetDefaultAuthenticateSchemeAsync(); if (defaultAuthenticate != null) { var result = await context.AuthenticateAsync(defaultAuthenticate.Name); if (result?.Principal != null) { context.User = result.Principal; } } await _next(context); } }</span></span></code> </pre> <br>  ASP.NET fournit de nombreux middleware int√©gr√©s que vous pouvez utiliser dans votre application, mais notez que le d√©veloppeur a la possibilit√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de cr√©er son propre middleware</a> et de l'ajouter au pipeline de requ√™tes HTTP.  Pour simplifier ce m√©canisme, nous avons ajout√© une interface sp√©ciale, et maintenant il suffit de cr√©er une classe qui l'impl√©mente. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INopStartup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Add and configure any of the middleware /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; /// &lt;param name="configuration"&gt;Configuration of the application&lt;/param&gt; void ConfigureServices(IServiceCollection services, IConfiguration configuration); /// &lt;summary&gt; /// Configure the using of added middleware /// &lt;/summary&gt; /// &lt;param name="application"&gt;Builder for configuring an application's request pipeline&lt;/param&gt; void Configure(IApplicationBuilder application); /// &lt;summary&gt; /// Gets order of this startup configuration implementation /// &lt;/summary&gt; int Order { get; } }</span></span></code> </pre> <br>  Ici, vous pouvez ajouter et configurer votre middleware: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Represents object for the configuring authentication middleware on application startup /// &lt;/summary&gt; public class AuthenticationStartup : INopStartup { /// &lt;summary&gt; /// Add and configure any of the middleware /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; /// &lt;param name="configuration"&gt;Configuration of the application&lt;/param&gt; public void ConfigureServices(IServiceCollection services, IConfiguration configuration) { //add data protection services.AddNopDataProtection(); //add authentication services.AddNopAuthentication(); } /// &lt;summary&gt; /// Configure the using of added middleware /// &lt;/summary&gt; /// &lt;param name="application"&gt;Builder for configuring an application's request pipeline&lt;/param&gt; public void Configure(IApplicationBuilder application) { //configure authentication application.UseNopAuthentication(); } /// &lt;summary&gt; /// Gets order of this startup configuration implementation /// &lt;/summary&gt; public int Order =&gt; 500; //authentication should be loaded before MVC }</span></span></code> </pre> <br><h3>  √âtape 7. Utilisation de DI int√©gr√© </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'</a> injection de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©pendances</a> est l'une des fonctionnalit√©s cl√©s du processus de conception d'application dans ASP.NET Core.  Il vous permet de cr√©er des applications √† couplage l√¢che qui sont plus testables, modulaires et, par cons√©quent, maintenables.  Cela a √©t√© rendu possible en suivant le principe de l'inversion de d√©pendance.  Pour installer les d√©pendances, des conteneurs IoC (Inversion of Control) sont utilis√©s.  Dans ASP.NET Core, un tel conteneur est repr√©sent√© par l'interface IServiceProvider.  Les services sont install√©s dans l'application dans la m√©thode <code>Startup.ConfigureServices()</code> . <br><br>  Tout service enregistr√© peut √™tre configur√© avec trois √©tendues: <br><br><ul><li>  transitoire </li><li>  port√©e </li><li>  singleton </li></ul><br><pre> <code class="java hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddSingleton&lt;Isingleton,MySingleton&gt;();</code> </pre> <br><h3>  √âtape 8. Utilisation de shells de compatibilit√© de projet WebAPI (Shim) </h3><br>  Pour simplifier la migration d'une impl√©mentation d'API Web existante, il est recommand√© d'utiliser le package NuGet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Microsoft.AspNetCore.Mvc.WebApiCompatShim</a> .  Les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctions compatibles suivantes sont</a> prises en charge: <br><br><ul><li>  Ajoute le type ApiController </li><li>  Active la liaison de mod√®le de style API Web </li><li>  √âtend la liaison de mod√®le afin que les actions du contr√¥leur puissent accepter des param√®tres de type HttpRequestMessage. </li><li>  Ajoute des formateurs de messages qui permettent aux actions de renvoyer des r√©sultats de type HttpResponseMessage </li></ul><br><pre> <code class="java hljs">services.AddMvc().AddWebApiConventions(); routes.MapWebApiRoute(name: <span class="hljs-string"><span class="hljs-string">"DefaultApi"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"api/{controller}/{id?}"</span></span> );</code> </pre> <br><h3>  √âtape 9. Transfert de la configuration de l'application </h3><br>  Auparavant, certains param√®tres √©taient enregistr√©s dans le fichier web.config.  Nous adoptons maintenant une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouvelle approche</a> bas√©e sur des paires cl√©-valeur √©tablies <i>par les fournisseurs de configuration</i> .  Il s'agit du m√©canisme recommand√© dans ASP.NET Core et nous utilisons le fichier appsettings.json. <br><br>  Vous pouvez √©galement utiliser le package NuGet <code>System.Configuration.ConfigurationManager</code> si, pour une raison quelconque, vous souhaitez continuer √† utiliser * .config.  Dans ce cas, vous devrez abandonner la possibilit√© d'ex√©cuter l'application sur les plates-formes Unix et de l'ex√©cuter uniquement sous IIS. <br><br>  Si vous souhaitez utiliser le fournisseur de configuration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Azure Key Vault</a> , vous devez vous r√©f√©rer au contenu Content <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration to Azure Key Valut</a> .  Dans notre projet, ce n'√©tait pas la t√¢che. <br><br><h3>  √âtape 10. Transfert de contenu statique vers wwwroot </h3><br>  Pour diffuser du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contenu statique,</a> vous devez indiquer √† l'h√¥te Web la racine du contenu du r√©pertoire en cours.  La valeur par d√©faut est wwwroot.  Vous pouvez personnaliser votre r√©pertoire pour stocker des fichiers statiques en configurant un middleware. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b7/z1/s7/b7z1s7pkzbd2yrkqukxcfholuus.png"></div><br><br><h3>  √âtape 11. Portage d'EntityFramework vers EF Core </h3><br>  Si le projet utilise des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctionnalit√©s</a> sp√©cifiques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d'Entity Framework 6</a> qui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne</a> sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pas prises</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">charge</a> dans <code>EF Core</code> , il est logique d'ex√©cuter l'application sur <code>NET Framework</code> .  Dans ce cas, cependant, vous devez sacrifier la multiplateforme.  L'application ne fonctionnera que sous Windows et sous IIS. <br><br>  <b>Jetons un coup d'≈ìil aux principaux changements √† prendre en compte:</b> <br><br><ul><li>  Espace de noms System.Data.Entity remplac√© par Microsoft.EntityFrameworkCore </li><li>  La signature du constructeur DbContext a √©t√© modifi√©e.  Vous devez maintenant injecter DbContextOptions </li><li>  M√©thode HasDatabaseGeneratedOption (DatabaseGeneratedOption.None) remplac√©e par ValueGeneratedNever () </li><li>  WillCascadeOnDelete (false), m√©thode remplac√©e par OnDelete (DeleteBehavior.Restrict) </li><li>  M√©thode OnModelCreating (DbModelBuilder modelBuilder) remplac√©e par la m√©thode OnModelCreating (ModelBuilder modelBuilder) </li><li>  La m√©thode HasOptional n'est plus disponible </li><li>  la configuration des objets est modifi√©e, vous devez maintenant utiliser OnModelCreating, car  EntityTypeConfiguration n'est plus disponible </li><li>  L'attribut ComplexType n'est plus disponible </li><li>  Remplacement de l'interface IDbSet par DbSet </li><li>  ComplexType - la prise en charge des types complexes est apparue dans EF Core 2 avec le type Entit√© d√©tenue ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.microsoft.com/en-us/ef/core/modeling/ownedentities</a> ) et les tables sans cl√© primaire avec QueryType dans EF Core 2.1 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.microsoft.com/en-us/ef/core/modeling/query-types</a> ) </li><li>  les cl√©s √©trang√®res dans EF Core g√©n√®rent des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">propri√©t√©s d'ombre en</a> utilisant le mod√®le Id [Entity], contrairement √† EF6, qui utilise le mod√®le _Id [Entity].  Par cons√©quent, ajoutez d'abord des cl√©s √©trang√®res en tant que propri√©t√© r√©guli√®re √† l'entit√©. </li><li>  Pour prendre en charge DI pour DbContext, configurez votre DbContex dans <code>ConfigureServices</code> </li></ul><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Register base object context /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; public static void AddNopObjectContext(this IServiceCollection services) { services.AddDbContextPool&lt;NopObjectContext&gt;(optionsBuilder =&gt; { optionsBuilder.UseSqlServerWithLazyLoading(services); }); } /// &lt;summary&gt; /// SQL Server specific extension method for Microsoft.EntityFrameworkCore.DbContextOptionsBuilder /// &lt;/summary&gt; /// &lt;param name="optionsBuilder"&gt;Database context options builder&lt;/param&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; public static void UseSqlServerWithLazyLoading(this DbContextOptionsBuilder optionsBuilder, IServiceCollection services) { var nopConfig = services.BuildServiceProvider().GetRequiredService&lt;NopConfig&gt;(); var dataSettings = DataSettingsManager.LoadSettings(); if (!dataSettings?.IsValid ?? true) return; var dbContextOptionsBuilder = optionsBuilder.UseLazyLoadingProxies(); if (nopConfig.UseRowNumberForPaging) dbContextOptionsBuilder.UseSqlServer(dataSettings.DataConnectionString, option =&gt; option.UseRowNumberForPaging()); else dbContextOptionsBuilder.UseSqlServer(dataSettings.DataConnectionString); }</span></span></code> </pre><br>  Utilisez l'outil de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comparaison SQL</a> pour v√©rifier que <code>EF Core</code> g√©n√®re un sch√©ma de base de donn√©es similaire √† <code>Entity Framework</code> lors de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">migration</a> . <br><br><h3>  √âtape 12. Suppression de toutes les r√©f√©rences HttpContext, remplacement des classes obsol√®tes et modification de l'espace de noms </h3><br>  Lors de la migration de votre projet, vous constaterez qu'un nombre suffisamment important de classes ont √©t√© renomm√©es ou d√©plac√©es, et vous devez maintenant tout mettre en conformit√© avec les nouvelles exigences.  Voici une liste des principales transitions que vous pouvez rencontrer: <br><br><ul><li>  HttpPostedFileBase -&gt; IFormFile </li><li>  L'acc√®s pour acc√©der √† HttpContext se fait maintenant via IHttpContextAccessor </li><li>  HtmlHelper -&gt; IHtmlHelper </li><li>  ActionResult -&gt; IActionResult </li><li>  HttpUtility -&gt; WebUtility </li><li>  Au lieu de HttpSessionStateBase - ISession, est accessible √† partir de HttpContext.Session.  de Microsoft.AspNetCore.Http </li><li>  Request.Cookies renvoie IRequestCookieCollection: IEnumerable &lt;KeyValuePair &lt;cha√Æne, cha√Æne &gt;&gt;, donc au lieu de HttpCookie, KeyValuePair &lt;cha√Æne, cha√Æne&gt; de Microsoft.AspNetCore.Http </li></ul><br>  Remplacement de l'espace de noms: <br><br><ul><li>  SelectList -&gt; Microsoft.AspNetCore.Mvc.Rendering </li><li>  UrlHelper -&gt; WebUtitlity </li><li>  MimeMapping -&gt; FileExtensionContentTypeProvider </li><li>  MvcHtmlString -&gt; IHtmlString et HtmlString </li><li>  ModelState, ModelStateDictionary, ModelError -&gt; Microsoft.AspNetCore.Mvc.ModelBinding </li><li>  FormCollection -&gt; IFormCollection </li><li>  Request.Url.Scheme -&gt; this.Url.ActionContext.HttpContext.Request.Scheme </li></ul><br>  Autre: <br><br><ul><li>  MvcHtmlString.IsNullOrEmpty (IHtmlString) -&gt; String.IsNullOrEmpty (variable.ToHtmlString ()) </li><li>  [ValidateInput (false)] - ce n'est g√©n√©ralement plus et n'est pas n√©cessaire </li><li>  HttpUnauthorizedResult -&gt; UnauthorizedResult </li><li>  [AllowHtml] - il n'y a plus de directive et ce n'est pas n√©cessaire </li><li>  La m√©thode TagBuilder.SetInnerText a √©t√© remplac√©e - c'est maintenant InnerHtml.AppendHtml </li><li>  JsonRequestBehavior.AllowGet lorsque le retour de Json n'est plus n√©cessaire </li><li>  HttpUtility.JavaScriptStringEncode.  -&gt; JavaScriptEncoder.Default.Encode </li><li>  Request.RawUrl.  Il est n√©cessaire de connecter s√©par√©ment Request.Path + Request.QueryString </li><li>  AllowHtmlAttribute - plus de classe </li><li>  XmlDownloadResult - maintenant vous pouvez utiliser simplement renvoyer File (Encoding.UTF8.GetBytes (xml), "application / xml", "filename.xml"); </li><li>  [ValidateInput (false)] - il n'y a plus de directive et ce n'est pas n√©cessaire </li></ul><br><h3>  √âtape 13. Mise √† jour de l'authentification et de l'autorisation </h3><br>  J'ai d√©j√† √©crit ci-dessus que dans notre projet, l'authentification n'est pas impl√©ment√©e √† l'aide du syst√®me d'identit√© int√©gr√©, mais est supprim√©e dans une couche distincte de middleware.  Cependant, ASP.NET Core poss√®de son propre m√©canisme pour fournir des informations d'identification.  Plus de d√©tails peuvent √™tre trouv√©s dans la documentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Quant √† la protection des donn√©es - nous n'utilisons plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MachineKey</a> .  Au lieu de cela, nous utilisons la fonction de protection des donn√©es int√©gr√©e.  Par d√©faut, les cl√©s sont g√©n√©r√©es au d√©marrage de l'application.  L'entrep√¥t de donn√©es peut √™tre: <br><br><ul><li>  Syst√®me de fichiers - fichier de cl√©s bas√© sur le syst√®me de fichiers </li><li>  Azure Storage - Cl√©s de protection des donn√©es dans Azure Blob Storage </li><li>  Redis - Cl√©s de protection des donn√©es dans le cache Redis </li><li>  Registre - doit √™tre utilis√© si l'application n'a pas acc√®s au syst√®me de fichiers </li><li>  EF Core - les cl√©s sont stock√©es dans la base de donn√©es </li></ul><br>  Si les m√©canismes int√©gr√©s ne conviennent pas, vous pouvez sp√©cifier votre propre m√©canisme de stockage de cl√©s en fournissant un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IXmlRepository</a> personnalis√©. <br><br><h3>  √âtape 14. Mise √† jour de JS / CSS </h3><br>  La fa√ßon de travailler avec les ressources statiques a chang√©: maintenant, toutes doivent √™tre stock√©es dans le dossier racine du projet <i>wwwroot</i> , √† moins, bien s√ªr, que d'autres param√®tres ne soient sp√©cifi√©s. <br><br>  Lorsque vous utilisez des blocs en ligne javascript, il est recommand√© de les d√©placer √† la fin de la page.  Utilisez simplement l'attribut asp-location = "Footer" pour vos balises.  La m√™me r√®gle s'applique aux fichiers js. <br><br>  Utilisez l'extension <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BundlerMinifier</a> en remplacement de System.Web.Optimization - cela vous permettra de lier et de minimiser JavaScript et CSS lors de la construction du projet.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien</a> vers la documentation. <br><br><h3>  √âtape 15. Migration des vues </h3><br>  Les actions enfants ne sont plus utilis√©es.  Au lieu de cela, ASP.NET Core propose un nouvel outil puissant - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ViewComponents</a> , qui est appel√© de mani√®re asynchrone. <br><br>  Comment obtenir une cha√Æne de ViewComponent: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Render component to string /// &lt;/summary&gt; /// &lt;param name="componentName"&gt;Component name&lt;/param&gt; /// &lt;param name="arguments"&gt;Arguments&lt;/param&gt; /// &lt;returns&gt;Result&lt;/returns&gt; protected virtual string RenderViewComponentToString(string componentName, object arguments = null) { if (string.IsNullOrEmpty(componentName)) throw new ArgumentNullException(nameof(componentName)); var actionContextAccessor = HttpContext.RequestServices.GetService(typeof(IActionContextAccessor)) as IActionContextAccessor; if (actionContextAccessor == null) throw new Exception("IActionContextAccessor cannot be resolved"); var context = actionContextAccessor.ActionContext; var viewComponentResult = ViewComponent(componentName, arguments); var viewData = ViewData; if (viewData == null) { throw new NotImplementedException(); } var tempData = TempData; if (tempData == null) { throw new NotImplementedException(); } using (var writer = new StringWriter()) { var viewContext = new ViewContext( context, NullView.Instance, viewData, tempData, writer, new HtmlHelperOptions()); // IViewComponentHelper is stateful, we want to make sure to retrieve it every time we need it. var viewComponentHelper = context.HttpContext.RequestServices.GetRequiredService&lt;IViewComponentHelper&gt;(); (viewComponentHelper as IViewContextAware)?.Contextualize(viewContext); var result = viewComponentResult.ViewComponentType == null ? viewComponentHelper.InvokeAsync(viewComponentResult.ViewComponentName, viewComponentResult.Arguments): viewComponentHelper.InvokeAsync(viewComponentResult.ViewComponentType, viewComponentResult.Arguments); result.Result.WriteTo(writer, HtmlEncoder.Default); return writer.ToString(); } }</span></span></code> </pre> <br>  Il n'est plus n√©cessaire d'utiliser HtmlHelper - ASP.NET Core dispose d'un grand nombre de fonctions de balise d'assistance ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tag Helpers</a> ) int√©gr√©es.  Lorsque l'application est en cours d'ex√©cution, elles sont trait√©es par le moteur Razor c√¥t√© serveur et sont finalement converties en √©l√©ments html standard.  Cela simplifie consid√©rablement le d√©veloppement d'applications.  Et, bien s√ªr, vous pouvez impl√©menter vos propres balises. <br><br>  Nous avons commenc√© √† utiliser l'injection de d√©pendances dans les vues au lieu d'autoriser les param√®tres et les services √† l'aide de <code>EngineContext</code> . <br><br>  Donc, les principaux points sur la migration des vues: <br><br><ul><li>  Convertissez <code>Views/web.config  Views/_ViewImports.cshtml</code> - utilis√© pour importer des espaces de noms et <code>Views/web.config  Views/_ViewImports.cshtml</code> d√©pendances.  Ce fichier ne prend pas en charge d'autres fonctions <code>Razor</code> , telles que les d√©finitions de fonctions et de sections. </li><li>  Convertir <code>namespaces.add</code> en <code>@using</code> </li><li>  Transf√©rez tous les param√®tres dans la configuration principale de l'application </li><li>  <code>Scripts.Render</code> et <code>Styles.Render</code> n'existe pas.  Remplacez <code>libman</code> ou <code>BundlerMinifier</code> liens vers la sortie </li></ul><br><h2>  En conclusion </h2><br>  Notre exp√©rience nous a montr√© que le processus de migration d'une grande application Web est une t√¢che tr√®s chronophage qui peut difficilement √™tre r√©alis√©e sans √©cueils.  Nous avions pr√©vu de passer √† un nouveau framework d√®s la sortie de sa premi√®re version stable, mais nous n'avons pas pu le terminer tout de suite: il y avait certaines fonctions critiques qui n'avaient pas encore √©t√© transf√©r√©es vers .NET Core, en particulier, li√©es √† EntityFramework.  Par cons√©quent, nous avons d√ª d'abord publier la prochaine version en utilisant une approche mixte - l'architecture .NET Core avec les d√©pendances .NET Framework. <br><br>  Nous avons pu adapter compl√®tement le projet apr√®s la sortie de .NET Core 2.1, ayant √† l'√©poque une solution stable fonctionnant d√©j√† sur la nouvelle architecture - il ne restait plus qu'√† remplacer certains packages et r√©√©crire le travail avec EF Core.  Ainsi, la migration compl√®te vers le nouveau framework a n√©cessit√© plusieurs mois de travail. <br><br>  Vous pouvez en savoir plus sur notre projet dans notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel sur GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472738/">https://habr.com/ru/post/fr472738/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472720/index.html">L'ERP ne fonctionne pas ... Quelle est l'alternative? ou juste √† temps. Pour la Russie?</a></li>
<li><a href="../fr472724/index.html">Introduction √† skydive.network</a></li>
<li><a href="../fr472726/index.html">Am√©lioration de l'immunit√© au bruit Arduino</a></li>
<li><a href="../fr472730/index.html">Ivanovo! Mitap en l'honneur du 10e anniversaire de Node.js</a></li>
<li><a href="../fr472736/index.html">Webinaire ouvert "Introduction √† l'automatisation des tests d'applications mobiles sur S√©l√©nium et Appium"</a></li>
<li><a href="../fr472744/index.html">Le MRP ne fonctionne pas ... Quelle est l'alternative?</a></li>
<li><a href="../fr472746/index.html">Serveur de terminal pour administrateur; Pas un seul √©cart SSH</a></li>
<li><a href="../fr472748/index.html">Navigateur s√©mantique ou vie sans sites</a></li>
<li><a href="../fr472750/index.html">OK, ai-je vraiment besoin de Kubernetes?</a></li>
<li><a href="../fr472752/index.html">CSE: Kubernetes pour n'importe qui dans vCloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>