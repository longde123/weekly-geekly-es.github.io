<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📵 🚛 🎌 投票失败：我们将AgentTesla带到干净的水中。 第三部分 👩🏾‍🤝‍👩🏼 👨🏾‍🎓 👩‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="通过本文，我们将完成一系列致力于恶意软件分析的出版物。 在第一部分中，我们对一家欧洲公司通过邮件收到的受感染文件进行了详细分析，并在其中找到了AgentTesla间谍软件。 第二部分描述了主要AgentTesla模块的分阶段分析结果。 

 今天，CERT Group-IB恶意软件分析专家Ilya ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>投票失败：我们将AgentTesla带到干净的水中。 第三部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/481078/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vz/an/r5/vzanr5kxitvhd3zqrcdh1qhctjm.png"></div><br><br> 通过本文，我们将完成一系列致力于恶意软件分析的出版物。 在<a href="https://habr.com/ru/company/group-ib/blog/478176/">第一部分中，</a>我们对一家欧洲公司通过邮件收到的受感染文件进行了详细分析，并在其中找到了AgentTesla间谍软件。  <a href="https://habr.com/ru/company/group-ib/blog/479120/">第二部分</a>描述了主要AgentTesla模块的分阶段分析结果。 <br><br> 今天，CERT Group-IB恶意软件分析专家Ilya Pomerantsev将讨论恶意软件分析的第一阶段-使用来自CERT Group-IB专家实践的三个小型案例对AgentTesla样本进行半自动拆包。 <a name="habracut"></a><br><br> 通常，分析恶意软件的第一步是取消保护程序，包括打包程序，加密程序，临时程序或引导程序。 在大多数情况下，可以通过启动恶意软件并进行转储来解决此问题，但是在某些情况下，此方法不合适。 例如，如果恶意软件是加密程序，保护其内存区域免受转储，代码中包含用于检测虚拟机的机制，或者恶意软件在启动后立即执行重新引导。 在这种情况下，将使用所谓的“半自动”拆包，即研究人员可以完全控制该过程，并且可以随时进行干预。 以AgentTesla系列的三个样本为例，考虑此过程。 如果禁用其网络访问权限，则这是一种相对无害的恶意软件。 <br><br><h2> 样品编号1 <br></h2><br> 源文件是利用漏洞CVE-2017-11882的MS Word文档。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/se/n2/oy/sen2oymx-j-modsjdtrynz8_rku.png"></div><br> 结果，有效载荷被加载并启动。 <br><br> 对进程树和行为标记的分析显示，已注入<b>RegAsm.exe</b>进程。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sm/-v/d5/sm-vd50chyqlggzigduei7bip-m.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zt/rm/qq/ztrmqqqggwsf_ztrc2tzhwwxcms.png"></div><br> 提供了AgentTesla特定的行为标记。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nr/qb/ro/nrqbro_k9d1_n0br9zez0b4sbtm.png"></div><br> 下载的样本是一个受<b>.NET Reactor</b>保护<b>器</b>保护的可执行<b>.NET</b>文件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/m5/s1/gim5s1jzafhrcnwl1gbcawvqc1a.png"></div><br> 在<b>dnSpy x86</b>实用程序中将其打开，然后移至入口点。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nz/m1/3g/nzm13gikyff5kdvxm7nww4p_ask.png"></div><br> 进入<b>DateTimeOffset</b>函数，我们找到新<b>.NET</b>模块的初始化代码。 在我们感兴趣的行上放置一个<b>断点</b>并运行文件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7a/7a/cj/7a7acjpjgqv0qiftf6mlonjxuy0.png"></div><br> 在返回的缓冲区之一中，您可以看到MZ签名（ <b>0x4D 0x5A</b> ）。 保存。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/dc/fb/kidcfbitazutwlav20ihuimj1sw.png"></div><br> 转储的可执行文件是一个动态库，它是一个加载器，即 从资源部分提取有效负载并启动它。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/45/lh/5j/45lh5j34n5pflsbwjvunofgbykk.png"></div><br> 同时，必需的资源本身在转储中不可用。 它们在父样本中。 <br><br>  <b>dnSpy</b>实用程序具有两个非常有用的功能，它们将帮助我们从两个链接的文件中快速创建科学怪人。 <br><br><ol><li> 第一个允许您将动态库“粘贴”到父样本中。 <br><br><img src="https://habrastorage.org/webt/2f/rb/yd/2frbydn7-vz764pf5oqs-5xqglm.png"></li><li> 第二种方法是在入口点重写功能代码，以调用插入的动态库的所需方法。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zy/3i/72/zy3i72xavtsynr_bauq5nyazqzm.png"></div></li></ol><br> 我们保存“ Frankenstein”，将<b>断点</b>放在返回具有解密资源的缓冲区的行上，然后与上一步类似地进行转储。 <br><br> 第二个转储是用<b>VB.NET</b>编写的可执行文件，该文件受我们<b>已知</b>的<b>ConfuserEx</b>保护器保护。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xj/g9/me/xjg9meooplkgp8l7gfoousosxr4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/le/hi/7c/lehi7ckvlg7i26bj24ox6mhs40u.png"></div><br> 卸下踏板后，我们使用以前编写的YARA规则，并确保解压缩的恶意软件确实是AgentTesla。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/om/hb/qxomhbhkixl1u8jj6lqnjqlzg3a.png"></div><br><br><h2> 样品编号2 <br></h2><br> 源文件是MS Excel文档。 内置宏导致执行恶意代码。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p6/p7/z6/p6p7z6_sccv0gjw608rxwwdzjs0.png"></div><br> 结果，启动了PowerShell脚本。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/o6/h-/i1/o6h-i12l0pshpo1p8fp3porfcck.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sh/l5/o-/shl5o-gwiskazeeyaajb10hglx0.png"></div><br> 该脚本解密C＃中的代码并将控制权转移给它。 该代码本身就是一个加载器，也可以在沙盒报告中看到。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/as/ny/cq/asnycqkaabrg3nwn_bwxsu4idbq.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zo/bk/zz/zobkzz24wctt6ptm6bvsr-igldi.png"></div><br> 有效负载是一个可执行的<b>.NET</b>文件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/c3/6r/s3/c36rs3asfwjorzg686ucedjhgoq.png"></div><br> 通过在<b>dnSpy x86中</b>打开文件，您可以看到它被混淆了。 使用<b>de4dot</b>实用程序消除混淆，然后返回分析。 <br><br> 在代码研究过程中，您可以发现以下功能： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/op/2o/ts/op2otsscifdiprh3mvbee_8fcw8.png"></div><br>  <b>EntryPoint</b>和<b>Invoke</b>编码的字符串<b>引人注目</b> 。 我们<b>将断点</b>放在第一行，开始并保存<b>byte_0</b>缓冲区的值。 <br><br> 转储还是<b>.NET应用程序</b> ，并受<b>ConfuserEx</b>保护。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gc/vr/pj/gcvrpjllett4_ayunmvfchynxoq.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gr/oi/te/groitegnkflmt9aosqlgmgib3wc.png"></div><br> 用<b>de4dot</b>消除混淆并加载到<b>dnSpy中</b> 。 从文件描述中我们<b>了解到</b>我们遇到了<b>CyaX-Sharp loader</b> 。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/52/20/6t/52206tjxrnylcc_g-ayprten39w.png"></div><br> 该引导加载程序具有广泛的反解析功能。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xd/tk/a7/xdtka7g43eqevn6uzn9dd2-j7qi.png"></div><br> 此功能包括绕过内置的Windows保护系统，禁用Windows Defender，以及用于检测沙箱和虚拟机的机制。 可以从网络加载有效负载或将其存储在资源部分中。 通过注入到自己的进程，自己的进程的副本或进程<b>MSBuild.exe</b> ， <b>vbc.exe</b>和<b>RegSvcs.exe中来执行启动</b> ，具体取决于攻击者选择的参数。 <br><br> 但是，对我们来说，它们的重要性不如<b>ConfuserEx</b>添加的<b>AntiDump</b>功能。 它的源代码可以在<a href="">GitHub</a>上<a href="">找到</a> 。 <br><br> 要禁用保护，请使用<b>dnSpy功能</b> ，该<b>功能</b>允许您编辑<b>IL</b>代码。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3l/qf/_h/3lqf_hhmmpxdyczb1uvcc0z7of4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/td/_r/k3/td_rk3haqxgklb20vkobvgw1ny0.png"></div><br> 保存并在有效载荷解密函数的调用行上放置一个<b>断点</b> 。 它在主类的构造函数中。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7h/re/tw/7hretwjlklrjna4gsku1glbvq9e.png"></div><br> 启动并转储有效负载。 使用先前编写的YARA规则，我们确保拥有AgentTesla。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ja/va/p2/javap26-msg8yup-eshiyhgbk8o.png"></div><br><br><h2> 样品编号3 <br></h2><br> 源文件是可执行的<b>VB本机PE32</b>文件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7u/vc/yn/7uvcynbnrfmhglcq9rskdz0vpyo.png"></div><br> 熵分析表明存在大量加密数据。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2g/z4/zq/2gz4zqmn7vmgdftmyzcovpt1m5q.png"></div><br> 在<b>VB Decompiler中</b>分析申请表时<b>，</b>您可能会注意到奇怪的像素背景。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2n/qy/hg/2nqyhg4uktwjbpjtrpblhoiun8o.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hz/mf/qs/hzmfqsgxyqfedt6-lcoiwgy5xok.png"></div><br>  <b>bmp</b>图片的熵图与源文件的熵图相同，并且大小为文件大小的85％。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h8/re/nl/h8renlp6w9_gs0mc3qa8dkj3sme.png"></div><br> 图像的一般视图指示隐写术的使用。 <br><br> 让我们关注过程树的外观以及注入标记的存在。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/un/rw/cf/unrwcfp3pyy8-ww5v91rrjo3nv0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/-z/b4/m_-zb4b0vyjpar3x392toay19qg.png"></div><br> 这表示正在拆箱。 对于Visual Basic上的加载器（又名<b>VBKrypt</b>或<b>VBInjector</b> ），通常使用<b>shellcode</b>初始化有效负载以及执行注入本身。 <br><br> 在<b>VB反编译器</b>中的分析显示， <b>FegatassocAirballoon2</b>表单上存在<b>Load</b>事件。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/va/go/oa/vagooa-hnf7zt5fg5acxdqqf7gq.png"></div><br> 让我们去指定地址的<b>IDA pro</b>并研究其功能。 该代码非常混乱。 下面介绍了我们感兴趣的片段。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/j2/gf/fj/j2gffjeaub6fpcan8f-xjrtzz34.png"></div><br> 这是在进程的地址空间中扫描签名的地方。 这种方法非常令人怀疑。 <br><br> 首先，扫描开始地址为<b>0x400100</b> 。 该值是静态的，在移动底脚时不会调整。 在理想的温室条件下，它将指向可执行文件的<b>PE</b>标头的末尾。 但是，数据库不是静态的，它的值可以更改，并且搜索所需签名的真实地址（尽管它不会导致变量溢出）可能会花费很长时间。 <br><br> 其次， <b>iWGK</b>签名的价值。 我认为很明显4个字节太小，无法保证唯一性。 而且，如果您考虑到第一点，则犯错的可能性就很高。 <br><br> 实际上，所需的片段以偏移量<b>0xA1D0D</b>附加到先前找到的<b>bmp</b>图片的<b>末尾</b> 。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hq/4-/_w/hq4-_wm6mkg_jl0jc87yxkccazg.png"></div><br>  <b>Shellcode</b>分两个阶段运行。 第一个解密主体。 在这种情况下，密钥是通过穷举搜索确定的。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ja/4z/suja4zppdzosqlzol2tfzx1ddum.png"></div><br> 转储解密的<b>Shellcode</b>并查看行。 <br><br> 首先，我们现在知道创建子进程的函数： <b>CreateProcessInternalW</b> 。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pg/jj/ke/pgjjkewljfg9xc3q9-l0famn9py.png"></div><br> 其次，我们意识到了系统中的整合机制。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-m/gp/dc/-mgpdcb6nkr8op8vujdzgmgiz4g.png"></div><br> 回到原来的过程。 将<b>断点</b>设置为<b>CreateProcessInternalW</b>并继续执行。 接下来，我们观察捆绑软件<b>NtGetContextThread / NtSetContextThread</b> ，该捆绑<b>软件</b>将执行开始的地址更改为<b>ShellCode</b>的地址。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/lb/rw/hylbrwthjvmah2o3a5xvxp76dxs.png"></div><br> 我们连接到调试器创建的进程，激活在库中<b>挂起uload / unload事件</b> ，恢复进程并等待<b>.NET</b>库的加载。 <br><br> 接下来，使用<b>ProcessHucker，我们</b>转储包含解压缩的<b>.NET</b>应用程序的区域。 <br><br> 我们停止所有进程并删除系统中固定的恶意软件副本。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/85/vn/wx/85vnwxgzesq6euniiplqs_o1bhk.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/an/iz/uh/anizuhqn3yawpwd_mq7iujucxo0.png"></div><br> 转储文件受<b>.NET Reactor</b>保护<b>器</b>保护，可以使用<b>de4dot</b>实用程序将其轻松删除。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u7/4g/ud/u74gudip_a1ixlqu0fgfpeklx9a.png"></div><br> 使用先前编写的YARA规则，我们确保前面有AgentTesla。 <br><br><h2> 总结一下 <br></h2><br> 因此，我们以三个小案例为例详细演示了样本的半自动拆包过程，并在一个完整的案例的基础上对恶意软件进行了分析，发现被调查的样本是AgentTesla，并设置了其功能和完整的危害指标列表。 <br><br> 对我们执行的恶意对象进行分析需要大量时间和精力，这项工作应由公司中的一名特殊员工完成，但是，并非所有公司都准备好对员工进行分析。 <br><br>  IB组计算机取证和恶意代码分析实验室提供的服务之一是对网络事件的响应。 为了防止客户浪费时间在网络攻击中进行文档协调和讨论，Group-IB推出了<b>事件响应保持器</b> ，这是一种预预订事件响应服务，还包括恶意代码分析步骤。 有关此的更多信息，请参见<a href="https://www.group-ib.ru/incident-response/retainer.html">此处</a> 。 <br><br> 如果您想再次研究如何解开AgentTesla样本并查看CERT Group-IB专家的工作方式，则可以在<a href="https://gibnc.group-ib.com/s/mNCo8td3izMjEMP">此处</a>下载有关此主题的网络研讨会录像。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481078/">https://habr.com/ru/post/zh-CN481078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481056/index.html">根据哈勃（Habr）的说法，这十年的主要技术</a></li>
<li><a href="../zh-CN481058/index.html">关于奇怪的问题（再次）和晶体管的选择</a></li>
<li><a href="../zh-CN481066/index.html">在Raspberry Pi 3上使用Fish Eye：启动用于计算机视觉的预训练DL模型</a></li>
<li><a href="../zh-CN481070/index.html">Rust 1.40.0版本：＃[non_exhaustive]，宏增强和其他增强</a></li>
<li><a href="../zh-CN481074/index.html">Python计算器</a></li>
<li><a href="../zh-CN481082/index.html">Mohnatiki占领了游戏行业的市场！ Peregrine Labs宣布与Epic Games合作</a></li>
<li><a href="../zh-CN481084/index.html">Python，数据库简介</a></li>
<li><a href="../zh-CN481086/index.html">Vivaldi 2.10-卧底特工</a></li>
<li><a href="../zh-CN481092/index.html">PHP 8中最有趣的事情</a></li>
<li><a href="../zh-CN481094/index.html">关于具有太阳能的JBL无线耳机以及它们的毛病</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>