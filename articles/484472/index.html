<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé® ü§üüèª üõÄüèæ Uso de asyncio para crear controladores de dispositivos as√≠ncronos en MicroPython v.1.12 ü§∑üèø ‚ò∫Ô∏è üë®üèº‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al estudiar las posibilidades de MicroPython para sus prop√≥sitos, me encontr√© con una de las implementaciones de la biblioteca asincio y, despu√©s de u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de asyncio para crear controladores de dispositivos as√≠ncronos en MicroPython v.1.12</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484472/">  <i>Al estudiar las posibilidades de <b>MicroPython</b> para sus prop√≥sitos, me encontr√© con una de las implementaciones de la biblioteca <b>asincio</b> y, despu√©s de una breve correspondencia con <b>Piter Hinch</b> , el autor de la biblioteca, me di cuenta de que necesitaba comprender m√°s profundamente los principios, conceptos b√°sicos y errores t√≠picos del uso de m√©todos de programaci√≥n asincr√≥nica.</i>  <i>Adem√°s, la secci√≥n para principiantes es solo para m√≠.</i> <br><br>  Esta gu√≠a est√° destinada a usuarios con diferentes niveles de experiencia con <i><b>asyncio</b></i> , incluida una secci√≥n especial para principiantes. <br><a name="habracut"></a><br>  <b>Contenido</b> <br>  <b>0. Introducci√≥n</b> <br>  0.1 .___ Instalaci√≥n de <i><b>uasyncio</b></i> en un dispositivo vac√≠o (hardware) <br>  <b>1. Planificaci√≥n para la ejecuci√≥n conjunta del programa.</b> <br>  1.1 .___ M√≥dulos <br>  <b>2. biblioteca <i>uasyncio</i></b> <br>  2.1 .___ Estructura del programa: ciclo de procesamiento de eventos <br>  2.2 .___ Corutinas <br>  2.2.1 .______ Colas de colas <i>para participar en la planificaci√≥n</i> <br>  2.2.2 .______ <i>Iniciar una <i>devoluci√≥n de llamada de</i> funci√≥n ( <i>devoluci√≥n de llamada</i> )</i> <br>  2.2.3 .______ <i>Notas: corutinas como m√©todos relacionados.</i>  <i>Los valores de retorno.</i> <br>  2.3 .___ Retrasos <br>  <b>3. Sincronizaci√≥n y sus clases.</b> <br>  3.1 .___ Bloqueo <i><b>Bloqueo</b></i> <br>  3.1.1 .______ <i>Cerraduras y tiempos de espera</i> <br>  3.2 .___ <i><b>Evento</b></i> <br>  3.2.1 .______ <i>Valor del</i> evento <br>  3.3 .___ Barrera <i><b>Barrera</b></i> <br>  3.4 .___ <i><b>Sem√°foro</b></i> <br>  3.4.1 .______ <i>Sem√°foro limitado</i> <br>  3.5 .___ Cola <i><b>Cola</b></i> <br>  3.6 .___ Otras clases de sincronizaci√≥n <br>  <b>4. Desarrollo de clase para <i>asyncio</i></b> <br>  4.1 .___ Clases usando await <br>  4.1.1 .______ <i>Uso en gestores de contexto</i> <br>  4.1.2 .______ <i>Aguardar en la rutina</i> <br>  4.2 .___ Iteradores asincr√≥nicos <br>  4.3 .___ Gerentes de contexto as√≠ncrono <br>  <b>5. Excepciones a los tiempos de espera y debido a cancelaciones de tareas</b> <br>  5.1 .___ Excepciones <br>  5.2 .___ Excepciones debido a tiempos de espera y debido a la cancelaci√≥n de tareas <br>  5.2.1 .______ <i>Cancelar tareas</i> <br>  5.2.2 .______ <i>Corutinas con tiempos de espera</i> <br>  <b>6. Interacci√≥n con dispositivos de hardware.</b> <br>  6.1 .___ Problemas de sincronizaci√≥n <br>  6.2 .___ Dispositivos de sondeo con corutinas <br>  6.3 .___ Uso del motor de transmisi√≥n <br>  6.3.1 .______ <i>Ejemplo de controlador UART</i> <br>  6.4 .___ Desarrollo de controladores para un dispositivo de transmisi√≥n <br>  6.5 .___ Ejemplo completo: controlador <i>aremote.py</i> para receptor de control remoto IR. <br>  6.6 .___ Controlador para sensor de temperatura y humedad HTU21D. <br>  <b>7. Consejos y trucos</b> <br>  7.1 .___ El programa se congela <br>  7.2 .___ <b><i>uasyncio</i></b> guarda estado <br>  7.3 .___ Recolecci√≥n de basura <br>  7.4 .___ Pruebas <br>  7.5 .___ Error com√∫n.  Puede ser dif√≠cil de encontrar. <br>  7.6 .___ Programaci√≥n usando sockets ( <i>sockets</i> ) <br>  7.6.1 .______ <i>Problemas de WiFi</i> <br>  7.7 .___ Argumentos del constructor del bucle de eventos <br>  <b>8. Notas para principiantes</b> <br>  8.1 .___ Problema 1: bucles de eventos <br>  8.2 .___ Problema 2: m√©todos de bloqueo <br>  8.3 .___ El enfoque <b><i>uasyncio</i></b> <br>  8.4 .___ Planificaci√≥n en <b><i>uasyncio</i></b> <br>  8.5 .___ ¬øPor qu√© la programaci√≥n conjunta, no basada en subprocesos ( <i>_thread</i> )? <br>  8.6 .___ Interacci√≥n <br>  8.7 .___ <i>Sondeo</i> <br><br>  <b>0. Introducci√≥n</b> <br><br>  La mayor parte de este documento supone cierta familiaridad con la programaci√≥n asincr√≥nica.  Para principiantes, se puede encontrar una introducci√≥n en la secci√≥n 7. <br><br>  La biblioteca <i><b>uasyncio</b></i> para <b>MicroPython</b> incluye un subconjunto de la biblioteca <b><i>asyncio</i></b> <b>Python</b> y est√° dise√±ada para usarse en microcontroladores.  Como tal, ocupa una peque√±a cantidad de RAM y est√° configurado para cambiar r√°pidamente los contextos con cero asignaci√≥n de RAM. <br><br>  Este documento describe el uso de <i><b>uasyncio</b></i> con √©nfasis en la creaci√≥n de controladores para dispositivos de hardware. <br><br>  El objetivo es dise√±ar los controladores para que la aplicaci√≥n contin√∫e funcionando mientras el controlador espera una respuesta del dispositivo.  Al mismo tiempo, la aplicaci√≥n sigue siendo sensible a otros eventos y a la interacci√≥n del usuario. <br><br>  Otra √°rea importante de aplicaci√≥n de <b><i>asyncio</i></b> es la programaci√≥n de red: en Internet puede encontrar suficiente informaci√≥n sobre este tema. <br><br>  Tenga en cuenta que <b>MicroPython se</b> basa en <b>Python 3.4</b> con los complementos m√≠nimos de <b>Python 3.5</b> .  Excepto como se detalla a continuaci√≥n, las funciones de <b><i>las</i></b> versiones de <b><i>asyncio</i></b> anteriores a 3.4 no son compatibles.  Este documento define las caracter√≠sticas admitidas en este subconjunto. <br><br>  El prop√≥sito de esta gu√≠a es presentar un estilo de programaci√≥n compatible con <b>CPython V3.5</b> y superior. <br><br>  <b>0.1 Instalar <b><i>uasyncio</i></b> en un dispositivo vac√≠o (hardware)</b> <br><br>  Se recomienda utilizar el firmware <b>MicroPython V1.11</b> o posterior.  En muchas plataformas, la instalaci√≥n no es necesaria, ya que <b><i>uasyncio¬Æ</i></b> ya <b><i>est√°</i></b> compilado en el ensamblaje.  Para verificar, simplemente escriba REPL <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio</code> </pre> <br>  Las siguientes instrucciones cubren casos en los que los m√≥dulos no est√°n preinstalados.  Las <b><i>colas</i></b> y los m√≥dulos de <b><i>sincronizaci√≥n</i></b> son opcionales, pero son necesarios para ejecutar los ejemplos que se proporcionan aqu√≠. <br><br>  <b>Dispositivo conectado a internet</b> <br><br>  En un dispositivo conectado a Internet y que ejecute el firmware V1.11 o posterior, puede instalar utilizando la versi√≥n <i>incorporada</i> de <i>upip</i> .  Aseg√∫rese de que el dispositivo est√© conectado a su red: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> upip upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.synchro'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.queues'</span></span> )</code> </pre><br>  Los mensajes de error de <i>upip</i> no <i>son</i> muy √∫tiles.  Si obtiene un error incomprensible, verifique nuevamente la conexi√≥n a Internet. <br><br>  <b>Hardware sin conexi√≥n a internet ( <i>micropip</i> )</b> <br><br>  Si el dispositivo no tiene una conexi√≥n a Internet (por ejemplo, <b>Pyboard V1.x</b> ), la forma m√°s f√°cil es comenzar la instalaci√≥n de <i>micropip.py</i> en la computadora en el directorio que elija y luego copiar la estructura del directorio resultante en el dispositivo de destino.  La utilidad <i>micropip.py se</i> ejecuta en <b>Python 3.2</b> o posterior y se ejecuta en Linux, Windows y OSX.  M√°s informaci√≥n se puede encontrar <a href="https://github.com/peterhinch/micropython-samples/tree/master/micropip" rel="nofollow">aqu√≠</a> . <br><br>  Llamada tipica: <br><br><pre> <code class="python hljs">$ micropip.py install -p ~/rats micropython-uasyncio $ micropip.py install -p ~/rats micropython-uasyncio.synchro $ micropip.py install -p ~/rats micropython-uasyncio.queues</code> </pre><br>  <b>Un dispositivo sin conexi√≥n a Internet (fuente de copia)</b> <br><br>  Si no utiliza <i>micropip.py</i> , los archivos deben copiarse de la fuente.  Las siguientes instrucciones describen c√≥mo copiar el n√∫mero m√≠nimo de archivos en el dispositivo de destino, as√≠ como el caso en que <b><i>uasyncio</i></b> necesita comprimirse en un ensamblaje compilado en forma de <b><i>c√≥digo de bytes</i></b> para reducir el espacio ocupado.  Para la √∫ltima versi√≥n compatible con firmware oficial, los archivos deben copiarse del sitio <a href="http://github.com/micropython/micropython-lib" rel="nofollow">web</a> oficial de <a href="http://github.com/micropython/micropython-lib" rel="nofollow">micropython-lib</a> . <br><br>  Clone la biblioteca a la computadora con el comando <br><br><pre> <code class="python hljs">$ git clone https://github.com/micropython/micropython-lib.git</code> </pre><br>  En el dispositivo de destino, cree el directorio <b><i>uasyncio</i></b> (opcional en el directorio lib) y copie los siguientes archivos en √©l: <br><br>  <b>‚Ä¢ uasyncio / uasyncio / __ init__.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.core / uasyncio / core.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.synchro / uasyncio / synchro.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.queues / uasyncio / queues.py</b> <b><br></b> <br><br>  Estos m√≥dulos <b><i>uasyncio</i></b> pueden comprimirse en bytecode colocando el directorio <b><i>uasyncio</i></b> y sus contenidos en el puerto del directorio de <i>m√≥dulos</i> y volviendo a compilar los contenidos. <br><br>  <b>1. Planificaci√≥n conjunta</b> <br><br>  La t√©cnica de ejecuci√≥n conjunta de varias tareas se usa ampliamente en sistemas embebidos, que ofrecen menos gastos generales que la programaci√≥n de subprocesos ( <b>_thread</b> ), evitando muchas dificultades asociadas con subprocesos verdaderamente asincr√≥nicos. <br><br>  <b>1.1 M√≥dulos</b> <br><br>  La siguiente es una lista de m√≥dulos que pueden ejecutarse en el dispositivo de destino. <br><br>  <b><u>Bibliotecas</u></b> <br><br>  1. <b><i>asyn.py</i></b> Proporciona <i><b>bloqueo, evento, barrera, sem√°foro, sem√°foro limitado, condici√≥n,</b></i> primitivas de sincronizaci√≥n de <i><b>recopilaci√≥n</b></i> .  Proporciona soporte para cancelar tareas a trav√©s de las clases <i><b>NamedTask</b></i> y <i><b>Cancellable</b></i> . <br><br>  2. <b><i>aswitch.py</i></b> Representa clases para emparejar interruptores y botones, as√≠ como un objeto de programa con la posibilidad de retrasos repetidos.  Los botones son una generalizaci√≥n de interruptores que proporcionan un estado l√≥gico en lugar de f√≠sico, as√≠ como eventos activados por una pulsaci√≥n doble y prolongada. <br><br>  <b>Programas de demostraci√≥n</b> <br><br>  Los dos primeros son m√°s √∫tiles ya que dan resultados visibles al acceder al <b>hardware de Pyboard</b> . <br><br><ol><li>  <b><i>aledflash.py</i></b> Parpadea cuatro indicadores de <b>Pyboard de</b> forma asincr√≥nica durante 10 segundos.  La demostraci√≥n m√°s simple de <b>uasyncio</b> .  Importarlo para ejecutar. </li><li>  <b><i>apoll.py</i></b> Controlador del <b><i>dispositivo</i></b> para el aceler√≥metro <b>Pyboard</b> .  Demuestra el uso de corutinas para consultar un dispositivo.  Funciona por 20 s.  Importarlo para ejecutar.  Requiere <b>Pyboard V1.x.</b> </li><li>  <b><i>astests.py Programas de</i></b> prueba / demostraci√≥n para el m√≥dulo <b><i>aswitch</i></b> . </li><li>  <b><i>asyn_demos.py Demos</i></b> simples de cancelar tareas. </li><li>  <b><i>roundrobin.py</i></b> Demostraci√≥n de planificaci√≥n circular.  Tambi√©n el punto de referencia para la planificaci√≥n del rendimiento. </li><li>  <b><i>awaitable.py</i></b> Demostraci√≥n de una clase con una espera.  Una forma de implementar un controlador de dispositivo que sondea una interfaz. </li><li>  <b><i>chain.py</i></b> Copiado de la documentaci√≥n de <b>Python</b> .  Demostraci√≥n de la cadena de rutina. </li><li>  <b><i>aqtest.py</i></b> Demostraci√≥n de la clase <b><i>Queue</i></b> de la biblioteca <i><b>uasyncio</b></i> . </li><li>  <b><i>aremote.py</i></b> Ejemplo de controlador de dispositivo para el protocolo NEC IR. </li><li>  <b><i>auart.py</i></b> Demostraci√≥n de transmisi√≥n de entrada-salida a trav√©s de <b>Pyboard UART</b> . </li><li>  <b><i>auart_hd.py</i></b> Usando <b>Pyboard UART</b> para comunicarse con un dispositivo usando el protocolo half-duplex.  Adecuado para dispositivos, por ejemplo, que utilizan el conjunto de comandos del m√≥dem AT. </li><li>  <b><i>iorw.py</i></b> Demostraci√≥n de un dispositivo lector / grabador utilizando E / S de transmisi√≥n. </li></ol><br>  <b>Programas de prueba</b> <br><br><ol><li>  <b><i>asyntest.py</i></b> Pruebas para clases de sincronizaci√≥n en <b><i>asyn.py.</i></b> </li><li>  <b><i>cantest.py</i></b> Pruebas de cancelaci√≥n de trabajos. </li></ol><br>  <b>Utilidad</b> <br><br>  1. <b><i>check_async_code.py</i></b> La utilidad est√° escrita en <b>Python3</b> para detectar errores de codificaci√≥n espec√≠ficos que pueden ser dif√≠ciles de encontrar.  Ver secci√≥n 7.5. <br><br>  <b>Control</b> <br><br>  El directorio <a href="" rel="nofollow"><i>benchmarks</i></a> contiene scripts para verificar y caracterizar el <i><b>planificador uasyncio</b></i> . <br><br><cut></cut><br>  <b>2. biblioteca <i>uasyncio</i></b> <br><br>  El concepto de <i>asincio se</i> basa en la organizaci√≥n de la planificaci√≥n para la ejecuci√≥n conjunta de varias tareas, que en este documento se denominan <b>corutinas</b> . <br><br>  <b>2.1 Estructura del programa: bucle de eventos</b> <br><br>  Considere el siguiente ejemplo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : count + = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( count ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  1 loop = asyncio.get_event_loop () loop.create_task ( bar ()) #     loop.run_forever ()</span></span></code> </pre><br>  La ejecuci√≥n del programa contin√∫a hasta que <i>se llama a loop.run_forever</i> .  En este punto, la ejecuci√≥n es controlada por el planificador.  La l√≠nea despu√©s de <i>loop.run_forever</i> nunca se ejecutar√°.  El planificador ejecuta el c√≥digo de <i>barras</i> porque se ha puesto en cola en el <i>planificador loop.create_task</i> .  En este ejemplo trivial, solo hay una <i>barra</i> corutina.  Si hubiera otros, el planificador los ejecutar√≠a durante los per√≠odos en que la <i>barra</i> estaba en pausa. <br><br>  La mayor√≠a de las aplicaciones integradas tienen un ciclo de eventos continuo.  Un ciclo de eventos tambi√©n se puede iniciar de una manera que permita su finalizaci√≥n utilizando el m√©todo de ciclo de eventos <i>run_until_complete</i> ;  Se utiliza principalmente en pruebas.  Se pueden encontrar ejemplos en el m√≥dulo <a href="https://github.com/peterhinch/micropython-async/blob/master/astests.py" rel="nofollow"><b><i>astests.py</i></b></a> . <br><br>  Una instancia de bucle de evento es un √∫nico objeto creado por la primera llamada a <i>asyncio.get_event_loop ()</i> con dos argumentos enteros opcionales que indican el n√∫mero de corutinas en las dos colas: el inicio y la espera.  T√≠picamente, ambos argumentos tendr√°n el mismo valor, igual al menos al n√∫mero de rutinas ejecutadas simult√°neamente en la aplicaci√≥n.  Por lo general, el valor predeterminado de 16 es suficiente. Si se utilizan valores no predeterminados, consulte Argumentos del constructor del bucle de eventos (secci√≥n 7.7.). <br><br>  Si la rutina necesita llamar al m√©todo de bucle de eventos (generalmente <i>create_task</i> ), llamar a <i>asyncio.get_event_loop ()</i> (sin argumentos) lo devolver√° efectivamente. <br><br>  <b>2.2 Corutinas</b> <br><br>  Una corutina se crea de la siguiente manera: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> )</code> </pre><br>  Una corutina puede permitir que otras corridas se inicien utilizando la instrucci√≥n de <i>espera</i> .  Una corutina debe contener al menos una declaraci√≥n de <i>espera</i> .  Esto hace que la rutina se ejecute antes de completarse, antes de que la ejecuci√≥n avance a la siguiente instrucci√≥n.  Considere un ejemplo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">0</span></span> )</code> </pre><br>  La primera l√≠nea hace que el c√≥digo se detenga por un tiempo de retraso, mientras que otras rutinas usan este tiempo para su ejecuci√≥n.  Un retraso de 0 hace que todas las corutinas pendientes se ejecuten en un orden c√≠clico hasta que se ejecute la siguiente l√≠nea.  Vea el ejemplo de <i><b>roundrobin.py</b></i> . <br><br>  <b>2.2.1.</b>  <b>Cola para planificar una corutina</b> <br><br><ul><li>  <i>EventLoop.create_task</i> Argumento: Corutina a ejecutar.  El planificador pone en cola la rutina para que se inicie lo antes posible.  La llamada <i>create_task</i> vuelve inmediatamente.  La rutina en el argumento se especifica utilizando la sintaxis de la llamada a la funci√≥n con los argumentos necesarios. </li><li>  <i>EventLoop.run_until_complete</i> Argumento: Coroutine to run.  El planificador pone en cola la rutina para que se inicie lo antes posible.  La rutina en el argumento se especifica utilizando la sintaxis de la llamada a la funci√≥n con los argumentos necesarios.  La llamada <i>un_until_complete</i> regresa cuando se completa la rutina: este m√©todo proporciona una forma de salir del programador. </li><li>  Aguarde Argumento: Una rutina para ejecutar, especificada utilizando la sintaxis de llamada de funci√≥n.  Inicia una corutina lo antes posible.  La corutina pendiente se bloquea hasta que se complete una de las esperadas. </li></ul><br>  Lo anterior es compatible con <b>CPython</b> .  <b><i>M√©todos</i></b> adicionales de <b><i>uasyncio se</i></b> discuten en las Notas (Secci√≥n 2.2.3.). <br><br>  <b>2.2.2 Inicio de la funci√≥n de devoluci√≥n de llamada</b> <br><br>  Las devoluciones de llamada deben ser funciones de <b>Python</b> dise√±adas para ejecutarse en un corto per√≠odo de tiempo.  Esto se debe al hecho de que las corutinas no podr√°n funcionar durante todo el tiempo que se realiza la funci√≥n. <br><br>  Los siguientes <b><i>m√©todos de la</i></b> clase <b><i>EventLoop</i></b> usan devoluciones de llamada: <br><br><ol><li>  <i>call_soon</i> : llame lo antes posible.  Args: <i>devoluci√≥n de</i> llamada de <i>devoluci√≥n de</i> llamada para ejecutar, <i>* args</i> cualquier argumento posicional puede ir seguido de una coma. </li><li>  <i>call_later</i> : llamada despu√©s de un retraso en segundos.  Args: <i>retraso, devoluci√≥n de llamada, * args</i> </li><li>  <i>call_later_ms</i> : llamada despu√©s de un retraso en ms.  Args: <i>retraso, devoluci√≥n de llamada, * args</i> . </li></ol><br><pre> <code class="python hljs">loop = asyncio.get_event_loop () loop.call_soon ( foo , <span class="hljs-number"><span class="hljs-number">5</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#    'foo'      5. loop.call_later ( 2 , foo , 5 ) #   2 . loop.call_later_ms ( 50 , foo , 5 ) #   50 . loop.run_forever ()</span></span></code> </pre><br>  <b>2.2.3 Notas</b> <br><br>  Una corutina puede contener una declaraci√≥n de <i>retorno</i> con valores de retorno arbitrarios.  Para obtener este valor: <br><br><pre> <code class="python hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro ()</code> </pre><br>  Una corutina puede estar limitada por m√©todos y debe contener al menos una declaraci√≥n de <i>espera</i> . <br><br>  <b>2.3 Retrasos</b> <br><br>  Hay dos opciones para organizar retrasos en las rutinas.  Para retrasos m√°s largos y en casos donde la duraci√≥n no necesita ser precisa, puede usar: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs , delay_ms )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( delay_ms )</code> </pre><br>  Durante tales demoras, el planificador ejecutar√° otras corutinas.  Esto puede introducir incertidumbre en el tiempo, ya que la rutina de llamada solo se iniciar√° cuando se ejecute la que se est√° ejecutando actualmente.  La cantidad de retraso depende del desarrollador de la aplicaci√≥n, pero probablemente ser√° del orden de decenas o cientos de ms;  esto se discute m√°s adelante en la Interacci√≥n con dispositivos de hardware (Secci√≥n 6). <br><br>  Se pueden realizar retrasos muy precisos utilizando las funciones <i>utime</i> : <i>sleep_ms</i> y <i>sleep_us</i> .  Son m√°s adecuados para retrasos cortos, ya que el planificador no podr√° ejecutar otras rutinas mientras el retraso est√© en progreso. <br><br>  <b>3 sincronizaci√≥n</b> <br><br>  A menudo existe la necesidad de garantizar la sincronizaci√≥n entre las rutinas.  Un ejemplo com√∫n es evitar las llamadas "condiciones de carrera" cuando varias corutinas requieren simult√°neamente acceso al mismo recurso.  Se proporciona un ejemplo en <b><i>astests.py</i></b> y se describe en la <a href="" rel="nofollow">documentaci√≥n</a> .  Otro peligro son los "abrazos de la muerte" cuando cada corutina espera a que se complete la otra. <br><br>  En aplicaciones simples, la sincronizaci√≥n se puede lograr utilizando indicadores globales o variables relacionadas.  Un enfoque m√°s elegante es usar clases de sincronizaci√≥n.  El m√≥dulo <b><i>asyn.py</i></b> ofrece implementaciones "micro" de las clases <i><b>Event, Barrier, Semaphore</b></i> y <i><b>Conditios</b></i> , destinadas a usarse solo con <b><i>asyncio</i></b> .  No est√°n orientados a subprocesos y no deben usarse con el m√≥dulo <b><i>_thread</i></b> o el controlador de interrupciones, a menos que se especifique lo contrario.  Tambi√©n se implementa la clase <i><b>Lock</b></i> , que es una alternativa a la implementaci√≥n oficial. <br><br>  Otro problema de sincronizaci√≥n surge con los productores de coroutine y los consumidores de coroutine.  Un productor de rutina genera datos que utiliza un consumidor de rutina.  Para hacer esto, <b><i>asyncio</i></b> proporciona la clase <i><b>Queue</b></i> .  El productor de rutina coloca los datos en la cola, mientras que el consumidor de rutina espera su finalizaci√≥n (con otras operaciones programadas a tiempo).  La clase <i><b>Queue</b></i> ofrece garant√≠as para eliminar elementos en el orden en que fueron recibidos.  Alternativamente, puede usar la clase <i><b>Barrera</b></i> si la rutina del productor debe esperar hasta que la rutina del consumidor est√© lista para acceder a los datos. <br><br>  A continuaci√≥n se ofrece una breve descripci√≥n de las clases.  M√°s detalles en la <a href="" rel="nofollow">documentaci√≥n completa</a> . <br><br>  <b>3.1 <a href="" rel="nofollow"><i>Bloqueo</i></a></b> <br><br>  <i><b>Lock</b></i> garantiza un acceso √∫nico a un recurso compartido.  El siguiente ejemplo de c√≥digo crea una instancia de la clase de <i>bloqueo</i> <b><i>Bloqueo</i></b> que se pasa a todos los clientes que desean acceder al recurso compartido.  Cada corutina intenta capturar el bloqueo, pausando la ejecuci√≥n hasta que tenga √©xito: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.synchro <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Lock <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, lock)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> lock.acquire() print(<span class="hljs-string"><span class="hljs-string">"Acquired lock in task"</span></span>, i) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.5</span></span>) lock.release() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">killer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) loop = asyncio.get_event_loop() lock = Lock() <span class="hljs-comment"><span class="hljs-comment"># The global Lock instance loop.create_task(task(1, lock)) loop.create_task(task(2, lock)) loop.create_task(task(3, lock)) loop.run_until_complete(killer()) #  10s</span></span></code> </pre><br>  <b>3.1.1. Bloqueo y tiempos de espera</b> <br><br>  Al momento de escribir (5 de enero de 2018), el desarrollo de la clase <i><b>uasycio</b></i> <i>Lock</i> no se ha completado oficialmente.  Si la rutina tiene un <u>tiempo de espera (secci√≥n 5.2.2.)</u> , Al esperar un bloqueo cuando se activa, el tiempo de espera ser√° ineficaz.  No recibir√° un <i>TimeoutError</i> hasta que reciba un bloqueo.  Lo mismo se aplica a la cancelaci√≥n de una tarea. <br><br>  El m√≥dulo <b><i>asyn.py</i></b> ofrece la clase <a href="" rel="nofollow"><b><i>Lock</i></b></a> , que funciona en estas situaciones.  Esta implementaci√≥n de la clase es menos eficiente que la clase oficial, pero admite interfaces adicionales de acuerdo con la versi√≥n de <b>CPython</b> , incluido el uso del administrador de contexto. <br><br>  <b>3.2 Evento</b> <br><br>  <b><i>El evento</i></b> crea una oportunidad para que una o varias corutinas pausen, mientras que otra da una se√±al sobre su continuaci√≥n.  Una instancia de <b>Evento</b> est√° disponible para todas las corutinas que lo usan: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn event = asyn.Event ()</code> </pre><br>  Una corutina espera un evento declarando un <i>evento en espera</i> , despu√©s de lo cual la ejecuci√≥n se detiene hasta que otras corutinas declaran <i>event.set ()</i> .  <a href="" rel="nofollow">Informaci√≥n completa</a> <br><br>  Puede surgir un problema si <i>event.set ()</i> se emite en una construcci√≥n en bucle;  el c√≥digo debe esperar hasta que todos los objetos pendientes tengan acceso al evento antes de configurarlo nuevamente.  En el caso de que un <b>coro</b> espere un evento, esto se puede lograr al recibir un evento <b>coro</b> que borre el evento: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event event.clear()</code> </pre><br>  La rutina que desencadena el evento verifica que se haya atendido: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : <span class="hljs-comment"><span class="hljs-comment">#   - while event.is_set (): await asyncio.sleep ( 1 ) # ,  coro   event.set ()</span></span></code> </pre><br>  En el caso de que varios <b>coros</b> est√©n esperando la sincronizaci√≥n de un evento, el problema se puede resolver utilizando el evento de confirmaci√≥n.  Cada <b>coro</b> necesita un evento separado. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  , ack_event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event ack_event.set ()</code> </pre><br>  Un ejemplo de esto se da en la funci√≥n <i><b>event_test</b></i> en <i><b>asyntest.py</b></i> .  Esto es engorroso En la mayor√≠a de los casos, incluso con un <b>coro de</b> espera, la clase <b>Barrera</b> , presentada a continuaci√≥n, ofrece un enfoque m√°s simple. <br>  Un evento tambi√©n puede proporcionar un medio de comunicaci√≥n entre el controlador de interrupciones y el <b>coro</b> .  El controlador mantiene el hardware y establece el evento, que <b>Coro</b> ya verifica en modo normal. <br><br>  <b>3.2.1 Valores de evento</b> <br><br>  El m√©todo <i>event.set ()</i> puede tomar un valor de datos opcional de cualquier tipo.  <b>Coro</b> , esperando un evento, puede obtenerlo con <i>event.value ()</i> .  Tenga en cuenta que <i>event.clear ()</i> se establecer√° en <i>Ninguno</i> .  Un uso t√≠pico de esto para el <i>coro que</i> configura el evento es emitir <i>event.set (utime.ticks_ms ())</i> .  Cualquier <b>coro que</b> espera un evento puede determinar la demora que ha ocurrido, por ejemplo, para compensar esto. <br><br>  <b>3.3 <a href="" rel="nofollow"><i>Barrera</i></a></b> <br><br>  Hay dos usos para la clase <b><i>Barrera</i></b> . <br><br>  Primero, puede suspender una corutina hasta que se completen una o varias otras. <br><br>  En segundo lugar, permite que varias corutinas se encuentren en un punto determinado.  Por ejemplo, un productor y un consumidor pueden sincronizar en el punto donde el productor tiene datos, y el consumidor est√° listo para usarlos.  En el momento de la ejecuci√≥n, la <b>barrera</b> puede emitir una devoluci√≥n de llamada adicional antes de eliminar la barrera y todos los eventos pendientes pueden continuar. <br><br>  La devoluci√≥n de llamada puede ser una funci√≥n o una rutina.  En la mayor√≠a de las aplicaciones, lo m√°s probable es que se utilice la funci√≥n: se puede garantizar que se ejecute antes de completarse, antes de que se elimine la barrera. <br><br>  Un ejemplo es la funci√≥n <i><b>barrera_prueba</b></i> en <i><b>asyntest.py</b></i> .  En el fragmento de c√≥digo de este programa: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function">:</span></span> print(text) barrier = asyn.Barrier(<span class="hljs-number"><span class="hljs-number">3</span></span>, callback, (<span class="hljs-string"><span class="hljs-string">'Synch'</span></span>,)) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'{} '</span></span>.format(i), end=<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> barrier</code> </pre> <br>  varias instancias de la rutina del <i>informe</i> imprimen su resultado y hacen una pausa hasta que otras instancias tambi√©n est√©n completas y esperen a que contin√∫e la <b>barrera</b> .  En este punto, se est√° realizando una devoluci√≥n de llamada.  Al finalizar, se reanuda la rutina original. <br><br>  <b>3.4 Sem√°foro</b> <br><br>  El sem√°foro limita el n√∫mero de corutinas que pueden acceder al recurso.  Se puede usar para limitar el n√∫mero de instancias de una corutina particular que puede ejecutarse simult√°neamente.  Esto se realiza mediante un contador de acceso, que el constructor inicializa y reduce cada vez que la rutina recibe un sem√°foro. <br><br>  La forma m√°s f√°cil de usarlo en un administrador de contexto: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn sema = asyn.Semaphore(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sema)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> sema: <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre><br>  Un ejemplo es la funci√≥n <i>semaphore_test</i> en <i><b>asyntest.py</b></i> . <br><br>  <b>3.4.1 sem√°foro ( <a href="" rel="nofollow"><i>limitado</i></a> )</b> <br><br>  Funciona de manera similar a la clase <i><b>Semaphore</b></i> , excepto que si el m√©todo de <i>liberaci√≥n</i> hace que el contador de acceso exceda su valor inicial, <i>se</i> establece un <i>ValueError</i> . <br><br>  <b>3.5 Cola</b> <br><br>  El <i><b>uasycio</b></i> oficial mantiene la clase <i><b>Queue</b></i> y el programa de ejemplo <i><b>aqtest.py</b></i> demuestra su uso.  La cola se crea de la siguiente manera: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.queues <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue q = Queue ()</code> </pre><br>  Una rutina de fabricante t√≠pica puede funcionar de la siguiente manera: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">producer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> slow_process() <span class="hljs-comment"><span class="hljs-comment">#       await q.put(result) #  ,       </span></span></code> </pre><br>  y la rutina del consumidor puede funcionar de la siguiente manera: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span>(q.get()) <span class="hljs-comment"><span class="hljs-comment"># ,  q  print('Result was {}'.format(result))</span></span></code> </pre><br>  La clase <i><b>Queue</b></i> proporciona una funcionalidad adicional significativa cuando el tama√±o de las colas puede ser limitado y el estado puede ser consultado.  Se puede controlar el comportamiento con una cola vac√≠a (si el tama√±o es limitado) y el comportamiento con una cola completa.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La documentaci√≥n sobre esto est√° en el c√≥digo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.6 Otras clases de sincronizaci√≥n</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La biblioteca </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona una micro implementaci√≥n de algunas de las otras caracter√≠sticas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La clase </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condici√≥n</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite que una corutina notifique a otras corutinas que esperan en un recurso bloqueado. Despu√©s de recibir la notificaci√≥n, obtendr√°n acceso al recurso y se desbloquear√°n a su vez. Una corutina de notificaci√≥n puede limitar el n√∫mero de corutinas a notificar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La clase </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gather le</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite ejecutar una lista de corutinas. Una vez completado este √∫ltimo, se devolver√° una lista de resultados. Esta implementaci√≥n "micro" utiliza una sintaxis diferente. Los tiempos de espera se pueden aplicar a cualquiera de las corutinas.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 Desarrollo de clases para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio</font></font></i></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el contexto del desarrollo de controladores de dispositivos, el objetivo es garantizar que funcionen sin bloqueo. Un controlador de rutina debe asegurarse de que se ejecutan otras rutinas mientras el controlador est√° esperando que el dispositivo realice operaciones de hardware. Por ejemplo, una tarea que espera datos que llegan a UART, o un usuario que presiona un bot√≥n debe permitir que se programen otros eventos hasta que ocurra el evento. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1 Clases que utilizan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esperar en</font></font></i></b> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;"> espera Una </font></b><b><i><font style="vertical-align: inherit;">rutina</font></i></b></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede pausar la ejecuci√≥n mientras espera un objeto en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Bajo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se crea </font><b><font style="vertical-align: inherit;">una</font></b><font style="vertical-align: inherit;"> clase de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> personalizada </font><font style="vertical-align: inherit;">al implementar el m√©todo especial </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que el generador devuelve. </font><font style="vertical-align: inherit;">La clase de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utiliza de la siguiente manera:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'__await__ called'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     return 42 __iter__ = __await__ # .   async def bar(): foo = Foo() # Foo - awaitable  print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no soporta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="http://github.com/micropython/micropython/issues/2678" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">edici√≥n # 2678</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y para que la soluci√≥n sea usada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La cadena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__ = __await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona portabilidad entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los ejemplos de c√≥digo, ver las clases </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de eventos, de barrera, cancelables, Estado</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.1 Uso en gestores de contexto</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Los objetos esperados se pueden utilizar en gestores de contexto s√≠ncronos o as√≠ncronos, proporcionando los m√©todos especiales necesarios. </font><font style="vertical-align: inherit;">Sintaxis:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> awaitable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a: <span class="hljs-comment"><span class="hljs-comment">#  'as'   #    async with awaitable as a: #    (.) #  -</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para lograr esto, el </font><font style="vertical-align: inherit;">generador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe regresar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esto se pasa a cualquier variable en la </font><font style="vertical-align: inherit;">cl√°usula </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y tambi√©n permite que funcionen m√©todos especiales. Vea </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.Condition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyntest.condition_test</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donde la clase de </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">condici√≥n</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y se puede usar en un administrador de contexto s√≠ncrono. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.2 corrutina esperan en</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el lenguaje </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requiere </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> era la funci√≥n del generador. En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython, los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generadores y las corutinas son id√©nticos, por lo que la soluci√≥n es utilizar el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendimiento de coro (args)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El prop√≥sito de esta gu√≠a es ofrecer c√≥digo que sea port√°til para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o posterior. En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generadores y las corutinas tienen un significado diferente. En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, una</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corutina tiene un </font><font style="vertical-align: inherit;">m√©todo especial </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que el generador recupera. Esto es port√°til:</font></font><br><br><pre> <code class="python hljs">up = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-comment"><span class="hljs-comment">#   MicroPython? try: import uasyncio as asyncio up = True #    sys.implementation.name except ImportError: import asyncio async def times_two(n): # Coro   await asyncio.sleep(1) return 2 * n class Foo(): def __await__(self): res = 1 for n in range(5): print('__await__ called') if up: # MicroPython res = yield from times_two(res) else: # CPython res = yield from times_two(res).__await__() return res __iter__ = __await__ async def bar(): foo = Foo() # foo is awaitable print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__, rendimiento a partir de asyncio.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permiti√≥ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Todav√≠a no entiendo c√≥mo se logra esto. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.2 iteradores</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asincr√≥nicos </font><b><font style="vertical-align: inherit;">Los iteradores</font></b><font style="vertical-align: inherit;"> asincr√≥nicos proporcionan un medio para devolver una secuencia de valores finita o infinita y pueden usarse como un medio para recuperar elementos de datos secuenciales cuando provienen de un dispositivo de solo lectura. </font><font style="vertical-align: inherit;">Un iterador asincr√≥nico llama a un c√≥digo asincr√≥nico en su </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√≥ximo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©todo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La clase debe cumplir los siguientes requisitos:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiene un m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aiter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> definido en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def as√≠ncrono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y que devuelve un iterador as√≠ncrono.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiene un m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__anext__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que en s√≠ mismo es una rutina, es decir, se define a trav√©s de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definici√≥n as√≠ncrona</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y contiene al menos una instrucci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para detener la iteraci√≥n, debe generar una </font><font style="vertical-align: inherit;">excepci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StopAsyncIteration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los valores en serie se recuperan usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as√≠ncrono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como se muestra a continuaci√≥n:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncIterable</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.data = (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) self.index = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aiter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__anext__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.fetch_data() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> StopAsyncIteration <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     if self.index &gt;= len(self.data): return None x = self.data[self.index] self.index += 1 return x async def run(): ai = AsyncIterable() async for x in ai: print(x)</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3 Administradores de contexto as√≠ncrono</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Las clases se pueden dise√±ar para admitir administradores de contexto as√≠ncrono que tienen procedimientos de entrada y salida que son coprogramas. Un ejemplo es la clase de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueo</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descrita anteriormente. Tiene la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corutina</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> __aenter__ </font><font style="vertical-align: inherit;">, que es l√≥gicamente necesaria para la operaci√≥n asincr√≥nica. Para admitir el protocolo asincr√≥nico del administrador de contexto, su </font><font style="vertical-align: inherit;">m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n debe ser una rutina, que se logra mediante la inclusi√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se puede acceder a estas clases desde una rutina con la siguiente sintaxis:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( lock )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lock: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( ¬´ bar ¬ª )</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al igual que con los administradores de contexto regulares, se garantiza que se llamar√° al m√©todo de salida cuando el administrador de contexto complete su trabajo, como de costumbre, y mediante una excepci√≥n. Para lograr esto, se utilizan los m√©todos especiales </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que deben definirse como corutinas que esperan otra corutina u </font><font style="vertical-align: inherit;">objeto en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este ejemplo est√° tomado de la clase </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lock</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aenter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.acquire() <span class="hljs-comment"><span class="hljs-comment"># a coro    async def return self async def __aexit__(self, *args): self.release() #   await asyncio.sleep_ms(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async with</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contiene una cl√°usula </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as variable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la variable obtiene el valor devuelto por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para garantizar un comportamiento correcto, el firmware debe ser V1.9.10 o posterior. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Excepciones a los tiempos de espera y debido a la cancelaci√≥n de tareas</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estos temas est√°n relacionados: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incluye la cancelaci√≥n de tareas y la aplicaci√≥n de un tiempo de espera a una tarea, lanzando una excepci√≥n para la tarea de una manera especial. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1 Excepciones</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si se produce una excepci√≥n en una corutina, debe procesarse en esta corutina o en una corutina en espera de su finalizaci√≥n. Esto garantiza que la excepci√≥n no se aplique al planificador. Si se produce una excepci√≥n, el planificador dejar√° de funcionar pasando la excepci√≥n al c√≥digo que inici√≥ el planificador. Por lo tanto, para evitar que el planificador se detenga, la corutina lanzada con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop.create_task ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe detectar cualquier excepci√≥n en su interior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cerrar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font><i><font style="vertical-align: inherit;">lanzar una</font></i><font style="vertical-align: inherit;"> excepci√≥n en una rutina no es razonable. Esto destruye </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , haciendo que la rutina comience y posiblemente </font><b><font style="vertical-align: inherit;">salga</font></b><font style="vertical-align: inherit;"> cuando todav√≠a est√° en la cola de ejecuci√≥n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El ejemplo anterior ilustra esta situaci√≥n. Si se le permite trabajar hasta el final, funciona como se esperaba.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) print(<span class="hljs-string"><span class="hljs-string">'About to throw exception.'</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> foo() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ZeroDivisionError: print(<span class="hljs-string"><span class="hljs-string">'foo  -   0'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ! raise #     . except KeyboardInterrupt: print('foo was interrupted by ctrl-c') #   ! raise async def shutdown(): print('Shutdown is running.') #     await asyncio.sleep(1) print('done') loop = asyncio.get_event_loop() try: loop.run_until_complete(bar()) except ZeroDivisionError: loop.run_until_complete(shutdown()) except KeyboardInterrupt: print('Keyboard interrupt at loop level.') loop.run_until_complete(shutdown())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, emitir una interrupci√≥n de teclado hace que la excepci√≥n entre en el bucle de eventos. Esto se debe a que la ejecuci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se pasa al bucle de eventos. Por lo tanto, las aplicaciones que requieren un c√≥digo claro en respuesta a una interrupci√≥n del teclado deben detectar una excepci√≥n en el nivel del bucle de eventos. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2 Cancelar y tiempos de espera</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como se mencion√≥ anteriormente, estas funciones funcionan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzando una</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> excepci√≥n para la tarea de una manera especial utilizando el m√©todo especial </font><b><font style="vertical-align: inherit;">MicroPython</font></b><font style="vertical-align: inherit;"> coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . C√≥mo funciona depende de la versi√≥n. En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v.2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">, una</font></b><font style="vertical-align: inherit;"> excepci√≥n no se procesa hasta la pr√≥xima tarea programada. Esto impone un retraso si la tarea espera </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dormir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrada-salida </font><font style="vertical-align: inherit;">Los tiempos de espera pueden ir m√°s all√° de su per√≠odo nominal. </font><font style="vertical-align: inherit;">La tarea de deshacer de otras tareas no puede determinar cu√°ndo se completa la operaci√≥n de deshacer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualmente hay una soluci√≥n alternativa y dos soluciones.</font></font><br><br><ul><li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n alternativa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la biblioteca </font><b><font style="vertical-align: inherit;">as√≠nica</font></b><font style="vertical-align: inherit;"> proporciona un medio para esperar a que se cancelen las tareas o los grupos de tareas. </font><font style="vertical-align: inherit;">Consulte Cancelar un trabajo (secci√≥n 5.2.1.).</font></font></li><li> <a href="http://github.com/pfalcon/pycopy-lib" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La biblioteca Paul Sokolovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero esto requiere su firmware </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pycopy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biblioteca</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> soluciona este problema de</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (menos de manera elegante) y el corredor firmware oficial.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La jerarqu√≠a de excepciones utilizada aqu√≠ es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exception-CanceledError-TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.1 Cancelar un trabajo </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona una funci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancelaci√≥n (coro)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esto funciona lanzando una excepci√≥n para usar la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rutina</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pend_throw </font><font style="vertical-align: inherit;">. Tambi√©n funciona con corutinas anidadas. El uso es el siguiente:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) # code omitted asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si este ejemplo se ejecuta en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuando la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelva </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancelar,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no tendr√° efecto hasta el pr√≥ximo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> programado </font><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">puede producirse </font><font style="vertical-align: inherit;">un </font><font style="vertical-align: inherit;">retraso de hasta 10 segundos </font><font style="vertical-align: inherit;">cuando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cancela el </font><i><font style="vertical-align: inherit;">foo</font></i><font style="vertical-align: inherit;"> . Otra fuente de retraso ocurrir√° si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo est√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esperando E / S. Dondequiera que ocurra el retraso, la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no podr√° determinar si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo ha sido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cancelado. Importa en algunos casos de uso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se usan las </font><b><font style="vertical-align: inherit;">bibliotecas </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io, es</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suficiente usar sleep (0):</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) #    asyncio.cancel(foo_instance) await asyncio.sleep(0) #   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto tambi√©n funcionar√° en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y cualquier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rutina pendiente </font><font style="vertical-align: inherit;">) nunca </font><font style="vertical-align: inherit;">volvi√≥ a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dormir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y no esper√≥ la E / S. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El comportamiento que puede sorprender a los descuidados ocurre cuando se espera que se cancele una rutina que se ejecuta mediante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_task</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y est√° en modo de </font><font style="vertical-align: inherit;">espera </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Considere este fragmento:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def foo_runner(foo_instance): await foo_instance print('   ') async def bar(loop): foo_instance = foo() loop.create_task(foo_runner(foo_instance)) #    asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando </font><font style="vertical-align: inherit;">se cancela </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se elimina de la cola del planificador; </font><font style="vertical-align: inherit;">porque carece de una </font><font style="vertical-align: inherit;">declaraci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devoluci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el procedimiento de llamada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo_runner</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca se reanuda. </font><font style="vertical-align: inherit;">Se recomienda que siempre detecte la excepci√≥n en el √°mbito m√°s externo de la funci√≥n que se va a deshacer:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.CancelledError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este caso, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_coro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no necesita detectar la excepci√≥n, ya que se propagar√° al canal de llamada y se capturar√° all√≠.</font></font><br><br>  Nota<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√° prohibido usar </font><font style="vertical-align: inherit;">m√©todos de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cierre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzamiento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de corutinas cuando las corutinas se usan fuera del programador. Esto socava el planificador, obligando a la rutina a ejecutar c√≥digo, incluso si no est√° programado. Esto puede tener consecuencias indeseables. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.2 corrutinas con tiempos de espera</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tiempos de espera implementarse usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Toman la rutina y la latencia en segundos o ms, respectivamente, como argumentos. Si el tiempo de espera caduca, se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzar√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un </font><i><font style="vertical-align: inherit;">TimeoutError</font></i><font style="vertical-align: inherit;"> a la rutina usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esta excepci√≥n debe ser detectada por el usuario o por la persona que llama. </font><font style="vertical-align: inherit;">Esto es necesario por la raz√≥n descrita anteriormente: si el tiempo de espera expira, se cancela. </font><font style="vertical-align: inherit;">A menos que el error sea detectado y devuelto, la √∫nica forma en que la persona que llama puede continuar es detectar la excepci√≥n en s√≠. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando la excepci√≥n fue detectada por la rutina, tuve fallas claras si la excepci√≥n no se detect√≥ en el alcance externo, como se muestra a continuaci√≥n:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: print(<span class="hljs-string"><span class="hljs-string">'Got timeout'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># And return async def foo(): await asyncio.wait_for(forever(), 5) await asyncio.sleep(2) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alternativamente, puede interceptar la funci√≥n de llamada: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.wait_for(forever(), <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> print(<span class="hljs-string"><span class="hljs-string">'Timeout elapsed.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto no se aplica a las </font><b><font style="vertical-align: inherit;">bibliotecas </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la rutina comienza a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esperar asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , con un largo retraso t, la rutina no se reiniciar√° hasta que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expire </font><font style="vertical-align: inherit;">. Si ha transcurrido el tiempo de espera antes de que finalice el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sue√±o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">producir√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un </font><i><font style="vertical-align: inherit;">error de tiempo de</font></i><font style="vertical-align: inherit;"> espera </font><font style="vertical-align: inherit;">cuando se recargue la rutina, es decir cuando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expira </font><font style="vertical-align: inherit;">. En tiempo real y desde la perspectiva de la persona que llama, su respuesta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se retrasar√°. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si esto es importante para la aplicaci√≥n, cree un retraso largo mientras espera uno corto en el bucle. Corutina</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apoya esto. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 Interacci√≥n con el equipo</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La base de la interacci√≥n entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y eventos as√≠ncronos externos es el sondeo. El hardware que requiere una respuesta r√°pida puede usar una interrupci√≥n. Pero la interacci√≥n entre la rutina de interrupci√≥n (ISR) y la rutina del usuario se basar√° en encuestas. Por ejemplo, un ISR puede llamar a </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evento</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o establecer un indicador global, mientras que una rutina que espera un resultado sondea un objeto cada vez que se programa una solicitud. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interrogaci√≥n puede llevarse a cabo de dos maneras, expl√≠cita o impl√≠cita. Esto √∫ltimo se realiza mediante la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transmisi√≥n de E / S</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un mecanismo, que es un sistema dise√±ado para dispositivos de transmisi√≥n como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sockets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En la encuesta expl√≠cita m√°s simple, el siguiente c√≥digo puede consistir:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_my_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> my_flag <span class="hljs-comment"><span class="hljs-comment">#   ISR while True: if my_flag: my_flag = False # service the device await asyncio.sleep(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En lugar de un indicador global, puede usar una variable de instancia de la clase </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o una instancia de una clase que use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Una encuesta expl√≠cita se discute a continuaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El sondeo impl√≠cito consiste en desarrollar un controlador que actuar√° como un dispositivo de E / S de transmisi√≥n, como un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font><font style="vertical-align: inherit;">un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket de </font></font></i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E / S de transmisi√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que sondea dispositivos que usan el sistema </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : dado que el sondeo se realiza en C, es m√°s r√°pido y m√°s eficiente que encuesta expl√≠cita El uso del flujo de E / S se trata en la secci√≥n 6.3.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a su efectividad, el sondeo impl√≠cito brinda una ventaja a los controladores de dispositivos de E / S m√°s r√°pidos: los controladores de transmisi√≥n se pueden crear para muchos dispositivos que generalmente no se consideran dispositivos de transmisi√≥n. Esto se discute con m√°s detalle en la secci√≥n 6.4. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.1 Problemas de sincronizaci√≥n</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanto las encuestas expl√≠citas como las impl√≠citas se basan actualmente en la planificaci√≥n c√≠clica. Supongamos que I / O funciona simult√°neamente con N corutinas personalizadas, cada una de las cuales se ejecuta con cero retraso. Cuando se sirve la E / S, se sondear√° tan pronto como se programen todas las operaciones del usuario. El retraso estimado debe considerarse al dise√±ar. Los canales de E / S pueden requerir almacenamiento en b√∫fer, con el equipo de servicio ISR en tiempo real desde las memorias intermedias y las rutinas, llenando o liberando las memorias intermedias en un momento m√°s lento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n es necesario considerar la posibilidad de ir m√°s all√°: este es el caso cuando algo interrogado por la rutina ocurre m√°s de una vez antes de que realmente sea planificado por la rutina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otro problema de tiempo es la precisi√≥n de latencia. Si los problemas de rutina</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( t ) <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el planificador garantiza que la ejecuci√≥n se suspender√° durante al menos t ms. El retraso real puede ser mayor que t, que depende de la carga actual del sistema. Si en este momento otras corutinas esperan la finalizaci√≥n de demoras distintas de cero, la pr√≥xima l√≠nea se programar√° inmediatamente para su ejecuci√≥n. Pero si otras corutinas tambi√©n est√°n esperando su ejecuci√≥n (ya sea porque emitieron un retraso cero o porque su tiempo tambi√©n ha expirado), se puede programar para que se ejecuten antes. Esto introduce incertidumbre de sincronizaci√≥n en las </font><font style="vertical-align: inherit;">funciones </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El valor del caso m√°s desfavorable para este desbordamiento puede calcularse sumando los valores de tiempo de ejecuci√≥n de todas esas rutinas para determinar el tiempo de transmisi√≥n del caso m√°s desfavorable al planificador.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> versi√≥n </font><b><font style="vertical-align: inherit;">fast_io</font></b><font style="vertical-align: inherit;"> de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en este contexto proporciona una forma de garantizar que la transmisi√≥n de E / S se sondear√° en cada iteraci√≥n del planificador. Se espera que el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><font style="vertical-align: inherit;">acepte las enmiendas pertinentes a su debido tiempo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2 Interrogaci√≥n de dispositivos utilizando corutinas</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Este es un enfoque simple que es m√°s adecuado para dispositivos que pueden ser interrogados a una velocidad relativamente baja. Esto se debe principalmente al hecho de que el sondeo con un intervalo de sondeo corto (o cero) puede llevar al hecho de que la rutina consume m√°s tiempo del procesador del que es deseable para caer en el intervalo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El ejemplo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apoll.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> demuestra este enfoque al consultar el aceler√≥metro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un intervalo de 100 ms. Realiza un filtrado simple para ignorar el ruido e imprime un mensaje cada dos segundos si no se produce ning√∫n movimiento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El ejemplo de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aswitch.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona controladores para interruptores y dispositivos de bot√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n se muestra un ejemplo de controlador para un dispositivo capaz de leer y escribir. Para facilitar la prueba, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UART 4 ‚Äã‚Äãemula un dispositivo condicional. El controlador implementa la clase </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en el que los datos se suministran en registros de longitud variable que consisten en instancias de bytes. El objeto agrega un delimitador antes de enviar y almacena los datos entrantes hasta que se recibe un delimitador agregado. Esta es solo una demostraci√≥n y una forma ineficiente de usar UART en comparaci√≥n con la entrada / salida de transmisi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para demostrar la transferencia asincr√≥nica, suponemos que el dispositivo emulado tiene un medio para verificar que la transferencia se haya completado y que la aplicaci√≥n requiera que esperemos. Ninguno de los supuestos es cierto en este ejemplo, pero el c√≥digo lo falsifica </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esperando asyncio.sleep (0.1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para comenzar, no olvide conectar las salidas del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 y X2 (UART Txd y Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecordOrientedUart</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> DELIMITER = <span class="hljs-string"><span class="hljs-string">b'\0'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) self.data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Not __await__ issue #2678 data = b'' while not data.endswith(self.DELIMITER): yield from asyncio.sleep(0) # ,  : while not self.uart.any(): yield from asyncio.sleep(0) # timing may mean this is never called data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data async def send_record(self, data): data = b''.join((data, self.DELIMITER)) self.uart.write(data) await self._send_complete() #          #        await asyncio.sleep(0) async def _send_complete(self): await asyncio.sleep(0.1) def read_record(self): # Synchronous: await the object before calling return self.data[0:-1] # Discard delimiter async def run(): foo = RecordOrientedUart() rx_data = b'' await foo.send_record(b'A line of text.') for _ in range(20): await foo #  coros       foo rx_data = foo.read_record() print('Got: {}'.format(rx_data)) await foo.send_record(rx_data) rx_data = b'' loop = asyncio.get_event_loop() loop.run_until_complete(run())</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3 Uso de la transmisi√≥n de mecanismo ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corriente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Este ejemplo demuestra la entrada simult√°nea y de salida en un solo microprocesador UART </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para comenzar, conecte las salidas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 y X2 (UART Txd y Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sender</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> swriter = asyncio.StreamWriter(uart, {}) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> swriter.awrite(<span class="hljs-string"><span class="hljs-string">'Hello uart\n'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> sreader = asyncio.StreamReader(uart) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> sreader.readline() print(<span class="hljs-string"><span class="hljs-string">'Received'</span></span>, res) loop = asyncio.get_event_loop() loop.create_task(sender()) loop.create_task(receiver()) loop.run_forever()</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo de soporte se puede encontrar en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__init__.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la </font><font style="vertical-align: inherit;">biblioteca </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El mecanismo funciona porque el controlador del dispositivo (escrito en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) implementa los siguientes m√©todos: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl, read, readline</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La Secci√≥n 6.4: Escribir un controlador de dispositivo de transmisi√≥n revela detalles sobre c√≥mo se pueden escribir dichos controladores en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART puede recibir datos en cualquier momento. El mecanismo de transmisi√≥n de E / S verifica si hay caracteres entrantes pendientes cada vez que el programador obtiene el control. Cuando se ejecuta la rutina, la rutina de interrupci√≥n amortigua los caracteres entrantes; se eliminar√°n cuando la rutina pase al planificador. Por lo tanto, las aplicaciones UART deben dise√±arse de modo que las rutinas minimicen el tiempo entre transferencias al planificador para evitar desbordamientos del b√∫fer y p√©rdida de datos. Esto se puede mejorar utilizando un b√∫fer de lectura UART m√°s grande o una velocidad de datos m√°s baja. Alternativamente, el control de flujo de hardware proporcionar√° una soluci√≥n si la fuente de datos lo admite. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3.1 Ejemplo de UART controlador</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> programa </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auart_hd.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ilustra un m√©todo de comunicaci√≥n con un dispositivo semid√∫plex, como un dispositivo que responde al conjunto de comandos del m√≥dem AT. Half duplex significa que el dispositivo nunca env√≠a datos no solicitados: sus transferencias siempre se llevan a cabo en respuesta a un comando recibido del maestro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El dispositivo se emula ejecutando una prueba en un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con dos conexiones cableadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El dispositivo emulado (muy simplificado) responde a cualquier comando enviando cuatro l√≠neas de datos con una pausa entre cada una para simular un procesamiento lento.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El asistente env√≠a un comando, pero no sabe de antemano cu√°ntas filas de datos se devolver√°n. Inicia un temporizador de reinicio que se reinicia cada vez que se recibe una l√≠nea. Cuando expira el temporizador, se supone que el dispositivo ha completado la transmisi√≥n y se devuelve una lista de l√≠neas recibidas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n se demuestra un caso de falla del dispositivo, que se logra omitiendo una transmisi√≥n antes de esperar una respuesta. Despu√©s del tiempo de espera, se devuelve una lista vac√≠a. Vea los comentarios del c√≥digo para m√°s detalles. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.4 Desarrollo de transmisi√≥n (drivers </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corriente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) unidad de</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entrada de corriente / mecanismo de salida ( </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corriente I / O</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) para controlar el funcionamiento de la transmisi√≥n de dispositivos I / O tales como UART y tomas de corriente ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) El mecanismo puede ser utilizado por los controladores de cualquier dispositivo sondeado regularmente delegando al programador que utiliza </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sondeando la disponibilidad de cualquier dispositivo en la cola. Esto es m√°s eficiente que realizar varias operaciones de rutina, cada una de las cuales sondea el dispositivo, en parte porque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° escrito en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y tambi√©n porque la rutina que realiza el sondeo se retrasa hasta que el objeto sondeado devuelve un estado listo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un controlador de dispositivo capaz de dar servicio al mecanismo de entrada / salida de transmisi√≥n deber√≠a admitir preferiblemente los m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader, StreamWriter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Un dispositivo legible debe proporcionar al menos uno de los siguientes m√©todos. Tenga en cuenta que estos son m√©todos sincr√≥nicos. El m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ver m√°s abajo) asegura que se invoquen solo cuando haya datos disponibles. Los m√©todos deben devolverse lo m√°s r√°pido posible, utilizando tantos datos como est√©n disponibles. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readline ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Devuelve tantos caracteres como sea posible, hasta cualquier car√°cter de nueva l√≠nea. Se requiere si se usa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readline () </font></font></i> <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Devuelve tantos caracteres como sea posible, pero no m√°s de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Obligatorio si se usa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.read ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readexactly ()</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador creado debe proporcionar el siguiente m√©todo s√≠ncrono con retorno inmediato: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con argumentos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf, off, sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donde: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el b√∫fer para escribir. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : desplazamiento al b√∫fer del primer car√°cter a escribir. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el n√∫mero solicitado de caracteres para escribir. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El valor de retorno</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el n√∫mero de caracteres realmente escritos (tal vez 1 si el dispositivo es lento). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> garantiza que solo se invocar√° cuando el dispositivo est√© listo para recibir datos.</font></font><br><cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los dispositivos deben proporcionar un m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que sondee el equipo para determinar su estado de disponibilidad. </font><font style="vertical-align: inherit;">Un ejemplo t√≠pico para un controlador de lectura / escritura:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL_WR = const(<span class="hljs-number"><span class="hljs-number">4</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyIO</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    def ioctl(self, req, arg): # see ports/stm32/uart.c ret = MP_STREAM_ERROR if req == MP_STREAM_POLL: ret = 0 if arg &amp; MP_STREAM_POLL_RD: if hardware_has_at_least_one_char_to_read: ret |= MP_STREAM_POLL_RD if arg &amp; MP_STREAM_POLL_WR: if hardware_can_accept_at_least_one_write_character: ret |= MP_STREAM_POLL_WR return ret</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La siguiente es una descripci√≥n del </font><font style="vertical-align: inherit;">retraso de espera </font><font style="vertical-align: inherit;">de la clase </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MillisecTimer</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> utime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MillisecTimer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.end = <span class="hljs-number"><span class="hljs-number">0</span></span> self.sreader = asyncio.StreamReader(self) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.readline() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ms)</span></span></span><span class="hljs-function">:</span></span> self.end = utime.ticks_add(utime.ticks_ms(), ms) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> utime.ticks_diff(utime.ticks_ms(), self.end) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: ret |= MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que se puede usar de la siguiente manera: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_test</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( n )</span></span></span><span class="hljs-function">:</span></span> timer = ms_timer.MillisecTimer () <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> timer ( <span class="hljs-number"><span class="hljs-number">30</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  30 </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En comparaci√≥n con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> dicha implementaci√≥n no ofrece ninguna ventaja en comparaci√≥n con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El uso de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proporciona retrasos significativamente m√°s precisos en el patr√≥n de uso normal, cuando las rutinas esperan un retraso cero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede usar la programaci√≥n de E / S para asociar un evento con una devoluci√≥n de llamada. Esto es m√°s eficiente que el ciclo de sondeo, porque el sondeo no est√° programado hasta que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regrese listo. A continuaci√≥n, se ejecuta una devoluci√≥n de llamada cuando la devoluci√≥n de llamada cambia de estado.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PinCall</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, pin, *, cb_rise=None, cbr_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">, cb_fall=None, cbf_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.pin = pin self.cb_rise = cb_rise self.cbr_args = cbr_args self.cb_fall = cb_fall self.cbf_args = cbf_args self.pinval = pin.value() self.sreader = asyncio.StreamReader(self) loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.read(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, _)</span></span></span><span class="hljs-function">:</span></span> v = self.pinval <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_rise <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_rise(*self.cbr_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_fall <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_fall(*self.cbf_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: v = self.pin.value() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v != self.pinval: self.pinval = v ret = MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y de nuevo, en el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">, la</font></b><font style="vertical-align: inherit;"> demora puede ser alta. Dependiendo del dise√±o de la aplicaci√≥n, la versi√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede ser m√°s eficiente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demostraci√≥n de iorw.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ilustra un ejemplo completo. Tenga en cuenta que al momento de escribir el art√≠culo en el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><font style="vertical-align: inherit;">hay un error debido al cual esto </font></font><a href="http://github.com/micropython/pull/3836" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no funciona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hay dos soluciones La soluci√≥n alternativa es escribir dos controladores separados, uno para solo lectura y otro para solo escritura. El segundo es usar </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que resuelve este problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">, la</font></b><font style="vertical-align: inherit;"> entrada / salida se planifica muy </font></font><a href="http://github.com/micropython/micropython/issues/2664" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raramente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.5 Ejemplo completo: aremote.py</font></font></b> <br><br> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador est√°</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dise√±ado para recibir / decodificar se√±ales de un control remoto infrarrojo. El controlador</font></font><a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aremote.py en s√≠</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Las siguientes notas son significativas con respecto al uso de</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interrupci√≥n en el contacto registra la hora del cambio de estado (en microsegundos) y establece el evento, omitiendo la hora en que ocurri√≥ el primer cambio de estado. La rutina espera un evento, informa la duraci√≥n del paquete de datos y luego decodifica los datos almacenados antes de llamar a la devoluci√≥n de llamada especificada por el usuario.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasar el tiempo a una instancia de</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Evento</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite que la rutina compense cualquier</font><font style="vertical-align: inherit;">retraso de</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asincio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al establecer el per√≠odo de retraso.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6.6 Sensor ambiental HTU21D</font></font></b> <br><br> <a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> controlador de chip HTU21D proporciona mediciones precisas de temperatura y humedad.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El chip necesita unos 120 ms para recibir ambos elementos de datos. El controlador funciona de forma asincr√≥nica, iniciando la recepci√≥n y el uso de</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> await asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes de leer los datos, actualiza las variables de temperatura y humedad, a las que se puede acceder en cualquier momento, lo que permite que se ejecuten otras rutinas mientras se ejecuta el controlador del chip.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.Consejos y trucos </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1 El programa se congela El congelamiento</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generalmente ocurre porque la tarea se bloquea sin concesi√≥n: esto conducir√° a la congelaci√≥n de todo el sistema. Al desarrollar, es √∫til tener una rutina que encienda peri√≥dicamente el LED integrado. Esto proporciona confirmaci√≥n de que el planificador todav√≠a se est√° ejecutando.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2 uasyncio guarda el estado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Al iniciar programas que usan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en REPL, realice un restablecimiento </font><b><font style="vertical-align: inherit;">parcial</font></b><font style="vertical-align: inherit;"> (ctrl-D) entre los inicios. Debido al hecho de que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mantiene el estado entre inicios, puede ocurrir un comportamiento impredecible en el pr√≥ximo inicio. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3 Recolecci√≥n de basura</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Puede ejecutar una rutina especificando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">import gc primero</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs">gc.collect () gc.treshold ( gc.mem_free () // <span class="hljs-number"><span class="hljs-number">4</span></span> + gc.mem_alloc ())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El prop√≥sito de esto se discute </font></font><a href="http://docs.micropython.org/en/latest/reference/constrained.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la secci√≥n de mont√≥n. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4 Pruebas</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es aconsejable asegurarse de que el controlador del dispositivo mantenga el control cuando sea necesario, lo que puede hacerse ejecutando una o m√°s copias de las rutinas ficticias que inician el ciclo de impresi√≥n de mensajes y comprobando que se ejecuta durante los per√≠odos en que el controlador est√° en modo de espera:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Roundrobin '</span></span>, n) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ejemplo del tipo de peligro que puede surgir, en el ejemplo anterior, el </font><font style="vertical-align: inherit;">m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart </font></font></i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se escribi√≥ originalmente como:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.uart.any(): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) data = <span class="hljs-string"><span class="hljs-string">b''</span></span>.join((data, self.uart.read(self.uart.any()))) self.data = data</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, la ejecuci√≥n se alarga hasta que se recibe todo el registro, as√≠ como el hecho de que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uart.any ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> siempre devuelve un n√∫mero distinto de cero de caracteres recibidos. En el momento de la llamada, es posible que ya se hayan recibido todos los caracteres. Esta situaci√≥n se puede resolver utilizando un bucle externo:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ,  : while not self.uart.any(): yield from asyncio.sleep(0) #        data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vale la pena se√±alar que este error no habr√≠a sido obvio si los datos se hubieran enviado al UART a una velocidad menor, en lugar de utilizar una prueba de retroalimentaci√≥n. Bienvenido a las alegr√≠as de la programaci√≥n en tiempo real. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5 Error com√∫n</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si una funci√≥n o m√©todo se define mediante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y posteriormente se llama como si fuera una llamada regular (sincr√≥nica), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font><b><font style="vertical-align: inherit;">muestra</font></b><font style="vertical-align: inherit;"> un mensaje de error. Esto es por dise√±o. Por lo general, esto lleva al hecho de que el programa en silencio no funciona correctamente:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># code loop.create_task(foo) #  1 1: foo     foo() #  2: .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengo una </font></font><a href="http://github.com/micropython-lib/pull/292" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sugerencia</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que sugiere arreglar la situaci√≥n en la opci√≥n 1 usando </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El m√≥dulo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check_async_code.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intenta detectar casos de uso dudoso de las rutinas. Est√° escrito en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y est√° dise√±ado para funcionar en una PC. Se usa en scripts escritos de acuerdo con las pautas descritas en esta gu√≠a con corutinas declaradas usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El m√≥dulo toma un argumento, la ruta al archivo fuente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o --help).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenga en cuenta que es algo grosero y est√° destinado a ser utilizado en un archivo sint√°cticamente correcto, que no se inicia por defecto. </font><font style="vertical-align: inherit;">Use una herramienta, como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para la verificaci√≥n general de sintaxis ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actualmente no tiene este error). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El gui√≥n produce falsos positivos. </font><font style="vertical-align: inherit;">Seg√∫n el plan, las corutinas son objetos del primer nivel; pueden transferirse a funciones y almacenarse en estructuras de datos. </font><font style="vertical-align: inherit;">Dependiendo de la l√≥gica del programa, puede guardar la funci√≥n o el resultado de su ejecuci√≥n. </font><font style="vertical-align: inherit;">El script no puede determinar la intenci√≥n. </font><font style="vertical-align: inherit;">Su objetivo es ignorar los casos que parecen correctos al identificar otros casos a considerar. </font><font style="vertical-align: inherit;">Supongamos que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donde la corutina se declara como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def as√≠ncrona</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><pre> <code class="python hljs">loop.run_until_complete(foo()) <span class="hljs-comment"><span class="hljs-comment">#   bar(foo) #     ,      bar(foo()) z = (foo,) z = (foo(),) foo() #  :   .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Me parece √∫til como es, pero las mejoras siempre son bienvenidas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6 Programaci√≥n con tomas de corriente ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enchufes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hay dos enfoques b√°sicos para la programaci√≥n de sockets </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De forma predeterminada, los sockets est√°n bloqueados hasta que se completa la operaci√≥n de lectura o escritura especificada. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> admite el bloqueo de socket mediante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para evitar que el programador los bloquee. En la mayor√≠a de los casos, este mecanismo es m√°s f√°cil de usar. Puede encontrar un ejemplo de c√≥digo de cliente y servidor en el directorio </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">client_server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Userver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utiliza la aplicaci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll sondeando</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expl√≠citamente el socket del servidor.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los sockets del cliente lo usan impl√≠citamente en el sentido de que el motor de transmisi√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio lo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa directamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenga en cuenta que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.getaddrinfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° actualmente bloqueado. El tiempo en el c√≥digo de muestra ser√° m√≠nimo, pero si se requiere una b√∫squeda de DNS, el per√≠odo de bloqueo puede ser significativo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un segundo enfoque para la programaci√≥n de sockets es usar sockets sin bloqueo. Esto agrega complejidad, pero es necesario en algunas aplicaciones, especialmente si la conexi√≥n es a trav√©s de WiFi (ver m√°s abajo). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el momento de escribir este art√≠culo (marzo de 2019), el soporte TLS para sockets sin bloqueo estaba en desarrollo. Su estado exacto es desconocido (para m√≠).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El uso de enchufes sin bloqueo requiere cierta atenci√≥n al detalle. Si se producen lecturas sin bloqueo debido a la latencia del servidor, no hay garant√≠a de que se devuelvan todos (o alguno) de los datos solicitados. Del mismo modo, las entradas pueden no completarse. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, los m√©todos as√≠ncronos de lectura y escritura deben realizar iterativamente una operaci√≥n sin bloqueo hasta que se lean o escriban los datos requeridos. En la pr√°ctica, puede ser necesario un tiempo de espera para hacer frente a las interrupciones del servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra complicaci√≥n es que el puerto ESP32 ten√≠a problemas que requer√≠an robos bastante desagradables para una operaci√≥n libre de errores. No he probado si este sigue siendo el caso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo </font></font><a href="" rel="nofollow"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sock_nonblock.py</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ilustra los m√©todos requeridos. Esta no es una demostraci√≥n funcional y es probable que las decisiones dependan de la aplicaci√≥n. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.1 Problemas con WiFi</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El mecanismo de transmisi√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font><b><font style="vertical-align: inherit;">es</font></b><font style="vertical-align: inherit;"> la mejor opci√≥n al detectar interrupciones de WiFi. Encontr√© que era necesario usar enchufes sin bloqueo para proporcionar una operaci√≥n a prueba de fallas y volver a conectar al cliente en caso de fallas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documento</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> describe los problemas que he encontrado en aplicaciones WiFi que mantienen abiertos los sockets durante per√≠odos prolongados y describe la soluci√≥n. </font></font><br><br> <a href="http://guthub.com/peterhinch/micropython-mqtt" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pltcm</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ofrece un robusto cliente MQTT as√≠ncrono que proporciona integridad de mensajes durante fallas de WiFi. Se describe un enlace serial asincr√≥nico full-duplex simple entre un cliente inal√°mbrico y un servidor con cable con entrega garantizada de mensajes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7 Argumentos del constructor del bucle de eventos</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Puede producirse un peque√±o error si necesita crear un bucle de eventos con valores que difieran de los valores predeterminados. Dicho ciclo debe declararse antes de ejecutar cualquier otro c√≥digo utilizando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque estos valores pueden ser necesarios en este c√≥digo. De lo contrario, el c√≥digo se inicializar√° con los valores predeterminados:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment">#   get_event_loop() #     loop = asyncio.get_event_loop(runq_len=40, waitq_len=40)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que la importaci√≥n de un m√≥dulo puede ejecutar c√≥digo, la forma m√°s segura es crear una instancia de un bucle de eventos inmediatamente despu√©s de importar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio loop = asyncio.get_event_loop(runq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>, waitq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment"># get_event_loop()   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al escribir m√≥dulos para su uso por otros programas, prefiero evitar ejecutar el c√≥digo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al importar. </font><font style="vertical-align: inherit;">Escriba funciones y m√©todos para esperar un bucle de evento como argumento. </font><font style="vertical-align: inherit;">Luego, aseg√∫rese de que solo las aplicaciones de nivel superior llamen a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_event_loop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> my_module <span class="hljs-comment"><span class="hljs-comment">#      loop = asyncio.get_event_loop(runq_len=40, waitq_len=40) bar = my_module.Bar(loop)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este tema se discute </font></font><a href="http://github.com/micropython/micropython-lib/issues/295" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 notas para principiantes</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estas notas est√°n destinadas a principiantes en c√≥digo as√≠ncrono y comienzan con una descripci√≥n de los problemas que los planificadores intentan resolver, as√≠ como una descripci√≥n general del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enfoque</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><b><font style="vertical-align: inherit;">uasyncio</font></b><font style="vertical-align: inherit;"> para las soluciones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La Secci√≥n 8.5 discute los m√©ritos relativos de los m√≥dulos de </font><b><font style="vertical-align: inherit;">hilo </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y _ </font><font style="vertical-align: inherit;">, as√≠ como tambi√©n por qu√© preferir√≠a usar las </font><b><font style="vertical-align: inherit;">rutinas de</font></b><font style="vertical-align: inherit;"> uasyncio </font><b><font style="vertical-align: inherit;">con</font></b><font style="vertical-align: inherit;"> programaci√≥n proactiva (_thread). </font><b><font style="vertical-align: inherit;">8.1 Problema 1: bucles de eventos</font></b></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una aplicaci√≥n de firmware t√≠pica funciona continuamente y, al mismo tiempo, debe responder a eventos externos, que pueden incluir un cambio de voltaje en el ADC, la aparici√≥n de una interrupci√≥n de hardware o un s√≠mbolo recibido en el UART o datos disponibles en el z√≥calo. Estos eventos ocurren de forma as√≠ncrona, y el c√≥digo deber√≠a poder responder independientemente del orden en que ocurran. Adem√°s, pueden requerirse tareas que dependen del tiempo, como el parpadeo de los LED. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La forma obvia de hacerlo es con el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eventos </font><b><font style="vertical-align: inherit;">uasycio</font></b><font style="vertical-align: inherit;"> . Este ejemplo no es un c√≥digo pr√°ctico, pero sirve para ilustrar la forma general del bucle de eventos.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> led_1_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_1_period = <span class="hljs-number"><span class="hljs-number">20</span></span> led_2_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_2_period = <span class="hljs-number"><span class="hljs-number">30</span></span> switch_state = switch.state() <span class="hljs-comment"><span class="hljs-comment">#    while True: time_now = utime.time() if time_now &gt;= led_1_time: #  LED #1 led1.toggle() led_1_time = time_now + led_1_period if time_now &gt;= led_2_time: #  LED #2 led2.toggle() led_2_time = time_now + led_2_period #    LEDs if switch.value() != switch_state: switch_state = switch.value() #  - if uart.any(): #    UART</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tal ciclo funciona para ejemplos simples, pero a medida que aumenta el n√∫mero de eventos, el c√≥digo r√°pidamente se vuelve engorroso. Tambi√©n violan los principios de la programaci√≥n orientada a objetos al combinar la mayor parte de la l√≥gica del programa en un solo lugar, en lugar de vincular el c√≥digo a un objeto controlado. Queremos desarrollar una clase para un LED parpadeante que se pueda insertar en un m√≥dulo e importar. El enfoque OOP para el parpadeo del LED puede verse as√≠:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_flashable</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, period)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: self.led.toggle() <span class="hljs-comment"><span class="hljs-comment"># -     period, #         </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El planificador en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite crear tales clases. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.2 Problema 2: M√©todos de bloqueo</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suponga que necesita leer un cierto n√∫mero de bytes de un socket. Si llama a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con un socket de bloqueo de forma predeterminada, se "bloquear√°" (es decir, no podr√° terminar) hasta que se reciban </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bytes. Durante este per√≠odo, la aplicaci√≥n no responder√° a otros eventos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando el z√≥calo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sin bloqueo </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> puede escribir un m√©todo de lectura as√≠ncrono. Una tarea que requiera datos se bloquear√° (necesariamente) hasta que se reciba, pero se realizar√°n otras tareas durante este per√≠odo, lo que permitir√° que la aplicaci√≥n permanezca receptiva.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.3. Uasyncio se acerca</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La pr√≥xima clase tiene un LED que se puede encender y apagar, y tambi√©n puede parpadear a cualquier velocidad. La instancia de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED_async</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa el m√©todo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecuci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que puede usarse para la operaci√≥n continua. El comportamiento de los LED se puede controlar utilizando los m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on (), off ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash (segundos)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_async</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.rate &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.led.toggle() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(int(<span class="hljs-number"><span class="hljs-number">500</span></span> / self.rate)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, rate)</span></span></span><span class="hljs-function">:</span></span> self.rate = rate <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.on() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">off</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.off() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cabe se√±alar que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on (), off ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son m√©todos sincr√≥nicos comunes. Cambian el comportamiento del LED, pero regresan de inmediato. El parpadeo ocurre "en segundo plano". Esto se explica en detalle en la siguiente secci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La clase cumple con el principio OOP, que consiste en almacenar la l√≥gica asociada con el dispositivo en la clase. Al mismo tiempo, el uso de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asegura que la aplicaci√≥n pueda responder a otros eventos mientras el LED parpadea. El siguiente programa parpadea con cuatro LED de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a diferentes frecuencias y tambi√©n responde al bot√≥n USR, que lo completa.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> led_async <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LED_async <span class="hljs-comment"><span class="hljs-comment"># ,   async def killer(): # ,      sw = pyb.Switch() while not sw.value(): await asyncio.sleep_ms(100) leds = [LED_async(n) for n in range(1, 4)] for n, led in enumerate(leds): led.flash(0.7 + n/4) loop = asyncio.get_event_loop() loop.run_until_complete(killer())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A diferencia del primer ejemplo de un bucle de eventos, la l√≥gica asociada con el interruptor est√° en una funci√≥n separada de la funcionalidad del LED. </font><font style="vertical-align: inherit;">Presta atenci√≥n al c√≥digo utilizado para iniciar el planificador:</font></font><br><br><pre> <code class="python hljs">loop = asyncio.get_event_loop() loop.run_until_complete(killer()) <span class="hljs-comment"><span class="hljs-comment">#    #       killer (), #   .</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.4 La planificaci√≥n en uasyncio </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> admiten el concepto de una funci√≥n asincr√≥nica, tambi√©n conocida como una rutina o tarea. </font><font style="vertical-align: inherit;">Una corutina debe incluir al menos una declaraci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): print(<span class="hljs-string"><span class="hljs-string">'Hello world.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta funci√≥n imprime un mensaje diez veces a intervalos de un segundo. Mientras la funci√≥n est√° en pausa en previsi√≥n de un retraso, el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">programador as√≠ncio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realizar√° otras tareas, creando la ilusi√≥n de ejecutarlas simult√°neamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando un problema de rutina </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarda asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarda asyncio.sleep (), la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarea actual se detiene y se coloca en una cola ordenada por tiempo y la ejecuci√≥n contin√∫a a la tarea en la parte superior de la cola. La cola est√° dise√±ada de tal manera que, incluso si el modo de suspensi√≥n especificado es cero, se realizar√°n otras tareas relevantes hasta que se reanude la corriente. Esta es la planificaci√≥n "honesta circular". Es una pr√°ctica com√∫n correr </font><i><font style="vertical-align: inherit;">esperar bucles asyncio.sleep (0)</font></i><font style="vertical-align: inherit;"> .</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que la tarea no retrase la ejecuci√≥n. </font><font style="vertical-align: inherit;">El siguiente es un bucle de espera ocupada que espera otra tarea para establecer la variable de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marca</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> global </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por desgracia, monopoliza el procesador e impide el lanzamiento de otras corutinas:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bad_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El problema aqu√≠ es que hasta que el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flagis False</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> loop </font><i><font style="vertical-align: inherit;">pase el</font></i><font style="vertical-align: inherit;"> control al planificador, no se iniciar√° ninguna otra tarea. </font><font style="vertical-align: inherit;">El enfoque correcto:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">good_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por la misma raz√≥n, es una mala pr√°ctica establecer retrasos, por ejemplo, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque bloquea otras tareas durante 1 s; es m√°s correcto usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await asyncio.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenga en cuenta que los retrasos generados por los </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todos uasyncio </font></font></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms en</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realidad pueden exceder el tiempo especificado. Esto se debe al hecho de que se realizar√°n otras tareas durante el retraso. Una vez transcurrido el per√≠odo de retraso, la ejecuci√≥n no se reanudar√° hasta que los problemas de la tarea en ejecuci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarden</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o finalicen. Una corutina bien portada siempre declarar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esperar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a intervalos regulares. Cuando se requiere un retraso exacto, especialmente si uno es inferior a unos pocos ms, puede ser necesario usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep_us (us)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.5 ¬øPor qu√© la programaci√≥n colaborativa, no basada en subprocesos ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_thread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La reacci√≥n inicial de los principiantes a la idea de co-planificar corutinas es a menudo decepcionante. ¬øSeguramente la planificaci√≥n de transmisi√≥n es mejor? ¬øPor qu√© deber√≠a ceder expl√≠citamente el control si la m√°quina virtual Python puede hacer esto por m√≠? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se trata de sistemas embebidos, el modelo de colaboraci√≥n tiene dos ventajas.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primero es ligero. Es posible tener una gran cantidad de corutinas, porque a diferencia de los hilos programados, las corutinas suspendidas ocupan menos espacio. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar, esto evita algunos de los problemas sutiles asociados con la programaci√≥n de transmisi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la pr√°ctica, la multitarea colaborativa se usa ampliamente, especialmente en aplicaciones de interfaz de usuario. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En defensa del modelo de planificaci√≥n de transmisi√≥n, mostrar√© una ventaja: si alguien escribe</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range ( <span class="hljs-number"><span class="hljs-number">1000000</span></span> ): <span class="hljs-comment"><span class="hljs-comment">#  - </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No bloquear√° otras tareas. El modelo de colaboraci√≥n asume que el ciclo deber√≠a dar expl√≠citamente a cada tarea un cierto n√∫mero de iteraciones, por ejemplo, poner el c√≥digo en una rutina y emitir peri√≥dicamente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por desgracia, esta ventaja palidece en comparaci√≥n con las desventajas. Algunos de estos se describen en la documentaci√≥n para escribir </font></font><a href="http://docs.micropython.org/en/latest/reference/isr_rules.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manejadores de interrupciones.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En un modelo de programaci√≥n de transmisi√≥n, cada subproceso puede interrumpir cualquier otro subproceso, cambiando los datos que se pueden utilizar en otros subprocesos. Como regla general, es mucho m√°s f√°cil encontrar y corregir un bloqueo que ocurre debido a un error que no da un resultado que la detecci√≥n de errores a veces muy sutiles y raramente encontrados que pueden ocurrir en el c√≥digo escrito en el marco de un modelo con planificaci√≥n de transmisi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En pocas palabras, si escribe una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corutina</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MicroPython </font><font style="vertical-align: inherit;">, puede estar seguro de que las variables no ser√°n cambiadas repentinamente por otra corutina: su corutina tiene control total hasta que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regrese aguarde asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenga en cuenta que los manejadores de interrupciones son preventivos. Esto se aplica tanto a las interrupciones de hardware como de software que pueden ocurrir en cualquier parte de su c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una discusi√≥n elocuente de los problemas de planificaci√≥n de transmisi√≥n se puede encontrar </font></font><a href="http://glyph.twistedmatrix.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.6 Interacci√≥n</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En aplicaciones no triviales, las corutinas deben interactuar. Se pueden usar los m√©todos convencionales de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Estos incluyen el uso de variables globales o la declaraci√≥n de corutinas como m√©todos de objeto: pueden compartir variables de instancia. Alternativamente, un objeto mutable puede pasarse como argumento a una rutina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modelo de planificaci√≥n de transmisi√≥n requiere especialistas para garantizar que las clases proporcionen una conexi√≥n segura; </font><font style="vertical-align: inherit;">en un modelo de colaboraci√≥n, esto rara vez se requiere. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.7. </font><font style="vertical-align: inherit;">Poll ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Polling</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algunos dispositivo de hardware tal como un aceler√≥metro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no admiten interrupciones, y por lo tanto debe ser sondea (es decir, verificar peri√≥dicamente). </font><font style="vertical-align: inherit;">El sondeo tambi√©n se puede usar junto con los manejadores de interrupciones: el manejador de interrupciones mantiene el equipo y establece una bandera. </font><font style="vertical-align: inherit;">La rutina sondea la bandera; si est√° configurada, los datos se procesan y la bandera se restablece. </font><font style="vertical-align: inherit;">El mejor enfoque es usar la clase </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evento</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a href="https://habr.com/ru/post/484472/">https://habr.com/ru/post/484472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484462/index.html">Scraping Github: en busca de "secretos" para desarrollar</a></li>
<li><a href="../484464/index.html">Subastas de motocicletas japonesas, como sucede todo</a></li>
<li><a href="../484466/index.html">Las promesas comunes de JavaScript son importantes para todos</a></li>
<li><a href="../484468/index.html">La cultura corporativa roja es el principal problema de los negocios rusos (Parte 2)</a></li>
<li><a href="../484470/index.html">Extensiones Extensibles en JavaScript</a></li>
<li><a href="../484480/index.html">La capitalizaci√≥n de las 5 compa√±√≠as tecnol√≥gicas m√°s grandes de EE. UU. Super√≥ los $ 5 billones</a></li>
<li><a href="../484482/index.html">Un peque√±o programa educativo sobre tratamiento de aguas.</a></li>
<li><a href="../484484/index.html">Ubuntu no es el mejor escritorio de Linux</a></li>
<li><a href="../484486/index.html">Una computadora que se niega a morir</a></li>
<li><a href="../484488/index.html">¬øQu√© tan confuso es un sistema cu√°ntico? La respuesta puede no ser computable.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>