<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗯️ 🤹🏽 🈚️ Wir schreiben Reverse socks5 Proxy auf Powershell. Teil 1 🤶🏻 🚵🏼 🔓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Geschichte von Forschung und Entwicklung in 3 Teilen. Teil 1 - Forschung. 
 Es gibt viele Buchen - noch mehr Vorteile. 

 Erklärung des Problems 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben Reverse socks5 Proxy auf Powershell. Teil 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453870/">  Die Geschichte von Forschung und Entwicklung in 3 Teilen.  Teil 1 - Forschung. <br>  Es gibt viele Buchen - noch mehr Vorteile. <br><br><h3>  Erklärung des Problems </h3><br>  Während der Durchführung von Pentests und RedTeam-Kampagnen ist es nicht immer möglich, die regulären Mittel von Kunden wie VPN, RDP, Citrix usw. zu verwenden.  als Fix für den Zugang zum internen Netzwerk.  Irgendwo funktioniert ein Vollzeit-VPN gemäß MFA und ein Eisen-Token wird als zweiter Faktor verwendet, irgendwo wird es streng überwacht und unser VPN-Eintrag wird sofort sichtbar, wie sie sagen - mit allen Konsequenzen, aber irgendwo gibt es einfach keine solchen Mittel. <br><br>  In solchen Fällen müssen ständig die sogenannten "Reverse Tunnels" durchgeführt werden - Verbindungen vom internen Netzwerk zu einer externen Ressource oder dem Server, den wir steuern.  In einem solchen Tunnel können wir bereits mit den internen Ressourcen der Kunden arbeiten. <br><br>  Es gibt verschiedene Arten solcher Umkehrtunnel.  Der bekannteste von ihnen ist natürlich Meterpreter.  SSH-Tunnel mit Reverse-Port-Weiterleitung sind auch bei den Hacker-Massen sehr gefragt.  Es gibt viele Reverse-Tunneling-Tools, von denen viele gut untersucht und beschrieben sind. <br><br>  Natürlich stehen Entwickler von Schutzlösungen ihrerseits nicht bereit und erkennen solche Aktionen aktiv. <br><br>  Beispielsweise werden MSF-Sitzungen von modernen IPS von Cisco oder Positive Tech erfolgreich erkannt, und der umgekehrte SSH-Tunnel kann von fast jeder kleinen normalen Firewall erkannt werden. <br><br>  Um in einer guten RedTeam-Kampagne unbemerkt zu bleiben, müssen wir daher einen Reverse-Tunnel mit nicht standardmäßigen Mitteln bauen und uns so genau wie möglich an den realen Modus des Netzwerks anpassen. <br><br>  Versuchen wir, etwas Ähnliches zu finden oder zu erfinden. <br><a name="habracut"></a><br>  Bevor Sie etwas erfinden, müssen Sie verstehen, welches Ergebnis wir erzielen möchten und welche Funktionen unsere Entwicklung erfüllen sollte.  Was sind die Anforderungen an den Tunnel, damit wir im Maximum-Stealth-Modus arbeiten können? <br><br>  Es ist klar, dass solche Anforderungen für jeden Fall sehr unterschiedlich sein können, aber aus Erfahrung können wir die wichtigsten unterscheiden: <br><br><ul><li>  Arbeit unter OS Windows-7-10.  Da die meisten Unternehmensnetzwerke Windows verwenden; </li><li>  Der Client stellt über SSL eine Verbindung zum Server her, um dummes Abhören mit ips zu verhindern. </li><li>  Beim Herstellen einer Verbindung muss der Client den Betrieb über einen Proxy-Server mit Berechtigung unterstützen, z  Viele Unternehmen greifen über einen Proxy auf das Internet zu.  Tatsächlich weiß der Client-Computer möglicherweise nicht einmal etwas darüber, und der Proxy wird in einem transparenten Modus verwendet.  Aber wir müssen solche Funktionalität legen; </li><li>  Der Client-Teil sollte präzise und portabel sein. <br>  Es ist klar, dass Sie für die Arbeit im Netzwerk des Kunden auf dem Client-Computer OpenVPN installieren und einen vollwertigen Tunnel zu Ihrem Server erstellen können (da openvpn-Clients über Proxys arbeiten können).  Aber erstens funktioniert das nicht immer, da wir dort möglicherweise keine lokalen Administratoren sind, und zweitens macht es so viel Lärm, dass ein anständiges SIEM oder HIPS sofort „auf uns klopfen“.  Im Idealfall sollte unser Client ein sogenannter Inline-Befehl sein, wie z. B. viele Bash-Shells, und beispielsweise über die Befehlszeile ausgeführt werden, wenn Befehle über ein Wortmakro ausgeführt werden. </li><li>  Unser Tunnel muss Multithread-fähig sein und viele Verbindungen gleichzeitig unterstützen. </li><li>  Die Client-Server-Verbindung muss über eine Berechtigung verfügen, damit der Tunnel nur für unseren Client und nicht für alle Personen eingerichtet wird, die unter der angegebenen Adresse und dem angegebenen Port zu unserem Server kommen.  Idealerweise sollte für Benutzer von Drittanbietern eine Zielseite mit Siegeln oder professionellen Themen im Zusammenhang mit der Quelldomäne geöffnet werden. <br>  Wenn der Kunde beispielsweise eine medizinische Organisation ist, sollte für den Administrator für Informationssicherheit, der beschlossen hat, die vom Klinikmitarbeiter verwendete Ressource zu überprüfen, eine Seite mit pharmazeutischen Produkten, eine Wikipedia mit einer Beschreibung der Diagnose oder ein Blog von Dr. Komarovsky usw. geöffnet werden. </li></ul><br><h3>  Analyse vorhandener Tools </h3><br>  Bevor Sie Ihr Fahrrad erfinden, müssen Sie vorhandene Fahrräder analysieren und verstehen, ob wir es wirklich brauchen, und wahrscheinlich haben wir nicht nur über die Notwendigkeit eines solchen funktionellen Fahrrads nachgedacht. <br><br>  Das Googeln im Internet (wir scheinen mit Google einverstanden zu sein) sowie das Durchsuchen des Githubs nach den Schlüsselwörtern „Reverse Socks“ ergaben nicht viele Ergebnisse.  Grundsätzlich kommt es darauf an, SSH-Tunnel mit Reverse-Port-Weiterleitung und allem, was damit verbunden ist, zu bauen.  Neben SSH-Tunneln können verschiedene Lösungen unterschieden werden: <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/klsecservices/rpivot</a></b> <br>  Eine langjährige Implementierung des Reverse Tunnels von den Jungs von Kaspersky Lab.  Durch den Namen ist klar, wofür dieses Skript gedacht ist.  Der in Python 2.7 implementierte Tunnel wird im Klartextmodus ausgeführt (wie es jetzt üblich ist - Hallo an ILV). <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/tonyseek/rsocks</a></b> <br>  Eine andere Python-Implementierung ist ebenfalls im Klartext, es gibt jedoch mehr Optionen.  Es ist als Modul geschrieben und es gibt eine API zur Integration der Lösung in Ihre Projekte. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/llkat/rsockstun</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/mis-team/rsockstun</a></b> <br>  Der erste Link ist die erste Version der Implementierung von Reverse Sox auf dem Golang (vom Entwickler nicht unterstützt). <br><br>  Der zweite Link ist bereits unsere Überarbeitung mit zusätzlichen Chips, auch auf dem Golang.  In unserer Version haben wir SSL implementiert, einen Proxy mit NTLM-Autorisierung, Client-Autorisierung, eine Zielseite mit einem falschen Kennwort (oder vielmehr eine Weiterleitung zu einer Zielseite) und einen Multithread-Modus (d. H. Mehrere Personen können gleichzeitig mit dem Tunnel arbeiten) bearbeitet. , ein Client-Ping-System, ob es lebt oder nicht. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/jun7th/tsocks</a></b> <br>  Reverse Sox-Implementierung von unseren „chinesischen Freunden“ in Python.  Dort für die Faulen und "Unsterblichen" liegt der fertige Binar (exe), der von den Chinesen zusammengestellt und gebrauchsfertig ist.  Hier weiß nur der chinesische Gott, dass dieses Binar mehr als die Hauptfunktionalität bieten kann. Verwenden Sie es also auf eigene Gefahr und Gefahr. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/securesocketfunneling/ssf</a></b> <br>  Ein interessantes C ++ - Projekt zur Implementierung von Reverse Socks und mehr.  Zusätzlich zum Reverse-Tunnel kann eine Portweiterleitung durchgeführt, eine Befehlsshell erstellt usw. werden. <br><br>  <b>Msf meterpreter</b> <br>  Hier, wie sie sagen, kein Kommentar.  Alle mehr oder weniger gut ausgebildeten Hacker sind mit dieser Sache sehr vertraut und wissen, wie leicht sie von Schutzausrüstung erkannt werden kann. <br><br>  Alle oben genannten Tools arbeiten mit einer ähnlichen Technologie: Auf einem Computer im Netzwerk wird ein vorbereitetes ausführbares Binärmodul gestartet, das eine Verbindung zu einem externen Server herstellt.  Der Server startet den SOCKS4 / 5-Server, der Verbindungen akzeptiert und diese in den Client übersetzt. <br><br>  Der Nachteil aller oben genannten Tools besteht darin, dass entweder Python oder Golang auf dem Client-Computer erforderlich ist (haben Sie Python häufig auf Computern installiert, z. B. Unternehmensleitern oder Büroangestellten?), Oder Sie müssen eine vormontierte Binärdatei auf diesen Computer ziehen (tatsächlich Python und das Skript in einer Flasche) und führen Sie dieses Binar bereits dort aus.  Das Herunterladen von exe mit dem anschließenden Start ist auch die Signatur für ein lokales Antivirenprogramm oder HIPS. <br><br>  Im Allgemeinen bietet sich die Schlussfolgerung an - wir brauchen eine Lösung für Powershell.  Jetzt fliegen Tomaten auf uns zu - sie sagen Powershell - es ist alles zusammengeschlagen, es wird überwacht, blockiert usw.  usw.  In der Tat - nicht überall.  Wir erklären verantwortungsbewusst.  Übrigens gibt es viele Möglichkeiten, die Sperren zu umgehen (hier wieder der modische Satz über Hallo an die ILV :)), angefangen von der dummen Umbenennung von Powershell.exe -&gt; cmdd.exe bis hin zu Powerdll usw. <br><br><h3>  Fangen Sie an zu erfinden </h3><br>  Es ist klar, dass wir zunächst in Google nachsehen und ... zu diesem Thema nichts finden (wenn jemand etwas gefunden hat - werfen Sie Links in Kommentare).  Es gibt nur eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Implementierung von</a> Socks5 auf Powershell, aber dies ist die übliche "direkte" Sox, die eine Reihe von Nachteilen hat (wir werden später darüber sprechen).  Sie können es natürlich mit einem Handgriff in eine Umkehrung verwandeln, aber es wird nur ein Sox mit einem einzigen Faden sein, was nicht genau das ist, was wir brauchen. <br><br>  Wir haben also nichts fertig gefunden, also müssen wir unser Fahrrad noch erfinden.  Als Basis für unser Fahrrad nehmen wir die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entwicklung von</a> Reverse-Socken auf dem Golang und implementieren den Kunden dafür auf Powershell. <br><br>  <b>RSocksTun</b> <br><br>  Wie funktioniert rsockstun? <br><br>  Im Zentrum der Arbeit von RsocksTun (im Folgenden als rs bezeichnet) stehen zwei Softwarekomponenten - Yamux und Socks5 Server.  Der Socks5-Server ist ein normaler lokaler Socks5-Server, der auf dem Client ausgeführt wird.  Und Multiplexing-Verbindungen dazu (erinnern Sie sich an Multithreading?) Wird mit yamux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einem weiteren Multiplexer</a> ) bereitgestellt.  Mit diesem Schema können Sie mehrere Client-Socks5-Server ausführen und externe Verbindungen an diese verteilen, indem Sie sie über eine einzige TCP-Verbindung (fast wie im Meterpreter) vom Client an den Server weiterleiten und so den Multithread-Modus realisieren, ohne den wir im internen einfach nicht vollständig arbeiten können Netzwerk. <br><br>  Das Wesentliche von yamux ist, dass es eine zusätzliche Netzwerkebene von Streams einführt und diese als 12-Byte-Header für jedes Paket realisiert.  (Hier verwenden wir absichtlich das Wort "Stream", keinen Stream, um den Leser nicht mit dem Programm-Thread "Thread" zu verwechseln - dieses Konzept werden wir auch in diesem Artikel verwenden).  Der Yamux-Header enthält die Stream-Nummer, Flags zum Setzen / Beenden des Streams, die Anzahl der übertragenen Bytes und die Größe des Übertragungsfensters. <br><br><img src="https://habrastorage.org/webt/ga/go/we/gagowe129appe4mb67fwca2rumi.jpeg"><br><br>  Zusätzlich zur Installation / Vervollständigung des Streams implementiert yamux einen Keepalive-Mechanismus, mit dem Sie den Zustand des installierten Kommunikationskanals überwachen können.  Der Mechanismus für Keeplive-Nachrichten wird beim Erstellen einer Yamux-Sitzung konfiguriert.  Tatsächlich gibt es in den Einstellungen nur zwei Parameter: Aktivieren / Deaktivieren und die Häufigkeit des Sendens von Paketen in Sekunden.  Der Yamux-Server kann Keepalive-Nachrichten senden, der Yamux-Client auch.  Nach Erhalt einer Keepalive-Nachricht ist die Gegenstelle verpflichtet, darauf zu antworten, indem sie genau dieselbe Nachrichtenkennung (tatsächlich eine Nummer) sendet, die sie erhalten hat.  Im Allgemeinen ist Keepalive der gleiche Ping, nur für Yamux. <br><br>  Die gesamte Multiplexer-Operationstechnik ist im Detail: Pakettypen, Installations- und Terminierungsflags, Datenübertragungsmechanismus ist in <a href="">der</a> Yamux- <a href="">Spezifikation beschrieben</a> . <br><br><h3>  Fazit zum ersten Teil </h3><br>  Im ersten Teil des Artikels haben wir einige Tools zum Organisieren von Rückwärts-Tunneln kennengelernt, ihre Vor- und Nachteile untersucht, den Funktionsmechanismus des Yamux-Multiplexers untersucht und die grundlegenden Anforderungen für das neu erstellte Powershell-Modul beschrieben.  Im nächsten Teil werden wir das Modul selbst praktisch von Grund auf neu entwickeln.  Fortsetzung folgt.  Nicht wechseln :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de453870/">https://habr.com/ru/post/de453870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de453860/index.html">AMD stellte seine neuen kundenspezifischen 7-nm-Prozessoren Ryzen der dritten Generation vor</a></li>
<li><a href="../de453862/index.html">Warum sollten Sie Pathlib verwenden</a></li>
<li><a href="../de453864/index.html">Das Verwenden einer Maus und einer Tastatur auf Konsolen ist Betrug?</a></li>
<li><a href="../de453866/index.html">API-Anfrage mit React Hooks, HOC oder Render Prop</a></li>
<li><a href="../de453868/index.html">Berühren Sie den Mini-Schalter mit Glasscheibe am nRF52832</a></li>
<li><a href="../de453872/index.html">Wiederherstellen von Fotos mithilfe neuronaler Netze</a></li>
<li><a href="../de453874/index.html">Vom russischen Roulette zum sicheren LOTO: So schützen Sie das Personal des Rechenzentrums</a></li>
<li><a href="../de453876/index.html">Wie bei Yandex.Practicum gewann das Front-End-Desync: eine akrobatische Nummer mit Redux-Saga, postMessage und Jupyter</a></li>
<li><a href="../de453882/index.html">Ein guter Leitfaden zum Beruf eines Lösungsarchitekten (+ Liste nützlicher Links)</a></li>
<li><a href="../de453884/index.html">HYIP Kamera oder DSLR Ersatz?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>