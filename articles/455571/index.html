<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≤ ‚§¥Ô∏è üö∏ Cursores DB en Doctrine üõ©Ô∏è üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø üòò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Con los cursores, puede recibir por lotes desde la base de datos y procesar una gran cantidad de datos sin desperdiciar la memoria de la aplicaci√≥n. E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cursores DB en Doctrine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/455571/"><p><img src="https://habrastorage.org/webt/a_/l9/rc/a_l9rcqm9ubhpc_gstic1u-rxtq.jpeg" alt="imagen"></p><br><p>  Con los cursores, puede recibir por lotes desde la base de datos y procesar una gran cantidad de datos sin desperdiciar la memoria de la aplicaci√≥n.  Estoy seguro de que cada desarrollador web se ha enfrentado a una tarea similar al menos una vez, y no solo una vez antes que yo.  En este art√≠culo, le dir√© en qu√© tareas los cursores pueden ser √∫tiles, y le dar√© un c√≥digo listo para trabajar con ellos desde PHP + Doctrine usando el ejemplo de PostrgeSQL. </p><a name="habracut"></a><br><h3 id="problema">  El problema </h3><br><p>  Imaginemos que tenemos un proyecto PHP, grande y pesado.  Seguramente, fue escrito con la ayuda de alg√∫n marco.  Por ejemplo, Symfony.  Tambi√©n utiliza una base de datos, por ejemplo, PostgreSQL, y la base de datos tiene una placa para 2,000,000 de registros con informaci√≥n sobre pedidos.  Y el proyecto en s√≠ es una interfaz para estos pedidos, que puede mostrarlos y filtrarlos.  Y, d√©jenme decir, esto est√° bastante bien. </p><br><p>  Ahora se nos pidi√≥ (¬øtodav√≠a no se le ha preguntado? Definitivamente se les pedir√°) que carguemos el resultado de filtrar pedidos en un archivo Excel.  Agitemos un bot√≥n con un icono de tabla, que escupir√° un archivo con √≥rdenes para el usuario. </p><br><h3 id="kak-obychno-reshayut-i-chem-eto-ploho">  ¬øC√≥mo se suele decidir y por qu√© es malo? </h3><br><p>  ¬øC√≥mo funciona un programador que a√∫n no se ha encontrado con esa tarea?  Hace SELECCIONAR en la base de datos, lee los resultados de la consulta, convierte la respuesta en un archivo de Excel y la entrega al navegador del usuario.  La tarea funciona, la prueba se completa, pero los problemas comienzan en la producci√≥n. </p><br><p> Seguramente, hemos establecido un l√≠mite de memoria para PHP en un razonable (posiblemente) 1 GB por proceso, y tan pronto como estos 2 millones de l√≠neas ya no caben en este gigabyte, todo se rompe.  PHP se bloquea con un error de "falta de memoria", y los usuarios se quejan de que el archivo no est√° cargado.  Esto sucede porque elegimos una forma bastante ingenua de descargar datos de la base de datos: todos ellos primero se transfieren desde la memoria de la base de datos (y el disco debajo de ella) a la RAM del proceso PHP, luego se procesan y se cargan en el navegador. </p><br><p>  Para que los datos siempre se coloquen en la memoria, debe tomarlos de la base de datos por partes.  Por ejemplo, 10,000 registros fueron le√≠dos, procesados, escritos en un archivo, y tantas veces. </p><br><p>  Bueno, piensa el programador que cumpli√≥ nuestra tarea por primera vez.  Luego har√© un ciclo y desinflar√© los resultados de la consulta en partes, indicando LIMIT y OFFSET.  Funciona, pero es una operaci√≥n muy costosa para la base de datos y, por lo tanto, cargar el informe no comienza a tomar 30 segundos, sino 30 minutos (¬°no es tan malo!).  Por cierto, si aparte de OFFSET en este momento, nada m√°s viene a la mente del programador, entonces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">todav√≠a hay muchas maneras de lograr</a> lo mismo sin violar la base de datos. </p><br><p>  Al mismo tiempo, la base de datos en s√≠ misma tiene una capacidad incorporada para enhebrar datos de lectura de ella: cursores. </p><br><h3 id="kursory">  Cursores </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Un cursor</a> es un puntero a una l√≠nea en los resultados de una consulta que vive en la base de datos.  Al usarlos, podemos realizar SELECCIONAR no en el modo de descarga inmediata de datos, sino abrir el cursor con esta selecci√≥n.  A continuaci√≥n, comenzamos a recibir el flujo de datos de la base de datos a medida que el cursor avanza.  Esto nos da el mismo resultado: leemos los datos en porciones, pero la base de datos no hace el mismo trabajo de encontrar la l√≠nea con la que necesita comenzar, como es el caso de OFFSET. </p><br><p>  El cursor se abre solo dentro de la transacci√≥n y vive hasta que la transacci√≥n est√© viva (hay una excepci√≥n, vea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WITH HOLD</a> ).  Esto significa que si leemos lentamente muchos datos de la base de datos, tendremos una transacci√≥n larga.  Esto a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">veces</a> es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">malo</a> , debe comprender y aceptar este riesgo. </p><br><h3 id="kursory-v-doctrine">  Cursores en Doctrina </h3><br><p>  Intentemos implementar el trabajo con cursores en Doctrine.  Primero, ¬øc√≥mo se ve una solicitud para abrir un cursor? </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> mycursor1 <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> huge_table );</code> </pre> <br><p>  DECLARE crea y abre el cursor para la consulta SELECT especificada.  Despu√©s de crear el cursor, puede comenzar a leer datos de √©l: </p><br><pre> <code class="sql hljs">FETCH FORWARD 10000 FROM mycursor1; &lt; 10 000 &gt; FETCH FORWARD 10000 FROM mycursor1; &lt;  10 000 &gt; ...</code> </pre> <br><p>  Y as√≠ sucesivamente, hasta que FETCH devuelva una lista vac√≠a.  Esto significar√° que se desplazaron hasta el final. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre> <br><p>  Esbozamos una clase compatible con Doctrine que encapsular√° el trabajo con el cursor.  Y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para resolver el 80% del problema en el 20% del tiempo</a> , solo funcionar√° con consultas nativas.  Entonces llam√©moslo, PgSqlNativeQueryCursor. </p><br><p>  Constructor: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeQuery $query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query = $query; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection = $query-&gt;getEntityManager()-&gt;getConnection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName = uniqid(<span class="hljs-string"><span class="hljs-string">'cursor_'</span></span>); assert(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getDriver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PDOPgSqlDriver); }</code> </pre> <br><p>  Aqu√≠ genero un nombre para el futuro cursor. </p><br><p>  Dado que la clase tiene un c√≥digo SQL espec√≠fico de PostgreSQL en la clase, es mejor verificar que nuestro controlador sea PG. </p><br><p>  De la clase necesitamos tres cosas: </p><br><ol><li>  Poder abrir el cursor. </li><li>  Poder devolvernos datos. </li><li>  Poder cerrar el cursor. </li></ol><br><p>  <strong>Abre el cursor:</strong> </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openCursor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getTransactionNestingLevel() === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \BadMethodCallException(<span class="hljs-string"><span class="hljs-string">'Cursor must be used inside a transaction'</span></span>); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'DECLARE %s CURSOR FOR (%s)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getSQL() )); $query-&gt;execute(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getParameters()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br><p>  Como dije, los cursores se abren en una transacci√≥n.  Por lo tanto, aqu√≠ verifico que no nos hemos olvidado de hacer una llamada a este m√©todo dentro de una transacci√≥n ya abierta.  (¬°Gracias a Dios, ha pasado el tiempo en que me atraer√≠a abrir una transacci√≥n aqu√≠ mismo!) </p><br><p>  Para simplificar la tarea de crear e inicializar una nueva NativeQuery, simplemente clono la que se introdujo en el constructor y la envuelvo en DECLARE ... CURSOR FOR (here_original_query).  Lo llevo a cabo. </p><br><p>  <strong>Hagamos el m√©todo getFetchQuery.</strong>  No devolver√° datos, sino otra solicitud que puede usarse como desee para obtener los datos deseados en lotes dados.  Esto le da al c√≥digo de llamada m√°s libertad. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH FORWARD %d FROM %s'</span></span>, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  El m√©todo tiene un par√°metro: este es el tama√±o del paquete, que formar√° parte de la solicitud devuelta por este m√©todo.  Aplico el mismo truco con la clonaci√≥n de consultas, sobrescribo los par√°metros en √©l y reemplazo SQL con FETCH ... FROM ...; construcci√≥n. </p><br><p>  Para no olvidar abrir el cursor antes de la primera llamada a getFetchQuery () (de repente no dormir√© lo suficiente), har√© una apertura impl√≠cita directamente en el m√©todo getFetchQuery (): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } ‚Ä¶</code> </pre> <br><p>  Y el m√©todo openCursor () se convertir√° en privado.  No veo casos en absoluto cuando necesito llamarlo expl√≠citamente. </p><br><p>  Dentro de getFetchQuery (), codifiqu√© FORWARD para mover el cursor hacia adelante un n√∫mero determinado de l√≠neas.  Pero los modos de llamada FETCH son muy diferentes.  ¬øVamos a agregarlos tambi√©n? </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_NEXT = <span class="hljs-string"><span class="hljs-string">'NEXT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_PRIOR = <span class="hljs-string"><span class="hljs-string">'PRIOR'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_FIRST = <span class="hljs-string"><span class="hljs-string">'FIRST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_LAST = <span class="hljs-string"><span class="hljs-string">'LAST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_ABSOLUTE = <span class="hljs-string"><span class="hljs-string">'ABSOLUTE'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// with count const DIRECTION_RELATIVE = 'RELATIVE'; // with count const DIRECTION_FORWARD = 'FORWARD'; // with count const DIRECTION_FORWARD_ALL = 'FORWARD ALL'; const DIRECTION_BACKWARD = 'BACKWARD'; // with count const DIRECTION_BACKWARD_ALL = 'BACKWARD ALL';</span></span></code> </pre> <br><p>  La mitad de ellos acepta el n√∫mero de l√≠neas en el par√°metro, y la otra mitad no.  Esto es lo que obtuve: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, string $direction = self::DIRECTION_FORWARD)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_ABSOLUTE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_RELATIVE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_FORWARD || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_BACKWARD ) { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s %d FROM %s'</span></span>, $direction, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s FROM %s'</span></span>, $direction, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  <strong>Cierre el cursor</strong> con CLOSE, no es necesario esperar a que se complete la transacci√≥n: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;exec(<span class="hljs-string"><span class="hljs-string">'CLOSE '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><p>  Destructor </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); } }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ est√° toda la clase en su totalidad</a> .  ¬øIntentamos en acci√≥n? </p><br><p>  Abro un escritor condicional en alg√∫n XLSX condicional. </p><br><pre> <code class="php hljs">$writer-&gt;openToFile($targetFile);</code> </pre> <br><p>  Aqu√≠ obtengo NativeQuery para extraer la lista de pedidos de la base de datos. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> NativeQuery $query */</span></span> $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOrdersRepository($em) -&gt;getOrdersFiltered($dateFrom, $dateTo, $filters);</code> </pre> <br><p>  Basado en esta consulta, declaro un cursor. </p><br><pre> <code class="php hljs">$cursor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PgSqlNativeQueryCursor($query);</code> </pre> <br><p>  Y para √©l recibo una solicitud para recibir datos en lotes de 10,000 l√≠neas. </p><br><pre> <code class="php hljs">$fetchQuery = $cursor-&gt;getFetchQuery(<span class="hljs-number"><span class="hljs-number">10000</span></span>);</code> </pre> <br><p>  Repito hasta que obtengo un resultado vac√≠o.  En cada iteraci√≥n, realizo FETCH, proceso el resultado y escribo en un archivo. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $result = $fetchQuery-&gt;getArrayResult(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $writer-&gt;addRow(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toXlsxRow($row)); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($result);</code> </pre> <br><p>  Cierro el cursor y el escritor. </p><br><pre> <code class="php hljs">$cursor-&gt;close(); $writer-&gt;close();</code> </pre> <br><p>  El archivo en s√≠ lo escribo en el disco en un directorio para archivos temporales, y despu√©s de que se completa la grabaci√≥n, se lo entrego al navegador para evitar, nuevamente, el almacenamiento en b√∫fer en la memoria. </p><br><p>  INFORME LISTO!  Utilizamos una cantidad constante de memoria de PHP para procesar todos los datos y no torturamos la base de datos con una serie de consultas pesadas.  Y la descarga en s√≠ misma tom√≥ un poco m√°s de tiempo que la base requerida para cumplir con la solicitud. </p><br><p>  ¬øVes si hay lugares en tus proyectos que pueden acelerar / guardar memoria con el cursor? </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/455571/">https://habr.com/ru/post/455571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455555/index.html">Pieza para el gerente mec√°nico</a></li>
<li><a href="../455559/index.html">¬øC√≥mo puede una computadora cu√°ntica entrar en los sistemas modernos de encriptaci√≥n y reducir el costo de producci√≥n de amon√≠aco?</a></li>
<li><a href="../455563/index.html">Peque√±as empresas: ¬øAutomatizar o no?</a></li>
<li><a href="../455565/index.html">¬øPuede la mente fingir el universo?</a></li>
<li><a href="../455569/index.html">Te invitamos a la Conferencia de Tarantool el 17 de junio.</a></li>
<li><a href="../455575/index.html">Neural Matching: c√≥mo adaptar el contenido a las realidades de Google</a></li>
<li><a href="../455577/index.html">SDL 2 Lecciones: Lecci√≥n 3 - Eventos</a></li>
<li><a href="../455579/index.html">Tupperware: ¬øel asesino de Facebook Kubernetes?</a></li>
<li><a href="../455580/index.html">Impresiones de aplicaciones m√≥viles imprescindibles</a></li>
<li><a href="../455582/index.html">Navegaci√≥n en la tienda: a trav√©s de la realidad aumentada hasta el estante deseado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>