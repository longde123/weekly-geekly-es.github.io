<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïê üé≥ üö£üèø Verantwortlich f√ºr die Verwaltung der Windows-Konfiguration. Erfolgsgeschichte üì´ üë©üèΩ‚Äçü§ù‚Äçüë®üèº üöò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei einem der Treffen der .Net-Community von St. Petersburg mit Entwicklern der SpbDotNet-Community haben wir ein Experiment durchgef√ºhrt und beschlos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verantwortlich f√ºr die Verwaltung der Windows-Konfiguration. Erfolgsgeschichte</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/455604/"><p>  Bei einem der Treffen der .Net-Community von St. Petersburg mit Entwicklern der SpbDotNet-Community haben wir ein Experiment durchgef√ºhrt und beschlossen, dar√ºber zu sprechen, wie Sie Ans√§tze anwenden k√∂nnen, die in der Linux-Welt seit langem Standard sind, um Windows-Infrastrukturen zu automatisieren.  Um jedoch nicht alles so weit zu bringen, dass das Ansible-Flag markiert wird, wurde beschlossen, dies am Beispiel der Bereitstellung einer ASP.Net-Anwendung zu zeigen. </p><br><p>  Aleksey Chernov, Senior Developer des Teams, das die Bibliothek der UI-Komponenten f√ºr unsere Projekte entwickelt, meldete sich freiwillig als Redner.  Und ja, es schien Ihnen nicht so: Ein JavaScript-Entwickler trat vor ein .Net-Publikum. </p><br><p>  Jeder, der sich f√ºr das Ergebnis eines solchen Experiments interessiert, ist im Rahmen der Dekodierung willkommen. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nEA3sSE33U4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Hi) Sie haben sich schon ein wenig verw√∂hnt und gesagt, dass ich ein Frontend bin, also kannst du schon auseinander gehen =) Mein Name ist Alexey, ich mache seit einiger Zeit alles M√∂gliche in Bezug auf Webentwicklung.  Ich habe mit Perl angefangen, dann gab es PHP, ein bisschen RoR, ein bisschen, ein bisschen davon.  Und dann brach JavaScript in mein Leben ein und seitdem mache ich fast alles. </p><br><p>  Zus√§tzlich zu JS habe ich in letzter Zeit ziemlich viele Autotests geschrieben (au√üerdem auf demselben JS), und deshalb muss ich mich mit der Automatisierung der Bereitstellung von Testb√§nken und der Infrastruktur f√ºr diese befassen. </p><br><p>  <strong>Hintergrund</strong> </p><br><p>  Vor zwei Jahren bin ich bei Veeam gelandet, wo sie Produkte f√ºr Windows entwickeln.  In diesem Moment war ich sehr √ºberrascht, aber es stellte sich heraus, dass es passiert =).  Vor allem aber war ich √ºberrascht √ºber den ungew√∂hnlich geringen Automatisierungsgrad von allem, was mit der Bereitstellung, der Bereitstellung von Anwendungen, Tests usw. zu tun hat. </p><br><p>  Wir, die wir f√ºr Linux entwickeln, sind seit langem daran gew√∂hnt, dass alles in Docker sein sollte, es gibt Kubernetes und alles entfaltet sich mit einem einzigen Klick.  Und als ich in einer Umgebung landete, in der das alles nicht da ist, war es schockiert.  Und als ich anfing, Autotests durchzuf√ºhren, stellte ich fest, dass dies nur ein Erfolg von 20% war und alles andere die Infrastruktur f√ºr sie vorbereitete. </p><br><p><img src="https://habrastorage.org/webt/5v/rm/ca/5vrmcacwrpdrkb1dejapgmjzfqa.png"><br>  <em>Meine Gef√ºhle am Anfang</em> </p><br><p>  <strong>Aktuelle Bedingungen</strong> </p><br><p>  Ich erz√§hle Ihnen ein wenig dar√ºber, wie alles bei uns arrangiert ist, was wir automatisieren m√ºssen und was wir tun. </p><br><p> Wir haben eine Reihe verschiedener Produkte, die meisten davon unter Windows, einige unter Linux und sogar etwas unter Solaris.  F√ºr alle Produkte werden t√§glich sehr viele Builds gesammelt.  Dementsprechend ist es notwendig, alles in Testlabors sowohl f√ºr die Qualit√§tssicherung als auch f√ºr die Entwickler selbst einzuf√ºhren, damit sie die Anwendungsintegration √ºberpr√ºfen k√∂nnen.  All dies erfordert eine riesige Infrastruktur mit vielen Eisenservern und virtuellen Maschinen.  Und manchmal f√ºhren wir Leistungstests durch, wenn wir sofort tausend virtuelle Maschinen hochfahren und sehen m√ºssen, wie schnell unsere Anwendungen funktionieren. </p><br><p>  <strong>Die Probleme</strong> </p><br><p>  Nat√ºrlich wurde in den ersten Phasen (vor langer Zeit gelesen) PowerShell verwendet, um alles direkt zu automatisieren.  Das Tool ist leistungsstark, aber Bereitstellungsskripte sind √§u√üerst kompliziert.  Ein weiteres Problem war das Fehlen einer zentralen Verwaltung dieses Prozesses.  Einige Skripte wurden lokal von Entwicklern ausgef√ºhrt, andere auf virtuellen Maschinen, die im Zeitalter der Mammuts usw. erstellt wurden.  Infolgedessen war es schwierig, ein einziges Ergebnis zu erhalten und zu verstehen, was funktioniert und was nicht.  Wenn Sie zur Arbeit kommen, √∂ffnen Sie den Browser - der Server ist nicht verf√ºgbar.  Warum es nicht verf√ºgbar ist, was passiert ist, wo es kaputt gegangen ist - es war v√∂llig unklar.  Es gab keinen einzigen Einstiegspunkt und ich musste in funktionierenden Chatrooms nach der Wahrheit suchen. Es ist gut, wenn jemand antwortete. </p><br><p>  Ein weiteres Problem, das nicht so offensichtlich ist, sind Neulinge.  Es war schwierig f√ºr sie.  In der ersten Arbeitswoche haben sie sich nur mit dem befasst, was geschah.  Wir haben gew√∂hnlich damit gelebt und uns versichert, dass das Leben eine schwierige Sache ist und wir uns damit abfinden m√ºssen.  Sozusagen verstehen und vergeben. </p><br><p>  Aber irgendwann fanden sie die innere Kraft, es zu √ºberwinden und sich umzusehen.  Wahrscheinlich kannst du irgendwie damit umgehen. </p><br><p><img src="https://habrastorage.org/webt/kg/ra/io/kgraiod0cirwgawpngochydtu2e.png"><br>  <em>Der erste Schritt zur L√∂sung des Problems besteht darin, es zu akzeptieren.</em> </p><br><p>  <strong>L√∂sungsauswahl</strong> </p><br><p>  Wenn Sie nicht wissen, was Sie tun sollen, sehen Sie, was andere tun. </p><br><p>  Und f√ºr den Anfang haben wir unsere Liste der Anforderungen f√ºr das erstellt, was wir am Ende bekommen wollen. </p><br><ul><li>  Einheitliche Codebasis.  Alle Bereitstellungsskripte sollten sich an derselben Stelle befinden.  M√∂chten Sie etwas bereitstellen oder sehen, wie es sich entwickelt: Hier ist ein Repository f√ºr Sie. Gehen Sie dorthin. </li><li>  Jeder wei√ü, wie es funktioniert.  Fragen sollten verschwinden a la "Ich verstehe nicht, wie ich es bereitstellen soll, daher kann ich den Fehler am zweiten Tag nicht schlie√üen." </li><li>  M√∂glichkeit, per Knopfdruck zu starten.  Wir m√ºssen in der Lage sein, Bereitstellungen zu steuern.  Zum Beispiel eine Art Weboberfl√§che, auf der Sie eine Taste dr√ºcken und das gew√ºnschte Produkt auf dem gew√ºnschten Host bereitgestellt wird. </li></ul><br><p>  Nachdem wir sichergestellt hatten, dass diese Liste das Minimum an notwendigen und ausreichenden Anforderungen f√ºr unser Gl√ºck abdeckt, begannen wir es zu versuchen.  Traditionell war das erste, was sie versuchten, Probleme zu l√∂sen, die Frontalangriffsmethode.  Haben wir viele PowerShell-Skripte?  Kombinieren wir sie also zu einem Repository.  Das Problem ist jedoch nicht, dass es zu viele Skripte gab, sondern dass verschiedene Teams dasselbe mit verschiedenen Skripten machten.  Ich ging durch verschiedene Teams, h√∂rte ihren Anforderungen zu, sammelte dieselben Skripte, versuchte sie irgendwie zu k√§mmen und zu parametrisieren und legte sie dann in ein einziges Repository. </p><br><p>  <strong>Fehlgeschlagen: Der</strong> Versuch ist fehlgeschlagen.  Erstens haben wir viel dar√ºber gestritten, warum wir das tun und nicht so.  Warum wurde diese Methode verwendet und nicht irgendeine andere usw.  Infolgedessen gab es viele, die alles "wie es sollte" nach dem Prinzip "Ich werde alles f√ºr Sie aufteilen und umschreiben" wiederholen wollten.  Und nat√ºrlich wird es nicht m√∂glich sein, Branchen mit diesem Ansatz zu kombinieren. </p><br><p>  Versuch Nummer zwei: Es sollte unseren CI-Server (TeamCity) nehmen, einige Vorlagen darauf erstellen und mithilfe der Vererbung das Hauptproblem vom ersten Versuch an schlie√üen.  Wie Sie vielleicht gleich vermutet haben, hat <strong>Fail auch</strong> auf uns gewartet <strong>:</strong> Sie k√∂nnen die Vorlage nur f√ºr die neueste Version verwenden, was bedeutet, dass wir nicht die erforderliche Versionierung erreichen.  Und die Folge einer gro√üen Anzahl von Teams - Vorlagen wurden sehr zahlreich, es wurde schwieriger, sie zu verwalten, und am Horizont war ein neuer Sumpf deutlich sichtbar. </p><br><p><img src="https://habrastorage.org/webt/10/mb/ai/10mbain0xddl-fwxwkvtmebrl-i.png"></p><br><p>  Es war m√ºde, bei jedem Startversuch mit dem Gesicht nach unten zu fallen, und es wurde beschlossen, sich wieder hinzusetzen und nachzudenken.  Wir haben also einerseits eine gro√üe Anzahl von ps-Skripten und andererseits eine gro√üe Anzahl von virtuellen Skripten.  Aber wir haben uns geirrt, weil  das war nicht die Wurzel des Problems.  Das Problem war, dass sich zwischen diesen Dingen immer eine Person befand.  Es spielt keine Rolle, ob es sich um einen Entwickler, einen Tester oder eine andere Person handelt. Die folgende logische Kette ist immer im Kopf aufgetreten: </p><br><ul><li>  Ich brauche also eine virtuelle Maschine f√ºr Tests </li><li>  Ja, hier haben wir einen Host-Pool </li><li>  Und hier ist das Skript, das ich brauche. Jetzt werde ich es ausf√ºhren und alles wird passieren </li></ul><br><p>  Mit der Realisierung einer so scheinbar einfachen Sache begann das allgemeine Problem mit neuen Farben zu spielen.  Es stellte sich heraus, dass alle unsere Schmerzen auf das Fehlen einer einzigen Beschreibung unserer Infrastruktur zur√ºckzuf√ºhren sind.  Es war in den K√∂pfen der Menschen, die es geschaffen haben, sie sa√üen in verschiedenen Abteilungen, versuchten nicht, es irgendwie zu dokumentieren, und im Allgemeinen lebten alle in ihrem eigenen Zustand. <br>  In diesem Moment kamen wir zu dem Schluss, dass die Antwort auf alle unsere Probleme lautet: </p><br><p>  <strong>Infrastruktur als Code</strong> </p><br><p>  Genau hier sollte unsere gesamte Infrastruktur im Code beschrieben und im Repository abgelegt werden.  Alle virtuellen Maschinen, alle ihre Parameter, alles, was dort installiert ist - alles muss im Code beschrieben werden. </p><br><p>  Es stellt sich eine berechtigte Frage - warum? </p><br><p>  Wir antworten: Dieser Ansatz gibt uns die M√∂glichkeit, die Best Practices aus der Entwicklungswelt anzuwenden, an die wir alle so gew√∂hnt sind: </p><br><ul><li>  Versionskontrolle.  Wir k√∂nnen immer verstehen, was und wann sich ge√§ndert hat.  Keine Gastgeber mehr, die aus dem Nichts kommen oder nirgendwo hingehen.  Es wird immer klar sein, wer die √Ñnderungen vorgenommen hat. </li><li>  Code√ºberpr√ºfung.  Wir werden in der Lage sein, die Bereitstellungsprozesse so zu steuern, dass einige andere nicht verletzen. </li><li>  Kontinuierliche Integration. </li></ul><br><p>  <strong>Werkzeugauswahl</strong> </p><br><p>  Wie wir alle wissen, gibt es viele Konfigurationsmanagement-Tools.  Wir haben uns f√ºr Ansible entschieden, weil es eine Reihe von Funktionen enth√§lt, die wir ben√∂tigen. <br>  Zun√§chst m√∂chten wir, dass das Automatisierungssystem keine Installationsprogramme ausf√ºhrt, etwas, das irgendwo migriert werden kann usw.  Zun√§chst m√∂chten wir von einem solchen System, dass wir nach dem Dr√ºcken einer Taste die Benutzeroberfl√§che der ben√∂tigten Anwendung sehen. </p><br><p>  Daher ist das Hauptmerkmal f√ºr uns die Idempotenz.  Ansible spielt keine Rolle, was vorher passiert ist.  Nach dem Start des gew√ºnschten Spielbuchs erhalten wir immer das gleiche Ergebnis.  Dies ist sehr wichtig, wenn Sie nicht "IIS installieren" sagen, sondern "Es sollte IIS geben", und Sie m√ºssen nicht dar√ºber nachdenken, ob er zuvor dort war oder nicht.  Es ist sehr schwierig, dies mit Skripten zu erreichen, und Ansible-Playbooks bieten eine solche M√∂glichkeit. </p><br><p>  Erw√§hnenswert ist auch die Agentenlosigkeit von Ansible.  Die meisten Automatisierungssysteme arbeiten √ºber Agenten.  Dies hat viele Vorteile - zum Beispiel die beste Leistung -, aber es war uns wichtig, dass es keinen Agenten gab, damit das System nicht irgendwie zus√§tzlich vorbereitet werden musste. </p><br><p>  PowerShell: </p><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$url</span></span> = <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> <span class="hljs-variable"><span class="hljs-variable">$output</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSSscriptRoot</span></span></span><span class="hljs-string">\build.msi"</span></span> Invoke-WebRequest -Uri <span class="hljs-variable"><span class="hljs-variable">$url</span></span> -OutFile <span class="hljs-variable"><span class="hljs-variable">$output</span></span></code> </pre> <br><p>  Ansible: </p><br><pre> <code class="bash hljs">name: Download build hosts: all tasks: name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"build.msi"</span></span> force: no</code> </pre> <br><p>  Hier sehen wir, dass im Basisbeispiel das ps-Skript noch pr√§gnanter ist als das Ansible-Playbook.  3 Zeilen Skript versus 7 Zeilen Playbook, um eine Datei herunterzuladen. </p><br><p>  Aber, Petka, es gibt eine Nuance (n).  Sobald wir uns an das Prinzip der Idempotenz halten und beispielsweise sicherstellen m√∂chten, dass sich die Datei auf dem Server nicht ge√§ndert hat und nicht heruntergeladen werden muss, m√ºssen Sie eine HEAD-Anforderung im Skript implementieren, die etwa 200 Zeilen hinzuf√ºgt.  Und im Spielbuch - eins.  Das Ansible win_get_url-Modul, das alle √úberpr√ºfungen f√ºr Sie durchf√ºhrt, enth√§lt 257 Codezeilen, die Sie nicht in jedes Skript einf√ºgen m√ºssen. </p><br><p>  Und dies ist nur ein Beispiel f√ºr eine sehr einfache Aufgabe. </p><br><p><img src="https://habrastorage.org/webt/ca/tz/el/catzel2r3lxpzk_yaz0moo6s-c0.png"></p><br><p>  Und wenn Sie dar√ºber nachdenken, brauchen wir √ºberall Idempotenz: </p><br><ul><li>  √úberpr√ºfen Sie das Vorhandensein einer virtuellen Maschine.  Bei Skripten besteht die Gefahr, dass entweder unendlich viele davon erstellt werden, oder das Skript st√ºrzt ganz am Anfang ab. </li><li>  Welche MSI-Pakete befinden sich auf dem Computer?  Im besten Fall f√§llt hier nichts, im schlimmsten Fall funktioniert die Maschine nicht mehr richtig. </li><li>  Muss ich Build-Artefakte erneut herunterladen?  Es ist gut, wenn Ihre Builds ein Dutzend Megabyte wiegen.  Und was ist mit denen, die ein paar Gigabyte haben? </li></ul><br><p>  Und andere Beispiele, bei denen der Ausweg darin besteht, Skripte mit endloser Verzweigung von Ifs aufzublasen, die nicht angemessen debuggt und nicht verwaltet werden k√∂nnen. </p><br><p>  Ansible verwendet unter anderem keine Agenten, um Ihre Hosts und Computer zu verwalten.  Unter Linux l√§uft es nat√ºrlich unter ssh, w√§hrend unter Windows WinRM verwendet wird.  Daher die offensichtliche Konsequenz: Ansible ist plattform√ºbergreifend.  Es unterst√ºtzt eine fantastische Anzahl von Plattformen bis hin zu Netzwerkger√§ten. </p><br><p>  Und das letzte, aber nicht weniger wichtige ist das YAML-Konfigurationsaufzeichnungsformat.  Jeder ist daran gew√∂hnt, es ist leicht zu lesen und es ist leicht herauszufinden, was dort passiert. </p><br><p>  Aber nicht alles ist so s√º√ü, es gibt Probleme: </p><br><ul><li>  Das Problem ist zweifelhaft: Zum Ausf√ºhren von Playbooks ben√∂tigen Sie immer noch einen Linux-Computer, auch wenn Ihre gesamte Infrastruktur ausschlie√ülich aus Windows besteht.  Obwohl dies in der modernen Welt kein so gro√ües Problem ist, weil  Unter Windows 10 gibt es jetzt WSL, wo Sie Ubuntu ausf√ºhren k√∂nnen, unter dem Sie Playbooks fahren k√∂nnen. </li><li>  Manchmal sind Playbooks wirklich schwer zu debuggen.  Ansible ist in Python geschrieben, und das Letzte, was ich sehen m√∂chte, ist ein Python-Stack-Stack-Sheet mit f√ºnf Bildschirmen.  Und ein Tippfehler im Modulnamen </li></ul><br><p>  <strong>Wie funktioniert es</strong> <br>  Zuerst brauchen wir eine Linux-Maschine.  In der Ansible-Terminologie wird dies als Control Machine bezeichnet. <br>  Playbooks beginnen damit und die ganze Magie passiert darauf. </p><br><p>  Auf dieser Maschine ben√∂tigen wir: </p><br><ul><li>  Python und der Python-Paketmanager pip.  Viele Distributionen sind sofort einsatzbereit, daher gibt es hier keine √úberraschungen. </li><li>  Installieren Sie Ansible √ºber pip als universellste Methode: pip install ansible </li><li>  F√ºgen Sie ein winrm-Modul hinzu, um zu Windows-Computern zu gelangen: pip install pywinrm [credssp] </li><li>  Und auf den Maschinen, die wir steuern m√∂chten, m√ºssen wir winrm aktivieren, weil  es ist standardm√§√üig deaktiviert.  Es gibt viele M√∂glichkeiten, dies zu tun, und alle sind in der Ansible-Dokumentation beschrieben.  Am einfachsten ist es jedoch, das fertige Skript aus dem Ansible-Repository zu entnehmen und es mit der erforderlichen Autorisierungsoption auszuf√ºhren: ConfigureRemotingForAnsible.ps1 -EnableCredSSP </li></ul><br><p>  Der wichtigste Teil, den wir brauchten, um nicht mehr mit ps-Skripten zu leiden, war Inventar.  Eine YAML-Datei (in unserem Fall), die unsere Infrastruktur beschreibt und in der Sie immer nachsehen k√∂nnen, wo diese bereitgestellt wird.  Und nat√ºrlich die Spielb√ºcher selbst.  In Zukunft sieht die Arbeit so aus, als w√ºrde ein Playbook mit der erforderlichen Inventardatei und zus√§tzlichen Parametern gestartet. </p><br><pre> <code class="bash hljs">all: children: webservers: hosts: spbdotnet-test-host.dev.local: dbservers: hosts: spbdotnet-test-host.dev.local: vars: ansible_connection: winrm ansible_winrm_transport: credssp ansible_winrm_server_cert_validation: ignore ansible_user: administrator ansible_password: 123qweASD</code> </pre> <br><p>  Hier ist alles einfach: Die Stammgruppe besteht aus allen und zwei Untergruppen, Webserves und DBServer.  Alles andere ist intuitiv, aber ich m√∂chte Ihre Aufmerksamkeit auf die Tatsache lenken, dass Ansible standardm√§√üig glaubt, dass Linux √ºberall ist. F√ºr Windows m√ºssen Sie daher unbedingt winrm und die Art der Autorisierung angeben. </p><br><p>  Nat√ºrlich m√ºssen Sie das Passwort nicht in klarer Form im Playbook speichern, hier nur ein Beispiel.  Passw√∂rter k√∂nnen beispielsweise in Ansible-Vault gespeichert werden.  Wir verwenden hierf√ºr TeamCity, das Geheimnisse durch Umgebungsvariablen weitergibt und nichts ausl√∂st. </p><br><p>  <strong>Module</strong> </p><br><p>  Alles, was Ansible macht, macht es mit Hilfe von Modulen.  Module f√ºr Linux sind in Python geschrieben, f√ºr Windows in PowerShell.  Und Ehrfurcht vor der Idempotenz: Das Ergebnis des Moduls liegt immer in Form einer JSON-Datei vor, die angibt, ob auf dem Host √Ñnderungen vorgenommen wurden oder nicht. </p><br><p>  Im allgemeinen Fall f√ºhren wir ein Konstrukt des Formulars ansible host group inventory file list of modules aus: </p><br><p><img src="https://habrastorage.org/webt/dt/ww/s7/dtwws7ix1i1k1jqbtpp0cnowrus.png"></p><br><p>  <strong>Spielb√ºcher</strong> </p><br><p>  Ein Playbook beschreibt, wie und wo wir Ansible-Module ausf√ºhren. </p><br><pre> <code class="bash hljs">- name: Install AWS CLI hosts: all vars: aws_cli_download_dir: c:\downloads aws_cli_msi_url: https://s3.amazonaws.com/aws-cli/AWSCLI32PY3.msi tasks: - name: Ensure target directory exists win_file: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}"</span></span> state: directory - name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_msi_url }}"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> force: no - name: Install AWS CLI win_package: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> state: present</code> </pre> <br><p>  In diesem Beispiel haben wir drei Aufgaben.  Jede Aufgabe ist ein Modulaufruf.  In diesem Playbook erstellen wir zuerst ein Verzeichnis (stellen Sie sicher, dass es vorhanden ist), laden dann die AWS-CLI dort herunter und installieren sie mit dem win_packge-Modul. </p><br><p>  Wenn Sie dieses Playbook ausf√ºhren, erhalten Sie dieses Ergebnis. </p><br><p><img src="https://habrastorage.org/webt/ga/2x/sd/ga2xsdh7zgvlxvioliy_g3ijkxo.png"></p><br><p>  Der Bericht zeigt, dass vier Aufgaben erfolgreich abgeschlossen wurden und drei der vier einige √Ñnderungen am Host vorgenommen haben. </p><br><p>  Aber was passiert, wenn Sie dieses Playbook erneut ausf√ºhren?  Wir haben nirgendwo geschrieben, dass wir das Verzeichnis erstellen, die Installationsdatei herunterladen und ausf√ºhren sollen.  Wir pr√ºfen einfach die Verf√ºgbarkeit jedes Artikels und √ºberspringen, falls verf√ºgbar. </p><br><p><img src="https://habrastorage.org/webt/8m/ro/de/8mrodes1ld9oocapp3qhnypwkcw.png"></p><br><p>  Dies ist die Idempotenz, die wir mit PowerShell nicht erreichen konnten. </p><br><p>  <strong>√úbe</strong> </p><br><p>  Dies ist ein leicht vereinfachtes Beispiel, aber im Prinzip ist es genau das, was wir jeden Tag tun. <br>  Wir werden eine Anwendung bereitstellen, die aus einem Windows-Dienst und einer Webanwendung unter IIS besteht. </p><br><pre> <code class="bash hljs">- name: Setup App hosts: webservers tasks: - name: Install IIS win_feature: name: - Web-Server - Web-Common-Http include_sub_features: True include_management_tools: True state: present register: win_feature - name: reboot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installing Web-Server feature requires it win_reboot: when: win_feature.reboot_required</code> </pre> <br><p>  Zuerst m√ºssen wir pr√ºfen, ob sich auf dem Host IIS befindet, und es installieren, wenn nicht.  Und es w√§re sch√∂n, sofort Management-Tools und alle abh√§ngigen Funktionen hinzuzuf√ºgen.  Und es ist sehr gut, wenn der Host bei Bedarf neu gestartet wird. </p><br><p>  Die erste Aufgabe, die wir l√∂sen, ist das win_feature-Modul, das sich mit der Verwaltung von Windows-Funktionen befasst.  Und hier haben wir zum ersten Mal die Umgebungsvariablen Ansible im Registerelement.  Denken Sie daran, ich sagte, dass Aufgaben immer ein JSON-Objekt zur√ºckgeben?  Nach Abschluss der Aufgabe "IIS installieren" liegt die Ausgabe des Moduls "win_feature" in der Variablen "win_feature" (entschuldigen Sie die Tautologie). </p><br><p>  In der n√§chsten Aufgabe rufen wir das Modul win_reboot auf.  Wir m√ºssen unseren Server jedoch nicht jedes Mal neu starten.  Wir werden es nur neu laden, wenn das win_feature-Modul diese Anforderung in Form einer Variablen an uns zur√ºckgibt. </p><br><p>  Der n√§chste Schritt ist die Installation von SQL.  Hierf√ºr wurden bereits eine Million Wege erfunden.  Ich verwende hier das win_chocolatey-Modul.  Dies ist ein Paketmanager f√ºr Windows.  Ja, genau das sind wir unter Linux gewohnt.  Die Module werden von der Community unterst√ºtzt und es gibt bereits mehr als sechstausend davon.  Ich rate Ihnen dringend, es zu versuchen. </p><br><pre> <code class="bash hljs">- name: SQL Server hosts: dbservers tasks: - name: Install MS SQL Server 2014 win_chocolatey: name: mssqlserver2014express state: present</code> </pre> <br><p>  Also haben wir den Host f√ºr den Start der Anwendung vorbereitet. Lassen Sie uns sie bereitstellen! </p><br><pre> <code class="plaintext hljs">- name: Deploy binaries hosts: webservers vars: myapp_artifacts: files/MyAppService.zip myapp_workdir: C:\myapp tasks: - name: Remove Service if exists win_service: name: MyAppService state: absent path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  Nur f√ºr den Fall, das erste, was wir tun, ist den vorhandenen Dienst zu l√∂schen. </p><br><pre> <code class="plaintext hljs">- name: Delete old files win_file: path: "{{ myapp_workdir }}\\" state: absent - name: Copy artifacts to remote machine win_copy: src: "{{ myapp_artifacts }}" dest: "{{ myapp_workdir }}\\" - name: Unzip build artifacts win_unzip: src: "{{ myapp_workdir }}\\MyAppService.zip" dest: "{{ myapp_workdir }}"</code> </pre> <br><p>  Der n√§chste Schritt ist das Hochladen neuer Artefakte auf den Host.  Dieses Playbook impliziert, dass es auf einem Build-Server ausgef√ºhrt wird, alle Archive sich in einem bekannten Ordner befinden und wir den Pfad zu ihnen mit Variablen angeben.  Nach dem Kopieren (win_copy) werden die Archive entpackt (win_unzip).  Dann registrieren wir einfach den Dienst, sagen den Pfad zu exe und dass er gestartet werden soll. </p><br><pre> <code class="plaintext hljs"> - name: Register and start the service win_service: name: ReporterService start_mode: auto state: started path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  <strong>Fertig !?</strong> </p><br><p>  Es scheint, dass unser Dienst f√ºr Arbeit und Verteidigung bereit ist, aber es gibt ein ‚Äûaber‚Äú - wir haben das Prinzip der Idempotenz nicht beachtet.  Wir l√∂schen immer den vorhandenen Code und stellen dann den neuen bereit. </p><br><p>  Und das ist das Problem.  Wenn wir den alten au√üer Betrieb befindlichen Dienst gel√∂scht haben und nachdem ein Fehler aufgetreten ist und das Playbook seine Arbeit nicht abgeschlossen hat, erhalten wir einen defekten Host.  Oder wir stellen beispielsweise mehrere Anwendungen gleichzeitig bereit, von denen sich eine nicht ge√§ndert hat. Dann m√ºssen wir sie auch nicht bereitstellen. </p><br><p>  Was kann getan werden?  Alternativ k√∂nnen Sie die Pr√ºfsumme unserer Artefakte √ºberpr√ºfen und mit denen auf dem Server vergleichen. </p><br><pre> <code class="plaintext hljs"> - name: Get arifacts checksum stat: path: "{{ myapp_artifacts }}" delegate_to: localhost register: myapp_artifacts_stat - name: Get remote artifacts checksum win_stat: path: "{{ myapp_workdir }}\\MyAppService.zip" register: myapp_remote_artifacts_stat</code> </pre> <br><p>  Wir verwenden das stat-Modul, das alle Arten von Informationen zu Dateien bereitstellt, einschlie√ülich der Pr√ºfsumme.  Als n√§chstes schreiben wir das Ergebnis unter Verwendung des bekannten Direktivenregisters in eine Variable.  Von interessant: delegate_to gibt an, dass dies auf dem lokalen Computer erfolgen muss, auf dem das Playbook gestartet wird. </p><br><pre> <code class="plaintext hljs"> - name: Stop play if checksums match meta: end_play when: - myapp_artifacts_stat.stat.checksum is defined - myapp_remote_artifacts_stat.stat.checksum is defined - myapp_artifacts_stat.stat.checksum == myapp_remote_artifacts_stat.stat.checksum</code> </pre> <br><p>  Und mit Hilfe des Metamoduls sagen wir, dass wir das Playbook beenden m√ºssen, wenn die Pr√ºfsummen der Artefakte auf den lokalen und Remote-Computern √ºbereinstimmen.  So haben wir das Prinzip der Idempotenz beobachtet. </p><br><pre> <code class="plaintext hljs"> - name: Ensure that the WebApp application exists win_iis_webapplication: name: WebApp physical_path: c:\webapp site: Default Web Site state: present</code> </pre> <br><p>  Schauen wir uns nun unsere Webanwendung an.  Wir lassen den Teil √ºber das Kopieren von Dateien weg und gehen direkt zum Punkt.  Unser Build-Server hat den Herausgeber erstellt, alle losen Dateien auf den Host hochgeladen und das integrierte Modul f√ºr die Arbeit mit IIS-Anwendungen verwendet.  Er wird die Anwendung erstellen und ausf√ºhren. </p><br><p>  <strong>Wiederverwendung von Code</strong> </p><br><p>  Eine der Aufgaben, die wir uns gestellt haben, war: jedem Ingenieur im Unternehmen zu erm√∂glichen, eine Bereitstellung einfach zu starten.  Er schreibt sein Spielbuch aus vorgefertigten Modulen und sagt, dass er so und so ein Produkt auf so und so einem Host ausf√ºhren muss. </p><br><p>  Daf√ºr hat Ansible Rollen.  Dies ist im Wesentlichen eine Konvention.  Wir erstellen einen Ordner / Rollen / auf dem Server und legen unsere Rollen darin ab.  Jede Rolle besteht aus einer Reihe von Konfigurationsdateien: einer Beschreibung unserer Ger√§te, Variablen, Servicedateien usw.  Normalerweise spielt eine isolierte Einheit eine Rolle.  Die Installation von IIS ist ein gutes Beispiel, wenn wir es nicht nur installieren, sondern auch irgendwie konfigurieren oder mit zus√§tzlichen Aufgaben √ºberpr√ºfen m√ºssen.  Wir erstellen eine separate Rolle und isolieren daher alle IIS-bezogenen Playbooks im Rollenordner.  In Zukunft rufen wir diese Rolle einfach mit der Anweisung include_role% role_name% auf. </p><br><p>  Nat√ºrlich haben wir Rollen f√ºr alle Anwendungen festgelegt, sodass die Ingenieure den Prozess mithilfe von Konfigurationsparametern irgendwie anpassen k√∂nnen. </p><br><pre> <code class="plaintext hljs">- name: Run App hosts: webservers tasks: - name: "Install IIS" include_role: name: IIS - name: Run My App include_role: name: MyAppService vars: myapp_artifacts: ./buld.zip</code> </pre> <br><p>  In diesem Beispiel kann die Rolle "Meine App ausf√ºhren" einen Pfad zu Artefakten √ºbertragen. </p><br><p>  Hier m√ºssen Sie ein Wort zu Ansible Galaxy einbringen - einem Repository allgemein verf√ºgbarer Standardl√∂sungen.  Wie in einer anst√§ndigen Gesellschaft √ºblich, wurden viele Probleme bereits vor uns gel√∂st.  Und wenn Sie das Gef√ºhl haben, dass wir das Rad jetzt neu erfinden werden, m√ºssen Sie sich zuerst die Liste der integrierten Module ansehen und sich dann mit Ansible Galaxy befassen.  Es ist wahrscheinlich, dass das von Ihnen ben√∂tigte Spielbuch bereits von einer anderen Person erstellt wurde.  Es gibt dort eine gro√üe Anzahl von Modulen f√ºr alle Gelegenheiten. </p><br><p>  <strong>Mehr Flexibilit√§t</strong> </p><br><p>  Aber was ist, wenn es in Galaxy kein eingebautes Modul oder eine geeignete Rolle gibt?  Es gibt zwei M√∂glichkeiten: Entweder machen wir etwas falsch oder wir haben wirklich eine einzigartige Aufgabe. </p><br><p>  Bei der zweiten Option k√∂nnen wir unser Modul immer schreiben.  Wie ich Ihnen am Anfang gezeigt habe, erm√∂glicht Ansible das Schreiben des einfachsten Moduls in buchst√§blich 10 Minuten. Wenn Sie tiefer gehen, hilft Ihnen eine recht detaillierte Dokumentation, die viele Fragen abdeckt. </p><br><p>  <strong>Ci</strong> <br>  In unserer Abteilung lieben wir TeamCity wirklich, aber es kann jeden anderen CI-Server Ihrer Wahl geben.  Warum m√ºssen wir sie teilen? </p><br><p>  Erstens k√∂nnen wir immer die Syntax unserer Playbooks √ºberpr√ºfen.  W√§hrend YAML Tabs als Syntaxfehler betrachtet, ist dies eine sehr n√ºtzliche Funktion. </p><br><p>  Auch auf dem CI-Server f√ºhren wir ansible-lint aus.  Dies ist ein statischer Analysator f√ºr ansible-Konfigurationen, der eine Liste von Empfehlungen enth√§lt. </p><br><p><img src="https://habrastorage.org/webt/mc/rf/ks/mcrfks9tz2igullrdgqeedqkyim.png"></p><br><p>  Zum Beispiel sagt er hier, dass wir am Ende der Zeile ein zus√§tzliches Leerzeichen haben und f√ºr eine Aufgabe kein Name angegeben wird.  Das ist wichtig, weil  Der Modulname kann mehrmals im selben Playbook vorkommen, und alle Aufgaben m√ºssen benannt werden. </p><br><p>  Nat√ºrlich k√∂nnen Sie immer noch Tests f√ºr Spielb√ºcher schreiben.  Wir k√∂nnen es uns leisten, dies nicht zu tun, weil  Wir werden in der Testumgebung bereitstellen und nichts Kritisches wird passieren.  Wenn Sie jedoch auf dem Produkt bereitstellen, ist es besser, alles zu √ºberpr√ºfen.  Mit dem Vorteil von ansible k√∂nnen Sie nicht nur Playbooks, sondern auch einzelne Module testen.  Achten Sie also unbedingt darauf. </p><br><p>  Der zweite Hauptgrund f√ºr die Verwendung des CI-Servers ist das Starten von Playbooks.  Dies ist der gleiche magische Knopf "Gut machen", der uns TeamCity gibt.  Wir erstellen nur einige einfache Konfigurationen f√ºr verschiedene Produkte, in denen wir sagen: ansible-playbook reporter_vm.yml -i inventar.yml -vvvv und rufen die Schaltfl√§che Bereitstellen auf. </p><br><p>  Bonuskomfort: Sie k√∂nnen Builds je nach Build erstellen.  Sobald sich etwas konsolidiert hat, startet TeamCity den Prozess der erneuten Bereitstellung. Danach k√∂nnen wir die Protokolle nur dann anzeigen, wenn pl√∂tzlich etwas kaputt geht. </p><br><p>  <strong>Insgesamt</strong> </p><br><ul><li>  Verwirrte und unterschiedliche PowerShell-Skripte, die wir durch YAML-Konfigurationen ersetzt haben. </li><li>  Wir haben verschiedene Implementierungen derselben Probleme durch gemeinsame Rollen ersetzt, die wiederverwendet werden k√∂nnen.  Es wurde ein Repository erstellt, in dem die Rollen liegen.  Wenn die Rolle zu Ihnen passt, verwenden Sie sie einfach.  Wenn es nicht zu Ihnen passt, senden Sie einfach die Poolanfrage und es passt zu Ihnen =) </li><li>  Sie k√∂nnen jetzt den Erfolg der Bereitstellung an einem einzigen Ort √ºberpr√ºfen. </li><li>  Jeder wei√ü, wo er nach Protokollen suchen muss. </li><li>  Kommunikationsprobleme wurden auch √ºber ein gemeinsames Repository und TeamCity gel√∂st.  Alle Interessierten wissen, wo sich Spielb√ºcher befinden und wie sie funktionieren. </li></ul><br><p>  PS Alle Beispiele aus dem Artikel k√∂nnen auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github genommen werden</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455604/">https://habr.com/ru/post/de455604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455594/index.html">Microsoft Edge von CVE zu RCE unter Windows 10</a></li>
<li><a href="../de455596/index.html">DevConfX :: Management - Berichte von Managern in einfachen Worten</a></li>
<li><a href="../de455598/index.html">Aktualisieren Sie Exim dringend auf 4.92 - es liegt eine aktive Infektion vor</a></li>
<li><a href="../de455600/index.html">Die 3DEXPERIENCE-Plattform hilft bei der Schaffung √∂ffentlicher Verkehrsmittel der Zukunft</a></li>
<li><a href="../de455602/index.html">Das Provozieren von Browsern st√ºrzt mit Verhaltensfuzzing ab</a></li>
<li><a href="../de455606/index.html">Maschinelles Lernen und Datenanalyse: Masterstudiengang an der Higher School of Economics in St. Petersburg</a></li>
<li><a href="../de455608/index.html">Bitmap-Indizes in Go: Unglaubliche Suchgeschwindigkeit</a></li>
<li><a href="../de455610/index.html">Legend√§rer Intel Core i7-2600K: Testen von Sandy Bridge im Jahr 2019 (Teil 1)</a></li>
<li><a href="../de455612/index.html">Wir denken √ºber die Charaktere von Spielen und Dialogen nach dem Rat von Schriftstellern und am Beispiel von Unterst√ºtzern der Theorie einer flachen Erde nach</a></li>
<li><a href="../de455614/index.html">FFI: Schreiben in Rust in einem PHP-Programm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>