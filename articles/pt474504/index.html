<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèø ü•ä üëÇ Backend ortodoxo ü§ï üè≠ ü§≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O backend moderno √© diverso, mas ainda obedece a algumas regras n√£o ditas. Muitos de n√≥s que desenvolvemos aplicativos de servidor enfrentamos abordag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Backend ortodoxo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474504/"><img src="https://habrastorage.org/webt/dj/q5/y-/djq5y-xjov_bqvrrnb08bfyqn4i.jpeg"><br><br>  O backend moderno √© diverso, mas ainda obedece a algumas regras n√£o ditas.  Muitos de n√≥s que desenvolvemos aplicativos de servidor enfrentamos abordagens geralmente aceitas, como Arquitetura Limpa, SOLID, Ignor√¢ncia de Persist√™ncia, Inje√ß√£o de Depend√™ncia e outros.  Muitos dos atributos do desenvolvimento de servidores s√£o t√£o comuns que n√£o levantam d√∫vidas e s√£o usados ‚Äã‚Äãsem pensar.  Eles falam muito sobre alguns, mas nunca o usam.  O significado do resto √© incorretamente interpretado ou distorcido.  O artigo fala sobre como construir uma arquitetura de back-end simples e completamente t√≠pica, que n√£o s√≥ pode seguir os preceitos de famosos te√≥ricos da programa√ß√£o sem nenhum dano, mas tamb√©m pode melhor√°-los at√© certo ponto. <br><a name="habracut"></a><br>  <i>Dedicado a todos aqueles que n√£o pensam em programa√ß√£o sem beleza e n√£o aceitam a beleza em meio ao absurdo.</i> <br><br><h2>  Modelo de dom√≠nio </h2><br>  A modelagem √© onde o desenvolvimento de software em um mundo ideal deve come√ßar.  Mas nem todos somos perfeitos, falamos muito sobre isso, mas fazemos tudo como sempre.  Muitas vezes, o motivo √© a imperfei√ß√£o das ferramentas existentes.  E para ser sincero, nossa pregui√ßa e medo de assumir a responsabilidade de fugir das "melhores pr√°ticas".  Em um mundo imperfeito, o desenvolvimento de software come√ßa, na melhor das hip√≥teses, com andaimes e, na pior, com otimiza√ß√£o de desempenho, nada.  No entanto, eu gostaria de descartar os exemplos dif√≠ceis de arquitetos "destacados" e especular sobre coisas mais comuns. <br><br>  Portanto, temos uma tarefa t√©cnica e at√© um design de interface do usu√°rio (ou n√£o, se a interface do usu√°rio n√£o for fornecida).  A pr√≥xima etapa √© refletir os requisitos no modelo de dom√≠nio.  Para come√ßar, voc√™ pode esbo√ßar um diagrama de objetos de modelo para maior clareza: <br><br><img src="https://habrastorage.org/webt/4n/hp/m5/4nhpm5kbhwvomryj9xhyww1eep0.png"><br><br>  Ent√£o, como regra, come√ßamos a projetar o modelo nos meios de sua implementa√ß√£o - uma linguagem de programa√ß√£o, um conversor objeto-relacional (ORM), ou em algum tipo de estrutura complexa como ASP.NET MVC ou Ruby on Rails, em outras palavras - comece a escrever o c√≥digo.  Nesse caso, seguimos o caminho da estrutura, que eu acho que n√£o est√° correta na estrutura de desenvolvimento baseada no modelo, por mais conveniente que possa parecer inicialmente.  Aqui voc√™ faz uma suposi√ß√£o enorme, que posteriormente nega os benef√≠cios do desenvolvimento baseado em dom√≠nio.  Como uma op√ß√£o mais livre, n√£o limitada pelo escopo de qualquer ferramenta, eu sugeriria o uso de apenas ferramentas sint√°ticas de uma linguagem de programa√ß√£o para construir um modelo de objeto de um dom√≠nio.  No meu trabalho, uso v√°rias linguagens de programa√ß√£o - C #, JavaScript, Ruby.  O destino decretou que os ecossistemas Java e C # s√£o minha inspira√ß√£o, JS √© minha principal receita e Ruby √© a linguagem que eu gosto.  Portanto, continuarei mostrando exemplos simples em Ruby: Estou convencido de que isso n√£o far√° com que os desenvolvedores de outros idiomas entendam problemas.  Portanto, mova o modelo para a classe Invoice no Ruby: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  I.e.  temos uma classe cujo construtor aceita um hash de atributos, depend√™ncias de objetos e inicializa seus campos e um m√©todo de pagamento que pode alterar o estado do objeto.  Tudo √© muito simples.  Agora, n√£o pensamos em como e onde exibiremos e armazenaremos esse objeto.  Apenas existe, podemos cri√°-lo, mudar seu estado, interagir com outros objetos.  Observe que o c√≥digo n√£o cont√©m artefatos estrangeiros como BaseEntity e outro lixo que n√£o esteja relacionado ao modelo.  Isso √© muito importante.  A prop√≥sito, nesta fase, j√° podemos come√ßar o desenvolvimento por meio de testes (TDD), usando objetos stub em vez de depend√™ncias como payment_service: <br><br><pre> <code class="ruby hljs">RSpec.describe Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> before <span class="hljs-symbol"><span class="hljs-symbol">:each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @payment_service = double(<span class="hljs-symbol"><span class="hljs-symbol">:payment_service</span></span>) allow(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>) @amount = <span class="hljs-number"><span class="hljs-number">100</span></span> @credit_card = CreditCard.new({...}) @customer = Customer.new({<span class="hljs-symbol"><span class="hljs-symbol">credit_card:</span></span> @credit_card, ...}) @subscription = Subscription.new({<span class="hljs-symbol"><span class="hljs-symbol">customer:</span></span> customer, ...}) @invoice = Invoice.new({<span class="hljs-symbol"><span class="hljs-symbol">amount:</span></span> @amount, <span class="hljs-symbol"><span class="hljs-symbol">date:</span></span> DateTime.now, @subscription: subscription}, payment_service) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe <span class="hljs-string"><span class="hljs-string">'pay'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"charges customer's credit card"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>).with(@credit_card, @amount) @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> it <span class="hljs-string"><span class="hljs-string">'makes the invoice paid'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@invoice.paid_at).not_to be_nil @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  ou at√© mesmo brincar com o modelo no int√©rprete (irb para Ruby), que pode muito bem ser, embora n√£o seja muito amig√°vel, a interface do usu√°rio: <br><br><pre> <code class="bash hljs">irb &gt; invoice = Invoice.new({amount: @amount, date: DateTime.now, @subscription: subscription}, payment_service) irb &gt; invoice.pay</code> </pre><br>  Por que √© t√£o importante evitar "artefatos estrangeiros" nesse est√°gio?  O fato √© que o modelo n√£o deve ter nenhuma id√©ia de como ser√° salvo ou se ser√° salvo.  No final, para alguns sistemas, o armazenamento de objetos diretamente na mem√≥ria pode ser bastante adequado.  No momento da modelagem, devemos abstrair completamente desse detalhe.  Essa abordagem √© chamada de ignor√¢ncia de persist√™ncia.  Deve-se enfatizar que n√£o ignoramos os problemas de trabalhar com o reposit√≥rio, seja um banco de dados relacional ou qualquer outro banco de dados, apenas negligenciamos os detalhes de interagir com ele no est√°gio de modelagem.  Ignor√¢ncia de persist√™ncia significa a elimina√ß√£o intencional de mecanismos para trabalhar com o estado do modelo, bem como todos os tipos de metadados relacionados a esse processo, a partir do pr√≥prio modelo.  Exemplos: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User &lt; Entity #     table :users #     # mapping  field :name, type: 'String' #   def save ... end end user = User.load(id) #     user.save #    </span></span></code> </pre><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User #   ,      attr_accessor :name, :lastname end user = repo.load(id) #     repo.save(user) #    </span></span></code> </pre><br>  Essa abordagem tamb√©m se deve a raz√µes fundamentais - conformidade com o princ√≠pio de responsabilidade exclusiva (princ√≠pio de responsabilidade √∫nica, S no SOLID).  Se o modelo, al√©m de seu componente funcional, descreve os par√¢metros de preserva√ß√£o do estado e tamb√©m lida com a preserva√ß√£o e o carregamento, ent√£o obviamente ele tem muitas responsabilidades.  A vantagem resultante e n√£o a √∫ltima da Ignor√¢ncia de persist√™ncia √© a capacidade de substituir a ferramenta de armazenamento e at√© o tipo de armazenamento em si durante o processo de desenvolvimento. <br><br><h2>  Model-View-Controller </h2><br>  O conceito MVC √© t√£o popular no ambiente de desenvolvimento de v√°rios aplicativos, n√£o apenas de servidores, em diferentes idiomas e plataformas que n√£o pensamos mais no que √© e por que √© necess√°rio.  Eu tenho o maior n√∫mero de perguntas desta abrevia√ß√£o que se chama ‚ÄúController‚Äù.  Do ponto de vista da organiza√ß√£o da estrutura do c√≥digo, √© bom agrupar a√ß√µes no modelo.  Mas o controlador n√£o deve ser uma classe, deve ser um m√≥dulo que inclui m√©todos para acessar o modelo.  N√£o √© s√≥ isso, deveria haver um lugar para estar?  Como desenvolvedor que seguiu o caminho do .NET -&gt; Ruby -&gt; Node.js, fiquei impressionado com os controladores JS (ES5) que implementam na estrutura do express.js.  Tendo a capacidade de resolver a tarefa atribu√≠da aos controladores em um estilo mais funcional, os desenvolvedores, como enfeiti√ßados, escrevem o ‚ÄúControlador‚Äù m√°gico repetidas vezes.  Por que um controlador t√≠pico √© ruim? <br><br>  Um controlador t√≠pico √© um conjunto de m√©todos que n√£o est√£o intimamente relacionados entre si, unidos por apenas um - uma certa ess√™ncia do modelo;  e √†s vezes n√£o apenas um, pior.  Cada m√©todo individual pode exigir depend√™ncias diferentes.  Observando um pouco √† frente, observo que sou um defensor da pr√°tica da invers√£o de depend√™ncia (Invers√£o de Depend√™ncia, D no SOLID).  Portanto, preciso inicializar essas depend√™ncias em algum lugar externo e pass√°-las ao construtor do controlador.  Por exemplo, ao criar uma nova conta, tenho que enviar notifica√ß√µes ao contador, para o qual preciso de um servi√ßo de notifica√ß√£o e, em outros m√©todos, n√£o: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_by_id</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Aqui, a id√©ia implora para ser dividida em m√©todos para trabalhar com o modelo em classes separadas, e por que n√£o? <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListInvoices</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateInvoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Bem, em vez do controlador, agora existe um conjunto de "fun√ß√µes" para acessar o modelo, que, a prop√≥sito, tamb√©m podem ser estruturadas usando diret√≥rios do sistema de arquivos, por exemplo.  Agora voc√™ precisa "abrir" esses m√©todos para o exterior, ou seja,  organizar algo como um roteador.  Como uma pessoa tentada com qualquer tipo de DSL (Linguagem Espec√≠fica de Dom√≠nio), eu preferiria ter uma descri√ß√£o mais visual das instru√ß√µes para o aplicativo Web do que truques em Ruby ou outra linguagem de uso geral para definir rotas: <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; return all invoices` `HTTP POST /invoices -&gt; create new invoice`</code> </pre><br>  ou pelo menos <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; ./invoices/list_invoices` `HTTP POST /invoices -&gt; ./invoices/create`</code> </pre><br>  Isso √© muito semelhante a um roteador t√≠pico, com a √∫nica diferen√ßa: ele interage n√£o com os controladores, mas diretamente com as a√ß√µes no modelo.  √â claro que, se queremos enviar e receber JSON, devemos cuidar da serializa√ß√£o e desserializa√ß√£o de objetos e muito mais.  De uma maneira ou de outra, podemos nos livrar dos controladores, mudar parte de sua responsabilidade para a estrutura de diret√≥rios e o roteador mais avan√ßado. <br><br><h2>  Inje√ß√£o de depend√™ncia </h2><br>  Eu escrevi deliberadamente um "roteador mais avan√ßado".  Para que o roteador possa realmente permitir o fluxo de a√ß√µes no modelo usando o mecanismo de inje√ß√£o de depend√™ncia no n√≠vel declarativo, provavelmente deve ser bastante complexo por dentro.  O esquema geral de seu trabalho deve ser algo como isto: <br><br><img src="https://habrastorage.org/webt/62/v1/ts/62v1tsjynvq067lnqxmpqefw0lg.png"><br><br>  Como voc√™ pode ver, meu roteador inteiro est√° cheio de inje√ß√£o de depend√™ncia usando um cont√™iner de IoC.  Por que isso √© necess√°rio?  O conceito de "inje√ß√£o de depend√™ncia" remonta √† t√©cnica de Invers√£o de Depend√™ncia, projetada para reduzir a conectividade de objetos, movendo a inicializa√ß√£o de depend√™ncia para fora do escopo de seu uso.  Um exemplo: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#  (   ) class A def initialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = Repository.new end end #  (   ) class A def initialize(repo) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = repo end end</span></span></code> </pre><br>  Essa abordagem ajuda muito aqueles que usam o Desenvolvimento Orientado a Testes.  No exemplo acima, podemos facilmente colocar um esbo√ßo no construtor, em vez do objeto de reposit√≥rio real correspondente √† sua interface, sem "invadir" o modelo de objeto.  Este n√£o √© o √∫nico b√¥nus de DI: quando aplicado corretamente, essa abordagem trar√° muita magia agrad√°vel √† sua aplica√ß√£o, mas primeiro as primeiras coisas.  Inje√ß√£o de Depend√™ncia √© uma abordagem que permite integrar a t√©cnica de Invers√£o de Depend√™ncia em uma solu√ß√£o arquitet√¥nica completa.  A ferramenta de implementa√ß√£o √© geralmente um cont√™iner IoC- (Inversion of Control).  Existem toneladas de cont√™ineres IoC realmente legais no mundo Java e .NET, existem dezenas deles.  Em JS e Ruby, infelizmente, n√£o h√° op√ß√µes adequadas para mim.  Em particular, observei o cont√™iner <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">seco</a> (cont√™iner <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">seco</a> ).  Seria assim que minha classe usaria: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Import</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Em vez do uso esbelto do construtor, sobrecarregamos a classe introduzindo nossas pr√≥prias depend√™ncias, que no est√°gio inicial nos afastam de um modelo limpo e independente.  Bem, alguma coisa, e o modelo n√£o deve saber nada sobre IoC!  Isso √© verdade para a√ß√µes como CreateInvoice.  Para o caso em quest√£o, nos meus testes j√° sou obrigado a usar a IoC como algo inalien√°vel.  Isso est√° totalmente errado.  Os objetos de aplicativo, na maior parte, n√£o devem saber sobre a exist√™ncia de IoC.  Depois de pesquisar e pensar muito, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">esbocei minha IoC</a> , o que n√£o seria t√£o intrusivo. <br><br><h2>  Salvando e carregando um modelo </h2><br>  Persist√™ncia A ignor√¢ncia requer um transformador de objeto discreto.  Neste artigo, quero dizer trabalhando com um banco de dados relacional, os principais pontos ser√£o verdadeiros para outros tipos de armazenamento.  Um conversor objeto-relacional - ORM (Object Relational Mapper) √© usado como um conversor semelhante para bancos de dados relacionais.  No mundo do .NET e Java, h√° uma abund√¢ncia de ferramentas ORM verdadeiramente poderosas.  Todos eles t√™m algumas ou outras pequenas falhas nas quais voc√™ pode fechar os olhos.  N√£o h√° boas solu√ß√µes em JS e Ruby.  Todos eles, de uma maneira ou de outra, vinculam rigidamente o modelo √† estrutura e for√ßam a declara√ß√£o de elementos estranhos, sem mencionar a inaplicabilidade da Ignor√¢ncia de Persist√™ncia.  Como no caso da IoC, pensei em implementar o ORM por conta pr√≥pria, esse √© o estado das coisas no Ruby.  N√£o fiz tudo do zero, mas tomei como base uma simples ORM Sequel, que fornece ferramentas discretas para trabalhar com diferentes DBMSs relacionais.  Antes de tudo, eu estava interessado na capacidade de executar consultas na forma de SQL regular, recebendo uma matriz de strings (objetos hash) na sa√≠da.  Restou apenas implementar seu Mapper e fornecer Ignor√¢ncia de Persist√™ncia.  Como j√° mencionei, eu n√£o gostaria de misturar campos de mapeamento no modelo de dom√≠nio, ent√£o implementei o Mapper para que ele use um arquivo de configura√ß√£o separado no formato de tipo: <br><br><pre> <code class="ruby hljs">entity Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:start_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:end_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:updated_at</span></span> reference <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> User reference <span class="hljs-symbol"><span class="hljs-symbol">:subscription</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> Subscription <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  A ignor√¢ncia de persist√™ncia √© bastante simples de implementar usando um objeto externo do tipo Reposit√≥rio: <br><br><pre> <code class="ruby hljs">repository.save(user)</code> </pre> <br>  Mas iremos al√©m e implementaremos o padr√£o da Unidade de Trabalho.  Para fazer isso, voc√™ precisa destacar o conceito de uma sess√£o.  Uma sess√£o √© um objeto que existe ao longo do tempo, durante o qual um conjunto de a√ß√µes √© executado no modelo, que √© uma √∫nica opera√ß√£o l√≥gica.  Ao longo de uma sess√£o, pode ocorrer o carregamento e a altera√ß√£o de objetos de modelo.  No final da sess√£o, ocorre a conserva√ß√£o transacional do estado do modelo. <br>  Exemplo de unidade de trabalho: <br><br><pre> <code class="ruby hljs">user = session.load(User, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) plan = session.load(Plan, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) subscription = Subscription.new(user, plan) session.attach(subscription) invoice = Invoice.new(subscription) session.attach(invoice) <span class="hljs-comment"><span class="hljs-comment"># ... # -       if Date.today.yday == 1 subscription.comment = 'New year offer' invoice.amount /= 2 end session.flush</span></span></code> </pre><br>  Como resultado, 2 instru√ß√µes ser√£o executadas no banco de dados em vez de 4 e ambas ser√£o executadas na mesma transa√ß√£o. <br><br>  E, de repente, lembre-se dos reposit√≥rios!  Aqui h√° uma sensa√ß√£o de d√©j√† vu, como acontece com os controladores: o reposit√≥rio n√£o √© a mesma entidade rudimentar?  Olhando para o futuro, vou responder - sim, √©.  O principal objetivo do reposit√≥rio √© evitar que a camada da l√≥gica de neg√≥cios interaja com o armazenamento real.  Por exemplo, no contexto de bancos de dados relacionais, significa escrever consultas SQL diretamente no c√≥digo da l√≥gica de neg√≥cios.  Sem d√∫vida, esta √© uma decis√£o muito razo√°vel.  Mas voltando ao momento em que nos livramos do controlador.  Do ponto de vista do OOP, o reposit√≥rio √© essencialmente o mesmo controlador - o mesmo conjunto de m√©todos, n√£o apenas para processar solicita√ß√µes, mas para trabalhar com o reposit√≥rio.  O reposit√≥rio tamb√©m pode ser dividido em a√ß√µes.  Por todas as indica√ß√µes, essas a√ß√µes n√£o diferem de forma alguma daquilo que propusemos em vez do controlador.  Ou seja, podemos recusar o Reposit√≥rio e o Controlador em favor de uma √∫nica A√ß√£o unificada! <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Voc√™ provavelmente notou que eu uso SQL em vez de algum tipo de sintaxe de objeto.  Isso √© uma quest√£o de gosto.  Eu prefiro o SQL porque √© uma linguagem de consulta, um tipo de DSL para trabalhar com dados.  √â claro que √© sempre mais f√°cil escrever Plan.load (id) do que o SQL correspondente, mas isso √© para casos triviais.  Quando se trata de coisas um pouco mais complexas, o SQL se torna uma ferramenta muito bem-vinda.  √Äs vezes, voc√™ amaldi√ßoa outro ORM ao tentar faz√™-lo como SQL puro, que "eu escreveria em alguns minutos".  Para quem est√° em d√∫vida, sugiro consultar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">MongoDB</a> , onde as explica√ß√µes s√£o fornecidas em um formato semelhante ao SQL, que parece muito engra√ßado!  Portanto, a interface para consultas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">ORM JetSet</a> , que escrevi para meus prop√≥sitos, √© SQL com impregna√ß√µes m√≠nimas, como "AS ENTITY".  A prop√≥sito, na maioria dos casos, n√£o uso objetos de modelo, v√°rios DTOs etc. para exibir dados tabulares - basta escrever uma consulta SQL, obter uma matriz de objetos hash e exibi-la em exibi√ß√£o.  De uma forma ou de outra, poucas pessoas conseguem ‚Äúrolar‚Äù o big data projetando tabelas relacionadas em um modelo.  Na pr√°tica, a proje√ß√£o plana (visualiza√ß√£o) √© mais provavelmente usada, e produtos muito maduros chegam ao est√°gio de otimiza√ß√£o quando solu√ß√µes mais complexas como o CQRS (Segrega√ß√£o de Responsabilidade por Comando e Consulta) come√ßam a ser usadas. <br><br><h2>  Juntando tudo </h2><br>  Ent√£o, o que temos: <br><br><ul><li>  descobrimos como carregar e salvar o modelo, tamb√©m projetamos uma arquitetura aproximada da ferramenta de entrega na Web do modelo, um determinado roteador; </li><li>  chegamos √† conclus√£o de que toda l√≥gica que n√£o faz parte da √°rea de assunto pode ser retirada em Actions (Actions) em vez de controladores e reposit√≥rios; </li><li>  As a√ß√µes devem suportar a inje√ß√£o de depend√™ncia </li><li>  ferramenta decente Inje√ß√£o de Depend√™ncia implementada; </li><li>  O ORM necess√°rio √© implementado. </li></ul><br>  A √∫nica coisa que resta √© implementar o mesmo "roteador".  Como nos livramos de reposit√≥rios e controladores em favor de a√ß√µes, √© √≥bvio que, para uma solicita√ß√£o, precisaremos executar v√°rias a√ß√µes.  As a√ß√µes s√£o aut√¥nomas e n√£o podemos investir uma na outra.  Portanto, como parte da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">estrutura Dandy,</a> implementei um roteador que permite criar cadeias de a√ß√µes.  Exemplo de configura√ß√£o (preste aten√ß√£o em / planos): <br><br><pre> <code class="plaintext hljs">:receive .-&gt; :before -&gt; common/open_db_session GET -&gt; welcome -&gt; :respond &lt;- show_welcome /auth -&gt; :before -&gt; current_user@users/load_current_user /profile -&gt; GET -&gt; plan@plans/load_plan \ -&gt; :respond &lt;- users/show_user_profile PATCH -&gt; users/update_profile /plans -&gt; GET -&gt; current_plan@plans/load_current_plan \ -&gt; plans@plans/load_plans \ -&gt; :respond &lt;- plans/list :catch -&gt; common/handle_errors</code> </pre><br>  "GET / auth / planos" exibe todos os planos de assinatura dispon√≠veis e "destaca" o atual.  O seguinte acontece: <br><br><ol><li>  ": before -&gt; common / open_db_session" - abrindo uma sess√£o do JetSet </li><li>  / auth ": before -&gt; current_user @ users / load_current_user" - carrega o usu√°rio atual (por tokens).  O resultado √© registrado no cont√™iner de IoC como current_user (current_user @ instru√ß√£o). </li><li>  / auth / plans "current_plan @ planos / load_current_plan" - carrega o plano atual.  Para isso, o valor @current_user √© obtido do cont√™iner.  O resultado √© registrado no cont√™iner de IoC como current_plan (current_plan @ instru√ß√£o): <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCurrentPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INNER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOIN</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriptions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ON</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AND</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LIMIT</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">: @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">map</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></li><li>  "Planos @ planos / load_plans" - carregando uma lista de todos os planos dispon√≠veis.  O resultado √© registrado no cont√™iner de IoC como planos (a instru√ß√£o plans @). </li><li>  ": responda &lt;- planos / lista" - o ViewBuilder registrado, por exemplo JBuilder, desenha a vista 'planos / lista' do tipo: <br><br><pre> <code class="ruby hljs">json.plans @plans <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|plan|</span></span> json.id plan.id json.name plan.name json.price plan.price json.active plan.id == @current_plan.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></li></ol><br>  Como @plans e @current_plan, os valores registrados nas etapas anteriores s√£o recuperados do cont√™iner.  No construtor Action, em geral, voc√™ pode "ordenar" tudo o que precisa, ou melhor, tudo o que est√° registrado no cont√™iner.  Um leitor atento provavelmente ter√° uma pergunta, mas h√° isolamento de tais vari√°veis ‚Äã‚Äãno modo "multiusu√°rio"?  Sim sim.  O fato √© que o cont√™iner Hypo IoC tem a capacidade de definir a vida √∫til dos objetos e, al√©m disso, vincul√°-lo √† vida √∫til de outros objetos.  No Dandy, vari√°veis ‚Äã‚Äãcomo @plans, @current_plan, @current_user s√£o vinculadas ao objeto de solicita√ß√£o e ser√£o destru√≠das no momento em que a solicita√ß√£o for conclu√≠da.  A prop√≥sito, a sess√£o JetSet tamb√©m est√° vinculada √† solicita√ß√£o - uma redefini√ß√£o de seu estado tamb√©m ser√° executada quando a solicita√ß√£o Dandy for conclu√≠da.  I.e.  Cada solicita√ß√£o possui seu pr√≥prio contexto isolado.  Hypo governa todo o ciclo de vida de Dandy, n√£o importa o qu√£o divertido esse trocadilho tenha sido na tradu√ß√£o literal dos nomes. <br><br><h2>  Conclus√µes </h2><br>  Dentro da estrutura da arquitetura fornecida, eu uso o modelo de objeto para descrever a √°rea de assunto;  Eu uso pr√°ticas apropriadas como inje√ß√£o de depend√™ncia;  Eu posso at√© usar heran√ßa.  Mas, ao mesmo tempo, todas essas a√ß√µes s√£o essencialmente fun√ß√µes comuns que podem ser encadeadas em um n√≠vel declarativo.  Obtivemos o back-end desejado em um estilo funcional, mas com todas as vantagens da abordagem de objeto, quando voc√™ n√£o tem problemas com abstra√ß√µes e testando seu c√≥digo.  Usando o roteador DSL Dandy como exemplo, podemos criar os idiomas necess√°rios para descrever rotas e muito mais. <br><br><h2>  Conclus√£o </h2><br>  Como parte deste artigo, conduzi uma esp√©cie de tour pelos aspectos fundamentais da cria√ß√£o de um back-end como eu o vejo.  Repito, o artigo √© superficial, n√£o abordou muitos t√≥picos importantes, como, por exemplo, otimiza√ß√£o de desempenho.  Tentei me concentrar apenas naquelas coisas que podem realmente ser √∫teis para a comunidade como alimento para o pensamento, e n√£o mais uma vez derramar de vazio para vazio, o que √© SOLID, TDD, como √© o esquema do MVC e assim por diante.  Defini√ß√µes estritas desses e de outros termos usados ‚Äã‚Äãpor um leitor curioso podem ser facilmente encontradas na vasta rede, sem mencionar colegas da loja, para os quais essas abrevia√ß√µes fazem parte do discurso cotidiano.  E, finalmente, enfatizo, tente n√£o se concentrar nas ferramentas que eu precisava implementar para resolver os problemas colocados.      ,    .     - ,       . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt474504/">https://habr.com/ru/post/pt474504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt474494/index.html">Como foi a C√∫pula Zabbix 2019</a></li>
<li><a href="../pt474496/index.html">Bancos de dados no HighLoad ++ 2019</a></li>
<li><a href="../pt474498/index.html">Tutorial JavaFX: Ol√°, mundo</a></li>
<li><a href="../pt474500/index.html">Desenvolvimento de plugins para Grafana: a hist√≥ria dos cones completos</a></li>
<li><a href="../pt474502/index.html">Odnoklassniki analisando no Joker 2019</a></li>
<li><a href="../pt474508/index.html">Realiza√ß√µes da bioprinting 3D de enxertos de pele</a></li>
<li><a href="../pt474514/index.html">Como sobrevivem os magnatas da minera√ß√£o chinesa de Bitcoin</a></li>
<li><a href="../pt474516/index.html">Aplica√ß√µes de voz: o bilion√©simo mercado que a R√∫ssia n√£o percebe</a></li>
<li><a href="../pt474518/index.html">FP vs OOP</a></li>
<li><a href="../pt474522/index.html">Hist√≥ria de vira-lata</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>