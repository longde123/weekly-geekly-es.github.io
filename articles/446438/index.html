<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Nuestra experiencia de creaci贸n de API de puerta de enlace   ぞ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algunas compa帽铆as, incluido nuestro cliente, desarrollan el producto a trav茅s de una red de afiliados. Por ejemplo, las grandes tiendas en l铆nea est谩n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nuestra experiencia de creaci贸n de API de puerta de enlace</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/446438/">  Algunas compa帽铆as, incluido nuestro cliente, desarrollan el producto a trav茅s de una red de afiliados.  Por ejemplo, las grandes tiendas en l铆nea est谩n integradas con un servicio de entrega: usted ordena productos y pronto recibe un n煤mero de seguimiento para el paquete.  Otro ejemplo: junto con un boleto a茅reo, compra un seguro o un boleto Aeroexpress. <br><br>  Para esto, se utiliza una API, que debe emitirse a los socios a trav茅s de la API de Gateway.  Hemos resuelto este problema.  Este art铆culo proporcionar谩 detalles. <br><br>  Dado: ecosistema y portal API con una interfaz donde los usuarios est谩n registrados, reciben informaci贸n, etc.  Necesitamos hacer una API de Gateway conveniente y confiable.  En el proceso, necesit谩bamos proporcionar <br><br><ul><li>  Registro </li><li>  Control de conexi贸n API </li><li>  Monitorear c贸mo los usuarios usan el sistema final </li><li>  contabilidad de indicadores de negocios. </li></ul><br><img src="https://habrastorage.org/webt/op/f3/aa/opf3aadequfubwpkiu4gci8j9nm.png"><br><br>  En el art铆culo, hablaremos sobre nuestra experiencia en la creaci贸n de la API de Gateway, durante la cual resolvimos las siguientes tareas: <br><br><ul><li>  autenticaci贸n de usuario </li><li>  autorizaci贸n de usuario </li><li>  modificaci贸n de la solicitud original, </li><li>  solicitud de representaci贸n </li><li>  postprocesamiento de la respuesta. </li></ul><br><a name="habracut"></a><br>  Hay dos tipos de gesti贸n de API: <br><br>  1. Est谩ndar, que funciona de la siguiente manera.  Antes de conectarse, el usuario prueba las posibilidades, luego paga e incrusta en su sitio.  Con mayor frecuencia se usa en peque帽as y medianas empresas. <br><br>  2. Una gran Administraci贸n de API B2B, cuando la empresa toma una decisi贸n comercial por primera vez sobre la conexi贸n, se convierte en una empresa asociada con una obligaci贸n contractual y luego se conecta a la API.  Y despu茅s de resolver todas las formalidades, la empresa obtiene acceso a las pruebas, las aprueba y entra en ventas.  Pero esto no es posible sin una decisi贸n de administraci贸n para conectarse. <br><br><img src="https://habrastorage.org/webt/go/qv/oi/goqvoiroiq0yknutwbn9hrt7abe.jpeg"><br><br><h3>  Nuestra decision </h3><br>  En esta parte, hablaremos sobre la creaci贸n de la API de Gateway. <br><br>  Los usuarios finales de la puerta de enlace creada a la API son los socios de nuestros clientes.  Para cada uno de ellos, ya tenemos los contratos necesarios.  Solo necesitaremos expandir la funcionalidad, teniendo en cuenta el acceso otorgado a la puerta de enlace.  En consecuencia, se necesita una conexi贸n controlada y un proceso de control. <br><br>  Por supuesto, uno podr铆a tomar una soluci贸n lista para resolver la tarea de Administraci贸n de API y crear API Gateway en particular.  Por ejemplo, esto podr铆a ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Azure API Management</a> .  No nos conven铆a, porque en nuestro caso ya ten铆amos un portal API y un gran ecosistema construido a su alrededor.  Todos los usuarios ya se han registrado, ya entendieron d贸nde y c贸mo pueden obtener la informaci贸n necesaria.  Las interfaces necesarias ya exist铆an en el portal API, solo necesit谩bamos API Gateway.  En realidad, comenzamos a desarrollarlo. <br><br>  Lo que llamamos la API de Gateway es un tipo de proxy.  Aqu铆 nuevamente tuvimos una opci贸n: puede escribir su proxy o puede elegir algo listo para usar.  En este caso, fuimos por el segundo camino y elegimos el paquete nginx + Lua.  Por qu茅  Necesit谩bamos un software confiable y probado que sea compatible con el escalado.  Despu茅s de la implementaci贸n, no quer铆amos verificar la correcci贸n de la l贸gica de negocios y la correcci贸n del proxy. <br><br>  Cualquier servidor web tiene una canalizaci贸n de procesamiento de solicitudes.  En el caso de nginx, se ve as铆: <br><br><img src="https://habrastorage.org/webt/7p/bu/9y/7pbu9y7z9ier1gtfhmu5pccawlu.png"><br><br>  (diagrama de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub Lua Nginx</a> ) <br><br>  Nuestro objetivo era integrarnos en esta tuber铆a en el momento en que podemos modificar la solicitud original. <br><br>  Queremos crear un proxy transparente para que la solicitud permanezca funcionalmente como lleg贸.  Solo controlamos el acceso a la API final, ayudamos a la solicitud para llegar a ella.  En caso de que la solicitud fuera incorrecta, la API final deber铆a mostrar el error, pero no nosotros.  La 煤nica raz贸n por la que podemos rechazar la solicitud es por la falta de acceso al cliente. <br><br>  Para nginx, ya existe una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensi贸n</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lua</a> .  Lua es un lenguaje de script, es muy ligero y f谩cil de aprender.  Por lo tanto, implementamos la l贸gica necesaria usando Lua. <br><br>  La configuraci贸n nginx (analog铆a con la ruta de la aplicaci贸n), donde se realiza todo el trabajo, es comprensible.  Cabe destacar aqu铆 la 煤ltima directiva: post_action. <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /middleware { <span class="hljs-attribute"><span class="hljs-attribute">more_clear_input_headers</span></span> Accept-Encoding; <span class="hljs-attribute"><span class="hljs-attribute">lua_need_request_body</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/rewrite.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/access.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> https://someurl.com; <span class="hljs-attribute"><span class="hljs-attribute">body_filter_by_lua_file</span></span> <span class="hljs-string"><span class="hljs-string">'middleware/body_filter.lua'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">post_action</span></span> /process_session; }</code> </pre> <br>  Considere lo que sucede en esta configuraci贸n: <br>  <b>more_clear_input_headers</b> : borra el valor de los encabezados especificados despu茅s de la directiva. <br>  <b>lua_need_request_body</b> : controla si se debe leer el cuerpo de origen de la solicitud antes de ejecutar las directivas rewrite / access / access_by_lua o no.  De forma predeterminada, nginx no lee el cuerpo de la solicitud del cliente y, si necesita acceder a 茅l, esta directiva debe estar activada. <br>  <b>rewrite_by_lua_file</b> : la ruta a los scripts, que describe la l贸gica para modificar la solicitud <br>  <b>access_by_lua_file</b> : la ruta al script, que describe la l贸gica que verifica el acceso al recurso. <br>  <b>proxy_pass</b> : url a la que se enviar谩 la solicitud por proxy. <br>  <b>body_filter_by_lua_file</b> : la ruta al script, que describe la l贸gica para filtrar la solicitud antes de regresar al cliente. <br>  Y finalmente, <b>post_action</b> es una directiva oficialmente indocumentada que se puede usar para realizar cualquier otra acci贸n despu茅s de que se da la respuesta al cliente. <br><br>  A continuaci贸n, describiremos en orden c贸mo resolvimos nuestros problemas. <br><br><h3>  Autorizaci贸n / autenticaci贸n y solicitud de modificaci贸n </h3><br>  <b>Iniciar sesi贸n</b> <br><br>  Creamos autorizaci贸n y autenticaci贸n mediante accesos de certificados.  Hay un certificado ra铆z.  Cada nuevo cliente del cliente genera su certificado personal con el que puede acceder a la API.  Este certificado se configura en la secci贸n del servidor de configuraci贸n nginx. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssl</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /usr/local/openresty/nginx/ssl/cert.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_client_certificate</span></span> /usr/local/openresty/nginx/ssl/ca.crt; <span class="hljs-attribute"><span class="hljs-attribute">ssl_verify_client</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br>  <b>Modificaci贸n</b> <br><br>  Puede surgir una pregunta justa: 驴qu茅 hacer con un cliente certificado si de repente queremos desconectarlo del sistema?  No vuelva a emitir certificados para todos los dem谩s clientes. <br><br>  As铆 que nos acercamos sin problemas a la siguiente tarea: la modificaci贸n de la solicitud original.  La solicitud original del cliente, en t茅rminos generales, no es v谩lida para el sistema final.  Una de las tareas es agregar las partes que faltan a la solicitud para que sea v谩lida.  El punto es que los datos que faltan son diferentes para cada cliente.  Sabemos que el cliente nos llega con un certificado del que podemos tomar una huella digital y extraer los datos necesarios del cliente de la base de datos. <br><br>  Si en alg煤n momento necesita desconectar al cliente de nuestro servicio, sus datos desaparecer谩n de la base de datos y no podr谩 hacer nada. <br><br><h3>  Trabajar con datos del cliente. </h3><br>  Necesit谩bamos garantizar una alta disponibilidad de la soluci贸n, especialmente c贸mo obtenemos los datos del cliente.  La dificultad es que la fuente de estos datos es un servicio de terceros que no garantiza una velocidad ininterrumpida y bastante alta. <br><br>  Por lo tanto, necesit谩bamos garantizar una alta disponibilidad de los datos del cliente.  Como herramienta, elegimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hazelcast</a> , que nos proporciona: <br><br><ul><li>  acceso r谩pido a los datos </li><li>  La capacidad de organizar un cl煤ster de varios nodos con datos replicados en diferentes nodos. </li></ul><br>  Fuimos por la estrategia de entrega de cach茅 m谩s simple: <br><br><img src="https://habrastorage.org/webt/u6/f6/72/u6f6729km0g71ge4prl5ww1kes8.png"><br><br>  El trabajo con el sistema final ocurre dentro del marco de las sesiones y hay un l铆mite en el n煤mero m谩ximo.  Si el cliente no cerr贸 la sesi贸n, tendremos que hacer esto. <br><br>  Los datos de sesi贸n abierta provienen del sistema de destino y se procesan inicialmente en el lado de Lua.  Decidimos usar Hazelcast para guardar estos datos con un escritor .NET.  Luego, en algunos intervalos, verificamos el derecho a la vida de las sesiones abiertas y cerramos la falta. <br><br><h3>  Acceso a Hazelcast desde Lua y .NET </h3><br>  No hay clientes en Lua para trabajar con Hazelcast, pero Hazelcast tiene una API REST, que decidimos usar.  Para .NET, hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente a</a> trav茅s del cual planeamos acceder a los datos de Hazelcast en el lado .NET.  Pero ah铆 estaba. <br><br><img src="https://habrastorage.org/webt/qr/xn/ip/qrxnipywarywskcoslishyb8xtm.png"><br><br>  Al guardar datos a trav茅s de REST y recuperarlos a trav茅s del cliente .NET, se utilizan diferentes serializadores / deserializadores.  Por lo tanto, es imposible poner los datos a trav茅s de REST, pero a trav茅s del cliente .NET y viceversa. <br><br>  Si est谩 interesado, hablaremos m谩s sobre este problema en un art铆culo separado.  Spoiler - en el shemka. <br><br><img src="https://habrastorage.org/webt/wh/l8/ra/whl8rayewel52cotktzhfcejmbs.png"><br><br><h3>  Registro y Monitoreo </h3><br>  Nuestro est谩ndar corporativo para iniciar sesi贸n a trav茅s de .NET es Serilog, todos los registros terminan en Elasticsearch, los analizamos a trav茅s de Kibana.  Quer铆a hacer algo similar en este caso.  El 煤nico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente</a> que trabaj贸 con Elastic en Lua que se encontr贸 quebr贸 en el primer requerimiento.  Y usamos Fluentd. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fluentd</a> es una soluci贸n de c贸digo abierto para proporcionar una sola capa de registro de aplicaciones.  Le permite recopilar registros de diferentes capas de la aplicaci贸n y luego traducirlos a una sola fuente. <br><br>  La API de Gateway funciona en K8S, por lo que decidimos agregar el contenedor con fluentd al mismo subtipo para escribir registros en el puerto tcp abierto existente fluentd. <br><br>  Tambi茅n examinamos c贸mo se comportar铆a fluentd si no tuviera conexi贸n con Elasticsearch.  Durante dos d铆as, las solicitudes se enviaron continuamente a la puerta de enlace, los registros se enviaron a fluentd, pero se prohibi贸 la fluidez de IP Elastic.  Despu茅s de reconectarse, fluentd super贸 perfectamente todos los registros en Elastic. <br><br><h3>  Conclusi贸n </h3><br>  El enfoque elegido para la implementaci贸n nos permiti贸 entregar un producto realmente funcional para el entorno de combate en solo 2.5 meses. <br><br>  Si alguna vez hace tales cosas, le recomendamos primero que comprenda claramente qu茅 problema est谩 resolviendo y cu谩les de los recursos que ya tiene.  Tenga en cuenta las complejidades de la integraci贸n con los sistemas de gesti贸n de API existentes. <br><br>  Comprenda por s铆 mismo qu茅 es exactamente lo que va a desarrollar: solo la l贸gica empresarial del procesamiento de solicitudes o, como podr铆a ser el caso en nuestro caso, el proxy completo.  Recuerde que todo lo que haga usted mismo debe probarse a fondo despu茅s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446438/">https://habr.com/ru/post/446438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446428/index.html">C贸mo se construy贸 la planta de abejorros de HR</a></li>
<li><a href="../446430/index.html">Enfriamiento de una nanopart铆cula levitante por medio de un resonador 贸ptico</a></li>
<li><a href="../446432/index.html">Se celebr贸 un seminario sobre gesti贸n de documentos t茅cnicos en Crimea</a></li>
<li><a href="../446434/index.html">Escala de Zimbra Collaboration Suite</a></li>
<li><a href="../446436/index.html">C贸mo generar hip贸tesis sobre las necesidades de los consumidores potenciales de su producto futuro</a></li>
<li><a href="../446440/index.html">El libro Reacciona r谩pido. Aplicaciones web en React, JSX, Redux y GraphQL 禄</a></li>
<li><a href="../446444/index.html">De Skype a WebRTC: c贸mo organizamos la comunicaci贸n de video web</a></li>
<li><a href="../446446/index.html">Conceptos b谩sicos del motor de JavaScript: formularios generales y almacenamiento en cach茅 en l铆nea. Parte 1</a></li>
<li><a href="../446448/index.html">5 reglas b谩sicas para realizar entrevistas problem谩ticas para identificar las necesidades del consumidor</a></li>
<li><a href="../446452/index.html">Misi贸n lunar "Bereshit": el 4 de abril de 2019, se complet贸 la transici贸n a la 贸rbita lunar, 7 d铆as de vuelo por delante, 6 maniobras y 1 aterrizaje</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>