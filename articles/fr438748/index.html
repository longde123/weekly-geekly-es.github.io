<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëï ‚õπüèΩ ü§£ L'infrastructure comme code, nous gagnons √† l'√©chelle (Kirill Vetchinkin, TYME) üôãüèø ‚¨ÖÔ∏è üöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le mod√®le Infrastructure as a Code (IaC), parfois appel√© ¬´infrastructure programmable¬ª, est un mod√®le par lequel le processus de configuration de l'in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'infrastructure comme code, nous gagnons √† l'√©chelle (Kirill Vetchinkin, TYME)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438748/"><p>  Le mod√®le Infrastructure as a Code (IaC), parfois appel√© ¬´infrastructure programmable¬ª, est un mod√®le par lequel le processus de configuration de l'infrastructure est similaire au processus de programmation logicielle.  Essentiellement, cela a marqu√© le d√©but de la suppression des fronti√®res entre l'√©criture d'applications et la cr√©ation d'environnements pour ces applications.  Les applications peuvent contenir des scripts qui cr√©ent et g√®rent leurs propres machines virtuelles.  C'est le fondement du cloud computing et une partie int√©grante de DevOps. </p><br><p>  L'infrastructure en tant que code vous permet de g√©rer des machines virtuelles au niveau logiciel.  Cela √©limine le besoin de configuration manuelle et de mises √† jour pour les composants d'√©quipement individuels.  L'infrastructure devient extr√™mement ¬´r√©siliente¬ª, c'est-√†-dire reproductible et √©volutive.  Un op√©rateur peut d√©ployer et g√©rer √† la fois une et 1000 machines en utilisant le m√™me ensemble de code.  Parmi les avantages garantis de l'infrastructure comme le code, citons la rapidit√©, la rentabilit√© et la r√©duction des risques. </p><br><p>  C'est exactement le sujet du d√©codage du rapport de Kirill Vetchinkin √† DevOpsDays Moscou 2018. Le rapport: r√©utilisation des modules Ansible, stockage dans Git, r√©vision, reconstruction, avantages financiers, mise √† l'√©chelle horizontale en 1 clic. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mElPCgMl_Wg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Peu importe, s'il vous pla√Æt, sous le chat. </p><a name="habracut"></a><br><p>  Bonjour √† tous.  Comme je l'ai d√©j√† dit, je suis Vetchinkin Kirill.  Je travaille chez TYME et aujourd'hui nous parlerons de l'infrastructure en tant que code.  Nous parlerons √©galement de la fa√ßon dont nous avons appris √† √©conomiser sur cette pratique, car elle co√ªte assez cher.  √âcrire beaucoup de code co√ªte assez cher pour configurer l'infrastructure. </p><br><p>  Je vais parler bri√®vement de l'entreprise.  Je travaille chez TYME.  Nous avons chang√© de marque.  Maintenant, nous nous appelons PaySystem - comme son nom l'indique, nous sommes engag√©s dans des syst√®mes de paiement.  Nous avons nos propres solutions - ce sont les traitements et le d√©veloppement personnalis√©.  Le d√©veloppement personnalis√© est la banque √©lectronique, la facturation, etc.  Et comme vous le savez, s'il s'agit d'un d√©veloppement personnalis√©, il s'agit d'un grand nombre de projets chaque ann√©e.  Le projet va apr√®s le projet.  Plus il y a de projets, plus il faut augmenter l'infrastructure du m√™me type.  Les projets √©tant souvent lourdement charg√©s, nous utilisons une architecture de microservice.  Par cons√©quent, dans un projet, il y a beaucoup, beaucoup de petits sous-projets. </p><br><p><img src="https://habrastorage.org/webt/e2/pn/or/e2pnoryduehiqs7tpmruibojxng.png"></p><br><p>  Par cons√©quent, la gestion de tout ce zoo sans DevOps complet est tr√®s difficile.  Par cons√©quent, notre entreprise a mis en ≈ìuvre diverses pratiques DevOps.  Naturellement, nous travaillons sur le kanban, sur SCRUM, nous stockons tout dans git.  Apr√®s validation, l'int√©gration est continue, les tests sont ex√©cut√©s.  Les testeurs √©crivent des tests de bout en bout sur PyTest qui commencent tous les soirs.  Le test unitaire d√©marre apr√®s chaque validation.  Nous utilisons un processus de construction et de d√©ploiement distinct: assembl√©, puis d√©ploy√© plusieurs fois dans divers environnements.  Nous √©tions aux fen√™tres.  Sur les fen√™tres que nous avons d√©ploy√©es en utilisant Octopus deploy, nous d√©veloppons cette ann√©e sur DotNet Core.  Par cons√©quent, nous pouvons d√©sormais ex√©cuter des logiciels sur des syst√®mes Linux.  Nous avons quitt√© Octopus et sommes venus √† Ansible.  Aujourd'hui, nous allons parler de cette partie, qui est une nouvelle pratique que nous avons d√©velopp√©e cette ann√©e, quelque chose que nous n'avions pas auparavant.  Lorsque vous avez des tests, quand vous savez comment bien construire l'application, le d√©ployer quelque part est tr√®s bien.  Mais si vous avez deux environnements configur√©s diff√©remment, alors vous tomberez et tomberez en production.  Par cons√©quent, la gestion des configurations est une pratique tr√®s importante.  C'est de cela que nous allons parler aujourd'hui. </p><br><p><img src="https://habrastorage.org/webt/_u/di/kj/_udikjskq0g3yi48718mjn1hf54.png"><br>  Je vais vous expliquer bri√®vement comment l'√©conomie du travail du produit est construite: <strong>60</strong> % sont consacr√©s au <strong>d√©veloppement</strong> , l' <strong>analyse</strong> prend environ <strong>10</strong> %, le <strong>contr√¥le qualit√©</strong> (tests) prend environ <strong>20</strong> % et tout le reste est allou√© √† la configuration.  Lorsque les syst√®mes fonctionnent √† plein r√©gime, ils disposent de nombreux logiciels tiers, les syst√®mes d'exploitation eux-m√™mes sont configur√©s presque de la m√™me mani√®re.  Nous passons plus de temps √† faire cela, essentiellement √† faire la m√™me chose.  Il y avait une id√©e pour automatiser tout et r√©duire le co√ªt de configuration de l'infrastructure.  Des t√¢ches similaires sont automatis√©es, bien d√©bogu√©es et ne contiennent pas d'op√©rations manuelles. </p><br><p><img src="https://habrastorage.org/webt/zf/vh/wm/zfvhwmb7pvlufeihfrgj0xk6dnq.png"><br>  Chaque application fonctionne dans une sorte d'environnement.  Voyons de quoi il s'agit.  Au minimum, nous devons avoir un <strong>syst√®me d'exploitation</strong> , il doit √™tre configur√©, il y a des <strong>applications tierces</strong> qui doivent √©galement √™tre configur√©es, <strong>l'application elle-m√™me</strong> doit recevoir les configurations, mais pour que tout le produit fonctionne, l'application elle-m√™me doit d√©marrer, qui fonctionne dans tout ce syst√®me.  Il existe √©galement un <strong>r√©seau</strong> qui doit √©galement √™tre configur√©, mais nous ne parlerons pas du r√©seau aujourd'hui, car nous avons diff√©rents clients, diff√©rents p√©riph√©riques r√©seau.  Nous avons √©galement essay√© d'automatiser la configuration du r√©seau, mais comme les appareils sont diff√©rents, cela ne pr√©sentait aucun avantage particulier, nous avons consacr√© plus de ressources √† cela.  Mais nous avons automatis√© les syst√®mes d'exploitation, les applications tierces et le transfert des param√®tres de configuration aux applications elles-m√™mes. </p><br><p><img src="https://habrastorage.org/webt/mp/gx/l0/mpgxl0kr4wzjrc9zymbmjn2pk6c.png"></p><br><p>  Il existe deux approches pour configurer les serveurs: avec vos mains - si vous les configurez avec vos mains, vous pouvez en cons√©quence obtenir une situation telle que votre production est configur√©e d'une mani√®re, le test est diff√©rent, le test est vert, les tests sont verts.  Vous d√©ployez en production, et il n'y a pas de cadre l√†-bas - rien ne fonctionne pour vous.  Autre exemple: trois serveurs d'applications sont configur√©s √† la main.  Un serveur d'applications a √©t√© configur√© d'une mani√®re, un autre serveur d'applications d'une mani√®re diff√©rente.  Les serveurs peuvent fonctionner de diff√©rentes mani√®res.  Autre exemple: il y a eu une situation o√π un serveur Stage a compl√®tement cess√© de fonctionner pour nous.  Nous avons commenc√© √† cr√©er un nouveau serveur en utilisant et apr√®s 30 le serveur √©tait pr√™t.  Autre exemple: le serveur vient de cesser de fonctionner.  Si vous le configurez avec vos mains, vous devez rechercher une personne qui sait comment le configurer, vous devez augmenter la documentation.  Comme nous le savons, la documentation n'est gu√®re pertinente.  Ce sont de gros probl√®mes.  Et, plus important encore, il s'agit d'un audit, c'est-√†-dire qu'en gros, vous avez dix administrateurs, chacun d'eux configure quelque chose avec ses mains, il n'est pas tr√®s clair s'ils l'ont configur√© correctement ou incorrectement, et comment comprendre si puis les param√®tres, ils pourraient mettre quelque chose de superflu, ouvrir des ports inutiles. </p><br><p><img src="https://habrastorage.org/webt/uz/pr/be/uzprbex2cscs4xglphdoy_wsenw.png"></p><br><p>  Il existe une option alternative - c'est exactement ce dont nous parlons aujourd'hui - c'est la configuration √† partir du code.  Autrement dit, nous avons un r√©f√©rentiel git dans lequel toute l'infrastructure est stock√©e.  Tous les scripts y sont stock√©s, √† l'aide desquels nous allons le configurer.  Comme tout est dans git, nous b√©n√©ficions de tous les avantages de la gestion de code, comme dans le d√©veloppement, c'est-√†-dire que nous pouvons faire des r√©visions, des audits, l'historique des modifications, qui l'a fait, pourquoi l'a fait, des commentaires, nous pouvons revenir en arri√®re.  Pour travailler avec le code, vous devez utiliser le pipeline d'assemblage continu - le pipeline de d√©ploiement.  Pour qu'un syst√®me particulier apporte des modifications aux serveurs, c'est-√†-dire que personne ne ferait quelque chose avec ses mains, mais le syst√®me le ferait exclusivement. </p><br><p><img src="https://habrastorage.org/webt/0r/dj/j_/0rdjj_cdepjplmukudcdg5sbnlo.png"></p><br><p>  En tant que syst√®me qui effectue les modifications, nous utilisons Ansible.  Comme nous n'avons pas un grand nombre de serveurs, il nous convient parfaitement.  Si vous avez 100 √† 200 serveurs l√†-bas, vous aurez de petits probl√®mes, car il (c'est-√†-dire Ansible) se connecte toujours √† chacun et les configure √† son tour - c'est un probl√®me.  Il vaut mieux utiliser d'autres moyens qui ne poussent pas, mais tirent.  Mais pour notre histoire, lorsque nous avons de nombreux projets, mais pas plus de 20 serveurs, cela nous convient parfaitement.  Ansible a un gros plus - c'est un seuil d'entr√©e bas.  Autrement dit, n'importe quel sp√©cialiste informatique en trois semaines peut parfaitement le ma√Ætriser.  Il a beaucoup de modules.  Autrement dit, vous pouvez g√©rer les nuages, les r√©seaux, les fichiers, l'installation de programmes, d√©ployer - absolument tout.  S'il n'y a pas de modules, vous pouvez √©crire les v√¥tres, vous pouvez enfin √©crire quelque chose en utilisant le shell Ansible ou le module de commande. </p><br><p><img src="https://habrastorage.org/webt/y6/2j/vq/y62jvqqmsm9jwm0shngvgrp_5_g.png"></p><br><p>  En g√©n√©ral, nous examinerons bri√®vement √† quoi il ressemble g√©n√©ralement, cet outil.  Ansible a des modules dont j'ai d√©j√† parl√©.  Autrement dit, ils peuvent √™tre livr√©s, √©crits par eux-m√™mes, qui font quelque chose.  Il y a des inventaires - c'est l√† que nous effectuerons nos modifications, c'est-√†-dire que ce sont les h√¥tes, leurs adresses IP, les variables sp√©cifiques √† ces h√¥tes.  Et, en cons√©quence, le r√¥le.  Les r√¥les sont ce que nous d√©ploierons sur ces serveurs.  Et nos h√¥tes sont √©galement regroup√©s en groupes, c'est-√†-dire que dans ce cas, nous voyons que nous avons deux groupes: le serveur de base de donn√©es et le serveur d'applications.  Dans chaque groupe, nous avons trois voitures.  Ils sont connect√©s via ssh.  Ainsi, nous r√©solvons les probl√®mes dont nous avons parl√© plus t√¥t, √† savoir qu'en premier lieu nos serveurs sont configur√©s de mani√®re identique, car le m√™me r√¥le se d√©ploie sur les serveurs.  Et de la m√™me mani√®re, si nous ex√©cutons ce r√¥le sur plusieurs machines, alors pour chacune, cela fonctionnera de la m√™me mani√®re. </p><br><p><img src="https://habrastorage.org/webt/h2/hr/-t/h2hr-t11qunwpnaa-9ro7wxhfio.png"></p><br><p>  Si nous examinons de plus pr√®s la structure du projet Ansible, nous voyons ici que les h√¥tes sont acceptables pour les inventaires de production.  Ce groupe est indiqu√© et contient deux serveurs.  Si nous allons sur un serveur sp√©cifique, nous voyons que l'adresse IP de cette machine est indiqu√©e ici.  D'autres param√®tres peuvent √©galement y √™tre indiqu√©s - variables sp√©cifiques √† cet environnement.  Si nous regardons les r√¥les.  Ce r√¥le contient plusieurs t√¢ches qui seront ex√©cut√©es.  Dans ce cas, il s'agit du r√¥le d'installation de PostgreSQL.  Autrement dit, nous installons l'application n√©cessaire, cr√©ons la base de donn√©es.  Ici, nous utilisons une boucle.  Ils (bases de donn√©es) seront un peu cr√©√©s.  Ensuite, nous √©tablissons la connexion n√©cessaire - les adresses IP qui peuvent se connecter √† cette base de donn√©es.  Et, en cons√©quence, nous configurons √† la toute fin du pare-feu.  Les param√®tres seront appliqu√©s √† tous les serveurs du groupe. </p><br><p><img src="https://habrastorage.org/webt/zg/ia/zo/zgiazoqklptftwwsjnxyqtq-1jc.png"></p><br><p>  Abordez le probl√®me lui-m√™me: nous avons appris √† configurer le serveur √† l'aide d'Ansible et tout allait bien.  Mais, comme je l'ai dit, nous avons de nombreux projets.  Ils sont presque tous pareils.  Certains de ces syst√®mes sont impliqu√©s dans chaque projet (k8s, RabbitMQ, Vault, ELK, PostgreSQL, HAProxy).  Pour chacun, nous avons √©crit un r√¥le.  Nous pouvons le faire rouler √† partir du bouton. </p><br><p><img src="https://habrastorage.org/webt/c3/ob/ez/c3obezyaxpshu6akdh6_qodbhp4.png"></p><br><p>  Mais nous avons de nombreux projets, et dans chacun, ils se chevauchent essentiellement.  C'est-√†-dire, dans un tel ensemble, dans le second tel, dans le troisi√®me tel.  Nous obtenons des points d'intersection dans lesquels les m√™mes r√¥les dans diff√©rents projets. </p><br><p><img src="https://habrastorage.org/webt/zk/fi/ag/zkfiagc0lsac1-a9tnce_rr7cha.png"></p><br><p>  Nous avons un r√©f√©rentiel avec une application, nous avons un r√©f√©rentiel avec une infrastructure pour le projet.  Le deuxi√®me projet a exactement la m√™me chose.  Infrastructure continue.  Et le troisi√®me.  Si nous impl√©mentons la m√™me chose, le copier-coller se r√©v√©lera essentiellement.  Nous jouerons le m√™me r√¥le dans 10 endroits.  Ensuite, s'il y a une erreur, nous r√©gnerons en 10 endroits. </p><br><p><img src="https://habrastorage.org/webt/g8/qe/ht/g8qehtvllis6iwedgzaasbu9pe8.png"></p><br><p>  Ce que nous avons fait: nous avons pris chaque r√¥le commun √† tous les projets et toutes ses configurations qui viennent de l'ext√©rieur vers un r√©f√©rentiel s√©par√© et les avons plac√©s dans un git dans un dossier s√©par√© - nous avons appel√© TYME Infrastructure.  Nous avons l√† un r√¥le pour PostgreSQL, pour ELK, pour le d√©ploiement de clusters Kubernetes.  Si nous avons besoin de mettre dans un projet, disons le m√™me PostgreSQL, puis allumez-le simplement comme un sous-module, r√©√©crivez les inventaires, c'est-√†-dire, en gros, la configuration o√π rouler ce r√¥le.  Nous ne r√©√©crivons pas le r√¥le lui-m√™me: il existe d√©j√†.  Et d'un simple clic, PostgreSQL appara√Æt dans tous les nouveaux projets.  Si vous devez augmenter un cluster Kubernetes - la m√™me chose. </p><br><p><img src="https://habrastorage.org/webt/iy/q1/p0/iyq1p0mgtf6vhnk06s4mnirypls.png"></p><br><p>  Ainsi, il s'est av√©r√© r√©duire le co√ªt d'√©criture des r√¥les.  Autrement dit, ils ont √©crit une fois - ils l'ont utilis√© 10 fois.  Lorsque le projet va apr√®s le projet - c'est tr√®s pratique.  Mais comme nous travaillons maintenant avec l'infrastructure en tant que code, nous avons naturellement besoin des pipelines dont nous avons parl√©.  Les gens s'engagent dans git, ils peuvent commettre une sorte d'inexactitude - nous devons suivre tout cela.  Par cons√©quent, nous avons construit un tel pipeline.  Autrement dit, le d√©veloppeur valide les scripts Ansible dans git.  Teamity les suit et les transf√®re √† Ansible.  Teamcity n'est n√©cessaire ici que pour une raison: premi√®rement, il a une interface visuelle (il existe une version gratuite d'Ansible Tower - AWX, qui r√©sout le m√™me probl√®me - environ)., Contrairement √† Ansible, gratuit et, en principe, nous avons Teamcity comme un seul Ci.  Donc, en principe, Ansible a un module qui peut lui-m√™me suivre git.  Mais dans ce cas, ils l'ont fait √† l'image et √† la ressemblance.  Et d√®s qu'il l'a suivi, il transf√®re tout le code √† Ansible et Ansible, respectivement, les lance sur le serveur d'int√©gration et modifie la configuration.  Si ce processus est viol√©, nous analysons ce qui ne va pas, pourquoi les scripts ont √©t√© mal √©crits. </p><br><p><img src="https://habrastorage.org/webt/rj/hc/wj/rjhcwjfpwdf_xwr8vpk4z2se26c.png"></p><br><p>  Le deuxi√®me point est qu'il existe une infrastructure sp√©cifique, ici nous avons l'infrastructure d√©ploy√©e s√©par√©ment, l'application est d√©ploy√©e s√©par√©ment.  Mais il existe une infrastructure sp√©cifique pour chaque application, c'est-√†-dire qui doit √™tre d√©ploy√©e avant de la lancer.  Ici, en cons√©quence, il est impossible de le transf√©rer vers un autre pipeline.  Vous devez le d√©ployer dans le m√™me conteneur que l'application elle-m√™me.  Autrement dit, les frameworks sont tr√®s appr√©ci√©s lorsque vous devez installer un framework pour une nouvelle application et en mettre un autre pour une autre.  Voici comment avec cette situation.  Ou vous devez nettoyer les caches.  Par exemple, Ansible peut √©galement grimper, nettoyer le cache. </p><br><p><img src="https://habrastorage.org/webt/b5/qj/rf/b5qjrf25y_2k4znz0-zidclu7fi.png"></p><br><p>  Mais ici, nous utilisons docker en combinaison avec Ansible.  Autrement dit, l'infrastructure sp√©cifique de nous est dans le docker, non sp√©cifique dans Ansible.  Et donc, nous partageons en quelque sorte ce petit delta dans Docker, tout le reste, fondamental - dans Ansible. </p><br><p><img src="https://habrastorage.org/webt/xq/6i/21/xq6i21qkn6l18s8f68becyjgt7y.png"></p><br><p>  Un point tr√®s important - si vous faites rouler l'infrastructure √† travers une sorte de scripts, via le code, alors si vous avez encore des manipulations manuelles du serveur, alors c'est une vuln√©rabilit√© potentielle.  Parce que disons que vous mettez Java sur le serveur de test, que vous avez √©crit le r√¥le ELK, que vous l'avez lanc√©.  Le d√©ploiement dans le test a r√©ussi.  D√©ployer en production, mais il n'y a pas de java.  Et vous n'avez pas sp√©cifi√© java dans le script - le d√©ploiement en production est tomb√©.  Par cons√©quent, vous devez retirer les droits de tous les serveurs aux administrateurs afin qu'ils n'y rampent pas de vos mains et n'effectuent pas toutes les modifications via git.  Tout ce convoyeur que nous avons travers√© nous-m√™mes.  Il y a une chose mais - ne serrez pas trop les √©crous.  Autrement dit, il est n√©cessaire d'introduire un tel processus progressivement.  Parce qu'il n'est toujours pas recadr√©.  Dans notre cas, nous avons laiss√© l'acc√®s √† tous les syst√®mes √† la t√™te de l'administrateur principal en cas d'incidents impr√©vus.  L'acc√®s est accord√© √† condition de ne rien configurer √† la main. </p><br><p><img src="https://habrastorage.org/webt/za/ka/i0/zakai07gy34i3f7gjx8d-jtvpfy.png"></p><br><p>  Comment fonctionne le d√©veloppement?  D√©ploiement dans la mise en sc√®ne, la production doit √™tre sans erreur.  Quelque chose pourrait se casser ici.  Si le d√©ploiement dans l'environnement d'int√©gration tombe constamment sur des erreurs, ce sera mauvais.  Ceci est similaire au d√©bogage d'applications sur une machine distante.  Lorsqu'un d√©veloppeur d√©veloppe d'abord tout sur une machine, le compile.  Si tout se compile, l'envoie au r√©f√©rentiel.  Il utilise la m√™me approche.  Les d√©veloppeurs utilisent Visual Studio Code avec les plugins Ansible, Vagrant, Docker, etc.  Les d√©veloppeurs testent leur code d'infrastructure sur un vagabond local.  Il s'√©l√®ve un syst√®me d'exploitation propre.  Les scripts eux-m√™mes pour √©lever cette machine se trouvent √©galement dans ce r√©f√©rentiel avec l'infrastructure dont nous avons parl√©.  Le d√©veloppeur commence √† y installer un serveur FTP.  Si quelque chose s'est mal pass√©, il le supprime simplement, le recharge et essaie √† nouveau d'installer le logiciel n√©cessaire dessus √† l'aide de scripts de d√©ploiement.  Apr√®s avoir d√©bogu√© les scripts de d√©ploiement, il envoie une demande de fusion √† la branche principale.  Apr√®s avoir fusionn√© la demande de fusion, le CI restaure ces modifications sur le serveur d'int√©gration. </p><br><p><img src="https://habrastorage.org/webt/6q/os/qq/6qosqq_jtbghh6dvamxnj1sdvru.png"></p><br><p>  Puisque tous les scripts sont du code, nous pouvons √©crire des tests.  Disons que nous avons install√© PostgreSQL.  Nous voulons v√©rifier si cela fonctionne ou non.  Pour ce faire, utilisez le module d'assertion Ansible.  Comparez la version install√©e de PostgreSQL avec la version des scripts.  Ainsi, nous comprenons qu'il est install√©, qu'il fonctionne g√©n√©ralement, c'est la version m√™me que nous attendions. </p><br><p><img src="https://habrastorage.org/webt/fc/3g/lf/fc3glflk8ozxdmpluhltv2a5mye.png"></p><br><p>  On voit que le test a r√©ussi.  Notre playbook a donc fonctionn√© correctement.  Vous pouvez √©crire autant de tests que vous le souhaitez.  Ils sont idempotents.  <strong>Idempotency</strong> (une op√©ration qui, si elle est appliqu√©e √† une valeur plusieurs fois, entra√Æne toujours la m√™me valeur qu'avec une seule application).  Si vous √©crivez des scripts gratuits pour l'installation et la configuration, assurez-vous que vos scripts obtiennent toujours la m√™me valeur si vous les ex√©cutez plusieurs fois. </p><br><p><img src="https://habrastorage.org/webt/cn/tx/zd/cntxzd9yeatgui-yml_a61pegsa.png"></p><br><p>  Il existe un autre type de test qui n'est pas directement li√© aux tests d'infrastructure.  Mais ils semblent l'affecter indirectement.  Ce sont des tests de bout en bout.  Nous avons l'infrastructure et les applications elles-m√™mes sont install√©es sur le m√™me serveur, que les testeurs testent.  Si nous avons d√©ploy√© une sorte d'infrastructure incorrecte, alors nous ne r√©ussirons que des tests complexes.  Autrement dit, notre application ne fonctionnera pas correctement.  Dans cet exemple, nous avons install√© une nouvelle version en production - l'application fonctionne.  Ensuite, une validation a √©t√© faite dans les tests git et end-to-end, qui ont lieu la nuit, suivi qu'ici nous n'avons pas de fichier sur ftp.  Nous d√©montons ce cas et voyons que le probl√®me est dans les param√®tres ftp.  Nous corrigeons les scripts dans le code, d√©ployons √† nouveau et tout devient vert.  M√™me histoire avec le code.  Le code d'infrastructure et l'infrastructure sont indirectement test√©s d'une mani√®re ou d'une autre.  Nous pouvons ensuite le d√©ployer en production. </p><br><p><img src="https://habrastorage.org/webt/mx/bo/e3/mxboe3llquz_vb46qalw6yir85m.png"></p><br><p>  Lorsque nous avons introduit cette approche, CI (Teamcity), qui a d√©ploy√© des modifications sur le serveur d'int√©gration, est tomb√© 8 fois sur 10. Personne n'y a fait attention car il n'y a pas eu de retour.  Pour les d√©veloppeurs, ces processus sont impl√©ment√©s depuis longtemps, mais les messages n'ont pas atteint les OPS (administrateurs syst√®me).  Par cons√©quent, nous avons ajout√© un tableau de bord avec les assemblages de ce projet √† un grand √©cran dans un endroit bien en vue du bureau.  Sur celui-ci, divers projets sont surlign√©s en <strong>vert</strong> - cela signifie que tout est en ordre avec lui.  Si surlign√© en <strong>rouge</strong> signifie que tout va mal avec lui.  On voit que certains tests ont √©chou√©.  Lors de la pr√©sentation, sur le c√¥t√© gauche du second, du haut, nous voyons le r√©sultat des d√©ploiements de d√©ploiement    .  ,    ,    ,   . :  -    .    .    Slack    ,   - - -    . </p><br><p><img src="https://habrastorage.org/webt/3b/bw/l1/3bbwl1jej_cien9satd3epefgqi.png"></p><br><p> Ok,     ,   ,    -  ,         .   trunk based .   Master  ‚Äî    .    Master  CI  (Teamcity)    integration .    CI  ,           integration .  release candidate.      .        .   ,  end-to-end  ,          staging .     production.         ,  staging     . </p><br><p><img src="https://habrastorage.org/webt/ut/lg/rb/utlgrbwe6gtssxn-ivmxwp3hpuc.png"></p><br><p>         .  ?   ,    PostgreSQL.      5     .    ,  .   1-2 .       .  ,  PostgreSQL      .      PostgreSQL  ,    staging, production 4 .   ,   ,         .          ,      .          - . </p><br><p><img src="https://habrastorage.org/webt/ts/28/cl/ts28clrdqnfeocxls1rudzn0k5i.png"></p><br><p>   git submodule     Ansible .       ,   .  git submodule  Ansible    .   inventories ,    .   30 .    git submodule         . </p><br><p><img src="https://habrastorage.org/webt/qx/y3/_w/qxy3_w7ra6n-35jnlc1oyhy_cew.png"></p><br><p>   :     ,           .   ,     ,     ,   staging    ,   . ,   ,   ,   ,   ,    ,     staging.       ‚Äî    , ,    -  . </p><br><p><img src="https://habrastorage.org/webt/mv/lv/nb/mvlvnbmp76dzsemwy9xdkv8nzda.png"></p><br><p>      6 .  ‚Äî   10  .            .      .    ,   . -    git submodule,         .      .      ,     ,      ,         .  ,       ,    . </p><br><p><img src="https://habrastorage.org/webt/tz/bm/n4/tzbmn4-jneygsmiecrtjudgw5ne.png"><br> . </p><br><p> -,   ,        :        ,   Ansible   git , : ‚Äú ,   - ‚Äù.     ?     git .   ,     .  100%  .  .       . </p><br><p>  ,     .    .   ,      RabbitMQ, ELK,    .     ,   ELK    .         ,  ,     ELK.    ELK,    ,    ELK  . </p><br><p>    ,    ,      ,   ,   .     , , ,   ,  .         ,     .       . </p><br><p>    .   ,    ,     ,  ,   ,  ,   .           git.    ,     ‚Äî    git,   ,  :     ,   -    .     . </p><br><p>   ,       ,    ,     code review.   ,     ,   .  ,    .  ,   , ,  ,  ,   .   ,    :      .   .          .     ,   - - . </p><br><p>    ,    . </p><br><p> :     ,       git submodule,        .     - ,     latest .      inventories.    ‚Äî   ,   .   , ,   ..  .  ‚Äî    .      . </p><br><p> :    -   Ansible          ( A   B, B  C      A,      )?   ,     ? </p><br><p> :      .      .  ,   -    IP  ,       ,   ,     ,      .       . ,      ,    ,    ,     ,  .        ,    -   ,  , , RabbitMQ     RabbitMQ,      . -      ,   . </p><br><p> PS      github       .     github  .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github </a> ‚Äî     Pull request   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438748/">https://habr.com/ru/post/fr438748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438732/index.html">Mesures de radioamateur: analyse du signal du bus I2C</a></li>
<li><a href="../fr438734/index.html">Enchev√™trement de personnes partageant les m√™mes id√©es</a></li>
<li><a href="../fr438736/index.html">DevDay for Managers: g√©rer l'informatique</a></li>
<li><a href="../fr438740/index.html">G√©rer les secrets avec HashiCorp Vault</a></li>
<li><a href="../fr438746/index.html">En route vers les principes physiques de l'√©volution biologique. Continuation</a></li>
<li><a href="../fr438750/index.html">Civilisation des ressorts, 4/5</a></li>
<li><a href="../fr438752/index.html">Comptabilit√© directement √† la banque: comment rendre les entrepreneurs individuels heureux</a></li>
<li><a href="../fr438754/index.html">Comment nous avons effectu√© la surveillance du r√©seau pour 14 000 objets</a></li>
<li><a href="../fr438756/index.html">Sixi√®me v√©rification du chrome, postface</a></li>
<li><a href="../fr438758/index.html">Pourquoi Google modifie-t-il l'interface URL standard dans le navigateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>