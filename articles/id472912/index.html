<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿 👨🏾‍🤝‍👨🏽 🏐 Database ClickHouse untuk manusia, atau Teknologi Asing 🤰🏻 👉🏽 🍂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexey Lizunov, kepala pusat kompetensi saluran layanan jarak jauh dari Direktorat Teknologi Informasi ICD 



 Sebagai alternatif dari tumpukan ELK (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Database ClickHouse untuk manusia, atau Teknologi Asing</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/"> <b>Alexey Lizunov, kepala pusat kompetensi saluran layanan jarak jauh dari Direktorat Teknologi Informasi ICD</b> <br><br><img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br><br>  Sebagai alternatif dari tumpukan ELK (ElasticSearch, Logstash, Kibana), kami sedang melakukan penelitian tentang penggunaan database ClickHouse sebagai gudang data untuk log. <br><br>  Dalam artikel ini, kami ingin berbicara tentang pengalaman kami menggunakan database ClickHouse dan tentang hasil awal dari operasi percontohan.  Harus segera dicatat bahwa hasilnya mengesankan. <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br><br>  Selanjutnya, kami akan menjelaskan secara lebih terperinci bagaimana sistem kami dikonfigurasikan dan terdiri dari komponen apa itu.  Tetapi sekarang saya ingin berbicara sedikit tentang database ini secara keseluruhan, dan mengapa Anda harus memperhatikannya.  Basis data ClickHouse adalah basis data kolom analitik kinerja tinggi dari Yandex.  Ini digunakan dalam layanan Yandex, awalnya merupakan gudang data utama untuk Yandex.Metrica.  Sistem open-source gratis.  Dari sudut pandang pengembang, saya selalu tertarik pada bagaimana mereka mengimplementasikannya, karena ada data yang luar biasa besar.  Dan antarmuka pengguna metrik itu sendiri sangat fleksibel dan cepat.  Pada kenalan pertama dengan database ini, kesan: “Ya, akhirnya!  Dibuat "untuk orang-orang"!  Mulai dari proses instalasi dan diakhiri dengan mengirim permintaan. " <br><br>  Basis data ini memiliki ambang masuk yang sangat rendah.  Bahkan rata-rata pengembang yang terampil dapat menginstal database ini dalam beberapa menit dan mulai menggunakannya.  Semuanya bekerja dengan jelas.  Bahkan orang yang baru mengenal Linux dapat dengan cepat melewati instalasi dan melakukan operasi sederhana.  Sebelumnya, ketika kata Big Data, Hadoop, Google BigTable, HDFS, pengembang biasa memiliki gagasan bahwa mereka berbicara tentang beberapa terabyte, petabyte, bahwa beberapa manusia super terlibat dalam pengaturan dan pengembangan untuk sistem ini, kemudian dengan munculnya database ClickHouse yang kami dapatkan. Alat sederhana dan mudah dipahami untuk menyelesaikan berbagai tugas yang sebelumnya tidak dapat dicapai.  Hanya satu mobil yang cukup rata-rata dan lima menit untuk menginstal.  Yaitu, kami mendapat basis data seperti, misalnya, MySql, tetapi hanya untuk menyimpan miliaran catatan!  Semacam pengawas SQL.  Seolah-olah orang diberikan senjata alien. <br><br><h4>  Tentang sistem pengumpulan log kami </h4><br>  Untuk mengumpulkan informasi, file log IIS dari aplikasi web dengan format standar digunakan (kami juga terlibat dalam penguraian log aplikasi, tetapi tujuan utama pada tahap operasi percontohan bersama kami adalah untuk mengumpulkan log IIS). <br><br>  Karena berbagai alasan, kami gagal untuk sepenuhnya meninggalkan tumpukan ELK, dan kami terus menggunakan komponen LogStash dan Filebeat, yang telah membuktikan diri dengan baik dan bekerja dengan cukup andal dan dapat diprediksi. <br><br>  Skema pembalakan umum disajikan pada gambar di bawah ini: <br><br><img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br><br>  Fitur penulisan data ke database ClickHouse adalah penyisipan catatan yang jarang (sekali per detik) dalam kumpulan besar.  Ini, tampaknya, adalah bagian paling "bermasalah" yang Anda temui ketika Anda pertama kali bekerja dengan database ClickHouse: skema ini agak rumit. <br>  Plugin LogStash banyak membantu di sini, yang secara langsung memasukkan data ke dalam ClickHouse.  Komponen ini digunakan pada server yang sama dengan database itu sendiri.  Jadi, secara umum, tidak disarankan untuk melakukannya, tetapi dari sudut pandang praktis, agar tidak menghasilkan server yang terpisah saat digunakan di server yang sama.  Kami tidak melihat adanya kegagalan atau konflik sumber daya dengan database.  Selain itu, perlu dicatat bahwa plugin memiliki mekanisme retray jika terjadi kesalahan.  Dan jika terjadi kesalahan, plugin menulis ke disk paket data yang tidak dapat dimasukkan (format file nyaman: setelah diedit, Anda dapat dengan mudah memasukkan paket yang diperbaiki menggunakan clickhouse-client). <br><br>  Daftar lengkap perangkat lunak yang digunakan dalam skema disajikan dalam tabel: <br><br><div class="spoiler">  <b class="spoiler_title">Daftar perangkat lunak yang digunakan</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  <b>Judul</b> <br></td><td>  <b>Deskripsi</b> <br></td><td>  <b>Tautan Distribusi</b> <br></td></tr><tr><td><p>  Nginx </p><br></td><td><p>  Reverse-proxy untuk membatasi akses dan otorisasi port </p><br><br><p>  Saat ini tidak digunakan di sirkuit. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://nginx.org/en/download.html</a> </p><br></td><td><p>  <a href="">https://nginx.org/download/nginx-1.16.0.tar.gz</a> </p><br></td></tr><tr><td><p>  Filebeat </p><br></td><td><p>  Transfer log file. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> (distribusi untuk Windows 64bit). </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Pengumpul log. </p><br><br><p>  Digunakan untuk mengumpulkan log dari FileBeat, serta untuk mengumpulkan log dari antrian RabbitMQ (untuk server yang ada di DMZ.) </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Logstash- output- clickhouse </p><br></td><td><p>  Plugin Loagstash untuk mentransfer log ke database ClickHouse dalam batch </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a> </p><br></td><td><p>  / usr / share / logstash / bin / logstash-plugin instal logstash-output-clickhouse </p><br><p>  / usr / share / logstash / bin / logstash-plugin instal logstash-filter-prune </p><br><p>  / usr / share / logstash / bin / logstash-plugin pasang logstash-filter-multiline </p><br></td></tr><tr><td><p>  Clickhouse </p><br></td><td><p>  Log repositori <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://clickhouse.yandex/docs/ru/</a> </p><br></td><td><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  Catatan  Sejak Agustus 2018, rakitan rpm "normal" untuk RHEL telah muncul di repositori Yandex, sehingga Anda dapat mencoba menggunakannya.  Pada saat instalasi, kami menggunakan paket yang dikompilasi oleh Altinity. </p><br></td></tr><tr><td><p>  Grafana </p><br></td><td><p>  Visualisasi log.  Konfigurasikan Dasbor </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://grafana.com/</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://grafana.com/grafana/download</a> </p><br><br><p>  Redhat &amp; Centos (64 Bit) - Versi Terbaru </p><br></td></tr><tr><td><p>  Sumber data ClickHouse untuk Grafana 4.6+ </p><br></td><td><p>  Plugin Grafana dengan sumber data ClickHouse </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/download</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Log router dari FileBeat ke antrian RabbitMQ. </p><br><p>  Catatan  Sayangnya, FileBeat tidak memiliki output langsung di RabbitMQ, jadi diperlukan tautan lanjutan dalam bentuk Logstash </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Rabbitmq </p><br></td><td><p>  Antrian pesan  Ini adalah buffer entri log di DMZ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.rabbitmq.com/download.html</a> </p><br></td><td><p>  <a href="">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a> </p><br></td></tr><tr><td><p>  Erlang Runtime (Diperlukan untuk RabbitMQ) </p><br></td><td><p>  Erlang runtime.  Diperlukan untuk RabbitMQ untuk bekerja </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://www.erlang.org/download.html</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="">http://www.erlang.org/downloads/21.3</a> </p><br></td></tr></tbody></table></div><br></div></div><br>  Konfigurasi server dengan database ClickHouse disajikan dalam tabel berikut: <br><div class="scrollable-table"><table><tbody><tr><td>  <b>Judul</b> <br></td><td>  <b>Nilai</b> <br></td><td>  <b>Catatan</b> <br></td></tr><tr><td><p>  Konfigurasi </p><br></td><td><p>  HDD: 40GB <br>  RAM: 8GB <br>  Prosesor: Core 2 2Ghz </p><br></td><td><p>  Penting untuk memperhatikan tips tentang cara mengoperasikan database ClickHouse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://clickhouse.yandex/docs/ru/operations/tips/</a> ) </p><br></td></tr><tr><td><p>  Perangkat lunak seluruh sistem </p><br></td><td><p>  OS: Server Red Hat Enterprise Linux (Maipo) </p><br><p>  JRE (Java 8) </p><br></td><td><p></p><br></td></tr></tbody></table></div><br>  Seperti yang Anda lihat, ini adalah workstation biasa. <br><br>  Struktur tabel untuk menyimpan log adalah sebagai berikut: <br><br><div class="spoiler">  <b class="spoiler_title">log_web.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_web ( logdate <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, logdatetime DateTime CODEC(Delta, LZ4HC), fld_log_file_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_server_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_module LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_website_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), serverIP LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), method LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), uriStem <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, uriQuery <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, port UInt32, username LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), clientIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, clientRealIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, userAgent <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, subresponse <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, win32response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, timetaken UInt64 , uriQuery__utm_medium <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_source <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_campaign <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_term <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_content <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__yclid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__region <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> = MergeTree() <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> toYYYYMM(logdate) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (fld_app_name, fld_app_module, logdatetime) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">8192</span></span>;</code> </pre> <br></div></div><br>  Kami menggunakan nilai default untuk mempartisi (berdasarkan bulan) dan rincian indeks.  Semua bidang praktis sesuai dengan entri log IIS untuk mendaftarkan permintaan http.  Secara terpisah, bidang terpisah untuk menyimpan tag utm (mereka diuraikan pada tahap penyisipan ke tabel dari bidang string kueri). <br><br>  Juga dalam tabel ditambahkan beberapa bidang sistem untuk menyimpan informasi tentang sistem, komponen, server.  Lihat tabel di bawah ini untuk deskripsi bidang ini.  Dalam satu tabel, kami menyimpan log untuk beberapa sistem. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>Judul</b> <br></td><td>  <b>Deskripsi</b> <br></td><td>  <b>Contoh</b> <br></td></tr><tr><td><p>  fld_app_name </p><br></td><td><p>  Nama Aplikasi / Sistem <br>  Nilai Valid: </p><br><ul><li>  site1.domain.com Situs eksternal 1 </li><li>  site2.domain.com Situs eksternal 2 </li><li>  internal-site1.domain.local Situs internal 1 </li></ul><br></td><td>  site1.domain.com <br></td></tr><tr><td><p>  fld_app_module </p><br></td><td><p>  Modul sistem <br>  Nilai Valid: </p><br><ul><li>  web - Situs web </li><li>  svc - Layanan situs web </li><li>  intgr - Layanan Integrasi Web </li><li>  bo - Admin (BackOffice) </li></ul><br></td><td><p>  web </p><br></td></tr><tr><td><p>  fld_website_name </p><br></td><td><p>  Nama situs web di IIS </p><br><p>  Beberapa sistem dapat digunakan pada satu server, atau bahkan beberapa contoh satu modul sistem </p><br></td><td><p>  web-main </p><br></td></tr><tr><td><p>  fld_server_name </p><br></td><td><p>  Nama server </p><br></td><td><p>  web1.domain.com </p><br></td></tr><tr><td><p>  fld_log_file_name </p><br></td><td><p>  Jalur ke file log di server </p><br></td><td>  C: \ inetpub \ logs \ LogFiles <br>  \ W3SVC1 \ u_ex190711.log <br></td></tr></tbody></table></div><br>  Ini memungkinkan Anda membangun grafik secara efektif di Grafana.  Misalnya, melihat permintaan dari frontend sistem tertentu.  Ini mirip dengan penghitung situs di Yandex.Metrica. <br><br>  Berikut adalah beberapa statistik tentang penggunaan basis data selama dua bulan. <br><br><div class="spoiler">  <b class="spoiler_title">Jumlah catatan berdasarkan sistem dan komponen</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fld_app_name, fld_app_module, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(fld_app_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rows_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> log_web <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name, fld_app_module <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TOTALS <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, rows_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> ┌─fld_app_name─────┬─fld_app_module─┬─rows_count─┐ │ site1.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">131441</span></span> │ │ site2.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">1751081</span></span> │ │ site3.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">106887543</span></span> │ │ site3.domain.ru │ svc │ <span class="hljs-number"><span class="hljs-number">44908603</span></span> │ │ site3.domain.ru │ intgr │ <span class="hljs-number"><span class="hljs-number">9813911</span></span> │ │ site4.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">772095</span></span> │ │ site5.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">17037221</span></span> │ │ site5.domain.ru │ intgr │ <span class="hljs-number"><span class="hljs-number">838559</span></span> │ │ site5.domain.ru │ bo │ <span class="hljs-number"><span class="hljs-number">7404</span></span> │ │ site6.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">595877</span></span> │ │ site7.domain.ru │ web │ <span class="hljs-number"><span class="hljs-number">27778858</span></span> │ └──────────────────┴────────────────┴────────────┘ Totals: ┌─fld_app_name─┬─fld_app_module─┬─rows_count─┐ │ │ │ <span class="hljs-number"><span class="hljs-number">210522593</span></span> │ └──────────────┴────────────────┴────────────┘ <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">4.874</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">210.52</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">421.67</span></span> MB (<span class="hljs-number"><span class="hljs-number">43.19</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">86.51</span></span> MB/s.)</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">Jumlah data pada disk</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_uncompressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_compressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_rows <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.parts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ┌─uncompressed─┬─compressed─┬─total_rows─┐ │ <span class="hljs-number"><span class="hljs-number">54.50</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">4.86</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">211427094</span></span> │ └──────────────┴────────────┴────────────┘ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">Tingkat kompresi data dalam kolom</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(data_compressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compress_ratio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ┌─<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>───────────────────┬─uncompressed─┬─compressed─┬─────compress_ratio─┐ │ logdate │ <span class="hljs-number"><span class="hljs-number">401.53</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.80</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">223.16665968777315</span></span> │ │ logdatetime │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">35.91</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">22.363966401202305</span></span> │ │ fld_log_file_name │ <span class="hljs-number"><span class="hljs-number">220.66</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">2.60</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">84.99905736932571</span></span> │ │ fld_server_name │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">50.63</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.980924816977078</span></span> │ │ fld_app_name │ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">969.17</span></span> KiB │ <span class="hljs-number"><span class="hljs-number">212.55518183686877</span></span> │ │ fld_app_module │ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">968.60</span></span> KiB │ <span class="hljs-number"><span class="hljs-number">212.67805817411906</span></span> │ │ fld_website_name │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.24</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">162.7204926761546</span></span> │ │ serverIP │ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">50.25</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">4.010824061219731</span></span> │ │ method │ <span class="hljs-number"><span class="hljs-number">201.53</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">43.64</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">4.617721053304486</span></span> │ │ uriStem │ <span class="hljs-number"><span class="hljs-number">5.13</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">832.51</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">6.311522291936919</span></span> │ │ uriQuery │ <span class="hljs-number"><span class="hljs-number">2.58</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">501.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.269731450124478</span></span> │ │ port │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.98</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">201.91673864241824</span></span> │ │ username │ <span class="hljs-number"><span class="hljs-number">318.08</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">26.93</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">11.812513794583598</span></span> │ │ clientIP │ <span class="hljs-number"><span class="hljs-number">2.35</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">82.59</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">29.132328640073343</span></span> │ │ clientRealIP │ <span class="hljs-number"><span class="hljs-number">2.49</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">465.05</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.478382297052563</span></span> │ │ userAgent │ <span class="hljs-number"><span class="hljs-number">18.34</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">764.08</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">24.57905114484208</span></span> │ │ referer │ <span class="hljs-number"><span class="hljs-number">14.71</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">1.37</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">10.736792723669906</span></span> │ │ response │ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">83.81</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">9.582334090987247</span></span> │ │ subresponse │ <span class="hljs-number"><span class="hljs-number">399.87</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">1.83</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">218.4831068635027</span></span> │ │ win32response │ <span class="hljs-number"><span class="hljs-number">407.86</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">7.41</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">55.050315514606815</span></span> │ │ timetaken │ <span class="hljs-number"><span class="hljs-number">1.57</span></span> GiB │ <span class="hljs-number"><span class="hljs-number">402.06</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">3.9947395692010637</span></span> │ │ uriQuery__utm_medium │ <span class="hljs-number"><span class="hljs-number">208.17</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">12.29</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.936148912472955</span></span> │ │ uriQuery__utm_source │ <span class="hljs-number"><span class="hljs-number">215.18</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">13.00</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.548367623199912</span></span> │ │ uriQuery__utm_campaign │ <span class="hljs-number"><span class="hljs-number">381.46</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">37.94</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">10.055156353418509</span></span> │ │ uriQuery__utm_term │ <span class="hljs-number"><span class="hljs-number">231.82</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">10.78</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">21.502540454070672</span></span> │ │ uriQuery__utm_content │ <span class="hljs-number"><span class="hljs-number">441.34</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">87.60</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">5.038260760449327</span></span> │ │ uriQuery__yclid │ <span class="hljs-number"><span class="hljs-number">216.88</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">16.58</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">13.07721335008116</span></span> │ │ uriQuery__region │ <span class="hljs-number"><span class="hljs-number">204.35</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">9.49</span></span> MiB │ <span class="hljs-number"><span class="hljs-number">21.52661903446796</span></span> │ └────────────────────────┴──────────────┴────────────┴────────────────────┘ <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.005</span></span> sec.</code> </pre> <br></div></div><br><h4>  Deskripsi komponen yang digunakan <br><br>  FileBeat.  Transfer File Log </h4><br>  Komponen ini memonitor perubahan dalam file log pada disk dan mentransfer informasi ke LogStash.  Itu diinstal pada semua server di mana file log ditulis (biasanya IIS).  Ini bekerja dalam mode ekor (mis., Hanya mentransfer catatan yang ditambahkan ke file).  Namun secara terpisah, Anda dapat mengonfigurasi seluruh transfer file.  Ini berguna ketika Anda perlu mengunduh data dari bulan-bulan sebelumnya.  Cukup masukkan file log dalam folder dan dia akan membacanya secara keseluruhan. <br><br>  Ketika layanan berhenti, data tidak lagi ditransfer ke penyimpanan. <br><br>  Contoh konfigurasi adalah sebagai berikut: <br><br><div class="spoiler">  <b class="spoiler_title">filebeat.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs">filebeat.inputs: - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment"><span class="hljs-comment">/*.log exclude_files: ['.gz$','.zip$'] tail_files: true ignore_older: 24h fields: fld_server_name: "site1.domain.ru" fld_app_name: "site1.domain.ru" fld_app_module: "web" fld_website_name: "web-main" - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/__Import/access_log-* exclude_files: ['.gz$','.zip$'] tail_files: false fields: fld_server_name: "site2.domain.ru" fld_app_name: "site2.domain.ru" fld_app_module: "web" fld_website_name: "web-main" fld_logformat: "logformat__apache" filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false reload.period: 2s output.logstash: hosts: ["log.domain.com:5044"] ssl.enabled: true ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"] ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer" ssl.key: "C:/filebeat/certs/site1.domain.ru.key" #================================ Processors ===================================== processors: - add_host_metadata: ~ - add_cloud_metadata: ~</span></span></code> </pre> <br></div></div><br><h4>  LogStash  Pengumpul log </h4><br>  Komponen ini dimaksudkan untuk menerima entri log dari FileBeat (atau melalui antrian RabbitMQ), mem-parsing dan menyisipkan bundel ke dalam database ClickHouse. <br><br>  Untuk memasukkan ke dalam ClickHouse, plugin Logstash-output-clickhouse digunakan.  Plugin Logstash memiliki mekanisme untuk mengambil permintaan, tetapi dengan shutdown reguler, lebih baik menghentikan layanan itu sendiri.  Ketika Anda berhenti, pesan akan terakumulasi dalam antrian RabbitMQ, jadi jika Anda berhenti untuk waktu yang lama, maka lebih baik menghentikan Filebeats di server.  Dalam skema di mana RabbitMQ tidak digunakan (pada jaringan lokal, Filebeat mengirim log langsung ke Logstash), Filebeats bekerja dengan cukup dapat diterima dan aman, sehingga bagi mereka ketidaktercapaian output tidak akan berdampak. <br><br>  Contoh konfigurasi adalah sebagai berikut: <br><br><div class="spoiler">  <b class="spoiler_title">log_web__filebeat_clickhouse.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"] ssl_certificate =&gt; "/etc/logstash/certs/server.cer" ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key" ssl_verify_mode =&gt; "peer" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } rabbitmq { host =&gt; "queue.domain.com" port =&gt; 5671 user =&gt; "q-reader" password =&gt; "password" queue =&gt; "web_log" heartbeat =&gt; 30 durable =&gt; true ssl =&gt; true <span class="hljs-comment"><span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12" #ssl_certificate_password =&gt; "password" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } } filter { if [message] =~ "^#" { drop {} } if [fld_logformat] == "logformat__iis_with_xrealip" { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"] } } else { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"] } } date { match =&gt; [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ] timezone =&gt; "Etc/UTC" remove_field =&gt; [ "log_timestamp", "@timestamp" ] target =&gt; [ "log_timestamp2" ] } ruby { code =&gt; "tstamp = event.get('log_timestamp2').to_i event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S')) event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))" } if [bytesSent] { ruby { code =&gt; "event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0" } } if [bytesReceived] { ruby { code =&gt; "event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0" } } ruby { code =&gt; "event.set('clientRealIP', event.get('clientIP'))" } if [xrealIP] { ruby { code =&gt; "event.set('clientRealIP', event.get('xrealIP'))" } } if [xforwarderfor] { ruby { code =&gt; "event.set('clientRealIP', event.get('xforwarderfor'))" } } mutate { convert =&gt; ["bytesSent", "integer"] convert =&gt; ["bytesReceived", "integer"] convert =&gt; ["timetaken", "integer"] convert =&gt; ["port", "integer"] add_field =&gt; { "clientHostname" =&gt; "%{clientIP}" } } useragent { source=&gt; "useragent" prefix=&gt; "browser" } kv { source =&gt; "uriQuery" prefix =&gt; "uriQuery__" allow_duplicate_values =&gt; false field_split =&gt; "&amp;" include_keys =&gt; [ "utm_medium", "utm_source", "utm_campaign", "utm_term", "utm_content", "yclid", "region" ] } mutate { join =&gt; { "uriQuery__utm_source" =&gt; "," } join =&gt; { "uriQuery__utm_medium" =&gt; "," } join =&gt; { "uriQuery__utm_campaign" =&gt; "," } join =&gt; { "uriQuery__utm_term" =&gt; "," } join =&gt; { "uriQuery__utm_content" =&gt; "," } join =&gt; { "uriQuery__yclid" =&gt; "," } join =&gt; { "uriQuery__region" =&gt; "," } } } output { #stdout {codec =&gt; rubydebug} clickhouse { headers =&gt; ["Authorization", "Basic abcdsfks..."] http_hosts =&gt; ["http://127.0.0.1:8123"] save_dir =&gt; "/etc/logstash/tmp" table =&gt; "log_web" request_tolerance =&gt; 1 flush_size =&gt; 10000 idle_flush_time =&gt; 1 mutations =&gt; { "fld_log_file_name" =&gt; "fld_log_file_name" "fld_server_name" =&gt; "fld_server_name" "fld_app_name" =&gt; "fld_app_name" "fld_app_module" =&gt; "fld_app_module" "fld_website_name" =&gt; "fld_website_name" "logdatetime" =&gt; "logdatetime" "logdate" =&gt; "logdate" "serverIP" =&gt; "serverIP" "method" =&gt; "method" "uriStem" =&gt; "uriStem" "uriQuery" =&gt; "uriQuery" "port" =&gt; "port" "username" =&gt; "username" "clientIP" =&gt; "clientIP" "clientRealIP" =&gt; "clientRealIP" "userAgent" =&gt; "userAgent" "referer" =&gt; "referer" "response" =&gt; "response" "subresponse" =&gt; "subresponse" "win32response" =&gt; "win32response" "timetaken" =&gt; "timetaken" "uriQuery__utm_medium" =&gt; "uriQuery__utm_medium" "uriQuery__utm_source" =&gt; "uriQuery__utm_source" "uriQuery__utm_campaign" =&gt; "uriQuery__utm_campaign" "uriQuery__utm_term" =&gt; "uriQuery__utm_term" "uriQuery__utm_content" =&gt; "uriQuery__utm_content" "uriQuery__yclid" =&gt; "uriQuery__yclid" "uriQuery__region" =&gt; "uriQuery__region" } } }</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">pipelines.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple. # For more information on multiple pipelines, see the documentation: # https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html - pipeline.id: log_web__filebeat_clickhouse path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</span></span></code> </pre> <br></div></div><br><h4>  ClickHouse.  Penyimpanan log </h4><br>  Log untuk semua sistem disimpan dalam satu tabel (lihat bagian awal artikel).  Ini dimaksudkan untuk menyimpan informasi tentang permintaan: semua parameter serupa untuk format yang berbeda, misalnya, log IIS, apache, dan log nginx.  Untuk log aplikasi yang, misalnya, kesalahan, pesan informasi, peringatan dicatat, tabel terpisah akan disediakan dengan struktur yang sesuai (sekarang pada tahap desain). <br><br>  Saat mendesain tabel, sangat penting untuk menentukan kunci utama (dimana data akan diurutkan selama penyimpanan).  Tingkat kompresi data dan kecepatan kueri bergantung pada ini.  Dalam contoh kita, kuncinya adalah <br>  ORDER BY (fld_app_name, fld_app_module, logdatetime) <br>  Yaitu, dengan nama sistem, nama komponen sistem dan tanggal acara.  Tanggal asli acara berada di tempat pertama.  Setelah memindahkannya ke tempat terakhir, kueri mulai bekerja sekitar dua kali lebih cepat.  Mengubah kunci utama akan membutuhkan pembuatan ulang tabel dan memuat ulang data sehingga ClickHouse akan mengurutkan kembali data pada disk.  Ini adalah operasi yang sulit, sehingga disarankan untuk memikirkan sebelumnya apa yang harus dimasukkan dalam kunci sortir. <br><br>  Juga harus dicatat bahwa dalam versi terbaru jenis data LowCardinality telah muncul.  Saat menggunakannya, ukuran data terkompresi berkurang tajam untuk bidang-bidang yang memiliki kardinalitas rendah (beberapa opsi). <br><br>  Sekarang versi 19.6 digunakan, dan kami berencana untuk mencoba memperbarui versi ke yang terbaru.  Mereka termasuk fitur luar biasa seperti Adaptive Granularity, Melewati indeks dan codec DoubleDelta, misalnya. <br><br>  Secara default, selama instalasi, level log konfigurasi diatur untuk dilacak.  Log diputar dan diarsipkan, tetapi diperluas hingga satu gigabyte.  Jika tidak perlu, maka Anda dapat mengatur tingkat peringatan, maka ukuran log berkurang tajam.  Pengaturan pencatatan diatur dalam file config.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Beberapa perintah yang bermanfaat</b> <div class="spoiler_text"><pre> <code class="sql hljs">      Debian,     Linux      Altinity.           : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-clickhouse sudo yum <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clickhouse-server.noarch <span class="hljs-number"><span class="hljs-number">1.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>        (   <span class="hljs-string"><span class="hljs-string">";"</span></span>) clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--multiline clickhouse-client --multiline --host 127.0.0.1 --password pa55w0rd clickhouse-client --multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd                /tmp/log_web_failed.json            : clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json sudo clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json     quit; ##  TLS https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2 openssl s_client -connect log.domain.com:9440 &lt; /dev/null</span></span></code> </pre> <br></div></div><br><h4>  LogStash  Router log FileBeat ke antrian RabbitMQ </h4><br>  Komponen ini digunakan untuk merutekan log yang berasal dari FileBeat ke antrian RabbitMQ.  Ada dua poin: <br><br><ol><li>  Sayangnya, FileBeat tidak memiliki plugin output untuk menulis langsung ke RabbitMQ.  Dan fungsi seperti itu, dilihat dari ish pada github mereka, tidak direncanakan untuk implementasi.  Ada plugin untuk Kafka, tetapi karena alasan tertentu kita tidak bisa menggunakannya di rumah. </li><li>  Ada persyaratan untuk mengumpulkan log di DMZ.  Berdasarkan pada mereka, log pertama-tama harus ditambahkan ke antrian dan kemudian LogStash dari luar membaca entri dari antrian. </li></ol><br>  Oleh karena itu, justru untuk kasus lokasi server di DMZ bahwa Anda harus menggunakan skema yang sedikit rumit.  Contoh konfigurasi adalah sebagai berikut: <br><br><div class="spoiler">  <b class="spoiler_title">iis_w3c_logs__filebeat_rabbitmq.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"] ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer" ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key" ssl_verify_mode =&gt; "peer" } } output { <span class="hljs-comment"><span class="hljs-comment">#stdout {codec =&gt; rubydebug} rabbitmq { host =&gt; "127.0.0.1" port =&gt; 5672 exchange =&gt; "monitor.direct" exchange_type =&gt; "direct" key =&gt; "%{[fields][fld_app_name]}" user =&gt; "q-writer" password =&gt; "password" ssl =&gt; false } }</span></span></code> </pre> <br></div></div><br><h4>  RabbitMQ.  Antrian pesan </h4><br>  Komponen ini digunakan untuk buffer entri log di DMZ.  Perekaman dilakukan melalui sekelompok Filebeat → LogStash.  Membaca dilakukan dari luar DMZ melalui LogStash.  Saat beroperasi melalui RabboitMQ, sekitar 4 ribu pesan diproses per detik. <br><br>  Perutean pesan dikonfigurasikan sesuai dengan nama sistem, yaitu berdasarkan data konfigurasi FileBeat.  Semua pesan terbagi dalam satu antrian.  Jika, karena alasan apa pun, layanan antrian dihentikan, ini tidak akan menyebabkan hilangnya pesan: FileBeats akan menerima kesalahan koneksi dan menunda pengiriman sementara.  Dan LogStash, yang dibaca dari antrian, juga akan menerima kesalahan jaringan dan menunggu koneksi untuk melanjutkan.  Data, tentu saja, tidak akan lagi ditulis ke dalam basis data. <br><br>  Instruksi berikut digunakan untuk membuat dan mengonfigurasi antrian: <br><br><pre> <code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> <span class="hljs-comment"><span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru" sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></span></code> </pre> <br><h4>  Grafana  Dasbor </h4><br>  Komponen ini digunakan untuk memvisualisasikan data pemantauan.  Dalam hal ini, Anda harus menginstal sumber data ClickHouse untuk plugin Grafana 4.6+.  Kami harus mengubah sedikit untuk meningkatkan efisiensi pemrosesan filter SQL pada dashboard. <br><br>  Misalnya, kami menggunakan variabel, dan jika tidak disetel di bidang filter, kami ingin agar tidak menghasilkan kondisi dalam formulir WHERE (uriStem = `` AND uriStem! = '').  Dalam hal ini, ClickHouse akan membaca kolom uriStem.  Secara umum, kami mencoba berbagai opsi dan akhirnya memperbaiki plugin (macro $ valueIfEmpty) sehingga jika ada nilai kosong, ia akan mengembalikan 1, tanpa menyebutkan kolom itu sendiri. <br><br>  Dan sekarang Anda dapat menggunakan kueri ini untuk bagan <br><br><pre> <code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name') and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%') and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code> </pre> <br>  yang dikonversi ke SQL tersebut (perhatikan bahwa bidang uriStem kosong dikonversi menjadi hanya 1) <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, groupArray((response, c)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> groupArr <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (intDiv(toUInt32(logdatetime), <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, response, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> default.log_web <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (logdate &gt;= toDate(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (logdatetime &gt;= toDateTime(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_name = <span class="hljs-string"><span class="hljs-string">'site1.domain.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_module = <span class="hljs-string"><span class="hljs-string">'web'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t, response <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br><h4>  Kesimpulan </h4><br>  Munculnya database ClickHouse telah menjadi peristiwa penting di pasar.  Sulit membayangkan bahwa gratis dalam sekejap, kami dipersenjatai dengan alat yang kuat dan praktis untuk bekerja dengan data besar.  Tentu saja, dengan meningkatnya kebutuhan (misalnya, sharding dan replikasi ke beberapa server), skema ini akan menjadi lebih kompleks.  Tetapi pada kesan pertama, bekerja dengan database ini sangat bagus.  Dapat dilihat bahwa produk tersebut dibuat "untuk manusia." <br><br>  Dibandingkan dengan ElasticSearch, biaya penyimpanan dan pemrosesan log, menurut perkiraan awal, dikurangi dari lima menjadi sepuluh kali lipat.  Dengan kata lain, jika untuk jumlah data saat ini kita harus mengkonfigurasi sekelompok beberapa mesin, maka ketika menggunakan ClickHouse kita hanya perlu satu mesin berdaya rendah.  Ya, tentu saja, ElasticSearch juga memiliki mekanisme untuk mengompresi data pada disk dan fitur lain yang dapat secara signifikan mengurangi konsumsi sumber daya, tetapi dibandingkan dengan ClickHouse, ini akan mahal. <br><br>  Tanpa optimasi khusus untuk bagiannya, pada pengaturan default, memuat data dan mengambil data dari database bekerja dengan kecepatan luar biasa.  Sejauh ini kami memiliki sedikit data (sekitar 200 juta catatan), tetapi server itu sendiri lemah.  Di masa mendatang, kita dapat menggunakan alat ini untuk tujuan lain yang tidak terkait dengan penyimpanan log.  Misalnya, untuk analitik ujung ke ujung, di bidang keamanan, pembelajaran mesin. <br><br>  Pada akhirnya, sedikit tentang pro dan kontra. <br><br><h4>  Cons </h4><br><ol><li>  Mengunduh catatan dalam bundel besar.  Ini, di satu sisi, adalah fitur, tetapi Anda masih harus menggunakan komponen tambahan untuk merekam buffer.  Tugas ini tidak selalu sederhana, tetapi masih bisa dipecahkan.  Dan saya ingin menyederhanakan skema. </li><li>  Beberapa fungsionalitas eksotis atau fitur baru sering rusak dalam versi baru.  Ini menimbulkan kekhawatiran, mengurangi keinginan untuk meningkatkan ke versi baru.  Misalnya, mesin tabel Kafka adalah fitur yang sangat berguna yang memungkinkan Anda untuk langsung membaca acara dari Kafka, tanpa penerapan konsumen.  Namun dilihat dari banyaknya Isu pada github, kami masih khawatir menggunakan mesin ini dalam produksi.  Namun, jika Anda tidak membuat gerakan tajam ke samping dan menggunakan fungsionalitas dasar, maka itu berfungsi secara stabil. </li></ol><br><h4>  Pro </h4><br><ol><li>  Itu tidak melambat. </li><li>  Ambang entri rendah. </li><li>  Sumber terbuka </li><li>  Ini gratis. </li><li>  Timbangan dengan baik (sharding / replikasi out-of-box) </li><li>  Ini termasuk dalam daftar perangkat lunak Rusia yang direkomendasikan oleh Kementerian Komunikasi. </li><li>  Kehadiran dukungan resmi dari Yandex. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id472912/">https://habr.com/ru/post/id472912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id472896/index.html">Helikopter dari sebuah printer: untuk pertama kalinya, para ilmuwan “mencetak” selembar mesin helikopter berukuran besar</a></li>
<li><a href="../id472902/index.html">Windows for IoT: Dukungan Perangkat Keras yang Disempurnakan dan Fitur Perangkat Cerdas Baru</a></li>
<li><a href="../id472904/index.html">Bagaimana Amazon Mengubah Saham Bekerja menjadi Game</a></li>
<li><a href="../id472908/index.html">Dagaz: Episodes (Bagian 2)</a></li>
<li><a href="../id472910/index.html">Temukan teks pada tanda dan paket menggunakan smartphone</a></li>
<li><a href="../id472916/index.html">Backend, pembelajaran mesin, dan tanpa server adalah yang paling menarik dari konferensi Habr Juli</a></li>
<li><a href="../id472918/index.html">ZX Spectrum di Rusia dan CIS: bagaimana pengejaran online berubah secara offline</a></li>
<li><a href="../id472922/index.html">Programmer defender lebih kuat dari entropi</a></li>
<li><a href="../id472926/index.html">Hukum percepatan pengembalian (bagian 1)</a></li>
<li><a href="../id472928/index.html">Layanan komputasi GPU yang sangat dimuat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>