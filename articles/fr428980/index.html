<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏼 🙅🏽 Ⓜ️ Broker JavaScript hors ligne ♐️ 👨🏾‍🔬 🦔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans mon projet, j'avais besoin d'une fonctionnalité qui me permettrait de ne pas perdre les données saisies en cas de panne de connexion Internet et ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Broker JavaScript hors ligne</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428980/">  Dans mon projet, j'avais besoin d'une fonctionnalité qui me permettrait de ne pas perdre les données saisies en cas de panne de connexion Internet et je suis arrivé avec un "Broker" très simple qui me permettrait de ne pas perdre de données lorsque la connexion était perdue, mais de les envoyer lorsque la connexion est rétablie.  «Courtier» n'est peut-être pas un bon nom pour lui, mais ne jugez pas strictement.  Je veux partager, peut-être que quelqu'un sera utile. <br><a name="habracut"></a><br><h2>  À propos du projet </h2><br>  Mon projet est conçu pour rendre compte des dépenses et des revenus ou comme une simple version de comptabilité à domicile.  Il a été créé en tant qu'application Web progressive, de sorte qu'il est pratique de l'utiliser sur des appareils mobiles, ainsi que pour ouvrir les capacités des notifications Push, accéder à la caméra pour lire les codes-barres, etc.  Il existe une application mobile similaire appelée ZenMoney, mais je voulais quelque chose de moi-même et à ma manière. <br><br><h2>  L'émergence des idées </h2><br>  J'essaie de garder une trace claire des dépenses et des revenus, mais comme on oublie souvent d'ajouter les postes nécessaires, en particulier ceux liés à la trésorerie, je dois le faire presque immédiatement lorsque la "transaction" s'est produite.  Parfois, je saisissais des données dans les transports publics, comme le métro, où les pertes de connexion se produisent souvent, malgré le réseau Wi-Fi très répandu.  C'était dommage que tout se fige et que rien ne se passe, puis les données ont simplement été perdues. <br><br>  L'idée est venue de l'utilisation d'un courtier de file d'attente tel que RabbitMQ.  Bien sûr, j'ai une solution plus simple et moins fonctionnelle, mais il y a quelque chose de similaire à ses principes.  Je pensais que vous pouvez tout enregistrer, par exemple, dans Cache ou LocalStorage en tant qu'objet avec une file d'attente de demandes «non satisfaites», et lorsqu'une connexion apparaît, vous pouvez les exécuter en toute sécurité.  Bien entendu, elles ne sont pas exécutées par ordre de priorité, ce qui, grâce au traitement asynchrone des requêtes en langage JS, est encore meilleur, étant donné que vous n'avez qu'un seul «abonné».  J'ai rencontré quelques difficultés, peut-être même la mise en œuvre de tout cela semblera un peu tordue, mais c'est une solution qui fonctionne.  Bien sûr, il peut être amélioré, mais pour l'instant je vais décrire l'option existante "brute" mais fonctionnelle. <br><br><h2>  Pour commencer </h2><br>  La première chose à laquelle j'ai pensé était de savoir où stocker les données en l'absence de connexion?!  Le service woker imposé par PWA fonctionne bien avec le cache, mais est-il judicieux d'utiliser le cache?!  Une question difficile, je ne vais pas y entrer.  En général, j'ai décidé que LocalStorage est mieux pour moi.  Étant donné que LocalStorage stocke des valeurs de type clé: valeur, l'objet a dû être ajouté en tant que chaîne Json.  Dans mon projet de développement externe, j'ai ajouté un répertoire appelé QueueBroker au dossier de classe <br><br><div class="spoiler">  <b class="spoiler_title">Structure des fichiers</b> <div class="spoiler_text"><code>/**----**/ <br> ├── app.js <br> ├── bootstrap.js <br> ├── classes <br> │  └── QueueBroker <br> │  ├── index.js <br> │  └── Library <br> │  ├── Broker.js <br> │  └── Storage.js <br> ├── components <br> /**----**/ <br></code> <br></div></div><br>  Mon projet est réalisé dans la pile Laravel + VueJs, donc une certaine dépendance de la structure du fichier est requise.  Je ne sais pas comment dans de tels cas il est correct d'appeler vos propres répertoires pour les classes, donc je l'ai fait. <br><br>  Le fichier d'index a été créé pour simplement connecter des modules à partir de la bibliothèque imbriquée.  Ce n'est peut-être pas une solution très élégante, mais je voulais faire en sorte que si je change soudainement d'avis d'utiliser LocalStorage, j'écrirai une autre classe pour Storage avec les mêmes méthodes, la passerai au constructeur du courtier et utiliserai l'autre stockage sans rien changer. <br><br><div class="spoiler">  <b class="spoiler_title">index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Broker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Broker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Storage'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Broker = Broker; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Storage = Storage;</code> </pre><br></div></div><br>  Cette méthode vous permet de connecter uniquement les bibliothèques dont j'ai besoin dans mes scripts, par exemple, si j'ai besoin des deux: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Storage, Broker} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../../classes/QueueBroker/index'</span></span>;</code> </pre><br>  Pour faciliter la modification de la classe de stockage, j'ai créé une sorte de constructeur pour la classe Broker, dans lequel l'objet Storage pourrait être passé en argument, l'essentiel est qu'il possède les fonctions nécessaires.  Je sais que sur ES6 je pouvais écrire classe et constructeur, mais j'ai décidé de le faire à l'ancienne - prototype.  Je vais écrire des commentaires directement par code: <br><br><div class="spoiler">  <b class="spoiler_title">Broker.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> axios = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'axios'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  axios /*     .    ,            front-end  */ function Broker(storage, prefix='storageKey') { this.storage = storage; this.prefix = prefix; /*     ,      .   storage   add     json */ if(this.storage.get('broker') === null) { this.broker = {}; this.storage.add('broker', this.broker) } else { //  , Storage    Json            this.broker = this.storage.getObject('broker'); } }; // ,           Broker.prototype.queueCount = function () { return Object.keys(this.broker).length; }; //  ""    Storage,    Broker.prototype.saveToStorage = function (method, url, data) { let key = this.prefix + '_' + (Object.keys(this.broker).length + 1); this.broker[key] = {method, url, data}; //            broker,        this.storage.add('broker', this.broker); }; // ,    ,    Broker.prototype.run = function () { for (let key in this.broker) { this.sendToServer(this.broker[key], key) } } /*    .        ,     method, url  data,        ,    ,    */ Broker.prototype.sendToServer = function (object, brokerKey) { axios({ method: object.method, url: object.url, data: object.data, }) .then(response =&gt; { if(response.data.status == 200) { //   ,    delete this.broker[brokerKey]; //  this.storage.add('broker', this.broker); } else { //   ;-) console.log(response.data) } }) .catch(error =&gt; { /*           ,       */ }); }; //   export module.exports = Broker;</span></span></code> </pre><br></div></div><br>  Ensuite, vous avez besoin de l'objet de stockage lui-même, qui enregistrera et récupérera tout avec succès du stockage <br><br><div class="spoiler">  <b class="spoiler_title">Storage.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  debug-   function Storage(debug) { if(debug === true) { this.debugMode = true; } this.storage = window.localStorage; }; // ,     Json      Storage.prototype.addObjectToStorage = function (key, object) { this.storage.setItem(key, JSON.stringify(object)); }; //    (,   ) Storage.prototype.addStringToStorage = function (key, value) { this.storage.setItem(key, value); }; //    Storage.prototype.get = function (key) { return this.storage.getItem(key); }; //    Json ,       Storage.prototype.getObject = function (key) { try { return JSON.parse(this.storage.getItem(key)); } catch (e) { this._debug(e); this._debug(key + ' = ' + this.storage.getItem(key)); return false; } }; /* ,     ,  ,        ,   Json      */ Storage.prototype.add = function (key, value) { try { if(typeof value === 'object') { this.addObjectToStorage(key, value); } else if (typeof value === 'string' || typeof value === 'number') { this.addStringToStorage(key, value); } else { //    this._debug('2 parameter does not belong to a known type') } return this.storage; } catch (e) { //    ,    ,    if (e === QUOTA_EXCEEDED_ERR) { this._debug('LocalStorage is exceeded the free space limit') } else { this._debug(e) } } }; //  Storage.prototype.clear = function () { try { this.storage.clear(); return true; } catch (e) { this._debug(e) return false; } }; //    Storage.prototype.delete = function(key) { try { this.storage.removeItem(key); return true; } catch (e) { this._debug(e) return false; } }; // ,      Storage.prototype._debug = function(error) { if(this.debugMode) { console.error(error); } return null; }; //   module.exports = Storage;</span></span></code> </pre><br></div></div><br>  Lorsque tout ce qui précède sera prêt, cela peut être utilisé à votre discrétion, je l'utilise comme ceci: <br><br><div class="spoiler">  <b class="spoiler_title">Utiliser lors de l'enregistrement</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue (methods) /*----*/ //      Storage   sendBroker(method, url, data) { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); broker.saveToStorage(method, url, data); }, //     fundsSave() { let url = '/pa/funds'; let method = ''; if(this.fundsFormType === 'create') { method = 'post'; } else if(this.fundsFormType === 'update') { method = 'put'; } else if(this.fundsFormType === 'delete') { method = 'delete'; } this.$store.commit('setPreloader', true); axios({ method: method, url: url, data: this.fundsFormData, }) .then(response=&gt; { if(response.data.status == 200) { this.fundsFormShow = false; this.getFunds(); this.$store.commit('setPreloader', false); } else { this.$store.commit('AlertError', '    '); } }) //        .catch(error =&gt; { this.$store.commit('setAlert', { type: 'warning', status: true, message: '   . ,        ,   ' } ); this.fundsFormShow = false; this.$store.commit('setPreloader', false); //   ""  this.sendBroker(method, url, this.fundsFormData); console.error(error); }); },</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Utiliser lors de la reconnexion</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue /*--*/ methods: { /*----*/ /*   ,    ,   ,      ,      */ brokerSendRun() { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); //,   -   if(broker.queueCount() &gt; 0) { // ,    broker.run(); //   ,   this.$store.commit('setAlert', {type: 'info', status: true, message: '      -  , ,      '}); } } } /*---*/ /*     , ,   ,          ,     ,        */ mounted() { this.brokerSendRun(); } /*---*/</span></span></code> </pre><br></div></div><br><h3>  PS </h3><br>  C'est difficile pour moi de parler du code, j'ai donc essayé de fournir le code dans les exemples aussi détaillé que possible avec des commentaires détaillés.  Si vous avez des idées pour améliorer cette solution ou améliorer cet article, je serai heureux de les voir dans les commentaires.  J'ai pris des exemples de mon propre projet sur Vue, je l'explique afin de bien comprendre pourquoi mes méthodes sont ainsi appelées et pourquoi j'y accède par <b>ce</b> biais.  Je ne le fais pas dans cet article spécifiquement sur Vue, donc je ne fournis pas d'autre code de composant, je le laisse pour la compréhension. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428980/">https://habr.com/ru/post/fr428980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428962/index.html">Délocalisation à Luxoft: comment se passe la vie</a></li>
<li><a href="../fr428964/index.html">Les vulnérabilités du SSD chiffré par le matériel permettent aux attaquants de contourner facilement les mesures de protection</a></li>
<li><a href="../fr428972/index.html">Intégration continue dans Yandex</a></li>
<li><a href="../fr428974/index.html">Intéressant à Interlight 2018</a></li>
<li><a href="../fr428976/index.html">Colline de fourmis ou forteresse? Je construis une maison pour le prix d'un appartement. Partie 2: Chauffage</a></li>
<li><a href="../fr428982/index.html">Comment écrire D sur ARM</a></li>
<li><a href="../fr428984/index.html">Julia et portraits de phases de systèmes dynamiques</a></li>
<li><a href="../fr428986/index.html">Conférence ThinkJava n ° 8 à Kharkov</a></li>
<li><a href="../fr428988/index.html">Conseils nature - Veilleuse nuageuse</a></li>
<li><a href="../fr428990/index.html">Exemples de configuration d'UIViewControllers utilisant RouteComposer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>