<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>โญ๏ธ ๐ฅ ๐จโ๐ฉโ๐งโ๐ง ุชูุตูู CryptoPro ุจู Mono ๐คข โ๏ธ ๐ช๐พ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูููุง ูุชุนูู ุจุงูุงูุชูุงู ุฅูู Linux ุ ุฃุตุจุญ ูู ุงูุถุฑูุฑู ููู ุฃุญุฏ ุฃูุธูุฉ ุงูุฎุงุฏู ุงูุฎุงุตุฉ ุจูุง ุงูููุชูุจุฉ ุจูุบุฉ C # ุฅูู Mono. ูุนูู ุงููุธุงู ูุน ุงูุชูููุนุงุช ุงูุฑูููุฉ ุงููุญุณูุฉ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุชูุตูู CryptoPro ุจู Mono</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423163/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ูููุง ูุชุนูู ุจุงูุงูุชูุงู ุฅูู Linux ุ ุฃุตุจุญ ูู ุงูุถุฑูุฑู ููู ุฃุญุฏ ุฃูุธูุฉ ุงูุฎุงุฏู ุงูุฎุงุตุฉ ุจูุง ุงูููุชูุจุฉ ุจูุบุฉ C # ุฅูู Mono.  ูุนูู ุงููุธุงู ูุน ุงูุชูููุนุงุช ุงูุฑูููุฉ ุงููุญุณูุฉ ุ ูุฐูู ูุงูุช ุฅุญุฏู ุงูููุงู ุงูุชู ูุงุฌููุงูุง ูู ุงุฎุชุจุงุฑ ุฃุฏุงุก ุดูุงุฏุงุช GOST ูู CryptoPro ุฃุญุงุฏูุฉ.  ูุงูุช CryptoPro ููุณูุง ุจุชุทุจูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CSP</a> ููุธุงู ุงูุชุดุบูู Linux ูุจุนุถ ุงูููุช ุ ููู ุงููุญุงููุฉ ุงูุฃููู ูุงุณุชุฎุฏุงูู ุฃุธูุฑุช ุฃู ูุฆุงุช ุชุดููุฑ Mono ุงูุฃุตููุฉ (ุนูู ุบุฑุงุฑ ุชูู ุงูููุฌูุฏุฉ ูู ุงููุงุนุฏุฉ. Net - X509Store ุ X509Certificate2 ุ ุฅูุฎ) ูุง ุชุนูู ููุท ูุน ููุงุชูุญ ุงูุถูู ุ ุจู ุฅููุง ุฃูุถูุง ูุง ุชุฑุงูู ูู ุฎุฒุงุฆููู.  ููุชูุฌุฉ ูุฐูู ุ ูุงู ูุง ุจุฏ ูู ุฑุจุท ุงูุนูู ูุน ุงูุชุดููุฑ ูุจุงุดุฑุฉ ูู ุฎูุงู ููุชุจุงุช CryptoPro. </p><br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  ุชุซุจูุช ุงูุดูุงุฏุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูุจู ุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุ ูุฌุจ ุชุซุจูุช ุงูุดูุงุฏุฉ ูุงูุชุฃูุฏ ูู ุฃููุง ุชุนูู ุจุดูู ุฌูุฏ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชุซุจูุช ุงูุดูุงุฏุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุชู ุชุซุจูุช ุฅุตุฏุงุฑ ูููู CryptoPro CSP 3.9 ุนูู Centos 7 ูู ุงููุฌูุฏ / opt / cprocsp.  ูุชุฌูุจ ุงูุชุนุงุฑุถุงุช ุจูู ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ mono ู CryptoPro ุงูุชู ุชุญูู ุงูุงุณู ููุณู (ุนูู ุณุจูู ุงููุซุงู ุ certmgr) ุ ูู ูุชู ุฅุฏุฎุงู ุงููุณุงุฑ ุฅูู ุงููุฌูุฏ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุชู ุงุณุชุฏุนุงุก ุฌููุน ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ูู ุงููุณุงุฑ ุงููุงูู. </p><br><p style=";text-align:right;direction:rtl"> ุฃููุงู ุ ูุญุฏุฏ ูุงุฆูุฉ ุงููุฑุงุก: <br> <code>/opt/cprocsp/bin/amd64/csptest -enum -info -type PP_ENUMREADERS | iconv -f cp1251</code> </p> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูู ููู ููุงู ูุงุฑุฆ ูู ุงููุฌูุฏ ุงูููุฌูุฏ ุนูู ุงููุฑุต (HDIMAGE) ุถูู ุงููุงุฆูุฉ ุ ูุถุนู: <br> <code>/opt/cprocsp/sbin/amd64/cpconfig -hardware reader -add HDIMAGE store</code> </p> <br><p style=";text-align:right;direction:rtl">  ุซู ููููู ุฅูุดุงุก ุญุงููุงุช ูู ุงููููุฐุฌ '\\. \ HDIMAGE \ {container name}' ุนู ุทุฑูู ุฅูุดุงุก ุญุงููุฉ ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู ุงูููุงุชูุญ: <br> <code>/opt/cprocsp/bin/amd64/csptest -keyset -provtype 75 -newkeyset -cont '\\.\HDIMAGE\test'</code> </p> <br><p style=";text-align:right;direction:rtl">  ุฃู ูู ุฎูุงู ุฅูุดุงุก ูุฌูุฏ / var / opt / cprocsp / keys / root / {container name} .000 ุ ูุงูุฐู ูุญุชูู ุนูู ุงููุฌููุนุฉ ุงูููุงุณูุฉ ูู ูููุงุช ุญุงููุงุช CryptoPro (* .key ุ * .mask ุ ููุง ุฅูู ุฐูู). </p><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ูููู ุชุซุจูุช ุงูุดูุงุฏุฉ ูู ุงูุญุงููุฉ ูู ูุฎุฒู ุงูุดูุงุฏุงุช: <br> <code>/opt/cprocsp/bin/amd64/certmgr -inst mMy -cont '\\.\HDIMAGE\{ }'</code> </p> <br><p style=";text-align:right;direction:rtl">  ูููู ุฑุคูุฉ ุงูุดูุงุฏุฉ ุงููุซุจุชุฉ ุจุงูุฃูุฑ ุงูุชุงูู: <br> <code>/opt/cprocsp/bin/amd64/certmgr -list mMy</code> </p> <br><p style=";text-align:right;direction:rtl">  ูููู ุงูุชุญูู ูู ุชุดุบูู ุงูุดูุงุฏุฉ ุนูู ุงููุญู ุงูุชุงูู: <br> <code>/opt/cprocsp/bin/amd64/cryptcp โ sign -norev -thumbprint {} {} { }</code> <br> <code>/opt/cprocsp/bin/amd64/cryptcp โ verify -norev { }</code> </p> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงู ูู ุดูุก ุนูู ูุง ูุฑุงู ูุน ุงูุดูุงุฏุฉ ุ ูููููู ุงููุชุงุจุนุฉ ุฅูู ุงูุงุชุตุงู ูู ุงูุฑูุฒ. </p><br></div></div><br><h2 style=";text-align:right;direction:rtl">  ุงูุงุชุตุงู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุนูู ุงูุฑุบู ูู ุนูููุฉ ุงูููู ุฅูู Linux ุ ูุงู ูู ุงูููุชุฑุถ ุฃู ูุณุชูุฑ ุงููุธุงู ูู ุงูุนูู ูู ุจูุฆุฉ Windows ุ ูุฐุง ูู ุงูุฎุงุฑุฌ ุ ูุฌุจ ุฃู ูุชู ุงูุนูู ูุน ุงูุชุดููุฑ ูู ุฎูุงู ุงูุทุฑู ุงูุนุงูุฉ ูููููุฐุฌ "byte [] SignData (byte [] _arDataุ X509Certificate2 _pCert)" ุ ูุงูุชู ูุฌุจ ุฃู ุชุนูู ุนูู ูุฏู ุงููุณุงูุงุฉ ุนูู ููููุณ ููุฐูู ุนูู ูููุฏูุฒ. </p><br><p style=";text-align:right;direction:rtl">  ุชุจูู ุฃู ุชุญููู ุทุฑู ููุชุจุงุช ุงูุชุดููุฑ ูุงู ูุงุฌุญูุง ุ ูุฃู CryptoPro ููุฐุช ููุชุจุฉ "libcapi20.so" ุงูุชู ุชุญุงูู ุชูุงููุง ููุชุจุงุช ุงูุชุดููุฑ ุงูููุงุณูุฉ Windows - "crypt32.dll" ู "advapi32.dll".  ุฑุจูุง ุ ุจุงูุทุจุน ุ ููุณ ุชูุงููุง ุ ูููู ุฌููุน ุงูุทุฑู ุงููุงุฒูุฉ ููุนูู ูุน ุงูุชุดููุฑ ูุชููุฑุฉ ููุงู ุ ูุฌููุนูุง ุชูุฑูุจูุง. </p><br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ูููู ุจุชุดููู ูุฆุชูู ุซุงุจุชุชูู "WCryptoAPI" ู "LCryptoAPI" ุ ูู ููููุง ูุณุชูุฑุฏ ุงููุฌููุนุฉ ุงููุงุฒูุฉ ูู ุงูุทุฑู ุนูู ุงููุญู ุงูุชุงูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(LIBCAPI20, SetLastError = true)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CertCloseStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iFlags</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><p style=";text-align:right;direction:rtl">  ูููู ุฅูุดุงุก ุจููุฉ ุงูุงุชุตุงู ููู ุทุฑููุฉ ุจุดูู ูุณุชูู ุ ุฃู ุงุณุชุฎุฏุงู ูููุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">pinvoke ุนูู</a> ุงูููุจ ุ ุฃู ูุณุฎูุง ูู ูุตุงุฏุฑ .Net (ูุฆุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CAPISafe</a> ).  ูู ููุณ ุงููุญุฏุฉ ุงูููุทูุฉ ุ ููููู ุฑุณู ุซูุงุจุช ูููุงูู ูุฑุชุจุทุฉ ุจุงูุชุดููุฑ ุ ูุงูุชู ูุฌุนู ูุฌูุฏูุง ุงูุญูุงุฉ ุฃุณูู ุนูุฏ ุงูุนูู ูุน ููุชุจุงุช ุฎุงุฑุฌูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุซู ูููู ุจุชุดููู ุงููุฆุฉ ุงูุซุงุจุชุฉ "UCryptoAPI" ูุงูุชู ุ ุจูุงุกู ุนูู ุงููุธุงู ุ ุณุชุทูู ุนูู ุทุฑููุฉ ูุงุญุฏุฉ ูู ูุฆุชูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_iFlags"&gt; (  0)&lt;/param&gt; * &lt;param name="_hCertStore"&gt;   &lt;/param&gt; * &lt;returns&gt;   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CertCloseStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iFlags</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LCryptoAPI.CertCloseStore(_hCertStore, _iFlags); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WCryptoAPI.CertCloseStore(_hCertStore, _iFlags); } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fIsLinux { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iPlatform = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Environment.OSVersion.Platform; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (iPlatform == <span class="hljs-number"><span class="hljs-number">4</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">6</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">128</span></span>); } }</code> </pre><br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ุจุงุณุชุฎุฏุงู ุทุฑู ูุฆุฉ UCryptoAPI ุ ููููู ุชูููุฐ ููุฏ ููุญุฏ ุชูุฑูุจูุง ูููุง ุงููุธุงููู. </p><br><h3 style=";text-align:right;direction:rtl">  ุจุญุซ ุงูุดูุงุฏุฉ </h3><br><p style=";text-align:right;direction:rtl">  ูุจุฏุฃ ุงูุนูู ูุน ุงูุชุดููุฑ ุนุงุฏุฉู ุจุงูุจุญุซ ุนู ุดูุงุฏุฉ ุ ููุฐุง ูู crypt32.dll ููุงู ุทุฑููุชุงู CertOpenStore (ููุชุญ ูุชุฌุฑ ุงูุดูุงุฏุงุช ุงููุญุฏุฏ) ู CertOpenSystemStore ุจุณูุทุฉ (ููุชุญ ุงูุดูุงุฏุงุช ุงูุดุฎุตูุฉ ูููุณุชุฎุฏู).  ูุธุฑูุง ูุฃู ุงูุนูู ูุน ุงูุดูุงุฏุงุช ูุง ููุชุตุฑ ุนูู ุดูุงุฏุงุช ุงููุณุชุฎุฏู ุงูุดุฎุตูุฉ ุ ูุฅููุง ูุฑุจุท ุงูุดูุงุฏุฉ ุงูุฃููู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุจุญุซ ุงูุดูุงุฏุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  (   )&lt;/summary&gt; * &lt;param name="_pFindType"&gt; &lt;/param&gt; * &lt;param name="_pFindValue"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_pName"&gt; &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerify"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindCertificateCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _pFindValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser, StoreName _pName = StoreName.My, X509FindType _pFindType = X509FindType.FindByThumbprint, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerify = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hCert = IntPtr.Zero; GCHandle hInternal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GCHandle(); GCHandle hFull = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GCHandle(); IntPtr hSysStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   hSysStore = UCryptoAPI.CertOpenStore(UCConsts.AR_CERT_STORE_PROV_SYSTEM[fIsLinux.ToByte()], UCConsts.PKCS_7_OR_X509_ASN_ENCODING, IntPtr.Zero, UCUtils.MapX509StoreFlags(_pLocation, OpenFlags.ReadOnly), UCConsts.AR_CRYPTO_STORE_NAME[(int)_pName]); if (hSysStore == IntPtr.Zero) { _sError = UCConsts.S_ERR_STORE_OPEN.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 1)     if ((_pFindType == X509FindType.FindByThumbprint) || (_pFindType == X509FindType.FindBySerialNumber)) { byte[] arData = _pFindValue.FromHex(); CRYPTOAPI_BLOB cryptBlob; cryptBlob.cbData = arData.Length; hInternal = GCHandle.Alloc(arData, GCHandleType.Pinned); cryptBlob.pbData = hInternal.AddrOfPinnedObject(); hFull = GCHandle.Alloc(cryptBlob, GCHandleType.Pinned); } else { byte[] arData; if(fIsLinux) arData = Encoding.UTF8.GetBytes(_pFindValue); else arData = Encoding.Unicode.GetBytes(_pFindValue); hFull = GCHandle.Alloc(arData, GCHandleType.Pinned); } // 2)  IntPtr hPrev = IntPtr.Zero; do { hCert = UCryptoAPI.CertFindCertificateInStore(hSysStore, UCConsts.PKCS_7_OR_X509_ASN_ENCODING, 0, UCConsts.AR_CRYPT_FIND_TYPE[(int)_pFindType, fIsLinux.ToByte()], hFull.AddrOfPinnedObject(), hPrev); // 2.1)   if(hPrev != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hPrev); // 2.2)    if(hCert == IntPtr.Zero) return UConsts.E_NO_CERTIFICATE; // 2.3)    X509Certificate2 pCert = new ISDP_X509Cert(hCert); if (!_fVerify || pCert.ISDPVerify()) { hCert = IntPtr.Zero; _pCert = pCert; return UConsts.S_OK; } hPrev = hCert; //    hCert = IntPtr.Zero; } while(hCert != IntPtr.Zero); return UConsts.E_NO_CERTIFICATE; } catch (Exception E) { _sError = UCConsts.S_FIND_CERT_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { //      if(hInternal.IsAllocated) hInternal.Free(); if(hFull.IsAllocated) hFull.Free(); if (hCert != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hCert); UCryptoAPI.CertCloseStore(hSysStore, 0); } }</span></span></code> </pre><br></div></div><br>  ูุชู ุงูุจุญุซ ุนูู ุนุฏุฉ ูุฑุงุญู: <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชุญุฉ ุชุฎุฒูู </li><li style=";text-align:right;direction:rtl">  ุชุดููู ุจููุฉ ุงูุจูุงูุงุช ุงูุชู ูุจุญุซ ุนููุง ุ </li><li style=";text-align:right;direction:rtl">  ุจุญุซ ุงูุดูุงุฏุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ุซู ุงูุชุญูู ูู ุงูุดูุงุฏุฉ (ููุตููุฉ ูู ูุณู ูููุตู) ุ </li><li style=";text-align:right;direction:rtl">  ุฅุบูุงู ุงููุณุชูุฏุน ูุฅุทูุงู ุงููููู ูู ุงูููุทุฉ 2 (ุญูุซ ููุฌุฏ ุนูู ูู ูู ููุงู ุจุฐุงูุฑุฉ ุบูุฑ ููุฏุงุฑุฉ. ุตุงูู ุ ูู ูุชู ุงูููุงู ุจุฃู ุดูุก ูุชูุธููู) ุ </li></ol><br><p style=";text-align:right;direction:rtl">  ููุงู ุจุนุถ ุงูููุงุท ุงูุฏูููุฉ ุนูุฏ ุงูุจุญุซ ุนู ุงูุดูุงุฏุงุช. </p><br><p style=";text-align:right;direction:rtl">  ูุนูู CryptoPro ุนูู Linux ูุน ุณูุงุณู ANSI ุ ูุนูู Windows ูุน UTF8 ุ ูุจุงูุชุงูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนูุฏ ุชูุตูู ุทุฑููุฉ ูุชุญ ุงูุชุฎุฒูู ูู Linux ุ ูู ุงูุถุฑูุฑู ุงูุฅุดุงุฑุฉ ุจูุถูุญ ุฅูู ููุน ุงูุชูุธูู [Inุ MarshalAs (UnmanagedType.LPStr)] ููุนููุฉ ุฑูุฒ ุงูุชุฎุฒูู ุ </li><li style=";text-align:right;direction:rtl">  ุชูุฑูุฑ ุณูุณูุฉ ุงูุจุญุซ (ุนูู ุณุจูู ุงููุซุงู ุ ุจุงุณู ุงูููุถูุน) ูุฌุจ ุชุญูููู ุฅูู ูุฌููุนุฉ ูู ุงูุจุงูุชุงุช ูุน ุชุฑููุฒุงุช ูุฎุชููุฉ ุ </li><li style=";text-align:right;direction:rtl">  ูุฌููุน ุซูุงุจุช ุงูุชุดููุฑ ุงูุชู ููุง ุงุฎุชูุงู ุญุณุจ ููุน ุงูุณูุณูุฉ (ุนูู ุณุจูู ุงููุซุงู ุ CERT_FIND_SUBJECT_STR_A ู CERT_FIND_SUBJECT_STR_W) ูู Windows ุ ูุฌุจ ุนููู ุชุญุฏูุฏ * _W ุ ููู Linux * _A ุ </li></ol><br><p style=";text-align:right;direction:rtl">  ูููู ุฃู ุชุคุฎุฐ ุทุฑููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MapX509StoreFlags</a> ูุจุงุดุฑุฉ ูู ูุตุงุฏุฑ Microsoft ุฏูู ุชุบููุฑุงุช ุ ููู ุจุจุณุงุทุฉ ุชุดูู ููุงุนูุง ููุงุฆููุง ูุนุชูุฏ ุนูู ุฅุดุงุฑุงุช .Net. </p><br><p style=";text-align:right;direction:rtl">  ุชุนุชูุฏ ุงููููุฉ ุงูุชู ูุชู ุจูุง ุงูุจุญุซ ุนูู ููุน ุงูุจุญุซ (ุฑุงุฌุน MSDN ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CertFindCertificateInStore</a> ) ุ ููุถุญ ุงููุซุงู ุงูุฎูุงุฑูู ุงูุฃูุซุฑ ุงุณุชุฎุฏุงููุง - ูุชูุณูู ุงูุณูุณูุฉ (ุฃุณูุงุก ุงูููุถูุน ุ ุฌูุฉ ุงูุฅุตุฏุงุฑ ุ ุฅูุฎ) ูุงูุซูุงุฆู (ุจุตูุฉ ุงูุฅุตุจุน ุ ุงูุฑูู ุงูุชุณูุณูู). </p><br><p style=";text-align:right;direction:rtl">  ุชุฎุชูู ุนูููุฉ ุฅูุดุงุก ุดูุงุฏุฉ ูู IntPtr ุนูู ูุธุงูู ุงูุชุดุบูู Windows ู Linux.  ุณูููู Windows ุจุฅูุดุงุก ุงูุดูุงุฏุฉ ุจุทุฑููุฉ ุจุณูุทุฉ: <br></p><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2(hCert);</code> </pre> <p></p><br><p style=";text-align:right;direction:rtl">  ูู Linux ุ ุนููู ุฅูุดุงุก ุดูุงุฏุฉ ูู ุฎุทูุชูู: <br></p><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">X509Certificate2(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate(hCert));</code> </pre> <p></p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุณุชูุจู ุ ูุญุชุงุฌ ุฅูู ุงููุตูู ุฅูู hCert ููุนูู ุ ููุฌุจ ุชุฎุฒููู ูู ูุงุฆู ุงูุดูุงุฏุฉ.  ูู ูุธุงู ุงูุชุดุบูู Windows ุ ูููู ุงุณุชุฑุฌุงุนูุง ูุงุญููุง ูู ุฎุงุตูุฉ Handle ุ ูููู Linux ูุญูู ุจููุฉ CERT_CONTEXT ุงูุชู ุชุชุจุน ุงุฑุชุจุงุท hCert ุฅูู ุงุฑุชุจุงุท ุฅูู ุจููุฉ x509_st (OpenSSL) ููุณุฌููุง ูู Handle.  ูุฐูู ุ ูู ุงูุฌุฏูุฑ ุฅูุดุงุก ูุฑุงุซุฉ ูู X509Certificate2 (ISDP_X509Cert ูู ุงููุซุงู) ุ ูุงูุชู ุณุชุฎุฒู hCert ูู ููุง ุงููุธุงููู ูู ุญูู ูููุตู. </p><br><p style=";text-align:right;direction:rtl">  ูุง ุชูุณ ุฃู ูุฐุง ุฑุงุจุท ูููุทูุฉ ูู ุงูุฐุงูุฑุฉ ุบูุฑ ุงูููุฏุงุฑุฉ ููุฌุจ ุชุญุฑูุฑูุง ุจุนุฏ ุงูุชูุงุก ุงูุนูู.  ูุฃู  ูู .Net 4.5 X509Certificate2 ูุง ูููู ุงูุชุฎูุต ููู - ูุฌุจ ุฅุฌุฑุงุก ุงูุชูุธูู ุจุงุณุชุฎุฏุงู ุฃุณููุจ CertFreeCertificateContext ูู ุงููุฏูุฑ. </p><br><h3 style=";text-align:right;direction:rtl">  ุชุดููู ุงูุชูููุน </h3><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุนูู ูุน ุดูุงุฏุงุช GOST ุ ูุชู ุฏุงุฆููุง ุงุณุชุฎุฏุงู ุงูุชูููุนุงุช ุบูุฑ ุงููุชุตูุฉ ูุน ุฃุญุฏ ุงููููุนูู.  ูู ุฃุฌู ุฅูุดุงุก ูุซู ูุฐุง ุงูุชูููุน ุ ูุทููุจ ูุชูุฉ ุฑูุฒ ุจุณูุทุฉ ุฅูู ุญุฏ ูุง: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชุดููู ุงูุชูููุน</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_SIGN_MESSAGE_PARA pParams = new CRYPT_SIGN_MESSAGE_PARA(); pParams.cbSize = Marshal.SizeOf(typeof(CRYPT_SIGN_MESSAGE_PARA)); pParams.dwMsgEncodingType = (int)(UCConsts.PKCS_7_OR_X509_ASN_ENCODING); pParams.pSigningCert = _pCert.getRealHandle(); pParams.cMsgCert = 1; pParams.HashAlgorithm.pszObjId = _pCert.getHashAlgirtmOid(); IntPtr pGlobData = Marshal.AllocHGlobal(_arData.Length); GCHandle pGC = GCHandle.Alloc(_pCert.getRealHandle(), GCHandleType.Pinned); try { pParams.rgpMsgCert = pGC.AddrOfPinnedObject(); Marshal.Copy(_arData, 0, pGlobData, _arData.Length); uint iLen = 50000; byte[] arRes = new byte[iLen]; // 1)   if (!UCryptoAPI.CryptSignMessage(ref pParams, true, 1, new IntPtr[1] { pGlobData }, new uint[1] { (uint)_arData.Length }, arRes, ref iLen)) { _sError = UCConsts.S_MAKE_SIGN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } Array.Resize(ref arRes, (int)iLen); _arRes = arRes; return UConsts.S_OK;; } catch (Exception E) { _sError = UCConsts.S_MAKE_SIGN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { pGC.Free(); Marshal.FreeHGlobal(pGlobData); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุฃุซูุงุก ุนูู ุงูุทุฑููุฉ ุ ูุชู ุชุดููู ูููู ูุน ูุนููุงุช ููุชู ุงุณุชุฏุนุงุก ุทุฑููุฉ ุงูุชูููุน.  ูููู ุฃู ุชุณูุญ ูู ุจููุฉ ุงููุนููุฉ ุจุญูุธ ุงูุดูุงุฏุงุช ูู ุงูุชูููุน ูุชุดููู ุณูุณูุฉ ูุงููุฉ (ุญููู cMsgCert ู rgpMsgCert ุ ูุฎุฒู ุงูุฃูู ุนุฏุฏ ุงูุดูุงุฏุงุช ุ ูุงููุงุฆูุฉ ุงูุซุงููุฉ ูุฑูุงุจุท ููุงูู ูุฐู ุงูุดูุงุฏุงุช). </p><br><p style=";text-align:right;direction:rtl">  ูููู ุฃู ุชุชููู ุทุฑููุฉ ุงูุชูููุน ูุซููุฉ ูุงุญุฏุฉ ุฃู ุฃูุซุฑ ููุชูููุน ุงููุชุฒุงูู ูุน ุชูููุน ูุงุญุฏ.  ุจุงูููุงุณุจุฉ ุ ูุฐุง ูุง ูุชุนุงุฑุถ ูุน ุงููุงููู ุงูููุฏุฑุงูู 63 ููู ูุฑูุญ ููุบุงูุฉ ุ ูุฃูู ูู ุบูุฑ ุงููุญุชูู ุฃู ูููู ุงููุณุชุฎุฏู ุณุนูุฏูุง ุจุงูุญุงุฌุฉ ุฅูู ุงูููุฑ ุนูู ุฒุฑ "ุชุณุฌูู" ุนุฏุฉ ูุฑุงุช. </p><br><p style=";text-align:right;direction:rtl">  ุงูุบุฑูุจ ุงูุฑุฆูุณู ูู ูุฐู ุงูุทุฑููุฉ ูู ุฃููุง ูุง ุชุนูู ูู ูุถุน ููุงููุชูู ุ ููู ุฃูุฑ ูููุฐุฌู ููุนุธู ุทุฑู ุงูููุชุจุฉ ุงูุชู ุชุนูู ูุน ูุชู ูุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ (ุงูุฃููู ุฐุงุช ุงููููุฉ ุงูุฎุงููุฉ - ุชุฑุฌุน ุทูู ุงููุฎุฒู ุงููุคูุช ุงููุทููุจ ุ ูุงูุซุงูู ูููุฃ ุงููุฎุฒู ุงููุคูุช).  ูุฐูู ุ ูู ุงูุถุฑูุฑู ุฅูุดุงุก ูุฎุฒู ูุคูุช ูุจูุฑ ุ ุซู ุชูุตูุฑู ุฅูู ุทููู ุงููุนูู. </p><br><p style=";text-align:right;direction:rtl">  ุงููุดููุฉ ุงูุฎุทูุฑุฉ ุงููุญูุฏุฉ ูู ุงูุจุญุซ ุนู OID ูุฎูุงุฑุฒููุฉ ุงูุชุฌุฒุฆุฉ (Digest) ุงููุณุชุฎุฏูุฉ ุนูุฏ ุงูุชูููุน - ูู ุดูู ุตุฑูุญ ููุณ ูู ุงูุดูุงุฏุฉ (ููุงู ููุท ุฎูุงุฑุฒููุฉ ุงูุชูููุน ููุณู).  ูุฅุฐุง ูุงู ุจุฅููุงูู ุชุญุฏูุฏู ุจุณูุณูุฉ ูุงุฑุบุฉ ุนูู ูุธุงู Windows - ุณูุชู ุงูุชูุงุทู ุชููุงุฆููุง ุ ูููู ุณูุฑูุถ Linux ุงูุชูููุน ุฅุฐุง ูู ุชูู ุงูุฎูุงุฑุฒููุฉ ูุชุดุงุจูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูููู ููุงู ุฎุฏุนุฉ - ูู ุงููุนูููุงุช ุญูู ุฎูุงุฑุฒููุฉ ุงูุชูููุน (ุงูุจููุฉ CRYPT_OID_INFO) ูุชู ุชุฎุฒูู OID ููุชูููุน ูู pszOID ุ ููุชู ุชุฎุฒูู ูุนุฑู ุฎูุงุฑุฒููุฉ ุงูุชุฌุฒุฆุฉ ูู Algid.  ูุชุญููู Algid ุฅูู OID ูู ุฃูุฑ ุชููู ุจุงููุนู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุญุตูู ุนูู OID ูุฎูุงุฑุฒููุฉ ุงูุชุฌุฒุฆุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OID   &lt;/summary&gt; * &lt;param name="_hCertHandle"&gt; &lt;/param&gt; * &lt;param name="_sOID"&gt;  OID&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashAlgoritmOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sOID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _sOID = <span class="hljs-string"><span class="hljs-string">""</span></span>; IntPtr hHashAlgInfo = IntPtr.Zero; IntPtr hData = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CERT_CONTEXT pContext = (CERT_CONTEXT)Marshal.PtrToStructure(_hCertHandle, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CONTEXT)); CERT_INFO pCertInfo = (CERT_INFO)Marshal.PtrToStructure(pContext.pCertInfo, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_INFO)); <span class="hljs-comment"><span class="hljs-comment">//  AlgID //  UCryptoAPI.CertAlgIdToOID  Windows   ,   byte[] arData = BitConverter.GetBytes(UCryptoAPI.CertOIDToAlgId(pCertInfo.SignatureAlgorithm.pszObjId)); hData = Marshal.AllocHGlobal(arData.Length); Marshal.Copy(arData, 0, hData, arData.Length); //  OID hHashAlgInfo = UCryptoAPI.CryptFindOIDInfo(UCConsts.CRYPT_OID_INFO_ALGID_KEY, hData, UCConsts.CRYPT_HASH_ALG_OID_GROUP_ID); if (hHashAlgInfo == IntPtr.Zero) { _sError = UCConsts.S_NO_HASH_ALG_ERR.Frm( Marshal.GetLastWin32Error()); return UConsts.E_GEN_EXCEPTION; } CRYPT_OID_INFO pHashAlgInfo = (CRYPT_OID_INFO)Marshal.PtrToStructure(hHashAlgInfo, typeof(CRYPT_OID_INFO)); _sOID = pHashAlgInfo.pszOID; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_DETERM_HASH_ALG_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { Marshal.FreeHGlobal(hData); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ูุฑุงุกุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุจุนูุงูุฉ ุ ูุฏ ุชุชูุงุฌุฃ ุจุฃู ูุนุฑู ุงูุฎูุงุฑุฒููุฉ ูุชู ุงูุญุตูู ุนููู ุจุทุฑููุฉ ุจุณูุทุฉ (CertOIDToAlgId) ูุฃู Oid ููู ูุนูุฏ (CryptFindOIDInfo).  ุณูููู ูู ุงูููุทูู ุงูุชุฑุงุถ ุงุณุชุฎุฏุงู ุฃู ูู ุงูุทุฑููุชูู ุงููุนูุฏุฉ ุฃู ููุชุง ุงูุทุฑููุชูู ุงูุจุณูุทุชูู ุ ููู Linux ูุนูู ููุง ุงูุฎูุงุฑูู ุจูุฌุงุญ.  ููุน ุฐูู ุ ูู Windows ุ ูููู ุงูุฎูุงุฑ ุงูุตุนุจ ููุญุตูู ุนูู ูุนุฑู ูุงูุญุตูู ุนูู ูุนุฑู OID ุบูุฑ ูุณุชูุฑ ุ ูุฐุง ูุฅู ูุซู ูุฐุง ุงููุฎุชูุท ุงูุบุฑูุจ ุณูููู ุญูุงู ูุณุชูุฑูุง. </p><br><h3 style=";text-align:right;direction:rtl">  ุงูุชุญูู ูู ุงูุชูููุน </h3><br><p style=";text-align:right;direction:rtl">  ูุชู ุงูุชุญูู ูู ุงูุชูููุน ุนูู ูุฑุญูุชูู ุ ูู ุงูุจุฏุงูุฉ ูุชู ุงูุชุญูู ูู ุงูุชูููุน ููุณู ุ ุซู ูุชู ุงูุชุญูู ูู ุงูุดูุงุฏุฉ ุงูุชู ุชู ุฅูุดุงุคูุง ุจูุง (ุงูุณูุณูุฉ ุ ุชุงุฑูุฎ ุงูุชูููุน ุ ููุง ุฅูู ุฐูู). <br>  ููุฐูู ุนูุฏ ุงูุชูููุน ุ ูุฌุจ ุนููู ุชุญุฏูุฏ ูุฌููุนุฉ ุงูุจูุงูุงุช ุงููุฑุงุฏ ุชูููุนูุง ุ ููุนููุงุช ุงูุชูููุน ูุงูุชูููุน ููุณู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุชุญูู ูู ุงูุชูููุน</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      &lt;/summary&gt; * &lt;returns&gt;&lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CRYPT_VERIFY_MESSAGE_PARA </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetStdSignVerifyPar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CRYPT_VERIFY_MESSAGE_PARA pVerifyParams = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CRYPT_VERIFY_MESSAGE_PARA(); pVerifyParams.cbSize = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Marshal.SizeOf(pVerifyParams); pVerifyParams.dwMsgEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pVerifyParams.hCryptProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; pVerifyParams.pfnGetSignerCertificate = IntPtr.Zero; pVerifyParams.pvGetArg = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pVerifyParams; } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arData"&gt;,   &lt;/param&gt; * &lt;param name="_pSign"&gt;&lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerifyOnlySign"&gt;  &lt;/param&gt; * &lt;param name="_pRevMode"&gt;  &lt;/param&gt; * &lt;param name="_pRevFlag"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * &lt;remarks&gt;   &lt;/remarks&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSignCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _pSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerifyOnlySign = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, X509RevocationMode _pRevMode = X509RevocationMode.Online, X509RevocationFlag _pRevFlag = X509RevocationFlag.ExcludeRoot</span></span></span><span class="hljs-function">)</span></span>{ _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr pHData = Marshal.AllocHGlobal(_arData.Length); GCHandle pCertContext = GCHandle.Alloc(IntPtr.Zero, GCHandleType.Pinned); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Marshal.Copy(_arData, <span class="hljs-number"><span class="hljs-number">0</span></span>, pHData, _arData.Length); CRYPT_VERIFY_MESSAGE_PARA pVerParam = UCUtils.GetStdSignVerifyPar(); <span class="hljs-comment"><span class="hljs-comment">// 0)   bool fRes = UCryptoAPI.CryptVerifyDetachedMessageSignature( ref pVerParam, //   0, //   _pSign, //  _pSign.Length, //   1, // -    new IntPtr[1] { pHData }, //   new int[1] { _arData.Length }, //    pCertContext.AddrOfPinnedObject());//    if (!fRes) { _sError = UCConsts.S_SIGN_CHECK_ERR.Frm(Marshal.GetLastWin32Error().ToString("X")); return UConsts.E_CRYPTO_ERR; } // 1)   _pCert = new ISDP_X509Cert((IntPtr)pCertContext.Target); if (_pCert == null) { _sError = UCConsts.S_SIGN_CHECK_CERT_ERR; return UConsts.E_CRYPTO_ERR; } // 2)   if (!_fVerifyOnlySign) { List&lt;DateTime&gt; pDates; // 2.1)    int iRes = GetSignDateTimeCP(_pSign, out pDates, ref _sError); // 2.2)    iRes = _pCert.ISDPVerify(ref _sError, pDates[0], _pRevMode, _pRevFlag); if (iRes != UConsts.S_OK) return iRes; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_SIGN_CHECK_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION;; } finally { Marshal.FreeHGlobal(pHData); if ((_pCert == null) &amp;&amp; pCertContext.IsAllocated &amp;&amp; ((IntPtr)pCertContext.Target != IntPtr.Zero)) UCryptoAPI.CertFreeCertificateContext((IntPtr)pCertContext.Target); pCertContext.Free(); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ููุฑุงุญุฉ ุ ุชู ููู ุนูููุฉ ุชุดููู ุจููุฉ ูุน ูุนููุงุช ุฅูู ุทุฑููุฉ ูููุตูุฉ (GetStdSignVerifyPar).  ุจุนุฏ ุฐูู ุ ูุชู ุงูุชุญูู ูู ุงูุชูููุน ููุณู ููุชู ุงุณุชุฎุฑุงุฌ ุงููููุน ุงูุฃูู (ูู ุฃุฌู ุงูุฎูุฑ ุ ูู ุงูุถุฑูุฑู ุงุณุชุฎุฑุงุฌ ุงููู ุ ูููู ุงูุชูููุน ุงูุฐู ูุญุชูู ุนูู ุงูุนุฏูุฏ ูู ุงููููุนูู ูุง ูุฒุงู ุบุฑูุจุงู). </p><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุงุณุชุฎุฑุงุฌ ุดูุงุฏุฉ ุงูููููููุน ุ ุณูุญูููููุง ุฅูู ูุตููุง ููุชุญูู ูููุง (ุฅุฐุง ุชู ุชุญุฏูุฏูุง ูู ูุนููุงุช ุงูุทุฑููุฉ).  ููุชุญูู ุ ูุชู ุงุณุชุฎุฏุงู ุชุงุฑูุฎ ุชูููุน ุงูููููุน ุงูุฃูู (ุงูุธุฑ ุงููุณู ุงูุฎุงุต ุจุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ูู ุงูุชูููุน ุ ูุงููุณู ุงูุฎุงุต ุจูุญุต ุงูุดูุงุฏุฉ). </p><br><h2 style=";text-align:right;direction:rtl">  ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงูุชูููุน </h2><br><p style=";text-align:right;direction:rtl">  ุบุงูุจูุง ูุง ุชุชุทูุจ ุฃูุธูุฉ ุงูุชุดููุฑ ุชูุซูููุง ูุทุจูุนูุง ููุชูููุน.  ูู ูู ุญุงูุฉ ุ ูููู ุงูุฃูุฑ ูุฎุชูููุง ุ ูุฐุง ูู ุงูุฃูุถู ุฅูุดุงุก ูุฆุฉ ูู ุงููุนูููุงุช ุญูู ุงูุชูููุน ุ ูุงูุชู ุณุชุญุชูู ุนูู ูุนูููุงุช ูู ุดูู ููุงุณุจ ููุงุณุชุฎุฏุงู ุ ูุจูุณุงุนุฏุฉ ููุง ุ ูู ุจุชูุฏูู ุนุฑุถ ุชูุฏููู ูุทุจูุน.  ูู .Net ููุงู ูุซู ูุฐู ุงููุฆุฉ - SignedCms ุ ููุน ุฐูู ุ ูุฅู ุงูุชูุงุธุฑูุฉ ุฃุญุงุฏูุฉ ูุน ุชูููุนุงุช CritoPro ุชุฑูุถ ุงูุนูู ูู ุงูุฃูู ุ ูุซุงูููุง ุชุญุชูู ุนูู ุงููุนุฏู ุงููุฎุชูู ูุซุงูุซูุง ุชูุฑูุจูุง ุฌููุน ุฎุตุงุฆุตูุง ูุญููุฉ ุถุฏ ุงููุชุงุจุฉ ุ ูุฐูู ุณูููู ุนููู ุฅูุดุงุก ูุธูุฑุชู ุงูุฎุงุตุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุญุชูู ุงูุชูููุน ููุณู ุนูู ุนูุตุฑูู ุฑุฆูุณููู - ูุงุฆูุฉ ุงูุดูุงุฏุงุช ููุงุฆูุฉ ุงููููุนูู.  ูุฏ ุชููู ูุงุฆูุฉ ุงูุดูุงุฏุงุช ูุงุฑุบุฉ ุ ุฃู ูุฏ ุชุญุชูู ุนูู ุฌููุน ุดูุงุฏุงุช ุงูุชุญูู ุ ุจูุง ูู ุฐูู ุงูุณูุงุณู ุงููุงููุฉ.  ุชุดูุฑ ูุงุฆูุฉ ุงููููุนูู ุนูู ุนุฏุฏ ุงูุชูููุนุงุช ุงูุญููููุฉ.  ูุชู ุงูุงุชุตุงู ุจููููุง ุนู ุทุฑูู ุงูุฑูู ุงูุชุณูุณูู ูุงููุงุดุฑ (ุงููุตุฏุฑ).  ูุธุฑููุง ุ ูู ุชูููุน ูุงุญุฏ ูููู ุฃู ุชููู ููุงู ุดูุงุฏุชุงู ูู ูุงุดุฑูู ูุฎุชูููู ุจููุณ ุงูุฑูู ุงูุชุณูุณูู ุ ูููู ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ ูููู ุฅููุงููุง ูุงูุจุญุซ ุนููุง ููุท ูู ุฎูุงู ุงูุฑูู ุงูุชุณูุณูู. </p><br><p style=";text-align:right;direction:rtl">  ูุฑุงุกุฉ ุงูุชูููุน ููุง ููู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุงูุชูููุน</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;&lt;/summary&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hMsg = IntPtr.Zero; <span class="hljs-comment"><span class="hljs-comment">// 0)   try { hMsg = UCryptoAPI.CryptMsgOpenToDecode(UCConsts.PKCS_7_OR_X509_ASN_ENCODING, UCConsts.CMSG_DETACHED_FLAG, 0, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero); if (hMsg == IntPtr.Zero) { _sError = UCConsts.S_CRYP_MSG_FORM_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 1)   if (!UCryptoAPI.CryptMsgUpdate(hMsg, _arSign, (uint)_arSign.Length, true)) { _sError = UCConsts.S_CRYP_MSG_SIGN_COPY_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)   (PKCS7 SignedData) uint iMessType = UCUtils.GetCryptMsgParam&lt;uint&gt;(hMsg, UCConsts.CMSG_TYPE_PARAM); if (UCConsts.CMSG_SIGNED != iMessType) { _sError = UCConsts.S_CRYP_MSG_SIGN_TYPE_ERR.Frm(iMessType, UCConsts.CMSG_SIGNED); return UConsts.E_CRYPTO_ERR; } // 3)    fpCertificates = UCUtils.GetSignCertificates(hMsg); // 4)   uint iSignerCount = UCUtils.GetCryptMsgParam&lt;uint&gt;(hMsg, UCConsts.CMSG_SIGNER_COUNT_PARAM); for (int i = 0; i &lt; iSignerCount; i++) { ISDPSignerInfo pInfo = new ISDPSignerInfo(); fpSignerInfos.Add(pInfo); int iRes = pInfo.Decode(hMsg, i, this, ref _sError); if (iRes != UConsts.S_OK) return iRes; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_SIGN_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hMsg != IntPtr.Zero) UCryptoAPI.CryptMsgClose(hMsg); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ูุชู ุชุญููู ุงูุชูููุน ูู ุนุฏุฉ ูุฑุงุญู ุ ุฃููุงู ูุชู ุชูููู ุจููุฉ ุงูุฑุณุงูุฉ (CryptMsgOpenToDecode) ุ ุซู ูุชู ุฅุฏุฎุงู ุจูุงูุงุช ุงูุชูููุน ุงูุญูููู (CryptMsgUpdate) ููู.  ูุจูู ุงูุชุญูู ูู ุฃู ูุฐุง ูู ุงูุชูููุน ุงูุญูููู ูุงูุญุตูู ุฃููุงู ุนูู ูุงุฆูุฉ ุงูุดูุงุฏุงุช ุ ุซู ูุงุฆูุฉ ุงููููุนูู.  ูุชู ุงุณุชุฑุฏุงุฏ ูุงุฆูุฉ ุงูุดูุงุฏุงุช ุจุงูุชุณูุณู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูุดูุงุฏุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;     &lt;/summary&gt; * &lt;param name="_hMsg"&gt;Handle &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> X509Certificate2Collection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSignCertificates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hMsg</span></span></span><span class="hljs-function">)</span></span> { X509Certificate2Collection certificates = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2Collection(); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iCnt = GetCryptMsgParam&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt;(_hMsg, UCConsts.CMSG_CERT_COUNT_PARAM); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; iCnt; i++) { IntPtr hInfo = IntPtr.Zero; IntPtr hCert = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iLen = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetCryptMsgParam(_hMsg, UCConsts.CMSG_CERT_PARAM, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> hInfo, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> iLen)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; hCert = UCryptoAPI.CertCreateCertificateContext(UCConsts.PKCS_7_OR_X509_ASN_ENCODING, hInfo, iLen); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hCert != IntPtr.Zero) { certificates.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ISDP_X509Cert(hCert)); hCert = IntPtr.Zero; } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hInfo); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hCert); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> certificates; }</code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ูุชู ุชุญุฏูุฏ ุนุฏุฏ ุงูุดูุงุฏุงุช ูู ุงููุนููุฉ CMSG_CERT_COUNT_PARAM ุ ุซู ูุชู ุงุณุชุฑุฏุงุฏ ุงููุนูููุงุช ุญูู ูู ุดูุงุฏุฉ ุจุดูู ุชุณูุณูู.  ุชููู ุนูููุฉ ุฅูุดุงุก ุณูุงู ุงูุดูุงุฏุฉ ูุนูู ุฃุณุงุณ ุงูุดูุงุฏุฉ ููุณูุง ุนูููุฉ ุงูุฅูุดุงุก. </p><br><p style=";text-align:right;direction:rtl">  ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูููููุน ุฃูุซุฑ ุตุนูุจุฉ.  ุชุญุชูู ุนูู ุฅุดุงุฑุฉ ููุดูุงุฏุฉ ููุงุฆูุฉ ุจูุนููุงุช ุงูุชูููุน (ุนูู ุณุจูู ุงููุซุงู ุ ุชุงุฑูุฎ ุงูุชูููุน).  ุนูููุฉ ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู ููุง ููู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงุณุชุฑุฏุงุฏ ูุนูููุงุช ุงููููููุน</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hMsg"&gt;Handler &lt;/param&gt; * &lt;param name="_iIndex"&gt; &lt;/param&gt; * &lt;param name="_pSignedCms"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hMsg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iIndex, ISDPSignedCms _pSignedCms, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1)   uint iLen = 0; // 2)  IntPtr hInfo = IntPtr.Zero; try { if (!UCryptoAPI.CryptMsgGetParam(_hMsg, UCConsts.CMSG_SIGNER_INFO_PARAM, (uint)_iIndex, IntPtr.Zero, ref iLen)) { _sError = UCConsts.S_ERR_SIGNER_INFO_LEN.Frm(_iIndex, Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } hInfo = Marshal.AllocHGlobal((int)iLen); if (!UCryptoAPI.CryptMsgGetParam(_hMsg, UCConsts.CMSG_SIGNER_INFO_PARAM, (uint)_iIndex, hInfo, ref iLen)) { _sError = UCConsts.S_ERR_SIGNER_INFO.Frm(_iIndex, Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } CMSG_SIGNER_INFO pSignerInfo = (CMSG_SIGNER_INFO) Marshal.PtrToStructure(hInfo, typeof(CMSG_SIGNER_INFO)); // 2.1)   byte[] arSerial = new byte[pSignerInfo.SerialNumber.cbData]; Marshal.Copy(pSignerInfo.SerialNumber.pbData, arSerial, 0, arSerial.Length); X509Certificate2Collection pLocCerts = _pSignedCms.pCertificates.Find(X509FindType.FindBySerialNumber, arSerial.Reverse().ToArray().ToHex(), false); if (pLocCerts.Count != 1) { _sError = UCConsts.S_ERR_SIGNER_INFO_CERT.Frm(_iIndex); return UConsts.E_NO_CERTIFICATE; } fpCertificate = pLocCerts[0]; fpSignedAttributes = UCUtils.ReadCryptoAttrsCollection(pSignerInfo.AuthAttrs); return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_ERR_SIGNER_INFO_READ.Frm(_iIndex, E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hInfo != IntPtr.Zero) Marshal.FreeHGlobal(hInfo); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุณูุงููุง ุ ูุชู ุชุญุฏูุฏ ุญุฌู ูููู ุงููููุน ุฃููุงู ุ ุซู ูุชู ุงุณุชุฎุฑุงุฌ ุงููููู CMSG_SIGNER_INFO. </font><font style="vertical-align: inherit;">ูู ุงูุณูู ุงูุนุซูุฑ ุนูู ุงูุฑูู ุงูุชุณูุณูู ููุดูุงุฏุฉ ููู ูุงุณุชุฎุฏุงูู ููุนุซูุฑ ุนูู ุงูุดูุงุฏุฉ ุงูุชู ุชุญุชุงุฌูุง ูู ุงููุงุฆูุฉ ุงููุณุชุฎุฑุฌุฉ ุณุงุจููุง. </font><font style="vertical-align: inherit;">ูุฑุฌู ููุงุญุธุฉ ุฃู ุงูุฑูู ุงูุชุณูุณูู ูู ุงูุชุฑุชูุจ ุงูุนูุณู.</font></font></p><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุจุนุฏ ุงุณุชุฎุฑุงุฌ ุงูุดูุงุฏุฉ ุ ูู ุงูุถุฑูุฑู ุชุญุฏูุฏ ูุนููุงุช ุงูุชูููุน ุ ูุฃูููุง ุชุงุฑูุฎ ุงูุชูููุน (ุญุชู ุฅุฐุง ูู ูุชู ุงูุชุญูู ูููุง ุจูุงุณุทุฉ ุฎุงุฏู ุงูุทุงุจุน ุงูุฒููู ุ ููู ุงูููู ุฌุฏูุง ููุนุฑุถ). </font></font></p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุงุฆูุฉ ุณูุงุช ุงูุชูููุน</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_pAttrs"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CryptographicAttributeObjectCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadCryptoAttrsCollection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CRYPT_ATTRIBUTES _pAttrs</span></span></span><span class="hljs-function">)</span></span> { CryptographicAttributeObjectCollection pRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptographicAttributeObjectCollection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _pAttrs.cAttr; i++) { IntPtr hAttr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)_pAttrs.rgAttr + (i * Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CRYPT_ATTRIBUTE)))); CRYPT_ATTRIBUTE pAttr = (CRYPT_ATTRIBUTE) Marshal.PtrToStructure(hAttr, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CRYPT_ATTRIBUTE)); CryptographicAttributeObject pAttrInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptographicAttributeObject(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Oid(pAttr.pszObjId), GetAsnEncodedDataCollection(pAttr)); pRes.Add(pAttrInfo); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pRes; }</code> </pre></div></div><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุณูุงุช ูู ูุฑุฌุน ูุชุฏุงุฎู ูุดูู Oid - ูุงุฆูุฉ ุงูููู (ูู ุงููุงูุน ุ ูุฐุง ูู ูููู ASN.1 ุงููุฌุฑ). </font><font style="vertical-align: inherit;">ุจุนุฏ ุงุฌุชูุงุฒ ุงููุณุชูู ุงูุฃูู ุ ูุดูู ูุงุฆูุฉ ูุชุฏุงุฎูุฉ:</font></font></p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูุฉ ุชูููุน ุงูุชุญููู</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      &lt;/summary&gt; * &lt;param name="_sName"&gt;&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Pkcs9AttributeObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pkcs9AttributeFromOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_sName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> UCConsts.S_SIGN_DATE_OID : <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pkcs9SigningTime(); <span class="hljs-comment"><span class="hljs-comment">// case UConsts.S_CONTENT_TYPE_OID : return new Pkcs9ContentType(); -&gt;&gt;  Mono  // case UConsts.S_MESS_DIGEST_OID : return new Pkcs9MessageDigest(); default: return new Pkcs9AttributeObject(); } } /**&lt;summary&gt;  ASN&lt;/summary&gt; * &lt;param name="_pAttr"&gt;&lt;/param&gt; * &lt;returns&gt;&lt;/returns&gt; * **/ internal static AsnEncodedDataCollection GetAsnEncodedDataCollection (CRYPT_ATTRIBUTE _pAttr) { AsnEncodedDataCollection pRes = new AsnEncodedDataCollection(); Oid pOid = new Oid(_pAttr.pszObjId); string sOid = pOid.Value; for (uint i = 0; i &lt; _pAttr.cValue; i++) { checked { IntPtr pAttributeBlob = new IntPtr((long)_pAttr.rgValue + (i * Marshal.SizeOf(typeof(CRYPTOAPI_BLOB)))); Pkcs9AttributeObject attribute = new Pkcs9AttributeObject(pOid, BlobToByteArray(pAttributeBlob)); Pkcs9AttributeObject customAttribute = Pkcs9AttributeFromOID(sOid); if (customAttribute != null) { customAttribute.CopyFrom(attribute); attribute = customAttribute; } pRes.Add(attribute); } } return pRes; }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">         Pkcs9AttributeObject.   ,      mono          .       Mono       . </p><br><p style=";text-align:right;direction:rtl">        โ        โ   SignedCms,        . </p><br><h3 style=";text-align:right;direction:rtl">  </h3><br><p style=";text-align:right;direction:rtl">       ,   ,         .                 (,      ,       ). </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EncryptDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_ENCRYPT_MESSAGE_PARA pParams = new CRYPT_ENCRYPT_MESSAGE_PARA(); pParams.dwMsgEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pParams.ContentEncryptionAlgorithm.pszObjId = _pCert.getEncodeAlgirtmOid(); pParams.cbSize = Marshal.SizeOf(pParams); // 1)   int iLen = 0; if (!UCryptoAPI.CryptEncryptMessage(ref pParams, 1, new IntPtr[] { _pCert.getRealHandle() }, _arInput, _arInput.Length, null, ref iLen)) { _sError = UCConsts.S_CRYPT_ENCODE_LEN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)     _arRes = new byte[iLen]; if (!UCryptoAPI.CryptEncryptMessage(ref pParams, 1, new IntPtr[] {_pCert.getRealHandle() }, _arInput, _arInput.Length, _arRes, ref iLen)) { _sError = UCConsts.S_CRYPT_ENCODE_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CRYPT_ENCODE_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">       โ  ,     .     , ,      . </p><br><p style=";text-align:right;direction:rtl">       ,              ,    . </p><br><p style=";text-align:right;direction:rtl">      .     ,            (    ).        : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OID   &lt;/summary&gt; * &lt;param name="_hCertHandle"&gt; &lt;/param&gt; * &lt;param name="_sOID"&gt;  OID&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEncodeAlgoritmOID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCertHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sOID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fNeedRelease = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _sOID = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iKeySpec = <span class="hljs-number"><span class="hljs-number">0</span></span>; IntPtr hCrypto = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    if (!UCryptoAPI.CryptAcquireCertificatePrivateKey(_hCertHandle, 0, IntPtr.Zero, ref hCrypto, ref iKeySpec, ref fNeedRelease)) { _sError = UCConsts.S_CRYPTO_PROV_INIT_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } uint iLen = 1000; byte[] arData = new byte[1000]; uint iFlag = 1; //  // 1)      while (UCryptoAPI.CryptGetProvParam(hCrypto, UCConsts.PP_ENUMALGS, arData, ref iLen, iFlag)){ iFlag = 2; //  PROV_ENUMALGS pInfo = ConvertBytesToStruct&lt;PROV_ENUMALGS&gt;(arData); // 2)   OID     byte[] arDataAlg = BitConverter.GetBytes(pInfo.aiAlgid); IntPtr hDataAlg = Marshal.AllocHGlobal(arDataAlg.Length); try { Marshal.Copy(arDataAlg, 0, hDataAlg, arDataAlg.Length); IntPtr hHashAlgInfo2 = UCryptoAPI.CryptFindOIDInfo(UCConsts.CRYPT_OID_INFO_ALGID_KEY, hDataAlg, UCConsts.CRYPT_ENCRYPT_ALG_OID_GROUP_ID); // 2.1)  -  if (hHashAlgInfo2 != IntPtr.Zero) { CRYPT_OID_INFO pHashAlgInfo2 = (CRYPT_OID_INFO)Marshal.PtrToStructure(hHashAlgInfo2, typeof(CRYPT_OID_INFO)); _sOID = pHashAlgInfo2.pszOID ; return UConsts.S_OK; } } finally { Marshal.FreeHGlobal(hDataAlg); } } // 3)   -  _sError = UCConsts.S_NO_ENCODE_ALG_ERR; return UConsts.E_CRYPTO_ERR; } catch (Exception E) { _sError = UCConsts.S_DETERM_ENCODE_ALG_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; }finally { if((hCrypto != IntPtr.Zero) &amp;&amp; fNeedRelease) UCryptoAPI.CryptReleaseContext(hCrypto, 0); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">             .        ( , , ,   .),      .          (UCConsts.CRYPT_ENCRYPT_ALG_OID_GROUP_ID).     โ    . </p><br><p style=";text-align:right;direction:rtl">               (    ). </p><br><h3 style=";text-align:right;direction:rtl">  </h3><br><p style=";text-align:right;direction:rtl">  ,   ,               .        .       โ  ,      : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;returns&gt;  ,  UCOnsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecryptDataCP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hSysStore = UCryptoAPI.CertOpenSystemStore(IntPtr.Zero, UCConsts.AR_CRYPTO_STORE_NAME[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)StoreName.My]); GCHandle GC = GCHandle.Alloc(hSysStore, GCHandleType.Pinned); IntPtr hOutCertL = IntPtr.Zero; IntPtr hOutCert = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CRYPT_DECRYPT_MESSAGE_PARA pParams = new CRYPT_DECRYPT_MESSAGE_PARA(); pParams.dwMsgAndCertEncodingType = UCConsts.PKCS_7_OR_X509_ASN_ENCODING; pParams.cCertStore = 1; pParams.rghCertStore = GC.AddrOfPinnedObject(); pParams.cbSize = Marshal.SizeOf(pParams); int iLen = 0; // 1)     if (!UCryptoAPI.CryptDecryptMessage(ref pParams, _arInput, _arInput.Length, null, ref iLen, ref hOutCertL)) { _sError = UCConsts.S_DECRYPT_LEN_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 2)    _arRes = new byte[iLen]; if (!UCryptoAPI.CryptDecryptMessage(ref pParams, _arInput, _arInput.Length, _arRes, ref iLen, ref hOutCert)) { _sError = UCConsts.S_DECRYPT_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } // 3)     if (hOutCert != IntPtr.Zero) _pCert = new ISDP_X509Cert(hOutCert); if(_pCert != null) hOutCert = IntPtr.Zero; //    return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_DECRYPT_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if (hOutCertL != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hOutCertL); if (hOutCert != IntPtr.Zero) UCryptoAPI.CertFreeCertificateContext(hOutCert); GC.Free(); UCryptoAPI.CertCloseStore(hSysStore, 0); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">     ,          .         ,    ( Linux    ). </p><br><h3 style=";text-align:right;direction:rtl">   </h3><br><p style=";text-align:right;direction:rtl">      ,         ,  ,       ,      .          ,   .       : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">   ( ,    ,  . .); </li><li style=";text-align:right;direction:rtl">    โ       ; </li><li style=";text-align:right;direction:rtl">     โ         ; <br></li><li style=";text-align:right;direction:rtl">     ,  ,         (CRL); </li></ol><br><p style=";text-align:right;direction:rtl">        ,       . </p><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุง ูู ูุงุถุญ ูู ุงูููุฏูุฉ ุ ูุฅู ุงูุชุญูู ูู ุตุญุฉ ุงูุตูุงุญูุฉ ูู ูุงุญุฏ ูู ุฃุตุนุจ ุงูููุงู. </font><font style="vertical-align: inherit;">ูุฐุง ูู ุงูุณุจุจ ูู ุฃู ุงูููุชุจุฉ ูุฏููุง ุงููุซูุฑ ูู ุงูุทุฑู ูุชูููุฐ ูู ุนูุตุฑ ุนูู ุญุฏุฉ. </font><font style="vertical-align: inherit;">ูุฐูู ุ ูู ุฃุฌู ุงูุจุณุงุทุฉ ุ ููุชูู ุฅูู ูุตุงุฏุฑ .Net ูุฃุณููุจ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X509Certificate2.Verify () ููุฃุฎุฐูุง</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุฃุณุงุณ.</font></font></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุชููู ุงูุชุญูู ูู ูุฑุญูุชูู: </font></font><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุชุดููู ุณูุณูุฉ ูู ุงูุดูุงุฏุงุช ูุตููุงู ุฅูู ุงูุฌุฐุฑ ุ </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุชุญูู ูู ูู ุงูุดูุงุฏุงุช ุงูููุฌูุฏุฉ ููู (ููุฅูุบุงุก ุ ูุงูููุช ุ ููุง ุฅูู ุฐูู) ุ </font></font></li></ol><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุฌุจ ุฃู ูุชู ูุฐุง ุงูุชุญูู ูุจู ุงูุชูููุน ูุงูุชุดููุฑ ูู ุงูุชุงุฑูุฎ ุงูุญุงูู ุ ููู ููุช ุงูุชุญูู ูู ุงูุชูููุน ูู ุชุงุฑูุฎ ุงูุชูููุน. </font><font style="vertical-align: inherit;">ุทุฑููุฉ ุงูุชุญูู ููุณูุง ุตุบูุฑุฉ:</font></font></p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุชุญูู ูู ุงูุดูุงุฏุฉ</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hPolicy"&gt;   &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_iCTLTimeout"&gt;   &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VerifyCertificate</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, DateTime _rOnDate, TimeSpan _iCTLTimeout, IntPtr _hPolicy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_hCert == IntPtr.Zero) { _sError = UCConsts.S_CRYPTO_CERT_CHECK_ERR; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.E_NO_CERTIFICATE; } CERT_CHAIN_POLICY_PARA pPolicyParam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CERT_CHAIN_POLICY_PARA(Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CHAIN_POLICY_PARA))); CERT_CHAIN_POLICY_STATUS pPolicyStatus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CERT_CHAIN_POLICY_STATUS(Marshal.SizeOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CERT_CHAIN_POLICY_STATUS))); <span class="hljs-comment"><span class="hljs-comment">// 1)   IntPtr hChain = IntPtr.Zero; try { int iRes = BuildChain(new IntPtr(UCConsts.HCCE_CURRENT_USER), _hCert, __iRevMode, _iRevFlag, _rOnDate, _iCTLTimeout, ref hChain, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)   if (UCryptoAPI.CertVerifyCertificateChainPolicy(_hPolicy, hChain, ref pPolicyParam, ref pPolicyStatus)) { if (pPolicyStatus.dwError != 0) { _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(pPolicyStatus.dwError); return UConsts.E_CRYPTO_ERR; } } else{ _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CRYPTO_CERT_VERIFY_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hChain != IntPtr.Zero) UCryptoAPI.CertFreeCertificateChain(hChain); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃููุงู ุ ูุชู ุชุดููู ุณูุณูุฉ ุจุงุณุชุฎุฏุงู ุทุฑููุฉ BuildChain ุ ููู ุซู ูุชู ูุญุตูุง. </font><font style="vertical-align: inherit;">ุฃุซูุงุก ุชุดููู ุงูุณูุณูุฉ ุ ูุชู ุชุดููู ูููู ุงููุนููุงุช ูุชุงุฑูุฎ ุงูุชุญูู ูุนูุงูุงุช ุงูุงุฎุชูุงุฑ:</font></font></p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    &lt;/summary&gt; * &lt;param name="_hChain"&gt;  &lt;/param&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hChainEngine"&gt; &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_rCTLTimeOut"&gt;   &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildChain</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hChainEngine, IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, DateTime _rOnDate, TimeSpan _rCTLTimeOut, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hChain, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    if (_hCert == IntPtr.Zero) { _sError = UCConsts.S_CRYPTO_CERT_CHAIN_ERR; return UConsts.E_NO_CERTIFICATE; } // 1)  CERT_CHAIN_PARA pChainParams = new CERT_CHAIN_PARA(); pChainParams.cbSize = (uint) Marshal.SizeOf(pChainParams); IntPtr hAppPolicy = IntPtr.Zero; IntPtr hCertPolicy = IntPtr.Zero; try { // 2)    pChainParams.dwUrlRetrievalTimeout = (uint)Math.Floor(_rCTLTimeOut.TotalMilliseconds); // 3)   FILETIME pVerifyTime = new FILETIME(_rOnDate.ToFileTime()); // 4)   uint _iFlags = MapRevocationFlags(_iRevMode, _iRevFlag); // 5)   if (!UCryptoAPI.CertGetCertificateChain(_hChainEngine, _hCert, ref pVerifyTime, IntPtr.Zero, ref pChainParams, _iFlags, IntPtr.Zero, ref _hChain)) { _sError = UCConsts.S_CRYPTO_CHAIN_BUILD_ERR.Frm(Marshal.GetLastWin32Error()); return UConsts.E_CRYPTO_ERR; } } catch(Exception E) { _sError = UCConsts.S_CRYPTO_CHAIN_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { Marshal.FreeHGlobal(hAppPolicy); Marshal.FreeHGlobal(hCertPolicy); } return UConsts.S_OK; }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">          ,    Microsoft.  hCertPolicy  hAppPolicy   OID-,    ,     .   ,  ,     . </p><br><p style=";text-align:right;direction:rtl">            (,   ). </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MapRevocationFlags</a> โ      .Net   โ   uint    . </p><br><h3 style=";text-align:right;direction:rtl">  ุงูุฎูุงุตุฉ </h3><br><p style=";text-align:right;direction:rtl">               : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  10 ; </li><li style=";text-align:right;direction:rtl">  ; </li><li style=";text-align:right;direction:rtl">  byte[] {1, 2, 3, 4, 5}; </li><li style=";text-align:right;direction:rtl">   ; </li><li style=";text-align:right;direction:rtl">   ; </li><li style=";text-align:right;direction:rtl">  byte[] {1, 2, 3, 4, 5}; </li><li style=";text-align:right;direction:rtl">   ; </li></ol><br><p style=";text-align:right;direction:rtl">      Windows   Linux  1-, 10-  50- ,     Linux    .   Linux     -   -  (   ,    ),   ยซยป .       (deadlock-)   (             ยซAccess Violationยป). </p><br><p style=";text-align:right;direction:rtl">           UCryptoAPI    .     fpCPSection  object        : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> fpCPSection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_hCryptMsg"&gt;  &lt;/param&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptMsgClose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCryptMsg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (pCPSection) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LCryptoAPI.CryptMsgClose(_hCryptMsg); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WCryptoAPI.CryptMsgClose(_hCryptMsg); } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;     &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> pCPSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fpCPSection;} }</code> </pre><br><p style=";text-align:right;direction:rtl">   ,         Linux- . </p><br><p style=";text-align:right;direction:rtl">         mono     Issuer  Subject . , ,    mono   X500DistinguishedName    .  , mono      (     ),           (impl.issuerName  impl.subjectName).         (Reflection)      X500DistinguishedName,       CERT_CONTEXT . </p><br><h2 style=";text-align:right;direction:rtl">  ุงููุฑุงุฌุน </h2><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a>  CAPILite </li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a> c      # </li><li style=";text-align:right;direction:rtl">  .Net: <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CAPIBase</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">X509Certificate2</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">SignedCMS</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">SignerInfo</a> </li></ol><br></li><li style=";text-align:right;direction:rtl">  mono: <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">X509Certificate2</a> </li><li style=";text-align:right;direction:rtl">  <a href="">X509CertificateImplBtls</a> </li></ol><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar423163/">https://habr.com/ru/post/ar423163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar423153/index.html">ุฏููู Node.js ุ ุงูุฌุฒุก ุงูุซุงูู: JavaScript ุ V8 ุ ุจุนุถ ุญูู ุงูุชุทููุฑ</a></li>
<li><a href="../ar423155/index.html">ุฏูุฑุฉ ูุนูุฏ ูุงุณุงุชุดูุณุชุณ ููุชูููููุฌูุง "ุฃูู ุฃูุธูุฉ ุงูููุจููุชุฑ". ุงููุญุงุถุฑุฉ 8: ูููุฐุฌ ุฃูู ุงูุดุจูุงุช ุ ุงูุฌุฒุก 2</a></li>
<li><a href="../ar423157/index.html">ุงุณุชุฎุฏุงู ูุธููุฉ connect () ูู ุฑุฏ ุงููุนู ุงููุชูุงุนู</a></li>
<li><a href="../ar423159/index.html">ููู ูุจุฑูุฌ ุณุนูุฏ! ุฃุญุจ ูุทูุฑูู</a></li>
<li><a href="../ar423161/index.html">ุงูุฃุนูุงู ุงูุชุฌุงุฑูุฉ ุชุฑูุฏ ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ</a></li>
<li><a href="../ar423165/index.html">ุฑุณู ุดุจูุฉ ุฏููุงูููู ูู ูุญุฑู Unreal 4</a></li>
<li><a href="../ar423167/index.html">ูุง ูุชุญุฏุซ ุนูู ูุงุฑู ุฒููุฑุจูุฑุฌ ุญูู ูุถุงูุง Facebook. ุงูุดูุก ุงูุฑุฆูุณู ูู ููุงูุฉ ุงููููููุฑูุฑ</a></li>
<li><a href="../ar423169/index.html">ุจุฏุก ุงูููู (ููููู-ุฃุบุณุทุณ 2018)</a></li>
<li><a href="../ar423171/index.html">ููู ูุฎุฏู Discord ูู ููุช ูุงุญุฏ 2.5 ููููู ุฏุฑุฏุดุฉ ุตูุชูุฉ ุจุงุณุชุฎุฏุงู WebRTC</a></li>
<li><a href="../ar423173/index.html">ุงูุญุฏ ุงูุฃุฏูู ูู ุงูููุช - ุงูุฃูู ุงูุฃูุตู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>