<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🚒 👨🏼‍⚖️ 👨🏼‍⚕️ Eclair - Bibliothèque de journalisation déclarative Java Spring 🤹🏿 🌾 🥊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a beaucoup de questions sur le travail des services aux stades de développement, de test et de support, et tous sont à première vue différents: "...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eclair - Bibliothèque de journalisation déclarative Java Spring</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/412871/"><img src="https://habrastorage.org/webt/c5/hp/zh/c5hpzhb2lfd56lwayott-mqlusi.jpeg"><br><br>  Il y a beaucoup de questions sur le travail des services aux stades de développement, de test et de support, et tous sont à première vue différents: <i>"Que s'est-il passé?"</i>  , <i>"Y avait-il une demande?"</i>  , <i>"Quel est le format de date?"</i>  , <i>"Pourquoi le service ne répond-il pas?"</i>  etc. <br><br>  Un journal correctement compilé pourra répondre en détail à ces questions et à bien d'autres de manière absolument autonome sans la participation des développeurs.  Dans la poursuite d'un objectif aussi tentant, la bibliothèque de journalisation Eclair est née, conçue pour engager un dialogue avec tous les participants au processus sans tirer trop de couvertures. <br><br>  À propos de la couverture et des fonctionnalités de la solution - ci-dessous. <br><a name="habracut"></a><br><h2>  Quel est le problème de la journalisation </h2><br><blockquote>  Si vous n'êtes pas très intéressé par la compréhension des lieux, vous pouvez immédiatement procéder à la description de notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">solution</a> . </blockquote><br><ul><li>  Le journal des applications est son alibi. <br>  Le plus souvent, lui seul peut prouver le succès de la candidature.  Il n'y a pas d'état dans un microservice; les systèmes adjacents sont mobiles et capricieux.  «Répéter», «recréer», «revérifier» - tout cela est difficile et / ou impossible.  Le journal doit être suffisamment informatif pour répondre à la question: <i>«Que s'est-il passé?»</i> À tout moment <i>.</i>  .  Le journal doit être clair pour tout le monde: le développeur, le testeur, parfois l'analyste, parfois l'administrateur, parfois la première ligne de support - tout se passe. </li><li>  Les microservices concernent le multithreading. <br>  Les demandes qui arrivent au service (ou les données demandées par le service) sont le plus souvent traitées par plusieurs threads.  Le journal de tous les threads est généralement mélangé.  Voulez-vous faire la distinction entre les threads parallèles et distinguer les threads "séquentiels"?  Le même flux est réutilisé pour le traitement séquentiel des demandes, exécutant encore et encore sa propre logique pour différents ensembles de données.  Ces flux "séquentiels" proviennent d'un autre plan, mais leurs limites doivent être claires pour le lecteur. </li><li>  Le journal doit enregistrer le format de données d'origine. <br>  Si en réalité les services sont échangés par XML, le journal correspondant doit stocker XML.  Ce n'est pas toujours compact et pas toujours beau (mais pratique).  Il est plus facile de voir le succès, d’analyser l’échec plus facilement.  Dans certains cas, le journal peut être utilisé pour lire ou retraiter manuellement la demande. </li><li>  Une partie des données du journal nécessite une relation spéciale. <br>  Les données entrantes (demandes), les données sortantes (réponses), les demandes adressées à des systèmes tiers et leurs réponses doivent souvent être stockées séparément.  Ils sont soumis à des exigences particulières: par durée de vie ou fiabilité.  De plus, ces données peuvent avoir une quantité impressionnante par rapport à une ligne de journal typique. </li><li>  Une partie des données n'est pas destinée au journal. <br>  Les éléments suivants doivent généralement être exclus du journal normal: données binaires (tableaux d'octets, base64, ..), données personnelles des clients / partenaires / autres personnes physiques et morales.  C'est toujours une histoire individuelle, mais systématique et ne se prête pas à un contrôle manuel. </li></ul><br><h2>  Pourquoi pas les mains </h2><br>  Prenez <code>org.slf4j.Logger</code> ( <code>org.slf4j.Logger</code> vous avec les annexes de n'importe quelle couleur) et écrivez tout ce qui est nécessaire dans le journal.  Les entrées aux principales méthodes, les sorties, si nécessaire, reflètent les erreurs détectées, certaines données.  Est-ce nécessaire?  Oui, mais: <br><br><ul><li>  La quantité de code augmente de manière déraisonnable (inhabituelle).  Au début, ce n'est pas très frappant, si vous vous connectez uniquement aux plus basiques (support réussi, soit dit en passant, avec cette approche). </li><li>  Appeler l'enregistreur avec vos mains devient rapidement de la paresse.  Déclarer un champ <code>static</code> avec un enregistreur est trop paresseux (enfin, Lombok peut le faire pour nous).  Nous, les développeurs, sommes paresseux.  Et nous écoutons notre paresse, c'est une noble paresse: elle change constamment le monde pour le mieux. </li><li>  Les microservices ne sont pas bons de tous les côtés.  Oui, elles sont petites et jolies, mais il y a un revers: il y en a beaucoup!  Une seule application du début à la fin est souvent écrite par un développeur.  L'héritage n'apparaît pas sous ses yeux.  Heureux, pas chargé de règles imposées, le développeur considère qu'il est du devoir d'inventer son propre format de log, son principe et ses propres règles.  Puis, met en œuvre avec brio l'invention.  Chaque classe est différente.  Est-ce un problème?  Colossal. </li><li>  La refactorisation cassera votre journal.  Même l'idée omnipotente ne le sauvera pas.  La mise à jour du journal est aussi impossible que la mise à jour de Javadoc.  Dans le même temps, au moins Javadoc est lu uniquement par les développeurs (non, personne ne lit), mais l'audience des journaux est beaucoup plus large et l'équipe de développement n'est pas limitée. </li><li>  MDC (Mapped Diagnostic Context) fait partie intégrante d'une application multithread.  Le remplissage manuel du MDC nécessite un nettoyage en temps opportun à la fin des travaux dans le flux.  Sinon, vous courez le risque de lier un <code>ThreadLocal</code> à des données non liées.  Les mains et les yeux pour contrôler cela, j'ose dire, est impossible. </li></ul><br>  Et c'est ainsi que nous résolvons ces problèmes dans nos applications. <br><a name="eclair-decision"></a><br><h2>  Qu'est-ce qu'Eclair et que peut-il faire </h2><br>  Eclair est un outil qui simplifie l'écriture de code enregistré.  Il permet de collecter les méta-informations nécessaires sur le code source, de les associer aux données volantes dans l'application lors de l'exécution et de les envoyer au référentiel de journaux habituel, tout en générant un minimum de code. <br><br>  L'objectif principal est de rendre le journal compréhensible pour tous les participants au processus de développement.  Par conséquent, la commodité de l'écriture de code, les avantages d'Eclair ne s'arrêtent pas, mais commencent seulement. <br><br>  Eclair enregistre les méthodes et paramètres annotés: <br><br><ul><li>  enregistre l'entrée / sortie de la méthode de la méthode / exceptions / arguments / valeurs renvoyées par la méthode </li><li>  filtre les exceptions pour les enregistrer spécifiquement dans les types: <i>uniquement lorsque cela est nécessaire</i> </li><li>  fait varier le "détail" du journal, en fonction des paramètres de l'application pour l'emplacement actuel: <i>par exemple, dans le cas le plus détaillé, il imprime les valeurs des arguments (tout ou partie), dans la version la plus courte - uniquement le fait d'entrer la méthode</i> </li><li>  imprime les données au format JSON / XML / dans tout autre format (prêt à travailler avec Jackson, JAXB prêt à l'emploi): <i>comprend quel format est le plus préférable pour un paramètre particulier</i> </li><li>  comprend SpEL (Spring Expression Language) pour l'installation déclarative et l'auto-nettoyage MDC </li><li>  écrit dans N loggers, le "logger" dans la compréhension d'Eclair est un bean dans le contexte qui implémente l'interface <code>EclairLogger</code> : vous pouvez <i>spécifier le logger qui doit traiter l'annotation par nom, par alias, ou par défaut</i> </li><li>  informe le programmeur de certaines erreurs dans l'utilisation des annotations: <i>par exemple, Eclair sait qu'il fonctionne sur des proxys dynamiques (avec toutes les fonctionnalités qui en découlent), par conséquent, il peut suggérer que l'annotation sur la méthode <code>private</code> ne fonctionnera jamais</i> </li><li>  accepte les méta annotations (comme les appelle Spring): <i>vous pouvez définir vos annotations pour la journalisation, en utilisant quelques annotations de base - pour réduire le code</i> </li><li>  capable de masquer les données «sensibles» lors de l'impression: <i>prêt à l'emploi XPath-shielding XML</i> </li><li>  écrit un journal en mode "manuel", définit l'invocateur et "développe" les arguments qui implémentent le <code>Supplier</code> : <i>donnant la possibilité d'initialiser les arguments "paresseusement"</i> </li></ul><br><h2>  Comment connecter Eclair </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le code source est publié sur GitHub</a> sous la licence Apache 2.0. <br><br>  Pour vous connecter, vous avez besoin de Java 8, Maven et Spring Boot 1.5+.  Artefact hébergé par Maven Central Repository: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>ru.tinkoff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>eclair-spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.8.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Le démarreur contient une implémentation standard d' <code>EclairLogger</code> , qui utilise un système de journalisation initialisé par Spring Boot avec un ensemble de paramètres vérifiés. <br><br><h2>  Des exemples </h2><br>  Voici quelques exemples d'utilisation typique d'une bibliothèque.  D'abord, un fragment de code est donné, puis le journal correspondant, selon la disponibilité d'un certain niveau de journalisation.  Un ensemble d'exemples plus complet peut être trouvé sur le wiki du projet dans la section <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exemples</a> . <br><br><h3>  Exemple le plus simple </h3><br>  Le niveau par défaut est DEBUG. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">simple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre><table><tbody><tr><th>  Si le niveau est disponible </th><th>  ... alors le journal sera comme ça </th></tr><tr><td> <code>TRACE <br> DEBUG</code> </td> <td> <code>DEBUG [] rteeExample.simple &gt; <br> DEBUG [] rteeExample.simple &lt;</code> </td> </tr><tr><td> <code>INFO <br> WARN <br> ERROR</code> </td> <td> <code>-</code> </td> </tr></tbody></table><h3>  Les détails du journal dépendent du niveau de journalisation disponible. </h3><br>  Le niveau de journalisation disponible à l'emplacement actuel affecte les détails du journal.  Plus le niveau disponible est bas (c'est-à-dire plus proche de TRACE), plus le journal est détaillé. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span>(INFO) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verbose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s, Integer i, Double d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><table><tbody><tr><th>  Niveau </th><th>  Journal </th></tr><tr><td> <code>TRACE <br> DEBUG</code> </td> <td> <code>INFO [] rteeExample.verbose &gt; s="s", i=4, d=5.6 <br> INFO [] rteeExample.verbose &lt; false</code> </td> </tr><tr><td> <code>INFO</code> </td> <td> <code>INFO [] rteeExample.verbose &gt; <br> INFO [] rteeExample.verbose &lt;</code> </td> </tr><tr><td> <code>WARN <br> ERROR</code> </td> <td> <code>-</code> </td> </tr></tbody></table><h3>  Journalisation des exceptions de réglage fin </h3><br>  Les types d'exceptions enregistrées peuvent être filtrés.  Les exceptions sélectionnées et leurs descendants seront promis.  Dans cet exemple, <code>NullPointerException</code> sera enregistré au niveau WARN, <code>Exception</code> au niveau ERROR (par défaut) et <code>Error</code> ne sera pas enregistré du tout (car <code>Error</code> pas inclus dans le filtre de la première annotation <code>@Log.error</code> et est explicitement exclu du filtre de la deuxième annotation). <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.error(level = WARN, ofType = {NullPointerException.class, IndexOutOfBoundsException.class}) <span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.error(exclude = Error.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filterErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable throwable)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> throwable; } <span class="hljs-comment"><span class="hljs-comment">//       filterErrors(new NullPointerException()); filterErrors(new Exception()); filterErrors(new Error());</span></span></code> </pre><table><tbody><tr><th>  Niveau </th><th>  Journal </th></tr><tr><td> <code>TRACE <br> DEBUG <br> INFO <br> WARN</code> </td> <td> <code>WARN  [] rteeExample.filterErrors ! java.lang.NullPointerException <br> java.lang.NullPointerException: null <br> at rteeExampleTest.filterErrors(ExampleTest.java:0) <br> .. <br> ERROR [] rteeExample.filterErrors ! java.lang.Exception <br> java.lang.Exception: null <br> at rteeExampleTest.filterErrors(ExampleTest.java:0) <br> .. <br></code> </td></tr><tr><td> <code>ERROR</code> </td> <td> <code>ERROR [] rteeExample.filterErrors ! java.lang.Exception <br> java.lang.Exception: null <br> at rteeExampleTest.filterErrors(ExampleTest.java:0) <br> ..</code> </td> </tr></tbody></table><h3>  Réglez chaque paramètre séparément </h3><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.in(INFO) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parameterLevels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Log(INFO)</span></span></span><span class="hljs-function"> Double d, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEBUG)</span></span></span><span class="hljs-function"> String s, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TRACE)</span></span></span><span class="hljs-function"> Integer i) </span></span>{ }</code> </pre><table><tbody><tr><th>  Niveau </th><th>  Journal </th></tr><tr><td> <code>TRACE</code> </td> <td> <code>INFO [] rteeExample.parameterLevels &gt; d=9.4, s="v", i=7</code> </td> </tr><tr><td> <code>DEBUG</code> </td> <td> <code>INFO [] rteeExample.parameterLevels &gt; d=9.4, s="v"</code> </td> </tr><tr><td> <code>INFO</code> </td> <td> <code>INFO [] rteeExample.parameterLevels &gt; 9.4</code> </td> </tr><tr><td> <code>WARN <br> ERROR</code> </td> <td> <code>-</code> </td> </tr></tbody></table><h3>  Sélectionnez et personnalisez le format d'impression </h3><br>  Les «imprimantes» responsables du format d'impression peuvent être configurées par des pré et post-processeurs.  Dans l'exemple ci-dessus, <code>maskJaxb2Printer</code> configuré de sorte que les éléments correspondant à l'expression XPath <code>"//s"</code> sont masqués à l'aide de <code>"********"</code> .  Dans le même temps, <code>jacksonPrinter</code> imprime <code>Dto</code> "tel <code>jacksonPrinter</code> ". <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.out(printer = <span class="hljs-string"><span class="hljs-string">"maskJaxb2Printer"</span></span>) <span class="hljs-function"><span class="hljs-function">Dto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Log(printer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"maskJaxb2Printer"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Dto xml, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(printer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"jacksonPrinter"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Dto json, Integer i) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xml; }</code> </pre><table><tbody><tr><th>  Niveau </th><th>  Journal </th></tr><tr><td> <code>TRACE <br> DEBUG</code> </td> <td> <code>DEBUG [] rteeExample.printers &gt; <br> xml=&lt;dto&gt;&lt;i&gt;5&lt;/i&gt;&lt;s&gt;********&lt;/s&gt;&lt;/dto&gt;, json={"i":5,"s":"password"} <br> DEBUG [] rteeExample.printers &lt; <br> &lt;dto&gt;&lt;i&gt;5&lt;/i&gt;&lt;s&gt;********&lt;/s&gt;&lt;/dto&gt;</code> </td> </tr><tr><td> <code>INFO <br> WARN <br> ERROR</code> </td> <td> <code>-</code> </td> </tr></tbody></table><h3>  Plusieurs enregistreurs en contexte </h3><br>  La méthode est enregistrée à l'aide de plusieurs enregistreurs en même temps: par défaut enregistreur (annoté à l'aide de <code>@Primary</code> ) et auditLogger.  Vous pouvez définir plusieurs enregistreurs si vous souhaitez séparer les événements enregistrés non seulement par niveau (TRACE - ERREUR), mais aussi les envoyer à différents stockages.  Par exemple, l'enregistreur principal peut écrire un journal dans un fichier sur le disque à l'aide de slf4j, et <code>auditLogger</code> peut écrire une tranche de données spéciale dans un excellent stockage (par exemple, dans Kafka) dans son propre format spécifique. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span> <span class="hljs-meta"><span class="hljs-meta">@Log</span></span>(logger = <span class="hljs-string"><span class="hljs-string">"auditLogger"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">twoLoggers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre><br><h3>  Gestion MDC </h3><br>  Les MDC définis à l'aide d'annotations sont automatiquement supprimés après avoir quitté la méthode annotée.  Une valeur d'enregistrement MDC peut être calculée dynamiquement à l'aide de SpEL.  Voici des exemples: une chaîne statique perçue par une constante, évaluant l'expression <code>1 + 1</code> , appelant le <code>jacksonPrinter</code> , appelant la méthode <code>static</code> <code>randomUUID</code> . <br>  Les MDC avec l'attribut <code>global = true</code> ne sont pas supprimés après avoir quitté la méthode: comme vous pouvez le voir, le seul enregistrement restant dans le MDC jusqu'à la fin du journal est <code>sum</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ self.mdc(); } <span class="hljs-meta"><span class="hljs-meta">@Mdc</span></span>(key = <span class="hljs-string"><span class="hljs-string">"static"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"string"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Mdc</span></span>(key = <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"1 + 1"</span></span>, global = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Mdc</span></span>(key = <span class="hljs-string"><span class="hljs-string">"beanReference"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"@jacksonPrinter.print(new ru.tinkoff.eclair.example.Dto())"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Mdc</span></span>(key = <span class="hljs-string"><span class="hljs-string">"staticMethod"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"T(java.util.UUID).randomUUID()"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Log</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mdc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ self.inner(); } <span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.<span class="hljs-function"><span class="hljs-function">in </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre><br>  Connectez-vous lors de l'exécution du code ci-dessus: <br> <code>DEBUG [] rteeExample.outer &gt; <br> DEBUG [beanReference={"i":0,"s":null}, sum=2, static=string, staticMethod=01234567-89ab-cdef-ghij-klmnopqrstuv] rteeExample.mdc &gt; <br> DEBUG [beanReference={"i":0,"s":null}, sum=2, static=string, staticMethod=01234567-89ab-cdef-ghij-klmnopqrstuv] rteeExample.inner &gt; <br> DEBUG [beanReference={"i":0,"s":null}, sum=2, static=string, staticMethod=01234567-89ab-cdef-ghij-klmnopqrstuv] rteeExample.mdc &lt; <br> DEBUG [sum=2] rteeExample.outer &lt;</code> <br> <br><h3>  Installation MDC basée sur des paramètres </h3><br>  Si vous spécifiez le MDC à l'aide de l'annotation sur le paramètre, le paramètre annoté est disponible en tant qu'objet racine du contexte d'évaluation.  Ici <code>"s"</code> est un champ de classe <code>Dto</code> de type <code>String</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Log</span></span>.<span class="hljs-function"><span class="hljs-function">in </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mdcByArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Mdc(key = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"dto"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"#this"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Mdc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"length"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"s.length()"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Dto dto) </span></span>{ }</code> </pre><br>  Connectez-vous lors de l'exécution du code ci-dessus: <br> <code>DEBUG [length=8, dto=Dto{i=12, s='password'}] rteeExample.mdcByArgument &gt; dto=Dto{i=12, s='password'}</code> <br> <br><h3>  Journalisation manuelle </h3><br>  Pour une journalisation "manuelle", il suffit d'implémenter l'implémentation de <code>ManualLogger</code> .  Les arguments passés qui implémentent le <code>Supplier</code> interface ne seront "développés" que si nécessaire. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualLogger logger; <span class="hljs-meta"><span class="hljs-meta">@Log</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">manual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ logger.info(<span class="hljs-string"><span class="hljs-string">"Eager logging: {}"</span></span>, Math.PI); logger.debug(<span class="hljs-string"><span class="hljs-string">"Lazy logging: {}"</span></span>, (Supplier) () -&gt; Math.PI); }</code> </pre><table><tbody><tr><th>  Niveau </th><th>  Journal </th></tr><tr><td> <code>TRACE <br> DEBUG</code> </td> <td> <code>DEBUG [] rteeExample.manual &gt; <br> INFO  [] rteeExample.manual - Eager logging: 3.141592653589793 <br> DEBUG [] rteeExample.manual - Lazy logging: 3.141592653589793 <br> DEBUG [] rteeExample.manual &lt;</code> </td> </tr><tr><td> <code>INFO</code> </td> <td> <code>INFO [] rteeExample.manual - Eager logging: 3.141592653589793</code> </td> </tr><tr><td> <code>WARN <br> ERROR</code> </td> <td> <code>-</code> </td> </tr></tbody></table><h2>  Qu'est-ce que Eclair ne fait pas </h2><br>  Eclair ne sait pas où vous stockerez vos journaux, pour combien de temps et en détail.  Eclair ne sait pas comment vous prévoyez d'utiliser votre journal.  Eclair extrait soigneusement de votre application toutes les informations dont vous avez besoin et les redirige vers le stockage que vous avez configuré. <br><br>  Un exemple de configuration d' <code>EclairLogger</code> dirigeant un journal vers un enregistreur Logback avec un Appender spécifique: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EclairLogger </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eclairLogger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LoggerFacadeFactory factory = loggerName -&gt; { ch.qos.logback.classic.LoggerContext context = (LoggerContext) LoggerFactory.getILoggerFactory(); ch.qos.logback.classic.Logger logger = context.getLogger(loggerName); <span class="hljs-comment"><span class="hljs-comment">// Appender&lt;ILoggingEvent&gt; appender = ? // logger.addAppender(appender); return new Slf4JLoggerFacade(logger); }; return new SimpleLogger(factory, LoggingSystem.get(SimpleLogger.class.getClassLoader())); }</span></span></code> </pre><br><h2>  Cette solution n'est pas pour tout le monde. </h2><br>  Avant de commencer à utiliser Eclair comme outil principal de journalisation, vous devez vous familiariser avec un certain nombre de fonctionnalités de cette solution.  Ces «fonctionnalités» sont dues au fait qu'Eclair est basé sur le mécanisme de proxy standard pour Spring. <br><br>  - La vitesse d'exécution du code encapsulé dans le prochain proxy est insignifiante, mais elle chutera.  Pour nous, ces pertes sont rarement importantes.  Si la question se pose de réduire le délai de livraison, il existe de nombreuses mesures d'optimisation efficaces.  Le refus d'un journal informatif pratique peut être considéré comme l'une des mesures, mais pas en premier lieu. <br><br>  - StackTrace "gonfle" un peu plus.  Si vous n'êtes pas habitué à la longue pile de traces de proxys Spring, cela peut être une nuisance pour vous.  Pour une raison tout aussi évidente, le débogage des classes mandataires sera difficile. <br><br>  - <b>Toutes les classes et toutes</b> <code>private</code> méthodes ne peuvent pas <b>être proxy</b> : <code>private</code> méthodes <code>private</code> ne peuvent pas être proxy, vous aurez besoin de vous-même pour enregistrer la chaîne de méthodes dans un bean, vous ne pouvez pas proxy tout ce qui n'est pas un bean, etc. <br><br><h2>  En fin de compte </h2><br>  Il est clair que cet outil, comme tout autre, doit pouvoir être utilisé pour en bénéficier.  Et ce matériau n'illumine que superficiellement le côté dans lequel nous avons décidé de nous déplacer à la recherche de la solution parfaite. <br><br>  Critique, réflexions, astuces, liens - je salue chaleureusement toute participation à la vie du projet!  Je serais ravi que vous trouviez Eclair utile pour vos projets. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412871/">https://habr.com/ru/post/fr412871/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412861/index.html">Création d'une carte de parcours utilisateur pour les nuls</a></li>
<li><a href="../fr412863/index.html">Dialogflower - Google Dialogflow pour Yandex Alice</a></li>
<li><a href="../fr412865/index.html">Comment filmer une caméra Motion Eye sur le Sony Xperia XZ2</a></li>
<li><a href="../fr412867/index.html">Comment compiler un fichier DOS COM par le compilateur GCC</a></li>
<li><a href="../fr412869/index.html">Entretien avec un expert en ingénierie tissulaire et médecine régénérative, le professeur Tal Tal Dvir</a></li>
<li><a href="../fr412873/index.html">Disques durs gâtés par le son des haut-parleurs d'ordinateur portable ordinaire</a></li>
<li><a href="../fr412877/index.html">Ruthénium (Ru) - le quatrième élément aux propriétés ferromagnétiques à température ambiante</a></li>
<li><a href="../fr412879/index.html">Numéro 24: Formation informatique - problèmes et défis actuels des grandes entreprises</a></li>
<li><a href="../fr412881/index.html">Björn Straustrup: Problème de programmation</a></li>
<li><a href="../fr412885/index.html">Science pathologique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>