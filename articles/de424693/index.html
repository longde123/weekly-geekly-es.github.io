<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚦 🥤 👎🏻 Hinzufügen eines Wasserzeichens zu allen Bildern der Site 👨‍🎤 👨🏿‍🤝‍👨🏼 🐿️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vom Kunden auf der alten Site kam eine Anwendung, um alle Bilder zu aktualisieren, nämlich ein Wasserzeichen mit einem Logo hinzuzufügen. Das Problem ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hinzufügen eines Wasserzeichens zu allen Bildern der Site</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424693/"><p>  Vom Kunden auf der alten Site kam eine Anwendung, um alle Bilder zu aktualisieren, nämlich ein Wasserzeichen mit einem Logo hinzuzufügen.  Das Problem war, dass es mehr als 10.000 Bilder gab und sie sich in verschiedenen Ordnern und unter Ordnern befanden. </p><br><p>  Wir haben beschlossen, ein universelles Skript zu schreiben, das über die Konsole oder direkt im Browser ausgeführt werden kann, und alle Bilder auf der Website zu aktualisieren. </p><a name="habracut"></a><br><p>  <strong>Und so die Aufgabe:</strong> </p><br><ol><li>  Die Bilder befinden sich im Ordner img im Stammverzeichnis der Site. </li><li>  Fügen Sie der Bildmitte ein Wasserzeichen hinzu. </li><li>  Übertragen Sie alle Bilder in den Ordner img2. </li></ol><br><p>  Bei der Lösung des Problems stellte sich heraus, dass alle Bilder auch unterschiedliche Größen von 200 bis 7000 Pixel haben und das Wasserzeichen in Form eines Logos überhaupt sein sollte. Wie wir dieses Problem gelöst haben: </p><br><h3 id="etap-1-oboyti-vse-fayly">  Stufe 1. Umgehen Sie alle Dateien </h3><br><p>  Zuerst müssen Sie herausfinden, mit was wir arbeiten werden, und dazu haben wir alle Dateien und Ordner angezeigt, die sich im img-Ordner auf der Site befinden. </p><br><pre><code class="php hljs">$path = $_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  $root = $path."/img"; // </span></span></code> </pre> <br><p>  Und die Funktion, alle Elemente des Ordners zu umgehen: </p><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir)</span></span></span><span class="hljs-function"> </span></span>{ $new_dir = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $dir_files = opendir($dir); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> !== ($file = readdir($dir_files))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($file != <span class="hljs-string"><span class="hljs-string">'.'</span></span> &amp;&amp; $file != <span class="hljs-string"><span class="hljs-string">'..'</span></span>) $new_dir[] = $dir.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.$file; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($new_dir) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($new_dir <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $check ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_file($check)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $check . <span class="hljs-string"><span class="hljs-string">"&lt;br&gt;"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>(is_dir($check)) find_new($check); } } find_new($root);</code> </pre> <br><p>  Wie Sie der Auflistung entnehmen können, ist die Funktion rekursiv. Aufgrund der Arbeit dieses Skripts werden auf dem Bildschirm viele Zeilen mit absoluten Pfaden zu den Dateien auf der Site angezeigt. </p><br><p>  Das einzige, was hier nicht implementiert ist, ist die Suche nach Bildern, aber es war für uns nicht nützlich. </p><br><h3 id="etap-2-vossozdat-strukturu-papok">  Stufe 2. Erstellen Sie die Ordnerstruktur neu </h3><br><p>  Da wir viele Ordner mit Unterordnern usw. bis Stufe 10 haben, benötigen wir für den erfolgreichen Betrieb aller Funktionen zum Kopieren und Verschieben von Dateien eine vorgefertigte Struktur. </p><br><p>  Dazu bestimmen wir natürlich den Namen des Ordners und wenn er nicht vorhanden ist, erstellen wir: </p><br><pre> <code class="php hljs">$fileName = basename($check); <span class="hljs-comment"><span class="hljs-comment">//   $new = str_replace("img","img2",$check); //   $put = substr($new,0,-strlen($fileName)); //    if (!file_exists($put)) { mkdir($put, 0777, true); //  ,   }</span></span></code> </pre> <br><p>  Dieser Code wird eingefügt nach: <em>echo $ check;</em>  und wenn es ausgeführt wird, generiert es eine neue Ordnerstruktur auf Ihrem Server, während Sie es unendlich oft ausführen können, es wird die Struktur nicht beschädigen, sondern einen benachbarten img2-Ordner erstellen. </p><br><h3 id="etap-3-dobavit-logotip-na-kartinki">  Stufe 3. Fügen Sie den Bildern ein Logo hinzu </h3><br><p>  Wir werden hierfür vier Standardfunktionen verwenden: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagecreatefrompng</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagecreatefromjpeg</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagecopy</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagejpeg</a> und einige zusätzliche Typen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagedestroy</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">imagesx</a> . </p><br><p>  All dies ist eine GD-Bibliothek für PHP, die standardmäßig für alle verbunden ist und so: </p><br><pre> <code class="php hljs">$stamp = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">'stamp.png'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//,   $sx = imagesx($stamp); //  $sy = imagesy($stamp); // $im = imagecreatefromjpeg($check); //  imagecopy($im, $stamp, imagesx($im) - $sx - 10, imagesy($im) - $sy - 10, 0, 0, imagesx($stamp), imagesy($stamp)); //    imagejpeg($im, $new, 100); //  imagedestroy($im); //  </span></span></code> </pre> <br><p>  Nach 3-5 Minuten des Skripts erhalten wir abhängig von der Anzahl der Dateien eine Kopie aller Bilder im Ordner img2, aber das Logo befindet sich in der unteren rechten Ecke und alle Bilder haben unterschiedliche Größen.  Sie können in der Bildkopie mit Zahlen herumspielen, dies hat jedoch keine Auswirkungen.  Die Bilder sind unterschiedlich, was bedeutet, dass das Wasserzeichen unterschiedlich sein muss, also gehen wir zu Stufe 4. </p><br><h3 id="4-etap-adaptaciya-i-vyravnivanie-logotipa">  4. Stufe.  Anpassung und Ausrichtung des Logos </h3><br><p>  Dazu müssen wir das Original-Logo stamp.png in die Größe des Bildes konvertieren, auf dem wir es platzieren möchten, und genau in die Mitte einfügen. <br>  Weiter: </p><br><pre> <code class="php hljs">$stamp = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">'stamp.png'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//,    2000*1500 $sx = imagesx($stamp); //  $sy = imagesy($stamp); // $im = imagecreatefromjpeg($check); //  ///    $w = imagesx($im) - 20; //    $koe=$sx/$w; //   $h=ceil($sy/$koe); //   //echo $sx."-".$sy." ".$w."-".$h." ".$koe."&lt;BR&gt;"; //   $sim = imagecreatetruecolor($w, $h); //     $transparent = imagecolorallocatealpha($sim, 0, 0, 0, 127); //    imagefill($sim, 0, 0, $transparent); //    imagesavealpha($sim, true); //    imagecopyresampled($sim,$stamp,0,0,0,0,$w,$h,$sx,$sy); //    $sim $cn = ceil((imagesy($im) - $h)/2); //     imagecopy($im, $sim, imagesx($im) - $w - 10, $cn, 0, 0, imagesx($sim), imagesy($sim)); //   </span></span></code> </pre> <br><p>  Wenn wir in Stufe 3 in der Bildkopie imagesx ($ stamp) als Abmessungen des eingefügten Bildes verwendet haben, verwenden wir hier bereits die Abmessungen des neuen Logos imagesx ($ sim). </p><br><p>  Das Logo enthält links und rechts Einrückungen von 10 Pixel und wird durch die Zahlen 20 und 10 im Code festgelegt. </p><br><h3 id="etap-5-dobavlyaem-funkciyu-preobrazovaniya-v-nash-cikl">  Schritt 5. Fügen Sie die Konvertierungsfunktion zu unserer Schleife hinzu: </h3><br><p>  Da das Skript auf dem Knie sein sollte, kann es natürlich vereinfacht und verbessert werden, Ihre Vorschläge in den Kommentaren.  Aber hier ist eine funktionierende Version: </p><br><pre> <code class="php hljs">path = $_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>]; $root = $path.<span class="hljs-string"><span class="hljs-string">"/img"</span></span>; $stamp = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">'stamp.png'</span></span>); $sx = imagesx($stamp); $sy = imagesy($stamp); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dir)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $stamp; <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $sx; <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $sy; $new_dir = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $dir_files = opendir($dir); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> !== ($file = readdir($dir_files))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($file != <span class="hljs-string"><span class="hljs-string">'.'</span></span> &amp;&amp; $file != <span class="hljs-string"><span class="hljs-string">'..'</span></span>) $new_dir[] = $dir.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.$file; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($new_dir) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($new_dir <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $check ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_file($check)) { $w=<span class="hljs-string"><span class="hljs-string">''</span></span>;$h=<span class="hljs-string"><span class="hljs-string">''</span></span>;$koe=<span class="hljs-string"><span class="hljs-string">''</span></span>;$sim=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">//echo $check . "&lt;br&gt;"; $im = imagecreatefromjpeg($check); ///    $w = imagesx($im) - 20; //    $koe=$sx/$w; $h=ceil($sy/$koe); //  //echo $sx."-".$sy." ".$w."-".$h." ".$koe."&lt;BR&gt;"; $sim = imagecreatetruecolor($w, $h); $transparent = imagecolorallocatealpha($sim, 0, 0, 0, 127); //    imagefill($sim, 0, 0, $transparent); //    imagesavealpha($sim, true); //    imagecopyresampled($sim,$stamp,0,0,0,0,$w,$h,$sx,$sy); $cn = ceil((imagesy($im) - $h)/2); //     //    imagecopy($im, $sim, imagesx($im) - $w - 10, $cn, 0, 0, imagesx($sim), imagesy($sim)); $fileName = basename($check); $put = substr($check,0,-strlen($fileName)); $put = str_replace("img","cache",$put); if (!file_exists($put)) { mkdir($put, 0777, true); } $new = str_replace("img","cache",$check); imagejpeg($im, $new, 100); imagedestroy($im); } elseif(is_dir($check)) find_new($check); } } find_new($root);</span></span></code> </pre> <br><p>  Es reicht aus, es in den Stammordner der Site zu legen, den Quell- und Zielordner mit Bildern festzulegen und auszuführen, wenn viele Bilder vorhanden sind.  Zuerst hinzufügen: </p><br><pre> <code class="php hljs">ignore_user_abort(); set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p>  Und laufen Sie von der Konsole aus, um die Arbeitsschritte zu sehen. </p><br><p>  Experimente zum Einfügen des Logos und zum Auswählen des Transparenzgrads werden am besten im Zielordner durchgeführt, dazu in der Zeile $ root = $ path. ”/ Add / your / path / to / folders” oder legen Sie das Skript in den Zielordner und führen Sie es von dort aus. </p><br><p>  Wir haben ein Standard-Firmenlogo mit 60% Transparenz verwendet. </p><br><h3 id="zaklyuchenie">  Fazit </h3><br><p>  Wenn der Ordner mit den neuen Dateien fertig ist, müssen Sie ihn nur von img2 in img umbenennen.  Infolgedessen verfügt Ihre Site über einen Ordner mit Quelldateien, die archiviert oder gelöscht werden können, und einen Ordner mit Fotos, die mit einem Logo gekennzeichnet sind. </p><br><p>  Dieses Skript ist für die Verwendung in Projekten relevant, in denen bereits Bilder von Produkten oder Artikeln hochgeladen wurden, und es gibt keine Möglichkeit, ein Skript zum Hinzufügen eines Wasserzeichens zu installieren, oder überhaupt nicht. </p><br><p>  Die nächste Aufgabe besteht darin, exif-Daten auf allen Bildern derselben Site zu ersetzen.  Was es ist und wie es implementiert wird, erfahren Sie im nächsten Artikel. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de424693/">https://habr.com/ru/post/de424693/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de424683/index.html">90 neue Funktionen (und APIs) in JDK 11</a></li>
<li><a href="../de424685/index.html">Die US-amerikanische Börsenaufsichtsbehörde (Securities and Exchange Commission) reichte eine Klage gegen den Chef von Tesla Elon Musk ein, auch wegen Betrugs</a></li>
<li><a href="../de424687/index.html">Das sind die richtigen Bienen: mechanische Anpassung an dynamische Effekte</a></li>
<li><a href="../de424689/index.html">Die Kontrolle über die Situation macht glücklich.</a></li>
<li><a href="../de424691/index.html">Wir laden Sie zur Konferenz Azov Developers Meetup 2018 - 13. Oktober in Taganrog ein</a></li>
<li><a href="../de424695/index.html">RedSlerm verwandelt sich in eine Kammer und eine einmalige Veranstaltung</a></li>
<li><a href="../de424697/index.html">Gehen Sie in Hunderttausenden von Zeilen gegen Excel</a></li>
<li><a href="../de424699/index.html">Willkommen zum praktischen Workshop API Jam</a></li>
<li><a href="../de424701/index.html">Fiktive IT-Geschichten über Betrüger und warum diese obskuren Praktiken bei Interviews auftauchten</a></li>
<li><a href="../de424703/index.html">Und wieder über Depersonalisierung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>