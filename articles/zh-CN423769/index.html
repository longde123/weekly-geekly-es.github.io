<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘°ğŸ¼ ğŸ§ ğŸ–ğŸ» å°†OpenSSLè¿æ¥åˆ°Mono ğŸ•µï¸ ğŸŠ ğŸœ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œä»‹ç»äº†å°†CryptoProçš„GOSTè¯ä¹¦ä¸monoé›†æˆçš„è¿‡ç¨‹ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»è¿æ¥RSAè¯ä¹¦ã€‚ 


 æˆ‘ä»¬ç»§ç»­å°†ç”¨Cï¼ƒç¼–å†™çš„æœåŠ¡å™¨ç³»ç»Ÿä¹‹ä¸€ç§»æ¤åˆ°Linuxï¼Œå¹¶ä¸”é˜Ÿåˆ—åˆ°è¾¾äº†ä¸RSAç›¸å…³çš„éƒ¨åˆ†ã€‚ å¦‚æœæœ€åä¸€æ¬¡è¿æ¥ä¸Šçš„å›°éš¾å¯ä»¥é€šè¿‡æœ€åˆæ²¡æœ‰ç›¸äº’è¿æ¥çš„ä¸¤ä¸ªç³»ç»Ÿçš„äº¤äº’æ¥è½»æ¾è§£é‡Šï¼Œé‚£ä¹ˆå½“ä»...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å°†OpenSSLè¿æ¥åˆ°Mono</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423769/"><p> åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œä»‹ç»äº†å°†CryptoProçš„GOSTè¯ä¹¦ä¸monoé›†æˆçš„è¿‡ç¨‹ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»è¿æ¥RSAè¯ä¹¦ã€‚ </p><br><p> æˆ‘ä»¬ç»§ç»­å°†ç”¨Cï¼ƒç¼–å†™çš„æœåŠ¡å™¨ç³»ç»Ÿä¹‹ä¸€ç§»æ¤åˆ°Linuxï¼Œå¹¶ä¸”é˜Ÿåˆ—åˆ°è¾¾äº†ä¸RSAç›¸å…³çš„éƒ¨åˆ†ã€‚ å¦‚æœæœ€åä¸€æ¬¡è¿æ¥ä¸Šçš„å›°éš¾å¯ä»¥é€šè¿‡æœ€åˆæ²¡æœ‰ç›¸äº’è¿æ¥çš„ä¸¤ä¸ªç³»ç»Ÿçš„äº¤äº’æ¥è½»æ¾è§£é‡Šï¼Œé‚£ä¹ˆå½“ä»monoè¿æ¥â€œæ™®é€šâ€ RSAè¯ä¹¦æ—¶ï¼Œæ²¡æœ‰äººä¼šé‡åˆ°éº»çƒ¦ã€‚ </p><br><a name="habracut"></a><br><p> å®‰è£…è¯ä¹¦å’Œå¯†é’¥ä¸ä¼šå¼•èµ·é—®é¢˜ï¼Œç³»ç»Ÿç”šè‡³å¯ä»¥åœ¨æ ‡å‡†å­˜å‚¨ä¸­çœ‹åˆ°å®ƒã€‚ ä½†æ˜¯ï¼Œä¸å†å¯èƒ½å¯¹ä»¥å‰ç”Ÿæˆçš„ç­¾åè¿›è¡Œç­¾åï¼ŒåŠ å¯†æˆ–æå–æ•°æ®-å•å£°é“ç¨³å®šåœ°å‡ºç°é”™è¯¯ã€‚ ä¸CryptoProä¸€æ ·ï¼Œæˆ‘å¿…é¡»ç›´æ¥è¿æ¥åˆ°åŠ å¯†åº“ã€‚ å¯¹äºLinuxä¸­çš„RSAè¯ä¹¦ï¼Œè¿™ç§è¿æ¥çš„ä¸»è¦å€™é€‰è€…æ˜¯OpenSSLã€‚ </p><br><h2> è¯ä¹¦å®‰è£… </h2><br><p> å¹¸è¿çš„æ˜¯ï¼ŒCentos 7å…·æœ‰å†…ç½®ç‰ˆæœ¬çš„OpenSSL-1.0.2kã€‚ ä¸ºäº†ä¸ç»™ç³»ç»Ÿå¸¦æ¥å…¶ä»–éº»çƒ¦ï¼Œæˆ‘ä»¬å†³å®šè¿æ¥åˆ°è¯¥ç‰ˆæœ¬ã€‚  OpenSSLå…è®¸æ‚¨åˆ›å»ºç‰¹æ®Šçš„æ–‡ä»¶è¯ä¹¦å­˜å‚¨ï¼Œä½†æ˜¯ï¼š </p><br><ol><li> è¿™æ ·çš„å•†åº—åŒ…å«è¯ä¹¦å’ŒCRLï¼Œè€Œä¸æ˜¯ç§é’¥ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬å°†å¿…é¡»å•ç‹¬å­˜å‚¨ï¼› </li><li> åœ¨Windowsä¸­ä»¥ä¸å®‰å…¨çš„å½¢å¼å°†è¯ä¹¦å’Œç§é’¥å­˜å‚¨åœ¨ç£ç›˜ä¸Šæ˜¯â€œæåº¦ä¸å®‰å…¨çš„â€ï¼ˆè´Ÿè´£æ•°å­—å®‰å…¨æ€§çš„äººå‘˜é€šå¸¸å°†å…¶æè¿°å¾—æ›´å®½æ³›ä¸”å®¡æŸ¥è¾ƒå°‘ï¼‰ï¼Œè¯´å®è¯ï¼Œè¿™åœ¨Linuxä¸­ä¸æ˜¯å¾ˆå®‰å…¨ï¼Œä½†æ˜¯å®é™…ä¸Šå¾ˆå¸¸è§ç»ƒä¹  </li><li> åœ¨Windowså’ŒLinuxä¸Šåè°ƒæ­¤ç±»å­˜å‚¨åº“çš„ä½ç½®éå¸¸å›°éš¾ï¼› </li><li> åœ¨æ‰‹åŠ¨å®æ–½å­˜å‚¨çš„æƒ…å†µä¸‹ï¼Œå°†éœ€è¦å®ç”¨ç¨‹åºæ¥ç®¡ç†è¯ä¹¦é›†ï¼› </li><li>  monoæœ¬èº«ä½¿ç”¨å…·æœ‰OpenSSLç»“æ„çš„ç£ç›˜å­˜å‚¨ï¼Œå¹¶ä¸”è¿˜åœ¨é™„è¿‘ä»¥å¼€æ”¾å½¢å¼å­˜å‚¨ç§é’¥ï¼› </li></ol><br> ç”±äºè¿™äº›åŸå› ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ ‡å‡†çš„.Netå’Œmonoè¯ä¹¦å­˜å‚¨åŒºæ¥è¿æ¥OpenSSLã€‚ ä¸ºæ­¤ï¼Œåœ¨Linuxä¸Šï¼Œå¿…é¡»é¦–å…ˆå°†è¯ä¹¦å’Œç§é’¥æ”¾åœ¨monoå­˜å‚¨åº“ä¸­ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">è¯ä¹¦å®‰è£…</b> <div class="spoiler_text">æˆ‘ä»¬å°†ä¸ºæ­¤ä½¿ç”¨æ ‡å‡†certmgrå®ç”¨ç¨‹åºã€‚ é¦–å…ˆï¼Œä»pfxå®‰è£…ç§é’¥ï¼š <br><br> <code>certmgr -importKey -c -p {password} My {pfx file}</code> <br> <br> ç„¶åæˆ‘ä»¬å°†è¿™ä¸ªpfxä¸­çš„è¯ä¹¦æ”¾å…¥ï¼Œç§é’¥å°†è‡ªåŠ¨è¿æ¥åˆ°å®ƒï¼š <br><br> <code>certmgr -add -c My {cer file}</code> <br> <br> å¦‚æœè¦å°†å¯†é’¥å®‰è£…åœ¨è®¡ç®—æœºçš„å­˜å‚¨å™¨ä¸­ï¼Œåˆ™å¿…é¡»æ·»åŠ -mé€‰é¡¹ã€‚ <br><br> ä¹‹åï¼Œå¯ä»¥åœ¨å­˜å‚¨åº“ä¸­çœ‹åˆ°è¯ä¹¦ï¼š <br><br> <code>certmgr -list -c -v My</code> <br> <br> æ³¨æ„å‘è¡Œã€‚ åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œè¯ä¹¦å¯¹ç³»ç»Ÿæ˜¯å¯è§çš„ï¼Œå¹¶ä¸”ä¸æ—©å…ˆä¸‹è½½çš„ç§é’¥ç»‘å®šã€‚ ä¹‹åï¼Œæ‚¨å¯ä»¥ç»§ç»­è¿›è¡Œä»£ç ä¸­çš„è¿æ¥ã€‚ <br></div></div><br><h2> ä»£ç è¿æ¥ </h2><br><p> ä¸ä¸Šæ¬¡ä¸€æ ·ï¼Œè¯¥ç³»ç»Ÿå°½ç®¡å·²ç§»æ¤åˆ°Linuxï¼Œä½†ä»åº”åœ¨Windowsç¯å¢ƒä¸­ç»§ç»­è¿è¡Œã€‚ å› æ­¤ï¼Œä»å¤–éƒ¨çœ‹ï¼Œåº”é€šè¿‡â€œ byte [] SignDataï¼ˆbyte [] _arDataï¼ŒX509Certificate2 _pCertï¼‰â€å½¢å¼çš„é€šç”¨æ–¹æ³•æ¥è¿›è¡ŒåŠ å¯†ï¼Œè¿™åœ¨Linuxå’ŒWindowsä¸­å‡åº”ç›¸åŒã€‚ </p><br><p> ç†æƒ³æƒ…å†µä¸‹ï¼Œæ— è®ºè¯ä¹¦çš„ç±»å‹å¦‚ä½•ï¼ˆåœ¨Linuxä¸Šé€šè¿‡OpenSSLæˆ–CryptoProå–å†³äºè¯ä¹¦ï¼Œåœ¨Windowsä¸Šé€šè¿‡crypt32ï¼‰ï¼Œéƒ½åº”å…·æœ‰ä¸Windowsä¸€æ ·æœ‰æ•ˆçš„æ–¹æ³•ã€‚ </p><br><p> å¯¹OpenSSLåº“çš„åˆ†æè¡¨æ˜ï¼Œåœ¨Windowsä¸Šï¼Œä¸»åº“æ˜¯â€œ libeay32.dllâ€ï¼Œåœ¨Linuxä¸Šï¼Œä¸»åº“æ˜¯â€œ libcrypto.so.10â€ã€‚ ä¸ä¸Šæ¬¡ä¸€æ ·ï¼Œæˆ‘ä»¬å½¢æˆä¸¤ä¸ªç±»WOpenSSLAPIå’ŒLOpenSSLAPIï¼Œå…¶ä¸­åŒ…å«åº“åº“æ–¹æ³•çš„åˆ—è¡¨ï¼š <br><br></p><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(CTRYPTLIB, CharSet = CharSet.Auto, SetLastError = true, CallingConvention = CallingConvention.Cdecl)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OPENSSL_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br><p> ä¸CryptoProä¸åŒï¼Œè¯·æ³¨æ„è°ƒç”¨çº¦å®šï¼Œåœ¨æ­¤å¿…é¡»æ˜ç¡®æŒ‡å®šã€‚ è¿™æ¬¡å¿…é¡»åŸºäº* .h OpenSSLæº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ä»¶</a>ç‹¬ç«‹ç”Ÿæˆç”¨äºè¿æ¥æ¯ç§æ–¹æ³•çš„è¯­æ³•ã€‚ </p><br><p> åŸºäº.hæ–‡ä»¶ä¸­çš„æ•°æ®åœ¨Cï¼ƒä¸­ç”Ÿæˆè°ƒç”¨è¯­æ³•çš„åŸºæœ¬è§„åˆ™å¦‚ä¸‹ï¼š </p><br><ol><li>  -ç»“æ„ï¼Œå­—ç¬¦ä¸²ç­‰çš„ä»»ä½•é“¾æ¥ã€‚-IntPtrï¼ŒåŒ…æ‹¬ç»“æ„æœ¬èº«å†…éƒ¨çš„é“¾æ¥ï¼› </li><li> é“¾æ¥åˆ°é“¾æ¥-ref IntPtrï¼Œå¦‚æœæ­¤é€‰é¡¹ä¸èµ·ä½œç”¨ï¼Œåˆ™ä»…IntPtrã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¿…é¡»è‡ªå·±æ‰‹åŠ¨æ”¾ç½®å’Œåˆ é™¤é“¾æ¥ã€‚ </li><li> æ•°ç»„-å­—èŠ‚[]; </li><li>  Cè¯­è¨€ä¸­çš„longï¼ˆOpenSSLï¼‰æ˜¯Cï¼ƒä¸­çš„intï¼ˆä¹ä¸€çœ‹ï¼Œå¾ˆå°çš„é”™è¯¯å¯èƒ½ä¼šèŠ±è´¹æ•°å°æ—¶æ¥å¯»æ‰¾ä¸å¯é¢„æµ‹çš„é”™è¯¯çš„æ¥æºï¼‰ï¼› </li></ol><br><p> åœ¨å£°æ˜ä¸­ï¼Œå‡ºäºä¹ æƒ¯ï¼Œæ‚¨å¯ä»¥æŒ‡å®šSetLastError = trueï¼Œä½†æ˜¯è¯¥åº“å°†å¿½ç•¥æ­¤é”™è¯¯-é€šè¿‡Marshal.GetLastWin32Errorï¼ˆï¼‰æ— æ³•è·å¾—é”™è¯¯ã€‚  OpenSSLæ‹¥æœ‰è‡ªå·±çš„é”™è¯¯è®¿é—®æ–¹æ³•ã€‚ </p><br><p> ç„¶åï¼Œæˆ‘ä»¬å½¢æˆå·²ç»ç†Ÿæ‚‰çš„é™æ€ç±»â€œ UOpenSSLAPIâ€ï¼Œæ ¹æ®ç³»ç»Ÿçš„ä¸åŒï¼Œè¯¥ç±»å°†è°ƒç”¨ä»¥ä¸‹ä¸¤ä¸ªç±»ä¹‹ä¸€çš„æ–¹æ³•ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> fpOSSection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OPENSSL_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (pOSSection) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) LOpenSSLAPI.OPENSSL_init(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> WOpenSSLAPI.OPENSSL_init(); } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> pOSSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fpOSSection; } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fIsLinux { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iPlatform = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Environment.OSVersion.Platform; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (iPlatform == <span class="hljs-number"><span class="hljs-number">4</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">6</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">128</span></span>); } }</code> </pre><br><p> æˆ‘ä»¬ç«‹å³æ³¨æ„åˆ°å­˜åœ¨å…³é”®éƒ¨åˆ†ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç†è®ºä¸Šè®²ï¼Œ</a> OpenSSLåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æä¾›å·¥ä½œã€‚ ä½†æ˜¯ï¼Œé¦–å…ˆï¼Œåœ¨æè¿°ä¸­ç«‹å³è¯´ä¸èƒ½ä¿è¯ï¼š </p><br><blockquote> ä½†æ˜¯æ‚¨ä»ç„¶ä¸èƒ½åŒæ—¶åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å¤§å¤šæ•°å¯¹è±¡ã€‚ </blockquote><br><p> å…¶æ¬¡ï¼Œè¿æ¥æ–¹æ³•ä¸æ˜¯æœ€ç®€å•çš„ã€‚ ä½¿ç”¨è¿™æ ·çš„å…³é”®éƒ¨åˆ†æ—¶ï¼Œé€šå¸¸çš„åŒæ ¸VMï¼ˆå¸¦æœ‰Intel Xeon E5649å¤„ç†å™¨çš„æœåŠ¡å™¨å¤„äºè¶…çº¿ç¨‹æ¨¡å¼ï¼‰åœ¨ä½¿ç”¨è¿™æ ·çš„å…³é”®éƒ¨åˆ†æ—¶å¤§çº¦æ¯ç§’æä¾›100ä¸ªå®Œæ•´å‘¨æœŸï¼ˆè¯·å‚é˜…ä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€ç¯‡æ–‡ç« </a>çš„æµ‹è¯•ç®—æ³•ï¼‰æˆ–600ä¸ªç­¾åï¼ŒåŸºæœ¬ä¸Šè¶³ä»¥åº”ä»˜å¤§å¤šæ•°ä»»åŠ¡ï¼ˆåœ¨é‡è´Ÿè½½ä¸‹ï¼Œæ— è®ºå¦‚ä½•éƒ½å°†ä½¿ç”¨ç³»ç»Ÿçš„å¾®æœåŠ¡æˆ–èŠ‚ç‚¹ä½“ç³»ç»“æ„ã€‚ </p><br><h2> åˆå§‹åŒ–å’Œå¸è½½OpenSSL </h2><br><p> ä¸CryptoProä¸åŒï¼ŒOpenSSLåœ¨å¼€å§‹ä½¿ç”¨å®ƒå’Œå®Œæˆä½¿ç”¨åº“ä¹‹åéœ€è¦é‡‡å–æŸäº›æªæ–½ï¼š <br><br></p><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitOpenSSL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { UOpenSSLAPI.OPENSSL_init(); UOpenSSLAPI.ERR_load_crypto_strings(); UOpenSSLAPI.ERR_load_RSA_strings(); UOpenSSLAPI.OPENSSL_add_all_algorithms_conf(); UOpenSSLAPI.OpenSSL_add_all_ciphers(); UOpenSSLAPI.OpenSSL_add_all_digests(); } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CleanupOpenSSL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { UOpenSSLAPI.EVP_cleanup(); UOpenSSLAPI.CRYPTO_cleanup_all_ex_data(); UOpenSSLAPI.ERR_free_strings(); }</code> </pre><br><br><h2> é”™è¯¯ä¿¡æ¯ </h2><br><p>  OpenSSLå°†é”™è¯¯ä¿¡æ¯å­˜å‚¨åœ¨åº“ä¸­æœ‰ç‰¹æ®Šæ–¹æ³•çš„å†…éƒ¨ç»“æ„ä¸­ã€‚ ä¸å¹¸çš„æ˜¯ï¼ŒæŸäº›ç®€å•çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ERR_error_stringï¼‰æ˜¯ä¸ç¨³å®šçš„ï¼Œå› æ­¤æ‚¨å¿…é¡»ä½¿ç”¨æ›´å¤æ‚çš„æ–¹æ³•ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è·å–é”™è¯¯ä¿¡æ¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iErr"&gt; &lt;/param&gt; * &lt;param name="_iPart"&gt;&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetErrStrPart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ulong</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iErr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iPart</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    IntPtr hErrStr = IntPtr.Zero; switch (_iPart) { case 0: hErrStr = UOpenSSLAPI.ERR_lib_error_string(_iErr); break; case 1: hErrStr = UOpenSSLAPI.ERR_func_error_string(_iErr); break; case 2: hErrStr = UOpenSSLAPI.ERR_reason_error_string(_iErr); break; } // 1)   return PtrToFirstStr(hErrStr); } /**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iErr"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/ public static string GetErrStr(ulong _iErr ) { return UCConsts.S_GEN_LIB_ERR_MAKRO.Frm(_iErr, GetErrStrPart(_iErr, 0), GetErrStrPart(_iErr, 1), GetErrStrPart(_iErr, 2)); } /**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;returns&gt; &lt;/returns&gt; * **/ public static string GetErrStrOS() { return GetErrStr(UOpenSSLAPI.ERR_get_error()); }</span></span></code> </pre></div></div><br><p>  OpenSSLä¸­çš„é”™è¯¯åŒ…å«æœ‰å…³å‘ç”Ÿé”™è¯¯çš„åº“ï¼Œæ–¹æ³•å’ŒåŸå› çš„ä¿¡æ¯ã€‚ å› æ­¤ï¼Œåœ¨æ¥æ”¶åˆ°é”™è¯¯ä»£ç æœ¬èº«ä¹‹åï¼Œæœ‰å¿…è¦åˆ†åˆ«æå–æ‰€æœ‰è¿™ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨æ–‡æœ¬è¡Œä¸­ã€‚ æ ¹æ®OpenSSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ï¼Œ</a>æ¯è¡Œçš„é•¿åº¦ä¸è¶…è¿‡120ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬ä½¿ç”¨æ‰˜ç®¡ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è°¨æ…åœ°ä»é“¾æ¥ä¸­æå–è¯¥è¡Œï¼š </p><br><div class="spoiler">  <b class="spoiler_title">é€šè¿‡IntPtrè·å–å­—ç¬¦ä¸²</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    PChar     _iLen&lt;/summary&gt; * &lt;param name="_hPtr"&gt;    &lt;/param&gt; * &lt;param name="_iLen"&gt;  &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PtrToFirstStr</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hPtr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iLen = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(_hPtr == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arStr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[_iLen]; Marshal.Copy(_hPtr, arStr, <span class="hljs-number"><span class="hljs-number">0</span></span>, arStr.Length); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] arRes = Encoding.ASCII.GetString(arStr).Split(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] { (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span> }, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arRes.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arRes[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre></div></div><br><p> æ£€æŸ¥è¯ä¹¦æ—¶çš„é”™è¯¯ä¸å±äºå¸¸è§„åˆ—è¡¨ï¼Œå¿…é¡»æ ¹æ®éªŒè¯ä¸Šä¸‹æ–‡é€šè¿‡å•ç‹¬çš„æ–¹æ³•æå–å®ƒä»¬ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ”¶åˆ°è¯ä¹¦éªŒè¯é”™è¯¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hStoreCtx"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCertVerifyErr</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hStoreCtx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iErr = UOpenSSLAPI.X509_STORE_CTX_get_error(_hStoreCtx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PtrToFirstStr(UOpenSSLAPI.X509_verify_cert_error_string(iErr)); }</code> </pre></div></div><br><h2> è¯ä¹¦æœå¯» </h2><br><p> ä¸å¾€å¸¸ä¸€æ ·ï¼ŒåŠ å¯†ä»è¯ä¹¦æœç´¢å¼€å§‹ã€‚ æˆ‘ä»¬ä½¿ç”¨å…¨æ—¶å­˜å‚¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨å¸¸è§„æ–¹æ³•è¿›è¡Œæœç´¢ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è¯ä¹¦æœå¯»</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  (   )&lt;/summary&gt; * &lt;param name="_pFindType"&gt; &lt;/param&gt; * &lt;param name="_pFindValue"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_pName"&gt; &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerify"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindCertificateOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _pFindValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser, StoreName _pName = StoreName.My, X509FindType _pFindType = X509FindType.FindByThumbprint, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerify = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (UOpenSSLAPI.pOSSection) { <span class="hljs-comment"><span class="hljs-comment">// 0)    _pCert = null; X509Store pStore = new X509Store(_pName, _pLocation); X509Certificate2Collection pCerts = null; try { // 1)   pStore.Open(OpenFlags.ReadOnly); // 2)    ( , .. Verify  Linux  false) pCerts = pStore.Certificates.Find(_pFindType, _pFindValue, false); if (pCerts.Count == 0) return UConsts.E_NO_CERTIFICATE; // 3)     if (!_fVerify) { _pCert = ISDP_X509Cert.Create(pCerts[0], TCryptoPath.cpOpenSSL); return UConsts.S_OK; } // 4)       foreach (X509Certificate2 pCert in pCerts) { ISDP_X509Cert pISDPCert = ISDP_X509Cert.Create(pCert, TCryptoPath.cpOpenSSL); if (pISDPCert.ISDPVerify()) { _pCert = pISDPCert; return UConsts.S_OK; } } return UConsts.E_NO_CERTIFICATE; } finally { if(pCerts != null) pCerts.Clear(); pStore.Close(); } } }</span></span></code> </pre></div></div><br><p> æ³¨æ„å…³é”®éƒ¨åˆ†ã€‚ å…·æœ‰è¯ä¹¦çš„å•å£°é“ä¹Ÿå¯ä»¥é€šè¿‡OpenSSLï¼Œä½†ä¸èƒ½é€šè¿‡UOpenSSLAPIä½¿ç”¨ã€‚ å¦‚æœæ‚¨åœ¨æ­¤å¤„ä¸æ‰§è¡Œæ­¤æ“ä½œï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å¹¶åœ¨è´Ÿè½½ä¸‹æµ®åŠ¨éš¾ä»¥ç†è§£çš„é”™è¯¯ã€‚ </p><br><p> ä¸»è¦åŠŸèƒ½æ˜¯åˆ›å»ºè¯ä¹¦ã€‚ ä¸CryptoProçš„ç‰ˆæœ¬ä¸åŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»å•†åº—ä¸­è·å–è¯ä¹¦æœ¬èº«ï¼ˆX509Certificate2ï¼‰ï¼Œå¹¶ä¸”å…¶ä¸­Handleä¸­çš„é“¾æ¥å·²å®šå‘åˆ°OpenSSLç»“æ„X509_stã€‚ ä¼¼ä¹æœ‰å¿…è¦ï¼Œä½†æ˜¯è¯ä¹¦ä¸­æ²¡æœ‰æŒ‡å‘EVP_PKEYï¼ˆæŒ‡å‘OpenSSLä¸­çš„ç§é’¥ç»“æ„çš„é“¾æ¥ï¼‰çš„æŒ‡é’ˆã€‚ <br></p><p> äº‹å®è¯æ˜ï¼Œç§é’¥æœ¬èº«ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨åœ¨è¯ä¹¦çš„å†…éƒ¨å­—æ®µä¸­-impl / fallback / _cert / _rsa / rsaã€‚ è¿™æ˜¯RSAManagedç±»ï¼Œå¿«é€Ÿæµè§ˆå…¶ä»£ç ï¼ˆä¾‹å¦‚ï¼Œ <a href="">DecryptValue</a>æ–¹æ³•ï¼‰å¯æ˜¾ç¤ºåŠ å¯†æŠ€æœ¯çš„å•å£°é“æœ‰å¤šç³Ÿç³•ã€‚ ä»–ä»¬ä¼¼ä¹æ²¡æœ‰è¯šå®åœ°ä½¿ç”¨OpenSSLåŠ å¯†æŠ€æœ¯ï¼Œè€Œæ˜¯æ‰‹åŠ¨å®ç°äº†å‡ ç§ç®—æ³•ã€‚ ä»–ä»¬çš„é¡¹ç›®çš„OpenSSLæ–¹æ³•ï¼ˆä¾‹å¦‚CMS_finalï¼ŒCMS_signæˆ–CMS_ContentInfo_newï¼‰çš„ç©ºæœç´¢ç»“æœæ”¯æŒæ­¤å‡è®¾ã€‚ æ²¡æœ‰å®ƒä»¬ï¼Œå¾ˆéš¾æƒ³è±¡æ ‡å‡†CMSç­¾åç»“æ„çš„å½¢æˆã€‚ åŒæ—¶ï¼Œä½¿ç”¨è¯ä¹¦çš„å·¥ä½œéƒ¨åˆ†æ˜¯é€šè¿‡OpenSSLè¿›è¡Œçš„ã€‚ </p><br><p> è¿™æ„å‘³ç€ç§é’¥å°†å¿…é¡»ä»monoå¸è½½å¹¶é€šè¿‡pemåŠ è½½åˆ°EVP_PKEYä¸­ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å†æ¬¡éœ€è¦X509Certificateçš„ç±»ç»§æ‰¿è€…ï¼Œè¯¥ç±»ç»§æ‰¿è€…å°†å­˜å‚¨æ‰€æœ‰å…¶ä»–é“¾æ¥ã€‚ </p><br><p> è¿™åªæ˜¯å°è¯•ï¼Œä¾‹å¦‚åœ¨CryptoProä¸­ä»Handleåˆ›å»ºæ–°è¯ä¹¦çš„æƒ…å†µä¸‹-ä¹Ÿä¸ä¼šæˆåŠŸï¼ˆç”±äºé”™è¯¯è€Œå¯¼è‡´çš„å•æ¬¡å´©æºƒï¼‰ï¼Œå¹¶ä¸”åŸºäºæ¥æ”¶åˆ°çš„è¯ä¹¦è¿›è¡Œåˆ›å»ºä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ å› æ­¤ï¼Œå”¯ä¸€çš„é€‰æ‹©æ˜¯åŸºäºåŒ…å«pemçš„å­—èŠ‚æ•°ç»„åˆ›å»ºè¯ä¹¦ã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å¾—PEMè¯ä¹¦ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è·å¾—PEMè¯ä¹¦</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_fBase64"&gt; Base64&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCerFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fBase64 = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { _arData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arData = _pCert.Export(X509ContentType.Cert); <span class="hljs-comment"><span class="hljs-comment">// 0) DER if (!_fBase64) { _arData = arData; return UConsts.S_OK; } // 1) Base64 using (TextWriter pWriter = new StringWriter()) { pWriter.WriteLine(UCConsts.S_PEM_BEGIN_CERT); pWriter.WriteLine(Convert.ToBase64String(arData, Base64FormattingOptions.InsertLineBreaks)); pWriter.WriteLine(UCConsts.S_PEM_END_CERT); // 1.2)   _arData = Encoding.UTF8.GetBytes(pWriter.ToString()); } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_TO_PEM_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p> æ— éœ€ç§äººå¯†é’¥å³å¯è·å–è¯ä¹¦ï¼Œæˆ‘ä»¬å°†å…¶è‡ªèº«è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå•ç‹¬çš„å­—æ®µæ¥é“¾æ¥åˆ°ENV_PKEYï¼š </p><br><div class="spoiler">  <b class="spoiler_title">åŸºäºPEMç§é’¥ç”ŸæˆENV_PKEY</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL    (EVP_PKEY)    &lt;/summary&gt; * &lt;remarks&gt;      PEM&lt;/remarks&gt; * &lt;param name="_arData"&gt;   &lt;/param&gt; * &lt;returns&gt;   (EVP_PKEY)&lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetENV_PKEYOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData</span></span></span><span class="hljs-function">)</span></span> { IntPtr hBIOPem = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   BIO hBIOPem = UOpenSSLAPI.BIO_new_mem_buf( _arData, _arData.Length); if (hBIOPem == IntPtr.Zero) return IntPtr.Zero; IntPtr hKey = IntPtr.Zero; // 1)     UOpenSSLAPI.PEM_read_bio_PrivateKey(hBIOPem, ref hKey, IntPtr.Zero, 0); return hKey; } finally { if(hBIOPem != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOPem); } }</span></span></code> </pre></div></div><br><p> ä¸Šä¼ çš„PEMç§é’¥ï¼Œä»»åŠ¡æ¯”PEMè¯ä¹¦è¦å›°éš¾å¾—å¤šï¼Œä½†å®ƒå·²ç»è¢«æè¿°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a> ã€‚ è¯·æ³¨æ„ï¼Œå¸è½½ç§é’¥æ˜¯ä¸€é¡¹â€œæå…¶ä¸å®‰å…¨â€çš„å·¥ä½œï¼Œåº”ä»å„ä¸ªæ–¹é¢é¿å…è¿™ç§æƒ…å†µã€‚ å¹¶ä¸”ç”±äºè¦ä½¿ç”¨OpenSSLå¿…é¡»è¿›è¡Œæ­¤ç±»å¸è½½ï¼Œå› æ­¤åœ¨Windowsä¸­ï¼Œä½¿ç”¨æ­¤åº“æ—¶æœ€å¥½ä½¿ç”¨crypt32.dllæ–¹æ³•æˆ–å¸¸è§„.Netç±»ã€‚ åœ¨Linuxä¸­ï¼Œç›®å‰ï¼Œæ‚¨å¿…é¡»åƒè¿™æ ·å·¥ä½œã€‚ </p><br><p> è¿˜åº”è®°ä½ï¼Œç”Ÿæˆçš„é“¾æ¥æŒ‡ç¤ºéæ‰˜ç®¡å†…å­˜åŒºåŸŸï¼Œå¿…é¡»å°†å…¶é‡Šæ”¾ã€‚ å› ä¸º  .Net 4.5ä¸­çš„X509Certificate2ä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦åœ¨ææ„å‡½æ•°ä¸­æ‰§è¡Œæ­¤æ“ä½œ </p><br><h2> ç­¾æ”¶ </h2><br><p> è¦ç­¾åOpenSSLï¼Œå¯ä»¥ä½¿ç”¨ç®€åŒ–çš„CMS_signæ–¹æ³•ï¼Œä½†æ˜¯ï¼Œå®ƒä¾èµ–äºé€‰æ‹©ç®—æ³•çš„é…ç½®æ–‡ä»¶ï¼Œè¯¥ç®—æ³•å¯¹äºæ‰€æœ‰è¯ä¹¦éƒ½æ˜¯ç›¸åŒçš„ã€‚ å› æ­¤ï¼Œæœ€å¥½ä¾é æ­¤æ–¹æ³•çš„<a href="">ä»£ç </a>æ¥å®ç°ç±»ä¼¼çš„ç­¾åç”Ÿæˆï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ•°æ®ç­¾å</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.CMS_DETACHED; IntPtr hData = IntPtr.Zero; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   ISDP_X509Cert pCert = ISDP_X509Cert.Convert(_pCert, TCryptoPath.cpOpenSSL); // 1)  BIO   int iRes = GetBIOByBytesOS(_arData, out hData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)   BIO hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); // 3)    hCMS = UOpenSSLAPI.CMS_ContentInfo_new(); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_CR_ERR); if (!UOpenSSLAPI.CMS_SignedData_init(hCMS)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_INIT_ERR); // 4)   if(UOpenSSLAPI.CMS_add1_signer(hCMS, pCert.hRealHandle, pCert.hOSKey, pCert.hOSDigestAlg, iFlags) == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_SIGNER_ERR); // 5)   -   if (!UOpenSSLAPI.CMS_set_detached(hCMS, 1)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_DET_ERR); // 6)    if (!UOpenSSLAPI.CMS_final(hCMS, hData, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_FINAL_ERR); // 7)    BIO if (!UOpenSSLAPI.i2d_CMS_bio_stream(hBIORes, hCMS, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_EXP_TO_BIO_ERR); // 8)     BIO return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } catch (Exception E) { _sError = UCConsts.S_SIGN_OS_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p> ç®—æ³•çš„è¿›å±•å¦‚ä¸‹ã€‚ é¦–å…ˆï¼Œå°†ä¼ å…¥çš„è¯ä¹¦ï¼ˆå¦‚æœæ˜¯X509Certificate2ï¼‰è½¬æ¢ä¸ºæˆ‘ä»¬çš„ç±»å‹ã€‚ å› ä¸º ç”±äºæˆ‘ä»¬ä½¿ç”¨åˆ°éæ‰˜ç®¡å†…å­˜åŒºåŸŸçš„é“¾æ¥ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ä»”ç»†ç›‘è§†å®ƒä»¬ã€‚ è¯ä¹¦é“¾æ¥è¶…å‡ºèŒƒå›´åçš„æŸä¸ªæ—¶é—´ï¼Œ.Netå°†å¯åŠ¨ææ„å‡½æ•°ã€‚ åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç²¾ç¡®åœ°è§„å®šäº†æ¸…é™¤ä¸ä¹‹å…³è”çš„æ‰€æœ‰éæ‰˜ç®¡å†…å­˜æ‰€å¿…éœ€çš„æ–¹æ³•ã€‚ è¿™ç§æ–¹æ³•ä½¿æˆ‘ä»¬ä¸å¿…æµªè´¹æ—¶é—´ç›´æ¥åœ¨æ–¹æ³•å†…éƒ¨è·Ÿè¸ªè¿™äº›é“¾æ¥ã€‚ </p><br><p> å¤„ç†å®Œè¯ä¹¦åï¼Œæˆ‘ä»¬å½¢æˆäº†ä¸€ä¸ªå…·æœ‰æ•°æ®å’Œç­¾åç»“æ„çš„BIOã€‚ ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ ç­¾åè€…çš„æ•°æ®ï¼Œè®¾ç½®ç”¨äºæ–­å¼€ç­¾åçš„æ ‡å¿—ï¼Œå¹¶å¼€å§‹æœ€ç»ˆå½¢æˆç­¾åã€‚ ç»“æœè¢«ä¼ é€åˆ°BIOã€‚ å®ƒä»…ä¿ç•™ä»BIOæå–å­—èŠ‚æ•°ç»„ã€‚ é€šå¸¸å°†BIOè½¬æ¢ä¸ºä¸€ç»„å­—èŠ‚ï¼Œåä¹‹äº¦ç„¶ï¼Œå› æ­¤æœ€å¥½å°†å®ƒä»¬æ”¾åœ¨å•ç‹¬çš„æ–¹æ³•ä¸­ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å­—èŠ‚[]ä¸­çš„BIOï¼Œåä¹‹äº¦ç„¶</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  BIO    OpenSSL&lt;/summary&gt; * &lt;param name="_hBIO"&gt; BIO&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_iLen"&gt; ,  0 -    &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadFromBIO_OS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hBIO, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iLen = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; IntPtr hRes = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iLen = _iLen; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(iLen == <span class="hljs-number"><span class="hljs-number">0</span></span>) iLen = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   iLen = UOpenSSLAPI.BIO_read(_hBIO, IntPtr.Zero, int.MaxValue); // 1)      hRes = Marshal.AllocHGlobal((int)iLen); if (UOpenSSLAPI.BIO_read(_hBIO, hRes, iLen) != iLen) { _sError = UCConsts.S_OS_BIO_READ_LEN_ERR; return UConsts.E_CRYPTO_ERR; } // 2)   _arRes = new byte[iLen]; Marshal.Copy(hRes, _arRes, 0, _arRes.Length); return UConsts.S_OK;; } catch (Exception E) { _sError = UCConsts.S_OS_BIO_READ_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hRes != IntPtr.Zero) Marshal.FreeHGlobal(hRes); } } /**&lt;summary&gt; BIO   &lt;/summary&gt; * &lt;param name="_arData"&gt;&lt;/param&gt; * &lt;param name="_hBIO"&gt;   BIO&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/ internal static int GetBIOByBytesOS(byte[] _arData, out IntPtr _hBIO, ref string _sError) { _hBIO = UOpenSSLAPI.BIO_new_mem_buf( _arData, _arData.Length); if (_hBIO == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CM_BIO_CR_ERR); return UConsts.S_OK; }</span></span></code> </pre></div></div><br><p> ä¸CryptoProä¸€æ ·ï¼Œæœ‰å¿…è¦ä»è¯ä¹¦ä¸­æå–æœ‰å…³ç­¾åå“ˆå¸Œç®—æ³•çš„ä¿¡æ¯ã€‚ ä½†å¯¹äºOpenSSLï¼Œå®ƒå°†ç›´æ¥å­˜å‚¨åœ¨è¯ä¹¦ä¸­ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è·å–å“ˆå¸Œç®—æ³•</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      OpenSSL&lt;/summary&gt; * &lt;param name="_hCert"&gt;  (X509)&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDigestAlgOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert</span></span></span><span class="hljs-function">)</span></span> { x509_st pCert = (x509_st)Marshal.PtrToStructure(_hCert, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(x509_st)); X509_algor_st pAlgInfo = (X509_algor_st)Marshal.PtrToStructure(pCert.sig_alg, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(X509_algor_st)); IntPtr hAlgSn = UOpenSSLAPI.OBJ_nid2sn(UOpenSSLAPI.OBJ_obj2nid(pAlgInfo.algorithm)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UOpenSSLAPI.EVP_get_digestbyname(hAlgSn); }</code> </pre></div></div><br><p> è¯¥æ–¹æ³•åŸæ¥å¾ˆæ£˜æ‰‹ï¼Œä½†å¯ä»¥ã€‚ æ‚¨å¯ä»¥åœ¨æ–‡æ¡£1.0.2ä¸­æ‰¾åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">EVP_get_digestbynid</a>æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ç‰ˆæœ¬çš„åº“ä¸ä¼šå¯¼å‡ºè¯¥æ–¹æ³•ã€‚ å› æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬å½¢æˆnidï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šå½¢æˆç®€ç§°ã€‚ å¹¶ä¸”å·²ç»æœ‰äº†ä¸€ä¸ªç®€çŸ­çš„åç§°ï¼Œæ‚¨å¯ä»¥æŒ‰åç§°æœç´¢çš„å¸¸è§„æ–¹å¼æå–ç®—æ³•ã€‚ </p><br><h2> ç­¾åéªŒè¯ </h2><br><p> æ”¶åˆ°çš„ç­¾åéœ€è¦éªŒè¯ã€‚  OpenSSLéªŒè¯ç­¾åå¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç­¾åéªŒè¯</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arData"&gt;,   &lt;/param&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pLocation"&gt;&lt;/param&gt; * &lt;param name="_fVerifyOnlySign"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * &lt;remarks&gt;   &lt;/remarks&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSignOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerifyOnlySign = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, StoreLocation _pLocation = StoreLocation.CurrentUser</span></span></span><span class="hljs-function">)</span></span>{ _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hBIOData = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; IntPtr hTrStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)  BIO     int iRes = GetBIOByBytesOS(_arData, out hBIOData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)   CMS iRes = GetCMSFromBytesOS(_arSign, out hCMS, ref _sError); if (iRes != UConsts.S_OK) return iRes; uint iFlag = UCConsts.CMS_DETACHED; // 2)    if (!_fVerifyOnlySign) { iRes = GetTrustStoreOS(_pLocation, out hTrStore, ref _sError); if (iRes != UConsts.S_OK) return iRes; } else iFlag |= UCConsts.CMS_NO_SIGNER_CERT_VERIFY; // 3)   if (!UOpenSSLAPI.CMS_verify(hCMS, IntPtr.Zero, hTrStore, hBIOData, IntPtr.Zero, iFlag)) return RetErrOS(ref _sError, UCConsts.S_OS_CM_CHECK_ERR); return UConsts.S_OK; } finally { if(hBIOData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); if(hTrStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hTrStore); } }</span></span></code> </pre></div></div><br><p> é¦–å…ˆï¼Œå°†ç­¾åæ•°æ®ä»å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºCMSç»“æ„ï¼š <br></p><br><div class="spoiler">  <b class="spoiler_title">CMSç»“æ„çš„å½¢æˆ</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; CMS   &lt;/summary&gt; * &lt;param name="_arData"&gt; CMS&lt;/param&gt; * &lt;param name="_hCMS"&gt;    CMS&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCMSFromBytesOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hCMS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hCMS = IntPtr.Zero; IntPtr hBIOCMS = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CMS hCMS = UOpenSSLAPI.CMS_ContentInfo_new(); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError); if (!UOpenSSLAPI.CMS_SignedData_init(hCMS)) return RetErrOS(ref _sError); // 1)    BIO hBIOCMS = UOpenSSLAPI.BIO_new_mem_buf(_arData, _arData.Length); if (hBIOCMS == IntPtr.Zero) return RetErrOS(ref _sError); // 2)   CMS if (UOpenSSLAPI.d2i_CMS_bio(hBIOCMS, ref hCMS) == IntPtr.Zero) return RetErrOS(ref _sError); // 3)   - ,    _hCMS = hCMS; hCMS = IntPtr.Zero; return UConsts.S_OK; } finally { if(hBIOCMS != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOCMS); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p>     ,     BIO.    ,    ,        (  )      : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    &lt;/summary&gt; * &lt;param name="_hStore"&gt;   &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTrustStoreOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StoreLocation _pLocation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hStore = IntPtr.Zero; IntPtr hStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { List&lt;X509Certificate2&gt; pCerts = GetCertList(_pLocation, StoreName.Root, TCryptoPath.cpOpenSSL); pCerts.AddRange(GetCertList(_pLocation, StoreName.AuthRoot, TCryptoPath.cpOpenSSL)); <span class="hljs-comment"><span class="hljs-comment">// 1)   hStore = UOpenSSLAPI.X509_STORE_new(); foreach (X509Certificate2 pCert in pCerts) { //      (    ) UOpenSSLAPI.X509_STORE_add_cert(hStore, pCert.getRealHandle()); } // 2)   UOpenSSLAPI.ERR_clear_error(); _hStore = hStore; hStore = IntPtr.Zero; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_FORM_TRUST_STORE_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if (hStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hStore); }</span></span></code> </pre></div></div><br><p>         ,         (   ,    ).     CMS_Verify,    . </p><br><p>       (,       CRL),      iFlag   . </p><br><h2>    </h2><br><p>               .        ,   ,           .  .Net    â€” SignedCms,                   . </p><br><p>        (   ,     )        .         â€”     ,    . </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arContent"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arContent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hBIOData = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; IntPtr hCerts = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    MS int iRes = UCUtils.GetCMSFromBytesOS(_arSign, out hCMS, ref _sError); if(iRes != UConsts.S_OK) return iRes; iRes = UCUtils.GetBIOByBytesOS(_arContent, out hBIOData, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)   uint iFlags = UCConsts.CMS_NO_SIGNER_CERT_VERIFY; if(_arContent.Length == 0) iFlags |= UCConsts.CMS_NO_CONTENT_VERIFY; // 2)  CMS if (!UOpenSSLAPI.CMS_verify(hCMS, IntPtr.Zero, IntPtr.Zero, hBIOData, IntPtr.Zero, iFlags)) return UCUtils.RetErrOS(ref _sError, UCConsts.S_OS_CMS_VERIFY_ERR); // 3)   hCerts = UOpenSSLAPI.CMS_get0_signers(hCMS); int iCnt = UOpenSSLAPI.sk_num(hCerts); for (int i = 0; i &lt; iCnt; i++) { IntPtr hCert = UOpenSSLAPI.sk_value(hCerts, i); byte[] arData; iRes = UCUtils.GetCertBytesOS(hCert, out arData, ref _sError); if(iRes != UConsts.S_OK) return iRes; fpCertificates.Add(ISDP_X509Cert.Create(arData, TCryptoPath.cpOpenSSL)); } // 4)   IntPtr hSigners = UOpenSSLAPI.CMS_get0_SignerInfos(hCMS); iCnt = UOpenSSLAPI.sk_num(hSigners); for (int i = 0; i &lt; iCnt; i++) { IntPtr hSignerInfo = UOpenSSLAPI.sk_value(hSigners, i); // 4.1)    ISDPSignerInfo pInfo = new ISDPSignerInfo(this); iRes = pInfo.DecodeOS(hSignerInfo, ref _sError); if(iRes != UConsts.S_OK) return iRes; fpSignerInfos.Add(pInfo); } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_OS_CMS_DECODE.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hCerts != IntPtr.Zero) UOpenSSLAPI.sk_free(hCerts); if(hBIOData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p>     ,      BIO     ( )   CMS,    .    ,          â€”        . </p><br><p>         (STACK_OF(X509)),      sk_pop,       .     ,          sk_value. </p><br><p>  ,         CMS_get0_signers  CMS_get1_certs.     ,   .      ,       ,         : </p><br><pre> <code class="hljs lisp">CRYPTO_add(<span class="hljs-name"><span class="hljs-name">&amp;cch-&gt;d</span></span>.certificate-&gt;references, <span class="hljs-number"><span class="hljs-number">1</span></span>, CRYPTO_LOCK_X509)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><p>   <a href="">1.1.0</a>    X509_up_ref,      . <br>         : </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hSignerInfo"&gt;Handler    (OpenSSL)&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hSignerInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    int iRes = UCUtils.GetSignerInfoCertOS(_hSignerInfo, fpSignedCMS.pCertificates, out fpCertificate, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)    uint iPos = UOpenSSLAPI.CMS_signed_get_attr_by_NID(_hSignerInfo, UCConsts.NID_pkcs9_signingTime, 0); IntPtr hAttr = UOpenSSLAPI.CMS_signed_get_attr(_hSignerInfo, iPos); IntPtr hDateTime = UOpenSSLAPI.X509_ATTRIBUTE_get0_data(hAttr, 0, UCConsts.V_ASN1_UTCTIME, IntPtr.Zero); asn1_string_st pDate = (asn1_string_st)Marshal.PtrToStructure(hDateTime, typeof(asn1_string_st)); // 2)   Pkcs9SigningTime byte[] arDateAttr = new byte[pDate.iLength]; Marshal.Copy(pDate.hData, arDateAttr, 0, (int)pDate.iLength); arDateAttr = new byte[] { (byte)UCConsts.V_ASN1_UTCTIME, (byte)pDate.iLength}.Concat(arDateAttr).ToArray(); fpSignedAttributes.Add(new Pkcs9SigningTime(arDateAttr)); return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CMS_SIGNER_DEC_OS_ER.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p>  ,    ,     .          ASN.1.      asn1_string_st         Pkcs9SigningTime. </p><br><p>    : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_hSignerInfo"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_pCerts"&gt;   &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSignerInfoCertOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hSignerInfo, X509Certificate2Collection _pCerts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)     IntPtr hKey = IntPtr.Zero; IntPtr hIssuer = IntPtr.Zero; IntPtr hSNO = IntPtr.Zero; if (!UOpenSSLAPI.CMS_SignerInfo_get0_signer_id(_hSignerInfo, ref hKey, ref hIssuer, ref hSNO)) return RetErrOS(ref _sError, UCConsts.S_GET_RECEIP_INFO_ERR); // 1)    string sSerial; int iRes = GetBinaryHexFromASNOS(hSNO, out sSerial, ref _sError); if(iRes != UConsts.S_OK) return iRes; X509Certificate2Collection pResCerts = _pCerts.Find(X509FindType.FindBySerialNumber, sSerial, false); if(pResCerts.Count == 0) return RetErrOS(ref _sError, UCConsts.S_NO_CERTIFICATE, UConsts.E_NO_CERTIFICATE); _pCert = pResCerts[0]; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GET_SIGN_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p>        ,          .       asn1_string_st,         hex : </p><br><div class="spoiler"> <b class="spoiler_title"> hex    ANS.1</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; Hex     ASN.1&lt;/summary&gt; * &lt;param name="_hASN"&gt;   ASN.1&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_sHexData"&gt;   Hex&lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBinaryHexFromASNOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hASN, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sHexData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _sHexData = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { asn1_string_st pSerial = (asn1_string_st)Marshal.PtrToStructure(_hASN, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(asn1_string_st)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arStr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[pSerial.iLength]; Marshal.Copy(pSerial.hData, arStr, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pSerial.iLength); _sHexData = arStr.ToHex().ToUpper(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.S_OK; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception E) { _sError = UCConsts.S_HEX_ASN_BINARY_ERR.Frm(E.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.E_GEN_EXCEPTION; } }</code> </pre></div></div><br><p>      ,      ,    . </p><br><h2>  </h2><br><p>   OpenSSL    : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_pReceipients"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EncryptDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, List&lt;X509Certificate2&gt; _pReceipients, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.CMS_BINARY; IntPtr hData = IntPtr.Zero; IntPtr hReceipts = IntPtr.Zero; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)  BIO     int iRes = GetBIOByBytesOS(_arInput, out hData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)     iRes = GetCertsStackOS(_pReceipients, out hReceipts, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)  CMS hCMS = UOpenSSLAPI.CMS_encrypt(hReceipts, hData, UOpenSSLAPI.EVP_des_ede3_cbc(), iFlags); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_ENC_CMS_ERR); // 3)  CMS  BIO hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); if (!UOpenSSLAPI.i2d_CMS_bio_stream(hBIORes, hCMS, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_EXP_TO_BIO_ERR); // 4)   BIO    return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } catch (Exception E) { _sError = UCConsts.S_ENC_OS_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); if(hReceipts != IntPtr.Zero) UOpenSSLAPI.sk_free(hReceipts); } }</span></span></code> </pre></div></div><br><p>    BIO      â€” .        .    ,       BIO    . OpenSSL      ,    ,    ,   .          EVP_des_ede3_cbc,       . </p><br><p>         , . .           OpenSSL: </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;* &lt;param name="_hStack"&gt; &lt;/param&gt; * &lt;param name="_pCerts"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCertsStackOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;X509Certificate2&gt; _pCerts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hStack, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hStack = IntPtr.Zero; IntPtr hStack = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { hStack = UOpenSSLAPI.sk_new_null(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (X509Certificate2 pCert <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _pCerts) { <span class="hljs-comment"><span class="hljs-comment">// 0)  ,     ISDP_X509Cert pLocCert = ISDP_X509Cert.Convert(pCert, TCryptoPath.cpOpenSSL); // 1)  UOpenSSLAPI.sk_push(hStack, pLocCert.hRealHandle); } _hStack = hStack; hStack = IntPtr.Zero; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GEN_CERT_STACK_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hStack != IntPtr.Zero) UOpenSSLAPI.sk_free(hStack); } }</span></span></code> </pre></div></div><br><h2>  </h2><br><p>     ,        .      : </p><br><ol><li> ,       ; </li><li>   ; </li><li>           ; </li><li>     ; </li><li>      BIO    ; </li></ol><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_pLocation"&gt; ,  &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;returns&gt;  ,  UCOnsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecryptDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser </span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlag = UCConsts.CMS_BINARY; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; X509Certificate2 pCert; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CMS int iRes = GetCMSFromBytesOS(_arInput, out hCMS, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)     IntPtr hReceipts = UOpenSSLAPI.CMS_get0_RecipientInfos(hCMS); int iCnt = UOpenSSLAPI.sk_num(hReceipts); for(int i = 0; i &lt; iCnt; i++) { IntPtr hRecep = UOpenSSLAPI.sk_value(hReceipts, i); iRes = GetRecepInfoCertOS(hRecep, _pLocation, out pCert, ref _sError); if (iRes != UConsts.S_OK &amp;&amp; iRes != UConsts.E_NO_CERTIFICATE) return iRes; // 1.1)   if (iRes == UConsts.E_NO_CERTIFICATE) continue; ISDP_X509Cert pLocCert = ISDP_X509Cert.Convert(pCert); // 1.2)    if (pLocCert.hOSKey == IntPtr.Zero) continue; // 1.3)   if (!UOpenSSLAPI.CMS_RecipientInfo_set0_pkey(hRecep, pLocCert.hOSKey)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_DEC_KEY_ERR); try { // 1.4)  if (!UOpenSSLAPI.CMS_RecipientInfo_decrypt(hCMS, hRecep)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_REC_DEC_ERR); } finally { // !!      UOpenSSLAPI.CMS_RecipientInfo_set0_pkey(hRecep, IntPtr.Zero); } // 1.5)   hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); if (!UOpenSSLAPI.CMS_decrypt(hCMS, IntPtr.Zero, pLocCert.hRealHandle, IntPtr.Zero, hBIORes, iFlag)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_FULL_DEC_ERR); _pCert = pLocCert; // 2)     BIO return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } _sError = UCConsts.S_DEC_NO_CERT_ERR; return UConsts.E_NO_CERTIFICATE; } catch (Exception E) { _sError = UCConsts.S_DEC_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p>        .   ,          CMS_RecipientInfo_set0_pkey,       CMS,            . </p><br><p>  ,   ,       .        ,        .        : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_hRecep"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt;   &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRecepInfoCertOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hRecep, StoreLocation _pLocation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)     IntPtr hKey = IntPtr.Zero; IntPtr hIssuer = IntPtr.Zero; IntPtr hSNO = IntPtr.Zero; if (!UOpenSSLAPI.CMS_RecipientInfo_ktri_get0_signer_id(_hRecep, ref hKey, ref hIssuer, ref hSNO)) return RetErrOS(ref _sError, UCConsts.S_GET_RECEIP_INFO_ERR); // 1)    string sSerial; int iRes = GetBinaryHexFromASNOS(hSNO, out sSerial, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 2)   iRes = FindCertificateOS(sSerial, out _pCert, ref _sError, _pLocation, StoreName.My, X509FindType.FindBySerialNumber); if(iRes != UConsts.S_OK) return iRes; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GET_RECEIP_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p>  CMS_RecipientInfo_ktri_get0_signer_id     ,        hSNO        .      . </p><br><p> C  ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> .          ktri â€”      .      OpenSSL    : CMS_RecipientInfo_kari_*, CMS_RecipientInfo_kekri_*   CMS_RecipientInfo_set0_password  pwri. </p><br><h2>   </h2><br><p>      ,          .               .        , . .         .  OpenSSL     .         (    ),      ,      . <br></p><p> ,  ,   ,           : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VerifyCertificateOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, StoreLocation _pLocation, DateTime _rOnDate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hStore = IntPtr.Zero; IntPtr hStoreCtx = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   int iRes = GetTrustStoreOS(_pLocation, out hStore, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)    hStoreCtx = UOpenSSLAPI.X509_STORE_CTX_new(); if (!UOpenSSLAPI.X509_STORE_CTX_init(hStoreCtx, hStore, _hCert, IntPtr.Zero)) { _sError = UCConsts.S_CRYPTO_CONTEXT_CER_ERR; return UConsts.E_CRYPTO_ERR; } // 2)       SetStoreCtxCheckDate(hStoreCtx, _rOnDate); // 3)  if (!UOpenSSLAPI.X509_verify_cert(hStoreCtx)) { _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(GetCertVerifyErr(hStoreCtx)); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } finally { if (hStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hStore); if (hStoreCtx != IntPtr.Zero) UOpenSSLAPI.X509_STORE_CTX_free(hStoreCtx); } }</span></span></code> </pre></div></div><br><p>     (X509_STORE_CTX)     .      : </p><br><div class="spoiler"> <b class="spoiler_title">    </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hStoreCtx"&gt; &lt;/param&gt; * &lt;param name="_rDate"&gt;&lt;/param&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetStoreCtxCheckDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hStoreCtx, DateTime _rDate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.X509_V_FLAG_USE_CHECK_TIME | UCConsts.X509_V_FLAG_X509_STRICT | UCConsts.X509_V_FLAG_CRL_CHECK_ALL; <span class="hljs-comment"><span class="hljs-comment">//   UOpenSSLAPI.X509_STORE_CTX_set_flags(_hStoreCtx, iFlags); //   UOpenSSLAPI.X509_STORE_CTX_set_time(_hStoreCtx, iFlags, (uint)_rDate.ToUnix()); //   -   UOpenSSLAPI.X509_STORE_CTX_set_trust(_hStoreCtx, UCConsts.X509_TRUST_TRUSTED); }</span></span></code> </pre></div></div><br><p>     ,           . </p><br><h1> ç»“è®º </h1><br><p>     ,      .       X509Certificate2 (mono)      .      . </p><br><p>   ,  Windows              .       .  Linux ,        ,        . </p><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CSP 5.0</a> ,     RSA .      ,     ,   ,          RSA, ,    . </p><br><h1> å‚è€ƒæ–‡çŒ® </h1><br><ol><li> OpenSSL 1.0.2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ManPages</a> ; </li><li>   OpenSSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">1</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OpenSSL</a> : <br><ol><li> <a href="">cms_smime.c;</a> </li></ol></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Wiki OpenSSL</a> ; </li><li>  mono: <ol><li>  <a href="">RSAManaged</a> ; </li></ol><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423769/">https://habr.com/ru/post/zh-CN423769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423753/index.html">ç¡®ä¿æˆæƒä»¤ç‰Œçš„å®‰å…¨</a></li>
<li><a href="../zh-CN423759/index.html">é‡‘èç§‘æŠ€æ‘˜è¦ï¼šä¿„ç½—æ–¯è”é‚¦å…¬æ°‘çš„ä¸ªäººæ•°æ®ï¼Œä¸­å¤®é“¶è¡Œå¸‚åœºï¼ŒCloudFlareçš„ä¸€é¡¹æ–°æœåŠ¡</a></li>
<li><a href="../zh-CN423763/index.html">Uber Cashæ•™ç»™åˆ›æ–°è€…çš„æ˜¯ä»€ä¹ˆ</a></li>
<li><a href="../zh-CN423765/index.html">æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªRetroOrangePiçš„MPVæ’­æ”¾å™¨çš„è¿œç¨‹æ§åˆ¶åº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN423767/index.html">é»‘å®¢è¢­å‡»è‹±å›½èˆªç©ºå…¬å¸ï¼š380,000å¼ å®¢æˆ·é“¶è¡Œå¡è¢«ç›—</a></li>
<li><a href="../zh-CN423771/index.html">å†æ¬¡ï¼ŒPVS-Studioåˆ†æä»ªæ¯”ä¸€ä¸ªäººæ›´ä¸“æ³¨</a></li>
<li><a href="../zh-CN423775/index.html">æˆ‘æƒ³è¦ä¸€å—æ¼‚äº®çš„é“ã€‚ åŸæ¥</a></li>
<li><a href="../zh-CN423777/index.html">é‡ç‚¹é¡¹ç›®ï¼šè¿è¡ŒåŸºäºRISC-Vçš„åº”ç”¨ç¨‹åºçš„å—ä¿¡ä»»ç¯å¢ƒ</a></li>
<li><a href="../zh-CN423779/index.html">äº‘åˆ°äº‘å¤‡ä»½ï¼šå®ƒæ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
<li><a href="../zh-CN423781/index.html">ç‰©è”ç½‘æä¾›å•†çš„è¯´æ˜ã€‚ æ¡ˆä¾‹ï¼šæˆ‘ä»¬ä¸ºè½¦é‡Œé›…å®¾æ–¯å…‹çš„åŠ æ²¹æœºå»ºç«‹äº†LoRaç½‘ç»œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>