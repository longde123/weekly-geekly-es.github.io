<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🔧 ✊🏾 👩🏾‍🏫 Experiência de atualização clássica do SAMBA no Debian 8 ⁉️ 💬 💇🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antecedentes 
 Há uma pequena rede local da empresa, na qual, há cerca de 10 anos, um domínio no 3º Samba + LDAP + BIND (no gateway) foi criado no Deb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experiência de atualização clássica do SAMBA no Debian 8</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418499/"><h2>  Antecedentes </h2><br>  Há uma pequena rede local da empresa, na qual, há cerca de 10 anos, um domínio no 3º Samba + LDAP + BIND (no gateway) foi criado no Debian 5.  Na verdade, ela só precisava de autenticação de usuário e arquivo de bolas.  Ao longo dos anos, o servidor atualizou para novas versões do Debian sem problemas.  No momento, ele possui o Debian 8 e o Samba 4.2 dos pacotes. <br><br>  Desde o Windows 7, a introdução de computadores no domínio, sem a conhecida muleta com a edição do registro, não funcionou.  A mesma muleta funcionou no Win 8 e no Win 10 até a versão 1803. Além da incapacidade de inserir computadores no domínio, outros problemas se acumularam e, como resultado, foi decidido realizar um upgrade clássico.  Devido à simplicidade da estrutura da LAN, foi decidido usar o DNS interno do Samba. <br><br>  Quero dizer imediatamente que o artigo não é um guia exato, mas a experiência de realizar esta operação.  A fase de pré-teste é altamente recomendada.  No meu caso, foram tiradas imagens de servidor para teste e implantadas em máquinas virtuais do VirtualBox. Além disso, para testar o comportamento dos clientes de domínio existentes, foram criadas as máquinas clientes Win XP SP3 e Win 10 1709 e 1803. <br><br>  Também quero observar que repetidamente os erros foram causados ​​por erros comuns.  Tome cuidado. <br><a name="habracut"></a><br><h2>  Descrição do ambiente </h2><br>  SO: Debian 8 <br>  Domínio: samdom.local <br>  Nome do servidor: pdc <br>  ip do servidor: 10.10.1.220 <br><cut></cut><br><h2>  Processo de transição </h2><br><h4>  Atualizando pacotes para as versões mais recentes + instalando os ausentes. </h4><br>  No meu caso, após a atualização, apenas o usuário krb5 tinha que ser entregue. <br><br><pre><code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">upgrade</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> samba smbclient krb5-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> winbind</code> </pre> <br>  Ao instalar o krb5-user, o sistema fará algumas perguntas sobre o nome do servidor e o nome do domínio.  Nós preenchemos os dados do nosso servidor. <br><cut></cut><br><h4>  Parada de samba </h4><br><pre> <code class="hljs sql">service samba-ad-dc <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service smbd <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service nmbd <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service winbind <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span></code> </pre> <br><h4>  Transferência de bases antigas e configuração do samba </h4><br><pre> <code class="hljs swift">mv /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba.<span class="hljs-type"><span class="hljs-type">NT</span></span> mv /etc/samba/smb.conf /etc/samba/smb.conf.<span class="hljs-type"><span class="hljs-type">NT</span></span></code> </pre> <br>  Mudei os bancos de dados antigos para /var/lib/samba.NT, então você precisa recriar o diretório / var / lib / samba <br><br><pre> <code class="hljs swift">mkdir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba</code> </pre> <br>  A documentação recomenda mover todos os bancos de dados para uma pasta separada.  No meu caso, apenas o gencache_notrans.tdb ficava separadamente, então tive que transferi-lo apenas. <br><br><pre> <code class="hljs swift">cp -p /run/samba/gencache_notrans.tdb /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba.<span class="hljs-type"><span class="hljs-type">NT</span></span></code> </pre> <br>  A documentação também diz que apenas seis bancos de dados são necessários: <br><br><blockquote>  secrets.tdb <br>  schannel_store.tdb <br>  passdb.tdb <br>  gencache_notrans.tdb <br>  group_mapping.tdb <br>  account_policy.tdb </blockquote><br>  No entanto, a presença de outros arquivos na pasta não impediu o processo de transição. <br><cut></cut><br><h4>  Iniciando o processo de atualização clássica </h4><br><pre> <code class="hljs powershell">samba<span class="hljs-literal"><span class="hljs-literal">-tool</span></span> domain classicupgrade —dbdir=/var/lib/samba.NT -<span class="hljs-literal"><span class="hljs-literal">-realm</span></span>=samdom.local -<span class="hljs-literal"><span class="hljs-literal">-dns</span></span><span class="hljs-literal"><span class="hljs-literal">-backend</span></span>=SAMBA_INTERNAL /etc/samba/smb.conf.NT</code> </pre> <br>  Observo que a documentação não recomenda o uso do domínio de nível superior local., Mas, no meu caso, aconteceu historicamente. <br><br>  Na planilha exibida na tela, a senha do administrador piscará, que você poderá anotar, se desejar). <br><br>  Se você tiver problemas, antes de novas tentativas de atualização clássica, lembre-se de excluir os arquivos de banco de dados e o smb.conf criados no processo. <br><br><pre> <code class="hljs powershell">rm <span class="hljs-operator"><span class="hljs-operator">-f</span></span> /etc/samba/smb.conf rm <span class="hljs-literal"><span class="hljs-literal">-rf</span></span> /var/lib/samba/*</code> </pre> <br>  Se tudo correu bem, você pode ir para o próximo passo. <br><br><h4>  Verificando e editando configurações do servidor </h4><br>  Em /etc/resolv.conf deve ser (se não for criado automaticamente para você) <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">domain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span></code> </pre> <br>  Em / etc / hosts <br><br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.localdomain</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pdc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pdc</span></span></code> </pre> <br>  O arquivo / etc / hostname deve ter um nome de host abreviado <br><br><pre> <code class="hljs">pdc</code> </pre> <br>  Em / etc / network / interfases <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-nameservers</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-search</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span></code> </pre> <br><h4>  Redirecionando solicitações de DNS </h4><br>  Se o seu servidor redirecionar as consultas DNS para a Internet (e INTERNAL_DNS Samba for usado), você precisará adicionar uma linha do seu IP do ISP na seção [global] no smb.conf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dns</span></span> forwarder = ip</code> </pre> <br>  No "Samba" 4.2, você pode especificar apenas um ip.  A seguir - alguns, com um espaço. <br>  Se o tráfego de saída for controlado no seu gateway, não esqueça de abrir a passagem de pacotes udp do servidor para a porta 53. <br><br><h4>  Configurar Kerberos </h4><br>  Trazemos o /etc/krb5.conf para uma forma semelhante: <br><br><pre> <code class="hljs pgsql">[libdefaults] default_realm = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> dns_lookup_realm = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> dns_lookup_kdc = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> krb4_config = /etc/krb.conf krb4_realms = /etc/krb.realms kdc_timesync = <span class="hljs-number"><span class="hljs-number">1</span></span> ccache_type = <span class="hljs-number"><span class="hljs-number">4</span></span> forwardable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> proxiable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> v4_instance_resolve = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> v4_name_convert = { host = { rcmd = host ftp = ftp } plain = { something = something-<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> } } fcc-mit-ticketflags = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> [realms] SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> = { kdc = pdc admin_server = pdc default_domain = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> } [domain_realm] .samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span></code> </pre> <br><h4>  Sincronização de tempo </h4><br>  Se o pacote ntp não valer a pena, defina: <br><br><pre> <code class="hljs swift">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install ntp</code> </pre> <br>  No meu caso, não havia diretório / var / lib / samba / ntp_signd /.  Criado manualmente. <br><br>  Em seguida, você precisa conceder direitos a ele: <br><br><pre> <code class="hljs swift">chown root:ntp /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba/ntp_signd/ chmod <span class="hljs-number"><span class="hljs-number">750</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba/ntp_signd/</code> </pre> <br>  Em seguida, você precisa trazer o arquivo /etc/ntp.conf para um formato semelhante: <br><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> clock (Note: This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> the localhost address!) <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.127</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> fudge <span class="hljs-number"><span class="hljs-number">127.127</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> stratum <span class="hljs-number"><span class="hljs-number">10</span></span> # The source, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> we are receiving the <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>pool.ntp.org iburst prefer driftfile /var/lib/ntp/ntp.drift logfile /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/ntp ntpsigndsocket /var/lib/samba/ntp_signd/ # <span class="hljs-keyword"><span class="hljs-keyword">Access</span></span> control # <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span> restriction: <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span> allow querying <span class="hljs-type"><span class="hljs-type">time</span></span> (incl. ms-sntp) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> this machine <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> kod nomodify notrap nopeer mssntp # Allow everything <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> localhost <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # Allow that our <span class="hljs-type"><span class="hljs-type">time</span></span> source can <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> provide <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>pool.ntp.org mask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> nomodify notrap nopeer noquery</code> </pre> <br><h4>  Removendo o slapd e reiniciando </h4><br><pre> <code class="hljs cs">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">remove</span></span> slapd reboot</code> </pre> <br><h4>  Teste </h4><br>  Na documentação, o teste é realizado na conta do administrador.  Historicamente, desenvolvemos que ações administrativas vêm de domain_admin.  Em seguida, os comandos e sua saída correta serão mostrados. <br><br>  <b>Testando samba:</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# smbclient -L localhost -U% <span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>=[SAMDOM] OS=[Unix] <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>=[Samba <span class="hljs-number"><span class="hljs-number">4.1</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span>-Debian] Sharename <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-comment"><span class="hljs-comment">--------- ---- ------- netlogon Disk sysvol Disk IPC$ IPC IPC Service (Samba 4.1.17-Debian) Domain=[SAMDOM] OS=[Unix] Server=[Samba 4.1.17-Debian] Server Comment --------- ------- Workgroup Master --------- -------</span></span></code> </pre> <br>  Se você receber um erro aqui: <br><blockquote>  Falha na conexão com o loclhost (erro NT_STATUS_UNSUCCESSFUL) </blockquote><br>  verifique se o samba começa.  Em um teste, esqueci de remover (desativar) o slapd e também vi esse erro. <br><br>  Mais um cheque: <br><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> smbclient //localhost/netlogon <span class="hljs-literal"><span class="hljs-literal">-Udomain_admin</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-string"><span class="hljs-string">'ls'</span></span> Enter Administrator<span class="hljs-string"><span class="hljs-string">'s password: Domain=[SAMDOM] OS=[Unix] Server=[Samba xyz] . D 0 Tue Nov 1 08:40:00 2016 .. D 0 Tue Nov 1 08:40:00 2016 49386 blocks of size 524288. 42093 blocks available</span></span></code> </pre> <br>  <b>Testando DNS</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# nslookup samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span> Address: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span>#<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>: samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> Address: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span></code> </pre> <br><pre> <code class="hljs pgsql">$ host -t SRV _ldap._tcp.samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>. _ldap._tcp.samdom.example.com has SRV <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">389</span></span> pdc.samdom.example.com.</code> </pre> <br><pre> <code class="hljs pgsql">$ host -t SRV _kerberos._udp.samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>. _kerberos._udp.samdom.example.com has SRV <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> pdc.samdom.example.com.</code> </pre> <br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> host <span class="hljs-literal"><span class="hljs-literal">-t</span></span> A pdc.samdom.local. dc1.samdom.example.com has address <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">1.220</span></span></code> </pre> <br>  <b>Testando o Kerberos</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# kinit domain_admin@SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain_admin@SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Warning</span></span>: Your <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> will expire <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> days <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>  <span class="hljs-number"><span class="hljs-number">27</span></span>  <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span></code> </pre><br><pre> <code class="hljs ruby">root@debian<span class="hljs-symbol"><span class="hljs-symbol">:/root</span></span><span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: FILE:/tmp/krb5cc_0 Default principal: domain_admin</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@SAMDOM</span></span></span><span class="hljs-comment">.LOCAL Valid starting Expires Service principal 16.10.2015 15:07:12 17.10.2015 01:07:12 krbtgt/SAMDOM.LOCAL</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@SAMDOM</span></span></span><span class="hljs-comment">.LOCAL renew until 17.10.2015 15:07:07</span></span></code> </pre> <br><h2>  Configuração adicional </h2><br>  <b>Para que nomes e grupos de domínio apareçam no linux, você precisa corrigir /etc/nsswitch.conf em vez de números</b> <br><br>  As strings devem ser reduzidas para o seguinte formato: <br><blockquote>  passwd: arquivos <u>winbind</u> <br>  grupo: arquivos <u>winbind</u> </blockquote><br>  Observe que o winbind é adicionado apenas a essas linhas.  Para detalhes, consulte a documentação. <br>  No meu caso, também removi a menção de ldap deste arquivo. <br><br><pre> <code class="hljs">reboot</code> </pre> <br>  <b>Se você, como eu, antes de atualizar o DNS clássico, o servidor estava localizado em outra máquina e você está usando um servidor DHCP, não se esqueça de alterar as configurações do servidor DHCP apontando para o servidor DNS</b> <br><br><h4>  Configurar pastas de rede </h4><br>  Os desenvolvedores não são recomendados para usar o controlador de domínio do AD como um servidor de arquivos.  No entanto, no meu caso, não havia outros servidores. <br><br>  A configuração está muito bem descrita na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação</a> para "Samba" e você precisa procurar lá.  Em suma, então: <br><br>  <b>É necessário verificar o suporte ao ACL samba.</b> <br><br><pre> <code class="hljs perl">smbd -b | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> HAVE_LIBACL HAVE_LIBACL</code> </pre> <br>  <b>Não esqueça que a seção deve ser montada com as opções user_xattr e acl.</b> <br><br>  <b>Somente usuários e grupos com SeDiskOperatorPrivilege podem configurar os direitos das bolas:</b> <br><br>  Por exemplo, para conceder esses direitos ao grupo Administradores de Domínio, você precisa executar o comando: <br><pre> <code class="hljs pgsql">net rpc rights <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> "Samdom\Domain Admins" SeDiskOperatorPrivilege -U "Samdom\domain_admin"</code> </pre> <br>  <b>Diretamente para adicionar bolas, você precisa:</b> <br><br>  Crie um diretório e atribua os direitos necessários: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># mkdir -p /srv/samba/Demo/ # chown root:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Domain Admins"</span></span></span><span class="hljs-meta"> /srv/samba/Demo/ # chmod 0770 /srv/samba/Demo/</span></span></code> </pre> <br>  adicione ao smb.conf <br><br><pre> <code class="hljs pgsql">[Demo] <span class="hljs-type"><span class="hljs-type">path</span></span> = /srv/samba/Demo/ <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre> <br>  Depois disso, recarregue as configurações do samba com o comando: <br><br><pre> <code class="hljs pgsql">smbcontrol <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reload-config</code> </pre> <br>  Como antes, as bolas podem ser ocultadas adicionando à sua descrição: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">browseable</span></span> = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br>  Em seguida, os direitos são distribuídos a partir das janelas da máquina, a partir de uma conta com <u>SeDiskOperatorPrivilege</u> .  Para fazer isso, vá para "Gerenciamento do computador". <br>  Apegue-se a um computador remoto (controlador de domínio pdc no nosso caso).  Distribua os direitos por meio de: "Pastas compartilhadas" -&gt; "Recursos compartilhados". <br><br>  É provável que, ao ir para o item "Pastas compartilhadas", você receba um erro "O número do procedimento esteja fora dos limites permitidos (1745)".  Eu o ignoro, porque não encontrei nada inteligível na Internet e isso não causa problemas durante o teste e a operação. <br><br>  Podem ser possíveis problemas se você compartilhar as pastas de rede antigas dessa maneira.  Antes do classicupgrade, os direitos para as bolas eram definidos via smb.conf, usuários do linux, group, other e setfacl.  Após a atualização clássica, as escolas com direito a mudar, renomear etc. começaram a aparecer gradualmente.  O cenário recursivo não ajudou, pois apareceram batentes com herança de direitos. <br><br>  Vale ressaltar que, na documentação, é recomendável distribuir direitos das janelas de uma máquina, por acesso remoto. <br><br>  Como resultado, devido ao volume não muito grande de arquivos, foi tomada a decisão de transferir dados para uma máquina Windows durante o horário não comercial, recriar pastas de rede de acordo com as recomendações dos desenvolvedores de samba e recarregar arquivos. <br><br><h4>  Pastas iniciais do usuário no servidor </h4><br>  O gerenciamento das pastas pessoais do usuário também foi alterado. <br>  Vale ressaltar que o processo da configuração também é muito bem descrito na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação</a> . <br>  Descreverei apenas os principais recursos do meu caso. <br><br>  Anteriormente, cada usuário tinha sua própria bola.  Agora, apenas a pasta compartilhada é compartilhada e os usuários têm acesso apenas ao diretório. <br><br>  A instalação é realizada usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o RSAT (Microsoft Remote Server Administration Tools)</a> .  RSAT tem uma característica desagradável.  Ao atualizar o Win 10 para uma nova versão, ele deve ser reinstalado. <br><br>  As bolas domésticas podem ser coletadas manualmente, através das propriedades do usuário no snap-in Usuários e Computadores.  Guia Perfil.  Disco U: \\ pdc \ compartilhamentos de usuários \ nome de usuário <br><br>  No entanto, é mais conveniente fazer isso por meio da diretiva de domínio, descrita com muita clareza na documentação acima, no parágrafo <b>"Usando uma preferência de diretiva de grupo"</b> . <br><br>  Não esqueça que a bola comum pode ser ocultada adicionando à sua descrição: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">browseable</span></span> = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br><h4>  Nível de domínio acima </h4><br>  O domínio foi atualizado sem problemas para o nível 2008_R2 com o comando: <br><br><pre> <code class="hljs pgsql">samba-tool <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-comment"><span class="hljs-comment">--domain=2008_R2 --forest=2008_R2</span></span></code> </pre> <br>  Você pode visualizar o nível com o comando: <br><br><pre> <code class="hljs pgsql">samba-tool <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span></code> </pre> <br><h4>  Se o smbd.log for bombardeado com erros do CUPS </h4><br>  No meu caso, esse problema apareceu: <br><br><blockquote>  Não foi possível conectar ao host local do servidor CUPS: 631 </blockquote><br>  Corrigido por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este</a> pequeno artigo. <br><br><h2>  Atualização subsequente para o problema e solução do Debian 9 </h2><br>  At <br><br><pre> <code class="hljs powershell">apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> dist<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span></code> </pre> <br>  Houve um problema, ou seja, samba e winbind não quiseram ser atualizados.  Entrou em um conflito de dependências. <br><br>  O método do artigo ajudou o link no qual, infelizmente, eu não salvei. <br>  Aqui está uma citação direta dele: <br><br><blockquote>  se o Samba estiver no modo AD-DC, ele e o winbind falharão. <br>  execute esses comandos e tente executar a atualização novamente <br><br>  systemctl parar smbd nmbd winbind <br>  systemctl desativar smbd nmbd winbind <br>  Desinstalar systemctl samba-ad-dc <br>  systemctl start samba-ad-dc <br>  systemctl enable samba-ad-dc <br></blockquote><br><br><h4>  Após atualizar a versão SAMBA, é recomendável: “Verificação do banco de dados Samba AD DC”. </h4><br><br> <code># samba-tool dbcheck --cross-ncs</code> <br> <br>  Como no Deb 9 SAMBA versão 4.5, recebi vários erros "replPropertyMetaData". <br>  O processo de solução de problemas está descrito na documentação: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki.samba.org/index.php/Updating_Samba#Fixing_replPropertyMetaData_Attributes</a> <br><br>  E tudo se resume à execução do comando: <br><br> <code>samba-tool dbcheck --cross-ncs --fix --yes</code> <br> <br><h2>  Lista de fontes usadas </h2><br>  Documentação SAMBA: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Migrando um domínio do Samba NT4 para o Samba AD (atualização clássica)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando o Samba como um controlador de domínio do Active Directory</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando um compartilhamento usando ACLs do Windows</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pastas da página inicial do usuário</a> <br>  Grande artigo: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Controlador de domínio Debian 8 (... que já possui um Samba4 embutido)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Erro de samba: Não foi possível conectar-se ao servidor local do CUPS: 631</a> <br>  Um artigo de um autor inglês desconhecido descrevendo como atualizar para o Debian 9 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418499/">https://habr.com/ru/post/pt418499/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418487/index.html">Sobre o trabalho na Alemanha</a></li>
<li><a href="../pt418489/index.html">Obras-primas da construção mundial de colunas: evolução de um padrão de três vias, estúdio cult da JBL</a></li>
<li><a href="../pt418491/index.html">Resistência à automação de teste</a></li>
<li><a href="../pt418493/index.html">Bluetooth História em primeira pessoa</a></li>
<li><a href="../pt418497/index.html">"Eu não te reconheço em maquiagem" (c)</a></li>
<li><a href="../pt418501/index.html">Vítimas do RGPD: quem já parou de trabalhar devido a nova regulamentação de dados pessoais</a></li>
<li><a href="../pt418503/index.html">Após 2020, o Reino Unido adquirirá o primeiro espaçoporto - na Escócia</a></li>
<li><a href="../pt418505/index.html">Visão geral e comparação de plataformas de software quântico no nível de porta</a></li>
<li><a href="../pt418507/index.html">O que a cosmonáutica nos deu?</a></li>
<li><a href="../pt418509/index.html">Amazon Rekognition reconhece 28 congressistas dos EUA como criminosos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>