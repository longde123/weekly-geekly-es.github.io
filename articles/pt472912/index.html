<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖ üèùÔ∏è ü¶í Banco de dados ClickHouse para humanos ou Alien Technology üñïüèæ üöØ üòÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexey Lizunov, chefe do centro de compet√™ncia dos canais de servi√ßo remoto da Diretoria de Tecnologias da Informa√ß√£o do CID 



 Como alternativa √† p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Banco de dados ClickHouse para humanos ou Alien Technology</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/"> <b>Alexey Lizunov, chefe do centro de compet√™ncia dos canais de servi√ßo remoto da Diretoria de Tecnologias da Informa√ß√£o do CID</b> <br><br><img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br><br>  Como alternativa √† pilha ELK (ElasticSearch, Logstash, Kibana), estamos realizando pesquisas sobre o uso do banco de dados ClickHouse como um armaz√©m de dados para logs. <br><br>  Neste artigo, gostar√≠amos de falar sobre nossa experi√™ncia no uso do banco de dados ClickHouse e sobre resultados preliminares da opera√ß√£o piloto.  Deve-se notar imediatamente que os resultados foram impressionantes. <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br><br>  A seguir, descreveremos com mais detalhes como nosso sistema est√° configurado e em quais componentes ele consiste.  Mas agora eu gostaria de falar um pouco sobre esse banco de dados como um todo e por que voc√™ deve prestar aten√ß√£o nele.  O banco de dados ClickHouse √© um banco de dados de coluna anal√≠tica de alto desempenho da Yandex.  √â usado nos servi√ßos Yandex, inicialmente √© o principal data warehouse para o Yandex.Metrica.  O sistema de c√≥digo aberto √© gratuito.  Do ponto de vista do desenvolvedor, eu sempre me interessei em como eles o implementaram, porque h√° dados incrivelmente grandes.  E a pr√≥pria interface de usu√°rio m√©trica √© muito flex√≠vel e r√°pida.  No primeiro contato com este banco de dados, a impress√£o: ‚ÄúBem, finalmente!  Feito "para pessoas"!  Come√ßando pelo processo de instala√ß√£o e terminando com o envio de solicita√ß√µes. " <br><br>  Este banco de dados tem um limite de entrada muito baixo.  Mesmo um desenvolvedor qualificado m√©dio pode instalar esse banco de dados em alguns minutos e come√ßar a us√°-lo.  Tudo funciona claramente.  Mesmo as pessoas novas no Linux podem passar rapidamente pela instala√ß√£o e executar opera√ß√µes simples.  Anteriormente, quando a palavra Big Data, Hadoop, Google BigTable, HDFS, o desenvolvedor habitual teve a ideia de que eles estavam falando sobre alguns terabytes, petabytes, que alguns super-humanos estavam envolvidos nas configura√ß√µes e no desenvolvimento desses sistemas, depois com o advento do banco de dados ClickHouse que obtivemos Uma ferramenta simples e compreens√≠vel com a qual voc√™ pode resolver a gama de tarefas anteriormente inating√≠vel.  Apenas um carro razoavelmente m√©dio e cinco minutos para instalar.  Ou seja, temos um banco de dados como, por exemplo, MySql, mas apenas para armazenar bilh√µes de registros!  Algum tipo de supervisor SQL.  √â como se as pessoas recebessem armas de alien√≠genas. <br><br><h4>  Sobre o nosso sistema de coleta de logs </h4><br>  Para coletar informa√ß√µes, s√£o usados ‚Äã‚Äãarquivos de log do IIS de aplicativos da Web de um formato padr√£o (tamb√©m estamos envolvidos na an√°lise de logs de aplicativos, mas o principal objetivo no est√°gio de opera√ß√£o piloto conosco √© coletar logs do IIS). <br><br>  Por v√°rias raz√µes, falhamos em abandonar completamente a pilha ELK e continuamos a usar os componentes LogStash e Filebeat, que se mostraram bem e funcionam de maneira confi√°vel e previs√≠vel. <br><br>  O esquema geral de registro √© apresentado na figura abaixo: <br><br><img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br><br>  Um recurso de grava√ß√£o de dados no banco de dados ClickHouse √© a inser√ß√£o pouco frequente (uma vez por segundo) de registros em lotes grandes.  Aparentemente, essa √© a parte mais "problem√°tica" que voc√™ encontra quando experimenta trabalhar com o banco de dados ClickHouse: o esquema √© um pouco complicado. <br>  O plug-in LogStash ajudou muito aqui, que insere dados diretamente no ClickHouse.  Este componente √© implantado no mesmo servidor que o pr√≥prio banco de dados.  Portanto, de um modo geral, n√£o √© recomend√°vel faz√™-lo, mas de um ponto de vista pr√°tico, para n√£o produzir servidores separados enquanto estiver implantado no mesmo servidor.  N√£o observamos nenhuma falha ou conflito de recursos com o banco de dados.  Al√©m disso, deve-se notar que o plug-in possui um mecanismo de recupera√ß√£o em caso de erros.  E, no caso de erros, o plug-in grava no disco um pacote de dados que n√£o p√¥de ser inserido (o formato do arquivo √© conveniente: ap√≥s a edi√ß√£o, voc√™ pode inserir facilmente o pacote corrigido usando o clickhouse-client). <br><br>  A lista completa de softwares usados ‚Äã‚Äãno esquema √© apresentada na tabela: <br><br><div class="spoiler">  <b class="spoiler_title">Lista de software usado</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  <b>T√≠tulo</b> <br></td><td>  <b>Descri√ß√£o do produto</b> <br></td><td>  <b>Link de distribui√ß√£o</b> <br></td></tr><tr><td><p>  Nginx </p><br></td><td><p>  Proxy reverso para restringir o acesso e a autoriza√ß√£o da porta </p><br><br><p>  Atualmente n√£o usado no circuito. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://nginx.org/en/download.html</a> </p><br></td><td><p>  <a href="">https://nginx.org/download/nginx-1.16.0.tar.gz</a> </p><br></td></tr><tr><td><p>  Filebeat </p><br></td><td><p>  Transferir logs de arquivos. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> (distribui√ß√£o para Windows 64 bits). </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Coletor de logs. </p><br><br><p>  Usado para coletar logs do FileBeat, bem como para coletar logs da fila RabbitMQ (para servidores que est√£o na DMZ). </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Logstash- output- clickhouse </p><br></td><td><p>  Plug-in Loagstash para transferir logs para o banco de dados ClickHouse em lotes </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a> </p><br></td><td><p>  / usr / share / logstash / bin / logstash-plugin instala logstash-output-clickhouse </p><br><p>  / usr / share / logstash / bin / logstash-plugin instala logstash-filter-prune </p><br><p>  / usr / share / logstash / bin / logstash-plugin instala logstash-filter-multiline </p><br></td></tr><tr><td><p>  Clickhouse </p><br></td><td><p>  Reposit√≥rio de log <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://clickhouse.yandex/docs/ru/</a> </p><br></td><td><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  Nota  Desde agosto de 2018, os assemblies rpm "normais" para RHEL aparecem no reposit√≥rio Yandex, para que voc√™ possa tentar us√°-los.  No momento da instala√ß√£o, usamos pacotes compilados pelo Altinity. </p><br></td></tr><tr><td><p>  Grafana </p><br></td><td><p>  Visualiza√ß√£o de log.  Configurar pain√©is </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://grafana.com/</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://grafana.com/grafana/download</a> </p><br><br><p>  Redhat &amp; Centos (64 Bit) - Vers√£o mais recente </p><br></td></tr><tr><td><p>  Fonte de dados ClickHouse para Grafana 4.6+ </p><br></td><td><p>  Plug-in Grafana com fonte de dados ClickHouse </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/download</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Roteador de log do FileBeat para a fila RabbitMQ. </p><br><p>  Nota  Infelizmente, o FileBeat n√£o possui sa√≠da diretamente no RabbitMQ, portanto, um link intermedi√°rio na forma de Logstash √© necess√°rio </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Rabbitmq </p><br></td><td><p>  Fila de mensagens  Este √© um buffer de entradas de log na DMZ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.rabbitmq.com/download.html</a> </p><br></td><td><p>  <a href="">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a> </p><br></td></tr><tr><td><p>  Tempo de execu√ß√£o Erlang (necess√°rio para o RabbitMQ) </p><br></td><td><p>  Tempo de execu√ß√£o Erlang.  Necess√°rio para o RabbitMQ funcionar </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.erlang.org/download.html</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="">http://www.erlang.org/downloads/21.3</a> </p><br></td></tr></tbody></table></div><br></div></div><br>  A configura√ß√£o do servidor com o banco de dados ClickHouse √© apresentada na tabela a seguir: <br><div class="scrollable-table"><table><tbody><tr><td>  <b>T√≠tulo</b> <br></td><td>  <b>Valor</b> <br></td><td>  <b>Nota</b> <br></td></tr><tr><td><p>  Configura√ß√£o </p><br></td><td><p>  HDD: 40GB <br>  RAM: 8GB <br>  Processador: Core 2 2Ghz </p><br></td><td><p>  √â necess√°rio prestar aten√ß√£o √†s dicas sobre como operar o banco de dados ClickHouse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://clickhouse.yandex/docs/ru/operations/tips/</a> ) </p><br></td></tr><tr><td><p>  Software para todo o sistema </p><br></td><td><p>  Sistema Operacional: Servidor Red Hat Enterprise Linux (Maipo) </p><br><p>  JRE (Java 8) </p><br></td><td><p></p><br></td></tr></tbody></table></div><br>  Como voc√™ pode ver, esta √© uma esta√ß√£o de trabalho regular. <br><br>  A estrutura da tabela para armazenar logs √© a seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">log_web.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_web ( logdate <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, logdatetime DateTime CODEC(Delta, LZ4HC), fld_log_file_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_server_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_module LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_website_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), serverIP LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), method LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), uriStem <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, uriQuery <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, port UInt32, username LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), clientIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, clientRealIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, userAgent <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, subresponse <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, win32response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, timetaken UInt64 , uriQuery__utm_medium <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_source <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_campaign <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_term <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_content <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__yclid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__region <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> = MergeTree() <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> toYYYYMM(logdate) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (fld_app_name, fld_app_module, logdatetime) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">8192</span></span>;</code> </pre> <br></div></div><br>  Usamos valores padr√£o para particionamento (por meses) e granularidade do √≠ndice.  Todos os campos correspondem praticamente √†s entradas de log do IIS para registrar solicita√ß√µes http.  Separadamente, campos separados para armazenar tags utm (eles s√£o analisados ‚Äã‚Äãno est√°gio de inser√ß√£o na tabela a partir do campo string de consulta). <br><br>  Tamb√©m na tabela s√£o adicionados v√°rios campos do sistema para armazenar informa√ß√µes sobre sistemas, componentes, servidores.  Veja a tabela abaixo para obter uma descri√ß√£o desses campos.  Em uma tabela, armazenamos logs para v√°rios sistemas. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>T√≠tulo</b> <br></td><td>  <b>Descri√ß√£o do produto</b> <br></td><td>  <b>Exemplo</b> <br></td></tr><tr><td><p>  fld_app_name </p><br></td><td><p>  Nome do aplicativo / sistema <br>  Valores v√°lidos: </p><br><ul><li>  site1.domain.com site externo 1 </li><li>  site2.domain.com Site externo 2 </li><li>  internal-site1.domain.local Site interno 1 </li></ul><br></td><td>  site1.dom√≠nio.com <br></td></tr><tr><td><p>  fld_app_module </p><br></td><td><p>  M√≥dulo do sistema <br>  Valores v√°lidos: </p><br><ul><li>  web - site </li><li>  svc - servi√ßo de site </li><li>  intgr - Servi√ßo de Integra√ß√£o da Web </li><li>  bo - Admin (BackOffice) </li></ul><br></td><td><p>  teia </p><br></td></tr><tr><td><p>  fld_website_name </p><br></td><td><p>  Nome do site no IIS </p><br><p>  V√°rios sistemas podem ser implantados em um servidor ou at√© v√°rias inst√¢ncias de um m√≥dulo do sistema </p><br></td><td><p>  web-main </p><br></td></tr><tr><td><p>  fld_server_name </p><br></td><td><p>  Nome do servidor </p><br></td><td><p>  web1.dom√≠nio.com </p><br></td></tr><tr><td><p>  fld_log_file_name </p><br></td><td><p>  O caminho para o arquivo de log no servidor </p><br></td><td>  C: \ inetpub \ logs \ LogFiles <br>  \ W3SVC1 \ u_ex190711.log <br></td></tr></tbody></table></div><br>  Isso permite que voc√™ crie efetivamente gr√°ficos no Grafana.  Por exemplo, visualize solicita√ß√µes do front-end de um sistema espec√≠fico.  Isso √© semelhante ao contador do site no Yandex.Metrica. <br><br>  Aqui est√£o algumas estat√≠sticas sobre o uso do banco de dados por dois meses. <br><br><div class="spoiler">  <b class="spoiler_title">N√∫mero de registros por sistema e componente</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fld_app_name, fld_app_module, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(fld_app_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rows_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> log_web <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name, fld_app_module <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TOTALS <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, rows_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> ‚îå‚îÄfld_app_name‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄfld_app_module‚îÄ‚î¨‚îÄrows_count‚îÄ‚îê ‚îÇ site1.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">131441</span></span> ‚îÇ ‚îÇ site2.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">1751081</span></span> ‚îÇ ‚îÇ site3.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">106887543</span></span> ‚îÇ ‚îÇ site3.domain.ru ‚îÇ svc ‚îÇ <span class="hljs-number"><span class="hljs-number">44908603</span></span> ‚îÇ ‚îÇ site3.domain.ru ‚îÇ intgr ‚îÇ <span class="hljs-number"><span class="hljs-number">9813911</span></span> ‚îÇ ‚îÇ site4.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">772095</span></span> ‚îÇ ‚îÇ site5.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">17037221</span></span> ‚îÇ ‚îÇ site5.domain.ru ‚îÇ intgr ‚îÇ <span class="hljs-number"><span class="hljs-number">838559</span></span> ‚îÇ ‚îÇ site5.domain.ru ‚îÇ bo ‚îÇ <span class="hljs-number"><span class="hljs-number">7404</span></span> ‚îÇ ‚îÇ site6.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">595877</span></span> ‚îÇ ‚îÇ site7.domain.ru ‚îÇ web ‚îÇ <span class="hljs-number"><span class="hljs-number">27778858</span></span> ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò Totals: ‚îå‚îÄfld_app_name‚îÄ‚î¨‚îÄfld_app_module‚îÄ‚î¨‚îÄrows_count‚îÄ‚îê ‚îÇ ‚îÇ ‚îÇ <span class="hljs-number"><span class="hljs-number">210522593</span></span> ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">4.874</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">210.52</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">421.67</span></span> MB (<span class="hljs-number"><span class="hljs-number">43.19</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">86.51</span></span> MB/s.)</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">A quantidade de dados no disco</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_uncompressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_compressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_rows <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.parts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ‚îå‚îÄuncompressed‚îÄ‚î¨‚îÄcompressed‚îÄ‚î¨‚îÄtotal_rows‚îÄ‚îê ‚îÇ <span class="hljs-number"><span class="hljs-number">54.50</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">4.86</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">211427094</span></span> ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">O grau de compacta√ß√£o de dados em colunas</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(data_compressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compress_ratio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> ‚îå‚îÄ<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄuncompressed‚îÄ‚î¨‚îÄcompressed‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄcompress_ratio‚îÄ‚îê ‚îÇ logdate ‚îÇ <span class="hljs-number"><span class="hljs-number">401.53</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">1.80</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">223.16665968777315</span></span> ‚îÇ ‚îÇ logdatetime ‚îÇ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">35.91</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">22.363966401202305</span></span> ‚îÇ ‚îÇ fld_log_file_name ‚îÇ <span class="hljs-number"><span class="hljs-number">220.66</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">2.60</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">84.99905736932571</span></span> ‚îÇ ‚îÇ fld_server_name ‚îÇ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">50.63</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">3.980924816977078</span></span> ‚îÇ ‚îÇ fld_app_name ‚îÇ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">969.17</span></span> KiB ‚îÇ <span class="hljs-number"><span class="hljs-number">212.55518183686877</span></span> ‚îÇ ‚îÇ fld_app_module ‚îÇ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">968.60</span></span> KiB ‚îÇ <span class="hljs-number"><span class="hljs-number">212.67805817411906</span></span> ‚îÇ ‚îÇ fld_website_name ‚îÇ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">1.24</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">162.7204926761546</span></span> ‚îÇ ‚îÇ serverIP ‚îÇ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">50.25</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">4.010824061219731</span></span> ‚îÇ ‚îÇ method ‚îÇ <span class="hljs-number"><span class="hljs-number">201.53</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">43.64</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">4.617721053304486</span></span> ‚îÇ ‚îÇ uriStem ‚îÇ <span class="hljs-number"><span class="hljs-number">5.13</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">832.51</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">6.311522291936919</span></span> ‚îÇ ‚îÇ uriQuery ‚îÇ <span class="hljs-number"><span class="hljs-number">2.58</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">501.06</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">5.269731450124478</span></span> ‚îÇ ‚îÇ port ‚îÇ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">3.98</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">201.91673864241824</span></span> ‚îÇ ‚îÇ username ‚îÇ <span class="hljs-number"><span class="hljs-number">318.08</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">26.93</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">11.812513794583598</span></span> ‚îÇ ‚îÇ clientIP ‚îÇ <span class="hljs-number"><span class="hljs-number">2.35</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">82.59</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">29.132328640073343</span></span> ‚îÇ ‚îÇ clientRealIP ‚îÇ <span class="hljs-number"><span class="hljs-number">2.49</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">465.05</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">5.478382297052563</span></span> ‚îÇ ‚îÇ userAgent ‚îÇ <span class="hljs-number"><span class="hljs-number">18.34</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">764.08</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">24.57905114484208</span></span> ‚îÇ ‚îÇ referer ‚îÇ <span class="hljs-number"><span class="hljs-number">14.71</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">1.37</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">10.736792723669906</span></span> ‚îÇ ‚îÇ response ‚îÇ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">83.81</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">9.582334090987247</span></span> ‚îÇ ‚îÇ subresponse ‚îÇ <span class="hljs-number"><span class="hljs-number">399.87</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">1.83</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">218.4831068635027</span></span> ‚îÇ ‚îÇ win32response ‚îÇ <span class="hljs-number"><span class="hljs-number">407.86</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">7.41</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">55.050315514606815</span></span> ‚îÇ ‚îÇ timetaken ‚îÇ <span class="hljs-number"><span class="hljs-number">1.57</span></span> GiB ‚îÇ <span class="hljs-number"><span class="hljs-number">402.06</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">3.9947395692010637</span></span> ‚îÇ ‚îÇ uriQuery__utm_medium ‚îÇ <span class="hljs-number"><span class="hljs-number">208.17</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">12.29</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">16.936148912472955</span></span> ‚îÇ ‚îÇ uriQuery__utm_source ‚îÇ <span class="hljs-number"><span class="hljs-number">215.18</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">13.00</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">16.548367623199912</span></span> ‚îÇ ‚îÇ uriQuery__utm_campaign ‚îÇ <span class="hljs-number"><span class="hljs-number">381.46</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">37.94</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">10.055156353418509</span></span> ‚îÇ ‚îÇ uriQuery__utm_term ‚îÇ <span class="hljs-number"><span class="hljs-number">231.82</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">10.78</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">21.502540454070672</span></span> ‚îÇ ‚îÇ uriQuery__utm_content ‚îÇ <span class="hljs-number"><span class="hljs-number">441.34</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">87.60</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">5.038260760449327</span></span> ‚îÇ ‚îÇ uriQuery__yclid ‚îÇ <span class="hljs-number"><span class="hljs-number">216.88</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">16.58</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">13.07721335008116</span></span> ‚îÇ ‚îÇ uriQuery__region ‚îÇ <span class="hljs-number"><span class="hljs-number">204.35</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">9.49</span></span> MiB ‚îÇ <span class="hljs-number"><span class="hljs-number">21.52661903446796</span></span> ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.005</span></span> sec.</code> </pre> <br></div></div><br><h4>  Descri√ß√£o dos componentes utilizados <br><br>  FileBeat.  Transfer√™ncia de log de arquivo </h4><br>  Este componente monitora altera√ß√µes nos arquivos de log no disco e transfere informa√ß√µes para o LogStash.  √â instalado em todos os servidores em que os arquivos de log s√£o gravados (geralmente IIS).  Funciona no modo de cauda (ou seja, transfere apenas registros adicionados a um arquivo).  Mas separadamente, voc√™ pode configurar toda a transfer√™ncia de arquivos.  Isso √© √∫til quando voc√™ precisa baixar dados de meses anteriores.  Basta colocar o arquivo de log em uma pasta e ele o ler√° na √≠ntegra. <br><br>  Quando o servi√ßo para, os dados deixam de ser transferidos para o armazenamento. <br><br>  Um exemplo de configura√ß√£o √© o seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">filebeat.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs">filebeat.inputs: - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment"><span class="hljs-comment">/*.log exclude_files: ['.gz$','.zip$'] tail_files: true ignore_older: 24h fields: fld_server_name: "site1.domain.ru" fld_app_name: "site1.domain.ru" fld_app_module: "web" fld_website_name: "web-main" - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/__Import/access_log-* exclude_files: ['.gz$','.zip$'] tail_files: false fields: fld_server_name: "site2.domain.ru" fld_app_name: "site2.domain.ru" fld_app_module: "web" fld_website_name: "web-main" fld_logformat: "logformat__apache" filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false reload.period: 2s output.logstash: hosts: ["log.domain.com:5044"] ssl.enabled: true ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"] ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer" ssl.key: "C:/filebeat/certs/site1.domain.ru.key" #================================ Processors ===================================== processors: - add_host_metadata: ~ - add_cloud_metadata: ~</span></span></code> </pre> <br></div></div><br><h4>  LogStash  Coletor de logs </h4><br>  Este componente destina-se a receber entradas de log do FileBeat (ou atrav√©s da fila RabbitMQ), analisando e inserindo pacotes configur√°veis ‚Äã‚Äãno banco de dados ClickHouse. <br><br>  Para inserir no ClickHouse, o plug-in Logstash-output-clickhouse √© usado.  O plug-in Logstash possui um mecanismo para recuperar solicita√ß√µes, mas com um desligamento regular, √© melhor parar o servi√ßo em si.  Quando voc√™ para, as mensagens se acumulam na fila do RabbitMQ; portanto, se voc√™ parar por um longo per√≠odo, √© melhor parar as batidas de arquivo nos servidores.  Em um esquema em que o RabbitMQ n√£o √© usado (em uma rede local, o Filebeat envia logs diretamente para o Logstash), os Filebeats funcionam de forma razo√°vel e segura, portanto, para eles, a inacessibilidade da sa√≠da n√£o tem consequ√™ncias. <br><br>  Um exemplo de configura√ß√£o √© o seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">log_web__filebeat_clickhouse.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"] ssl_certificate =&gt; "/etc/logstash/certs/server.cer" ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key" ssl_verify_mode =&gt; "peer" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } rabbitmq { host =&gt; "queue.domain.com" port =&gt; 5671 user =&gt; "q-reader" password =&gt; "password" queue =&gt; "web_log" heartbeat =&gt; 30 durable =&gt; true ssl =&gt; true <span class="hljs-comment"><span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12" #ssl_certificate_password =&gt; "password" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } } filter { if [message] =~ "^#" { drop {} } if [fld_logformat] == "logformat__iis_with_xrealip" { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"] } } else { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"] } } date { match =&gt; [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ] timezone =&gt; "Etc/UTC" remove_field =&gt; [ "log_timestamp", "@timestamp" ] target =&gt; [ "log_timestamp2" ] } ruby { code =&gt; "tstamp = event.get('log_timestamp2').to_i event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S')) event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))" } if [bytesSent] { ruby { code =&gt; "event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0" } } if [bytesReceived] { ruby { code =&gt; "event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0" } } ruby { code =&gt; "event.set('clientRealIP', event.get('clientIP'))" } if [xrealIP] { ruby { code =&gt; "event.set('clientRealIP', event.get('xrealIP'))" } } if [xforwarderfor] { ruby { code =&gt; "event.set('clientRealIP', event.get('xforwarderfor'))" } } mutate { convert =&gt; ["bytesSent", "integer"] convert =&gt; ["bytesReceived", "integer"] convert =&gt; ["timetaken", "integer"] convert =&gt; ["port", "integer"] add_field =&gt; { "clientHostname" =&gt; "%{clientIP}" } } useragent { source=&gt; "useragent" prefix=&gt; "browser" } kv { source =&gt; "uriQuery" prefix =&gt; "uriQuery__" allow_duplicate_values =&gt; false field_split =&gt; "&amp;" include_keys =&gt; [ "utm_medium", "utm_source", "utm_campaign", "utm_term", "utm_content", "yclid", "region" ] } mutate { join =&gt; { "uriQuery__utm_source" =&gt; "," } join =&gt; { "uriQuery__utm_medium" =&gt; "," } join =&gt; { "uriQuery__utm_campaign" =&gt; "," } join =&gt; { "uriQuery__utm_term" =&gt; "," } join =&gt; { "uriQuery__utm_content" =&gt; "," } join =&gt; { "uriQuery__yclid" =&gt; "," } join =&gt; { "uriQuery__region" =&gt; "," } } } output { #stdout {codec =&gt; rubydebug} clickhouse { headers =&gt; ["Authorization", "Basic abcdsfks..."] http_hosts =&gt; ["http://127.0.0.1:8123"] save_dir =&gt; "/etc/logstash/tmp" table =&gt; "log_web" request_tolerance =&gt; 1 flush_size =&gt; 10000 idle_flush_time =&gt; 1 mutations =&gt; { "fld_log_file_name" =&gt; "fld_log_file_name" "fld_server_name" =&gt; "fld_server_name" "fld_app_name" =&gt; "fld_app_name" "fld_app_module" =&gt; "fld_app_module" "fld_website_name" =&gt; "fld_website_name" "logdatetime" =&gt; "logdatetime" "logdate" =&gt; "logdate" "serverIP" =&gt; "serverIP" "method" =&gt; "method" "uriStem" =&gt; "uriStem" "uriQuery" =&gt; "uriQuery" "port" =&gt; "port" "username" =&gt; "username" "clientIP" =&gt; "clientIP" "clientRealIP" =&gt; "clientRealIP" "userAgent" =&gt; "userAgent" "referer" =&gt; "referer" "response" =&gt; "response" "subresponse" =&gt; "subresponse" "win32response" =&gt; "win32response" "timetaken" =&gt; "timetaken" "uriQuery__utm_medium" =&gt; "uriQuery__utm_medium" "uriQuery__utm_source" =&gt; "uriQuery__utm_source" "uriQuery__utm_campaign" =&gt; "uriQuery__utm_campaign" "uriQuery__utm_term" =&gt; "uriQuery__utm_term" "uriQuery__utm_content" =&gt; "uriQuery__utm_content" "uriQuery__yclid" =&gt; "uriQuery__yclid" "uriQuery__region" =&gt; "uriQuery__region" } } }</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">pipelines.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple. # For more information on multiple pipelines, see the documentation: # https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html - pipeline.id: log_web__filebeat_clickhouse path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</span></span></code> </pre> <br></div></div><br><h4>  ClickHouse.  Armazenamento de log </h4><br>  Os logs de todos os sistemas s√£o salvos em uma tabela (consulte o in√≠cio do artigo).  Destina-se a armazenar informa√ß√µes sobre solicita√ß√µes: todos os par√¢metros s√£o semelhantes para diferentes formatos, por exemplo, logs do IIS, logs do apache e nginx.  Para logs de aplicativos nos quais, por exemplo, erros, mensagens informativas e avisos s√£o registrados, uma tabela separada ser√° fornecida com a estrutura correspondente (agora no est√°gio de design). <br><br>  Ao projetar uma tabela, √© muito importante determinar a chave prim√°ria (pela qual os dados ser√£o classificados durante o armazenamento).  O grau de compacta√ß√£o de dados e a velocidade da consulta dependem disso.  No nosso exemplo, a chave √© <br>  ORDER BY (fld_app_name, fld_app_module, logdatetime) <br>  Ou seja, pelo nome do sistema, o nome do componente do sistema e a data do evento.  A data original do evento estava em primeiro lugar.  Depois de mov√™-lo para o √∫ltimo local, as consultas come√ßaram a funcionar duas vezes mais r√°pido.  Alterar a chave prim√°ria exigir√° recriar a tabela e recarregar os dados para que o ClickHouse reorganize os dados no disco.  Como √© uma opera√ß√£o dif√≠cil, √© aconselh√°vel pensar com anteced√™ncia o que deve ser inclu√≠do na chave de classifica√ß√£o. <br><br>  Tamb√©m deve ser observado que, nas vers√µes recentes, o tipo de dados LowCardinality apareceu.  Ao us√°-lo, o tamanho dos dados compactados √© bastante reduzido para os campos com baixa cardinalidade (poucas op√ß√µes). <br><br>  Agora a vers√£o 19.6 √© usada e planejamos tentar atualizar a vers√£o para a mais recente.  Eles inclu√≠am recursos maravilhosos como granularidade adaptativa, √≠ndices de igni√ß√£o e o codec DoubleDelta, por exemplo. <br><br>  Por padr√£o, durante a instala√ß√£o, o n√≠vel do log de configura√ß√£o √© definido para rastrear.  Os logs s√£o rotacionados e arquivados, mas expandem para um gigabyte.  Se n√£o houver necessidade, voc√™ poder√° definir o n√≠vel de aviso e o tamanho do log diminuir√° acentuadamente.  As configura√ß√µes de log s√£o definidas no arquivo config.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Alguns comandos √∫teis</b> <div class="spoiler_text"><pre> <code class="sql hljs">      Debian,     Linux      Altinity.           : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-clickhouse sudo yum <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clickhouse-server.noarch <span class="hljs-number"><span class="hljs-number">1.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>        (   <span class="hljs-string"><span class="hljs-string">";"</span></span>) clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--multiline clickhouse-client --multiline --host 127.0.0.1 --password pa55w0rd clickhouse-client --multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd                /tmp/log_web_failed.json            : clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json sudo clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json     quit; ##  TLS https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2 openssl s_client -connect log.domain.com:9440 &lt; /dev/null</span></span></code> </pre> <br></div></div><br><h4>  LogStash  Roteador de log FileBeat para a fila RabbitMQ </h4><br>  Este componente √© usado para rotear logs provenientes do FileBeat para a fila RabbitMQ.  Existem dois pontos: <br><br><ol><li>  Infelizmente, o FileBeat n√£o possui um plug-in de sa√≠da para gravar diretamente no RabbitMQ.  E essa funcionalidade, a julgar pelo ish no github, n√£o est√° planejada para implementa√ß√£o.  Existe um plugin para o Kafka, mas por algum motivo n√£o podemos us√°-lo em casa. </li><li>  Existem requisitos para coletar logs na DMZ.  Com base neles, os logs devem primeiro ser adicionados √† fila e, em seguida, o LogStash de fora l√™ as entradas da fila. </li></ol><br>  Portanto, √© precisamente no caso da localiza√ß√£o do servidor na DMZ que voc√™ precisa usar um esquema um pouco complicado.  Um exemplo de configura√ß√£o √© o seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">iis_w3c_logs__filebeat_rabbitmq.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"] ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer" ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key" ssl_verify_mode =&gt; "peer" } } output { <span class="hljs-comment"><span class="hljs-comment">#stdout {codec =&gt; rubydebug} rabbitmq { host =&gt; "127.0.0.1" port =&gt; 5672 exchange =&gt; "monitor.direct" exchange_type =&gt; "direct" key =&gt; "%{[fields][fld_app_name]}" user =&gt; "q-writer" password =&gt; "password" ssl =&gt; false } }</span></span></code> </pre> <br></div></div><br><h4>  RabbitMQ.  Fila de mensagens </h4><br>  Este componente √© usado para armazenar em buffer as entradas de log na DMZ.  A grava√ß√£o √© feita atrav√©s de um monte de Filebeat ‚Üí LogStash.  A leitura √© feita de fora da DMZ via LogStash.  Ao operar atrav√©s do RabboitMQ, cerca de 4 mil mensagens s√£o processadas por segundo. <br><br>  O roteamento de mensagens √© configurado de acordo com o nome do sistema, ou seja, com base nos dados de configura√ß√£o do FileBeat.  Todas as mensagens caem em uma fila.  Se, por qualquer motivo, o servi√ßo de fila for parado, isso n√£o levar√° √† perda de mensagens: o FileBeats receber√° erros de conex√£o e suspender√° o envio tempor√°rio.  E o LogStash, que l√™ da fila, tamb√©m receber√° erros de rede e aguardar√° a retomada da conex√£o.  Os dados, √© claro, n√£o ser√£o mais gravados no banco de dados. <br><br>  As seguintes instru√ß√µes s√£o usadas para criar e configurar filas: <br><br><pre> <code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> <span class="hljs-comment"><span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru" sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></span></code> </pre> <br><h4>  Grafana  Dashboards </h4><br>  Este componente √© usado para visualizar os dados de monitoramento.  Nesse caso, voc√™ deve instalar a fonte de dados ClickHouse para o plugin Grafana 4.6+.  Tivemos que ajust√°-lo um pouco para aumentar a efici√™ncia do processamento de filtros SQL em um painel. <br><br>  Por exemplo, usamos vari√°veis ‚Äã‚Äãe, se n√£o estiverem configuradas no campo de filtro, gostar√≠amos que ela n√£o gerasse uma condi√ß√£o no formul√°rio WHERE (uriStem = `` AND uriStem! = '').  Nesse caso, o ClickHouse ler√° a coluna uriStem.  Em geral, tentamos op√ß√µes diferentes e, eventualmente, corrigimos o plugin (macro $ valueIfEmpty) para que, no caso de um valor vazio, retornasse 1, sem mencionar a pr√≥pria coluna. <br><br>  E agora voc√™ pode usar esta consulta para o gr√°fico <br><br><pre> <code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name') and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%') and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code> </pre> <br>  que √© convertido para esse SQL (observe que os campos vazios do uriStem foram convertidos para apenas 1) <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, groupArray((response, c)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> groupArr <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (intDiv(toUInt32(logdatetime), <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, response, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> default.log_web <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (logdate &gt;= toDate(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (logdatetime &gt;= toDateTime(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_name = <span class="hljs-string"><span class="hljs-string">'site1.domain.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_module = <span class="hljs-string"><span class="hljs-string">'web'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t, response <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br><h4>  Conclus√£o </h4><br>  A apar√™ncia do banco de dados ClickHouse se tornou um evento marcante no mercado.  Era dif√≠cil imaginar que, de gra√ßa, em um instante, est√°vamos armados com uma ferramenta poderosa e pr√°tica para trabalhar com big data.  Obviamente, com as necessidades crescentes (por exemplo, compartilhamento e replica√ß√£o em v√°rios servidores), o esquema se tornar√° mais complexo.  Mas, nas primeiras impress√µes, trabalhar com esse banco de dados √© muito bom.  Pode-se ver que o produto √© feito "para pessoas". <br><br>  Comparado ao ElasticSearch, o custo de armazenamento e processamento de logs, de acordo com estimativas preliminares, √© reduzido de cinco para dez vezes.  Em outras palavras, se para a quantidade atual de dados precisarmos configurar um cluster de v√°rias m√°quinas, ao usar o ClickHouse, precisaremos apenas de uma m√°quina de baixa energia.  Sim, √© claro, o ElasticSearch tamb√©m possui mecanismos para compactar dados no disco e outros recursos que podem reduzir significativamente o consumo de recursos, mas, comparado ao ClickHouse, isso ser√° caro. <br><br>  Sem otimiza√ß√µes especiais, nas configura√ß√µes padr√£o, o carregamento e a recupera√ß√£o de dados do banco de dados funcionam a uma velocidade incr√≠vel.  At√© o momento, temos poucos dados (cerca de 200 milh√µes de registros), mas o servidor em si √© fraco.  No futuro, podemos usar essa ferramenta para outros fins n√£o relacionados ao armazenamento de logs.  Por exemplo, para an√°lise de ponta a ponta, no campo da seguran√ßa, aprendizado de m√°quina. <br><br>  No final, um pouco sobre os pr√≥s e contras. <br><br><h4>  Contras </h4><br><ol><li>  Download de registros em pacotes grandes.  Por um lado, esse √© um recurso, mas voc√™ ainda precisa usar componentes adicionais para armazenar registros em buffer.  Essa tarefa nem sempre √© simples, mas ainda pode ser solucionada.  E eu gostaria de simplificar o esquema. </li><li>  Algumas funcionalidades ex√≥ticas ou novos recursos geralmente quebram em novas vers√µes.  Isso gera preocupa√ß√µes, reduzindo o desejo de atualizar para uma nova vers√£o.  Por exemplo, o mecanismo de tabela Kafka √© um recurso muito √∫til que permite a leitura direta de eventos do Kafka, sem a implementa√ß√£o de consumidores.  Mas, a julgar pelo n√∫mero de problemas no github, ainda temos o cuidado de usar esse mecanismo na produ√ß√£o.  No entanto, se voc√™ n√£o fizer movimentos bruscos para o lado e usar a funcionalidade b√°sica, ele funcionar√° de forma est√°vel. </li></ol><br><h4>  Pr√≥s </h4><br><ol><li>  N√£o diminui a velocidade. </li><li>  Baixo limiar de entrada. </li><li>  C√≥digo aberto </li><li>  √â gr√°tis </li><li>  Escala bem (fragmenta√ß√£o / replica√ß√£o pronta para uso) </li><li>  Est√° inclu√≠do no registro do software russo recomendado pelo Minist√©rio das Comunica√ß√µes. </li><li>  A presen√ßa de apoio oficial da Yandex. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472912/">https://habr.com/ru/post/pt472912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472894/index.html">DartUP 2019: confer√™ncia sobre Dart and Flutter em S√£o Petersburgo em 23 de novembro</a></li>
<li><a href="../pt472896/index.html">Helic√≥ptero de uma impressora: pela primeira vez, os cientistas ‚Äúimprimiram‚Äù um estojo grande de um motor de helic√≥ptero</a></li>
<li><a href="../pt472902/index.html">Windows para IoT: Suporte aprimorado a hardware e novos recursos de dispositivos inteligentes</a></li>
<li><a href="../pt472908/index.html">Dagaz: Epis√≥dios (Parte 2)</a></li>
<li><a href="../pt472910/index.html">Encontre texto em placas e pacotes usando um smartphone</a></li>
<li><a href="../pt472916/index.html">Back-end, aprendizado de m√°quina e sem servidor s√£o os mais interessantes da confer√™ncia Habr de julho</a></li>
<li><a href="../pt472918/index.html">ZX Spectrum na R√∫ssia e na CEI: como a busca pelo online se transformou offline</a></li>
<li><a href="../pt472922/index.html">Programador do Defender mais forte que a entropia</a></li>
<li><a href="../pt472926/index.html">A lei dos retornos acelerados (parte 1)</a></li>
<li><a href="../pt472928/index.html">Servi√ßo de computa√ß√£o GPU altamente carregado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>