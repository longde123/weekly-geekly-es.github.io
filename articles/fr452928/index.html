<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆔 🧕🏾 🏇🏻 Nous restaurons les machines virtuelles à partir du magasin de données initialisé par erreur. L'histoire d'un non-sens avec une fin heureuse 🗓️ 👯 🖖🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avertissement: la note est divertissante. La densité spécifique d'informations utiles est faible. Il a été écrit «pour vous». 
 Introduction lyrique 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous restaurons les machines virtuelles à partir du magasin de données initialisé par erreur. L'histoire d'un non-sens avec une fin heureuse</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452928/"><blockquote>  <b>Avertissement: la</b> note est divertissante.  La densité spécifique d'informations utiles est faible.  Il a été écrit «pour vous». </blockquote><br><h3>  Introduction lyrique </h3><br>  Le vidage de fichiers dans notre organisation tourne sur une machine virtuelle VMware ESXi 6 sous Windows Server 2016. Et ce n'est pas seulement un vidage.  Il s'agit d'un serveur de partage de fichiers entre les divisions structurelles: il existe une collaboration, une documentation de projet et des dossiers provenant de scanners réseau.  En général, c'est toute la durée de vie de la production. <br><br>  Et ce conteneur de toute la vie de production a commencé à pendre.  De plus, l'invité pouvait se pendre tranquillement, sans affecter le reste.  Pourrait se bloquer après lui-même l'hôte entier et, par conséquent, toutes les autres machines invitées.  Je pourrais me bloquer et bloquer les services client vSphere: c'est-à-dire que les processus des autres invités sont actifs, les machines fonctionnent correctement et répondent, mais il n'y a pas de corruption de fichier et le client vSphere ne s'accroche pas à l'hôte.  En général, aucun système n'a pu être identifié.  Des blocages peuvent survenir pendant la journée lors d'une faible charge.  Pourrait la nuit pendant zéro charge.  Pourrait la nuit pendant la sauvegarde différentielle et la charge moyenne.  Pourrait le week-end pendant une sauvegarde complète et une charge élevée.  Et il y a eu une nette dégradation de la situation.  Au début, c'était une fois par an, puis une fois tous les six mois.  Au bout de ma patience, deux fois par semaine. <br><a name="habracut"></a><br>  J'ai péché pour RAM.  Mais ils ne m'ont pas laissé arrêter la poubelle même le week-end et chasser Memtest.  Attendu pour les vacances de mai.  Les vacances de mai, j'ai quitté Memtest et ... aucune erreur n'a été trouvée. <br><br>  J'étais étonné et j'ai décidé de partir en vacances.  Pendant mes vacances, la décharge n'avait pas un seul coup.  Et quand lundi le premier jour est allé au travail - la poubelle était suspendue.  Une sauvegarde complète a été maintenue et, à la fin, elle a été suspendue.  Une réunion si chaleureuse de vacances m'a poussé à la décision de faire physiquement glisser le lecteur invité vers un autre hôte. <br><br>  Et, bien que l'on sache depuis longtemps que le premier jour après les vacances, rien de grave ne peut être fait, bien que je me sois mis au travail tout le long du chemin du travail, mon indignation avec le prochain gel a assommé mon esprit et mon humeur, et mes vœux ... <br><br>  Les disques physiques ont été réorganisés vers un autre hôte.  Connexion chaude.  Les disques apparaissent dans les paramètres de stockage de l'onglet <i>Lecteurs</i> .  Sous l'onglet <i>Datastores, le</i> stockage sur ces lecteurs ne l'est pas.  <i>Actualiser</i> - n'apparaît pas.  Eh bien, bien sûr, la première impulsion est <i>Add Storage</i> .  L'assistant d'ajout vous indique ce qu'il prend en charge.  Bien sûr, il prend également en charge VMFS.  Je n'en doutais pas.  Un aperçu rapide des messages de l'assistant à chaque étape: Suivant, Suivant, Suivant, Terminer.  Son regard ne capta même pas un petit cercle jaune avec un point d’exclamation au bas de la fenêtre de l’une des marches du maître. <br><br>  À la fin de l'assistant, une nouvelle banque de données est apparue dans la liste ... et avec elle des banques de données d'autres disques physiques. <br><br>  Je passe à la navigation sur le magasin de données nouvellement ajouté, et celui-ci est vide.  Bien sûr, j'ai encore été étonné.  8 heures du matin, les 15 premières minutes de travail après les vacances, même le sucre dans le café n'a pas encore été remué.  Et voilà.  Ma première pensée a été de retirer le mauvais lecteur de l'hôte "natif".  J'ai regardé pour voir si le magasin de données requis est présent dans l'hôte "natif": non, pas présent.  La deuxième pensée était: "merde # b!".  Pas sûr, mais il me semble que la troisième, la quatrième et au moins la cinquième pensée étaient les mêmes. <br><br>  Pour dissiper les doutes, j'ai rapidement installé un nouvel ESXi sur l'échantillon, pris le lecteur de gauche et, après l'avoir lu, parcouru les étapes de l'assistant.  Oui  Lors de l'ajout d'un magasin de données à l'aide de l'assistant, toutes les données sur le disque sont perdues sans la possibilité d'annuler l'opération et de restaurer les données.  Plus tard, j'ai lu sur l'un des forums une évaluation d'une telle conception par le maître: merde merdique.  Et en ce moment, je suis vraiment d'accord. <br><br>  En commençant par le sixième, les pensées ont coulé de manière plus constructive.  D'accord.  L'initialisation prend quelques secondes, même pour un lecteur de 3 To.  Il s'agit donc d'un formatage de haut niveau.  Ainsi, la table de partition a été simplement réécrite.  Les données sont donc toujours là.  Alors maintenant, recherchons un peu de format et le tour est joué. <br><br>  Je charge la voiture depuis l'image de démarrage de Strelec ... Et je découvre que les programmes de récupération de partition sont connus de tout le monde sauf VMFS.  Par exemple, ils connaissent la disposition des partitions de Synology, mais VMFS ne le sait pas. <br><br>  Énumérer les programmes n'est pas rassurant: au mieux, GetDataBack et R.Saver trouvent des partitions NTFS avec des structures de répertoires en direct et des noms de fichiers en direct.  Mais cela ne me convient pas.  J'ai besoin de deux fichiers vmdk: avec un disque système et une poubelle. <br><br>  Et puis je comprends que, semble-t-il, maintenant j'installerai Windows et déploierai la sauvegarde de fichiers.  Et en même temps, je me souviens que j'avais une racine DFS là-bas.  Et aussi un système de droits d'accès en volume et de branchement complètement sauvage aux dossiers des unités.  Pas une option.  La seule option acceptable dans le temps est de restaurer l'état du système et du disque avec les données et tous les droits. <br><br>  Encore une fois googler, forums, KB'shki et encore pleurer Yaroslavna: VMware ESXi ne fournit pas de mécanisme de récupération de données.  Tous les fils de discussion ont deux finales: quelqu'un a récupéré à l'aide de DiskInternals VMFS Recovery pas cher ou quelqu'un qui faisait activement la promotion de leurs services avec l' <i>aide</i> de <i>vmfs-tools</i> et <i>dd</i> aidé.  L'option d'acheter une licence DiskInternals VMFS Recovery pour 700 $ n'est pas une option.  L'admission d'un étranger du «territoire d'un adversaire potentiel» aux données d'entreprise n'est pas non plus une option.  Mais il a été googlé que les partitions VMFS peuvent également lire UFS Explorer. <br><br><h3>  DiskInternals VMFS Recovery </h3><br>  La version d'essai a été téléchargée et installée.  Le programme a vu avec succès une section VMFS vide: <br><br><img src="https://habrastorage.org/webt/yy/pe/po/yypepobhgib-ilpc2lratezxrhc.png" alt="image"><br><br>  En mode <i>Undelete (Fast Scan)</i> , j'ai également trouvé une banque de données minable avec des dossiers de machines virtuelles avec des disques à l'intérieur: <br><br><img src="https://habrastorage.org/webt/jr/y8/sk/jry8skays28vnmrhzl8ot6jpfyu.png"><br><br>  L'aperçu a montré que les fichiers sont en direct: <br><br><img src="https://habrastorage.org/webt/tt/f1/eo/ttf1eoyfh-l0lsyfxcwcazss7dw.png"><br><br>  Le montage de la partition dans le système a réussi, mais pour une raison quelconque, les trois dossiers avaient la même machine virtuelle.  Bien sûr, la loi de la méchanceté n'est pas ce qui est requis. <br><br><div class="spoiler">  <b class="spoiler_title">Trois lignes de honte</b> <div class="spoiler_text">  Une tentative de verrouillage sans vergogne du logiciel s'est soldée par un échec.  Mais UFS Explorer était verrouillé. <br><br><blockquote>  Je suis extrêmement négatif sur le vol de logiciels.  En aucun cas, je ne recommande vivement le contournement de la protection contre une utilisation non autorisée. <br></blockquote><br>  J'étais dans une situation catastrophique et je n'étais pas du tout fier des mesures auxquelles j'avais eu recours. <br></div></div><br><h3>  Explorateur UFS </h3><br>  L'analyse du disque a montré la présence de 7 nœuds.  Le nombre de nœuds d'une «manière étonnante» a coïncidé avec le nombre de fichiers * -flat.vmdk détectés par VMFS Recovery: <br><br><img src="https://habrastorage.org/webt/nc/kh/m0/nckhm0xgc35ajd7hcmt9xbqgz6o.png"><br><br>  La comparaison des tailles de fichiers et des nœuds a également montré une correspondance jusqu'à l'octet.  Dans le même temps, les noms des fichiers * -flat.vmdk et, par conséquent, leur appartenance aux machines virtuelles ont été restaurés. <br><br><img src="https://habrastorage.org/webt/ru/o2/jm/ruo2jmc33trnezku3qnqzt3n1yy.png"><br><br>  En général, du point de vue d'ESXi, les disques vmdk se composent de deux fichiers: un fichier de données (&lt;nom de la machine&gt; -flat.vmdk) et un fichier de partitionnement de disque physique (&lt;nom de la machine&gt; .vmdk).  Si vous téléchargez le fichier * -flat.vmdk de la machine locale vers le magasin de données, ESXi ne le reconnaîtra pas comme un fichier disque valide.  Il y a un article dans la base de connaissances VMware sur la façon de créer manuellement un fichier descripteur de disque: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kb.vmware.com/s/article/1002511</a> , mais ce n'était pas nécessaire, je viens de copier le contenu des fichiers correspondants depuis la zone d'aperçu du contenu du fichier dans DiskInternals VMFS Recovery : <br><br><img src="https://habrastorage.org/webt/wa/ra/m3/waram3hzq42ow0zefbooy1vacqk.png"><br><br>  Après 4 heures de téléchargement d'un nœud de 2,5 To à partir d'UFS Explorer et 20 heures de chargement dans l'hyperviseur Datastore, les fichiers de disque pliés ont été connectés à une machine virtuelle fraîchement créée.  Les roues se sont levées.  Aucune perte de données n'a été constatée. <br><br><img src="https://habrastorage.org/webt/-p/nc/73/-pnc73v0yy5rcpghk4qan_fownw.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452928/">https://habr.com/ru/post/fr452928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452914/index.html">ML sur Scala avec le sourire, pour ceux qui n'ont pas peur de l'expérimentation</a></li>
<li><a href="../fr452916/index.html">Levez-vous et partez. Chirurgie vertébrale: quand faire, ce qui est dangereux</a></li>
<li><a href="../fr452922/index.html">Tables de grille CSS flexibles</a></li>
<li><a href="../fr452924/index.html">Ce que vous devez faire pour empêcher le vol de votre compte Google</a></li>
<li><a href="../fr452926/index.html">Des tests statiques ou sauvez le soldat Ryan</a></li>
<li><a href="../fr452938/index.html">Les pistolets de l'imprimante 3D sont de retour, et maintenant ils ne peuvent plus être arrêtés</a></li>
<li><a href="../fr452942/index.html">GeekBrains organise 12 réunions en ligne gratuites avec des experts en programmation</a></li>
<li><a href="../fr452944/index.html">Quel sera le "Dialogue" des linguistes et des spécialistes de l'analyse des données</a></li>
<li><a href="../fr452946/index.html">Relire la «philosophie de programmation de Windows 95 / NT» de Lou Greenaw</a></li>
<li><a href="../fr452952/index.html">Journée portes ouvertes JetBrains à Saint-Pétersbourg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>