<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜî üßïüèæ üèáüèª Nous restaurons les machines virtuelles √† partir du magasin de donn√©es initialis√© par erreur. L'histoire d'un non-sens avec une fin heureuse üóìÔ∏è üëØ üññüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avertissement: la note est divertissante. La densit√© sp√©cifique d'informations utiles est faible. Il a √©t√© √©crit ¬´pour vous¬ª. 
 Introduction lyrique 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous restaurons les machines virtuelles √† partir du magasin de donn√©es initialis√© par erreur. L'histoire d'un non-sens avec une fin heureuse</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452928/"><blockquote>  <b>Avertissement: la</b> note est divertissante.  La densit√© sp√©cifique d'informations utiles est faible.  Il a √©t√© √©crit ¬´pour vous¬ª. </blockquote><br><h3>  Introduction lyrique </h3><br>  Le vidage de fichiers dans notre organisation tourne sur une machine virtuelle VMware ESXi 6 sous Windows Server 2016. Et ce n'est pas seulement un vidage.  Il s'agit d'un serveur de partage de fichiers entre les divisions structurelles: il existe une collaboration, une documentation de projet et des dossiers provenant de scanners r√©seau.  En g√©n√©ral, c'est toute la dur√©e de vie de la production. <br><br>  Et ce conteneur de toute la vie de production a commenc√© √† pendre.  De plus, l'invit√© pouvait se pendre tranquillement, sans affecter le reste.  Pourrait se bloquer apr√®s lui-m√™me l'h√¥te entier et, par cons√©quent, toutes les autres machines invit√©es.  Je pourrais me bloquer et bloquer les services client vSphere: c'est-√†-dire que les processus des autres invit√©s sont actifs, les machines fonctionnent correctement et r√©pondent, mais il n'y a pas de corruption de fichier et le client vSphere ne s'accroche pas √† l'h√¥te.  En g√©n√©ral, aucun syst√®me n'a pu √™tre identifi√©.  Des blocages peuvent survenir pendant la journ√©e lors d'une faible charge.  Pourrait la nuit pendant z√©ro charge.  Pourrait la nuit pendant la sauvegarde diff√©rentielle et la charge moyenne.  Pourrait le week-end pendant une sauvegarde compl√®te et une charge √©lev√©e.  Et il y a eu une nette d√©gradation de la situation.  Au d√©but, c'√©tait une fois par an, puis une fois tous les six mois.  Au bout de ma patience, deux fois par semaine. <br><a name="habracut"></a><br>  J'ai p√©ch√© pour RAM.  Mais ils ne m'ont pas laiss√© arr√™ter la poubelle m√™me le week-end et chasser Memtest.  Attendu pour les vacances de mai.  Les vacances de mai, j'ai quitt√© Memtest et ... aucune erreur n'a √©t√© trouv√©e. <br><br>  J'√©tais √©tonn√© et j'ai d√©cid√© de partir en vacances.  Pendant mes vacances, la d√©charge n'avait pas un seul coup.  Et quand lundi le premier jour est all√© au travail - la poubelle √©tait suspendue.  Une sauvegarde compl√®te a √©t√© maintenue et, √† la fin, elle a √©t√© suspendue.  Une r√©union si chaleureuse de vacances m'a pouss√© √† la d√©cision de faire physiquement glisser le lecteur invit√© vers un autre h√¥te. <br><br>  Et, bien que l'on sache depuis longtemps que le premier jour apr√®s les vacances, rien de grave ne peut √™tre fait, bien que je me sois mis au travail tout le long du chemin du travail, mon indignation avec le prochain gel a assomm√© mon esprit et mon humeur, et mes v≈ìux ... <br><br>  Les disques physiques ont √©t√© r√©organis√©s vers un autre h√¥te.  Connexion chaude.  Les disques apparaissent dans les param√®tres de stockage de l'onglet <i>Lecteurs</i> .  Sous l'onglet <i>Datastores, le</i> stockage sur ces lecteurs ne l'est pas.  <i>Actualiser</i> - n'appara√Æt pas.  Eh bien, bien s√ªr, la premi√®re impulsion est <i>Add Storage</i> .  L'assistant d'ajout vous indique ce qu'il prend en charge.  Bien s√ªr, il prend √©galement en charge VMFS.  Je n'en doutais pas.  Un aper√ßu rapide des messages de l'assistant √† chaque √©tape: Suivant, Suivant, Suivant, Terminer.  Son regard ne capta m√™me pas un petit cercle jaune avec un point d‚Äôexclamation au bas de la fen√™tre de l‚Äôune des marches du ma√Ætre. <br><br>  √Ä la fin de l'assistant, une nouvelle banque de donn√©es est apparue dans la liste ... et avec elle des banques de donn√©es d'autres disques physiques. <br><br>  Je passe √† la navigation sur le magasin de donn√©es nouvellement ajout√©, et celui-ci est vide.  Bien s√ªr, j'ai encore √©t√© √©tonn√©.  8 heures du matin, les 15 premi√®res minutes de travail apr√®s les vacances, m√™me le sucre dans le caf√© n'a pas encore √©t√© remu√©.  Et voil√†.  Ma premi√®re pens√©e a √©t√© de retirer le mauvais lecteur de l'h√¥te "natif".  J'ai regard√© pour voir si le magasin de donn√©es requis est pr√©sent dans l'h√¥te "natif": non, pas pr√©sent.  La deuxi√®me pens√©e √©tait: "merde # b!".  Pas s√ªr, mais il me semble que la troisi√®me, la quatri√®me et au moins la cinqui√®me pens√©e √©taient les m√™mes. <br><br>  Pour dissiper les doutes, j'ai rapidement install√© un nouvel ESXi sur l'√©chantillon, pris le lecteur de gauche et, apr√®s l'avoir lu, parcouru les √©tapes de l'assistant.  Oui  Lors de l'ajout d'un magasin de donn√©es √† l'aide de l'assistant, toutes les donn√©es sur le disque sont perdues sans la possibilit√© d'annuler l'op√©ration et de restaurer les donn√©es.  Plus tard, j'ai lu sur l'un des forums une √©valuation d'une telle conception par le ma√Ætre: merde merdique.  Et en ce moment, je suis vraiment d'accord. <br><br>  En commen√ßant par le sixi√®me, les pens√©es ont coul√© de mani√®re plus constructive.  D'accord.  L'initialisation prend quelques secondes, m√™me pour un lecteur de 3 To.  Il s'agit donc d'un formatage de haut niveau.  Ainsi, la table de partition a √©t√© simplement r√©√©crite.  Les donn√©es sont donc toujours l√†.  Alors maintenant, recherchons un peu de format et le tour est jou√©. <br><br>  Je charge la voiture depuis l'image de d√©marrage de Strelec ... Et je d√©couvre que les programmes de r√©cup√©ration de partition sont connus de tout le monde sauf VMFS.  Par exemple, ils connaissent la disposition des partitions de Synology, mais VMFS ne le sait pas. <br><br>  √ânum√©rer les programmes n'est pas rassurant: au mieux, GetDataBack et R.Saver trouvent des partitions NTFS avec des structures de r√©pertoires en direct et des noms de fichiers en direct.  Mais cela ne me convient pas.  J'ai besoin de deux fichiers vmdk: avec un disque syst√®me et une poubelle. <br><br>  Et puis je comprends que, semble-t-il, maintenant j'installerai Windows et d√©ploierai la sauvegarde de fichiers.  Et en m√™me temps, je me souviens que j'avais une racine DFS l√†-bas.  Et aussi un syst√®me de droits d'acc√®s en volume et de branchement compl√®tement sauvage aux dossiers des unit√©s.  Pas une option.  La seule option acceptable dans le temps est de restaurer l'√©tat du syst√®me et du disque avec les donn√©es et tous les droits. <br><br>  Encore une fois googler, forums, KB'shki et encore pleurer Yaroslavna: VMware ESXi ne fournit pas de m√©canisme de r√©cup√©ration de donn√©es.  Tous les fils de discussion ont deux finales: quelqu'un a r√©cup√©r√© √† l'aide de DiskInternals VMFS Recovery pas cher ou quelqu'un qui faisait activement la promotion de leurs services avec l' <i>aide</i> de <i>vmfs-tools</i> et <i>dd</i> aid√©.  L'option d'acheter une licence DiskInternals VMFS Recovery pour 700 $ n'est pas une option.  L'admission d'un √©tranger du ¬´territoire d'un adversaire potentiel¬ª aux donn√©es d'entreprise n'est pas non plus une option.  Mais il a √©t√© googl√© que les partitions VMFS peuvent √©galement lire UFS Explorer. <br><br><h3>  DiskInternals VMFS Recovery </h3><br>  La version d'essai a √©t√© t√©l√©charg√©e et install√©e.  Le programme a vu avec succ√®s une section VMFS vide: <br><br><img src="https://habrastorage.org/webt/yy/pe/po/yypepobhgib-ilpc2lratezxrhc.png" alt="image"><br><br>  En mode <i>Undelete (Fast Scan)</i> , j'ai √©galement trouv√© une banque de donn√©es minable avec des dossiers de machines virtuelles avec des disques √† l'int√©rieur: <br><br><img src="https://habrastorage.org/webt/jr/y8/sk/jry8skays28vnmrhzl8ot6jpfyu.png"><br><br>  L'aper√ßu a montr√© que les fichiers sont en direct: <br><br><img src="https://habrastorage.org/webt/tt/f1/eo/ttf1eoyfh-l0lsyfxcwcazss7dw.png"><br><br>  Le montage de la partition dans le syst√®me a r√©ussi, mais pour une raison quelconque, les trois dossiers avaient la m√™me machine virtuelle.  Bien s√ªr, la loi de la m√©chancet√© n'est pas ce qui est requis. <br><br><div class="spoiler">  <b class="spoiler_title">Trois lignes de honte</b> <div class="spoiler_text">  Une tentative de verrouillage sans vergogne du logiciel s'est sold√©e par un √©chec.  Mais UFS Explorer √©tait verrouill√©. <br><br><blockquote>  Je suis extr√™mement n√©gatif sur le vol de logiciels.  En aucun cas, je ne recommande vivement le contournement de la protection contre une utilisation non autoris√©e. <br></blockquote><br>  J'√©tais dans une situation catastrophique et je n'√©tais pas du tout fier des mesures auxquelles j'avais eu recours. <br></div></div><br><h3>  Explorateur UFS </h3><br>  L'analyse du disque a montr√© la pr√©sence de 7 n≈ìuds.  Le nombre de n≈ìuds d'une ¬´mani√®re √©tonnante¬ª a co√Øncid√© avec le nombre de fichiers * -flat.vmdk d√©tect√©s par VMFS Recovery: <br><br><img src="https://habrastorage.org/webt/nc/kh/m0/nckhm0xgc35ajd7hcmt9xbqgz6o.png"><br><br>  La comparaison des tailles de fichiers et des n≈ìuds a √©galement montr√© une correspondance jusqu'√† l'octet.  Dans le m√™me temps, les noms des fichiers * -flat.vmdk et, par cons√©quent, leur appartenance aux machines virtuelles ont √©t√© restaur√©s. <br><br><img src="https://habrastorage.org/webt/ru/o2/jm/ruo2jmc33trnezku3qnqzt3n1yy.png"><br><br>  En g√©n√©ral, du point de vue d'ESXi, les disques vmdk se composent de deux fichiers: un fichier de donn√©es (&lt;nom de la machine&gt; -flat.vmdk) et un fichier de partitionnement de disque physique (&lt;nom de la machine&gt; .vmdk).  Si vous t√©l√©chargez le fichier * -flat.vmdk de la machine locale vers le magasin de donn√©es, ESXi ne le reconna√Ætra pas comme un fichier disque valide.  Il y a un article dans la base de connaissances VMware sur la fa√ßon de cr√©er manuellement un fichier descripteur de disque: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kb.vmware.com/s/article/1002511</a> , mais ce n'√©tait pas n√©cessaire, je viens de copier le contenu des fichiers correspondants depuis la zone d'aper√ßu du contenu du fichier dans DiskInternals VMFS Recovery : <br><br><img src="https://habrastorage.org/webt/wa/ra/m3/waram3hzq42ow0zefbooy1vacqk.png"><br><br>  Apr√®s 4 heures de t√©l√©chargement d'un n≈ìud de 2,5 To √† partir d'UFS Explorer et 20 heures de chargement dans l'hyperviseur Datastore, les fichiers de disque pli√©s ont √©t√© connect√©s √† une machine virtuelle fra√Æchement cr√©√©e.  Les roues se sont lev√©es.  Aucune perte de donn√©es n'a √©t√© constat√©e. <br><br><img src="https://habrastorage.org/webt/-p/nc/73/-pnc73v0yy5rcpghk4qan_fownw.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452928/">https://habr.com/ru/post/fr452928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452914/index.html">ML sur Scala avec le sourire, pour ceux qui n'ont pas peur de l'exp√©rimentation</a></li>
<li><a href="../fr452916/index.html">Levez-vous et partez. Chirurgie vert√©brale: quand faire, ce qui est dangereux</a></li>
<li><a href="../fr452922/index.html">Tables de grille CSS flexibles</a></li>
<li><a href="../fr452924/index.html">Ce que vous devez faire pour emp√™cher le vol de votre compte Google</a></li>
<li><a href="../fr452926/index.html">Des tests statiques ou sauvez le soldat Ryan</a></li>
<li><a href="../fr452938/index.html">Les pistolets de l'imprimante 3D sont de retour, et maintenant ils ne peuvent plus √™tre arr√™t√©s</a></li>
<li><a href="../fr452942/index.html">GeekBrains organise 12 r√©unions en ligne gratuites avec des experts en programmation</a></li>
<li><a href="../fr452944/index.html">Quel sera le "Dialogue" des linguistes et des sp√©cialistes de l'analyse des donn√©es</a></li>
<li><a href="../fr452946/index.html">Relire la ¬´philosophie de programmation de Windows 95 / NT¬ª de Lou Greenaw</a></li>
<li><a href="../fr452952/index.html">Journ√©e portes ouvertes JetBrains √† Saint-P√©tersbourg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>