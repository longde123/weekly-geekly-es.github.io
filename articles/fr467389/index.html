<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚¨ÜÔ∏è üç† üë®üèΩ‚Äçüé® Partage Pinterest: comment nous avons dimensionn√© notre parc MySQL ‚õ≥Ô∏è üóø üê´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Khabrovites! F√©licitations √† tous le jour de la programmation et partagez la traduction de l'article, qui a √©t√© sp√©cialement pr√©par√© pour les √©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Partage Pinterest: comment nous avons dimensionn√© notre parc MySQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/467389/">  <i>Salut, Khabrovites!</i>  <i>F√©licitations √† tous le jour de la programmation et partagez la traduction de l'article, qui a √©t√© sp√©cialement pr√©par√© pour les √©tudiants du cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"High Load Architect"</a> .</i> <br><br><img src="https://habrastorage.org/webt/3o/s-/k6/3os-k6l2f122mbs6d1lufcif6ke.png"><br><br>  <b><i>"Sharding.</i></b>  <b><i>Ou ne pas √©clater.</i></b>  <b><i>Sans essayer. "</i></b> <b><i><br></i></b>  <b><i>- Yoda</i></b> <br><br>  Aujourd'hui, nous allons plonger dans la s√©paration des donn√©es entre plusieurs serveurs MySQL.  Nous avons termin√© le sharding d√©but 2012, et ce syst√®me est toujours utilis√© pour stocker nos donn√©es de base. <a name="habracut"></a><br><br>  Avant de discuter de la fa√ßon de partager des donn√©es, apprenons √† mieux les conna√Ætre.  Installez une belle lumi√®re, obtenez des fraises au chocolat, souvenez-vous des citations de Star Trek ... <br><br>  Pinterest est un moteur de recherche pour tout ce qui vous int√©resse.  En termes de donn√©es, Pinterest est le plus grand graphique des int√©r√™ts humains dans le monde.  Il contient plus de 50 milliards de broches qui ont √©t√© enregistr√©es par les utilisateurs sur plus d'un milliard de cartes.  Les gens gardent des √©pingles pour eux-m√™mes et, comme d'autres √©pingles, s'abonnent √† d'autres √©pingles, tableaux et int√©r√™ts, consultent le flux d'accueil de tous les √©pingles, tableaux et int√©r√™ts auxquels ils sont abonn√©s.  Super!  Rendons-le maintenant √©volutif! <br><br><h3>  Croissance douloureuse </h3><br>  En 2011, nous avons commenc√© √† prendre de l'ampleur.  Selon certaines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">estimations</a> , nous avons progress√© plus rapidement que n'importe quelle startup connue √† l'√©poque.  Vers septembre 2011, chaque composant de notre infrastructure √©tait surcharg√©.  Nous avions plusieurs technologies NoSQL √† notre disposition, et toutes ont √©chou√© de mani√®re catastrophique.  Nous avions √©galement de nombreux esclaves MySQL, que nous avions l'habitude de lire, ce qui provoquait de nombreuses erreurs extraordinaires, en particulier lors de la mise en cache.  Nous avons reconstruit l'ensemble de notre mod√®le de stockage.  Pour travailler efficacement, nous avons soigneusement abord√© le d√©veloppement des exigences. <br><br><h3>  Pr√©requis </h3><br><ul><li>  L'ensemble du syst√®me doit √™tre tr√®s stable, facile √† utiliser et √©voluer de la taille d'une petite bo√Æte √† la taille de la lune √† mesure que le site se d√©veloppe. </li><li>  Tout le contenu g√©n√©r√© par le pinner doit √™tre disponible sur le site √† tout moment. </li><li>  Le syst√®me doit prendre en charge la demande de N broches sur la carte dans un ordre d√©terministe (par exemple, dans l'ordre inverse de l'heure de cr√©ation ou dans l'ordre sp√©cifi√© par l'utilisateur).  Il en va de m√™me pour les broches similaires, leurs broches, etc. </li><li> Par souci de simplicit√©, vous devez vous efforcer d'obtenir des mises √† jour de toutes les mani√®res possibles.  Pour obtenir la coh√©rence n√©cessaire, des jouets suppl√©mentaires, tels qu'un journal des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">transactions</a> distribu√©, seront n√©cessaires.  C'est amusant et (pas trop) facile! </li></ul><br><h3>  Philosophie de l'architecture et des notes </h3><br>  Comme nous voulions que ces donn√©es s'√©tendent sur plusieurs bases de donn√©es, nous ne pouvions pas utiliser uniquement une jointure, des cl√©s √©trang√®res et des index pour collecter toutes les donn√©es, bien qu'elles puissent √™tre utilis√©es pour des sous-requ√™tes qui ne s'√©tendent pas sur la base de donn√©es. <br><br>  Nous devions √©galement maintenir l'√©quilibrage de charge sur les donn√©es.  Nous avons d√©cid√© que le d√©placement de donn√©es, √©l√©ment par √©l√©ment, rendrait le syst√®me inutilement complexe et provoquerait de nombreuses erreurs.  Si nous devions d√©placer des donn√©es, il √©tait pr√©f√©rable de d√©placer le n≈ìud virtuel entier vers un autre n≈ìud physique. <br><br>  Pour que notre impl√©mentation soit rapidement mise en circulation, nous avions besoin de la solution la plus simple et la plus pratique et de n≈ìuds tr√®s stables dans notre plate-forme de donn√©es distribu√©es. <br>  Toutes les donn√©es ont d√ª √™tre r√©pliqu√©es sur la machine esclave pour cr√©er une sauvegarde, avec une haute disponibilit√© et un vidage sur S3 pour MapReduce.  Nous interagissons avec le ma√Ætre uniquement sur la production.  En production, vous ne voudrez pas √©crire ou lire en esclave.  Slave lag, et cela provoque d'√©tranges bugs.  Si le partage est effectu√©, il est inutile d'interagir avec un esclave en production. <br><br>  Enfin, nous avons besoin d'un bon moyen de g√©n√©rer des identificateurs uniques universels (UUID) pour tous nos objets. <br><br><h3>  Comment nous avons fait le sharding </h3><br>  Ce que nous allions cr√©er devait r√©pondre aux exigences, fonctionner de mani√®re stable, en g√©n√©ral, √™tre r√©alisable et maintenable.  C'est pourquoi nous avons choisi la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">technologie</a> MySQL d√©j√† assez mature comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">technologie</a> sous-jacente.  Nous nous m√©fions intentionnellement des nouvelles technologies de mise √† l'√©chelle automatique MongoDB, Cassandra et Membase, car elles √©taient suffisamment √©loign√©es de la maturit√© (et dans notre cas, elles se sont cass√©es de mani√®re impressionnante!). <br><blockquote>  De plus: je recommande toujours les startups pour √©viter de nouvelles choses bizarres - essayez simplement d'utiliser MySQL.  Faites-moi confiance.  Je peux le prouver avec des cicatrices. </blockquote>  MySQL - la technologie est √©prouv√©e, stable et simple - cela fonctionne.  Non seulement nous l'utilisons, mais il est populaire dans d'autres entreprises avec des balances encore plus impressionnantes.  MySQL r√©pond pleinement √† notre besoin de rationaliser les requ√™tes de donn√©es, de s√©lectionner des plages de donn√©es sp√©cifiques et des transactions au niveau des lignes.  En fait, dans son arsenal, il y a beaucoup plus de possibilit√©s, mais nous n'en avons pas tous besoin.  Mais MySQL est une solution ¬´en bo√Æte¬ª, donc les donn√©es ont d√ª √™tre partag√©es.  Voici notre solution: <br>  Nous avons commenc√© avec huit serveurs EC2, une instance de MySQL sur chacun: <br><br><img src="https://habrastorage.org/webt/e0/d0/o0/e0d0o0fijurp6mabuvbwecacnfi.png"><br><br>  Chaque serveur ma√Ætre-ma√Ætre MySQL est r√©pliqu√© sur l'h√¥te de sauvegarde en cas de d√©faillance principale.  Nos serveurs de production lisent ou √©crivent uniquement au ma√Ætre.  Je vous recommande de faire de m√™me.  Cela simplifie consid√©rablement et √©vite les erreurs avec des retards de r√©plication. <br><br>  Chaque entit√© MySQL poss√®de de nombreuses bases de donn√©es: <br><br><img src="https://habrastorage.org/webt/zf/vl/sx/zfvlsxbhhh6uict7kf9ly6f2y9m.png"><br><br>  Notez que chaque base de donn√©es porte un nom unique: db00000, db00001 √† dbNNNNN.  Chaque base de donn√©es est un fragment de nos donn√©es.  Nous avons pris une d√©cision architecturale, sur la base de laquelle seule une partie des donn√©es tombe dans le fragment, et cela ne va jamais au-del√† de ce fragment.  Cependant, vous pouvez obtenir plus de capacit√© en d√©pla√ßant des fragments vers d'autres machines (nous en parlerons plus tard). <br><br>  Nous travaillons avec une table de configuration qui indique quelles machines ont des fragments: <br><br><pre><code class="bash hljs">[{‚Äúrange‚Äù: (0,511), ‚Äúmaster‚Äù: ‚ÄúMySQL001A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL001B‚Äù}, {‚Äúrange‚Äù: (512, 1023), ‚Äúmaster‚Äù: ‚ÄúMySQL002A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL002B‚Äù}, ... {‚Äúrange‚Äù: (3584, 4095), ‚Äúmaster‚Äù: ‚ÄúMySQL008A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL008B‚Äù}]</code> </pre> <br>  Cette configuration ne change que lorsque nous devons d√©placer des fragments ou remplacer l'h√¥te.  Si le <code>master</code> meurt, nous pouvons utiliser l' <code>slave</code> existant, puis en prendre un nouveau.  La configuration se trouve dans <a href="">ZooKeeper</a> et, lorsqu'elle est mise √† jour, est envoy√©e aux services qui desservent le fragment MySQL. <br><br>  Chaque fragment a le m√™me ensemble de tables: <code>pins</code> , <code>boards</code> , <code>users_has_pins</code> , <code>users_likes_pins</code> , <code>pin_liked_by_user</code> , etc.  J'en parlerai un peu plus tard. <br><br>  Comment distribuons-nous les donn√©es pour ces fragments? <br><br>  Nous cr√©ons un ID 64 bits qui contient l'ID du fragment, le type de donn√©es qu'il contient et l'endroit o√π ces donn√©es se trouvent dans la table (ID local).  L'ID de fragment se compose de 16 bits, l'ID de type est de 10 bits et l'ID local de 36 bits.  Les math√©maticiens avanc√©s remarqueront qu'il n'y a que 62 bits.  Mon exp√©rience pass√©e en tant que compilateur et d√©veloppeur de circuits imprim√©s m'a appris que les bits de sauvegarde valent leur pesant d'or.  Donc, nous avons deux de ces bits (mis √† z√©ro). <br><br><pre> <code class="bash hljs">ID = (shard ID &lt;&lt; 46) | (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> ID &lt;&lt; 36) | (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ID&lt;&lt;0)</code> </pre> <br>  Prenons cette √©pingle: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.pinterest.com/pin/241294492511762325/</a> , analysons son ID 241294492511762325: <br><br><pre> <code class="bash hljs">Shard ID = (241294492511762325 &gt;&gt; 46) &amp; 0xFFFF = 3429 Type ID = (241294492511762325 &gt;&gt; 36) &amp; 0x3FF = 1 Local ID = (241294492511762325 &gt;&gt; 0) &amp; 0xFFFFFFFFF = 7075733</code> </pre> <br>  Ainsi, l'objet √©pingle vit dans un √©clat de 3429.  Son type est ¬´1¬ª (c'est-√†-dire ¬´Pin¬ª) et il est en ligne 7075733 dans le tableau des broches.  Par exemple, imaginons que ce fragment se trouve dans MySQL012A.  Nous pouvons y acc√©der comme suit: <br><br><pre> <code class="bash hljs">conn = MySQLdb.connect(host=‚ÄùMySQL012A‚Äù) conn.execute(‚ÄúSELECT data FROM db03429.pins <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> local_id=7075733‚Äù)</code> </pre> <br><br>  Il existe deux types de donn√©es: les objets et les mappages.  Les objets contiennent des parties, telles que des donn√©es de broche. <br><br><h4>  Tables d'objets </h4><br>  Les tables d'objets telles que les broches, les utilisateurs, les tableaux et les commentaires ont un ID (ID local, avec une cl√© primaire augmentant automatiquement) et un blob qui contient JSON avec toutes les donn√©es d'objet. <br><br><pre> <code class="bash hljs">CREATE TABLE pins ( local_id INT PRIMARY KEY AUTO_INCREMENT, data TEXT, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ) ENGINE=InnoDB;</code> </pre> <br>  Par exemple, les objets d'√©pingle ressemblent √† ceci: <br><br><pre> <code class="bash hljs">{‚Äúdetails‚Äù: ‚ÄúNew Star Wars character‚Äù, ‚Äúlink‚Äù: ‚Äúhttp://webpage.com/asdf‚Äù, ‚Äúuser_id‚Äù: 241294629943640797, ‚Äúboard_id‚Äù: 241294561224164665, ‚Ä¶}</code> </pre> <br>  Pour cr√©er une nouvelle √©pingle, nous collectons toutes les donn√©es et cr√©ons un blob JSON.  Ensuite, nous s√©lectionnons l'ID de fragment (nous pr√©f√©rons choisir le m√™me ID de fragment que la carte sur laquelle il est plac√©, mais ce n'est pas n√©cessaire).  Pour le type de broche 1. Nous nous connectons √† cette base de donn√©es et ins√©rons JSON dans la table des broches.  MySQL renverra un ID local automatiquement augment√©.  Nous avons maintenant un fragment, un type et un nouvel identifiant local, nous pouvons donc compiler un identifiant 64 bits complet! <br><br>  Pour √©diter la broche, nous lisons-modifions-√©crivons JSON en utilisant la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">transaction MySQL</a> : <br><br><pre> <code class="bash hljs">&gt; BEGIN &gt; SELECT blob FROM db03429.pins WHERE local_id=7075733 FOR UPDATE [Modify the json blob] &gt; UPDATE db03429.pins SET blob=<span class="hljs-string"><span class="hljs-string">'&lt;modified blob&gt;'</span></span> WHERE local_id=7075733 &gt; COMMIT</code> </pre> <br>  Pour supprimer une √©pingle, vous pouvez supprimer sa ligne dans MySQL.  Cependant, il est pr√©f√©rable d'ajouter le champ <i>¬´actif¬ª</i> dans JSON et de le d√©finir sur <i>¬´faux¬ª</i> , ainsi que de filtrer les r√©sultats c√¥t√© client. <br><br><h4>  Tables de correspondance </h4><br>  La table de mappage relie un objet √† un autre, par exemple une carte avec des broches dessus.  La table MySQL pour les mappages contient trois colonnes: 64 bits pour l'ID "de", 64 bits pour l'ID "o√π" et l'ID de s√©quence.  Dans ce triple (d'o√π, o√π, s√©quence) il y a des cl√©s d'index, et elles sont sur le fragment de l'identifiant "de". <br><br><pre> <code class="bash hljs">CREATE TABLE board_has_pins ( board_id INT, pin_id INT, sequence INT, INDEX(board_id, pin_id, sequence) ) ENGINE=InnoDB;</code> </pre> <br>  Les tables de mappage sont unidirectionnelles, par exemple, comme la table <code>board_has_pins</code> .  Si vous avez besoin de la direction oppos√©e, vous aurez besoin d'une table <code>pin_owned_by_board</code> distincte.  L'ID de s√©quence d√©finit la s√©quence (nos ID ne peuvent pas √™tre compar√©s entre les fragments, car les nouveaux ID locaux sont diff√©rents).  Habituellement, nous ins√©rons de nouvelles broches sur une nouvelle carte avec un ID de s√©quence √©gal au temps dans unix (horodatage unix).  N'importe quel nombre peut √™tre dans la s√©quence, mais le temps unix est un bon moyen de stocker s√©quentiellement de nouveaux mat√©riaux, car cet indicateur augmente de fa√ßon monotone.  Vous pouvez consulter les donn√©es de la table de mappage: <br><br><pre> <code class="bash hljs">SELECT pin_id FROM board_has_pins WHERE board_id=241294561224164665 ORDER BY sequence LIMIT 50 OFFSET 150</code> </pre> <br>  Cela vous donnera plus de 50 pin_id, que vous pouvez ensuite utiliser pour rechercher des objets pin. <br>  Ce que nous venons de faire est une jointure de couche d'application (board_id -&gt; pin_id -&gt; pin objects).  L'une des propri√©t√©s √©tonnantes des connexions au niveau de l'application est que vous pouvez mettre l'image en cache s√©par√©ment de l'objet.  Nous stockons pin_id dans le cache de l'objet pin dans le cluster memcache, mais nous enregistrons board_id dans pin_id dans le cluster redis.  Cela nous permet de choisir la bonne technologie qui convient le mieux √† l'objet mis en cache. <br><br><h3>  Augmenter la capacit√© </h3><br>  Il existe trois fa√ßons principales d'augmenter la capacit√© de notre syst√®me.  Le moyen le plus simple de mettre √† jour la machine (pour augmenter l'espace, mettre des disques durs plus rapides, plus de RAM). <br>  La prochaine fa√ßon d'augmenter la capacit√© est d'ouvrir de nouvelles gammes.  Initialement, nous avons cr√©√© un total de 4096 fragments, malgr√© le fait que l'ID de fragment √©tait compos√© de 16 bits (un total de 64 000 fragments).  De nouveaux objets ne peuvent √™tre cr√©√©s que dans ces premiers fragments 4k.  √Ä un moment donn√©, nous avons d√©cid√© de cr√©er de nouveaux serveurs MySQL avec des fragments de 4096 √† 8191 et avons commenc√© √† les remplir. <br><br>  La derni√®re fa√ßon d'augmenter notre capacit√© est de d√©placer des fragments vers de nouvelles machines.  Si nous voulons augmenter la capacit√© de MySQL001A (avec des fragments de 0 √† 511), nous cr√©ons une nouvelle paire ma√Ætre-ma√Ætre avec les noms maximum possibles suivants (disons MySQL009A et B) et commen√ßons la r√©plication √† partir de MySQL001A. <br><br><img src="https://habrastorage.org/webt/d2/uf/gd/d2ufgd1tttsa6tmxvpywfzgqugs.png"><br><br>  D√®s que la r√©plication est termin√©e, nous changeons notre configuration de sorte que dans MySQL001A il n'y a que des fragments de 0 √† 255, et dans MySQL009A de 256 √† 511. Maintenant, chaque serveur ne doit traiter que la moiti√© des fragments qu'il a trait√©s auparavant. <br><br><img src="https://habrastorage.org/webt/4f/cp/do/4fcpdo2g16molbdkkfbf8xvujbi.png"><br><br><h3>  Quelques fonctionnalit√©s int√©ressantes </h3><br>  Ceux qui avaient d√©j√† des syst√®mes pour g√©n√©rer de nouveaux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UUID</a> comprendront que dans ce syst√®me, nous les obtenons gratuitement!  Lorsque vous cr√©ez un nouvel objet et l'ins√©rez dans la table des objets, il renvoie un nouvel identifiant local.  Cet ID local, combin√© avec l'ID de fragment et l'ID de type, vous donne un UUID. <br><br>  Ceux d'entre vous qui ont effectu√© des ALTER pour ajouter plus de colonnes aux tables MySQL savent qu'ils peuvent fonctionner extr√™mement lentement et devenir un gros probl√®me.  Notre approche ne n√©cessite aucune modification de niveau MySQL.  Sur Pinterest, nous n'avons probablement fait qu'un seul ALTER au cours des trois derni√®res ann√©es.  Pour ajouter de nouveaux champs aux objets, dites simplement √† vos services qu'il existe plusieurs nouveaux champs dans le sch√©ma JSON.  Vous pouvez modifier la valeur par d√©faut afin que lors de la d√©s√©rialisation de JSON d'un objet sans nouveau champ, vous obteniez la valeur par d√©faut.  Si vous avez besoin d'une table de mappage, cr√©ez une nouvelle table de mappage et commencez √† la remplir quand vous le souhaitez.  Et une fois termin√©, vous pouvez envoyer! <br><br><h3>  √âclat de mod </h3><br>  C'est presque comme une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©quipe de mods</a> , mais compl√®tement diff√©rent. <br><br>  Certains objets doivent √™tre trouv√©s sans ID.  Par exemple, si un utilisateur se connecte avec un compte Facebook, nous devons mapper l'ID Facebook √† l'ID Pinterest.  Pour nous, les identifiants Facebook ne sont que des bits, nous les stockons donc dans un syst√®me de partition s√©par√© appel√© mod shard. <br><br>  D'autres exemples incluent les adresses IP, le nom d'utilisateur et l'adresse e-mail. <br>  Mod Shard est tr√®s similaire au syst√®me de partitionnement d√©crit dans la section pr√©c√©dente, √† la seule diff√©rence que vous pouvez rechercher des donn√©es √† l'aide de donn√©es d'entr√©e arbitraires.  Cette entr√©e est hach√©e et modifi√©e en fonction du nombre total de fragments dans le syst√®me.  En cons√©quence, un fragment sera obtenu sur lequel les donn√©es seront ou sont d√©j√† situ√©es.  Par exemple: <br><br><pre> <code class="bash hljs">shard = md5(‚Äú1.2.3.4<span class="hljs-string"><span class="hljs-string">") % 4096</span></span></code> </pre> <br>  Dans ce cas, le fragment sera √©gal √† 1524. Nous traitons le fichier de configuration correspondant √† l'ID de fragment: <br><br><pre> <code class="bash hljs">[{‚Äúrange‚Äù: (0, 511), ‚Äúmaster‚Äù: ‚Äúmsdb001a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb001b‚Äù}, {‚Äúrange‚Äù: (512, 1023), ‚Äúmaster‚Äù: ‚Äúmsdb002a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb002b‚Äù}, {‚Äúrange‚Äù: (1024, 1535), ‚Äúmaster‚Äù: ‚Äúmsdb003a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb003b‚Äù}, ‚Ä¶]</code> </pre> <br>  Ainsi, afin de trouver des donn√©es sur l'adresse IP 1.2.3.4, nous devrons proc√©der comme suit: <br><br><pre> <code class="bash hljs">conn = MySQLdb.connect(host=‚Äùmsdb003a‚Äù) conn.execute(‚ÄúSELECT data FROM msdb001a.ip_data WHERE ip=<span class="hljs-string"><span class="hljs-string">'1.2.3.4'</span></span>‚Äù)</code> </pre> <br>  Vous perdez de bonnes propri√©t√©s de l'ID de fragment, telles que la localit√© spatiale.  Vous devrez commencer par tous les fragments cr√©√©s au tout d√©but et cr√©er la cl√© vous-m√™me (elle ne sera pas g√©n√©r√©e automatiquement).  Il est toujours pr√©f√©rable de repr√©senter les objets sur votre syst√®me avec des ID immuables.  Ainsi, vous n'avez pas besoin de mettre √† jour de nombreux liens lorsque, par exemple, l'utilisateur change son "nom d'utilisateur". <br><br><h3>  Derni√®res pens√©es </h3><br>  Ce syst√®me fonctionne sur Pinterest depuis 3,5 ans et devrait y rester pour toujours.  Son impl√©mentation √©tait relativement simple, mais sa mise en service et le d√©placement de toutes les donn√©es de vieilles machines √©taient difficiles.  Si vous rencontrez un probl√®me lorsque vous venez de cr√©er un nouveau fragment, envisagez de cr√©er un cluster de machines de traitement de donn√©es en arri√®re-plan (astuce: utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pyres</a> ) pour d√©placer vos donn√©es avec des scripts d'anciennes bases de donn√©es vers votre nouveau fragment.  Je garantis qu'une partie des donn√©es sera perdue, peu importe vos efforts (ce sont tous des gremlins, je le jure), alors r√©p√©tez le transfert de donn√©es encore et encore jusqu'√† ce que la quantit√© de nouvelles informations dans le fragment devienne tr√®s petite ou pas du tout. <br><br>  Tous les efforts ont √©t√© faits pour ce syst√®me.  Mais il n'apporte en aucune fa√ßon atomicit√©, isolement ou coh√©rence.  Ouah!  √áa sonne mal!  Mais ne vous inqui√©tez pas.  Vous vous sentirez s√ªrement excellent sans eux.  Vous pouvez toujours construire ces couches avec d'autres processus / syst√®mes, si n√©cessaire, mais par d√©faut et sans frais, vous obtenez d√©j√† beaucoup: la capacit√© de travail.  Fiabilit√© obtenue gr√¢ce √† la simplicit√© et fonctionne m√™me rapidement! <br><br>  Mais qu'en est-il de la tol√©rance aux pannes?  Nous avons cr√©√© un service de maintenance des fragments MySQL, enregistr√© la table de configuration des fragments dans ZooKeeper.  Lorsque le serveur ma√Ætre tombe en panne, nous √©levons la machine esclave puis relevons la machine qui la remplacera (toujours √† jour).  √Ä ce jour, nous n'utilisons pas de traitement automatique des pannes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467389/">https://habr.com/ru/post/fr467389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467377/index.html">Trois d'affil√©e: les 10 meilleurs rapports de Mobius 2019 Piter</a></li>
<li><a href="../fr467381/index.html">LED √† plusieurs √©tages, lumi√®res intelligentes et ampoules pour 18 roubles</a></li>
<li><a href="../fr467383/index.html">¬´Le manager doit continuer √† coder¬ª: entretien avec Stephen Chin</a></li>
<li><a href="../fr467385/index.html">Une s√©lection de questions techniques psychologiques et atypiques issues d'entretiens avec des d√©veloppeurs Java</a></li>
<li><a href="../fr467387/index.html">Solutions pour travailler avec le feedback et l'exp√©rience client: des petits services aux plateformes lourdes</a></li>
<li><a href="../fr467391/index.html">Yandex pr√©sente RPKI</a></li>
<li><a href="../fr467393/index.html">NX Bootcamp d√©marre en octobre</a></li>
<li><a href="../fr467395/index.html">Habr Weekly # 18 / Nouveaux gadgets Apple, un smartphone enti√®rement modulaire, le village des programmeurs en Bi√©lorussie, le ph√©nom√®ne XY</a></li>
<li><a href="../fr467399/index.html">Vous ne pouvez pas interdire d'apporter: comment mettre en ≈ìuvre le concept BYOD et ne pas nuire √† la s√©curit√© des informations</a></li>
<li><a href="../fr467401/index.html">Comparaison de Tesla Model S et Porsche Taycan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>