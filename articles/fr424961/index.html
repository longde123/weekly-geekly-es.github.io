<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚öïÔ∏è üëçüèº ‚ôüÔ∏è MTA-STS pour Postfix üòõ üñçÔ∏è üôèüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MTA-STS est la norme RFC8461 propos√©e qui est sortie du statut provisoire et publi√©e officiellement le 26 septembre 2018. Cette norme offre un m√©canis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MTA-STS pour Postfix</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424961/">  MTA-STS est la norme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RFC8461</a> propos√©e qui est sortie du statut provisoire et publi√©e officiellement le 26 septembre 2018.  Cette norme offre un m√©canisme pour d√©tecter la possibilit√© d'utiliser TLS complet entre les serveurs de messagerie, avec cryptage des donn√©es et authentification du serveur.  Autrement dit, cette norme prot√®ge presque compl√®tement contre les interf√©rences avec le trafic de messagerie entre les serveurs. <br><br>  Simplifi√©, l'essence de la norme est la suivante: <br><br><ol><li>  Les services de messagerie pris en charge publient une strat√©gie (1 enregistrement TXT et 1 ressource HTTPS pour chaque domaine). </li><li>  Les services de messagerie lors de l'envoi de courrier vers d'autres domaines d√©tectent la strat√©gie de domaine du destinataire. </li><li>  Les services de messagerie se connectent au serveur de messagerie du domaine destinataire, en appliquant, le cas √©ch√©ant, les restrictions TLS d√©finies par la strat√©gie d√©tect√©e. </li></ol><br>  Il existe de bons articles ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">par exemple</a> ) qui parlent de la norme elle-m√™me et pourquoi elle est n√©cessaire, comparant MTA-STS avec d'autres initiatives similaires, et montrant m√™me comment √©crire et publier une politique.  Mais trouver comment d√©passer la premi√®re √©tape n'√©tait pas si simple. <a name="habracut"></a><br><br><h3>  Recommencer </h3><br>  Avant d'impl√©menter MTA-STS, vous devez nettoyer les certificats du serveur de messagerie.  Sinon, les serveurs de messagerie qui prennent en compte votre politique STS rejetteront la connexion √† votre serveur.  Les conditions suivantes doivent √™tre remplies: <br><br><ul><li>  Le certificat de serveur est d√©livr√© par une autorit√© de certification reconnue (Let's Encrypt est bon). </li><li>  La cha√Æne de certificats envoy√©e par le serveur comprend tous les certificats n√©cessaires des autorit√©s de certification interm√©diaires. </li><li>  Le certificat a un champ Subject Alternative Name avec le nom DNS de votre serveur MX. </li></ul><br>  Vous pouvez v√©rifier le serveur configur√© avec le certificat avec la commande suivante: <br><br><pre><code class="bash hljs">[ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(LANG=C openssl s_client -connect MX.EXAMPLE.COM:25 -starttls smtp -verify_hostname MX.EXAMPLE.COM &lt; /dev/null 2&gt;&amp;1 | fgrep 'error')</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> ] &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OK || <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> FAIL</code> </pre> <br>  o√π MX.EXAMPLE.COM est le nom de domaine de votre serveur MX.  Pour une conformit√© totale avec la norme, il est conseill√© de v√©rifier que le nom de domaine souhait√© est pr√©sent non seulement dans le nom commun du certificat, mais au moins dans le nom alternatif du sujet. <br><br><h3>  Publication de politique </h3><br>  Afin de d√©signer votre domaine comme prenant en charge une connexion s√©curis√©e avec lui, vous devez publier la politique MTA-STS.  Pour ce faire, effectuez les √©tapes simples suivantes dans l'ordre sp√©cifi√© (des exemples sont donn√©s pour le domaine example.com). <br><br>  1. Placer √† <br><br><pre>  https://mta-sts.example.com/.well-known/mta-sts.txt </pre><br>  fichier texte du formulaire: <br><br><pre> version: STSv1
 mode: appliquer
 mx: mail.example.com
 mx: * .example.net
 mx: backupmx.example.com
 max_age: 604800
</pre><br>  Le fichier doit √™tre fourni avec Content-Type: text / plain.  Les redirections ne sont pas autoris√©es.  Les sauts de ligne doivent √™tre LF ou CRLF.  Les lignes vides ne sont pas autoris√©es.  La derni√®re ligne peut se terminer par un saut de ligne, ou elle ne peut pas se terminer par elle - les deux options sont autoris√©es.  L'espace vide avant les deux points et au d√©but de la ligne n'est pas autoris√©.  L'espace vide apr√®s les deux points est autoris√© en n'importe quelle quantit√©.  Les espaces blancs (espaces, tabulations, etc.) √† la fin de chaque ligne sont ignor√©s. <br><br>  Valeurs de champ: <br><br>  <b>version</b> : format version.  Il doit toujours √™tre √©gal √† "STSv1". <br>  <b>mode</b> : <b>mode</b> politique.  Options possibles: aucune, test, appliquer.  Le mode d'application correspond au fonctionnement normal de la norme - exiger le certificat correct et une connexion TLS stable lors de la connexion au serveur.  Le mode de test vous oblige √† essayer d'utiliser une connexion s√©curis√©e, mais en cas d'erreur, envoyez un courrier √©lectronique avec une notification d'administrateur via le m√©canisme TLSRPT.  Aucun mode correspond √† la situation comme si la politique n'√©tait pas publi√©e du tout.  Ce mode est utile pour d√©sactiver correctement une strat√©gie. <br>  <b>mx</b> : un ou plusieurs champs contenant les noms de tous les serveurs de domaine MX autoris√©s.  Comme vous pouvez le voir dans l'exemple, les mod√®les sont autoris√©s, mais uniquement en tant que domaine de niveau inf√©rieur. <br>  <b>max_age</b> : <b>dur√©e</b> en secondes pendant laquelle la politique peut √™tre mise en cache et pendant laquelle les exp√©diteurs peuvent continuer √† l'utiliser si la politique n'est plus disponible.  En raison de cette fonctionnalit√© de la norme, la d√©sactivation de STS est plus rapide en publiant une nouvelle strat√©gie sans mode. <br><br>  2. Cr√©ez un enregistrement TXT _mta-sts.example.com avec le contenu du formulaire: <br><br><pre>  v = STSv1;  id = 20160831085700Z; </pre><br>  Les espaces autour d'un point-virgule peuvent √™tre arbitrairement dispos√©s en n'importe quelle quantit√©.  Dans d'autres endroits, les espaces blancs ne sont pas autoris√©s.  Le dernier point-virgule peut √™tre pr√©sent ou absent. <br><br>  Valeurs de champ: <br><br>  <b>v</b> : format de version.  Il doit toujours √™tre le premier champ, il doit toujours √™tre √©gal √† STSv1. <br>  <b>id</b> : identifiant unique de la politique publi√©e.  Il peut s'agir d'une cha√Æne de 1 √† 32 caract√®res, compos√©e de lettres de registres et de chiffres.  La modification de la valeur de l'ID indique aux exp√©diteurs que la strat√©gie a √©t√© mise √† jour.  Par cons√©quent, vous devez mettre √† jour la strat√©gie en publiant d'abord un nouveau fichier de strat√©gie, puis en changeant l'ID dans l'enregistrement TXT. <br><br>  D√©sormais, les serveurs de messagerie qui prennent en charge MTA-STS n'enverront que du courrier √† votre domaine via une connexion s√©curis√©e authentifi√©e par certificat.  C‚Äôest l√† que se terminent la plupart des manuels, mais la partie la plus int√©ressante √† venir est d‚Äôobtenir la politique MTA-STS depuis votre propre serveur lors de l‚Äôenvoi de courrier. <br><br><h3>  Le plus int√©ressant </h3><br>  La principale difficult√© est que cette norme n'est pas prise en charge par les serveurs de messagerie, y compris Postfix.  Cependant, cette bagatelle d√©sagr√©able ne devrait pas nous arr√™ter. <br><br>  Trouver une solution m'a amen√© aux archives de la liste de diffusion des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilisateurs de postfix</a> discutant du timing de cette norme.  Dans un article, Witsa Venema, auteur de Postfix, indique la direction pr√©f√©r√©e pour impl√©menter cette fonctionnalit√© - utiliser un serveur externe pour rechercher des politiques TLS.  Il est propos√© d'utiliser la directive de configuration du formulaire: <br><br><pre>  smtp_policy_maps = socketmap: inet: h√¥te: port: nom </pre><br>  J'ai impl√©ment√© un tel serveur pour obtenir la politique MTA-STS. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code source</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Package en PyPI</a> <br><br>  Il manque √† l'application certaines des fonctions prescrites par la RFC8461, telles que: r√©cup√©ration proactive des politiques, rapports et limitation de la fr√©quence des demandes de politique.  Cependant, la fonction principale - d√©tecter la politique TLS et la mettre en cache - elle fonctionne. <br><br>  L'application n√©cessite Python 3.5.3+.  L'installation et la configuration de ce d√©mon peuvent √™tre effectu√©es √† l'aide des √©tapes suivantes. <br><br><h4>  Installation du package </h4><br>  Il suffit d'ex√©cuter la commande: <br><br><pre> <code class="bash hljs">pip3 install postfix-mta-sts-resolver</code> </pre> <br>  Des m√©thodes d'installation alternatives sont √©crites <a href="">ici</a> . <br><br><h4>  Cr√©ation d'un fichier de configuration </h4><br>  Si vous √™tes satisfait des param√®tres par d√©faut, la commande suffit <br><br><pre> <code class="bash hljs">touch /etc/postfix/mta-sts-daemon.yml</code> </pre> <br>  Sinon, la configuration peut √™tre tir√©e de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple</a> et adapt√©e √† vos besoins. <br><br>  Le param√®tre le plus important, √† mon avis, est le param√®tre strict_testing.  S'il est d√©fini sur true (false par d√©faut), l'application renvoie une strat√©gie s√©curis√©e m√™me pour les domaines avec une strat√©gie en mode test.  Ce comportement est contraire √† la norme, mais il est conseill√© pour des raisons pratiques: si le propri√©taire du domaine a publi√© la politique STS m√™me en mode test, il est probablement pr√™t pour cela.  C'est-√†-dire qu'aujourd'hui, le courrier gmail.com sera envoy√© via une connexion fiable. <br><br><h4>  Organisation de d√©marrage </h4><br>  Dans le cas de systemd, il suffit de placer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">simple fichier d'unit√©</a> dans /etc/systemd/system/mta-sts-daemon.service <br><br>  Apr√®s cela, il reste √† relire la configuration de systemd, activer l'ex√©cution automatique du d√©mon et le d√©marrer: <br><br><pre> <code class="bash hljs">systemctl daemon-reload systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mta-sts-daemon.service systemctl start mta-sts-daemon.service</code> </pre> <br><h4>  Bilan de sant√© </h4><br>  En supposant que le port par d√©faut est utilis√©, la commande <br><br><pre> <code class="bash hljs">/usr/sbin/postmap -q dismail.de socketmap:inet:127.0.0.1:8461:postfix</code> </pre> <br>  devrait apporter <br><br><pre>  correspondance s√©curis√©e = mx1.dismail.de </pre><br><h4>  Connectez-vous √† Postfix </h4><br>  Ajoutez une ligne √† main.cf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">smtp_policy_maps</span></span> = socketmap:inet:<span class="hljs-number"><span class="hljs-number">127.0.0.1:8461</span></span>:postfix</code> </pre> <br>  Red√©marrez Postfix: <br><br><pre> <code class="bash hljs">systemctl reload postfix.service</code> </pre> <br>  Si tout est fait correctement, alors pour les connexions STS dans le journal /var/log/mail.info √† la place <br><br><pre>  Connexion TLS s√©curis√©e √©tablie </pre><br>  les enregistrements commencent √† appara√Ætre <br><br><pre>  Connexion TLS v√©rifi√©e √©tablie </pre><br><br><h3>  Conclusion </h3><br>  Si vous arrivez √† cet endroit, cela signifie tr√®s probablement: <br><br><ul><li>  Vous lisez l'article sans une seule image. </li><li>  De jour en jour, la probabilit√© d'interception de courrier dans votre domaine diminuera, car d'autres services de messagerie impl√©menteront la nouvelle norme. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424961/">https://habr.com/ru/post/fr424961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424947/index.html">Reconnaissance des gestes avec APDS-9960</a></li>
<li><a href="../fr424949/index.html">PHP Digest n ¬∞ 140 (17-30 septembre 2018)</a></li>
<li><a href="../fr424951/index.html">Hourra! Ce n'√©tait pas de la parano√Øa</a></li>
<li><a href="../fr424955/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 332 (24-30 septembre 2018)</a></li>
<li><a href="../fr424957/index.html">G√©n√©ration d'images √† partir de texte √† l'aide d'AttnGAN</a></li>
<li><a href="../fr424963/index.html">Financement Zuckerberg: cr√©er ensemble des outils pour la science</a></li>
<li><a href="../fr424965/index.html">D√©veloppement d'applications React √† l'aide de ReasonReact</a></li>
<li><a href="../fr424967/index.html">Raccourcis JavaScript pour les d√©butants</a></li>
<li><a href="../fr424969/index.html">Guide Node.js, partie 9: Utilisation du syst√®me de fichiers</a></li>
<li><a href="../fr424971/index.html">Habrokast "Sunset Manually" # 1. Essayer de mettre en place un environnement pour d√©velopper un jouet pour Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>