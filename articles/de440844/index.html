<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍❤️‍💋‍👨 🕣 👨🏾‍💼 Google Drive als Speicher für eine Webanwendung 🔽 🤟🏼 👩‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vorwort 
 Meine Webanwendung speichert Daten in localStorage . Dies war praktisch, bis ich wollte, dass der Benutzer beim Zugriff auf die Site von ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Google Drive als Speicher für eine Webanwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440844/"><h1>  Vorwort </h1><br>  Meine Webanwendung speichert Daten in <code>localStorage</code> .  Dies war praktisch, bis ich wollte, dass der Benutzer beim Zugriff auf die Site von verschiedenen Geräten aus dasselbe sieht.  Das heißt, Remote-Speicher war erforderlich. <br><br>  Die Anwendung wird jedoch auf GitHub-Seiten "gehostet" und hat keinen Serverteil.  Ich habe beschlossen, keinen Server zu erstellen, sondern die Daten bei einem Dritten zu speichern.  Dies bietet erhebliche Vorteile: <br><br><ol><li>  Der Server muss nicht bezahlt werden, er schadet dem Kopf in Bezug auf Stabilität und Verfügbarkeit nicht. </li><li>  Weniger Code, weniger Fehler. </li><li>  Der Benutzer muss sich nicht in meiner Anwendung registrieren (dies ist für viele ärgerlich). </li><li>  Der Datenschutz ist höher und der Benutzer weiß, dass seine Daten an einem Ort gespeichert sind, dem er höchstwahrscheinlich mehr vertraut als mir. </li></ol><br>  Erstens fiel die Wahl auf <a href="">remoteStorage.js</a> .  Sie bieten ein offenes Datenaustauschprotokoll, eine hübsche API, die Möglichkeit zur Integration in Google Drive und Dropbox sowie deren Server.  Aber dieser Weg stellte sich als Sackgasse heraus (warum - eine separate Geschichte). <br><br>  Am Ende habe ich mich entschieden, Google Drive direkt und die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google API Client Library</a> (im Folgenden GAPI) als Bibliothek für den Zugriff darauf zu verwenden. <br><br>  Leider ist die Google-Dokumentation enttäuschend und die GAPI-Bibliothek sieht unvollendet aus. Außerdem hat sie mehrere Versionen und es ist nicht immer klar, um welche es sich handelt.  Daher musste die Lösung für meine Probleme in Teilen aus der Dokumentation, Fragen und Antworten zu StackOverflow und zufälligen Beiträgen im Internet gesammelt werden. <br><br>  Ich hoffe, dieser Artikel spart Ihnen Zeit, wenn Sie Google Drive in Ihrer Anwendung verwenden. <br><a name="habracut"></a><br><h1>  Vorbereitung </h1><br>  Im Folgenden wird beschrieben, wie Sie Schlüssel für die Arbeit mit der Google-API erhalten.  Wenn Sie nicht interessiert sind, fahren Sie direkt mit dem nächsten Teil fort. <br><br><div class="spoiler">  <b class="spoiler_title">Schlüssel empfangen</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen Sie</a> in der Google Developer Console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein</a> neues Projekt und geben Sie einen Namen ein. <br><br>  Klicken Sie in der Systemsteuerung auf "API und Dienste aktivieren" und aktivieren Sie Google Drive. <br><br>  Gehen Sie als Nächstes zum Abschnitt API und Dienste -&gt; Anmeldeinformationen und klicken Sie auf "Anmeldeinformationen erstellen".  Es gibt drei Dinge, die Sie tun müssen: <br><br><ol><li>  Konfigurieren Sie "OAuth Access Request Window".  Geben Sie den Namen der Anwendung, Ihre Domain im Abschnitt "Autorisierte Domains" und einen Link zur Hauptseite der Anwendung ein.  Andere Felder sind optional. <br></li><li>  Klicken Sie im Abschnitt "Anmeldeinformationen" auf "Anmeldeinformationen erstellen" -&gt; "OAuth-Client-ID".  Wählen Sie den Typ "Webanwendung".  Fügen Sie im Einstellungsfenster "Zulässige Javascript-Quellen" und "Zulässige Umleitungs-URIs" hinzu: <br><ul><li>  Ihre Domain (erforderlich) <br></li><li>  <code>http://localhost:8000</code> (optional, um lokal zu arbeiten). <br></li></ul><br><img src="https://habrastorage.org/webt/gg/rv/hc/ggrvhc5j0yclrw6brc5ij0uaape.png"><br></li><li>  Klicken Sie im Abschnitt "Anmeldeinformationen" auf "Anmeldeinformationen erstellen" -&gt; "API-Schlüssel".  Geben Sie in den Schlüsseleinstellungen die Einschränkungen an: <br><ul><li>  Zulässiger Anwendungstyp -&gt; HTTP-Verweise (Websites) <br></li><li>  Akzeptieren Sie http-Anfragen von den folgenden Verweisquellen (Sites) -&gt; Ihrer Domain und Ihrem lokalen Host (wie in Punkt 2). <br></li><li>  Gültige APIs -&gt; Google Drive API <br></li></ul><br><img src="https://habrastorage.org/webt/rj/uo/26/rjuo26cmoytw5p9up_xcbrpy270.png"><br></li></ol><br>  Der Abschnitt Anmeldeinformationen sollte ungefähr so ​​aussehen: <br><br><img src="https://habrastorage.org/webt/fa/9i/he/fa9ihekdcod48ffftoavoyhejbe.png"><br><br>  Hier sind wir fertig.  Wir gehen zum Code über. <br></div></div><br><h1>  Initialisierung und Login </h1><br>  Die von Google empfohlene Methode zum Aktivieren von GAPI besteht darin, den folgenden Code in Ihren HTML-Code einzufügen: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://apis.google.com/js/api.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"this.onload=function(){}; gapi.load('client:auth2', initClient)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onreadystatechange</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"if (this.readyState === 'complete') this.onload()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Nach dem Laden der Bibliothek wird die <code>initClient</code> Funktion aufgerufen, die wir selbst schreiben müssen.  Sein typisches Aussehen ist wie folgt: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gapi.client.init({ <span class="hljs-comment"><span class="hljs-comment">//   API apiKey: GOOGLE_API_KEY, //    clientId: GOOGLE_CLIENT_ID, // ,     Google Drive API v3 discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'], //    application data folder (. ) scope: 'https://www.googleapis.com/auth/drive.appfolder' }).then(() =&gt; { //    / (. ) gapi.auth2.getAuthInstance().isSignedIn.listen(onSignIn) //   initApp() }, error =&gt; { console.log('Failed to init GAPI client', error) //    initApp({showAlert: 'google-init-failed-alert'}) }) }</span></span></code> </pre> <br>  Zur Datenspeicherung verwenden wir den sogenannten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Application Data Ordner</a> .  Seine Vorteile gegenüber einem normalen Ordner: <br><br><ol><li>  Der Benutzer sieht es nicht direkt: Dateien daraus verstopfen seinen persönlichen Bereich nicht und er kann unsere Daten nicht ruinieren. </li><li>  Andere Anwendungen sehen es nicht und können es auch nicht verderben. </li><li>  Der oben erwähnte Bereich gewährt der Anwendung Zugriff darauf, jedoch keinen Zugriff auf die übrigen Dateien des Benutzers.  Das heißt, wir werden eine Person nicht durch Anfragen nach Zugang zu ihren persönlichen Daten abschrecken. </li></ol><br>  Nach erfolgreicher Initialisierung der Google-API führt die Funktion Folgendes aus: <br><br><ol><li>  Fängt an, Anmelde- / Abmeldeereignisse abzufangen - dies sollte höchstwahrscheinlich immer erfolgen. </li><li>  Initialisiert die Anwendung.  Dies kann vor dem Laden und Initialisieren von GAPI erfolgen - wie Sie es bevorzugen.  Mein Initialisierungsverfahren war etwas anders, wenn Google nicht verfügbar ist.  Jemand könnte sagen, dass dies nicht der Fall ist :) Aber erstens können Sie in Zukunft mit Schlüsseln und Zugriffsrechten klug sein.  Zweitens ist Google beispielsweise in China verboten. </li></ol><br>  Das An- und Abmelden erfolgt einfach: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isGapiLoaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gapi &amp;&amp; gapi.auth2 } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isGapiLoaded()) { <span class="hljs-comment"><span class="hljs-comment">//    Google    gapi.auth2.getAuthInstance().signIn() } } function logOut() { if (isGapiLoaded()) { gapi.auth2.getAuthInstance().signOut() } }</span></span></code> </pre> <br>  Sie erhalten <code>onSignIn</code> im <code>onSignIn</code> Handler: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLoggedIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isGapiLoaded() &amp;&amp; gapi.auth2.getAuthInstance().isSignedIn.get() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSignIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLoggedIn()) { <span class="hljs-comment"><span class="hljs-comment">//   } else { //   } //   .    "" }</span></span></code> </pre> <br>  Leider ist die Arbeit mit Dateien nicht so offensichtlich. <br><br><h1>  Versprich Helfer </h1><br>  GAPI gibt keine normalen Versprechen zurück.  Stattdessen wird eine eigene Thennable-Schnittstelle verwendet, die Versprechungen ähnelt, aber nicht ganz.  Aus praktischen <code>async/await</code> (hauptsächlich zur Verwendung von <code>async/await</code> ) werden wir daher einen kleinen Helfer erstellen: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gapiCall, argObj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { gapiCall(argObj).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resp</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resp &amp;&amp; (resp.status &lt; <span class="hljs-number"><span class="hljs-number">200</span></span> || resp.status &gt; <span class="hljs-number"><span class="hljs-number">299</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'GAPI call returned bad status'</span></span>, resp) reject(resp) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resolve(resp) } }, err =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'GAPI call failed'</span></span>, err) reject(err) }) }) }</code> </pre> <br>  Diese Funktion verwendet die GAPI-Methode und die Parameter als erstes Argument und gibt Promise zurück.  Dann werden Sie sehen, wie man es benutzt. <br><br><h1>  Mit Dateien arbeiten </h1><br>  Sie sollten immer daran denken, dass <b>der Dateiname in Google Drive nicht eindeutig ist</b> .  Sie können beliebig viele Dateien und Ordner mit demselben Namen erstellen.  Nur die Kennung ist eindeutig. <br><blockquote>  Für grundlegende Aufgaben müssen Sie nicht mit Ordnern arbeiten, daher funktionieren alle folgenden Funktionen mit Dateien im Stammverzeichnis des Ordners Anwendungsdaten.  Die Kommentare geben an, was geändert werden muss, um mit Ordnern zu arbeiten.  Die Dokumentation von Google finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </blockquote><h2>  Erstellen Sie eine leere Datei </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEmptyFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, mimeType</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resp = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.create, { <span class="hljs-attr"><span class="hljs-attr">resource</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: name, <span class="hljs-comment"><span class="hljs-comment">//     // mimeType = 'application/vnd.google-apps.folder' mimeType: mimeType || 'text/plain', //  'appDataFolder'   ID  parents: ['appDataFolder'] }, fields: 'id' }) //    —    return resp.result.id }</span></span></code> </pre> <br>  Diese asynchrone Funktion erstellt eine leere Datei und gibt ihren Bezeichner (String) zurück.  Wenn eine solche Datei bereits vorhanden ist, wird eine neue Datei mit demselben Namen erstellt und ihre ID zurückgegeben.  Wenn Sie dies nicht möchten, müssen Sie zunächst überprüfen, ob keine Datei mit demselben Namen vorhanden ist (siehe unten). <br><blockquote>  Google Drive ist keine vollständige Datenbank.  Wenn Sie beispielsweise möchten, dass mehrere Nutzer <b>gleichzeitig</b> von verschiedenen Geräten aus mit demselben Google-Konto arbeiten, kann es aufgrund fehlender Transaktionen zu Problemen bei der Lösung von Konflikten kommen.  Für solche Aufgaben ist es besser, Google Drive nicht zu verwenden. </blockquote><h2>  Arbeiten Sie mit Dateiinhalten </h2><br>  GAPI (für browserbasiertes JavaScript) bietet keine Methoden zum Arbeiten mit dem Inhalt von Dateien (sehr seltsam, nicht wahr?).  Stattdessen gibt es eine allgemeine <code>request</code> (einen Thin Wrapper über eine einfache AJAX-Anforderung). <br><br>  Durch Versuch und Irrtum bin ich zu folgenden Implementierungen gekommen: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileId, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,  ,     JSON return prom(gapi.client.request, { path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: {uploadType: 'media'}, body: typeof content === 'string' ? content : JSON.stringify(content) }) } async function download(fileId) { const resp = await prom(gapi.client.drive.files.get, { fileId: fileId, alt: 'media' }) // resp.body      // resp.result —    resp.body  JSON. //   ,  resp.result  false // ..    ,   return resp.result || resp.body }</span></span></code> </pre><br><h2>  Dateisuche </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">query</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ret = [] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> token <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resp = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.list, { <span class="hljs-comment"><span class="hljs-comment">//  'appDataFolder'   ID  spaces: 'appDataFolder', fields: 'files(id, name), nextPageToken', pageSize: 100, pageToken: token, orderBy: 'createdTime', q: query }) ret = ret.concat(resp.result.files) token = resp.result.nextPageToken } while (token) // :    [{id: '...', name: '...'}], //     return ret }</span></span></code> </pre> <br>  Wenn Sie keine <code>query</code> angeben, gibt diese Funktion alle Dateien im Anwendungsordner (ein Array von Objekten mit <code>id</code> und Namensfeldern) sortiert nach Erstellungszeit zurück. <br><br>  Wenn Sie die <code>query</code> angeben (die Syntax wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> beschrieben), werden nur Dateien zurückgegeben, die der Abfrage entsprechen.  Um beispielsweise zu überprüfen, ob eine Datei mit dem Namen <code>config.json</code> , müssen Sie dies tun <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> find(<span class="hljs-string"><span class="hljs-string">'name = "config.json"'</span></span>)).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ()  }</span></span></code> </pre><br><h2>  Dateien löschen </h2><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileId</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> prom(gapi.client.drive.files.delete, { <span class="hljs-attr"><span class="hljs-attr">fileId</span></span>: fileId }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err.status === <span class="hljs-number"><span class="hljs-number">404</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err } }</code> </pre> <br>  Diese Funktion löscht die Datei nach ID und gibt <code>true</code> zurück <code>true</code> wenn sie erfolgreich gelöscht wurde, und <code>false</code> wenn keine solche Datei vorhanden war. <br><br><h1>  Synchronisieren </h1><br>  Es wird empfohlen, dass das Programm hauptsächlich mit <code>localStorage</code> arbeitet und Google Drive nur zum Synchronisieren von Daten aus <code>localStorage</code> . <br><br>  Das Folgende ist eine einfache Konfigurationssynchronisationsstrategie: <br><br><ol><li>  Die neue Konfiguration wird mit einem Login von Google Drive heruntergeladen und anschließend alle 3 Minuten die lokale Kopie überschrieben. </li><li>  Lokale Änderungen werden auf Google Drive übertragen und überschreiben, was dort vorhanden war. </li><li>  Die Konfigurationsdatei- <code>fileID</code> wird in <code>localStorage</code> zwischengespeichert, um die Arbeit zu beschleunigen und die Anzahl der Anforderungen zu verringern. </li><li>  Richtig gehandhabte (fehlerhafte) Situationen sind, wenn Google Drive über mehrere Konfigurationsdateien verfügt und jemand unsere Konfigurationsdatei gelöscht oder ruiniert hat. </li><li>  Synchronisierungsdetails wirken sich nicht auf den Rest des Anwendungscodes aus.  Um mit der Konfiguration zu arbeiten, verwenden Sie nur zwei Funktionen: <code>getConfig()</code> und <code>saveConfig(newConfig)</code> . </li></ol><br>  In einer realen Anwendung möchten Sie wahrscheinlich eine flexiblere Konfliktbehandlung beim Laden / Entladen einer Konfiguration implementieren. <br><br><div class="spoiler">  <b class="spoiler_title">Code anzeigen</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     const SYNC_PERIOD = 1000 * 60 * 3 // 3  //    const DEFAULT_CONFIG = { // ... } //  ID  ,      let configSyncTimeoutId async function getConfigFileId() { //  configFileId let configFileId = localStorage.getItem('configFileId') if (!configFileId) { //     Google Drive const configFiles = await find('name = "config.json"') if (configFiles.length &gt; 0) { //   (  )  configFileId = configFiles[0].id } else { //   configFileId = await createEmptyFile('config.json') } //  ID localStorage.setItem('configFileId', configFileId) } return configFileId } async function onSignIn() { //   / (. ) if (isLoggedIn()) { //   //  (  -?)    scheduleConfigSync(0) } else { //   //          //   config file ID localStorage.removeItem('configFileId') //  localStorage   ,    } } function getConfig() { let ret try { ret = JSON.parse(localStorage.getItem('config')) } catch(e) {} //    ,    return ret || {...DEFAULT_CONFIG} } async function saveConfig(newConfig) { //    ,     localStorage.setItem('config', JSON.stringify(newConfig)) if (isLoggedIn()) { //  config file ID const configFileId = await getConfigFileId() //     Google Drive upload(configFileId, newConfig) } } async function syncConfig() { if (!isLoggedIn()) { return } //  config file ID const configFileId = await getConfigFileId() try { //   const remoteConfig = await download(configFileId) if (!remoteConfig || typeof remoteConfig !== 'object') { //    ,   upload(configFileId, getConfig()) } else { //  ,    localStorage.setItem('config', JSON.stringify(remoteConfig)) } //  ,  localStorage   } catch(e) { if (e.status === 404) { // -   ,   fileID     localStorage.removeItem('configFileId') syncConfig() } else { throw e } } } function scheduleConfigSync(delay) { //   ,    if (configSyncTimeoutId) { clearTimeout(configSyncTimeoutId) } configSyncTimeoutId = setTimeout(() =&gt; { //      syncConfig() .catch(e =&gt; console.log('Failed to synchronize config', e)) .finally(() =&gt; scheduleSourcesSync()) }, typeof delay === 'undefined' ? SYNC_PERIOD : delay) } function initApp() { //      scheduleConfigSync() }</span></span></code> </pre><br></div></div><br><h1>  Fazit </h1><br>  Meiner Meinung nach eignet sich der Datenspeicher für eine Website in Google Drive hervorragend für kleine Projekte und Prototypen.  Es ist nicht nur einfach zu implementieren und zu unterstützen, sondern trägt auch dazu bei, die Anzahl unnötiger Entitäten im Universum zu reduzieren.  Ich hoffe, mein Artikel hilft Ihnen, Zeit zu sparen, wenn Sie diesen Weg wählen. <br><br>  <b>PS</b> Der Code des realen Projekts <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">liegt auf GitHub</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sie können</a> ihn <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ausprobieren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de440844/">https://habr.com/ru/post/de440844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de440832/index.html">Snapdragon 855: Mobile Plattform für 5G, AI und Augmented Reality</a></li>
<li><a href="../de440834/index.html">DUMP-2019-Konferenz: Wir laden Sie ein, in den Abschnitten DevOps und Mobile zu sprechen</a></li>
<li><a href="../de440836/index.html">Softwareschutz gegen Kopieren und Hacken: Grundlegende Methoden und Strategien</a></li>
<li><a href="../de440838/index.html">Wie wir uns für ein DLP-System entschieden haben (praktische Erfahrung)</a></li>
<li><a href="../de440842/index.html">Das Buch „Wie man mit Intellektuellen umgeht. Ich, Nerds und Geeks "</a></li>
<li><a href="../de440846/index.html">Leistungs-Timer</a></li>
<li><a href="../de440848/index.html">Das Modell eines festen Kerns ohne elektronische Hüllen, d. H. Der Kern, ist gleich groß wie das gesamte Atom</a></li>
<li><a href="../de440850/index.html">Englisch in Indien: ein historischer Ausflug</a></li>
<li><a href="../de440852/index.html">Warum geben amerikanische Jugendliche vor, die Arbeit zu lieben?</a></li>
<li><a href="../de440854/index.html">Crypto Miner infiltrierten den Microsoft Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>