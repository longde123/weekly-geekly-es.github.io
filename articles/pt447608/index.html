<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõçÔ∏è üõê üìå Evolu√ß√£o do IC na equipe de desenvolvimento m√≥vel üôÇ üôÖüèø üëâüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje, a maioria dos produtos de software √© desenvolvida em equipes. As condi√ß√µes de sucesso para o desenvolvimento da equipe podem ser apresentadas na...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Evolu√ß√£o do IC na equipe de desenvolvimento m√≥vel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/447608/">  Hoje, a maioria dos produtos de software √© desenvolvida em equipes.  As condi√ß√µes de sucesso para o desenvolvimento da equipe podem ser apresentadas na forma de um esquema simples. <br><br><img src="https://habrastorage.org/webt/wd/yv/we/wdyvwe6jcuq9yygmffhk5-eqnlo.png"><br><br>  Depois de escrever o c√≥digo, voc√™ deve se certificar de que: <br><br><ol><li>  Isso funciona. </li><li>  N√£o quebra nada, incluindo o c√≥digo que seus colegas escreveram. </li></ol><br>  Se as duas condi√ß√µes forem atendidas, voc√™ estar√° no caminho do sucesso.  Para verificar facilmente essas condi√ß√µes e n√£o desativar um caminho lucrativo, eles criaram a Integra√ß√£o Cont√≠nua. <br><br>  O IC √© um fluxo de trabalho no qual voc√™ integra seu c√≥digo ao c√≥digo geral do produto o mais r√°pido poss√≠vel.  E n√£o apenas integrar, mas tamb√©m verificar constantemente se tudo funciona.  Como voc√™ precisa verificar muitas e muitas vezes, pense na automa√ß√£o.  Voc√™ pode verificar tudo na tra√ß√£o manual, mas n√£o vale a pena, e √© por isso. <br><a name="habracut"></a><br><ul><li>  <strong>As pessoas s√£o caras</strong> .  Uma hora de trabalho de qualquer programador √© mais cara que uma hora de trabalho de qualquer servidor. </li><li>  <strong>As pessoas est√£o erradas</strong> .  Portanto, podem surgir situa√ß√µes quando eles executam testes na ramifica√ß√£o errada ou coletam a confirma√ß√£o incorreta para testadores. </li><li>  <strong>As pessoas s√£o pregui√ßosas</strong> .  Periodicamente, quando eu termino uma tarefa, penso: ‚ÄúMas o que h√° para verificar?  Eu escrevi duas linhas - stopudovo tudo funciona! ‚Äù  Penso que para alguns de voc√™s, esses pensamentos √†s vezes v√™m √† mente.  Mas voc√™ sempre precisa verificar. </li></ul><br>  Como a Integra√ß√£o Cont√≠nua foi introduzida e desenvolvida na equipe de desenvolvimento m√≥vel Avito, como eles atingiram de 0 a 450 montagens por dia e que constroem m√°quinas coletam 200 horas por dia, diz Nikolay Nesterov ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">nnesterov</a> ) - participante de todas as mudan√ßas evolutivas do aplicativo CI / CD Android . <br><br>  A hist√≥ria √© baseada no exemplo da equipe do Android, mas a maioria das abordagens tamb√©m se aplica ao iOS. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lz8MNATTUCU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Era uma vez uma pessoa que trabalhava na equipe Avito Android.  Por defini√ß√£o, ele n√£o precisava de nada da Integra√ß√£o Cont√≠nua: n√£o havia ningu√©m com quem se integrar. <br><br>  Mas o aplicativo cresceu, mais e mais novas tarefas apareceram, respectivamente, a equipe cresceu.  Em algum momento, estava na hora de estabelecer formalmente o processo de integra√ß√£o de c√≥digo.  Foi decidido usar o fluxo Git. <br><br><img src="https://habrastorage.org/webt/rv/qa/jd/rvqajd0kgcao3w0-vw6lnomjpc8.png"><br><br>  O conceito de fluxo Git √© conhecido: existe uma ramifica√ß√£o de desenvolvimento comum no projeto e, para cada novo recurso, os desenvolvedores cortam uma ramifica√ß√£o separada, confirmam, enviam por push e, quando desejam injetar seu c√≥digo na ramifica√ß√£o de desenvolvimento, solicitam pull aberto.  Para compartilhar conhecimento e discutir abordagens, introduzimos uma revis√£o de c√≥digo, ou seja, os colegas devem verificar e confirmar o c√≥digo um do outro. <br><br><h2>  Cheques </h2><br>  Observar o c√≥digo com seus olhos √© legal, mas n√£o o suficiente.  Portanto, as verifica√ß√µes autom√°ticas s√£o introduzidas. <br><br><ul><li>  Antes de tudo, verificamos a <strong>montagem do ARC</strong> . </li><li>  Muitos <strong>testes Junit</strong> . </li><li>  <strong>Consideramos a cobertura do c√≥digo</strong> , pois executamos os testes. </li></ul><br>  Para entender como essas verifica√ß√µes devem ser executadas, vejamos o processo de desenvolvimento no Avito. <br><br>  Esquematicamente, pode ser representado da seguinte maneira: <br><br><ul><li>  O desenvolvedor escreve o c√≥digo em seu laptop.  Voc√™ pode executar verifica√ß√µes de integra√ß√£o aqui - com um gancho de confirma√ß√£o ou apenas executar verifica√ß√µes em segundo plano. </li><li>  Depois que o desenvolvedor executa o c√≥digo, ele abre a solicita√ß√£o de recebimento.  Para que o c√≥digo dele entre na ramifica√ß√£o de desenvolvimento, voc√™ deve passar por uma revis√£o de c√≥digo e coletar o n√∫mero necess√°rio de confirma√ß√µes.  Voc√™ pode ativar verifica√ß√µes e compila√ß√µes aqui: at√© que todas as compila√ß√µes sejam bem-sucedidas, a solicita√ß√£o pull n√£o pode ser mesclada. </li><li>  Depois que a solicita√ß√£o de recebimento √© mesclada e o c√≥digo est√° em desenvolvimento, voc√™ pode escolher um hor√°rio conveniente: por exemplo, √† noite, quando todos os servidores est√£o livres, e as verifica√ß√µes de unidade, como voc√™ quiser. </li></ul><br>  Ningu√©m gostou de executar testes em seu laptop.  Quando o desenvolvedor terminar o recurso, ele deseja inici√°-lo rapidamente e abrir a solicita√ß√£o de recebimento.  Se nesse momento algumas verifica√ß√µes longas forem iniciadas, isso n√£o √© apenas muito agrad√°vel, mas tamb√©m atrasa o desenvolvimento: enquanto o laptop est√° verificando alguma coisa, √© imposs√≠vel trabalhar normalmente nela. <br><br>  N√≥s realmente gostamos de executar verifica√ß√µes √† noite, porque h√° muito tempo e servidores, voc√™ pode dar um passeio.  Infelizmente, quando o c√≥digo do recurso foi desenvolvido, o desenvolvedor j√° tem muito menos motiva√ß√£o para reparar os erros encontrados pela CI.  Periodicamente, me pego pensando, quando olhava no relat√≥rio da manh√£, todos os erros encontrados para corrigi-los algum tempo depois, porque agora em Jira existe uma nova e interessante tarefa que s√≥ quero come√ßar a fazer. <br><br>  Se as verifica√ß√µes bloquearem a solicita√ß√£o de recebimento, a motiva√ß√£o ser√° suficiente, porque at√© que as constru√ß√µes fiquem verdes, o c√≥digo n√£o entrar√° em desenvolvimento, o que significa que a tarefa n√£o ser√° conclu√≠da. <br><br>  Como resultado, escolhemos esta estrat√©gia: √† noite, conduzimos o conjunto m√°ximo poss√≠vel de verifica√ß√µes, a mais cr√≠tica delas e, o mais importante, rapidamente, executamos uma solicita√ß√£o de recebimento.  Mas n√£o paramos por a√≠ - estamos otimizando simultaneamente a velocidade de aprova√ß√£o nas verifica√ß√µes, para que elas mudem do modo noturno para as verifica√ß√µes na solicita√ß√£o de recebimento. <br><br>  Naquele momento, todos os nossos assemblies foram r√°pidos o suficiente, ent√£o inclu√≠mos o conjunto ARC, os testes Junit e o c√°lculo da cobertura de c√≥digo com o bloqueador de solicita√ß√£o de recebimento.  Eles o ativaram, refletiram sobre o assunto e abandonaram a cobertura de c√≥digo porque achavam que n√£o precis√°vamos disso. <br><br>  <strong><em>Levamos dois dias para concluir a configura√ß√£o b√°sica do IC (a seguir, uma estimativa tempor√°ria √© aproximada, necess√°ria para a escala).</em></strong> <br><br>  Depois disso, eles come√ßaram a pensar mais - estamos verificando corretamente?  Estamos lan√ßando builds sob solicita√ß√£o pull corretamente? <br><br>  Iniciamos a constru√ß√£o no √∫ltimo commit da ramifica√ß√£o com a qual a solicita√ß√£o pull est√° aberta.  Mas as verifica√ß√µes desse commit apenas mostram que o c√≥digo que o desenvolvedor escreveu funciona.  Mas eles n√£o provam que ele n√£o quebrou nada.  De fato, voc√™ precisa verificar o status da ramifica√ß√£o de revela√ß√£o depois que o recurso foi injetado nela. <br><br><img src="https://habrastorage.org/webt/g7/sw/gn/g7swgnopkxqajjm-73mz9oxwbng.png"><br><br>  Para fazer isso, escrevemos um script bash simples <strong>premerge.sh:</strong> <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash set -e git fetch origin develop git merge origin/develop</span></span></code> </pre> <br>  Aqui, todas as altera√ß√µes mais recentes do desenvolvimento s√£o simplesmente puxadas e mescladas na ramifica√ß√£o atual.  Adicionamos o script premerge.sh como a primeira etapa de todas as compila√ß√µes e come√ßamos a verificar exatamente o que queremos, ou seja, a <strong>integra√ß√£o</strong> . <br><br>  <strong><em>Demorou tr√™s dias para localizar o problema, encontrar uma solu√ß√£o e escrever este script.</em></strong> <br><br>  O aplicativo desenvolvido, cada vez mais tarefas apareciam, a equipe crescia e premerge.sh √†s vezes come√ßava a nos decepcionar.  Desenvolver mudan√ßas conflitantes e penetrantes que interromperam a assembl√©ia. <br><br>  Um exemplo de como isso acontece: <br><br><img src="https://habrastorage.org/webt/xc/dm/e-/xcdme-bg7rwxkmgip5pgh4hlc8u.png"><br><br>  Dois desenvolvedores come√ßam a visualizar simultaneamente os recursos A e B. O desenvolvedor do recurso A descobre a fun√ß√£o <code>answer()</code> n√£o utilizada no projeto e, como um bom olheiro, a remove.  Ao mesmo tempo, o desenvolvedor do recurso B adiciona uma nova chamada a essa fun√ß√£o em sua ramifica√ß√£o. <br><br>  Os desenvolvedores concluem o trabalho e, ao mesmo tempo, solicitam pull aberto.  As constru√ß√µes iniciam, premerge.sh verifica a solicita√ß√£o de recebimento de um novo estado de desenvolvimento - todas as verifica√ß√µes s√£o verdes.  Depois que os recursos de solicita√ß√£o de recebimento A forem mesclados, os recursos de solicita√ß√£o de recebimento B ser√£o mesclados ... Lan√ßa!  Desenvolver quebras porque no c√≥digo de desenvolvimento h√° uma chamada para uma fun√ß√£o inexistente. <br><br><img src="https://habrastorage.org/webt/zk/im/_r/zkim_rji20ahq4fyztlnc-twxwi.png"><br><br>  Quando n√£o vai se desenvolver, isso √© um <strong>desastre local</strong> .  Toda a equipe n√£o pode coletar e dar nada para o teste. <br><br>  Aconteceu que eu estava frequentemente envolvido em tarefas de infraestrutura: an√°lise, rede, bancos de dados.  Ou seja, escrevi as fun√ß√µes e classes que outros desenvolvedores usam.  Por causa disso, muitas vezes entrei em tais situa√ß√µes.  Eu at√© tive essa foto de uma vez. <br><br><img src="https://habrastorage.org/webt/xo/vj/6e/xovj6ea0xjjvuoxfgnrrhbskxta.jpeg"><br><br>  Como isso n√£o nos convinha, come√ßamos a elaborar op√ß√µes sobre como evitar isso. <br><br><h2>  Como n√£o quebrar desenvolver </h2><br>  Primeira op√ß√£o: <strong>reconstrua todas as solicita√ß√µes pull quando a atualiza√ß√£o for desenvolvida.</strong>  Se, no nosso exemplo, uma solicita√ß√£o pull com o recurso A primeiro entrar em desenvolvimento, a solicita√ß√£o pull do recurso B ser√° reconstru√≠da e, consequentemente, as verifica√ß√µes falhar√£o devido a um erro de compila√ß√£o. <br><br>  Para entender quanto tempo levar√°, considere um exemplo com dois PRs.  Abrimos dois PRs: duas compila√ß√µes, dois lan√ßamentos de teste.  Depois que o primeiro PR √© despejado no desenvolvimento, o segundo deve ser reconstru√≠do.  No total, dois lan√ßamentos de cheques de RP levam tr√™s PRs: 2 + 1 = 3. <br><br>  Em princ√≠pio, √© normal.  Mas analisamos as estat√≠sticas e uma situa√ß√£o t√≠pica em nossa equipe era de 10 PRs abertos e, em seguida, o n√∫mero de verifica√ß√µes √© a soma da progress√£o: 10 + 9 + ... + 1 = 55. Ou seja, para aceitar 10 PRs, √© necess√°rio reconstruir 55 vezes.  E isso est√° em uma situa√ß√£o ideal, quando todas as verifica√ß√µes passam pela primeira vez, quando ningu√©m abre uma solicita√ß√£o de recebimento adicional enquanto essas dez est√£o sendo processadas. <br><br>  Imagine-se um desenvolvedor que precisa ter tempo para pressionar o bot√£o "mesclar" primeiro, porque se isso for feito por um vizinho, voc√™ ter√° que esperar at√© que todas as montagens sejam executadas novamente ... N√£o, isso n√£o funcionar√°, isso atrasar√° seriamente o desenvolvimento. <br><br>  A segunda maneira poss√≠vel: <strong>coletar solicita√ß√£o de recebimento ap√≥s revis√£o de c√≥digo.</strong>  Ou seja, abra a solicita√ß√£o de recebimento, colete o n√∫mero necess√°rio de atualiza√ß√µes de colegas, corrija o que voc√™ precisa e execute as compila√ß√µes.  Se tiverem √™xito, a solicita√ß√£o pull ser√° mesclada com o develop.  Nesse caso, n√£o h√° reinicializa√ß√µes adicionais, mas o feedback diminui bastante.  Como desenvolvedor, quando abro uma solicita√ß√£o de recebimento, quero imediatamente ver se ele vai.  Por exemplo, se um teste falhar, voc√™ precisar√° corrigi-lo rapidamente.  No caso de uma compila√ß√£o atrasada, o feedback fica mais lento, o que significa todo o desenvolvimento.  Isso tamb√©m n√£o nos convinha. <br><br>  Como resultado, apenas a terceira op√ß√£o permaneceu - dar um <strong>ciclo</strong> .  Todo o nosso c√≥digo, todas as nossas fontes s√£o armazenadas no reposit√≥rio no servidor Bitbucket.  Assim, tivemos que desenvolver um plugin para o Bitbucket. <br><br><img src="https://habrastorage.org/webt/kf/ye/yx/kfyeyxalmkommukvjics9uvinn4.png"><br><br>  Este plug-in substitui o mecanismo de mesclagem de solicita√ß√£o de recebimento.  O in√≠cio √© padr√£o: o PR √© aberto, todos os conjuntos s√£o iniciados, a revis√£o do c√≥digo √© aprovada.  Por√©m, ap√≥s a revis√£o do c√≥digo ser aprovada e o desenvolvedor decidir clicar em "mesclar", o plug-in verifica se o estado em que as verifica√ß√µes de desenvolvimento foram executadas.  Se, ap√≥s as compila√ß√µes, o develop conseguiu atualizar, o plug-in n√£o permitir√° a mesclagem de uma solicita√ß√£o pull na ramifica√ß√£o principal.  Simplesmente reiniciar√° as compila√ß√µes em rela√ß√£o ao novo desenvolvimento. <br><br><img src="https://habrastorage.org/webt/_v/_s/0z/_v_s0zaf1bjvxn8oiwekagtj37a.png"><br><br>  Em nosso exemplo com altera√ß√µes conflitantes, essas compila√ß√µes falhar√£o devido a um erro de compila√ß√£o.  Dessa forma, o desenvolvedor do recurso B precisar√° corrigir o c√≥digo, reiniciar as verifica√ß√µes e o plug-in aplicar√° automaticamente a solicita√ß√£o de recebimento. <br><br>  Antes de implementar este plug-in, tivemos uma m√©dia de 2,7 execu√ß√µes de teste por solicita√ß√£o pull.  Com o plugin, houve 3,6 lan√ßamentos.  Isso nos convinha. <br><br>  Vale a pena notar que este plugin tem uma desvantagem: ele reinicia a compila√ß√£o apenas uma vez.  Ou seja, permanece uma pequena janela atrav√©s da qual mudan√ßas conflitantes podem se desenvolver.  Mas a probabilidade disso n√£o √© alta e fizemos esse compromisso entre o n√∫mero de partidas e a probabilidade de falha.  Por dois anos, ele disparou apenas uma vez, portanto, provavelmente n√£o em v√£o. <br><br>  <strong><em>Demoramos duas semanas para escrever a primeira vers√£o do plugin para Bitbucket.</em></strong> <br><br><h3>  Novos cheques </h3><br>  Enquanto isso, nossa equipe continuou a crescer.  Novas verifica√ß√µes foram adicionadas. <br><br>  Pensamos: por que reparar erros se eles podem ser evitados?  E ent√£o eles introduziram a <strong>an√°lise de c√≥digo est√°tico</strong> .  Come√ßamos com o lint, que est√° inclu√≠do no Android SDK.  Mas naquela √©poca ele n√£o sabia trabalhar com o c√≥digo Kotlin, e j√° possu√≠mos 75% do aplicativo escrito em Kotlin.  Portanto, as <strong>verifica√ß√µes internas do Android Studio</strong> foram adicionadas ao fiapo <strong>.</strong> <br><br>  Para fazer isso, tive que ser muito pervertido: pegue o Android Studio, empacote-o no Docker e execute-o no CI com um monitor virtual para que ele pensasse que estava sendo executado em um laptop real.  Mas funcionou. <br><br>  Tamb√©m nesse momento, come√ßamos a escrever muitos <strong>testes</strong> de <strong>instrumenta√ß√£o</strong> e implementamos o <strong>teste de captura de tela</strong> .  √â quando uma captura de tela de refer√™ncia √© gerada para uma visualiza√ß√£o pequena separada, e o teste √© que uma captura de tela √© tirada da visualiza√ß√£o e comparada diretamente com a refer√™ncia pixel por pixel.  Se houver uma discrep√¢ncia, significa que um layout foi para algum lugar ou algo est√° errado nos estilos. <br><br>  Por√©m, testes de instrumenta√ß√£o e de captura de tela precisam ser executados em dispositivos: emuladores ou em dispositivos reais.  Dado que existem muitos testes e eles geralmente perseguem, voc√™ precisa de um farm inteiro.  Para iniciar sua pr√≥pria fazenda √© muito trabalhoso, por isso encontramos uma op√ß√£o pronta - o Firebase Test Lab. <br><br><h3>  Laborat√≥rio de teste do Firebase </h3><br>  Foi escolhido porque o Firebase √© um produto do Google, ou seja, deve ser confi√°vel e dificilmente morrer√°.  Os pre√ßos s√£o acess√≠veis: US $ 5 por hora para um dispositivo real e US $ 1 por hora para um emulador. <br><br>  <strong><em>Demorou cerca de tr√™s semanas para implementar o Firebase Test Lab em nosso IC.</em></strong> <br><br>  Mas a equipe continuou a crescer, e o Firebase, infelizmente, come√ßou a nos decepcionar.  Naquela √©poca, ele n√£o tinha SLA.  √Äs vezes, o Firebase nos fazia esperar at√© que o n√∫mero necess√°rio de dispositivos para testes se tornasse gratuito e n√£o os executasse imediatamente, como quer√≠amos.  A espera na fila demorou meia hora, e esse √© um tempo muito longo.  Os testes de instrumenta√ß√£o eram executados em todas as rela√ß√µes p√∫blicas, os atrasos atrasavam muito o desenvolvimento e, em seguida, uma conta mensal vinha com uma soma redonda.  Em geral, foi decidido abandonar o Firebase e serrar em casa, j√° que a equipe cresceu o suficiente. <br><br><h3>  Docker + python + bash </h3><br>  Pegamos o docker, inserimos emuladores nele, escrevemos um programa simples em Python que, no momento certo, aumenta o n√∫mero certo de emuladores na vers√£o correta e os interrompe quando necess√°rio.  E, √© claro, alguns scripts bash - onde sem eles? <br><br>  <strong><em>Foram necess√°rias cinco semanas para criar nosso pr√≥prio ambiente de teste.</em></strong> <br><br>  Como resultado, cada solicita√ß√£o de recebimento tinha uma extensa lista de mesclagem de verifica√ß√µes de bloqueio: <br><br><ul><li>  Assembl√©ia do ARC; </li><li>  Testes Junit </li><li>  Fiapos; </li><li>  Verifica√ß√µes do Android Studio; </li><li>  Testes de instrumenta√ß√£o; </li><li>  Testes de captura de tela. </li></ul><br>  Isso impediu muitas poss√≠veis falhas.  Tecnicamente, tudo funcionou, mas os desenvolvedores reclamaram que a espera pelos resultados era muito longa. <br><br>  Quanto tempo √© quanto?  Carregamos os dados do Bitbucket e TeamCity no sistema de an√°lise e percebemos que o <strong>tempo m√©dio de espera √© de 45 minutos</strong> .  Ou seja, um desenvolvedor, que abre uma solicita√ß√£o de recebimento, espera, em m√©dia, resultados de compila√ß√£o de 45 minutos.  Na minha opini√£o, isso √© muito, e voc√™ n√£o pode trabalhar assim. <br><br>  Obviamente, decidimos acelerar todas as nossas compila√ß√µes. <br><br><h2>  Acelerar </h2><br>  Vendo que muitas vezes as constru√ß√µes est√£o alinhadas, a primeira coisa que <strong>compramos √© o ferro</strong> - o desenvolvimento extensivo √© o mais simples.  As constru√ß√µes pararam de ficar na fila, mas o tempo de espera diminuiu apenas um pouco, porque algumas verifica√ß√µes estavam sendo realizadas por um per√≠odo muito longo. <br><br><h3>  Removemos verifica√ß√µes muito longas </h3><br>  Nossa integra√ß√£o cont√≠nua pode detectar esses tipos de erros e problemas. <br><br><ul><li>  <strong>N√£o vou</strong> .  O IC pode detectar um erro de compila√ß√£o quando, devido a altera√ß√µes conflitantes, algo n√£o est√° ocorrendo.  Como eu disse, ningu√©m pode coletar nada, o desenvolvimento aumenta e todos ficam nervosos. </li><li>  <strong>Um erro no comportamento</strong> .  Por exemplo, quando o aplicativo √© criado, mas quando voc√™ clica no bot√£o, ele trava ou o bot√£o n√£o √© pressionado.  Isso √© ruim porque esse bug pode alcan√ßar o usu√°rio. </li><li>  <strong>Bug no layout</strong> .  Por exemplo, um bot√£o √© pressionado, mas movido 10 pixels para a esquerda. </li><li>  <strong>Aumento da d√≠vida t√©cnica</strong> . </li></ul><br>  Observando esta lista, percebemos que apenas os dois primeiros pontos s√£o cr√≠ticos.  Queremos pegar esses problemas antes de tudo.  Os erros no layout s√£o detectados no est√°gio de revis√£o do projeto e s√£o facilmente corrigidos.  Trabalhar com d√≠vida t√©cnica requer um processo e planejamento separados, por isso decidimos n√£o verificar a solicita√ß√£o de recebimento. <br><br>  Com base nessa classifica√ß√£o, sacudimos toda a lista de verifica√ß√µes.  <strong>Riscou o Lint</strong> e adiou o lan√ßamento para a noite: apenas para fornecer um relat√≥rio de quantos problemas existem no projeto.  Concordamos em trabalhar separadamente com a d√≠vida t√©cnica, mas <strong>recusamos completamente os cheques do Android Studio</strong> .  O Android Studio do Docker para lan√ßar inspe√ß√µes parece interessante, mas traz muitos problemas no suporte.  Qualquer atualiza√ß√£o para as vers√µes do Android Studio √© uma luta contra bugs obscuros.  Tamb√©m foi dif√≠cil manter testes de captura de tela, porque a biblioteca n√£o funcionava de maneira muito est√°vel, havia falsos positivos.  <strong>Os testes de captura de tela foram removidos da lista de verifica√ß√µes</strong> . <br><br>  Como resultado, nos resta: <br><br><ul><li>  Assembl√©ia do ARC; </li><li>  Testes Junit </li><li>  Testes de instrumenta√ß√£o. </li></ul><br><br><h3>  Cache remoto Gradle </h3><br>  Sem verifica√ß√µes pesadas, as coisas melhoraram.  Mas n√£o h√° limite para a perfei√ß√£o! <br><br>  Nossa aplica√ß√£o j√° foi dividida em aproximadamente 150 m√≥dulos gradle.  Normalmente, nesse caso, o cache remoto Gradle funciona bem e decidimos experiment√°-lo. <br><br>  O cache remoto Gradle √© um servi√ßo que pode criar artefatos de cache para tarefas individuais em m√≥dulos separados.  Gradle, em vez de realmente compilar o c√≥digo, bate no cache remoto via HTTP e pergunta se algu√©m j√° executou essa tarefa.  Nesse caso, basta baixar o resultado. <br><br>  <strong><em>Iniciar o cache remoto do Gradle √© f√°cil porque o Gradle fornece uma imagem do Docker.</em></strong>  <strong><em>Conseguimos fazer isso em tr√™s horas.</em></strong> <br><br>  Tudo o que era necess√°rio era iniciar o Docker e registrar uma linha no projeto.  Mas, embora voc√™ possa inici√°-lo rapidamente para que tudo funcione bem, isso levar√° muito tempo. <br><br>  Abaixo est√° um gr√°fico de erros de cache. <br><br><img src="https://habrastorage.org/webt/je/0j/an/je0jansmt1nkhgiqhwybnmc2_fs.png"><br><br>  No in√≠cio, a porcentagem de falhas ap√≥s o cache era de cerca de 65. Tr√™s semanas depois, conseguimos aumentar esse valor para 20%.  Acontece que as tarefas que o aplicativo Android coleta possuem depend√™ncias transitivas estranhas, devido √†s quais Gradle perdeu o cache. <br><br>  Ao conectar o cache, aceleramos bastante a montagem.  Mas, al√©m da montagem, os testes de instrumenta√ß√£o ainda est√£o perseguindo, e est√£o perseguindo por um longo tempo.  Talvez nem todos os testes precisem ser perseguidos para cada solicita√ß√£o de recebimento.  Para descobrir, usamos a an√°lise de impacto. <br><br><h3>  An√°lise de impacto </h3><br>  Na solicita√ß√£o pull, criamos o git diff e encontramos os m√≥dulos Gradle modificados. <br><br><img src="https://habrastorage.org/webt/yg/xn/ki/ygxnkisjdskb-qkqxoccaywcu5a.png"><br><br>  Faz sentido executar apenas os testes de instrumenta√ß√£o que testam os m√≥dulos modificados e todos os m√≥dulos que dependem deles.  N√£o faz sentido executar testes para m√≥dulos vizinhos: o c√≥digo n√£o foi alterado l√° e nada pode ser interrompido. <br><br>  Os testes de instrumenta√ß√£o n√£o s√£o t√£o simples, porque devem estar localizados no m√≥dulo Aplicativo de n√≠vel superior.  Aplicamos uma heur√≠stica de an√°lise de bytecode para entender a qual m√≥dulo cada teste pertence. <br><br>  <strong><em>Demorou cerca de oito semanas para atualizar os testes de instrumenta√ß√£o para testar apenas os m√≥dulos envolvidos.</em></strong> <br><br>  As medidas de acelera√ß√£o de verifica√ß√£o funcionaram com sucesso.  Ap√≥s 45 minutos, chegamos a aproximadamente 15. Um quarto de hora para aguardar a compila√ß√£o j√° √© normal. <br><br>  Mas agora os desenvolvedores come√ßaram a reclamar que n√£o est√° claro para eles quais builds est√£o sendo lan√ßadas, onde o log ficar√°, por que o build est√° vermelho, qual teste caiu etc. <br><br><img height="487" src="https://habrastorage.org/webt/ez/ev/wl/ezevwlalp50tf9bcret2aff7fte.png"><br><br>  Os problemas de feedback retardam o desenvolvimento, por isso tentamos fornecer as informa√ß√µes mais compreens√≠veis e detalhadas sobre cada PR e compila√ß√£o.  Come√ßamos com coment√°rios no Bitbucket for PR, indicando qual compila√ß√£o caiu e por que, escrevemos mensagens direcionadas no Slack.  No final, eles criaram um painel para a p√°gina de Rela√ß√µes P√∫blicas com uma lista de todas as compila√ß√µes em execu√ß√£o no momento e seu status: na linha, inicia, trava ou termina.  Voc√™ pode clicar na compila√ß√£o e acessar seu log. <br><br><img src="https://habrastorage.org/webt/d5/hu/fr/d5hufrypmfupj3g8k4snhrksy9w.png"><br><br>  <strong><em>Seis semanas foram gastas em feedback detalhado.</em></strong> <br><br><h2>  Planos </h2><br>  Passamos para a hist√≥ria mais recente.  Tendo resolvido a quest√£o do feedback, fomos para um novo n√≠vel - decidimos construir nossa pr√≥pria fazenda de emuladores.  Quando existem muitos testes e emuladores, eles s√£o dif√≠ceis de gerenciar.  Como resultado, todos os nossos emuladores foram movidos para um cluster k8s com gerenciamento flex√≠vel de recursos. <br><br>  Al√©m disso, existem outros planos. <br><br><ul><li>  <strong>Return Lint</strong> (e outras an√°lises est√°ticas).  J√° estamos trabalhando nessa dire√ß√£o. </li><li>  Execute todos os <strong>testes de ponta a ponta</strong> no bloqueador PR em todas as vers√µes do SDK. </li></ul><br>  Assim, tra√ßamos a hist√≥ria do desenvolvimento da Integra√ß√£o Cont√≠nua no Avito.  Agora, quero dar alguns conselhos do ponto de vista dos experientes. <br><br><h1>  Dicas </h1><br>  Se eu pudesse dar apenas um conselho, seria o seguinte: <br><br><blockquote>  Por favor, tenha cuidado com os scripts de shell! </blockquote><br>  O Bash √© uma ferramenta muito flex√≠vel e poderosa, √© muito conveniente e r√°pido para escrever scripts nele.  Mas com ele voc√™ pode cair na armadilha e, infelizmente, ca√≠mos nela. <br><br>  Tudo come√ßou com scripts simples executados em nossas m√°quinas de constru√ß√£o: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash ./gradlew assembleDebug</span></span></code> </pre> <br>  Mas, como voc√™ sabe, tudo se desenvolve e se complica com o tempo - vamos executar um script a partir de outro, vamos passar alguns par√¢metros para l√° - no final, tive que escrever uma fun√ß√£o que determina qual n√≠vel de bash de aninhamento estamos no momento para substituir as aspas necess√°rias, para que tudo comece. <br><br><img src="https://habrastorage.org/webt/rt/o6/vp/rto6vp4hs-ucbefd_3pbzehvx0a.png"><br><br>  Voc√™ pode imaginar o trabalho envolvido no desenvolvimento desses scripts.  Eu aconselho voc√™ a n√£o cair nessa armadilha. <br><br>  O que pode ser substitu√≠do? <br><br><ul><li>  Qualquer linguagem de script.  Escrever em <strong>Python ou Kotlin Script √©</strong> mais conveniente porque √© programa√ß√£o, n√£o scripts. </li><li>  Ou descreva toda a l√≥gica de constru√ß√£o na forma de <strong>tarefas de classifica√ß√£o personalizada</strong> para seu projeto. </li></ul><br>  Decidimos escolher a segunda op√ß√£o e agora estamos excluindo sistematicamente todos os scripts do bash e escrevendo muitos shuffles personalizados do gradle. <br><br>  <strong>Dica 2: mantenha sua infraestrutura em c√≥digo.</strong> <br><br>  √â conveniente quando a configura√ß√£o de Integra√ß√£o Cont√≠nua n√£o √© armazenada na interface de interface do usu√°rio Jenkins ou TeamCity, etc., mas como arquivos de texto diretamente no reposit√≥rio do projeto.  Isso fornece capacidade de vers√£o.  N√£o ser√° dif√≠cil reverter ou coletar c√≥digo em outra ramifica√ß√£o. <br><br>  Os scripts podem ser armazenados no projeto.  E o que fazer com o meio ambiente? <br><br>  <strong>Dica 3: o Docker pode ajudar com o meio ambiente.</strong> <br><br>  Definitivamente ajudar√° os desenvolvedores do Android, ainda n√£o iOS, infelizmente. <br><br>  Este √© um exemplo de um arquivo docker simples que cont√©m jdk e android-sdk: <br><br><pre> <code class="plaintext hljs">FROM openjdk:8 ENV SDK_URL="https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip" \ ANDROID_HOME="/usr/local/android-sdk" \ ANDROID_VERSION=26 \ ANDROID_BUILD_TOOLS_VERSION=26.0.2 # Download Android SDK RUN mkdir "$ANDROID_HOME" .android \ &amp;&amp; cd "$ANDROID_HOME" \ &amp;&amp; curl -o sdk.zip $SDK_URL \ &amp;&amp; unzip sdk.zip \ &amp;&amp; rm sdk.zip \ &amp;&amp; yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses # Install Android Build Tool and Libraries RUN $ANDROID_HOME/tools/bin/sdkmanager --update RUN $ANDROID_HOME/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS_VERSION}" \ "platforms;android-${ANDROID_VERSION}" \ "platform-tools" RUN mkdir /application WORKDIR /application</code> </pre><br>  Depois de escrever esse arquivo de encaixe (vou lhe contar um segredo, voc√™ n√£o pode escrev√™-lo, mas retir√°-lo do GitHub) e coletar a imagem, voc√™ obt√©m uma m√°quina virtual na qual √© poss√≠vel criar o aplicativo e executar os testes do Junit. <br><br>  Os dois principais argumentos pelos quais isso faz sentido s√£o escalabilidade e repetibilidade.  Usando a janela de encaixe, voc√™ pode aumentar rapidamente uma d√∫zia de agentes de constru√ß√£o que ter√£o exatamente o mesmo ambiente que o antigo.  Isso facilita a vida dos engenheiros de CI.  Colocar o android-sdk no docker √© bastante simples, com os emuladores um pouco mais complicados: voc√™ precisa trabalhar um pouco (bem, ou fazer o download do finalizado novamente no GitHub). <br><br>  <strong>Dica n√∫mero 4: n√£o esque√ßa que as verifica√ß√µes n√£o s√£o feitas apenas para verifica√ß√£o, mas para as pessoas.</strong> <br><br>  O feedback r√°pido e, o mais importante, claro √© muito importante para os desenvolvedores: o que eles quebraram, que teste caiu, onde o log de cria√ß√£o. <br><br>  <strong>Dica 5: seja pragm√°tico com a integra√ß√£o cont√≠nua.</strong> <br><br>  Entenda claramente que tipos de erros voc√™ deseja evitar, quanto voc√™ est√° disposto a gastar recursos, tempo, tempo no computador.  As verifica√ß√µes muito longas podem, por exemplo, ser reagendadas da noite para o dia.  E aqueles que pegam erros n√£o muito importantes devem ser completamente abandonados. <br><br>  <strong>Dica n√∫mero 6: use ferramentas prontas.</strong> <br><br>  Agora, existem muitas empresas que fornecem CI de nuvem. <br><br><img src="https://habrastorage.org/webt/7a/dr/k3/7adrk3z_1xnccybehwal8sfi-pi.png"><br><br>  Para equipes pequenas, essa √© uma boa sa√≠da.  Voc√™ n√£o precisa manter nada, apenas pague algum dinheiro, colete seu aplicativo e at√© realize testes de instrumenta√ß√£o. <br><br>  <strong>Dica 7: em uma equipe grande, as solu√ß√µes internas s√£o mais lucrativas.</strong> <br><br>  Por√©m, mais cedo ou mais tarde, com o crescimento da equipe, as solu√ß√µes internas ser√£o mais lucrativas.  H√° um ponto nessas decis√µes.  Em economia, existe uma lei de retornos decrescentes: em qualquer projeto, cada melhoria subsequente √© cada vez mais dif√≠cil, requer cada vez mais investimento. <br><br>  A economia descreve toda a nossa vida, incluindo a integra√ß√£o cont√≠nua.  Criei um cronograma de trabalho para cada est√°gio do desenvolvimento da Integra√ß√£o Cont√≠nua. <br><br><img src="https://habrastorage.org/webt/es/za/8w/esza8woeimanj5auez2iz9js7di.png"><br><br>  Pode-se ver que qualquer melhoria √© cada vez mais dif√≠cil.  Observando este gr√°fico, podemos entender que o desenvolvimento da Integra√ß√£o Cont√≠nua deve ser consistente com o crescimento do tamanho da equipe.  Para uma equipe de duas pessoas, gastar 50 dias desenvolvendo um farm de emuladores internos √© uma id√©ia mais ou menos.  Mas, ao mesmo tempo, para uma grande equipe n√£o fazer a Integra√ß√£o Cont√≠nua tamb√©m √© uma m√° id√©ia, devido a problemas de integra√ß√£o, corre√ß√£o de comunica√ß√µes etc.  vai demorar ainda mais tempo. <br><br>  Come√ßamos com o fato de que a automa√ß√£o √© necess√°ria porque as pessoas s√£o caras, enganadas e pregui√ßosas.  Mas as pessoas tamb√©m automatizam.  Portanto, todos esses mesmos problemas se aplicam √† automa√ß√£o. <br><br><ul><li>  Automatizar √© caro.  Lembre-se do hor√°rio de trabalho. </li><li>  Na automa√ß√£o, as pessoas cometem erros. </li><li>  √Äs vezes, a automa√ß√£o √© muito pregui√ßosa, porque tudo funciona assim.  Por que mais melhorar, por que toda essa integra√ß√£o cont√≠nua? </li></ul><br>     :  20%   .     ,      .  ,   , ,    - ,     develop,    . ,           ,    -   . <br><br> <strong> Continuous Integration.   .</strong> <br><br><blockquote> ,        ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppsConf</a>        .            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .     22-23   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447608/">https://habr.com/ru/post/pt447608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447592/index.html">WhatsApp na palma da sua m√£o: onde e como voc√™ pode detectar artefatos forenses?</a></li>
<li><a href="../pt447594/index.html">Instrumentos personalizados: quando a placa de sinaliza√ß√£o n√£o √© suficiente</a></li>
<li><a href="../pt447598/index.html">Escrevendo um jogo de cart√£o de mem√≥ria no Swift</a></li>
<li><a href="../pt447604/index.html">Dentes lisos, C ++ e matem√°tica - como eles est√£o relacionados? Conversa com Alinhar</a></li>
<li><a href="../pt447606/index.html">Coletor de lixo CLRium # 5: Peter - Esgotado</a></li>
<li><a href="../pt447610/index.html">Como assumir o controle de sua infraestrutura de rede. CAP√çTULO TR√äS Seguran√ßa de rede. Parte tr√™s</a></li>
<li><a href="../pt447612/index.html">Centro de Dados Espaciais. Tradu√ß√£o de texto do lan√ßamento do servidor na estratosfera</a></li>
<li><a href="../pt447614/index.html">Voc√™ n√£o conseguir√° resolver este problema na entrevista</a></li>
<li><a href="../pt447616/index.html">Conex√£o do Aquastorozh √† Smart Home no Z-Wave</a></li>
<li><a href="../pt447618/index.html">O banco de dados do servi√ßo de streaming Kanopy vazou at√© 40 milh√µes de entradas de log sobre filmes visualizados pelos usu√°rios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>