<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¶ğŸ» ğŸ¹ âœŠğŸ¿ å…¨æ–‡æœç´¢ï¼šé’ˆå¯¹å¤æ‚ä»»åŠ¡çš„Elasticsearchç‰¹å®šåŠŸèƒ½ ğŸšµğŸ¿ ğŸ•‰ï¸ ğŸ§‘ğŸ»â€ğŸ¤â€ğŸ§‘ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ï¼Œæˆ‘å«Andreyï¼Œæˆ‘æ˜¯ä¸€åå¼€å‘äººå‘˜ã€‚ å¾ˆä¹…ä»¥å‰-ä¼¼ä¹æ˜¯ä¸Šå‘¨äº”-æˆ‘ä»¬çš„å›¢é˜Ÿè¿›è¡Œäº†ä¸€ä¸ªé¡¹ç›®ï¼Œä»–ä»¬éœ€è¦æœç´¢æ„æˆäº§å“çš„æˆåˆ†ã€‚ å‡è®¾é¦™è‚ çš„æˆåˆ†ã€‚ åœ¨é¡¹ç›®çš„å¼€å§‹é˜¶æ®µï¼Œæœç´¢å°±ä¸éœ€è¦å¤ªå¤šï¼šæ˜¾ç¤ºæ‰€æœ‰åŒ…å«ä¸€å®šé‡æ‰€éœ€æˆåˆ†çš„é…æ–¹ï¼› é‡å¤Nä¸ªæˆåˆ†ã€‚ 

 ä½†æ˜¯ï¼Œå°†æ¥è®¡åˆ’å¤§å¹…å¢åŠ äº§å“å’Œæˆåˆ†çš„æ•°é‡ï¼Œå¹¶ä¸”æœç´¢ä¸ä»…åº”åº”å¯¹ä¸æ–­...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å…¨æ–‡æœç´¢ï¼šé’ˆå¯¹å¤æ‚ä»»åŠ¡çš„Elasticsearchç‰¹å®šåŠŸèƒ½</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413075/"><img src="https://habrastorage.org/webt/yb/hh/1r/ybhh1rxmqt9yswla3tfbiexyluo.png" alt="å›¾ç‰‡"><br><br> å¤§å®¶å¥½ï¼Œæˆ‘å«Andreyï¼Œæˆ‘æ˜¯ä¸€åå¼€å‘äººå‘˜ã€‚ å¾ˆä¹…ä»¥å‰-ä¼¼ä¹æ˜¯ä¸Šå‘¨äº”-æˆ‘ä»¬çš„å›¢é˜Ÿè¿›è¡Œäº†ä¸€ä¸ªé¡¹ç›®ï¼Œä»–ä»¬éœ€è¦æœç´¢æ„æˆäº§å“çš„æˆåˆ†ã€‚ å‡è®¾é¦™è‚ çš„æˆåˆ†ã€‚ åœ¨é¡¹ç›®çš„å¼€å§‹é˜¶æ®µï¼Œæœç´¢å°±ä¸éœ€è¦å¤ªå¤šï¼šæ˜¾ç¤ºæ‰€æœ‰åŒ…å«ä¸€å®šé‡æ‰€éœ€æˆåˆ†çš„é…æ–¹ï¼› é‡å¤Nä¸ªæˆåˆ†ã€‚ <br><a name="habracut"></a><br> ä½†æ˜¯ï¼Œå°†æ¥è®¡åˆ’å¤§å¹…å¢åŠ äº§å“å’Œæˆåˆ†çš„æ•°é‡ï¼Œå¹¶ä¸”æœç´¢ä¸ä»…åº”åº”å¯¹ä¸æ–­å¢åŠ çš„æ•°æ®é‡ï¼Œè€Œä¸”è¿˜åº”æä¾›å…¶ä»–é€‰é¡¹-ä¾‹å¦‚ï¼Œæ ¹æ®äº§å“çš„ä¸»è¦æˆåˆ†è‡ªåŠ¨ç¼–åˆ¶äº§å“è¯´æ˜ã€‚ <br><br>  <b>è¦æ±‚æ¡ä»¶</b> <br><br><ul><li> ä½¿ç”¨è‡³å°‘50,000ä¸ªæ–‡æ¡£çš„æ•°æ®åº“åœ¨Elacsticsearchä¸Šåˆ›å»ºæœç´¢ã€‚ </li><li> æä¾›å¯¹è¯·æ±‚çš„é«˜é€Ÿå“åº”-å°‘äº300æ¯«ç§’ã€‚ </li><li> ä¸ºäº†ç¡®ä¿è¯·æ±‚é‡å¾ˆå°ï¼Œå¹¶ä¸”å³ä½¿åœ¨æœ€å·®çš„ç§»åŠ¨Internetæƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥æœåŠ¡ã€‚ </li><li> ä»UXçš„è§’åº¦æ¥çœ‹ï¼Œä½¿æœç´¢é€»è¾‘å°½å¯èƒ½ç›´è§‚ã€‚ ä»æœ¬è´¨ä¸Šè®²ï¼Œè¯¥ç•Œé¢å°†åæ˜ æœç´¢é€»è¾‘ï¼Œåä¹‹äº¦ç„¶ã€‚ </li><li> æœ€å°åŒ–ç³»ç»Ÿå…ƒç´ ä¹‹é—´çš„ä¸­é—´å±‚æ•°ï¼Œä»¥å®ç°æ›´é«˜çš„æ€§èƒ½å’Œæ›´å°‘çš„ä¾èµ–æ€§ã€‚ </li><li> éšæ—¶æä¾›æœºä¼šä»¥æ–°æ¡ä»¶è¡¥å……ç®—æ³•ï¼ˆä¾‹å¦‚ï¼Œè‡ªåŠ¨ç”Ÿæˆäº§å“è¯´æ˜ï¼‰ã€‚ </li><li> å°½å¯èƒ½ç®€å•ï¼Œæ–¹ä¾¿åœ°ä¸ºé¡¹ç›®çš„æœç´¢éƒ¨åˆ†æä¾›è¿›ä¸€æ­¥çš„æ”¯æŒã€‚ </li></ul><br> æˆ‘ä»¬å†³å®šä¸ç€æ€¥å¹¶ä»ç®€å•å¼€å§‹ã€‚ <br><br> é¦–å…ˆï¼Œæˆ‘ä»¬å°†äº§å“ç»„åˆçš„æ‰€æœ‰æˆåˆ†å­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œè¯¥æ•°æ®åº“æœ€åˆæ”¶åˆ°äº†10,000ä¸ªæ¡ç›®ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œå³ä½¿ä»¥è¿™ç§å¤§å°ï¼Œå³ä½¿è€ƒè™‘äº†join-så’Œç´¢å¼•çš„ä½¿ç”¨ï¼Œæœç´¢æ•°æ®åº“ä¹ŸèŠ±è´¹äº†å¤ªå¤šæ—¶é—´ã€‚ å¹¶ä¸”åœ¨ä¸ä¹…çš„å°†æ¥ï¼Œè®°å½•çš„æ•°é‡åº”è¯¥ä¼šè¶…è¿‡50,000ï¼Œæ­¤å¤–ï¼Œè¯¥å®¢æˆ·åšæŒä½¿ç”¨Elasticsearchï¼ˆä»¥ä¸‹ç®€ç§°ESï¼‰ï¼Œå› ä¸ºä»–é‡åˆ°äº†è¿™ä¸ªå·¥å…·ï¼Œæ˜¾ç„¶å¯¹ä»–æœ‰çƒ­æƒ…ã€‚ æˆ‘ä»¬ä»¥å‰æ²¡æœ‰ä½¿ç”¨è¿‡ESï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“å®ƒçš„ä¼˜ç‚¹å¹¶åŒæ„è¿™ç§é€‰æ‹©ï¼Œå› ä¸ºä¾‹å¦‚ï¼Œè®¡åˆ’å°†æˆ‘ä»¬ç»å¸¸æœ‰æ–°æ¡ç›®ï¼ˆæ ¹æ®æ¯å¤©50åˆ°500çš„å„ç§ä¼°è®¡ï¼‰ï¼Œè¿™æ˜¯å¿…è¦çš„ç«‹å³åˆ†å‘ç»™ç”¨æˆ·ã€‚ <br><br> æˆ‘ä»¬å†³å®šæ”¾å¼ƒé©±åŠ¨ç¨‹åºçº§åˆ«çš„ä¸­é—´å±‚ï¼Œåªä½¿ç”¨RESTè¯·æ±‚ï¼Œå› ä¸ºä¸æ•°æ®åº“çš„åŒæ­¥ä»…åœ¨åˆ›å»ºæ–‡æ¡£æ—¶è¿›è¡Œï¼Œå¹¶ä¸”ä¸å†éœ€è¦ã€‚ è¿™æ˜¯å¦ä¸€ä¸ªä¼˜åŠ¿-å¯ä»¥å°†æœç´¢æŸ¥è¯¢ç›´æ¥ä»æµè§ˆå™¨å‘é€åˆ°ESã€‚ <br><br> æˆ‘ä»¬æ±‡æ€»äº†ç¬¬ä¸€ä¸ªåŸå‹ï¼Œåœ¨è¯¥åŸå‹ä¸­ï¼Œæˆ‘ä»¬å°†ç»“æ„ä»æ•°æ®åº“ï¼ˆPostgreSQLï¼‰ä¼ è¾“åˆ°ESæ–‡æ¡£ï¼š <br><br><pre><code class="php hljs">{<span class="hljs-string"><span class="hljs-string">"mappings"</span></span> : { <span class="hljs-string"><span class="hljs-string">"recipe"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_source"</span></span> : { <span class="hljs-string"><span class="hljs-string">"enabled"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, <span class="hljs-string"><span class="hljs-string">"properties"</span></span> : { <span class="hljs-string"><span class="hljs-string">"recipe_id"</span></span> : {<span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"integer"</span></span>}, <span class="hljs-string"><span class="hljs-string">"recipe_name"</span></span> : {<span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"text"</span></span>}, <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span> : { <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"nested"</span></span>, <span class="hljs-string"><span class="hljs-string">"properties"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-string"><span class="hljs-string">"float"</span></span> } } } } }}</code> </pre> <br> åŸºäºæ­¤æ˜ å°„ï¼Œæˆ‘ä»¬å¤§è‡´è·å¾—ä»¥ä¸‹æ–‡æ¡£ï¼ˆç”±äºNDAï¼Œæˆ‘ä»¬æ— æ³•æ˜¾ç¤ºé¡¹ç›®ä¸­çš„å·¥ä½œäººå‘˜ï¼‰ï¼š <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"recipe_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA &amp; BBB"</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 3"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"BBB"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 4"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br> æ‰€æœ‰è¿™äº›éƒ½æ˜¯ä½¿ç”¨Elasticsearch PHPè½¯ä»¶åŒ…å®Œæˆçš„ã€‚  Laravelçš„æ‰©å±•ï¼ˆElastiquentï¼ŒLaravel Scoutç­‰ï¼‰å†³å®šä¸ä½¿ç”¨å®ƒæ˜¯å‡ºäºä¸€ä¸ªåŸå› -å®¢æˆ·éœ€è¦é«˜æ€§èƒ½ï¼Œç›´åˆ°ä¸Šé¢æåˆ°çš„â€œè¯·æ±‚300æ¯«ç§’ä¹‹å¤šâ€ã€‚ è€Œä¸”Laravelçš„æ‰€æœ‰è½¯ä»¶åŒ…éƒ½å……å½“äº†é¢å¤–çš„å¼€é”€ï¼Œå¹¶ä¸”é€Ÿåº¦å˜æ…¢äº†ã€‚ æœ¬å¯ä»¥ç›´æ¥åœ¨Guzzleä¸Šå®Œæˆï¼Œä½†æˆ‘ä»¬å†³å®šä¸èµ°æç«¯ã€‚ <br><br> é¦–å…ˆï¼Œæœ€ç®€å•çš„é…æ–¹æœç´¢ç›´æ¥åœ¨é˜µåˆ—ä¸Šå®Œæˆã€‚ æ˜¯çš„ï¼Œæ‰€æœ‰è¿™äº›éƒ½è¢«å–å‡ºåˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ç›¸åŒçš„è¯·æ±‚å´å¤ªå¤§äº†ã€‚ æœç´¢æ˜¯åœ¨é™„ä»¶æ–‡ä»¶ï¼ˆç›¸åŒæˆåˆ†ï¼‰ä¸Šè¿›è¡Œçš„ï¼Œä½¿ç”¨â€œåº”è¯¥â€å’Œâ€œå¿…é¡»â€åœ¨å¸ƒå°”è¡¨è¾¾å¼ä¸Šè¿›è¡Œæœç´¢ï¼Œè¿˜å­˜åœ¨å¯¹é™„ä»¶æ–‡ä»¶è¿›è¡Œå¼ºåˆ¶ä¼ é€’çš„æŒ‡ä»¤-ç»“æœï¼Œè¯·æ±‚ä»ä¸€ç™¾è¡Œå¼€å§‹ï¼Œå…¶è¯·æ±‚é‡ä»ä¸‰åƒå­—èŠ‚å¼€å§‹ã€‚ <br><br> ä¸è¦å¿˜è®°å¯¹å“åº”é€Ÿåº¦å’Œå¤§å°çš„è¦æ±‚-åˆ°é‚£æ—¶ï¼ŒAPIä¸­çš„ç­”æ¡ˆå·²ç»æ ¼å¼åŒ–ï¼Œä»è€Œå¢åŠ äº†æœ‰ç”¨çš„ä¿¡æ¯é‡ï¼šæ¯ä¸ªjsonå¯¹è±¡ä¸­çš„é”®éƒ½å‡å°‘ä¸ºä¸€ä¸ªå­—æ¯ã€‚ å› æ­¤ï¼Œåœ¨å‡ åƒå­—èŠ‚çš„ESä¸­è¿›è¡ŒæŸ¥è¯¢æˆä¸ºä¸€ç§æ— æ³•æ¥å—çš„å¥¢ä¾ˆã€‚ <br><br> é‚£æ—¶ï¼Œæˆ‘ä»¬æ„è¯†åˆ°ä»¥PHPå…³è”æ•°ç»„çš„å½¢å¼æ„å»ºå¤§å‹æŸ¥è¯¢æ˜¯ä¸€ç§æ²‰è¿·çš„ä¹ æƒ¯ã€‚ æ­¤å¤–ï¼Œæ§åˆ¶å™¨å˜å¾—å®Œå…¨ä¸å¯è¯»ï¼Œè¯·äº²è‡ªæŸ¥çœ‹ï¼š <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchSimilar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> $conditions[] = [ <span class="hljs-string"><span class="hljs-string">"nested"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"path"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span>, <span class="hljs-string"><span class="hljs-string">"score_mode"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"max"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"bool"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"must"</span></span> =&gt; [ [<span class="hljs-string"><span class="hljs-string">"term"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.ingredient_id"</span></span> =&gt; $ingredient_id]], [<span class="hljs-string"><span class="hljs-string">"range"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.percent"</span></span>=&gt;[ <span class="hljs-string"><span class="hljs-string">"lte"</span></span>=&gt;$percent + <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"gte"</span></span>=&gt;$percent - <span class="hljs-number"><span class="hljs-number">5</span></span> ]]] ] ] ] ] ]; $parameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][<span class="hljs-string"><span class="hljs-string">'query'</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>] = $conditions; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> $equal_conditions[] = [ <span class="hljs-string"><span class="hljs-string">"nested"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"path"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"flavors"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"bool"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"must"</span></span> =&gt; [ [<span class="hljs-string"><span class="hljs-string">"term"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.percent"</span></span> =&gt; $percent]] ] ] ] ] ]; $parameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][<span class="hljs-string"><span class="hljs-string">'query'</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'must'</span></span>] = $equal_conditions; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;client-&gt;search($parameters); }</code> </pre> <br> æŠ’æƒ…ç¦»é¢˜ï¼šå½“æ¶‰åŠåˆ°æ–‡æ¡£ä¸­çš„åµŒå¥—å­—æ®µæ—¶ï¼Œäº‹å®è¯æ˜æˆ‘ä»¬æ— æ³•æ»¡è¶³ä»¥ä¸‹å½¢å¼çš„æŸ¥è¯¢ï¼š <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"nested"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"should"</span></span>: [ ... ] } } } }</code> </pre> <br> å‡ºäºä¸€ä¸ªç®€å•çš„åŸå› -æ‚¨æ— æ³•åœ¨åµŒå¥—è¿‡æ»¤å™¨ä¸­æ‰§è¡Œå¤šé‡æœç´¢ã€‚ å› æ­¤ï¼Œæˆ‘å¿…é¡»è¿™æ ·åšï¼š <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"should"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"nested"</span></span>: { <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"flavors"</span></span>, <span class="hljs-string"><span class="hljs-string">"score_mode"</span></span>: <span class="hljs-string"><span class="hljs-string">"max"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { ... } } }} ] } }</code> </pre> <br> å³ é¦–å…ˆï¼Œå£°æ˜äº†åº”æ»¡è¶³æ¡ä»¶çš„æ•°ç»„ï¼Œå¹¶åœ¨æ¯ä¸ªæ¡ä»¶å†…é€šè¿‡åµŒå¥—å­—æ®µè°ƒç”¨äº†æœç´¢ã€‚ ä»Elasticsearchçš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯æ›´æ­£ç¡®å’Œåˆä¹é€»è¾‘çš„ã€‚ ç»“æœï¼Œå½“æˆ‘ä»¬æ·»åŠ å…¶ä»–æœç´¢è¯æ—¶ï¼Œæˆ‘ä»¬è‡ªå·±è®¤ä¸ºè¿™æ˜¯åˆä¹é€»è¾‘çš„ã€‚ <br><br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‘ç°äº†ESå†…ç½®çš„<s>Google</s>æ¨¡æ¿ã€‚ é€‰æ‹©è½åœ¨Mustacheä¸Š-ä¸€ä¸ªç›¸å½“æ–¹ä¾¿çš„æ— é€»è¾‘æ¨¡æ¿å¼•æ“ã€‚ å®é™…ä¸Šå¯ä»¥å°†æ•´ä¸ªè¯·æ±‚ä¸»ä½“å’Œæ‰€æœ‰ä¼ è¾“çš„æ•°æ®æ”¾å…¥å…¶ä¸­ï¼Œè€Œæ— éœ€è¿›è¡Œæ›´æ”¹ï¼Œå› æ­¤æœ€ç»ˆè¯·æ±‚é‡‡ç”¨ä»¥ä¸‹å½¢å¼ï¼š <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"template"</span></span>: <span class="hljs-string"><span class="hljs-string">"template1"</span></span>, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: params{} }</code> </pre> <br> æ¨¡æ¿çš„ä¸»ä½“éå¸¸é€‚åº¦ä¸”æ˜“äºé˜…è¯»-ä»…JSONå’ŒMustacheæœ¬èº«çš„æŒ‡ä»¤ã€‚ æ¨¡æ¿å­˜å‚¨åœ¨Elasticsearchæœ¬èº«ä¸­ï¼Œå¹¶æŒ‰åç§°è°ƒç”¨ã€‚ <br><br><pre> <code class="hljs smalltalk">/* search_similar.mustache */ { <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"minimum_should_match"</span></span>: {{ minimumShouldMatch }}, <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredientsList</span></span>}} // mustache         ingredientsList {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredients</span></span>}} //         ingredients {<span class="hljs-comment"><span class="hljs-comment">"nested"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"path"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"ingredients"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"score_mode"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"max"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"must"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"term"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"ingredients.flavor_id"</span></span>: {{ id }} }}, {<span class="hljs-comment"><span class="hljs-comment">"range"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"ingredients.percent"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"lte"</span></span>: {{ lte }}, <span class="hljs-comment"><span class="hljs-comment">"gte"</span></span>: {{ gte }} }}} ] } } }} {{^isLast}},{{/isLast}} //    {{/ingredients}} {{/ingredientsList}} ] }} ] } } } /*  */ { <span class="hljs-comment"><span class="hljs-comment">"template"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"search_similar"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"params"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"minimumShouldMatch"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ingredientsList"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"ingredients"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">"lte"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-comment"><span class="hljs-comment">"gte"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-comment"><span class="hljs-comment">"isLast"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } ] } } }</code> </pre> <br> ç»“æœï¼Œåœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä»¬åªéœ€å°†ä¸€ç³»åˆ—å¿…è¦çš„æˆåˆ†ä¼ é€’ç»™æ¨¡æ¿ã€‚ ä»é€»è¾‘ä¸Šè®²ï¼Œè¯¥è¯·æ±‚ä¸ä»¥ä¸‹æ¡ä»¶å¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼š <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ingredients <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> recipes <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> recipes.id = ingredient.recipe_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ingredients.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ingredients.id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ingredients.percent <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">20.0</span></span></code> </pre> <br> ä½†æ˜¯ä»–çš„å·¥ä½œé€Ÿåº¦æ›´å¿«ï¼Œè¿™æ˜¯è¿›ä¸€æ­¥æå‡ºè¦æ±‚çš„ç°æˆåŸºç¡€ã€‚ <br><br> åœ¨è¿™é‡Œï¼Œé™¤äº†ç™¾åˆ†æ¯”æœç´¢å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…¶ä»–å‡ ç§ç±»å‹çš„æ“ä½œï¼šæŒ‰åç§°æœç´¢é…æ–™ï¼Œç»„å’Œé…æ–¹åç§°ï¼› è€ƒè™‘åˆ°æˆåˆ†åœ¨é…æ–¹ä¸­çš„å®¹å¿åº¦ï¼Œé€šè¿‡æˆåˆ†IDæœç´¢ï¼› ç›¸åŒçš„æŸ¥è¯¢ï¼Œä½†æ˜¯åœ¨å››ä¸ªæ¡ä»¶ä¸‹è®¡ç®—äº†ç»“æœï¼ˆéšåé‡åšäº†å¦ä¸€ä¸ªä»»åŠ¡ï¼‰ï¼Œä»¥åŠæœ€ç»ˆæŸ¥è¯¢ã€‚ <br><br> è¯¥è¯·æ±‚éœ€è¦ä»¥ä¸‹é€»è¾‘ï¼šå¯¹äºæ¯ç§æˆåˆ†ï¼Œæœ‰äº”ä¸ªå°†å…¶ä¸ä»»ä½•ç»„ç›¸å…³è”çš„æ ‡ç­¾ã€‚ æŒ‰ç…§æƒ¯ä¾‹ï¼ŒçŒªè‚‰å’Œç‰›è‚‰æ˜¯è‚‰ï¼Œé¸¡è‚‰å’Œç«é¸¡æ˜¯å®¶ç¦½ã€‚ æ¯ä¸ªæ ‡ç­¾éƒ½ä½äºå…¶è‡ªå·±çš„çº§åˆ«ã€‚ åŸºäºè¿™äº›æ ‡ç­¾ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºé…æ–¹åˆ›å»ºæ¡ä»¶æè¿°ï¼Œè¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆæœç´¢æ ‘å’Œ/æˆ–æè¿°ã€‚ ä¾‹å¦‚ï¼Œé¦™è‚ è‚‰å’Œç‰›å¥¶åŠ é¦™æ–™ï¼Œè‚è„å’Œå¤§è±†ï¼Œæ¸…çœŸé¸¡è‚‰ã€‚ å•ä¸ªé…æ–¹å¯ä»¥åŒ…å«å…·æœ‰ç›¸åŒæ ‡ç­¾çš„å¤šç§æˆåˆ†ã€‚ è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æ— éœ€å†ç”¨åŒæ‰‹å¡æ»¡æ ‡ç­¾é“¾äº†-æ ¹æ®é£Ÿè°±çš„ç»„æˆï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ¸…æ¥šåœ°æè¿°å®ƒäº†ã€‚ éšé™„æ–‡æ¡£çš„ç»“æ„ä¹Ÿå·²æ›´æ”¹ï¼š <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 3"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"level_1"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"level_2"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"level_3"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"level_4"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"level_5"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> }</code> </pre> <br> è¿˜éœ€è¦æ ¹æ®é…æ–¹çš„â€œçº¯åº¦â€æ¡ä»¶æ¥æŒ‡å®šæœç´¢ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé£Ÿè°±ï¼Œå…¶ä¸­åªæœ‰ç‰›è‚‰ï¼Œç›å’Œèƒ¡æ¤’ç²‰ã€‚ ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»æ·˜æ±°ä»…åœ¨ç¬¬ä¸€å±‚ä¸Šåªæœ‰ç‰›è‚‰ï¼Œåœ¨ç¬¬äºŒå±‚ä¸Šåªæœ‰é¦™æ–™çš„é£Ÿè°±ï¼ˆé¦™æ–™çš„ç¬¬ä¸€ä¸ªæ ‡ç­¾ä¸ºé›¶ï¼‰ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä¸å¾—ä¸ä½œå¼Šï¼šç”±äºèƒ¡é¡»æ˜¯æ²¡æœ‰é€»è¾‘çš„æ¨¡æ¿ï¼Œå› æ­¤ä¸èƒ½è°ˆè®ºä»»ä½•è®¡ç®—ã€‚ æ­¤å¤„è¦æ±‚ä»¥ESè„šæœ¬è¯­è¨€-Painlessåœ¨è¯·æ±‚ä¸­å®ç°è„šæœ¬çš„ä¸€éƒ¨åˆ†ã€‚ å®ƒçš„è¯­æ³•å°½å¯èƒ½æ¥è¿‘Javaï¼Œå› æ­¤æ²¡æœ‰å›°éš¾ã€‚ ç»“æœï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªç”¨äºç”ŸæˆJSONçš„Mustacheæ¨¡æ¿ï¼Œå…¶ä¸­éƒ¨åˆ†è®¡ç®—ï¼ˆå³æ’åºå’Œè¿‡æ»¤ï¼‰æ˜¯åœ¨Painlessä¸Šå®ç°çš„ï¼š <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">"filter": [ </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#levelsList}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#levels}}</span></span><span class="xml"><span class="xml"> {"script": { "script": " int total=0; for (ingredient in params._source.ingredients){ if ([0,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{tag}}</span></span><span class="xml"><span class="xml">].contains(ingredient.level_</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{id}}</span></span><span class="xml"><span class="xml">)) total+=1; } return (total==params._source.ingredients.length); " }} </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{^isLast}}</span></span><span class="xml"><span class="xml">,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/isLast}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/levels}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/levelsList}}</span></span><span class="xml"><span class="xml"> ]</span></span></code> </pre><br> åœ¨ä¸‹æ–‡ä¸­ï¼Œè„šæœ¬ä¸»ä½“ç»è¿‡æ ¼å¼åŒ–ä»¥æé«˜å¯è¯»æ€§ï¼Œä¸èƒ½åœ¨è¯·æ±‚ä¸­ä½¿ç”¨æ¢è¡Œç¬¦ã€‚ <br><br> åˆ°é‚£æ—¶ï¼Œæˆ‘ä»¬æ¶ˆé™¤äº†å¯¹æˆåˆ†å«é‡çš„è€å—æ€§ï¼Œå‘ç°äº†ä¸€ä¸ªç“¶é¢ˆ-æˆ‘ä»¬åªèƒ½è€ƒè™‘ç‰›è‚‰é¦™è‚ ï¼Œå› ä¸ºåœ¨é‚£é‡Œæ‰¾åˆ°äº†è¿™ç§æˆåˆ†ã€‚ ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ äº†æ‰€æœ‰å†…å®¹ï¼ˆåœ¨ç›¸åŒçš„Painlessè„šæœ¬ä¸Šè¿›è¡Œäº†è¿‡æ»¤ï¼‰ï¼Œæ¡ä»¶æ˜¯è¯¥æˆåˆ†åº”åœ¨åˆæˆä¸­å ä¸»å¯¼åœ°ä½ï¼š <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">"filter": [ {"script":{ "script": " double nest=0,rest=0; for (ingredient in params._source.ingredients){ if([</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#tags}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{tagId}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{^isLast}}</span></span><span class="xml"><span class="xml">,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/isLast}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{/tags}}</span></span><span class="xml"><span class="xml">].contains(flavor.level_</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{tags.0.levelId}}</span></span><span class="xml"><span class="xml">)){ nest+= ingredient.percent; }else{ if (ingredient.percent&gt;rest){rest = ingredient.percent} } } return(nest&gt;=rest); " }} ]</span></span></code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼ŒElasticsearchåœ¨æ­¤é¡¹ç›®ä¸­ç¼ºå°‘å¾ˆå¤šä¸œè¥¿ï¼Œå› æ­¤å¿…é¡»é€šè¿‡â€œå¯ç”¨æ–¹å¼â€è¿›è¡Œç»„åˆã€‚ ä½†è¿™ä¸è¶³ä¸ºå¥‡-è¯¥é¡¹ç›®å¯¹äºç”¨äºå…¨æ–‡æœç´¢çš„æœºå™¨æ¥è¯´å·²ç»è¶³å¤Ÿéå…¸å‹äº†ã€‚ <br><br> åœ¨é¡¹ç›®çš„ä¸­é—´é˜¶æ®µä¹‹ä¸€ï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹äº‹æƒ…ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æˆåˆ†ç»„çš„åˆ—è¡¨ä»¥åŠæ¯ä¸ªç»„çš„ä½ç½®æ•°é‡ã€‚ åœ¨è¿™é‡Œï¼Œä¸æ™®éæŸ¥è¯¢ä¸­å‡ºç°çš„é—®é¢˜ç›¸åŒï¼šåœ¨10,000ä¸ªé£Ÿè°±ä¸­ï¼Œæ ¹æ®å†…å®¹ç”Ÿæˆäº†å¤§çº¦10ç»„ã€‚ ä½†æ˜¯ï¼Œè¿™äº›ç»„ä¸­æ€»å…±æœ‰å¤§çº¦40,000ç§é…æ–¹ï¼Œæ ¹æœ¬ä¸ç°å®ä¸ç¬¦ã€‚ ç„¶åï¼Œæˆ‘ä»¬å¼€å§‹ç ”ç©¶å¹¶è¡ŒæŸ¥è¯¢ã€‚ <br><br> åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ç¬¬ä¸€çº§æ‰€æœ‰ç»„çš„åˆ—è¡¨ï¼Œä½†æ²¡æœ‰æ¡ç›®æ•°é‡ã€‚ æ­¤åï¼Œäº§ç”Ÿäº†ä¸€ä¸ªå¤šé‡è¯·æ±‚ï¼šå¯¹äºæ¯ä¸ªç»„ï¼Œæ ¹æ®ç°è¡Œç™¾åˆ†æ¯”çš„åŸåˆ™ï¼Œè¦æ±‚æ¥æ”¶å®é™…é£Ÿè°±çš„æ•°é‡ã€‚ æ‰€æœ‰è¿™äº›è¯·æ±‚éƒ½æ”¶é›†åˆ°ä¸€ä¸ªä¸­ï¼Œç„¶åå‘é€åˆ°Elasticsearchã€‚ ä¸€èˆ¬è¯·æ±‚çš„å“åº”æ—¶é—´ç­‰äºæœ€æ…¢è¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚ æ‰¹é‡èšåˆå¯ä»¥å¹¶è¡ŒåŒ–å®ƒä»¬ã€‚  SQLä¸­ç±»ä¼¼çš„é€»è¾‘ï¼ˆä»…é€šè¿‡æŒ‰æŸ¥è¯¢ä¸­çš„æ¡ä»¶åˆ†ç»„ï¼‰èŠ±è´¹äº†å¤§çº¦15å€çš„æ—¶é—´ã€‚ <br><br><pre> <code class="hljs markdown">/<span class="hljs-bullet"><span class="hljs-bullet">*   *</span></span>/ $params = config('elastic.params'); $params[<span class="hljs-string"><span class="hljs-string">'body'</span></span>] = config('elastic.top_list'); return (Elastic::getClient()-&gt;search($params))[<span class="hljs-string"><span class="hljs-string">'aggregations'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">'tags'</span></span>][<span class="hljs-string"><span class="hljs-string">'buckets'</span></span>]; /<span class="hljs-bullet"><span class="hljs-bullet">*   *</span></span>/</code> </pre><br> ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è¯„ä¼°ï¼š <br><br><ol><li> å½“å‰é…æ–¹æœ‰å¤šå°‘ç§é…æ–¹å¯ç”¨ï¼› </li><li> æˆ‘ä»¬è¿˜å¯ä»¥å‘ç»„åˆç‰©ä¸­æ·»åŠ å“ªäº›å…¶ä»–æˆåˆ†ï¼ˆæœ‰æ—¶æˆ‘ä»¬æ·»åŠ äº†æˆåˆ†å¹¶å¾—åˆ°äº†ä¸€ä¸ªç©ºæ ·å“ï¼‰ï¼› </li><li> åœ¨æ­¤çº§åˆ«ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€é€‰æˆåˆ†ä¸­çš„å“ªäº›æˆåˆ†æ ‡è®°ä¸ºå”¯ä¸€ã€‚ </li></ol><br> æ ¹æ®ä»»åŠ¡ï¼Œæˆ‘ä»¬ç»“åˆäº†æ”¶åˆ°çš„é’ˆå¯¹é…æ–¹åˆ—è¡¨çš„æœ€åä¸€ä¸ªè¯·æ±‚çš„é€»è¾‘å’Œä»æ‰€æœ‰å¯ç”¨ç»„çš„åˆ—è¡¨ä¸­è·å–ç¡®åˆ‡ç¼–å·çš„é€»è¾‘ï¼š <br><br><pre> <code class="hljs smalltalk">/*  */ <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span> : { //      <span class="hljs-comment"><span class="hljs-comment">"tags"</span></span> :{ //    <span class="hljs-comment"><span class="hljs-comment">"terms"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"field"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ingredients.level_{{ level }}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"order"</span></span> : {<span class="hljs-comment"><span class="hljs-comment">"_term"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"asc"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">"exclude"</span></span> : [ {{<span class="hljs-symbol"><span class="hljs-symbol">#exclude</span></span>}}{{ id }},{{/exclude}} <span class="hljs-number"><span class="hljs-number">0</span></span>] }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"reverse_nested"</span></span>: {} } //    ,    } } /*   */ foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>ot_only as <span class="hljs-string"><span class="hljs-string">$e</span></span>lement) { <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = config(<span class="hljs-string"><span class="hljs-string">'elastic.params'</span></span>); <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = self::getParamsBody( <span class="hljs-string"><span class="hljs-string">$b</span></span>ody, collect(<span class="hljs-string"><span class="hljs-string">$o</span></span>nly-&gt;all())-&gt;push(<span class="hljs-string"><span class="hljs-string">$e</span></span>lement), <span class="hljs-string"><span class="hljs-string">$m</span></span>ax_level, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ); } /*   */ <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = config(<span class="hljs-string"><span class="hljs-string">'elastic.params'</span></span>); <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = self::getParamsBody( <span class="hljs-string"><span class="hljs-string">$b</span></span>ody, <span class="hljs-string"><span class="hljs-string">$o</span></span>nly, <span class="hljs-string"><span class="hljs-string">$m</span></span>ax_level, <span class="hljs-string"><span class="hljs-string">$f</span></span>rom, <span class="hljs-string"><span class="hljs-string">$s</span></span>ize<span class="hljs-string"><span class="hljs-string">') ); /*     */ $parameters['</span></span>max_concurrent_searches<span class="hljs-string"><span class="hljs-string">'] = 1 + $not_only-&gt;count(); return (Elastic::getClient()-&gt;msearchTemplate($parameters))['</span></span>responses<span class="hljs-string"><span class="hljs-string">'];</span></span></code> </pre> <br> ç»“æœï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ï¼Œè¯¥è¯·æ±‚æŸ¥æ‰¾äº†æ‰€æœ‰å¿…è¦çš„é£Ÿè°±åŠå…¶æ€»æ•°ï¼ˆå–è‡ªå“åº”[â€œ hitsâ€] [â€œ totalâ€]ï¼‰ã€‚ ä¸ºç®€å•èµ·è§ï¼Œæ­¤è¯·æ±‚è®°å½•åœ¨åˆ—è¡¨çš„æœ€åä½ç½®ã€‚ <br><br> æ­¤å¤–ï¼Œé€šè¿‡æ±‡æ€»ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä¸‹ä¸€ä¸ªçº§åˆ«çš„æ‰€æœ‰IDæˆåˆ†ã€‚ å¯¹äºæœªæ ‡è®°ä¸ºâ€œå”¯ä¸€â€çš„æ¯ç§æˆåˆ†ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæŸ¥è¯¢ï¼Œåœ¨å…¶ä¸­è¿›è¡Œäº†ç›¸åº”çš„æ ‡è®°ï¼Œç„¶åç®€å•åœ°è®¡ç®—äº†æ‰¾åˆ°çš„æ–‡æ¡£æ•°ã€‚ å¦‚æœå®ƒå¤§äºé›¶ï¼Œåˆ™è®¤ä¸ºè¯¥æˆåˆ†å¯ç”¨äºåˆ†é…é”®â€œå•â€ã€‚ æˆ‘è®¤ä¸ºæ‚¨å¯ä»¥åœ¨æ²¡æœ‰æˆ‘çš„æƒ…å†µä¸‹è¿˜åŸæ•´ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä»¬åœ¨è¾“å‡ºä¸­å¾—åˆ°äº†ï¼š <br><br><pre> <code class="hljs smalltalk">{ <span class="hljs-comment"><span class="hljs-comment">"from"</span></span>: {{ from }}, <span class="hljs-comment"><span class="hljs-comment">"size"</span></span>: {{ size }}, <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"must"</span></span>: [ {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredientTags</span></span>}} {{<span class="hljs-symbol"><span class="hljs-symbol">#tagList</span></span>}} {<span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"term"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"level_{{ levelId }}"</span></span>: {{ tagId }} }} ] }} {{^isLast}},{{/isLast}} {{/tagList}} {{/ingredientTags}} ], <span class="hljs-comment"><span class="hljs-comment">"filter"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"script"</span></span>:{ <span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: <span class="hljs-comment"><span class="hljs-comment">" double nest=0,rest=0; for(ingredient in params._source. ingredients){ if([{{#tags}}{{tagId}}{{^isLast}},{{/isLast}}{{/tags}}].contains(ingredient.level_{{tags.0.levelId}})){ nest+= ingredient.percent; }else{ if (ingredient.percent&gt;rest){ rest= ingredient.percent } } } return(nest&gt;=rest); "</span></span> }} {{<span class="hljs-symbol"><span class="hljs-symbol">#levelsList</span></span>}}, {{<span class="hljs-symbol"><span class="hljs-symbol">#levels</span></span>}} {<span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: <span class="hljs-comment"><span class="hljs-comment">" int total=0; for(ingredient in params._source.ingredients){ if ([0,{{tag}}].contains(ingredient.level_{{id}})) total+=1; } return (total==params._source.ingredients.length); "</span></span> }} {{^isLast}},{{/isLast}} {{/levels}} {{/levelsList}} ] } }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"tags"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"terms"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"field"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ingredients.level_{{ level }}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"order"</span></span> : {<span class="hljs-comment"><span class="hljs-comment">"_term"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"asc"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">"exclude"</span></span> : [ {{<span class="hljs-symbol"><span class="hljs-symbol">#exclude</span></span>}}{{ id }},{{/exclude}} <span class="hljs-number"><span class="hljs-number">0</span></span>] }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"reverse_nested"</span></span>: {} } } }, <span class="hljs-comment"><span class="hljs-comment">"sort"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"_score"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"order"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"desc"</span></span>}} ] }</code> </pre><br> å½“ç„¶ï¼Œæˆ‘ä»¬ç¼“å­˜äº†ä¸€éƒ¨åˆ†æ¨¡æ¿å’ŒæŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰å¯ç”¨ç»„çš„é¡µé¢ä»¥åŠå¯ç”¨é…æ–¹çš„æ•°é‡ï¼‰ï¼Œè¿™åœ¨ä¸»é¡µä¸Šå¢åŠ äº†ä¸€äº›æ€§èƒ½ã€‚ è¿™ä¸€å†³å®šä½¿å¾—å¯ä»¥åœ¨50æ¯«ç§’å†…æ”¶é›†ä¸»è¦æ•°æ®ã€‚ <br><br>  <b>é¡¹ç›®æˆæœ</b> <br><br> æˆ‘ä»¬åœ¨Elasticsearchçš„æ•°æ®åº“ä¸­è¿›è¡Œäº†è‡³å°‘50,000ä¸ªæ–‡æ¡£çš„æœç´¢ï¼Œä½¿æ‚¨å¯ä»¥æœç´¢äº§å“ä¸­çš„æˆåˆ†ï¼Œå¹¶é€šè¿‡å…¶ä¸­åŒ…å«çš„æˆåˆ†è·å¾—äº§å“çš„æè¿°ã€‚ å¾ˆå¿«è¯¥æ•°æ®åº“å°†å¢é•¿å¤§çº¦å…­å€ï¼ˆæ­£åœ¨å‡†å¤‡æ•°æ®ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„ç»“æœä»¥åŠå°†Elasticsearchç”¨ä½œæœç´¢å·¥å…·æ„Ÿåˆ°éå¸¸æ»¡æ„ã€‚ <br><br> åœ¨æ€§èƒ½é—®é¢˜ä¸Šï¼Œæˆ‘ä»¬æ»¡è¶³äº†é¡¹ç›®çš„è¦æ±‚ï¼Œæˆ‘ä»¬è‡ªå·±å¾ˆé«˜å…´å¯¹è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´ä¸º250-300æ¯«ç§’ã€‚ <br><br> åœ¨å¼€å§‹ä½¿ç”¨Elasticsearchçš„ä¸‰ä¸ªæœˆåï¼Œå®ƒä¼¼ä¹ä¸å†é‚£ä¹ˆä»¤äººå›°æƒ‘å’Œå¼‚å¸¸ã€‚ æ¨¡æ¿çš„ä¼˜åŠ¿éå¸¸æ˜æ˜¾ï¼šå¦‚æœæˆ‘ä»¬å‘ç°è¯·æ±‚å†æ¬¡å˜å¾—å¤ªå¤§ï¼Œæˆ‘ä»¬åªéœ€å°†é™„åŠ é€»è¾‘è½¬ç§»åˆ°æ¨¡æ¿ï¼Œç„¶åå°†åŸå§‹è¯·æ±‚å†æ¬¡å‘é€åˆ°æœåŠ¡å™¨ï¼Œå‡ ä¹æ²¡æœ‰ä»»ä½•æ›´æ”¹ã€‚ <br><br>  â€œä¸‡äº‹å¦‚æ„ï¼Œè°¢è°¢ä½ çš„é±¼ï¼â€  ï¼ˆcï¼‰ <br><br>  <b>PS</b>æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŒ‰åç§°ä¸­çš„ä¿„è¯­å­—ç¬¦è¿›è¡Œæ’åºã€‚ ç„¶åäº‹å®è¯æ˜ï¼ŒElasticsearchæ— æ³•å……åˆ†ç†è§£ä¿„è¯­å­—æ¯ã€‚ æœ‰æ¡ä»¶çš„é¦™è‚ â€œè¶…å¤§çŒªè‚‰9000å¡è·¯é‡Œâ€åœ¨åˆ†ç±»å†…éƒ¨å˜æˆäº†â€œ 9000â€ï¼Œæ’åœ¨æœ€åã€‚ äº‹å®è¯æ˜ï¼Œé€šè¿‡å°†ä¿„è¯­å­—ç¬¦è½¬æ¢ä¸ºu042Bå½¢å¼çš„unicodeè¡¨ç¤ºæ³•ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°è§£å†³æ­¤é—®é¢˜ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN413075/">https://habr.com/ru/post/zh-CN413075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN413063/index.html">åœ¨ç›¸å˜ä¸­æµ‹è¯•è‡ªåˆ¶ä¿æ¸©æ¯</a></li>
<li><a href="../zh-CN413065/index.html">Cï¼ƒ8.0ä¸­è®¡åˆ’çš„æ–°åŠŸèƒ½</a></li>
<li><a href="../zh-CN413069/index.html">éŸ³é¢‘æœç´¢ï¼ŒéŸ³é¢‘SEOå’Œæ’­å®¢å¸®åŠ©-å·²å¼€å§‹ä½¿ç”¨Googleä¸“å®¶</a></li>
<li><a href="../zh-CN413071/index.html">DeepMindæ•™AIç©YouTubeè§†é¢‘æ¸¸æˆ</a></li>
<li><a href="../zh-CN413073/index.html">å¦‚ä½•ä½¿ç”¨äº‘ï¼šå…³äºPDï¼ŒISå’ŒIaaSçš„30ç§ææ–™ï¼Œå®ç”¨æŒ‡å—å’ŒæŠ€å·§</a></li>
<li><a href="../zh-CN413077/index.html">255å·ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ5æœˆ28æ—¥è‡³6æœˆ3æ—¥ï¼‰</a></li>
<li><a href="../zh-CN413083/index.html">éº»çœç†å·¥å­¦é™¢çš„å¼€å‘äººå‘˜åˆ›å»ºäº†å…·æœ‰ç²¾ç¡®åŠ¨ä½œåè°ƒæ€§çš„ä»¿ç”Ÿå‡ä½“</a></li>
<li><a href="../zh-CN413087/index.html">ç”·å­æ±½è½¦åŠ©æ‰‹</a></li>
<li><a href="../zh-CN413091/index.html">åœ¨SpringBoot + Log4j2 + Mavenä¸­æ–¹ä¾¿åœ°è®°å½•æ—¥å¿—</a></li>
<li><a href="../zh-CN413093/index.html">é¢„æœŸç¾å›½å’Œä¸­å›½çš„å¤ªç©ºå•†äººç«èµ›</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>