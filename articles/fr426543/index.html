<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëé üë©üèº‚Äçüöí üè© Sauvegardes avec √©tat dans Kubernetes üèôÔ∏è üëâüèº üëáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ainsi, comme tout le monde le sait, plus r√©cemment, DevOpsConfRussia2018 s'est tenue √† Moscou dans ¬´Infraspace¬ª les 1er et 2 octobre. Pour ceux qui ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegardes avec √©tat dans Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/426543/"><p>  Ainsi, comme tout le monde le sait, plus r√©cemment, <b>DevOpsConfRussia2018</b> s'est tenue √† Moscou dans ¬´Infraspace¬ª les 1er et 2 octobre.  Pour ceux qui ne sont pas √† l' <b>aise</b> , <b>DevOpsConf</b> est une conf√©rence professionnelle sur l'int√©gration des processus de d√©veloppement, de test et d'exploitation. </p><br><p>  Notre entreprise a √©galement particip√© √† cette conf√©rence.  Nous √©tions ses partenaires, repr√©sentant l'entreprise sur notre stand, et avons √©galement tenu une petite r√©union.  Au fait, c'√©tait notre premi√®re participation √† ce genre d'activit√©.  La premi√®re conf√©rence, le premier mitap, la premi√®re exp√©rience. </p><br><p>  De quoi parlions-nous?  Mitap √©tait sur le sujet ¬´Sauvegardes dans Kubernetes¬ª. </p><br><p>  Tr√®s probablement, en entendant ce nom, beaucoup diront: ¬´Pourquoi revenir sur Kubernetes?  Il n'a pas besoin d'√™tre sauvegard√©, il est apatride. ¬ª </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Pr√©sentation ... </h3><br><p>  Commen√ßons par un petit historique.  Pourquoi est-il devenu n√©cessaire de couvrir ce sujet et pourquoi il est n√©cessaire. </p><br><p>  En 2016, nous nous sommes familiaris√©s avec une technologie telle que Kubernetes et avons commenc√© √† l'appliquer activement √† nos projets.  Bien s√ªr, il s'agit principalement de projets avec une architecture de microservices, ce qui implique √† son tour l'utilisation d'un grand nombre de logiciels divers. </p><br><p>  Avec le premier projet o√π nous avons utilis√© Kubernetes, nous avions une question sur la fa√ßon de sauvegarder les services Stateful qui s'y trouvent, qui parfois pour une raison ou une autre tombent dans les k8. </p><br><p>  Nous avons commenc√© √† √©tudier et rechercher des pratiques existantes pour r√©soudre ce probl√®me.  Communiquez avec nos coll√®gues et camarades: "Et comment ce processus est-il men√© et construit par eux?" </p><br><p>  Apr√®s avoir parl√©, nous avons r√©alis√© que tout cela se produit par diff√©rentes m√©thodes, moyens et avec un grand nombre de b√©quilles.  Cependant, nous n'avons suivi aucune approche unifi√©e, m√™me <u>dans le cadre d'un projet</u> . </p><br><p>  Pourquoi est-ce si important?  Puisque nos projets de services d'entreprise bas√©s sur k8s, nous avions juste besoin de d√©velopper une m√©thodologie structur√©e pour r√©soudre ce probl√®me. </p><br><p>  Imaginez que vous travaillez avec un projet sp√©cifique dans Coober.  Il contient certains services avec √©tat et vous devez sauvegarder leurs donn√©es.  En principe, ici, vous pouvez faire quelques b√©quilles et l'oublier.  Mais que faire si vous avez d√©j√† deux projets sur k8?  Et le deuxi√®me projet utilise des services compl√®tement diff√©rents dans son travail.  Et s'il y a d√©j√† cinq projets?  Dix?  Ou plus de vingt? </p><br><p>  Bien s√ªr, mettre des b√©quilles est d√©j√† difficile et peu pratique.  Nous avons besoin d'une sorte d'approche unifi√©e qui pourrait √™tre utilis√©e lorsque nous travaillons avec de nombreux projets √† Cuba, et en m√™me temps, afin que l'√©quipe d'ing√©nieurs puisse facilement et litt√©ralement en quelques minutes apporter les modifications n√©cessaires aux sauvegardes de ces projets. </p><br><p>  Dans le cadre de cet article, nous allons simplement parler de quel outil et quelle pratique nous utilisons pour r√©soudre ce probl√®me au sein de notre entreprise. </p><br><h3>  Comment on fait √ßa? </h3><br><h6>  Nxs-backup c'est quoi? </h6><br><p>  Pour les sauvegardes, nous utilisons notre propre outil open source - nxs-backup.  Nous n'entrerons pas dans les d√©tails de ce qu'il peut.  Plus de d√©tails peuvent √™tre trouv√©s sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> suivant. </p><br><p>  Passons maintenant √† l'impl√©mentation des sauvegardes dans k8s.  Comment et ce que nous avons fait exactement. </p><br>
<h3>  Qu'est-ce que la sauvegarde? </h3><br><p>  Regardons un exemple de sauvegarde de notre propre Redmine.  Dans ce document, nous allons sauvegarder la base de donn√©es MySQL et les fichiers de projet utilisateur. </p><br><h3>  Comment fait-on cela? </h3><br><h6>  1 CronJob == 1 service </h6><br><p>  Sur les serveurs ordinaires et les clusters sur le mat√©riel, presque tous les outils de sauvegarde sont principalement lanc√©s via cron standard.  Dans k8s, √† cette fin, nous utilisons CronJob, c'est-√†-dire que nous cr√©ons 1 CronJob pour 1 service, que nous sauvegardons.  Tous ces CronJob sont situ√©s dans le m√™me espace de noms que le service lui-m√™me. </p><br><p>  Commen√ßons par la base de donn√©es MySQL.  Pour sauvegarder MySQL, nous avons besoin de 4 √©l√©ments, comme pour presque tous les autres services: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf pour nxs-backup) </li><li>  Secret (les acc√®s au service sont stock√©s ici, dans ce cas MySQL).  Habituellement, cet √©l√©ment est d√©j√† d√©fini pour que le service fonctionne et peut √™tre r√©utilis√©. </li><li>  CronJob (pour chaque service qui lui est propre) </li></ul><br><p>  Allons dans l'ordre. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Ici, nous d√©finissons les param√®tres de base qui sont pass√©s √† notre outil, qui sont n√©cessaires √† son fonctionnement.  Il s'agit du nom du serveur, de l'e-mail pour les notifications, de la restriction de la consommation des ressources et d'autres param√®tres. </p><br><p>  Les configurations peuvent √™tre sp√©cifi√©es au format j2, ce qui permet l'utilisation de variables d'environnement. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Ce fichier d√©crit la logique de sauvegarde du service correspondant, dans notre cas c'est MySQL. </p><br><p>  Ici vous pouvez sp√©cifier: </p><br><ul><li>  Quel est le nom du travail (champ: travail) </li><li>  Type d'emploi (champ: type) </li><li>  Le r√©pertoire temporaire n√©cessaire pour collecter les sauvegardes (champ: tmp_dir) </li><li>  Options de connexion MySQL (champ: connect) </li><li>  Base de donn√©es √† sauvegarder (champ: cible) </li><li>  Besoin d'arr√™ter Slave avant de collecter (champ: is_slave) </li><li>  Cl√©s suppl√©mentaires pour mysqldump (champ: extra_keys) </li><li>  Stockage Stockage, c'est-√†-dire dans quel stockage nous allons stocker une copie (champ: stockage) </li><li>  Le r√©pertoire o√π nous allons stocker nos copies (champ: backup_dir) </li><li>  Sch√©ma de stockage (champ: magasin) </li></ul><br><p>  Dans notre exemple, le type de stockage est d√©fini sur local, c'est-√†-dire que nous collectons et stockons les sauvegardes localement dans un r√©pertoire sp√©cifique du pod lanc√©. </p><br><p>  Ici, par analogie avec ce fichier de configuration, vous pouvez sp√©cifier les m√™mes fichiers de configuration pour Redis, PostgreSQL ou tout autre service n√©cessaire, s'il est pris en charge par notre outil.  Le fait qu'il supporte se trouve sur le lien donn√© plus haut. </p><br><h6>  MySQL secret </h6><br><pre> <code class="hljs powershell">apiVersion: v1 kind: Secret metadata: name: app<span class="hljs-literal"><span class="hljs-literal">-config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  Nous gardons un acc√®s secret pour nous connecter √† MySQL lui-m√™me et au serveur de messagerie.  Ils peuvent √™tre stock√©s dans un secret s√©par√©, ou profiter de celui qui existe, bien s√ªr, s'il y en a un.  Rien d'int√©ressant ici.  Notre secret contient √©galement le secret_token, qui est n√©cessaire au fonctionnement de notre Redmine. </p><br><h6>  CronJob MySQL </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Cet √©l√©ment est peut-√™tre le plus int√©ressant.  Premi√®rement, afin de compiler le bon CronJob, vous devez d√©terminer o√π les sauvegardes collect√©es seront stock√©es. </p><br><p>  Pour cela, nous avons un serveur s√©par√© avec le nombre de ressources n√©cessaires.  Dans l'exemple, un n≈ìud de cluster distinct, nxs-node5, est allou√© pour collecter les sauvegardes.  La restriction sur le d√©marrage de CronJob sur les n≈ìuds dont nous avons besoin est d√©finie par la directive nodeAffinity. </p><br><p>  Lorsque CronJob d√©marre, le r√©pertoire correspondant lui est connect√© via hostPath √† partir du syst√®me h√¥te, qui est utilis√© pour stocker des copies de sauvegarde. </p><br><p>  Ensuite, ConfigMaps est connect√© au CronJob sp√©cifique, contenant la configuration pour nxs-backup, √† savoir les fichiers nxs-backup.conf et mysql.conf dont nous venons de parler ci-dessus. </p><br><p>  Ensuite, toutes les variables d'environnement n√©cessaires sont d√©finies, qui sont d√©finies directement dans le manifeste ou extraites de Secret'ov. </p><br><p>  Ainsi, les variables sont transf√©r√©es dans le conteneur et, via docker-entrypoint.sh, sont remplac√©es dans ConfigMaps aux endroits dont nous avons besoin avec les valeurs n√©cessaires.  Pour MySQL, il s'agit de db_host, db_user, db_password.  Dans ce cas, nous transmettons le port simplement comme une valeur dans le manifeste du CronJob, car il ne contient aucune information pr√©cieuse. </p><br><p>  Eh bien, avec MySQL, tout semble clair.  Voyons maintenant ce qui est n√©cessaire pour sauvegarder les fichiers d'application Redmine. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Il s'agit d'un fichier de configuration qui d√©crit la logique de sauvegarde des fichiers.  Il n'y a rien d'inhabituel ici non plus, tous les m√™mes param√®tres sont d√©finis comme pour MySQL, √† l'exception des donn√©es d'autorisation, car ils ne le sont tout simplement pas.  Bien qu'ils puissent l'√™tre, si des protocoles de transfert de donn√©es sont impliqu√©s: ssh, ftp, webdav, s3 et autres.  Nous consid√©rerons cette option un peu plus tard. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Rien de nouveau non plus concernant MySQL.  Mais ici, un PV suppl√©mentaire (target-dir) est mont√©, que nous allons sauvegarder - / var / www / files.  Sinon, tout est pareil, nous stockons des copies localement sur le n≈ìud dont nous avons besoin, pour lequel CronJob est affect√©. </p><br><h6>  R√©sum√© </h6><br><p>  Pour chaque service que nous voulons sauvegarder, nous cr√©ons un CronJob s√©par√© avec tous les √©l√©ments connexes n√©cessaires: ConfigMaps et Secrets.  Par analogie avec les exemples consid√©r√©s, nous pouvons sauvegarder tout service similaire dans le cluster. </p><br><p>  Je pense que, sur la base de ces deux exemples, tout le monde a une id√©e de la fa√ßon dont nous sauvegardons les services d'√âtat √† Cuba.  Je pense que cela n'a aucun sens d'analyser en d√©tail les m√™mes exemples pour d'autres services, car, fondamentalement, ils se ressemblent tous et pr√©sentent de l√©g√®res diff√©rences. </p><br><p>  En fait, c'est ce que nous voulions atteindre, √† savoir une sorte d' <u>approche unifi√©e</u> pour la construction du processus de sauvegarde.  Et pour que cette approche puisse √™tre appliqu√©e √† un grand nombre de projets diff√©rents bas√©s sur k8s. </p><br><h3>  O√π le stockons-nous? </h3><br><p>  Dans tous les exemples d√©crits ci-dessus, nous stockons des copies dans le r√©pertoire local du n≈ìud sur lequel le conteneur s'ex√©cute.  Mais personne ne se soucie de connecter le volume persistant en tant que stockage externe fonctionnel et d'y collecter des copies.  Ou vous pouvez uniquement les synchroniser avec un magasin distant en utilisant le protocole souhait√© sans enregistrer localement.  Autrement dit, il existe de nombreuses variantes.  Collectez d'abord localement, puis synchronisez.  Ou pour collecter et stocker uniquement sur un stockage distant, etc.  La configuration est assez flexible. </p><br><h6>  mysql.conf + s3 </h6><br><p>  Ce qui suit est un exemple du fichier de configuration de sauvegarde MySQL, o√π les copies sont stock√©es localement sur le n≈ìud o√π CronJob est ex√©cut√©, et √©galement synchronis√©es dans s3. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Autrement dit, s'il ne suffit pas de stocker des copies localement, vous pouvez les synchroniser avec n'importe quel stockage distant √† l'aide du protocole appropri√©.  Le nombre de stockage pour le stockage peut √™tre quelconque. </p><br><p>  Mais dans ce cas, vous devez encore apporter quelques modifications suppl√©mentaires, √† savoir: </p><br><ul><li>  Connectez le ConfigMap appropri√© avec le contenu n√©cessaire pour l'autorisation avec AWS S3, au format j2 </li><li>  Cr√©er un secret appropri√© pour stocker les acc√®s d'autorisation </li><li>  D√©finissez les variables d'environnement n√©cessaires tir√©es de Secret ci-dessus </li><li>  Ajustez docker-entrypoint.sh pour remplacer les variables correspondantes dans ConfigMap </li><li>  Reconstruisez l'image Docker, en ajoutant des utilitaires pour travailler avec AWS S3 </li></ul><br><p>  Bien que ce processus soit loin d'√™tre parfait, nous y travaillons.  Par cons√©quent, dans un proche avenir, nous ajouterons √† nxs-backup la possibilit√© de d√©finir des param√®tres dans le fichier de configuration √† l'aide de variables d'environnement, ce qui simplifiera consid√©rablement le travail avec le fichier de point d'entr√©e et minimisera le temps consacr√© √† l'ajout de la prise en charge de la sauvegarde de nouveaux services. </p><br><h3>  Conclusion </h3><br><p>  C'est probablement tout. </p><br><p>  L'utilisation de l'approche dont nous venons de parler, tout d'abord, nous permet de structurer et de sauvegarder des services de projet Stateful sur k8s.  Autrement dit, il s'agit d'une solution toute faite et, surtout, de la pratique que vous pouvez appliquer dans vos projets, sans perdre de temps et d'efforts √† rechercher et √† affiner les solutions open source existantes. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426543/">https://habr.com/ru/post/fr426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426527/index.html">Bon outstuff, mauvais outstuff</a></li>
<li><a href="../fr426531/index.html">Dell G3 15 (3579): un ordinateur portable de jeu pour un budget minimal</a></li>
<li><a href="../fr426533/index.html">Noise Security Bit episode 0x21 (Fiction et r√©alit√©: portes d√©rob√©es dans le mat√©riel et le firmware)</a></li>
<li><a href="../fr426537/index.html">Le livre "App from scratch"</a></li>
<li><a href="../fr426541/index.html">Paul Allen, co-fondateur de Microsoft, est d√©c√©d√© √† l'√¢ge de 65 ans</a></li>
<li><a href="../fr426545/index.html">Bonus Joker 2018: streaming en ligne gratuit, bofs, f√™te et table</a></li>
<li><a href="../fr426547/index.html">Alors que le cr√©ateur d'Android tente de sortir le premier "anti-smartphone"</a></li>
<li><a href="../fr426549/index.html">Un nouveau type de logiciel pour les chefs de produit</a></li>
<li><a href="../fr426551/index.html">Trekz Air - comment les √©couteurs √† conduction osseuse sonnent r√©ellement</a></li>
<li><a href="../fr426553/index.html">Banni√®res publicitaires dans l'application iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>