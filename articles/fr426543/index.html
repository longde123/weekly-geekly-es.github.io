<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👎 👩🏼‍🚒 🏩 Sauvegardes avec état dans Kubernetes 🏙️ 👉🏼 👇🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ainsi, comme tout le monde le sait, plus récemment, DevOpsConfRussia2018 s'est tenue à Moscou dans «Infraspace» les 1er et 2 octobre. Pour ceux qui ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegardes avec état dans Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/426543/"><p>  Ainsi, comme tout le monde le sait, plus récemment, <b>DevOpsConfRussia2018</b> s'est tenue à Moscou dans «Infraspace» les 1er et 2 octobre.  Pour ceux qui ne sont pas à l' <b>aise</b> , <b>DevOpsConf</b> est une conférence professionnelle sur l'intégration des processus de développement, de test et d'exploitation. </p><br><p>  Notre entreprise a également participé à cette conférence.  Nous étions ses partenaires, représentant l'entreprise sur notre stand, et avons également tenu une petite réunion.  Au fait, c'était notre première participation à ce genre d'activité.  La première conférence, le premier mitap, la première expérience. </p><br><p>  De quoi parlions-nous?  Mitap était sur le sujet «Sauvegardes dans Kubernetes». </p><br><p>  Très probablement, en entendant ce nom, beaucoup diront: «Pourquoi revenir sur Kubernetes?  Il n'a pas besoin d'être sauvegardé, il est apatride. » </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Présentation ... </h3><br><p>  Commençons par un petit historique.  Pourquoi est-il devenu nécessaire de couvrir ce sujet et pourquoi il est nécessaire. </p><br><p>  En 2016, nous nous sommes familiarisés avec une technologie telle que Kubernetes et avons commencé à l'appliquer activement à nos projets.  Bien sûr, il s'agit principalement de projets avec une architecture de microservices, ce qui implique à son tour l'utilisation d'un grand nombre de logiciels divers. </p><br><p>  Avec le premier projet où nous avons utilisé Kubernetes, nous avions une question sur la façon de sauvegarder les services Stateful qui s'y trouvent, qui parfois pour une raison ou une autre tombent dans les k8. </p><br><p>  Nous avons commencé à étudier et rechercher des pratiques existantes pour résoudre ce problème.  Communiquez avec nos collègues et camarades: "Et comment ce processus est-il mené et construit par eux?" </p><br><p>  Après avoir parlé, nous avons réalisé que tout cela se produit par différentes méthodes, moyens et avec un grand nombre de béquilles.  Cependant, nous n'avons suivi aucune approche unifiée, même <u>dans le cadre d'un projet</u> . </p><br><p>  Pourquoi est-ce si important?  Puisque nos projets de services d'entreprise basés sur k8s, nous avions juste besoin de développer une méthodologie structurée pour résoudre ce problème. </p><br><p>  Imaginez que vous travaillez avec un projet spécifique dans Coober.  Il contient certains services avec état et vous devez sauvegarder leurs données.  En principe, ici, vous pouvez faire quelques béquilles et l'oublier.  Mais que faire si vous avez déjà deux projets sur k8?  Et le deuxième projet utilise des services complètement différents dans son travail.  Et s'il y a déjà cinq projets?  Dix?  Ou plus de vingt? </p><br><p>  Bien sûr, mettre des béquilles est déjà difficile et peu pratique.  Nous avons besoin d'une sorte d'approche unifiée qui pourrait être utilisée lorsque nous travaillons avec de nombreux projets à Cuba, et en même temps, afin que l'équipe d'ingénieurs puisse facilement et littéralement en quelques minutes apporter les modifications nécessaires aux sauvegardes de ces projets. </p><br><p>  Dans le cadre de cet article, nous allons simplement parler de quel outil et quelle pratique nous utilisons pour résoudre ce problème au sein de notre entreprise. </p><br><h3>  Comment on fait ça? </h3><br><h6>  Nxs-backup c'est quoi? </h6><br><p>  Pour les sauvegardes, nous utilisons notre propre outil open source - nxs-backup.  Nous n'entrerons pas dans les détails de ce qu'il peut.  Plus de détails peuvent être trouvés sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> suivant. </p><br><p>  Passons maintenant à l'implémentation des sauvegardes dans k8s.  Comment et ce que nous avons fait exactement. </p><br>
<h3>  Qu'est-ce que la sauvegarde? </h3><br><p>  Regardons un exemple de sauvegarde de notre propre Redmine.  Dans ce document, nous allons sauvegarder la base de données MySQL et les fichiers de projet utilisateur. </p><br><h3>  Comment fait-on cela? </h3><br><h6>  1 CronJob == 1 service </h6><br><p>  Sur les serveurs ordinaires et les clusters sur le matériel, presque tous les outils de sauvegarde sont principalement lancés via cron standard.  Dans k8s, à cette fin, nous utilisons CronJob, c'est-à-dire que nous créons 1 CronJob pour 1 service, que nous sauvegardons.  Tous ces CronJob sont situés dans le même espace de noms que le service lui-même. </p><br><p>  Commençons par la base de données MySQL.  Pour sauvegarder MySQL, nous avons besoin de 4 éléments, comme pour presque tous les autres services: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf pour nxs-backup) </li><li>  Secret (les accès au service sont stockés ici, dans ce cas MySQL).  Habituellement, cet élément est déjà défini pour que le service fonctionne et peut être réutilisé. </li><li>  CronJob (pour chaque service qui lui est propre) </li></ul><br><p>  Allons dans l'ordre. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Ici, nous définissons les paramètres de base qui sont passés à notre outil, qui sont nécessaires à son fonctionnement.  Il s'agit du nom du serveur, de l'e-mail pour les notifications, de la restriction de la consommation des ressources et d'autres paramètres. </p><br><p>  Les configurations peuvent être spécifiées au format j2, ce qui permet l'utilisation de variables d'environnement. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Ce fichier décrit la logique de sauvegarde du service correspondant, dans notre cas c'est MySQL. </p><br><p>  Ici vous pouvez spécifier: </p><br><ul><li>  Quel est le nom du travail (champ: travail) </li><li>  Type d'emploi (champ: type) </li><li>  Le répertoire temporaire nécessaire pour collecter les sauvegardes (champ: tmp_dir) </li><li>  Options de connexion MySQL (champ: connect) </li><li>  Base de données à sauvegarder (champ: cible) </li><li>  Besoin d'arrêter Slave avant de collecter (champ: is_slave) </li><li>  Clés supplémentaires pour mysqldump (champ: extra_keys) </li><li>  Stockage Stockage, c'est-à-dire dans quel stockage nous allons stocker une copie (champ: stockage) </li><li>  Le répertoire où nous allons stocker nos copies (champ: backup_dir) </li><li>  Schéma de stockage (champ: magasin) </li></ul><br><p>  Dans notre exemple, le type de stockage est défini sur local, c'est-à-dire que nous collectons et stockons les sauvegardes localement dans un répertoire spécifique du pod lancé. </p><br><p>  Ici, par analogie avec ce fichier de configuration, vous pouvez spécifier les mêmes fichiers de configuration pour Redis, PostgreSQL ou tout autre service nécessaire, s'il est pris en charge par notre outil.  Le fait qu'il supporte se trouve sur le lien donné plus haut. </p><br><h6>  MySQL secret </h6><br><pre> <code class="hljs powershell">apiVersion: v1 kind: Secret metadata: name: app<span class="hljs-literal"><span class="hljs-literal">-config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  Nous gardons un accès secret pour nous connecter à MySQL lui-même et au serveur de messagerie.  Ils peuvent être stockés dans un secret séparé, ou profiter de celui qui existe, bien sûr, s'il y en a un.  Rien d'intéressant ici.  Notre secret contient également le secret_token, qui est nécessaire au fonctionnement de notre Redmine. </p><br><h6>  CronJob MySQL </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Cet élément est peut-être le plus intéressant.  Premièrement, afin de compiler le bon CronJob, vous devez déterminer où les sauvegardes collectées seront stockées. </p><br><p>  Pour cela, nous avons un serveur séparé avec le nombre de ressources nécessaires.  Dans l'exemple, un nœud de cluster distinct, nxs-node5, est alloué pour collecter les sauvegardes.  La restriction sur le démarrage de CronJob sur les nœuds dont nous avons besoin est définie par la directive nodeAffinity. </p><br><p>  Lorsque CronJob démarre, le répertoire correspondant lui est connecté via hostPath à partir du système hôte, qui est utilisé pour stocker des copies de sauvegarde. </p><br><p>  Ensuite, ConfigMaps est connecté au CronJob spécifique, contenant la configuration pour nxs-backup, à savoir les fichiers nxs-backup.conf et mysql.conf dont nous venons de parler ci-dessus. </p><br><p>  Ensuite, toutes les variables d'environnement nécessaires sont définies, qui sont définies directement dans le manifeste ou extraites de Secret'ov. </p><br><p>  Ainsi, les variables sont transférées dans le conteneur et, via docker-entrypoint.sh, sont remplacées dans ConfigMaps aux endroits dont nous avons besoin avec les valeurs nécessaires.  Pour MySQL, il s'agit de db_host, db_user, db_password.  Dans ce cas, nous transmettons le port simplement comme une valeur dans le manifeste du CronJob, car il ne contient aucune information précieuse. </p><br><p>  Eh bien, avec MySQL, tout semble clair.  Voyons maintenant ce qui est nécessaire pour sauvegarder les fichiers d'application Redmine. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Il s'agit d'un fichier de configuration qui décrit la logique de sauvegarde des fichiers.  Il n'y a rien d'inhabituel ici non plus, tous les mêmes paramètres sont définis comme pour MySQL, à l'exception des données d'autorisation, car ils ne le sont tout simplement pas.  Bien qu'ils puissent l'être, si des protocoles de transfert de données sont impliqués: ssh, ftp, webdav, s3 et autres.  Nous considérerons cette option un peu plus tard. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Rien de nouveau non plus concernant MySQL.  Mais ici, un PV supplémentaire (target-dir) est monté, que nous allons sauvegarder - / var / www / files.  Sinon, tout est pareil, nous stockons des copies localement sur le nœud dont nous avons besoin, pour lequel CronJob est affecté. </p><br><h6>  Résumé </h6><br><p>  Pour chaque service que nous voulons sauvegarder, nous créons un CronJob séparé avec tous les éléments connexes nécessaires: ConfigMaps et Secrets.  Par analogie avec les exemples considérés, nous pouvons sauvegarder tout service similaire dans le cluster. </p><br><p>  Je pense que, sur la base de ces deux exemples, tout le monde a une idée de la façon dont nous sauvegardons les services d'État à Cuba.  Je pense que cela n'a aucun sens d'analyser en détail les mêmes exemples pour d'autres services, car, fondamentalement, ils se ressemblent tous et présentent de légères différences. </p><br><p>  En fait, c'est ce que nous voulions atteindre, à savoir une sorte d' <u>approche unifiée</u> pour la construction du processus de sauvegarde.  Et pour que cette approche puisse être appliquée à un grand nombre de projets différents basés sur k8s. </p><br><h3>  Où le stockons-nous? </h3><br><p>  Dans tous les exemples décrits ci-dessus, nous stockons des copies dans le répertoire local du nœud sur lequel le conteneur s'exécute.  Mais personne ne se soucie de connecter le volume persistant en tant que stockage externe fonctionnel et d'y collecter des copies.  Ou vous pouvez uniquement les synchroniser avec un magasin distant en utilisant le protocole souhaité sans enregistrer localement.  Autrement dit, il existe de nombreuses variantes.  Collectez d'abord localement, puis synchronisez.  Ou pour collecter et stocker uniquement sur un stockage distant, etc.  La configuration est assez flexible. </p><br><h6>  mysql.conf + s3 </h6><br><p>  Ce qui suit est un exemple du fichier de configuration de sauvegarde MySQL, où les copies sont stockées localement sur le nœud où CronJob est exécuté, et également synchronisées dans s3. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Autrement dit, s'il ne suffit pas de stocker des copies localement, vous pouvez les synchroniser avec n'importe quel stockage distant à l'aide du protocole approprié.  Le nombre de stockage pour le stockage peut être quelconque. </p><br><p>  Mais dans ce cas, vous devez encore apporter quelques modifications supplémentaires, à savoir: </p><br><ul><li>  Connectez le ConfigMap approprié avec le contenu nécessaire pour l'autorisation avec AWS S3, au format j2 </li><li>  Créer un secret approprié pour stocker les accès d'autorisation </li><li>  Définissez les variables d'environnement nécessaires tirées de Secret ci-dessus </li><li>  Ajustez docker-entrypoint.sh pour remplacer les variables correspondantes dans ConfigMap </li><li>  Reconstruisez l'image Docker, en ajoutant des utilitaires pour travailler avec AWS S3 </li></ul><br><p>  Bien que ce processus soit loin d'être parfait, nous y travaillons.  Par conséquent, dans un proche avenir, nous ajouterons à nxs-backup la possibilité de définir des paramètres dans le fichier de configuration à l'aide de variables d'environnement, ce qui simplifiera considérablement le travail avec le fichier de point d'entrée et minimisera le temps consacré à l'ajout de la prise en charge de la sauvegarde de nouveaux services. </p><br><h3>  Conclusion </h3><br><p>  C'est probablement tout. </p><br><p>  L'utilisation de l'approche dont nous venons de parler, tout d'abord, nous permet de structurer et de sauvegarder des services de projet Stateful sur k8s.  Autrement dit, il s'agit d'une solution toute faite et, surtout, de la pratique que vous pouvez appliquer dans vos projets, sans perdre de temps et d'efforts à rechercher et à affiner les solutions open source existantes. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426543/">https://habr.com/ru/post/fr426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426527/index.html">Bon outstuff, mauvais outstuff</a></li>
<li><a href="../fr426531/index.html">Dell G3 15 (3579): un ordinateur portable de jeu pour un budget minimal</a></li>
<li><a href="../fr426533/index.html">Noise Security Bit episode 0x21 (Fiction et réalité: portes dérobées dans le matériel et le firmware)</a></li>
<li><a href="../fr426537/index.html">Le livre "App from scratch"</a></li>
<li><a href="../fr426541/index.html">Paul Allen, co-fondateur de Microsoft, est décédé à l'âge de 65 ans</a></li>
<li><a href="../fr426545/index.html">Bonus Joker 2018: streaming en ligne gratuit, bofs, fête et table</a></li>
<li><a href="../fr426547/index.html">Alors que le créateur d'Android tente de sortir le premier "anti-smartphone"</a></li>
<li><a href="../fr426549/index.html">Un nouveau type de logiciel pour les chefs de produit</a></li>
<li><a href="../fr426551/index.html">Trekz Air - comment les écouteurs à conduction osseuse sonnent réellement</a></li>
<li><a href="../fr426553/index.html">Bannières publicitaires dans l'application iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>