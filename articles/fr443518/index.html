<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéóÔ∏è üôåüèº üö¥üèæ RBKmoney Payments sous le capot - microservices, protocoles et configuration de la plateforme üöé üóÉÔ∏è üïó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Habr! RBKmoney prend √† nouveau contact et poursuit une s√©rie d'articles sur la fa√ßon d'√©crire le traitement des paiements par soi-m√™me. 





 J...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RBKmoney Payments sous le capot - microservices, protocoles et configuration de la plateforme</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rbkmoney/blog/443518/"><p>  Salut Habr!  RBKmoney prend √† nouveau contact et poursuit une s√©rie d'articles sur la fa√ßon d'√©crire le traitement des paiements par soi-m√™me. </p><br><p><img src="https://habrastorage.org/webt/nc/w-/dh/ncw-dhwzrbb-b84-afrgy1syhri.jpeg"></p><br><p>  Je voulais plonger imm√©diatement dans les d√©tails de la description de la mise en ≈ìuvre d'un processus commercial de paiement en tant que machine d'√©tat, montrer des exemples d'une telle machine avec un ensemble d'√©v√©nements, des fonctionnalit√©s de mise en ≈ìuvre ... Mais il semble que vous ne pouvez pas vous passer de quelques articles de revue suppl√©mentaires.  Le sujet s'est av√©r√© trop grand.  Cet article r√©v√©lera les nuances de travail et l'interaction entre les microservices de notre plateforme, l'interaction avec les syst√®mes externes et la fa√ßon dont nous g√©rons la configuration de l'entreprise. <a name="habracut"></a></p><br><h3 id="makroservis">  Service de macro </h3><br><p>  Notre syst√®me se compose de nombreux microservices qui, impl√©mentant chacun de leur partie finie de la logique m√©tier, interagissent entre eux et forment ensemble un macro service.  En fait, le macro-service d√©ploy√© dans le centre de donn√©es, connect√© aux banques et autres syst√®mes de paiement, est notre traitement des paiements. </p><br><h4 id="shablon-mikroservisa">  Mod√®le de microservice </h4><br><p>  Nous utilisons une approche unifi√©e pour le d√©veloppement de tout microservice dans la langue dans laquelle il est √©crit.  Chaque microservice est un conteneur Docker qui contient: </p><br><ul><li>  l'application elle-m√™me qui impl√©mente la logique m√©tier √©crite en Erlang ou Java; </li><li>  RPClib - une biblioth√®que qui impl√©mente la communication entre les microservices; <br><ul><li>  nous utilisons Apache Thrift, ses principaux avantages sont des biblioth√®ques client-serveur pr√™tes √† l'emploi et la possibilit√© de typifier strictement la description de toutes les m√©thodes publiques fournies par chaque microservice; </li><li> la deuxi√®me caract√©ristique de la biblioth√®que est notre impl√©mentation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google Dapper</a> , qui nous permet de tracer rapidement les demandes avec une simple recherche dans Elasticsearch.  Le premier microservice qui a re√ßu une demande d'un syst√®me externe g√©n√®re un <code>trace_id</code> unique, qui est enregistr√© par chaque cha√Æne de demande suivante.  De plus, nous g√©n√©rons et enregistrons <code>parent_id</code> et <code>span_id</code> , ce qui vous permet de construire un arbre de requ√™te, en surveillant visuellement toute la cha√Æne de microservices impliqu√©s dans le traitement de la demande; </li><li>  la troisi√®me caract√©ristique - nous utilisons activement le transfert au niveau du transport de diff√©rentes informations sur le contexte de la demande.  Par exemple, les d√©lais (la dur√©e de vie attendue de la demande d√©finie sur le client), ou pour le compte de qui nous appelons une m√©thode; </li></ul></li><li>  Le mod√®le Consul est un agent de d√©couverte de service qui conserve des informations sur l'emplacement, la disponibilit√© et l'√©tat d'un microservice.  Les microservices se trouvent par noms DNS, la zone TTL est nulle, le service qui est mort ou qui n'a pas pass√© le contr√¥le de sant√© cesse de se r√©soudre et re√ßoit ainsi du trafic; </li><li>  les journaux que l'application √©crit dans un format compr√©hensible par Elasticsearch dans le fichier conteneur local et le <code>filebeat</code> fichier, qui s'ex√©cute sur la machine h√¥te par rapport au conteneur, r√©cup√®re ces journaux et les envoie au cluster Elasticsearch; <br><ul><li>  puisque nous impl√©mentons la plateforme selon le mod√®le Event Sourcing, les cha√Ænes de journaux r√©sultantes sont √©galement utilis√©es pour la visualisation sous la forme de diff√©rents tableaux de bord Grafana, ce qui r√©duit le temps de mise en ≈ìuvre de diff√©rentes m√©triques (nous utilisons √©galement des m√©triques distinctes). </li></ul></li></ul><br><p><img src="https://habrastorage.org/webt/2v/ac/a2/2vaca2u7qtih8_1iqtl0h_2ywoq.jpeg"></p><br><p>  Lors du d√©veloppement de microservices, nous utilisons les limitations que nous avons sp√©cialement invent√©es, qui sont con√ßues pour r√©soudre √† la fois le probl√®me de la haute disponibilit√© de la plateforme et de sa tol√©rance aux pannes: </p><br><ul><li>  limites de m√©moire strictes pour chaque conteneur, lorsque vous allez au-del√† des limites - MOO, la plupart des microservices vivent dans 256-512M.  Cela rend la mise en ≈ìuvre de la logique m√©tier plus finement fragment√©e, prot√®ge contre la d√©rive vers le monolithe, r√©duit le co√ªt du point de d√©faillance, offre un avantage suppl√©mentaire pour travailler sur du mat√©riel bon march√© (la plate-forme est d√©ploy√©e et fonctionne sur des serveurs monoprocesseurs peu co√ªteux); </li><li>  aussi peu de microservices avec √©tat que possible et autant d'impl√©mentations sans √©tat que possible.  Cela nous permet de r√©soudre les probl√®mes de tol√©rance aux pannes, de rapidit√© de r√©cup√©ration et, en g√©n√©ral, de minimiser les lieux √† comportement potentiellement incompr√©hensible.  Cela devient particuli√®rement important avec une augmentation de la dur√©e de vie du syst√®me lorsqu'un important h√©ritage est accumul√©; </li><li>  laissez-le tomber en panne et les approches "√ßa va d√©finitivement casser".  Nous savons que n'importe quelle partie de notre syst√®me √©chouera n√©cessairement, nous le concevons de telle sorte que cela n'affecte pas l'exactitude g√©n√©rale des informations accumul√©es dans la plate-forme.  Aide √† minimiser le nombre d'√©tats non d√©finis dans le syst√®me. </li></ul><br><p>  <em>S√ªrement familier √† beaucoup de ceux qui s'int√®grent √† des tiers, la situation.</em>  <em>Nous nous attendions √† une r√©ponse d'un tiers √† la demande d'annuler de l'argent conform√©ment au protocole, et une r√©ponse compl√®tement diff√©rente est arriv√©e, qui n'est d√©crite dans aucune sp√©cification, et on ne sait pas comment l'interpr√©ter.</em> </p><br><p>  Dans cette situation, nous tuons la machine d'√©tat servant √† ce paiement, toutes les actions de l'ext√©rieur recevront une erreur de 500. Et √† l'int√©rieur, nous d√©couvrons l'√©tat actuel du paiement, alignons l'√©tat de la machine avec la r√©alit√© et ravivons la machine d'√©tat. </p><br><h2 id="protocol-oriented-development">  D√©veloppement orient√© protocole </h2><br><p><img src="https://habrastorage.org/webt/my/8p/o1/my8po16kkxanpoanxnzrea_i7gg.jpeg"></p><br><p>  Au moment de la r√©daction du pr√©sent rapport, 636 ch√®ques diff√©rents √©taient enregistr√©s dans notre Service Discovery pour des services qui garantissent le fonctionnement de la plateforme.  M√™me en tenant compte du fait que plusieurs v√©rifications sont effectu√©es sur un service, et aussi que la plupart des services sans √©tat fonctionnent dans au moins une triple instance, vous obtenez toujours cinquante applications qui doivent pouvoir se connecter d'une mani√®re ou d'une autre et ne pas √©chouer. dans l'enfer RPC. </p><br><p>  La situation est compliqu√©e par le fait que nous avons trois langages de d√©veloppement sur la pile - Erlang, Java, JS, et ils doivent tous pouvoir communiquer de mani√®re transparente entre eux. </p><br><p>  La premi√®re t√¢che qui devait √™tre r√©solue √©tait de concevoir la bonne architecture pour l'√©change de donn√©es entre les microservices.  Comme base, nous avons pris Apache Thrift.  Tous les microservices √©changent des binaires trift; nous utilisons HTTP comme transport. </p><br><p>  Nous pla√ßons les sp√©cifications de police sous forme de r√©f√©rentiels s√©par√©s dans notre github, afin qu'elles soient disponibles pour tout d√©veloppeur qui y a acc√®s.  Initialement, ils ont utilis√© un r√©f√©rentiel commun pour tous les protocoles, mais au fil du temps, ils sont arriv√©s √† la conclusion que cela n'√©tait pas pratique - le travail parall√®le conjoint sur les protocoles s'est transform√© en un mal de t√™te constant.  Diff√©rentes √©quipes et m√™me diff√©rents d√©veloppeurs ont √©t√© oblig√©s de s'entendre sur le nom des variables, une tentative de division en espace de noms n'a pas non plus aid√©. </p><br><p>  En g√©n√©ral, nous pouvons dire que nous avons un d√©veloppement bas√© sur le protocole.  Avant de commencer toute mise en ≈ìuvre, nous d√©veloppons le futur protocole de microservice sous la forme d'une sp√©cification d'ascenseur, parcourons 7 cercles de r√©vision, attirant les futurs clients de ce microservice, et avons l'opportunit√© de commencer simultan√©ment √† d√©velopper plusieurs microservices en parall√®le, car nous connaissons toutes ses futures m√©thodes et nous pouvons d√©j√† √©crire leurs gestionnaires, en utilisant √©ventuellement moki. </p><br><p>  Une √©tape distincte dans le processus de d√©veloppement du protocole est une revue de s√©curit√©, o√π les gars regardent de leur point de vue pentester les nuances de la sp√©cification en cours d'√©laboration. </p><br><p>  Nous avons √©galement jug√© appropri√© de souligner un r√¥le distinct du propri√©taire du protocole dans l'√©quipe.  La t√¢che est difficile, une personne doit garder √† l'esprit les sp√©cificit√©s de tous les microservices, mais elle est payante dans un ordre important et la pr√©sence d'un seul point d'escalade. </p><br><p>  Sans l'approbation finale de la demande d'extraction par ces employ√©s, le protocole ne peut pas √™tre fusionn√© dans une branche principale.  Il y a une fonctionnalit√© tr√®s pratique dans le github pour cela - les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">propri√©taires de code</a> , nous l'utilisons avec plaisir. </p><br><p>  Ainsi, nous avons r√©solu le probl√®me de la communication entre les microservices, les probl√®mes possibles de malentendu sur le type de microservice apparu dans la plate-forme et pourquoi il √©tait n√©cessaire.  Cet ensemble de protocoles est peut-√™tre la seule partie de la plate-forme o√π nous choisissons inconditionnellement la qualit√© par rapport au co√ªt et √† la vitesse de d√©veloppement, car la mise en ≈ìuvre d'un microservice peut √™tre r√©√©crite relativement sans douleur, et le protocole sur lequel plusieurs dizaines sont d√©j√† chers et douloureux. </p><br><p>  En cours de route, une journalisation pr√©cise permet de r√©soudre le probl√®me de la documentation.  Des noms de m√©thodes et de param√®tres raisonnablement choisis, quelques commentaires et une sp√©cification auto-document√©e font gagner beaucoup de temps! </p><br><p>  Par exemple, voici √† quoi ressemble la sp√©cification de la m√©thode de l'un de nos microservices, vous permettant d'obtenir une liste des √©v√©nements qui se sont produits sur la plateforme: </p><br><pre> <code class="plaintext hljs">/**    */ typedef i64 EventID /* Event sink service definitions */ service EventSink { /** *       ,   *    ,  ,  `range`.  *      `0`  `range.limit` . * *   `range.after`    ,   * ,        , *   `EventNotFound`. */ Events GetEvents (1: EventRange range) throws (1: EventNotFound ex1, 2: base.InvalidRequest ex2) /** *         *  . */ base.EventID GetLastEventID () throws (1: NoLastEvent ex1) } /* Events */ typedef list&lt;Event&gt; Events /** * ,    -,  . */ struct Event { /** *  . *    ,     *      (total order). */ 1: required base.EventID id /** *   . */ 2: required base.Timestamp created_at /** *  -,  . */ 3: required EventSource source /** *  ,    ( ) *   -,  . */ 4: required EventPayload payload /** *      . *    . */ 5: optional base.SequenceID sequence } // Exceptions exception EventNotFound {} exception NoLastEvent {} /** * ,       -   */ exception InvalidRequest { /**          */ 1: required list&lt;string&gt; errors }</code> </pre> <br><h3 id="thrift-console-client">  Client de console Thrift </h3><br><p>  Parfois, nous sommes confront√©s √† la t√¢che d'appeler certaines m√©thodes du microservice n√©cessaire directement, par exemple, √† la main depuis le terminal.  Cela peut √™tre utile pour le d√©bogage, l'obtention d'un ensemble de donn√©es brutes ou lorsque la t√¢che est si rare que le d√©veloppement d'une interface utilisateur distincte n'est pas pratique. </p><br><p>  Par cons√©quent, nous avons d√©velopp√© un outil pour nous-m√™mes qui combine les fonctions de <code>curl</code> , mais vous permet de faire des requ√™tes trift sous la forme de structures JSON.  Nous l'avons appel√© en cons√©quence - <code>woorl</code> .  L'utilitaire est universel, il suffit de lui transf√©rer l'emplacement de toute sp√©cification de levage √† l'aide du param√®tre de ligne de commande, il fera le reste lui-m√™me.  Un utilitaire tr√®s pratique, vous pouvez lancer un paiement directement depuis le terminal, par exemple. </p><br><p>  Voici √† quoi ressemble un appel directement au microservice de la plateforme, qui est responsable de la gestion des applications (par exemple, pour cr√©er un magasin).  J'ai demand√© des donn√©es sur mon compte test: </p><br><p><img src="https://habrastorage.org/webt/zk/9f/zy/zk9fzypaopdlugw06vwkso2qt0q.jpeg"></p><br><p>  <em>Les lecteurs observateurs ont probablement remarqu√© une caract√©ristique de la capture d'√©cran.</em>  <em>Nous n'aimons pas √ßa non plus.</em>  <em>Il est n√©cessaire de s√©curiser l'autorisation d'appels trift entre microservices, il faut coller TLS dans le bon sens.</em>  <em>Mais alors que les ressources, comme toujours, ne suffisent pas.</em>  <em>Nous nous sommes limit√©s √† l'enceinte totale du p√©rim√®tre dans lequel vivent les microservices de traitement.</em> </p><br><h2 id="protokoly-obscheniya-s-vneshnimi-sistemami">  Protocoles pour communiquer avec des syst√®mes externes </h2><br><p>  Pour publier des sp√©cifications d'ascenseur vers l'ext√©rieur et pour forcer nos marchands √† communiquer en utilisant le protocole binaire, nous l'avons jug√© trop cruel pour eux.  Il √©tait n√©cessaire de choisir un protocole lisible par l'homme qui nous permettrait de nous int√©grer facilement √† nous, de d√©boguer et de pouvoir documenter facilement.  Nous avons choisi la norme Open API, √©galement connue sous le nom de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Swagger</a> . </p><br><p>  Revenant au probl√®me de la documentation des protocoles, Swagger vous permet de r√©soudre rapidement et √† moindre co√ªt ce probl√®me.  Le r√©seau poss√®de de nombreuses impl√©mentations de la belle conception de la sp√©cification Swagger sous forme de documentation pour les d√©veloppeurs.  Nous avons examin√© tout ce que nous pouvions trouver et avons finalement choisi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ReDoc</a> , une biblioth√®que JS qui accepte swagger.json en entr√©e, et g√©n√®re une telle documentation en trois colonnes √† la sortie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://developer.rbk.money/api/</a> . </p><br><p>  Les approches du d√©veloppement des deux protocoles, Thrift interne et Swagger externe, sont absolument identiques pour nous.  Cela ajoute du temps au d√©veloppement, mais est rentable √† long terme. </p><br><p>  Nous devions √©galement r√©soudre un autre probl√®me important - nous acceptons non seulement les demandes d'annulation de fonds, mais nous les envoyons √©galement plus loin - aux banques et aux syst√®mes de paiement. </p><br><p>  Les forcer √† mettre en ≈ìuvre notre ascenseur serait une t√¢che encore plus impraticable que de le soumettre √† des API publiques. </p><br><p>  Par cons√©quent, nous avons con√ßu et mis en ≈ìuvre le concept d'adaptateurs de protocole.  Ceci est juste un autre microservice qui impl√©mente notre sp√©cification de levage interne d'un c√¥t√©, qui est le m√™me pour toute la plate-forme, et le second est un protocole externe sp√©cifique √† une banque ou PS particuli√®re. </p><br><p>  <em>Les probl√®mes qui surviennent lors de l'√©criture de tels adaptateurs lorsque vous devez interagir avec des tiers est un sujet riche en histoires diff√©rentes.</em>  <em>Dans notre pratique, nous avons rencontr√© diff√©rentes choses, des r√©ponses de la forme: "vous, bien s√ªr, pouvez mettre en ≈ìuvre cette fonction comme d√©crit dans le protocole que nous vous avons donn√©, mais je ne donne aucune garantie. Voici notre malade en 2 semaines, qui est pour toutes ces r√©ponses, et vous lui demandez confirmation. "</em>  <em>De plus, de telles situations ne sont pas rares: "voici le nom d'utilisateur et le mot de passe de notre serveur, allez-y et configurez tout vous-m√™me."</em> </p><br><p>  <em>Je trouve cela particuli√®rement int√©ressant lorsque nous nous sommes int√©gr√©s √† un partenaire de paiement, qui, √† son tour, s'√©tait auparavant int√©gr√© √† notre plate-forme et avait effectu√© avec succ√®s des paiements par notre interm√©diaire (cela arrive souvent, les sp√©cificit√©s commerciales de l'industrie du paiement).</em>  <em>En r√©ponse √† notre demande d'un environnement de test, le partenaire a r√©pondu qu'il n'avait pas d'environnement de test en tant que tel, mais qu'il pouvait obtenir du trafic pour l'int√©gration avec RBC, c'est-√†-dire avec notre plateforme, o√π nous pourrions nous impliquer.</em>  <em>C'est ainsi que nous, √† travers un partenaire, nous nous sommes int√©gr√©s une fois.</em> </p><br><p>  Ainsi, nous avons tout simplement r√©solu le probl√®me de la mise en ≈ìuvre d'une connexion parall√®le de masse de divers syst√®mes de paiement et d'autres tiers.  Dans la grande majorit√© des cas, vous n'avez pas besoin de toucher le code de la plate-forme pour cela, il suffit d'√©crire les adaptateurs et d'ajouter plus d'instruments de paiement √† l'√©num√©ration. </p><br><p>  En cons√©quence, nous avons obtenu un tel sch√©ma de travail - nous regardons en dehors des microservices de l'API RBKmoney (nous les appelons API commune, ou capi *, vous les avez vu dans le consul ci-dessus), qui valident les donn√©es d'entr√©e selon la sp√©cification publique Swagger, autorisent les clients, diffusent ces m√©thodes √† nos appels internes et envoient les demandes en aval au prochain microservice.  De plus, ces services impl√©mentent une autre exigence de plate-forme, dont la sp√©cification technique a √©t√© formul√©e comme suit: "le syst√®me devrait toujours avoir la possibilit√© d'obtenir un chat". </p><br><p>  Lorsque nous devons appeler un syst√®me externe, des microservices internes tirent les m√©thodes de levage de l'adaptateur de protocole correspondant, ils les traduisent dans la langue d'une banque ou d'un syst√®me de paiement sp√©cifique et les envoient. </p><br><h3 id="trudnosti-obratnoy-sovmestimosti-protokolov">  Probl√®mes de compatibilit√© descendante du protocole </h3><br><p>  La plateforme √©volue constamment, de nouvelles fonctions sont ajout√©es, les anciennes sont modifi√©es.  Dans de telles circonstances, vous devez investir dans la prise en charge de la compatibilit√© descendante ou mettre √† jour constamment les microservices d√©pendants.  Et si la situation o√π le champ requis devient facultatif est simple, vous ne pouvez rien faire du tout, dans le cas contraire, vous devez d√©penser des ressources suppl√©mentaires. </p><br><p>  Avec un ensemble de protocoles internes, les choses vont plus facilement.  L'industrie du paiement change rarement, de sorte que des m√©thodes d'interaction fondamentalement nouvelles apparaissent.  Prenons, par exemple, une t√¢che commune pour nous - connecter un nouveau fournisseur avec un nouvel instrument de paiement.  Par exemple, le traitement de portefeuille local, qui vous permet de traiter les paiements au Kazakhstan en tenge.  Il s'agit d'un nouveau portefeuille pour notre plate-forme, mais en principe, il ne diff√®re pas du m√™me portefeuille Qiwi - il a toujours un identifiant et des m√©thodes uniques qui vous permettent d'en d√©biter / d'annuler le d√©bit. </p><br><p>  En cons√©quence, notre sp√©cification d'ascenseur pour tous les fournisseurs de portefeuilles ressemble √† ceci: </p><br><pre> <code class="plaintext hljs">typedef string DigitalWalletID struct DigitalWallet { 1: required DigitalWalletProvider provider 2: required DigitalWalletID id } enum DigitalWalletProvider { qiwi rbkmoney }</code> </pre> <br><p>  et l'ajout d'un nouveau moyen de paiement sous la forme d'un nouveau portefeuille compl√®te simplement l'√©num√©ration: </p><br><pre> <code class="plaintext hljs">enum DigitalWalletProvider { qiwi rbkmoney newwallet }</code> </pre> <br><p>  Il ne reste plus qu'√† bump tous les microservices utilisant cette sp√©cification, en se synchronisant avec l'assistant de r√©f√©rentiel avec la sp√©cification et en les d√©ployant via CI / CD. </p><br><p>  Les protocoles externes sont plus compliqu√©s.  Chaque mise √† jour de la sp√©cification Swagger, en particulier sans compatibilit√© descendante, est presque impossible √† appliquer dans un d√©lai raisonnable - il est peu probable que nos partenaires conservent des ressources de d√©veloppement gratuites sp√©cifiquement pour la mise √† jour de notre plate-forme. </p><br><p>  <em>Et parfois, cela est tout simplement impossible, nous rencontrons parfois des situations comme: "le programmeur nous a √©crit et est parti, a pris les sources avec nous, comment nous travaillons, nous ne savons pas, cela fonctionne et ne le touchez pas."</em> </p><br><p>  Par cons√©quent, nous investissons dans la prise en charge de la compatibilit√© descendante sur les protocoles externes.  Dans notre architecture, c'est un peu plus facile - puisque nous utilisons des adaptateurs de protocole s√©par√©s pour chaque version sp√©cifique de l'API commune, nous laissons simplement les anciens microservices capi fonctionner, ne changeant que la partie qui ressemble √† une bagatelle √† l'int√©rieur de la plate-forme si n√©cessaire.  Les microservices <code>capi-v1</code> , <code>capi-v2</code> , <code>capi-v3</code> et ainsi de suite apparaissent et restent avec nous pour toujours. </p><br><p>  Que se passera <code>capi-v33</code> il lorsque <code>capi-v33</code> nous devrons probablement d√©pr√©cier certaines anciennes versions. </p><br><p>  <em>√Ä ce stade, je commence g√©n√©ralement √† tr√®s bien comprendre les entreprises telles que Microsoft et toute leur peine √† prendre en charge la compatibilit√© descendante des solutions qui fonctionnent depuis des d√©cennies.</em> </p><br><h2 id="nastraivaem-sistemu">  Personnalisez le syst√®me </h2><br><p>  Et, pour terminer le sujet, nous vous expliquerons comment nous g√©rons les param√®tres de plate-forme sp√©cifiques √† l'entreprise. </p><br><p>  Faire un paiement n'est pas aussi simple qu'il y para√Æt.  Pour chaque paiement, le client professionnel souhaite associer un grand nombre de conditions - de la commission √†, en principe, la possibilit√© d'une mise en ≈ìuvre r√©ussie en fonction de l'heure de la journ√©e.  Nous nous sommes fix√© pour t√¢che de num√©riser l'ensemble des conditions qu'un client professionnel peut proposer maintenant et √† l'avenir et d'appliquer cet ensemble √† chaque paiement nouvellement lanc√©. </p><br><p>  En cons√©quence, nous avons d√©cid√© de d√©velopper notre propre DSL, auquel nous avons foir√© des outils de gestion pratique qui nous permettent de d√©crire le mod√®le commercial de la bonne mani√®re: le choix des adaptateurs de protocole, une description du plan de publication, selon laquelle l'argent sera dispers√© dans les comptes du syst√®me, en fixant des limites, des commissions, des cat√©gories et d'autres choses sp√©cifiques au syst√®me de paiement. </p><br><p>  Par exemple, lorsque nous voulons prendre une commission de 1% pour l'acquisition sur les cartes du maestro et MS et la disperser sur les comptes √† l'int√©rieur du syst√®me, nous configurons le domaine comme ceci: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"cash_flow"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"decisions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"if_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"any_of"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"maestro"</span></span> } } } } }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"mastercard"</span></span> } } } } } ] }, <span class="hljs-attr"><span class="hljs-attr">"then_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"system"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"destination"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"provider"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"volume"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"share"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"parts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"p"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"q"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"of"</span></span>: <span class="hljs-string"><span class="hljs-string">"operation_amount"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>: <span class="hljs-string"><span class="hljs-string">"1% processing fee"</span></span> } ] } } ] } }</code> </pre> <br><p>  ,         ,   .     ,             JSON.    ,    ,    ,  .        ,  ,     .  ,  CVS/SVN-. </p><br><p>    "               ". , ,     ,     1%,   ,    ,    .    ,        ,   .         ,         . </p><br><p> <em> cvs-like        ,       .   ,    ‚Äî  stateless, ,               .         .         .</em> </p><br><p> <em>    -     .            ,      ,   .     ,    ,                   .</em> </p><br><p> <em>             .     ,   10   ,     ,           .</em> </p><br><p>     , ,    ,   -,       woorl-.    -        JSON-  .    -  JS,       ,      UX: </p><br><p><img src="https://habrastorage.org/webt/c0/ni/ge/c0nigeglg1reebztmvml6svc7ia.jpeg"></p><br><p>           ,    ,         ,          . </p><br><p>     , , . </p><br><p>        ,     ,       SaltStack. </p><br><p> ,    ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443518/">https://habr.com/ru/post/fr443518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443508/index.html">Jeux de soci√©t√© √©ducatifs pour les programmeurs</a></li>
<li><a href="../fr443510/index.html">Ordinateur portable Compaq Armada 7700 - en tant que d√©veloppement de la gamme Compaq LTE</a></li>
<li><a href="../fr443512/index.html">Hackathon d'analyse de donn√©es √† Nizhny Novgorod</a></li>
<li><a href="../fr443514/index.html">√âcrire votre couche r√©seau dans Swift: approche orient√©e protocole</a></li>
<li><a href="../fr443516/index.html">Hacker Geohot a d√©cid√© de lib√©rer les gens de la simulation de l'IA</a></li>
<li><a href="../fr443520/index.html">Choisir une voiture pour un sp√©cialiste informatique ou des conseils pour des th√©i√®res √† partir d'une th√©i√®re</a></li>
<li><a href="../fr443522/index.html">H√©bergement: options, comparaisons, statistiques utilisateurs</a></li>
<li><a href="../fr443524/index.html">Animations Flash √† faire soi-m√™me dans Unity3D. Premi√®re partie, Lyrique</a></li>
<li><a href="../fr443526/index.html">Des algorithmes au cancer: conf√©rences de l'√âcole de bioinformatique</a></li>
<li><a href="../fr443530/index.html">√âvolution de l'infrastructure de base de donn√©es: de la base de donn√©es et des applications sur un serveur √† la r√©plication en streaming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>