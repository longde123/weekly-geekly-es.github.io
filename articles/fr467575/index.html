<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔆 👩🏼‍🤝‍👨🏿 👩‍🚒 Une façon d'obtenir le profil de charge de travail et l'historique d'attente dans PostgreSQL 😦 🐏 👏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suite de l'article " Essayer de créer un analogue d'ASH pour PostgreSQL ". 

 L'article sera examiné et affiché sur des requêtes et des exemples spéci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Une façon d'obtenir le profil de charge de travail et l'historique d'attente dans PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467575/"> Suite de l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Essayer de créer un analogue d'ASH pour PostgreSQL</a> ". <br><br>  L'article sera examiné et affiché sur des requêtes et des exemples spécifiques - quelles informations utiles peuvent être obtenues en utilisant l'historique de présentation pg_stat_activity. <br><blockquote>  Avertissement <br>  En raison de la nouveauté du sujet et de la période de test incomplète, l'article peut contenir des erreurs.  La critique et les commentaires sont fortement encouragés et attendus. </blockquote><a name="habracut"></a><h2>  Entrer les données </h2><br><h3>  Afficher l'historique pg_stat_statements </h3><br><div class="spoiler">  <b class="spoiler_title">pg_stat_history</b> <div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> pg_stat_history ( id <span class="hljs-type"><span class="hljs-type">SERIAL</span></span>, snapshot_timestamp <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, database_id <span class="hljs-type"><span class="hljs-type">integer</span></span>, dbid <span class="hljs-type"><span class="hljs-type">oid</span></span>, userid <span class="hljs-type"><span class="hljs-type">oid</span></span>, queryid <span class="hljs-type"><span class="hljs-type">bigint</span></span>, query <span class="hljs-type"><span class="hljs-type">text</span></span>, calls <span class="hljs-type"><span class="hljs-type">bigint</span></span>, total_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, min_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, max_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, mean_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, stddev_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-type"><span class="hljs-type">bigint</span></span>, shared_blks_hit <span class="hljs-type"><span class="hljs-type">bigint</span></span>, shared_blks_read <span class="hljs-type"><span class="hljs-type">bigint</span></span>, shared_blks_dirtied <span class="hljs-type"><span class="hljs-type">bigint</span></span>, shared_blks_written <span class="hljs-type"><span class="hljs-type">bigint</span></span>, local_blks_hit <span class="hljs-type"><span class="hljs-type">bigint</span></span>, local_blks_read <span class="hljs-type"><span class="hljs-type">bigint</span></span>, local_blks_dirtied <span class="hljs-type"><span class="hljs-type">bigint</span></span>, local_blks_written <span class="hljs-type"><span class="hljs-type">bigint</span></span>, temp_blks_read <span class="hljs-type"><span class="hljs-type">bigint</span></span>, temp_blks_written <span class="hljs-type"><span class="hljs-type">bigint</span></span>, blk_read_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, blk_write_time <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>, baseline_id <span class="hljs-type"><span class="hljs-type">integer</span></span> );</code> </pre> </div></div><br>  Le tableau est rempli toutes les heures à l'aide de dblink vers la base de données cible.  La colonne la plus intéressante et utile du tableau, bien sûr, est <b>queryid</b> . <br><br><h3>  Pg_stat_activity afficher l'historique </h3><br><div class="spoiler">  <b class="spoiler_title">archive_pg_stat_activity</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> archive_pg_stat_activity ( timepoint <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, datid <span class="hljs-type"><span class="hljs-type">oid</span></span>, datname <span class="hljs-type"><span class="hljs-type">name</span></span>, pid <span class="hljs-type"><span class="hljs-type">integer</span></span>, usesysid <span class="hljs-type"><span class="hljs-type">oid</span></span>, usename <span class="hljs-type"><span class="hljs-type">name</span></span>, application_name <span class="hljs-type"><span class="hljs-type">text</span></span>, client_addr <span class="hljs-type"><span class="hljs-type">inet</span></span>, client_hostname <span class="hljs-type"><span class="hljs-type">text</span></span>, client_port <span class="hljs-type"><span class="hljs-type">integer</span></span>, backend_start <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, xact_start <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, query_start <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, state_change <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-type"><span class="hljs-type">without time zone</span></span>, wait_event_type <span class="hljs-type"><span class="hljs-type">text</span></span>, wait_event <span class="hljs-type"><span class="hljs-type">text</span></span>, state <span class="hljs-type"><span class="hljs-type">text</span></span>, backend_xid xid, backend_xmin xid, query <span class="hljs-type"><span class="hljs-type">text</span></span>, backend_type <span class="hljs-type"><span class="hljs-type">text</span></span>, queryid <span class="hljs-type"><span class="hljs-type">bigint</span></span> );</code> </pre> </div></div><br>  La table est une table history_pg_stat_activity partitionnée par horloge (pour plus de détails, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voir pg_stat_statements + pg_stat_activity + loq_query = pg_ash?</a> Et voici une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tentative de création d'un analogue d'ASH pour PostgreSQL.)</a> <br><br><h2>  Mentions légales </h2><br><h3>  CLUSTER CPU TIME (SYSTEM + CLIENTS) </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'second'</span></span>, timepoint) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( aa.wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> aa.state = <span class="hljs-string"><span class="hljs-string">'active'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cpu_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t ;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">CLUSTER CPU TIME (SYSTEM + CLIENTS ) : 28:37:46</code> </pre> </div></div><br><h3>  TEMPS D'ATTENTE DU CLUSTER </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'second'</span></span>, timepoint) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( aa.wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> aa.state = <span class="hljs-string"><span class="hljs-string">'active'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cpu_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t ;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">CLUSTER WAITINGS TIME : 30:12:49</code> </pre> </div></div><br><h3>  Total des valeurs de pg_stat_statements </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"> <span class="hljs-comment"><span class="hljs-comment">--TOTAL pg_stat SELECT SUM(calls) AS calls, SUM(total_time) AS total_time, SUM(rows) AS rows , SUM(shared_blks_hit) AS shared_blks_hit,SUM(shared_blks_read) AS shared_blks_read , SUM(shared_blks_dirtied) AS shared_blks_dirtied,SUM(shared_blks_written) AS shared_blks_written , SUM(local_blks_hit) AS local_blks_hit , SUM(local_blks_read) AS local_blks_read , SUM(local_blks_dirtied) AS local_blks_dirtied , SUM(local_blks_written) AS local_blks_written, SUM(temp_blks_read) AS temp_blks_read, SUM(temp_blks_written) temp_blks_written , SUM(blk_read_time) AS blk_read_time , SUM(blk_write_time) AS blk_write_time INTO pg_total_stat_history_rec FROM pg_stat_history WHERE snapshot_timestamp BETWEEN pg_stat_history_begin AND pg_stat_history_end AND queryid IS NULL;</span></span></code> </pre> </div></div><br><h3>  SQL DBTIME - Total Query Runtime </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs">dbtime_total = <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 millisecond'</span></span> * pg_total_stat_history_rec.total_time ;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">SQL DBTIME : 136:49:36</code> </pre> </div></div><br><h3>  SQL CPU TIME temps du CPU consacré à l'exécution des requêtes </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'second'</span></span>, timepoint) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( aa.wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type = <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> aa.state = <span class="hljs-string"><span class="hljs-string">'active'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cpu_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t ;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">SQL CPU TIME : 27:40:15</code> </pre> </div></div><br><h3>  SQL WAITINGS TIME - Temps d'attente total pour les requêtes </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'second'</span></span>, timepoint) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( aa.wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> aa.state = <span class="hljs-string"><span class="hljs-string">'active'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type = <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> waiting_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t ;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">SQL WAITINGS TIME : 30:04:09</code> </pre> </div></div><br>  Les requêtes suivantes sont triviales et pour économiser de l'espace, les détails d'implémentation sont omis: <br><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">| SQL IOTIME : 19:44:50 | SQL READ TIME : 19:44:32 | SQL WRITE TIME : 00:00:17 | | SQL CALLS : 12188248 ------------------------------------------------------------- | SQL SHARED BLOCKS READS : 7997039120 | SQL SHARED BLOCKS HITS : 8868286092 | SQL SHARED BLOCKS HITS/READS % : 110.89 | SQL SHARED BLOCKS DIRTED : 419945 | SQL SHARED BLOCKS WRITTEN : 19857 | | SQL TEMPORARY BLOCKS READS : 7836169 | SQL TEMPORARY BLOCKS WRITTEN : 10683938</code> </pre></div></div><br>  Nous passons à la section la plus intéressante <br><br><h2>  ATTENTE STATIQUE </h2><br><h3>  TOP 10 DES ATTENTES PAR TEMPS D'ATTENTE TOTAL POUR LES PROCESSUS DES CLIENTS </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> wait_event_type , wait_event , get_system_waiting_duration( wait_event_type , wait_event ,pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ,pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type != <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> wait_event_type, wait_event <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ------------------------------------------------- -----------------------------------
 |  TOP 10 DES ATTENTES PAR TEMPS D'ATTENTE TOTAL POUR LES PROCESSUS SYSTÈME
 + ----- + ------------------------------ + ------------ -------- + --------------------
 |  # |  wait_event_type |  wait_event |  la durée
 + ----- + ------------------------------ + ------------ -------- + --------------------
 |  1 |  Activité |  LogicalLauncherMain |  10:43:28
 |  2 |  Activité |  AutoVacuumMain |  10:42:49
 |  3 |  Activité |  WalWriterMain |  10:28:53
 |  4 |  Activité |  CheckpointerMain |  10:23:50
 |  5 |  Activité |  BgWriterMain |  09:11:59
 |  6 |  Activité |  BgWriterHibernate |  01:37:46
 |  7 |  IO |  BufFileWrite |  00:02:35
 |  8 |  LWLock |  buffer_mapping |  00:01:54
 |  9 |  IO |  DataFileRead |  00:01:23
 |  10 |  IO |  WALWrite |  00:00:59
 + ----- + ------------------------------ + ------------ -------- + --------------------
</pre></div></div><br><h3>  TOP 10 DES ATTENTES PAR TEMPS D'ATTENTE TOTAL POUR LES PROCESSUS DES CLIENTS </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> wait_event_type , wait_event , get_clients_waiting_duration( wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type = <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> wait_event_type, wait_event <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ----- + ------------------------------ + ------------ -------- + -------------------- + ----------
 |  # |  wait_event_type |  wait_event |  durée |  % dbtime
 + ----- + ------------------------------ + ------------ -------- + -------------------- + ----------
 |  1 |  Lock |  transactionid |  08: 16: 47 |  6.05
 |  2 |  IO |  DataFileRead |  06: 13: 41 |  4,55
 |  3 |  Délai d'expiration |  PgSleep |  02: 53: 21 |  2.11
 |  4 |  LWLock |  buffer_mapping |  00: 40: 42 |  0,5
 |  5 |  LWLock |  buffer_io |  00: 17: 17 |  0,21
 |  6 |  IO |  BufFileWrite |  00: 01: 34 |  0,02
 |  7 |  Lock |  tuple |  00: 01: 32 |  0,02
 |  8 |  Client |  ClientRead |  00: 01: 19 |  0,02
 |  9 |  IO |  BufFileRead |  00: 00: 37 |  0,01
 |  10 |  LWLock |  buffer_content |  00: 00: 08 |  0
 + ----- + ------------------------------ + ------------ -------- + -------------------- + ----------
</pre></div></div><br><h3>  TYPES D'ATTENTE PAR TEMPS D'ATTENTE TOTAL, POUR LES PROCESSUS SYSTÈME </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> wait_event_type , get_system_waiting_type_duration( wait_event_type , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type != <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ----- + ------------------------------ + ------------ --------
 |  # |  wait_event_type |  la durée
 + ----- + ------------------------------ + ------------ --------
 |  1 |  Activité |  53:08:45
 |  2 |  IO |  00:06:24
 |  3 |  LWLock |  00:03:02
 + ----- + ------------------------------ + ------------ --------
</pre></div></div><br><h3>  TYPES D'ATTENTE PAR TEMPS D'ATTENTE TOTAL, POUR LES PROCESSUS DES CLIENTS </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> wait_event_type , get_clients_waiting_type_duration( wait_event_type , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type = <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ----- + ------------------------------ + ------------ -------- + --------------------
 |  # |  wait_event_type |  durée |  % dbtime
 + ----- + ------------------------------ + ------------ -------- + --------------------
 |  1 |  Lock |  08: 18: 19 |  6.07
 |  2 |  IO |  06: 16: 01 |  4,58
 |  3 |  Délai d'expiration |  02: 53: 21 |  2.11
 |  4 |  LWLock |  00: 58: 12 |  0,71
 |  5 |  Client |  00: 01: 19 |  0,02
 |  6 |  IPC |  00: 00: 04 |  0
 + ----- + ------------------------------ + ------------ -------- + --------------------
</pre></div></div><br>  Durée des attentes, pour les processus système et les demandes individuelles. <br><br><h3>  ATTENTE DES PROCESSUS SYSTÈME </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> backend_type , datname , wait_event_type , wait_event , get_backend_type_waiting_duration( backend_type , wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type != <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> backend_type , datname , wait_event_type , wait_event <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ----- + ----------------------------- + ---------- + - ------------------ + ---------------------- + -------- ------------
 |  # |  backend_type |  dbname |  wait_event_type |  wait_event |  la durée
 + ----- + ----------------------------- + ---------- + - ------------------ + ---------------------- + -------- ------------
 |  1 |  lanceur de réplication logique |  |  Activité |  LogicalLauncherMain |  10:43:28
 |  2 |  lanceur autovacuum |  |  Activité |  AutoVacuumMain |  10:42:49
 |  3 |  walwriter |  |  Activité |  WalWriterMain |  10:28:53
 |  4 |  pointeur de contrôle |  |  Activité |  CheckpointerMain |  10:23:50
 |  5 |  écrivain de fond |  |  Activité |  BgWriterMain |  09:11:59
 |  6 |  écrivain de fond |  |  Activité |  BgWriterHibernate |  01:37:46
 |  7 |  travailleur parallèle |  tdb1 |  IO |  BufFileWrite |  00:02:35
 |  8 |  travailleur parallèle |  tdb1 |  LWLock |  buffer_mapping |  00:01:41
 |  9 |  travailleur parallèle |  tdb1 |  IO |  DataFileRead |  00:01:22
 |  10 |  travailleur parallèle |  tdb1 |  IO |  BufFileRead |  00:00:59
 |  11 |  walwriter |  |  IO |  WALWrite |  00:00:57
 |  12 |  travailleur parallèle |  tdb1 |  LWLock |  buffer_io |  00:00:47
 |  13 |  travailleur autovacuum |  tdb1 |  LWLock |  buffer_mapping |  00:00:13
 |  14 |  écrivain de fond |  |  IO |  DataFileWrite |  00:00:12
 |  15 |  pointeur de contrôle |  |  IO |  DataFileWrite |  00:00:11
 |  16 |  walwriter |  |  LWLock |  WALWriteLock |  00:00:09
 |  17 |  pointeur de contrôle |  |  LWLock |  WALWriteLock |  00:00:06
 |  18 |  écrivain de fond |  |  LWLock |  WALWriteLock |  00:00:06
 |  19 |  walwriter |  |  IO |  WALInitWrite |  00:00:02
 |  20 |  travailleur autovacuum |  tdb1 |  LWLock |  WALWriteLock |  00:00:02
 |  21 |  walwriter |  |  IO |  WALInitSync |  00:00:02
 |  22 |  travailleur autovacuum |  tdb1 |  IO |  DataFileRead |  00:00:01
 |  23 |  pointeur de contrôle |  |  IO |  ControlFileSyncUpdate |  00:00:01
 |  24 |  écrivain de fond |  |  IO |  WALWrite |  00:00:01
 |  25 |  écrivain de fond |  |  IO |  DataFileFlush |  00:00:01
 |  26 |  pointeur de contrôle |  |  IO |  SLRUFlushSync |  00:00:01
 |  27 |  travailleur autovacuum |  tdb1 |  IO |  WALWrite |  00:00:01
 |  28 |  pointeur de contrôle |  |  IO |  DataFileSync |  00:00:01
 + ----- + ----------------------------- + ---------- + - ------------------ + ---------------------- + -------- ------------ </pre></div></div><br><h3>  ATTENTES POUR SQL - attentes pour les requêtes individuelles par queryid </h3><br><div class="spoiler">  <b class="spoiler_title">Demande</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> queryid , datname , wait_event_type , wait_event , get_query_waiting_duration( queryid , wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> duration <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> activity_hist.archive_pg_stat_activity aa <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> timepoint <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> backend_type = <span class="hljs-string"><span class="hljs-string">'client backend'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> wait_event_type <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> queryid <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> queryid , datname , wait_event_type , wait_event <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple</b> <div class="spoiler_text"><pre>  + ----- + ------------------------- + ---------- + ------ -------------- + -------------------- + -------------- ------ + --------------------
 |  # |  queryid |  dbname |  wait_event_type |  wait_event |  attente |  au total
 |  |  |  |  |  |  durée |  la durée
 + ----- + ------------------------- + ---------- + ------ -------------- + -------------------- + -------------- ------ + --------------------
 |  1 |  -8247416849404883188 |  tdb1 |  Client |  ClientRead |  00: 00: 02 |
 |  2 |  -6572922443698419129 |  tdb1 |  Client |  ClientRead |  00: 00: 05 |
 |  3 |  -6572922443698419129 |  tdb1 |  IO |  DataFileRead |  00: 00: 01 |
 |  4 |  -5917408132400665328 |  tdb1 |  Client |  ClientRead |  00: 00: 04 |
 |  5 |  -4091009262735781873 |  tdb1 |  Client |  ClientRead |  00: 00: 03 |
 |  6 |  -1473395109729441239 |  tdb1 |  Client |  ClientRead |  00: 00: 01 |
 |  7 |  28942442626229688 |  tdb1 |  IO |  BufFileWrite |  00: 01: 34 |  00:46:06
 |  8 |  28942442626229688 |  tdb1 |  LWLock |  buffer_mapping |  00: 01: 05 |  00:46:06
 |  9 |  28942442626229688 |  tdb1 |  IO |  DataFileRead |  00: 00: 44 |  00:46:06
 |  10 |  28942442626229688 |  tdb1 |  IO |  BufFileRead |  00: 00: 37 |  00:46:06
 |  11 |  28942442626229688 |  tdb1 |  LWLock |  buffer_io |  00: 00: 35 |  00:46:06
 |  12 |  28942442626229688 |  tdb1 |  Client |  ClientRead |  00: 00: 05 |  00:46:06
 |  13 |  28942442626229688 |  tdb1 |  IPC |  MessageQueueReceive |  00: 00: 03 |  00:46:06
 |  14 |  28942442626229688 |  tdb1 |  IPC |  BgWorkerShutdown |  00: 00: 01 |  00:46:06
 |  15 |  389015618226997618 |  tdb1 |  Lock |  transactionid |  03: 55: 09 |  04:14:15
 |  16 |  389015618226997618 |  tdb1 |  IO |  DataFileRead |  03: 23: 09 |  04:14:15
 |  17 |  389015618226997618 |  tdb1 |  LWLock |  buffer_mapping |  00: 12: 09 |  04:14:15
 |  18 |  389015618226997618 |  tdb1 |  LWLock |  buffer_io |  00: 10: 18 |  04:14:15
 |  19 |  389015618226997618 |  tdb1 |  Lock |  tuple |  00: 00: 35 |  04:14:15
 |  20 |  389015618226997618 |  tdb1 |  LWLock |  WALWriteLock |  00: 00: 02 |  04:14:15
 |  21 |  389015618226997618 |  tdb1 |  IO |  DataFileWrite |  00: 00: 01 |  04:14:15
 |  22 |  389015618226997618 |  tdb1 |  LWLock |  SyncScanLock |  00: 00: 01 |  04:14:15
 |  23 |  389015618226997618 |  tdb1 |  Client |  ClientRead |  00: 00: 01 |  04:14:15
 |  24 |  734234407411547467 |  tdb1 |  Client |  ClientRead |  00: 00: 11 |
 |  25 |  734234407411547467 |  tdb1 |  LWLock |  buffer_mapping |  00: 00: 05 |
 |  26 |  734234407411547467 |  tdb1 |  IO |  DataFileRead |  00: 00: 02 |
 |  27 |  1237430309438971376 |  tdb1 |  LWLock |  buffer_mapping |  00: 02: 18 |  02:45:40
 |  28 |  1237430309438971376 |  tdb1 |  IO |  DataFileRead |  00: 00: 27 |  02:45:40
 |  29 |  1237430309438971376 |  tdb1 |  Client |  ClientRead |  00: 00: 02 |  02:45:40
 |  30 |  2404820632950544954 |  tdb1 |  Client |  ClientRead |  00: 00: 01 |
 |  31 |  2515308626622579467 |  tdb1 |  Client |  ClientRead |  00: 00: 02 |
 |  32 |  4710212362688288619 |  tdb1 |  LWLock |  buffer_mapping |  00: 03: 08 |  02:18:21
 |  33 |  4710212362688288619 |  tdb1 |  IO |  DataFileRead |  00: 00: 22 |  02:18:21
 |  34 |  4710212362688288619 |  tdb1 |  Client |  ClientRead |  00: 00: 06 |  02:18:21
 |  35 |  4710212362688288619 |  tdb1 |  LWLock |  buffer_io |  00: 00: 02 |  02:18:21
 |  36 |  9150846928388977274 |  tdb1 |  IO |  DataFileRead |  00: 01: 19 |
 |  37 |  9150846928388977274 |  tdb1 |  LWLock |  buffer_mapping |  00: 00: 34 |
 |  38 |  9150846928388977274 |  tdb1 |  Client |  ClientRead |  00: 00: 10 |
 |  39 |  9150846928388977274 |  tdb1 |  LWLock |  buffer_io |  00: 00: 01 |
 + ----- + ------------------------- + ---------- + ------ -------------- + -------------------- + -------------- ------ + -------------------- </pre></div></div><br><h3>  CLIENT SQL STATICTICS - TOP requêtes </h3><br>  Cependant, les demandes de réception sont triviales et pour gagner de la place, elles ne sont pas données. <br><br><div class="spoiler">  <b class="spoiler_title">Des exemples</b> <div class="spoiler_text"><pre>  + ------------------------------------------------- -----------------------------------
 |  CLIENT SQL ordonné par Elapsed Time
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + --------------------
 |  temps écoulé |  appels |  % dbtime |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + --------------------
 |  04: 14: 15 |  19 |  3.1 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 |  02: 45: 40 |  746 |  2,02 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 |  02: 18: 21 |  749 |  1,69 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 |  00: 46: 06 |  375 |  0,56 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + --------------------
 |  CLIENT SQL ordonné par CPU Time
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  temps processeur |  appels |  % dbtime | total_time |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  02: 59: 49 |  19 |  3.1 |  04: 14: 15 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 |  01: 10: 12 |  746 |  2,02 |  02: 45: 40 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 |  00: 56: 15 |  749 |  1,69 |  02: 18: 21 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 |  00: 15: 35 |  375 |  0,56 |  00: 46: 06 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  CLIENT SQL ordonné par temps d'attente des E / S utilisateur
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  temps io_wait |  appels |  % dbtime | total_time |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  03: 23: 10 |  19 |  3.1 |  04: 14: 15 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 |  00: 02: 54 |  375 |  0,56 |  00: 46: 06 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 |  00: 00: 27 |  746 |  2,02 |  02: 45: 40 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 |  00: 00: 22 |  749 |  1,69 |  02: 18: 21 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  CLIENT SQL ordonné par des lectures de tampons partagés
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  tampons lit |  appels |  % dbtime | total_time |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  1056388566 |  19 |  3.1 |  04: 14: 15 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 |  11709251 |  375 |  0,56 |  00: 46: 06 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 |  3439004 |  746 |  2,02 |  02: 45: 40 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 |  3373330 |  749 |  1,69 |  02: 18: 21 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  CLIENT SQL ordonné par Disk Reads Time
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  temps de lecture |  appels |  % dbtime | total_time |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  02: 16: 30 |  19 |  3.1 |  04: 14: 15 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 |  00: 04: 50 |  375 |  0,56 |  00: 46: 06 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 |  00: 01: 10 |  749 |  1,69 |  02: 18: 21 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 |  00: 00: 57 |  746 |  2,02 |  02: 45: 40 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  CLIENT SQL ordonné par Executions
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  appels |  lignes |  % dbtime | total_time |  % CPU |  % IO |  dbname |  queryid
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ --------
 |  749 |  749 |  1,69 |  02: 18: 21 |  3,39 |  0,1 |  tdb1 |  4710212362688288619
 |  746 |  746 |  2,02 |  02: 45: 40 |  4.23 |  0,08 |  tdb1 |  1237430309438971376
 |  375 |  0 |  0,56 |  00: 46: 06 |  0,94 |  0,41 |  tdb1 |  28942442626229688
 |  19 |  19 |  3.1 |  04: 14: 15 |  10,83 |  11,52 |  tdb1 |  389015618226997618
 + -------------------- + ---------- + ---------- + ------ ---- + ---------- + ---------- + ---------- + ------------ -------- </pre></div></div><br><h2>  Résumé </h2><br>  En utilisant les demandes soumises et les rapports résultants, vous pouvez obtenir une image plus complète pour analyser et résoudre les problèmes de dégradation des performances pour les demandes individuelles et l'ensemble du cluster dans son ensemble. <br><br><h2>  Développement </h2><br>  Jusqu'à présent, les plans de développement sont les suivants: <br><br><ul><li>  Compléter les rapports avec un historique des verrous  Les demandes sont en cours de test et seront soumises sous peu. </li><li>  Utilisez l'extension TimescaleDB pour stocker l'historique de pg_stat_activity et pg_locks. </li><li>  Préparez une solution batch sur github pour un déploiement de masse sur les bases de production. </li></ul><br>  À suivre ... </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467575/">https://habr.com/ru/post/fr467575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467559/index.html">Événements numériques à Moscou du 16 au 22 septembre</a></li>
<li><a href="../fr467561/index.html">Un jour à partir du support utilisateur de PVS-Studio</a></li>
<li><a href="../fr467563/index.html">Un jour à partir du support utilisateur de PVS-Studio</a></li>
<li><a href="../fr467567/index.html">Prise en charge des couleurs 24 bits dans le terminal dans un tas de ssh + tmux + neovim</a></li>
<li><a href="../fr467573/index.html">Top 8 des filtres d'analyse utiles</a></li>
<li><a href="../fr467577/index.html">Mono Review: le meilleur appareil combo Playme P600SG</a></li>
<li><a href="../fr467581/index.html">Rendu des couleurs correct des rétroconsoles dans les émulateurs</a></li>
<li><a href="../fr467583/index.html">Gestionnaire de licences LMTOOLS. Liste des licences pour les utilisateurs de produits Autodesk</a></li>
<li><a href="../fr467587/index.html">Tous les contenus Wi-Fi utiles en un seul endroit</a></li>
<li><a href="../fr467589/index.html">Ce que vous devez savoir sur le RGPD en 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>