<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚰 🔂 🐌 顶级系统上的Linux设备硬件加密狗认证 🎎 🃏 ☀️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="工业物联网是对工业设施，建筑物，商业设施的工程系统进行监视，调度和自动化。 各种参数的传感器，仪表和控制器从这些对象收集数据，例如服务器机房中的温度和湿度，公寓楼中水表的读数，机房中的二氧化碳水平。 控制器处理此信息，并将所有内容发送到“云”。 

 Wiren Board生产用于工业物联网的Lin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>顶级系统上的Linux设备硬件加密狗认证</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/476304/"> 工业物联网是对工业设施，建筑物，商业设施的工程系统进行监视，调度和自动化。 各种参数的传感器，仪表和控制器从这些对象收集数据，例如服务器机房中的温度和湿度，公寓楼中水表的读数，机房中的二氧化碳水平。 控制器处理此信息，并将所有内容发送到“云”。 <br><br>  Wiren Board生产用于工业物联网的Linux控制器。 设备从油井和银行分支收集数据，监视服务器和超级市场中的小气候。 控制器与公司合作伙伴的顶级系统集成。 系统对设备进行身份验证-他们了解自己正在与自己的传感器（而不是与他人的传感器）通信，然后进行授权。 在这个阶段出现了一个问题-有成千上万的控制器，成百上千的客户，但是没有单一的集成系统。 简单的传统方法（例如登录名/密码对）容易受到攻击，并且部署不便。 <br><br><img src="https://habrastorage.org/webt/sk/xm/mt/skxmmtcf6uhcrlm0xkcqilqwjuo.jpeg"><br><br> 因此，该公司在使用硬件密钥的顶级系统中开发了身份验证-基于标准的非对称加密技术，使用硬件保护的元素来存储密钥。 现在，不需要统一的集成系统-保护了身份验证和授权，并且可以立即使用。  <b>Evgeny Boger</b>将告诉您如何执行此操作：他们如何选择“加密芯片”，如何将其固定在硬件和Linux上，如何使通用库和软件与它成为朋友。 特别强调部署：在生产中引入设备初始化，引入对各种顶级软件的支持，包括在别人的和封闭的软件中。 <br><a name="habracut"></a><br>  <b>关于发言人：</b> <b>Eugene Boger</b> （ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">evgeny_boger</a> ）-Wiren Board的首席技术官兼联合创始人。 从事嵌入式系统，尤其是嵌入式Linux。 <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/tbXmNAs5IrM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2> 问题所在 </h2><br> 首先，我们正在做什么，这个问题是从哪里来的。 我们在俄罗斯的Wiren Board设计和制造设备。 它曾经被称为M2M，但现在是工业物联网。 这是建筑工程系统的自动化，监视和调度。 简而言之，所有工作都是这样的：各种参数的传感器，执行器，计数器和控制器（边缘计算或IoT网关）从对象中收集不同的数据，对其进行处理，执行本地逻辑，然后将它们收集到一个大型的调度，监视或控制系统中。 <br><br><img src="https://habrastorage.org/webt/ns/fh/xa/nsfhxa9qezcmcuuc9y8kijenyhw.jpeg"><br><br> 与某些竞争者不同，我们没有一个完整的生态系统。 我们生产与合作伙伴的多个顶级系统集成的设备。 有很多合作伙伴公司，他们共同承担责任。 没有良好的技术手段，整合将无法进行-只是无法谈判。 <br><br> 有两种简单的解决方案可以解决这些问题。 第一个是像每个人一样<b>将用户名/密码提供给客户端</b> ，第二个是<b>在工作场所中生成并缝制“秘密”</b> 。 两种选择都不适合我们-我会告诉你原因。 <br><br><h2> 简单的解决方案 </h2><br>  <b>第一种解决方案是向客户端发出用户名和密码</b> 。 直到最近，我们所有人都这样做。 <br><br> 要验证将数据发送到某个系统的设备的身份，您可以创建一个秘密密钥-有条件的登录名/密码（“秘密”）。 这在控制器和从多个控制器收集数据的顶级系统上很常见。 <br><br> 必须以某种方式将几个用户名/密码（一个常见的“秘密”）提供给客户-公司或个人。 必须有人生成一个秘密对，通过电子邮件发送，通过帐号对客户端进行身份验证。 这是标准程序-低技术。 <br><br>  <b>问题</b> 。 就是我们有很多这样的系统。 我们的客户，他可以将数据发送到我们合作伙伴的系统。 这是所有参与方之间的复杂交互。 <br><br> 除了许多系统的问题外，还有其他问题。 <br><br><ul><li>  <b>交货不良并交付给客户</b> 。 <br></li><li>  <b>登录名和密码存储在服务器上</b> 。 如果我们还存储散列，这将使我们免受泄漏的影响。 但是即使如此，当所有客户端控制器的密钥存储在服务器上时，仍然会出现令人不快的感觉。 其中一些可以处理关键任务：室外照明，监控石油钻机。 <br></li><li>  <b>服务之间的同步</b> 。 <br></li><li>  <b>损失追回</b> 。 当客户端擦除控制器的内存时，不清楚丢失时该怎么办-我应该在哪个内存中写入？ 您必须再次重复一遍。 <br></li><li>  <b>防止复制详细信息</b> 。 有付费的监视系统，可为客户提供服务并收取订阅费。 我不希望最终客户能够通过我们以某种方式绕过系统-支付一次，但使用两次。 <br></li></ul><br>  <b>第二种解决方案是在生产中生成并缝合“秘密”</b> 。 这是对先前解决方案的改进。 <br><br> 方案是这样的：作为控制器的制造商，我们为每个人预先生成了用户名和密码，将它们缝入我们的系统并输入到设备中。 无法读取或更改设备的登录名和密码。 这比以前的选择要好，因为它不需要人与人之间的互动。 <br><br>  <b>问题</b> 。 除了第一个问题，所有问题仍然存在，但主要问题是<b>服务和Intranet之间</b>的<b>同步</b> 。 服务很多，尚不清楚如何同步它们-因此，我们无法实现第二种解决方案。 我们有在封闭网络中使用设备的客户。 我们发布了一个新的控制器，并将其出售给客户，并且他的系统已关闭。 它已设置，只能运行一次，并且很难进一步传达“秘密”。 批量报告？ 尽管技术上很简单，但组织中的一切都很复杂。 <br><br> 两种解决方案都不适合我们。 因此，我们决定采取不同的方法。 但是在此之前，他们决定概述共同的目标。 <br><br><h2> 任务与目标 </h2><br> 首先常见的任务。 <br><br>  <b>认证方式</b> 这是一种了解谁正在与顶级系统进行对话，谁与调度系统完全连接的方法。 <br><br><blockquote> 身份验证不是在授予或限制访问权限，而是一种了解谁在与我们交谈的方式。 </blockquote><br>  <b>发送数据的任务</b> 。 我们的控制器是专为特殊任务而设计的Linux计算机。 我们需要它们将数据发送到顶级系统，并通过VPN连接。 同时，我们希望调度能够“开箱即用”地工作-无需客户以及系统的最终用户与我们以及与客户之间的设置和交互。 <br><br>  <b>其他任务</b> 。 这是可靠的连接，数据通道加密，但是另一个问题是<b>授权</b> 。 授权任务与外部服务相关联，分为三个部分。 <br><br><ul><li>  <b>免费制造商服务</b> 。 通过设备序列号提供访问权限。 <br></li><li> 为合作伙伴提供的服务<b>的序列号白名单</b> -将购买和访问链接到客户的帐户。 <br></li><li>  <b>执照</b> 根据证书中指定的选项允许或拒绝访问。 <br></li></ul><br> 解决问题是我们要实现的目标。 <br><br>  <b>向客户发行和交付</b> 。 没有人的参与-信息是由生产中的机器人缝制的。 <br><br>  <b>损失追回</b> 。 我们希望绝不丢失任何秘密细节。 <br><br>  <b>从生产到服务交付</b> 。 我们想要没有它，因此您不需要向服务交付任何东西。 在启动新设备时，我们不想更新应该对这些设备进行身份验证的所有服务的数据库。 <br><br>  <b>存储在服务器上</b> 。 建议不要在此存储任何内容。 <br><br>  <b>服务和Intranet之间的同步</b> 。 建议不要同步任何内容-因为我们不会存储任何内容。 <br><br>  <b>防止复制详细信息</b> 。 我们想要一个秘密，要花钱，这是不可能免费复制和接收的。 <br><br><h2> 数字签名急救 </h2><br><blockquote> 电子数字签名（EDS）是一项使我们一切正常的技术。 </blockquote><br> 就像普通签名一样，只有数字签名。  EDS易于验证，但很难伪造。 密码学已经有数十年的历史了。 <br><br> 如果您知道秘密私钥（私钥），则电子签名就是消息可以计数的东西。 如果您知道公用密钥（公用密钥），则很容易验证消息的电子签名是否正确。 名字很清楚-公众习惯于告知所有人，而秘密仅适用于签名的人。 <br><br><blockquote> 所有签名和密钥都只是数字。 </blockquote><br> 在我们的例子中，这是32字节的数据，可用于数学“魔术”。 数学可确保签名易于验证，但难以伪造。 <br><br> 我们使用签名ECDSA-256 + SHA-256： <br><br><ul><li> <code>e = HASH(m)</code> -密码哈希函数将消息m不可逆地转换为数字e； <br></li><li>  <code>private key (dA)</code> -随机数； <br></li><li>  <code>public key (QA)</code> -从私钥生成，但反之则不； <br></li><li>  <code>signature (r,s) = sign(private key, e)</code> -签名; <br></li><li>  <code>verify(public key, signature, e)</code> -签名的验证。 <br></li></ul><br><h3>  EDS认证。 第一次尝试 </h3><br> 使用这种棘手的机制，对于一个简单的方向，而在另一个困难的方向上起作用，可以为我们的任务做什么呢？ <br><br>  <b>向客户发行和交付</b> 。 我们为生产中的每个设备生成一个随机私钥。 我们不会告诉任何人，因为我们甚至都不认识他，因此我们会写信给该设备。 <br><br>  <b>从生产到服务交付</b> 。 接下来，我们仅使用此设备的公钥对服务进行身份验证。 在服务方面，我们仅存储公共密钥列表而不是密码。 <br><br> 标准健康检查算法： <br><br><ul><li> 服务向控制器发送随机消息<code>m</code> ； <br></li><li> 控制器： <code>sign(private key, m)</code> ； <br></li><li> 控制器向服务发送签名； <br></li><li> 服务： <code>verify(public key, signature, m)</code> 。 <br></li></ul><br> 我们以这种方式决定的唯一一件事是，我们<b>不再</b>以开放或缓存的形式<b>将常见的“秘密”存储在我们的服务</b>中。 这不是我们想要的。 <br><br><h3>  EDS认证。 第二次尝试 </h3><br> 我们不想在服务上存储任何东西。 为此，我们可以强制设备将其公钥发送给服务。 <br><br> 在最后阶段，我们解决了两个问题。 第一个-我们<b>检查了他们是否提供了服务的密钥</b> 。 我们有一个公钥，这意味着我们也做了一个私钥。 第二个-我们确保<b>设备拥有私钥</b> ，该<b>私钥</b>位于USB闪存驱动器上的某个位置。 如果设备可以签名，则它具有私钥。 <br><br> 现在，设备还将把公钥发送到服务。 如何检查没有人拦截他，没有伪造他以及一切正常？ <br><br>  <b>检查公钥</b> 。 我们为自己创建了另一个公钥。 他将是我们作为制造商的关键。 这是根密钥“根私钥+公钥”。 在生产中使用此根秘密密钥，我们将对设备公用密钥进行签名，并将此签名存储在设备上。 设备必须将其公钥和其公钥签名发送给服务。 现在，该服务可以检查设备的公钥。 如果使用根私钥签名，则我们将发布此密钥。 <br><br><blockquote> 只有制造商-我们可以在设备上创建并存储签名，但请检查所有内容。 </blockquote> 我们在“联系人”部分的网站上发布公钥。 任何人都可以拿走它并检查将设备发送到服务的设备的公钥。 然后，您可以验证设备本身具有自己的私钥。 <br><br> 通用算法如下所示。 <br><br><ul><li>  <code>(once) random root private key</code> ； <br></li><li>  <code>factory: random device private key</code> ； <br></li><li>  <code>factory: sign(root private key, device public key) = signature_1</code> ； <br></li><li>  <code>device-&gt;service:  device public key + signature_1</code> ； <br></li><li> <code>service: verify(root public key, signature_1, device public key)?</code> <br> </li></ul><br><h3> 第二次尝试结果 </h3><br> 我们解决了<b>交付</b>给客户的问题-信息被存储在生产现场， <b>无需恢复任何东西</b> 。 <br><br> 我们解决了<b>将“秘密”传递给顶级服务</b>的问题非常重要，因为所有需要存储在服务中的都是制造商的公钥。 整个密钥为33个字节。 借助他们的帮助和数学魔术，您可以继续建立握手连接，并验证设备是否具有相应的私钥。 <br><br>  <b>在服务器上，</b>我们仅存储制造商密钥（根公共密钥）。 <br><br> 我们已经谈到过， <b>服务和Intranet之间</b>没有<b>同步</b> 。 同样，我们也无法<b>防止复制细节</b> 。 <br><br> 我们唯一忘记的是<b>身份验证</b> 。 该设备发送了一个私钥，我们检查了该私钥并发出了它，并检查了该设备是否拥有它。 但是我们不知道这是哪种设备，我们生产了数千种。 <br><br> 因此，我们应用了一个称为“证书”的技巧。 <br><br><h2> 认证和证书 </h2><br> 在这一步中，在所有带有签名及其检查的数学魔术中，我们添加<b>其他信息-证书</b> 。 为此，我们不仅要在工厂登录公钥（设备公钥），还要在密钥中附加其他信息。 <br><br> 在我们的案例中的其他信息。 <br><br><ul><li> 生产日期和制造商。 <br></li><li> 型号和硬件配置。 <br></li><li> 可以验证设备的序列号。 <br></li><li> 选项：硬件和软件。 不同的配置在物理上可能不会彼此不同，但是证书将包含有关客户所支付费用的信息。 <br></li><li> 客户名称和帐号。 <br></li></ul><br> 我们将使用生产者密钥-根公共密钥将所有这些信息与公共密钥一起签名。 之后，信息将转到服务，他们将能够确保信息正确。 由于这些是我们和合作伙伴的服务，因此他们信任我们。 <br><br><h3> 目标状态 </h3><br> 信息也在工厂缝制，无需<b>交付</b>服务。  <b>在服务器上，我们</b>仅存储制造商的密钥。 <br><br>  <b>损失追回</b> 。 我们将证书中的所有信息都缝到设备的闪存中。 从理论上讲，它可以被意外或有意删除，但是证书中的此信息没有什么秘密。 甚至签名本身也不是秘密-有公共密钥，并且带有我们密钥的签名。 证书中的唯一秘密是具有不同选项的设备的销量。 <br><br> 证书可以存储在工厂中，如果丢失，则将其发送给客户。 客户端很少专门擦除内存的服务区域。 通常，我们在设备恢复过程中执行此操作：设备是从客户端到达的，它已完全通过初始化传递，所有内容都被删除，再次下载，然后从工厂数据库复制了证书。 <br><br> 我们没有丢失<b>恢复</b> ，复制保护和<b>服务之间的同步</b> 。 <br><br>  <b>在认证阶段，</b>我们接收并验证证书。 我们了解这是什么类型的设备-我们知道制造商，型号和序列号，以及他能或不能做什么。 <br><br><h3> 登入 </h3><br> 证书允许您存储授权信息。 <br><br>  <b>免费制造商服务</b> 。 知道设备的序列号，您便可以访问所有人。 在我们的服务中，我们可以访问所有基本客户。 <br><br>  <b>白名单的序列号</b> 。 为了给我们的合作伙伴提供服务，您可以创建一个带有序列号白名单的表格：“客户从我们这里轻松地购买了两个控制器，这些控制器的序列号与他的帐户相关联” <br><br>  <b>执照</b> 您可以预先出售一些东西，然后<b>根据</b>证书中指定<b>的选项（</b>具有系统X许可证的控制器）允许或拒绝访问。 <br><br> 服务，系统的制造商或制造商之间没有共同的基础。 当一切在系统中进行身份验证时，所有内容都仅由我们作为制造商签名的控制器上的信息起作用。 <br><br><h2> 中级证书 </h2><br> 我们在旅途中解决的另一个技术问题。 在我刚才提到的方案中，有制造商的根证书-根私钥。 每次创建设备时都需要它。 但是，如果有许多设备，则此密钥需要对有限的人群持续访问。 这很糟糕，因为如果丢失了它，则必须更新所有服务上的公钥，并且它不应被攻击者使用。 这些是组织上的大问题。 但是有一个解决方案。 <br><br><blockquote> 我们将中间密钥引入一批不太容易丢失的设备。 </blockquote><br> 我们做了同样的事情，只是链条更长。 <br><br><img src="https://habrastorage.org/webt/x-/mb/s3/x-mbs3xfmihxr-qjdmpm7f5buey.jpeg"><br><br> 凭制造商的证书，我们在中间密钥上签名。 从物理上讲，这是一个“闪存驱动器”，在工厂交给领班一天。 硬件限制了密钥可以签名的设备数量。 在该方案的中间，我们添加了一个中间证书，否则没有任何变化。 <br><br><h2> 安全密钥库 </h2><br> 在所有这些方面，我们没有<b>为设备的私钥</b>提供足够的<b>保护</b> -这仍然是USB闪存驱动器上的文件。 攻击者可以复制它，但很可能会丢失它或意外打开访问权限。 <br><br> 在理想情况下，最好防止设备的私钥被复制-将其放在黑盒中。 <br><br> 黑匣子执行4个操作： <br><br><ul><li> 内部本身根据请求生成密钥，但不提供； <br></li><li> 提供公钥； <br></li><li> 签名消息 <br></li><li> 验证签名。 <br></li></ul><br><img src="https://habrastorage.org/webt/by/ck/zf/byckzfred-odhrigx-ayq2gkytk.jpeg"><br>  <i>要验证签名，您只需要一个公共密钥，因此三个操作就足够了。</i> <br><br> 以我的理解，这应该是一种硬件解决方案，最好与处理器分开。 有多种选择，最好的是<b>在SoC内部</b>或作为单独的芯片使用<b>特殊的加密处理器</b> 。 <br><br> 我们审查的第一个黑匣子选项是我们使用的NXP i.mx 6、7、8处理器中的CAAM <b>模块</b> 。 问题在于它是在处理器的Boot ROM中以编程方式实现的。 <br><br> 它可能包含可以通过其他处理器功能找到甚至利用的错误。 几年前，在此模块中发现了一个漏洞，使下载固件时可以绕过签名验证。 这不是我们需要的功能，但沉积物仍然存在。 另一个问题是，很难将带有此模块的处理器导入俄罗斯；它们需要填写文书。 <br><br> 因此，我们采用了单独的芯片。 老实说，我指望这样的事实：如果我们不能将它带到俄罗斯，我们会想出一些办法-芯片很小，价格为1美元。 但是一切都很好-他们找到了已经有所有论文的<b>Microchip ATECC</b>芯片。 <br><br><h2> 芯片ATECC608A </h2><br> 这是一个单独的小芯片，需要花费一分钱。 芯片通过I2C连接-处理器的两个“分支”，您也可以与其他外围设备共享。 该芯片具有标准引脚排列。 我们在设备的第一个版本中使用了该芯片，并将其焊接在具有相同协议和引脚排列的另一芯片上，因为这是标准的。 <br><br> 该芯片可以完成我们需要的此类芯片：读取签名，存储密钥等等。 <br><br><img src="https://habrastorage.org/webt/_h/sb/jb/_hsbjbw9dyvjo2ta5emvp_wuqk4.jpeg"><br><br> 特点 <br><br><ul><li>  16个按键槽； <br></li><li> 可以读取ECSDSA签名，哈希，MAC和加密AES，可以DH； <br></li><li> 有一个随机数发生器和密码计数器； <br></li><li> 外壳：SOIC-8，DFN6; <br></li><li> 协议：I2C，单线； <br></li><li>  ~0.7$@1000片 <br></li></ul><br><h3> 如何使用微电路 </h3><br> 有不错的<b>文档</b> ，但是在NDA下。 如果您立即写信给gamma.spb.ru，那么他们将在2周内将其给您。 如果在另一家公司-3个月后。 我们写信给两家公司，当我们完成所有工作后，另一位Microchip经销商回答了我们。 <br><br>  <b>应用笔记很少</b> ，而且比平均水平还差。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub上</a>有<b>软件</b> -具有HAL的库。 很好笑-该文档位于NDA下，其上编写的软件位于GitHub上。 该软件不支持Linux，但是支持Raspberry Pi和Atmel MK-有点不同。 开发人员认为，在所有设备上只有一条I2C总线，例如，在Raspberry Pi上称为支脚。 <br><br> 与<b>OpenSSL</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">集成</a> -不能很好地工作，但是可以。  <b>Linux下没有示例，</b>也无法进行<b>个性化设置</b> 。 <br><br><h3> 芯片定制 </h3><br><blockquote> 个性化是芯片最大的麻烦。 </blockquote><br> 问题在于该芯片可以完成很多事情。 它有16个插槽，其中存储了16个密钥：用户数据或公共密钥，或其他插槽的临时存储-有很多选项。 <br><br> 您需要以某种方式限制对插槽的访问，并且还有许多配置选项：通过密码，通过另一个插槽中的身份验证，通过访问工厂的时间进行限制。 <br><br><img src="https://habrastorage.org/webt/-a/du/mm/-adumml8w8ijipo3nbep8jz5nry.jpeg"><br>  <i>在表中，键的类型，读写访问权限，插槽之间的关系-SlotConfig，KeyConfig。</i> <br><br> 在我们使用的每个密钥的位掩码（16位）中，到处都有不同的数字。 <br><br> 最可悲的是，配置区域是一次性的，它设置了插槽的功能。 在做正确的事情之前，我们弄乱了50个筹码。 该芯片仅<b>在锁定配置后</b>才能工作。 另外， <b>每个插槽</b>都有一个<b>锁</b> <br><br> 示例或软件中没有文档。 有单个位的文档，但是那里的一切都很复杂。 在Microchip的所有示例中都写着：“下载这样的块，它将以某种方式为您工作，就像向Amazon发送数据的示例一样。” <br><br> 这花费了很多时间，但是在此过程中，他们做了一个很酷的实用程序。 <br><br><h3>  Atecc-util实用程序 </h3><br> 这是一个控制台实用程序，可以执行芯片的大部分功能，并使其变得更容易使用。 根据MIT许可，它可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在GitHub上</a>使用。 <br><br> 该实用程序使用CryptoAuthLib。 她知道如何在配置区域中更友好地工作，她知道如何与SHA，MAC，ECDSA和DH一起工作。 该界面是批处理友好的，因为我们首先创建了用于脚本的实用程序。 一个人可以引起它的事实是一个附带特征。 该实用程序可以列出一个列表-命令计划：“首先，个性化该区域，然后写下这样的密钥。” <br><br> 调用实用程序的示例非常容易理解。 <br><br><pre> <code class="plaintext hljs">atecc - b 10 - c 'serial' - c 'read-config /tmp/config.dump'</code> </pre> <br> 该实用程序在Linux下，AMD64下构建-它在Debian软件包中。 <br><br><img src="https://habrastorage.org/webt/lc/yr/bs/lcyrbsjcuggnfwuzetwwjy3auxg.jpeg"><br><br><h3> 其他个性化工具 </h3><br> 我们有一个Excel标牌来读取这些位。 如果您向我们展示了使用Microchip进行的NDA扫描，我们将把它交给您。 <br><br><img src="https://habrastorage.org/webt/gs/j5/r9/gsj5r9tr6ngrcascp8tqxdq6dla.jpeg"><br><br> 我们涵盖了所有测试内容，因为有很多选项可以让您忘记一位，而某些服务命令将读取您的私钥。 测试测试真实设备。 他们转向微电路并检查设备上的正确配置：是否可以读取此插槽，可以进行签名？ <br><br> 与这些位并行，我们创建了该设备应满足的保证的列表，并检查了所有工作方式。 我们使用<b>蝙蝠框架</b> -非常有趣的事情。 看起来像这样。 <br><br><img src="https://habrastorage.org/webt/wr/kd/op/wrkdopidmf6zn2ko70ue36p7fxc.jpeg"><br>  <i>示例的测试列表。</i>  <i>较高的通过了，较低的没有通过。</i> <br><br><h3> 设备中的设置 </h3><br>  <b>对于我们自己，我们仅使用两个插槽</b>来执行我正在谈论的任务。 在这两者中，我们存储设备的私钥。 区别在于前者与<b>永久证书</b>相关联，该<b>证书</b>于1970年颁发了200年。 <br><br> 这是由于以下事实：在物联网中，时间并不总是同步的。 证书基础结构涉及验证证书的有效性。 如果设备上的同步中断，则某些重要服务可能会失败，例如VPN。 <br><br> 因此， <b>一个插槽是无限永久的</b> 。 它仅生成一次，并且在设备的整个生命周期中都不会改变。 对于此密钥，将为封闭网络生成200年的证书。 <br><br> 另一个插槽正在更新。 证书的最长有效期为一年。 这样做是为了以防万一。 随着设备证书的有效期到期，将生成私有可更新设备密钥。 用于开放网络中的身份验证，每月更新一次或更少一次，并附带证书。 <br><br>  <b>对于用户，我们生成了各种组合</b> ，包括用于ECDSA专用密钥的多个插槽。 如果用户不信任我们的私钥，则可以在单独的插槽中生成其密钥。 为此，您只需要信任Microchip。 用户可以阅读签名，进行加密-我们提供了芯片可以做的一切。 <br><br> 不幸的是，到目前为止，还没有人使用过，但我们希望如此。 <br><br><h3> 基础结构：中级密钥 </h3><br> 我已经说过，在某些时候，我们实施了中间证书，以免与不应丢失的根证书保持一致。 他从没出现在工厂。 <br><br><img src="https://habrastorage.org/webt/uh/m0/dl/uhm0dl6mdkegvzwl2avlsqpe7kc.jpeg"><br><br> 物理中间证书是ATECC508A芯片。 它与608略有不同，但是在508中，有一些功能对于按键很方便，但是在608中，它不再存在。 <br><br> 该芯片通过USB-I2C适配器连接。 这是带有tiny-usb-i2c固件的USBISP-一个可以闪入USB-I2C桥接器的编程器。 中间证书使用其私钥对设备证书进行签名。 <br><br> 事实证明，微电路的两个功能对我们有用。 <br><br>  <b>硬件密码保护插槽</b> 。 只有满足以下两个条件，才能对芯片进行编程以读取签名： <br><br><ul><li> 当设备卡在计算机中时； <br></li><li> 输入密码。 <br></li></ul><br> 我们为工头提供了用于多个控制器的中间键和密码。 因此，您需要同时窃取密钥和密码才能获得访问权限。 我们免费获得了此机会，但它提高了系统的安全性。 <br><br>  <b>硬件对使用次数的限制</b> 。 内部的密码计数器只能增加。 当它一次达到预定极限时，微电路不会对其他任何东西进行签名。 <br><br><img src="https://habrastorage.org/webt/tm/qv/4-/tmqv4-eakpcudfupub3oy6nt9bw.jpeg"><br><br><h2> 客户端上的OpenSSL </h2><br> 让我们考虑一下一切如何在客户端上进行。 控制器上有OpenSSL。 我们没有发明任何东西-这是普通的TLS，普通的PKI。 我们还需要一个客户端库。 在绝大多数Linux软件中，它用于安全连接。 <br><br> 我们从Microchip那里获取了代码，并添加了一点代码，支持全新的OpenSSL。 <br>  1.1。 结果，他知道如何使用硬件密钥-硬件支持私钥的密码。 <br><br> 看起来像这样。 <br><br><pre> <code class="plaintext hljs">openssl req -new -engine ateccx08 -keyform engine -key ATECCx08:00:04:C0:00 -subj "/CN=wirenboard-AP6V5MDG" -out device AP6V5MDG.csr</code> </pre> <br> 这是对常规OpenSSL的调用，也是使用适当的引擎模块的说明。 在此处设置密钥：地址，型号和最后两个字节是所使用的插槽号。 一切都像是密钥文件一样传输，但不是文件-您需要进入设备。 <br><br><h2> 服务器上的SSL </h2><br> 任何SSL均可在服务器上使用，包括OpenSSL。 无需在服务器端进行任何修改和自定义构建。 服务器上需要做的就是<b>能够检查证书捆绑链</b> （设备证书+中间证书），并<b>存储我们</b>在站点上发布的<b>公共密钥</b> -Wiren Board ROOTCA。 <br><br> 标准TLS表示，双方都必须相互认证。    —   —   .    —    handshake. <br><br>         :    .    ,         .   letsencrypt    SSL,   ,      . <br><br>       ,    — MQTT. <br><br><h2> MQTT: mosquitto   </h2><br>          IBM.               . <br><br> Mosquitto —       ,   ,  Linux.    ,   OpenSSL engine (  )    «keyfile»,     . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>   ,  20 . <br><br>     bundle. <br><br><img src="https://habrastorage.org/webt/ea/ju/ge/eajugei4pidm4h7ramzyhh-vpkq.jpeg"><br><br>             . <br><br><pre> <code class="plaintext hljs">mosquitto_sub -h mqtt.wirenboard.com -p 8884 -cert /etc/ssl/device/device_bundle.crt.pem --key 'engine:ateccx08:ATECCx08:00:04:C0:00' --capath /etc/ssl/certs/ -t /# -v</code> </pre> <br>     .     —    <code>-cert</code> .   bundle- — .      <code>--key</code> .       . <br><br>  ,    <code>--capath</code> ,    .       SSL-,     letsencrypt. <br><br>   <b> </b> . <br><br><pre> <code class="plaintext hljs">root@wirenboard-AXXVJI62:~# cat /etc/mosquitto/conf.d/bridge-hw.conf connection wb_devices_cloud.wirenboard-AXXVJI62 address contactless.ru:8884 bridge_capath /etc/ssl/certs/ bridge_certfile /etc/ssl/device/device_bundle.crt.pem bridge_keyfile engine:ateccx08:ATECCx08:00:04:C0:00 notifications true notification_topic /client/wirenboard-AXXVJI62/bridge_status topic/# both 1 ""/dient/wirenboard-AXXVJI62</code> </pre> <br> Mosquito-     . <br><br> <b>   Mosquitto</b> —    . <br><br><pre> <code class="plaintext hljs">per _listener_settings true listener 8884 0.0.0.0 cafile/etc/mosquitto/certs/WirenBoard_Root_CA.crt certfile /etc/letsencrypt/live/contactless.ru/fullchain.pem keyfile/etc/letsencrypt/live/contactless.ru/privkey.pem require.certificate true use_identity_as_username true password_file /etc/mosquitto/passwd.conf allow_anonymous false acl_file /etc/mosquitto/ad.conf :~$ cat /etc/mosquitto/acl.conf pattern write /client/%u/# pattern read /client/%u/#</code> </pre> <br>   —  . <br><br><ul><li>  Root CA  letsencrypt-   —   .     . <br></li><li>    Mosquitto.           <code>username</code>      MQTT. <br></li><li>  ,     , ,   (CN) wirenboard-AXXVJI62,   ,      . <br></li><li> <code>per_listener_settings:</code>   ,      / (&gt;1.5.5). <br></li></ul><br>    MQTT-  Wiren Board IoT Cloud Platform. <br><br><h2>  OpenVPN </h2><br> OpenVPN  ,      ,     .   ,                . <br><br>  OpenVPN <b> </b>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,   .       ,   : bundle,  , engine. <br><br><pre> <code class="plaintext hljs">openvpn --capath /etc/ssl/certs/ --cert /etc/ssl/device/device_bundle.crt.pem --key engine:ateccx08:ATECCx08:00:04:C0:00</code> </pre> <br> <b> </b>    letsencrypt. <br><br><pre> <code class="plaintext hljs">ca /etc/openvpn/WirenBoard_Root_CA.crt cert /etc/letsencrypt/live/vpn1.wirenboard.com/fullchain.pem key /etc/letsencrypt/live/vpn1.wirenboard.com/privkey.pem</code> </pre> <br>     —       .      -  . <br><br><h2>  Nginx的 </h2><br>   . Nginx   ,    ,        , SSL.      nginx     web-,  reverse-proxy.   —      nginx. <br><br> nginx   ,  HTTP-,       .   ,       : Common Name,      ,        .   ,   400. <br><br><pre> <code class="plaintext hljs">ssl_client_certificate WirenBoard_Root_CA.crt; ssl_verify_client on;</code> </pre> <br> <b>nginx  </b> .     — ,     HTTP.  Linux-   nginx  ,        SSL,   ,   OpenSSL. <br><br>    wget  , bash    ,   HTTP-  TLS   .    10 . <br><br><pre> <code class="plaintext hljs">server { listen 8080; location / { proxy_pass https://example.com; proxy_ssl_name example.com; proxy_ssl_server_name on; proxy_ssl_certificate/etc/ssl/device/device_bundle.crt.pem; proxy_ssl_certificate_key engine:ateccx08;ATECCx08:00:04:C0:00; } }</code> </pre> <br><h2>   </h2><br>      <b>Wiren Board 6</b> ,     .     ,       . <br><br>         web-   cloud.wirenboard.com  OpenVPN  .     Grafana  InfluxDB,      MQTT.     saymon.info —    (MQTT)  . <br><br>      ,  -  ,     , Grafana, MQTT-,   ,  , .   — . <br><br>  ,    ,   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> —  OpenSSL    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> —  .  ! <br><br><blockquote>           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">InoThings Conf 2019</a> .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">YouTube-</a>       2019 .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>  Telegram.     ,  ,       IoT. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476304/">https://habr.com/ru/post/zh-CN476304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476292/index.html">SVG还是画布？</a></li>
<li><a href="../zh-CN476294/index.html">分布式游戏网络是GFN的替代产品：它如何起飞，为何起飞以及在俄罗斯已经开始运作的地方</a></li>
<li><a href="../zh-CN476296/index.html">11月21日，产品工程聚会：谁是产品工程师？</a></li>
<li><a href="../zh-CN476298/index.html">踏上自行车的荆棘，第1部分：了解使用插件自定义Visual Studio调试器的基础知识</a></li>
<li><a href="../zh-CN476300/index.html">《电车》杂志是俄罗斯儿童先锋派的一颗闪闪发光，褪色很快的明星</a></li>
<li><a href="../zh-CN476306/index.html">TelegramBot说明，用于为机器人创建基本功能。 （第1部分）</a></li>
<li><a href="../zh-CN476308/index.html">2020年将遵循的5大软件开发实践</a></li>
<li><a href="../zh-CN476310/index.html">人脸CRM</a></li>
<li><a href="../zh-CN476312/index.html">React或Angular或Vue.js-选择什么？</a></li>
<li><a href="../zh-CN476316/index.html">Vue店面：在ES中填充数据</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>