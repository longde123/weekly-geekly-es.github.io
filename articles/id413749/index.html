<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé§ ü•¶ üë®üèø‚Äçü§ù‚Äçüë®üèæ B + tree dalam proyek nyata üßìüèª üçã ‚úçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, kita akan melihat secara terperinci bagaimana pohon B + dibuat dalam database Apache Ignite yang didistribusikan. 




 Sudah ada be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>B + tree dalam proyek nyata</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/413749/"><p>  Pada artikel ini, kita akan melihat secara terperinci bagaimana pohon B + dibuat dalam database <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apache Ignite yang</a> didistribusikan. <br></p><br><img src="https://habrastorage.org/webt/mv/_t/zg/mv_tzg1o-c96a2ib19cf9umv67u.jpeg"><a name="habracut"></a><br><p>  Sudah ada beberapa artikel tentang pohon-H di pohon-B ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">satu</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dua</a> ), tetapi mereka lebih cenderung teoretis dan bahkan jika mengandung implementasi, maka mereka belum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">siap produksi</a> .  Dari sini ada minat untuk melihat implementasi yang digunakan dalam kehidupan. </p><br><p>  Sebelum membaca artikel lebih lanjut, saya menyarankan Anda untuk menonton <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kuliah oleh Maxim Babenko</a> , jika Anda masih tidak tahu apa teori B-tree secara teori.  Tapi saya tidak perlu terlalu mengenal Java atau proyek Apache Ignite - saya akan menulis detailnya secara eksplisit atau menyembunyikannya di bawah spoiler. </p><br><p>  Saat membaca sumber Ignite, saya menyarankan Anda untuk melompati argumen metode dalam pikiran Anda, yang maknanya tidak terlalu jelas dan untuk membaca nama-nama fungsi - jauh lebih mudah untuk membaca isi fungsi jika Anda tahu sebelumnya apa fungsinya. </p><br><p>  Harap dicatat bahwa saya bukan pengembang utama Apache Ignite dan bisa salah mengerti sesuatu dari kode.  Jadi, saya mengeluarkan frasa "sejauh yang saya mengerti", yang harus ditambahkan secara mental sebelum setiap kalimat afirmatif. </p><br><h1 id="zachem-b-derevo-v-apache-ignite">  Mengapa pohon B + di Apache Ignite </h1><br><p> Apache Ignite adalah basis data dalam memori, tetapi karena versi 2.1 ia memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penyimpanan data persisten</a> - fungsi untuk menyimpan data ke disk <em>(tidak ada hubungannya dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">struktur data persisten</a> )</em> .  Oleh karena itu, jelas mengapa struktur diperlukan untuk memori eksternal, masih memahami mengapa mereka tidak memilih yang lain. </p><br><p>  Untuk mulai dengan, pohon B + adalah optimasi dari pohon-B, di mana nilai disimpan hanya dalam daun.  Dalam pengoptimalan ini, lebih banyak kunci masuk dalam sebuah simpul, yang meningkatkan tingkat percabangan.  Oleh karena itu, tidak ada banyak alasan untuk menggunakan B-tree klasik. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">B *</a> dan B + * - lebih padat pada disk, tetapi mereka memiliki kinerja yang lebih buruk, karena  kami menyimpan data dari RAM, kinerja lebih penting bagi kami. </p><br><p>  Dilihat berdasarkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tolok ukur,</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pohon LSM</a> lebih cepat dalam menulis, tetapi lebih lambat dalam membaca.  Selain itu, kerugian dalam membaca lebih besar daripada keuntungan dalam menulis, jadi untuk kasus umum hipotetis, saya juga akan mengambil pohon B +. </p><br><p>  Ada juga <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pohon fraktal yang</a> aneh, namun, tampaknya, mereka dipatenkan dan diimplementasikan hanya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">TokuDB</a> . </p><br><p>  Secara pribadi, saya lebih tertarik pada mengapa tidak mungkin untuk mengambil backend disk yang sudah jadi, seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">LevelDB</a> ?  Jawaban parsial adalah bahwa PDS mendukung penyimpanan pihak ketiga. </p><br><h1 id="realizaciya-v-krupnuyu-kletku">  Implementasi Sel Besar </h1><br><p> Awalnya, GridGain mengembangkan Apache Ignite, tetapi sebelum berangkat ke open-source, ia memakai nama perusahaan, jadi beberapa nama komponen dimulai dengan <code>Grid</code> dan yang lainnya dengan <code>Ignite</code> .  Oleh karena itu <code>GridCursor</code> , tetapi <code>IgniteTree</code> .  Tidak ada logika lain di sini. </p><br><p>  Kode Apache Ignite ditulis dalam pola praktik terbaik Java, dan setiap kelas mewarisi antarmuka, jika tidak satu.  Dari antarmuka <code>IgniteTree</code> dan mulai tariannya.  Saya memberikan kode tanpa javadoc, singkatnya. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T val)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key, Object x, InvokeClosure&lt;T&gt; c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper, Object x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvokeClosure</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable T row)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">OperationType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operationType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OperationType { NOOP, REMOVE, PUT } }</code> </pre> <br><p>  Antarmuka <code>IgniteTree</code> menggambarkan serangkaian operasi standar.  Harap perhatikan bahwa memiliki pencarian rentang mengharuskan Anda untuk merajut daun dalam daftar.  Bonus mendukung operasi catatan yang sewenang-wenang - <code>invoke</code> . </p><br><p>  Operasi <code>put</code> hanya membutuhkan satu argumen tipe <code>T</code> tanpa kunci.  Anda tidak akan menemukan penjelasan untuk ini di <code>IgniteTree</code> , namun jawabannya tersembunyi di header <code>BPlusTree</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BPlusTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataStructure</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Seperti yang Anda lihat, nilai mewarisi kunci, oleh karena itu, dalam operasi put, kunci dihitung dari nilai.  Ini tidak membatasi fungsionalitas pohon.  Asumsi saya adalah lebih kompak untuk menyimpan set. </p><br><p>  Biasanya mereka membuat set peta dengan menempelkan konstan sampah ke nilai.  Namun, dalam pohon B +, <em>hanya kunci yang</em> disimpan dalam node, jika nilainya juga menyimpan kunci, maka di daun itu cukup untuk menyimpan <em>hanya nilai-nilai</em> .  Dan jika pohon adalah satu set, maka secara otomatis ternyata di daun hanya akan ada kunci tanpa nilai sampah. </p><br><p><img src="https://habrastorage.org/webt/gk/5a/mj/gk5amjeohtkej5assnsgyy791p4.png"></p><br><p>  Sekarang mari kita lihat kode pencarian elemen. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> g Get. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IgniteCheckedException If failed. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Get g)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. g.init(); switch (findDown(g, g.rootId, 0L, g.rootLvl)) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; default: return; } } } /** * @param g Get. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result findDown(final Get g, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { long page = acquirePage(pageId); try { for (;;) { // Init args. g.pageId = pageId; g.fwdId = fwdId; Result res = read(pageId, page, search, g, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert g.pageId != pageId; assert g.fwdId != fwdId || fwdId == 0; // Go down recursively. res = findDown(g, g.pageId, g.fwdId, lvl - 1); switch (res) { case RETRY: checkInterrupted(); continue; // The child page got split, need to reread our page. default: return res; } case NOT_FOUND: assert lvl == 0 : lvl; g.row = null; // Mark not found result. return res; default: return res; } } } finally { if (g.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  Dasar dari algoritma B-tree traversal tetap tidak berubah: mereka secara rekursif turun pohon ke daun yang diinginkan: jika nilainya ada, maka mereka mengembalikan hasilnya, dan jika tidak, maka <code>null</code> .  Rekursi itu rupanya dibiarkan nyaman, toh, pohon-B tidak dalam. </p><br><p><img src="https://habrastorage.org/webt/tc/g3/0t/tcg30to_z-6fcrfegjfulubh0gq.jpeg"></p><br><p>  Saya terkejut karena ada instalasi yang jelas di kepala saya: rekursi selalu dihapus dalam proyek nyata ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tidak ada optimasi rekursi ekor di Jawa</a> , rekursi dapat diterima dalam proyek dalam bahasa lain).  Tapi sungguh, ketinggian pohon-B diukur dalam satuan, karena ukuran blok pesanan <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 2 ^ {10} </script>  , dan jumlah data pesanan <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2 ^ {40} </script>  dan tingginya akan <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mn>4</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.975ex" height="2.901ex" viewBox="0 -935.7 10753.2 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-29" x="2962" y="0"></use></g><g transform="translate(5566,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-29" x="2962" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-3D" x="9196" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhi2V1G1hT9WCL3rS3SWqf00pOgGtA#MJMAIN-34" x="10252" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mo>=</mo><mn>4</mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ frac {log (2 ^ {40})} {log (2 ^ {10})} = 4 </script>  . </p><br><p>  Apache Ignite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menyukai konkurensi</a> .  Karena itu, pohon mendukung modifikasi kompetitif.  Pada saat operasi, satu halaman diblokir, tetapi utas lainnya dapat memodifikasi sisa pohon sehingga diperlukan pembacaan kedua.  Sehingga prosedur dapat mencapai root. </p><br><p>  Pada awalnya, saya tidak mengerti arti fungsi seperti itu, karena disknya lambat dan satu utas akan dengan tenang memproses semua operasi I / O.  Jelas bahwa pencarian di node yang dimuat dari disk sedikit biaya dan selama waktu ini Anda dapat memuat disk dengan operasi lain, tetapi upaya berulang akan memakan keuntungan.  Namun, kemudian saya sadar bahwa dalam implementasi ini node tidak segera memerah ke disk setelah modifikasi, tetapi mereka menggantung di memori untuk sementara waktu, untuk kemudian segera menerapkan banyak modifikasi.  Tidak ada data yang hilang berkat Write Ahead Log.  Lebih lanjut tentang itu akan ada di akhir artikel. </p><br><p>  Sekarang mari kita lihat kode untuk menambahkan item. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> needOld)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ checkDestroyed(); Put p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Put(row, needOld); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. p.init(); Result res = putDown(p, p.rootId, 0L, p.rootLvl); switch (res) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; case FOUND: // We may need to insert split key into upper level here. if (!p.isFinished()) { // It must be impossible to have an insert higher than the current root, // because we are making decision about creating new root while keeping // write lock on current root, so it can't concurrently change. assert p.btmLvl &lt;= getRootLevel(); checkInterrupted(); continue; } return p.oldRow; default: throw new IllegalStateException("Result: " + res); } } } catch (IgniteCheckedException e) { throw new IgniteCheckedException("Runtime failure on row: " + row, e); } catch (RuntimeException e) { throw new IgniteException("Runtime failure on row: " + row, e); } catch (AssertionError e) { throw new AssertionError("Assertion error on row: " + row, e); } finally { checkDestroyed(); } } /** * @param p Put. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result putDown(final Put p, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { assert lvl &gt;= 0 : lvl; final long page = acquirePage(pageId); try { for (;;) { // Init args. p.pageId = pageId; p.fwdId = fwdId; Result res = read(pageId, page, search, p, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert lvl &gt; 0 : lvl; assert p.pageId != pageId; assert p.fwdId != fwdId || fwdId == 0; res = p.tryReplaceInner(pageId, page, fwdId, lvl); if (res != RETRY) // Go down recursively. res = putDown(p, p.pageId, p.fwdId, lvl - 1); if (res == RETRY_ROOT || p.isFinished()) return res; if (res == RETRY) checkInterrupted(); continue; // We have to insert split row to this level or it is a retry. case FOUND: // Do replace. assert lvl == 0 : "This replace can happen only at the bottom level."; return p.tryReplace(pageId, page, fwdId, lvl); case NOT_FOUND: // Do insert. assert lvl == p.btmLvl : "must insert at the bottom level"; assert p.needReplaceInner == FALSE : p.needReplaceInner + " " + lvl; return p.tryInsert(pageId, page, fwdId, lvl); default: return res; } } } finally { if (p.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  Satu-satunya perbedaan adalah bahwa setelah posisi terdeteksi, kode akan <code>replace</code> dan <code>insert</code> .  Anda tidak dapat lagi menonton kode <code>remove</code> .  Mekanisme dasarnya adalah bahwa dengan upaya berulang untuk berjalan secara rekursif melalui pohon bersama dengan objek khusus tergantung pada operasinya: <code>Get</code> , <code>Put</code> atau <code>Remove</code> . </p><br><p>  <code>Invoke</code> bekerja dengan cara yang sama, hanya operasi yang dilakukan dengan salinan catatan, maka jenisnya ditentukan: <code>NOOP</code> untuk membaca, <code>REMOVE</code> untuk menghapus dan <code>PUT</code> untuk memperbarui atau menambah, dan kemudian objek <code>Put</code> atau <code>Remove</code> sesuai dihasilkan, yang diterapkan pada catatan di pohon. </p><br><h1 id="ispolzovanie">  Gunakan </h1><br><p>  Di bawah ini saya akan melihat lebih dekat dua <code>BPlusTree</code> : <code>CacheDataTree</code> dan <code>PendingEntriesTree</code> .  Overboard adalah implementasi indeks - ini adalah topik untuk diskusi terpisah, yang belum saya siapkan. </p><br><p>  Sebelum melanjutkan, saya akan mengklarifikasi bahwa peta yang didistribusikan lokal memiliki fungsi <code>IgniteCache</code> dan disebut <code>IgniteCache</code> - selanjutnya hanya cache. </p><br><h2 id="cachedatatree"> <code>CacheDataTree</code> </h2> <br><p>  <code>CacheDataTree</code> adalah pemetaan beberapa <code>IgniteCache</code> ke disk.  Penyortiran bersifat multi-level: pertama-tama urutkan berdasarkan id cache ke kunci grup dalam satu cache, dan kemudian dengan hash. </p><br><p>  <code>CacheDataTree</code> tidak mengulangi rentang, karena indeks diterapkan pada penerus <code>H2Tree extends BPlusTree</code> , oleh karena itu, jenis penyortiran spesifik tidak penting: ada cukup untuk <code>put</code> dan <code>get</code> operasi.  Membandingkan hash lebih cepat dari objek.  Tapi yang lebih penting, hash yang seragam akan mengisi pohon lebih padat. </p><br><p>  Pohon seimbang sehingga tidak merosot menjadi daftar.  Tetapi jika Anda menambahkan kunci yang didistribusikan secara merata ke pohon pencarian, itu akan secara otomatis seimbang.  Karena B-tree mulai menyeimbangkan ketika masalah muncul, dan hash mencampur kunci secara merata, menyortir berdasarkan hash mengurangi frekuensi keseimbangan. </p><br><p>  Menggunakan hash di pohon pencarian bukanlah ide yang aneh karena tampaknya, pengembangan logisnya akan mengarah ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">trias array Hash dipetakan</a> . </p><br><h2 id="pendingentriestree"> <code>PendingEntriesTree</code> </h2> <br><p>  <code>PendingEntriesTree</code> menyimpan kunci untuk data dari waktu ke waktu dan digunakan sebagaimana diatur.  Penyortiran bersifat multi-level: pertama disortir berdasarkan id cache ke kunci grup dalam satu cache, dan kemudian menurut masa pakai.  Berikutnya adalah putaran perbandingan lainnya - tampaknya, murni teknis, untuk membedakan antara elemen-elemen.  Dari pengurutan, mudah ditebak bahwa kelas ini digunakan untuk mencari rentang.  Pohon ini menggandakan kunci entri cache untuk preemption. </p><br><p>  Pahami bagaimana petualangan terpisah ini bekerja. </p><br><div class="spoiler">  <b class="spoiler_title">Petualangan</b> <div class="spoiler_text"><p>  Di <code>IgniteCacheOffheapManagerImpl.expire()</code> ambil kursor dan hapus entri dari <code>PendingEntriesTree</code> .  Entri dalam <code>CacheDataTree</code> dihapus pada penutup <code>c</code> , yang diteruskan dalam parameter. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( GridCacheContext cctx, IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount )</span></span></span></span></code> </pre> <br><p>  Apache Ignite baru-baru ini berhenti mendukung Java 7, jadi penutupan dibuat melalui kelas anonim. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; expireC = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GridCacheEntryEx entry, GridCacheVersion obsoleteVer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> touch = !entry.isNear(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.isTraceEnabled()) log.trace(<span class="hljs-string"><span class="hljs-string">"Trying to remove expired entry from cache: "</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.onTtlExpired(obsoleteVer)) touch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GridCacheEntryRemovedException ignore) { entry = entry.context().cache().entryEx(entry.key()); touch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touch) entry.context().evicts().touch(entry, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } };</code> </pre><br><p>  Apa yang kami cari adalah dalam metode <code>GridCacheMapEntry.onTtlExpired()</code> , di mana baris yang berharga ada di blok <code>finally</code> . </p><br><pre> <code class="java hljs">cctx.cache().removeEntry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> </div></div><br><h1 id="detali-realizacii">  Detail implementasi </h1><br><h2 id="rabota-so-stranicami-v-offheap">  Bekerja dengan halaman di Offheap </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Offheap</a> adalah teknik untuk mengoptimalkan manajemen memori manual dalam bahasa dengan pengumpul sampah. </p><br><p>  Ini adalah mitos bahwa karena pengumpul sampah semuanya melambat, biasanya pengumpul biaya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">persentase kinerja yang menyedihkan</a> .  Bahkan tumpukan besar dalam diri mereka sendiri tidak menjadi masalah, karena  kolektor bekerja secara kompetitif (misalnya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">CMS dan G1</a> di Jawa), dan server memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">puluhan inti</a> .  Tentu saja, kolektor menambahkan jeda yang tidak terduga ke aplikasi, yang penting untuk game, tetapi dapat ditoleransi untuk database. </p><br><p>  Tapi apa yang sebenarnya menjadi masalah adalah pelanggaran hipotesis generasi pada tumpukan besar. </p><br><div class="spoiler">  <b class="spoiler_title">Hipotesis Generasi</b> <div class="spoiler_text"><p>  Optimalisasi GC menggunakan hipotesis generasi.  Hipotesis ini ada dalam dua versi: kuat dan lemah. </p><br><p>  <strong>Hipotesis generasi yang lemah:</strong> sebagian besar benda mati muda. </p><br><p>  <strong>Hipotesis kuat tentang generasi:</strong> semakin tua objek, semakin lama ia akan hidup. </p><br><p>  Hipotesis yang kuat menyiratkan yang lemah, tetapi tidak sebaliknya.  Idealnya, GC harus puas dengan memenuhi hipotesis yang lemah, tetapi dalam praktiknya tidak demikian. </p><br><p>  Lihat pembicaraan Alexey Shipilev tentang GC baru di Jawa, jika Anda ingin lebih memahami topik: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">satu</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dua</a> . </p></div></div><br><p>  Dan di sini ada hal yang sebelum munculnya PDS, Apache Ignite diposisikan terutama sebagai cache antara layanan dan database disk (misalnya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hadoop</a> ).  Oleh karena itu, peta di Ignite disebut <code>IgniteCache</code> dan memiliki fungsi ekstrusi yang sesuai.  Dan cache hanya melanggar hipotesis generasi - di dalamnya, probabilitas suatu objek yang dihapus meningkat seiring waktu.  Oleh karena itu, dalam hal ini, Offheap untuk menyimpan data pengguna meningkatkan kinerja. </p><br><p>  Lebih banyak bonus: </p><br><ul><li>  Offheap memudahkan untuk mengimplementasikan struktur yang mengandung lebih dari elemen <code>Integer.MAX_VALUE</code> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Jika Anda menyimpan banyak kurang dari 32GB, maka tautannya akan berbobot 4 byte</a> , yang menghemat beberapa gigabytes. </li><li>  Karena kolektor membuat grafik objek, ia mengkonsumsi memori secara proporsional dengan jumlah mereka.  Dan jumlah objek sebanding dengan heap.  Kolektor juga mengkonsumsi CPU, yang lebih baik dihabiskan untuk kompresi data, misalnya. </li><li>  Pada tumpukan yang sangat besar, bahkan jika hipotesis generasi tidak dilanggar secara keseluruhan, masih akan ada cukup banyak benda tua dalam nilai absolut yang akan melanggarnya. </li></ul><br><p>  Karena data kemudian dikirim ke disk, objek serial ke memori secara langsung melalui <code>unsafe</code> , dan kemudian area memori ini digunakan untuk buffer I / O. </p><br><h2 id="write-ahead-log">  Tulis log di depan </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Write Ahead Log</a> adalah log operasi dengan struktur linier, menambah biayanya konstan, tidak seperti pohon.  Pohon diperbarui lebih jarang, dan jika data hilang karena jatuh, mereka dipulihkan dari log dengan menerapkan operasi mulai dari keadaan tersimpan terakhir.  Hasilnya adalah peningkatan kinerja tanpa mengurangi keandalan.  Saya menyarankan Anda untuk melihat antarmuka <code>IgniteWriteAheadLogManager</code> - ada dokumentasi rinci. </p><br><h2 id="obhod-uzla">  Bypass node </h2><br><p>  Karena node di pohon-B tidak kecil, mereka dilewati oleh pencarian biner.  Untuk ini, keturunan dari kelas <code>BPlusTree.GetPageHandler</code> , dan untuk operasi yang berbeda mereka berbeda. </p><br><div class="spoiler">  <b class="spoiler_title">Implementasi pencarian biner</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInsertionPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lvl, BPlusIO&lt;L&gt; io, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> low, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cnt, L row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> row != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = cnt - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cmp = compare(lvl, io, buf, mid, row); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift; <span class="hljs-comment"><span class="hljs-comment">// We need to fix the case when search row matches multiple data rows. //noinspection Duplicates if (cmp &lt; 0) low = mid + 1; else if (cmp &gt; 0) high = mid - 1; else return mid; // Found. } return -(low + 1); // Not found. }</span></span></code> </pre> <br><p>  Metode <code>compare</code> berbeda untuk keturunan <code>BPlusTree</code> berbeda.  Indeks negatif mengkodekan tidak adanya elemen dengan posisi di mana ia bisa berada.  <code>Collections.binarySearch</code> dari perpustakaan standar melakukan hal yang sama. </p><br><p>  Perhatikan baris-baris berikut. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift;</code> </pre> <br><p>  Untuk operasi <code>findOne</code> , kode ini tidak melakukan apa-apa, karena  <code>shift</code> diatur ke nol, mis.  jika kunci yang sama ada di pohon, maka mereka akan menemukan salah satunya. </p><br><p>  Namun, jika Anda mencari rentang dengan cara ini, maka elemen akan hilang, sehingga ada <code>shift</code> yang diatur ke <code>1</code> .  Akibatnya, pencarian <em>tidak menemukan elemen bahkan jika ada</em> , tetapi tidak penting untuk mencari rentang. </p></div></div><br><h2 id="spisok-listov">  Daftar lembar </h2><br><p>  Untuk menyiasatinya secara efisien, lembaran diikat ke daftar.  <code>BPlusTree.ForwardCursor</code> , yang <code>BPlusTree.ForwardCursor</code> dari lembar ke lembar, dikembalikan sebagai hasil pencarian.  Rupanya, bagian kursor tidak diisolasi dari operasi lain di pohon, karena  ketika lewat, kunci hanya diambil pada satu halaman.  Saya tidak menemukan mekanisme sinkronisasi yang melindungi akses ke metode kursor. </p><br><h1 id="zaklyuchenie">  Kesimpulan </h1><br><p>  Karena pohon B + di Apache Ignite masih muda dibandingkan dengan basis data relasional lainnya, kami mendapatkan set yang diperlukan untuk pohon B + siap produksi: </p><br><ul><li>  <strong>WAL</strong> memberikan keamanan murah, sebagai akibatnya, pohon jarang diperbarui pada disk. </li><li>  <strong>Offheap</strong> dengan data dalam bentuk serial. </li><li>  <strong>Concurrency</strong> - untuk bagian-bagian pohon yang dimuat ke dalam memori. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id413749/">https://habr.com/ru/post/id413749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id413739/index.html">Bagaimana kami memindai seluruh Internet dan apa yang kami pelajari</a></li>
<li><a href="../id413741/index.html">Apa itu dan bagaimana: tayangan tim WWDC Redmadrobot</a></li>
<li><a href="../id413743/index.html">Luncurkan LAMP dan ratusan aplikasi web lainnya dalam beberapa klik</a></li>
<li><a href="../id413745/index.html">Sistem daya nirkabel dikembangkan untuk semua elektronik dalam tubuh manusia sekaligus</a></li>
<li><a href="../id413747/index.html">Melalui NULL</a></li>
<li><a href="../id413751/index.html">Ruslan Cheremin dan Maxim Gramin - bekerja dengan lingkungan di jug.msk.ru</a></li>
<li><a href="../id413753/index.html">Eye in the Sky: Drone patroli dengan pengakuan kekerasan di kerumunan dan tempat-tempat umum</a></li>
<li><a href="../id413757/index.html">Database dalam proyek komersial: apa yang harus dilakukan?</a></li>
<li><a href="../id413759/index.html">Keingintahuan menemukan organik di Mars, yang berusia miliaran tahun</a></li>
<li><a href="../id413761/index.html">Bagaimana mencegah Windows 10 memulai kembali setelah pembaruan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>