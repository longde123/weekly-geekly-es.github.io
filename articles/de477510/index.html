<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â˜•ï¸ â†ªï¸ ğŸš‹ Automatische Sicherung und Wiederherstellung von dynamischen Adresslisten auf Mikrotik ğŸšŸ ğŸ… ğŸ‘©ğŸ¿â€âœˆï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RouterOS in Mikrotik speichert keine dynamischen Elemente in Adresslisten. Bei einem Neustart oder Stromausfall bleiben nur statische Elemente in den ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatische Sicherung und Wiederherstellung von dynamischen Adresslisten auf Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477510/"> RouterOS in Mikrotik speichert keine dynamischen Elemente in Adresslisten. Bei einem Neustart oder Stromausfall bleiben nur statische Elemente in den Listen.  Sie haben beispielsweise eine Regel, die Spammer oder Port-Scanner abfÃ¤ngt und deren IP-Adressen fÃ¼r einen Monat sperrt.  Normalerweise werden solche Adressen als dynamische EintrÃ¤ge in Listen gespeichert, aber sie werden nicht wÃ¤hrend des Neustarts gespeichert, was bedeutet, dass es leicht mÃ¶glich ist, die "Rettich" -Datenbank zu verlieren, die beispielsweise fÃ¼r einige Monate ununterbrochenen Gateway-Betriebs gesammelt wurde. <br><a name="habracut"></a><br>  Damit dieses Schema funktioniert, benÃ¶tigen Sie einen FTP-Server (ich besitze Windows, aber die Batch-Datei ist fÃ¼r Nixes leicht zu wiederholen) mit einem Konto, das Ã¼ber Lese- / Schreibberechtigungen verfÃ¼gt.  Der Mechanismus basiert auf dem Zusammenspiel der folgenden Elemente: den Skripten backupDynList_to_FTP und BackupDynListFromFTP auf dem Gateway und dem Skript convertmtik.bat auf dem FTP-Server.  Ein Server eines Drittanbieters wird benÃ¶tigt, um den internen Speicher von Mikrotik auszulagern (Listen kÃ¶nnen sehr groÃŸ sein und nichtflÃ¼chtiger Speicher ist nicht fÃ¼r alle Benutzer geeignet) und um die Datei mit leistungsfÃ¤higeren Mitteln fÃ¼r die Textverarbeitung zu verarbeiten als die integrierte Skriptsprache von Mikrotik.  Der DynListExport-Funktionsaufruf wird verwendet, um das Systemlimit fÃ¼r die GrÃ¶ÃŸe der Liste zu umgehen.  Die Notwendigkeit, die Liste zu konvertieren, beruht auf der Tatsache, dass, wenn dasselbe Element (z. B. ein statischer Datensatz) bereits in der Datenbank vorhanden ist, beim Import ein Fehler auftritt und der Import abgebrochen wird.  Um dies zu vermeiden, wird jedes Mal, wenn ein statischer Datensatz hinzugefÃ¼gt wird, die Fehlerbehandlungsroutine zurÃ¼ckgesetzt, und im Falle einer Ãœbereinstimmung wird der Datensatz einfach nicht hinzugefÃ¼gt, und der Importvorgang wird fortgesetzt. <br><br>  Das Skript BackupDynList_to_FTP wird jede Stunde (00:00) ausgefÃ¼hrt. Es sammelt alle Daten zu dynamischen DatensÃ¤tzen (die mindestens eine halbe Stunde gÃ¼ltig sind) in allen Listen in der Datei iplist_dyn.src und sendet diese Datei an ftp.  Auf dem Server wird jede Stunde mit einer halbstÃ¼ndigen Verschiebung zum ersten Skript (00:30) die Batchdatei convertmtik.bat ausgefÃ¼hrt, die das vom Gateway empfangene ursprÃ¼ngliche Skript in ein vor Zufallsfehlern geschÃ¼tztes Skript umwandelt und unter dem Namen iplist_dyn_done.src speichert <br><br>  Bei einem Absturz oder Neustart des Gateways werden zum Zeitpunkt des Starts automatisch Daten zu dynamischen DatensÃ¤tzen gelÃ¶scht. 60 Sekunden nach dem Start lÃ¤dt das Skript BackupDynListFromFTP die Datei iplist_dyn_done.src von FTP herunter und startet die AusfÃ¼hrung. Die Listen werden wiederhergestellt. <br><br>  Der Aktivator Hourly_Dynlist_Backup_on_FTP (/ sys sheduler) wird zu Beginn jeder Stunde ausgefÃ¼hrt: <br><br><pre><code class="dos hljs">/system script run BackupDynList_to_FTP</code> </pre> <br>  Skript BackupDynList_to_FTP (vergessen Sie nicht, die FTP-Adresse, den Benutzernamen und das Passwort zu Ã¤ndern): <br><br><pre> <code class="dos hljs">/system script environment remove [ <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> where name="DynListExport" ]; :global DynListExport <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip firewall addressâ€“list <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> where dynamic=yes and timeout&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>d00h30m] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local list [/ip firewall addressâ€“list get $i list]; :local address [/ip firewall addressâ€“list get $i address]; :local timeout [/ip firewall addressâ€“list get $i timeout]; :local comment [/ip firewall addressâ€“list get $i comment]; :put "/ip firewall addressâ€“list add list=$list address=$address timeout=$timeout comment=\"$comment\";"}; } :log info "Starting Backup to FTP Script..." :global iplistfile ("iplist_dyn.rsc") :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/file <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$iplistfile]!= "") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={/file <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> $iplistfile}; /execute script="\$DynListExport" file=$iplistfile :delay <span class="hljs-number"><span class="hljs-number">60</span></span>s /tool fetch address="_FTP_" port=<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span>=ftp srcâ€“<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="iplist_dyn.rsc.txt" user= password= dstâ€“<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="iplist_dyn.src" upload=yes :delay <span class="hljs-number"><span class="hljs-number">20</span></span>s /file <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> $iplistfile :log info "Finished Backup to FTP!"</code> </pre> <br>  Der Activator BackupDynList_from_FTP (/ sys sheduler) wird beim Start des Gateways (Start) ausgefÃ¼hrt: <br><br><pre> <code class="dos hljs">{:delay <span class="hljs-number"><span class="hljs-number">60</span></span>s}; /system script run BackupDynListFromFTP</code> </pre> <br>  Skript BackupDynListFromFTP (vergessen Sie nicht, die FTP-Adresse, den Benutzernamen und das Passwort zu Ã¤ndern): <br><br><pre> <code class="dos hljs">:local BackupFile "iplist_dyn_done.src" /file remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$BackupFile] /tool fetch address="_FTP_" port=<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span>=ftp srcâ€“<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>="$BackupFile" user= password= /import fileâ€“name=$BackupFile {:delay <span class="hljs-number"><span class="hljs-number">30</span></span>s}; /file remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> name=$BackupFile] /log info "$BackupFile imported"</code> </pre> <br>  Server-Skript Convertmtik.bat - verwendet fÃ¼r seine Arbeit den SED-Port des Linux-Dienstprogramms, beispielsweise von gnuwin32, das im Pfad auf dem Server registriert sein muss: <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ â€” &gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time%</span></span> &gt;&gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> # â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ â€” &gt;&gt; iplist_dyn_done.src <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /ip firewall addressâ€“list &gt; iplist_dyn_done.src sed â€“e "s/;//" â€“e "s/\/ip firewall addressâ€“list //" â€“e "s/.*/:<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { &amp; } onâ€“error={}/" iplist_dyn.src &gt;&gt; iplist_dyn_done.src</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de477510/">https://habr.com/ru/post/de477510/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de477500/index.html">Anwendungsmodell (Avalanche - Anwendungsframework fÃ¼r Java)</a></li>
<li><a href="../de477502/index.html">Fernarbeit eines gesunden Arbeitgebers</a></li>
<li><a href="../de477504/index.html">Die besten Praktiken fÃ¼r die App-Entwicklung, die es im Jahr 2020 zu befolgen gilt</a></li>
<li><a href="../de477506/index.html">Entwicklung einer mobilen Anwendung ohne Server</a></li>
<li><a href="../de477508/index.html">Radarwarner: Noch ein paar Worte zur Ethik und viele Worte zu Gesetzen</a></li>
<li><a href="../de477512/index.html">Schlacht von L2TP, RRAS gegen SoftEther</a></li>
<li><a href="../de477514/index.html">Hardware-Testautomatisierung fÃ¼r eingebettete Systeme</a></li>
<li><a href="../de477518/index.html">Knochenmikroarchitektur als Basis fÃ¼r ultraleichte und langlebige Materialien</a></li>
<li><a href="../de477520/index.html">Treffen Sie <Details></a></li>
<li><a href="../de477522/index.html">Tetris Herausforderung angenommen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>