<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÜïÔ∏è üò£ üëµüèø Mise √† jour des statistiques sur les r√©pliques secondaires du groupe de disponibilit√© üí≤ üôÜüèº üïé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous aimons et utilisons tous les fonctionnalit√©s √©tonnantes du groupe de disponibilit√© sur les r√©pliques secondaires, telles que les contr√¥les d'int√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mise √† jour des statistiques sur les r√©pliques secondaires du groupe de disponibilit√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462853/">  Nous aimons et utilisons tous les fonctionnalit√©s √©tonnantes du groupe de disponibilit√© sur les r√©pliques secondaires, telles que les contr√¥les d'int√©grit√©, les sauvegardes, etc. <br><br>  En fait, l'impossibilit√© d'enregistrer ces informations dans une base de donn√©es sur une r√©plique est toujours un casse-t√™te (et pensez √† des choses comme CDC pour encore plus d'inconfort). <br><br>  Mais arr√™tez de vous plaindre, voici l'id√©e principale: cher Microsoft, utilisons nos indices pour mettre √† jour les statistiques ... eh bien, faisons-en beaucoup plus. <br><br>
<h3>  Il y a toujours * un moyen, ou quelque chose comme √ßa </h3><a name="habracut"></a><br>  <i>* presque toujours</i> <br><br>  √ânum√©rons les d√©tails de base connus d'une solution possible sur Enterprise Edition MS SQL Server: <br><br><ul><li>  nous pouvons rendre les r√©pliques lisibles et en lire les donn√©es (pas que vous deviez toujours le faire, mais si vous savez vraiment ce que vous faites ...); </li><li>  nous pouvons copier nos objets dans Tempdb (oui, vos tables multi-t√©raoctets ne sont probablement pas tr√®s adapt√©es √† une telle op√©ration), ou dans une autre base de donn√©es accessible en √©criture; </li><li>  nous pouvons √©crire les r√©sultats dans un dossier partag√© accessible aux deux r√©pliques (que ce soit un fichier texte dans un partage de fichiers); </li><li>  nous pouvons exporter des statistiques sous forme de blob depuis SQL Server; </li><li>  nous pouvons importer le blob t√©l√©charg√© dans les statistiques. </li></ul><br><h4>  Faisons-le </h4><br>  J'ai un test AG sur une paire de machines virtuelles avec SQL Server 2017 (vous pouvez utiliser n'importe quelle version) et je vais cr√©er un tableau simple dans lequel je souhaite mettre √† jour les statistiques. <br><br>  Voici un script pour cr√©er une table et y ins√©rer un million de lignes: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbo.SampleDataTable; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.SampleDataTable ( C1 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, C2 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_SampleDataTable PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (C1) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (TABLOCK) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.RN, t.RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1000000</span></span>) ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.objects t1 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t2 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t3 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t4 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t5 ) t <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (MAXDOP <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Cr√©ons maintenant les statistiques ST_SampleDataTable_C2 pour la colonne c2 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> ST_SampleDataTable_C2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.SampleDataTable(C2);</code> </pre> <br>  Et puis je vais ins√©rer 1000 lignes, ce qui sera tr√®s important et √† cause de cela j'ai vraiment besoin de mettre √† jour les statistiques. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (TABLOCK) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10000000</span></span> + t.RN, <span class="hljs-number"><span class="hljs-number">999999999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1000</span></span>) ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) RN <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.objects t1 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t2 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t3 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t4 <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects t5 ) t <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (MAXDOP <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Maintenant, j'ai 1000 entr√©es dans lesquelles, dans la colonne C2, la valeur est 999999999. Et cela signifie certainement le probl√®me de la cl√© ascendante et j'ai vraiment besoin de mettre √† jour les statistiques ... sur la r√©plique afin de ne pas forcer le serveur principal avec les calculs et l'a emp√™ch√© de servir les clients. <br><br>  En utilisant la bonne vieille commande DBCC SHOW_STATISTICS, examinons nos statistiques. <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2')</code> </pre> <br><img src="https://habrastorage.org/webt/gm/hx/xv/gmhxxvlklhhluczq_s43u1ejo_o.png"><br>  Tout est parfait dans notre royaume et nos statistiques sont en parfait ordre, bien qu'il ne prenne en compte qu'un million de lignes et qu'il n'y ait pas ce millier de lignes nuisibles, qui, en fin de compte, devraient faire partie de ces statistiques. <br><br>  En outre, nous pouvons voir le flux de statistiques √† l'aide du param√®tre STATS_STREAM de la commande DBCC SHOW_STATISTICS: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM;</code> </pre> <br><img src="https://habrastorage.org/webt/p8/rt/nc/p8rtncofa5dn602kl7bvexkst0m.png"><br><br>  C'est juste un jeu de caract√®res sur lequel les blogs √©crivent depuis des ann√©es, mais je ne sais toujours pas si c'est une fonctionnalit√© enti√®rement document√©e (m√™me si cela n'a jamais emp√™ch√© les gens de l'utiliser). <br><br><h3>  Au bon moment </h3><br>  Copions notre table sur une r√©plique vers tempdb (bien que mon AG soit en mode synchrone, la m√™me chose peut √™tre faite en asynchrone, seules les donn√©es peuvent venir avec un l√©ger retard). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> TempDB; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbo.SampleDataTable; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.SampleDataTable ( C1 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, C2 <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_SampleDataTable PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (C1) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.SampleDataTable <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> C1, C2 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> AvGroupDb.dbo.SampleDataTable;</code> </pre> <br>  Nous sommes maintenant pr√™ts √† mettre √† jour les statistiques avec une analyse compl√®te dans tempdb sur la r√©plique. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> TempDB; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> ST_SampleDataTable_C2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.SampleDataTable(C2) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> FULLSCAN;</code> </pre> <br>  ( <i>Note du traducteur - Nico a oubli√© de cr√©er des statistiques et utilise la syntaxe incorrecte de l'op√©ration UPDATE STATISTICS, au lieu de UPDATE, elle devrait √™tre CREATE, c'est-√†-dire que les statistiques ne sont pas mises √† jour, mais cr√©√©es</i> ) <br><br>  Revenez √† DBCC SHOW_STATISTICS et regardez-le: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2')</code> </pre> <br><img src="https://habrastorage.org/webt/pg/ai/n7/pgain7_73tket3lziu3h3fopk90.png"><br><br>  Il semble compl√®tement diff√©rent de ce qu'il √©tait sur le serveur principal - seulement 3 lignes contre 178, mais il d√©crit parfaitement les donn√©es - nous avons un million de lignes uniques et 1000 lignes avec la m√™me valeur de colonne C2 - l'histogramme est aussi bon que possible . <br><br>  Regardons le flux de statistiques: <br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM;</code> </pre> <br><img src="https://habrastorage.org/webt/04/0u/pz/040upzmtjoezg-ykcnvdvjzzicw.png"><br><br>  Vous n'avez pas besoin d'√™tre un g√©nie pour remarquer que le flux est compl√®tement diff√©rent - nous voyons les 5689A0C6 caract√®res dans le flux mis √† jour, tandis que dans l'original, entre tous ces z√©ros que nous avons vus EDF10EB4. <br><br>  Concentrons-nous sur l'exportation de ces donn√©es vers un fichier texte quelque part en dehors de SQL Server et faisons-le √† l'aide de la merveilleuse commande BCP, qui n√©cessite l'activation de CMDSHELL (remarque: vous ne voulez probablement pas cela sur votre serveur de production): <br><br><pre> <code class="sql hljs">EXEC xp_cmdshell 'BCP "DBCC SHOW_STATISTICS(''AvGroupDb.dbo.SampleDataTable'', ''ST_SampleDataTable_C2'') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM<span class="hljs-string"><span class="hljs-string">" queryout \\SharedServer\Tempdb\stats.txt -c -T';</span></span></code> </pre> <br>  Et voici la taille du fichier stats.txt dans notre boule: <br><br><img src="https://habrastorage.org/webt/io/3f/uz/io3fuz8igpsqphnccpgmf_ghxwq.png"><br><br>  Juste quelques kilo-octets!  Facile √† transmettre, facile √† g√©rer. <br><br><h3>  Retour au serveur principal </h3><br>  Sur le serveur principal, nous devrons cr√©er une table temporaire qui stockera le flux de statistiques avant de pouvoir en mettre √† jour les statistiques dans notre table SampleDataTable principale (en pratique, nous pouvons d√©velopper cette table pour de nombreuses bases de donn√©es, tables, statistiques). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.TempStats( Stats_Stream VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, DataPages <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> );</code> </pre> <br>  Importons les donn√©es de notre fichier texte dans notre nouvelle table temporaire et voyons ce que nous avons import√©: <br><br><pre> <code class="sql hljs">BULK <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> dbo.TempStats <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'\\SharedServer\Tempdb\stats.txt'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TempStats;</code> </pre> <br><img src="https://habrastorage.org/webt/nd/0h/rk/nd0hrkomoixkorwndcrijcxlzwu.png"><br><br>  Nous pouvons voir les m√™mes donn√©es que nous avons calcul√©es sur la r√©plique, mais ces donn√©es sont d√©j√† sur notre serveur principal et tout ce qui nous reste √† faire est de mettre √† jour nos statistiques √† partir d'eux dans le tableau.  Cette op√©ration peut √™tre effectu√©e √† l'aide de l'op√©ration UPDATE STATISTICS √† l'aide du param√®tre WITH STATS_STREAM = ... <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @script <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @script = <span class="hljs-string"><span class="hljs-string">'UPDATE STATISTICS dbo.SampleDataTable(ST_SampleDataTable_C2) WITH STATS_STREAM = '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), [Stats_Stream],<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TempStats PRINT @script; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_executesql @script;</code> </pre> <br>  Ce script lit la valeur import√©e ci-dessus (oui, je sais - j'ai fait cet exemple pour une table et je n'ai pas pris la peine de plusieurs statistiques, tables, bases de donn√©es, etc.), g√©n√®re une instruction UPDATE STATISTICS, l'affiche √† l'√©cran et, √† la fin, le remplit. <br>  Voici ce que j'obtiens dans la sortie: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> dbo.SampleDataTable(ST_SampleDataTable_C2) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATS_STREAM =</code> </pre> <br>  L'ex√©cution de DBCC SHOW_STATISTICS sur le serveur principal me donne le r√©sultat que j'esp√©rais - le m√™me que ce que nous avons vu sur la r√©plique.  Le cercle est ferm√©. <br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS('dbo.SampleDataTable', 'ST_SampleDataTable_C2');</code> </pre> <br>  La partie vraiment impressionnante de cette histoire est que la taille de l'objet avec des statistiques est tr√®s petite et nous pouvons le transf√©rer tr√®s facilement / instantan√©ment sur le serveur principal. <br><br><h3>  Sc√©nario pas si basique. </h3><br>  Si vous avez plusieurs AG entre les m√™mes r√©pliques, o√π une r√©plique est la principale dans une AG et l'autre dans la seconde, alors vous pouvez ins√©rer des donn√©es BLOB dans le flux de donn√©es entre les r√©pliques et ajouter une petite base de donn√©es avec les donn√©es transmises. <br><br><img src="https://habrastorage.org/webt/ua/af/5r/uaaf5rbrsxkxfq1onfcydtzlgbm.png"><br><br>  Regardez l'image.  Si nous avons deux AG (AG1 et AG2) qui sont situ√©s sur des serveurs diff√©rents et que nous avons une table sp√©cifique sur Server1 dans AG1 pour laquelle nous voulons mettre √† jour les statistiques, alors sur Server2 nous pouvons copier cette table (appelons-la dbo.MyTable ) dans tempdb, mettez √† jour et utilisez AG2 renvoyez l'objet avec le flux de statistiques vers Server1, o√π vous importez simplement les statistiques de ce flux dans les statistiques dont nous avons besoin. <br><br>  Oui, je sais, cela semble d√©routant, mais pensez-y simplement comme un canal de r√©troaction √† travers lequel les r√©sultats sont livr√©s, au lieu de les mettre dans des fichiers. <br><br><h3>  Place au doute </h3><br>  Vous pouvez avoir quelques objections, par exemple: <br><br><ul><li>  pourquoi devrais-je le faire sur une r√©plique si je peux le faire en toute s√©curit√© sur le serveur principal?  (enfin, l'id√©e est de d√©charger le serveur principal) </li><li>  mais nous ne chargeons pas potentiellement la r√©plique (oui, mais si elle est inactive, c'est pourquoi nous voulons utiliser sa puissance) </li><li>  et nous ne pouvons pas agir sur le serveur principal en quelque sorte?  (non, nous lisons simplement les donn√©es de la r√©plique et renvoyons quelques kilo-octets, ce qui, dans notre si√®cle, des gigaoctets et des t√©raoctets sonne comme "shtoa?") </li><li>  Que se passe-t-il si au milieu du processus, le serveur principal commence √† mettre √† jour les statistiques de son propre chef?  (dans ce cas, il peut soit interrompre le deuxi√®me processus, soit red√©marrer avec les donn√©es mises √† jour). </li></ul><br><h3>  AG Feedback Channel </h3><br>  Il s'agit d'un canal avec des commentaires de la r√©plique sur le serveur principal - apr√®s avoir promis la transaction dans l'AG synchrone, le serveur principal attendra la confirmation de la r√©plique - et je pense que ce canal peut √™tre utilis√© pour impl√©menter cette am√©lioration.  Regardez la photo prise dans un post par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Simon Su</a> . <br><br><img src="https://habrastorage.org/webt/hc/my/rk/hcmyrkc1okyfr1byzfvhxexwixy.png"><br><br>  Ce qui repr√©sente tout le m√©canisme du canal de r√©troaction existant.  La r√©plique, √† l'aide des √©tapes 12 et suivantes, confirme au serveur principal que les informations ont √©t√© enregistr√©es.  Le m√™me canal peut √™tre utilis√© pour envoyer un objet de flux de statistiques apr√®s le recomptage sur une r√©plique.  Bien s√ªr, nous n'aurons pas √† utiliser tempdb √† cette fin, mais cr√©er un objet en m√©moire dans la base de donn√©es qui ne devrait pas √™tre stock√© en permanence (regardez vos tables de sch√©ma OLTP en m√©moire uniquement, ou pensez aux tables NOLOGGING dans Oracle), et devrait √™tre retir√© √† la fin de l'op√©ration - ce serait vraiment cool. <br><br><h3>  R√©flexions g√©n√©rales </h3><br>  Cela ne devrait pas d√©pendre du fait que la r√©plique synchrone ou non - la plupart du temps, les statistiques ne sont pas mises √† jour toutes les deux secondes et cela nous am√®ne √† la deuxi√®me partie de l'id√©e - pour effectuer un appel pour mettre √† jour les statistiques sur le serveur principal avec un param√®tre, tel que <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> dbo.MyAwesomeTable(HugeImportantStatOnC17) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> FULLSCAN, SECONDARY</code> </pre> <br>  o√π le param√®tre SECONDARY indique o√π l'op√©ration doit √™tre effectu√©e. <br>  Et tout comme pour les sauvegardes, nous devrions √™tre en mesure de sp√©cifier la r√©plique pr√©f√©r√©e pour effectuer des MISES √Ä JOUR DE STATISTIQUES (ou toute autre op√©ration √† l'avenir) dans les param√®tres. <br><br>  Je suis s√ªr que cette fonctionnalit√© encouragera de nombreux utilisateurs Enterprise Edition √† migrer vers la nouvelle version de SQL Server, ce qui permettra de r√©partir les op√©rations lourdes entre les r√©pliques. <br><br>  Quant √† la situation actuelle - je vois exactement comment vous pouvez automatiser cette solution en utilisant Powershell. <br><br>  Microsoft, c'est ton tour!  ;) <br><br>  Votez pour la fonctionnalit√© propos√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  <i>Note du traducteur: Toutes les suggestions et commentaires sur la traduction et le style sont les bienvenus, comme d'habitude.</i> <i><br><br></i>  <i>J'ai g√©n√©ralement appel√© r√©plique principale dans la traduction ¬´serveur principal¬ª et r√©plique secondaire - simplement une r√©plique.</i>  <i>Ce n'est peut-√™tre pas tout √† fait correct, mais mon oreille me fait moins mal que les r√©pliques "primaire" et "secondaire" sur msdn.</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462853/">https://habr.com/ru/post/fr462853/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462843/index.html">Limitations des jeux 8 bits et leur recr√©ation exacte dans Unity</a></li>
<li><a href="../fr462845/index.html">Massage pour votre cerveau: parlez d'ASMR</a></li>
<li><a href="../fr462847/index.html">Webinaires Hewlett Packard Enterprise en ao√ªt-octobre 2019</a></li>
<li><a href="../fr462849/index.html">Quelque chose √† propos de l'inode</a></li>
<li><a href="../fr462851/index.html">Nous r√©alisons un service cloud pour la gestion des fournitures (Angular + Firebase)</a></li>
<li><a href="../fr462855/index.html">Programmation simple: tableau Kanban pour GitLab en un jour ouvrable</a></li>
<li><a href="../fr462859/index.html">Comment une compagnie de bus europ√©enne op√®re en Russie: comment les bus et les passagers diff√®rent</a></li>
<li><a href="../fr462863/index.html">21 ao√ªt a diffus√© le Meetup Zabbix Moscou # 5</a></li>
<li><a href="../fr462867/index.html">Choisir un sch√©ma de couleurs pour votre application: comment le rendre simple?</a></li>
<li><a href="../fr462869/index.html">Syst√®me de gestion de projet Agilean</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>