<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíê üçß üë®üèΩ‚Äçüîß Compilaci√≥n de FFmpeg en WebAssembly (= ffmpeg.js): Parte 3 - Convertir avi a mp4 üåØ üë®üèæ‚Äçüç≥ üê∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lista de partes traducidas de la serie: 


1. Cocinando 
2. Compilando con Emscripten 
3. Convierte avi a mp4 (est√°s aqu√≠) 



 En esta parte, analiza...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compilaci√≥n de FFmpeg en WebAssembly (= ffmpeg.js): Parte 3 - Convertir avi a mp4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473166/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/899/a0b/a50/899a0ba50105cb44cf23fe8cc40b8e42.png" width="640" height="360"></div><br><br><p>  Lista de partes traducidas de la serie: </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cocinando</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Compilando con Emscripten</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Convierte avi a mp4</a> (est√°s aqu√≠) </li></ol><br><hr><br><p>  En esta parte, analizaremos: </p><br><br><ol><li>  Compilaci√≥n de la biblioteca FFmpeg con argumentos optimizados. </li><li>  Gesti√≥n del sistema de archivos Emscripten. </li><li>  Desarrollo de ffmpeg.js v0.1.0 y conversi√≥n de video. </li></ol><br><a name="habracut"></a><hr><br><h1>  Compilar la biblioteca FFmpeg con argumentos optimizados </h1><br><p>  Aunque el objetivo final de esta parte es crear ffmpeg.js v0.1.0 para convertir avi a mp4, en la parte anterior creamos solo una versi√≥n "b√°sica" de FFmpeg, que ser√≠a bueno optimizar con varios par√°metros. </p><br><ol><li>  <b>-Oz</b> : optimiza el c√≥digo y reduce su tama√±o (de 30 a 15 MB) </li><li>  <b>-o javascript / ffmpeg-core.js</b> : guarde los archivos js y wasm en el directorio javascript.  (desde donde llamaremos ffmpeg-core.js desde la biblioteca de envoltura ffmpeg.js, que proporciona una buena API) </li><li>  <b>-s MODULARIZE = 1</b> : crea una biblioteca en lugar de una utilidad de l√≠nea de comandos (deber√°s modificar las fuentes, detalles a continuaci√≥n) </li><li>  <b>-s EXPORTED_FUNCTIONS = "[_ ffmpeg]"</b> : exporta la funci√≥n ffmpeg C al mundo JavaScript </li><li>  <b>-s EXTRA_EXPORTED_RUNTIME_METHODS = "[cwrap, FS, getValue, setValue]"</b> : funciones adicionales para trabajar con el sistema de archivos y punteros, los detalles se pueden encontrar en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Interactuar con el c√≥digo</a> . </li><li>  <b>-s ALLOW_MEMORY_GROWTH = 1</b> : elimina el l√≠mite en la memoria consumida </li><li>  <b>-lpthread</b> : eliminado porque planeamos crear nuestro propio trabajador.  (Esta es una cartera de pedidos para la cuarta parte de las publicaciones) </li></ol><br><blockquote><p>  Se pueden encontrar m√°s detalles sobre cada uno de los argumentos en <a href="">src / settings.js</a> en el repositorio de github emscripten. </p></blockquote><br><p>  Al agregar <b>-s MODULARIZE = 1,</b> necesitaremos modificar el c√≥digo fuente para cumplir con los requisitos de modularidad (de hecho, deshacerse de la funci√≥n main ()).  Tienes que cambiar solo tres l√≠neas. </p><br><p>  1. <b>fftools / ffmpeg.c</b> : renombra main a ffmpeg </p><br><pre><code class="plaintext hljs">- int main(int argc, char **argv) + int ffmpeg(int argc, char **argv)</code> </pre> <br><p>  2. <b>fftools / ffmpeg.h</b> : agregue ffmpeg al final del archivo para exportar la funci√≥n </p><br><pre> <code class="plaintext hljs">+ int ffmpeg(int argc, char** argv); #endif /* FFTOOLS_FFMPEG_H */</code> </pre> <br><p>  3. <b>fftools / cmdutils.c</b> : comenta la salida (ret) para que nuestra biblioteca no salga del tiempo de ejecuci√≥n (mejoraremos este punto m√°s adelante). </p><br><pre> <code class="plaintext hljs">void exit_program(int ret){ if (program_exit) program_exit(ret); - exit(ret); + // exit(ret); }</code> </pre> <br><p>  Nuestra nueva versi√≥n del script de compilaci√≥n: </p><br><pre> <code class="plaintext hljs">emcc \ -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \ -Qunused-arguments -Oz \ -o javascript/ffmpeg-core.js fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \ -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm \ -s MODULARIZE=1 \ -s EXPORTED_FUNCTIONS="[_ffmpeg]" \ -s EXTRA_EXPORTED_RUNTIME_METHODS="[cwrap, FS, getValue, setValue]" \ -s TOTAL_MEMORY=33554432 \ -s ALLOW_MEMORY_GROWTH=1</code> </pre> <br><p>  ¬°ffmpeg-core.js est√° listo! </p><br><p>  Si tiene experiencia con ffmpeg, ya sabe c√≥mo se ve un comando t√≠pico: </p><br><pre> <code class="plaintext hljs">$ ffmpeg -i input.avi output.mp4</code> </pre> <br><p>  Y como usamos la funci√≥n ffmpeg en lugar de main, la llamada de comando se ver√° as√≠: </p><br><pre> <code class="plaintext hljs">const args = ['./ffmpeg', '-i', 'input.avi', 'output.mp4']; ffmpeg(args.length, args);</code> </pre> <br><p>  Por supuesto, no todo es tan simple, tendremos que construir un puente entre los mundos de JavaScript y C, as√≠ que comencemos con el sistema de archivos emscripten. </p><br><h1>  Gesti√≥n del sistema de archivos emscripten </h1><br><p>  Emscripten tiene un sistema de archivos virtual para admitir la lectura / escritura desde C, que ffmpeg-core.js utiliza para trabajar con archivos de video. </p><br><blockquote><p>  Lea m√°s sobre esto en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API del sistema de archivos</a> . </p></blockquote><br><p>  Para que todo funcione, exportamos la API de FS desde emscripten, que se debe al par√°metro anterior: </p><br><pre> <code class="plaintext hljs">-s EXTRA_EXPORTED_RUNTIME_METHODS="[cwrap, FS, getValue, setValue]"</code> </pre> <br><p>  Para guardar el archivo, debe preparar la matriz en el formato Uint8Array en el entorno de Node.js, que se puede hacer de la siguiente manera: </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const data = new Uint8Array(fs.readFileSync('./input.avi'));</code> </pre> <br><p>  Y gu√°rdelo en el sistema de archivos emscripten usando FS.writeFile (): </p><br><pre> <code class="plaintext hljs">require('./ffmpeg-core.js)() .then(Module =&gt; { Module.FS.writeFile('input.avi', data); });</code> </pre> <br><p>  Y para descargar el archivo de emscripten: </p><br><pre> <code class="plaintext hljs">require('./ffmpeg-core.js)() .then(Module =&gt; { const data = Module.FS.readFile('output.mp4'); });</code> </pre> <br><p>  Comencemos a desarrollar ffmpeg.js para ocultar estas complejidades detr√°s de una hermosa API. </p><br><h1>  Desarrollo ffmpeg.js v0.1.0 y conversi√≥n de video </h1><br><p>  El desarrollo de ffmpeg.js no es trivial, ya que constantemente necesita cambiar entre los mundos de JavaScript y C, pero si est√° familiarizado con los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">punteros</a> , ser√° mucho m√°s f√°cil entender lo que est√° sucediendo aqu√≠. </p><br><p>  Nuestra tarea es desarrollar ffmpeg.js como este: </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const ffmpeg = require('@ffmpeg/ffmpeg'); (async () =&gt; { await ffmpeg.load(); const data = ffmpeg.transcode('./input.avi', 'mp4'); fs.writeFileSync('./output.mp4', data); })();</code> </pre> <br><p>  Primero, descargue ffmpeg-core.js, que tradicionalmente se realiza de forma as√≠ncrona para no bloquear el hilo principal. </p><br><p>  As√≠ es como se ve: </p><br><pre> <code class="plaintext hljs">const { setModule } = require('./util/module'); const FFmpegCore = require('./ffmpeg-core'); module.exports = () =&gt; ( new Promise((resolve, reject) =&gt; { FFmpegCore() .then((Module) =&gt; { setModule(Module); resolve(); }); }) );</code> </pre> <br><p>  Puede parecer extra√±o que envuelvamos una promesa en otra, esto se debe a que <b>FFmpegCore ()</b> no <b>es</b> una promesa real, sino solo una funci√≥n que simula la API de promesa. </p><br><p>  El siguiente paso es usar el <b>M√≥dulo</b> para obtener la funci√≥n ffmpeg usando la funci√≥n <b>cwrap</b> : </p><br><pre> <code class="plaintext hljs">// int ffmpeg(int argc, char **argv) const ffmpeg = Module.cwrap('ffmpeg', 'number', ['number', 'number']);</code> </pre> <br><p>  El primer argumento para <b>cwrap</b> es el nombre de la funci√≥n (que debe estar en EXPORTED_FUNCTIONS con el gui√≥n bajo anterior), el segundo es el tipo del valor de retorno, el tercero es el tipo de argumentos de la funci√≥n (int argc y char ** argv). </p><br><p>  Est√° claro por qu√© <b>argc es un</b> n√∫mero, pero ¬øpor qu√© <b>argv</b> tambi√©n es un n√∫mero?  <b>argv</b> es un puntero, y el puntero almacena la direcci√≥n en la memoria (de tipo 0xfffffff), por lo que el tipo de puntero no tiene signo de 32 bits en WebAssembly.  Es por eso que especificamos el n√∫mero como el tipo <b>argv</b> . </p><br><p>  Para llamar a ffmpeg (), el primer argumento ser√° un n√∫mero regular en JavaScript, pero el segundo argumento debe ser un puntero a una matriz de caracteres (Uint8 en JavaScript). </p><br><p>  Dividimos esta tarea en 2 subtareas: </p><br><ol><li>  ¬øC√≥mo crear un puntero a una serie de caracteres? </li><li>  ¬øC√≥mo crear un puntero a una matriz de punteros? </li></ol><br><p>  Resolveremos el primer problema creando la utilidad <b>str2ptr</b> : </p><br><pre> <code class="plaintext hljs">const { getModule } = require('./module'); module.exports = (s) =&gt; { const Module = getModule(); const ptr = Module._malloc((s.length+1)*Uint8Array.BYTES_PER_ELEMENT); for (let i = 0; i &lt; s.length; i++) { Module.setValue(ptr+i, s.charCodeAt(i), 'i8'); } Module.setValue(ptr+s.length, 0, 'i8'); return ptr; };</code> </pre> <br><p>  <b>Module._malloc ()</b> es similar a <b>malloc ()</b> en C, asigna una porci√≥n de memoria en el mont√≥n.  <b>Module.setValue ()</b> establece el valor espec√≠fico por puntero. </p><br><blockquote><p>  Recuerde agregar 0 al final de la matriz de caracteres para evitar situaciones imprevistas. </p></blockquote><br><p>  Despu√©s de ocuparse de la primera subtarea, cree <b>strList2ptr</b> para resolver la segunda: </p><br><pre> <code class="plaintext hljs">const { getModule } = require('./module'); const str2ptr = require('./str2ptr'); module.exports = (strList) =&gt; { const Module = getModule(); const listPtr = Module._malloc(strList.length*Uint32Array.BYTES_PER_ELEMENT); strList.forEach((s, idx) =&gt; { const strPtr = str2ptr(s); Module.setValue(listPtr + (4*idx), strPtr, 'i32'); }); return listPtr; };</code> </pre> <br><p>  Lo principal que hay que entender aqu√≠ es que el puntero es un valor Uint32 dentro de JavaScript, por lo que <b>listPtr</b> es un puntero a una matriz Uint32 que almacena punteros en una matriz Uint8. </p><br><p>  <b>Al poner</b> todo junto, obtenemos la siguiente implementaci√≥n de <b>ffmepg.transcode ()</b> : </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const { getModule } = require('./util/module'); const strList2ptr = require('./util/strList2ptr'); module.exports = (inputPath, outputExt) =&gt; { const Module = getModule(); const data = new Uint8Array(fs.readFileSync(inputPath)); const ffmpeg = Module.cwrap('ffmpeg', 'number', ['number', 'number']); const args = ['./ffmpeg', '-i', 'input.avi', `output.${outputExt}`]; Module.FS.writeFile('input.avi', data); ffmpeg(args.length, strList2ptr(args)); return Buffer.from(Module.FS.readFile(`output.${outputExt}`)); };</code> </pre> <br><p>  Hecho  Ahora tenemos ffmpeg.js v0.1.0 para convertir avi a mp4. </p><br><p>  Puede probar el resultado usted mismo instalando la biblioteca: </p><br><pre> <code class="plaintext hljs">$ npm install @ffmpeg/ffmpeg@0.1.0</code> </pre> <br><p>  Y convirtiendo el archivo as√≠: </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const ffmpeg = require('@ffmpeg/ffmpeg'); (async () =&gt; { await ffmpeg.load(); const data = ffmpeg.transcode('./input.avi', 'mp4'); fs.writeFileSync('./output.mp4', data); })();</code> </pre> <br><p>  Solo tenga en cuenta que hasta ahora la biblioteca solo funciona para Node.js, pero en la siguiente parte agregaremos soporte para web-worker (y child_process en Node.js). </p><br><p>  C√≥digos fuente: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ffmpeg-core.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ffmpeg.js</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473166/">https://habr.com/ru/post/473166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473144/index.html">Un hombre con cuatro "en" o Nostradamus sovi√©tico</a></li>
<li><a href="../473146/index.html">Blazor Server en .NET Core 3.0 escenarios y rendimiento</a></li>
<li><a href="../473154/index.html">Friendly Open Space JS: renderizado del lado del cliente y creaci√≥n de envoltorios</a></li>
<li><a href="../473156/index.html">C√≥mo evaluar el conocimiento en la pr√°ctica, recibir beneficios por admisi√≥n al programa de maestr√≠a e invitaciones laborales</a></li>
<li><a href="../473160/index.html">Marca personal para ayudar a las empresas: 8 pasos para crear un concepto</a></li>
<li><a href="../473176/index.html">Es hora de hacer una nueva Terminal de Windows profiles.json</a></li>
<li><a href="../473182/index.html">El principio de aumentar la flexibilidad de las caracter√≠sticas de los ICE automotrices modernos</a></li>
<li><a href="../473184/index.html">Docker + php-fpm + PhpStorm + Xdebug</a></li>
<li><a href="../473186/index.html">Dise√±o no trivial de elementos en flexbox sin solicitudes de medios</a></li>
<li><a href="../473190/index.html">Proyecto TAME metformina: las opiniones est√°n divididas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>