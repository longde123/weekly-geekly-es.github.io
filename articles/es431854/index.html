<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüè´ ‚úäüèø üöµ Consistencia de datos en sistemas muy cargados üë®üèΩ‚Äç‚öñÔ∏è ‚úçüèæ üëÅ‚Äçüó®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problema 
 Casi cualquier sistema de informaci√≥n requiere almacenamiento de datos de manera continua. En la mayor√≠a de los sistemas con carga peque√±a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Consistencia de datos en sistemas muy cargados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431854/"><h2>  Problema </h2><br>  Casi cualquier sistema de informaci√≥n requiere almacenamiento de datos de manera continua.  En la mayor√≠a de los sistemas con carga peque√±a y mediana, esta funci√≥n se realiza mediante DBMS relacionales, cuya ventaja indiscutible es la garant√≠a de la coherencia de los datos. <br><br>  Un ejemplo cl√°sico que explica qu√© es la consistencia de los datos: la operaci√≥n de transferir fondos de una cuenta a otra.  En el momento en que la operaci√≥n de cambiar el saldo de una cuenta ya se ha completado y la otra a√∫n no ha tenido tiempo, puede ocurrir una falla.  Luego, los fondos se debitar√°n de una cuenta, pero no se acreditar√°n a otra.  Este estado de los datos del sistema se llama inconsistente y, tal vez, no hay necesidad de explicar qu√© consecuencias puede tener esto.  Los DBMS relacionales proporcionan un mecanismo de transacci√≥n que garantiza la coherencia de los datos en cualquier momento.  Una transacci√≥n es un conjunto finito de operaciones que transfiere un estado consistente a otro estado consistente. <a name="habracut"></a>  En el caso de un error en cualquier paso, el DBMS cancela todas las operaciones realizadas anteriormente y devuelve los datos a su estado original acordado.  En otras palabras, se realizar√°n todas las operaciones o no una sola. <br><br>  En cuanto a los sistemas a gran escala, no siempre es posible utilizar una sola base de datos en ellos debido a una carga demasiado pesada.  En tales casos, cada m√≥dulo del sistema (servicio) se proporciona con su propia base de datos separada.  En este caso, surge la pregunta de c√≥mo garantizar la coherencia de los datos para dicha arquitectura de cl√∫ster. <br><br><h2>  Resolviendo Consistencia de Datos </h2><br>  Una soluci√≥n son las transacciones distribuidas.  Primero, todos los nodos del cl√∫ster deben aceptar que la operaci√≥n es posible, luego los cambios se confirman en todos los nodos.  Dado que los nodos no tienen un dispositivo de almacenamiento com√∫n, la √∫nica forma de llegar a una opini√≥n com√∫n es ponerse de acuerdo utilizando alg√∫n protocolo de consenso distribuido. <br><br>  Un protocolo simple para capturar transacciones globales es el compromiso de dos fases (2PC).  El nodo que realiza la transacci√≥n se considera el coordinador.  En la fase de preparaci√≥n (preparaci√≥n), el coordinador informa a los otros nodos sobre el compromiso de la transacci√≥n y espera la confirmaci√≥n de ellos de que est√°n listos para comprometerse.  Si al menos un nodo no est√° listo, la transacci√≥n se interrumpe.  En la fase de confirmaci√≥n, el coordinador informa a todos los nodos de la decisi√≥n de confirmar la transacci√≥n.  Al recibir la confirmaci√≥n de todos de que todo est√° bien, el coordinador tambi√©n captura la transacci√≥n. <br><br><img src="https://access.redhat.com/webassets/avalon/d/JBoss_Enterprise_Application_Platform-5-Transactions_Development_Guide-en-US/images/721547b5fb5ee9da94ec3200cb1231fe/fig-two-phase-commit-overview.png" alt="imagen"><br><br><h4>  Figura 1 - Esquema general de una confirmaci√≥n de dos fases </h4><br>  Este protocolo evita un m√≠nimo de mensajes, pero no es robusto.  Por ejemplo, si el coordinador falla despu√©s de la fase de preparaci√≥n, los nodos restantes no tienen informaci√≥n sobre si la transacci√≥n debe confirmarse o cancelarse (tendr√°n que esperar a que se solucione la falla).  Otro inconveniente grave de 2PC (y otros protocolos de transacciones distribuidas, por ejemplo 3PC) es que a medida que aumenta el n√∫mero de nodos del cl√∫ster, disminuye el rendimiento de las confirmaciones de dos fases. <br><br><img src="http://www.techort.com/wp-content/uploads/2018/10/1539271021_859_data-integrity-in-microservice-architecture-how-to-ensure-it-without-distributed-transactions-and-tight-connectivity-avito-habr-blog.png" alt="imagen"><br><br><h4>  Figura 2 - Dependencia de la velocidad de una confirmaci√≥n de dos bases en la cantidad de servidores en un cl√∫ster DBMS </h4><br>  Adem√°s, el enfoque de transacci√≥n distribuida impone una limitaci√≥n: todos los m√≥dulos del sistema deben usar el mismo DBMS, lo que no siempre es conveniente. <br><br>  Otra opci√≥n es proporcionar un mecanismo que le permita trabajar con diferentes bases de datos (para servicios) como una sola base de datos (para resolver el problema con la integridad de los datos en una base de datos distribuida).  Al mismo tiempo, se requiere un cierto an√°logo de una transacci√≥n para un sistema distribuido ("transacci√≥n comercial"). <br><br>  En las transacciones ordinarias, as√≠ como en los compromisos de dos fases, todas las operaciones est√°n controladas por el mecanismo de transacci√≥n (usando bloqueos), y esto se hace para proporcionar la capacidad de revertir cualquier operaci√≥n (enfoque pesimista: consideramos que cualquier operaci√≥n puede estar causando una falla).  Este es el cuello de botella del sistema.  Una alternativa es el llamado enfoque optimista: creemos que la mayor√≠a de las operaciones se completan con √©xito.  Tambi√©n realizamos acciones adicionales ante el hecho de una falla.  Es decir  reduciendo costos para la mayor√≠a de las operaciones, lo que lleva a una mayor productividad. <br><br><h2>  ¬øQu√© es una saga y c√≥mo funciona? </h2><br>  Una alternativa a las transacciones para la arquitectura de microservicios es Saga.  Saga (saga) es un conjunto de pasos realizados por varios m√≥dulos del sistema (servicios);  Tambi√©n se requiere el servicio de saga, que es responsable de la operaci√≥n (transacci√≥n comercial) en su conjunto.  Los pasos est√°n vinculados a trav√©s de un gr√°fico de eventos.  Una vez completada la saga, el sistema debe pasar de un estado acordado a otro (en caso de ejecuci√≥n exitosa) o volver al estado acordado anterior (en caso de cancelaci√≥n). <br><br>  ¬øC√≥mo implementar tal devoluci√≥n o reversi√≥n de una transacci√≥n comercial?  Para hacer esto, la saga utiliza el mecanismo de cancelaci√≥n de pasos (acciones compensatorias).  Por ejemplo, uno de los pasos fue exitoso (por ejemplo, se agreg√≥ una entrada a la tabla de la base de datos del usuario), pero uno de los siguientes pasos fall√≥ y toda la saga deber√≠a cancelarse.  Luego, el mismo servicio recibe un comando: cancelar la acci√≥n.  Pero en el servicio DBMS, la transacci√≥n local ya se ha completado, se ha agregado el registro de usuario.  Luego, para volver al estado anterior, el servicio debe realizar una acci√≥n compensatoria (en nuestro ejemplo, eliminar el registro).  La cancelaci√≥n de pasos permite que la atomicidad ("todo o nada") se implemente en el marco de la saga: todos los pasos se realizan o compensan. <br><br><img src="https://cdn-images-1.medium.com/max/1200/1*IUfYVaCXhQHWqM13_6sLhQ.png" alt="imagen"><br><br><h4>  Figura 3 - El mecanismo de trabajo de Saga y la naturaleza del efecto compensatorio. </h4><br>  En la Figura 3, los pasos de la saga se designan como T1 ... T4, acciones de compensaci√≥n: C1 ... C4. <br>  Las sagas apoyan la idempotencia de los pasos (una acci√≥n cuya repetici√≥n repetida es equivalente a una sola).  El enfoque de hundimiento brinda la oportunidad de repetir cualquier paso (por ejemplo, si no recibi√≥ una respuesta al completar con √©xito).  La idempotencia tambi√©n le permite restaurar el estado cuando se pierden datos en cualquier nodo (falla y recuperaci√≥n).  Al realizar un paso, cada servicio debe determinar (mediante la clave de idempotencia) si ya realiz√≥ este paso o no (si no, ejecutar, de lo contrario omitir).  Para acciones de compensaci√≥n, tambi√©n es posible agregar claves de idempotencia y repeticiones de operaciones (asegurando persistencia / estabilidad). <br><br><h2>  Resumen </h2><br>  De los cuatro requisitos para el sistema de transacci√≥n ACID (atomicidad, consistencia, aislamiento, estabilidad), el mecanismo de ca√≠da permite implementar tres, todos excepto el aislamiento.  La falta de aislamiento puede conducir a anomal√≠as ("lecturas sucias", "lecturas no repetibles", reescritura de cambios entre diferentes transacciones comerciales, etc.).  Para superar tales situaciones, se requiere el uso de mecanismos adicionales, por ejemplo, el control de versiones de objetos mutables. <br><br>  Las sagas te permiten resolver las siguientes tareas: <br><br><ul><li>  Proporcionar cambios de datos dependientes para datos cr√≠ticos del negocio; </li><li>  Ser capaz de establecer un estricto orden de pasos; </li><li>  Cumplir con un 100% de consistencia (coordinar datos incluso en caso de accidentes); </li><li>  Proporcione controles de rendimiento en todos los niveles. </li></ul><br><h2>  Alcance y ejemplos de aplicaci√≥n </h2><br>  Las sagas a menudo se usan en sistemas con una gran cantidad de solicitudes.  Por ejemplo, servicios populares de correo electr√≥nico, redes sociales.  Sin embargo, el enfoque puede encontrar aplicaci√≥n en proyectos de menor escala. <br><br>  Nuestra empresa tiene experiencia en el desarrollo de un sistema de contabilidad para una gran empresa que fue dise√±ado para varias docenas de usuarios y todos los datos se almacenaron en un DBMS relacional.  El problema surgi√≥ al implementar el c√°lculo autom√°tico del trabajo planificado: en algunos casos, los c√°lculos eran muy grandes y requer√≠an la inserci√≥n de millones de registros en las tablas de DBMS, lo que cargaba significativamente el DBMS y ralentizaba el funcionamiento de todo el sistema. <br><br>  Se encontr√≥ una soluci√≥n: poner la l√≥gica de c√°lculo del trabajo en un servicio separado con su propio DBMS para almacenar el trabajo en s√≠ y los objetos relacionados.  La consistencia de los datos fue asegurada por la saga.  Si el c√°lculo falla, el m√≥dulo principal de la aplicaci√≥n recibi√≥ un comando para cancelar la operaci√≥n de c√°lculo l√≥gico. <br><br><h2>  Bibliotecas habilitadas para saga </h2><br>  La aplicaci√≥n fue desarrollada en .Net, y para esta tecnolog√≠a hay varias bibliotecas de administrador de servicios con soporte para sagas.  Observamos las bibliotecas NServiceBus, Mass Transit y Rebus.  Como resultado, nos decidimos por Rebus: esta biblioteca es m√°s f√°cil de aprender, a la vez que comprende el principio de las sagas y es de uso gratuito.  NServiceBus y Mass transit son herramientas m√°s sofisticadas con toneladas de caracter√≠sticas adicionales.  No fueron necesarios como parte de nuestra tarea, pero puede ser aconsejable usarlos en proyectos futuros con una l√≥gica m√°s compleja. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es431854/">https://habr.com/ru/post/es431854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431844/index.html">Swift Heroes 2018. C√≥mo fue</a></li>
<li><a href="../es431846/index.html">GeekBrains comienza a preparar desarrolladores de Python de pila completa</a></li>
<li><a href="../es431848/index.html">Mientras escrib√≠a el gui√≥n m√°s grande para Altium Designer</a></li>
<li><a href="../es431850/index.html">Heisenbug 2018 Mosc√∫: transmisi√≥n gratuita en l√≠nea, fiesta y mucho m√°s</a></li>
<li><a href="../es431852/index.html">¬øHackear 50,000 impresoras de red e imprimir texto arbitrario? Nada es m√°s f√°cil«É</a></li>
<li><a href="../es431856/index.html">Extender el editor de Unity con la ventana del editor, el objeto con secuencia de comandos y el editor personalizado</a></li>
<li><a href="../es431858/index.html">Mitap Sbertekh en Rostov del Don</a></li>
<li><a href="../es431860/index.html">Sobre las opciones del controlador de Linux, o c√≥mo pas√© el fin de semana</a></li>
<li><a href="../es431862/index.html">Mitap Sbertekh en Ekaterimburgo</a></li>
<li><a href="../es431864/index.html">PVS-Studio ROI: c√≥mo no perder millones (versi√≥n borrador del art√≠culo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>