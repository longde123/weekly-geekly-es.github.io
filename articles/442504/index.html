<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßú üíà „Ä∞Ô∏è Proxy PHP Xdebug: cuando las caracter√≠sticas est√°ndar de Xdebug no son suficientes üë©‚Äçüåæ üéûÔ∏è üê†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para la depuraci√≥n, los programas PHP a menudo usan Xdebug . Sin embargo, las caracter√≠sticas est√°ndar del IDE y Xdebug no siempre son suficientes. Al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Proxy PHP Xdebug: cuando las caracter√≠sticas est√°ndar de Xdebug no son suficientes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442504/"><p><img src="https://habrastorage.org/webt/qr/30/pd/qr30pdoglljz7da1c8uooyutxu8.jpeg" alt="Proxy PHP Xdebug: cuando las caracter√≠sticas est√°ndar de Xdebug no son suficientes"></p><br><p>  Para la depuraci√≥n, los programas PHP a menudo usan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Xdebug</a> .  Sin embargo, las caracter√≠sticas est√°ndar del IDE y Xdebug no siempre son suficientes.  Algunos de los problemas pueden resolverse utilizando el proxy Xdebug - pydbgpproxy, pero a√∫n no todos.  Por lo tanto, implement√© el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proxy PHP Xdebug</a> basado en el marco asincr√≥nico amphp. </p><br><p>  Debajo del corte, le dir√© lo que est√° mal con pydbgpproxy, lo que falta y por qu√© no lo modifiqu√©.  Tambi√©n explicar√© c√≥mo funciona el proxy Xdebug de PHP y mostrar√© c√≥mo extenderlo con un ejemplo. <a name="habracut"></a></p><br><h2 id="pydbgpproxy-vs-php-xdebug-proxy">  Pydbgpproxy vs proxy PHP Xdebug </h2><br><p>  El proxy Xdebug es un servicio intermedio entre el IDE y Xdebug (solicitudes de proxy de Xdebug al IDE y viceversa).  Muy a menudo se utiliza para la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">depuraci√≥n multiusuario</a> .  Esto es cuando tienes un servidor web y varios desarrolladores. </p><br><p>  Como proxy, generalmente se usa pydbgpproxy.  Pero tiene algunos problemas: </p><br><ul><li>  sin p√°gina oficial; </li><li>  dif√≠cil de encontrar donde descargarlo;  Resulta que esto se puede hacer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> : de repente, el cliente de depuraci√≥n remota de Python; </li><li>  No encontr√© el repositorio oficial; </li><li>  como consecuencia del p√°rrafo anterior, no est√° claro d√≥nde llevar la solicitud de extracci√≥n; </li><li>  proxy, como su nombre lo indica, est√° escrito en Python, que no todos los desarrolladores de PHP saben, lo que significa que expandirlo es un problema; </li><li>  continuaci√≥n del p√°rrafo anterior: si hay alg√∫n c√≥digo en PHP, y necesitar√° usarse en proxy, entonces tendr√° que ser portado a Python, y la duplicaci√≥n de c√≥digo siempre no es muy buena. </li></ul><br><p>  La b√∫squeda de un proxy Xdebug escrito en PHP en GitHub y en Internet no arroj√≥ resultados.  Entonces escrib√≠ el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proxy Xdebug de PHP</a> .  Debajo del cap√≥, utilic√© el marco asincr√≥nico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp</a> . </p><br><p>  Las principales ventajas del proxy PHP Xdebug sobre pydbgpproxy: </p><br><ul><li>  El proxy PHP Xdebug est√° escrito en un lenguaje familiar para los desarrolladores de PHP, lo que significa: <br><ul><li>  es m√°s f√°cil resolver problemas en √©l; </li><li>  es m√°s f√°cil de expandir; </li></ul></li><li>  El proxy PHP Xdebug tiene un repositorio p√∫blico, lo que significa: <br><ul><li>  Puede bifurcarlo y terminarlo seg√∫n sus necesidades; </li><li>  Puede enviar una solicitud de extracci√≥n con una funci√≥n faltante o una soluci√≥n a un problema. </li></ul></li></ul><br><h2 id="kak-rabotat-s-php-xdebug-proxy">  C√≥mo trabajar con proxy Xdebug de PHP </h2><br><h3 id="ustanovka">  Instalaci√≥n </h3><br><p>  El proxy PHP Xdebug se puede instalar como una dependencia de desarrollo a trav√©s del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compositor</a> : </p><br><pre><code class="bash hljs">composer.phar require mougrim/php-xdebug-proxy --dev</code> </pre> <br><p>  Pero si no desea arrastrar dependencias adicionales a su proyecto, entonces el proxy Xdebug de PHP se puede instalar como un proyecto a trav√©s del mismo compositor: </p><br><pre> <code class="bash hljs">composer.phar create-project mougrim/php-xdebug-proxy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-xdebug-proxy</code> </pre> <br><p>  El proxy Xdebug de PHP es extensible, pero se requiere <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ext-dom de</a> forma predeterminada (la extensi√≥n est√° habilitada de forma predeterminada en PHP) para analizar XML y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp / log</a> para el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">registro</a> asincr√≥nico: </p><br><pre> <code class="bash hljs">composer.phar require amphp/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-string"><span class="hljs-string">'^1.0.0'</span></span></code> </pre> <br><h3 id="zapusk">  Lanzamiento </h3><br><p><img src="https://habrastorage.org/webt/jb/n4/dc/jbn4dcyqwpirx7koyqjzwxfwozc.jpeg" alt="Proxy PHP Xdebug"></p><br><p>  El proxy comienza de la siguiente manera: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy</code> </pre> <br><p>  Proxy comenzar√° con la configuraci√≥n predeterminada: </p><br><pre> <code class="plaintext hljs">Using config path /path/to/php-xdebug-proxy/config [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use default ide: 127.0.0.1:9000 array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use predefined ides array ( 'predefinedIdeList' =&gt; array ( 'idekey' =&gt; '127.0.0.1:9000', ), ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][IdeRegistration] Listening for new connections on '127.0.0.1:9001'... array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][Xdebug] Listening for new connections on '127.0.0.1:9002'... array ( ) array ( )</code> </pre> <br><p>  Desde el registro puede ver que el proxy predeterminado: </p><br><ul><li>  escucha <code>127.0.0.1:9001</code> para conexiones de inicio de sesi√≥n IDE; </li><li>  escucha <code>127.0.0.1:9002</code> para conexiones Xdebug; </li><li>  utiliza <code>127.0.0.1:9000</code> como IDE predeterminado e IDE predefinido con la clave idekey. </li></ul><br><h3 id="konfiguraciya">  Configuracion </h3><br><p>  Si desea configurar puertos de escucha, etc., puede especificar la ruta a la carpeta de configuraci√≥n.  Simplemente copie la carpeta de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">configuraci√≥n</a> : </p><br><pre> <code class="bash hljs">cp -r /path/to/php-xdebug-proxy/config /your/custom/path</code> </pre> <br><p>  Hay tres archivos en la carpeta de configuraci√≥n: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>config.php</code></a> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'xdebugServer'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// host:port    Xdebug 'listen' =&gt; '127.0.0.1:9002', ], 'ideServer' =&gt; [ //  proxy    IDE,     IDE  , //    IDE  ,     . // IDE   ,  proxy    . 'defaultIde' =&gt; '127.0.0.1:9000', //  IDE    'idekey' =&gt; 'host:port', //   IDE  ,     . //  IDE ,   proxy  , //           proxy. 'predefinedIdeList' =&gt; [ 'idekey' =&gt; '127.0.0.1:9000', ], ], 'ideRegistrationServer' =&gt; [ // host:port     IDE, //     IDE,     . 'listen' =&gt; '127.0.0.1:9001', ], ];</span></span></code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>logger.php</code></a> : puedes configurar el registrador;  el archivo debe devolver un objeto que sea una instancia de <code>\Psr\Log\LoggerInterface</code> , el valor predeterminado es <code>\Monolog\Logger</code> con <code>\Amp\Log\StreamHandler</code> (para la grabaci√≥n sin bloqueo), muestra los registros en stdout; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>factory.php</code></a> : puedes configurar las clases que se usan en proxy;  el archivo debe devolver un objeto que sea una instancia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\Factory</code></a> , el valor predeterminado es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\DefaultFactory</code></a> . </li></ul><br><p>  Despu√©s de copiar los archivos, puede editar y ejecutar el proxy: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy --configs=/your/custom/path/config</code> </pre> <br><h3 id="otladka">  Depuraci√≥n </h3><br><p>  Se han escrito muchos art√≠culos sobre c√≥mo depurar c√≥digo usando Xdebug.  Anotar√© los puntos principales. </p><br><p>  En php.ini, las siguientes configuraciones deben estar en la secci√≥n <code>[xdebug]</code> ( <code>[xdebug]</code> si difieren de las est√°ndar): </p><br><ul><li>  idekey = idekey </li><li>  remote_host = 127.0.0.1 </li><li>  remote_port = 9002 </li><li>  remote_enable = On </li><li>  remote_autostart = On </li><li>  remote_connect_back = Apagado </li></ul><br><p>  Luego puede ejecutar el c√≥digo PHP depurado: </p><br><pre> <code class="bash hljs">php /path/to/your/script.php</code> </pre> <br><p>  Si hizo todo bien, la depuraci√≥n comenzar√° desde el primer punto de interrupci√≥n en el IDE.  La depuraci√≥n en modo php-fpm por parte de varios desarrolladores est√° m√°s all√° del alcance de este art√≠culo, pero se describe, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h2 id="rasshirenie-funkciy-proxy">  Funciones de proxy de extensi√≥n </h2><br><p>  Todo lo que examinamos anteriormente, pydbgpproxy tambi√©n es capaz de un grado u otro. </p><br><p>  Ahora hablemos de lo m√°s interesante en PHP Xdebug proxy.  Los proxies se pueden ampliar utilizando su propia f√°brica (creada en la configuraci√≥n <code>factory.php</code> , ver arriba).  La f√°brica debe implementar la interfaz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\Factory</code></a> . </p><br><p>  Los m√°s poderosos son los llamados preparadores de solicitudes.  Pueden modificar las solicitudes de Xdebug al IDE y viceversa.  Para agregar un <code>Factory\DefaultFactory::createRequestPreparers()</code> consultas, debe anular el m√©todo <code>Factory\DefaultFactory::createRequestPreparers()</code> .  El m√©todo devuelve una matriz de objetos que implementan la interfaz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>RequestPreparer\RequestPreparer</code></a> .  Al enviar una solicitud de Xdebug al IDE, se ejecutan en el orden directo; al enviar una solicitud del IDE a Xdebug, se invierte. </p><br><p>  Los manejadores de consultas se pueden usar, por ejemplo, para cambiar rutas a archivos (en puntos de interrupci√≥n y archivos ejecutables). </p><br><h3 id="debag-perepisannyh-faylov">  Depurar archivos sobrescritos </h3><br><p>  Para dar un ejemplo de preparador, har√© una peque√±a digresi√≥n.  En las pruebas unitarias, utilizamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">simulacros</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> ).  Soft-mocks le permite reemplazar funciones, m√©todos est√°ticos, constantes, etc. en las pruebas, es una alternativa para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">runkit</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uopz</a> .  Esto funciona reescribiendo archivos PHP sobre la marcha.  Del mismo modo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AspectMock</a> todav√≠a funciona. </p><br><p>  Pero las caracter√≠sticas est√°ndar de Xdebug e IDE le permiten depurar reescritas (que tienen una ruta diferente), en lugar de los archivos originales. </p><br><p>  Echemos un vistazo m√°s de cerca al problema de depuraci√≥n usando simulacros en las pruebas.  Primero, tome el caso donde el c√≥digo PHP se ejecuta localmente. </p><br><p>  Las primeras dificultades aparecen en la etapa de establecer puntos de interrupci√≥n (puntos de interrupci√≥n).  En el IDE, se instalan en los archivos originales, no en los reescritos.  Para poner un punto de interrupci√≥n a trav√©s del IDE, debe encontrar el archivo reescrito real.  El problema se agrava por el hecho de que cada vez que se cambia el archivo original, se crea un nuevo archivo reescrito, es decir, para cada contenido de archivo √∫nico habr√° un archivo reescrito √∫nico. </p><br><p>  Este problema se puede resolver llamando a la funci√≥n <code>xdebug_break()</code> , que es similar a establecer un punto de interrupci√≥n.  En este caso, no hay necesidad de buscar un archivo reescrito. </p><br><p>  Ahora considere la situaci√≥n m√°s complicada: la aplicaci√≥n se ejecuta en una m√°quina remota. </p><br><p>  En este caso, puede montar la carpeta con los archivos reescritos, por ejemplo, a trav√©s de SSHFS.  Si las rutas locales y remotas a la carpeta son diferentes, a√∫n debe registrar las asignaciones en el IDE. </p><br><p>  De una forma u otra, este m√©todo es ligeramente diferente del habitual y le permite depurar solo los archivos copiados, pero no los originales.  Pero a√∫n as√≠ quiero editar y depurar los mismos archivos originales. </p><br><p>  AspectMock solucion√≥ el problema al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habilitar el modo de depuraci√≥n</a> sin la capacidad de deshabilitarlo: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $options = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>])) { $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>] = []; } $options[<span class="hljs-string"><span class="hljs-string">'debug'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>][] = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::init($options); }</code> </pre> <br><p>  En un ejemplo de prueba simple, el modo de depuraci√≥n es m√°s lento en un 20 por ciento, pero no tengo suficientes pruebas de AspectMock para dar una estimaci√≥n m√°s precisa de lo lento que es.  Si tiene muchas pruebas en AspectMock, me alegrar√° si comparte la comparaci√≥n en los comentarios. </p><br><h3 id="ispolzovanie-xdebug-s-soft-mocks">  Usando Xdebug con simulacros </h3><br><p><img src="https://habrastorage.org/webt/eu/3d/ui/eu3duipif0jihrhzwlquhfpywuc.jpeg" alt="Xdebug + simulacros"></p><br><p>  Ahora que el problema est√° claro, considere c√≥mo resolverlo utilizando el proxy Xdebug de PHP.  La parte principal est√° en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>RequestPreparer\SoftMocksRequestPreparer</code></a> . </p><br><p>  En el constructor de la clase, defina la ruta al script de inicializaci√≥n de simulacros blandos y ejec√∫telo (se supone que los simulacros blandos est√°n conectados como una dependencia, pero se puede pasar cualquier ruta al constructor): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerInterface $logger, string $initScript = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$initScript) { $possibleInitScriptPaths = [ <span class="hljs-comment"><span class="hljs-comment">// proxy   , soft-mocks ‚Äî    __DIR__.'/../../vendor/badoo/soft-mocks/src/init_with_composer.php', // proxy  soft-mocks    __DIR__.'/../../../../badoo/soft-mocks/src/init_with_composer.php', ]; foreach ($possibleInitScriptPaths as $possiblInitScriptPath) { if (file_exists($possiblInitScriptPath)) { $initScript = $possiblInitScriptPath; break; } } } if (!$initScript) { throw new Error("Can't find soft-mocks init script"); } //  soft-mocks (       ..) require $initScript; }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/9p/8t/u7/9p8tu7eatpdhaewvfxvv2ossunu.jpeg" alt="Xdebug + simulacros: de Xdebug a IDE"></p><br><p>  Para preparar una solicitud de Xdebug al IDE, debe reemplazar la ruta al archivo reescrito con el archivo original: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToIde</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XmlDocument $xmlRequest, string $rawRequest)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context = [ <span class="hljs-string"><span class="hljs-string">'request'</span></span> =&gt; $rawRequest, ]; $root = $xmlRequest-&gt;getRoot(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$root) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($root-&gt;getChildren() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { <span class="hljs-comment"><span class="hljs-comment">//         : // - 'stack': https://xdebug.org/docs-dbgp.php#stack-get // - 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message': https://xdebug.org/docs-dbgp.php#error-notification if (!in_array($child-&gt;getName(), ['stack', 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message'], true)) { continue; } $attributes = $child-&gt;getAttributes(); if (isset($attributes['filename'])) { //         ,      $filename = $this-&gt;getOriginalFilePath($attributes['filename'], $context); if ($attributes['filename'] !== $filename) { $this-&gt;logger-&gt;info("Change '{$attributes['filename']}' to '{$filename}'", $context); $child-&gt;addAttribute('filename', $filename); } } } }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/6h/qw/er/6hqwerwharffc9a_ylzobqxut9o.jpeg" alt="Xdebug + simulacros: de IDE a Xdebug"></p><br><p>  Para preparar una solicitud del IDE a Xdebug, debe reemplazar la ruta al archivo original con la ruta a la reescrita: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToXdebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $request, CommandToXdebugParser $commandToXdebugParser)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       [$command, $arguments] = $commandToXdebugParser-&gt;parseCommand($request); $context = [ 'request' =&gt; $request, 'arguments' =&gt; $arguments, ]; if ($command === 'breakpoint_set') { //    -f,          // . https://xdebug.org/docs-dbgp.php#id3 if (isset($arguments['-f'])) { $file = $this-&gt;getRewrittenFilePath($arguments['-f'], $context); if ($file) { $this-&gt;logger-&gt;info("Change '{$arguments['-f']}' to '{$file}'", $context); $arguments['-f'] = $file; //    $request = $commandToXdebugParser-&gt;buildCommand($command, $arguments); } } else { $this-&gt;logger-&gt;error("Command {$command} is without argument '-f'", $context); } } return $request; }</span></span></code> </pre> <br><p>  Para que el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\DefaultFactory</code></a> consultas funcione, debe crear su clase de f√°brica y heredarla de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\DefaultFactory</code></a> , o implementar la interfaz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\Factory</code></a> .  Para los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\SoftMocksFactory</code></a> , la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>Factory\SoftMocksFactory</code></a> ve as√≠: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SoftMocksFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return new SoftMocksConfig($config); } public function createRequestPreparers(LoggerInterface $logger, Config $config): array { $requestPreparers = parent::createRequestPreparers($logger, $config); return array_merge($requestPreparers, [$this-&gt;createSoftMocksRequestPreparer($logger, $config)]); } public function createSoftMocksRequestPreparer(LoggerInterface $logger, SoftMocksConfig $config): SoftMocksRequestPreparer { //     init-   return new SoftMocksRequestPreparer($logger, $config-&gt;getSoftMocks()-&gt;getInitScript()); } }</span></span></code> </pre> <br><p>  Aqu√≠ necesita su propia clase de configuraci√≥n para que pueda especificar la ruta del script de inicio de simulacros.  Lo que es, puede ver en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Config \ SoftMocksConfig</a> . </p><br><p>  Solo quedaba un poco: crear una nueva f√°brica e indicar la ruta al script de inicio de simulacros.  C√≥mo se hace esto se puede ver en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>softMocksConfig</code></a> . </p><br><h3 id="neblokiruyuschiy-api">  API sin bloqueo </h3><br><p>  Como escrib√≠ anteriormente, el proxy Xdebug de PHP usa amphp debajo del cap√≥, lo que significa que se debe usar una API sin bloqueo para trabajar con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">E / S.</a>  Apmphp ya tiene muchos componentes que implementan esta API sin bloqueo.  Si va a extender el proxy PHP Xdebug y usarlo en modo multiusuario, aseg√∫rese de usar API sin bloqueo. </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  El proxy PHP Xdebug todav√≠a es un proyecto bastante joven, pero en Badoo ya se usa activamente para depurar pruebas usando simulacros. </p><br><p>  Proxy PHP Xdebug: </p><br><ul><li>  reemplaza pydbgpproxy en la depuraci√≥n multiusuario; </li><li>  puede trabajar con simulacros blandos; </li><li>  se puede ampliar: <br><ul><li>  Puede reemplazar las rutas a los archivos que provienen del IDE y de Xdebug; </li><li>  se pueden recopilar estad√≠sticas: en modo de depuraci√≥n, al menos el contexto ejecutable est√° disponible al depurar (valores de variables y l√≠nea de c√≥digo ejecutable). </li></ul></li></ul><br><p>  Si usa el proxy Xdebug para algo que no sea la depuraci√≥n multiusuario, comparta su caso y el proxy Xdebug que usa en los comentarios. </p><br><p>  Si usa pydbgpproxy o alg√∫n otro proxy Xdebug, pruebe el proxy Xdebug de PHP, informe sobre sus problemas, comparta solicitudes de extracci√≥n.  ¬°Desarrollemos el proyecto juntos!  :) </p><br><p>  PD: ¬°Gracias a mi colega Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Makhrov,</a> tambi√©n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conocido</a> como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eZH,</a> por la idea de proxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">smdbgpproxy</a> ! </p><br><h2 id="eschyo-raz-ssylki">  Enlaces de nuevo </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proxy Xdebug de PHP: proxy</a> Xdebug, que se trata en el art√≠culo; </li><li>  pydbgpproxy se puede descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> , de repente, Python Remote Debugging Client; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp</a> : marco PHP asincr√≥nico sin bloqueo; </li><li>  herramientas para simulacros: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">simulacros blandos</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AspectMock</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uopz</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kit de runas</a> </li></ul></li></ul><br><p>  Gracias por su atencion! </p><br><p>  Estar√© encantado de comentarios y sugerencias. </p><br><p>  Rinat Akhmadeev, Sr.  Desarrollador PHP </p><br><p>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Traducci√≥n</a> publicada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">del</a> art√≠culo al ingl√©s. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442504/">https://habr.com/ru/post/442504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442494/index.html">Componente Figma y organizaci√≥n de instancias usando Userpic como ejemplo</a></li>
<li><a href="../442496/index.html">Cerdo corporativo</a></li>
<li><a href="../442498/index.html">Los 10 mejores informes de la conferencia C ++ Rusia 2018: videos completos, diapositivas, comentarios</a></li>
<li><a href="../442500/index.html">Analizador est√°tico Detekt para Kotlin</a></li>
<li><a href="../442502/index.html">Transformamos el lugar de trabajo en un titular por $ 200</a></li>
<li><a href="../442506/index.html">¬øSe castiga a Rusia por el comercio ilegal de datos personales?</a></li>
<li><a href="../442508/index.html">C√≥mo udalenka acelera la innovaci√≥n en GitLab</a></li>
<li><a href="../442512/index.html">Personalizaci√≥n de Django ORM en el ejemplo de ZomboDB</a></li>
<li><a href="../442514/index.html">Sistemas distribuidos. Patrones de dise√±o. Rese√±a del libro</a></li>
<li><a href="../442516/index.html">Pandas Guide to Big Data Analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>