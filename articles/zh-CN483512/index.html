<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🎤 📉 📷 开发完美的pypi包并支持不同版本的python 🚩 🥞 🔇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是一本关于如何为python创建“完美” pypi软件包的小手册/故事，任何人都可以使用cherished命令安装该软件包： 


pip install my-perfect-package  


 它是针对初学者的，但是我敦促专业人士就如何改进“完美”软件包发表意见。 因此，我要猫。 
 “...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>开发完美的pypi包并支持不同版本的python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483512/"><p> 这是一本关于如何为python创建“完美” pypi软件包的小手册/故事，任何人都可以使用cherished命令安装该软件包： </p><br><pre><code class="plaintext hljs">pip install my-perfect-package</code> </pre> <br><p> 它是针对初学者的，但是我敦促专业人士就如何改进“完美”软件包发表意见。 因此，我要猫。 </p><a name="habracut"></a><br><h2 id="chto-znachit-idealnyy-paket">  “理想”的包装是什么意思？ </h2><br><p> 我将从以下要求出发： </p><br><ul><li>  <strong>在github上开源;</strong> <br> 每个人都应该能够为发展做出贡献，并感谢作者。 </li><li>  <strong>支持所有当前/流行的python版本（2.7、3.5、3.6、3.7、3.8）;</strong> <br>  Python是不同的，并且仍然在2.7上积极编写代码。 </li><li>  <strong>100％的单元测试覆盖率；</strong> <br><del> 单元测试可改进体系结构并自动执行回归检查。 </del><br> 带有珍贵数字的徽章会引发FAQ，并<a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow">为其他人设置标准</a> 。 </li><li>  <strong>使用CI：</strong> <br> 自动检查非常方便！ <del> 还有一堆很酷的徽章 </del><br><ul><li>  <strong>在所有平台和所有版本的python上运行单元测试；</strong> <br> 不要相信那些声称python和已安装软件包是<a href="https://docs.python.org/2/library/os.html" rel="nofollow">跨平台的人</a> ，因为您总是会遇到<a href="https://bugs.python.org/issue22587" rel="nofollow">bug</a> 。 </li><li>  <strong>样式代码检查；</strong> <br> 统一的样式可以提高可读性，并减少评论中空白讨论的数量。 </li><li>  <strong>静态代码分析器；</strong> <br> 自动搜索代码中的错误？ 给我两个！ </li></ul></li><li>  <strong>实际文件；</strong> <br> 使用软件包的示例，方法/类的描述以及典型错误的分析-记录的经验将降低初学者的入门门槛。 </li><li>  <strong>跨平台开发；</strong> <br> 不幸的是，仅仅因为开发人员改进了Unix的工具就很难对项目做出个人贡献。 例如，我使用bash脚本进行汇编。 </li><li>  <strong>该软件包非常有用，可以使世界变得更美好。</strong> <br> 一个困难的要求，因为从<a href="https://pypi.org/" rel="nofollow">pypi中</a>的软件包数量<em>（〜210k）来看，</em>开发人员是野性利他主义者，并且已经编写了很多内容。 </li></ul><br><h2 id="s-chego-nachat"> 从哪里开始？ </h2><br><p> 没有什么好主意，所以我选择了一个非常老套且非常受欢迎的主题-使用数字系统。 第一个版本应该能够将数字转换为罗马数字，反之亦然。 对于本手册来说比较复杂，没有必要。 哦，是的，最重要的是名称： <del>  numsys-作为数字系统的解密。 </del>  <em>数字系统py</em> 。 </p><br><h2 id="kak-testirovat"> 怎么测试？ </h2><br><p> 我使用<em>python3.7</em> ，首先使用标准的<a href="https://habr.com/ru/post/121162/">unittests</a>模块使用功能存根（我们都是<a href="https://habr.com/ru/post/121162/">TDD</a> ）编写了测试。 </p><br><p> 我进行以下项目结构： </p><br><pre> <code class="plaintext hljs">src/ numeral-system/ __init__.py roman.py tests __init__.py test_roman.py</code> </pre> <br><p> 我不会将测试放在包装中，因此我将其分开 <del> 谷壳 </del>  。 最初， <code>src/</code>没有创建<code>src/</code>文件夹，但是进一步的开发表明它对我来说更方便。 因此，这是没有必要的。 </p><br><p> 我决定使用<a href="https://habr.com/ru/post/269759/">pytest</a>进行启动-它知道如何与标准模块中的测试完美配合。 看起来有点不合逻辑，但是对我来说测试的标准模块 <del> 好像 </del> 似乎有点舒服。  <em>现在，我建议使用pytest写作风格。</em> </p><br><p> 但是，他们说将<code>pytest</code> （像其他依赖项一样）放在系统python中并不是一个很聪明的主意... </p><br><h2 id="kak-upravlyat-zavisimostyami"> 如何管理依赖关系？ </h2><br><p> 只能使用<a href="https://virtualenv.pypa.io/en/latest/" rel="nofollow">virtualenv</a>和<code>requirements.txt</code> 。 你可以进步，可以运用<a href="https://poetry.eustace.io/" rel="nofollow">诗歌</a> 。 也许我会使用<a href="https://tox.readthedocs.io/en/latest/" rel="nofollow">tox-</a>一种简化自动化和测试的工具，这也将允许我管理依赖项。 </p><br><p> 我创建一个简单的tox.ini配置并安装<code>pytest</code> ： </p><br><pre> <code class="plaintext hljs">[tox] envlist = py37 ;     ,   python3.7 [testenv] ;     deps =  `deps`  ,   . -r requirements.txt ;     -r requirements-test.txt ; commands = pytest ;  </code> </pre> <br><p> 最初，我明确指出了依赖关系，但与第三方服务集成的实践表明，最好的方法仍然是将依赖关系存储在<code>requirements.txt</code>文件中。 </p><br><p> 一个非常微妙的时刻出现了。 在开发时修复当前版本，还是始终放置最新版本？ </p><br><p> 如果提交，则在安装过程中，由于所使用依赖项的版本不同，软件包之间可能会发生冲突。 如果您不提交，则程序包可能突然停止工作。 对于最终产品来说，后一种情况非常不愉快，因为由于隐式依赖项的较小更新，所有构建可能在一夜之内“变成红色”。 而且根据<a href="https://en.wikipedia.org/wiki/Murphy%2527s_law" rel="nofollow">墨菲的法律，</a>这将在发布当天发生。 </p><br><p> 因此，我为自己制定了一条规则： </p><br><ol><li> 始终为最终产品修复版本，因为使用哪个版本是他们的责任。 </li><li> 不要修复用于已安装软件包的版本。 如果软件包功能需要，则将其限制在一个范围内。 </li></ol><br><h2 id="chto-dalshe"> 接下来是什么？ </h2><br><p> 我在写测试！ </p><br><p> 我填写了函数正文，添加了注释并使测试正确运行。 <br> 在这一点上，大多数开发人员通常会停下来（我仍然相信每个人都编写测试=），发布程序包并破解bug。 但是我继续 <del> 跳进兔子洞 </del>  。 </p><br><h2 id="kak-rabotat-s-razlichnymi-versiyami-python"> 如何使用不同版本的python？ </h2><br><p> 在<code>tox</code>配置中， <code>tox</code>指定在所有有趣的python版本上启动测试： </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38}</code> </pre> <br><p> 使用<a href="https://khashtamov.com/ru/pyenv-python/" rel="nofollow">pyenv，我</a>在本地向<a href="https://khashtamov.com/ru/pyenv-python/" rel="nofollow">我</a>提供了必要的版本，以便<code>tox</code>可以找到它们并创建测试环境。 </p><br><h2 id="gde-zavetnye-100"> 珍爱的100％在哪里？ </h2><br><p> 我将对代码的覆盖率进行衡量-为此，它提供了出色的<a href="https://coverage.readthedocs.io/en/v4.5.x/" rel="nofollow">覆盖率</a>软件包，并且与pytest- <a href="https://github.com/pytest-dev/pytest-cov" rel="nofollow">pytest-cov的</a>集成度同样出色。 <br>  <code>requirements-test.txt</code>现在看起来像这样： </p><br><pre> <code class="plaintext hljs">six=1.13.0 pytest=4.6.7 pytest-cov=2.8.1 parameterized=0.7.1</code> </pre> <br><p> 根据上述规则，我修复了用于运行测试的软件包的版本。 </p><br><p> 我更改了测试运行命令： </p><br><pre> <code class="plaintext hljs">deps = -r requirements.txt -r requirements-test.txt commands = pytest \ --cov=src/ \ --cov-config="{toxinidir}/tox.ini" \ --cov-append</code> </pre> <br><p> 我正在从<code>src/</code>文件夹中收集所有代码的覆盖率统计信息-包本身（ <em>numerical_system /</em> ）和测试代码所必需的（ <em>tests /</em> ）-我不希望测试本身包含不可执行的部分吗？ </p><br><p>  <code>--cov-append</code>不同版本的python下每个调用的所有收集到的统计信息<code>--cov-append</code>为一个，因为第二个和第三个python的覆盖范围可能不同（嗨，取决于版本的代码和模块<a href="https://pypi.org/project/six/" rel="nofollow">6</a> ！），但总计为100 ％ 一个简单的例子： </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.version_info &gt; (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-comment"><span class="hljs-comment"># Python 3 code in this block else: # Python 2 code in this block</span></span></code> </pre> <br><p> 添加新环境以创建覆盖率报告。 </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage commands = coverage html ;   ,   coverage report --include="src/*" --fail-under=100 -m ;    100% </code> </pre> <br><p> 在所有版本的python上运行测试后，我将环境添加到列表中。 </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38} coverage_report</code> </pre> <br><p> 运行<code>tox</code>命令后，包含<code>index.html</code>文件和漂亮报告的<code>tox</code>文件夹应出现在项目根目录中。 </p><br><p> 对于令人垂涎的徽章，我将100％与<a href="https://codecov.io/" rel="nofollow">codecov</a>服务集成在一起，该服务本身已经与<code>github</code>集成，并允许您查看代码覆盖率更改的历史记录。 为此，当然，您必须在此处创建一个帐户。 </p><br><p> 最终的启动环境如下： </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage==5.0.2 codecov==2.0.15 commands = coverage html coverage report --include="src/*" --fail-under=100 -m coverage xml codecov -f coverage.xml --token=2455dcfa-f9fc-4b3a-b94d-9765afe87f0f ;     codecov,   </code> </pre> <br><p> 现在仅保留指向<code>README.rst</code>的徽章的链接： </p><br><pre> <code class="plaintext hljs">|Code Coverage| .. |Code Coverage| image:: https://codecov.io/gh/zifter/numeral-system-py/branch/master/graph/badge.svg :target: https://codecov.io/gh/zifter/numeral-system-py</code> </pre> <br><h2 id="kak-formatirovat-i-analizirovat-kod"> 如何格式化和分析代码？ </h2><br><p> 不存在许多分析器，因为它们在很大程度上是相互补充的。 因此，我将集成流行的静态分析器，以检查是否符合<a href="https://www.python.org/dev/peps/pep-0008/" rel="nofollow">PEP8</a> ，发现潜在问题并 <del> 修复所有错误 </del> 统一格式化代码。 </p><br><p> 您应该立即考虑在哪里指定用于微调分析仪的参数。 为此，您可以使用<code>tox.ini</code>文件， <code>setup.cfg</code> ，单个自定义文件或分析仪的特定文件。 我决定直接使用<code>tox.ini</code> ，因为您可以将<code>tox.ini</code>复制到以后的项目中。 </p><br><h2 id="isort">  isort </h2><br><p>  <a href="https://github.com/timothycrosley/isort" rel="nofollow">isort</a>是用于格式化导入的实用程序。 </p><br><p> 我创建以下环境以代码格式模式运行<code>isort</code> 。 </p><br><pre> <code class="plaintext hljs">[testenv:isort] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort -y -sp={toxinidir}/tox.ini</code> </pre> <br><p> 不幸的是， <code>isort</code>无法指定用于格式化的文件夹。 因此，您必须通过<code>changedir</code>更改启动目录，并使用<code>-sp={toxinidir}/tox.ini</code>设置文件的路径。 需要使用<code>-y</code>开关来禁用交互方式。 </p><br><p> 要在测试中运行，您需要一种验证模式-为此，有一个<code>--check-only</code>标志： </p><br><pre> <code class="plaintext hljs">[testenv:isort-check] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort --check-only -sp={toxinidir}/tox.ini</code> </pre> <br><h2 id="black"> 黑色的 </h2><br><p> 接下来，我与<a href="https://black.readthedocs.io/en/stable/" rel="nofollow">黑色</a>代码格式化程序集成。 我用<code>isort</code>类推地<code>isort</code> ： </p><br><pre> <code class="plaintext hljs">[testenv:black] deps = black==19.10b0 commands = black src/ [testenv:black-check] deps = black==19.10b0 commands = black --check src/</code> </pre> <br><p> 一切正常，但与<code>isort</code>冲突- <a href="https://github.com/psf/black/issues/127" rel="nofollow">导入</a>的<a href="https://github.com/psf/black/issues/127" rel="nofollow">格式</a>有所不同。 </p><br><p> 在<a href="https://github.com/timothycrosley/isort/issues/694" rel="nofollow">其中的一条评论中，我</a>找到了一个最小兼容的<code>isort</code>设置，该设置用于： </p><br><pre> <code class="plaintext hljs">[isort] multi_line_output=3 include_trailing_comma=True force_grid_wrap=0 use_parentheses=True line_length=88</code> </pre> <br><h2 id="flake8"> 薄片8 </h2><br><p> 接下来，我与<a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">flake8</a>静态分析器集成。 </p><br><pre> <code class="plaintext hljs">[testenv:flake8-check] deps = flake8==3.7.9 commands = flake8 --config=tox.ini src/</code> </pre> <br><p> 再次与<code>black</code> <a href="https://github.com/psf/black/issues/113" rel="nofollow">融合</a>存在<a href="https://github.com/psf/black/issues/113" rel="nofollow">问题</a> 。 我们必须添加一个微调，实际上， <code>black</code>本身<a href="https://github.com/psf/black" rel="nofollow">推荐这样做</a> ： </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203</code> </pre> <br><p> 不幸的是，这第一次无效。 出现错误<code>E231 missing whitespace after ','</code> ，我不得不添加此错误以忽略： </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203,E231</code> </pre> <br><h2 id="pylint"> 皮林特 </h2><br><p> 与<a href="https://www.pylint.org/" rel="nofollow">pylint</a>静态代码<a href="https://www.pylint.org/" rel="nofollow">分析器</a>集成 </p><br><pre> <code class="plaintext hljs">[testenv:pylint-check] deps = {[testenv]deps} # pylint  ,     pylint==2.4.4 commands = pylint --rcfile=tox.ini src/</code> </pre> <br><p> 我立即遇到奇怪的限制-函数名称为30个字符（是的，我写了很长的测试方法名称），并在代码中警告了<code>TODO</code>的存在。 <br> 我必须添加一些例外： </p><br><pre> <code class="plaintext hljs">[MESSAGES CONTROL] disable=fixme,invalid-name</code> </pre> <br><p> 同样，令人不快的时刻是<code>pylint</code>开发<code>pylint</code>已经掩埋了<code>python2.7</code> ，并且不再为其开发软件包。 因此，应在当前软件包<code>python3.7</code>上运行检查。 <br> 将适当的行添加到配置中： </p><br><pre> <code class="plaintext hljs">[tox] envlist = isort-check black-check flake8-check pylint-check py{27,35,36,37,38} coverage_report basepython = python3.7</code> </pre> <br><p> 这对于在不同平台上运行测试也很重要，因为CI系统中python的默认版本不同。 </p><br><h2 id="chto-tam-s-ci">  CI怎么了？ </h2><br><h3 id="appveyor"> 传送带 </h3><br><p> 与<a href="https://www.appveyor.com/" rel="nofollow">appveyor</a> -Windows CI集成。 初始设置很简单-可以在界面中完成所有操作，然后下载yaml文件并将其提交到存储库。 </p><br><pre> <code class="plaintext hljs">version: 0.0.{build} install: - cmd: &gt;- C:\\Python37\\python -m pip install --upgrade pip C:\\Python37\\pip install tox build: off test_script: - cmd: C:\\Python37\\tox</code> </pre> <br><p> 在这里，我明确指定<code>python3.7</code>的版本，因为默认情况下将使用<code>python2.7</code> （尽管我明确指定了<code>python3.7</code> ， <code>tox</code>也将使用此版本）。 <br> 照常，徽章的链接已添加到<code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build status Appveyor| .. |Build status Appveyor| image:: https://ci.appveyor.com/api/projects/status/github/zifter/numeral-system-py?branch=master&amp;svg=true :target: https://ci.appveyor.com/project/zifter/numeral-system-py</code> </pre> <br><h3 id="travis-ci"> 特拉维斯 </h3><br><p> 之后，我在Linux（以及在Windows的MacOS和Windows）下与<a href="https://travis-ci.org/" rel="nofollow">Travis CI</a> -CI集成，但是<a href="https://docs.travis-ci.com/user/languages/python/" rel="nofollow"><code>Python builds are not available on the macOS and Windows environments</code></a> 。设置有些复杂，因为配置文件将直接从存储库中使用。配置已经准备好了，我挤进了一个漂亮的提交，合并请求也准备好了。 </p><br><pre> <code class="plaintext hljs">language: python python: 3.8 # dist: xenial # required for Python 3.7 (travis-ci/travis-ci#9069) sudo: required # required for Python 3.7 (travis-ci/travis-ci#9069) addons: apt: sources: - deadsnakes packages: - python3.5 - python3.6 - python3.7 - pypy install: - pip install tox script: - tox</code> </pre> <br><p>  （ <em>反问：为什么CI项目会像yaml格式那么多？</em> ） </p><br><p> 我指出了<code>python3.8</code>的版本，因为它无法通过<code>addon</code>正常工作，并且<code>Travis CI</code>从指定的版本成功创建了<code>virtualenv</code> 。 </p><br><p> 熟悉<code>Travis CI</code>可能会问，为什么不以这种方式明确指定python版本？ 毕竟， <code>Travis CI</code>自动创建<code>virtualenv</code>并在其中执行必要的命令。 </p><br><p> 原因是我们需要收集所有版本的代码覆盖率数据。 但是测试将同时在不同的作业中运行，这就是为什么它无法收集总体覆盖率报告的原因。 </p><br><p> 当然，我敢肯定，可以多一些理解，并且可以解决此问题。 </p><br><p> 按照传统，指向徽章的链接也会添加到<code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build Status Travis CI| .. |Build Status Travis CI| image:: https://travis-ci.org/zifter/numeral-system-py.svg?branch=master :target: https://travis-ci.org/zifter/numeral-system-py</code> </pre> <br><h2 id="dokumentaciya"> 该文件 </h2><br><p> 我认为每个python开发人员都至少使用过一次该服务<a href="https://readthedocs.org/" rel="nofollow">-readthedocs.org</a> 。 在我看来，这是托管其文档的最佳服务。 <br> 我将使用标准工具生成<a href="http://www.sphinx-doc.org/en/master/" rel="nofollow">Sphinx</a>文档。 我遵循<a href="https://docs.readthedocs.io/en/stable/intro/getting-started-with-sphinx.html" rel="nofollow">入门手册中</a>的步骤并获得以下结构： </p><br><pre> <code class="plaintext hljs">src/ docs/ build/ #      html  source/ #     _static/ #   , ,  _templates/ #     conf.py #    index.rst #    make.bat Makefile # make     make</code> </pre> <br><p> 接下来，您需要执行最少的步骤来配置： </p><br><ol><li>  <code>github</code>默认建议以<a href="https://en.wikipedia.org/wiki/Markdown" rel="nofollow">Markdown</a>格式创建<code>README.md</code>文件，而默认情况下作为<code>sphinx</code>建议使用<a href="https://en.wikipedia.org/wiki/ReStructuredText" rel="nofollow">ReStructuredText</a> 。 </li></ol><br><p> 因此，我不得不以<code>.rst</code>格式重写它。 <del> 如果我至少读了一遍入门手册，我意识到<code>sphinx</code>可以在Markdown中完成 </del>  。 <br> 我<code>README.rst</code>文件<code>README.rst</code>在<code>index.rst</code> </p><br><pre> <code class="plaintext hljs">.. include:: ../../README.rst</code> </pre> <br><ol><li> 为了从源代码中的注释自动生成文档，我添加了扩展名<a href="http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html" rel="nofollow">sphinx.ext.autodoc</a> 。 </li><li> 我<code>conf.py</code>包文件夹<code>conf.py</code>到<code>conf.py</code> 这将允许<code>sphinx</code>导入我们的代码进行分析。 <br><pre> <code class="plaintext hljs">import os import sys sys.path.insert(0, os.path.abspath('./../../src')) import numeral_system</code> </pre> </li><li> 我添加了<code>docs/source/api-docs</code>文件夹，并在其中放置每个模块的描述文件。 文档应通过注释自动生成： <br><pre> <code class="plaintext hljs">Roman numeral system ========================= .. automodule:: numeral_system.roman :members:</code> </pre> </li></ol><br><p> 之后，该项目准备向世界展示其描述。 您需要创建一个帐户（最好通过<code>github</code>上的帐户）并导入您的项目，详细步骤在<a href="" rel="nofollow">说明中</a>进行了描述。 <br> 按照传统，我创建了一个<code>tox</code>的环境： </p><br><pre> <code class="plaintext hljs">[testenv:gen_docs] deps = -r docs/requirements.txt commands = sphinx-build -b html docs/source/ docs/build/</code> </pre> <br><p> 我明确使用了<code>sphinx-build</code> ，而不是<code>make</code> ，因为Windows下不存在该<code>sphinx-build</code> 。 而且我不想违反跨平台开发的原则。 </p><br><p> 一旦更改被冻结， <code>readthedocs.org</code>将自动收集文档并将其发布。 </p><br><p> 但是... <a href="https://github.com/readthedocs/readthedocs.org/issues/2569" rel="nofollow"><code>Build failed</code></a> 。 我没有提交<code>sphinx</code>和<code>sphinx_rtd_theme</code> ，我希望<code>readthedocs.org</code>使用当前版本。 但是事实并非如此。 我修复： </p><br><pre> <code class="plaintext hljs">sphinx==2.3.1 sphinx_rtd_theme==0.4.3</code> </pre> <br><p> 我为<code>readthedocs.org</code>创建了一个特殊的配置文件<code>.readthedocs.yml</code> ，其中描述了启动构建的环境： </p><br><pre> <code class="plaintext hljs">python: version: 3.7 install: - requirements: docs/requirements.txt - requirements: requirements.txt</code> </pre> <br><p> 这就是依赖项位于<code>requirements.txt</code>文件中这一事实派上用场的地方。 我正在等待构建，并且<a href="https://numeral-system-py.readthedocs.io/en/latest/" rel="nofollow">文档可用</a> 。 </p><br><p> 再次添加徽章： </p><br><pre> <code class="plaintext hljs">|Docs| .. |Docs| image:: https://readthedocs.org/projects/numeral-system-py/badge/?version=latest&amp;style=flat :target: https://numeral-system-py.readthedocs.io/en/latest/</code> </pre> <br><h2 id="licenzirovanie"> 发牌 </h2><br><p> 值得考虑选择软件包的许可证。 <br> 这是一个非常广泛的主题，因此我阅读了<a href="https://habr.com/ru/post/243091/">这篇文章</a> 。 基本上，选择是在<a href="http://directory.fsf.org/wiki/License:Expat" rel="nofollow">MIT</a>和<a href="" rel="nofollow">Apache 2.0</a>之间。 我喜欢从上下文中成功删除的短语： </p><br><pre> <code class="plaintext hljs">MIT      </code> </pre> <br><p> 我完全同意，我会这样做，如果计划有所更改，您可以轻松更改许可证（尽管以前的版本将在旧版本下）。 </p><br><p> 再次添加徽章 <del> 徽章神 </del>  ： </p><br><pre> <code class="plaintext hljs">|License| .. |License| image:: https://img.shields.io/badge/License-MIT-yellow.svg :target: https://opensource.org/licenses/MIT</code> </pre> <br><p>  <a href="https://gist.github.com/lukas-h/2a5d00690736b4c3a7ba" rel="nofollow">在这里，</a>您可以找到所有许可证的徽章。 </p><br><h2 id="kak-zalit-na-pypi"> 如何上传到pypi？ </h2><br><p> 首先，您需要在<a href="https://pypi.org/" rel="nofollow">pypi.org</a>上创建一个帐户。 然后继续准备包装。 </p><br><h3 id="sozdayu-setupcfg"> 我创建setup.cfg </h3><br><p> 必须正确描述用于安装/构建软件包的配置。 我按照<a href="https://docs.python.org/3/distutils/introduction.html" rel="nofollow">指示进行</a> 。 可以通过<code>setup.py</code>设置数据，但是没有设置某些参数的选项。 因此，请使用<code>setup.cfg</code>文件，您可以在其中指定所有细微差别。 找到了有关如何填充此文件的<a href="https://gist.github.com/althonos/6914b896789d3f2078d1e6237642c35c" rel="nofollow">小模板</a> 。 结果，我同时使用了该文件和该文件-更加方便。 </p><br><p> 这个文件也可以用来配置<code>pylint</code> ， <code>flake8</code>和其他设置，但是我没有。 </p><br><h3 id="kak-sobrat-paket"> 如何组装包装？ </h3><br><p> 我再次写了一个环境，可以帮助我整理必要的软件包： </p><br><pre> <code class="plaintext hljs">[testenv:build_wheel] skip_install = True deps = ;     wheel docutils pygments commands = python -c 'import shutil; (shutil.rmtree(p, ignore_errors=True) for p in ["build", "dist"]);' python setup.py sdist bdist_wheel</code> </pre> <br><p> 为什么要使用python删除文件夹？ 我想遵守跨平台开发的要求，在Windows和Unix下没有方便的方法可以做到这一点。 </p><br><p> 我启动测试环境： </p><br><pre> <code class="plaintext hljs">tox -e build_wheel</code> </pre> <br><p> 结果，在<code>dist</code>文件夹中，我得到： </p><br><pre> <code class="plaintext hljs">dist/ numeral-system_py-0.1.0.tar.gz numeral_system-py-0.1.0-py2.py3-none-any.whl</code> </pre> <br><h3 id="zalivayu"> 我填写！ </h3><br><p> 不完全是 </p><br><p> 首先，值得检查程序包是否正常工作。 我将其上传到测试包存储库。 因此，您需要创建另一个帐户，但是已经在<a href="https://test.pypi.org/" rel="nofollow">test.pypi.org上</a> 。 </p><br><p> 为此，我使用了<a href="https://pypi.org/project/twine/" rel="nofollow">twine</a>软件包-一种在PyPi中填充工件的工具。 </p><br><pre> <code class="plaintext hljs">[testenv:test_upload] skip_install = True deps = twine ;    commands = python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*</code> </pre> <br><p> 最初，该项目名为<code>numsys</code> ，但是在尝试填充该项目时，我遇到了一个事实，即已经存在具有相同名称的软件包！ 而且最烦人的是-他还知道如何转换为罗马数字：)他不是很沮丧，而是将其重命名为<code>numeral-system-py</code> 。 </p><br><p> 现在，您需要从测试环境中安装软件包。 验证也应自动进行： </p><br><pre> <code class="plaintext hljs">[testenv:test_venv] skip_install = True ;         deps = ;   commands = pip install -i https://test.pypi.org/simple/ numeral-system-py</code> </pre> <br><p> 现在，您只需要运行： </p><br><pre> <code class="plaintext hljs">tox -e test_venv ... test_venv: commands_succeeded congratulations :)</code> </pre> <br><p> 似乎有效:) </p><br><h3 id="vot-teper-tochno-zalivayu"> 现在肯定倒了！ </h3><br><p> 是的 </p><br><p> 我创建了一个用于上传到生产存储库的环境。 </p><br><pre> <code class="plaintext hljs">[testenv:pypi_upload] skip_install = True deps = twine commands = python -m twine upload dist/*</code> </pre> <br><p> 以及用于生产验证的环境。 </p><br><pre> <code class="plaintext hljs">[testenv:pypi_venv] skip_install = True deps = ;    commands = pip install numeral-system-py</code> </pre> <br><h3 id="a-vse-tochno-rabotaet"> 一切正常吗？ </h3><br><p> 我用简单的命令检查： </p><br><pre> <code class="plaintext hljs">&gt; virtualenv venv &gt; source venv/bin/activate (venv) &gt; pip install numeral-system-py (venv) &gt; python &gt;&gt;&gt; import numeral_system &gt;&gt;&gt; numeral_system.roman.encode(7) 'VII'</code> </pre> <br><p> 一切都很棒！ </p><br><p>  <a href="https://help.github.com/en/articles/creating-releases" rel="nofollow">我在github上剪切了发行版</a> ，收集了软件包并将其填充到propy pypi中。 </p><br><h2 id="zamechaniya"> 备注 </h2><br><h3 id="obnovleniya-zavisimostey"> 依赖关系更新 </h3><br><p> 在本文准备期间，发布了新版本的pytest，实际上其中已删除了对python 3.4的支持（ <a href="https://github.com/tox-dev/tox/issues/1483" rel="nofollow">实际上</a>在<a href="https://github.com/tartley/colorama" rel="nofollow">colorama</a>软件包中）。 有两种选择： </p><br><ol><li> 提交与3.4兼容的colorama版本； </li><li> 掉落支持3.4 :) </li></ol><br><p> 为了支持第二种选择，最后一个论点是<code>pip</code>在版本19.1中放弃了支持3.4。 </p><br><p> 还存在分析器，格式化程序和其他服务形式的固定依赖项。 这些依赖项可以同时更新。 如果幸运的话，您只能使用升级版本；否则，您将不得不更正代码，甚至添加设置。 </p><br><h3 id="travisci">  TravisCI </h3><br><p> 对于MacOS和Windows不支持python。 在同一工作中为所有版本的python运行<code>tox</code>会有困难。 </p><br><h3 id="versiya-paketa"> 套餐版本 </h3><br><p> 必须遵守<a href="https://semver.org/" rel="nofollow">语义版本控制</a> ，即格式： </p><br><pre> <code class="plaintext hljs">MAJOR.MINOR.PATCH</code> </pre> <br><h3 id="dublirovanie-meta-informacii"> 元信息重复 </h3><br><p> 必须指定软件包的版本和一些其他参数以安装软件包（在<code>setup.cfg</code>或<code>setup.py</code> ）和文档中。 为了避免重复，他只在软件包<code>numeral_system/__init__.py</code>做了说明： </p><br><pre> <code class="plaintext hljs">__version__ = '0.2.0'</code> </pre> <br><p> 然后在<code>setup.py</code>明确使用此变量 </p><br><pre> <code class="plaintext hljs">setup(version=numeral_system.__version__)</code> </pre> <br><p>  <code>docs/source/conf.py</code>也是如此 </p><br><pre> <code class="plaintext hljs">release = numeral_system.__version__</code> </pre> <br><p> 上面的内容适用于任何元信息<code>REAMDE.rst</code> ，项目描述，许可证，作者姓名等。 </p><br><p> 的确，这导致包装在组装时被导入的事实，这可能是不希望的。 </p><br><h3 id="dublirovanie-zavisimostey"> 依赖复制 </h3><br><p>      ,         <code>requirements.txt</code>  <code>setup.cfg</code> . <br>   <a href="https://caremad.io/posts/2013/07/setup-vs-requirement/" rel="nofollow"> </a> ,   —     <code>setup.cfg</code> . <br>      . ,      <code>requirements-dev.txt</code>  . </p><br><h3 id="organizaciya-ishodnikov">   </h3><br><p>    ,       <code>src/</code> .     : </p><br><ul><li>       ; </li><li>    ,             ,   ; </li></ul><br><p>     : </p><br><ul><li>    <code>PyCharm</code> (    ?) —   <code>src</code> ,   . </li></ul><br><h3 id="kommity-i-istoriya-izmeneniy">     </h3><br><p>           —   . <br>  <a href="https://github.com/zifter/numeral-system-py/commits/master" rel="nofollow"> </a>  ,     : </p><br><pre> <code class="plaintext hljs">Add badge with supported version Support for py38</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">Try fix py38 env creating Try fix py38 env creating Try fix py38 env creating Fix check</code> </pre> <br><p> , 3       !        Travis CI. </p><br><p>  <a href="https://habr.com/ru/post/416887/"> </a>  ,    .     —     ,         . </p><br><p>         ,         .       <code>CHANGELOG</code> . </p><br><h3 id="dokumentaciya-1">  </h3><br><p>     ,   <code>Markdown</code> .     ,      <code>rst</code> . </p><br><h3 id="beydzhi"> 徽章 </h3><br><p>      —  ,  ,   ,      .    ,     <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow"> </a> . <br>     <a href="https://pypi.org/project/coverage/" rel="nofollow">coverage</a> . </p><br><h3 id="ogranicheniya-iz-za-ispolzovaniya-raznyh-versiy">  -    </h3><br><p>   ,     ,  , .   <code>six</code>    ,       ,  <code>type hint</code> , <code>asyncio</code>    — . <br>      <code>python2.7</code> ,   <a href="https://pythonclock.org/" rel="nofollow"> </a> .   ,    python3.5+,     . ,         ,      CI   .          . </p><br><h2 id="mozhno-li-sdelat-luchshe">    ? </h2><br><p>       ,    : </p><br><ul><li>   MacOS; </li><li>   python x64  x86; </li><li>   ; </li><li> 100%      ,    <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" rel="nofollow">  </a> .     <a href="https://pypi.org/project/mccabe/" rel="nofollow">mccabe</a> ,      2017 .    ? </li><li>        <a href="https://pyup.io/" rel="nofollow">PyUp</a>  <a href="https://requires.io/" rel="nofollow">requires.io</a> .  ? </li><li>    .     <a href="https://github.com/PyCQA0" rel="nofollow">Python Code Quality Authority</a> , - ? <br><ul><li> <a href="http://mypy-lang.org/" rel="nofollow">mypy</a> —  ; </li><li> <a href="https://github.com/PyCQA/bandit" rel="nofollow">bandit</a> —       ; </li><li> <a href="https://github.com/PyCQA/pyflakes" rel="nofollow">Pyflakes</a> —      ; </li><li> <a href="https://github.com/PyCQA/prospector" rel="nofollow">prospector</a> — ,  <code>pylint</code> , <code>pep8</code> , <code>mccabe</code> . ,    ; </li></ul></li><li>   \   ? </li></ul><br><h2 id="zaklyuchenie"> 结论 </h2><br><p>           open source ,     . <br>           ,    python   <code>github</code> ,       . <br>        <code>stackoverflow.com</code>  issues    <code>github</code>            . <br>           .      .      ?.. </p><br><p> ,  ,     <a href="https://habr.com/ru/company/ruvds/blog/444344/">   </a> . <br>       ,    <a href="https://sourcery.ai/blog/python-best-practices/" rel="nofollow"> </a> . </p><br><p> <a href="https://github.com/zifter/numeral-system-py" rel="nofollow">    github</a> . </p><br><p> 谢谢你 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483512/">https://habr.com/ru/post/zh-CN483512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483502/index.html">太阳，风和水ver 0.2</a></li>
<li><a href="../zh-CN483504/index.html">Sporth-YaP如何进行现场音乐表演</a></li>
<li><a href="../zh-CN483506/index.html">梦见深真空（第1部分）。 扩散蒸汽油泵：复苏和一些理论</a></li>
<li><a href="../zh-CN483508/index.html">十大C ++ CoreHard 2019年秋季会议论文</a></li>
<li><a href="../zh-CN483510/index.html">像这样的小公司的测试仪</a></li>
<li><a href="../zh-CN483516/index.html">停止放二极管2</a></li>
<li><a href="../zh-CN483518/index.html">为纪念VVVVVV游戏十年的开发者，其源代码公开了</a></li>
<li><a href="../zh-CN483520/index.html">在C中使用相似性模式观察器</a></li>
<li><a href="../zh-CN483524/index.html">Habra分析：什么时候最好发布您的帖子？</a></li>
<li><a href="../zh-CN483526/index.html">使用RxJS / Immer管理应用程序状态，作为Redux / MobX的简单替代方案</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>