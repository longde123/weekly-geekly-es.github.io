<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≤üèº üëì üë©üèº‚Äçüè´ Comment passer d'ESXi √† KVM / LXD et ne pas perdre la t√™te üôÜüèº üßëüèª üë®‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendant longtemps, la soci√©t√© Maxnet Systems a utilis√© la version gratuite de VMware - ESXi, √† partir de la version 5.0, comme hyperviseur. La version...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment passer d'ESXi √† KVM / LXD et ne pas perdre la t√™te</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/458922/">  Pendant longtemps, la soci√©t√© Maxnet Systems a utilis√© la version gratuite de VMware - ESXi, √† partir de la version 5.0, comme hyperviseur.  La version payante de vSphere a effray√© le mod√®le de licence, tandis que la version gratuite avait un certain nombre d'inconv√©nients qui n'√©taient pas disponibles dans la version payante, mais vous pouviez les supporter.  Mais lorsque dans les nouvelles versions d'ESXi la nouvelle interface Web a refus√© de fonctionner avec l'ancienne et que la surveillance des matrices RAID a cess√© de montrer des signes de vie, la soci√©t√© a d√©cid√© de rechercher une solution plus universelle et ouverte.  L'entreprise avait d√©j√† une bonne exp√©rience et une bonne impression de LXC - Linux Containers.  Par cons√©quent, il est devenu √©vident que l'hyperviseur de r√™ve sera hybride et combinera KVM et LXD pour diff√©rentes charges - une continuation √©volutive de LXC.  √Ä la recherche d'informations sur KVM, l'entreprise √©tait confront√©e √† des id√©es fausses, des r√¢teaux et des pratiques n√©fastes, mais les tests et le temps ont tout mis en place. <br><br><img src="https://habrastorage.org/webt/s-/vc/6s/s-vc6shq5cfia5bjjcuhixbgukq.jpeg"><br><br>  √Ä propos de comment g√©rer le passage d'ESXi √† KVM et de ne pas conduire une roue sur un r√¢teau, dira <strong>Lev Nikolaev</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">maniaque</a> ) - administrateur et d√©veloppeur de syst√®mes tr√®s charg√©s, formateur en technologies de l'information.  Parlons du r√©seau, des r√©f√©rentiels, des conteneurs, du KVM, du LXD, du LXC, du provisionnement et des machines virtuelles pratiques. <br><a name="habracut"></a><br><h2>  Prologue </h2><br>  Nous identifierons imm√©diatement les pens√©es cl√©s, puis nous les analyserons plus en d√©tail. <br><br>  <strong>R√©seau.</strong>  Alors que les vitesses de vos interfaces ne d√©passent pas 1 Gb / s, le bridge vous suffit.  D√®s que vous voulez en serrer plus, cela vous limitera. <br><br>  <strong>D√©p√¥t.</strong>  Cr√©ez un stockage r√©seau partag√©.  M√™me si vous n'√™tes pas pr√™t √† utiliser 10 Gbit / s √† l'int√©rieur du r√©seau, m√™me 1 Gbit / s vous donnera 125 Mo / s de stockage.  Pour un certain nombre de charges, cela suffira avec une marge, et la migration des machines virtuelles sera une question √©l√©mentaire. <br><br>  <strong>Conteneur ou KVM?</strong>  Avantages, inconv√©nients, pi√®ges.  Quels types de charges sont les mieux plac√©s dans un conteneur et lesquels sont les mieux plac√©s dans un KVM? <br><br>  <strong>LXD ou LXC</strong> .  Est-ce que LXD LXC?  Ou une autre version?  Ou un module compl√©mentaire?  De quoi s'agit-il?  Dissipons les mythes et comprenons les diff√©rences entre LXD et LXC. <br><br>  <strong>Provisionnement pratique</strong> .  Quel est le plus pratique: prendre la m√™me image ou installer le syst√®me √† partir de z√©ro √† chaque fois?  Comment le faire rapidement et avec pr√©cision √† chaque fois? <br><br>  <strong>Machine virtuelle pratique.</strong>  Il y aura des histoires effrayantes sur les chargeurs de d√©marrage, les partitions, LVM. <br><br>  <strong>Divers</strong> .  Beaucoup de petites questions: comment faire glisser rapidement une machine virtuelle d'ESXi vers KVM, comment bien migrer, comment virtualiser correctement les disques? <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HqsxBkxGxqg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Raison de la r√©installation </h2><br>  D'o√π nous est venue l'id√©e folle de passer d'ESXi √† KVM / LXD?  ESXi est populaire parmi les petites et moyennes entreprises.  C'est un bon hyperviseur bon march√©.  Mais il y a des nuances. <br><br>  Nous avons commenc√© avec la version 5.0 - commod√©ment, tout fonctionne!  La prochaine version 5.5 est la m√™me. <br><br>  Depuis la version 6.0, c'est d√©j√† plus difficile.  Sur ESXi, l'interface Web n'est pas devenue imm√©diatement gratuite, uniquement √† partir de la version 6.5, avant qu'un utilitaire pour Windows ne soit requis.  Nous avons support√© cela.  Qui ex√©cute OS X ach√®te Parallels et installe cet utilitaire.  C'est une douleur bien connue. <br><br>  La surveillance clignote p√©riodiquement.  Il √©tait n√©cessaire de red√©marrer les services de gestion dans la console du serveur - puis CIM Heartbeat est r√©apparu.  Nous avons endur√©, car il ne tombait pas toujours. <br><br>  Version ESXi 6.5 - poubelles, d√©chets et atrocit√©s.  Hyperviseur horrible.  Et voici pourquoi. <br><br><ul><li>  <strong>Angular tombe avec une exception √† l'entr√©e de l'interface Web.</strong>  D√®s que vous entrez votre nom d'utilisateur et votre mot de passe - imm√©diatement une exception! </li><li>  <strong>La possibilit√© de surveiller √† distance l'√©tat de la matrice RAID</strong> ne <strong>fonctionne pas</strong> car cela nous convient.  Avant, c'√©tait pratique, mais dans la version 6.5, tout va mal. </li><li>  <strong>Prise en charge faible des cartes r√©seau modernes d'Intel</strong> .  Les cartes r√©seau Intel et ESXi causent de la douleur.  Il y a un fil de discussion sur le forum de support ESXi √† ce sujet.  VMware et Intel ne sont pas amis et les relations ne s'am√©lioreront pas dans un avenir proche.  Le plus triste est que m√™me les clients des solutions payantes rencontrent des probl√®mes. </li><li>  <strong>Aucune migration dans ESXi</strong> .  Sauf si la migration est consid√©r√©e comme une proc√©dure de pause, de copie et de d√©marrage.  Nous mettons la voiture en pause, la copions rapidement et la d√©marrons √† un autre endroit.  Mais il est impossible de l'appeler migration - il y en a toujours une simple. </li></ul><br>  Apr√®s avoir regard√© tout cela, nous avons eu l'id√©e folle de bouger avec ESXi 6.5. <br><br><h2>  Liste de souhaits </h2><br>  Pour commencer, nous avons √©crit une liste de souhaits pour un avenir id√©al que nous allons. <br><br>  <strong>Gestion sous SSH</strong> et Web et plus en option.  L'interface Web est g√©niale, mais lors d'un voyage d'affaires avec l'iPhone, aller √† l'interface Web ESXi et faire quelque chose est g√™nant et difficile.  Par cons√©quent, la seule fa√ßon de tout g√©rer est SSH, il n'y en aura pas d'autre. <br><br>  <strong>Virtualisation Windows.</strong>  Parfois, les clients demandent des choses √©tranges, et notre mission est de les aider. <br><br>  <strong>Toujours de nouveaux pilotes et la possibilit√© de configurer une carte r√©seau</strong> .  D√©sir suffisant, mais non r√©alis√© sous ESXi pur. <br><br>  <strong>Migration en direct, pas de clustering</strong> .  Nous voulons pouvoir faire glisser les machines d'un hyperviseur √† un autre sans ressentir de retard, d'arr√™t ou d'inconv√©nient. <br><br>  La liste de souhaits est pr√™te, puis une recherche difficile a commenc√©. <br><br><h2>  Farine de choix </h2><br>  Le march√© tourne autour du KVM ou du LXC avec diff√©rentes sauces.  Parfois, il semble que Kubernetes est quelque part au-dessus, o√π tout va bien, le soleil et le paradis, et au niveau inf√©rieur, il y a Morlocks - KVM, Xen ou quelque chose comme √ßa ... <br><br>  Par exemple, Proxmox VE est Debian, qui a √©t√© tir√© par le noyau d'Ubuntu.  √áa a l'air bizarre, mais est-ce que √ßa l'am√®ne √† la production? <br><br>  Nos voisins en bas sont Alt Linux.  Ils ont trouv√© une belle solution: ils ont assembl√© Proxmox VE sous forme de package.  Ils ont simplement mis le package dans une seule commande.  C'est pratique, mais nous ne mettons pas Alt Linux en production, donc cela ne nous convenait pas. <br><br><h3>  Prenez KVM </h3><br>  Au final, nous avons choisi KVM.  Ils ne l'ont pas accept√©, Xen, par exemple, √† cause de la communaut√© - KVM en a beaucoup plus.  Il semblait que nous trouverions toujours la r√©ponse √† notre question.  Nous avons d√©couvert plus tard que la taille d'une communaut√© n'affecte pas sa qualit√©. <br><br>  Initialement, nous avons calcul√© que nous prendrions une machine Bare Metal, ajouterions l'Ubuntu avec lequel nous travaillons et lancerions KVM / LXD par le haut.  Nous comptions sur la capacit√© de g√©rer des conteneurs.  Ubuntu est un syst√®me bien connu et il n'y a pas de surprise en termes de r√©solution de probl√®mes de d√©marrage / r√©cup√©ration pour nous.  Nous savons o√π donner un coup de pied si l'hyperviseur ne d√©marre pas.  Tout est clair et pratique pour nous. <br><br><h2>  Cours intensif KVM </h2><br>  Si vous √™tes du monde d'ESXi, vous trouverez beaucoup de choses int√©ressantes.  Apprenez trois mots: QEMU, KVM et libvirt. <br><br>  <strong>QEMU</strong> traduit les souhaits d'un OS virtualis√© en d√©fis d'un processus r√©gulier.  Fonctionne tr√®s bien presque partout, mais lentement.  QEMU lui-m√™me est un produit autonome qui virtualise un tas d'autres appareils. <br><br>  Plus loin sur la sc√®ne vient un tas de <strong>QEMU-KVM</strong> .  Il s'agit du module du noyau Linux pour QEMU.  La virtualisation de toutes les instructions co√ªte cher, nous avons donc un module de noyau KVM qui <strong>ne traduit que quelques instructions</strong> .  En cons√©quence, cela est beaucoup plus rapide, car seuls quelques pour cent des instructions de l'ensemble g√©n√©ral sont trait√©es.  C'est tous les co√ªts de la virtualisation. <br><br>  Si vous venez d'avoir QEMU, le d√©marrage de la machine virtuelle sans liaison ressemble √† ceci: <br><br><pre><code class="plaintext hljs">$ qemu &lt; &gt;</code> </pre> <br>  Dans les param√®tres que vous d√©crivez, bloquez les p√©riph√©riques.  Tout est merveilleux, mais peu pratique.  Il y a donc libvirt. <br><br>  <strong>Le but de libvirt est d'√™tre un outil unique pour tous les hyperviseurs</strong> .  Il peut fonctionner avec n'importe quoi: avec KVM, avec LXD.  Il semble qu'il ne reste plus qu'√† apprendre la syntaxe de libvirt, mais en r√©alit√© cela fonctionne moins bien qu'en th√©orie. <br><br>  Ces trois mots suffisent pour faire monter la premi√®re machine virtuelle dans KVM.  Mais encore une fois, il y a des nuances ... <br><br>  Libvirt a une configuration o√π les machines virtuelles et autres param√®tres sont stock√©s.  Il stocke la configuration dans des fichiers xml - √©l√©gant, √† la mode et directement des ann√©es 90.  Si vous le souhaitez, ils peuvent √™tre modifi√©s √† la main, mais pourquoi, s'il existe des commandes pratiques.  Il est √©galement pratique que les modifications apport√©es aux fichiers xml soient merveilleusement versionn√©es.  Nous utilisons <strong>etckeeper</strong> - version du r√©pertoire, etc.  Il est d√©j√† possible d'utiliser etckeeper et il est grand temps. <br><br><h2>  Cours intensif LXC </h2><br>  Il existe de nombreuses id√©es fausses sur LXC et LXD. <br><br><blockquote>  LXC est la capacit√© du noyau moderne √† utiliser des espaces de noms - pour pr√©tendre que ce n'est pas du tout le noyau qu'il √©tait √† l'origine. </blockquote><br>  Vous pouvez cr√©er autant d'espaces de noms que vous le souhaitez pour chaque conteneur.  Formellement, le noyau est un, mais il se comporte comme de nombreux c≈ìurs identiques.  LXC vous permet d'ex√©cuter des conteneurs, mais ne fournit que des outils de base. <br><br>  Canonical, qui est derri√®re Ubuntu et fait avancer les conteneurs de mani√®re agressive, a publi√© <strong>LXD, un analogue de libvirt</strong> .  Il s'agit d'une liaison qui facilite l'ex√©cution des conteneurs, mais √† l'int√©rieur, il s'agit toujours de LXC. <br><br><blockquote>  LXD est un hyperviseur de conteneur bas√© sur LXC. </blockquote><br>  L'entreprise r√®gne en LXD.  LXD stocke la configuration dans sa base de donn√©es - dans le r√©pertoire <code>/var/lib/lxd</code> .  L√†, LXD m√®ne sa configuration √† la configuration dans SQlite.  La copier n'a pas de sens, mais vous pouvez √©crire les commandes que vous avez utilis√©es pour cr√©er la configuration du conteneur. <br><br>  Il n'y a pas de d√©chargement en tant que tel, mais la plupart des changements sont automatis√©s par les √©quipes.  Il s'agit d'un analogue du fichier Docker, uniquement avec un contr√¥le manuel. <br><br><h2>  La production </h2><br>  Ce √† quoi nous √©tions confront√©s lorsque nous sommes tous entr√©s en service. <br><br><h3>  R√©seau </h3><br>  Combien de poubelles infernales et d'agitation sur Internet √† propos du r√©seau dans KVM!  90% des mat√©riaux disent utiliser un pont. <br><br><blockquote>  Arr√™tez d'utiliser le pont! </blockquote><br>  Qu'est-ce qui ne va pas avec lui?  Derni√®rement, j'ai le sentiment que la folie se produit avec les conteneurs: placez Docker au-dessus de Docker pour pouvoir ex√©cuter Docker dans Docker tout en regardant Docker.  La plupart ne comprennent pas ce que fait le pont. <br><br>  Il met votre contr√¥leur r√©seau en <strong>mode promiscuit√©</strong> et re√ßoit tout le trafic car il ne sait pas lequel et lequel.  En cons√©quence, tout le trafic du pont passe par une merveilleuse pile Linux r√©seau rapide et il y a beaucoup de copies.  Au final, tout est lent et mauvais.  Par cons√©quent, n'utilisez pas de bridge en production. <br><br><h3>  SR-IOV </h3><br>  <strong>SR-IOV est la possibilit√© de virtualiser au sein d'une carte r√©seau</strong> .  La carte r√©seau elle-m√™me est capable d'allouer une partie d'elle-m√™me aux machines virtuelles, ce qui n√©cessite une prise en charge mat√©rielle.  C'est ce qui emp√™chera la migration.  La migration d'une machine virtuelle o√π SR-IOV est manquant est p√©nible. <br><br>  SR-IOV doit √™tre utilis√© lorsqu'il est pris en charge par tous les hyperviseurs dans le cadre de la migration.  Sinon, macvtap est fait pour vous. <br><br><h3>  macvtap </h3><br>  C'est pour ceux dont la carte r√©seau ne prend pas en charge SR-IOV.  Il s'agit de la version all√©g√©e du pont: diff√©rentes adresses MAC sont accroch√©es sur une carte r√©seau, et un <strong>filtrage unicast est utilis√©</strong> : la carte r√©seau n'accepte pas tout, mais strictement selon la liste des adresses MAC. <br><br>  Plus de d√©tails sanglants peuvent √™tre trouv√©s dans l'excellent discours de Toshiaki Makita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">, Virtual Switching Technologies et Linux Bridge</a> .  Il est plein de douleur et de souffrance. <br><br><blockquote>  90% des mat√©riaux sur la fa√ßon de construire un r√©seau en KVM sont inutiles. </blockquote><br>  Si quelqu'un dit que le pont est g√©nial, ne parlez plus √† cette personne. <br><br>  Avec macvtap, le <strong>CPU √©conomise environ 30%</strong> gr√¢ce √† moins de copies.  Mais le mode promiscuit√© a ses propres nuances.  Vous ne pouvez pas vous connecter √† l'interface r√©seau de la machine invit√©e √† partir de l'hyperviseur lui-m√™me - √† partir de l'h√¥te.  Un rapport Toshiaki d√©taille cela.  Mais en bref - cela ne fonctionnera pas. <br><br>  De l'hyperviseur m√™me aller rarement sur SSH.  Il est plus pratique d'y d√©marrer une console, par exemple une console Win.  Il est possible de ¬´surveiller¬ª le trafic sur l'interface - vous ne pouvez pas vous connecter via TCP, mais le trafic sur l'hyperviseur est visible. <br><br><blockquote>  Si vos vitesses sont sup√©rieures √† 1 Gigabit - choisissez macvtap. </blockquote><br>  √Ä des vitesses d'interface allant jusqu'√† ou environ 1 Gigabit par seconde, le pont peut √©galement √™tre utilis√©.  Mais si vous avez une carte r√©seau de 10 Go et que vous souhaitez vous en d√©barrasser, il ne reste que macvtap.  Il n'y a pas d'autre option.  Sauf SR-IOV. <br><br><h3>  systemd-networkd </h3><br>  <strong>C'est un excellent moyen de stocker la configuration r√©seau sur l'hyperviseur lui-m√™me</strong> .  Dans notre cas, c'est Ubuntu, mais pour d'autres syst√®mes, systemd fonctionne. <br><br>  Nous avions un fichier <code>/etc/network/interfaces</code> dans lequel nous conservions tous.  Un fichier n'est pas pratique √† modifier √† chaque fois - systemd-networkd vous permet de diviser la configuration en une dispersion de petits fichiers.  C'est pratique car il fonctionne avec n'importe quel syst√®me de version: il a √©t√© envoy√© √† Git et vous voyez quand et quel changement s'est produit. <br><br>  Il y a une faille que nos networkers ont d√©couverte.  Lorsque vous devez ajouter un nouveau VLAN dans l'hyperviseur, je vais configurer.  Ensuite, je dis: "systemctl restart systemd-networkd".  En ce moment, tout va bien pour moi, mais si les sessions BGP de cette machine sont augment√©es, elles se cassent.  Nos networkers ne l'approuvent pas. <br><br>  Pour l'hyperviseur, il ne se passe rien de mal.  Systemd-networkd ne convient pas aux fronti√®res, aux serveurs avec BGP √©lev√© et aux hyperviseurs - excellent. <br><br>  Systemd-networkd est loin d'√™tre d√©finitif et ne sera jamais termin√©.  Mais c'est plus pratique que d'√©diter un √©norme fichier.  Une alternative √† systemd-networkd dans Ubuntu 18.04 est Netplan.  C'est une fa√ßon ¬´cool¬ª de configurer le r√©seau et de monter sur le r√¢teau. <br><br><h3>  P√©riph√©rique r√©seau </h3><br>  Apr√®s avoir install√© KVM et LXD sur l'hyperviseur, la premi√®re chose que vous verrez est deux ponts.  L'un a fait KVM pour lui-m√™me, et le second - LXD. <br><br><blockquote>  LXD et KVM tentent de d√©ployer leur r√©seau. </blockquote><br>  Si vous avez encore besoin d'un pont - pour les machines de test ou pour jouer, tuez le pont, qui est activ√© par d√©faut et cr√©ez le v√¥tre - celui que vous voulez.  KVM ou LXD le font terriblement - glissez dnsmasq, et l'horreur commence. <br><br><h3>  Stockage </h3><br><blockquote>  Peu importe les impl√©mentations que vous aimez - utilisez le stockage partag√©. </blockquote><br>  Par exemple, iSCSI pour les machines virtuelles.  Vous ne vous d√©barrasserez pas du ¬´point de d√©faillance¬ª, mais vous pouvez <strong>consolider le stockage √† un moment donn√©</strong> .  Cela ouvre de nouvelles opportunit√©s int√©ressantes. <br><br>  Pour ce faire, vous devez disposer d'au moins 10 Gb / s d'interfaces dans le centre de donn√©es.  Mais m√™me si vous n'avez que 1 Gbit / s - ne vous inqui√©tez pas.  Cela repr√©sente environ 125 Mo / s, ce qui est assez bon pour les hyperviseurs qui ne n√©cessitent pas une charge de disque √©lev√©e. <br><br>  KVM peut migrer et faire glisser le stockage.  Mais, par exemple, en mode charge de travail, le transfert d'une machine virtuelle vers quelques t√©raoctets est une t√¢che difficile.  Pour la migration avec un stockage commun, seule la RAM est suffisante, ce qui est √©l√©mentaire.  Cela <strong>r√©duit le temps de migration</strong> . <br><br><h3>  Au final, LXD ou KVM? </h3><br>  Initialement, nous avons suppos√© que pour toutes les machines virtuelles o√π le noyau correspond au syst√®me h√¥te, nous prendrons LXD.  Et l√† o√π nous devons prendre un autre noyau - prenez KVM. <br><br>  En r√©alit√©, les plans n'ont pas d√©coll√©.  Pour comprendre pourquoi, examinez de plus pr√®s LXD. <br><br><h3>  Lxd </h3><br>  Le principal avantage est d'√©conomiser de la m√©moire sur le c≈ìur.  Le noyau est le m√™me et lorsque nous lan√ßons de nouveaux conteneurs, le noyau est le m√™me.  Sur ce, les avantages ont pris fin et les inconv√©nients ont commenc√©. <br><br>  <strong>Le p√©riph√©rique de bloc avec rootfs doit √™tre mont√©.</strong>  C'est plus difficile qu'il n'y para√Æt. <br><br>  <strong>Il n'y a vraiment pas de migration</strong> .  Il est et est bas√© sur le merveilleux instrument sombre et criu que nos compatriotes ont vu.  Je suis fier d'eux, mais dans des cas simples, criu ne fonctionne pas. <br><br>  <strong>zabbix-agent se comporte √©trangement dans un r√©cipient</strong> .  Si vous l'ex√©cutez √† l'int√©rieur du conteneur, vous verrez une s√©rie de donn√©es du syst√®me h√¥te et non du conteneur.  Jusqu'√† pr√©sent, rien ne peut √™tre fait. <br><br>  <strong>Lorsque vous consultez la liste des processus sur l'hyperviseur, il est impossible de comprendre rapidement √† partir de quel conteneur un processus particulier se d√©veloppe</strong> .  Il faut du temps pour comprendre quel espace de noms est l√†, quoi et o√π.  Si la charge quelque part a saut√© plus que d'habitude, alors ne comprends pas rapidement.  C'est le principal probl√®me - la limitation des capacit√©s de r√©ponse.  Une mini enqu√™te est men√©e pour chaque cas. <br><br><blockquote>  Le seul avantage de LXD est d'√©conomiser la m√©moire centrale et de r√©duire les frais g√©n√©raux. </blockquote><br>  Mais la m√©moire partag√©e du noyau dans KVM √©conomise d√©j√† la m√©moire. <br><br>  Jusqu'√† pr√©sent, je ne vois aucune raison d'introduire une production s√©rieuse et LXD.  Malgr√© les meilleurs efforts de Canonical dans ce domaine, la production de LXD pose plus de probl√®mes que de solutions.  Dans un avenir proche, la situation ne changera pas. <br><br>  Mais, on ne peut pas dire que LXD est mauvais.  Il est bon, mais dans des cas limit√©s, dont je parlerai un peu plus tard. <br><br><h3>  Criu </h3><br>  Criu est un utilitaire sombre. <br><br>  Cr√©ez un conteneur vide, il arrivera avec un client DHCP et lui dira: "Suspend!"  Obtenez l'erreur car il y a un client DHCP: ¬´Horreur, horreur!  Il ouvre la prise avec le signe "raw" - quel cauchemar! "  Pire nulle part. <br><br><blockquote>  Impressions de conteneurs: pas de migration, Criu fonctionne √† chaque fois. </blockquote><br>  J'aime ¬´la¬ª recommandation de l'√©quipe LXD que faire de Criu pour qu'il n'y ait aucun probl√®me: <br><br>  - <em>Prenez une version plus fra√Æche du r√©f√©rentiel!</em> <br><br>  Et puis-je en quelque sorte le mettre √† partir du package afin de ne pas courir dans le r√©f√©rentiel? <br><br><h3>  Conclusions </h3><br>  <strong>LXD est merveilleux si vous voulez cr√©er une infrastructure CI / CD.</strong>  Nous prenons LVM - Logical Volume Manager, en faisons un instantan√© et d√©marrons le conteneur dessus.  Tout fonctionne tr√®s bien!  En une seconde, un nouveau conteneur propre est cr√©√©, qui est configur√© pour tester et rouler le chef - nous l'utilisons activement. <br><br>  <strong>LXD est faible pour une production s√©rieuse</strong> .  Nous ne pouvons pas savoir quoi faire avec LXD en production si cela ne fonctionne pas bien. <br><br>  <strong>Choisissez KVM et seulement KVM!</strong> <br><br><h3>  La migration </h3><br>  Je vais le dire bri√®vement.  Pour nous, la migration s'est av√©r√©e √™tre un nouveau monde merveilleux que nous aimons.  Tout y est simple - il y a une √©quipe de migration et deux options importantes: <br><br><pre> <code class="plaintext hljs">virsh migrate &lt;vm&gt; qemu+ssh://&lt;hypervisor&gt;/system --undefinesource -persistent</code> </pre> <br>  Si vous tapez ¬´Migration KVM¬ª dans Google et ouvrez le premier document, vous verrez une commande de migration, mais sans les deux derni√®res cl√©s.  Vous ne verrez aucune mention de leur importance: ¬´Ex√©cutez simplement cette commande!¬ª  Ex√©cutez la commande - et elle migre vraiment, mais seulement comment? <br><br>  Options de migration importantes. <br><br>  <strong>undefinesource - supprimez la machine virtuelle de l'hyperviseur √† partir duquel nous migrons.</strong>  Si vous red√©marrez apr√®s une telle migration, l'hyperviseur que vous avez quitt√© red√©marrera cette machine.  Vous serez surpris, mais c'est normal. <br><br>  <strong>Sans le deuxi√®me param√®tre - persistant - l'hyperviseur o√π vous avez d√©m√©nag√© ne consid√®re pas du tout qu'il s'agit d'une migration permanente.</strong>  Apr√®s le red√©marrage, l'hyperviseur ne se souviendra de rien. <br><br><pre> <code class="plaintext hljs">- virsh dominfo &lt;vm&gt; | grep persistent</code> </pre> <br>  Sans ce param√®tre, la machine virtuelle fait des cercles sur l'eau.  Si le premier param√®tre est sp√©cifi√© sans le second, alors devinez ce qui se passera. <br><br>  Il y a beaucoup de tels moments avec KVM. <br><br><ul><li>  R√©seau: ils vous parlent toujours de bridge - c'est un cauchemar!  Vous lisez et pensez - comment cela?! </li><li>  Migration: ils ne diront rien d'intelligible non plus, jusqu'√† ce que vous vous frappiez la t√™te contre ce mur. </li></ul><br><h2>  Par o√π commencer? </h2><br>  Pour commencer tard - je parle d'autre chose. <br><br><h3>  Provisioning: comment le d√©ployer </h3><br><blockquote>  Si vous √™tes satisfait des options d'installation standard, le m√©canisme pr√©configur√© est parfait. </blockquote><br>  Sous ESXi, nous avons utilis√© virt-install.  Il s'agit d'un moyen r√©gulier de d√©ployer une machine virtuelle.  Il est pratique de cr√©er un fichier pr√©d√©fini dans lequel vous d√©crivez l'image de votre Debian / Ubuntu.  D√©marrez une nouvelle machine en lui fournissant un kit de distribution ISO et un fichier pr√©d√©fini.  Ensuite, la voiture se roule.  Vous vous connectez via SSH, connectez-le √† un chef, lancez des cookies - c'est tout, pr√©cipitez-vous vers la prod! <br><br>  Mais si vous avez assez de virt-install, j'ai de mauvaises nouvelles.  Cela signifie que vous n'avez pas atteint le stade o√π vous voulez faire autre chose.  Nous nous sommes remis et avons r√©alis√© que virt-install ne suffisait pas.  Nous sommes arriv√©s √† une ¬´image dor√©e¬ª, que nous clonons puis lan√ßons des machines virtuelles. <br><br><h3>  Et comment organiser une machine virtuelle? </h3><br>  Pourquoi en sommes-nous arriv√©s √† cette image et pourquoi le provisionnement est-il important?  Parce que la communaut√© comprend encore mal qu'il existe de grandes diff√©rences entre une machine virtuelle et une machine normale. <br><br>  <strong>Une machine virtuelle n'a pas besoin d'un processus de d√©marrage compliqu√© et d'un chargeur de d√©marrage intelligent</strong> .  Il est beaucoup plus facile d'attacher les disques d'une machine virtuelle √† une machine qui a un ensemble complet d'outils qu'en mode de r√©cup√©ration en essayant de sortir quelque part. <br><br>  <strong>Une machine virtuelle a besoin de la simplicit√© d'un appareil</strong> .  Pourquoi ai-je besoin de partitions sur un disque virtuel?  Pourquoi les gens prennent-ils un disque virtuel et y mettent des partitions, pas LVM? <br><br>  <strong>Une machine virtuelle a besoin d'une extensibilit√© maximale</strong> .  Habituellement, les machines virtuelles se d√©veloppent.  Il s'agit d'un processus ¬´cool¬ª - l'augmentation de la partition dans le MBR.  Vous le supprimez, √† ce moment-l√†, essuyez la sueur de votre front et pensez: "N'√©crivez pas maintenant, n'√©crivez pas!"  - et recr√©er avec les nouveaux param√®tres. <br><br><h3>  LVM @ lilo </h3><br>  En cons√©quence, nous sommes arriv√©s √† LVM @ lilo.  Il s'agit d'un chargeur de d√©marrage qui vous permet de configurer √† partir d'un seul fichier.  Si pour √©diter la configuration GRUB vous √©ditez un fichier sp√©cial qui contr√¥le le moteur de mod√®le et construit le monstrueux boot.cfg, alors avec Lilo - un fichier, et rien de plus. <br><br>  LVM sans partition rend le syst√®me parfait et facile.  Le probl√®me est que GRUB ne peut pas vivre sans MBR ou GPT et il g√®le.  Nous lui disons: ¬´GRUB s'installe ici¬ª, mais il ne peut pas, car il n'y a pas de partitions. <br><br>  LVM vous permet d'√©tendre rapidement et de faire des sauvegardes.  Bo√Æte de dialogue standard: <br><br>  <em>- Les gars, comment faites-vous la sauvegarde virtuelle?</em> <br><br>  <em>- ... nous prenons un p√©riph√©rique bloc et copions.</em> <br><br>  <em>- Avez-vous essay√© de vous d√©ployer en arri√®re?</em> <br><br>  <em>- Eh bien, non, tout fonctionne pour nous!</em> <br><br>  Vous pouvez l√©cher un p√©riph√©rique de bloc dans une machine virtuelle √† tout moment, mais s'il existe un syst√®me de fichiers, tout enregistrement qu'il contient n√©cessite trois mouvements - cette proc√©dure n'est pas atomique. <br><br>  Si vous effectuez un instantan√© de la machine virtuelle de l'int√©rieur, elle peut alors communiquer avec le syst√®me de fichiers afin qu'elle atteigne l'√©tat coh√©rent souhait√©.  Mais cela ne convient pas √† tout. <br><br><h2>  Comment construire un conteneur? </h2><br>  Pour d√©marrer et cr√©er un conteneur, il existe des outils r√©guliers √† partir des mod√®les.  LXD propose le mod√®le Ubuntu 16.04 ou 18.04.  Mais si vous √™tes un combattant avanc√© et que vous ne voulez pas de mod√®le standard, mais vos rootfs personnalis√©s, que vous pouvez personnaliser vous-m√™me, la question se pose: comment cr√©er un conteneur √† partir de z√©ro dans LXD? <br><br><h3>  Conteneur √† partir de z√©ro </h3><br>  <strong>Pr√©paration de rootfs</strong> .  Debootstrap vous y aidera: nous expliquons quels packages sont n√©cessaires, lesquels ne le sont pas et installons. <br><br>  <strong>Expliquez √† LXD que nous voulons cr√©er un conteneur √† partir de rootfs sp√©cifiques</strong> .  Mais d'abord, cr√©ez un conteneur vide avec une commande courte: <br><br><pre> <code class="plaintext hljs">curl --unix-socket /var/lib/lxd/unix.socket -X POST -d '{"name": "my-container", "source": {"type": "none"}}' lxd/1.0/containers</code> </pre> <br>  Il peut m√™me √™tre automatis√©. <br><br>  Un lecteur r√©fl√©chi dira: o√π est rootfs my-container?  O√π est-il indiqu√© √† quel endroit?  Mais je n'ai pas dit que c'√©tait tout! <br><br>  <strong>Nous montons les rootfs du conteneur</strong> o√π il vivra.  Ensuite, nous indiquons que le conteneur rootfs vivra ici: <br><br><pre> <code class="plaintext hljs">lxc config set my-container raw.lxc "lxc.rootfs=/containers/my-container/rootfs"</code> </pre> <br>  Encore une fois, cela est automatis√©. <br><br><h3>  Dur√©e de vie du conteneur </h3><br>  <strong>Le conteneur n'a pas son propre noyau</strong> , donc le chargement est plus facile <strong>:</strong> systemd, init et vol√©! <br><br>  Si vous n'utilisez pas d'outils standard pour travailler avec LVM, dans la plupart des cas, pour d√©marrer le conteneur, vous devrez monter les rootfs du conteneur dans l'hyperviseur. <br><br>  Je trouve parfois des articles conseillant autofs.  Ne le faites pas.  Systemd a des unit√©s de montage automatique qui fonctionnent, mais pas autofs.  Par cons√©quent, les unit√©s de montage automatique systemd peuvent et doivent √™tre utilis√©es, mais autofs n'en vaut pas la peine. <br><br><h2>  Conclusions </h2><br>  <strong>Nous aimons KVM avec migration</strong> .  Avec LXD, ce n'est pas encore le chemin, bien que pour tester et construire l'infrastructure, nous l'utilisons l√† o√π il n'y a pas de charge de production. <br><br>  <strong>Nous adorons les performances de KVM</strong> .  Il est plus courant de regarder en haut, de voir un processus pertinent pour cette machine virtuelle et de comprendre qui et ce que nous faisons.  C'est mieux que d'utiliser un ensemble d'utilitaires √©tranges avec des conteneurs pour savoir quel genre de coups sous-marins il y a. <br><br>  <strong>Nous sommes ravis de la migration.</strong>  Cela est largement d√ª au stockage partag√©.  Si nous migrions en faisant glisser des disques, nous ne serions pas si heureux. <br><br><blockquote>  Si vous, comme Leo, √™tes pr√™t √† parler de surmonter les difficult√©s de fonctionnement, d'int√©gration ou de support, alors il est temps <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de soumettre un rapport</a> √† la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DevOpsConf d'</a> automne.  Et nous, au comit√© du programme, nous aiderons √† pr√©parer la m√™me pr√©sentation inspirante et utile que celle-ci. <br><br>  Nous n'attendons pas la date limite de l'appel √† communications et avons d√©j√† accept√© plusieurs rapports au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">programme</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la</a> conf√©rence.  Abonnez-vous √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">newsletter</a> et √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cha√Æne de t√©l√©grammes</a> et restez au courant des nouvelles concernant les pr√©paratifs de DevOpsConf 2019 et ne manquez pas de nouveaux articles et vid√©os. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458922/">https://habr.com/ru/post/fr458922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458912/index.html">Migration vers Zimbra avec imapsync</a></li>
<li><a href="../fr458914/index.html">Ce que vous devez savoir (pas) pour cr√©er des jeux sur Unity</a></li>
<li><a href="../fr458916/index.html">Sous le capot de React. Nous √©crivons notre impl√©mentation √† partir de z√©ro</a></li>
<li><a href="../fr458918/index.html">Ce que vous pouvez apprendre de la conception de jeux hyper-occasionnels</a></li>
<li><a href="../fr458920/index.html">Conf√©rence pour les fans de DevOps</a></li>
<li><a href="../fr458924/index.html">Les accidents vous aident √† apprendre</a></li>
<li><a href="../fr458926/index.html">La trag√©die ne vient pas seule</a></li>
<li><a href="../fr458928/index.html">XLNet vs BERT</a></li>
<li><a href="../fr458930/index.html">Comment les √©tudiants de Perm se sont rendus en finale du championnat international d'analyse de donn√©es Data Mining Cup 2019</a></li>
<li><a href="../fr458932/index.html">Yota - ou comment tout savoir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>