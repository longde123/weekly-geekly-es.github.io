<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèø üë®üèΩ‚Äçüç≥ üßëüèª‚Äçü§ù‚Äçüßëüèª Migraci√≥n a Google Cloud Platform (Google Cloud Platform - GCP) üë©üèø‚Äçüé§ üôéüèº üó£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[parte 2 de 2] 


 [parte 1 de 2] 





 Como lo hicimos 


 Decidimos cambiar a GCP para mejorar el rendimiento de la aplicaci√≥n, al tiempo que aumen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migraci√≥n a Google Cloud Platform (Google Cloud Platform - GCP)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/430874/"><h3 id="chast-2-iz-2">  [parte 2 de 2] </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[parte 1 de 2]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos">  Como lo hicimos </h2><br><p>  Decidimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cambiar a GCP</a> para mejorar el rendimiento de la aplicaci√≥n, al tiempo que aumentamos la escala, pero sin costos significativos.  Todo el proceso tom√≥ m√°s de 2 meses.  Para resolver este problema, hemos formado un grupo especial de ingenieros. </p><br><p>  En esta publicaci√≥n, hablaremos sobre el enfoque elegido y su implementaci√≥n, as√≠ como sobre c√≥mo logramos alcanzar el objetivo principal: llevar a cabo este proceso de la mejor manera posible y transferir toda la infraestructura a Google Cloud Platform, sin comprometer la calidad del servicio al usuario. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="imagen"></p><a name="habracut"></a><br><h2 id="planirovanie">  Planificacion </h2><br><ol><li>  Se ha preparado una lista de verificaci√≥n detallada que identifica cada posible paso.  Se ha creado un diagrama de flujo para describir la secuencia. </li><li>  Se ha desarrollado un plan de reinicio que nosotros, en todo caso, podr√≠amos usar. </li></ol><br><p> Algunas sesiones de lluvia de ideas, y hemos identificado el enfoque m√°s comprensible y m√°s simple para implementar el esquema activo-activo.  Consiste en el hecho de que un peque√±o conjunto de usuarios est√° alojado en una nube y el resto en otra.  Sin embargo, este enfoque caus√≥ problemas, especialmente en el lado del cliente (relacionado con la administraci√≥n de DNS) y provoc√≥ demoras en la replicaci√≥n de la base de datos.  Debido a esto, era casi imposible implementarlo de manera segura.  El m√©todo obvio no proporcion√≥ la soluci√≥n necesaria, y tuvimos que desarrollar una estrategia especializada. </p><br><p>  Con base en el diagrama de dependencia y los requisitos de seguridad operacional, dividimos los servicios de infraestructura en 9 m√≥dulos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="imagen"></p><br><p>  <em>(M√≥dulos b√°sicos para desplegar infraestructura de alojamiento)</em> </p><br><p>  Cada grupo de infraestructura gestion√≥ servicios internos y externos comunes. </p><br><p>  Service <strong>Servicio de mensajer√≠a de infraestructura</strong> : MQTT, HTTPs, Thrift, servidor Gunicorn, m√≥dulo de colas, cliente Async, servidor Jetty, cl√∫ster Kafka. <br>  Services <strong>Servicios de almacenamiento de datos</strong> : cl√∫ster distribuido MongoDB, Redis, Cassandra, Hbase, MySQL y MongoDB. <br>  Service <strong>Servicio de an√°lisis de infraestructura</strong> : cl√∫ster Kafka, cl√∫ster de almac√©n de datos (HDFS, HIVE). </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu">  Prepar√°ndose para un d√≠a significativo: </h2><br><p>  ‚úì Un plan detallado para cambiar a GCP para cada servicio: secuencia, almac√©n de datos, plan de reinicio. <br>  ‚úì Redes de proyectos cruzados (VPC de nube privada virtual compartida [XPN]) en GCP para aislar varias partes de la infraestructura, optimizar la administraci√≥n, mejorar la seguridad y la conectividad. <br>  ‚úì Varios t√∫neles VPN entre el GCP y la nube privada virtual (VPC) en ejecuci√≥n para simplificar la transferencia de grandes cantidades de datos a trav√©s de la red durante el proceso de replicaci√≥n, as√≠ como para el posible despliegue posterior de un sistema paralelo. <br>  ‚úì Automatice la instalaci√≥n y configuraci√≥n de toda la pila utilizando el sistema Chef. <br>  ‚úì Scripts y herramientas de automatizaci√≥n para implementaci√≥n, monitoreo, registro, etc. <br>  ‚úì Configure todas las subredes requeridas y las reglas de firewall administrado para la secuencia del sistema. <br>  ‚úì Replicaci√≥n en m√∫ltiples centros de datos (Multi-DC) para todos los sistemas de almacenamiento. <br>  ‚úì Configurar equilibradores de carga (GLB / ILB) y grupos de instancias administradas (MIG). <br>  ‚úì Scripts y c√≥digo para transferir el contenedor de almacenamiento de objetos al GCP Cloud Storage con puntos de control. </p><br><p>  Pronto, cumplimos con todos los requisitos previos necesarios y preparamos una lista de verificaci√≥n de elementos para mover la infraestructura a la plataforma GCP.  Despu√©s de numerosas discusiones, adem√°s de considerar la cantidad de servicios y sus diagramas de dependencia, decidimos transferir la infraestructura de la nube a GCP en tres noches para cubrir todos los servicios del lado del servidor y de almacenamiento de datos. </p><br><h2 id="perehod">  Transici√≥n </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki">  Estrategia de transferencia de equilibrador de carga: </h3><br><p>  Reemplazamos el cl√∫ster administrado HAProxy utilizado anteriormente con un equilibrador de carga global para procesar decenas de millones de conexiones de usuario activas diariamente. </p><br><p>  ‚äπ <strong>Etapa 1:</strong> </p><br><ul><li>  Los MIG se crean con reglas de reenv√≠o de paquetes para reenviar todo el tr√°fico a las direcciones IP MQTT en la nube existente. </li><li>  Se ha creado un equilibrador de proxy SSL y TCP con MIG como parte del servidor. </li><li>  Para MIG, HAProxy se inicia con servidores MQTT como parte del servidor. </li><li>  En DNS, una pol√≠tica de enrutamiento basada en el peso ha agregado una direcci√≥n IP GLB externa. </li></ul><br><p>  Las conexiones de usuario se implementan gradualmente mientras se rastrea su rendimiento. </p><br><p>  ‚äπ <strong>Paso 2:</strong> transici√≥n de hitos, comenzar a implementar servicios en GCP. <br>  ‚äπ <strong>Etapa 3:</strong> la etapa final de la transici√≥n, todos los servicios se transfieren al GCP. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="imagen"></p><br><p>  <em>(Etapas de transferencia del equilibrador de carga)</em> </p><br><p>  En esta etapa, todo funcion√≥ como se esperaba.  Pronto, lleg√≥ el momento de implementar varios servicios HTTP internos en GCP con enrutamiento, dado el peso de los coeficientes.  Seguimos de cerca todos los indicadores.  Cuando comenzamos a aumentar gradualmente el tr√°fico, el d√≠a antes de la transici√≥n planificada, aumentaron los retrasos en la interacci√≥n VPC a trav√©s de VPN (se registraron retrasos de 40 ms - 100 ms, aunque antes eran menos de 10 ms). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="imagen"></p><br><p>  <em>(Instant√°nea de la comprobaci√≥n del retraso de la red cuando dos VPC interact√∫an)</em> </p><br><p>  El monitoreo mostr√≥ claramente: algo estaba mal con ambos canales de red en la nube que usaban t√∫neles VPN.  Incluso el rendimiento del t√∫nel VPN no alcanz√≥ la marca √≥ptima.  Esta situaci√≥n ha comenzado a afectar negativamente a algunos de nuestros servicios de usuario.  Inmediatamente devolvimos todos los servicios HTTP previamente migrados a su estado original.  Nos contactamos con los equipos de soporte de TAM y servicios en la nube, proporcionamos los datos iniciales necesarios y comenzamos a entender por qu√© crec√≠an las demoras.  Los especialistas de soporte llegaron a la conclusi√≥n de que se logr√≥ el ancho de banda de red m√°ximo en el canal de la nube entre dos proveedores de servicios en la nube.  De ah√≠ el crecimiento de los retrasos en la red durante la transferencia de sistemas internos. </p><br><p>  Este incidente oblig√≥ a suspender la transici√≥n a la nube.  Los proveedores de servicios en la nube no pudieron duplicar el ancho de banda lo suficientemente r√°pido.  Por lo tanto, volvimos a la etapa de planificaci√≥n y revisamos la estrategia.  Decidimos transferir la infraestructura de la nube a GCP en una noche en lugar de tres e incluimos en el plan todos los servicios de la parte del servidor y el almacenamiento de datos.  Cuando lleg√≥ la hora "X", todo transcurri√≥ sin problemas: ¬°las cargas de trabajo se transfirieron con √©xito a Google Cloud sin ser notadas por nuestros usuarios! </p><br><h2 id="strategiya-perenosa-bazy-dannyh">  Estrategia de migraci√≥n de base de datos: </h2><br><p>  Fue necesario transferir m√°s de 50 puntos finales de base de datos para un DBMS relacional, almacenamiento en memoria, as√≠ como NoSQL y cl√∫steres distribuidos y escalables con baja latencia.  Hemos colocado r√©plicas de todas las bases de datos en GCP.  Esto se hizo para todas las implementaciones, excepto HBase. </p><br><p>  Replica Replicaci√≥n <strong>maestro-esclavo:</strong> implementado para MySQL, Redis, MongoDB y clusters MongoS. <br>  <strong>Multi Multi-DC replication:</strong> implementado para clusters Cassandra. <br>  ‚äπ <strong>Cl√∫steres duales:</strong> se ha configurado <strong>un</strong> cl√∫ster paralelo para Gbase en GCP.  Se migraron los datos existentes, se configur√≥ la doble entrada de acuerdo con la estrategia de mantener la consistencia de los datos en ambos grupos. </p><br><p>  En el caso de HBase, el problema fue establecer con Ambari.  Encontramos algunas dificultades al colocar cl√∫steres en varios centros de datos, por ejemplo, hubo problemas con DNS, un script de reconocimiento de rack, etc. </p><br><p>  Los pasos finales (despu√©s de mover los servidores) incluyeron mover las r√©plicas a los servidores principales y cerrar las bases de datos antiguas.  Seg√∫n lo planeado, determinando la prioridad de la transferencia de la base de datos, utilizamos Zookeeper para la configuraci√≥n necesaria de los cl√∫steres de aplicaciones. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="imagen"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy">  Estrategia de migraci√≥n de servicios de aplicaciones </h2><br><p>  Para transferir las cargas de trabajo de los servicios de aplicaciones del alojamiento actual a la nube de GCP, utilizamos el enfoque de levantar y cambiar.  Para cada servicio de aplicaci√≥n, creamos un grupo de instancias administradas (MIG) con escala autom√°tica. </p><br><p>  De acuerdo con un plan detallado, comenzamos a migrar servicios a GCP, teniendo en cuenta la secuencia y las dependencias de los almacenes de datos.  Todos los servicios de pila de mensajes se migraron a GCP sin ning√∫n tiempo de inactividad.  S√≠, hubo algunos problemas menores, pero los tratamos de inmediato. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="imagen"></p><br><p>  Por la ma√±ana, a medida que aumentaba la actividad del usuario, seguimos cuidadosamente todos los paneles e indicadores para identificar r√°pidamente los problemas.  Surgieron algunas dificultades, pero pudimos eliminarlas r√°pidamente.  Uno de los problemas se debi√≥ a las limitaciones del equilibrador de carga interno (ILB), que no puede manejar m√°s de 20,000 conexiones concurrentes.  ¬°Y necesit√°bamos 8 veces m√°s!  Por lo tanto, agregamos ILB adicionales a nuestra capa de administraci√≥n de conexiones. </p><br><p>  En las primeras horas de carga m√°xima despu√©s de la transici√≥n, controlamos todos los par√°metros con especial cuidado, ya que toda la carga de la pila de mensajes se transfiri√≥ a GCP.  Hubo algunos problemas menores que tratamos muy r√°pidamente.  Al migrar otros servicios, tomamos el mismo enfoque. </p><br><h2 id="perenos-hranilischa-obektov">  Migraci√≥n de almacenamiento de objetos: </h2><br><p>  Utilizamos el servicio de almacenamiento de objetos principalmente de tres maneras. </p><br><p>  ‚äπ Almacenamiento de archivos multimedia enviados a un chat personal o grupal.  El per√≠odo de retenci√≥n est√° determinado por la pol√≠tica de gesti√≥n del ciclo de vida. <br>  ‚äπ Almacenamiento de im√°genes y miniaturas del perfil de usuario. <br>  ‚äπ Almacenamiento de archivos multimedia de las secciones "Historial" y "L√≠nea de tiempo" y las miniaturas correspondientes. </p><br><p>  Utilizamos la herramienta de transferencia de almacenamiento de Google para copiar objetos antiguos de S3 a GCS.  Tambi√©n utilizamos un MIG personalizado basado en Kafka para transferir objetos de S3 a GCS cuando se requer√≠a una l√≥gica especial. </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi">  La transici√≥n de S3 a GCS incluy√≥ los siguientes pasos: </h3><br><p>  ‚óè Para el primer caso de uso del almac√©n de objetos, comenzamos a escribir nuevos datos tanto en S3 como en GCS, y despu√©s del vencimiento comenzamos a leer datos de GCS usando la l√≥gica en el lado de la aplicaci√≥n.  La transferencia de datos antiguos no tiene sentido, y este enfoque es rentable. <br>  ‚óè Para el segundo y tercer caso de uso, comenzamos a escribir nuevos objetos en GCS y cambiamos la ruta para leer los datos, de modo que la b√∫squeda se realiza primero en GCS y solo entonces, si no se encuentra el objeto, en S3. <br>  Tom√≥ <strong>meses</strong> planificar, verificar la exactitud del concepto, preparar y crear un prototipo, pero luego decidimos la transici√≥n y la implementamos muy r√°pidamente.  Evaluamos los riesgos y nos dimos cuenta de que la migraci√≥n r√°pida es preferible y casi imperceptible. <br>  Este proyecto a gran escala nos ha ayudado a obtener una posici√≥n s√≥lida y a aumentar la productividad del equipo en muchas √°reas, ya que la mayor√≠a de las operaciones manuales sobre la gesti√≥n de la infraestructura de la nube se han realizado en el pasado. <br>  ‚óè En cuanto a los usuarios, ahora hemos recibido todo lo necesario para garantizar la m√°s alta calidad de su servicio.  El tiempo de inactividad casi ha desaparecido, y las nuevas caracter√≠sticas se est√°n implementando m√°s r√°pido. <br>  ‚óè Nuestro equipo dedica menos tiempo a tareas de mantenimiento y puede centrarse en proyectos de automatizaci√≥n y crear nuevas herramientas. <br>  ‚óè Obtuvimos acceso a un conjunto de herramientas sin precedentes para trabajar con grandes datos, as√≠ como a funcionalidades listas para el aprendizaje y an√°lisis autom√°tico.  Ver detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠.</a> <br>  ‚óè El compromiso de Google Cloud de trabajar con el proyecto de c√≥digo abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kubernetes</a> tambi√©n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√°</a> en l√≠nea con nuestro plan de desarrollo para este a√±o. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430874/">https://habr.com/ru/post/es430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430864/index.html">Los partidos no son un juguete?</a></li>
<li><a href="../es430866/index.html">Beijing introducir√° una calificaci√≥n social para los residentes en 2020</a></li>
<li><a href="../es430868/index.html">¬øQu√© recordar al comprar NGFW? Lista de verificaci√≥n</a></li>
<li><a href="../es430870/index.html">Instalar BigBlueButton en Ubuntu 16.04</a></li>
<li><a href="../es430872/index.html">¬øQui√©n ganar√° el debate de malla vs ESB</a></li>
<li><a href="../es430876/index.html">Desarrollo a trav√©s de pruebas: mejora de habilidades</a></li>
<li><a href="../es430878/index.html">Disponible PhpStorm 2018.3</a></li>
<li><a href="../es430880/index.html">Otra implementaci√≥n de procesamiento de datos</a></li>
<li><a href="../es430882/index.html">Xiaomi Aqara Switch rehace de ZigBee a Z-Wave</a></li>
<li><a href="../es430884/index.html">F√°brica de impresi√≥n: por qu√© "LANIT-Integration" abri√≥ su propia "imprenta"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>