<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèõÔ∏è ‚óºÔ∏è üêú Comment j'ai patch√© l'univers üë©üèΩ‚Äçüè≠ üî¥ üëêüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a beaucoup d'articles sur le d√©veloppement de jeux sur Habr√©, mais parmi eux il y a tr√®s peu d'articles qui se rapportent √† des sujets ¬´en coulis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai patch√© l'univers</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440870/"><img src="https://habrastorage.org/webt/qx/ux/p6/qxuxp6yfki43hwobitxc9pte6jm.jpeg" alt="image"><br><br>  <i>Il y a beaucoup d'articles sur le d√©veloppement de jeux sur Habr√©, mais parmi eux il y a tr√®s peu d'articles qui se rapportent √† des sujets ¬´en coulisses¬ª.</i>  <i>L'un de ces sujets est l'organisation de la livraison du jeu √† un grand nombre d'utilisateurs depuis longtemps (un, deux, trois).</i>  <i>Malgr√© le fait que pour certains la t√¢che puisse sembler futile, j'ai d√©cid√© de partager mon exp√©rience de marche du r√¢teau dans cette affaire pour un projet sp√©cifique.</i>  <i>Toute personne int√©ress√©e - s'il vous pla√Æt.</i> <br><a name="habracut"></a><br>  <i>Une petite digression sur la divulgation d'informations.</i>  <i>La plupart des entreprises sont tr√®s jalouses que la ¬´cuisine int√©rieure¬ª ne devienne pas accessible au grand public.</i>  <i>Pourquoi - je ne sais pas, mais qu'est-ce que - c'est.</i>  <i>Dans ce projet particulier - The Universim - j'ai eu de la chance et le PDG de Crytivo Inc.</i>  <i>(anciennement Crytivo Games Inc.) Alex Wallet s'est av√©r√© absolument sain d'esprit dans une telle affaire, j'ai donc l'occasion de partager mon exp√©rience avec les autres.</i> <br><br><h3>  Un peu de patcher en soi </h3><br>  Je participe au d√©veloppement de jeux depuis longtemps.  Dans certains - en tant que concepteur de jeux et programmeur, dans certains - en tant que fusion d'un administrateur syst√®me et d'un programmeur (je n'aime pas le terme ¬´devops¬ª, car il ne refl√®te pas exactement l'essence des t√¢ches que j'ex√©cute dans de tels projets). <br><br>  Fin 2013 (l'horreur du temps qui passe), j'ai pens√© √† proposer de nouvelles versions (builds) aux utilisateurs.  Bien s√ªr, √† cette √©poque, il y avait de nombreuses solutions pour une telle t√¢che, mais le d√©sir de fabriquer un produit et le d√©sir de ¬´construction de v√©los¬ª ont gagn√©.  De plus, je voulais apprendre le C # plus profond√©ment - j'ai donc d√©cid√© de cr√©er mon propre patcher.  Pour l'avenir, je dirai que le projet a √©t√© un succ√®s, plus d'une dizaine d'entreprises l'ont utilis√© et l'utilisent dans leurs projets, certaines ont demand√© de r√©aliser une version prenant en compte exactement leurs souhaits. <br><br>  La solution classique consiste √† cr√©er des packages delta (ou diffs) d'une version √† l'autre.  Cependant, cette approche n'est pas pratique pour les joueurs et les d√©veloppeurs de testeurs - dans un cas, pour obtenir la derni√®re version du jeu, vous devez parcourir toute la cha√Æne des mises √† jour.  C'est-√†-dire  le joueur doit rassembler s√©quentiellement une certaine quantit√© de donn√©es qu'il (a) n'utilisera jamais, et le d√©veloppeur de stocker sur son serveur (ou serveurs) un tas de donn√©es obsol√®tes dont certains des joueurs pourraient avoir besoin une fois. <br><br>  Dans un autre cas, vous devez t√©l√©charger le correctif pour votre version au plus tard, mais le d√©veloppeur doit garder tout ce zoo de correctifs √† la maison.  Certaines impl√©mentations de syst√®mes de correctifs n√©cessitent certains logiciels et une certaine logique sur les serveurs - ce qui cr√©e √©galement un casse-t√™te suppl√©mentaire pour les d√©veloppeurs.  De plus, les d√©veloppeurs de jeux ne veulent souvent rien faire qui ne soit directement li√© au d√©veloppement du jeu lui-m√™me.  Je dirai m√™me plus - la plupart ne sont pas des sp√©cialistes capables de configurer des serveurs pour la distribution de contenu - ce n'est tout simplement pas leur domaine d'activit√©. <br><br>  Avec tout cela √† l'esprit, je voulais trouver une solution qui serait aussi simple que possible pour les utilisateurs (qui veulent jouer plus vite et ne pas danser avec des correctifs de diff√©rentes versions), ainsi que pour les d√©veloppeurs qui ont besoin d'√©crire un jeu sans savoir quoi et pourquoi non mis √† jour par le prochain utilisateur. <br><br>  Connaissant le fonctionnement de certains protocoles de synchronisation des donn√©es - lorsque les donn√©es sont analys√©es sur le client et que seules les modifications du serveur sont transmises - j'ai d√©cid√© d'utiliser la m√™me approche. <br>  De plus, en pratique, de version en version tout au long de la p√©riode de d√©veloppement, de nombreux fichiers de jeu changent l√©g√®rement - la texture est l√†, le mod√®le lui-m√™me, quelques sons. <br><br>  En cons√©quence, il semblait logique de consid√©rer chaque fichier dans le r√©pertoire du jeu comme un ensemble de blocs de donn√©es.  √Ä la sortie de la prochaine version, la construction du jeu est analys√©e, une carte de blocs est cr√©√©e et les fichiers du jeu eux-m√™mes sont compress√©s bloc par bloc.  Le client analyse les blocs existants et seule la diff√©rence est t√©l√©charg√©e. <br><br>  Initialement, le patcher √©tait pr√©vu comme module dans Unity3D, cependant, un d√©tail d√©sagr√©able est apparu qui m'a fait reconsid√©rer cela.  Le fait est que Unity3D est une application (moteur) totalement ind√©pendante de votre code.  Et pendant que le moteur fonctionne, tout un tas de fichiers sont ouverts, ce qui cr√©e des probl√®mes lorsque vous souhaitez les mettre √† jour. <br><br>  Dans les syst√®mes de type Unix, l'√©crasement d'un fichier ouvert (sauf s'il est sp√©cifiquement verrouill√©) ne pose aucun probl√®me, mais sous Windows, sans danser avec un tambourin, une telle ¬´feinte avec des oreilles¬ª ne fonctionne pas.  C'est pourquoi j'ai cr√©√© le patcher comme une application distincte qui ne charge que des biblioth√®ques syst√®me.  De fait, le patcher lui-m√™me s'est av√©r√© √™tre un utilitaire compl√®tement ind√©pendant du moteur Unity3D, ce qui n'a cependant pas emp√™ch√© de l'ajouter au magasin Unity3D. <br><br><h3>  Algorithme Patcher </h3><br>  Ainsi, les d√©veloppeurs publient de nouvelles versions avec une certaine fr√©quence.  Les joueurs veulent obtenir ces versions.  L'objectif du d√©veloppeur est de fournir ce processus √† un co√ªt minimal et avec un minimum de maux de t√™te pour les joueurs. <br><br><h3>  Du d√©veloppeur </h3><br>  Lors de la pr√©paration d'un patch, l'algorithme des actions du patcher ressemble √† ceci: <br><br>  ‚óã Cr√©ez une arborescence de fichiers de jeu avec leurs attributs et les sommes de contr√¥le SHA512 <br>  ‚óã Pour chaque fichier: <br>  ‚ñ∫ Divisez le contenu en blocs. <br>  ‚ñ∫ Enregistrez la somme de contr√¥le SHA256. <br>  ‚ñ∫ Compressez un bloc et ajoutez-le √† la carte des blocs de fichiers. <br>  ‚ñ∫ Enregistrez l'adresse du bloc dans l'index. <br>  ‚óã Enregistrez l'arborescence des fichiers avec leurs sommes de contr√¥le. <br>  ‚óã Enregistrez le fichier de donn√©es de version. <br><br>  Le d√©veloppeur doit t√©l√©charger les fichiers re√ßus sur le serveur. <br><br><h4>  C√¥t√© joueur </h4><br>  Sur le client, le patcher effectue les op√©rations suivantes: <br>  ‚óã Se copie dans un fichier avec un nom diff√©rent.  Cela mettra √† jour le fichier ex√©cutable du patcher si n√©cessaire.  Le contr√¥le est ensuite transf√©r√© sur la copie et l'original est termin√©. <br>  ‚óã T√©l√©chargez le fichier de version et comparez-le avec le fichier de version local. <br>  ‚óã Si la comparaison n'a pas r√©v√©l√© de diff√©rence - vous pouvez jouer, nous avons la derni√®re version.  S'il y a une diff√©rence, passez √† l'√©l√©ment suivant. <br>  ‚óã T√©l√©chargez une arborescence de fichiers avec leurs sommes de contr√¥le. <br>  ‚óã Pour chaque fichier dans l'arborescence du serveur: <br>  ‚ñ∫ S'il y a un fichier, il consid√®re sa somme de contr√¥le (SHA512).  Sinon, il le consid√®re comme √©tant vide, (c'est-√†-dire compos√© de z√©ros solides) et consid√®re √©galement sa somme de contr√¥le. <br>  ‚ñ∫ Si la somme du fichier local ne correspond pas √† la somme de contr√¥le du fichier de la derni√®re version: <br>  ‚ñ∫ Cr√©e une carte de blocs locale et la compare avec la carte de blocs du serveur. <br>  ‚ñ∫ Pour chaque bloc local qui diff√®re du bloc distant, il t√©l√©charge un bloc compress√© depuis le serveur et l'√©crase localement. <br>  ‚óã S'il n'y a aucune erreur, met √† jour le fichier de version. <br><br>  J'ai fait la taille du bloc de donn√©es un multiple de 1024 octets, apr√®s un certain nombre de tests, j'ai d√©cid√© qu'il √©tait plus facile de fonctionner avec des blocs de 64 Ko.  Bien que l'universalit√© du code demeure: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#region DQPatcher class public class DQPatcher { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// some internal constants // 1 minute timeout by default private const int DEFAULT_NETWORK_TIMEOUT = 60000; // maximum number of compressed blocks, which we will download at once private const UInt16 MAX_COMPRESSED_BLOCKS = 1000; // default block size, you can use range from 4k to 64k, //depending on average size of your files in the project tree private const uint DEFAULT_BLOCK_SIZE = 64 * 1024; ... #region public constants and vars section // X * 1024 bytes by default for patch creation public static uint blockSize = DEFAULT_BLOCK_SIZE; ... #endregion ....</span></span></span></span></code> </pre> <br>  Si vous r√©duisez les blocs, le client requiert moins de modifications lorsque les modifications elles-m√™mes sont peu nombreuses.  Cependant, un autre probl√®me se pose - la taille du fichier d'index augmente inversement avec la diminution de la taille du bloc - c'est-√†-dire  si nous fonctionnons avec des blocs de 8 Ko, le fichier d'index sera 8 fois plus grand qu'avec des blocs de 64 Ko. <br><br>  J'ai choisi SHA256 / 512 pour les fichiers et les blocs √† partir des consid√©rations suivantes: la vitesse diff√®re l√©g√®rement par rapport au (obsol√®te) MD5 / SHA128, mais vous devez toujours lire les blocs et les fichiers.  Et la probabilit√© de collisions avec SHA256 / 512 est nettement moindre qu'avec MD5 / SHA128.  √ätre compl√®tement ennuyeux - c'est dans ce cas, mais il est si petit que cette probabilit√© peut √™tre n√©glig√©e. <br><br>  De plus, le client prend en compte les points suivants: <br>  ‚ñ∫ Les blocs de donn√©es peuvent √™tre d√©plac√©s dans diff√©rentes versions, c'est-√†-dire  localement, nous avons le bloc num√©ro 10, et sur le serveur, nous avons le bloc num√©ro 12, ou vice versa.  Ceci est pris en compte afin de ne pas t√©l√©charger de donn√©es suppl√©mentaires. <br>  ‚ñ∫ Les blocs ne sont pas demand√©s un par un, mais en groupes - le client essaie de combiner les plages des blocs n√©cessaires et les demande au serveur en utilisant l'en-t√™te Range.  Cela minimise √©galement la charge du serveur: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// get compressed remote blocks of data and return it to the caller // Note: we always operating with compressed data, so all offsets are in the _compressed_ data file!! // Throw an exception, if fetching compressed blocks failed public byte[] GetRemoteBlocks(string remoteName, UInt64 startByteRange, UInt64 endByteRange) { if (verboseOutput) Console.Error.WriteLine("Getting partial content for [" + remoteName + "]"); if (verboseOutput) Console.Error.WriteLine("Range is [" + startByteRange + "-" + endByteRange + "]"); int bufferSize = 1024; byte[] remoteData; byte[] buffer = new byte[bufferSize]; HttpWebRequest httpRequest = (HttpWebRequest)WebRequest.Create(remoteName); httpRequest.KeepAlive = true; httpRequest.AddRange((int)startByteRange, (int)endByteRange); httpRequest.Method = WebRequestMethods.Http.Get; httpRequest.ReadWriteTimeout = this.networkTimeout; try { // Get back the HTTP response for web server HttpWebResponse httpResponse = (HttpWebResponse)httpRequest.GetResponse(); if (verboseOutput) Console.Error.WriteLine("Got partial content length: " + httpResponse.ContentLength); remoteData = new byte[httpResponse.ContentLength]; Stream httpResponseStream = httpResponse.GetResponseStream(); if (!((httpResponse.StatusCode == HttpStatusCode.OK) || (httpResponse.StatusCode == HttpStatusCode.PartialContent))) // rise an exception, we expect partial content here { RemoteDataDownloadingException pe = new RemoteDataDownloadingException("While getting remote blocks:\n" + httpResponse.StatusDescription); throw pe; } int bytesRead = 0; int rOffset = 0; while ((bytesRead = httpResponseStream.Read(buffer, 0, bufferSize)) &gt; 0) { // if(verboseOutput) Console.Error.WriteLine("Got ["+bytesRead+"] bytes of remote data block."); Array.Copy(buffer, 0, remoteData, rOffset, bytesRead); rOffset += bytesRead; } if (verboseOutput) Console.Error.WriteLine("Total got: [" + rOffset + "] bytes"); httpResponse.Close(); } catch (Exception ex) { if (verboseOutput) Console.Error.WriteLine(ex.ToString()); PatchException pe = new PatchException("Unable to fetch URI " + remoteName, ex); throw pe; } return remoteData; }</span></span></code> </pre> <br>  Bien s√ªr, il s'est av√©r√© que le client peut √™tre interrompu √† tout moment et lors du lancement ult√©rieur, il poursuivra de facto son travail et ne t√©l√©chargera pas tout √† partir de z√©ro. <br><br>  Ici vous pouvez regarder une vid√©o illustrant le travail du patcher sur le projet d'exemple Angry Bots: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lTyeYJcKbzo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  √Ä propos de l'organisation du patch de l'univers du jeu </h3><br>  En septembre 2015, Alex Koshelkov m'a contact√© et m'a propos√© de rejoindre le projet - ils avaient besoin d'une solution qui fournirait √† 30 000 (avec une queue) de joueurs des mises √† jour mensuelles.  La taille initiale du jeu dans l'archive est de 600 m√©gaoctets.  Avant de me contacter, il y avait eu des tentatives de faire votre propre version en utilisant Electron, mais tout s'est heurt√© au m√™me probl√®me de fichiers ouverts (√† propos, la version actuelle d'Electron peut le faire) et quelques autres.  De plus, aucun des d√©veloppeurs n'a compris comment tout cela fonctionnerait - ils m'ont fourni plusieurs conceptions de v√©los, la partie serveur √©tait compl√®tement absente - ils voulaient le faire apr√®s que toutes les autres t√¢ches aient √©t√© r√©solues. <br><br>  En outre, il √©tait n√©cessaire de r√©soudre le probl√®me de la pr√©vention de la fuite des cl√©s des joueurs - le fait est que les cl√©s √©taient destin√©es √† la plate-forme Steam, bien que le jeu lui-m√™me sur Steam ne soit pas encore accessible au public.  La distribution du jeu √©tait strictement requise par la cl√© - bien que les joueurs puissent partager la cl√© du jeu avec des amis, cela pourrait √™tre n√©glig√©, car si le jeu apparaissait sur Steam, la cl√© ne pouvait √™tre activ√©e qu'une seule fois. <br><br>  Dans la version normale du patcher, l'arborescence des donn√©es du patch ressemble √† ceci: <br><pre> ./
 | - linux
 |  | - 1.0.0
 |  `- version.txt
 | - macosx
 |  | - 1.0.0
 |  `- version.txt
 `- fen√™tres
     | - 1.0.0
     `- version.txt
</pre><br><br>  Je devais m'assurer que seuls ceux avec la bonne cl√© avaient acc√®s. <br><br>  J'ai trouv√© la solution suivante - pour chaque cl√©, nous obtenons son hachage (SHA1), puis nous l'utilisons comme chemin d'acc√®s aux donn√©es de patch sur le serveur.  Sur le serveur, nous transf√©rons les donn√©es du correctif √† un niveau sup√©rieur √† docroot et ajoutons des liens symboliques au r√©pertoire avec les donn√©es du correctif dans le docroot lui-m√™me.  Les liens symboliques ont les m√™mes noms que les hachages de touches, uniquement divis√©s en plusieurs niveaux (pour faciliter le fonctionnement du syst√®me de fichiers), c'est-√†-dire  le hachage 0f99e50314d63c30271 ... ... ade71963e7ff sera repr√©sent√© comme <br><pre> ./0f/99/e5/0314d63c30271.....ade71963e7ff -----&gt; / full / path / to / patch-data /.
</pre><br>  Ainsi, il n'est pas n√©cessaire de distribuer les cl√©s elles-m√™mes √† quelqu'un qui prendra en charge les serveurs de mise √† jour - il suffit de transf√©rer leurs hachages, qui sont absolument inutiles aux joueurs eux-m√™mes. <br><br>  Pour ajouter de nouvelles cl√©s (ou supprimer les anciennes) - ajoutez / supprimez simplement le lien symbolique correspondant. <br><br>  Avec cette impl√©mentation, la v√©rification de la cl√© elle-m√™me n'est √©videmment effectu√©e nulle part; la r√©ception de 404 erreurs sur le client indique que la cl√© est incorrecte (ou a √©t√© d√©sactiv√©e). <br><br>  Il convient de noter que l'acc√®s aux cl√©s n'est pas une protection DRM √† part enti√®re - ce ne sont que des restrictions au stade des tests alpha et b√™ta (ferm√©s).  Et la recherche est facilement interrompue par le biais du serveur Web lui-m√™me (au moins dans Nginx, que j'utilise). <br><br>  Au cours du mois de lancement, seulement 2,5 To de trafic ont √©t√© livr√©s le premier jour seulement, et les jours suivants, environ le m√™me montant est distribu√© en moyenne par mois: <br><br><img src="https://habrastorage.org/webt/nl/a8/xn/nla8xn_apxlj7gfk20fyhdtm5xi.png" alt="image"><br><br>  Par cons√©quent, si vous pr√©voyez de distribuer beaucoup de contenu - il est pr√©f√©rable de calculer √† l'avance combien cela vous co√ªtera.  Selon des observations personnelles - le trafic le moins cher des h√©bergeurs europ√©ens, le plus cher (je dirais ¬´or¬ª) d'Amazon et de Google. <br><br>  En pratique, les √©conomies de trafic par an en moyenne chez The Universim sont √©normes - comparez les chiffres ci-dessus.  Bien s√ªr, si l'utilisateur n'a pas de jeu du tout ou s'il est tr√®s obsol√®te, un miracle ne se produira pas et il devra t√©l√©charger beaucoup de donn√©es depuis le serveur - si √† partir de z√©ro, alors un peu plus que le jeu ne prend dans les archives.  Cependant, avec les mises √† jour mensuelles, les choses vont vraiment bien.  En moins de 6 mois, le miroir am√©ricain a donn√© un peu plus de 10 To de trafic, sans l'utilisation d'un patcher, cette valeur aurait consid√©rablement augment√©. <br><br>  Voici √† quoi ressemble le trafic annuel du projet: <br><br><img src="https://habrastorage.org/webt/1f/h_/e4/1fh_e4-xudejikja5ekk_9iixti.png" alt="image"><br><br>  Quelques mots sur le "rake" le plus m√©morable que nous avons d√ª franchir dans le processus de travail sur un patcher personnalis√© pour le jeu "The Universim": <br><br>  ‚óè Le plus gros probl√®me m'attendait des antivirus.  Eh bien, ils n'aiment pas les applications qui t√©l√©chargent quelque chose sur Internet, modifient les fichiers (y compris les fichiers ex√©cutables), puis essaient √©galement d'ex√©cuter les fichiers t√©l√©charg√©s.  Certains antivirus ne bloquaient pas seulement l'acc√®s aux fichiers locaux - ils bloquaient √©galement les appels au serveur de mise √† jour eux-m√™mes, p√©n√©trant directement dans les donn√©es t√©l√©charg√©es par le client.  La solution √©tait d'utiliser une signature num√©rique valide pour le patcher - cela r√©duit consid√©rablement la parano√Øa des antivirus et l'utilisation du protocole HTTPS au lieu de HTTP - √©limine rapidement certaines des erreurs associ√©es √† la curiosit√© des antivirus. <br><br>  ‚óè Mise √† jour des progr√®s.  De nombreux utilisateurs (et clients) souhaitent voir la progression de la mise √† jour.  Il faut improviser, car il n'est pas toujours possible de montrer de mani√®re fiable les progr√®s sans avoir √† faire un travail suppl√©mentaire.  Oui, et l'heure exacte de la fin du processus de correction ne peut pas non plus √™tre affich√©e, car le correctif lui-m√™me ne dispose pas de donn√©es sur les fichiers qui doivent √™tre mis √† jour √† l'avance. <br><br>  ‚óè Un grand nombre d'utilisateurs des √âtats-Unis ont des vitesses de connexion √† des serveurs europ√©ens pas tr√®s √©lev√©es.  La migration du serveur de mise √† jour vers les √âtats-Unis a r√©solu ce probl√®me.  Pour les utilisateurs d'autres continents, nous avons quitt√© le serveur en Allemagne.  Soit dit en passant, le trafic aux √âtats-Unis est beaucoup plus cher qu'europ√©en, dans certains cas - plusieurs dizaines de fois. <br><br>  ‚óè Apple n'est pas tr√®s √† l'aise avec cette m√©thode d'installation des applications.  Politique officielle - les applications doivent √™tre install√©es uniquement √† partir de leur magasin.  Mais le probl√®me est que les applications aux √©tapes de test alpha et b√™ta ne sont pas autoris√©es dans le magasin.  Et plus encore, il n'y a rien √† dire sur la vente d'applications brutes d'acc√®s anticip√©.  Par cons√©quent, vous devez √©crire des instructions sur la fa√ßon de danser sur les coquelicots.  L'option avec AppAnnie (alors ils √©taient encore ind√©pendants) n'a pas √©t√© envisag√©e en raison de la limite du nombre de testeurs. <br><br>  ‚óè La mise en r√©seau est assez impr√©visible.  Pour que l'application ne renonce pas imm√©diatement, j'ai d√ª entrer un compteur d'erreurs.  9 exceptions d√©tect√©es vous permettent de dire fermement √† l'utilisateur qu'il a des probl√®mes avec le r√©seau. <br><br>  ‚óè Les syst√®mes d'exploitation 32 bits ont des restrictions sur la taille des fichiers affich√©s en m√©moire (Memory Mapped Files - MMF) pour chaque thread d'ex√©cution et pour le processus dans son ensemble.  Les premi√®res versions du patcher utilisaient MMF pour acc√©l√©rer le travail, mais comme les fichiers de ressources de jeu peuvent √™tre √©normes, j'ai d√ª abandonner cette approche et utiliser des flux de fichiers ordinaires.  Soit dit en passant, une perte de performances sp√©ciale n'a pas √©t√© observ√©e, probablement en raison de la lecture proactive du syst√®me d'exploitation. <br><br>  ‚óè Vous devez √™tre pr√™t √† ce que les utilisateurs se plaignent.  Peu importe la qualit√© de votre produit, il y en aura toujours qui ne seront pas satisfaits.  Et plus il y a d'utilisateurs de votre produit (dans le cas de l'Universim, il y en a plus de 50 000 en ce moment) - plus vous aurez de plaintes quantitativement.  En pourcentage, c'est un tr√®s petit nombre, mais en termes quantitatifs ... <br><br>  Bien que le projet dans son ensemble ait √©t√© un succ√®s, il pr√©sente certains inconv√©nients: <br><br>  ‚óè M√™me si j'ai initialement retir√© toute la logique principale s√©par√©ment, la partie GUI est diff√©rente dans l'impl√©mentation pour MAC et Windows.  La version Linux n'a pas caus√© de probl√®mes - tous les probl√®mes √©taient principalement li√©s √† l'utilisation d'une construction monolithique qui ne n√©cessitait pas l'environnement d'ex√©cution mono - MRE.  Mais comme vous avez besoin d'une licence suppl√©mentaire pour distribuer de tels fichiers ex√©cutables, il a √©t√© d√©cid√© d'abandonner les versions monolithiques et de simplement exiger MRE.  La version Linux ne diff√®re de la version Windows que par la prise en charge des attributs de fichier sp√©cifiques aux syst√®mes * nix.  Pour mon deuxi√®me projet, qui sera plus qu'un simple patcher, je pr√©vois d'utiliser une approche modulaire sous la forme d'un processus noyau qui s'ex√©cute en arri√®re-plan et permet de tout g√©rer sur l'interface locale.  Et le contr√¥le lui-m√™me peut √™tre effectu√© √† partir d'une application bas√©e sur Electron et similaires (ou simplement √† partir d'un navigateur).  Avec n'importe quelle petite chose.  Avant de parler de la taille de la distribution de ces applications - regardez la taille des jeux.  Les versions de d√©monstration (!!!) de certains occupent 5 gigaoctets ou plus dans l'archive (!!!). <br><br>  ‚óè Les structures utilis√©es actuellement ne permettent pas d'√©conomiser de l'espace lorsque le jeu est publi√© pour 3 plates-formes - de facto, vous devez conserver 3 copies de donn√©es presque identiques, bien que compress√©es. <br><br>  ‚óè La version actuelle du patcher ne met pas en cache son travail - chaque fois que toutes les sommes de contr√¥le de tous les fichiers sont recalcul√©es.  Il serait possible de r√©duire consid√©rablement le temps si le patcher mettait en cache les r√©sultats des fichiers d√©j√† pr√©sents sur le client.  Mais il y a un dilemme - si le fichier est endommag√© (ou manquant), mais l'entr√©e de cache pour ce fichier est enregistr√©e, le patcher l'ignorera, ce qui entra√Ænera des probl√®mes. <br><br>  ‚óè La version actuelle ne peut pas fonctionner simultan√©ment avec plusieurs serveurs (sauf si vous effectuez un Round-robin en utilisant DNS) - je voudrais passer √† une technologie de type torrent afin que vous puissiez utiliser plusieurs serveurs en m√™me temps.  Il n'est pas question d'utiliser les clients comme source de donn√©es, car cela pose de nombreux probl√®mes juridiques et il est plus facile de refuser d√®s le d√©part. <br><br>  ‚óè Si vous souhaitez restreindre l'acc√®s aux mises √† jour, cette logique devra √™tre impl√©ment√©e ind√©pendamment.  En fait, cela peut difficilement √™tre qualifi√© d'inconv√©nient, car chacun peut avoir ses propres souhaits concernant les restrictions.  La restriction de cl√© la plus simple - sans aucune partie serveur - est rendue assez simple, comme je l'ai montr√© ci-dessus. <br><br>  ‚óè Un correctif est cr√©√© pour un seul projet √† la fois.  Si vous souhaitez cr√©er quelque chose de similaire √† Steam, un syst√®me complet de distribution de contenu est d√©j√† requis.  Et c'est un projet d'un niveau compl√®tement diff√©rent. <br><br>  Je pr√©vois de mettre moi-m√™me le patcher dans le domaine public apr√®s la mise en ≈ìuvre de la ¬´deuxi√®me g√©n√©ration¬ª - un syst√®me de livraison de contenu de jeu qui comprendra non seulement le patcher √©volu√©, mais aussi un module de t√©l√©m√©trie (car les d√©veloppeurs doivent savoir ce que font les joueurs), Module Cloud Save et quelques autres modules. <br><br>  Si vous avez un projet √† but non lucratif et avez besoin d'un patcher, √©crivez-moi les d√©tails de votre projet et je vous en donnerai une copie gratuitement.  Il n'y aura pas de liens ici, car ce n'est pas le hub ¬´I PR¬ª. <br><br>  Je me ferai un plaisir de r√©pondre √† vos questions. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440870/">https://habr.com/ru/post/fr440870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440856/index.html">Comment l'espace et le temps peuvent √™tre un code de correction d'erreur quantique</a></li>
<li><a href="../fr440858/index.html">Il existe de nombreux programmes pour apprendre l'anglais, mais cela vaut-il la peine de les utiliser si vous √™tes programmeur?</a></li>
<li><a href="../fr440862/index.html">Mod√®les CI / CD et anti-mod√®les. Partie 1</a></li>
<li><a href="../fr440864/index.html">L'histoire tragique des rencontres poppler</a></li>
<li><a href="../fr440866/index.html">Les t√©l√©phones publics en Russie veulent compl√©ter le minist√®re des situations d'urgence</a></li>
<li><a href="../fr440872/index.html">PostGIS et JPA</a></li>
<li><a href="../fr440874/index.html">Impl√©mentation du mouvement des particules libres sur ReactJS</a></li>
<li><a href="../fr440878/index.html">Web Analytics pour les entreprises</a></li>
<li><a href="../fr440880/index.html">Top 10 des capteurs IoT en 2019</a></li>
<li><a href="../fr440882/index.html">√âchapper √† Crypto Pro. √âdition GOST 34.10-2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>