<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🚒 🎳 💈 Développement du package pypi parfait avec prise en charge de différentes versions de python 📪 ⚰️ 👩‍❤️‍💋‍👩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ceci est un petit manuel / histoire sur la façon de créer un package pypi «parfait» pour python, que n'importe qui peut installer avec la commande ché...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Développement du package pypi parfait avec prise en charge de différentes versions de python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483512/"><p>  Ceci est un petit manuel / histoire sur la façon de créer un package pypi «parfait» pour python, que n'importe qui peut installer avec la commande chérie: </p><br><pre><code class="plaintext hljs">pip install my-perfect-package</code> </pre> <br><p>  Il s'adresse aux débutants, mais j'exhorte les professionnels à exprimer leur avis sur la façon d'améliorer le package "parfait".  Par conséquent, je demande un chat. </p><a name="habracut"></a><br><h2 id="chto-znachit-idealnyy-paket">  Que signifie un forfait «idéal»? </h2><br><p>  Je vais partir des exigences suivantes: </p><br><ul><li>  <strong>Open source sur github;</strong> <br>  Tout le monde devrait pouvoir contribuer au développement et remercier l'auteur. </li><li>  <strong>Prise en charge de toutes les versions actuelles / populaires de python (2.7, 3.5, 3.6, 3.7, 3.8);</strong> <br>  Les pythons sont différents, et quelque part écrivent toujours activement sur 2.7. </li><li>  <strong>Couverture à 100% avec tests unitaires;</strong> <br><del>  Les tests unitaires améliorent l'architecture et automatisent les contrôles de régression. </del><br>  Un badge avec un numéro cher soulève la FAQ et <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow">place la barre pour les autres</a> . </li><li>  <strong>Utilisation de CI:</strong> <br>  Les contrôles automatiques sont très pratiques! <del>  Et un tas de badges sympas </del><br><ul><li>  <strong>Exécution de tests unitaires sur toutes les plateformes et sur toutes les versions de python;</strong> <br>  Ne croyez pas ceux qui prétendent que python et les packages installés sont <a href="https://docs.python.org/2/library/os.html" rel="nofollow">multiplates-formes</a> , car vous pouvez toujours rencontrer un <a href="https://bugs.python.org/issue22587" rel="nofollow">bogue</a> . </li><li>  <strong>Vérification du code de style;</strong> <br>  Un style uniforme améliore la lisibilité et réduit le nombre de discussions vides dans une révision. </li><li>  <strong>Analyseur de code statique;</strong> <br>  Recherche automatique de bugs dans le code?  Donnez-moi deux! </li></ul></li><li>  <strong>Documentation réelle;</strong> <br>  Exemples de travail avec le package, description des méthodes / classes et analyse des erreurs typiques - une expérience documentée réduira le seuil d'entrée pour les débutants. </li><li>  <strong>Développement multiplateforme;</strong> <br>  Malheureusement, il est difficile d'apporter une contribution personnelle aux projets simplement parce que le développeur a affiné les outils pour Unix.  Par exemple, j'ai utilisé des scripts bash pour l'assemblage. </li><li>  <strong>Le package est utile et rend le monde meilleur.</strong> <br>  Une exigence difficile, car à en juger par le nombre de packages dans <a href="https://pypi.org/" rel="nofollow">pypi</a> <em>(~ 210k), les</em> développeurs sont des altruistes sauvages et beaucoup a déjà été écrit. </li></ul><br><h2 id="s-chego-nachat">  Par où commencer? </h2><br><p>  Il n'y avait pas de bonnes idées, j'ai donc choisi un sujet galvaudé et très populaire - travailler avec les systèmes numériques.  La première version devrait pouvoir traduire les nombres en romain et vice versa.  Pour le manuel c'est plus compliqué et pas nécessaire.  Oh oui, le plus important est le nom: <del>  numsys - comme décryptage des systèmes numériques. </del>  <em>numeral-system-py</em> . </p><br><h2 id="kak-testirovat">  Comment tester? </h2><br><p>  J'ai pris <em>python3.7</em> et <em>j'ai d'</em> abord écrit des tests avec des <em>stubs</em> de fonction (nous sommes tous des <a href="https://habr.com/ru/post/121162/">TDD</a> ) en utilisant le module standard <a href="https://habr.com/ru/post/121162/">unittests</a> . </p><br><p>  Je fais la structure de projet suivante: </p><br><pre> <code class="plaintext hljs">src/ numeral-system/ __init__.py roman.py tests __init__.py test_roman.py</code> </pre> <br><p>  Je ne mettrai pas de tests dans le package, donc je sépare <del>  paillette </del>  .  Au départ, <code>src/</code> n'ai pas créé le dossier <code>src/</code> , mais les développements ultérieurs ont montré qu'il était plus pratique pour moi d'opérer.  Ce n'est donc pas nécessaire à volonté. </p><br><p>  J'ai décidé d'utiliser <a href="https://habr.com/ru/post/269759/">pytest</a> pour le lancement - il sait parfaitement fonctionner avec les tests du module standard.  Cela peut sembler un peu illogique, mais le module standard pour les tests pour moi <del>  il semble </del>  semblait un peu plus confortable.  <em>Maintenant, je recommanderais d'utiliser le style d'écriture pytest.</em> </p><br><p>  Mais, ils disent que mettre <code>pytest</code> (comme toutes les autres dépendances) dans python système n'est pas une idée très intelligente ... </p><br><h2 id="kak-upravlyat-zavisimostyami">  Comment gérer les dépendances? </h2><br><p>  Seuls <a href="https://virtualenv.pypa.io/en/latest/" rel="nofollow">virtualenv</a> et <code>requirements.txt</code> peuvent être utilisés.  Vous pouvez être progressiste et utiliser la <a href="https://poetry.eustace.io/" rel="nofollow">poésie</a> .  J'utiliserai peut-être <a href="https://tox.readthedocs.io/en/latest/" rel="nofollow">tox</a> - un outil pour simplifier l'automatisation et les tests, ce qui me permettra également de gérer les dépendances. </p><br><p>  Je crée une simple configuration tox.ini et installe <code>pytest</code> : </p><br><pre> <code class="plaintext hljs">[tox] envlist = py37 ;     ,   python3.7 [testenv] ;     deps =  `deps`  ,   . -r requirements.txt ;     -r requirements-test.txt ; commands = pytest ;  </code> </pre> <br><p>  Initialement, j'ai indiqué explicitement les dépendances, mais la pratique de l'intégration avec des services tiers a montré que le meilleur moyen serait encore de stocker les dépendances dans le fichier <code>requirements.txt</code> . </p><br><p>  Un moment très subtil survient.  Réparer la version actuelle au moment du développement ou toujours mettre la dernière? </p><br><p>  Si vous vous engagez, lors de l'installation, il peut y avoir des conflits entre les packages en raison des différentes versions des dépendances utilisées.  Si vous ne vous engagez pas, le package peut soudainement cesser de fonctionner.  Cette dernière situation est très désagréable pour les produits finaux, lorsque toutes les versions peuvent «virer au rouge» en une nuit en raison d'une mise à jour mineure de la dépendance implicite.  Et selon <a href="https://en.wikipedia.org/wiki/Murphy%2527s_law" rel="nofollow">la loi de Murphy,</a> cela se produira le jour de la sortie. </p><br><p>  Par conséquent, j'ai développé une règle pour moi-même: </p><br><ol><li>  Fixez toujours la version des produits finaux, car les versions à utiliser sont de leur responsabilité. </li><li>  Ne corrigez pas la version utilisée pour les packages installés.  Ou limitez-le à une plage si la fonctionnalité du package l'exige. </li></ol><br><h2 id="chto-dalshe">  Et ensuite? </h2><br><p>  J'écris des tests! </p><br><p>  Je remplis le corps des fonctions, ajoute des commentaires et fais les tests correctement. <br>  À ce stade, la plupart des développeurs s'arrêtent généralement (je crois toujours que tout le monde écrit des tests =), publient le package et piratent les bogues.  Mais je continue <del>  et saute dans le terrier du lapin </del>  . </p><br><h2 id="kak-rabotat-s-razlichnymi-versiyami-python">  Comment travailler avec différentes versions de python? </h2><br><p>  Dans la configuration <code>tox</code> , <code>tox</code> précise le lancement de tests sur toutes les versions intéressantes de python: </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38}</code> </pre> <br><p>  En utilisant <a href="https://khashtamov.com/ru/pyenv-python/" rel="nofollow">pyenv, je me</a> livre localement les versions nécessaires pour que <code>tox</code> puisse les trouver et créer des environnements de test. </p><br><h2 id="gde-zavetnye-100">  Où sont les chéris à 100%? </h2><br><p>  J'ajouterai une mesure de la couverture du code - pour cela, il existe un excellent package de <a href="https://coverage.readthedocs.io/en/v4.5.x/" rel="nofollow">couverture</a> et non moins une excellente intégration avec pytest - <a href="https://github.com/pytest-dev/pytest-cov" rel="nofollow">pytest-cov</a> . <br>  <code>requirements-test.txt</code> ressemble maintenant à ceci: </p><br><pre> <code class="plaintext hljs">six=1.13.0 pytest=4.6.7 pytest-cov=2.8.1 parameterized=0.7.1</code> </pre> <br><p>  Selon la règle ci-dessus, je corrige les versions des packages utilisés pour exécuter les tests. </p><br><p>  Je change la commande de test: </p><br><pre> <code class="plaintext hljs">deps = -r requirements.txt -r requirements-test.txt commands = pytest \ --cov=src/ \ --cov-config="{toxinidir}/tox.ini" \ --cov-append</code> </pre> <br><p>  Je collecte des statistiques de couverture pour tout le code du dossier <code>src/</code> - le package lui-même ( <em>numeral_system /</em> ) et requis pour le code de test ( <em>tests /</em> ) - Je ne veux pas que les tests eux-mêmes contiennent des parties non exécutables? </p><br><p>  <code>--cov-append</code> commande <code>--cov-append</code> toutes les statistiques collectées pour chaque appel sous une version différente de python en une seule, car la couverture pour les deuxième et troisième python peut être différente (code dépendant de la version et module <a href="https://pypi.org/project/six/" rel="nofollow">six</a> !), Mais au total, donnez 100 %  Un exemple simple: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.version_info &gt; (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-comment"><span class="hljs-comment"># Python 3 code in this block else: # Python 2 code in this block</span></span></code> </pre> <br><p>  Ajoutez un nouvel environnement pour créer un rapport de couverture. </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage commands = coverage html ;   ,   coverage report --include="src/*" --fail-under=100 -m ;    100% </code> </pre> <br><p>  Et j'ajoute à la liste des environnements après avoir exécuté les tests sur toutes les versions de python. </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38} coverage_report</code> </pre> <br><p>  Après avoir exécuté la commande <code>tox</code> , le dossier <code>tox</code> contenant le fichier <code>index.html</code> avec un beau rapport doit apparaître à la racine du projet. </p><br><p>  Pour le badge convoité, <a href="https://codecov.io/" rel="nofollow">j'intègre à</a> 100% le service <a href="https://codecov.io/" rel="nofollow">codecov</a> , lui-même déjà intégré à <code>github</code> et vous permet de visualiser l'historique des changements de couverture de code.  Pour cela, vous devrez bien sûr y créer un compte. </p><br><p>  L'environnement de lancement final est le suivant: </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage==5.0.2 codecov==2.0.15 commands = coverage html coverage report --include="src/*" --fail-under=100 -m coverage xml codecov -f coverage.xml --token=2455dcfa-f9fc-4b3a-b94d-9765afe87f0f ;     codecov,   </code> </pre> <br><p>  Il ne reste plus qu'à ajouter un lien vers le badge dans <code>README.rst</code> : </p><br><pre> <code class="plaintext hljs">|Code Coverage| .. |Code Coverage| image:: https://codecov.io/gh/zifter/numeral-system-py/branch/master/graph/badge.svg :target: https://codecov.io/gh/zifter/numeral-system-py</code> </pre> <br><h2 id="kak-formatirovat-i-analizirovat-kod">  Comment formater et analyser le code? </h2><br><p>  De nombreux analyseurs n'existent pas, car ils se complètent pour la plupart.  Par conséquent, <a href="https://www.python.org/dev/peps/pep-0008/" rel="nofollow">j'intégrerai</a> des analyseurs statiques populaires qui vérifieront la conformité au <a href="https://www.python.org/dev/peps/pep-0008/" rel="nofollow">PEP8</a> , trouveront les problèmes potentiels et <del>  corriger tous les bugs </del>  formater uniformément le code. </p><br><p>  Vous devez immédiatement déterminer où spécifier les paramètres de réglage fin des analyseurs.  Pour ce faire, vous pouvez utiliser le fichier <code>tox.ini</code> , <code>setup.cfg</code> , un seul fichier personnalisé ou des fichiers spécifiques pour les analyseurs.  J'ai décidé d'utiliser <code>tox.ini</code> directement, car vous pouvez simplement copier <code>tox.ini</code> pour de futurs projets. </p><br><h2 id="isort">  isort </h2><br><p>  <a href="https://github.com/timothycrosley/isort" rel="nofollow">isort</a> est un utilitaire pour formater les importations. </p><br><p>  Je crée l'environnement suivant pour exécuter <code>isort</code> en mode format de code. </p><br><pre> <code class="plaintext hljs">[testenv:isort] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort -y -sp={toxinidir}/tox.ini</code> </pre> <br><p>  Malheureusement, <code>isort</code> ne peut pas spécifier de dossier pour le formatage.  Par conséquent, vous devez modifier le répertoire de démarrage via <code>changedir</code> et spécifier le chemin d'accès au fichier avec les paramètres <code>-sp={toxinidir}/tox.ini</code> .  Le commutateur <code>-y</code> est nécessaire pour désactiver le mode interactif. </p><br><p>  Pour exécuter les tests, vous avez besoin d'un mode de vérification - pour cela, il y a un indicateur <code>--check-only</code> : </p><br><pre> <code class="plaintext hljs">[testenv:isort-check] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort --check-only -sp={toxinidir}/tox.ini</code> </pre> <br><h2 id="black">  noir </h2><br><p>  Ensuite, je m'intègre avec le formateur de code <a href="https://black.readthedocs.io/en/stable/" rel="nofollow">noir</a> .  Je le fais par analogie avec <code>isort</code> : </p><br><pre> <code class="plaintext hljs">[testenv:black] deps = black==19.10b0 commands = black src/ [testenv:black-check] deps = black==19.10b0 commands = black --check src/</code> </pre> <br><p>  Tout fonctionne bien, mais il y a un conflit avec <code>isort</code> - il y a une différence dans le <a href="https://github.com/psf/black/issues/127" rel="nofollow">formatage des importations</a> . </p><br><p>  Dans l' <a href="https://github.com/timothycrosley/isort/issues/694" rel="nofollow">un des commentaires, j'ai</a> trouvé un paramètre d' <code>isort</code> compatibilité minimale, que j'ai utilisé: </p><br><pre> <code class="plaintext hljs">[isort] multi_line_output=3 include_trailing_comma=True force_grid_wrap=0 use_parentheses=True line_length=88</code> </pre> <br><h2 id="flake8">  flake8 </h2><br><p>  Ensuite, je <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">m'intègre</a> aux analyseurs statiques <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">flake8</a> . </p><br><pre> <code class="plaintext hljs">[testenv:flake8-check] deps = flake8==3.7.9 commands = flake8 --config=tox.ini src/</code> </pre> <br><p>  Il y a encore des <a href="https://github.com/psf/black/issues/113" rel="nofollow">problèmes avec l'intégration</a> avec le <code>black</code> .  Nous devons ajouter un réglage fin, qui, en fait, est <a href="https://github.com/psf/black" rel="nofollow">recommandé</a> par le <code>black</code> lui-même: </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203</code> </pre> <br><p>  Malheureusement, la première fois, cela n'a pas fonctionné.  Est tombé avec l'erreur <code>E231 missing whitespace after ','</code> , j'ai dû ajouter cette erreur pour ignorer: </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203,E231</code> </pre> <br><h2 id="pylint">  pylint </h2><br><p>  Intégration avec les <a href="https://www.pylint.org/" rel="nofollow">analyseurs de</a> code statique <a href="https://www.pylint.org/" rel="nofollow">pylint</a> </p><br><pre> <code class="plaintext hljs">[testenv:pylint-check] deps = {[testenv]deps} # pylint  ,     pylint==2.4.4 commands = pylint --rcfile=tox.ini src/</code> </pre> <br><p>  Je rencontre immédiatement d'étranges restrictions - des noms de fonction de 30 caractères (oui, j'écris des noms très longs de méthodes de test) et des avertissements pour la présence de <code>TODO</code> dans le code. <br>  Je dois ajouter quelques exceptions: </p><br><pre> <code class="plaintext hljs">[MESSAGES CONTROL] disable=fixme,invalid-name</code> </pre> <br><p>  De plus, le moment désagréable est que les développeurs de <code>pylint</code> déjà enterré <code>python2.7</code> et ne développent plus de package pour cela.  Par conséquent, les vérifications doivent être exécutées sur le package actuel pour <code>python3.7</code> . <br>  Ajoutez la ligne appropriée à la configuration: </p><br><pre> <code class="plaintext hljs">[tox] envlist = isort-check black-check flake8-check pylint-check py{27,35,36,37,38} coverage_report basepython = python3.7</code> </pre> <br><p>  Il est également important pour exécuter des tests sur différentes plates-formes, car la version par défaut de python dans les systèmes CI est différente. </p><br><h2 id="chto-tam-s-ci">  Quoi de neuf avec CI? </h2><br><h3 id="appveyor">  Appveyor </h3><br><p>  Intégration avec <a href="https://www.appveyor.com/" rel="nofollow">appveyor</a> - CI pour Windows.  La configuration initiale est simple - tout peut être fait dans l'interface, puis téléchargez le fichier yaml et validez-le dans le référentiel. </p><br><pre> <code class="plaintext hljs">version: 0.0.{build} install: - cmd: &gt;- C:\\Python37\\python -m pip install --upgrade pip C:\\Python37\\pip install tox build: off test_script: - cmd: C:\\Python37\\tox</code> </pre> <br><p>  Ici, je spécifie explicitement la version de <code>python3.7</code> , car <code>python2.7</code> sera utilisé par défaut (et <code>tox</code> utilisera également cette version, bien que j'aie explicitement spécifié <code>python3.7</code> ). <br>  Le lien vers le badge, comme d'habitude, est ajouté à <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build status Appveyor| .. |Build status Appveyor| image:: https://ci.appveyor.com/api/projects/status/github/zifter/numeral-system-py?branch=master&amp;svg=true :target: https://ci.appveyor.com/project/zifter/numeral-system-py</code> </pre> <br><h3 id="travis-ci">  Travis ci </h3><br><p>  Après cela, je m'intègre à <a href="https://travis-ci.org/" rel="nofollow">Travis CI</a> - CI sous Linux (et sous MacOS avec Windows, mais les <a href="https://docs.travis-ci.com/user/languages/python/" rel="nofollow"><code>Python builds are not available on the macOS and Windows environments</code></a> . La configuration est un peu plus compliquée, car le fichier de configuration sera utilisé directement à partir du référentiel. Quelques itérations d'essai et d'erreur - la configuration est prête, je squash dans un beau commit et la demande de fusion est prête. </p><br><pre> <code class="plaintext hljs">language: python python: 3.8 # dist: xenial # required for Python 3.7 (travis-ci/travis-ci#9069) sudo: required # required for Python 3.7 (travis-ci/travis-ci#9069) addons: apt: sources: - deadsnakes packages: - python3.5 - python3.6 - python3.7 - pypy install: - pip install tox script: - tox</code> </pre> <br><p>  ( <em>Question rhétorique: et pourquoi les projets CI aiment-ils tant le format yaml?</em> ) </p><br><p>  <code>python3.8</code> la version de <code>python3.8</code> , car elle n'a pas fonctionné correctement via l' <code>addon</code> , et <code>Travis CI</code> réussi à créer <code>virtualenv</code> partir de la version spécifiée. </p><br><p>  Les personnes familières avec <code>Travis CI</code> peuvent se demander pourquoi ne pas spécifier explicitement les versions de python de cette façon?  Après tout, <code>Travis CI</code> crée automatiquement <code>virtualenv</code> et y exécute les commandes nécessaires. </p><br><p>  La raison en est que nous devons collecter des données de couverture de code de toutes les versions.  Mais les tests seront exécutés dans différents travaux en parallèle, c'est pourquoi il ne fonctionnera pas pour collecter un rapport de couverture générale. </p><br><p>  Bien sûr, je suis sûr qu'un peu plus de compréhension et cela peut être corrigé. </p><br><p>  Par tradition, un lien vers un badge est également ajouté à <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build Status Travis CI| .. |Build Status Travis CI| image:: https://travis-ci.org/zifter/numeral-system-py.svg?branch=master :target: https://travis-ci.org/zifter/numeral-system-py</code> </pre> <br><h2 id="dokumentaciya">  La documentation </h2><br><p>  Je pense que chaque développeur de python a utilisé le service au moins une fois - <a href="https://readthedocs.org/" rel="nofollow">readthedocs.org</a> .  Il me semble que c'est le meilleur service pour héberger sa documentation. <br>  J'utiliserai l'outil standard pour générer la documentation <a href="http://www.sphinx-doc.org/en/master/" rel="nofollow">Sphinx</a> .  Je suis les étapes du <a href="https://docs.readthedocs.io/en/stable/intro/getting-started-with-sphinx.html" rel="nofollow">manuel de démarrage</a> et j'obtiens la structure suivante: </p><br><pre> <code class="plaintext hljs">src/ docs/ build/ #      html  source/ #     _static/ #   , ,  _templates/ #     conf.py #    index.rst #    make.bat Makefile # make     make</code> </pre> <br><p>  Ensuite, vous devez effectuer les étapes minimales pour configurer: </p><br><ol><li>  <code>github</code> par défaut suggère de créer un fichier <code>README.md</code> au format <a href="https://en.wikipedia.org/wiki/Markdown" rel="nofollow">Markdown</a> , alors que comme <code>sphinx</code> par défaut, il suggère d'utiliser <a href="https://en.wikipedia.org/wiki/ReStructuredText" rel="nofollow">ReStructuredText</a> . </li></ol><br><p>  Par conséquent, j'ai dû le réécrire au format <code>.rst</code> . <del>  Et si j'avais lu le manuel de démarrage jusqu'à la fin au moins une fois, je me suis rendu compte que <code>sphinx</code> peut le faire dans Markdown </del>  . <br>  <code>README.rst</code> fichier <code>index.rst</code> dans <code>index.rst</code> </p><br><pre> <code class="plaintext hljs">.. include:: ../../README.rst</code> </pre> <br><ol><li>  Pour générer automatiquement la documentation à partir des commentaires dans la source, j'ajoute l'extension <a href="http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html" rel="nofollow">sphinx.ext.autodoc</a> . </li><li>  <code>conf.py</code> dossier <code>conf.py</code> package à <code>conf.py</code>  Cela permettra à <code>sphinx</code> d'importer notre code pour analyse. <br><pre> <code class="plaintext hljs">import os import sys sys.path.insert(0, os.path.abspath('./../../src')) import numeral_system</code> </pre> </li><li>  J'ajoute le dossier <code>docs/source/api-docs</code> et y dépose le fichier de description de chaque module.  La documentation doit être générée automatiquement à partir des commentaires: <br><pre> <code class="plaintext hljs">Roman numeral system ========================= .. automodule:: numeral_system.roman :members:</code> </pre> </li></ol><br><p>  Après cela, le projet est prêt à révéler sa description au monde.  Vous devez créer un compte (de préférence via un compte sur <code>github</code> ) et importer votre projet, les étapes détaillées sont décrites dans les <a href="" rel="nofollow">instructions</a> . <br>  Par tradition, je crée un environnement en <code>tox</code> : </p><br><pre> <code class="plaintext hljs">[testenv:gen_docs] deps = -r docs/requirements.txt commands = sphinx-build -b html docs/source/ docs/build/</code> </pre> <br><p>  J'utilise explicitement la <code>sphinx-build</code> , au lieu de <code>make</code> , car elle n'existe pas sous Windows.  Et je ne veux pas violer le principe du développement multiplateforme. </p><br><p>  Dès que les modifications sont gelées, <code>readthedocs.org</code> collectera automatiquement la documentation et la publiera. </p><br><p>  Mais ... La <a href="https://github.com/readthedocs/readthedocs.org/issues/2569" rel="nofollow"><code>Build failed</code></a> .  Je n'ai pas <code>sphinx_rtd_theme</code> <code>sphinx</code> et <code>sphinx_rtd_theme</code> , et je m'attendais <code>readthedocs.org</code> ce que <code>readthedocs.org</code> prenne les versions actuelles.  Mais ce n'est pas le cas.  Je corrige: </p><br><pre> <code class="plaintext hljs">sphinx==2.3.1 sphinx_rtd_theme==0.4.3</code> </pre> <br><p>  Et je crée un fichier de configuration spécial <code>.readthedocs.yml</code> pour <code>readthedocs.org</code> , dans lequel je décris l'environnement pour lancer la construction: </p><br><pre> <code class="plaintext hljs">python: version: 3.7 install: - requirements: docs/requirements.txt - requirements: requirements.txt</code> </pre> <br><p>  C'est là que le fait est devenu pratique que les dépendances se trouvent dans les fichiers <code>requirements.txt</code> .  J'attends la construction et la <a href="https://numeral-system-py.readthedocs.io/en/latest/" rel="nofollow">documentation devient disponible</a> . </p><br><p>  Ajoutez à nouveau le badge: </p><br><pre> <code class="plaintext hljs">|Docs| .. |Docs| image:: https://readthedocs.org/projects/numeral-system-py/badge/?version=latest&amp;style=flat :target: https://numeral-system-py.readthedocs.io/en/latest/</code> </pre> <br><h2 id="licenzirovanie">  Licence </h2><br><p>  Il vaut la peine d'envisager de choisir une licence pour le package. <br>  Il s'agit d'un sujet très complet, j'ai donc lu <a href="https://habr.com/ru/post/243091/">cet article</a> .  Fondamentalement, le choix se fait entre <a href="http://directory.fsf.org/wiki/License:Expat" rel="nofollow">MIT</a> et <a href="" rel="nofollow">Apache 2.0</a> .  J'ai aimé la phrase qui a été sortie de son contexte avec succès: </p><br><pre> <code class="plaintext hljs">MIT      </code> </pre> <br><p>  Je suis tout à fait d'accord, je le ferai. Si les plans changent, vous pouvez facilement changer la licence (bien que les versions précédentes seront sous l'ancienne). </p><br><p>  Encore une fois, ajoutez un badge <del>  insigne dieu </del>  : </p><br><pre> <code class="plaintext hljs">|License| .. |License| image:: https://img.shields.io/badge/License-MIT-yellow.svg :target: https://opensource.org/licenses/MIT</code> </pre> <br><p>  Vous trouverez ici des badges pour toutes les licences. </p><br><h2 id="kak-zalit-na-pypi">  Comment télécharger sur pypi? </h2><br><p>  Vous devez d'abord créer un compte sur <a href="https://pypi.org/" rel="nofollow">pypi.org</a> .  Procédez ensuite à la préparation du colis. </p><br><h3 id="sozdayu-setupcfg">  Je crée setup.cfg </h3><br><p>  Il est nécessaire de décrire correctement la configuration pour l'installation / la construction du package.  J'ai suivi les <a href="https://docs.python.org/3/distutils/introduction.html" rel="nofollow">instructions</a> .  Il est possible de définir des données via <code>setup.py</code> , mais il n'y a pas d'options pour définir certains paramètres.  Par conséquent, utilisez le fichier <code>setup.cfg</code> , dans lequel vous pouvez spécifier toutes les nuances.  Trouvé un <a href="https://gist.github.com/althonos/6914b896789d3f2078d1e6237642c35c" rel="nofollow">petit modèle</a> sur la façon de remplir ce fichier.  En conséquence, j'utilise à la fois cela et ce fichier - c'est plus pratique. </p><br><p>  Ce fichier peut également être utilisé pour configurer <code>pylint</code> , <code>flake8</code> et d'autres paramètres, mais je ne l'ai pas fait. </p><br><h3 id="kak-sobrat-paket">  Comment assembler un colis? </h3><br><p>  Encore une fois, j'écris un environnement qui m'aidera à rassembler le package nécessaire: </p><br><pre> <code class="plaintext hljs">[testenv:build_wheel] skip_install = True deps = ;     wheel docutils pygments commands = python -c 'import shutil; (shutil.rmtree(p, ignore_errors=True) for p in ["build", "dist"]);' python setup.py sdist bdist_wheel</code> </pre> <br><p>  Pourquoi est-ce que je supprime des dossiers en utilisant python?  Je veux me conformer à l'exigence de développement multiplateforme, il n'y a aucun moyen pratique de le faire sous Windows et Unix. </p><br><p>  Je lance l'environnement de test: </p><br><pre> <code class="plaintext hljs">tox -e build_wheel</code> </pre> <br><p>  En conséquence, dans le dossier <code>dist</code> , j'obtiens: </p><br><pre> <code class="plaintext hljs">dist/ numeral-system_py-0.1.0.tar.gz numeral_system-py-0.1.0-py2.py3-none-any.whl</code> </pre> <br><h3 id="zalivayu">  Je remplis! </h3><br><p>  Pas vraiment. </p><br><p>  Pour commencer, il convient de vérifier que le package fonctionne correctement.  Je vais le télécharger dans le référentiel du package de test.  Par conséquent, vous devez créer un autre compte, mais déjà sur <a href="https://test.pypi.org/" rel="nofollow">test.pypi.org</a> . </p><br><p>  J'utilise le paquet <a href="https://pypi.org/project/twine/" rel="nofollow">twine</a> pour cela - un outil pour remplir les artefacts dans PyPi. </p><br><pre> <code class="plaintext hljs">[testenv:test_upload] skip_install = True deps = twine ;    commands = python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*</code> </pre> <br><p>  Au départ, le projet s'appelait <code>numsys</code> , mais en essayant de le remplir, je suis tombé sur le fait qu'un package du même nom existe déjà!  Et ce qui est le plus ennuyeux - il sait aussi comment convertir en chiffres romains :) Il n'était pas très contrarié et renommé en <code>numeral-system-py</code> . </p><br><p>  Vous devez maintenant installer le package à partir de l'environnement de test.  La validation doit également être automatisée: </p><br><pre> <code class="plaintext hljs">[testenv:test_venv] skip_install = True ;         deps = ;   commands = pip install -i https://test.pypi.org/simple/ numeral-system-py</code> </pre> <br><p>  Il vous suffit maintenant d'exécuter: </p><br><pre> <code class="plaintext hljs">tox -e test_venv ... test_venv: commands_succeeded congratulations :)</code> </pre> <br><p>  Cela semble fonctionner :) </p><br><h3 id="vot-teper-tochno-zalivayu">  Maintenant, versez définitivement! </h3><br><p>  Oui </p><br><p>  Je crée un environnement pour le téléchargement vers le référentiel de production. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_upload] skip_install = True deps = twine commands = python -m twine upload dist/*</code> </pre> <br><p>  Et l'environnement pour la vérification de la production. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_venv] skip_install = True deps = ;    commands = pip install numeral-system-py</code> </pre> <br><h3 id="a-vse-tochno-rabotaet">  Est-ce que tout fonctionne? </h3><br><p>  Je vérifie avec des commandes simples: </p><br><pre> <code class="plaintext hljs">&gt; virtualenv venv &gt; source venv/bin/activate (venv) &gt; pip install numeral-system-py (venv) &gt; python &gt;&gt;&gt; import numeral_system &gt;&gt;&gt; numeral_system.roman.encode(7) 'VII'</code> </pre> <br><p>  Tout est super! </p><br><p>  <a href="https://help.github.com/en/articles/creating-releases" rel="nofollow">Je coupe la version sur github</a> , récupère le paquet et le remplis dans le propi pypi. </p><br><h2 id="zamechaniya">  Remarques </h2><br><h3 id="obnovleniya-zavisimostey">  Mises à jour des dépendances </h3><br><p>  Lors de la préparation de cet article, une nouvelle version de pytest a été publiée, dans laquelle, en fait, le support de python 3.4 a été abandonné (en <a href="https://github.com/tox-dev/tox/issues/1483" rel="nofollow">fait</a> dans le package <a href="https://github.com/tartley/colorama" rel="nofollow">colorama</a> ).  Il y avait deux options: </p><br><ol><li>  Validez la version colorama compatible avec 3.4; </li><li>  Drop support 3.4 :) </li></ol><br><p>  En faveur de la deuxième option, le dernier argument était que <code>pip</code> abandonné le support 3.4 dans la version 19.1. </p><br><p>  Il existe également des dépendances fixes sous la forme d'analyseurs, de formateurs et d'autres services.  Ces dépendances peuvent être mises à jour en même temps.  Si vous êtes chanceux, vous ne pourrez que vous mettre à niveau avec la version de mise à niveau; sinon, vous devrez corriger le code ou même ajouter les paramètres. </p><br><h3 id="travisci">  TravisCI </h3><br><p>  Ne prend pas en charge python pour MacOS et Windows.  Il y a des difficultés à exécuter <code>tox</code> pour toutes les versions de python dans le même travail. </p><br><h3 id="versiya-paketa">  Version du package </h3><br><p>  Il est nécessaire de respecter <a href="https://semver.org/" rel="nofollow">le versioning sémantique</a> , à savoir le format: </p><br><pre> <code class="plaintext hljs">MAJOR.MINOR.PATCH</code> </pre> <br><h3 id="dublirovanie-meta-informacii">  Duplication des méta-informations </h3><br><p>  La version du package et certains autres paramètres doivent être spécifiés pour installer le package (dans <code>setup.cfg</code> ou <code>setup.py</code> ) et dans la documentation.  Pour éviter la duplication, il a fait une indication uniquement dans le paquet <code>numeral_system/__init__.py</code> : </p><br><pre> <code class="plaintext hljs">__version__ = '0.2.0'</code> </pre> <br><p>  Et puis dans <code>setup.py</code> explicitement cette variable </p><br><pre> <code class="plaintext hljs">setup(version=numeral_system.__version__)</code> </pre> <br><p>  Il en va de même pour dans <code>docs/source/conf.py</code> </p><br><pre> <code class="plaintext hljs">release = numeral_system.__version__</code> </pre> <br><p>  Ce qui précède est vrai pour toute méta-information - <code>REAMDE.rst</code> , descriptions de projet, licences, noms d'auteur, etc. </p><br><p>  Certes, cela conduit au fait que le package est importé au moment de l'assemblage, ce qui peut être indésirable. </p><br><h3 id="dublirovanie-zavisimostey">  Duplication des dépendances </h3><br><p>  Au début, j'étais confus du fait que je devais spécifier des dépendances pour le package dans <code>requirements.txt</code> et <code>setup.cfg</code> . <br>   <a href="https://caremad.io/posts/2013/07/setup-vs-requirement/" rel="nofollow"> </a> ,   —     <code>setup.cfg</code> . <br>      . ,      <code>requirements-dev.txt</code>  . </p><br><h3 id="organizaciya-ishodnikov">   </h3><br><p>    ,       <code>src/</code> .     : </p><br><ul><li>       ; </li><li>    ,             ,   ; </li></ul><br><p>     : </p><br><ul><li>    <code>PyCharm</code> (    ?) —   <code>src</code> ,   . </li></ul><br><h3 id="kommity-i-istoriya-izmeneniy">     </h3><br><p>           —   . <br>  <a href="https://github.com/zifter/numeral-system-py/commits/master" rel="nofollow"> </a>  ,     : </p><br><pre> <code class="plaintext hljs">Add badge with supported version Support for py38</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">Try fix py38 env creating Try fix py38 env creating Try fix py38 env creating Fix check</code> </pre> <br><p> , 3       !        Travis CI. </p><br><p>  <a href="https://habr.com/ru/post/416887/"> </a>  ,    .     —     ,         . </p><br><p>         ,         .       <code>CHANGELOG</code> . </p><br><h3 id="dokumentaciya-1">  La documentation </h3><br><p>     ,   <code>Markdown</code> .     ,      <code>rst</code> . </p><br><h3 id="beydzhi">  Insignes </h3><br><p>      —  ,  ,   ,      .    ,     <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow"> </a> . <br>     <a href="https://pypi.org/project/coverage/" rel="nofollow">coverage</a> . </p><br><h3 id="ogranicheniya-iz-za-ispolzovaniya-raznyh-versiy">  -    </h3><br><p>   ,     ,  , .   <code>six</code>    ,       ,  <code>type hint</code> , <code>asyncio</code>    — . <br>      <code>python2.7</code> ,   <a href="https://pythonclock.org/" rel="nofollow"> </a> .   ,    python3.5+,     . ,         ,      CI   .          . </p><br><h2 id="mozhno-li-sdelat-luchshe">    ? </h2><br><p>       ,    : </p><br><ul><li>   MacOS; </li><li>   python x64  x86; </li><li>   ; </li><li> 100%      ,    <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" rel="nofollow">  </a> .     <a href="https://pypi.org/project/mccabe/" rel="nofollow">mccabe</a> ,      2017 .    ? </li><li>        <a href="https://pyup.io/" rel="nofollow">PyUp</a>  <a href="https://requires.io/" rel="nofollow">requires.io</a> .  ? </li><li>    .     <a href="https://github.com/PyCQA0" rel="nofollow">Python Code Quality Authority</a> , - ? <br><ul><li> <a href="http://mypy-lang.org/" rel="nofollow">mypy</a> —  ; </li><li> <a href="https://github.com/PyCQA/bandit" rel="nofollow">bandit</a> —       ; </li><li> <a href="https://github.com/PyCQA/pyflakes" rel="nofollow">Pyflakes</a> —      ; </li><li> <a href="https://github.com/PyCQA/prospector" rel="nofollow">prospector</a> — ,  <code>pylint</code> , <code>pep8</code> , <code>mccabe</code> . ,    ; </li></ul></li><li>   \   ? </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>           open source ,     . <br>           ,    python   <code>github</code> ,       . <br>        <code>stackoverflow.com</code>  issues    <code>github</code>            . <br>           .      .      ?.. </p><br><p> ,  ,     <a href="https://habr.com/ru/company/ruvds/blog/444344/">   </a> . <br>       ,    <a href="https://sourcery.ai/blog/python-best-practices/" rel="nofollow"> </a> . </p><br><p> <a href="https://github.com/zifter/numeral-system-py" rel="nofollow">    github</a> . </p><br><p>  Je vous remercie! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483512/">https://habr.com/ru/post/fr483512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483500/index.html">Pourquoi les feux arrière sur la Cadillac XLR peuvent coûter plus cher que la Corolla utilisée</a></li>
<li><a href="../fr483502/index.html">Soleil, vent et eau ver 0,2</a></li>
<li><a href="../fr483506/index.html">Rêves d'un vide profond (partie 1). Pompe à vapeur-huile à diffusion: réanimation et un peu de théorie</a></li>
<li><a href="../fr483508/index.html">Top 10 des documents de conférence C ++ CoreHard automne 2019</a></li>
<li><a href="../fr483510/index.html">Testeur pour une petite entreprise comme celle-ci</a></li>
<li><a href="../fr483516/index.html">Arrêtez de mettre la diode 2</a></li>
<li><a href="../fr483518/index.html">Le développeur du jeu VVVVVV en l'honneur de sa décennie a rendu le code source ouvert</a></li>
<li><a href="../fr483520/index.html">Utilisation de l'observateur du modèle de similitude en C</a></li>
<li><a href="../fr483524/index.html">Analyse Habra: quand est-il préférable de publier votre message?</a></li>
<li><a href="../fr483526/index.html">Gestion de l'état des applications avec RxJS / Immer comme alternative simple à Redux / MobX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>