<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👍🏿 🐑 👩‍👧‍👦 Et quelle différence choisit Collation? 🏼 🤷🏽 👩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article a été préparé pour les étudiants du cours "MS SQL Server Developer" 
 Je veux partager une histoire d'un des projets précédents, qui illus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Et quelle différence choisit Collation?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461231/"><p>  Cet article a été préparé pour les étudiants du cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"MS SQL Server Developer"</a> <br>  Je veux partager une histoire d'un des projets précédents, qui illustre que la collation doit être choisie très soigneusement.  Et sur ce qui se passe si ce paramètre est néanmoins mal choisi, et quelles options existent pour résoudre le problème. </p><br><p>  Tout d'abord, une petite introduction sur ce qu'est le classement.  Dans SQL Server, le paramètre Collation indique au serveur comment trier et comparer des lignes.  Par exemple, les lignes «Apple» et «apple».  Sont-ils différents ou non?  Cela dépend du classement spécifié.  Si le registre devient de plus en plus clair, que faire de l'exemple de «l'arbre de Noël» et de «l'arbre de Noël»?  Les compter comme identiques ou différents?  Tout cela est également dans Collation. </p><br><p>  L'histoire s'est produite dans un projet dont la fonctionnalité est très similaire à DropBox ou Google Drive.  Il offre la possibilité de gérer leurs dossiers et fichiers synchronisés sur différentes machines, ainsi que la possibilité pour d'autres utilisateurs d'avoir accès à ce dossier synchronisé. </p><br><p><img src="https://habrastorage.org/webt/zb/r_/ix/zbr_ixoq-dgwur4uwz_izd9myta.png" alt="image"></p><a name="habracut"></a><br><p>  Donc, l'histoire a commencé avec le fait que sur les serveurs Prod, il y avait 75 à 90% d'erreurs dans les journaux (voir la capture d'écran ci-dessous), et on ne sait pas d'où ils viennent et quelle était leur raison.  L'erreur était: "ReadWrtLst n'est pas terminée".  Viennent ensuite les détails de l'utilisateur et leurs dossiers. </p><br><p><img src="https://habrastorage.org/webt/i5/jz/lt/i5jzltkaco2jt9du8opn4ywi1du.png" alt="image"></p><br><p>  Le code a rapidement trouvé un endroit qui a généré une erreur, mais nous ne pouvions pas comprendre pourquoi cela s'était produit et comment le reproduire. Il était clair que l'erreur était en quelque sorte liée au fait que l'utilisateur avait réussi à créez un autre dossier avec le même nom dans votre système d'exploitation. </p><br><p>  Nous avons collecté des informations sur les utilisateurs pour lesquels cette erreur est générée.  Et là, nous avons été confrontés à la première surprise: sur des millions d'utilisateurs du système, seuls 50 d'entre eux avaient cette erreur et ces 50 utilisateurs génèrent 90% des journaux d'erreurs.  La situation n'ayant pu être reproduite, nous avons décidé de contacter l'un des utilisateurs et de découvrir pourquoi l'un des dossiers n'était pas synchronisé avec lui.  Le dossier nous semblait le même que les autres, la seule différence était qu'il était appelé dans la langue de l'utilisateur en utilisant des hiéroglyphes.  Et l'utilisateur était japonais.  Soit dit en passant, parmi ces 50 utilisateurs, les Japonais étaient la majorité. </p><br><p>  Grâce à l'un des développeurs de l'équipe, nous avons pu reproduire l'erreur.  L'erreur était que le système d'exploitation considérait les noms de dossier différents et SQL Server les considérait comme identiques en raison du classement sélectionné. </p><br><p>  Collation utilisée dans le projet: <br>  SQL_Latin1_General_CP1_CI_AS </p><br><p>  Une petite digression sur la façon de lire le classement.  (Si vous le connaissez, n'hésitez pas à le sauter.) </p><br><p>  Ainsi, Collation comporte plusieurs parties: </p><br><ul><li>  SQL - options de tri par SQL Server (SQL au début du classement) ou Windows (alors ce serait juste Latin1_ ...); </li><li>  Latin1_General - paramètres régionaux ou langue utilisés; </li><li>  CP1 - page de codes - page de codes; </li><li>  CI - insensible à la casse - insensible à la casse; </li><li>  AS - Accent Sensitive - en tenant compte des axones ou des diacritiques, en d'autres termes, «a» n'est pas considéré comme égal à «ấ». </li></ul><br><p>  Ce classement était autrefois le classement par défaut lors de l'installation de SQL Server. </p><br><p>  Quelles sont les options? </p><br><ul><li>  _KS - en tenant compte des caractères japonais de hiragana et katakana, si l'option n'est pas sélectionnée, SQL Server interprétera les hiéroglyphes de hiragana et katakana de la même manière. </li><li> _WS - compte tenu de la largeur des caractères, si le paramètre n'est pas sélectionné, alors "Texte" et "T ext" sont considérés comme les mêmes lignes. </li><li>  _VSS - tenant compte des signes de choix de l'option d'orthographe en japonais, apparu à partir de la version 2017. </li><li>  _UTF8 - vous permet de stocker des données dans UTF8. </li></ul><br><p>  Tous les champs de texte de la base de données ont utilisé le type NVARCHAR. <br>  Il s'avère que, puisque le classement actuel a ignoré la différence dans l'orthographe des caractères japonais et la différence dans les largeurs de caractères, SQL Server n'a pas comparé les chaînes de la même manière que le système d'exploitation, ce qui a causé le problème, c'est-à-dire  l'utilisateur pouvait créer des dossiers, ne pouvait pas les ajouter au système pour la synchronisation.  La même chose se produirait plus tard lors de la comparaison des noms de fichiers. </p><br><p>  Nous avons commencé à réfléchir à la façon de résoudre ce problème et de changer le classement. </p><br><p>  Le classement peut être défini à plusieurs niveaux: </p><br><ul><li>  Instance SQL Server </li><li>  Base de données </li><li>  Table </li><li>  Le terrain </li></ul><br><p>  Dans le même temps, il n'est pas recommandé d'avoir un classement différent dans la base de données, car chaque fois que vous comparez des lignes avec un classement différent, vous devrez effectuer la conversion à l'aide de COLLATE, en indiquant au serveur l'ordre de comparaison à utiliser. </p><br><p>  Quelles sont les options dans une situation où il est clair que le classement n'est pas sélectionné correctement? </p><br><ol><li>  Modifier le classement au niveau de la base de données; </li><li>  Modifier le classement au niveau du champ (dans notre cas, il était inutile de changer pour la table entière); </li><li>  Ajoutez le champ Varbinary, dans lequel écrire un doublon du champ avec le nom du dossier, et utilisez-le pour la comparaison; </li><li>  Dites aux utilisateurs qu'il existe des restrictions sur la prise en charge des caractères dans les noms de répertoire. </li></ol><br><p>  La première option - changer le classement au niveau de la base de données - est la plus difficile.  Dans le cas de la base de données, il serait nécessaire de recréer la base de données et d'y recharger les données.  Le système fonctionnant 24h / 24 et 7j / 7, cette option a été rejetée immédiatement. </p><br><p>  La deuxième option concernant la modification du champ: la façon la plus simple de l'implémenter consiste à ajouter un champ avec le classement souhaité et à y transférer les données.  Mais ensuite, il sera nécessaire de changer le code dans la base de données qui fonctionne avec ce champ, et il y avait beaucoup de code dans la base de données. </p><br><p>  Nous avons le plus aimé la troisième option, car en théorie, elle apportait le moins de changements, car le champ principal continuerait d'exister avec le classement actuel, et nous n'aurions pas de problèmes avec sa conversion, tandis que toutes les fonctionnalités nécessaires sous la forme de la comptabilité de l'alphabet japonais ou large les personnages fonctionneraient.  L'inconvénient était qu'il était nécessaire d'apporter des modifications à la partie logicielle, mais depuis cette partie serveur, cela pouvait être fait. </p><br><p>  La quatrième option était la plus simple dans ce cas, car le nombre total d'utilisateurs était de plusieurs millions, et seulement 50 avaient un problème. Cependant, si l'application était activement utilisée au Japon, cette solution serait de peu d'utilité. </p><br><p>  Après avoir présenté les données à la direction, il a été décidé d'informer les utilisateurs que le logiciel ne prend pas en charge un certain nombre de caractères, et lorsqu'il est utilisé au nom de fichiers et dossiers synchronisés, le logiciel peut ne pas fonctionner correctement.  Il s'agit d'une solution temporaire, car avec une distribution plus poussée, le nombre d'utilisateurs confrontés à un problème similaire augmentera et il sera nécessaire de changer quelque chose en utilisant les trois premières options. </p><br><p>  La meilleure option pour choisir le classement est basée sur les exigences de votre application.  Si vous souhaitez que SQL Server compare les chaînes de la même manière que le système d'exploitation, le classement est définitivement incorrect par défaut.  Malheureusement, de telles nuances sont rarement visibles au début d'un projet lors de la conception d'un système, mais, espérons-le, après avoir lu l'article, vous vous souviendrez de la situation décrite et ne monterez pas vous-même un tel râteau. </p><br><p>  Ressources de collation utiles: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.microsoft.com/en-us/sql/relational-databases/collations/collation-and-unicode-support?view=sql-server-2017</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.red-gate.com/simple-talk/sql/sql-development/questions-sql-server-collations-shy-ask/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.virtual-dba.com/sql-server-collation/</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461231/">https://habr.com/ru/post/fr461231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461219/index.html">Dell Latitude 7400 2-en-1: un ordinateur portable convertible d'entreprise beau et léger avec un boîtier métallique</a></li>
<li><a href="../fr461223/index.html">IaaS digest: hautes performances, stockage de données et nouvelles technologies pour les centres de données</a></li>
<li><a href="../fr461225/index.html">Comment se rendre au pôle Nord depuis la base dérivante de Barneo</a></li>
<li><a href="../fr461227/index.html">Embarcadero RAD Studio 10.3.2 est sorti ou ce qui est mort ... est mort</a></li>
<li><a href="../fr461229/index.html">Helsinki Comment trouver un emploi dans l'industrie du jeu finlandaise, commencer à travailler sans autorisation et ne pas violer les lois russes</a></li>
<li><a href="../fr461239/index.html">Flutter dans les exemples. Liens profonds dans les applications Flutter</a></li>
<li><a href="../fr461241/index.html">Wolfram Mathematica en géophysique</a></li>
<li><a href="../fr461243/index.html">Ne vous promenez pas en Afrique: quelle est la situation de la censure sur Internet sur le continent noir</a></li>
<li><a href="../fr461247/index.html">50 meilleures sources sur la gestion des produits à lire, écouter et regarder</a></li>
<li><a href="../fr461249/index.html">Écrire une application Android pour les fans de films - Partie 2 (Conception)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>