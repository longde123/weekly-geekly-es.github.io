<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶é üì¥ üë©üèª‚Äç‚úàÔ∏è Como √© f√°cil entregar um pedido, sabendo o endere√ßo do cliente (n√£o muito) üî≥ üç∑ üîÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Denis Girko, sou o arquiteto de sistemas da plataforma de com√©rcio eletr√¥nico em Lamoda. No ano passado, falei na confer√™ncia ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como √© f√°cil entregar um pedido, sabendo o endere√ßo do cliente (n√£o muito)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/444848/"><p>  Ol√° pessoal!  Meu nome √© Denis Girko, sou o arquiteto de sistemas da plataforma de com√©rcio eletr√¥nico em Lamoda.  No ano passado, falei na confer√™ncia DevConf com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> que quero compartilhar com voc√™. </p><br><p> Este √© um relat√≥rio de revis√£o sobre as dificuldades que uma grande loja online encontra no processo de entrega de pedidos e quais solu√ß√µes t√©cnicas podem ajudar a super√°-las (usando as solu√ß√µes que testamos na Lamoda como exemplo). </p><br><p><img src="https://habrastorage.org/webt/vc/1p/24/vc1p24p8id79oozynnspkyikg0k.jpeg" alt="imagem"></p><br><p>  Sobre o que ser√°?  Eu vou te dizer: </p><br><ul><li>  Sobre o processo de entrega e identificar problemas; </li><li>  como armazenar efetivamente territ√≥rios de entrega no banco de dados; </li><li>  como melhorar a qualidade dos dados que recebemos do cliente; </li><li>  como pesquisar o destinat√°rio no banco de dados de endere√ßos para encontrar resultados mais precisos. </li></ul><a name="habracut"></a><br><h3 id="obschaya-shema-dostavki-zakaza-lamoda">  Esquema Geral de Entrega de Pedidos Lamoda </h3><br><p>  A Lamoda √© uma loja on-line com quatro pa√≠ses para entrega: R√∫ssia, Ucr√¢nia, Cazaquist√£o e Bielorr√∫ssia.  Entregamos mercadorias no dia seguinte devido ao fato de termos nosso pr√≥prio servi√ßo de entrega e uma d√∫zia de parceiros terceirizados cujos servi√ßos usamos.  A entrega √© uma grande parte do nosso neg√≥cio. </p><br><p>  Lamoda aceita o pedido, solicita ao cliente o endere√ßo no momento do registro e o passa para o servi√ßo de correio. </p><br><p><img src="https://habrastorage.org/webt/ng/2d/i1/ng2di1movib3pmlisotbmwq-ffq.png" alt="imagem"></p><cut></cut><br><p>  E se n√£o tivermos um servi√ßo de correio, mas v√°rios?  Em seguida, √© adicionado o pr√≥ximo passo - para determinar qual servi√ßo de entrega faremos o pedido. </p><br><p><img src="https://habrastorage.org/webt/1v/6z/7c/1v6z7ceacbfmk5kctkqh1ss1jeg.png" alt="imagem"></p><br><p>  Pode haver alguns crit√©rios de sele√ß√£o de neg√≥cios.  Mas a primeira coisa a se pensar √© se esse servi√ßo de entrega tem entrega na cidade selecionada pelo cliente ou n√£o.  Portanto, o primeiro passo para integrar qualquer empresa de courier em nosso sistema √© descobrir sua √°rea de cobertura. <br><img src="https://habrastorage.org/webt/_n/xx/wv/_nxxwvl8qncwmm8vhqhgd2g_qo4.png" alt="imagem"><br>  Em seguida, voc√™ precisa aprender como verificar se o endere√ßo do cliente se enquadra nesse territ√≥rio ou n√£o. </p><br><p>  O esquema geral ser√° aprimorado e ter√° a seguinte apar√™ncia: </p><br><ul><li>  pe√ßa um endere√ßo; </li><li>  descubra quais servi√ßos de courier podem fornec√™-lo; </li><li>  selecione o que voc√™ deseja dentre os dispon√≠veis. </li></ul><br><p><img src="https://habrastorage.org/webt/7r/av/xo/7ravxognqcj0njydxoauolhxsbk.png" alt="imagem"></p><br><p>  Agora um pouco mais sobre essas etapas. </p><br><h3 id="sprashivaem-u-klienta-adres">  Pedimos ao cliente o endere√ßo </h3><br><p>  Como posso perguntar a ele? </p><br><ol><li>  Pe√ßa para preencher um campo grande.  O cliente martela em seu endere√ßo, o que ainda n√£o precisa de manipula√ß√µes complicadas.  O endere√ßo pode ser impresso em um peda√ßo de papel, entregue ao correio a p√©, que ent√£o o descobrir√°. </li><li>  A segunda op√ß√£o √© mais complicada.  Pedimos ao cliente que preencha cada componente do endere√ßo em seu campo.  Aqui voc√™ j√° pode fazer alguma coisa.  Por exemplo, compare a cidade de Moscou com uma determinada lista de cidades.  Mas funcionar√° mal, porque a cidade de Moscou pode ser escrita de v√°rias maneiras: ‚Äúg.  Moscow ‚Äù,‚Äú Moscow city ‚Äù,‚Äú Moscow city ‚Äùsem espa√ßo, e assim por diante. </li><li>  Portanto, h√° uma op√ß√£o ainda mais avan√ßada.  Como a lista de cidades que temos √© finita, voc√™ pode pr√©-compilar uma lista de cidades e sugerir que o cliente selecione a que ele precisa.  O b√¥nus √© que, para cada elemento dessa lista, j√° podemos associar algum identificador aqui.  N√≥s desenvolvedores adoramos trabalhar n√£o com strings, mas com identificadores que podem ser usados ‚Äã‚Äãem todos os nossos sistemas como o equivalente √† cidade selecionada.  Eu tenho um √≠ndice central dos correios no slide como um identificador. <br><img src="https://habrastorage.org/webt/cz/q9/sy/czq9syl4hieoqj8h88c7trupbim.png" alt="imagem"></li></ol><br><h3 id="kakoy-sluzhboy-dostavki-vezem">  Que servi√ßo de entrega estamos transportando? </h3><br><p>  Como temos um identificador (√≠ndice), deixe o territ√≥rio armazenado em nosso banco de dados ser representado por uma lista de √≠ndices.  Nesse caso, o algoritmo para verificar a entrada da cidade no territ√≥rio √© muito simples.  Ent√£o, vamos faz√™-lo: colocaremos os territ√≥rios de entrega recebidos dos servi√ßos de correio no banco de dados na forma de √≠ndices. </p><br><p>  Os √≠ndices t√™m seus pr√≥s e contras.  Eu digo antecipadamente que, no in√≠cio, a Lamoda fez exatamente isso: o resultado da escolha de um cliente da cidade foi um √≠ndice e nossos √≠ndices foram armazenados no banco de dados.  Por que um plus?  Como eu disse, um √≠ndice √© algo que todos entendem.  Qualquer gerente que acabou de trabalhar sabe o que √© um √≠ndice.  Ele pode receber da empresa de courier da cidade, de alguma forma convert√™-los em √≠ndices e us√°-los.  A desvantagem √© que o √≠ndice √© o identificador dos correios dos correios russos.  E os assentamentos pr√≥ximos podem compartilhar o mesmo √≠ndice. </p><br><h3 id="pochemu-perestalo-hvatat-indeksov">  Por que os √≠ndices est√£o ausentes? </h3><br><p>  Um exemplo simples: Lyubertsy.  Perto √© a vila de Marusino.  Marusino n√£o tem uma ag√™ncia postal, a correspond√™ncia chega a uma das ag√™ncias postais de Lyubertsy.  Se quis√©ssemos adicionar entrega ao Lyubertsy, mas n√£o entregar ao Marusino, porque pode n√£o ser financeiramente lucrativo para n√≥s, n√£o poder√≠amos fazer isso apenas por √≠ndice. <br><img src="https://habrastorage.org/webt/xy/5d/am/xy5damiwrmj4accagb5uckr8bma.png" alt="imagem"></p><br><p>  Outro exemplo √© quando Lamoda expandiu e abriu um segundo armaz√©m de transporte em Moscou.  Era necess√°rio dividir Moscou nas partes norte e sul.  E j√° na hora de fazer o pedido, entenda em qual armaz√©m de tr√¢nsito a entrega ser√° realizada.  Nesse caso, um √≠ndice por cidade n√£o seria suficiente. </p><br><p>  Decidimos usar coordenadas geogr√°ficas juntamente com √≠ndices.  Pegamos o endere√ßo do cliente, executamos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">geocoder Yandex</a> .  Na sa√≠da, obtemos n√£o apenas o √≠ndice, mas tamb√©m as coordenadas.  Usamos √≠ndices nos casos em que os detalhes n√£o s√£o importantes.  E as coordenadas especificam esses casos quando voc√™ precisa fazer uma divis√£o fina do territ√≥rio. </p><br><p>  Eles forneceram uma interface em seu programa de configura√ß√£o para log√≠sticos, que permite desenhar um pol√≠gono no topo do mapa.  √â simples: o ponto cai no aterro - h√° entrega, n√£o cai - n√£o. <br><img src="https://habrastorage.org/webt/_2/t3/pk/_2t3pkebkcck78k3imgkk6w8cdi.png" alt="imagem"><br>  <em>Interface de cria√ß√£o de zona de pol√≠gono</em> </p><br><p>  O b√¥nus que temos coordenadas geogr√°ficas para cada pedido foi a oportunidade de melhorar a interface que os log√≠sticos usam para fazer rotas para os representantes de vendas.  A interface exibe um mapa no qual os pedidos dos clientes s√£o marcados.  O log√≠stico usa a ferramenta la√ßo, que combina as ordens adjacentes em uma rota.  Al√©m disso, essa rota vai para um representante de vendas, ou seja, uma pessoa n√£o precisa ir de um extremo da cidade para o outro extremo durante o dia para receber todos os seus pedidos - todos eles est√£o geograficamente pr√≥ximos. <br><img src="https://habrastorage.org/webt/4d/aq/ar/4daqar6z4vmutjh3mdumdwn-6ma.png" alt="imagem"><br>  <em>Interface de roteamento</em> </p><br><p>  O endere√ßo digitado pelo cliente √© convertido em coordenadas.  A probabilidade de obtermos as coordenadas para um determinado endere√ßo depende diretamente da qualidade do endere√ßo digitado pelo cliente.  Portanto, a primeira coisa que pensamos √© em como aumentar o n√∫mero de endere√ßos bem reconhecidos.  Portanto, voc√™ precisa ajudar o cliente a inserir o endere√ßo correto. </p><br><p>  O fato √© que os clientes geralmente n√£o seguem os cen√°rios que fornecemos para eles; portanto, adquirimos bancos de dados de endere√ßos para cada um dos quatro pa√≠ses para os quais entregamos pedidos.  E fizeram uma festa, n√£o s√≥ para a cidade, mas tamb√©m para a rua e at√© para o n√∫mero da casa.  Para fazer uma lista de casas, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">analisamos os</a> dados abertos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do openstreetmap.org</a> . <br><img src="https://habrastorage.org/webt/bb/4n/bd/bb4nbdspyc75buacqdxmmi3jibk.png" alt="imagem"><br>  <em>O formul√°rio de checkout oferece dicas para formalizar dados de endere√ßo</em> </p><br><h3 id="adresnaya-baza">  Base de endere√ßo </h3><br><p>  Para fazer uma sujest na base de endere√ßo, voc√™ precisa mant√™-la em casa.  Onde conseguimos todas as bases de endere√ßos para nossos quatro pa√≠ses?  Na R√∫ssia, √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FIAS</a> , a base de endere√ßos que √© compilada e mantida por nosso servi√ßo de impostos.  √â bastante completo, embora n√£o sem falhas.  Nossos parceiros de entrega nos ajudaram com outros pa√≠ses. <br><img src="https://habrastorage.org/webt/tp/bi/_m/tpbi_m-s0oxwiiddhd_i5rrw-l8.png" alt="imagem"></p><br><p>  Tamb√©m temos um conjunto de scripts PHP que assumem o formato com o qual a base de endere√ßos chega at√© n√≥s e da mesma maneira que a adiciona ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PostgreSQL</a> .  Por que da mesma forma?  Porque uma das tarefas √© atualizar periodicamente esses bancos de dados das mesmas fontes.  Isso significa que, se fornec√™ssemos a convers√£o, ela teria que ser repetida a cada atualiza√ß√£o.Portanto, os dados v√£o para o PostgreSQL e, a partir da√≠, s√£o convertidos e armazenados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apache Solr</a> ;  O Solr permite procurar rapidamente por eles e fazer sajest.  Um pequeno servidor web PHP √© capaz de criar solicita√ß√µes no Solr, de acordo com os resultados, uma lista √© criada para o cliente no site para o sujest. </p><br><div class="spoiler">  <b class="spoiler_title">Exemplo vivo</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ko/s4/cz/kos4czfszfi2egrtx2mnwxcaqwo.png" alt="imagem"></p></div></div><br><p><img src="https://habrastorage.org/webt/py/z_/pw/pyz_pw_qs26ypndty6qpowgilsi.png" alt="imagem"></p><br><p>  Fazemos o download de dados da fonte aproximadamente da mesma forma em que eles chegaram at√© n√≥s.  Ou seja, com o mesmo conjunto de campos, com os mesmos tipos de colunas e assim por diante.  Adicione-os como est√£o.  Tentamos usar os dados neste formul√°rio desde o in√≠cio e, para transform√°-los nas estruturas com as quais podemos trabalhar, escrevemos v√°rias visualiza√ß√µes.  Como temos 4 pa√≠ses, tudo isso foi multiplicado por 4, e foi muito dif√≠cil e caro apoiar.  Portanto, era necess√°rio fazer algo a respeito. </p><br><p>  A primeira coisa de que nos livramos √© a estrutura n√£o estruturada, ou melhor, a <em>estrutura espec√≠fica</em> , em um est√°gio inicial.  Ou seja, assim que os dados brutos s√£o carregados, com a ajuda de visualiza√ß√µes, os transformamos em um formato unificado, com o qual todas as outras transforma√ß√µes s√£o configuradas.  Isso nos impediu de multiplicar por 4. E √© nesse momento que esquecemos a estrutura em que os dados chegaram at√© n√≥s e trabalhamos apenas com o que inventamos para n√≥s mesmos. <br><img src="https://habrastorage.org/webt/1s/zp/rn/1szprnn0rmejrvuop8uawdzwvaa.png" alt="imagem"></p><br><p>  Se voc√™ precisar de duas fontes - fa√ßa o download.  O principal √© que o formato dessa sa√≠da de dados ap√≥s a convers√£o em visualiza√ß√µes seja o mesmo. <br><img src="https://habrastorage.org/webt/we/ru/dm/werudmivgvezc6ytbrgpmdr0ojm.png" alt="imagem"></p><br><p>  Outro requisito para bancos de dados de endere√ßos carregados era que era necess√°rio fazer corre√ß√µes de pontos.  Um exemplo simples: no FIAS, a Rep√∫blica Chuvash √© chamada "Rep Chuvash.  "Chuvashia."  Bem, queremos apenas a Rep√∫blica Chuvash.  Por que precisamos desse tra√ßo?  E, ao mesmo tempo, ainda n√£o podemos evitar atualiza√ß√µes peri√≥dicas de fontes. </p><br><p>  Aqui est√£o as seguintes camadas que temos no PostgreSQL. <br><img src="https://habrastorage.org/webt/gf/is/a2/gfisa2hm2svx2gkehzy5raekpim.png" alt="imagem"></p><br><p>  As tabelas √† esquerda s√£o dados brutos baixados da fonte. </p><br><p>  Atr√°s deles, exibi√ß√µes que convertem dados em um formato padr√£o. </p><br><p>  <em>Substitui√ß√µes locais</em> s√£o nosso conjunto de tabelas que redefinem apontadormente alguns atributos dos dados de endere√ßo carregados.  Inclu√≠mos aqui, por exemplo, que um registro com esse identificador deve receber em vez de ‚ÄúChuvash rep.  - Chuvashia ‚Äù√© o nosso nome escolhido. </p><br><p> <em>A tabela Mapeamento</em> √© o nosso reposit√≥rio de identificadores, que n√≥s mesmos atribu√≠mos aos objetos de endere√ßo que baixamos - isso nos permitiu abstrair nossos sistemas da fonte, daqueles identificadores usados ‚Äã‚Äãna fonte e tamb√©m ocultar n√£o uma fonte, mas at√© v√°rias - sob um ID. Vou contar um pouco mais tarde.  Tudo isso junto √© combinado e corrigido em uma vis√£o materializada.  Assim, obtemos quase o equivalente da tabela final, que pode ser atualizada executando um comando SQL <code>REFRESH MATERIALIZED VIEW</code> . </p><br><p>  <em>Objetos de endere√ßo</em> - base de endere√ßos formada com todas as corre√ß√µes e adi√ß√µes. </p><br><p>  Portanto, na sa√≠da j√° corrigimos os objetos de endere√ßo, j√° com novos nomes e nossos identificadores.  Tudo isso √© transformado e desnormalizado, conveniente para pesquisar e adicionado ao Solr. </p><br><p>  Como agora temos bancos de dados de endere√ßos, seria legal us√°-los n√£o apenas para solicitar o formul√°rio de pedido, mas tamb√©m para fazer uma pesquisa.  Onde uma pesquisa pode ser √∫til?  Acontece muito onde.  As mesmas √°reas de entrega que recebemos dos servi√ßos de courier s√£o muitas vezes representadas simplesmente por uma lista de cidades.  E a lista de cidades est√° repleta dos mesmos problemas da entrada do usu√°rio: as cidades podem ter interpreta√ß√µes diferentes, nomes diferentes e muito mais. </p><br><p>  Eu tenho um slide especial aqui, uma hist√≥ria de horror - o que ter√≠amos que fazer se peg√°ssemos tudo manualmente para convert√™-lo em PHP: isto √©, Chech√™nia, Rep√∫blica da Chech√™nia e assim por todas as fontes de dados - o inferno √© um inferno. </p><br><p><img src="https://habrastorage.org/webt/7t/p4/eo/7tp4eoy0jtxnevev1-0pgdk_axi.png" alt="imagem"></p><br><blockquote>  Adi√ß√£o: na tela - um c√≥digo real do servi√ßo, que se tornou desnecess√°rio apenas por causa das solu√ß√µes descritas. </blockquote><p>  Classificamos esses problemas. </p><br><p>  1) Nomes equivalentes dos mesmos objetos.  Por exemplo, sin√¥nimos comuns como Chuvashia e Rep√∫blica Chuvash. </p><br><p>  2) Cidades renomeadas.  A Ucr√¢nia est√° agora na fase ativa de se livrar do passado comunista, e √© por isso que literalmente todos os dias fazem mudan√ßas nos nomes de seus assentamentos.  Por esse motivo, pode acontecer que em um banco de dados tenhamos nomes antigos e em outro - novos. </p><br><p>  3) Muitos erros.  Muitas vezes confundido com o status dos assentamentos.  H√° uma vila, aqui √© uma vila ou aqui √© uma vila, h√° uma fazenda. </p><br><p>  4) Palavras estrangeiras transliteradas para o russo, geralmente o mesmo nome √© transliterado de maneiras diferentes. </p><br><p>  5) Existem muitos erros na hierarquia: Zelenograd, por h√°bito, pertence √† regi√£o de Moscou, embora formalmente tamb√©m esteja listado em Moscou como FIAS.  Escreva corretamente "Cidade de Moscou, Zelenograd". </p><br><p>  Como chegamos a isso? </p><br><p>  A primeira coisa que fazemos √© separar todos os componentes insignificantes do endere√ßo dos nomes.  N√≥s n√£o os jogamos fora, eles participam da pesquisa, mas separadamente das partes significativas. <br><img src="https://habrastorage.org/webt/pj/l-/hm/pjl-hmgtn30iryqakbsqjrll6qy.png" alt="imagem"></p><br><p>  Em seguida, fizemos uma pequena lista de sin√¥nimos e abrevia√ß√µes comuns usados ‚Äã‚Äãnos nomes.  Onde a fonte permitia, carregamos e colocamos todos os nomes no Solr.  N√£o apenas os sin√¥nimos mais relevantes, mas tamb√©m poss√≠veis sin√¥nimos e nomes hist√≥ricos. </p><br><p>  Para pesquisar melhor, jogamos fora todas as letras que podem apresentar discrep√¢ncias.  Isso se aplica ao idioma russo e aos idiomas com os quais ainda temos que lidar. </p><br><p>  Corrigimos erros de digita√ß√£o e corrigimos o layout. </p><br><p>  Finalmente, criamos pais fantasmas - esses s√£o pais atribu√≠dos a objetos.  Eles s√£o relevantes na pesquisa, mas n√£o participam do resultado da pesquisa.  Por exemplo, para Zelenograd, adicionamos a regi√£o de Moscou.  Agora voc√™ pode procurar por "Moscow Region, Zelenograd" e encontrar o objeto de que precisamos, mas nos resultados da pesquisa ainda ser√° o "Moscow, Zelenograd" correto. </p><br><p><img src="https://habrastorage.org/webt/rw/kh/qm/rwkhqme_rixhx9dz1du34m0hrqy.png" alt="imagem"></p><br><p>  Dependendo dos requisitos de neg√≥cios, √© necess√°ria uma grada√ß√£o diferente da precis√£o da pesquisa.  Portanto, temos 4 graus, cada um deles d√° um resultado com maior probabilidade, mas com uma menor probabilidade, ser√° exatamente o resultado que se deseja. <br><img src="https://habrastorage.org/webt/hn/hw/lh/hnhwlh7kyr55fbn5b-eqqqlsxtc.png" alt="imagem"></p><br><p>  E onde encontramos esse aplicativo de pesquisa? </p><br><ul><li>  Mais uma vez, executamos o endere√ßo digitado pelo cliente por meio dessa pesquisa.  Se ele n√£o usou nossas dicas na p√°gina de checkout, temos mais uma chance de transformar as linhas que ele inseriu em identificadores.  Temos um endere√ßo formalizado. </li><li>  Executamos essa pesquisa em tudo o que os servi√ßos de correio nos enviam - reconhecemos as cidades que eles nos transmitem.  Isso nos permitiu lan√ßar apenas 10 pe√ßas por dia, o que √© relevante para o B2B - a Lamoda fornece sua entrega a empresas terceirizadas, portanto h√° muitos novos servi√ßos de correio conectados por unidade de tempo. </li><li>  Isso nos permitiu ‚Äúencadear‚Äù v√°rias informa√ß√µes √∫teis em nossos identificadores nos bancos de dados de endere√ßos.  Por exemplo, baixamos fusos hor√°rios, endere√ßos IP, para procurar cidades pelos endere√ßos IP dos clientes. </li><li>  Agora temos a oportunidade de ocultar a base de endere√ßos combinada de duas fontes com um de nossos identificadores.  Ou seja, permitiu evitar duplicatas e combinar os mesmos objetos de endere√ßo nas duas bases. </li></ul><br><p>  N√≥s n√£o paramos.  Este √© um processo que ainda podemos melhorar. </p><br><p>  Em primeiro lugar, Lamoda trabalha em √≠ndices.  Ou seja, nossos identificadores s√£o √≠ndices, dos quais sabemos os menos.  Quase todos os nossos sistemas mudaram para a nova API; eles operam n√£o com √≠ndices, mas com os mesmos identificadores que n√≥s mesmos atribu√≠mos aos nossos objetos de endere√ßo.  A vantagem √© que a verifica√ß√£o de uma cidade no territ√≥rio √© t√£o simples quanto nos √≠ndices.  No entanto, n√£o h√° menos no fato de que v√°rios assentamentos podem se esconder atr√°s de um ID. </p><br><blockquote>  Al√©m disso: o tempo passou desde o momento do meu discurso, e agora estou feliz em me corrigir: nossos √≠ndices agora permanecem apenas no caso, quando o correio nos d√° seu territ√≥rio na forma de uma lista deles, por exemplo, Russian Post.  Em outros casos, os √≠ndices foram suplantados por nossos identificadores de endere√ßo interno. </blockquote><p>  No slide, h√° uma parte da interface que permite configurar manualmente o territ√≥rio, mas, na verdade, tudo √© configurado a partir de listas carregadas em lote de objetos de endere√ßo na forma de seq√º√™ncias de caracteres. <br><img src="https://habrastorage.org/webt/n9/-1/rn/n9-1rnlutwkmd8-tpnyfaxiwuxg.png" alt="imagem"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Baixamos as</a> coordenadas geogr√°ficas do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">openstreetmap.org</a> para resid√™ncias.  Agora, em uma grande porcentagem de casos, n√£o precisamos ir a um servi√ßo externo para descobrir o local.  Isso nos reduziu 10 vezes a viagens para Yandex, que naturalmente economizavam dinheiro. </p><br><p>  N√≥s nos livramos do PHP na cadeia de pesquisa de dados de endere√ßo.  Reescrevemos o c√≥digo que acessou o Solr em Lua.  Substitu√≠do nginx pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Openresty</a> , agora tudo √© muito r√°pido e pode suportar cargas pesadas.  95% das respostas de nosso servi√ßo de pesquisa cabem em 10 milissegundos, o que √© mais do que suficiente para n√≥s. </p><br><p><img src="https://habrastorage.org/webt/6b/th/wm/6bthwmdw9aq79khamwrwrqfgbqc.png" alt="imagem"></p><br><blockquote>  Al√©m disso: o uso do Openresty e Lua, que atraiu seu desempenho, foi um tipo de experi√™ncia que valeu a pena: o servi√ßo funciona rapidamente, √© est√°vel sob carga e √© facilmente mantido.  Mas desde ent√£o, Lamoda adotou Golang, que tem as mesmas qualidades, como uma das linguagens de programa√ß√£o para o back-end carregado.  Se a decis√£o de desenvolver o servi√ßo fosse tomada agora, n√≥s o preferir√≠amos. </blockquote><br><h3 id="vyvod">  Conclus√£o </h3><br><p>  Minha moral pessoal de todo o trabalho realizado √© que os dados de endere√ßo s√£o uma √°rea em que voc√™ n√£o pode esperar a qualidade ideal dos dados.  Isso nunca vai acontecer.  Nunca receberemos dados perfeitos de um cliente ou de fontes externas.  Portanto, voc√™ precisa extrair o m√°ximo do que √©. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt444848/">https://habr.com/ru/post/pt444848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt444838/index.html">OWASP R√∫ssia Meetup</a></li>
<li><a href="../pt444840/index.html">3. Introdu√ß√£o ao Ponto de Verifica√ß√£o R80.20. Prepara√ß√£o de layout</a></li>
<li><a href="../pt444842/index.html">O primeiro computador program√°vel de DNA</a></li>
<li><a href="../pt444844/index.html">Existe uma marca registrada para registrar? ou Como fomos for√ßados a alterar o nome do aplicativo</a></li>
<li><a href="../pt444846/index.html">ML.NET 0.11 - Aprendizado de m√°quina para .Net</a></li>
<li><a href="../pt444850/index.html">Mec√¢nica Qu√¢ntica: O Fim da Guerra das Interpreta√ß√µes</a></li>
<li><a href="../pt444852/index.html">Casa Inteligente - Repensando</a></li>
<li><a href="../pt444854/index.html">Criando elementos de interface programaticamente usando o PureLayout (parte 1)</a></li>
<li><a href="../pt444858/index.html">Em busca do melhor rem√©dio</a></li>
<li><a href="../pt444860/index.html">OFFZONE 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>