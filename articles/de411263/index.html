<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¶ ‚è∞ üñ•Ô∏è Magic Button f√ºr LED auf ATtiny4 üí∂ ‚úãüèº üîÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SESAM 


 Ich hatte vor langer Zeit einmal einen ber√ºhrungsempfindlichen Wunderschalter SESAM . Ich mochte ihn wirklich. Aber die Zeiten √§ndern sich, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Magic Button f√ºr LED auf ATtiny4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411263/"><h4 id="sezam">  SESAM </h4><br><p>  Ich hatte vor langer Zeit einmal einen ber√ºhrungsempfindlichen Wunderschalter <em>SESAM</em> .  Ich mochte ihn wirklich.  Aber die Zeiten √§ndern sich, es passt nicht mehr in den Innenraum, und dann wurde es √ºberhaupt nicht f√ºr alle Arten von modischen Energiesparlampen entwickelt.  Ich mochte das Prinzip des Managements darin.  Durch kurzes Ber√ºhren des Sensors wurde das Licht ein- und ausgeschaltet, und durch langes Ber√ºhren wurde die Helligkeit eingestellt.  Wen <em>k√ºmmert es</em> - der Leistungsschalter war <em>K145AP2</em> , ein Analogon von <em>Siemens S576B</em> (K145AP2 wird noch verkauft). </p><br><p>  Unter dem Schnitt meine Version der Emulation des Betriebs dieses Chips. </p><a name="habracut"></a><br><p>  Vor nicht allzu langer Zeit habe ich mir ein LED-Lichtband in einem Aluminiumprofil mit einem Diffusor √ºber dem Tisch gebaut, und es stellte sich die Frage nach dem Schalter.  Das Vorbereiten ist irgendwie umst√§ndlich.  Damit es am Draht h√§ngt - es ist nicht sch√∂n, einen gew√∂hnlichen Schalter zu bet√§tigen -, verdirbt es die Aussicht und es gibt wirklich keinen Ort, an den man gehen kann. </p><br><p>  Ich beschloss, am Ende der 16-mm-Spanplatte einen Schalter f√ºr einen und einen Dimmer zu bauen.  Ber√ºhren Sie es, bedecken Sie es mit einem Aufkleber, mit dem die M√∂belhersteller die Maske verschrauben. </p><br><h4 id="zhelezo">  Eisen </h4><br><p>  Begonnen mit einem Sensor.  Ich habe das Prinzip der Ladungs√ºbertragung auf den <em>ATtiny13A ausprobiert</em> .  Die Option funktioniert, aber ich war zu faul, um mich mit Auto-Tuning-Parametern usw. zu besch√§ftigen.  Er hat auch den fertigen nicht genommen. </p><br><p>  Dann habe ich beschlossen, den Sensor in der <em>QTouch-</em> Bibliothek zu implementieren.  Als <em>ATtiny10-</em> Sensor.  Es gibt ein vorgefertigtes Dienstprogramm, das <em>ATtiny10</em> in einen Touch-Button mit allen <em>Extras</em> verwandelt.  Aber am Ausgang ist es schwierig, den Code der Bin√§rdatei dort hinzuzuf√ºgen.  Ich √ºberlegte, was ich tun sollte, surfte im Internet und stie√ü dann <em>auf eine</em> Erw√§hnung des <em>TTP223</em> - des Controllers mit einem Tastendruck.  Diese Option passte perfekt zu mir. </p><br><p>  Als MK fiel die Wahl auf <em>ATtiny4</em> .  So klein wie <em>TTP223</em> , ein 16-Bit-Timer.  Ja, und lange wollte ich etwas N√ºtzliches an diesen Tinki machen. </p><br><p>  Als Schl√ºssel - <em>P3055LD</em> vom alten Motherboard. </p><br><h4 id="pechatnaya-plata">  Leiterplatte </h4><br><p>  Bei der Entwicklung einer Leiterplatte ging ich davon aus, dass die L√∂cher am Ende der Spanplatte so wenig wie m√∂glich ben√∂tigen, und entschied, dass ein Durchmesser von 7 mm v√∂llig ausreichen w√ºrde.  Das Board stellte sich als 7x28mm heraus, zwei Schichten. </p><br><p>  Sp√§ter, als die Platine gel√∂tet wurde, wurde klar, dass die Platine nicht in das 7-mm-Loch passen w√ºrde, mindestens 9 mm - die H√∂he der Elemente wurde nicht ber√ºcksichtigt.  Die Idee mit einem Aufkleber h√∂rte auch irgendwie auf zu m√∂gen.  Und dann fiel mir ein M√∂belstummel auf!  Entworfen f√ºr 10mm Loch und Innendurchmesser genau 7mm!  Alles stimmte √ºberein! </p><br><p>  Das Sensor-Patch selbst befindet sich auf einem separaten Schal, der am Hauptende angel√∂tet ist.  Auf den Bildern sehen Sie. </p><br><div class="spoiler">  <b class="spoiler_title">Bilder</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/c90/811/124/c908111247ab756b2667c342f63910ef.jpg" alt="cooles Bild"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/8e7/bb2/c17/8e7bb2c177c2f1f1940cc7a9edf1d7c6.jpg" alt="cooles Bild"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/626/916/1bb/6269161bb3a78aa01bd7f6b77119af5d.jpg" alt="cooles Bild"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e14/976/8f0/e149768f0a162a2598003f83d5741e4a.jpg" alt="cooles Bild"></p></div></div><br><h4 id="programma">  Das Programm </h4><br><p>  Das Steuerprogramm ist in Assembler geschrieben.  Alle 32 ms (Watchdog Timer) wird der Sensor abgefragt.  Abh√§ngig vom aktuellen Status und der Dauer des Dr√ºckens werden bestimmte Aktionen ausgef√ºhrt.  Die Arbeitslogik unterscheidet sich geringf√ºgig vom Prototyp <em>K145AP2</em> </p><br><p>  Wenn das Licht ausgeschaltet ist (Zustand nach dem Einschalten): </p><br><ul><li>  Durch kurzes Dr√ºcken wird die Beleuchtung auf derselben Stufe eingeschaltet, auf der sie ausgeschaltet wurde.  Beim ersten Einschalten bei maximaler Helligkeit </li><li>  Durch langes Dr√ºcken wird das Licht auf maximaler Stufe eingeschaltet. </li></ul><br><p>  Wenn das Licht an ist: </p><br><ul><li>  Ein kurzer Druck macht das Licht aus </li><li>  Ein langes Dr√ºcken √§ndert die Helligkeit.  Die Richtung der Helligkeits√§nderung √§ndert sich durch wiederholtes langes Dr√ºcken </li></ul><br><p>  Zu kurze Druckvorg√§nge (Interferenzen) durch das Programm werden ignoriert.  Die Helligkeit wird durch den PWM-Koeffizienten (16 Bit) eingestellt.  PWM-Frequenz ca. 122 Hz (8.000.000 Hz / 2 <sup>16</sup> ‚âà 122 Hz) </p><br><p>  <strong>Um die psychophysiologische Wahrnehmung der Helligkeit der Beleuchtung von der tats√§chlichen Helligkeit zu kompensieren, tritt eine √Ñnderung der letzteren entlang eines Teils der kubischen Parabel auf</strong> .  Normalerweise werden hierf√ºr Tabellen verwendet, aber in meiner Version wird der Koeffizient berechnet.  Der Koeffizient variiert mit der PWM-Frequenz, dh wenn sich die Helligkeit √§ndert, wird jeder Impuls mit seiner eigenen Dauer erhalten.  Der minimale PWM-Wert ist softwarebegrenzt. </p><br><p>  Meistens schl√§ft MK und verbraucht zusammen mit <em>TTP223</em> etwa 16 Mikroampere.  Das hei√üt, die Schaltung ist f√ºr Ger√§te mit autonomer Leistung gut geeignet. </p><br><p>  <em>ATtiny4 hat</em> sechs Pins.  Zwei f√ºr die Stromversorgung, eine Standardeinstellung f√ºr das Zur√ºcksetzen.  Ich habe bereits zwei beteiligt.  Nur noch einer √ºbrig.  Ich dachte, wie man es benutzt.  Und dann erinnerte ich mich an den Laptop eines neuen Freundes mit Force Touch-Trackpad.  Als Experiment habe ich beschlossen, etwas √Ñhnliches zu tun.  Ich brauche nicht viel Zuverl√§ssigkeit der Antwort und es gibt viele Vibromotoren von alten Telefonen.  Infolgedessen habe ich eine solche Funktion in das Programm implementiert, dass an einem freien Ausgang ein kurzer Impuls auftritt, wenn die Einstellgrenze erreicht ist.  In <em>K145AP2 √§ndert sich</em> die Einstellrichtung <em>,</em> wenn die Einstellgrenze erreicht ist.  Daher waren einige F√§higkeiten erforderlich, um die Hand maximal oder minimal vom Sensor zu entfernen.  In meiner Implementierung stoppt die Anpassung, wenn die Grenze erreicht ist.  Die gesamte Anpassungszeit von einer Grenze zur anderen betr√§gt ca. 4 Sekunden. </p><br><p>  Code auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" title="Schieben Sie es!">GitHub</a> verf√ºgbar </p><br><h4 id="tpi-cherez-arduinu">  TPI √ºber Arduino </h4><br><p>  Separat nehme ich die Programmierung von MK zur Kenntnis.  Mein <em>JTAGICE3</em> unterst√ºtzt keine TPI-Programmierschnittstelle.  Aber zum Gl√ºck haben <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gute Leute eine Skizze √ºber Arduin geschrieben</a> , um dieses kleine Ding zu programmieren.  Nicht sofort, aber alles hat f√ºr mich geklappt, die Firmware war √ºberflutet und alles hat funktioniert.  Zus√§tzlich zu Arduinen werden 4 Widerst√§nde ben√∂tigt.  Der gesamte Prozess wird in einer Skizze gemalt. </p><br><h4 id="itog">  Zusammenfassung </h4><br><p>  Der magische Knopf ist installiert und funktioniert wie vorgesehen.  Der Stromverbrauch und die Abmessungen erm√∂glichen die Einbettung in Ger√§te mit autonomer Stromversorgung. </p><br><p>  Ich habe nicht den erwarteten Effekt von der Vibration bekommen.  Hier sind offenbar Experimente mit dem Installationsort erforderlich. </p><br><p>  Im Prototyp <em>K145AP2</em> und im <em>Siemens S576B-</em> Analogon gibt es eine Schlussfolgerung "Schlaf".  Dies ist ein solcher Modus, in dem die Helligkeit sehr langsam abf√§llt, bis sie vollst√§ndig ausgeschaltet ist.  Wie vom Hersteller geplant, wird hierf√ºr ein zus√§tzlicher Sensor in der N√§he des Kopfes des Bettes installiert.  16 Bit des PWM-Timers aktivieren diesen Modus. </p><br><p>  Dies ist aus Ideen f√ºr die Zukunft. </p><br><div class="spoiler">  <b class="spoiler_title">Knopf an Ort und Stelle</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/757/2da/2b5/7572da2b50cf61fc18aef6e609b80650.jpg" alt="cooles Bild"></p></div></div><br><p>  Wie alles. </p><br><p>  Danke an alle! </p><br><p>  UPD: Wie versprochen habe ich die PWM-Frequenz auf fast 1 kHz erh√∂ht.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" title="Schieben Sie es!">Github-</a> Code </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de411263/">https://habr.com/ru/post/de411263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de411253/index.html">Die Verschmelzung von Neutronensternen setzte den Alternativen von Dunkler Materie und Dunkler Energie ein Ende</a></li>
<li><a href="../de411255/index.html">Dezentrale Apps f√ºr Millionen von Benutzern auf Ethereum</a></li>
<li><a href="../de411257/index.html">In den USA schaffen sie ein Lasersystem, das den Feind mit Ger√§uschen erschreckt</a></li>
<li><a href="../de411259/index.html">Wir verbinden einen Wasserz√§hler mit einem Smart Home</a></li>
<li><a href="../de411261/index.html">Vibrationsreaktion in Prothesen: Ein neuer Weg, um die Kontrolle √ºber bionische Gliedma√üen zu verbessern</a></li>
<li><a href="../de411265/index.html">Spionagef√§lle (Teil 3)</a></li>
<li><a href="../de411267/index.html">Wer steckt wirklich hinter den neuen Smartphones der Marke Nokia?</a></li>
<li><a href="../de411269/index.html">Die drei Komponenten von ‚ÄûLOAD‚Äú</a></li>
<li><a href="../de411271/index.html">Das Elektroauto Tesla Autopilot verheddert sich auf schwierigen Stra√üenabschnitten</a></li>
<li><a href="../de411273/index.html">Die erste Studie zur Attraktivit√§t von Robolits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>