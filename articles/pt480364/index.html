<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèº üõÄ üíå Metaf√≠sica da inje√ß√£o de depend√™ncia ‚úâÔ∏è üéÑ üë®üèæ‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inje√ß√£o de Depend√™ncia √© uma t√©cnica comumente usada em programa√ß√£o orientada a objetos, projetada para reduzir a conectividade de componentes. Quando...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Metaf√≠sica da inje√ß√£o de depend√™ncia</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480364/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/bp/ha/dz/bphadz2idyr738uoocd_ykof4zm.png" alt="imagem"></div><br><br>  Inje√ß√£o de Depend√™ncia √© uma t√©cnica comumente usada em programa√ß√£o orientada a objetos, projetada para reduzir a conectividade de componentes.  Quando usado corretamente, al√©m de atingir esse objetivo, pode trazer qualidades verdadeiramente m√°gicas para suas aplica√ß√µes.  Como qualquer m√°gica, essa t√©cnica √© percebida como um conjunto de feiti√ßos, e n√£o como um tratado cient√≠fico rigoroso.  Isso leva a uma m√° interpreta√ß√£o dos fen√¥menos e, como conseq√º√™ncia, ao mau uso de artefatos.  Em meu material autoral, sugiro que o leitor, passo a passo, curta e em ess√™ncia, siga o caminho l√≥gico dos fundamentos apropriados do design orientado a objetos at√© a pr√≥pria m√°gica da inje√ß√£o autom√°tica de depend√™ncia. <br><a name="habracut"></a><br>  O material √© baseado no desenvolvimento do <a href="https://github.com/cylon-v/hypo" rel="nofollow">container Hypo IoC</a> , que mencionei em um <a href="https://habr.com/ru/post/474504/">artigo anterior</a> .  Em exemplos de c√≥digo em miniatura, usarei o Ruby como uma das linguagens orientadas a objetos mais concisas para escrever exemplos curtos.  Isso n√£o deve causar problemas para os desenvolvedores de outros idiomas entenderem. <br><br><h2>  N√≠vel 1: Princ√≠pio da invers√£o de depend√™ncia </h2><br>  Os desenvolvedores no paradigma orientado a objetos s√£o confrontados diariamente com a cria√ß√£o de objetos, que, por sua vez, podem depender de outros objetos.  Isso leva a um gr√°fico de depend√™ncia.  Suponha que estamos lidando com um modelo de objeto do formul√°rio: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ih/b7/vy/ihb7vyogm2d5rt-ugz_udhskzpy.png" alt="imagem"></div><br>  - algum servi√ßo de cobran√ßa (InvoiceProcessor) e servi√ßo de notifica√ß√£o (NotificationService).  O servi√ßo de processamento de faturas envia notifica√ß√µes quando certas condi√ß√µes s√£o atendidas. Vamos tirar essa l√≥gica do escopo.  Em princ√≠pio, esse modelo j√° √© bom, pois os componentes individuais s√£o respons√°veis ‚Äã‚Äãpor diferentes responsabilidades.  O problema est√° em como implementamos essas depend√™ncias.  Um erro comum √© inicializar uma depend√™ncia em que essa depend√™ncia √© usada: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">process</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#      notificationService = NotificationService.new notificationService.notify(invoice.owner) end end</span></span></span></span></code> </pre> <br>  Isso √© um erro, visto que obtemos alta conectividade de objetos logicamente independentes (High Coupling).  Isso leva a uma viola√ß√£o do Princ√≠pio da Responsabilidade √önica - um objeto dependente, al√©m de suas responsabilidades imediatas, deve inicializar suas depend√™ncias;  e tamb√©m ‚Äúconhece‚Äù a interface do construtor de depend√™ncia, o que levar√° a um motivo adicional de mudan√ßa ( <a href="https://blog.cleancoder.com/uncle-bob/2014/05/08/SingleReponsibilityPrinciple.html" rel="nofollow">‚Äúmotivo para mudar‚Äù, R. Martin</a> ).  √â mais correto passar esse tipo de depend√™ncia, inicializada fora do objeto dependente: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">process</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">owner</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationService</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoiceProcessor</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">)</span></span></code> </pre><br>  Essa abordagem √© consistente com o Princ√≠pio da invers√£o de depend√™ncia.  Agora estamos transferindo um objeto com uma interface de envio de mensagens - n√£o √© mais necess√°rio que o servi√ßo de cobran√ßa "saiba" como construir o objeto de servi√ßo de notifica√ß√£o.  Ao escrever testes de unidade para um servi√ßo de processamento de faturas, o desenvolvedor n√£o precisa entender como substituir a implementa√ß√£o da interface do servi√ßo de notifica√ß√£o por um stub.  Em idiomas com digita√ß√£o din√¢mica, como Ruby, voc√™ pode substituir qualquer objeto que atenda ao m√©todo de notifica√ß√£o;  com digita√ß√£o est√°tica, como C # / Java, voc√™ pode usar a interface INotificationService, para a qual √© f√°cil criar um Mock.  A quest√£o da invers√£o de depend√™ncia foi divulgada em detalhes por Alexander Byndyu <a href="https://blog.byndyu.ru/2009/12/blog-post.html" rel="nofollow">em um artigo</a> que comemorou recentemente seu 10¬∫ anivers√°rio! <br><br><h2>  N√≠vel 2: registro de objetos relacionados </h2><br>  Usar o princ√≠pio de invers√£o de depend√™ncia n√£o parece uma pr√°tica complicada.  Mas com o tempo, devido a um aumento no n√∫mero de objetos e relacionamentos, novos desafios aparecem.  NotificationService pode ser usado por outros servi√ßos que n√£o o InvoiceProcessor.  Al√©m disso, ele pr√≥prio pode depender de outros servi√ßos, que, por sua vez, dependem de terceiros, etc.  Al√©m disso, alguns componentes nem sempre podem ser usados ‚Äã‚Äãem uma √∫nica c√≥pia.  A principal tarefa √© encontrar a resposta para a pergunta - ‚Äúquando criar depend√™ncias?‚Äù. <br>  Para resolver esse problema, voc√™ pode tentar criar uma solu√ß√£o baseada em uma matriz associativa de depend√™ncias.  Um exemplo de interface de seu trabalho pode ser assim: <br><br><pre> <code class="ruby hljs">registry.add(InvoiceProcessor) .depends_on(NotificationService) registry.add(NotificationService) .depends_on(ServiceX) invoiceProcessor = registry.resolve(InvoiceProcessor) invoiceProcessor.process(invoice)</code> </pre><br>  N√£o √© dif√≠cil de implementar na pr√°tica: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rd/bj/v4/rdbjv49agcxw3fhhask4uv5ysew.png" alt="imagem"></div><br>  Cada vez que container.resolve () √© chamado, iremos para a f√°brica, que criar√° inst√¢ncias de depend√™ncia, ignorando recursivamente o gr√°fico de depend√™ncia descrito no registro.  No caso de `container.resolve (InvoiceProcessor)`, o seguinte ser√° executado: <br><br><ol><li>  factory.resolve (InvoiceProcessor) - a f√°brica solicita as depend√™ncias InvoiceProcessor no registro, recebe um NotificationService, que tamb√©m precisa ser montado. </li><li>  factory.resolve (NotificationService) - a f√°brica solicita as depend√™ncias NotificationService no registro e recebe o ServiceX, que tamb√©m precisa ser montado. </li><li>  factory.resolve (ServiceX) - n√£o possui depend√™ncias, cria, retorna ao longo da pilha de chamadas para a etapa 1, obt√©m um objeto montado do tipo InvoiceProcessor. </li></ol><br>  Cada componente pode depender de v√°rios outros, portanto, a pergunta √≥bvia √© ‚Äúcomo combinar corretamente os par√¢metros do designer com as inst√¢ncias de depend√™ncia resultantes?‚Äù.  Um exemplo: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paymentService</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end</span></span></span></span></code> </pre><br>  Em idiomas com digita√ß√£o est√°tica, o tipo de par√¢metro pode servir como seletor: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(notificationService: NotificationService, paymentService: PaymentService) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  No Ruby, voc√™ pode usar a conven√ß√£o - basta usar o nome do tipo no formato snake_case, este ser√° o nome do par√¢metro esperado. <br><br><h2>  N√≠vel 3: gerenciamento de vida √∫til da depend√™ncia </h2><br>  J√° temos uma boa solu√ß√£o de gerenciamento de depend√™ncias.  Sua √∫nica limita√ß√£o √© a necessidade de criar uma nova inst√¢ncia da depend√™ncia a cada chamada.  Mas e se n√£o pudermos criar mais de uma inst√¢ncia de um componente?  Por exemplo, um conjunto de conex√µes com o banco de dados.  Aprofundar e se precisarmos fornecer uma vida √∫til controlada de depend√™ncias?  Por exemplo, feche a conex√£o com o banco de dados ap√≥s a conclus√£o da solicita√ß√£o HTTP. <br>  Torna-se aparente que o candidato para substitui√ß√£o na solu√ß√£o original √© InstanceFactory.  Gr√°fico atualizado: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/ed/xl/hfedxlxxnqjmm22oevtbwqrle2k.png" alt="imagem"></div><br>  E a solu√ß√£o l√≥gica √© usar um conjunto de estrat√©gias ( <a href="https://refactoring.guru/ru/design-patterns/strategy" rel="nofollow">Estrat√©gia, GoF</a> ) para obter inst√¢ncias de componentes.  Agora, nem sempre criamos novas inst√¢ncias ao chamar Container :: resolve, portanto, √© apropriado renomear Factory para Resolver.  Observe que o m√©todo Container :: register possui um novo par√¢metro - life_time (life).  Este par√¢metro √© opcional - por padr√£o, seu valor √© "transit√≥rio" (transit√≥rio), que corresponde ao comportamento implementado anteriormente.  A estrat√©gia singleton tamb√©m √© √≥bvia - com seu uso, apenas uma inst√¢ncia do componente √© criada, que ser√° retornada toda vez. <br>  O escopo √© uma estrat√©gia um pouco mais complexa.  Em vez de "caminhos transit√≥rios" e "solit√°rios", muitas vezes √© necess√°rio usar algo intermedi√°rio - um componente que existe ao longo da vida de outro componente.  Um exemplo semelhante pode ser um objeto de solicita√ß√£o de aplicativo da web, que √© o contexto da exist√™ncia de objetos como, por exemplo, par√¢metros HTTP, conex√£o com o banco de dados, agregados de modelo.  Durante toda a vida √∫til da solicita√ß√£o, coletamos e usamos essas depend√™ncias e, ap√≥s sua destrui√ß√£o, esperamos que todas elas tamb√©m sejam destru√≠das.  Para implementar essa funcionalidade, ser√° necess√°rio desenvolver uma estrutura de objetos fechados bastante complexa: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vd/97/hh/vd97hhi_p41keoxph7ku9sdxrdm.png" alt="imagem"></div><br>  O diagrama mostra um fragmento refletindo altera√ß√µes nas classes Component e LifetimeStrategy no contexto da implementa√ß√£o da vida √∫til do escopo.  O resultado foi uma esp√©cie de "ponte dupla" (semelhante ao modelo <a href="https://refactoring.guru/ru/design-patterns/bridge" rel="nofollow">Bridge, GoF</a> ).  Usando os meandros das t√©cnicas de heran√ßa e agrega√ß√£o, o Component se torna o n√∫cleo do cont√™iner.  A prop√≥sito, o diagrama tem heran√ßa m√∫ltipla.  Onde a linguagem de programa√ß√£o e a consci√™ncia permitirem, voc√™ pode deixar assim.  No Ruby, eu uso impurezas; em outros idiomas, voc√™ pode substituir a heran√ßa por outra ponte: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ri/dj/h7/ridjh7shgaolxp_mxujgvkueta4.png" alt="imagem"></div><br>  O diagrama de sequ√™ncia mostra o ciclo de vida do componente da sess√£o, que est√° vinculado √† vida √∫til do componente de solicita√ß√£o: <br><br><img src="https://habrastorage.org/webt/-c/im/bt/-cimbtr3sktosriryzoyrtqxht4.png" alt="imagem"><br><br>  Como voc√™ pode ver no diagrama, em um determinado momento, quando o componente de solicita√ß√£o completa sua miss√£o, √© chamado o m√©todo de libera√ß√£o, que inicia o processo de destrui√ß√£o do escopo. <br><br><h2>  N√≠vel 4: Inje√ß√£o de Depend√™ncia </h2><br>  At√© agora, falei sobre como determinar o registro de depend√™ncias e como criar e destruir componentes de acordo com o gr√°fico das rela√ß√µes formadas.  E para que serve?  Suponha que usamos isso como parte do Ruby on Rails: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registry</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resolve</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceRepository</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_processor</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registry</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resolve</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">find</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_processor</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  O c√≥digo que ser√° escrito dessa maneira n√£o ser√° mais leg√≠vel, test√°vel ou flex√≠vel.  N√£o podemos ‚Äúfor√ßar‚Äù o Rails a injetar depend√™ncias do controlador por meio de seu construtor, o que n√£o √© fornecido pela estrutura.  Mas, por exemplo, no ASP.NET MVC, isso √© implementado em um n√≠vel b√°sico.  Para aproveitar ao m√°ximo o uso do mecanismo autom√°tico de resolu√ß√£o de depend√™ncias, √© necess√°rio implementar a t√©cnica Inversion of Control (IoC, inversion of control).  Essa √© uma abordagem na qual a responsabilidade pela resolu√ß√£o de depend√™ncias vai al√©m do escopo do c√≥digo do aplicativo e fica com a estrutura.  Considere um exemplo. <br>  Imagine que estamos projetando algo como Rails do zero.  Implementamos o seguinte esquema: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/bg/bh/y1bgbh_27yevoryv4ntb58nej9w.png" alt="imagem"></div><br>  O aplicativo recebe a solicita√ß√£o, o roteador recupera os par√¢metros e instrui o controlador apropriado a processar essa solicita√ß√£o.  Esse esquema copia condicionalmente o comportamento de uma estrutura da Web t√≠pica com apenas uma pequena diferen√ßa - o cont√™iner de IoC est√° envolvido na cria√ß√£o e implementa√ß√£o de depend√™ncias.  Mas aqui surge a quest√£o: onde o pr√≥prio cont√™iner √© criado?  Para cobrir o maior n√∫mero poss√≠vel de objetos da futura aplica√ß√£o, nossa estrutura deve criar um cont√™iner no est√°gio inicial de sua opera√ß√£o.  Obviamente, n√£o h√° lugar mais adequado do que o criador de aplicativos.  √â tamb√©m o local mais adequado para configurar todas as depend√™ncias: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#   - ,      . def initialize </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Container.new </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(Controller) .using_lifetime(:transient) # ,     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(InvoiceService) .using_lifetime(:singleton) # ,     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(Router) .using_lifetime(:singleton) #  end #     -     , #      . def call(env) router = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.resolve(Router) router.handle(env.path, env.method, env.params) end end</span></span></span></span></code> </pre><br>  Qualquer aplicativo tem um ponto de entrada, por exemplo, o m√©todo principal.  Neste exemplo, o ponto de entrada √© o m√©todo de chamada.  O objetivo deste m√©todo √© chamar o roteador para processar solicita√ß√µes recebidas.  O ponto de entrada deve ser o √∫nico local para ligar diretamente para o cont√™iner - a partir desse momento, o cont√™iner deve ser esquecido, toda a magia subsequente deve ocorrer "sob o cap√¥".  A implementa√ß√£o do controlador dentro dessa arquitetura realmente parece incomum.  Apesar do fato de n√£o ser instanciado explicitamente, ele possui um construtor com par√¢metros: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#   . #    . def initialize(invoice_service) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@invoice</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_service = invoice_service end def create_invoice(params) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@invoice</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_service.create(params) end end</span></span></span></span></code> </pre><br>  O ambiente "entende" como criar inst√¢ncias do controlador.  Isso √© poss√≠vel gra√ßas ao mecanismo de inje√ß√£o de depend√™ncia fornecido pelo cont√™iner de IoC incorporado no cora√ß√£o do aplicativo da web.  No construtor do controlador, agora voc√™ pode listar tudo o que √© necess√°rio para sua opera√ß√£o.  O principal √© que os componentes correspondentes sejam registrados no cont√™iner.  Agora vamos passar para a implementa√ß√£o do roteador: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#         -  #      #     . def initialize(controller) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@controller</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = controller end def handle(path, method, params) #  ""- if path == '/invoices' &amp;&amp; method == 'POST' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@controller</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.create(params) end end end</span></span></span></span></code> </pre><br>  Observe que o roteador depende do controlador.  Se recordarmos as configura√ß√µes de depend√™ncia, o Controlador √© um componente de vida curta e o Roteador, um solit√°rio constante.  Como isso pode ser?  A resposta √© que os componentes n√£o s√£o inst√¢ncias das classes correspondentes, como parece externamente.  De fato, esses s√£o objetos proxy ( <a href="https://refactoring.guru/ru/design-patterns/proxy" rel="nofollow">Proxy, GoF</a> ) com a inst√¢ncia do m√©todo factory ( <a href="https://refactoring.guru/ru/design-patterns/factory-method" rel="nofollow">Factory Method, GoF</a> );  eles retornam uma inst√¢ncia do componente de acordo com a estrat√©gia atribu√≠da.  Como o controlador est√° registrado como "transit√≥rio", o roteador sempre lidar√° com sua nova inst√¢ncia quando for acessado.  O diagrama de seq√º√™ncia mostra um mecanismo aproximado de trabalho: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tl/ng/1y/tlng1yrikuvxkenacsx-gy0x7mu.png" alt="imagem"></div><br>  I.e.  Al√©m do gerenciamento de depend√™ncias, uma boa estrutura baseada em um cont√™iner de IoC tamb√©m assume a responsabilidade pelo gerenciamento correto da vida √∫til dos componentes. <br><br><h2>  Conclus√£o </h2><br>  A t√©cnica de inje√ß√£o de depend√™ncia pode ter uma implementa√ß√£o interna bastante sofisticada.  Esse √© o pre√ßo de transferir a complexidade da implementa√ß√£o de aplicativos flex√≠veis para o n√∫cleo da estrutura.  O usu√°rio de tais estruturas n√£o pode se preocupar com os aspectos puramente t√©cnicos, mas dedica mais tempo ao desenvolvimento confort√°vel da l√≥gica de neg√≥cios dos programas aplicativos.  Usando uma implementa√ß√£o de DI de alta qualidade, um programador de aplicativo inicialmente escreve c√≥digo test√°vel e bem suportado.  Um bom exemplo da implementa√ß√£o da Inje√ß√£o de Depend√™ncias √© a estrutura <a href="https://github.com/cylon-v/dandy" rel="nofollow">Dandy</a> descrita no meu artigo anterior, <a href="https://habr.com/ru/post/474504/">Orthodox Backend</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480364/">https://habr.com/ru/post/pt480364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480352/index.html">O geneticista de Harvard est√° desenvolvendo um prot√≥tipo de aplicativo de namoro com DNA</a></li>
<li><a href="../pt480354/index.html">Introdu√ß√£o aos m√©todos de matriz JavaScript .map (), .filter () e .reduce ()</a></li>
<li><a href="../pt480356/index.html">Dicas √∫teis sobre Python que voc√™ n√£o conheceu</a></li>
<li><a href="../pt480358/index.html">O pre√ßo oculto das bibliotecas CSS-in-JS nos aplicativos React</a></li>
<li><a href="../pt480362/index.html">Aventuras do hexafluoreto de ur√¢nio empobrecido alem√£o na R√∫ssia. Parte 1. Hist√≥ria e tecnologias de enriquecimento</a></li>
<li><a href="../pt480368/index.html">Captura de vazamentos de mem√≥ria em C / C ++</a></li>
<li><a href="../pt480370/index.html">Confer√™ncia DEFCON 19. Os chefes adoram o Excel, os hackers tamb√©m</a></li>
<li><a href="../pt480374/index.html">Reagir √† DogBot da Robotics: Revolu√ß√£o na Ind√∫stria da Constru√ß√£o</a></li>
<li><a href="../pt480376/index.html">De jogos de computador a mensagens secretas: discuta ovos de P√°scoa em lan√ßamentos de vinil</a></li>
<li><a href="../pt480378/index.html">14 projetos de c√≥digo aberto para aprimorar as habilidades de ci√™ncia de dados (f√°cil, normal, dif√≠cil)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>