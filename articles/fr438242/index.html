<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📖 💅🏽 🤶🏽 Compressez la liste des adresses IP de la meilleure façon 👨🏻‍🎨 🖼️ 🚣🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois que j'ai lu sur Habr un article sur la configuration de BGP sur un routeur. Les instructions à partir de là peuvent être utilisées pour confi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compressez la liste des adresses IP de la meilleure façon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/438242/"><img src="https://habrastorage.org/webt/xb/cm/03/xbcm03j6a2yijqkxhzatkxq6xbw.jpeg"><br><br>  Une fois que j'ai lu sur Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> sur la configuration de BGP sur un routeur.  Les instructions à partir de là peuvent être utilisées pour configurer le routeur domestique afin que le trafic vers des adresses IP spécifiques passe par un autre canal.  Cependant, il y a un problème: la liste des adresses IP peut être très longue. <br><br>  En plus des réseaux de la liste, les plus grands sous-réseaux communs des réseaux voisins sont ajoutés à ce graphique.  Lisez la suite pour savoir pourquoi cela est nécessaire. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fh/pf/er/fhpfer-kqivtgto-agnozn9wpos.png"><br>  <i>Cela ressemblait à une arborescence de réseau de Roskomnadzor en mai 2018.</i> <br><br>  Tout d'abord, j'ai essayé d'ajouter la liste complète via / ip route add à mon MikroTik hAP ac lite - le routeur a manqué d'espace disque.  Ensuite, j'ai chargé toutes les adresses en mémoire via BGP - le routeur fonctionnait un peu et se bloquait.  Il est devenu évident que la liste devait être réduite. <br><br>  L' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> mentionne l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire</a> network-list-parser d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Unsacrificed</a> .  Elle fait ce dont j'ai besoin, mais je l'ai vue après avoir commencé à inventer mon vélo.  Ensuite, je l'ai terminé par intérêt, car ce que j'ai fait fonctionne mieux, bien que beaucoup plus lentement. <br><br>  Donc, l'énoncé du problème: vous devez écrire un script qui prend une liste d'adresses IP et de réseaux en entrée et la raccourcit à la taille spécifiée.  Dans ce cas, la nouvelle liste doit couvrir toutes les adresses de l'ancienne, et le nombre de nouvelles adresses forcées à y être ajoutées doit être minimal. <br><br>  Commençons par construire un graphique de tous les réseaux sources (ce qui est dans l'image ci-dessus).  Le nœud racine sera le réseau 0.0.0.0/0.  Lors de l'ajout d'un nouveau sous-réseau A, nous trouvons le sous-réseau B dans l'arborescence afin que A et B se trouvent sur le sous-réseau C et que la taille du sous-réseau C soit minimale (masque maximal).  En d'autres termes, le nombre de bits communs des sous-réseaux A et B doit être maximum.  Nous ajoutons ce sous-réseau commun à l'arbre, et à l'intérieur nous transférons les sous-réseaux A et B. Peut-être que cela peut être appelé un arbre binaire. <br><br>  Par exemple, créez une arborescence de deux sous-réseaux (192.168.0.1/32 et 192.168.33.0/24): <br><br><img src="https://habrastorage.org/webt/5d/ts/tx/5dtstx3shvofo6npuytk5n0kcto.png"><br><br>  Obtenez l'arbre: <br><br><img src="https://habrastorage.org/webt/la/5b/ej/la5bejewneridokbs_-fkahmz1y.png"><br><br>  Si nous ajoutons, disons, le réseau 192.168.150.150/32, alors l'arborescence ressemblera à ceci: <br><br><img src="https://habrastorage.org/webt/-r/yp/om/-rypomiatbn-l5hlfq86wzcgal8.png"><br><br>  L'orange indique les sous-réseaux communs ajoutés lors de la construction des arbres.  Ce sont ces sous-réseaux communs que nous allons «réduire» pour réduire la taille de la liste.  Par exemple, si vous réduisez le nœud 192.168.0.0/16, nous réduirons la taille de la liste des réseaux de 2 (il y avait 3 réseaux de la liste d'origine, elle est devenue 1), mais en même temps, nous couvrons également les adresses IP 65536-1-1-256 = 65278, qui non inclus dans notre liste d'origine. <br><br>  Il est pratique pour chaque nœud de calculer le «coefficient de profit de l'effondrement», en indiquant le nombre d'adresses IP qui seront en outre ajoutées à chacune des entrées supprimées de la liste: <br><br><pre><code class="plaintext hljs">weight_reversed = net_extra_ip_volume / (in_list_records_count - 1)</code> </pre> <br>  Nous utiliserons weight = 1 / weight_reversed, comme  c'est plus pratique.  Il est curieux que le poids puisse être égal à l'infini si, par exemple, il y a deux / 32 réseaux dans la liste, qui forment ensemble un grand réseau / 31. <br><br>  Ainsi, plus le poids est important, plus il est rentable d'effondrer un tel réseau. <br><br>  Vous pouvez maintenant calculer le poids de tous les nœuds du réseau, trier les nœuds par poids et réduire les sous-réseaux jusqu'à obtenir la taille de la liste dont nous avons besoin.  Cependant, il y a une difficulté: au moment où nous effondrons un réseau, les poids de tous les réseaux parents changent. <br><br>  Par exemple, nous avons un arbre avec des poids calculés: <br><br><img src="https://habrastorage.org/webt/mn/wd/60/mnwd60e30yeamoqjg3veobslqcc.png"><br><br>  Réduisons le sous-réseau 192.168.0.0/30: <br><br><img src="https://habrastorage.org/webt/3q/zf/tm/3qzftmtvi-ctpw9_ebniki7cvkm.png"><br><br>  Le poids du nœud parent a diminué.  S'il y a des nœuds dans l'arbre avec un poids supérieur à 0,166, les éléments suivants doivent être réduits. <br><br>  En conséquence, la liste doit être compressée récursivement.  L'algorithme est quelque chose comme ceci: <br><br><ol><li>  Nous calculons les poids pour tous les nœuds. </li><li>  Pour chaque nœud, stockez le poids maximal du nœud enfant (Wmax). </li><li>  Il s'avère que Wmax du nœud racine est le poids maximum du nœud dans l'arbre entier (il peut y avoir plusieurs nœuds avec un poids égal à Wmax). </li><li>  Compressez récursivement tous les réseaux avec un poids égal à Wmax du nœud racine.  Dans ce cas, nous recomptons les poids.  Nous revenons au nœud racine. </li><li>  Wmax du nœud racine a diminué - nous effectuons l'étape 4 jusqu'à ce que nous obtenions la taille souhaitée de la liste des réseaux. </li></ol><br>  La chose la plus intéressante est d'observer l'algorithme en mouvement.  Voici un exemple de liste de réseaux: <br><br> <code>192.168.0.1 <br> 192.168.0.2 <br> 192.168.0.8/29 <br> 192.168.150.1 <br> 192.168.150.2 <br> 192.168.150.8/29 <br> 192.168.20.1 <br> 192.168.20.2 <br> 192.168.20.3 <br> 192.168.20.4 <br> 192.168.20.5 <br> 192.168.20.6 <br> 192.168.20.7</code> <br> <br>  Ici, les sous-réseaux 192.168.0.0/24 et 192.168.150.0/24 ont une structure identique - il est préférable de voir comment, pendant la compression, l'algorithme saute d'une branche à l'autre.  Il a ajouté le sous-réseau 192.168.20.0/24 afin de montrer qu'il est parfois plus rentable de compresser le réseau parent que le réseau enfant.  Faites attention au sous-réseau 192.168.20.0/30: après avoir rempli l'arbre, son poids est inférieur à celui du sous-réseau parent. <br><br>  Remplissage d'arbres: <br><br><img src="https://habrastorage.org/webt/db/7y/od/db7yodt6w5mvgq_rvxxoe5k4lq8.gif"><br><br>  Ici, la police noire est le véritable réseau de la liste d'origine.  Jaune - réseaux ajoutés.  Le bleu est le poids du nœud.  Le rouge est le réseau actuel.  Le rose est un filet effondré. <br><br>  La compression <br><br><img src="https://habrastorage.org/webt/wp/wr/0j/wpwr0j57ms67jp4xdpmhzjkpnpy.gif"><br><br>  Il y avait une idée pour accélérer l'algorithme d'effondrement du réseau: pour cela, il n'est pas nécessaire d'effondrer uniquement les réseaux avec un poids maximum à chaque itération.  Vous pouvez présélectionner la valeur de poids, qui nous donnera une liste de la taille souhaitée.  Vous pouvez sélectionner par recherche binaire, c'est-à-dire  compresser avec un certain poids et voir quelle taille de la liste est obtenue à la sortie.  Certes, pour cela, vous avez besoin de deux fois plus de mémoire et de réécrire le code - je n'ai tout simplement pas mis la main dessus. <br><br>  Il reste maintenant à comparer avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">network-list-parser</a> de l'article sur BGP. <br><br>  Avantages de mon script: <br><br><ol><li>  Configuration plus pratique: spécifiez simplement la taille requise de la liste des réseaux, et la sortie sera une liste exactement de cette taille.  Network-list-parser a beaucoup de descripteurs, et vous devez en trouver une combinaison. </li><li>  Le taux de compression s'adapte à la liste d'origine.  Si nous supprimons certains réseaux de la liste, nous obtiendrons moins d'adresses supplémentaires, si nous en ajoutons plus.  Dans ce cas, la taille de la liste résultante sera constante.  Vous pouvez choisir la taille maximale que le routeur peut gérer et ne vous inquiétez pas si la liste devient trop longue à un moment donné. </li><li>  La liste résultante contient le nombre minimum possible de réseaux supplémentaires.  Sur la liste de tests de GitHub, mon algorithme a donné 718479 adresses IP supplémentaires et analyseur de liste de réseaux - 798761. <b>La différence n'est que de 10%</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Comment ai-je calculé cela?</b>  <b class="spoiler_title">Regarder</b> <div class="spoiler_text">  1. Lancement <br><br><pre> <code class="plaintext hljs"> ./network-list-parser-darwin-386-1.2.bin -src-file real_net_list_example.txt -dst-file parsed.txt -aggregation-max-fake-ips 0 -intensive-aggregation-min-prefix 31 2&gt;&amp;1</code> </pre> <br>  et nous obtenons une liste nettoyée sans ordures et partiellement réduite.  Je vais comparer la qualité de compression de parsed.txt.  (sans cette étape, il y a eu des problèmes pour évaluer le nombre de fausses adresses réseau-liste-parseur). <br><br>  2. Lancement <br><br><pre> <code class="plaintext hljs">./network-list-parser-darwin-386-1.2.bin -src-file parsed.txt -dst-file parsed1.txt 2&gt;&amp;1</code> </pre> <br>  et nous obtenons une liste compressée, regardez la sortie, il y a la ligne "Ajouter une couverture IP de 7,3% (798761)." <br><br>  Le fichier parsed1.txt contient 16649 entrées. <br><br>  3. Lancement <br><br>  python3 minimise_net_list.py parsed.txt 16649. <br>  Nous voyons la ligne ### pas réelle ips: 718479. <br></div></div><br></li></ol><br>  Je ne vois qu'un seul inconvénient du script résultant: il fonctionne depuis longtemps et nécessite beaucoup de mémoire.  Sur mon MacBook, la liste est pressée pendant 5 secondes.  Sur la framboise - <b>une minute et demie</b> .  Avec RyPy3 sur Mac, c'est plus rapide, je ne pouvais pas mettre PyPy3 sur Raspberry.  Network-list-parser vole ça et là. <br><br>  En général, il est logique d'utiliser ce schéma uniquement pour les perfectionnistes, car  il est peu probable que tous les autres dépensent autant de ressources informatiques pour 10% des réseaux enregistrés.  Eh bien, un peu plus pratique, oui. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers le projet sur GitHub</a> <br><br>  Courez comme ceci: <br><br><pre> <code class="plaintext hljs">python3 minimize_net_list.py real_net_list_example.txt 30000 | grep -v ### &gt; result.txt</code> </pre> <br>  En fait, c'est tout. <br><br>  <b>UPD</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Pochemuk</a> dans les commentaires a indiqué une erreur dans le calcul du poids, je l'ai corrigé et maintenant, lors de la compression de la même liste de l'exemple avec les mêmes paramètres, 624925 adresses IP sont ajoutées qui ne figurent pas dans la liste d'origine.  C'est déjà <b>22% mieux</b> que lors du traitement de l'analyseur de liste de réseau <br>  Nouveau code dans la branche non testée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/phoenix-mstu/net_list_minimizer/tree/untested</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438242/">https://habr.com/ru/post/fr438242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438230/index.html">Traduction "Préparez vos applications pour les exigences 64 bits"</a></li>
<li><a href="../fr438234/index.html">Résumé des événements informatiques de février</a></li>
<li><a href="../fr438236/index.html">Confluence pour une base de connaissances publique: changer la conception et mettre en place la séparation linguistique</a></li>
<li><a href="../fr438238/index.html">En tant que designer, je refuse d'appeler les gens «utilisateurs»</a></li>
<li><a href="../fr438240/index.html">Test de charge du CPU et du SSD des hébergeurs cloud: comparer Selectel, Servers, MCS et I. Cloud</a></li>
<li><a href="../fr438244/index.html">Nous traitons de la réglementation cryptographique russe ... en utilisant l'exemple de l'arrestation d'un seigneur de la drogue</a></li>
<li><a href="../fr438248/index.html">GitHub Action Life</a></li>
<li><a href="../fr438250/index.html">L'ignorance des principes de la sécurité de l'information n'exempte pas</a></li>
<li><a href="../fr438252/index.html">Pourquoi n'a pas décollé du portail immobilier. Partie 1</a></li>
<li><a href="../fr438254/index.html">Eclipse lance GlassFish 5.1 pour Java EE 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>