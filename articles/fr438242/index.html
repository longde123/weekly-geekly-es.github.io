<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìñ üíÖüèΩ ü§∂üèΩ Compressez la liste des adresses IP de la meilleure fa√ßon üë®üèª‚Äçüé® üñºÔ∏è üö£üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois que j'ai lu sur Habr un article sur la configuration de BGP sur un routeur. Les instructions √† partir de l√† peuvent √™tre utilis√©es pour confi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compressez la liste des adresses IP de la meilleure fa√ßon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/438242/"><img src="https://habrastorage.org/webt/xb/cm/03/xbcm03j6a2yijqkxhzatkxq6xbw.jpeg"><br><br>  Une fois que j'ai lu sur Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> sur la configuration de BGP sur un routeur.  Les instructions √† partir de l√† peuvent √™tre utilis√©es pour configurer le routeur domestique afin que le trafic vers des adresses IP sp√©cifiques passe par un autre canal.  Cependant, il y a un probl√®me: la liste des adresses IP peut √™tre tr√®s longue. <br><br>  En plus des r√©seaux de la liste, les plus grands sous-r√©seaux communs des r√©seaux voisins sont ajout√©s √† ce graphique.  Lisez la suite pour savoir pourquoi cela est n√©cessaire. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fh/pf/er/fhpfer-kqivtgto-agnozn9wpos.png"><br>  <i>Cela ressemblait √† une arborescence de r√©seau de Roskomnadzor en mai 2018.</i> <br><br>  Tout d'abord, j'ai essay√© d'ajouter la liste compl√®te via / ip route add √† mon MikroTik hAP ac lite - le routeur a manqu√© d'espace disque.  Ensuite, j'ai charg√© toutes les adresses en m√©moire via BGP - le routeur fonctionnait un peu et se bloquait.  Il est devenu √©vident que la liste devait √™tre r√©duite. <br><br>  L' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> mentionne l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire</a> network-list-parser d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Unsacrificed</a> .  Elle fait ce dont j'ai besoin, mais je l'ai vue apr√®s avoir commenc√© √† inventer mon v√©lo.  Ensuite, je l'ai termin√© par int√©r√™t, car ce que j'ai fait fonctionne mieux, bien que beaucoup plus lentement. <br><br>  Donc, l'√©nonc√© du probl√®me: vous devez √©crire un script qui prend une liste d'adresses IP et de r√©seaux en entr√©e et la raccourcit √† la taille sp√©cifi√©e.  Dans ce cas, la nouvelle liste doit couvrir toutes les adresses de l'ancienne, et le nombre de nouvelles adresses forc√©es √† y √™tre ajout√©es doit √™tre minimal. <br><br>  Commen√ßons par construire un graphique de tous les r√©seaux sources (ce qui est dans l'image ci-dessus).  Le n≈ìud racine sera le r√©seau 0.0.0.0/0.  Lors de l'ajout d'un nouveau sous-r√©seau A, nous trouvons le sous-r√©seau B dans l'arborescence afin que A et B se trouvent sur le sous-r√©seau C et que la taille du sous-r√©seau C soit minimale (masque maximal).  En d'autres termes, le nombre de bits communs des sous-r√©seaux A et B doit √™tre maximum.  Nous ajoutons ce sous-r√©seau commun √† l'arbre, et √† l'int√©rieur nous transf√©rons les sous-r√©seaux A et B. Peut-√™tre que cela peut √™tre appel√© un arbre binaire. <br><br>  Par exemple, cr√©ez une arborescence de deux sous-r√©seaux (192.168.0.1/32 et 192.168.33.0/24): <br><br><img src="https://habrastorage.org/webt/5d/ts/tx/5dtstx3shvofo6npuytk5n0kcto.png"><br><br>  Obtenez l'arbre: <br><br><img src="https://habrastorage.org/webt/la/5b/ej/la5bejewneridokbs_-fkahmz1y.png"><br><br>  Si nous ajoutons, disons, le r√©seau 192.168.150.150/32, alors l'arborescence ressemblera √† ceci: <br><br><img src="https://habrastorage.org/webt/-r/yp/om/-rypomiatbn-l5hlfq86wzcgal8.png"><br><br>  L'orange indique les sous-r√©seaux communs ajout√©s lors de la construction des arbres.  Ce sont ces sous-r√©seaux communs que nous allons ¬´r√©duire¬ª pour r√©duire la taille de la liste.  Par exemple, si vous r√©duisez le n≈ìud 192.168.0.0/16, nous r√©duirons la taille de la liste des r√©seaux de 2 (il y avait 3 r√©seaux de la liste d'origine, elle est devenue 1), mais en m√™me temps, nous couvrons √©galement les adresses IP 65536-1-1-256 = 65278, qui non inclus dans notre liste d'origine. <br><br>  Il est pratique pour chaque n≈ìud de calculer le ¬´coefficient de profit de l'effondrement¬ª, en indiquant le nombre d'adresses IP qui seront en outre ajout√©es √† chacune des entr√©es supprim√©es de la liste: <br><br><pre><code class="plaintext hljs">weight_reversed = net_extra_ip_volume / (in_list_records_count - 1)</code> </pre> <br>  Nous utiliserons weight = 1 / weight_reversed, comme  c'est plus pratique.  Il est curieux que le poids puisse √™tre √©gal √† l'infini si, par exemple, il y a deux / 32 r√©seaux dans la liste, qui forment ensemble un grand r√©seau / 31. <br><br>  Ainsi, plus le poids est important, plus il est rentable d'effondrer un tel r√©seau. <br><br>  Vous pouvez maintenant calculer le poids de tous les n≈ìuds du r√©seau, trier les n≈ìuds par poids et r√©duire les sous-r√©seaux jusqu'√† obtenir la taille de la liste dont nous avons besoin.  Cependant, il y a une difficult√©: au moment o√π nous effondrons un r√©seau, les poids de tous les r√©seaux parents changent. <br><br>  Par exemple, nous avons un arbre avec des poids calcul√©s: <br><br><img src="https://habrastorage.org/webt/mn/wd/60/mnwd60e30yeamoqjg3veobslqcc.png"><br><br>  R√©duisons le sous-r√©seau 192.168.0.0/30: <br><br><img src="https://habrastorage.org/webt/3q/zf/tm/3qzftmtvi-ctpw9_ebniki7cvkm.png"><br><br>  Le poids du n≈ìud parent a diminu√©.  S'il y a des n≈ìuds dans l'arbre avec un poids sup√©rieur √† 0,166, les √©l√©ments suivants doivent √™tre r√©duits. <br><br>  En cons√©quence, la liste doit √™tre compress√©e r√©cursivement.  L'algorithme est quelque chose comme ceci: <br><br><ol><li>  Nous calculons les poids pour tous les n≈ìuds. </li><li>  Pour chaque n≈ìud, stockez le poids maximal du n≈ìud enfant (Wmax). </li><li>  Il s'av√®re que Wmax du n≈ìud racine est le poids maximum du n≈ìud dans l'arbre entier (il peut y avoir plusieurs n≈ìuds avec un poids √©gal √† Wmax). </li><li>  Compressez r√©cursivement tous les r√©seaux avec un poids √©gal √† Wmax du n≈ìud racine.  Dans ce cas, nous recomptons les poids.  Nous revenons au n≈ìud racine. </li><li>  Wmax du n≈ìud racine a diminu√© - nous effectuons l'√©tape 4 jusqu'√† ce que nous obtenions la taille souhait√©e de la liste des r√©seaux. </li></ol><br>  La chose la plus int√©ressante est d'observer l'algorithme en mouvement.  Voici un exemple de liste de r√©seaux: <br><br> <code>192.168.0.1 <br> 192.168.0.2 <br> 192.168.0.8/29 <br> 192.168.150.1 <br> 192.168.150.2 <br> 192.168.150.8/29 <br> 192.168.20.1 <br> 192.168.20.2 <br> 192.168.20.3 <br> 192.168.20.4 <br> 192.168.20.5 <br> 192.168.20.6 <br> 192.168.20.7</code> <br> <br>  Ici, les sous-r√©seaux 192.168.0.0/24 et 192.168.150.0/24 ont une structure identique - il est pr√©f√©rable de voir comment, pendant la compression, l'algorithme saute d'une branche √† l'autre.  Il a ajout√© le sous-r√©seau 192.168.20.0/24 afin de montrer qu'il est parfois plus rentable de compresser le r√©seau parent que le r√©seau enfant.  Faites attention au sous-r√©seau 192.168.20.0/30: apr√®s avoir rempli l'arbre, son poids est inf√©rieur √† celui du sous-r√©seau parent. <br><br>  Remplissage d'arbres: <br><br><img src="https://habrastorage.org/webt/db/7y/od/db7yodt6w5mvgq_rvxxoe5k4lq8.gif"><br><br>  Ici, la police noire est le v√©ritable r√©seau de la liste d'origine.  Jaune - r√©seaux ajout√©s.  Le bleu est le poids du n≈ìud.  Le rouge est le r√©seau actuel.  Le rose est un filet effondr√©. <br><br>  La compression <br><br><img src="https://habrastorage.org/webt/wp/wr/0j/wpwr0j57ms67jp4xdpmhzjkpnpy.gif"><br><br>  Il y avait une id√©e pour acc√©l√©rer l'algorithme d'effondrement du r√©seau: pour cela, il n'est pas n√©cessaire d'effondrer uniquement les r√©seaux avec un poids maximum √† chaque it√©ration.  Vous pouvez pr√©s√©lectionner la valeur de poids, qui nous donnera une liste de la taille souhait√©e.  Vous pouvez s√©lectionner par recherche binaire, c'est-√†-dire  compresser avec un certain poids et voir quelle taille de la liste est obtenue √† la sortie.  Certes, pour cela, vous avez besoin de deux fois plus de m√©moire et de r√©√©crire le code - je n'ai tout simplement pas mis la main dessus. <br><br>  Il reste maintenant √† comparer avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">network-list-parser</a> de l'article sur BGP. <br><br>  Avantages de mon script: <br><br><ol><li>  Configuration plus pratique: sp√©cifiez simplement la taille requise de la liste des r√©seaux, et la sortie sera une liste exactement de cette taille.  Network-list-parser a beaucoup de descripteurs, et vous devez en trouver une combinaison. </li><li>  Le taux de compression s'adapte √† la liste d'origine.  Si nous supprimons certains r√©seaux de la liste, nous obtiendrons moins d'adresses suppl√©mentaires, si nous en ajoutons plus.  Dans ce cas, la taille de la liste r√©sultante sera constante.  Vous pouvez choisir la taille maximale que le routeur peut g√©rer et ne vous inqui√©tez pas si la liste devient trop longue √† un moment donn√©. </li><li>  La liste r√©sultante contient le nombre minimum possible de r√©seaux suppl√©mentaires.  Sur la liste de tests de GitHub, mon algorithme a donn√© 718479 adresses IP suppl√©mentaires et analyseur de liste de r√©seaux - 798761. <b>La diff√©rence n'est que de 10%</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Comment ai-je calcul√© cela?</b>  <b class="spoiler_title">Regarder</b> <div class="spoiler_text">  1. Lancement <br><br><pre> <code class="plaintext hljs"> ./network-list-parser-darwin-386-1.2.bin -src-file real_net_list_example.txt -dst-file parsed.txt -aggregation-max-fake-ips 0 -intensive-aggregation-min-prefix 31 2&gt;&amp;1</code> </pre> <br>  et nous obtenons une liste nettoy√©e sans ordures et partiellement r√©duite.  Je vais comparer la qualit√© de compression de parsed.txt.  (sans cette √©tape, il y a eu des probl√®mes pour √©valuer le nombre de fausses adresses r√©seau-liste-parseur). <br><br>  2. Lancement <br><br><pre> <code class="plaintext hljs">./network-list-parser-darwin-386-1.2.bin -src-file parsed.txt -dst-file parsed1.txt 2&gt;&amp;1</code> </pre> <br>  et nous obtenons une liste compress√©e, regardez la sortie, il y a la ligne "Ajouter une couverture IP de 7,3% (798761)." <br><br>  Le fichier parsed1.txt contient 16649 entr√©es. <br><br>  3. Lancement <br><br>  python3 minimise_net_list.py parsed.txt 16649. <br>  Nous voyons la ligne ### pas r√©elle ips: 718479. <br></div></div><br></li></ol><br>  Je ne vois qu'un seul inconv√©nient du script r√©sultant: il fonctionne depuis longtemps et n√©cessite beaucoup de m√©moire.  Sur mon MacBook, la liste est press√©e pendant 5 secondes.  Sur la framboise - <b>une minute et demie</b> .  Avec RyPy3 sur Mac, c'est plus rapide, je ne pouvais pas mettre PyPy3 sur Raspberry.  Network-list-parser vole √ßa et l√†. <br><br>  En g√©n√©ral, il est logique d'utiliser ce sch√©ma uniquement pour les perfectionnistes, car  il est peu probable que tous les autres d√©pensent autant de ressources informatiques pour 10% des r√©seaux enregistr√©s.  Eh bien, un peu plus pratique, oui. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers le projet sur GitHub</a> <br><br>  Courez comme ceci: <br><br><pre> <code class="plaintext hljs">python3 minimize_net_list.py real_net_list_example.txt 30000 | grep -v ### &gt; result.txt</code> </pre> <br>  En fait, c'est tout. <br><br>  <b>UPD</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Pochemuk</a> dans les commentaires a indiqu√© une erreur dans le calcul du poids, je l'ai corrig√© et maintenant, lors de la compression de la m√™me liste de l'exemple avec les m√™mes param√®tres, 624925 adresses IP sont ajout√©es qui ne figurent pas dans la liste d'origine.  C'est d√©j√† <b>22% mieux</b> que lors du traitement de l'analyseur de liste de r√©seau <br>  Nouveau code dans la branche non test√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/phoenix-mstu/net_list_minimizer/tree/untested</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438242/">https://habr.com/ru/post/fr438242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438230/index.html">Traduction "Pr√©parez vos applications pour les exigences 64 bits"</a></li>
<li><a href="../fr438234/index.html">R√©sum√© des √©v√©nements informatiques de f√©vrier</a></li>
<li><a href="../fr438236/index.html">Confluence pour une base de connaissances publique: changer la conception et mettre en place la s√©paration linguistique</a></li>
<li><a href="../fr438238/index.html">En tant que designer, je refuse d'appeler les gens ¬´utilisateurs¬ª</a></li>
<li><a href="../fr438240/index.html">Test de charge du CPU et du SSD des h√©bergeurs cloud: comparer Selectel, Servers, MCS et I. Cloud</a></li>
<li><a href="../fr438244/index.html">Nous traitons de la r√©glementation cryptographique russe ... en utilisant l'exemple de l'arrestation d'un seigneur de la drogue</a></li>
<li><a href="../fr438248/index.html">GitHub Action Life</a></li>
<li><a href="../fr438250/index.html">L'ignorance des principes de la s√©curit√© de l'information n'exempte pas</a></li>
<li><a href="../fr438252/index.html">Pourquoi n'a pas d√©coll√© du portail immobilier. Partie 1</a></li>
<li><a href="../fr438254/index.html">Eclipse lance GlassFish 5.1 pour Java EE 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>