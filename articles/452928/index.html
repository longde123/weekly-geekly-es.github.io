<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêñ ü•í üíè Restauramos m√°quinas virtuales del almac√©n de datos inicializado err√≥neamente. La historia de un sinsentido con final feliz üßùüèº üìπ üí•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Descargo de responsabilidad: la nota es entretenida. La densidad espec√≠fica de informaci√≥n √∫til en ella es peque√±a. Fue escrito "para ti mismo". 
 Int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Restauramos m√°quinas virtuales del almac√©n de datos inicializado err√≥neamente. La historia de un sinsentido con final feliz</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452928/"><blockquote>  <b>Descargo de responsabilidad: la</b> nota es entretenida.  La densidad espec√≠fica de informaci√≥n √∫til en ella es peque√±a.  Fue escrito "para ti mismo". </blockquote><br><h3>  Introducci√≥n l√≠rica </h3><br>  El volcado de archivos en nuestra organizaci√≥n est√° girando en una m√°quina virtual VMware ESXi 6 en Windows Server 2016. Y esto no es solo un volcado.  Este es un servidor de intercambio de archivos entre divisiones estructurales: hay colaboraci√≥n, documentaci√≥n de proyectos y carpetas de esc√°neres de red.  En general, esta es toda la vida de producci√≥n. <br><br>  Y este contenedor de toda la vida de producci√≥n comenz√≥ a colgar.  Adem√°s, el invitado pod√≠a ahorcarse en silencio, sin afectar al resto.  Podr√≠a colgar detr√°s de s√≠ mismo todo el host y, en consecuencia, todas las dem√°s m√°quinas invitadas.  Podr√≠a colgarme y colgar los servicios del cliente vSphere: es decir, los procesos de los otros invitados est√°n vivos, las m√°quinas funcionan correctamente y responden, pero no hay corrupci√≥n de archivos y vSphere Client no se aferra al host.  En general, no se pudo identificar ning√∫n sistema.  Los bloqueos pueden ocurrir durante el d√≠a durante una carga d√©bil.  Podr√≠a por la noche durante carga cero.  Podr√≠a por la noche durante el respaldo diferencial y la carga media.  Podr√≠a el fin de semana durante una copia de seguridad completa y alta carga.  Y hubo una clara degradaci√≥n de la situaci√≥n.  Al principio era una vez al a√±o, luego una vez cada seis meses.  Al final de mi paciencia, dos veces por semana. <br><a name="habracut"></a><br>  Pequ√© por RAM.  Pero no me dejaron detener la basura ni siquiera los fines de semana y ahuyentar a Memtest.  Esper√© las vacaciones de mayo.  En las vacaciones de mayo, me fui de Memtest y ... no se encontraron errores. <br><br>  Me sorprendi√≥ y decid√≠ irme de vacaciones.  Mientras estaba de vacaciones, el basurero no ten√≠a una sola ca√≠da.  Y cuando el lunes el primer d√≠a fue a trabajar, el basurero colg√≥.  Mantuvo una copia de seguridad completa, y justo al final se colg√≥.  Una reuni√≥n tan c√°lida de vacaciones me llev√≥ a la decisi√≥n de arrastrar f√≠sicamente el disco de invitado a otro anfitri√≥n. <br><br>  Y, aunque se sabe desde hace mucho tiempo que el primer d√≠a despu√©s de unas vacaciones, no se puede hacer nada serio, aunque me prepar√© para trabajar todo el camino, mi indignaci√≥n con el siguiente congelamiento me dej√≥ sin palabras y votos ... <br><br>  Los discos f√≠sicos se reorganizaron a otro host.  Conexi√≥n en caliente.  Los discos aparecen en la configuraci√≥n de almacenamiento en la pesta√±a <i>Unidades</i> .  En la pesta√±a Almacenes de <i>datos, el</i> almacenamiento en estas unidades no lo es.  <i>Actualizar</i> : no aparece.  Bueno, por supuesto, el primer impulso es <i>Agregar almacenamiento</i> .  El Asistente para agregar le dice lo que admite.  Por supuesto, tambi√©n es compatible con VMFS.  No tuve dudas  Un vistazo r√°pido a los mensajes del asistente en cada paso: Siguiente, Siguiente, Siguiente, Finalizar.  Su mirada ni siquiera se cerr√≥ para atrapar un peque√±o c√≠rculo amarillo con un signo de exclamaci√≥n en la parte inferior de la ventana de uno de los pasos del maestro. <br><br>  Al final del asistente, apareci√≥ un nuevo almac√©n de datos en la lista ... y con √©l almacenes de datos de otros discos f√≠sicos. <br><br>  Me dirijo a la navegaci√≥n en el Almac√©n de datos reci√©n agregado y ... est√° vac√≠o.  Por supuesto, nuevamente me sorprendi√≥.  8 am en el reloj, los primeros 15 minutos en el trabajo despu√©s de las vacaciones, incluso el az√∫car en el caf√© a√∫n no se ha agitado.  Y aqui esta.  Mi primer pensamiento fue que saqu√© el disco equivocado del host "nativo".  Mir√© para ver si el almac√©n de datos requerido est√° presente en el host "nativo": no, no est√° presente.  El segundo pensamiento fue: "¬°mierda # b!".  No estoy seguro, pero me parece que el tercer, cuarto y al menos quinto pensamiento fue el mismo. <br><br>  Para disipar dudas, instal√© r√°pidamente un ESXi nuevo en la muestra, tom√© el disco izquierdo y, despu√©s de leerlo, segu√≠ los pasos del asistente.  Si  Al agregar un almac√©n de datos utilizando el asistente, todos los datos en el disco se pierden sin la capacidad de revertir la operaci√≥n y restaurar los datos.  M√°s tarde, le√≠ en uno de los foros una evaluaci√≥n de tal dise√±o por parte del maestro: mierda horrible.  Y ahora mismo estoy de acuerdo. <br><br>  Comenzando con el sexto, los pensamientos fluyeron de una manera m√°s constructiva.  Esta bien  La inicializaci√≥n lleva unos segundos, incluso para un disco de 3Tb.  Entonces este es un formato de alto nivel.  Entonces, la tabla de particiones fue simplemente reescrita.  Entonces los datos todav√≠a est√°n all√≠.  As√≠ que ahora busquemos un poco de formato y listo. <br><br>  Cargo el auto desde la imagen de arranque de Strelec ... Y descubro que todos los programas de recuperaci√≥n de particiones son conocidos, excepto VMFS.  Por ejemplo, conocen el dise√±o de partici√≥n de Synology, pero VMFS no. <br><br>  Enumerar programas no es reconfortante: en el mejor de los casos, GetDataBack y R.Saver encuentran particiones NTFS con estructuras de directorios en vivo y nombres de archivos en vivo.  Pero eso no me conviene.  Necesito dos archivos vmdk: con un disco del sistema y un contenedor de basura. <br><br>  Y luego entiendo que, al parecer, ahora instalar√© Windows y desplegar√© la copia de seguridad del archivo.  Y al mismo tiempo recuerdo que ten√≠a una ra√≠z DFS all√≠.  Y tambi√©n un sistema de derechos de acceso a las carpetas de unidades completamente voluminoso y ramificado.  No es una opcion.  La √∫nica opci√≥n de tiempo aceptable es restaurar el estado del sistema y el disco con datos y todos los derechos. <br><br>  Nuevamente buscando en Google, foros, KB'shki y nuevamente llorando Yaroslavna: VMware ESXi no proporciona un mecanismo de recuperaci√≥n de datos.  Todos los hilos de discusi√≥n tienen dos finales: alguien se recuper√≥ con la ayuda de DiskInternals VMFS Recovery no barato o alguien que promovi√≥ activamente sus servicios con la <i>ayuda</i> de <i>vmfs-tools</i> y <i>dd</i> ayud√≥.  La opci√≥n de comprar una licencia de recuperaci√≥n de DiskInternals VMFS por $ 700 no es una opci√≥n.  La admisi√≥n de un extra√±o desde el "territorio de un posible adversario" a los datos corporativos tampoco es una opci√≥n.  Pero se busc√≥ en Google que las particiones VMFS pueden leer tambi√©n UFS Explorer. <br><br><h3>  DiskInternals VMFS Recovery </h3><br>  La versi√≥n de prueba fue descargada e instalada.  El programa vio con √©xito una secci√≥n VMFS vac√≠a: <br><br><img src="https://habrastorage.org/webt/yy/pe/po/yypepobhgib-ilpc2lratezxrhc.png" alt="imagen"><br><br>  En el modo <i>Recuperar (Escaneo r√°pido)</i> , tambi√©n encontr√© un almac√©n de datos en mal estado con carpetas de m√°quinas virtuales con discos dentro: <br><br><img src="https://habrastorage.org/webt/jr/y8/sk/jry8skays28vnmrhzl8ot6jpfyu.png"><br><br>  La vista previa mostr√≥ que los archivos est√°n en vivo: <br><br><img src="https://habrastorage.org/webt/tt/f1/eo/ttf1eoyfh-l0lsyfxcwcazss7dw.png"><br><br>  El montaje de la partici√≥n en el sistema fue exitoso, pero por alguna raz√≥n, las tres carpetas ten√≠an la misma m√°quina virtual.  Por supuesto, la ley de la maldad no es lo que se requiere. <br><br><div class="spoiler">  <b class="spoiler_title">Tres l√≠neas de verg√ºenza</b> <div class="spoiler_text">  Un intento de bloquear descaradamente el software termin√≥ en un fracaso.  Pero UFS Explorer estaba bloqueado. <br><br><blockquote>  Soy extremadamente negativo sobre el robo de software.  En ning√∫n caso insto al uso de elusi√≥n de la protecci√≥n contra el uso sin licencia. <br></blockquote><br>  Estaba en una situaci√≥n catastr√≥fica y no estaba en absoluto orgulloso de las medidas a las que hab√≠a recurrido. <br></div></div><br><h3>  UFS Explorer </h3><br>  Escanear el disco mostr√≥ la presencia de 7 nodos.  El n√∫mero de nodos de una "manera sorprendente" coincidi√≥ con el n√∫mero de archivos * -flat.vmdk detectados por VMFS Recovery: <br><br><img src="https://habrastorage.org/webt/nc/kh/m0/nckhm0xgc35ajd7hcmt9xbqgz6o.png"><br><br>  La comparaci√≥n de tama√±os de archivo y tama√±os de nodo tambi√©n mostr√≥ una coincidencia hasta el byte.  Al mismo tiempo, se restauraron los nombres de los archivos * -flat.vmdk y, en consecuencia, su pertenencia a m√°quinas virtuales. <br><br><img src="https://habrastorage.org/webt/ru/o2/jm/ruo2jmc33trnezku3qnqzt3n1yy.png"><br><br>  En general, desde el punto de vista de ESXi, los discos vmdk consisten en dos archivos: un archivo de datos (&lt;nombre del equipo&gt; -flat.vmdk) y un archivo de partici√≥n del disco f√≠sico (&lt;nombre del equipo&gt; .vmdk).  Si carga el archivo * -flat.vmdk desde la m√°quina local al Almac√©n de datos, ESXi no lo reconocer√° como un archivo de disco v√°lido.  Hay un art√≠culo en la base de conocimiento de VMware sobre c√≥mo crear manualmente un archivo descriptor de disco: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kb.vmware.com/s/article/1002511</a> , pero no tuve que hacerlo, simplemente copi√© el contenido de los archivos correspondientes del √°rea de vista previa de contenido de archivos en DiskInternals VMFS Recovery : <br><br><img src="https://habrastorage.org/webt/wa/ra/m3/waram3hzq42ow0zefbooy1vacqk.png"><br><br>  Despu√©s de 4 horas de descargar un nodo de 2.5TB del Explorador UFS y 20 horas de carga en el hipervisor Datastore, los archivos de disco fallidos se conectaron a una m√°quina virtual reci√©n creada.  Ruedas recogidas.  No se not√≥ p√©rdida de datos. <br><br><img src="https://habrastorage.org/webt/-p/nc/73/-pnc73v0yy5rcpghk4qan_fownw.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452928/">https://habr.com/ru/post/452928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452914/index.html">ML en Scala con una sonrisa, para aquellos que no tienen miedo a la experimentaci√≥n</a></li>
<li><a href="../452916/index.html">Lev√°ntate y vete. Cirug√≠a de columna: cu√°ndo hacer, qu√© es peligroso</a></li>
<li><a href="../452922/index.html">Tablas de rejilla CSS flexibles</a></li>
<li><a href="../452924/index.html">Lo que debe hacer para evitar que le roben su cuenta de Google</a></li>
<li><a href="../452926/index.html">Pruebas est√°ticas o guardar al soldado Ryan</a></li>
<li><a href="../452938/index.html">Las pistolas de la impresora 3D est√°n de vuelta, y ahora ya no se pueden detener.</a></li>
<li><a href="../452942/index.html">GeekBrains celebra 12 reuniones en l√≠nea gratuitas con expertos en programaci√≥n</a></li>
<li><a href="../452944/index.html">¬øCu√°l ser√° el "Di√°logo" de ling√ºistas y especialistas en an√°lisis de datos?</a></li>
<li><a href="../452946/index.html">Relectura de la filosof√≠a de programaci√≥n de Windows 95 / NT de Lou Greenaw</a></li>
<li><a href="../452952/index.html">Jornada de puertas abiertas de JetBrains en San Petersburgo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>