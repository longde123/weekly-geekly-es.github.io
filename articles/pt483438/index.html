<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèø üë©üèª‚Äçüíº üêú Toque "osu!", N√£o se esque√ßa dos erros ü•¶ ‚õπüèª üÜí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Congratulamo-nos com todos os amantes de erros ex√≥ticos e n√£o muito no c√≥digo. Hoje, no banco de testes, o PVS-Studio √© um convidado bastante raro - u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toque "osu!", N√£o se esque√ßa dos erros</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483438/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Quadro 1" align="left"></p>  Congratulamo-nos com todos os amantes de erros ex√≥ticos e n√£o muito no c√≥digo.  Hoje, no banco de testes, o PVS-Studio √© um convidado bastante raro - um jogo em C #.  Ou seja, osu!  Como sempre: procure erros, pense, brinque. <br><a name="habracut"></a><br><h2>  O jogo </h2><br>  Osu!  - Um jogo de ritmo de m√∫sica de c√≥digo aberto.  A julgar pelas informa√ß√µes do <a href="https://osu.ppy.sh/home">site do jogo</a> , √© bastante popular, pois s√£o reivindicados mais de 15 milh√µes de jogadores registrados.  O projeto √© caracterizado por jogabilidade livre, design colorido com a capacidade de personalizar cartas, recursos avan√ßados para compilar um ranking on-line de jogadores, presen√ßa de multiplayer, um grande conjunto de composi√ß√µes musicais.  N√£o vou descrever o jogo em detalhes, os interessados ‚Äã‚Äãencontrar√£o facilmente todas as informa√ß√µes na rede.  Por exemplo, <a href="https://en.wikipedia.org/wiki/Osu!">aqui</a> . <br><br>  Estou mais interessado no c√≥digo-fonte do projeto, que est√° dispon√≠vel para download no <a href="https://github.com/ppy/osu">GitHub</a> .  Um n√∫mero significativo de confirma√ß√µes (mais de 24 mil) no reposit√≥rio atrai imediatamente a aten√ß√£o, o que indica o desenvolvimento ativo do projeto, que continua at√© hoje (o jogo foi lan√ßado em 2007, mas o trabalho provavelmente foi iniciado anteriormente).  Ao mesmo tempo, n√£o h√° muito c√≥digo-fonte - 1813 arquivos .cs que cont√™m 135 mil linhas de c√≥digo, excluindo as vazias.  Este c√≥digo cont√©m testes que eu normalmente n√£o considero em cheques.  O c√≥digo de teste est√° contido em 306 arquivos .cs e, consequentemente, em 25 mil linhas de c√≥digo, excluindo as vazias.  Este √© um projeto pequeno: para compara√ß√£o, o n√∫cleo C # do analisador PVS-Studio cont√©m cerca de 300 mil linhas de c√≥digo. <br><br>  No total, para verificar se h√° erros no jogo, usei projetos sem teste contendo 1507 arquivos de c√≥digo-fonte e 110 mil linhas.  No entanto, o resultado me agradou parcialmente, pois houve v√°rios erros interessantes sobre os quais me apresso a falar. <br><br><h2>  Erros </h2><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Existem <a href="https://www.viva64.com/ru/w/v3001/">subexpress√µes</a> id√™nticas 'result == HitResult.Perfect' √† esquerda e √† direita da '||'  operador.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Um bom exemplo de programa√ß√£o orientada para copiar e colar.  Um termo c√¥mico que meu colega Valery Komarov usou recentemente (introduziu) em seu artigo " <a href="https://www.viva64.com/ru/b/0699/">Os 10 principais erros em projetos Java para 2019</a> ". <br><br>  Portanto, duas verifica√ß√µes id√™nticas seguem uma ap√≥s a outra.  Uma das verifica√ß√µes provavelmente deve conter outra <i>constante de</i> enumera√ß√£o <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Qual constante espec√≠fica precisava ser usada ou a segunda verifica√ß√£o n√£o √© necess√°ria?  Perguntas que somente o desenvolvedor pode responder.  De qualquer forma, foi cometido um erro que distorce a l√≥gica do programa. <br><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Existem <a href="https://www.viva64.com/ru/w/v3001/">subexpress√µes</a> id√™nticas 'family! = GetFamilyString (TournamentTypeface.Aquatico)' √† esquerda e √† direita do operador '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  E novamente copie e cole.  Formatei o c√≥digo, para que o erro seja facilmente percebido.  Na vers√£o original, toda a condi√ß√£o foi escrita em uma linha.  Tamb√©m √© dif√≠cil dizer como o c√≥digo pode ser corrigido.  A enumera√ß√£o <i>TournamentTypeface</i> cont√©m uma √∫nica constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  A condi√ß√£o pode ter usado a vari√°vel de <i>fam√≠lia</i> duas vezes por engano, mas isso n√£o √© exato. <br><br>  <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] √â estranho que esse m√©todo sempre retorne um e o mesmo valor de 'false'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  O m√©todo sempre retornar√° <i>falso</i> .  Para esses erros, geralmente verifico o c√≥digo de chamada, pois geralmente eles n√£o usam o valor de retorno em nenhum lugar, ent√£o n√£o h√° erro (exceto pelo estilo de programa√ß√£o feio).  Nesse caso, me deparei com o seguinte c√≥digo: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Como voc√™ pode ver, o resultado retornado pelo m√©todo <i>OnPressed</i> √© usado.  E como sempre √© <i>falso</i> , o resultado da chamada <i>OnPressed</i> tamb√©m ser√° sempre <i>falso</i> .  Eu acho que voc√™ deve verificar esse c√≥digo novamente, pois h√° uma alta probabilidade de erro. <br><br>  Outro erro semelhante: <br><br><ul><li>  V3009 [CWE-393] √â estranho que esse m√©todo sempre retorne um e o mesmo valor de 'false'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  Na condi√ß√£o do operador <i>?:</i> , A vari√°vel <i>val.NewValue</i> n√£o √© segura.  O analisador chegou a essa conclus√£o, desde ent√£o na ramifica√ß√£o ent√£o, uma op√ß√£o segura √© usada para acessar a vari√°vel por meio do operador de acesso condicional <i>val.NewValue? .Substring (....)</i> . <br><br>  Outro erro semelhante: <br><br><ul><li>  V3042 [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Esse c√≥digo √© menos claro, mas acho que o erro ainda est√° l√°.  Crie um objeto do tipo <i>ActionableInfo</i> .  O campo <i>A√ß√£o</i> √© inicializado com um lambda, no corpo do qual n√£o √© seguro trabalhar com uma <i>API de</i> refer√™ncia potencialmente nula.  O analisador considerou esse padr√£o um erro; desde ent√£o, ao inicializar o par√¢metro <i>Value</i> , a vari√°vel <i>api</i> trabalha com seguran√ßa.  Chamei o erro de amb√≠guo, porque o c√≥digo lambda pressup√µe a execu√ß√£o atrasada e, talvez, o desenvolvedor garanta um valor diferente de zero do link <i>api</i> .  Mas isso √© apenas uma suposi√ß√£o, j√° que o corpo lambda n√£o cont√©m nenhum sinal de trabalho seguro com o link (verifica√ß√µes preliminares, por exemplo). <br><br>  <a href="https://www.viva64.com/ru/w/v3066/">V3066</a> [CWE-683] Poss√≠vel ordem incorreta de argumentos passada para o m√©todo 'Atan2': 'diff.X' e 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  O analisador suspeitou que, ao trabalhar com o m√©todo <i>Atan2</i> da classe <i>Math</i> , o desenvolvedor misturasse a ordem dos argumentos.  <i>An√∫ncio Atan2</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Como voc√™ pode ver, os valores foram transferidos na ordem inversa.  N√£o posso julgar se isso √© um erro, pois o m√©todo <i>UpdateProgress</i> cont√©m muitos c√°lculos n√£o triviais.  Acabei de observar o fato de um poss√≠vel problema no c√≥digo. <br><br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> [CWE-476] Poss√≠vel desrefer√™ncia nula.  Considere inspecionar 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  O analisador apontou o perigo de acesso atrav√©s do link nulo do <i>Beatmap</i> .  Aqui est√° o que √©: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Bem, o analisador est√° certo. <br><br>  Para obter mais informa√ß√µes sobre como o PVS-Studio encontra esses erros, bem como sobre as inova√ß√µes do C # 8.0 relacionadas a um t√≥pico semelhante (trabalhando com refer√™ncias potencialmente nulas), consulte o artigo " <a href="https://www.viva64.com/ru/b/0631/">Tipos de refer√™ncia anul√°veis ‚Äã‚Äãno C # 8.0 e an√°lise est√°tica</a> ". <br><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> [CWE-367] <a href="https://www.viva64.com/ru/w/v3083/">Chamada n√£o segura</a> do evento 'ObjectConverted', NullReferenceException √© poss√≠vel.  Considere atribuir um evento a uma vari√°vel local antes de invoc√°-lo.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Erro n√£o cr√≠tico e bastante comum.  Entre a verifica√ß√£o do <i>nulo</i> do evento e sua chamada, eles podem cancelar a inscri√ß√£o no evento, o que levar√° ao travamento do programa. <br>  Uma das corre√ß√µes: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> [CWE-476] O objeto 'colunas' foi usado antes de ser verificado com rela√ß√£o a nulo.  Verifique as linhas: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  N√£o √© seguro ignorar a cole√ß√£o de <i>colunas</i> em um loop.  Ao mesmo tempo, o desenvolvedor assumiu que o link das <i>colunas</i> poderia ser nulo, pois mais tarde no c√≥digo, um operador de acesso condicional √© usado para acessar a cole√ß√£o. <br><br>  <a href="https://www.viva64.com/ru/w/v3119/">V3119</a> Chamar o evento substitu√≠do 'OnNewResult' pode levar a um comportamento imprevis√≠vel.  Considere implementar explicitamente os acessadores de eventos ou use a palavra-chave 'selada'.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  O analisador alerta para os perigos do uso de um evento virtual ou substitu√≠do.  Qual √© exatamente o perigo - sugiro ler a <a href="https://www.viva64.com/ru/w/v3119/">descri√ß√£o</a> para o diagn√≥stico.  Al√©m disso, escrevi um artigo sobre este t√≥pico, " <a href="https://www.viva64.com/ru/b/0453/">Eventos virtuais em C #: algo deu errado</a> ". <br><br>  Outra constru√ß√£o insegura semelhante no c√≥digo: <br><br><ul><li>  V3119 A chamada de um evento substitu√≠do pode levar a um comportamento imprevis√≠vel.  Considere implementar explicitamente os acessadores de eventos ou use a palavra-chave 'selada'.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Talvez o '??'  O operador trabalha de uma maneira diferente da esperada.  Sua prioridade √© inferior √† prioridade de outros operadores na parte esquerda.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Para uma melhor compreens√£o do problema - darei um exemplo sint√©tico de como o c√≥digo est√° funcionando agora: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  O erro foi cometido devido ao fato de o operador * ter prioridade mais alta que o operador ??  Vers√£o corrigida do c√≥digo (colchetes adicionados): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Outro erro semelhante no c√≥digo: <br><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Talvez o '??'  O operador trabalha de uma maneira diferente da esperada.  Sua prioridade √© inferior √† prioridade de outros operadores na parte esquerda.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Aqui, como no fragmento de c√≥digo anterior, a prioridade dos operadores n√£o foi levada em considera√ß√£o.  Agora a express√£o passada para o m√©todo <i>Math.Abs</i> √© avaliada da seguinte maneira: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  C√≥digo corrigido: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3142/">V3142</a> [CWE-561] C√≥digo inacess√≠vel detectado.  √â poss√≠vel que haja um erro.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  O analisador afirma que o <i>c√≥digo do</i> manipulador <i>OnPressed</i> , come√ßando com a segunda <i>instru√ß√£o if</i> , est√° inacess√≠vel.  Isso decorre da suposi√ß√£o de que a primeira condi√ß√£o √© sempre verdadeira, ou seja, o m√©todo <i>base.OnPressed</i> sempre retornar√° <i>false</i> .  <i>D√™ uma</i> olhada no m√©todo <i>base.OnPressed</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Prosseguimos para o m√©todo <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Observe que a implementa√ß√£o da propriedade <i>Judged</i> n√£o √© importante aqui, pois a l√≥gica do m√©todo <i>UpdateResult</i> implica que a √∫ltima <i>declara√ß√£o de retorno √©</i> equivalente a isso: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Assim, o m√©todo <i>UpdateResult</i> sempre retornar√° <i>false</i> , o que levar√° a um erro com o c√≥digo inacess√≠vel no c√≥digo acima da pilha. <br><br>  <a href="https://www.viva64.com/ru/w/v3146/">V3146</a> [CWE-476] Poss√≠vel desrefer√™ncia nula de 'conjunto de regras'.  O 'FirstOrDefault' pode retornar o valor nulo padr√£o.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  O analisador considera a chamada <i>ruleset.CreateInstance ()</i> insegura.  A vari√°vel do <i>conjunto de regras</i> obt√©m o valor anteriormente como resultado de chamar <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Como voc√™ pode ver, o aviso do analisador √© justificado, pois a cadeia de chamadas cont√©m <i>FirstOrDefault</i> , que pode retornar <i>nulo</i> . <br><br><h2>  Conclus√£o </h2><br>  Em geral, o projeto do jogo "osu!", Satisfeito com um pequeno n√∫mero de erros.  No entanto, recomendo que os desenvolvedores prestem aten√ß√£o aos problemas detectados.  E deixe o jogo continuar agradando seus f√£s. <br><br>  E para quem gosta de se aprofundar no c√≥digo, lembro que o analisador PVS-Studio, que √© f√°cil de <a href="https://www.viva64.com/ru/pvs-studio-download/">baixar</a> do site oficial, ser√° uma boa ajuda.  Tamb√©m observo que verifica√ß√µes √∫nicas de projetos, como as descritas acima, n√£o t√™m nada a ver com o uso de um analisador est√°tico no trabalho real.  A efici√™ncia m√°xima na luta contra erros pode ser alcan√ßada apenas com o uso regular da ferramenta no servidor de compila√ß√£o e diretamente no computador do desenvolvedor (an√°lise incremental).  O objetivo m√°ximo √© impedir a entrada de erros no sistema de controle de vers√£o, corrigindo defeitos j√° no est√°gio de escrita do c√≥digo. <br><br>  Boa sorte e sucesso! <br><br><h2>  Refer√™ncias </h2><br>  Esta √© a primeira publica√ß√£o em 2020.  Aproveitando esta oportunidade, fornecerei links para artigos sobre a verifica√ß√£o de projetos em C # no ano passado: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0605/">Procurando bugs no c√≥digo-fonte do Amazon Web Services SDK para .NET</a> </li><li>  <a href="https://www.viva64.com/ru/b/0622/">Verificando o c√≥digo fonte de Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0631/">Tipos de refer√™ncia anul√°veis ‚Äã‚Äãem C # 8.0 e an√°lise est√°tica</a> </li><li>  <a href="https://www.viva64.com/ru/b/0653/">WinForms: erros, Holmes</a> </li><li>  <a href="https://www.viva64.com/ru/b/0654/">A hist√≥ria de como o PVS-Studio encontrou um erro na biblioteca usada em ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0656/">Verifica√ß√£o do c√≥digo-fonte das bibliotecas .NET Core pelo analisador est√°tico PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0664/">Verificando os analisadores Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0677/">Verifique a interface do usu√°rio da Telerik para obter UWP para se familiarizar com o PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0678/">Azure PowerShell: "principalmente inofensivo"</a> </li><li>  <a href="https://www.viva64.com/ru/b/0681/">Pesquisamos e analisamos erros no c√≥digo Orchard CMS</a> </li><li>  <a href="https://www.viva64.com/ru/b/0683/">Verificando o wrapper OpenCvSharp sobre o OpenCV com o PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0692/">Azure SDK para .NET: a hist√≥ria de uma pesquisa dif√≠cil de erros</a> </li><li>  <a href="https://www.viva64.com/ru/b/0694/">SARIF SDK e seus erros</a> </li><li>  <a href="https://www.viva64.com/ru/b/0698/">Os 10 principais erros em projetos de C # para 2019</a> </li></ul><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/483436/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Sergey Khrenov.  <a href="https://habr.com/en/company/pvs-studio/blog/483436/">Toque "osu!", Mas cuidado com os bugs</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483438/">https://habr.com/ru/post/pt483438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483418/index.html">Sistemas de ingressos: como voc√™ conseguiu tr√™s OTRS gratuitos pagos?</a></li>
<li><a href="../pt483424/index.html">DBA: transferindo valores de SEQUENCE entre bancos de dados PostgreSQL</a></li>
<li><a href="../pt483426/index.html">Friday Tab Survey</a></li>
<li><a href="../pt483428/index.html">Qual ser√° o gerenciamento de documentos eletr√¥nicos ap√≥s a entrada em vigor de altera√ß√µes √† lei sobre assinatura eletr√¥nica?</a></li>
<li><a href="../pt483436/index.html">Toque "osu!", Mas cuidado com os bugs</a></li>
<li><a href="../pt483440/index.html">√öltimos compiladores D</a></li>
<li><a href="../pt483444/index.html">Relat√≥rio DORA 2019: Como melhorar o desempenho do DevOps</a></li>
<li><a href="../pt483446/index.html">Cientistas descobriram uma nova maneira de diminuir os n√≠veis de ferro na √°gua pot√°vel</a></li>
<li><a href="../pt483448/index.html">Disney - A maior via dupla da hist√≥ria da humanidade</a></li>
<li><a href="../pt483454/index.html">Mudando de Mercurial para GIT no Atlassian Bitbucket com salvando arquivos em cir√≠lico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>