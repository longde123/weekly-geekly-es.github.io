<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòî üâë üõê Restaurar fotos usando redes neuronales üëÉ üíà ‚ôíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos, trabajo como programador de investigaci√≥n en el equipo de visi√≥n por computadora de Mail.ru Group. Para el D√≠a de la Victoria de este a√±...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Restaurar fotos usando redes neuronales</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/453872/"><img src="https://habrastorage.org/getpro/habr/post_images/333/44a/c78/33344ac788b63200841180799417f934.jpg"><br><br>  Hola a todos, trabajo como programador de investigaci√≥n en el equipo de visi√≥n por computadora de Mail.ru Group.  Para el D√≠a de la Victoria de este a√±o, decidimos hacer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto para la restauraci√≥n de fotograf√≠as militares</a> .  ¬øQu√© es la restauraci√≥n de fotos?  Consta de tres etapas: <br><br><ul><li>  encontramos todos los defectos de imagen: roturas, rasgu√±os, agujeros; <br></li><li>  pintar sobre los defectos encontrados en funci√≥n de los valores de p√≠xeles a su alrededor; <br></li><li>  colorear la imagen <br></li></ul><br>  En este art√≠culo, pasar√© por cada una de las etapas de restauraci√≥n en detalle y le dir√© c√≥mo y d√≥nde tomamos datos, qu√© redes aprendimos, qu√© hicimos, qu√© rastrillos pisamos. <br><a name="habracut"></a><br><h1>  B√∫squeda de defectos </h1><br>  Queremos encontrar todos los p√≠xeles relacionados con defectos en la foto cargada.  Primero, necesitamos entender qu√© tipo de fotograf√≠as de los a√±os de guerra subir√°n las personas.  Nos dirigimos a los organizadores del proyecto Regimiento Inmortal, quienes compartieron datos con nosotros.  Despu√©s de analizarlos, notamos que las personas a menudo cargan retratos, individuales o grupales, que tienen una cantidad moderada o grande de defectos. <br><br>  Luego fue necesario recolectar una muestra de entrenamiento.  La muestra de entrenamiento para la tarea de segmentaci√≥n es una imagen y una m√°scara en la que se marcan todos los defectos.  La forma m√°s f√°cil es dar fotos a los marcadores a los marcadores.  Por supuesto, las personas son buenas para encontrar defectos, pero el problema es que el marcado es un proceso muy largo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5d/a19/892/d5da1989220f10bcaac3944d27d64276.png"><br><br>  Puede tomar de una hora a un d√≠a h√°bil completo para marcar p√≠xeles relacionados con defectos en una foto, por lo que es dif√≠cil recopilar una muestra de m√°s de 100 fotos en unas pocas semanas.  Por lo tanto, tratamos de complementar de alguna manera nuestros datos y escribimos defectos nosotros mismos: tomamos una foto limpia, le aplicamos defectos artificiales y obtuvimos una m√°scara que nos muestra qu√© partes particulares de la imagen estaban da√±adas.  La parte principal de nuestra muestra de entrenamiento fue 79 fotos marcadas manualmente, de las cuales 11 fueron transferidas a la muestra de prueba. <br><br>  El enfoque m√°s popular para el problema de segmentaci√≥n: tome Unet con un codificador previamente entrenado y minimice la cantidad <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>B</mi><mi>c</mi><mi>e</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-65" x="1193" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> Bce </script>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">entrop√≠a cruzada binaria</a> ) y <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi><mi>I</mi><mi>C</mi><mi>E</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.638ex" height="2.057ex" viewBox="0 -780.1 2858 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-44" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-49" x="828" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-43" x="1333" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-45" x="2093" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yo</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> DICE </script>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">S√∏rensen - Coeficiente de dados</a> ). <br><br>  ¬øQu√© problemas surgen con este enfoque en el problema de la segmentaci√≥n de defectos? <br><br><ul><li>  Incluso si nos parece que hay muchos defectos en la foto, que est√° muy sucia y muy ra√≠da por el tiempo, el √°rea ocupada por los defectos es a√∫n mucho m√°s peque√±a que la parte no da√±ada de la imagen.  Para resolver este problema, puede aumentar el peso de la clase positiva en <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>B</mi><mi>c</mi><mi>e</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-65" x="1193" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> Bce </script>  , y el peso √≥ptimo ser√° la relaci√≥n entre el n√∫mero de p√≠xeles puros y el n√∫mero de p√≠xeles que pertenecen a los defectos. <br></li><li>  El segundo problema es que si usamos Unet fuera de la caja con un codificador pre-entrenado, por ejemplo Albunet-18, entonces perdemos mucha informaci√≥n posicional.  La primera capa de Albunet-18 consiste en una convoluci√≥n con un n√∫cleo de 5 y una zancada igual a dos.  Esto permite que la red funcione r√°pidamente.  Sacrificamos el tiempo de la red en aras de una mejor localizaci√≥n de los defectos: eliminamos la agrupaci√≥n m√°xima despu√©s de la primera capa, redujimos el paso a 1 y redujimos el n√∫cleo de convoluci√≥n a 3. <br></li><li>  Si trabajamos con im√°genes peque√±as, por ejemplo, comprimiendo una imagen a 256 x 256 o 512 x 512, los peque√±os defectos simplemente desaparecer√°n debido a la interpolaci√≥n.  Por lo tanto, debe trabajar con una imagen grande.  Ahora en producci√≥n estamos segmentando defectos en fotograf√≠as de 1024 x 1024. Por lo tanto, era necesario entrenar la red neuronal en grandes cultivos de im√°genes grandes.  Y debido a esto, hay problemas con el peque√±o tama√±o del lote en una tarjeta de video. <br></li><li>  Durante el entrenamiento, tenemos alrededor de 20 im√°genes colocadas en una tarjeta.  Debido a esto, la estimaci√≥n de la media y la varianza en las capas BatchNorm es inexacta.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">In-place BatchNorm</a> nos ayuda a resolver este problema, que, en primer lugar, ahorra memoria y, en segundo lugar, tiene una versi√≥n de Synchronized BatchNorm, que sincroniza las estad√≠sticas entre todas las tarjetas.  Ahora consideramos el promedio y la varianza no por 20 im√°genes en una tarjeta, sino por 80 im√°genes de 4 tarjetas.  Esto mejora la convergencia de la red. <br></li></ul><br>  Al final, aumentar de peso. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>B</mi><mi>c</mi><mi>e</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-65" x="1193" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> Bce </script>  Al cambiar la arquitectura y usar In-place BatchNorm, comenzamos a buscar defectos en la foto.  Pero a un precio econ√≥mico, podr√≠a hacerlo incluso un poco mejor agregando Test Time Augmentation.  Podemos ejecutar la red una vez en la imagen de entrada, luego reflejarla y ejecutar la red nuevamente, esto puede ayudarnos a encontrar peque√±os defectos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c75/95b/702/c7595b702dcb921dac612b0218ce13e4.png"><br><br>  Como resultado, nuestra red convergi√≥ en cuatro GeForce 1080Ti en 18 horas.  La inferencia toma 290 ms.  Resulta que es lo suficientemente largo, pero es una tarifa por el hecho de que estamos buscando defectos peque√±os.  Validaci√≥n <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi><mi>I</mi><mi>C</mi><mi>E</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.638ex" height="2.057ex" viewBox="0 -780.1 2858 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-44" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-49" x="828" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-43" x="1333" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-45" x="2093" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yo</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-5"> DICE </script>  igual a 0,35 y <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>R</mi><mi>O</mi><mi>C</mi><mi>A</mi><mi>U</mi><mi>C</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.596ex" height="2.057ex" viewBox="0 -780.1 4562 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-52" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-4F" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-43" x="1523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-41" x="2283" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-55" x="3034" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhjTfGjV4r1JwCQ2Vuu6nJj0F0e-TQ#MJMATHI-43" x="3801" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-6"> ROCAUC </script>  - 0,93. <br><br><h1>  Restauraci√≥n de fragmentos </h1><br>  Unet nos ayud√≥ a resolver este problema nuevamente.  A la entrada le dimos la imagen original y una m√°scara en la que marcamos espacios limpios con unidades y esos p√≠xeles que queremos pintar con ceros.  Recopilamos los datos de la siguiente manera: tomamos de Internet un gran conjunto de datos con im√°genes, por ejemplo, OpenImagesV4, y defectos a√±adidos artificialmente que son similares en forma a los que se encuentran en la vida real.  Y despu√©s de eso, entrenaron a la red para reparar las partes faltantes. <br><br>  ¬øC√≥mo podemos modificar Unet para esta tarea? <br><br>  Puede usar la convoluci√≥n parcial en lugar de la convoluci√≥n habitual.  Su idea es que cuando colapsamos una regi√≥n de una imagen con un n√∫cleo, no tenemos en cuenta los valores de p√≠xeles relacionados con los defectos.  Esto ayuda a que la pintura sea m√°s precisa.  Un ejemplo de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo de NVIDIA</a> .  En la imagen central, usaron Unet con la convoluci√≥n habitual, y a la derecha, con convoluci√≥n parcial: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a5/280/a4b/5a5280a4be71695d16ab08af876c5d23.png"><br><br>  Entrenamos la red durante 5 d√≠as.  El √∫ltimo d√≠a, congelamos BatchNorm, esto ayud√≥ a que los bordes de la parte pintada de la imagen fueran menos visibles. <br><br>  La red procesa una imagen de 512 x 512 en 50 ms.  La validaci√≥n PSNR es 26.4.  Sin embargo, no se puede confiar incondicionalmente en esta tarea.  Por lo tanto, primero ejecutamos varios modelos buenos en nuestros datos, anonimizamos los resultados y luego votamos por los que m√°s nos gustaron.  Entonces elegimos el modelo final. <br><br>  Mencion√© que agregamos artificialmente defectos para limpiar im√°genes.  Al entrenar, debe monitorear cuidadosamente el tama√±o m√°ximo de los defectos superpuestos, porque con defectos muy grandes que la red nunca ha visto en el proceso de aprendizaje, fantasear√° y dar√° un resultado absolutamente inaplicable.  Entonces, si necesita pintar sobre defectos grandes, tambi√©n aplique defectos grandes durante el entrenamiento. <br><br>  Aqu√≠ hay un ejemplo del algoritmo: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abd/6cb/c8c/abd6cbc8c05396042bf83c00516b630e.png"><br><br><h1>  Colorear </h1><br>  Segmentamos los defectos y los pintamos, el tercer paso es la reconstrucci√≥n del color.  Perm√≠teme recordarte que entre las fotograf√≠as del "Regimiento Inmortal" hay muchos retratos individuales o grupales.  Y quer√≠amos que nuestra red funcionara bien con ellos.  Decidimos hacer nuestra propia coloraci√≥n, porque ninguno de los servicios que conocemos pinta retratos de forma r√°pida y adecuada. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/015/bce/bf1/015bcebf15ef1ee069fdf08f16e00542.png"><br><br>  GitHub tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> popular para colorear fotos.  En promedio, hace bien este trabajo, pero tiene varios problemas.  Por ejemplo, le encanta pintar la ropa de azul.  Por lo tanto, tambi√©n lo rechazamos. <br><br>  Entonces, decidimos hacer una red neuronal para la coloraci√≥n.  La idea m√°s obvia: tomar una imagen en blanco y negro y predecir tres canales, rojo, verde y azul.  Pero, en t√©rminos generales, podemos simplificar nuestro trabajo.  Podemos trabajar no con la representaci√≥n RGB del color, sino con la representaci√≥n YCbCr.  El componente Y es brillo (luma).  La imagen en blanco y negro descargada es el canal Y, la reutilizaremos.  Quedaba por predecir Cb y Cr: Cb es la diferencia en color azul y brillo, y Cr es la diferencia en color rojo y brillo. <br><br><img src="https://habrastorage.org/webt/k8/ke/l_/k8kel_xrjco6euolh8ypkchjm8g.jpeg"><br><br>  ¬øPor qu√© elegimos la vista YCbCr?  El ojo humano es m√°s susceptible a los cambios de brillo que a los cambios de color.  Por lo tanto, reutilizamos el componente Y (brillo), algo a lo que el ojo es inicialmente receptivo, y predecimos Cb y Cr, en el que podemos cometer un poco m√°s de error, ya que las personas notan menos colores "falsos".  Esta caracter√≠stica comenz√≥ a utilizarse activamente en los albores de la televisi√≥n en color, cuando el ancho de banda del canal no era suficiente para transmitir todos los colores en su totalidad.  La imagen se transfiri√≥ a YCbCr, se transfiri√≥ al componente Y sin cambios, y Cb y Cr se comprimieron dos veces. <br><br><h1>  C√≥mo ensamblar la l√≠nea base </h1><br>  Puede volver a tomar Unet con un codificador previamente entrenado y minimizar la p√©rdida de L1 entre el CbCr real y el previsto.  Queremos colorear los retratos, por lo que, adem√°s de las fotos de OpenImages, necesitamos agregar fotos espec√≠ficas para nuestra tarea. <br><br>  ¬øD√≥nde puedo obtener fotograf√≠as en color de personas con uniforme militar?  Hay personas en Internet que pintan fotograf√≠as antiguas como un pasatiempo o por encargo.  Lo hacen con mucho cuidado, tratando de cumplir con todos los matices.  Coloreando el uniforme, charreteras, medallas, recurren a materiales de archivo, por lo que se puede confiar en el resultado de su trabajo.  En total, utilizamos 200 fotograf√≠as pintadas a mano.  La segunda fuente de datos √∫til es el sitio del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ej√©rcito Rojo de Trabajadores y Campesinos</a> .  Uno de sus creadores fue fotografiado en casi todas las variantes posibles de un uniforme militar durante la Gran Guerra Patria. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f72/999/7d9/f729997d9fd02755fd95967ff09d27ca.png"><br><br>  En algunas fotograf√≠as, repiti√≥ las poses de personas de famosas fotograf√≠as de archivo.  Es especialmente bueno que haya disparado sobre un fondo blanco, esto nos permiti√≥ aumentar muy bien los datos, agregando varios objetos naturales al fondo.  Tambi√©n utilizamos retratos modernos de personas comunes, que los complementan con insignias y otros atributos de la ropa de guerra. <br><br>  Entrenamos a AlbuNet-50: este es Unet, en el que se utiliza AlbuNet-50 como codificador.  La red comenz√≥ a dar resultados adecuados: la piel es rosada, los ojos son gris azulados, las correas de los hombros son amarillentas.  Pero el problema es que ella pint√≥ las im√°genes con manchas.  Esto se debe al hecho de que, desde el punto de vista del error L1, a veces es m√°s rentable no hacer nada que intentar predecir algo de color. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/435/4a9/63c/4354a963c4cd2789c434002e44fdda26.png"><br>  <i>Estamos comparando nuestro resultado con una foto de Ground Truth - coloraci√≥n manual del artista bajo el apodo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Klimbim</a></i> <br><br>  ¬øC√≥mo resolver este problema?  Necesitamos un discriminador: una red neuronal, a la que proporcionaremos im√°genes a la entrada, y dir√° cu√°n realista se ve esta imagen.  A continuaci√≥n, una fotograf√≠a est√° pintada a mano y la segunda por una red neuronal.  ¬øCu√°l te parece? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/253/86a/abd/25386aabd9080c14daf71b60d9968453.png"><br><br><div class="spoiler">  <b class="spoiler_title">La respuesta</b> <div class="spoiler_text">  La foto de la izquierda est√° pintada manualmente. <br></div></div><br>  Como discriminador, utilizamos el discriminador del art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Self-Attention GAN</a> .  Esta es una peque√±a red de convoluci√≥n, en las √∫ltimas capas de las cuales est√° incorporada la llamada Auto-Atenci√≥n.  Le permite "prestar m√°s atenci√≥n" a los detalles de la imagen.  Tambi√©n utilizamos la normalizaci√≥n espectral.  La explicaci√≥n exacta y la motivaci√≥n se pueden encontrar en el art√≠culo.  Entrenamos una red con una combinaci√≥n de p√©rdida L1 y el error devuelto por el discriminador.  Ahora la red pinta mejor los detalles de la imagen y el fondo es m√°s consistente.  Otro ejemplo: a la izquierda es el resultado de la red entrenada solo con p√©rdida L1, a la derecha, con p√©rdida L1 y un error discriminador. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa4/724/ada/aa4724ada4e0bbdc52dbcaadd5bb3fdc.png"><br><br>  En cuatro Geforce 1080Ti, el entrenamiento tom√≥ dos d√≠as.  La red funcion√≥ en 30 ms en la imagen de 512 x 512. La validaci√≥n MSE fue de 34.4.  Como en el problema de la pintura, no se puede confiar plenamente en las m√©tricas.  Por lo tanto, seleccionamos 6 modelos que ten√≠an las mejores m√©tricas para la validaci√≥n y votamos ciegamente por el mejor modelo. <br><br>  Despu√©s de implementar el modelo en producci√≥n, continuamos los experimentos y llegamos a la conclusi√≥n de que es mejor minimizar no la p√©rdida L1 por p√≠xel, sino la p√©rdida perceptiva.  Para calcularlo, debe ejecutar la predicci√≥n de red y la foto de origen a trav√©s de la red VGG-16, tomar los mapas de atributos en las capas inferiores y compararlos de acuerdo con MSE.  Este enfoque pinta m√°s √°reas y ayuda a obtener una imagen m√°s colorida. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db9/303/509/db93035094c4906cf82c246151432cbc.jpg"><br><br><h1>  Conclusiones y conclusiones </h1><br>  Unet es una modelo genial.  En el primer problema de segmentaci√≥n, encontramos un problema al entrenar y trabajar con im√°genes de alta resoluci√≥n, por lo que usamos In-Place BatchNorm.  En la segunda tarea (Inpainting), en lugar de la convoluci√≥n habitual, utilizamos Convoluci√≥n parcial, esto ayud√≥ a lograr mejores resultados.  En el problema de colorizaci√≥n de Unet, agregamos una peque√±a red discriminadora que mult√≥ al generador por una imagen de aspecto poco realista y usamos la p√©rdida de percepci√≥n. <br><br>  La segunda conclusi√≥n es que los accesores son importantes.  Y no solo en la etapa de marcar las im√°genes antes del entrenamiento, sino tambi√©n para validar el resultado final, porque en problemas de defectos de pintura o coloraci√≥n, a√∫n debe validar el resultado con la ayuda de una persona.  Le damos al usuario tres fotos: la original con los defectos eliminados, coloreada con los defectos eliminados, y solo la foto coloreada en caso de que el algoritmo para encontrar y pintar defectos sea incorrecto. <br><br>  Tomamos algunas fotos del proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Military Album</a> y las procesamos con nuestras redes neuronales.  Aqu√≠ est√°n los resultados obtenidos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a51/ade/15e/a51ade15e9cee54ec8269dc1e22df0af.jpg"><br><br>  Y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> puede verlos en la resoluci√≥n original y en cada etapa del procesamiento. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453872/">https://habr.com/ru/post/453872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453862/index.html">Por qu√© deber√≠as usar pathlib</a></li>
<li><a href="../453864/index.html">¬øUsar un mouse y un teclado en las consolas es hacer trampa?</a></li>
<li><a href="../453866/index.html">Solicitud API con React Hooks, HOC o Render Prop</a></li>
<li><a href="../453868/index.html">Mini interruptor t√°ctil con panel de vidrio en nRF52832</a></li>
<li><a href="../453870/index.html">Escribimos Reverse socks5 proxy en powershell. Parte 1</a></li>
<li><a href="../453874/index.html">De la ruleta rusa a Safe LOTO: c√≥mo proteger al personal del centro de datos</a></li>
<li><a href="../453876/index.html">Como en Yandex.Practicum, gan√≥ la desincronizaci√≥n frontal: un n√∫mero acrob√°tico con Redux-Saga, postMessage y Jupyter</a></li>
<li><a href="../453882/index.html">Una gran gu√≠a sobre la profesi√≥n de arquitecto de soluciones (+ lista de enlaces √∫tiles)</a></li>
<li><a href="../453884/index.html">¬øC√°mara HYIP o reemplazo de DSLR?</a></li>
<li><a href="../453886/index.html">El programa funciona</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>