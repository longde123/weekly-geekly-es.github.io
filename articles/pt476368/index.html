<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèø üóûÔ∏è ü•¢ Criando um CI / CD dom√©stico com a√ß√µes do GitHub e Python üßïüèº üññüèª üëÉüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma noite, quando cheguei em casa do trabalho, decidi fazer um pouco de li√ß√£o de casa. Fiz v√°rias edi√ß√µes e imediatamente quis experimentar com elas. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Criando um CI / CD dom√©stico com a√ß√µes do GitHub e Python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476368/"><p> Uma noite, quando cheguei em casa do trabalho, decidi fazer um pouco de li√ß√£o de casa.  Fiz v√°rias edi√ß√µes e imediatamente quis experimentar com elas.  Por√©m, antes dos experimentos, eu tinha que entrar no VPS, fazer altera√ß√µes, reconstruir o cont√™iner e execut√°-lo.  Ent√£o decidi que era hora de lidar com a entrega cont√≠nua. <br><img src="https://habrastorage.org/webt/xa/l4/dm/xal4dmowtxwpuoxxrutujwwy4fm.jpeg"></p><a name="habracut"></a><br><p>  Inicialmente, eu tive uma escolha entre Circle CI, Travis ou Jenkins.  Eu descartei Jenkins quase imediatamente devido √† falta de necessidade de uma ferramenta t√£o poderosa.  Ap√≥s uma r√°pida leitura sobre Travis, cheguei √† conclus√£o de que √© conveniente montar e testar nele, mas voc√™ n√£o pode imaginar nenhuma entrega com ele.  Eu aprendi sobre o Circle CI com an√∫ncios excessivamente intrusivos no youtube.  Comecei a experimentar exemplos, mas em algum momento eu estava enganado e fiz testes eternos, o que levou muitos preciosos minutos de montagem (em geral, h√° um limite suficiente para n√£o me preocupar, mas isso me atingiu).  Ao retomar a pesquisa, me deparei com o Github Actions.  Depois de brincar com os exemplos de introdu√ß√£o, tive uma impress√£o positiva e, depois de uma r√°pida olhada na documenta√ß√£o, cheguei √† conclus√£o de que √© muito legal manter segredos para montar, coletar e praticamente implantar projetos em um s√≥ lugar.  Com olhos brilhantes, ele rapidamente desenhou o esquema desejado e as engrenagens giraram. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/fp/rv/h1fprvm3jru4em3vj0ae6xruu5i.jpeg" alt="planejar"></div><br><p>  Primeiro, tentaremos fazer o teste.  Como experimental, escrevi um servidor Web simples no Flask com 2 pontos de extremidade: </p><br><div class="spoiler">  <b class="spoiler_title">Listando um aplicativo Web simples</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request, jsonify app = Flask(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_post_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: dict)</span></span></span><span class="hljs-function"> -&gt; bool:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data, dict): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], str): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'age'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'age'</span></span>], int): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" /api entpoint GET - returns json= {'status': 'test'} POST - { name - str not null age - int optional } :return: """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'GET'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> validate_post_data(request.json): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}), <span class="hljs-number"><span class="hljs-number">400</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre> </div></div><br><p>  E alguns testes: </p><br><div class="spoiler">  <b class="spoiler_title">Listagem de teste de aplicativos</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> </pre> </div></div><br><p>  Sa√≠da de cobertura: </p><br><pre> <code class="plaintext hljs">coverage report Name Stmts Miss Cover ------------------------------------------------------------------ src/app.py 28 2 93% src/tests.py 37 0 100% ------------------------------------------------------------------ TOTAL 65 2 96%</code> </pre> <br><p>  Agora crie nossa primeira a√ß√£o, que executar√° os testes.  De acordo com a documenta√ß√£o, todas as a√ß√µes devem ser armazenadas em um diret√≥rio especial: </p><br><pre> <code class="bash hljs">$ mkdir -p .github/workflows $ touch .github/workflows/test_on_push.yaml</code> </pre> <br><p>  Desejo que esta a√ß√£o seja executada em qualquer evento push em qualquer ramifica√ß√£o, exceto nas libera√ß√µes (tags, porque haver√° testes separados): </p><br><pre> <code class="plaintext hljs">on: push: tags: - '!refs/tags/*' branches: - '*'</code> </pre> <br><p>  Em seguida, criamos uma tarefa que ser√° executada na vers√£o mais recente dispon√≠vel do Ubuntu: </p><br><pre> <code class="plaintext hljs">jobs: run_tests: runs-on: [ubuntu-latest]</code> </pre> <br><p>  Em etapas, iremos verificar o c√≥digo, instalar o python, instalar depend√™ncias, executar testes e exibir a cobertura: </p><br><pre> <code class="plaintext hljs">steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Todos juntos</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Run tests on any Push event #    push    ,    . #      on: push: tags: - '!refs/tags/*' branches: - '*' jobs: run_tests: runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> </div></div><br><p>  Vamos tentar criar um commit e ver como nossa a√ß√£o funciona. <br><img src="https://habrastorage.org/webt/qy/v7/by/qyv7byybfnvpnkurriqvydsp_xk.png"><br>  <em>Passando testes na interface Actions</em> </p><br><p>  Hooray, conseguimos criar a primeira a√ß√£o e execut√°-la!  Vamos tentar quebrar algum tipo de teste e ver a sa√≠da: <br><img src="https://habrastorage.org/webt/dr/vn/_s/drvn_sgrq-esw6sgxjiylhhy02w.png"><br>  <em>Testes falham na interface Actions</em> </p><br><p>  Os testes falharam.  O indicador ficou vermelho e at√© recebeu uma notifica√ß√£o pelo correio.  O que voc√™ precisa!  3 de 8 pontos do esquema de destino podem ser considerados cumpridos.  Agora vamos tentar lidar com a montagem, o armazenamento de nossas imagens do docker. </p><br><p>  <strong>Nota!</strong>  <strong>Em seguida, precisamos de uma conta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docker</a></strong> </p><br><p>  Primeiro, escreveremos um Dockerfile simples no qual nosso aplicativo ser√° executado. </p><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> </pre> </div></div><br><p>  Para enviar um cont√™iner para o hub, ser√° necess√°rio fazer login na janela de encaixe, mas como n√£o quero que o mundo inteiro saiba a senha da conta, usarei os segredos incorporados ao GitHub.  Em geral, somente as senhas podem ser colocadas em segredo, e o restante ser√° codificado em * .yaml, e isso funcionar√°.  Mas eu gostaria de copiar e colar minhas a√ß√µes sem altera√ß√µes e obter todas as informa√ß√µes espec√≠ficas dos segredos. </p><br><p><img src="https://habrastorage.org/webt/2c/h8/5t/2ch85tdbuovsc7ywejh5gmrmvgw.png"><br>  <em>Segredos do Github</em> </p><br><p>  DOCKER_LOGIN - fa√ßa o login em hub.docker.com <br>  DOCKER_PWD - senha <br>  DOCKER_NAME - nome do reposit√≥rio do docker para este projeto (deve ser criado com anteced√™ncia) </p><br><p>  Ok, a prepara√ß√£o est√° conclu√≠da, agora vamos criar nossa segunda a√ß√£o: </p><br><pre> <code class="bash hljs">$ touch .github/workflows/pub_on_release.yaml</code> </pre> <br><p>  Copiamos o teste da a√ß√£o anterior, com exce√ß√£o do gatilho de inicializa√ß√£o (n√£o encontrei como importar as a√ß√µes).  N√≥s o substitu√≠mos por "Launch on release": </p><br><pre> <code class="plaintext hljs">on: release: types: [published]</code> </pre> <br><p>  <strong>IMPORTANTE!</strong>  <strong>√â muito importante garantir a condi√ß√£o correta.</strong> <br>  Por exemplo, se on.release n√£o especificar tipos, esse evento disparar√° pelo menos 2 eventos: publicados e criados.  Ou seja, 2 processos de montagem ser√£o iniciados imediatamente. </p><br><p>  Agora, no mesmo arquivo, faremos outra tarefa, dependendo da primeira: </p><br><pre> <code class="plaintext hljs">build_and_pub: needs: [run_tests]</code> </pre> <br><p>  needs - diz que esta tarefa n√£o ser√° iniciada at√© que run_tests termine </p><br><p>  <strong>IMPORTANTE!</strong>  <strong>Se voc√™ possui v√°rios arquivos de a√ß√£o e, dentro deles, v√°rias tarefas, todos eles s√£o executados simultaneamente em diferentes ambientes.</strong>  Um ambiente separado √© criado para cada tarefa, independente de outras tarefas.  se voc√™ n√£o especificar necessidades, a tarefa de teste e os conjuntos ser√£o iniciados simultaneamente e independentemente um do outro. </p><br><p>  Adicione vari√°veis ‚Äã‚Äãde ambiente nas quais nossos segredos ser√£o: </p><br><pre> <code class="plaintext hljs">env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }}</code> </pre> <br><p>  Agora, as etapas de nossa tarefa, nelas, devemos efetuar login na janela de encaixe, coletar o cont√™iner e public√°-lo no registro: </p><br><pre> <code class="plaintext hljs">steps: - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - uses: actions/checkout@master - name: Build image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:11}</code> </pre> <br><p>  $ {GITHUB_REF: 11} √© uma vari√°vel do github que armazena uma linha com uma refer√™ncia ao evento para o qual o gatilho funcionou (nome do ramo, tag etc.). Se tivermos tags do formato "v0.0.0", ser√° necess√°rio aparar os 11 primeiros. caracteres, ent√£o "0.0.0" permanece. </p><br><p>  Empurre o c√≥digo e crie uma nova tag.  E vemos que nosso cont√™iner foi montado e enviado com sucesso para o registro e n√£o iluminamos nossa senha em nenhum lugar. </p><br><p><img src="https://habrastorage.org/webt/mg/yt/i-/mgyti-mww_fcqsmbiqk6zli7swo.png"><br>  <em>Construir e enviar cont√™iner na interface Actions</em> </p><br><p>  Verifique o hub: </p><br><p><img src="https://habrastorage.org/webt/ut/nw/vd/utnwvdtcprbqfpavnnirqmqim0s.png"><br>  <em>Cont√™iner armazenado no hub docker</em> </p><br><p>  Tudo funciona, mas a tarefa mais dif√≠cil permanece - a implanta√ß√£o.  Aqui voc√™ j√° precisar√° de um VPS e um endere√ßo IP branco onde implantaremos o cont√™iner e onde poder√° enviar o gancho.  Em teoria, no lado do VPS ou do servidor dom√©stico, voc√™ pode executar um script na coroa, que no caso de uma nova imagem a dispararia ou, de alguma forma, brincar com o bot de telegrama.  Certamente, existem v√°rias maneiras de fazer isso.  Mas vou trabalhar com ip externo.  Para n√£o ser inteligente, escrevi um pequeno servi√ßo da Web no Flask com uma API simples. <br>  Em resumo, h√° 1 ponto final "/". <br>  Uma solicita√ß√£o GET retorna json com todos os cont√™ineres ativos no host. <br>  POST - recebe dados no formato: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"owner"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"v0.0.1"</span></span>, #    <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"8080"</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, ‚Äú443‚Äù: <span class="hljs-number"><span class="hljs-number">443</span></span>} #      }</code> </pre> <br><p>  O que acontece no host: </p><br><ol><li>  do json recebido o nome de uma nova imagem </li><li>  uma nova imagem est√° aumentando </li><li>  se a imagem foi baixada, o cont√™iner atual √© parado e exclu√≠do </li><li>  um novo cont√™iner √© lan√ßado, com a publica√ß√£o de portas (sinalizador -p) </li></ol><br><p>  Todo o trabalho com o docker √© feito usando a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docker-py</a> </p><br><p>  Seria muito errado publicar um servi√ßo desse tipo na Internet sem nenhuma prote√ß√£o m√≠nima, e eu criei uma apar√™ncia de API KEY, o servi√ßo l√™ o token das vari√°veis ‚Äã‚Äãde ambiente e o compara com o cabe√ßalho {Authorization: CI_TOKEN} </p><br><div class="spoiler">  <b class="spoiler_title">Listagem de servidores da Web para implanta√ß√£o</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  Para este aplicativo, eu tamb√©m fiz o setup.py para instal√°-lo no sistema.  Voc√™ pode instal√°-lo usando: </p><br><pre> <code class="bash hljs">$ python3 setup.sy install</code> </pre> <br><p>  desde que voc√™ tenha baixado os arquivos e esteja no diret√≥rio deste aplicativo. <br>  Ap√≥s a instala√ß√£o, voc√™ deve ativar o aplicativo como um servi√ßo para que ele se inicie no caso de uma reinicializa√ß√£o do servidor, para isso usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">systemd</a> <br>  Aqui est√° um arquivo de configura√ß√£o de exemplo: </p><br><pre> <code class="plaintext hljs">[Unit] Description=Deployment web server After=network-online.target [Service] Type=simple RestartSec=3 ExecStart=/usr/local/bin/ci_example Environment=CI_TOKEN=#&lt;I generate it with $(openssl rand -hex 20)&gt; [Install] WantedBy=multi-user.target</code> </pre><br><p>  Resta apenas execut√°-lo: </p><br><pre> <code class="bash hljs">$ sudo systemctl daemon-reload $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ci_example.service $ sudo systemctl start ci_example.service</code> </pre> <br><p>  Voc√™ pode visualizar o log do servidor de entrega na web usando o comando </p><br><pre> <code class="bash hljs">$ sudo systemctl status ci_example.service</code> </pre> <br><p>  A parte do servidor est√° pronta, resta apenas adicionar um gancho √† nossa a√ß√£o.  Para fazer isso, adicione os segredos do endere√ßo IP do nosso servidor e o CI_TOKEN que geramos quando instalamos o aplicativo. <br>  No come√ßo, eu queria usar uma a√ß√£o pronta para curl do mercado github, mas, infelizmente, remove as aspas do corpo da solicita√ß√£o POST, o que impossibilitou a an√°lise de json.  Obviamente, isso n√£o me agradou e decidi usar o curl embutido no ubuntu (no qual coleciono cont√™ineres), que ali√°s tinha um efeito positivo no desempenho, porque n√£o requer a montagem de um cont√™iner adicional: </p><br><pre> <code class="plaintext hljs">deploy: needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre><br><p>  <strong>Nota: √© muito importante especificar a op√ß√£o --fail, caso contr√°rio, qualquer solicita√ß√£o ser√° bem-sucedida, mesmo que um erro tenha sido recebido em resposta.</strong> <br>  Tamb√©m √© importante notar que as vari√°veis ‚Äã‚Äãusadas na solicita√ß√£o n√£o s√£o realmente vari√°veis, mas fun√ß√µes especiais chamadas com exce√ß√£o de GITHUB_REF, e √© por isso que por um longo tempo n√£o entendi por que a solicita√ß√£o n√£o estava funcionando corretamente.  Mas, tendo feito disso uma fun√ß√£o, tudo deu certo. </p><br><div class="spoiler">  <b class="spoiler_title">A√ß√£o cria e implanta</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre> </div></div><br><p>  Ok, reunimos tudo, agora vamos criar uma nova vers√£o e analisar as a√ß√µes. <br><img src="https://habrastorage.org/webt/07/dn/5q/07dn5qrqodyyfaulm6gpey7w8my.png"><br>  <em>Webhook para interface de a√ß√µes do aplicativo de implanta√ß√£o</em> </p><br><p>  Tudo acabou, fazemos uma solicita√ß√£o GET ao servi√ßo de implanta√ß√£o (exibe todos os cont√™ineres ativos no host): <br><img src="https://habrastorage.org/webt/gq/1w/yg/gq1wygbewjefugj8itjchn2ucki.png"><br>  <em>Implantado no cont√™iner VPS</em> </p><br><p>  Agora, enviaremos solicita√ß√µes para nosso aplicativo implantado: <br><img src="https://habrastorage.org/webt/hs/9x/hz/hs9xhzawrwliyoptcccjd-48bco.png"><br>  <em>Solicita√ß√£o GET para o cont√™iner implantado</em> </p><br><img src="https://habrastorage.org/webt/jf/fy/xc/jffyxcdf8zyzfylylyufv8wlcp0.png" alt="Solicita√ß√£o post para cont√™iner implantado"><br><p>  <em>Solicita√ß√£o POST para cont√™iner implantado</em> </p><br><p>  <strong>Conclus√µes</strong> <br>  O GitHub Actions √© uma ferramenta muito conveniente e flex√≠vel com a qual voc√™ pode fazer muitas coisas que podem simplificar bastante sua vida.  Tudo depende da imagina√ß√£o. <br>  Eles suportam testes de integra√ß√£o com servi√ßos. <br>  Como uma continua√ß√£o l√≥gica deste projeto, voc√™ pode adicionar ao webhook a capacidade de passar par√¢metros personalizados para iniciar o cont√™iner. <br>  No futuro, tentarei tomar como base este projeto para a implanta√ß√£o de gr√°ficos de leme quando estudar e experimentar os k8s </p><br><p>  Se voc√™ tem algum tipo de projeto inicial, as A√ß√µes do GitHub podem simplificar bastante o trabalho com o reposit√≥rio. </p><br><p>  Detalhes da sintaxe podem ser encontrados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui.</a> <br>  Todas as fontes do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto</a> </p><cut text=" "></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt476368/">https://habr.com/ru/post/pt476368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt476348/index.html">Como os qu√≠micos de uma universidade estadual introduziram os princ√≠pios de TI em seu trabalho e se tornaram l√≠deres de equipe</a></li>
<li><a href="../pt476352/index.html">Gerenciamento de servi√ßo de campo e servi√ßo de campo. A R√∫ssia chegou ao ponto de gerenciar engenheiros de servi√ßo de campo?</a></li>
<li><a href="../pt476354/index.html">Tr√™s etapas pr√°ticas para economizar recursos da sua inicializa√ß√£o</a></li>
<li><a href="../pt476358/index.html">Malha de servi√ßo para microsservi√ßos. Parte I</a></li>
<li><a href="../pt476366/index.html">O teto foi: como entender que √© hora de um terapeuta e como encontr√°-lo</a></li>
<li><a href="../pt476370/index.html">O site oficial da JetBrains j√° est√° dispon√≠vel em russo</a></li>
<li><a href="../pt476372/index.html">A teoria das categorias permite que a matem√°tica abandone as igualdades</a></li>
<li><a href="../pt476374/index.html">Os irm√£os Wright: primeiros trolls de patentes</a></li>
<li><a href="../pt476378/index.html">V√° com calma, CUDA - Intel anuncia GPU de 7 nm para data centers</a></li>
<li><a href="../pt476380/index.html">Com√©rcio de criptomoedas - Como desenvolver uma estrat√©gia sustent√°vel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>