<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîè üíû ‚è±Ô∏è PHP sem servidor üê© üßëüèΩ‚Äçü§ù‚Äçüßëüèª ‚ò¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na v√©spera do lan√ßamento do curso Backend PHP Developer, tivemos uma li√ß√£o aberta tradicional . Dessa vez, nos familiarizamos com o conceito Serverles...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP sem servidor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/477370/"><p>  Na v√©spera do lan√ßamento do curso <a href="https://otus.pw/PjYz/">Backend PHP Developer,</a> tivemos uma <a href="https://www.youtube.com/watch%3Fv%3DcGBggTdDmKI">li√ß√£o aberta tradicional</a> .  Dessa vez, nos familiarizamos com o conceito Serverless, conversamos sobre sua implementa√ß√£o na AWS, discutimos os princ√≠pios de opera√ß√£o, montagem e lan√ßamento e tamb√©m constru√≠mos um simples PHP-bot PHP baseado no AWS Lambda. </p><br><p>  Palestrante - <a href="https://otus.ru/teacher/491/">Alexander Pryakhin</a> , CTO da Westwing R√∫ssia. </p><br><hr><br><p><img src="https://habrastorage.org/webt/fm/-y/de/fm-yde0vvpixphwgwoqfsumq-n4.jpeg"></p><a name="habracut"></a><br><h2 id="kratkiy-ekskurs-v-istoriyu">  Uma breve excurs√£o pela hist√≥ria </h2><br><p><img src="https://habrastorage.org/webt/w7/jh/mk/w7jhmkufvziqczxd8ppmbgjylpy.png"></p><br><p>  Como chegamos a uma vida em que a computa√ß√£o sem servidor apareceu?  Obviamente, eles apareceram n√£o apenas assim, mas se tornaram uma continua√ß√£o l√≥gica das tecnologias de virtualiza√ß√£o existentes. </p><br><p><img src="https://habrastorage.org/webt/am/jv/dt/amjvdt02rv2bv7_-yhbexlhejm0.png"></p><br><p>  O que geralmente virtualizamos?  Por exemplo, um processador.  Voc√™ tamb√©m pode virtualizar a mem√≥ria real√ßando certas √°reas da mem√≥ria e tornando-as acess√≠veis a alguns usu√°rios e inacess√≠veis a outros.  Voc√™ pode virtualizar uma rede VPN.  E assim por diante </p><br><p><img src="https://habrastorage.org/webt/il/2o/p_/il2op_dxfloq7om6r_czugnhebq.png"></p><br><p>  A virtualiza√ß√£o √© boa porque utilizamos melhor os recursos e aumentamos a produtividade.  Mas tamb√©m h√° desvantagens, por exemplo, ao mesmo tempo, havia problemas de compatibilidade.  No entanto, praticamente n√£o h√° arquiteturas incompat√≠veis com as m√°quinas virtuais modernas. </p><br><p>  O pr√≥ximo ponto negativo √© que adicionamos uma camada adicional de abstra√ß√£o, adicionamos um hipervisor, adicionamos uma m√°quina virtual por si s√≥ e, √© claro, podemos perder um pouco de velocidade.  Um pouco complicado e o uso do servidor. </p><br><p><img src="https://habrastorage.org/webt/yh/on/4j/yhon4j0ial2rlrdfq_grqgx6yjw.png"></p><br><p>  Se levarmos uma m√°quina virtual padr√£o com voc√™, ser√° algo parecido com isto: </p><br><p><img src="https://habrastorage.org/webt/rq/ii/at/rqiiat114asa0rziaowjsjp1amg.png"></p><br><p> Em primeiro lugar, temos um servidor de ferro e, em segundo lugar, o sistema operacional no qual nosso hipervisor girar√°.  Al√©m disso, nossas m√°quinas virtuais est√£o girando, nas quais h√° um sistema operacional convidado, bibliotecas e aplicativos.  Se voc√™ pensar logicamente, veremos alguma sobrecarga na presen√ßa do SO convidado, porque na verdade gastamos recursos extras. </p><br><p>  Como posso resolver o problema de sobrecarga?  Recusando m√°quinas virtuais e colocando um sistema de gerenciamento de cont√™iner no topo do sistema operacional principal.  Obviamente, o sistema mais popular agora √© o Docker Engine.  Em seguida, as bibliotecas dentro do cont√™iner usar√£o o kernel host do sistema operacional. </p><br><p><img src="https://habrastorage.org/webt/rb/wv/ce/rbwvceyh5h8mrsgsst9bu8acadk.png"></p><br><p>  Dessa forma, removemos a sobrecarga, mas o Docker tamb√©m n√£o √© o ideal e possui seus pr√≥prios problemas e recursos de trabalho que nem todo mundo gosta. </p><br><p>  O principal a entender √© que o Docker e a m√°quina virtual s√£o abordagens diferentes e n√£o h√° necessidade de igual√°-las.  O Docker n√£o √© um microvirtual com o qual voc√™ pode trabalhar como em uma m√°quina virtual, porque o cont√™iner √© para isso e para o cont√™iner.  Mas o cont√™iner nos permite oferecer flexibilidade e uma abordagem completamente diferente da entrega cont√≠nua, quando entregamos coisas √† produ√ß√£o e entendemos que elas j√° est√£o testadas e funcionando. </p><br><h2 id="oblachnye-tehnologii">  Tecnologia em nuvem </h2><br><p>  Com o desenvolvimento da virtualiza√ß√£o, as tecnologias em nuvem tamb√©m come√ßaram a se desenvolver.  Essa √© uma boa solu√ß√£o, mas vale a pena mencionar imediatamente que as nuvens n√£o s√£o uma bala de prata e nem uma panac√©ia para todos os males.  Aqui n√£o se pode deixar de lembrar uma cita√ß√£o famosa: </p><br><blockquote>  "Quando ou√ßo algu√©m divulgando a nuvem como uma bala m√°gica para todos os problemas de computa√ß√£o, substituo silenciosamente" nuvem "por" palha√ßo "e continuo com um sorriso zen." <br>  Amy rich </blockquote><p>  No entanto, para empresas de m√©dio porte que desejam receber um certo n√≠vel de servi√ßo e toler√¢ncia a falhas sem grandes inje√ß√µes financeiras, as nuvens s√£o uma op√ß√£o.  E para muitas empresas, manter seu data center com o mesmo SLA ser√° muito mais caro do que ser servido na nuvem.  Al√©m disso, podemos usar as nuvens para nossas necessidades, pois elas fornecem algumas coisas com apenas alguns cliques do mouse, o que √© muito conveniente.  Por exemplo, a capacidade de levantar uma m√°quina virtual ou rede em apenas alguns cliques. <br>  Sim, existem restri√ß√µes, por exemplo, a 152¬™ Lei Federal que pro√≠be o armazenamento de dados pessoais no exterior, portanto a mesma Amaz√¥nia n√£o ser√° adequada para n√≥s durante uma auditoria.  N√£o se esque√ßa do bloqueio de fornecedor.  Muitas solu√ß√µes em nuvem n√£o s√£o portadas uma para a outra, embora o mesmo armazenamento compat√≠vel com S3 seja suportado pela maioria dos provedores. </p><br><p>  As nuvens nos oferecem a oportunidade de receber diferentes n√≠veis de servi√ßo sem um conhecimento restrito.  Quanto menos conhecimento voc√™ precisar, mais pagaremos.  Na figura abaixo, √© poss√≠vel observar a pir√¢mide, onde, de baixo para cima, √© exibida a diminui√ß√£o dos requisitos de conhecimento t√©cnico ao usar a nuvem: </p><br><p><img src="https://habrastorage.org/webt/ro/hi/aj/rohiajoeei87pirilzujxcaelqs.png"></p><br><h2 id="serverless-i-faas-function-as-a-service">  Sem servidor e FaaS (fun√ß√£o como servi√ßo) </h2><br><p>  Sem servidor √© uma maneira bastante jovem de executar scripts nas nuvens, por exemplo, como a AWS (em termos da AWS, o servidor √© implementado no Lambda).  * As abordagens AaS listadas na pir√¢mide acima j√° s√£o familiares: IaaS (EC2, VDS), PaaS (hospedagem compartilhada), SaaS (Office 365, Tilda).  Portanto, sem servidor √© uma implementa√ß√£o da abordagem FaaS.  E essa abordagem consiste em fornecer ao usu√°rio uma plataforma pronta para o desenvolvimento, lan√ßamento e gerenciamento de determinadas funcionalidades sem a necessidade de auto-prepara√ß√£o e configura√ß√£o. </p><br><p>  Imagine que voc√™ tem uma m√°quina envolvida no processamento noturno de documentos, executando tarefas das 00:00 √†s 18:00 e, durante o restante das horas, ela fica ociosa.  A quest√£o √©: por que pagar por isso durante o dia?  E por que n√£o usar recursos gratuitos para outra coisa?  Esse desejo de otimiza√ß√£o e o desejo de gastar dinheiro apenas com o que voc√™ realmente usa e levou ao surgimento do FaaS. </p><br><p>  Sem servidor √© um recurso para executar c√≥digo e nada mais.  Isso n√£o significa que n√£o h√° servidor por tr√°s do nosso script - √© verdade, mas, na verdade, n√£o temos nenhum recurso alocado especificamente no qual nosso Lambda ser√° lan√ßado.  Quando executamos nosso script, a microestrutura se desdobra imediatamente, e esse n√£o √© o seu problema em princ√≠pio - voc√™ s√≥ pensa que tem o c√≥digo executado e n√£o precisa pensar em mais nada. <br>  Isso requer, √© claro, uma certa abordagem para o desenvolvimento do seu c√≥digo.  Por exemplo, voc√™ n√£o pode armazenar nada neste ambiente, √© necess√°rio retirar tudo.  Se forem dados, ser√° necess√°rio um banco de dados externo, se for um log, um servi√ßo de log externo, se for um arquivo, e um armazenamento de arquivo externo.  Felizmente, qualquer provedor sem servidor oferece a capacidade de se conectar a sistemas externos. </p><br><p>  Voc√™ s√≥ tem c√≥digo, trabalha no paradigma Stateless, n√£o tem estado.  Para o mesmo mundo do PHP, isso significa, por exemplo, que voc√™ pode esquecer o mecanismo de sess√£o padr√£o.  Em princ√≠pio, voc√™ pode at√© criar seu Serverless, e recentemente em Habr√© havia <a href="https://habr.com/ru/company/southbridge/blog/475044/">um artigo sobre esse assunto</a> . </p><br><p>  A id√©ia principal do Serverless √© que a infraestrutura n√£o exija suporte da equipe.  Tudo cai sobre os ombros da plataforma, pela qual voc√™, de fato, paga dinheiro.  Dos pontos negativos - voc√™ n√£o controla o ambiente de execu√ß√£o e n√£o sabe onde o que √© executado. </p><br><p>  Ent√£o sem servidor: </p><br><ul><li>  n√£o significa aus√™ncia f√≠sica do servidor; </li><li>  n√£o √© um assassino de virtualoks e Docker; </li><li>  n√£o exagere aqui e agora. <br>  Sem servidor deve ser empurrado conscientemente e deliberadamente.  Por exemplo, se voc√™ precisar testar rapidamente uma hip√≥tese sem envolver metade da equipe.  Ent√£o voc√™ obt√©m a fun√ß√£o como servi√ßo.  A fun√ß√£o responder√° a alguns eventos e, como h√° uma rea√ß√£o a eventos, esses eventos devem ser chamados por alguma coisa - para isso, existem muitos gatilhos na mesma AWS. </li></ul><br><p>  Recursos do FaaS: </p><br><ul><li>  infraestrutura n√£o requer configura√ß√£o; </li><li>  Modelo de evento ‚Äúpronto para uso‚Äù; </li><li>  Sem estado; </li><li>  o dimensionamento √© muito f√°cil e √© realizado automaticamente de acordo com as necessidades do usu√°rio. </li></ul><br><h2 id="aws-lambda">  AWS Lambda </h2><br><p>  A primeira implementa√ß√£o do FaaS dispon√≠vel ao p√∫blico √© o AWS Lambda.  Se for uma tese, possui os seguintes recursos: <br>  - dispon√≠vel desde 2014; <br>  - suporta Java pronto para uso, Node.js, Python, Go e tempos de execu√ß√£o personalizados; <br>  - pagamos por: <br>  n√∫mero de chamadas; <br>  prazo de entrega. <br>  AWS Lambda: por que √© necess√°rio: <br>  Elimina√ß√£o  Voc√™ paga apenas pelo tempo em que o servi√ßo est√° sendo executado. <br>  Velocidade.  O pr√≥prio Lambda sobe e trabalha muito r√°pido. <br>  Funcional.  O Lambda possui muitos recursos para integra√ß√£o com os servi√ßos da AWS. <br>  Performance.  Colocar um lambda √© bem dif√≠cil.  Paralelamente, ele pode ser executado, dependendo da regi√£o, de no m√°ximo 1000 a 3000 c√≥pias.  E, se desejado, esse limite pode ser aumentado escrevendo-se no suporte. </p><br><p>  Temos o corpo de um lambda, um editor on-line, o VPC como uma grade de computa√ß√£o virtual, o log, o pr√≥prio c√≥digo, vari√°veis ‚Äã‚Äãde ambiente e gatilhos que causam um lambda (a prop√≥sito, o versionamento funciona muito bem).  Excelente anatomia Lambda √© descrita <a href="https://habr.com/ru/post/457100/">neste artigo</a> . </p><br><p>  O c√≥digo √© armazenado no corpo (se esses idiomas forem suportados imediatamente) ou em camadas.  Temos um gatilho que chama o lambda, o lambda l√™ os ambientes tempor√°rios, puxa-os para si e executa nosso c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/sr/py/zu/srpyzu9gzq6gfkekd-tbo5zkmyq.png"></p><br><p>  Se tivermos um tempo de execu√ß√£o personalizado, teremos que colocar o c√≥digo em uma camada.  Se voc√™ trabalhou com o Docker, a camada do Docker √© muito semelhante √† camada no lambda - um tipo de quase-reposit√≥rio no qual nossa liga√ß√£o necess√°ria est√° localizada.  L√° temos o arquivo execut√°vel do ambiente (se estivermos falando sobre PHP, voc√™ deve colocar o bin√°rio PHP compilado com anteced√™ncia), o arquivo de inicializa√ß√£o lambda (localizado por padr√£o) e os scripts chamados diretamente que ser√£o executados. </p><br><p><img src="https://habrastorage.org/webt/pj/es/fp/pjesfpgl0xix6psx4tqwegms_4m.png"></p><br><p>  Com a entrega, tudo n√£o √© t√£o otimista: </p><br><p><img src="https://habrastorage.org/webt/xg/qt/km/xgqtkmwgjqrisunlmvwtgym2nkk.png"></p><br><p>  Ou seja, somos oferecidos para pegar arquivos com o c√≥digo, envi√°-lo para o arquivo zip, envi√°-lo para a camada e executar nosso c√≥digo.  √â absolutamente legal que isso seja oferecido na documenta√ß√£o oficial da Amazon. </p><br><p><img src="https://habrastorage.org/webt/w2/ls/vr/w2lsvrvdjcbta6km5boxp3ntsgw.png"></p><br><p>  √â claro que isso n√£o corresponde √†s realidades modernas e ao cheiro de dois mil√©simos no ar.  Felizmente, pessoas gentis tentaram e criaram v√°rias estruturas, portanto, usaremos a estrutura sem servidor desenvolvida no Node.js e nos permitir√° gerenciar aplicativos com base no AWS Lambda.  Al√©m disso, quando falamos sobre implanta√ß√£o e desenvolvimento, √© claro, n√£o quero implantar manualmente, mas h√° um desejo de fazer algo flex√≠vel e automatizado. </p><br><p>  Ent√£o, precisamos: <br>  - AWS CLI - interface de linha de comando para trabalhar com servi√ßos da AWS; <br>  - a estrutura sem servidor j√° mencionada acima (a vers√£o de desenvolvimento √© gratuita e sua funcionalidade √© suficiente para os olhos); <br>  - A biblioteca Bref, necess√°ria para escrever c√≥digo.  Como a biblioteca √© instalada usando o compositor, o c√≥digo ser√° compat√≠vel com qualquer estrutura.  Uma √≥tima solu√ß√£o, especialmente considerando que o AWS Lambda n√£o oferece suporte √† chamada de scripts PHP imediatamente. </p><br><p><img src="https://habrastorage.org/webt/ke/de/4w/kede4wq7a7kupqj4zheld7ifkp0.png"></p><br><h2 id="nastraivaem-okruzhenie-i-aws">  Personalize seu ambiente e a AWS </h2><br><h3 id="aws-cli">  CLI da AWS </h3><br><p>  Vamos come√ßar criando uma conta e instalando a AWS CLI.  O shell do console da AWS √© baseado no Python 2.7+ ou 3.4+.  Como a AWS recomenda a vers√£o 3 do Python, n√£o discutiremos. <br>  Os exemplos abaixo s√£o para o Ubuntu. </p><br><pre><code class="plaintext hljs">sudo apt-get -y install python3-pip</code> </pre> <br><p>  Em seguida, instale diretamente o AWS CLI: </p><br><pre> <code class="plaintext hljs">pip3 install awscli --upgrade --user</code> </pre> <br><p>  Verifique a instala√ß√£o: </p><br><pre> <code class="plaintext hljs">aws --version</code> </pre> <br><p>  Agora voc√™ precisa conectar o AWS CLI √† sua conta.  Voc√™ pode usar seu nome de usu√°rio e senha existentes, mas seria melhor criar um usu√°rio separado por meio do AWS IAM, definindo-o apenas os direitos de acesso necess√°rios.  Chamar a configura√ß√£o n√£o causar√° problemas: </p><br><pre> <code class="plaintext hljs">aws configure</code> </pre> <br><p>  Em seguida, voc√™ precisar√° do AWS Secret e do AWS Access Key.  Eles podem ser obtidos no ASW IAM na guia "Credenciais de seguran√ßa" (localizada na p√°gina do usu√°rio desejado).  O bot√£o "Criar chave de acesso" ajudar√° a gerar chaves de acesso.  Mantenha-os com voc√™. </p><br><p><img src="https://habrastorage.org/webt/yn/t3/0q/ynt30qaych_hosd73v0bl3yb51q.png"></p><br><p>  Para registrar um novo bot no Telegram, use @BotFather e o comando / newbot.  Como resultado, o token necess√°rio para conectar-se ao seu bot ser√° devolvido a voc√™.  Trave-o tamb√©m. </p><br><p><img src="https://habrastorage.org/webt/mn/db/6_/mndb6_yarkg6ssd1cmfaykayuam.png"></p><br><h3 id="serverless-framework">  Estrutura sem servidor </h3><br><p>  Para instalar o Serverless Framework, voc√™ precisar√° de uma conta em <a href="https://serverless.com/">https://serverless.com/</a> . <br>  Ap√≥s concluir o registro, procederemos √† instala√ß√£o em nossa esta√ß√£o de trabalho.  O Node.js 6 e acima ser√° necess√°rio. </p><br><pre> <code class="plaintext hljs">sudo apt-get -y install nodejs</code> </pre> <br><p>  Para garantir o lan√ßamento correto em nosso ambiente, seguimos as etapas recomendadas: </p><br><pre> <code class="plaintext hljs">mkdir ~/.npm-global export PATH=~/.npm-global/bin:$PATH source ~/.profile npm config set prefix '~/.npm-global'</code> </pre> <br><p>  Adicione tamb√©m: </p><br><pre> <code class="plaintext hljs">~/.npm-global/bin:$PATH</code> </pre> <br><p>  para o arquivo / etc / environment. <br>  Agora coloque Serverless: </p><br><pre> <code class="plaintext hljs">npm install -g serverless</code> </pre> <br><h3 id="aws">  Aws </h3><br><p>  Bem, √© hora de mudar para a interface da AWS e adicionar um nome de dom√≠nio.  Criamos uma zona do AWS Route 53, um registro DNS e um certificado SSL para ele. <br>  Al√©m disso, voc√™ precisa do ELB, que criamos no servi√ßo EC2 -&gt; Load Balancers.  A prop√≥sito, ao criar um ELB, voc√™ precisa seguir todas as etapas do assistente, indicando o certificado criado. </p><br><p>  Quanto ao balanceador, voc√™ pode cri√°-lo por meio da CLI da AWS usando o seguinte comando: </p><br><pre> <code class="plaintext hljs">aws elb create-load-balancer --load-balancer-name my-load-balancer --listeners "Protocol=HTTP,LoadBalancerPort=80,InstanceProtocol=HTTP,InstancePort=80" "Protocol=HTTPS,LoadBalancerPort=443,InstanceProtocol=HTTP,InstancePort=80,SSLCertificateId=arn:aws:iam::123456789012:server-certificate/my-server-cert" --subnets subnet-15aaab61 --security-groups sg-a61988c3</code> </pre> <br><p>  Um balanceador ser√° necess√°rio ap√≥s a primeira implanta√ß√£o.  Nesse caso, voc√™ precisa enviar solicita√ß√µes para o nosso dom√≠nio.  Para implementar isso, nas configura√ß√µes do registro DNS (campo "Alias ‚Äã‚Äãtarget"), comece a inserir o nome do ELB criado.  Como resultado, voc√™ ver√° uma lista suspensa; portanto, resta selecionar a entrada desejada e salv√°-la. </p><br><p><img src="https://habrastorage.org/webt/-i/yr/8g/-iyr8gsoknvxwk0nsjvwtiolca0.png"></p><br><p>  Agora v√° para o c√≥digo. </p><br><h3 id="pishem-kod">  Escrevendo um c√≥digo </h3><br><p>  Usaremos Bref para escrever o c√≥digo.  Como mencionado anteriormente, esta biblioteca √© instalada usando o compositor, portanto, o c√≥digo ser√° compat√≠vel com qualquer estrutura.  A prop√≥sito, os desenvolvedores j√° descreveram o processo de usar o Bref com o <a href="https://bref.sh/docs/frameworks/laravel.html">Laravel</a> e o <a href="https://bref.sh/docs/frameworks/symfony.html">Symfony</a> .  Mas √© aconselh√°vel que trabalhemos no PHP "vazio" - isso ajudar√° a entender melhor a ess√™ncia. <br>  Come√ßamos com as depend√™ncias: </p><br><pre> <code class="plaintext hljs">{ "require": { "php": "&gt;=7.2", "bref/bref": "^0.5.9", "telegram-bot/api": "*" }, "autoload": { "psr-4": { "App\": "src/" } } }</code> </pre> <br><p>  Escreveremos no PHP 7.2 e superior e, para trabalhar com o Telegram, esse shell para a API √© adequado para n√≥s - <a href="https://github.com/TelegramBot/Api">https://github.com/TelegramBot/Api</a> .  Quanto ao pr√≥prio c√≥digo, ele ser√° colocado no diret√≥rio src. </p><br><p>  Portanto, o ambiente sem servidor est√° passando por uma caixa de di√°logo do console.  √â necess√°rio um aplicativo HTTP e, do ponto de vista do Lambda, isso significa que as chamadas de script ser√£o executadas da mesma maneira que o Nginx.  A interpreta√ß√£o ser√° realizada pelo PHP-FPM.  Em geral, isso √© mais como uma chamada de script do console padr√£o.  Este √© um ponto importante, porque sem levar esse recurso em considera√ß√£o, n√£o poderemos chamar scripts via HTTP. <br>  Realizamos: </p><br><pre> <code class="plaintext hljs">vendor/bin/bref init</code> </pre> <br><p>  Na caixa de di√°logo, selecione o item "Aplicativo HTTP" e n√£o se esque√ßa de especificar a regi√£o, pois o aplicativo deve funcionar na mesma regi√£o em que o balanceador funciona. <br>  Ap√≥s a inicializa√ß√£o, 2 novos arquivos aparecer√£o: <br>  index.php - o arquivo chamado; <br>  serverless.yml - arquivo de configura√ß√£o de implanta√ß√£o. <br>  A pasta .serverless precisar√° ser imediatamente adicionada ao .gitignore (ela aparecer√° ap√≥s a primeira tentativa de implanta√ß√£o). </p><br><p>  Quando tivermos um aplicativo da Web, colocaremos o index.php na pasta p√∫blica, imediatamente mudando para o serverless.yml.  Aqui est√° o que pode parecer em nossa implementa√ß√£o: </p><br><pre> <code class="plaintext hljs">#  lambda- service: app #    provider: name: aws #   ! region: eu-central-1 #    runtime: provided # ,  bref  1024.         memoryLimit: 256 #   stage: dev #    environment: BOT_TOKEN: ${ssm:/app/bot-token} #  bref plugins: - ./vendor/bref/bref #  Lambda- functions: #       php-api-dev # service-function-stage api: handler: public/index.php description: '' # in seconds (API Gateway has a timeout of 29 seconds) timeout: 28 layers: - ${bref:layer.php-73-fpm} #     API Gateway events: - http: 'ANY /' - http: 'ANY /{proxy+}' #    environment: MY_VARIABLE: ${ssm:/app/my_variable}</code> </pre> <br><p>  Agora vamos analisar as linhas n√£o √≥bvias.  Precisamos principalmente de vari√°veis ‚Äã‚Äãde ambiente.  N√£o queremos codificar conex√µes de banco de dados, APIs externas, etc. Se nos conectarmos ao Telegram, teremos nosso pr√≥prio token, recebido do BotFather.  E n√£o √© recomend√°vel armazenar esse token no serverless.yml, portanto, √© melhor envi√°-lo para o armazenamento AWS ssm: </p><br><pre> <code class="plaintext hljs">aws ssm put-parameter --region eu-central-1 --name '/app/my_variable' --type String --value '___BOTFATHER'</code> </pre> <br><p>  A prop√≥sito, estamos nos referindo a ele na configura√ß√£o. <br>  Essas vari√°veis ‚Äã‚Äãest√£o dispon√≠veis como vari√°veis ‚Äã‚Äãde ambiente e voc√™ pode acess√°-las no PHP usando a fun√ß√£o getenv.  Se falarmos sobre o nosso exemplo, vamos manter o token do bot no escopo global para simplificar.  Tamb√©m podemos transferir o token para o escopo de uma √∫nica fun√ß√£o e a chamada em si n√£o ser√° alterada a partir disso. </p><br><p>  Vamos seguir em frente.  Vamos agora criar uma classe simples do BotApp - ele ser√° respons√°vel por gerar uma resposta para o bot e responder√° aos comandos.  Os desenvolvedores de telegrama recomendam adicionar suporte aos comandos / help e / start para todos os bots.  Vamos adicionar outro comando por divers√£o.  A classe em si √© bastante simples e possibilita implementar o controlador Front no index.php sem carregar o arquivo de chamada.  Para obter uma l√≥gica mais complexa, a arquitetura deve ser desenvolvida e complicada. </p><br><pre> <code class="plaintext hljs">&lt;?php namespace App; use TelegramBot\Api\Client; use Telegram\Bot\Objects\Update; class BotApp { function run(): void{ $token = getenv('BOT_TOKEN'); $bot = new Client($token); //   start $bot-&gt;command('start', function ($message) use ($bot) { $answer = ' !'; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //    $bot-&gt;command('help', function ($message) use ($bot) { $answer = ': /help -  '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //   $bot-&gt;command('hello', function ($message) use ($bot) { $answer = '-,  - ,   Serverless '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); $bot-&gt;run(); } }</code> </pre> <br><p>  E aqui est√° a lista de index.php: </p><br><pre> <code class="plaintext hljs">&lt;?php require_once('../vendor/autoload.php'); use App\BotApp; try{ $botApp = new BotApp(); $botApp-&gt;run(); } catch (Exception $e){ echo $e-&gt;getMessage(); print_r($e-&gt;getTrace(), 1); }</code> </pre> <br><p>  Pode parecer estranho, mas est√° tudo pronto para partirmos para a Produ√ß√£o.  Vamos fazer isso executando o comando na pasta serverless.yml: </p><br><pre> <code class="plaintext hljs">sls deploy</code> </pre> <br><p>  No modo normal, sem servidor, os arquivos ser√£o compactados em arquivos zip, criar√£o um bucket S3 onde os colocar, criar√£o ou atualizar√£o o Aplicativo AWS anexado ao Lambda e colocar√£o o c√≥digo e o tempo de execu√ß√£o em uma camada separada. </p><br><p>  Durante o primeiro lan√ßamento, a API do Gateway ser√° criada (deixamos para facilitar o teste de chamadas, mas √© recomend√°vel exclu√≠-la).  Voc√™ tamb√©m precisar√° configurar a chamada Lambda via ELB, para a qual selecionamos ‚ÄúAdicionar gatilho‚Äù na janela de controle de fun√ß√µes e selecione ‚ÄúApplication Load Balancer‚Äù na lista suspensa.  Voc√™ precisar√° especificar o ELB criado anteriormente, definir a conex√£o via HTTPS, deixar o host vazio e em Path especificar o caminho que o Lambda chamar√° (por exemplo, / lambda / mytgbot).  Como resultado, seu Lambda estar√° dispon√≠vel no URL com o caminho especificado. </p><br><p>  Agora voc√™ pode registrar a parte da resposta do bot no Telegram para que o mensageiro entenda onde obter as mensagens.  Para fazer isso, chame o seguinte URL no navegador, mas n√£o esque√ßa de substituir seus pr√≥prios par√¢metros nele: </p><br><pre> <code class="plaintext hljs">https://api.telegram.org/bot_/setWebhook?url=https://my-elb-host.com/lambda/mytgbot</code> </pre> <br><p>  Como resultado, a API retornar√° "OK", ap√≥s o que o bot ficar√° dispon√≠vel. </p><br><p><img src="https://habrastorage.org/webt/g-/rd/kl/g-rdkldh57hxw-sbbcl_ci9nmyk.png"></p><br><h2 id="testiruem-bota-na-lokali">  Testando o bot em localidades </h2><br><p>  O bot pode ser testado antes da implanta√ß√£o.  O fato √© que o Serverless Framework suporta a inicializa√ß√£o em localidades usando cont√™ineres do Docker para isso.  Comando de chamada: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction</code> </pre> <br><p>  N√£o se esque√ßa de que usamos vari√°veis ‚Äã‚Äãde ambiente; portanto, durante a chamada, elas tamb√©m devem ser definidas no formato: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction --env VAR1=val1</code> </pre> <br><h2 id="logi">  Logs </h2><br><p>  Por padr√£o, a sa√≠da da chamada ser√° registrada no CloudWatch - est√° dispon√≠vel no painel Monitoramento da fun√ß√£o Lambda correspondente.  Aqui voc√™ pode ler os rastreamentos de chamadas no caso de um dump no lado do PHP.  Al√©m disso, voc√™ pode conectar servi√ßos avan√ßados de monitoramento, mas eles custar√£o alguns centavos adicionais a cada m√™s. </p><br><h2 id="itogo">  Total </h2><br><p>  Como resultado, obtivemos uma solu√ß√£o bastante r√°pida, flex√≠vel, escal√°vel e tamb√©m relativamente barata.  Sim, o Lambda nem sempre vence em compara√ß√£o com VMs e cont√™ineres padr√£o, mas h√° situa√ß√µes em que o aplicativo sem servidor ajuda a "fotografar" de maneira r√°pida e eficiente.  E o exemplo do bot criado apenas demonstra isso. <br>  Materiais √∫teis sobre o tema: </p><br><ul><li>  <a href="http.html">Documenta√ß√£o Bref</a> </li><li>  <a href="https://habr.com/ru/post/457100/">Teoria lambda</a> ; </li><li>  <a href="https://dev.to/sosnowski/anatomy-of-aws-lambda-1i1e">Anatomia lambda</a> ; </li><li>  <a href="https://serverless.com/">Estrutura sem servidor</a> </li><li>  <a href="https://devenergy.ru/archives/941">Bot de Telegrama sem servidor baseado em PHP e AWS Lambda</a> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477370/">https://habr.com/ru/post/pt477370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477358/index.html">Convidamos voc√™ para o DINS DevOps EVENING em 5 de dezembro: estamos falando de um sistema de processamento de eventos, compartilhando experi√™ncia com o Influx</a></li>
<li><a href="../pt477360/index.html">Novidades do SOLIDWORKS Simulation 2020</a></li>
<li><a href="../pt477362/index.html">Mais do que anti-spam: como tirar o m√°ximo proveito do seu Security Email Gateway</a></li>
<li><a href="../pt477364/index.html">Como se tornar um desenvolvedor Java? Ou talvez escolha Python?</a></li>
<li><a href="../pt477366/index.html">Cinco perguntas sobre o design de linguagens de programa√ß√£o</a></li>
<li><a href="../pt477372/index.html">Amazon perde a guerra contra falsifica√ß√µes</a></li>
<li><a href="../pt477374/index.html">Z-m√°quinas fuzzing</a></li>
<li><a href="../pt477378/index.html">Agile misto - abordagem em cascata ao implementar aplicativos de neg√≥cios (tamb√©m conhecido como Agile)</a></li>
<li><a href="../pt477382/index.html">Esports - lucrando: Mercedes, megafone, apostas e marcas para esports</a></li>
<li><a href="../pt477384/index.html">Confer√™ncia ‚ÄúSeguran√ßa da Informa√ß√£o. Amea√ßas do presente e do futuro ‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>