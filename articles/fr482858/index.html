<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•á ‚ôæ üë≠ Capteurs de fen√™tre sans fil maison: STM32L051 + RFM69 + Android üñ®Ô∏è üèÇüèΩ üê§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, cher Khabrovites! Il y a quelques ann√©es, j'ai achet√© une publicit√© zWave color√©e et install√© des capteurs de fen√™tre bas√©s sur ce protocole....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Capteurs de fen√™tre sans fil maison: STM32L051 + RFM69 + Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482858/"> Bonjour, cher Khabrovites!  Il y a quelques ann√©es, j'ai achet√© une publicit√© zWave color√©e et install√© des capteurs de fen√™tre bas√©s sur ce protocole.  Un zWave-Stick USB a √©t√© connect√© au serveur domestique, qui a jou√© le r√¥le d'un contr√¥leur, un petit module Java a √©t√© √©crit qui a re√ßu des donn√©es de ce contr√¥leur, et une petite application pour Android a √©t√© √©crite qui affiche magnifiquement l'√©tat de tous les capteurs.  Les piles sont ins√©r√©es, les capteurs sont enregistr√©s sur le contr√¥leur, tout a fonctionn√©.  Mais apr√®s quelques mois, il y a eu une terrible d√©ception.  Tout d'abord, ces capteurs zWave fonctionnent sur le principe "envoyer un message et s'endormir sans attendre de confirmation".  Dans mon cas, cela a conduit au fait que le signal des capteurs les plus √©loign√©s du contr√¥leur n'a tout simplement pas atteint le contr√¥leur.  M√™me l'installation d'un r√©p√©teur zWave suppl√©mentaire n'a pas aid√©.  Deuxi√®mement, ils ont d√©charg√© la batterie si rapidement qu'apr√®s environ six mois, tous les capteurs ont cess√© de fonctionner.  La raison en est qu'ils se r√©veillaient toutes les heures pour informer le contr√¥leur de leur √©tat.  D√©sactiver ou modifier cette option ne fonctionnait pas, car le logiciel standard ne le permettait cat√©goriquement pas.  Apr√®s deux ans de tourments avec cette technologie brute, peu fiable et hostile, j'ai d√©cid√© que j'en avais assez.  Mais au lieu de tout ranger et de le jeter, j'ai eu l'id√©e de laisser les √©tuis, mais de changer l'√©lectronique dedans.  Le choix s'est port√© sur un √©metteur-r√©cepteur RFM69 assez simple (433 MHz), sur la base duquel il √©tait possible de r√©aliser √† la fois une carte pour le capteur et un contr√¥leur connect√© via USB au serveur.  Le nouveau syst√®me est d√©j√† op√©rationnel depuis 5 mois, la fiabilit√© est proche de 100% (mais il y a quand m√™me eu quelques pannes), les batteries ne semblent pas encore vides.  Autrement dit, il est d√©j√† visible que toutes les lacunes de l'ancien syst√®me bas√© sur zWave ont √©t√© √©limin√©es, et je veux partager les d√©tails techniques de cet article, voir la photo. <br><br><img src="https://habrastorage.org/webt/n-/gz/rd/n-gzrd4pxnz2h38utebhqhtakjg.png"><br><br>  Peu importe, s'il vous pla√Æt, sous le chat. <br><a name="habracut"></a><br>  Il me semble que zWave dans mon cas s'est av√©r√© inop√©rant pour deux raisons: la maison a deux √©tages avec des planchers en b√©ton arm√© et une grande surface (c'est-√†-dire une suppression importante de certains capteurs du contr√¥leur).  Eh bien, des failles dans le logiciel propri√©taire, qui ne permettaient pas de d√©sactiver le r√©veil p√©riodique des capteurs, ce qui entra√Ænait une d√©charge rapide de la batterie.  Quand il est devenu clair que je n'√©tais pas sur le chemin avec zWave, j'ai commenc√© √† chercher d'autres options qui pourraient √™tre ins√©r√©es dans les m√™mes bo√Ætiers de capteur. <br><br>  Mon premier prototype de capteurs √©tait bas√© sur l'ESP8266.  Le contr√¥leur - sur la base de mon paiement dont j'ai d√©j√† <a href="https://habr.com/en/post/413101">√©crit sur Habr√©</a> .  Le syst√®me a m√™me fonctionn√© comme prototype, mais j'ai d√ª l'abandonner pour deux raisons.  La premi√®re raison est la m√™me - dans la maison, il y avait des coins avec un tr√®s faible niveau de signal WiFi, ce qui a conduit √† un temps d'activation tr√®s long de l'ESP8266 au r√©veil et, par cons√©quent, √† une forte d√©charge de la batterie.  Bien que j'avoue que je ne sais tout simplement pas comment cuisiner ce tr√®s ESP8266 (des articles <a href="https://habr.com/ru/post/480316">comme celui-ci</a> confirment cette th√®se).  Mais la deuxi√®me raison √©tait plus s√©rieuse.  Depuis que j'ai d√©cid√© de laisser non seulement le bo√Ætier, mais aussi le compartiment de la batterie, je me suis limit√© √† une batterie CR123A, qui est de 3,0 volts.  Autrement dit, le prix et la complexit√© du capteur ont augment√© en raison de l'augmentation du convertisseur CC / CC.  Bien <a href="https://habr.com/ru/post/304936">qu'il y ait un merveilleux article</a> sur ce sujet sur Habr√©.  Mais, de toute fa√ßon, ces deux raisons l'emportent et j'ai rejet√© ESP8266. <br><br>  Le deuxi√®me prototype a √©t√© c√¢bl√©.  J'ai fait un prototype du capteur et du contr√¥leur USB, j'ai ajout√© un module serveur pour qu'il comprenne ce contr√¥leur en plus du zWave-Stick.  Il y avait une id√©e de tirer progressivement les fils et le capteur apr√®s capteur pour changer la carte zWave en filaire.  Mais √† la fin, il n'a pas choisi de murs et ce prototype a √©galement √©t√© jet√©. <br><br>  Puis il a d√©cid√© de regarder vers les modules radio √† 433 et 868 MHz et a command√© plusieurs modules pour les exp√©riences: <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> , <a href="https://www.mouser.de/datasheet/2/21/A110LR09A_ProductBrief-1511797.pdf" rel="nofollow">A110LR09A</a> et <a href="https://www.mouser.de/datasheet/2/268/70651A-60467.pdf" rel="nofollow">MRF89XAM8A</a> .  En termes de taille de module, de prix, et √©galement en raison de la disponibilit√© des deux biblioth√®ques et de <a href="https://learn.sparkfun.com/tutorials/rfm69hcw-hookup-guide" rel="nofollow">bons exemples, j'ai</a> opt√© pour RFM69HCW, qui constituait la base du syst√®me. <br><br>  Le syst√®me ne comprend que quatre composants: <br><br><ul><li>  capteurs sans fil (433 MHz, pile CR123A 3.0V), </li><li>  contr√¥leur r√©seau (433 MHz, aliment√© via USB √† partir du serveur) </li><li>  le serveur (dont j'ai d√©j√† parl√© sur Habr√© <a href="https://habr.com/en/post/268197">dans cet article</a> ) et le module programme serveur </li><li>  client mobile (application Android) </li></ul><br>  Ci-dessous, je d√©crirai chaque module en d√©tail, et √† la fin je donnerai des statistiques sur le fonctionnement du syst√®me au cours des derniers mois de fonctionnement. <br><br><h3>  Capteurs </h3><br>  Les capteurs utilisent le <a href="https://www.sparkfun.com/products/13910" rel="nofollow">module</a> radio <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> .  Il a une large plage de tension de fonctionnement (1,8 V-2,4 V 17 dBm, 2,4 V-3,6 V 20 dBm) et est contr√¥l√© via SPI.  Autrement dit, vous avez besoin d'un microcontr√¥leur.  Il y a quelque temps, j'ai fait connaissance avec la s√©rie STM32L et command√© le STM32L051 pour des exp√©riences.  Il m'a soudoy√© comme un petit courant en mode veille (0,27 ŒºA), et la tension de fonctionnement, presque identique √† la tension du module radio (1,65V-3,6V).  Plus petit prix. <br><br>  Il s'est av√©r√© le sch√©ma suivant: <br><br><img src="https://habrastorage.org/webt/0b/xx/kb/0bxxkbtvavy113lz23izewdi4yk.png" alt="image"><br><br>  La tension d'alimentation du microcontr√¥leur et du module radio est telle qu'ils peuvent √™tre directement aliment√©s √† partir de l'√©l√©ment CR123A.  Le STM32L051 a une r√©f√©rence de tension interne connect√©e au canal ADC 17, ainsi que la valeur d'√©talonnage de cette source, qui vous permet de mesurer la valeur actuelle de la tension d'alimentation VDD.  Le module radio est connect√© √† l'alimentation via l'appareil de terrain Q1, ce qui vous permet de contr√¥ler son alimentation √† partir du microcontr√¥leur. <br><br>  Le mode veille est impl√©ment√© en transf√©rant le microcontr√¥leur en "veille".  Dans ce mode, le STM32L051 a un c≈ìur d√©sactiv√©, presque tous les p√©riph√©riques et un r√©gulateur de tension interne, ce qui garantit une consommation au niveau de 0,29 ŒºA (avec l'horloge en temps r√©el d√©sactiv√©e).  Mais dans ce mode, il y a une caract√©ristique - le microcontr√¥leur ne se r√©veille que le long du front montant du signal sur la broche WKUP (A0).  Puisqu'un interrupteur magn√©tique est utilis√©, qui est activ√© / d√©sactiv√© (ferm√© ou ouvert), vous avez besoin d'un petit bloc qui g√©n√®re une impulsion de courte dur√©e √† la fois lors de la fermeture et lors de l'ouverture d'un contact magn√©tique.  Cette impulsion est envoy√©e √† l'entr√©e A0 du microcontr√¥leur et la r√©veille.  Un tel convertisseur est impl√©ment√© sur la puce OU exclusive IC3 de la s√©rie 74AUP √©conome en √©nergie (74AUP1G86), qui fonctionne dans la plage de tension de 0,8 V √† 3,6 V et consomme 0,2 ŒºA.  Ainsi, la consommation totale en mode veille devrait √™tre d'environ 0,5 ŒºA, ce qui est confirm√© par des mesures sur un capteur enti√®rement assembl√©. <br><br>  Lorsque le microcontr√¥leur se r√©veille, il mesure d'abord la tension d'alimentation et, si elle est inf√©rieure √† 1,8 volts, ce n'est pas le destin - l'√©metteur ne peut pas √™tre d√©marr√© et le microcontr√¥leur se rendort. <br><br>  Si la tension de la batterie est sup√©rieure √† 1,8 volts, le microcontr√¥leur s'allume et initialise le module radio, transf√®re l'√©tat au contr√¥leur de r√©seau et attend la confirmation.  Le paquet de donn√©es comprend un num√©ro de paquet (√©v√©nement) 32 bits unique, la tension de la batterie, la temp√©rature, l'√©tat du contact magn√©tique, l'octet de contr√¥le (CRC7).  En cas de confirmation r√©ussie, le microcontr√¥leur s'endort.  Sinon, envoie √† nouveau le statut, mais au maximum 10 fois.  J'ai d√©fini cette limite pour que le capteur n'essaie pas d'attendre ind√©finiment une r√©ponse dans une situation o√π le contr√¥leur r√©seau est simplement √©teint.  Le dernier num√©ro d'√©v√©nement unique transmis est stock√© dans l'EEPROM interne du microcontr√¥leur. <br><br>  Pendant le transfert de donn√©es, le microcontr√¥leur clignote une LED (o√π sans elle).  La LED est allum√©e √† l'aide de PWM, o√π le rapport cyclique d√©pend de la valeur de tension actuelle, ce qui vous permet d'avoir presque la m√™me luminosit√© dans presque toute la plage de tension de fonctionnement. <br><br>  Les cartes sont con√ßues en EagleCAD, la conception des cartes <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">est disponible ici</a> .  Les cartes sont √† double face: le microcontr√¥leur et son faisceau sont situ√©s sur le c√¥t√© sup√©rieur face au cadre de la fen√™tre, et le module radio et la LED sont sur le c√¥t√© inf√©rieur face √† la pi√®ce.  J'ai command√© en Chine, je me suis soud√© dans un four de cuisine conventionnel (couche sup√©rieure) et un s√®che-cheveux (couche inf√©rieure). <br><br><img src="https://habrastorage.org/webt/rj/io/9l/rjio9lhfs3psrwyw8_xefn1lcmi.jpeg" alt="image"><br><br>  Le module radio a besoin d'une antenne.  Ce n'est qu'un morceau de fil de 164 mm de long. <br><br>  Apr√®s l'installation, chaque capteur doit √™tre programm√©, pour lequel un connecteur SWD est fourni.  J'ai laiss√© les contacts restants au tableau pour d'√©ventuelles exp√©riences √† l'avenir. <br>  Le firmware est √©crit en C ++, une partie du code est ex√©cut√© dans des classes de base assez universelles qui encapsulent les appels √† la biblioth√®que ST HAL.  Le code source <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">est ici</a> .  Pour le d√©veloppement, System Workbench pour STM32 a √©t√© utilis√©.  La taille du fichier de firmware binaire final est de 22 Ko. <br><br>  Et voici le capteur dans le bo√Ætier: <br><br><img src="https://habrastorage.org/webt/91/fx/ap/91fxapzu7uwnpr0wp2cjydbpwaa.jpeg" alt="image"><br><br>  Selon la position du capteur, pour certains capteurs, j'ai laiss√© l'antenne √† l'ext√©rieur (sur le fond du cadre blanc, cependant, elle n'est pas visible), et pour certains capteurs, j'ai pli√© le fil dans le cadre et l'ai compl√®tement fourr√© √† l'int√©rieur du bo√Ætier. <br><br>  Par souci d'int√©r√™t, j'ai calcul√© le co√ªt des composants pour un capteur (aux prix du catalogue Mouser, prix et prix total en euros) <br><table cellspacing="0" border="0"><tbody><tr><td align="left">  <b><font>Objet</font></b> </td><td align="left">  <b><font>La description</font></b> </td><td align="left">  <b><font>Valeur</font></b> </td><td align="left">  <b><font>Num√©ro MOUSER</font></b> </td><td align="left">  <b><font>Qt√©</font></b> </td><td align="left">  <b><font>Co√ªt</font></b> </td></tr><tr><td align="left">  <font>IC3</font> </td><td align="left">  <font>OU exclusif</font> </td><td align="left">  <font>1G86</font> </td><td align="left">  <font>771-74AUP1G86GW-G</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,254</font> </td></tr><tr><td align="left">  <font>IC1</font> </td><td align="left">  <font>Microcontr√¥leur</font> </td><td align="left">  <font>STM32L051</font> </td><td align="left">  <font>511-STM32L051K6T6</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>2.14</font> </td></tr><tr><td align="left">  <font>SV1</font> </td><td align="left">  <font>Connecteur</font> </td><td align="left">  <font>Swd</font> </td><td align="left">  <font>68602-406HLF</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,157</font> </td></tr><tr><td align="left">  <font>LED1</font> </td><td align="left">  <font>LED 3 mm</font> </td><td align="left">  <font>3 mm</font> </td><td align="left">  <font>630-HLMP-K155</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,351</font> </td></tr><tr><td align="left">  <font>Q1</font> </td><td align="left">  <font>P-mosfet</font> </td><td align="left">  <font>BSH205</font> </td><td align="left">  <font>771-BSH205G2R</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,276</font> </td></tr><tr><td align="left">  <font>S1</font> </td><td align="left">  <font>Contact magn√©tique</font> </td><td align="left">  <font>ORD211-0810</font> </td><td align="left">  <font>876-ORD211-0810</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,625</font> </td></tr><tr><td align="left">  <font>IC2</font> </td><td align="left">  <font>Module radio RFM69HCW</font> </td><td align="left">  <font>RFM69HCW</font> </td><td align="left">  <font>474-COM-13910</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>5.36</font> </td></tr><tr><td align="left">  <font>C1, C2, C3, C6</font> </td><td align="left">  <font>Condensateur SMD</font> </td><td align="left">  <font>0,1 uF</font> </td><td align="left">  <font>80-C0805C104J5RAC</font> </td><td align="left">  <font>4</font> </td><td align="left">  <font>0,1</font> </td></tr><tr><td align="left">  <font>C5</font> </td><td align="left">  <font>Condensateur SMD</font> </td><td align="left">  <font>0.4nF</font> </td><td align="left">  <font>C0805C471K8HACTU</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,021</font> </td></tr><tr><td align="left">  <font>C4</font> </td><td align="left">  <font>Condensateur SMD (tantale)</font> </td><td align="left">  <font>47uF</font> </td><td align="left">  <font>581-TAJR225K016RNJ</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,334</font> </td></tr><tr><td align="left">  <font>R1</font> </td><td align="left">  <font>R√©sistance SMD</font> </td><td align="left">  <font>10K</font> </td><td align="left">  <font>660-RK73H2ATTDD1002F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R10</font> </td><td align="left">  <font>R√©sistance SMD</font> </td><td align="left">  <font>330</font> </td><td align="left">  <font>660-RK73H2ATTDD3300F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R3, R4, R6, R7, R8, R11</font> </td><td align="left">  <font>R√©sistance SMD</font> </td><td align="left">  <font>47K</font> </td><td align="left">  <font>660-RK73H2ATTDD4702F</font> </td><td align="left">  <font>6</font> </td><td align="left">  <font>0,06</font> </td></tr><tr><td align="left">  <font>R5</font> </td><td align="left">  <font>R√©sistance SMD</font> </td><td align="left">  <font>56</font> </td><td align="left">  <font>660-RK73H2ATTD56R0F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,013</font> </td></tr><tr><td align="left">  <font>R9</font> </td><td align="left">  <font>R√©sistance SMD</font> </td><td align="left">  <font>56M</font> </td><td align="left">  <font>603-RC0805JR-0756ML</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,037</font> </td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">  <b><font>9.748</font></b> </td></tr></tbody></table><br>  Soit dit en passant, il s'est av√©r√© exactement trois fois moins cher que le capteur zWave d'origine.  Bien que ce ne soit que le co√ªt des pi√®ces hors bo√Ætier.  Mais, √† mon avis, dans le commerce, les capteurs zWave sont ind√©cemment chers. <br><br><h3>  Contr√¥leur r√©seau </h3><br>  Pour le contr√¥leur, le m√™me module radio et le m√™me microcontr√¥leur ont √©t√© utilis√©s que pour les capteurs.  Cela a permis de r√©utiliser la plupart du code du firmware.  Pour le contr√¥leur, j'ai choisi ce facteur de forme de la carte afin d'utiliser le bo√Ætier pr√™t √† l'emploi de Raspberry Pi.  Par rapport au capteur, un connecteur d'antenne externe et une boucle USB bas√©e sur l'isolateur FT232RL et SI-8621 ont √©t√© ajout√©s.  Bien s√ªr, √† la place, on pourrait prendre du STM32 avec USB √† bord.  Mais ensuite, d'une part, il faudrait s√©parer le code du firmware et, d'autre part, faire l'impl√©mentation logicielle de l'USB lui-m√™me.  L'option avec un FT232RL externe, bien que plus ch√®re, est plus fiable et plus rapide √† mettre en ≈ìuvre.  Le r√©sultat est le <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">sch√©ma suivant</a> : <br><br><img src="https://habrastorage.org/webt/wh/ij/_k/whij_k04j8jqetojnlz0hblpnom.png" alt="image"><br><br>  Et sous forme assembl√©e, il s'est av√©r√© comme ceci: <br><br><img src="https://habrastorage.org/webt/f2/-4/io/f2-4iog6apig6hfmq-6zhhxmzno.jpeg" alt="image"><br><br><img src="https://habrastorage.org/webt/dp/gg/cu/dpggcuqsrdegbwobtujrbf1rlck.jpeg" alt="image"><br><br>  Le microcontr√¥leur ne s'endort pas ici, le module radio fonctionne pour la r√©ception, mais apr√®s avoir r√©ussi √† recevoir un paquet de l'un des capteurs, le module passe en mode de transmission et envoie un accus√© de r√©ception.  De plus, tout paquet re√ßu avec succ√®s est transmis via USB au serveur.  Le format du package est une cha√Æne de valeurs s√©par√©es par le symbole ¬´;¬ª: <br>  GW; 3; 12; -57; 0; 146; 30; 18 <br>  o√π: <br><br><ul><li>  la premi√®re position est l'√©tiquette du paquet (toujours ¬´GW¬ª) </li><li>  deuxi√®me position - type de donn√©es (√©tat du capteur ou code d'erreur) </li><li>  troisi√®me position - num√©ro du capteur </li><li>  quatri√®me position - la qualit√© du signal sur le c√¥t√© du contr√¥leur de r√©seau (le RFM69HCW pr√©serve la qualit√© du signal pendant la r√©ception et vous permet de l'interroger lorsque la r√©ception est termin√©e) </li><li>  cinqui√®me position - √©tat de la fen√™tre (0 ouvert, 1 ferm√©) </li><li>  sixi√®me position - un num√©ro unique du paquet (√©v√©nement) du capteur.  Ce num√©ro vous permet de contr√¥ler c√¥t√© serveur si tous les √©v√©nements ont √©t√© re√ßus par le serveur ou si un ou plusieurs √©v√©nements ont √©t√© perdus. </li><li>  septi√®me position - tension actuelle de la batterie (30 correspond √† 3,0 V) </li><li>  la derni√®re, la huiti√®me position est la temp√©rature du capteur interne du microcontr√¥leur.  Je n'ai pas encore compris comment l'utiliser </li></ul><br>  Le code source du firmware est <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">au m√™me endroit que pour le capteur</a> .  Ils ont un fichier principal commun et une biblioth√®que commune de classes de base.  L'option de micrologiciel (capteur ou contr√¥leur) est s√©lectionn√©e √† l'aide de la directive define du fichier main.cpp. <br><br>  Le co√ªt du contr√¥leur de r√©seau est plus √©lev√© en raison du circuit USB, de l'antenne et des connecteurs suppl√©mentaires.  Mais cet additif peut √™tre n√©glig√©, car il n'y a qu'un seul contr√¥leur.  Mais m√™me avec ce suppl√©ment, il s'est √©galement av√©r√© √™tre trois fois moins cher que le zWave-Stick, qui √©tait auparavant √† sa place. <br><br><h3>  Module serveur </h3><br>  Le contr√¥leur r√©seau est connect√© √† un serveur ex√©cutant CentOS 7. Le serveur ex√©cute un programme √©crit en Java.  Et dans sa structure, et dans la mise en ≈ìuvre, et dans les t√¢ches, le programme est assez simple: <br><br><ul><li>  En utilisant une biblioth√®que <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">RxTx</a> tr√®s ancienne et apparemment plus prise en <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">charge</a> , le port USB sp√©cifi√© dans la configuration est surveill√© (dans mon cas / dev / ttyUSB0).  √Ä l'heure actuelle, il s'agit de la partie la moins optimis√©e de l'ensemble du syst√®me, car la biblioth√®que charge fortement le processeur du serveur. </li><li>  Si des donn√©es sont re√ßues du port USB, elles sont enregistr√©es dans un fichier journal et stock√©es dans la classe d'√©tat du capteur.  Lorsque vous red√©marrez le serveur, l'√©tat est perdu.  Pour le restaurer, vous devez faire le tour de la maison et ouvrir et fermer manuellement toutes les fen√™tres.  C'est probablement le plus gros inconv√©nient de mon syst√®me, mais j'ai tout √† fait consciemment refus√© d'interroger p√©riodiquement les capteurs pour √©conomiser leurs batteries. </li><li>  L'application est √©galement un petit serveur TCP / IP et √©coute sur le port TCP / IP sp√©cifi√© dans la configuration.  Sur ce port, il peut accepter les connexions d'un client mobile. </li><li>  Si le client mobile se connecte au serveur, il envoie l'√©tat actuel de tous les capteurs.  √Ä l'aide de messages de fr√©quence cardiaque p√©riodiques, le serveur surveille √©galement l'activit√© de la connexion. </li><li>  Le serveur et le client mobile √©changent des messages au format XML.  Ces messages sont impl√©ment√©s sous la forme d'une petite <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/common" rel="nofollow">biblioth√®que Java</a> , partag√©e √† la fois c√¥t√© serveur et c√¥t√© application mobile Android. </li><li>  Bien que cela n'ait pas beaucoup de sens, dans l'int√©r√™t, j'ai ajout√© la fonction d'autoriser un client mobile via IMEI, ainsi que le cryptage AES des messages entre le serveur et le client √† l'aide d'une cl√© cousue dans le code source (package Java javax.crypto).  Mais c'est purement pour l'exp√©rience, car le port TCP / IP de ce module serveur n'est accessible que depuis le r√©seau interne et n'est pas visible de l'ext√©rieur.  Bien que, si je veux ouvrir ce port au grand monde, maintenant ce ne sera pas si effrayant de le faire. </li></ul><br>  Peu importe, le code source du module serveur est <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/server" rel="nofollow">ici</a> . <br><br><h3>  Client mobile (application Android) </h3><br>  Vous n'√©crirez pas grand-chose ici, bien que cette application soit le r√©sultat final de l'ensemble du projet.  Il s'agit d'une application Java standard et tr√®s simple avec trois onglets: l'√©tat des fen√™tres du premier √©tage, l'√©tat du deuxi√®me √©tage et une petite t√©l√©m√©trie du serveur (voir le <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/app" rel="nofollow">code source ici</a> ): <br><br><img src="https://habrastorage.org/webt/j5/hz/hd/j5hzhduedoxedwhuuhrpe0e4s8e.png" alt="image"><br><br>  Les graphiques sont bas√©s sur un ensemble de fichiers SVG, qui sont empil√©s les uns sur les autres en fonction de l'√©tat des capteurs.  Un appui long est pris en charge dans la zone de chaque fen√™tre, selon lequel un indice est affich√© avec l'heure √† quelle heure cette fen√™tre a √©t√© ouverte: <br><br><img src="https://habrastorage.org/webt/4e/_z/42/4e_z42j_o2j11j7tl9lzzefeffi.png" alt="image"><br><br>  En principe, rien ne vous emp√™che d'ajouter une ic√¥ne de batterie √† cette info-bulle, mais vos mains ne l'ont pas encore atteinte. <br><br><h3>  Exp√©rience d'exploitation </h3><br>  "Chaque √©ternuement" est enregistr√© dans un fichier journal c√¥t√© serveur.  L'analyse de ces fichiers au cours des 5 derniers mois nous permet de comprendre un peu plus en d√©tail ce que ressent ce syst√®me. <br><br>  L'analyse est tr√®s simple - il suffit de grep dans le dossier des fichiers journaux sur le serveur. <br><br>  Combien d'erreurs y a-t-il eu lors de la transmission des donn√©es sur le canal radio?  Sur 5 mois, 8 erreurs ont √©t√© enregistr√©es lorsque le message a √©t√© re√ßu dans la mauvaise taille et 25 erreurs dans le mauvais CRC.  Dans les deux cas, vous ne pouvez pas dire directement quel capteur a rencontr√© des probl√®mes, car le paquet de donn√©es dans ce cas est compl√®tement endommag√©.  √âtant donn√© que le contr√¥leur de r√©seau ne confirme pas la r√©ception des donn√©es dans tous ces cas, le capteur doit envoyer les donn√©es d'une nouvelle mani√®re, ce qui dans la plupart des cas corrige ces erreurs. <br><br>  Et voici un tableau r√©capitulatif du fonctionnement des capteurs pendant 5 mois. <br><table cellspacing="0" border="0"><tbody><tr><td align="center">  <b><font>√âtage</font></b> </td><td align="center">  <b><font>Capteur</font></b> </td><td align="center">  <b><font>La quantit√©</font></b> <b><font><br></font></b>  <b><font>Des √©v√©nements</font></b> </td><td align="center">  <b><font>Des perdus</font></b> <b><font><br></font></b>  <b><font>Des √©v√©nements</font></b> </td><td align="center">  <b><font>La tension</font></b> <b><font><br></font></b>  <b><font>Les piles</font></b> </td><td align="center">  <b><font>M√©diane</font></b> <b><font><br></font></b>  <b><font>Puissance</font></b> <b><font><br></font></b>  <b><font>Signal</font></b> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>10</font> </td><td align="center">  <font>105</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font color="#800000">3.1</font> </td><td align="center">  <font>-66</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>11</font> </td><td align="center">  <font>52</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>12</font> </td><td align="center">  <font>122</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-61</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>13</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>14</font> </td><td align="center">  <font>2573</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>15</font> </td><td align="center">  <font>261</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>16</font> </td><td align="center">  <font>543</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>17</font> </td><td align="center">  <font>156</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>18</font> </td><td align="center">  <font>177</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.2</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>19</font> </td><td align="center">  <font>384</font> </td><td align="center">  <font color="#800000">3</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-56</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>3</font> </td><td align="center">  <font>368</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>4</font> </td><td align="center">  <font>86</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-71</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>5</font> </td><td align="center">  <font>521</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-59</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>6</font> </td><td align="center">  <font>115</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>7</font> </td><td align="center">  <font>316</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-63</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>8</font> </td><td align="center">  <font>419</font> </td><td align="center">  <font color="#800000">1</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>9</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr></tbody></table><br>  Le capteur n ¬∞ 10 se fige une fois.  Cela a apparemment conduit √† une diminution significative de la tension de la batterie.  La raison du gel n'est pas encore claire.  Il se bloque √† nouveau, vous devez le comprendre. <br><br>  Le capteur n ¬∞ 14 est install√© sur la porte avant, c'est pourquoi il a un si grand nombre de r√©ponses.  Mais un si grand nombre de d√©placements n'a pas encore affect√© la tension de la batterie. <br><br>  Un √©v√©nement perdu est lorsque le capteur a tent√© d'envoyer un √©tat, mais le serveur ne l'a pas confirm√©.  Tous les √©v√©nements perdus sont dus au fait que j'ai √©teint le serveur pendant environ une demi-journ√©e pour le nettoyage. <br><br>  La colonne M√©diane de la force du signal m√©dian affiche la valeur RSSI m√©diane (en dBm), o√π chaque valeur individuelle est obtenue apr√®s la r√©ception de chaque paquet.  Le capteur avec le meilleur signal (n ¬∞ 19, -56 dBm) est situ√© √† 2 m√®tres du contr√¥leur de r√©seau, mais l'antenne de ce capteur est recroquevill√©e √† l'int√©rieur du bo√Ætier.  Le contr√¥leur de r√©seau lui-m√™me est situ√© au rez-de-chauss√©e.  Cependant, le signal des capteurs du deuxi√®me √©tage est tr√®s bon.  Cela est d√ª au fait que sur tous les capteurs du deuxi√®me √©tage, l'antenne est retir√©e du bo√Ætier du capteur. <br><br><h3>  Au lieu d'une postface </h3><br>  D'une part, je suis heureux que, comme passe-temps, par moi-m√™me, il se soit pass√© de z√©ro pour concevoir, assembler et faire fonctionner un syst√®me de ce niveau.  Et encore plus heureux qu'il fonctionne mieux que le syst√®me "propri√©taire" bas√© sur la technologie de battage m√©diatique zWave.  Il est √©galement possible de d√©velopper et d'am√©liorer ce syst√®me.  Je ne suis rong√© que par de petits doutes.  √Ä savoir, qu'une personne sans √©ducation √©lectrique sp√©cialis√©e collecte sur son genou quelque chose qui fonctionne de mani√®re plus fiable que les produits de marque connus dans les cercles √©troits des marques IOT.  Probablement, les progr√®s ont tourn√© quelque part dans la mauvaise direction. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482858/">https://habr.com/ru/post/fr482858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482848/index.html">Bot en direct, partie 2</a></li>
<li><a href="../fr482850/index.html">Perspectives pour les biocarburants dans l'aviation</a></li>
<li><a href="../fr482852/index.html">L'√®re de l'audio compact: comment les bandes sont entr√©es dans les voitures</a></li>
<li><a href="../fr482854/index.html">√Ä propos de l'estimation</a></li>
<li><a href="../fr482856/index.html">√âtranger divin</a></li>
<li><a href="../fr482860/index.html">J'√©tais responsable des relations internationales chez Google. Voil√† pourquoi je suis parti</a></li>
<li><a href="../fr482862/index.html">Y a-t-il un GameDev √† Sakhaline? 1.V</a></li>
<li><a href="../fr482864/index.html">Vid√©o surveillance √† domicile. Sch√©ma de maintenance d'une archive vid√©o sans registraire √† domicile</a></li>
<li><a href="../fr482866/index.html">Vaut-il la peine d'acheter du Bitcoin l'ann√©e prochaine et combien cela co√ªtera</a></li>
<li><a href="../fr482870/index.html">Comment j'ai achet√© un ordinateur portable verrouill√© sur eBay et essay√© de faire mon AntiTheft bas√© sur IntelAMT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>