<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎹 💾 🕺🏼 الجزء 3: تحميل Linux تقريبًا من بطاقة SD إلى RocketChip 💘 ▪️ ⚠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="في الجزء السابق ، تم تطبيق وحدة تحكم في الذاكرة تعمل بشكل أو بآخر ، أو بالأحرى ، برنامج التفاف عبر IP Core من Quartus ، وهو محول إلى TileLink. اليوم ،...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>الجزء 3: تحميل Linux تقريبًا من بطاقة SD إلى RocketChip</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458482/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/4j/fu/lu/4jfulumeapi32exqv7d6vnseaho.png" width="45%" align="left">  في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الجزء السابق</a> ، تم تطبيق وحدة تحكم في الذاكرة تعمل بشكل أو بآخر ، أو بالأحرى ، برنامج التفاف عبر IP Core من Quartus ، وهو محول إلى TileLink.  اليوم ، تحت عنوان "نحن ننقل RocketChip إلى لوحة أم صينية غير معروفة مع Cyclone" ، سترى وحدة تحكم تعمل.  استمرت العملية قليلاً: اعتقدت بالفعل أنني سأقوم بتشغيل Linux بسرعة والمضي قدماً ، لكن لم يكن هناك.  في هذا الجزء ، أقترح إلقاء نظرة على عملية بدء تشغيل تهيئة نواة U-Boot و BBL و Linux kidel.  ولكن هناك وحدة تحكم - U-Boot-ovsky ، ومتطورة للغاية ، تحتوي على الكثير مما تتوقعه من وحدة تحكم متكاملة. </p><br><p style=";text-align:right;direction:rtl"> في الجهاز ، سيتم إضافة بطاقة SD متصلة عبر SPI ، وكذلك UART.  في جزء البرنامج ، سيتم استبدال <code>xip</code> من <code>xip</code> إلى <code>sdboot</code> ، وفي الواقع ، ستتم إضافة مراحل التمهيد التالية (على بطاقة SD). </p><a name="habracut"></a><br><h2 id="dopilivanie-apparatnoy-chasti" style=";text-align:right;direction:rtl">  تعاطي المنشطات </h2><br><p style=";text-align:right;direction:rtl">  المهمة: تحتاج إلى التبديل إلى النواة "الكبيرة" وتوصيل UART (من Raspberry) ومحول SD (تم استخدام نوع من لوحة Catalex بستة دبابيس: GND ، VCC ، MISO ، MOSI ، SCK ، CS). </p><br><p style=";text-align:right;direction:rtl">  من حيث المبدأ ، كان كل شيء بسيطًا جدًا.  ولكن قبل أن أدرك هذا ، تم إلقاؤي قليلاً من جانب إلى آخر: بعد المرة السابقة ، قررت أنه مرة أخرى تحتاج فقط إلى مزج شيء مثل <code>HasPeripheryUART</code> في <code>System</code> (والتنفيذ وفقًا لذلك) ، نفس الشيء بالنسبة لبطاقة SD - وهذا هو كل شيء سوف تكون جاهزة.  ثم قررت أن أرى كيف تم تنفيذه في تصميم "جدي".  إذن ماذا خرجنا من الجدية؟  آرتي ، على ما يبدو ، لا يصلح - لا يزال الوحش <code>unleahshed.DevKitConfigs</code> .  وفجأة تبين أنه كان هناك في كل مكان نوع من التراكبات التي تمت إضافتها من خلال المعلمات بالمفاتيح.  أعتقد أن هذا من المحتمل أن يكون مرنًا للغاية وقابل للتكوين ، لكن يجب أن أبدأ شيئًا في البداية ... <em>ولكن ليس لديك نفس العكازات ، فقط أسهل من العكازات؟ ..</em> ثم صادفت <code>vera.iofpga.FPGAChip</code> ل FPGAs Microsemi و <del>  سحبت على الفور في اقتباسات </del>  لقد حاولت تنفيذ عملي عن طريق القياس ، الفائدة هنا هي "تخطيط اللوحة الأم" بأكمله أو أكثر في ملف واحد. </p><br><p style=";text-align:right;direction:rtl">  اتضح بالفعل ، أنت فقط بحاجة إلى إضافة خطوط إلى <code>System.scala</code> </p><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystem</span></span></span><span class="hljs-class"> ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripherySPI</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUART</span></span></span><span class="hljs-class"> ... </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tlclock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">FixedClockResource</span></span>(<span class="hljs-string"><span class="hljs-string">"tlclk"</span></span>, p(<span class="hljs-type"><span class="hljs-type">DevKitFPGAFrequencyKey</span></span>)) ... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemModule</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">L</span></span></span><span class="hljs-class"> &lt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">L</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystemModuleImp</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer</span></span></span><span class="hljs-class">) ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUARTModuleImp</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryGPIOModuleImp</span></span></span><span class="hljs-class"> ...</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يضيف سطر في نص فئة <code>System</code> معلومات حول التردد الذي يعمل به هذا الجزء من شركة نفط الجنوب على ملف dts.  بقدر ما أفهم ، يعد DTS / DTB بمثابة تناظرية ثابتة لتكنولوجيا التوصيل والتشغيل للأجهزة المدمجة: يتم تجميع شجرة وصف dts في ملف ثنائي dtb ويتم إرسالها بواسطة أداة التحميل إلى kernel حتى يتمكن من تكوين الأجهزة بشكل صحيح.  ومن المثير للاهتمام ، أنه بدون خط مع <code>tlclock</code> يتم تجميع كل شيء تمامًا ، لكنه لن يعمل على ترجمة BootROM (سأذكرك الآن بأنه سيكون <code>sdboot</code> ) - أثناء <code>sdboot</code> ، يقوم بتوزيع ملف dts وإنشاء رأس مع الماكرو <code>TL_CLK</code> ، بفضله يمكنه تكوين فواصل التردد بشكل صحيح واجهات خارجية. </p><br><p style=";text-align:right;direction:rtl">  ستحتاج أيضًا إلى إصلاح "الأسلاك" قليلاً: </p><br><p style=";text-align:right;direction:rtl">  <strong>Platform.scala:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlatformIO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bundle</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">// UART io.uart_tx := sys.uart(0).txd sys.uart(0).rxd := RegNext(RegNext(io.uart_rx)) // SD card io.sd_cs := sys.spi(0).cs(0) io.sd_sck := sys.spi(0).sck io.sd_mosi := sys.spi(0).dq(0).o sys.spi(0).dq(0).i := false.B sys.spi(0).dq(1).i := RegNext(RegNext(io.sd_miso)) sys.spi(0).dq(2).i := false.B sys.spi(0).dq(3).i := false.B }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  تمت إضافة سلاسل التسجيل ، بصراحة ، ببساطة عن طريق القياس مع بعض الأماكن الأخرى في التعليمات البرمجية المصدر.  على الأرجح ، يجب أن تحمي ضد <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">النقيلة</a> .  ربما تتمتع <em>بعض</em> الكتل بالفعل بحمايتها الخاصة ، لكن أولاً أريد أن أركض على الأقل "على مستوى عالٍ".  سؤال أكثر إثارة للاهتمام بالنسبة لي هو لماذا يتعطل MISO و MOSI على <code>dq</code> مختلفة؟  ما زلت لم أجد الإجابة ، لكن يبدو أن بقية الكود يعتمد على مثل هذا الاتصال. </p><br><p style=";text-align:right;direction:rtl">  جسديا ، أنا فقط تعيين استنتاجات التصميم لجهات الاتصال فضفاضة على كتلة وإعادة ترتيبها الطائر اختيار الجهد إلى 3.3V. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">محول SD</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  عرض أعلى: </p><br><img src="https://habrastorage.org/webt/su/zf/q4/suzfq4lwejcelmwt3rpk5w_min0.jpeg"><br><p style=";text-align:right;direction:rtl">  عرض أسفل: </p><br><img src="https://habrastorage.org/webt/y0/__/qq/y0__qqavfhkikpsorvmzqhbamlw.jpeg"></div></div><br><h2 id="otladka-programmnoy-chasti-instrumenty" style=";text-align:right;direction:rtl">  تصحيح جزء البرنامج: الأدوات </h2><br><p style=";text-align:right;direction:rtl">  أولاً ، دعنا نتحدث عن أدوات تصحيح الأخطاء المتوفرة والقيود الخاصة بها. </p><br><h3 id="minicom" style=";text-align:right;direction:rtl">  Minicom </h3><br><p style=";text-align:right;direction:rtl">  أولاً ، سنحتاج إلى قراءة ما هو محمل الإقلاع ومخرج kernel بطريقة أو بأخرى.  للقيام بذلك ، على نظام Linux (في هذه الحالة ، الموجود على RaspberryPi) ، نحتاج إلى برنامج Minicom.  بشكل عام ، أي برنامج للعمل مع منفذ تسلسلي مناسب. </p><br><p style=";text-align:right;direction:rtl">  لاحظ أنه عند بدء التشغيل ، يجب تحديد اسم جهاز المنفذ كـ <code>-D /dev/ttyS0</code> - بعد الخيار <code>-D</code> .  حسنًا ، المعلومات الرئيسية: للخروج ، استخدم <code>Ctrl-A, X</code>  كان لدي حقًا حالة لم ينجح فيها هذا المزيج - ثم يمكنك ببساطة القول <code>killall -KILL minicom</code> من جلسة SSH المجاورة. </p><br><p style=";text-align:right;direction:rtl">  هناك ميزة أخرى.  على وجه التحديد ، هناك نوعان من UARTs على RaspberryPi ، ويمكن بالفعل تكييف كلا المنفذين لشيء ما: واحد للبلوتوث ، من خلال الآخر ، يتم عرض وحدة التحكم kernel بشكل افتراضي.  لحسن الحظ ، يمكن إعادة تكوين هذا السلوك <a href="">وفقًا لهذا الدليل</a> . </p><br><h3 id="perepisyvanie-pamyati" style=";text-align:right;direction:rtl">  إعادة كتابة الذاكرة </h3><br><p style=";text-align:right;direction:rtl">  عند تصحيح الأخطاء ، لاختبار الفرضية ، كان علي أحيانًا <em>تحميل أداة تحميل التشغيل</em> (آسف) في ذاكرة الوصول العشوائي مباشرةً من المضيف.  ربما يمكن القيام بذلك مباشرة من GDB ، لكن في النهاية ذهبت بالطريقة البسيطة: قمت بنسخ الملف الضروري إلى Raspberry ، كما أرسل المنفذ 4444 (telnet من OpenOCD) عبر SSH واستخدم الأمر <code>load_image</code> .  عند تنفيذه ، يبدو أن كل شيء مُجمد ، لكن في الواقع <em>"لا ينام ، بل يومض ببطء"</em> : يتم تحميل الملف ، بل يتم تنفيذه بسرعة بضع كيلوبايت في الثانية. </p><br><h3 id="osobennosti-ustanovki-breakpoint-ov" style=";text-align:right;direction:rtl">  ميزات تثبيت نقاط التوقف </h3><br><p style=";text-align:right;direction:rtl">  ربما ، لم يكن على الكثير منهم التفكير في هذا الأمر عند تصحيح البرامج العادية ، ولكن نقاط التوقف لا يتم وضعها دائمًا في الأجهزة.  في بعض الأحيان ، يتضمن إعداد نقطة توقف كتابة تعليمات خاصة إلى المكان الصحيح <strong>مباشرةً في رمز الجهاز</strong> .  على سبيل المثال ، هذه هي الطريقة التي يعمل بها أمر <code>b</code> القياسي في GDB.  هنا ما يلي من هذا: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  لا يمكنك وضع نقطة داخل BootROM ، لأن ROM </li><li style=";text-align:right;direction:rtl">  يمكنك تعيين نقطة توقف على الرمز الذي تم تحميله في ذاكرة الوصول العشوائي من بطاقة SD ، ولكن عليك الانتظار حتى يتم تحميله.  خلاف ذلك ، لن نقوم بإعادة كتابة جزء من الشفرة ، ولكن الجرافة ستعيد كتابة نقطة توقفنا </li></ul><br><p style=";text-align:right;direction:rtl">  أنا متأكد من أنه يمكنك المطالبة صراحة باستخدام نقاط توقف الأجهزة ، ولكن هناك عددًا محدودًا منها على أي حال. </p><br><h3 id="bystraya-podmena-bootrom" style=";text-align:right;direction:rtl">  تبادل سريع BootROM </h3><br><p style=";text-align:right;direction:rtl">  في المرحلة الأولى من تصحيح الأخطاء ، غالبًا ما تكون هناك رغبة في إصلاح BootROM والمحاولة مرة أخرى.  ولكن هناك مشكلة: BootROM هو جزء من التصميم الذي تم تحميله في FPGA ، وتوليفه مسألة عدة دقائق (وهذا بعد تجميع صورة BootROM نفسها على الفور من C و Assembler ...).  لحسن الحظ ، في الواقع ، كل شيء <strong>أسرع بكثير</strong> : تسلسل الإجراءات كما يلي: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  إعادة تشغيل bootrom.mif (انتقلت إلى MIF بدلاً من HEX ، لأنه مع HEX كان لدي دائمًا بعض المشاكل ، و MIF هو تنسيق Alter الأصلي) </li><li style=";text-align:right;direction:rtl">  في Quartus نقول <code>Processing -&gt; Update Memory Initialization File</code> </li><li style=";text-align:right;direction:rtl">  على مجمع (في العمود الأيسر من المهام) ، الأمر ابدأ مرة أخرى </li></ul><br><p style=";text-align:right;direction:rtl">  لكل شيء عن كل شيء - بضع عشرات من الثواني. </p><br><h2 id="podgotovka-sd-karty" style=";text-align:right;direction:rtl">  إعداد بطاقة SD </h2><br><p style=";text-align:right;direction:rtl">  كل شيء بسيط نسبيًا هنا ، ولكن يجب أن تتحلى بالصبر ولديك مساحة تبلغ 14 جيجابايت تقريبًا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git clone https://github.com/sifive/freedom-u-sdk git submodule update --recursive --init make</code> </pre> <br><p style=";text-align:right;direction:rtl">  ثم تحتاج إلى إدخال نظيف ، أو بالأحرى ، لا يحتوي على أي شيء تحتاجه ، وبطاقة SD ، وتنفيذها </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">sudo make DISK=/dev/sdX format-boot-loader</code> </pre> <br><p style=";text-align:right;direction:rtl">  ... حيث <code>sdX</code> هو الجهاز المخصص للبطاقة.  <strong>انتباه: سيتم حذف البيانات الموجودة على البطاقة ، الكتابة بشكل عام!</strong>  لا يستحق القيام بالتجميع الكامل من تحت <code>sudo</code> ، لأنه بعد ذلك سوف تكون جميع القطع الأثرية التجميعية مملوكة من قبل <code>root</code> ، ويجب أن يتم التجميع من تحت <code>sudo</code> الوقت. </p><br><p style=";text-align:right;direction:rtl">  والنتيجة هي بطاقة تم <code>uEnv.txt</code> في GPT مع أربعة أقسام ، أحدها هو FAT مع <code>uEnv.txt</code> وصورة قابلة للتنزيل بتنسيق FIT (تحتوي على عدة صور فرعية ، لكل منها عنوان التنزيل الخاص به) ، والقسم الآخر فارغ ، ومن المفترض أن يتم تنسيقه في Ext4 لنظام التشغيل Linux.  قسمان آخران <em>خفيان</em> : U-Boot يعيش على قسم واحد (الإزاحة ، كما أفهمها ، سلكية في BootROM) ، من ناحية أخرى ، يبدو أن متغيرات البيئة الخاصة به حية ، لكنني لا أستخدمها بعد. </p><br><h2 id="uroven-pervyy-bootrom" style=";text-align:right;direction:rtl">  المستوى الأول ، BootROM </h2><br><p style=";text-align:right;direction:rtl">  تقول الحكمة الشعبية: "إذا كان هناك في البرمجة رقصات مع الدف ، ثم في مجال الالكترونيات - وكذلك مع طفاية حريق."  لم يكن الأمر كذلك بمجرد أن أحرقت اللوحة تقريبًا ، وقررت أن "حسنًا ، GND هو نفس المستوى المنخفض" <em>(على ما يبدو ، لا تزال المقاومة لن تؤذي ...)</em> إنها تتعلق أكثر بحقيقة أنه إذا الأيدي لا تنمو من هناك ، ثم الإلكترونيات لا تتوقف عن جلب المفاجآت: عندما كنت أعلق الموصل على اللوحة ، ما زلت لا أستطيع حل جهات الاتصال بشكل طبيعي - يظهر الفيديو كيف ينتشر اللحام بشكل مباشر طوال الاتصال ، فقط قم بتطبيق المكواة ، لقد حصلت عليها على أية حال.  حسنًا ، ربما لم يكن اللحام مناسبًا لدرجة حرارة مكواة اللحام ، وربما شيئًا آخر ... بشكل عام ، عندما رأيت أنه كان لدي بالفعل عشرات الاتصالات ، بصق ، وبدأت في تصحيح الأخطاء.  ثم بدأ شيء <em>غامض</em> : قمت بتوصيل RX / TX من UART ، أقوم بتحميل البرامج الثابتة - يكتب </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">INIT CMD0 ERROR</code> </pre> <br><p style=";text-align:right;direction:rtl">  حسنًا ، كل شيء منطقي - لم أقم بتوصيل وحدة بطاقة SD.  نحن نصلح الموقف ونحمّل البرامج الثابتة ... والصمت ... ما لم أغير رأيه ، وفتح النعش للتو: كان من الضروري توصيل أحد مخرجات الوحدة النمطية بـ VCC.  في حالتي ، دعمت الوحدة 5 فولت للحصول على الطاقة ، لذلك دون التفكير مرتين ، علقت سلكًا ممتدًا من الوحدة إلى الجانب الآخر من اللوحة.  ونتيجة لذلك ، فإن الموصل الملتوي الملتوي ملتوي ، <strong>وفقد اتصال UART ببساطة.</strong>  <em>facepalm.jpg</em> بشكل عام ، "الرأس السيئ لا يعطي الراحة للساقين" ، ويداه ملتوية - إلى الرأس ... </p><br><p style=";text-align:right;direction:rtl">  في النهاية ، رأيت الذي طال انتظاره في Minicom </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING /</code> </pre> <br><p style=";text-align:right;direction:rtl">  وعلاوة على ذلك، <del>  يتحرك </del>  مؤشر التحميل هو الغزل.  أتذكر مباشرة السنوات الدراسية والتمهيد الممتع لـ MinuetOS من قرص مرن.  ما لم يطحن محرك الأقراص. </p><br><p style=";text-align:right;direction:rtl">  المشكلة هي أن لا شيء يحدث بعد رسالة BOOT.  لذا ، فقد حان الوقت للاتصال من خلال OpenOCD على Raspberry ، GDB على المضيف له ، ومعرفة ما هو عليه. </p><br><p style=";text-align:right;direction:rtl">  أولاً ، أظهر الاتصال بـ GDB على الفور أن <code>$pc</code> (عداد البرنامج ، عنوان التعليمات الحالية) ينتقل إلى <code>0x0</code> - ربما يحدث هذا بعد خطأ متعدد.  لذلك ، مباشرة بعد إصدار رسالة <code>BOOT</code> ، نضيف حلقة لا نهائية.  <em>هذا سوف يؤخره لفترة قصيرة ...</em> </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs">diff --git a/bootrom/sdboot/sd.cb/bootrom/sdboot/sd.c index c6b5ede..bca1b7f 100644 --- a/bootrom/sdboot/sd.c +++ b/bootrom/sdboot/sd.c @@ -224,6 +224,8 @@ int main(void) kputs("BOOT"); + while(*(volatile char *)0x10000){} + __asm__ __volatile__ ("fence.i" : : : "memory"); return 0; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يتم استخدام مثل هذا الرمز الصعب "من أجل الموثوقية": لقد سمعت في مكان ما ، على ما يبدو ، أن حلقة لا نهائية هي سلوك غير محدد ، وهنا من غير المرجح أن يخمن المترجم (أذكر أن BootROM يقع في <code>0x10000</code> ). </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wj/xw/a9/wjxwa9m9hqoghtvy79zsbysctr0.png" alt="هناك مصحح ، لا يوجد مصدر"></p><br><p style=";text-align:right;direction:rtl">  قد يبدو ذلك ، لكن ما الذي يمكن توقعه - مضمن قاسي ، ما هو نوع المصدر الموجود.  ولكن بعد كل شيء ، في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هذه المقالة ، قام</a> المؤلف بتصحيح الكود ... Krex-fex-pex: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) file builds/zeowaa-e115/sdboot.elf A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from builds/zeowaa-e115/sdboot.elf...done.</code> </pre> <br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ya/08/zp/ya08zpufla55qz02j5fhwcoijy4.png" alt="هناك رموز المصدر!"></p><br><p style=";text-align:right;direction:rtl">  تحتاج فقط إلى تحميل ملف MIF وليس حاوية ، ولكن النسخة الأصلية بتنسيق ELF. </p><br><p style=";text-align:right;direction:rtl">  الآن ، مع محاولة nth لتخمين العنوان حيث سيستمر التنفيذ (وهذا سبب آخر لماذا لا يجب أن يكون المترجم قد خمن أن الحلقة لا نهائية).  الفريق </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">set variable $pc=0xADDR</code> </pre> <br><p style=";text-align:right;direction:rtl">  يسمح لك بتغيير قيمة السجل أثناء التنقل (في هذه الحالة ، عنوان التعليمات الحالية).  من خلال مساعدتها ، يمكنك تغيير القيم المسجلة في الذاكرة (والسجلات المعينة في الذاكرة). </p><br><p style=";text-align:right;direction:rtl">  في النهاية ، توصلت إلى استنتاج (لست متأكداً مما إذا كان صحيحًا) أن لدينا "صورة بطاقة sd للنظام الخاطئ" ، وعلينا الانتقال إلى بداية البيانات التي تم تنزيلها ، ولكن إلى <code>0x89800</code> بايت أخرى: </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs">diff --git a/bootrom/sdboot/head.S b/bootrom/sdboot/head.S index 14fa740..2a6c944 100644 --- a/bootrom/sdboot/head.S +++ b/bootrom/sdboot/head.S @@ -13,7 +13,7 @@ _prog_start: smp_resume(s1, s2) csrr a0, mhartid la a1, dtb - li s1, PAYLOAD_DEST + li s1, (PAYLOAD_DEST + 0x89800) jr s1 .section .rodata</code> </pre> <br><p style=";text-align:right;direction:rtl">  ربما تأثر هذا أيضًا بحقيقة عدم امتلاك بطاقة 4Gb غير الضرورية في متناول اليد ، لقد <code>DEMO_END=11718750</code> إلى 2 جيجابت واستبدلتها في Makefile بـ <code>DEMO_END=11718750</code> بـ <code>DEMO_END=3078900</code> (لا ابحث عن المعنى في القيمة المحددة - لا توجد الآن ، إلى البطاقة). </p><br><h2 id="uroven-vtoroy-u-boot" style=";text-align:right;direction:rtl">  المستوى الثاني ، يو التمهيد </h2><br><p style=";text-align:right;direction:rtl">  الآن ما زلنا "نقع" ، لكننا بالفعل على العنوان <code>0x0000000080089a84</code> .  هنا يجب أن أعترف: في الواقع ، لا يذهب العرض التقديمي "مع كل المحطات" ، ولكن تمت كتابته جزئيًا "بعد" ، لذلك تمكنت هنا بالفعل من وضع ملف dtb الصحيح من شركة نفط الجنوب ، واضبط <code>CONFIG_SYS_TEXT_BASE=0x80089800</code> المتغير في <code>CONFIG_SYS_TEXT_BASE=0x80089800</code> <code>HiFive_U-Boot</code> (بدلاً من <code>0x08000000</code> ) بحيث يطابق عنوان التنزيل العنوان الفعلي.  تحميل الآن <del>  خريطة المستوى التالي </del>  صورة أخرى: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) file ../freedom-u-sdk/work/HiFive_U-Boot/u-boot (gdb) tui en</code> </pre> <br><p style=";text-align:right;direction:rtl">  ونحن نرى: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> │304 /* │ │305 * trap entry │ │306 */ │ │307 trap_entry: │ │308 addi sp, sp, -32*REGBYTES │ &gt;│309 SREG x1, 1*REGBYTES(sp) │ │310 SREG x2, 2*REGBYTES(sp) │ │311 SREG x3, 3*REGBYTES(sp) │</code> </pre> <br><p style=";text-align:right;direction:rtl">  ونحن نقفز بين السطور 308 و 309. وليس من المستغرب ، بالنظر إلى أن <code>$sp</code> تحتوي على القيمة <code>0xfffffffe31cdc0a0</code> .  للأسف ، إنه "يهرب" باستمرار أيضًا بسبب الخط 307. لذلك ، سنحاول تعيين نقطة توقف على <code>trap_entry</code> ، ثم <code>0x80089800</code> مرة أخرى إلى <code>0x80089800</code> (نقطة الدخول U-Boot) ، ونأمل ألا يتطلب الإعداد الصحيح <code>0x80089800</code> قبل الانتقال ... يبدو أن العمل: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) b trap_entry Breakpoint 1 at 0x80089a80: file /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S, line 308. (gdb) set variable $pc=0x80089800 (gdb) c Continuing. Breakpoint 1, trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:308 (gdb) p/x $sp $4 = 0x81cf950</code> </pre> <br><p style=";text-align:right;direction:rtl">  هكذا ، مؤشر المكدس ، دعنا نقول بصراحة: إنه يشير عمومًا إلى ذاكرة الوصول العشوائي (ما لم يكن ، بالطبع ، لا يزال لدينا ترجمة عنوان ، ولكن دعونا نأمل في خيار بسيط). </p><br><p style=";text-align:right;direction:rtl">  دعنا نحاول استبدال المؤشر بـ <code>0x881cf950</code> .  نتيجة لذلك ، توصلنا إلى حقيقة أن <code>handle_trap</code> يُطلق عليه ويسمى ، بينما نترك في <code>_exit_trap</code> مع الوسيطة <code>epc=2148315240</code> (بالتدوين العشري): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) x/10i 2148315240 0x800cb068 &lt;strnlen+12&gt;: lbu a4,0(a5) 0x800cb06c &lt;strnlen+16&gt;: bnez a4,0x800cb078 &lt;strnlen+28&gt; 0x800cb070 &lt;strnlen+20&gt;: sub a0,a5,a0 0x800cb074 &lt;strnlen+24&gt;: ret 0x800cb078 &lt;strnlen+28&gt;: addi a5,a5,1 0x800cb07c &lt;strnlen+32&gt;: j 0x800cb064 &lt;strnlen+8&gt; 0x800cb080 &lt;strdup&gt;: addi sp,sp,-32 0x800cb084 &lt;strdup+4&gt;: sd s0,16(sp) 0x800cb088 &lt;strdup+8&gt;: sd ra,24(sp) 0x800cb08c &lt;strdup+12&gt;: li s0,0</code> </pre> <br><p style=";text-align:right;direction:rtl">  وضعنا نقطة توقف على <code>strnlen</code> ، تابع وانظر: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) bt #0 strnlen (s=s@entry=0x10060000 "", count=18446744073709551615) at lib/string.c:283 #1 0x00000000800cc14c in string (buf=buf@entry=0x881cbd4c "", end=end@entry=0x881cc15c "", s=0x10060000 "", field_width=&lt;optimized out&gt;, precision=&lt;optimized out&gt;, flags=&lt;optimized out&gt;) at lib/vsprintf.c:265 #2 0x00000000800cc63c in vsnprintf_internal (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=0x800d446e "s , epc %08x , ra %08lx\n", fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=0x881cc1a0, args@entry=0x881cc188) at lib/vsprintf.c:619 #3 0x00000000800cca54 in vsnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:710 #4 0x00000000800cca68 in vscnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:717 #5 0x00000000800ccb50 in printf (fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n") at lib/vsprintf.c:792 #6 0x000000008008a9f0 in _exit_trap (regs=&lt;optimized out&gt;, epc=2148315240, code=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:92 #7 handle_trap (mcause=&lt;optimized out&gt;, epc=&lt;optimized out&gt;, regs=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:55 #8 0x0000000080089b10 in trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:343 Backtrace stopped: frame did not save the PC</code> </pre> <br><p style=";text-align:right;direction:rtl">  يبدو أن <code>_exit_trap</code> يريد إعطاء معلومات تصحيح الأخطاء حول الاستثناء الذي حدث ، <em>لكنه فشل</em> .  لذلك ، لا يتم عرض شيء مع شفرة المصدر مرة أخرى.  <code>set directories ../freedom-u-sdk/HiFive_U-Boot/</code> أوه!  عرض الآن! </p><br><p style=";text-align:right;direction:rtl">  حسنًا ، قم بتشغيله مرة أخرى <code>mcause == 5</code> على المكدس تتبع سبب المشكلة الأصلية التي تسببت في الخطأ الأول ( <code>mcause == 5</code> ).  إذا فهمت بشكل صحيح ما هو مكتوب <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> في الصفحة 37 ، فإن هذا الاستثناء يعني <code>Load access fault</code> .  السبب ، على ما يبدو ، هو لأنه هنا </p><br><p style=";text-align:right;direction:rtl">  <strong>القوس / riscv / وحدة المعالجة المركزية / HiFive / start.S:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">call_board_init_f: li t0, -16 li t1, CONFIG_SYS_INIT_SP_ADDR and sp, t1, t0 /* force 16 byte alignment */ #ifdef CONFIG_DEBUG_UART jal debug_uart_init #endif call_board_init_f_0: mv a0, sp jal board_init_f_alloc_reserve mv sp, a0 jal board_init_f_init_reserve mv a0, zero /* a0 &lt;-- boot_flags = 0 */ la t5, board_init_f jr t5 /* jump to board_init_f() */</code> </pre><br><p style=";text-align:right;direction:rtl">  <code>$sp</code> له نفس القيمة غير الصحيحة ، ويحدث خطأ داخل <code>board_init_f_init_reserve</code> .  يبدو أن ذلك هو الجاني: متغير باسم صريح <code>CONFIG_SYS_INIT_SP_ADDR</code> .  يتم تعريفه في الملف <code>HiFive_U-Boot/include/configs/HiFive-U540.h</code> .  في مرحلة ما ، حتى أنني فكرت ، أو ربما ، بشكل جيد ، في إنهاء محمل الإقلاع للمعالج - ربما يكون من الأسهل إصلاح المعالج قليلاً؟  ولكن بعد ذلك رأيت أنه يشبه قطعة أثرية من إعدادات <code>#if 0</code> ليست تمامًا لتكوين ذاكرة مختلف ، ويمكنك محاولة القيام بذلك: </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs">diff --git a/include/configs/HiFive-U540.hb/include/configs/HiFive-U540.h index ca89383..245542c 100644 --- a/include/configs/HiFive-U540.h +++ b/include/configs/HiFive-U540.h @@ -65,12 +65,9 @@ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif #if 1 -/*#define CONFIG_NR_DRAM_BANKS 1*/ +#define CONFIG_NR_DRAM_BANKS 1 #define PHYS_SDRAM_0 0x80000000 /* SDRAM Bank #1 */ -#define PHYS_SDRAM_1 \ - (PHYS_SDRAM_0 + PHYS_SDRAM_0_SIZE) /* SDRAM Bank #2 */ -#define PHYS_SDRAM_0_SIZE 0x80000000 /* 2 GB */ -#define PHYS_SDRAM_1_SIZE 0x10000000 /* 256 MB */ +#define PHYS_SDRAM_0_SIZE 0x40000000 /* 1 GB */ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif /* @@ -81,7 +78,7 @@ #define CONSOLE_ARG "console=ttyS0,115200\0" /* Init Stack Pointer */ -#define CONFIG_SYS_INIT_SP_ADDR (0x08000000 + 0x001D0000 - \ +#define CONFIG_SYS_INIT_SP_ADDR (0x80000000 + 0x001D0000 - \ GENERATED_GBL_DATA_SIZE) #define CONFIG_SYS_LOAD_ADDR 0xa0000000 /* partway up SDRAM */</code> </pre> <br><p style=";text-align:right;direction:rtl">  في مرحلة ما ، الكمية <del>  ركائز </del>  وصلت <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">السحابات التكنولوجية</a> إلى نقطة حرجة.  بعد قليل من العذاب ، توصلت إلى الحاجة إلى جعل المنفذ الصحيح على لوحتي.  للقيام بذلك ، تحتاج إلى نسخ وتصحيح عدد معين من الملفات لتكوين لدينا. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">حسنا ، تقريبا ، هنا طاولة صغيرة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">trosinenko@trosinenko-pc:/hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot$ git show --name-status commit 39cd67d59c16ac87b46b51ac1fb58f16f1eb1048 (HEAD -&gt; zeowaa-1gb) Author: Anatoly Trosinenko &lt;anatoly.trosinenko@gmail.com&gt; Date: Tue Jul 2 17:13:16 2019 +0300 Initial support for Zeowaa A-E115FB board M arch/riscv/Kconfig A arch/riscv/cpu/zeowaa-1gb/Makefile A arch/riscv/cpu/zeowaa-1gb/cpu.c A arch/riscv/cpu/zeowaa-1gb/start.S A arch/riscv/cpu/zeowaa-1gb/timer.c A arch/riscv/cpu/zeowaa-1gb/u-boot.lds M arch/riscv/dts/Makefile A arch/riscv/dts/zeowaa-1gb.dts A board/Zeowaa/zeowaa-1gb/Kconfig A board/Zeowaa/zeowaa-1gb/MAINTAINERS A board/Zeowaa/zeowaa-1gb/Makefile A board/Zeowaa/zeowaa-1gb/Zeowaa-A-E115FB.c A configs/zeowaa-1gb_defconfig A include/configs/zeowaa-1gb.h</code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكن العثور على التفاصيل في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">المستودع</a> . </p></div></div><br><p style=";text-align:right;direction:rtl">  كما اتضح فيما بعد ، على سجلات SiFive هذه ، تحتوي سجلات بعض الأجهزة على عناوين مختلفة.  اتضح أيضًا أن U-Boot قد تم تكوينه بواسطة آلية Kconfig ، المألوفة بالفعل من نواة Linux - على سبيل المثال ، يمكنك أن تطلب إجراء menuconfig ، وسترى واجهة نصية مريحة مع أوصاف المعلمات المعروضة في <code>?</code>  إلخ  بشكل عام ، بعد أن أعمى وصف الثلث من أوصاف اللوحتين ، ورمي أي إعادة تشكيل PLL مثيرة للشفقة من هناك (على ما يبدو ، هذا مرتبط بطريقة أو بأخرى بالتحكم PCIe من الكمبيوتر المضيف ، لكن هذا غير دقيق) ، حصلت على بعض البرامج الثابتة ، والتي ، إذا كان الطقس صحيحًا على المريخ أعطاني رسالة UART حول أي التزام تم جمعه منه ، وكم DRAM لدي (ولكني سجلت هذه المعلومات أيضًا في الرأس). </p><br><p style=";text-align:right;direction:rtl">  إنه لأمر مؤسف أنه بعد هذا توقف عادة عن الاستجابة مع JTAG المعالج ، والتشغيل من بطاقة SD ، للأسف ، ليست سريعة في التكوين الخاص بي.  من ناحية أخرى ، في بعض الأحيان يعرض BootROM رسالة تفيد بأن <code>ERROR</code> لا يمكنه التمهيد ، وظهرت U-Boot على الفور.  عندها بزغ فجرًا لي: على ما يبدو ، بعد إعادة تشغيل BITSTREAM ، لا تتآكل الذاكرة في FPGA ، وليس لديها وقت "للتمزيق" ، إلخ.  باختصار ، يمكنك ببساطة عند ظهور <code>LOADING /</code> message ، الاتصال <code>set variable $pc=0x80089800</code> الأوامر <code>set variable $pc=0x80089800</code> ، متجاوزًا هذا الحمل الطويل (بالطبع ، مع افتراض أنه قد تم كسره في وقت مبكر جدًا ، ولم يكن لديه وقت أعلى الرمز الأصلي تنزيل). </p><br><p style=";text-align:right;direction:rtl">  بالمناسبة ، من الطبيعي بشكل عام تعليق المعالج تمامًا ولا يمكن توصيل مصحح أخطاء JTAG بالرسائل </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Error: unable to halt hart 0 Error: dmcontrol=0x80000001 Error: dmstatus =0x00030c82</code> </pre> <br><p style=";text-align:right;direction:rtl">  لذا انتظر!  لقد رأيته بالفعل! -     TileLink,      -   —   … ,           : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING BOOT U-Boot 2018.09-g39cd67d-dirty (Jul 03 2019 - 13:50:33 +0300) DRAM: 1 GiB MMC: BEFORE LOAD ENVBEFORE FDTCONTROLADDRBEFORE LOADADDRIn: serial Out: serial Err: serial Hit any key to stop autoboot: 3</code> </pre> <br><p style=";text-align:right;direction:rtl">      <code>In: serial</code>    —       ,      environment.  , «    »?          !  :  U-Boot      2^24   SD-, ,    <del>   </del>  ,      ,        ,   ELF-,    .  : ,       ,     . </p><br><p style=";text-align:right;direction:rtl"> ,    ? ,    -  ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,    ? </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) set variable *0x0200bff8=310000000 (gdb) c</code> </pre> <br><p style=";text-align:right;direction:rtl"> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0</code> </pre> <br><p style=";text-align:right;direction:rtl"> :   . , -        : </p><br><p style=";text-align:right;direction:rtl"> <strong>HiFive_U-Boot/cmd/bootmenu.c:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bootmenu_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct bootmenu_data *menu, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bootmenu_key *key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *esc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!tstc()) { WATCHDOG_RESET(); mdelay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } c = getc(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*esc) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* First char of ANSI escape sequence '\e' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'\e'</span></span>) { *esc = <span class="hljs-number"><span class="hljs-number">1</span></span>; *key = KEY_NONE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* Second char of ANSI '[' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'['</span></span>) { ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  <abbr title="في الواقع لا ، على الأقل ليس فقط في هذا ، انظر كذلك">  </abbr> ,    :      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">DTSTimebase</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">BigInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl"> …   ,      «   —  0».   <code>WithNBigCores</code>      1MHz (, ,      U-Boot).   , ,   :    ,  25MHz!     .   «» ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0 ## Unknown partition table type 0 libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND ** No partition table - mmc 0 ** ## Info: input data size = 34 = 0x22 Running uEnv.txt boot2... ## Error: "boot2" not defined HiFive-Unleashed #</code> </pre> <br><p style=";text-align:right;direction:rtl">    ! ,  , , ,   <code>mmc_spi 1 10000000 0; mmc part</code> ,   SPI  20MHz  10MHz.  لماذا؟ ,       20MHz,      . ,   , ,    ,  :      (  —  25MHz)  ,           .   ,    115200Hz UART-   ,  ,     25000000  20000000  1, ..     25MHz. ,   ,    , ,  -  (   )…  ,      —  , , . 25MHz —    Core i9. </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">HiFive-Unleashed # env edit mmcsetup edit: mmc_spi 1 10000000 0; mmc part HiFive-Unleashed # boot MMC_SPI: 1 at 0:1 hz 10000000 mode 0 Partition Map for MMC device 0 -- Partition Type: EFI Part Start LBA End LBA Name Attributes Type GUID Partition GUID 1 0x00000800 0x0000ffde "Vfat Boot" attrs: 0x0000000000000000 type: ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 type: data guid: 76bd71fd-1694-4ff3-8197-bfa81699c2fb 2 0x00040800 0x002efaf4 "root" attrs: 0x0000000000000000 type: 0fc63daf-8483-4772-8e79-3d69d8477de4 type: linux guid: 9f3adcc5-440c-4772-b7b7-283124f38bf3 3 0x0000044c 0x000007e4 "uboot" attrs: 0x0000000000000000 type: 5b193300-fc78-40cd-8002-e86c45580b47 guid: bb349257-0694-4e0f-9932-c801b4d76fa3 4 0x00000400 0x0000044b "uboot-env" attrs: 0x0000000000000000 type: a09354ac-cd63-11e8-9aff-70b3d592f0fa guid: 4db442d0-2109-435f-b858-be69629e7dbf libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND 2376 bytes read in 0 ms Running uEnv.txt boot2... 15332118 bytes read in 0 ms ## Loading kernel from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'bbl' kernel subimage Description: BBL/SBI/riscv-pk Type: Kernel Image Compression: uncompressed Data Start: 0x900000d4 Data Size: 74266 Bytes = 72.5 KiB Architecture: RISC-V OS: Linux Load Address: 0x80000000 Entry Point: 0x80000000 Hash algo: sha256 Hash value: 28972571467c4ad0cf08a81d9cf92b9dffc5a7cb2e0cd12fdbb3216cf1f19cbd Verifying Hash Integrity ... sha256+ OK ## Loading fdt from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'fdt' fdt subimage Description: unavailable Type: Flat Device Tree Compression: uncompressed Data Start: 0x90e9d31c Data Size: 6911 Bytes = 6.7 KiB Architecture: RISC-V Load Address: 0x81f00000 Hash algo: sha256 Hash value: 10b0244a5a9205357772ea1c4e135a4f882409262176d8c7191238cff65bb3a8 Verifying Hash Integrity ... sha256+ OK Loading fdt from 0x90e9d31c to 0x81f00000 Booting using the fdt blob at 0x81f00000 ## Loading loadables from FIT Image at 90000000 ... Trying 'kernel' loadables subimage Description: Linux kernel Type: Kernel Image Compression: uncompressed Data Start: 0x900123e8 Data Size: 10781356 Bytes = 10.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x80200000 Entry Point: unavailable Hash algo: sha256 Hash value: 72a9847164f4efb2ac9bae736f86efe7e3772ab1f01ae275e427e2a5389c84f0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x900123e8 to 0x80200000 ## Loading loadables from FIT Image at 90000000 ... Trying 'ramdisk' loadables subimage Description: buildroot initramfs Type: RAMDisk Image Compression: gzip compressed Data Start: 0x90a5a780 Data Size: 4467411 Bytes = 4.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x82000000 Entry Point: unavailable Hash algo: sha256 Hash value: 883dfd33ca047e3ac10d5667ffdef7b8005cac58b95055c2c2beda44bec49bd0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x90a5a780 to 0x82000000</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl"> ,     ,     .      .  mcause ,      <code>$pc</code>   <code>si</code>   <code>trap_entry</code> .    U-Boot     mcause = 0..4,      .     ,  ,    ,  :    <code>conf/rvboot-fit.txt</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">fitfile=image.fit # below much match what's in FIT (ugha)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,     ,      ,   ,  <code>SIF0</code> —  <abbr title="في الواقع لا ، كما اتضح بعد ذلك"> -  PCIe</abbr> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-bootargs=console=ttySIF0,921600 debug +bootargs=console=ttyS0,125200 debug</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">        SHA-256  MD5:     ( ,  ),    ,         MD5 —  .  ما هي النتيجة؟        (    ),   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">... Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; Loading Kernel Image ... OK Booting kernel in 3</code> </pre> <br><p style=";text-align:right;direction:rtl">     ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p style=";text-align:right;direction:rtl"> , ,     ,     ,  . , ,  ,         ,  : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=1000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=2000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=3000000 (gdb) c Continuing.</code> </pre> <br><p style=";text-align:right;direction:rtl">  ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,     —  , ,     ! </p><br><p style=";text-align:right;direction:rtl">        -  </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0000000080001c20 &lt;poweroff&gt;: 80001c20: 1141 addi sp,sp,-16 80001c22: e022 sd s0,0(sp) 80001c24: 842a mv s0,a0 80001c26: 00005517 auipc a0,0x5 80001c2a: 0ca50513 addi a0,a0,202 # 80006cf0 &lt;softfloat_countLeadingZeros8+0x558&gt; 80001c2e: e406 sd ra,8(sp) 80001c30: f7fff0ef jal ra,80001bae &lt;printm&gt; 80001c34: 8522 mv a0,s0 80001c36: 267000ef jal ra,8000269c &lt;finisher_exit&gt; 80001c3a: 00010797 auipc a5,0x10 80001c3e: 41e78793 addi a5,a5,1054 # 80012058 &lt;htif&gt; 80001c42: 639c ld a5,0(a5) 80001c44: c399 beqz a5,80001c4a &lt;poweroff+0x2a&gt; 80001c46: 72c000ef jal ra,80002372 &lt;htif_poweroff&gt; 80001c4a: 45a1 li a1,8 80001c4c: 4501 li a0,0 80001c4e: dc7ff0ef jal ra,80001a14 &lt;send_ipi_many&gt; 80001c52: 10500073 wfi 80001c56: bff5 j 80001c52 &lt;poweroff+0x32&gt;</code> </pre> <br><p style=";text-align:right;direction:rtl">   Berkeley Boot Loader.       <code>htif</code> — host interface,   tethered-  (      ARM), -  standalone. ,      ,  ,     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poweroff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> code)</span></span></span><span class="hljs-function"> </span></span>{ printm(<span class="hljs-string"><span class="hljs-string">"Power off\r\n"</span></span>); finisher_exit(code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (htif) { htif_poweroff(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { send_ipi_many(<span class="hljs-number"><span class="hljs-number">0</span></span>, IPI_HALT); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"wfi\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } } }</code> </pre> <br><h2 id="kvest-zapusti-chasy" style=";text-align:right;direction:rtl"> :   </h2><br><p style=";text-align:right;direction:rtl">    CLINT    </p><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> io = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bundle</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcTick = <span class="hljs-type"><span class="hljs-type">Bool</span></span>(<span class="hljs-type"><span class="hljs-type">INPUT</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> time = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, width = timeWidth)) when (io.rtcTick) { time := time + <span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br><p style=";text-align:right;direction:rtl">    RTC,    MockAON,     : «,     ? ? !»      ,       ,       <code>System.scala</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcDivider = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span>asUInt(<span class="hljs-number"><span class="hljs-number">16.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-comment"><span class="hljs-comment">//      16,   :) val mhzInt = p(DevKitFPGAFrequencyKey).toInt // ,      rtcDivider := Mux(rtcDivider === (mhzInt - 1).U, 0.U, rtcDivider + 1.U) outer.clintOpt.foreach { clint =&gt; clint.module.io.rtcTick := rtcDivider === 0.U }</span></span></code> </pre> <br><h2 id="probirayas-k-linux-kernel" style=";text-align:right;direction:rtl">   Linux kernel </h2><br><p style=";text-align:right;direction:rtl">           ,    : </p><br><p style=";text-align:right;direction:rtl"> BBL   FDT   <code>0xF0000000</code> ,     !   ,  …   <strong>HiFive_U-Boot/arch/riscv/lib/boot.c</strong> ,   <code>0x81F00000</code> ,     U-Boot. </p><br><p style=";text-align:right;direction:rtl">  BBL ,   .      <code>mem_prop</code> ,   <strong>riscv-pk/machine/fdt.c</strong> :   ,     fdt ram  <code>device_type = "memory"</code> — , ,     ,      —       . </p><br><p style=";text-align:right;direction:rtl">     (   ,   ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">This is bbl's dummy_payload. To boot a real kernel, reconfigure bbl with the flag --with-payload=PATH, then rebuild bbl. Alternatively, bbl can be used in firmware-only mode by adding device-tree nodes for an external payload and use QEMU's -bios and -kernel options.</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,      <code>riscv,kernel-start</code>  <code>riscv,kernel-end</code>  DTB,   .  <code>query_chosen</code> ,  BBL   32- ,     <code>&lt;0x0 0xADDR&gt;</code> ,   , ,  .    <code>chosen</code> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">chosen { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; ... }</code> </pre> <br><p style=";text-align:right;direction:rtl">    : <abbr title="ولكن هناك حل أفضل">  <code>0x0</code>  </abbr> . </p><br><p style=";text-align:right;direction:rtl">  100500       ,   : </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">النص المخفي</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ... bbl loader SIFIVE, INC. 5555555555555555555555555 5555 5555 5555 5555 5555 5555 5555 5555555555555555555555 5555 555555555555555555555555 5555 5555 5555 5555 5555 5555 5555555555555555555555555555 55555 55555 555555555 55555 55555 55555 55555 55555 5 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 555555555 55555 5 SiFive RISC-V Core IP [ 0.000000] OF: fdt: Ignoring memory range 0x80000000 - 0x80200000 [ 0.000000] Linux version 4.19.0-sifive-1+ (trosinenko@trosinenko-pc) (gcc version 8.3.0 (Buildroot 2019.02-07449-g4eddd28f99)) #1 SMP Wed Jul 3 21:29:21 MSK 2019 [ 0.000000] bootconsole [early0] enabled [ 0.000000] Initial ramdisk at: 0x(____ptrval____) (16777216 bytes) [ 0.000000] Zone ranges: [ 0.000000] DMA32 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Normal [mem 0x00000000c0000000-0x00000bffffffffff] [ 0.000000] Movable zone start for each node [ 0.000000] Early memory node ranges [ 0.000000] node 0: [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Initmem setup node 0 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] On node 0 totalpages: 261632 [ 0.000000] DMA32 zone: 3577 pages used for memmap [ 0.000000] DMA32 zone: 0 pages reserved [ 0.000000] DMA32 zone: 261632 pages, LIFO batch:63 [ 0.000000] software IO TLB: mapped [mem 0xbb1fc000-0xbf1fc000] (64MB)</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl"> (  BBL,       — ). </p><br><p style=";text-align:right;direction:rtl">  ,  ,  ,   RocketChip     JTAG   trap-   —      . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Program received signal SIGTRAP, Trace/breakpoint trap. 0xffffffe0000024ca in ?? () (gdb) bt #0 0xffffffe0000024ca in ?? () Backtrace stopped: previous frame identical to this frame (corrupt stack?) (gdb) file work/linux/vmlinux A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from work/linux/vmlinux...done. (gdb) bt #0 0xffffffe0000024ca in setup_smp () at /hdd/trosinenko/fpga/freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:75 #1 0x0000000000000000 in ?? () Backtrace stopped: frame did not save the PC</code> </pre> <br><p style=";text-align:right;direction:rtl"> <strong>freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_smp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_node</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dn</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NULL</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hart; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found_boot_cpu = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpuid = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((dn = of_find_node_by_type(dn, <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>))) { hart = riscv_of_processor_hartid(dn); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart == cpuid_to_hartid_map(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { BUG_ON(found_boot_cpu); found_boot_cpu = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } cpuid_to_hartid_map(cpuid) = hart; set_cpu_possible(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); set_cpu_present(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); cpuid++; } BUG_ON(!found_boot_cpu); <span class="hljs-comment"><span class="hljs-comment">// &lt;    }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">     , <em>CPU not found, running software emulation</em> .    running.     . </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* The lucky hart to first increment this variable will boot the other cores */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">atomic_t</span></span> hart_lottery; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> boot_cpu_hartid;</code> </pre> <br><p style=";text-align:right;direction:rtl">    <strong>linux/arch/riscv/kernel/setup.c</strong> —       .  ,   -  ,     ... </p><br><p style=";text-align:right;direction:rtl">         . </p><br><p style=";text-align:right;direction:rtl">  .       ,   ,      singlestep-. </p><br><p style=";text-align:right;direction:rtl">    ( ): <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><img src="https://asciinema.org/a/h22F5eCMXYF9n7n89CY6NJNEi.svg" alt="asciicast"></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar458482/">https://habr.com/ru/post/ar458482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar458464/index.html">رابط جيجابت 3 كم على أجهزة المودم الليزرية</a></li>
<li><a href="../ar458468/index.html">كيف تدير اجتماعًا رائعًا لـ Kanban؟</a></li>
<li><a href="../ar458470/index.html">التركيب ، أو ما تحتاج إلى معرفته لتصبح فنان السطح. الجزء 2. أقنعة والقوام</a></li>
<li><a href="../ar458472/index.html">تجميع تصنيف المناطق بطريقة الإمكانات الحرارية باستخدام البيانات المفتوحة</a></li>
<li><a href="../ar458474/index.html">أفضل التقارير مع HighLoad ++ 2018</a></li>
<li><a href="../ar458486/index.html">أسرار العمل بالنسيج في لعبة آلان ويك</a></li>
<li><a href="../ar458488/index.html">ملخص علم البيانات (يوليو 2019)</a></li>
<li><a href="../ar458490/index.html">التمسك بإحكام بعجلة القيادة ... مشروعنا لمراقبة حالة السائقين</a></li>
<li><a href="../ar458492/index.html">"كنا نؤمن دائمًا بالمنافسة والحق في اختيار المستخدم" © Yandex</a></li>
<li><a href="../ar458494/index.html">مثال عملي لاستخدام وظائف تقديم Vue: إنشاء شبكة مطبعية لنظام التصميم</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>