<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âœğŸ¾ ğŸ”„ ğŸ‘­ ä»å¤´å¼€å§‹RISC-V ğŸ¤˜ ğŸŒŠ ğŸ§™ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡RISC-Vä½“ç³»ç»“æ„åŠå…¶ç”Ÿæ€ç³»ç»Ÿæ¥æ¢è®¨å„ç§åº•å±‚æ¦‚å¿µï¼ˆç¼–è¯‘å’Œå¸ƒå±€ï¼ŒåŸå§‹è¿è¡Œæ—¶ï¼Œæ±‡ç¼–å™¨ç­‰ï¼‰ã€‚ æˆ‘æœ¬äººæ˜¯ä¸€åWebå¼€å‘äººå‘˜ï¼Œæˆ‘ä»€ä¹ˆéƒ½ä¸åšï¼Œä½†è¿™å¯¹æˆ‘æ¥è¯´å¾ˆæœ‰è¶£ï¼Œè¿™æ˜¯æ–‡ç« çš„æ¥æºï¼ å’Œæˆ‘ä¸€èµ·åœ¨è¿™ä½çº§æ··ä¹±çš„æ·±å¤„è¿›è¡Œå¿™ç¢Œçš„æ—…ç¨‹ã€‚ 

 é¦–å…ˆï¼Œè®©æˆ‘ä»¬è°ˆè°ˆRISC-VåŠå…¶æ¶æ„çš„é‡è¦æ€§ï¼Œè®¾ç½®RISC-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä»å¤´å¼€å§‹RISC-V</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454208/"> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡RISC-Vä½“ç³»ç»“æ„åŠå…¶ç”Ÿæ€ç³»ç»Ÿæ¥æ¢è®¨å„ç§åº•å±‚æ¦‚å¿µï¼ˆç¼–è¯‘å’Œå¸ƒå±€ï¼ŒåŸå§‹è¿è¡Œæ—¶ï¼Œæ±‡ç¼–å™¨ç­‰ï¼‰ã€‚ æˆ‘æœ¬äººæ˜¯ä¸€åWebå¼€å‘äººå‘˜ï¼Œæˆ‘ä»€ä¹ˆéƒ½ä¸åšï¼Œä½†è¿™å¯¹æˆ‘æ¥è¯´å¾ˆæœ‰è¶£ï¼Œè¿™æ˜¯æ–‡ç« çš„æ¥æºï¼ å’Œæˆ‘ä¸€èµ·åœ¨è¿™ä½çº§æ··ä¹±çš„æ·±å¤„è¿›è¡Œå¿™ç¢Œçš„æ—…ç¨‹ã€‚ <br><br> é¦–å…ˆï¼Œè®©æˆ‘ä»¬è°ˆè°ˆRISC-VåŠå…¶æ¶æ„çš„é‡è¦æ€§ï¼Œè®¾ç½®RISC-Vå·¥å…·é“¾å¹¶åœ¨ä»¿çœŸçš„RISC-Vç¡¬ä»¶ä¸Šè¿è¡Œä¸€ä¸ªç®€å•çš„Cç¨‹åºã€‚ <br><a name="habracut"></a><br><h1> ç›®å½•å†…å®¹ </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»€ä¹ˆæ˜¯RISC-Vï¼Ÿ</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é…ç½®QEMUå’ŒRISC-Vå·¥å…·</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å—¨ï¼ŒRISC-Vï¼</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤©çœŸçš„æ–¹æ³•</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æèµ·çª—å¸˜-v</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœç´¢æˆ‘ä»¬çš„å †æ ˆ</a> <br></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¸ƒå±€å›¾</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ«è¯´äº†</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><s>é”¤å‡»æ—¶é—´ï¼</s></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿è¡Œæ—¶ï¼</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è°ƒè¯•ä½†ç°åœ¨æ˜¯çœŸå®çš„</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€‰é…</a> </li></ol><br><a name="1"></a><h1> ä»€ä¹ˆæ˜¯RISC-Vï¼Ÿ </h1><br>  RISC-Væ˜¯ä¸€ç§å…è´¹çš„æŒ‡ä»¤é›†ä½“ç³»ç»“æ„ã€‚ è¯¥é¡¹ç›®äº2010å¹´èµ·æºäºåŠ åˆ©ç¦å°¼äºšå¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡ã€‚ ä»£ç çš„å¼€æ”¾æ€§å’Œä½¿ç”¨è‡ªç”±åº¦åœ¨å…¶æˆåŠŸä¸­æ‰®æ¼”ç€é‡è¦è§’è‰²ï¼Œè¿™ä¸è®¸å¤šå…¶ä»–ä½“ç³»ç»“æ„æœ‰å¾ˆå¤§ä¸åŒã€‚ ä»¥ARMä¸ºä¾‹ï¼šè¦åˆ›å»ºå…¼å®¹çš„å¤„ç†å™¨ï¼Œæ‚¨å¿…é¡»æ”¯ä»˜<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">100ä¸‡åˆ°1000ä¸‡ç¾å…ƒ</a>çš„é¢„ä»˜æ¬¾<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ï¼Œè¿˜éœ€æ”¯ä»˜é”€å”®æ”¶å…¥çš„0.5-2ï¼…çš„ç‰¹è®¸æƒä½¿ç”¨è´¹</a> ã€‚ è‡ªç”±å¼€æ”¾çš„æ¨¡å‹ä½¿RISC-Vå¯¹è®¸å¤šäººæ¥è¯´éƒ½æ˜¯æœ‰å¸å¼•åŠ›çš„é€‰æ‹©ï¼ŒåŒ…æ‹¬é‚£äº›æ— æ³•ä¸ºARMæˆ–å…¶ä»–å¤„ç†å™¨æ”¯ä»˜è®¸å¯è¯çš„åˆåˆ›å…¬å¸ï¼Œå­¦æœ¯ç ”ç©¶äººå‘˜ä»¥åŠï¼ˆæ˜¾ç„¶ï¼‰å¼€æºç¤¾åŒºã€‚ <br><br>  RISC-Vçš„è¿…é€Ÿæ™®åŠå¹¶æ²¡æœ‰å¼•èµ·äººä»¬çš„æ³¨æ„ã€‚  ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¨å‡ºäº†ä¸€ä¸ªç«™ç‚¹</a> ï¼ˆå°è¯•ï¼ˆä½†æ²¡æœ‰æˆåŠŸï¼‰ï¼‰å¼ºè°ƒARMä¼˜äºRISC-Vçš„ä¼˜åŠ¿ï¼ˆè¯¥ç«™ç‚¹å·²å…³é—­ï¼‰ã€‚  RISC-Vé¡¹ç›®å¾—åˆ°äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®¸å¤šå¤§å…¬å¸çš„</a>æ”¯æŒï¼ŒåŒ…æ‹¬Googleï¼ŒNvidiaå’ŒWestern Digitalã€‚ <br><br><a name="2"></a><h1> é…ç½®QEMUå’ŒRISC-Vå·¥å…· </h1><br> åœ¨è®¾ç½®ç¯å¢ƒä¹‹å‰ï¼Œæˆ‘ä»¬æ— æ³•åœ¨RISC-Vå¤„ç†å™¨ä¸Šè¿è¡Œä»£ç ã€‚ å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸éœ€è¦ç‰©ç†RISC-Vå¤„ç†å™¨ï¼›ç›¸åï¼Œæˆ‘ä»¬é‡‡ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">qemu</a> ã€‚ æŒ‰ç…§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯´æ˜</a>å®‰è£…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ“ä½œç³»ç»Ÿ</a> ã€‚ æˆ‘æœ‰MacOSï¼Œå› æ­¤åªéœ€è¾“å…¥ä¸€ä¸ªå‘½ä»¤ï¼š <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># also available via MacPorts - `sudo port install qemu` brew install qemu</span></span></code> </pre> <br> æ–¹ä¾¿åœ°ï¼Œ <code>qemu</code>é™„å¸¦äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‡ å°ç°æˆçš„è®¡ç®—æœº</a> ï¼ˆè¯·å‚é˜…<code>qemu-system-riscv32 -machine</code> ï¼‰ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œå®‰è£…é€‚ç”¨äºRISC-Vå’ŒRISC-Vå·¥å…·çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OpenOCD</a> ã€‚ <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>ä¸‹è½½RISC-V OpenOCDå’ŒRISC-Vå·¥å…·çš„ç°æˆç»„ä»¶ã€‚ <br> æˆ‘ä»¬å°†æ–‡ä»¶è§£å‹ç¼©åˆ°ä»»ä½•ç›®å½•ï¼Œ <code>~/usys/riscv</code> ã€‚ è®°ä½å®ƒä»¥å¤‡å°†æ¥ä½¿ç”¨ã€‚ <br><br><pre> <code class="bash hljs">mkdir -p ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads cp openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv cp riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv tar -xvf openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz tar -xvf riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz</code> </pre> <br> è®¾ç½®ç¯å¢ƒå˜é‡<code>RISCV_OPENOCD_PATH</code>å’Œ<code>RISCV_PATH</code>ä»¥ä¾¿å…¶ä»–ç¨‹åºå¯ä»¥æ‰¾åˆ°æˆ‘ä»¬çš„å·¥å…·é“¾ã€‚ æ ¹æ®æ“ä½œç³»ç»Ÿå’Œå¤–å£³ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥æœ‰æ‰€ä¸åŒï¼šæˆ‘å°†è·¯å¾„æ·»åŠ åˆ°<code>~/.zshenv</code> ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I put these two exports directly in my ~/.zshenv file - you may have to do something else. export RISCV_OPENOCD_PATH="$HOME/usys/riscv/openocd-&lt;date&gt;-&lt;version&gt;" export RISCV_PATH="$HOME/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;" # Reload .zshenv with our new environment variables. Restarting your shell will have a similar effect. source ~/.zshenv</span></span></code> </pre> <br> åœ¨<code>/usr/local/bin</code>ä¸­ä¸ºæ­¤å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥éšæ—¶è¿è¡Œå®ƒï¼Œè€Œæ— éœ€æŒ‡å®š<code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc</code> ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Symbolically link our gcc executable into /usr/local/bin. Repeat this process for any other executables you want to quickly access. ln -s ~/usys/riscv/riscv64-unknown-elf-gcc-8.2.0-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc /usr/local/bin</span></span></code> </pre> <br> ç§ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„RISC-Vå·¥å…·åŒ…ï¼ æˆ‘ä»¬æ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¾‹å¦‚<code>riscv64-unknown-elf-gcc</code> ï¼Œ <code>riscv64-unknown-elf-gdb</code> ï¼Œ <code>riscv64-unknown-elf-ld</code>ç­‰ï¼Œéƒ½ä½äº<code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/</code> ã€‚ <br><br><a name="3"></a><h1> å—¨ï¼ŒRISC-Vï¼ </h1><br>  <i>2019å¹´5æœˆ26æ—¥è¡¥ä¸ï¼š</i> <i><br><br></i>  <i>ä¸å¹¸çš„æ˜¯ï¼Œç”±äºRISC-V QEMUä¸­çš„é”™è¯¯ï¼ŒQEMUä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è‡ªç”±e-sdk</a> â€œ hello worldâ€ç¨‹åºä¸å†èµ·ä½œç”¨ã€‚</i>  <i>å·²ç»å‘å¸ƒäº†ä¸€ä¸ªè¡¥ä¸ç¨‹åºæ¥è§£å†³æ­¤é—®é¢˜ï¼Œä½†ç°åœ¨è¯·è·³è¿‡æœ¬èŠ‚ã€‚</i>  <i>æœ¬æ–‡çš„åç»­éƒ¨åˆ†å°†ä¸éœ€è¦æ­¤ç¨‹åºã€‚</i>  <i>ä¿®å¤é”™è¯¯åï¼Œæˆ‘ä¼šè·Ÿè¸ªæƒ…å†µå¹¶æ›´æ–°æ–‡ç« ã€‚</i> <i><br><br></i>  <i>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§æ­¤è¯„è®º</a> ã€‚</i> <br><br> é€šè¿‡è®¾ç½®å·¥å…·ï¼Œè®©æˆ‘ä»¬è¿è¡Œç®€å•çš„RISC-Vç¨‹åºã€‚ è®©æˆ‘ä»¬ä»å…‹éš†SiFive Freedom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-e-sdk</a>å­˜å‚¨åº“å¼€å§‹ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/wherever/you/want/to/<span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>/this git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive https://github.com/sifive/freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŒ‰ç…§ä¼ ç»Ÿ</a> ï¼Œè®©æˆ‘ä»¬ä»<code>freedom-e-sdk</code>å­˜å‚¨åº“ä¸­çš„â€œ Helloï¼Œworldâ€ç¨‹åºå¼€å§‹ã€‚ æˆ‘ä»¬ä½¿ç”¨ä»–ä»¬æä¾›çš„ç°æˆçš„<code>Makefile</code>åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç¼–è¯‘è¯¥ç¨‹åºï¼š <br><br><pre> <code class="bash hljs">make PROGRAM=hello TARGET=sifive-hifive1 CONFIGURATION=debug software</code> </pre> <br> å¹¶åœ¨QEMUä¸­è¿è¡Œï¼š <br><br><pre> <code class="bash hljs">qemu-system-riscv32 -nographic -machine sifive_e -kernel software/hello/debug/hello.elf Hello, World!</code> </pre> <br> è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ã€‚ æ‚¨å¯ä»¥ä»<code>freedom-e-sdk</code>è¿è¡Œå…¶ä»–ç¤ºä¾‹ã€‚ ä¹‹åï¼Œæˆ‘ä»¬å°†ç¼–å†™å¹¶å°è¯•ä½¿ç”¨Cè°ƒè¯•æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºã€‚ <br><br><h1> å¤©çœŸçš„æ–¹æ³• </h1><br> è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ç¨‹åºå¼€å§‹ï¼Œè¯¥ç¨‹åºæ— é™åœ°å°†ä¸¤ä¸ªæ•°å­—ç›¸åŠ ã€‚ <br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br> æˆ‘ä»¬è¦è¿è¡Œæ­¤ç¨‹åºï¼Œé¦–å…ˆéœ€è¦ä¸ºRISC-Vå¤„ç†å™¨ç¼–è¯‘å®ƒã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -O0 to disable all optimizations. Without this, GCC might optimize # away our infinite addition since the result 'c' is never used. # -g to tell GCC to preserve debug info in our executable. riscv64-unknown-elf-gcc add.c -O0 -g</span></span></code> </pre> <br> è¿™å°†åˆ›å»ºä¸€ä¸ª<code>a.out</code>æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶<code>gcc</code>é»˜è®¤ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚ ç°åœ¨åœ¨<code>qemu</code>è¿è¡Œæ­¤æ–‡ä»¶ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -machine tells QEMU which among our list of available machines we want to # run our executable against. Run qemu-system-riscv64 -machine help to list # all available machines. # -m is the amount of memory to allocate to our virtual machine. # -gdb tcp::1234 tells QEMU to also start a GDB server on localhost:1234 where # TCP is the means of communication. # -kernel tells QEMU what we're looking to run, even if our executable isn't # exactly a "kernel". qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</span></span></code> </pre> <br> æˆ‘ä»¬é€‰æ‹©äº†<code>riscv-qemu</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ€åˆéšé™„</a>çš„<code>virt</code>æœºã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬çš„ç¨‹åºåœ¨QEMUä¸­ä¸<code>localhost:1234</code>ä¸Šçš„GDBæœåŠ¡å™¨ä¸€èµ·è¿è¡Œï¼Œæˆ‘ä»¬ä»å¦ä¸€ä¸ªç»ˆç«¯é€šè¿‡RISC-V GDBå®¢æˆ·ç«¯è¿æ¥åˆ°å®ƒï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># --tui gives us a (t)extual (ui) for our GDB session. # While we can start GDB without any arguments, specifying 'a.out' tells GDB # to load debug symbols from that file for the newly created session. riscv64-unknown-elf-gdb --tui a.out</span></span></code> </pre> <br> è€Œä¸”æˆ‘ä»¬åœ¨GDBå†…éƒ¨ï¼ <br><br><pre> æ­¤GDBé…ç½®ä¸ºâ€œ --host = x86_64-apple-darwin17.7.0 --target = riscv64-unknown-elfâ€ã€‚  â”‚
é”®å…¥â€œæ˜¾ç¤ºé…ç½®â€ä»¥è·å–é…ç½®è¯¦ç»†ä¿¡æ¯ã€‚  â”‚
æœ‰å…³é”™è¯¯æŠ¥å‘Šçš„è¯´æ˜ï¼Œè¯·å‚è§ï¼šâ”‚
 &lt;http://www.gnu.org/software/gdb/bugs/&gt;ã€‚  â”‚
åœ¨çº¿æŸ¥æ‰¾GDBæ‰‹å†Œå’Œå…¶ä»–æ–‡æ¡£èµ„æºï¼šâ”‚
     &lt;http://www.gnu.org/software/gdb/documentation/&gt;ã€‚  â”‚
                                                                                                       â”‚
è¦è·å¾—å¸®åŠ©ï¼Œè¯·é”®å…¥â€œå¸®åŠ©â€ã€‚  â”‚
è¾“å…¥â€œ apropos wordâ€ä»¥æœç´¢ä¸â€œ wordâ€ç›¸å…³çš„å‘½ä»¤...â”‚
ä»a.outè¯»å–ç¬¦å·...â”‚
 ï¼ˆgdbï¼‰ </pre><br> æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨GDBä¸­ä¸º<code>a.out</code>å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œ<code>run</code>æˆ–<code>start</code>å‘½ä»¤ï¼Œä½†æ˜¯ç›®å‰ç”±äºæ˜æ˜¾çš„åŸå› ï¼Œè¯¥å‘½ä»¤æ— æ³•æ­£å¸¸å·¥ä½œã€‚ æˆ‘ä»¬å°†è¯¥ç¨‹åºç¼–è¯‘ä¸º<code>riscv64-unknown-elf-gcc</code> ï¼Œå› æ­¤ä¸»æœºåº”åœ¨<code>riscv64</code>ä½“ç³»ç»“æ„ä¸Šè¿è¡Œã€‚ <br><br> ä½†æ˜¯æœ‰å‡ºè·¯ï¼ è¿™ç§æƒ…å†µæ˜¯å­˜åœ¨GDBå®¢æˆ·æœåŠ¡å™¨æ¨¡å‹çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚ æˆ‘ä»¬å¯ä»¥è·å–<code>riscv64-unknown-elf-gdb</code>å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨ä¸»æœºä¸Šå¯åŠ¨å®ƒï¼Œè€Œæ˜¯ä¸ºå®ƒæŒ‡å®šä¸€äº›è¿œç¨‹ç›®æ ‡ï¼ˆGDBæœåŠ¡å™¨ï¼‰ã€‚ æ‚¨è¿˜è®°å¾—ï¼Œæˆ‘ä»¬åˆšåˆšå¯åŠ¨<code>riscv-qemu</code>å¹¶å‘Šè¯‰æˆ‘ä»¬åœ¨<code>localhost:1234</code>ä¸Šå¯åŠ¨GDBæœåŠ¡å™¨<code>localhost:1234</code> ã€‚ åªéœ€è¿æ¥åˆ°è¯¥æœåŠ¡å™¨ï¼š <br><br><pre>  ï¼ˆGDBï¼‰ç›®æ ‡è¿œç¨‹ï¼š1234â”‚
è¿œç¨‹è°ƒè¯•ä½¿ç”¨ï¼š1234 </pre><br> ç°åœ¨æ‚¨å¯ä»¥è®¾ç½®ä¸€äº›æ–­ç‚¹ï¼š <br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x1018e: file add.c, line 2. (gdb) b 5 <span class="hljs-comment"><span class="hljs-comment"># this is the line within the forever-while loop. int c = a + b; Breakpoint 2 at 0x1019a: file add.c, line 5.</span></span></code> </pre> <br> æœ€åï¼ŒæŒ‡å®šGDB <code>continue</code> ï¼ˆç¼©å†™ä¸º<code>c</code> ï¼‰ï¼Œç›´åˆ°åˆ°è¾¾æ–­ç‚¹ï¼š <br><br><pre> <code class="bash hljs">(gdb) c Continuing.</code> </pre> <br> æ‚¨ä¼šå¾ˆå¿«æ³¨æ„åˆ°è¯¥è¿‡ç¨‹ä¸ä¼šä»¥ä»»ä½•æ–¹å¼ç»“æŸã€‚ è¿™å¾ˆå¥‡æ€ªâ€¦â€¦æˆ‘ä»¬ä¸åº”è¯¥ç«‹å³åˆ°è¾¾æ–­ç‚¹<code>b 5</code>å—ï¼Ÿ å‘ç”Ÿä»€ä¹ˆäº‹äº† <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a53/834/210/a538342106336ef7ed1b8f9e53a47f48.png"><br><br> åœ¨è¿™é‡Œæ‚¨å¯ä»¥çœ‹åˆ°å‡ ä¸ªé—®é¢˜ï¼š <br><br><ol><li> æ–‡æœ¬UIæ‰¾ä¸åˆ°æºã€‚ è¯¥ç•Œé¢åº”æ˜¾ç¤ºæˆ‘ä»¬çš„ä»£ç å’Œé™„è¿‘çš„ä»»ä½•æ–­ç‚¹ã€‚ <br></li><li>  GDBçœ‹ä¸åˆ°å½“å‰æ‰§è¡Œè¡Œï¼ˆ <code>L??</code> ï¼‰ï¼Œå¹¶æ˜¾ç¤ºè®¡æ•°å™¨0x0ï¼ˆ <code>PC: 0x0</code> ï¼‰ã€‚ <br></li><li> è¾“å…¥è¡Œä¸­çš„æŸäº›æ–‡æœ¬å…¨éƒ¨å¦‚ä¸‹æ‰€ç¤ºï¼š <code>0x0000000000000000 in ?? ()</code> <code>0x0000000000000000 in ?? ()</code> </li></ol><br> ç»“åˆæˆ‘ä»¬æ— æ³•è¾¾åˆ°æ–­ç‚¹çš„äº‹å®ï¼Œè¿™äº›æŒ‡æ ‡è¡¨æ˜ï¼šæˆ‘ä»¬åšé”™äº†<i>ä»€ä¹ˆ</i> ã€‚ ä½†æ˜¯å‘¢ <br><br><a name="5"></a><h1> æèµ·çª—å¸˜-v </h1><br> è¦äº†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ï¼Œæ‚¨éœ€è¦é€€åä¸€æ­¥ï¼Œè°ˆè®ºæˆ‘ä»¬çš„ç®€å•Cç¨‹åºå®é™…ä¸Šæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚  <code>main</code>å‡½æ•°åšä¸€ä¸ªç®€å•çš„åŠ æ³•ï¼Œä½†å®é™…ä¸Šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä¸ºä»€ä¹ˆè¦ç§°å…¶ä¸ºâ€œ <code>main</code> â€è€Œä¸æ˜¯â€œ <code>origin</code>æˆ–â€œ <code>begin</code> ï¼Ÿ æ ¹æ®çº¦å®šï¼Œæ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶éƒ½å¼€å§‹ä½¿ç”¨<code>main</code>å‡½æ•°æ‰§è¡Œï¼Œä½†æ˜¯ä»€ä¹ˆé­”æœ¯æä¾›äº†è¿™ç§åŠŸèƒ½ï¼Ÿ <br><br> è¦å›ç­”è¿™äº›é—®é¢˜ï¼Œè®©æˆ‘ä»¬ç”¨<code>-v</code>æ ‡å¿—é‡å¤æˆ‘ä»¬çš„GCCå›¢é˜Ÿï¼Œä»¥è·å–å®é™…æƒ…å†µçš„æ›´è¯¦ç»†è¾“å‡ºã€‚ <br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc add.c -O0 -g -v</code> </pre> <br> è¾“å‡ºå¾ˆå¤§ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¸ä¼šæŸ¥çœ‹æ•´ä¸ªæ¸…å•ã€‚ é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œå°½ç®¡GCCæ­£å¼æ˜¯ç¼–è¯‘å™¨ï¼Œä½†å®ƒä¹Ÿé»˜è®¤ä¸ºç¼–è¯‘ï¼ˆè¦é™åˆ¶è‡ªå·±è¿›è¡Œç¼–è¯‘å’Œæ±‡ç¼–ï¼Œå¿…é¡»æŒ‡å®š<code>-c</code>æ ‡å¿—ï¼‰ã€‚ ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ å¥½å§ï¼Œçœ‹çœ‹<code>gcc</code>çš„è¯¦ç»†è¾“å‡ºä¸­çš„ä»£ç ç‰‡æ®µï¼š <br><br><pre>  ï¼ƒå®é™…çš„`gcc -v`å‘½ä»¤è¾“å‡ºå®Œæ•´è·¯å¾„ï¼Œä½†æ˜¯è¿™äº›è·¯å¾„ç›¸å½“
 ï¼ƒå¾ˆé•¿ï¼Œå› æ­¤å‡è£…è¿™äº›å˜é‡å­˜åœ¨ã€‚
 ï¼ƒ$ RV_GCC_BIN_PATH = /ç”¨æˆ·/ twilcock / usys / riscv / riscv64-unknown-elf-gcc- &lt;æ—¥æœŸ&gt;-&lt;ç‰ˆæœ¬&gt; / bin /
 ï¼ƒ$ RV_GCC_LIB_PATH = $ RV_GCC_BIN_PATH /../ lib / gcc / riscv64-unknown-elf / 8.2.0<font></font>
<font></font>
 $ RV_GCC_BIN_PATH /../ libexec / gcc / riscv64-unknown-elf / 8.2.0 / collect2 \
   ...è¢«æˆªæ–­... 
   $ RV_GCC_LIB_PATH /../../../../ riscv64-unknown-elf / lib / rv64imafdc / lp64d / crt0.o \ 
   $ RV_GCC_LIB_PATH / riscv64-unknown-elf / 8.2.0 / rv64imafdc / lp64d / crtbegin.o \
   -lgcc-å¼€å§‹ç»„-lc -lgloss-ç»“æŸç»„-lgcc \ 
   $ RV_GCC_LIB_PATH / rv64imafdc / lp64d / crtend.o
   ...è¢«æˆªæ–­...
 COLLECT_GCC_OPTIONS ='-O0''-g''-v''-march = rv64imafdc''-mabi = lp64d' </pre><br> æˆ‘çŸ¥é“å³ä½¿æ˜¯ç¼©å†™å½¢å¼ä¹Ÿå¾ˆå¤šï¼Œæ‰€ä»¥è®©æˆ‘è§£é‡Šä¸€ä¸‹ã€‚ åœ¨ç¬¬ä¸€è¡Œï¼Œ <code>gcc</code>è¿è¡Œ<code>collect2</code>ç¨‹åºï¼Œä¼ é€’å‚æ•°<code>crt0.o</code> ï¼Œ <code>crtbegin.o</code>å’Œ<code>crtend.o</code> ï¼Œ <code>-lgcc</code>å’Œ<code>--start-group</code>æ ‡å¿—ã€‚ å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>æ‰¾åˆ°collect2çš„æè¿°ï¼šç®€è€Œè¨€ä¹‹ï¼Œcollect2åœ¨å¯åŠ¨æ—¶ä¼šç»„ç»‡å„ç§åˆå§‹åŒ–å‡½æ•°ï¼Œä»è€Œä¸€æ¬¡æˆ–å¤šæ¬¡ä¼ é€’å¸ƒå±€ã€‚ <br><br> å› æ­¤ï¼ŒGCCä½¿ç”¨æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘äº†å¤šä¸ª<code>crt</code>æ–‡ä»¶ã€‚ å¦‚æ‚¨æ‰€æ–™ï¼Œ <code>crt</code>è¡¨ç¤ºâ€œ Cè¿è¡Œæ—¶â€ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>è¯¦ç»†æè¿°äº†æ¯ä¸ª<code>crt</code>ç”¨é€”ï¼Œä½†æ˜¯æˆ‘ä»¬å¯¹<code>crt0</code>æ„Ÿå…´è¶£ï¼Œå®ƒåšäº†ä¸€ä»¶é‡è¦çš„äº‹æƒ…ï¼š <br><br><blockquote>  <i>â€œæ­¤[crt0]å¯¹è±¡åº”è¯¥åŒ…å«<code>_start</code>å­—ç¬¦ï¼Œå®ƒæŒ‡ç¤ºç¨‹åºçš„å¼•å¯¼ç¨‹åºã€‚â€</i> </blockquote><br>  â€œå¼•å¯¼ç¨‹åºâ€çš„æœ¬è´¨å–å†³äºå¹³å°ï¼Œä½†æ˜¯å®ƒé€šå¸¸æ¶‰åŠé‡è¦çš„ä»»åŠ¡ï¼Œä¾‹å¦‚è®¾ç½®å †æ ˆæ¡†æ¶ï¼Œä¼ é€’å‘½ä»¤è¡Œå‚æ•°ä»¥åŠè°ƒç”¨<code>main</code> ã€‚ æ˜¯çš„ï¼Œæˆ‘ä»¬<i>ç»ˆäº</i>æ‰¾åˆ°äº†é—®é¢˜çš„ç­”æ¡ˆï¼š <code>_start</code>è°ƒç”¨äº†æˆ‘ä»¬çš„ä¸»è¦åŠŸèƒ½ï¼ <br><br><a name="6"></a><h1> æœç´¢æˆ‘ä»¬çš„å †æ ˆ </h1><br> æˆ‘ä»¬è§£å†³äº†ä¸€ä¸ªéš¾é¢˜ï¼Œä½†æ˜¯è¿™å¦‚ä½•ä½¿æˆ‘ä»¬æ›´æ¥è¿‘æœ€åˆçš„ç›®æ ‡-åœ¨<code>gdb</code>è¿è¡Œç®€å•çš„Cç¨‹åºï¼Ÿ ä»ç„¶éœ€è¦è§£å†³å‡ ä¸ªé—®é¢˜ï¼šç¬¬ä¸€ä¸ªé—®é¢˜ä¸<code>crt0</code>å¦‚ä½•é…ç½®å †æ ˆæœ‰å…³ã€‚ <br><br> å¦‚ä¸Šæ‰€è¿°ï¼Œ <code>gcc</code>é»˜è®¤ä¸º<code>crt0</code> ã€‚ åŸºäºä»¥ä¸‹å‡ ä¸ªå› ç´ é€‰æ‹©é»˜è®¤å‚æ•°ï¼š <br><br><ul><li> ä¸<code>machine-vendor-operatingsystem</code>çš„ç»“æ„ç›¸å¯¹åº”çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç›®æ ‡ä¸‰å…ƒç»„</a> ã€‚ æˆ‘ä»¬æ‹¥æœ‰<code>riscv64-unknown-elf</code> <br></li><li> ç›®æ ‡æ¶æ„<code>rv64imafdc</code> <br></li><li> ç›®æ ‡ABIï¼Œ <code>lp64d</code> </li></ul><br> é€šå¸¸ï¼Œä¸€åˆ‡éƒ½å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†ä¸é€‚ç”¨äºæ¯ä¸ªRISC-Vå¤„ç†å™¨ã€‚ å¦‚å‰æ‰€è¿°ï¼Œ <code>crt0</code>çš„ä»»åŠ¡ä¹‹ä¸€æ˜¯é…ç½®å †æ ˆã€‚ ä½†æ˜¯ä»–ä¸çŸ¥é“æˆ‘ä»¬çš„CPUï¼ˆ <code>-machine</code> ï¼‰çš„å †æ ˆåº”è¯¥åœ¨å“ªé‡Œï¼Ÿ æ²¡æœ‰æˆ‘ä»¬çš„å¸®åŠ©ï¼Œä»–æ— æ³•åšåˆ°ã€‚ <br><br> åœ¨<code>qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</code>æˆ‘ä»¬ä½¿ç”¨äº†<code>virt</code>è®¡ç®—æœºã€‚ å¹¸è¿çš„æ˜¯ï¼Œ <code>qemu</code>ä½¿å°†æœºå™¨ä¿¡æ¯è½»æ¾è½¬å‚¨åˆ°<code>dtb</code>è½¬å‚¨ï¼ˆè®¾å¤‡æ ‘blobï¼‰ä¸­ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Go to the ~/usys/riscv folder we created before and create a new dir # for our machine information. cd ~/usys/riscv &amp;&amp; mkdir machines cd machines # Use qemu to dump info about the 'virt' machine in dtb (device tree blob) # format. # The data in this file represents hardware components of a given # machine / device / board. qemu-system-riscv64 -machine virt -machine dumpdtb=riscv64-virt.dtb</span></span></code> </pre> <br>  Dtbæ•°æ®å¾ˆéš¾è¯»å–ï¼Œå› ä¸ºå®ƒåŸºæœ¬ä¸Šæ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª<code>dtc</code> ï¼ˆè®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼‰å‘½ä»¤è¡Œå®ç”¨ç¨‹åºå¯ä»¥å°†æ–‡ä»¶è½¬æ¢ä¸ºæ›´å…·å¯è¯»æ€§çš„æ–‡ä»¶ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I'm running MacOS, so I use Homebrew to install this. If you're # running another OS you may need to do something else. brew install dtc # Convert our .dtb into a human-readable .dts (device tree source) file. dtc -I dtb -O dts -o riscv64-virt.dts riscv64-virt.dtb</span></span></code> </pre> <br> è¾“å‡ºæ–‡ä»¶æ˜¯<code>riscv64-virt.dts</code> ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æˆ‘ä»¬çœ‹åˆ°äº†è®¸å¤šå…³äº<code>virt</code>çš„æœ‰è¶£ä¿¡æ¯ï¼šå¯ç”¨çš„å¤„ç†å™¨å†…æ ¸æ•°é‡ï¼Œå„ç§å¤–å›´è®¾å¤‡ï¼ˆä¾‹å¦‚UARTï¼‰çš„å†…å­˜ä½ç½®ï¼Œå†…éƒ¨å†…å­˜ï¼ˆRAMï¼‰çš„ä½ç½®ã€‚ å †æ ˆåº”è¯¥åœ¨æ­¤å†…å­˜ä¸­ï¼Œå› æ­¤è¯·ä½¿ç”¨<code>grep</code>æŸ¥æ‰¾ï¼š <br><br><pre> <code class="bash hljs">grep memory riscv64-virt.dts -A 3 memory@80000000 { device_type = <span class="hljs-string"><span class="hljs-string">"memory"</span></span>; reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;; };</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œæ­¤èŠ‚ç‚¹çš„â€œå†…å­˜â€æŒ‡å®šä¸º<code>device_type</code> ã€‚ æ˜¾ç„¶ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æƒ³è¦çš„ä¸œè¥¿ã€‚ é€šè¿‡<code>reg = &lt;...&gt; ;</code>çš„å€¼<code>reg = &lt;...&gt; ;</code> æ‚¨å¯ä»¥ç¡®å®šå­˜å‚¨åº“çš„èµ·å§‹ä½ç½®åŠå…¶é•¿åº¦ã€‚ <br><br> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">devicetreeè§„èŒƒä¸­ï¼Œæˆ‘ä»¬</a>çœ‹åˆ°<code>reg</code>è¯­æ³•æ˜¯ä»»æ„æ•°é‡çš„å¯¹<code>(base_address, length)</code> ã€‚ ä½†æ˜¯ï¼Œ <code>reg</code>å†…éƒ¨æœ‰å››ä¸ªå«ä¹‰ã€‚ å¥‡æ€ªï¼Œä¸¤ä¸ªå€¼ä¸è¶³ä»¥å®¹çº³ä¸€ä¸ªå­˜å‚¨åº“å—ï¼Ÿ <br><br> å†æ¬¡ï¼Œä»devicetreeè§„èŒƒï¼ˆæœç´¢<code>reg</code>å±æ€§ï¼‰ä¸­æˆ‘ä»¬å‘ç°ï¼Œç”¨äºæŒ‡å®šåœ°å€å’Œé•¿åº¦çš„<code>&lt;u32&gt;</code>å•å…ƒæ•°ç”±çˆ¶èŠ‚ç‚¹ï¼ˆæˆ–èŠ‚ç‚¹æœ¬èº«ï¼‰ä¸­çš„<code>#address-cells</code>å’Œ<code>#size-cells</code>å±æ€§ç¡®å®šã€‚ è¿™äº›å€¼æœªåœ¨æˆ‘ä»¬çš„å†…å­˜èŠ‚ç‚¹ä¸­æŒ‡å®šï¼Œå¹¶ä¸”çˆ¶å†…å­˜èŠ‚ç‚¹åªæ˜¯æ–‡ä»¶çš„æ ¹ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™äº›å€¼ï¼š <br><br><pre> <code class="plaintext hljs">head -n8 riscv64-virt.dts /dts-v1/; / { #address-cells = &lt;0x02&gt;; #size-cells = &lt;0x02&gt;; compatible = "riscv-virtio"; model = "riscv-virtio,qemu";</code> </pre> <br> äº‹å®è¯æ˜ï¼Œåœ°å€å’Œé•¿åº¦éƒ½éœ€è¦ä¸¤ä¸ª32ä½å€¼ã€‚ è¿™æ„å‘³ç€<code>reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;</code> æˆ‘ä»¬çš„å†…å­˜å¼€å§‹<code> 0x00 + 0x80000000 (0x80000000)</code>å¹¶å ç”¨<code>0x00 + 0x8000000 (0x8000000)</code>å­—èŠ‚ï¼Œå³ï¼Œå®ƒä»¥<code>0x88000000</code>ç»“æŸï¼Œå¯¹åº”äº128å…†å­—èŠ‚ã€‚ <br><br><a name="7"></a><h1> å¸ƒå±€å›¾ </h1><br> ä½¿ç”¨<code>qemu</code>å’Œ<code>dtc</code>æˆ‘ä»¬åœ¨virtè™šæ‹Ÿæœºä¸­æ‰¾åˆ°äº†RAMåœ°å€ã€‚ æˆ‘ä»¬è¿˜çŸ¥é“ï¼Œ <code>gcc</code>é»˜è®¤æƒ…å†µä¸‹ä¼šç»„æˆ<code>crt0</code> ï¼Œè€Œæ— éœ€æ ¹æ®éœ€è¦é…ç½®å †æ ˆã€‚ ä½†æ˜¯å¦‚ä½•ä½¿ç”¨è¿™äº›ä¿¡æ¯æœ€ç»ˆè¿è¡Œå’Œè°ƒè¯•ç¨‹åºï¼Ÿ <br><br> ç”±äº<code>crt0</code>ä¸é€‚åˆæˆ‘ä»¬ï¼Œå› æ­¤æœ‰ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„é€‰æ‹©ï¼šç¼–å†™æ‚¨è‡ªå·±çš„ä»£ç ï¼Œç„¶åå°†å…¶ä¸åœ¨ç¼–è¯‘ç®€å•ç¨‹åºåè·å¾—çš„ç›®æ ‡æ–‡ä»¶ä¸€èµ·ç¼–å†™ã€‚ æˆ‘ä»¬çš„<code>crt0</code>éœ€è¦çŸ¥é“æ ˆé¡¶ä»å“ªé‡Œå¼€å§‹ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚ æˆ‘ä»¬å¯ä»¥<code>crt0</code>å€¼<code>0x80000000</code>ç›´æ¥<code>crt0</code>ä¸º<code>crt0</code> ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å°†æ¥å¯èƒ½éœ€è¦çš„æ›´æ”¹ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸åˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚ å¦‚æœæˆ‘ä»¬æƒ³åœ¨ä»¿çœŸå™¨ä¸­ä½¿ç”¨å¦ä¸€ä¸ªå…·æœ‰ä¸åŒç‰¹å¾çš„CPUï¼Œå¦‚<code>sifive_e</code> ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ <br><br> å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸æ˜¯ç¬¬ä¸€ä¸ªæå‡ºè¿™ä¸ªé—®é¢˜çš„äººï¼Œè€Œä¸”å·²ç»å­˜åœ¨ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆã€‚  GNU <code>ld</code>é“¾æ¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å™¨ä½¿æ‚¨å¯ä»¥å®šä¹‰</a> <code>crt0</code>å¯ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„å­—ç¬¦</a> ã€‚ æˆ‘ä»¬å¯ä»¥å®šä¹‰é€‚ç”¨äºä¸åŒå¤„ç†å™¨çš„<code>__stack_top</code>ç¬¦å·ã€‚ <br><br> ä¸å…¶ä»å¤´å¼€å§‹ç¼–å†™è‡ªå·±çš„é“¾æ¥å™¨æ–‡ä»¶ï¼Œä¸å¦‚å°†é»˜è®¤è„šæœ¬ä¸<code>ld</code>å¹¶å¯¹å…¶è¿›è¡Œä¸€äº›ä¿®æ”¹ä»¥æ”¯æŒå…¶ä»–å­—ç¬¦ã€‚ ä»€ä¹ˆæ˜¯é“¾æ¥æè¿°æ–‡ä»¶ï¼Ÿ  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://www.scoberlin.de/content/media/">è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æè¿°</a> ï¼š <br><br><blockquote>  <i>é“¾æ¥æè¿°æ–‡ä»¶çš„ä¸»è¦ç›®çš„æ˜¯æè¿°å¦‚ä½•åœ¨è¾“å…¥å’Œè¾“å‡ºä¸­åŒ¹é…æ–‡ä»¶èŠ‚ï¼Œå¹¶æ§åˆ¶è¾“å‡ºæ–‡ä»¶çš„å†…å­˜å¸ƒå±€ã€‚</i> </blockquote><br> çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬å°†é»˜è®¤çš„é“¾æ¥<code>riscv64-unknown-elf-ld</code>æ–‡ä»¶<code>riscv64-unknown-elf-ld</code>å¤åˆ¶åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv <span class="hljs-comment"><span class="hljs-comment"># Make a new dir for custom linker scripts out RISC-V CPUs may require. mkdir ld &amp;&amp; cd ld # Copy the default linker script into riscv64-virt.ld riscv64-unknown-elf-ld --verbose &gt; riscv64-virt.ld</span></span></code> </pre> <br> è¯¥æ–‡ä»¶åŒ…å«<i>è®¸å¤š</i>æœ‰è¶£çš„ä¿¡æ¯ï¼Œè¿œè¿œè¶…å‡ºäº†æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„èŒƒå›´ã€‚ ä½¿ç”¨<code>--Verbose</code>è¯¦ç»†è¾“å‡ºåŒ…æ‹¬æœ‰å…³<code>ld</code>ç‰ˆæœ¬ï¼Œæ”¯æŒçš„ä½“ç³»ç»“æ„ç­‰çš„ä¿¡æ¯ã€‚ çŸ¥é“è¿™ä¸€åˆ‡éƒ½æ˜¯å¾ˆå¥½çš„ï¼Œä½†æ˜¯åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­è¿™ç§è¯­æ³•æ˜¯ä¸å¯æ¥å—çš„ï¼Œå› æ­¤è¯·æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨å¹¶ä»æ–‡ä»¶ä¸­åˆ é™¤æ‰€æœ‰å¤šä½™çš„å†…å®¹ã€‚ <br><br><pre> ç—…æ¯’riscv64-virt.ld<font></font>
<font></font>
 ï¼ƒåˆ é™¤ä¸Šé¢çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬=============
 GNU ldï¼ˆGNU Binutilsï¼‰2.32
  æ”¯æŒçš„ä»¿çœŸï¼š
    elf64lriscv
    elf32lriscv
ä½¿ç”¨å†…éƒ¨é“¾æ¥å™¨è„šæœ¬ï¼š
 ====================================================
 / * -z combrelocçš„è„šæœ¬ï¼šç»„åˆå’Œæ’åºé‡å®šä½èŠ‚* /
 / *ç‰ˆæƒæ‰€æœ‰ï¼ˆCï¼‰2014-2019è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šï¼ŒInc.
   å¤åˆ¶å’Œåˆ†å‘æ­¤è„šæœ¬ï¼ˆä¿®æ”¹æˆ–ä¸ä¿®æ”¹ï¼‰ï¼Œ
   å…è®¸åœ¨æ²¡æœ‰ç‰ˆæƒçš„æƒ…å†µä¸‹ä»¥ä»»ä½•åª’ä½“æä¾›ç‰ˆæƒ
   é€šçŸ¥ï¼Œæ­¤é€šçŸ¥è¢«ä¿ç•™ã€‚  * /
 OUTPUT_FORMATï¼ˆâ€œ elf64-littleriscvâ€ï¼Œâ€œ elf64-littleriscvâ€ï¼Œ
	       â€œ elf64-littleriscvâ€ï¼‰
 ...å…¶ä½™çš„é“¾æ¥æè¿°æ–‡ä»¶... </pre><br> ä¹‹åï¼Œè¿è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MEMORY</a>å‘½ä»¤æ‰‹åŠ¨ç¡®å®š<code>__stack_top</code>ä½ç½®ã€‚ æ‰¾åˆ°ä»¥<code>OUTPUT_ARCH(riscv)</code>å¼€å¤´çš„è¡Œï¼Œè¯¥è¡Œåº”ä½äºæ–‡ä»¶çš„é¡¶éƒ¨ï¼Œå¹¶åœ¨å…¶ä¸‹æ–¹æ·»åŠ <code>MEMORY</code>å‘½ä»¤ï¼š <br><br><pre> <code class="plaintext hljs">OUTPUT_ARCH(riscv) /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ MEMORY { /* qemu-system-risc64 virt machine */ RAM (rwx) : ORIGIN = 0x80000000, LENGTH = 128M } /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ ENTRY(_start)</code> </pre> <br> æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç§°ä¸º<code>RAM</code>çš„å­˜å‚¨å—ï¼Œå…è®¸å¯¹å…¶è¿›è¡Œè¯»ï¼ˆ <code>r</code> ï¼‰ï¼Œå†™ï¼ˆ <code>w</code> ï¼‰å’Œå­˜å‚¨å¯æ‰§è¡Œä»£ç ï¼ˆ <code>x</code> ï¼‰ã€‚ <br><br> å¤ªå¥½äº†ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¸€ä¸ªåŒ¹é…<code>virt</code> RISC-Væœºå™¨è§„æ ¼çš„å†…å­˜å¸ƒå±€ã€‚ ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚ æˆ‘ä»¬æƒ³å°†å †æ ˆæ”¾å…¥å†…å­˜ã€‚ <br><br> æ‚¨éœ€è¦å®šä¹‰<code>__stack_top</code>å­—ç¬¦ã€‚ åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­æ‰“å¼€é“¾æ¥æè¿°æ–‡ä»¶ï¼ˆ <code>riscv64-virt.ld</code> ï¼‰å¹¶æ·»åŠ å‡ è¡Œï¼š <br><br><pre> <code class="plaintext hljs">SECTIONS { /* Read-only sections, merged into text segment: */ PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x10000)); . = SEGMENT_START("text-segment", 0x10000) + SIZEOF_HEADERS; /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ PROVIDE(__stack_top = ORIGIN(RAM) + LENGTH(RAM)); /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ .interp : { *(.interp) } .note.gnu.build-id : { *(.note.gnu.build-id) }</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>__stack_top</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‘½ä»¤</a>å®šä¹‰<code>__stack_top</code> ã€‚ å¯ä»¥ä»ä¸æ­¤è„šæœ¬å…³è”çš„ä»»ä½•ç¨‹åºä¸­è®¿é—®è¯¥ç¬¦å·ï¼ˆå‡è®¾è¯¥ç¨‹åºæœ¬èº«ä¸ä¼šç¡®å®šåç§°ä¸º<code>__stack_top</code>ä¸œè¥¿ï¼‰ã€‚ å°†<code>__stack_top</code>è®¾ç½®ä¸º<code>ORIGIN(RAM)</code> ã€‚ æˆ‘ä»¬çŸ¥é“æ­¤å€¼ä¸º<code>0x80000000</code>åŠ ä¸Š<code>LENGTH(RAM)</code> ï¼Œå³128å…†å­—èŠ‚ï¼ˆ <code>0x8000000</code>å­—èŠ‚ï¼‰ã€‚ è¿™æ„å‘³ç€æˆ‘ä»¬çš„<code>__stack_top</code>è®¾ç½®ä¸º<code>0x88000000</code> ã€‚ <br><br> ä¸ºç®€ä¾¿èµ·è§ï¼Œæˆ‘ä¸ä¼šåœ¨<a href="">æ­¤å¤„</a>åˆ—å‡ºæ•´ä¸ªé“¾æ¥å™¨æ–‡ä»¶ï¼›æ‚¨å¯ä»¥<a href="">åœ¨æ­¤å¤„æŸ¥çœ‹</a> ã€‚ <br><br><a name="8"></a><h1> åˆ«è¯´äº†  <s>é”¤å‡»æ—¶é—´ï¼</s> è¿è¡Œæ—¶ï¼ </h1><br> ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰åˆ›å»ºè‡ªå·±çš„Cè¿è¡Œæ—¶æ‰€éœ€çš„ä¸€åˆ‡ï¼Œå®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“ç®€å•çš„ä»»åŠ¡ï¼Œè¿™æ˜¯æ•´ä¸ª<code>crt0.s</code>æ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">.section .init, "ax" .global _start _start: .cfi_startproc .cfi_undefined ra .option push .option norelax la gp, __global_pointer$ .option pop la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br> ç«‹å³å¸å¼•äº†å¤§é‡ä»¥å¥ç‚¹å¼€å¤´çš„è¡Œã€‚ è¿™æ˜¯ç”¨äºæ±‡ç¼–ç¨‹åºçš„æ–‡ä»¶ã€‚ å¸¦ç‚¹çš„çº¿ç§°ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ±‡ç¼–ç¨‹åºä¼ªæŒ‡ä»¤</a> ï¼šå®ƒä»¬ä¸ºæ±‡ç¼–ç¨‹åºæä¾›ä¿¡æ¯ã€‚ è¿™ä¸æ˜¯å¯æ‰§è¡Œä»£ç ï¼Œä¾‹å¦‚RISC-Væ±‡ç¼–ç¨‹åºæŒ‡ä»¤ï¼ˆä¾‹å¦‚<code>jal</code>å’Œ<code>add</code> ã€‚ <br><br> è®©æˆ‘ä»¬é€è¡Œæµè§ˆæ–‡ä»¶ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨å„ç§æ ‡å‡†RISC-Vå¯„å­˜å™¨ï¼Œå› æ­¤è¯·æŸ¥çœ‹<a href="">æ­¤è¡¨</a> ï¼Œ <a href="">è¯¥è¡¨</a>æ¶µç›–äº†æ‰€æœ‰å¯„å­˜å™¨åŠå…¶ç”¨é€”ã€‚ <br><br><pre> <code class="plaintext hljs">.section .init, "ax"</code> </pre> <br> å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GNUæ±‡ç¼–ç¨‹åºâ€œ asâ€æ‰‹å†Œä¸­æ‰€è¿°</a> ï¼Œæ­¤è¡Œå‘Šè¯‰æ±‡ç¼–ç¨‹åºå°†ä»¥ä¸‹ä»£ç æ’å…¥<code>.init</code>èŠ‚ï¼Œè¯¥èŠ‚å·²åˆ†é…ï¼ˆ <code>a</code> ï¼‰å’Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ <code>x</code> ï¼‰ã€‚ æœ¬èŠ‚æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­è¿è¡Œä»£ç çš„å¦ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¸¸è§çº¦å®š</a> ã€‚ æˆ‘ä»¬åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„çº¯ç¡¬ä»¶ä¸Šå·¥ä½œï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„è¯´æ˜å¯èƒ½ä¸æ˜¯ç»å¯¹å¿…è¦çš„ï¼Œä½†æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚ <br><br><pre> <code class="plaintext hljs">.global _start _start:</code> </pre> <br>  <code>.global</code>ä½¿<code>ld</code>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å­—ç¬¦ã€‚ å¦åˆ™ï¼Œé“¾æ¥å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºé“¾æ¥æè¿°æ–‡ä»¶ä¸­çš„<code>ENTRY(_start)</code>æŒ‡å‘<code>_start</code>ç¬¦å·ï¼Œä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ã€‚ ä¸‹ä¸€è¡Œå‘Šè¯‰æ±‡ç¼–ç¨‹åºæˆ‘ä»¬æ­£åœ¨å¼€å§‹<code>_start</code>å­—ç¬¦çš„å®šä¹‰ã€‚ <br><br><pre> <code class="plaintext hljs">_start: .cfi_startproc .cfi_undefined ra ...other stuff... .cfi_endproc</code> </pre> <br> è¿™äº›<code>.cfi</code>æŒ‡ä»¤ä¼š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šçŸ¥æ‚¨</a>æœ‰å…³æ¡†æ¶çš„ç»“æ„ä»¥åŠå¦‚ä½•å¤„ç†å®ƒã€‚  <code>.cfi_startproc</code>å’Œ<code>.cfi_endproc</code>å‡½æ•°çš„å¼€å§‹å’Œç»“æŸï¼Œ <code>.cfi_undefined ra</code>å‘Šè¯‰æ±‡ç¼–ç¨‹åºï¼Œåœ¨<code>_start</code>ä¹‹å‰ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸å¾—å°†</a> <code>ra</code>å¯„å­˜å™¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¢å¤</a>ä¸ºåŒ…å«çš„ä»»ä½•å€¼ã€‚ <br><br><pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br> å½“æ‚¨éœ€è¦åº”ç”¨ä¸€ç»„ç‰¹å®šçš„é€‰é¡¹æ—¶ï¼Œè¿™äº›<code>.option</code>ä¼ªæŒ‡ä»¤æ ¹æ®ä»£ç æ›´æ”¹æ±‡ç¼–ç¨‹åºçš„è¡Œä¸ºã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™æ˜¯</a>ä¸ºä»€ä¹ˆåœ¨<code>.option</code>ä¸­ä½¿ç”¨<code>.option</code>å¾ˆé‡è¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„</a>è¯¦ç»†è¯´æ˜ï¼š <br><br><blockquote>  <i>...ç”±äºæˆ‘ä»¬å¯èƒ½ä¼šå°†åºåˆ—çš„å¯»å€æ”¾å®½åˆ°ç›¸å¯¹äºGPè¾ƒçŸ­çš„åºåˆ—ï¼Œå› æ­¤GPçš„åˆå§‹åŠ è½½ä¸åº”å—åˆ°å‰Šå¼±ï¼Œåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</i> <i><br><br></i> <pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br> è¿™æ ·ï¼Œåœ¨æ”¾æ¾ä¹‹åï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹ä»£ç ï¼š <br><br><pre> <code class="plaintext hljs">auipc gp, %pcrel_hi(__global_pointer$) addi gp, gp, %pcrel_lo(__global_pointer$)</code> </pre> <br> è€Œä¸æ˜¯ç®€å•çš„ï¼š <br><br><pre> <code class="plaintext hljs">addi gp, gp, 0</code> </pre> </blockquote><br> ç°åœ¨ï¼Œæˆ‘ä»¬çš„<code>crt0.s</code>çš„æœ€åä¸€éƒ¨åˆ†ï¼š <br><br><pre> <code class="plaintext hljs">_start: ...other stuff... la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥ä½¿ç”¨æˆ‘ä»¬åŠªåŠ›åˆ›å»ºçš„<code>__stack_top</code>ç¬¦å·ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¼ªæŒ‡ä»¤</a> <code>la</code> ï¼ˆåŠ è½½åœ°å€ï¼‰å°†<code>__stack_top</code>å€¼åŠ è½½åˆ°<code>sp</code>å¯„å­˜å™¨ï¼ˆå †æ ˆæŒ‡é’ˆï¼‰ä¸­ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºåœ¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä¸­ä½¿ç”¨ã€‚ <br><br> ç„¶å<code>add s0, sp, zero</code> ï¼Œå°†å¯„å­˜å™¨<code>sp</code>å’Œ<code>zero</code>çš„å€¼ç›¸åŠ ï¼ˆå®é™…ä¸Šæ˜¯ç¡¬å¼•ç”¨0çš„å¯„å­˜å™¨<code>x0</code> ï¼‰ï¼Œå¹¶å°†ç»“æœæ”¾å…¥å¯„å­˜å™¨<code>s0</code> ã€‚ è¿™æ˜¯ä¸€ä¸ª<a href="">ç‰¹æ®Šçš„å¯„å­˜å™¨</a> ï¼Œåœ¨å‡ ä¸ªæ–¹é¢éƒ½ä¸å¸¸è§ã€‚ é¦–å…ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œæ°¸ä¹…å¯„å­˜å™¨â€ï¼Œå³åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¿å­˜ã€‚ å…¶æ¬¡ï¼Œ <code>s0</code>æœ‰æ—¶å……å½“å¸§æŒ‡é’ˆï¼Œè¿™ç»™æ¯ä¸ªå‡½æ•°è°ƒç”¨ä¸€ä¸ªå°çš„ç©ºé—´ï¼Œç”¨äºåœ¨å †æ ˆä¸­å­˜å‚¨ä¼ é€’ç»™è¯¥å‡½æ•°çš„å‚æ•°ã€‚ å‡½æ•°è°ƒç”¨å¦‚ä½•ä¸å †æ ˆæŒ‡é’ˆå’Œæ¡†æ¶æŒ‡é’ˆä¸€èµ·å·¥ä½œæ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ä¸»é¢˜ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ä¸“é—¨å†™ä¸€ç¯‡å•ç‹¬çš„æ–‡ç« ï¼Œä½†æ˜¯å°±ç›®å‰è€Œè¨€ï¼Œä»…çŸ¥é“åœ¨æˆ‘ä»¬çš„è¿è¡Œæ—¶ä¸­ï¼Œåˆå§‹åŒ–æ¡†æ¶æŒ‡é’ˆ<code>s0</code>å¾ˆé‡è¦ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>jal zero, main</code>å£°æ˜ã€‚ åœ¨è¿™é‡Œï¼Œ <code>jal</code>è¡¨ç¤ºè·³è½¬å’Œé“¾æ¥ã€‚ è¯¥æŒ‡ä»¤æœŸæœ›æ“ä½œæ•°çš„å½¢å¼ä¸º<code>jal rd (destination register), offset_address</code> ã€‚ åœ¨åŠŸèƒ½ä¸Šï¼Œ <code>jal</code>å°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å€¼ï¼ˆ <code>pc</code>å¯„å­˜å™¨åŠ 4ï¼‰å†™å…¥<code>rd</code> ï¼Œç„¶åå°†<code>pc</code>å¯„å­˜å™¨è®¾ç½®ä¸ºå½“å‰<code>pc</code>å€¼åŠ ä¸Šå¸¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¦å·æ‰©å±•åçš„</a>åç§»åœ°å€ï¼Œä»è€Œæœ‰æ•ˆåœ°â€œè°ƒç”¨â€è¯¥åœ°å€ã€‚ <br><br> å¦‚ä¸Šæ‰€è¿°ï¼Œ <code>x0</code>ä¸å­—é¢å€¼0ç´§å¯†ç»‘å®šï¼Œå¯¹å…¶è¿›è¡Œå†™å…¥æ˜¯æ²¡æœ‰ç”¨çš„ã€‚    ,         <code>zero</code> ,   RISC-V    <code>x0</code> .       <code>offset_address</code> .   ,         ? <br><br>    <code>jal zero, offset_address</code>      .       , ,  .    ISA,  .  ,       <code>jal</code>  <code>unconditional jump</code> ,  RISC-V   <code>jal</code> ,      <code>jal zero, main</code> . <br><br>  RISC-V    ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> .  ,       . ,    <code>j offset_address</code>  RISC-V   <code>jal zero, offset_address</code> .      .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> RISC-V ( 2.2)</a> . <br><br><pre> <code class="plaintext hljs">_start: ...other stuff... jal zero, main .cfi_endproc .end</code> </pre> <br>    â€”    <code>.end</code> ,     . <br><br><a name="9"></a><h1> ,   - </h1><br>     C   RISC-V,    .    <code>qemu</code>  <code>dtc</code>       <code>virt</code> RISC-V.                <code>riscv64-unknown-elf-ld</code> ,      <code>__stack_top</code> .        <code>crt0.s</code> ,        , ,   <code>main</code> .             GDB. <br><br> ,     C: <br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>   : <br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc -g -ffreestanding -O0 -Wl,--gc-sections -nostartfiles -nostdlib -nodefaultlibs -Wl,-T,riscv64-virt.ld crt0.s add.c</code> </pre> <br>      ,    ,     ,    . <br><br> <code>-ffreestanding</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> ,      </a> ,         .           (  ),       ,      . <br><br> <code>-Wl</code> â€”        ( <code>ld</code> ).  <code>--gc-sections</code>  Â«  Â»,  <code>ld</code>       .  <code>-nostartfiles</code> , <code>-nostdlib</code>  <code>-nodefaultlibs</code>         (,  <code>crt0</code> ),    stdlib      .     <code>crt0</code>  ,     ,          . <br><br> <code>-T</code>      ,      <code>riscv64-virt.ld</code> . ,   ,   ,   : <code>crt0.s</code>  <code>add.c</code> .   ,            <code>a.out</code> . <br><br>         <code>qemu</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -S freezes execution of our executable (-kernel) until we explicitly tell # it to start with a 'continue' or 'c' from our gdb client qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -S -kernel a.out</span></span></code> </pre> <br>   <code>gdb</code> ,       <code>a.out</code> ,    : <br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gdb --tui a.out GNU gdb (GDB) 8.2.90.20190228-git Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type <span class="hljs-string"><span class="hljs-string">"show copying"</span></span> and <span class="hljs-string"><span class="hljs-string">"show warranty"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This GDB was configured as <span class="hljs-string"><span class="hljs-string">"--host=x86_64-apple-darwin17.7.0 --target=riscv64-unknown-elf"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"show configuration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> configuration details. For bug reporting instructions, please see: &lt;http://www.gnu.org/software/gdb/bugs/&gt;. Find the GDB manual and other documentation resources online at: &lt;http://www.gnu.org/software/gdb/documentation/&gt;. For <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">"help"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"apropos word"</span></span> to search <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> commands related to <span class="hljs-string"><span class="hljs-string">"word"</span></span>... Reading symbols from a.out... (gdb)</code> </pre> <br>     <code>gdb</code>   <code>gdb</code> ,       <code>qemu</code> : <br><br><pre> <code class="bash hljs">(gdb) target remote :1234 â”‚ Remote debugging using :1234</code> </pre> <br>     main: <br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x8000001e: file add.c, line 2.</code> </pre> <br>    : <br><br><pre> <code class="bash hljs">(gdb) c Continuing. Breakpoint 1, main () at add.c:2</code> </pre> <br>    ,          2!      , -     <code>L</code> ,  <code>PC:</code>  <code>L2</code> ,  <code>PC:</code> â€” <code>0x8000001e</code> .       ,     : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd8/aa9/78d/bd8aa978df4289f584b5c422cdb6e44c.png"><br><br>      <code>gdb</code>  : <code>-s</code>     , <code>info all-registers</code>           . .    â€¦ , ,    ! <br><br><a name="10"></a><h1> æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ </h1><br>     , ,  !            ,    ,       .   ,   .        <code>jal</code> ,          ,  ,   <code>add.c</code> -     RISC-V.     - ,       - , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> . <br><br>   ! ,    ! <br><br><a name="11"></a><h1> é€‰é… </h1><br>         ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Â«  :     main()Â»</a>   CppCon2018.      ,   .   ,  ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN454208/">https://habr.com/ru/post/zh-CN454208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN454190/index.html">æ‰‹æœºè¢«ç›—æ—¶ä¸éœ€è¦åšä»€ä¹ˆ</a></li>
<li><a href="../zh-CN454196/index.html">ä½¿ç”¨æ— äººæœºç¤ºä¾‹å¯¹ç”µå­äº§å“è¿›è¡Œ3Dæ‰“å°ï¼šä¸å†éœ€è¦ç”µçº¿å’Œæ¿</a></li>
<li><a href="../zh-CN454198/index.html">åœ¨IDEAä¸­åˆ›å»ºå¤šæ¨¡å—Gradle SpringBoot + Angularé¡¹ç›®</a></li>
<li><a href="../zh-CN454204/index.html">è¡Œä¸ºçˆ¬è¡Œä¸æ˜¯ä¸‡èƒ½è¯å—ï¼Ÿ</a></li>
<li><a href="../zh-CN454206/index.html">PHç¬¬9å¤©ï¼šAI CTFè§£æ</a></li>
<li><a href="../zh-CN454210/index.html">è¢«é—å¿˜çš„enchantjs +æ–°çš„1C-Bitrix =æ¿€åŠ±å®¢æˆ·çš„æ¸¸æˆ</a></li>
<li><a href="../zh-CN454214/index.html">æˆ‘è®¨åŒå‡ ä¹æ‰€æœ‰è½¯ä»¶</a></li>
<li><a href="../zh-CN454216/index.html">æ‰¾åˆ°çš„è¯æ®è¡¨æ˜æ‰€æœ‰å˜åŒ–éƒ½æ˜¯æœ‰åºå’Œå¶ç„¶çš„æ··åˆ</a></li>
<li><a href="../zh-CN454220/index.html">ä¸¤ä½æ•°æ¸©åº¦è®¡</a></li>
<li><a href="../zh-CN454222/index.html">ä½¿ç”¨PCIe 1.0-2.0æ€»çº¿å‡çº§æ—§æœåŠ¡å™¨çš„ç£ç›˜å­ç³»ç»Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>