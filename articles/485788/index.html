<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèùÔ∏è üç¢ ‚ùáÔ∏è C√≥mo hacer que cualquier proceso funcione con NTFS transaccional: mi primer paso para escribir un sandbox para Windows üöµüèª üëéüèø üë®üèª‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uno de los m√≥dulos en el kernel de Windows proporciona soporte para combinar un conjunto de operaciones de archivo en una entidad conocida como transa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hacer que cualquier proceso funcione con NTFS transaccional: mi primer paso para escribir un sandbox para Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485788/"><p><img src="https://habrastorage.org/webt/p0/-s/fi/p0-sfitxnzzpywfqxuc4arx1fps.png" align="right" alt="TransactionMaster">  Uno de los m√≥dulos en el kernel de Windows proporciona soporte para combinar un conjunto de operaciones de archivo en una entidad conocida como <strong>transacci√≥n</strong> .  Al igual que en las bases de datos, estas entidades son <em>aisladas</em> y <em>at√≥micas</em> .  Puede realizar algunos cambios en el sistema de archivos que no ser√°n visibles hasta que los <em>confirme</em> .  O, como alternativa, siempre puede <em>revertir</em> todo.  En cualquier caso, usted act√∫a sobre el grupo de operaciones en su conjunto.  Precisamente, ¬øqu√© se necesitaba para preservar la <em>coherencia</em> al instalar software o actualizar nuestros sistemas, ¬øverdad?  Si algo sale mal, el instalador o incluso todo el sistema falla, la transacci√≥n se revierte autom√°ticamente. </p><br><p>  Desde la primera vez que vi un art√≠culo sobre este incre√≠ble mecanismo, siempre me pregunt√© c√≥mo ser√≠a el mundo desde adentro.  ¬øY sabes que?  Acabo de descubrir un enfoque verdaderamente maravilloso para forzar a cualquier proceso a operar dentro de una transacci√≥n predefinida, <del>  que este margen es demasiado estrecho para contener </del>  .  Adem√°s, la mayor√≠a de las veces, ni siquiera requiere privilegios administrativos. </p><br><p>  Luego hablemos sobre los elementos internos de Windows, pruebe una nueva herramienta y responda una pregunta: ¬øqu√© tiene que ver con los sandboxes? </p><a name="habracut"></a><br><h2 id="repository">  Repositorio </h2><br><p>  Aquellos que quieran comenzar a experimentar de inmediato son bienvenidos en la p√°gina del proyecto en GitHub: <a href="https://github.com/diversenok/TransactionMaster">TransactionMaster</a> . </p><br><h2 id="theory">  Teor√≠a </h2><br><p>  La introducci√≥n de Transactional NTFS, tambi√©n conocido como <strong>TxF</strong> , en Windows Vista fue un paso revolucionario para mantener la consistencia del sistema y, por lo tanto, la estabilidad.  Al exponer esta funcionalidad directamente a los desarrolladores, Microsoft hizo posible simplificar dram√°ticamente el manejo de errores en todos los componentes responsables de instalar y actualizar el software.  La tarea de mantener un plan de respaldo para todas las posibles fallas del sistema de archivos se convirti√≥ en un trabajo del sistema operativo en s√≠, que comenz√≥ a proporcionar una <a href="https://en.wikipedia.org/wiki/ACID">sem√°ntica <abbr title="Atomicidad, Consistencia, Aislamiento, Durabilidad">ACID</abbr></a> con todas <a href="https://en.wikipedia.org/wiki/ACID"><abbr title="Atomicidad, Consistencia, Aislamiento, Durabilidad">las</abbr></a> funciones a pedido. </p><br><p> Para proporcionar este nuevo instrumento, Microsoft introdujo un conjunto de funciones API que duplicaban la funcionalidad existente, pero dentro de un contexto de transacciones.  La transacci√≥n en s√≠ se convirti√≥ en un nuevo objeto del n√∫cleo, junto con los existentes, como archivos, procesos y primitivas de sincronizaci√≥n.  En el escenario m√°s simple, la aplicaci√≥n crea una nueva transacci√≥n usando <a href="https://docs.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-createtransaction"><code>CreateTransaction</code></a> , realiza las operaciones requeridas ( <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createfiletransactedw"><code>CreateFileTransacted</code></a> , <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-movefiletransactedw"><code>MoveFileTransacted</code></a> , <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-deletefiletransactedw"><code>DeleteFileTransacted</code></a> , etc.), y luego la confirma o <a href="https://docs.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-committransaction"><code>CommitTransaction</code></a> con <a href="https://docs.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-committransaction"><code>CommitTransaction</code></a> / <a href="https://docs.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-rollbacktransaction"><code>RollbackTransaction</code></a> . </p><br><p>  Echemos un vistazo a la arquitectura de estas nuevas funciones.  Sabemos que la capa API oficial de bibliotecas como <code>kernel32.dll</code> no invoca el kernel directamente, sino que convierte los par√°metros y reenv√≠a la llamada a <code>ntdll.dll</code> .  Que luego, emite un syscall.  Sorprendentemente, <u>no hay signos de ninguna funci√≥n adicional <strong>-Transacted</strong> tanto en el lado <strong>ntdll</strong> como en el kernel de la llamada.</u> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/1f/pd/hh1fpdvbzuerpebayexmhpn1xui.png" alt="Capas API"></div><br><p>  Las definiciones de estas funciones de API nativas no han cambiado en d√©cadas, por lo que no hay ning√∫n par√°metro adicional para especificar una transacci√≥n.  ¬øC√≥mo sabe el n√∫cleo cu√°l usar entonces?  La respuesta es simple pero prometedora: cada subproceso tiene un campo designado, donde almacena un identificador para la transacci√≥n actual.  Esta variable reside en una regi√≥n espec√≠fica de la memoria llamada TEB - Thread Environmental Block.  En cuanto a otros campos conocidos ubicados aqu√≠ tambi√©n, puedo nombrar el <a href="https://docs.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror">√∫ltimo c√≥digo de error</a> y la <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid">ID del hilo</a> . </p><br><p>  Por lo tanto, todas las funciones con el sufijo <em>-Transacted</em> establecen el campo de transacci√≥n actual en TEB, llaman a la API no transaccionada correspondiente y restauran el valor anterior.  Para lograr este objetivo, utilizan un par de rutinas bastante sencillas llamadas <a href=""><code>RtlGetCurrentTransaction</code></a> / <a href=""><code>RtlSetCurrentTransaction</code></a> de <code>ntdll</code> .  Proporcionan un nivel suficiente de abstracci√≥n, que resulta √∫til en el caso de <abbr title="Windows en Windows de 64 bits">WoW64</abbr> , m√°s sobre eso m√°s adelante. </p><br><p>  ¬øQu√© significa para nosotros?  <strong>Al cambiar una variable en la memoria, podemos controlar, en un contexto de qu√© transacci√≥n el proceso accede al sistema de archivos.</strong>  No es necesario instalar ning√∫n gancho o devoluci√≥n de llamada en modo kernel, todo lo que necesitamos es entregar el identificador al proceso de destino y modificar un par de bytes de memoria por cada subproceso.  Suena sorprendentemente f√°cil, ¬°pero el resultado debe ser sorprendente! </p><br><h2 id="pitfalls">  Trampas </h2><br><p>  El primer concepto de trabajo revel√≥ muchos detalles peculiares.  Para mi gran deleite, <a href="https://farmanager.com/index.php%3Fl%3Den">Far Manager</a> , que uso como reemplazo para el Explorador de Windows, est√° perfectamente bien con el cambio activo de transacciones.  Pero tambi√©n vi un par de programas, en los cuales mi m√©todo no ten√≠a efecto esperado ya que crean nuevos hilos para las operaciones de archivos.  Un ejemplo del representante de segunda clase es <a href="https://github.com/microsoft/winfile">WinFile</a> .  Solo como recordatorio, la transacci√≥n actual es una funci√≥n por subproceso.  Inicialmente, fue un agujero en la trama, ya que el seguimiento de la creaci√≥n de subprocesos fuera de proceso es bastante dif√≠cil, teniendo en cuenta la sensibilidad temporal de esta operaci√≥n. </p><br><h3 id="thread-tracking-dll">  Dll de seguimiento de hilos </h3><br><p>  Afortunadamente, recibir notificaciones sincr√≥nicas sobre la creaci√≥n de subprocesos es extremadamente simple dentro del contexto del proceso de destino.  Todo lo que necesitamos es crear una DLL, que propague la transacci√≥n actual a nuevos subprocesos, el cargador de <code>ntdll</code> de <code>ntdll</code> se encargar√° del resto.  Cada vez que llega un nuevo hilo al proceso, activar√° nuestro punto de entrada con el par√°metro <a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain"><code>DLL_THREAD_ATTACH</code></a> .  Al implementar esta funcionalidad, arregl√© la compatibilidad con un mont√≥n de programas diferentes. </p><br><p>  <strong>*</strong> Estrictamente hablando, esta devoluci√≥n de llamada no ocurre en todas las condiciones posibles.  De vez en cuando, ver√° uno o dos hilos auxiliares dando vueltas sin una transacci√≥n.  La mayor√≠a de las veces, estos son los subprocesos del grupo de trabajo del cargador de m√≥dulos en s√≠.  La raz√≥n es que las notificaciones de DLL ocurren bajo el <em>bloqueo</em> del <em>cargador</em> , lo que implica una variedad de limitaciones, incluida la capacidad de cargar m√°s m√≥dulos.  Y eso es, de hecho, lo que esos hilos necesitan lograr, mientras que paralelizan el acceso a los archivos mientras tanto.  Por lo tanto, existe una excepci√≥n para evitar puntos muertos: si la persona que llama especifica el indicador <a href=""><code>THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH</code></a> mientras crea un hilo con la ayuda de <a href=""><code>NtCreateThreadEx</code></a> , las devoluciones de llamada de notificaci√≥n DLL no se activan. </p><br><h3 id="starting-windows-explorer">  Iniciando el Explorador de Windows </h3><br><p>  Desafortunadamente, todav√≠a quedan algunos programas que no pueden manejar bien las transacciones de cambio en caliente, y Windows Explorer es uno de ellos.  No puedo diagnosticar el problema de manera confiable.  Es una aplicaci√≥n compleja que generalmente tiene muchos identificadores abiertos, y si el contexto de una transacci√≥n invalida algunos de ellos, podr√≠a provocar un bloqueo.  De todos modos, la soluci√≥n universal a tales problemas es asegurarse de que el proceso se ejecute dentro de un contexto consistente desde la primera instrucci√≥n que ejecuta. </p><br><p>  Por lo tanto, implement√© una opci√≥n para realizar la inyecci√≥n de DLL de inmediato al crear un nuevo proceso.  Y result√≥ ser suficiente para arreglar el bloqueo.  Sin embargo, dado que Explorer utiliza de manera intensiva COM fuera de proceso, la vista previa y algunas otras caracter√≠sticas a√∫n no funcionan en archivos modificados. </p><br><h3 id="what-about-wow64">  ¬øQu√© pasa con WoW64? </h3><br><p>  Los beneficios de compatibilidad que proporciona el subsistema <em>Windows-on-Windows de 64 bits</em> son sinceramente notables.  Sin embargo, tener en cuenta sus detalles a menudo se vuelve tedioso durante la programaci√≥n del sistema.  Anteriormente mencion√© que el comportamiento de <code>Rtl[Get/Set]CurrentTransaction</code> vuelve un poco m√°s complejo en este caso.  Dado que dichos procesos funcionan con un tama√±o distintivo de punteros que el resto del sistema, cada hilo WoW64 mantiene dos TEB asociados con √©l: el sistema operativo en s√≠ mismo espera que tenga uno de 64 bits, y la aplicaci√≥n requiere uno de 32 bits como bien para funcionar correctamente.  Y aunque, desde la perspectiva del kernel, el TEB nativo tiene prioridad, hay un c√≥digo adicional en estas funciones para garantizar que los valores correspondientes siempre coincidan.  De todos modos, es esencial tener en cuenta todas estas peculiaridades <a href="">al implementar una nueva funcionalidad</a> . </p><br><h3 id="unsolved-problems">  Problemas sin resolver </h3><br><p>  Por triste que sea, el primer escenario de uso que se nos viene a la mente: instalar aplicaciones en este modo, no funciona bien por ahora.  En primer lugar, los instaladores suelen crear procesos complementarios, y todav√≠a no he implementado la captura de procesos secundarios en la misma transacci√≥n.  Veo varias formas de hacerlo, pero podr√≠a llevar un tiempo.  Otro problema importante surge cuando intentamos ejecutar archivos binarios que se desempaquetan durante la instalaci√≥n y, por lo tanto, no existen en ning√∫n otro lugar.  Teniendo en cuenta que <a href=""><code>NtCreateUserProcess</code></a> y, por lo tanto, <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw"><code>CreateProcess</code></a> , ignoran la transacci√≥n actual por alguna raz√≥n, la soluci√≥n de este problema probablemente requerir√° algo de creatividad, combinada con un mont√≥n de trucos sofisticados.  Por supuesto, siempre podemos confiar en <a href=""><code>NtCreateProcessEx</code></a> como √∫ltimo recurso, pero arreglar la compatibilidad puede convertirse en una pesadilla en este caso. </p><br><p>  Por cierto, me recuerda una historia que le√≠ sobre un malware que logr√≥ enga√±ar a un par de ingenuos antivirus aplicando un enfoque similar.  Sol√≠a ‚Äã‚Äãsoltar una carga √∫til en una transacci√≥n, iniciarla y revertir los cambios para cubrir las pistas, permitiendo que el proceso se ejecute sin una imagen en el disco.  Incluso si la l√≥gica de "sin archivo - sin amenaza" suena tonta, podr√≠a no haber sido el caso para algunos AV, al menos hace unos a√±os. </p><br><h2 id="whats-with-sandboxing">  ¬øQu√© pasa con el sandboxing? </h2><br><p>  Echa un vistazo a esta captura de pantalla a continuaci√≥n.  Puede ver tres programas completamente en desacuerdo sobre el contenido de la misma carpeta.  Todos trabajan dentro de tres transacciones diferentes.  Ese es el poder del aislamiento en la sem√°ntica de ACID. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9f/ml/ds/9fmldsooc30vlqq7plchzoxystc.png" alt="Aislamiento de transacciones"></div><br><p>  Mi programa no es un sandbox en absoluto;  carece de una pieza crucial: un <strong>l√≠mite de seguridad</strong> .  S√© que algunas compa√±√≠as todav√≠a logran vender productos similares, present√°ndolos como verdaderos sandboxes, qu√© verg√ºenza, qu√© puedo decir.  Y podr√≠a pensar: ¬øc√≥mo puede convertirlo en un sandbox? Incluso si es un depurador, no puede evitar de manera confiable que un proceso modifique una variable que controla la transacci√≥n, despu√©s de todo, reside en su memoria.  Es bastante justo, por eso tengo que tener otro truco maravilloso en mi manga, que eventualmente me ayudar√° a terminar este proyecto y que no revelar√© por ahora.  S√≠, estoy planeando crear una caja de arena completamente en modo de usuario con virtualizaci√≥n del sistema de archivos.  Mientras tanto, usa <a href="https://sandboxie.com/">Sandboxie</a> y sigue experimentando con <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/appcontainer-isolation">AppContainers</a> .  Est√©n atentos. </p><br><p>  Repositorio del proyecto en GitHub: <strong><a href="https://github.com/diversenok/TransactionMaster">TransactionMaster</a></strong> . </p></div></div><p>Source: <a href="https://habr.com/ru/post/485788/">https://habr.com/ru/post/485788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485772/index.html">Del escritorio al centro de datos virtual: c√≥mo pasamos a la virtualizaci√≥n</a></li>
<li><a href="../485776/index.html">En toda la geograf√≠a: tareas de navegaci√≥n y geod√©sicas en diferentes idiomas.</a></li>
<li><a href="../485780/index.html">Robots, resonadores de cuarzo, microcontroladores ... ¬øqu√© hace Epson?</a></li>
<li><a href="../485784/index.html">Hacer que cualquier proceso funcione con NTFS transaccional: mi primer paso para crear un entorno limitado para Windows</a></li>
<li><a href="../485786/index.html">Tarea de aritm√©tica</a></li>
<li><a href="../485790/index.html">Entrevistas: expectativas vs realidad</a></li>
<li><a href="../485792/index.html">Ivan Lilekvist y Kim Dotkom, una gran entrevista: la historia de Megaupload, extradici√≥n a los Estados Unidos, libertad, bitcoin. Parte 2</a></li>
<li><a href="../485794/index.html">¬øEst√°s desarrollando en .NET Core? Vamos a Ubuntu, he preparado todo</a></li>
<li><a href="../485796/index.html">Resuelve lo insoluble</a></li>
<li><a href="../485800/index.html">Digitalizaci√≥n vs. Automatizaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>