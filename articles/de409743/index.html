<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üóÑÔ∏è ü§≥ DIY-Controller des LED-Panels auf CPLD mit BAM-Modulation ‚ù£Ô∏è üö• üë®üèæ‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit nahm er an einer Diskussion √ºber das DIY-Projekt einer Matrix-LED-Uhr teil. 
 Und was mich √ºberrascht hat - die alte monochromatische...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY-Controller des LED-Panels auf CPLD mit BAM-Modulation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409743/">  Vor einiger Zeit nahm er an einer Diskussion √ºber das DIY-Projekt einer Matrix-LED-Uhr teil. <br>  Und was mich √ºberrascht hat - die alte monochromatische 8x8 LED-Matrix mit einem Schritt von 5 Millimetern wurde als Anzeigeger√§t verwendet.  Dar√ºber hinaus wurden komplexe Leiterplatten f√ºr sie gez√ºchtet, eine weiche dynamische Anzeige wurde gemacht.  Und dies zu einer Zeit, in der fertige 64x32-Farb-LED-Panels mit einem Abstand von 3 mm seit langem zu einem Preis von 10 bis 20 US-Dollar erh√§ltlich sind.  Das allgemeine Sortiment solcher Panels ist sehr gro√ü und hat einen Pixelabstand von 2 bis 10 mm und nahezu jede Gr√∂√üe. <br><a name="habracut"></a><br>  Gleichzeitig ist die Verwendung solcher Panels in DIY-Designs ziemlich schwierig - vorgefertigte Controller kosten ziemlich viel Geld und haben keine normale API.  Es ist ziemlich schwierig, das Panel auf Mikrocontrollern, die √ºblicherweise im Heimwerkerbereich verwendet werden, ziemlich schnell zu scannen.  Dar√ºber hinaus m√ºssen die Zeitintervalle mit hoher Genauigkeit eingehalten werden - sonst beginnt eine merkliche Ungleichm√§√üigkeit der Helligkeit. <br><br>  Bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit</a> gibt es gute L√∂sungen, die jedoch alle recht teuer und komplex sind. <br><br>  Nach einigem √úberlegen kam der Gedanke - warum nicht ein extrem preiswertes Board herstellen, das eine Br√ºcke zwischen einem gew√∂hnlichen Penny Board wie einem Arduino und einem LED-Panel darstellt?  Nach ein paar Monaten der Aufregung war etwas Arbeitendes geboren. <br><br>  Dieser Artikel beschreibt die zweite, verbesserte Version des Controllers. <br><cut><br><h2>  Herausforderung </h2><br>  Als Grundaufgabe wollte ich in der Lage sein, ein Panel mit einer Gesamtgr√∂√üe von mindestens 64 x 64 zu steuern und gleichzeitig mindestens in Hochfarbe (RGB565) arbeiten zu k√∂nnen, w√§hrend eine akzeptable Bildschirmaktualisierungsrate (mindestens 50 Hz) beibehalten wird.  In der ersten Version des Controllers wurde die Grundaufgabe vollst√§ndig implementiert, aber es entstand die Idee, die Aufgabe mit einer anderen, sehr vielversprechenden Methode zu implementieren, aus der die zweite Version hervorging. <br><br><h2>  Grundlegende Erkl√§rung des Designs eines typischen LED-Panels </h2><br>  Eingabe HUB75-Schnittstelle: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2d/yn/gt/2dyngtqqelfmxsb9iseipe2c29u.jpeg"></div><br>  An jedem Farbeingang befindet sich eine Kette von Registern vom Typ HC595 (jedoch spezielle 16-Kanal-Versionen f√ºr LEDs).  Es gibt so viele Register, die f√ºr die Breite des Panels ausreichen.  Shred-, Parallelstart- und Ausgabeberechtigungen sind allen Registern gemeinsam.  Die Eing√§nge ABCDE - dies ist die Wahl einer Serie - gehen an einen herk√∂mmlichen Decoder. <br><br>  Arbeitsprinzip: <br><br><ul><li>  Stellen Sie die Daten auf RGB-Eing√§nge ein und klicken Sie auf die Schaltfl√§che CLK.  Wiederholen, bis die gesamte Zeile geladen ist </li><li>  Schalten Sie die Ausg√§nge OE = 1 aus (damit keine St√∂rungen auftreten). </li><li>  Geben Sie dem Decoder die Nummer der geladenen Zeile </li><li>  Klick parallel laden LAT - Leitungsdaten werden in Ausgangsregister √ºbertragen <br>  Freigabeausg√§nge OE = 0 </li><li>  Wiederholen Sie dies f√ºr die n√§chste Zeile </li></ul><br>  Das ist eine klassische dynamische Anzeige.  Es ist klar, dass wir mit dieser Methode in einem solchen Zyklus nur jede bestimmte LED ein- und ausschalten k√∂nnen. <br><br>  Um Helligkeitsabstufungen mit klassischem PWM zu erhalten, muss ein solcher Zyklus N-1 Mal wiederholt werden, wobei N die Anzahl der Helligkeitsabstufungen ist (256 f√ºr RGB888).  Und da es gleichzeitig immer noch flackert - das alles muss sehr, sehr schnell gehen. <br><br>  Es gibt eine Problemumgehung - Bit Angle Modulation (BAM).  In diesem Fall ist die Gl√ºhzeit in jedem Zyklus proportional zum Gewicht des angezeigten Bits.  Das hei√üt, f√ºr RGB888 ben√∂tigen Sie nur 8 Anzeigezyklen.  Ein bisschen detaillierter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Die erste Version des Controllers verwendete klassisches PWM, wodurch die Anzahl der Scan-Zyklen streng begrenzt wurde.  In der zweiten Version ist die BAM implementiert, was zu einem enormen Geschwindigkeitsgewinn f√ºhrte. <br><br><h2>  Implementierung </h2><br>  Es war ziemlich offensichtlich, dass ein herk√∂mmlicher Mikrocontroller nur kleine Panels zieht - gro√üe haben einfach nicht genug Geschwindigkeit.  Daher ist CPLD oder FPGA hier unverzichtbar - es ist physikalisch unm√∂glich, auf kosteng√ºnstigen Mikrocontrollern Dutzende MB / s zu erzeugen. <br><br>  Als Speicher wurde ich im IXBT-Forum vom sehr interessanten FIFO-Speicher Averlogic AL422B empfohlen, der √ºber ca. 400 KB Speicher verf√ºgt und mit Frequenzen bis zu 50 MHz arbeiten kann. <br><br>  In Anbetracht der Tatsache, dass meine Hauptanforderung die maximal niedrigen Kosten der Komponenten war, so dass der fertige Schal f√ºr hausgemachte Hersteller zug√§nglich war, wurde die Altera EPM3064 - CPLD mit 64 Makrozellen ausgew√§hlt.  Gleichzeitig erlaubt eine so kleine Anzahl von Makrozellen keine dynamisch konfigurierbare Karte - die Konfiguration muss direkt in CPLD kompiliert werden. <br><br>  ‚Üí Die resultierende Schaltung liegt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> <br><br>  Details: <br><br><ul><li>  CPLD EPM3064ATC44-10 - Der Preis f√ºr Ali liegt bei 13-15 USD f√ºr ein Dutzend </li><li>  FIFO RAM AL422B - Der Preis f√ºr Ali liegt bei 15 US-Dollar pro Dutzend </li><li>  50MHz Quarzoszillator.  Die Karte erm√∂glicht die Installation in DIP14 / DIP8 / 7050-Geh√§usen.  Der Preis f√ºr Ali liegt bei 6 bis 7 US-Dollar pro Dutzend </li><li>  3,3-V-Stabilisator im SOT223-Geh√§use.  Preis in Chip und Dip - 40r pro St√ºck </li><li>  IDC-10MS-Anschluss.  Preis in Chip &amp; Dip - 3 p / St√ºck </li><li>  IDC-16MS-Anschluss.  Preis in Chip &amp; Dip - 8 r / St√ºck </li><li>  IDC-14MS-Anschluss.  Preis in Chip &amp; Dip - 7 r / St√ºck </li><li>  Kondensatoren 1 Mikrofarad 0805 - 8 St√ºck von ca. 1 U / St√ºck </li><li>  Kondensator 0.1uF 0805 - ca. 1 U / St√ºck </li><li>  Widerstand 10k 0805 - ein Penny </li></ul><br>  Insgesamt im Detail erhalten Sie 1,5 + 1,5 + 0,7 = 3,7 $ und 40 + 3 + 8 + 7 + 8 * 1 + 1 = 67 p.  Alles zusammen innerhalb von 5 Dollar - ein Penny. <br><br>  ‚Üí Das Original-Board-Image finden Sie <a href="">hier</a> <br><br>  ‚Üí Gerber- <a href="">Dateien f√ºr die Bestellung</a> vorbereitet <br><br>  Das Board ist f√ºr die erste Version vorbereitet, in der es keine RE-Kontrolle gab.  Um es mit der zweiten Version zu verwenden, m√ºssen Sie die Br√ºcke zwischen den Klemmen 23 und 24 von AL422B abschneiden und die Dr√§hte von Klemme 28 von EPM3064 (sie wird zum Klemmenblock gebracht) zu Klemme 24 von AL422B werfen. <br><br>  Vergessen Sie beim L√∂ten der Platine nicht, die Steckbr√ºcken auf der R√ºckseite der Platine zu l√∂ten. <br><br><img src="https://habrastorage.org/webt/y6/hy/i6/y6hyi6obrqqyyybfvractvmtuqy.jpeg"><br><br><img src="https://habrastorage.org/webt/u1/n1/jr/u1n1jr2zzs7sqfwpzxji2xpg2pg.jpeg"><br><br><h2>  Berechnungen </h2><br>  Die Berechnungen der erforderlichen Parameter sind recht kompliziert. <br><br>  Tatsache ist, dass in der Steuerung zwei Prozesse parallel ausgef√ºhrt werden - Laden der Daten der n√§chsten Zeile / Anzeigen einer bereits geladenen Zeile. <br><br>  Prozesse beginnen gleichzeitig, enden jedoch zu unterschiedlichen Zeiten, sodass ein schnellerer Prozess auf den Abschluss eines l√§ngeren Prozesses wartet. <br><br>  ‚Üí F√ºr die Berechnung wurde ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Excel-Tablet</a> erstellt <br><br>  Ausgangsdaten: <br><br><ul><li>  CRYSTAL_FRQ (MHz) - Generatorfrequenz (50 MHz) </li><li>  PIXEL_COUNT - Die Anzahl der Pixel in der Download-Leiste.  Weitere Details im Schaltbereich. </li><li>  RGB_INPUTS - Die Anzahl der RGB-Eing√§nge, die in der HUB75E-Schnittstelle des verwendeten Panels verwendet werden.  1 oder 2 </li><li>  BYTES_PER_PIXEL - Bytes pro Pixel.  In unserem Fall immer 3 - RGB888 </li><li>  SCAN_LINES - Anzahl der Scanlinien im verwendeten Bereich.  16.08.32 </li></ul><br>  Ausgew√§hlte Parameter: <br><br><ul><li>  PRE_DELAY - Verz√∂gerung vom LAT-Signal bis zum Einschalten der OE, in Ticks gesetzt </li><li>  PRESCALER - Prescaler f√ºr den Hauptz√§hler.  Das hei√üt, wenn die Preisliste 8 ist und das Gewicht des aktuellen Bits 4 ist, wird OE f√ºr 8 * 4 = 32 Zyklen eingeschaltet </li><li>  POST_DELAY - minimale Verz√∂gerung vom Ausschalten der OE bis zum n√§chsten LAT-Signal, in Ticks gesetzt </li></ul><br>  Zum Beispiel haben wir ein 32x32-Panel mit 8 Scanlinien und 2 RGB-Eing√§ngen.  Ein solches Panel verf√ºgt √ºber zwei HUB75E-Anschl√ºsse, dh physisch handelt es sich um zwei 32x16-Panels.  Wir verbinden diese Panels in Reihe, dh logischerweise sieht dieses Panel wie 64x16 aus. <br><br>  PRE_DELAY und POST_DELAY sind Austastintervalle vor und nach der Ausgangsfreigabe (OE), damit die Multiplexer die Ausg√§nge schalten und die Tasten √∂ffnen / schlie√üen k√∂nnen.  Ohne sie gibt es ‚ÄûTricks‚Äú vom Brennen von Pixeln in benachbarte Zeilen.  Die Werte werden experimentell f√ºr ein bestimmtes Panel ausgew√§hlt.  In der Regel sind 15 Ma√ünahmen ausreichend (in Ma√ünahmen festgelegt). <br><br>  Dies wirft die Frage auf, wie man Prescaler w√§hlt - wie man es w√§hlt. <br><br>  Ein niedriger Vorteilerwert ergibt eine kurze Bildanzeigezeit, verringert jedoch die Gesamthelligkeit.  Der hohe Wert des Vorteilers erh√∂ht die Anzeigezeit des Rahmens, dh wenn er aufgez√§hlt wird, flackert er auf dem Bildschirm. <br><br>  Versuchen wir es mit PRESCALER = 1 <br><br>  Wir bekommen: <br><br>  OE_EFFICIENCY - 8,3%, d. H. Das Panel arbeitet nur mit 8,3% der m√∂glichen maximalen Helligkeit <br>  FRAMES_PER_SECOND - 2034 fps - aber die Bildwiederholfrequenz des Bildes wird enorm sein - mehr als 2000 fps. <br><br>  Der Helligkeitsverlust ist bereits sehr gro√ü. <br><br>  Versuchen wir es mit PRESCALER = 16 <br><br>  Wir bekommen: <br><br>  OE_EFFICIENCY - 72,9%, dh das Panel arbeitet mit 72,9% der m√∂glichen maximalen Helligkeit <br>  FRAMES_PER_SECOND - 1117 - und die Bildwiederholfrequenz des Bildes ist sehr gut - mehr als 1000 fps. <br>  Nun, es ist ganz normal - ein Wirkungsgrad von mehr als 50% ist ganz normal und die Bildrate ist sehr gut. <br><br>  Die allgemeine Faustregel lautet, dass PRESCALER etwa achtmal kleiner ist als das Produkt PIXEL_COUNT * RGB_INPUTS <br><br>  Nun, z√§hle weiter und √ºberpr√ºfe. <br><br><h2>  LED-Panels wechseln </h2><br>  Alle Panels sind in Reihe geschaltet.  Anschlussplan: zuerst von rechts nach links, dann von unten nach oben.  Das hei√üt, zuerst verbinden wir die Horizontalen in Reihe, dann den Ausgang der unteren Reihe mit dem Eingang der zweiten Reihe von unten usw.  in die oberste Reihe. <br><br>  Der Controller klammert sich an das untere rechte Feld. <br><br>  Es gibt Panels mit zwei Eingangs- und zwei Ausgangsanschl√ºssen.  Solche Platten sind im Wesentlichen nur eine mechanische Anordnung von zwei Platten vertikal.  Kommutiert als zwei unabh√§ngige Panels. <br><br>  Nach dem Zusammenbau m√ºssen wir die Gesamtl√§nge der Kette in Pixel berechnen - dazu sehen wir - wie viele Panels sich insgesamt in der Kette befanden, und diese Zahl mit der Breite des Panels in Pixel multiplizieren.  Diese Nummer muss dann w√§hrend der CPLD-Konfiguration in den Wert PIXEL_COUNT und in den Zeitrechner eingegeben werden. <br><br><h2>  FPGA-Firmware </h2><br>  Alle notwendigen Dateien befinden sich auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> .  Sie m√ºssen direkt mit dem Ordner herunterladen. <br><br>  Nach der Registrierung m√ºssen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quartus II 13.0sp1</a> von der Altera-Website herunterladen und installieren.  Sie m√ºssen genau diese Version herunterladen - neuere Versionen unterst√ºtzen die MAX3000-Serie nicht mehr.  Es ist nicht notwendig, es zu brechen - die (kostenlose) Web Edition-Version reicht aus.  Aktivieren Sie beim Herunterladen unbedingt die Kontrollk√§stchen f√ºr die Unterst√ºtzung von MAX3000 und Programmer.  Nur f√ºr den Fall, ich warne Sie - das Paket ist gro√ü, ungef√§hr zwei Gigs.  Sie ben√∂tigen auch Altera USB Blaster - der √ºbliche Preis f√ºr Ali betr√§gt ca. 3 US-Dollar. <br><br>  √ñffnen Sie das Projekt al422_bam.qpf.  √ñffnen Sie links die Registerkarte Datei und die Datei al422_bam.v - dies ist die Hauptprojektdatei.  Darin m√ºssen Sie die Parameter konfigurieren: <br><br>  Wie viele RGB-Eing√§nge auf einem Panel - Auf Panels mit einem HUB75-Eingang k√∂nnen 1 oder 2 RGB-Eing√§nge vorhanden sein.  Um genau herauszufinden, wie viele Eingaben auf diese Weise m√∂glich sind, nehmen wir die Anzahl der Pixel im Bedienfeld vertikal.  Teilen Sie es durch die Anzahl der Scanlinien (in der Bedienfeldbezeichnung beispielsweise 8S angegeben).  Teilen Sie durch die Anzahl der Eingangsanschl√ºsse (1 oder 2).  Zum Beispiel - Ich habe ein 32x32-Panel, einen 8S-Scan und zwei Eingangsanschl√ºsse - 32/8/2 = 2 - was zwei RGB-Eing√§nge bedeutet. <br><br><pre><code class="hljs powershell">`define RGB_outs <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Wie viele Scanlinien auf dem Bedienfeld - da der HUB75E-Standard unterst√ºtzt wird, kann er bis zu 32x betragen.  Die Anzahl der Scanlinien ist normalerweise im Panel-Namen in Form von 8S / 16S / 32S angegeben. <br><br>  Es darf nur eine Zeile unkommentiert sein: <br><br><pre> <code class="hljs powershell">`define SCAN_x8 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x16 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x32 <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Die Gesamtzahl der horizontalen Pixel in der Kette.  Pixel werden in der gesamten Panel-Kette ber√ºcksichtigt - siehe Abschnitt ‚ÄûLED-Panels wechseln‚Äú <br><br><pre> <code class="hljs powershell">`define PIXEL_COUNT <span class="hljs-number"><span class="hljs-number">64</span></span></code> </pre><br>  Die Phasen der Ausgangssignale.  Die typischste Konfiguration ist folgende: OE ist auf niedriger Ebene aktiv (Kommentare entfernt), CLK wird vorne ausgef√ºhrt (Kommentare sind aktiviert), LAT ist auf hoher Ebene aktiv (Kommentare sind aktiviert).  Alle m√∂glichen seltsamen Optionen sind m√∂glich.  Finden Sie heraus, welche Sie nur experimentell haben oder indem Sie die Schaltung entfernen und nach Datenbl√§ttern f√ºr die verwendeten Chips suchen. <br><br><pre> <code class="hljs powershell">//`define LED_LAT_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> `define LED_OE_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> //`define LED_CLK_ON_FALL <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Vor- und Nachverz√∂gerung des OE-Signals relativ zu LAT und Prescaler f√ºr den Hauptz√§hler.  Siehe oben. <br><br><pre> <code class="hljs powershell">`define OE_PRESCALER <span class="hljs-number"><span class="hljs-number">16</span></span> `define OE_PREDELAY <span class="hljs-number"><span class="hljs-number">31</span></span> `define OE_POSTDELAY <span class="hljs-number"><span class="hljs-number">31</span></span></code> </pre><br>  Alles, dr√ºcken Sie Strg-L - das Projekt wird kompiliert.  Wenn Sie es nirgendwo vermasselt haben, werden mehrere Warnungen angezeigt, aber es sollten keine Fehler auftreten.  Als n√§chstes schlie√üen wir die gel√∂tete Platine an den USB-Blaster an und versorgen die Platine mit Strom.  Gehen Sie in Quartus zu tools - programmer.  W√§hlen Sie im Hardware-Setup USB-Blaster aus und klicken Sie auf Start.  Das war's, CPLD ist programmiert. <br><br><h2>  Mikrocontroller-Teil </h2><br>  Die Datenausgabe an die Steuerung ist im Allgemeinen √§u√üerst einfach: Wir setzen die Schreibadresse zur√ºck und geben dann nacheinander Datenbytes aus, die mit dem WCLK-Signal abgetastet werden.  Und es scheint, dass sogar eine banale Arduinka f√ºr die Arbeit ausreicht.  Es gibt jedoch zwei Probleme: <br><br>  a) Es braucht viel Speicher.  Selbst ein kleines 32x32-Panel im RGB888-Modus ben√∂tigt 3 KByte Speicher f√ºr einen Bildschirmpuffer.  Gew√∂hnliches Arduino-basiertes Atmega328 enth√§lt nur 2 KB RAM.  Sie k√∂nnen nat√ºrlich eine auf Atmega2560 basierende Mega-Karte verwenden, die bis zu 8 kB RAM enth√§lt, aber selbst dies reicht f√ºr normal gro√üe Panels nicht aus - ein 128 x 64-Panel im RGB565-Modus ben√∂tigt 16 kB Speicher. <br><br>  b) Bei der Arbeit mit AL422B ist ein Fehler aufgetreten, der nirgendwo dokumentiert wurde. Wenn Daten mit einer Geschwindigkeit von weniger als 2 MB / s geschrieben werden, funktioniert der Adressz√§hler nicht richtig und schreibt Daten "nicht vorhanden".  Vielleicht ist das eine Panne meiner Partei.  Vielleicht nicht.  Aber diese Panne muss umgangen werden.  Da der AVR8 mit 16 MHz arbeitet, ist es fast unm√∂glich, Daten mit den gew√ºnschten Geschwindigkeiten von ihm zu erhalten. <br><br>  Die vorgeschlagene L√∂sung besteht darin, billige Schals zu verwenden, die auf dem 32-Bit-Controller STM32F103C8T6 basieren.  Ein solcher Schal kostet Ali etwa 2,5 US-Dollar pro St√ºck oder etwa 1,7 US-Dollar beim Kauf eines Dutzend, das hei√üt sogar billiger als ein Arduino Nano.  Gleichzeitig erhalten wir einen vollwertigen 32-Bit-Mikrocontroller, der mit 72 MHz arbeitet und √ºber 20 kB RAM und 64 kB Flash verf√ºgt (vergleiche mit dem 2kB / 8kB Atmega328 auf Nano). <br><br>  Gleichzeitig werden solche Boards in der Arduino-Umgebung recht erfolgreich programmiert.  Dar√ºber gibt es einen guten Artikel auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Uhr</a> , daher werde ich ihn nicht duplizieren.  Machen Sie im Allgemeinen alles wie im Artikel beschrieben. <br><br>  W√§hlen Sie in einer Arduino-Umgebung die generische Karte STM32F103C, Variante STM32F103C8.  Die Daten werden √ºber DMA √ºbertragen, sodass Sie jede Optimierungsoption verwenden k√∂nnen. <br><br>  Das Umschalten erfolgt wie folgt: <br><br>  Fest in der Bibliothek festgenagelt: <br>  A0..A7 ‚Üí DI0..DI7 AL422B <br>  B0 ‚Üí WCLK AL422B <br>  B1 ‚Üí WRST AL422B <br><br>  In einer Skizze dem Controller zugewiesen: <br>  B10 ‚Üí WIR AL422B <br><br>  Gemeinsamer Draht: <br>  G ‚Üí GND <br><br>  Vergessen Sie nicht, die entsprechenden Controller-Pins mit 5 V / GND vom Panel zu versorgen. <br><br>  Nehmen Sie die Pinbelegung des Steckers am Controller aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Stromkreis</a> . <br><br><img src="https://habrastorage.org/webt/nh/p7/_y/nhp7_ygm9hqmkawess06ypt1oy4.jpeg"><br><br><h2>  Software-Teil </h2><br>  Da die Aufgabe darin bestand, alles so einfach und erschwinglich wie m√∂glich zu gestalten, wurde die gesamte Software f√ºr die Arduino-Umgebung entwickelt und als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LED_PANEL-</a> Bibliothek konzipiert. <br><br>  Die LED-PANEL-Bibliothek verwendet die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit GFX</a> -Bibliothek aktiv und muss daher installiert werden. <br><br>  Ich empfehle dringend, die LED_PANEL-Bibliothek nicht im Bibliotheksverzeichnis abzulegen, sondern im Skizzenordner zu belassen.  Tatsache ist, dass es viele eisengebundene Parameter gibt, und wenn Sie die Arbeit auf einen "fetteren" Mikrocontroller √ºbertragen m√∂chten, m√ºssen Sie viele Dinge im Code selbst √§ndern. <br><br>  Die Initialisierung erfolgt ungef√§hr in der folgenden Form: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LED_PANEL.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> width 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> height 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> bpp 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> scan_lines 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RGB_inputs 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> we_out_pin PB10 LED_PANEL led_panel = LED_PANEL(width, height, bpp, scan_lines, RGB_inputs, we_out_pin);</span></span></code> </pre><br>  Das hei√üt, wir erstellen eine Instanz der LED_PANEL-Klasse, f√ºr die wir die Parameter angeben: <br><br>  width - Die Gesamtbreite des Panels in Pixel (gesamt) <br>  H√∂he - Die Gesamth√∂he des Panels in Pixel (gesamt) <br>  bpp - Byte pro Pixel, 3 f√ºr RGB888.  Die BAM-Version funktioniert nur in RGB888 <br>  scan_lines - Die Anzahl der Scanlinien betr√§gt 16.08.32.  Es muss dem in der Steuerung blinkenden Modus entsprechen. <br>  RGB_Eing√§nge - Die Anzahl der RGB-Eing√§nge im HUB75-Anschluss betr√§gt 1/2.  Es muss dem in der Steuerung blinkenden Modus entsprechen. <br>  we_out_pin - Pin, an den der WE-Ausgang angeschlossen ist <br><br>  Bitte beachten Sie, dass w√§hrend der Initialisierung nur der WE-Pin angegeben wird.  Alle anderen Pins sind starr im Code registriert, da sie an die verwendeten Timer- und DMA-Kan√§le gebunden sind und ihre √Ñnderung erhebliche √Ñnderungen im Code mit sich bringt. <br><br>  Starten und L√∂schen des Bildschirms im Setup-Bereich: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.begin</span></span>(); <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.clear</span></span>();</code> </pre><br>  begin initialisiert die notwendigen Pins mit dem Ausgang, verbindet einen Timer und DMA <br>  clear l√∂scht den Puffer <br><br>  Zum Zeichnen k√∂nnen Sie alle Standardverfahren der Adafruit GFX-Bibliothek verwenden - vom einfachsten drawPixel bis zur Textausgabe.  Zur Ausgabe der in den Puffer gezeichneten Prozeduren werden verwendet: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>();</code> </pre><br>  In diesem Formular initiiert show die Daten√ºbertragung zum Controller √ºber DMA und gibt die Kontrolle sofort zur√ºck.  Finden Sie mithilfe der Funktion led_panel.OutIsFree () heraus, ob die √úbertragung beendet wurde. Wenn "true" angezeigt wird, wurde die √úbertragung beendet.  Es gibt eine Funktion - wenn Sie show aufrufen, wenn die √úbertragung noch nicht abgeschlossen ist - wird sie einfach ignoriert. <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  analog zu show (), aber wenn Sie show (false) aufrufen und die √úbertragung noch nicht abgeschlossen ist, wartet die Prozedur auf den Abschluss der √úbertragung und startet dann eine neue √úbertragungs- und R√ºckgabesteuerung: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  Analog zu show (false). Wenn Sie jedoch show (true) aufrufen, gibt die Prozedur nach dem Start einer neuen √úbertragung die Kontrolle erst zur√ºck, wenn die √úbertragung abgeschlossen ist. <br><br>  Im Allgemeinen ist das alles. <br><br><img src="https://habrastorage.org/webt/pn/-a/of/pn-aofhwnhuuzszuk_mcf9upqje.jpeg"><br><br>  Einige Hinweise zur Software: <br><br>  a) Die Gammakorrektur wird eingef√ºhrt, wenn die Farbe aus RGB565 (das von der Bibliothek verwendet wird) mit der ExpandColor-Funktion neu berechnet wird.  In allen anderen F√§llen wird eine lineare √úbertragungsfunktion verwendet, dh die Helligkeit ist direkt proportional zum Wert. <br>  b) Mit der Software k√∂nnen Sie mehrere LED-Controller an eine Mikrocontroller-Karte anschlie√üen.  Senden Sie dazu die Datenbus-, RST- und CLK-Leitungen parallel an die Steuerungen.  Der gew√ºnschte Controller wird √ºber die WE-Leitung ausgew√§hlt.  In der Software m√ºssen Sie f√ºr jeden Controller eine separate Instanz der LED_PANEL-Klasse erstellen, und jede Instanz muss w√§hrend der Initialisierung unterschiedliche WE-Zeilen (den letzten Parameter) haben. <br><br><h2>  ZU TUN </h2><br>  - Besch√§ftige dich mit der "Aufnahme" von Blumen in benachbarten Reihen.  Es sieht aus wie eine schlechte Verkabelung des Panels selbst (Schl√ºssel sind verschmutzt), aber Sie m√ºssen dies √ºberpr√ºfen.  Gerade ist ein neues Panel angekommen - ich werde es √ºberpr√ºfen; <br>  - Erstellen Sie eine neue Version der Karte - mit bereits geschiedenem RE und zus√§tzlichen Ausgangspegelwandlern in 5 V; <br>  - Erstellen Sie die META_LED_PANEL-Klasse, mit der mehrere LED_PANELs zu einem virtuellen Bildschirm kombiniert werden k√∂nnen. Auf diese Weise k√∂nnen sehr gro√üe Bildschirme mit mehreren Controllern erstellt werden. <br>  - Wechseln Sie in Zukunft zu einer leistungsst√§rkeren CPLD-Serie, z. B. CycloneIV.  Dies w√ºrde die M√∂glichkeiten erheblich erweitern und gleichzeitig die Kosten niedrig halten (EP4CE6E22 kostet f√ºr die Chinesen etwa 5 $, w√§hrend es 100-mal mehr Makrozellen und etwa 32 kB internen Speicher gibt).  Aber ich werde das eines Tages sp√§ter tun.  Wenn ich will.  Da solche Entwicklungen zu viel Zeit in Anspruch nehmen. </cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de409743/">https://habr.com/ru/post/de409743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de409731/index.html">Hashflare-Rentabilit√§tspr√ºfung. Meine Erfahrung in 6 Monaten</a></li>
<li><a href="../de409733/index.html">Ben√∂tigen Sie schnellere Daten und einen saubereren Planeten? Beginnen Sie mit der Entwicklung von Asteroiden</a></li>
<li><a href="../de409735/index.html">Konsens-Level-Illusion</a></li>
<li><a href="../de409739/index.html">Bloomberg: Telegram plant, w√§hrend des ICO mehr als 1 Milliarde US-Dollar zu gewinnen</a></li>
<li><a href="../de409741/index.html">Das Wei√üe Haus ist daran interessiert, Falcon Heavy auf den Markt zu bringen</a></li>
<li><a href="../de409745/index.html">Der KI-Spezialist behauptet, er habe verstanden, in welcher Sprache das Voynich-Manuskript geschrieben ist</a></li>
<li><a href="../de409747/index.html">Das neuronale AttnGAN-Netzwerk zeichnet Objekte in Teilen, wobei der Vektorraum nicht nur von S√§tzen, sondern auch von W√∂rtern verwendet wird</a></li>
<li><a href="../de409749/index.html">Pyrolysekessel zu Hause oder wenn der Gaspreis keine Rolle spielt</a></li>
<li><a href="../de409751/index.html">AudioFilkina Brief: Blue Tooth Musik - nicht f√ºr Hype, sondern zum Guten</a></li>
<li><a href="../de409753/index.html">Die Vereinten Nationen k√∂nnen gro√ü angelegte zuf√§llige Experimente durchf√ºhren, um die globale Erw√§rmung zu verringern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>