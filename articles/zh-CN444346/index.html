<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ½â€ğŸ³ ğŸ’¥ ğŸ”  GraphQLå’ŒGolang ğŸ›ï¸ ğŸ™‡ğŸ¾ ğŸ”§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨å…¬å¸å°†Facebookè½¬ç§»åˆ°å¼€æºç±»åˆ«ä¹‹åçš„è¿‡å»å‡ å¹´ä¸­ï¼ŒGraphQLæŠ€æœ¯å·²å˜å¾—éå¸¸æµè¡Œã€‚ è¯¥ææ–™çš„ä½œè€…ï¼ˆæˆ‘ä»¬ä»Šå¤©å°†å…¶ç¿»è¯‘å‘è¡¨ï¼‰è¡¨ç¤ºï¼Œä»–å°è¯•åœ¨Node.jsä¸­ä½¿ç”¨GraphQLï¼Œå¹¶ä¸”æ ¹æ®ä»–è‡ªå·±çš„ç»éªŒï¼Œä»–åšä¿¡è¯¥æŠ€æœ¯ç”±äºå…¶å“è¶Šçš„åŠŸèƒ½å’Œç®€å•æ€§è€Œä¸ä¼šå¼•èµ·å¦‚æ­¤å¤šçš„å…³æ³¨ã€‚ æœ€è¿‘ï¼Œåœ¨ä»äº‹ä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼Œä»–ä»Node...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GraphQLå’ŒGolang</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/444346/"> åœ¨å…¬å¸å°†Facebookè½¬ç§»åˆ°å¼€æºç±»åˆ«ä¹‹åçš„è¿‡å»å‡ å¹´ä¸­ï¼ŒGraphQLæŠ€æœ¯å·²å˜å¾—éå¸¸æµè¡Œã€‚ è¯¥ææ–™çš„ä½œè€…ï¼ˆæˆ‘ä»¬ä»Šå¤©å°†å…¶ç¿»è¯‘å‘è¡¨ï¼‰è¡¨ç¤ºï¼Œä»–å°è¯•åœ¨Node.jsä¸­ä½¿ç”¨GraphQLï¼Œå¹¶ä¸”æ ¹æ®ä»–è‡ªå·±çš„ç»éªŒï¼Œä»–åšä¿¡è¯¥æŠ€æœ¯ç”±äºå…¶å“è¶Šçš„åŠŸèƒ½å’Œç®€å•æ€§è€Œä¸ä¼šå¼•èµ·å¦‚æ­¤å¤šçš„å…³æ³¨ã€‚ æœ€è¿‘ï¼Œåœ¨ä»äº‹ä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼Œä»–ä»Node.jsåˆ‡æ¢åˆ°Golangã€‚ ç„¶åï¼Œä»–å†³å®šæµ‹è¯•Golangå’ŒGraphQLçš„åä½œã€‚ <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/jp/qa/qv/jpqaqvlt5xh7d7mlhwpxvvwhptq.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">åˆæ­¥èµ„æ–™</font> </h2><br> æ‚¨å¯ä»¥ä»å®˜æ–¹çš„GraphQLå®šä¹‰ä¸­äº†è§£åˆ°ï¼Œè¿™æ˜¯APIçš„æŸ¥è¯¢è¯­è¨€ï¼Œä¹Ÿæ˜¯å¯¹ç°æœ‰æ•°æ®æ‰§è¡Œæ­¤ç±»æŸ¥è¯¢çš„è¿è¡Œæ—¶ã€‚  GraphQLæä¾›äº†ç‰¹å®šAPIä¸­æ•°æ®çš„å®Œæ•´ä¸”æ˜“äºç†è§£çš„æè¿°ï¼Œä½¿å®¢æˆ·å¯ä»¥å‡†ç¡®åœ°è¯·æ±‚ä»–ä»¬æ‰€éœ€çš„ä¿¡æ¯ï¼Œä»…æ­¤è€Œå·²ï¼Œå°±å¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»ç®€åŒ–APIçš„å¼€å‘ï¼Œå¹¶ä¸ºå¼€å‘äººå‘˜æä¾›å¼ºå¤§çš„å·¥å…·ã€‚ <br><br> ç”¨äºGolangçš„GraphQLåº“ä¸å¤šã€‚ ç‰¹åˆ«æ˜¯ï¼Œæˆ‘å°è¯•äº†è¯¸å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Thunder</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">graphql</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">graphql-go</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gqlgenä¹‹ç±»çš„åº“</a> ã€‚ æˆ‘åº”è¯¥æ³¨æ„ï¼Œæˆ‘å°è¯•è¿‡çš„æœ€å¥½çš„æ–¹æ³•æ˜¯gqlgenåº“ã€‚ <br><br>  gqlgenåº“ä»å¤„äºbetaç‰ˆæœ¬ä¸­ï¼Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œç‰ˆæœ¬ä¸º<a href="">0.7.2</a> ã€‚ å›¾ä¹¦é¦†æ­£åœ¨è¿…é€Ÿå‘å±•ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œï¼Œ</a>æ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å…¶å¼€å‘è®¡åˆ’çš„ä¿¡æ¯ã€‚ ç°åœ¨gqlgençš„å®˜æ–¹èµåŠ©å•†æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">99designs</a>é¡¹ç›®ï¼Œè¿™æ„å‘³ç€è¯¥åº“å¾ˆå¯èƒ½ä¼šæ¯”ä»¥å‰æ›´å¿«åœ°å‘å±•ã€‚ è¯¥åº“çš„ä¸»è¦å¼€å‘äººå‘˜æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">vektah</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">neelance</a> ï¼Œè€Œneelanceå¦å¤–å¯ä»¥åœ¨graphql-goåº“ä¸Šå·¥ä½œã€‚ <br><br> è®©æˆ‘ä»¬åŸºäºæ‚¨å·²ç»å…·å¤‡GraphQLåŸºæœ¬çŸ¥è¯†çš„å‡è®¾æ¥è®¨è®ºgqlgenåº“ã€‚ <br><br><h2>  <font color="#3AC1EF">GqlgenåŠŸèƒ½</font> </h2><br> åœ¨gqlgenæè¿°ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ä¹‹å‰æ‹¥æœ‰çš„åº“ï¼Œç”¨äºåœ¨Golangä¸­å¿«é€Ÿåˆ›å»ºä¸¥æ ¼ç±»å‹çš„GraphQLæœåŠ¡å™¨ã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™å¥è¯å¾ˆæœ‰å¸Œæœ›ï¼Œå› ä¸ºè¿™æ„å‘³ç€åœ¨ä½¿ç”¨è¯¥åº“æ—¶ï¼Œæˆ‘ä¸ä¼šé‡åˆ°è¯¸å¦‚<code>map[string]interface{}</code> ï¼Œå› ä¸ºæ­¤å¤„ä½¿ç”¨äº†åŸºäºä¸¥æ ¼ç±»å‹çš„æ–¹æ³•ã€‚ <br><br> å¦å¤–ï¼Œè¯¥åº“ä½¿ç”¨åŸºäºæ•°æ®æ¨¡å¼çš„æ–¹æ³•ã€‚ è¿™æ„å‘³ç€å°†ä½¿ç”¨GraphQL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¶æ„å®šä¹‰è¯­è¨€</a>æ¥æè¿°APIã€‚ è¯¥è¯­è¨€å…·æœ‰è‡ªå·±å¼ºå¤§çš„ä»£ç ç”Ÿæˆå·¥å…·ï¼Œå¯è‡ªåŠ¨åˆ›å»ºGraphQLä»£ç ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜åªèƒ½å®ç°ç›¸åº”æ¥å£æ–¹æ³•çš„åŸºæœ¬é€»è¾‘ã€‚ <br><br> æœ¬æ–‡åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ ç¬¬ä¸€ä¸ªè‡´åŠ›äºåŸºæœ¬çš„å·¥ä½œæ–¹æ³•ï¼Œç¬¬äºŒä¸ªè‡´åŠ›äºé«˜çº§æ–¹æ³•ã€‚ <br><br><h2>  <font color="#3AC1EF">ä¸»è¦å·¥ä½œæ–¹æ³•ï¼šè®¾ç½®ï¼Œæ¥æ”¶å’Œæ›´æ”¹æ•°æ®çš„è¯·æ±‚ï¼Œè®¢é˜…</font> </h2><br> ä½œä¸ºå®éªŒæ€§åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç½‘ç«™ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¯¥ç½‘ç«™ä¸Šå‘å¸ƒè§†é¢‘ï¼Œæ·»åŠ å±å¹•æˆªå›¾å’Œè¯„è®ºï¼Œæœç´¢è§†é¢‘ä»¥åŠæŸ¥çœ‹ä¸å…¶ä»–è®°å½•ç›¸å…³çš„è®°å½•åˆ—è¡¨ã€‚ è®©æˆ‘ä»¬å¼€å§‹è¿™ä¸ªé¡¹ç›®ï¼š <br><br><pre> <code class="go hljs">mkdir -p $GOPATH/src/github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/</code> </pre> <br> åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä»¥ä¸‹æ•°æ®æ¨¡å¼æ–‡ä»¶ï¼ˆ <code>schema.graphql</code> ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> User {   id: ID!   name: String!   email: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video {   id: ID!   name: String!   description: String!   user: User!   url: String!   createdAt: Timestamp!   screenshots: [Screenshot]   related(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Screenshot {   id: ID!   videoId: ID!   url: String! } input NewVideo {   name: String!   description: String!   userId: ID!   url: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Query {   Videos(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } scalar Timestamp</code> </pre> <br> å®ƒæè¿°äº†åŸºæœ¬çš„æ•°æ®æ¨¡å‹ï¼Œä¸€ä¸ªçªå˜ï¼ˆ <code>Mutation</code> ï¼Œå¯¹æ•°æ®æ›´æ”¹çš„è¯·æ±‚çš„æè¿°ï¼‰ç”¨äºåœ¨ç«™ç‚¹ä¸Šå‘å¸ƒæ–°çš„è§†é¢‘æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ªæŸ¥è¯¢ï¼ˆ <code>Query</code> ï¼‰ä»¥è·å–æ‰€æœ‰è§†é¢‘æ–‡ä»¶çš„åˆ—è¡¨ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³GraphQLæ¨¡å¼çš„æ›´å¤šä¿¡æ¯ã€‚ å¦å¤–ï¼Œè¿™é‡Œæˆ‘ä»¬å£°æ˜äº†è‡ªå·±çš„æ ‡é‡æ•°æ®ç±»å‹ä¹‹ä¸€ã€‚ æˆ‘ä»¬å¯¹GraphQLä¸­çš„5ç§æ ‡å‡†æ ‡é‡æ•°æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç±»å‹</a> ï¼ˆ <code>Int</code> ï¼Œ <code>Float</code> ï¼Œ <code>String</code> ï¼Œ <code>Boolean</code>å’Œ<code>ID</code> ï¼‰ä¸æ»¡æ„ã€‚ <br><br> å¦‚æœéœ€è¦ä½¿ç”¨è‡ªå·±çš„ç±»å‹ï¼Œåˆ™å¯ä»¥åœ¨<code>schema.graphql</code>å£°æ˜å®ƒä»¬ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæ­¤ç±»å‹ä¸º<code>Timestamp</code> ï¼‰å¹¶åœ¨ä»£ç ä¸­æä¾›å®ƒä»¬çš„å®šä¹‰ã€‚ ä½¿ç”¨gqlgenåº“æ—¶ï¼Œéœ€è¦æä¾›ç”¨äºæ‰€æœ‰è‡ªå·±çš„æ ‡é‡ç±»å‹çš„å°é€å¤„ç†å’Œè§£å°é€å¤„ç†çš„æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨<code>gqlgen.yml</code>é…ç½®æ˜ å°„ã€‚ <br><br> åº”å½“æŒ‡å‡ºï¼Œåœ¨è¯¥åº“çš„æœ€æ–°ç‰ˆæœ¬ä¸­ï¼Œæœ‰ä¸€é¡¹é‡è¦æ›´æ”¹ã€‚ å³ï¼Œä»ä¸­åˆ é™¤äº†å¯¹å·²ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¾èµ–æ€§ã€‚ å› æ­¤ï¼Œåº”å°†<code>scripts/gqlgen.go</code>æ–‡ä»¶æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œ <code>scripts/gqlgen.go</code>ä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// +build ignore package main import "github.com/99designs/gqlgen/cmd" func main() { cmd.Execute() }</span></span></code> </pre> <br> ä¹‹åï¼Œæ‚¨éœ€è¦åˆå§‹åŒ–<code>dep</code> ï¼š <br><br><pre> <code class="go hljs">dep init</code> </pre> <br> ç°åœ¨æ˜¯æ—¶å€™åˆ©ç”¨åº“çš„ä»£ç ç”ŸæˆåŠŸèƒ½äº†ã€‚ å®ƒä»¬ä½¿æ‚¨å¯ä»¥åˆ›å»ºæ‰€æœ‰æ— èŠçš„æ ·æ¿ä»£ç ï¼Œä½†æ˜¯ï¼Œä¸èƒ½å°†å®ƒä»¬ç§°ä¸ºå®Œå…¨æ— è¶£çš„ä»£ç ã€‚ è¦å¯åŠ¨è‡ªåŠ¨ä»£ç ç”Ÿæˆæœºåˆ¶ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> init</code> </pre> <br> æ‰§è¡Œåï¼Œå°†åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š <br><br><ul><li>  <code>gqlgen.yml</code> ï¼šç”¨äºç®¡ç†ä»£ç ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚ <br></li><li>  <code>generated.go</code> ï¼šç”Ÿæˆçš„ä»£ç ã€‚ <br></li><li>  <code>models_gen.go</code> ï¼šæä¾›çš„æ¶æ„çš„æ‰€æœ‰æ¨¡å‹å’Œæ•°æ®ç±»å‹ã€‚ <br></li><li>  <code>resolver.go</code> ï¼šè¿™æ˜¯ç¨‹åºå‘˜åˆ›å»ºçš„ä»£ç ã€‚ <br></li><li>  <code>server/server.go</code> ï¼šå¸¦æœ‰<code>http.Handler</code>å…¥å£ç‚¹ï¼Œä»¥å¯åŠ¨GraphQLæœåŠ¡å™¨ã€‚ <br></li></ul><br> çœ‹ä¸€ä¸‹<code>Video</code>ç±»å‹çš„ç”Ÿæˆæ¨¡å‹ï¼ˆæ–‡ä»¶<code>generated_video.go</code> ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> User        User  <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Screenshots []*Screenshot <span class="hljs-string"><span class="hljs-string">`json:"screenshots"`</span></span> Related     []Video  <span class="hljs-string"><span class="hljs-string">`json:"related"`</span></span> }</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥çœ‹åˆ°<code>ID</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ <code>CreatedAt</code>ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ ç›¸åº”åœ°é…ç½®å…¶ä»–ç›¸å…³æ¨¡å‹ã€‚ ä½†æ˜¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸æ˜¯å¿…éœ€çš„ã€‚ å¦‚æœä½¿ç”¨çš„æ˜¯ä»»ä½•ç±»å‹çš„SQLæ•°æ®ï¼Œåˆ™ä¾‹å¦‚ï¼Œæ ¹æ®æ‰€ä½¿ç”¨çš„æ•°æ®åº“ï¼Œæ‚¨éœ€è¦<code>ID</code>å­—æ®µä¸º<code>int</code>æˆ–<code>int64</code> ã€‚ <br><br> ä¾‹å¦‚ï¼Œæˆ‘åœ¨æ­¤æ¼”ç¤ºåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨PostgreSQLï¼Œå› æ­¤ï¼Œå½“ç„¶ï¼Œæˆ‘éœ€è¦<code>ID</code>å­—æ®µä¸º<code>int</code>ç±»å‹ï¼Œè€Œ<code>CreatedAt</code>å­—æ®µä¸º<code>CreatedAt</code>ç±»å‹ã€‚ è¿™å¯¼è‡´ä¸€ä¸ªäº‹å®ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰è‡ªå·±çš„æ¨¡å‹ï¼Œå¹¶å‘Šè¯‰gqlgenæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆ‘ä»¬çš„æ¨¡å‹è€Œä¸æ˜¯ç”Ÿæˆæ–°æ¨¡å‹ã€‚ è¿™æ˜¯<code>models.go</code>æ–‡ä»¶çš„å†…å®¹ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> User        User <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Related     []Video } <span class="hljs-comment"><span class="hljs-comment">//    int  ID func MarshalID(id int) graphql.Marshaler { return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.Quote(fmt.Sprintf("%d", id))) }) } //        func UnmarshalID(v interface{}) (int, error) { id, ok := v.(string) if !ok {   return 0, fmt.Errorf("ids must be strings") } i, e := strconv.Atoi(id) return int(i), e } func MarshalTimestamp(t time.Time) graphql.Marshaler { timestamp := t.Unix() * 1000 return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.FormatInt(timestamp, 10)) }) } func UnmarshalTimestamp(v interface{}) (time.Time, error) { if tmpStr, ok := v.(int); ok {   return time.Unix(int64(tmpStr), 0), nil } return time.Time{}, errors.TimeStampError }</span></span></code> </pre> <br> æˆ‘ä»¬å‘Šè¯‰å›¾ä¹¦é¦†å®ƒåº”è¯¥ä½¿ç”¨ä»¥ä¸‹æ¨¡å‹ï¼ˆ <code>gqlgen.yml</code>æ–‡ä»¶ï¼‰ï¼š <br><br><pre> <code class="go hljs">schema: - schema.graphql exec: filename: generated.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> model: filename: models_gen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> resolver: filename: resolver.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Resolver models: Video:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Video ID:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.ID Timestamp:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Timestamp</code> </pre> <br> æ‰€æœ‰è¿™äº›çš„å…³é”®åœ¨äºï¼Œæˆ‘ä»¬ç°åœ¨æ‹¥æœ‰è‡ªå·±çš„<code>ID</code>å’Œ<code>Timestamp</code>å®šä¹‰ï¼Œä»¥åŠç”¨äºç¼–ç»„<code>gqlgen.yml</code>å¹¶å°†å®ƒä»¬æ˜ å°„åˆ°<code>gqlgen.yml</code>æ–‡ä»¶ä¸­çš„æ–¹æ³•ã€‚ ç°åœ¨ï¼Œç”¨æˆ·å·²å°†å­—ç¬¦ä¸²ä½œä¸º<code>ID</code> ï¼Œ <code>UnmarshalID()</code>æ–¹æ³•å°†è¯¥å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°ã€‚ å‘é€å“åº”æ—¶ï¼Œ <code>MarshalID()</code>æ–¹æ³•å°†æ•°å­—è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚  <code>Timestamp</code>æˆ–ç¨‹åºå‘˜å£°æ˜çš„ä»»ä½•å…¶ä»–æ ‡é‡ç±»å‹<code>Timestamp</code>å‘ç”Ÿç›¸åŒçš„æƒ…å†µã€‚ <br><br> ç°åœ¨è¯¥å®ç°åº”ç”¨ç¨‹åºé€»è¾‘äº†ã€‚ æ‰“å¼€<code>resolver.go</code>æ–‡ä»¶ï¼Œå¹¶å‘å…¶ä¸­æ·»åŠ çªå˜å’ŒæŸ¥è¯¢çš„æè¿°ã€‚ å·²ç»æœ‰ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ ·æ¿ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å¡«å……å…¶å«ä¹‰ã€‚ è¿™æ˜¯æ­¤æ–‡ä»¶çš„ä»£ç ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { newVideo := api.Video{   URL:         input.URL,   Name:        input.Name,   CreatedAt:   time.Now().UTC(), } rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"INSERT INTO videos (name, url, user_id, created_at) VALUES($1, $2, $3, $4) RETURNING id"</span></span>,   input.Name, input.URL, input.UserID, newVideo.CreatedAt) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> || !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, err } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;newVideo.ID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> errors.IsForeignKeyError(err) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.UserNotExist   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newVideo, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *queryResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Videos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, limit *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, offset *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]api.Video, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> video api.Video <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videos []api.Video rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"SELECT id, name, url, created_at, user_id FROM videos ORDER BY created_at desc limit $1 offset $2"</span></span>, limit, offset) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;video.ID, &amp;video.Name, &amp;video.URL, &amp;video.CreatedAt, &amp;video.UserID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {     errors.DebugPrintf(err)     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError   }   videos = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(videos, video) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videos, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br> ç°åœ¨è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹çªå˜ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f7b/a2c/01f/f7ba2c01f766ebc31ed90880376136f1.png"></div>  <i><font color="#999999">å˜å¼‚createVideo</font></i> <br><br> æœ‰æ•ˆï¼ ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆç”¨æˆ·ä¿¡æ¯ï¼ˆ <code>user</code>å¯¹è±¡ï¼‰ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Ÿ å½“ä½¿ç”¨GraphQLæ—¶ï¼Œé€‚ç”¨äºç±»ä¼¼äºâ€œæƒ°æ€§â€ï¼ˆlazyï¼‰å’Œâ€œè´ªå©ªâ€ï¼ˆæ¸´æœ›ï¼‰åŠ è½½çš„æ¦‚å¿µã€‚ ç”±äºè¯¥ç³»ç»Ÿæ˜¯å¯æ‰©å±•çš„ï¼Œå› æ­¤æ‚¨éœ€è¦æŒ‡å®šå“ªäº›å­—æ®µéœ€è¦â€œè´ªå©ªåœ°â€å¡«å†™ï¼Œå“ªäº›å­—æ®µéœ€è¦â€œæ‡’æƒ°â€ã€‚ <br><br> æˆ‘å‘æˆ‘æ‰€åœ¨çš„ç»„ç»‡çš„å›¢é˜Ÿå»ºè®®äº†ä»¥ä¸‹ä¸gqlgenä¸€èµ·ä½¿ç”¨çš„â€œé»„é‡‘æ³•åˆ™â€ï¼šâ€œä¸è¦åœ¨æ¨¡å‹ä¸­åŒ…æ‹¬ä»…åœ¨å®¢æˆ·è¦æ±‚æ—¶æ‰éœ€è¦åŠ è½½çš„å­—æ®µã€‚â€ <br><br> åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œä»…å½“å®¢æˆ·ç«¯è¯·æ±‚è¿™äº›å­—æ®µæ—¶ï¼Œæˆ‘æ‰éœ€è¦ä¸‹è½½æœ‰å…³è§†é¢‘ç‰‡æ®µçš„æ•°æ®ï¼ˆç”šè‡³åŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚ ä½†æ˜¯ç”±äºæˆ‘ä»¬åœ¨æ¨¡å‹ä¸­åŒ…æ‹¬äº†è¿™äº›å­—æ®µï¼Œå› æ­¤gqlgenå‡å®šæˆ‘ä»¬é€šè¿‡æ¥æ”¶æœ‰å…³è§†é¢‘çš„ä¿¡æ¯æ¥æä¾›æ­¤æ•°æ®ã€‚ ç»“æœï¼Œç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ç©ºç»“æ„ã€‚ <br><br> æœ‰æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦æŸç§ç±»å‹çš„æ•°æ®ï¼Œå› æ­¤ä½¿ç”¨å•ç‹¬çš„è¯·æ±‚ä¸‹è½½æ•°æ®æ˜¯ä¸åˆ‡å®é™…çš„ã€‚ ä¸ºæ­¤ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚SQLè¿æ¥ä¹‹ç±»çš„æ–¹æ³•ã€‚ ä¸€æ¬¡ï¼ˆä½†æ˜¯ï¼Œè¿™ä¸é€‚ç”¨äºæ­¤å¤„è€ƒè™‘çš„ç¤ºä¾‹ï¼‰ï¼Œæˆ‘éœ€è¦å°†å…¶å…ƒæ•°æ®ä¸è§†é¢‘ä¸€èµ·ä¸Šä¼ ã€‚ è¿™äº›å®ä½“å­˜å‚¨åœ¨ä¸åŒçš„ä½ç½®ã€‚ ç»“æœï¼Œå¦‚æœæˆ‘çš„ç³»ç»Ÿæ”¶åˆ°äº†ä¸‹è½½è§†é¢‘çš„è¯·æ±‚ï¼Œåˆ™æˆ‘ä¸å¾—ä¸æå‡ºå¦ä¸€ä¸ªè¯·æ±‚ä»¥è·å–å…ƒæ•°æ®ã€‚ ä½†æ˜¯ï¼Œç”±äºæˆ‘çŸ¥é“æ­¤è¦æ±‚ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘çŸ¥é“å®¢æˆ·ç«¯å§‹ç»ˆéœ€è¦å®¢æˆ·ç«¯å’Œè§†é¢‘åŠå…¶å…ƒæ•°æ®ï¼‰ï¼Œå› æ­¤æˆ‘æ›´å–œæ¬¢ä½¿ç”¨è´ªå©ªçš„åŠ è½½æŠ€æœ¯æ¥æé«˜æ€§èƒ½ã€‚ <br><br> è®©æˆ‘ä»¬é‡å†™æ¨¡å‹å¹¶å†æ¬¡ç”Ÿæˆgqlgenä»£ç ã€‚ ä¸ºäº†ä¸ä½¿æ•…äº‹å¤æ‚åŒ–ï¼Œæˆ‘ä»¬åªä¸º<code>user</code>å­—æ®µç¼–å†™æ–¹æ³•ï¼ˆæ–‡ä»¶<code>models.go</code> ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> UserID      <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"-"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> }</code> </pre> <br> æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª<code>UserID</code>å¹¶åˆ é™¤äº†<code>User</code>ç»“æ„ã€‚ ç°åœ¨é‡æ–°ç”Ÿæˆä»£ç ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br> ç”±äºæ­¤å‘½ä»¤ï¼Œå°†åˆ›å»ºä»¥ä¸‹æ¥å£æ–¹æ³•æ¥è§£ææœªå®šä¹‰çš„ç»“æ„ã€‚ æ­¤å¤–ï¼Œæ‚¨å°†éœ€è¦åœ¨è§£æå™¨ï¼ˆ <code>generated.go</code>æ–‡ä»¶ï¼‰ä¸­ç¡®å®šä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> VideoResolver <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { User(ctx context.Context, obj *api.Video) (api.User, error) Screenshots(ctx context.Context, obj *api.Video) ([]*api.Screenshot, error) Related(ctx context.Context, obj *api.Video, limit *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, offset *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ([]api.Video, error) }</code> </pre> <br> è¿™æ˜¯å®šä¹‰ï¼ˆ <code>resolver.go</code>æ–‡ä»¶ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { rows, _ := dal.LogAndQuery(r.db,<span class="hljs-string"><span class="hljs-string">"SELECT id, name, email FROM users where id = $1"</span></span>, obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user api.User <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br> ç°åœ¨ï¼Œçªå˜æµ‹è¯•ç»“æœå°†å¦‚ä¸‹æ‰€ç¤ºã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25a/41d/aaa/25a41daaa86b8db5407bd432312c3028.png"></div><br>  <i><font color="#999999">å˜å¼‚createVideo</font></i> <br><br> æˆ‘ä»¬åˆšåˆšè®¨è®ºçš„æ˜¯GraphQLçš„åŸºç¡€çŸ¥è¯†ï¼ŒæŒæ¡äº†å®ƒä¹‹åï¼Œæ‚¨å·²ç»å¯ä»¥ç¼–å†™è‡ªå·±çš„ä¸œè¥¿ã€‚ ä½†æ˜¯ï¼Œåœ¨æ‚¨å°è¯•ä½¿ç”¨GraphQLå’ŒGolangè¿›è¡Œå®éªŒä¹‹å‰ï¼Œè®¨è®ºä¸æˆ‘ä»¬åœ¨è¿™é‡Œè¿›è¡Œçš„å·¥ä½œç›´æ¥ç›¸å…³çš„è®¢é˜…å°†å¾ˆæœ‰ç”¨ã€‚ <br><br><h3>  <font color="#3AC1EF">â–è®¢é˜…</font> </h3><br>  GraphQLæä¾›äº†è®¢é˜…å®æ—¶å‘ç”Ÿçš„æ•°æ®æ›´æ”¹çš„åŠŸèƒ½ã€‚  gqlgenåº“å…è®¸ä½¿ç”¨Webå¥—æ¥å­—å®æ—¶å¤„ç†è®¢é˜…äº‹ä»¶ã€‚ <br><br> è®¢é˜…éœ€è¦åœ¨<code>schema.graphql</code>æ–‡ä»¶ä¸­æè¿°ã€‚ ä»¥ä¸‹æ˜¯è®¢é˜…è§†é¢‘å‘å¸ƒäº‹ä»¶çš„è¯´æ˜ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Subscription {   videoPublished: Video! }</code> </pre> <br> ç°åœ¨ï¼Œå†æ¬¡è¿è¡Œè‡ªåŠ¨ä»£ç ç”Ÿæˆï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br> å¦‚å‰æ‰€è¿°ï¼Œåœ¨<code>generated.go</code>æ–‡ä»¶ä¸­è‡ªåŠ¨åˆ›å»ºä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºäº†å¿…é¡»åœ¨è¯†åˆ«å™¨ä¸­å®ç°çš„æ¥å£ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼ˆ <code>resolver.go</code>æ–‡ä»¶ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videoPublishedChannel <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { videoPublishedChannel = <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video{} } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> subscriptionResolver <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>{ *Resolver } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *subscriptionResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VideoPublished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;-</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api.Video, error)</span></span></span></span> { id := randx.String(<span class="hljs-number"><span class="hljs-number">8</span></span>) videoEvent := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   &lt;-ctx.Done() }() videoPublishedChannel[id] = videoEvent <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videoEvent, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ... for _, observer := range videoPublishedChannel {   observer &lt;- newVideo } return newVideo, nil }</span></span></code> </pre> <br> ç°åœ¨ï¼Œåœ¨åˆ›å»ºæ–°è§†é¢‘æ—¶ï¼Œæ‚¨éœ€è¦è§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯<code>for _, observer := range videoPublishedChannel</code>çš„è¡Œå®Œæˆçš„ã€‚ <br><br> ç°åœ¨æ˜¯æ—¶å€™æ£€æŸ¥æ‚¨çš„è®¢é˜…äº†ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f71/d7f/42b/f71d7f42b147f59d227a25e577ef57fb.gif"></div><br>  <i><font color="#999999">éªŒè¯è®¢é˜…</font></i> <br><br>  GraphQLå½“ç„¶å…·æœ‰æŸäº›æœ‰ä»·å€¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ­£å¦‚ä»–ä»¬æ‰€è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰é—ªé—ªå‘å…‰çš„éƒ½æ˜¯é‡‘å­ã€‚ å³ï¼Œæˆ‘ä»¬æ­£åœ¨è°ˆè®ºä¸€ä¸ªäº‹å®ï¼Œå³ä½¿ç”¨GraphQLçš„äººéœ€è¦ç…§é¡¾æˆæƒï¼Œè¯·æ±‚çš„å¤æ‚æ€§ï¼Œç¼“å­˜ï¼ŒN + 1ä¸ªè¯·æ±‚çš„é—®é¢˜ï¼ŒæŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦çš„é™åˆ¶ä»¥åŠå…¶ä»–ä¸€äº›äº‹æƒ…ã€‚ å¦åˆ™ï¼Œä½¿ç”¨GraphQLå¼€å‘çš„ç³»ç»Ÿå¯èƒ½ä¼šä¸¥é‡é™ä½æ€§èƒ½ã€‚ <br><br><h2>  <font color="#3AC1EF">å…ˆè¿›æŠ€æœ¯ï¼šèº«ä»½éªŒè¯ï¼Œæ•°æ®åŠ è½½å™¨ï¼ŒæŸ¥è¯¢å¤æ‚æ€§</font> </h2><br> æ¯æ¬¡é˜…è¯»è¿™æ ·çš„æ‰‹å†Œæ—¶ï¼Œæˆ‘éƒ½ä¼šæ„Ÿè§‰åˆ°ï¼ŒæŒæ¡å®ƒä»¬åï¼Œæˆ‘ä¼šå­¦åˆ°æŸç§æŠ€æœ¯æ‰€éœ€çš„ä¸€åˆ‡çŸ¥è¯†ï¼Œå¹¶å…·æœ‰è§£å†³å„ç§å¤æ‚é—®é¢˜çš„èƒ½åŠ›ã€‚ <br><br> ä½†æ˜¯ï¼Œå½“æˆ‘å¼€å§‹è‡ªå·±çš„é¡¹ç›®æ—¶ï¼Œé€šå¸¸ä¼šé‡åˆ°æ— æ³•é¢„æ–™çš„æƒ…å†µï¼Œä¾‹å¦‚æœåŠ¡å™¨é”™è¯¯æˆ–è¿è¡Œäº†å¾ˆé•¿æ—¶é—´çš„è¯·æ±‚ï¼Œæˆ–å…¶ä»–ä¸€äº›æ­»é”æƒ…å†µã€‚ å› æ­¤ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å¿…é¡»æ›´å¥½åœ°ç ”ç©¶æœ€è¿‘ä¼¼ä¹å®Œå…¨å¯ä»¥ç†è§£çš„å†…å®¹ã€‚ æˆ‘å¸Œæœ›åœ¨åŒä¸€æœ¬æ‰‹å†Œä¸­å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚ å› æ­¤ï¼Œåœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€äº›ä½¿ç”¨GraphQLçš„é«˜çº§æŠ€æœ¯ã€‚ <br><br><h3>  <font color="#3AC1EF">â–è®¤è¯</font> </h3><br> ä½¿ç”¨REST APIæ—¶ï¼Œä½¿ç”¨ç‰¹å®šç«¯ç‚¹æ—¶ï¼Œæˆ‘ä»¬å…·æœ‰èº«ä»½éªŒè¯ç³»ç»Ÿå’Œæ ‡å‡†æˆæƒå·¥å…·ã€‚ ä½†æ˜¯ï¼Œå½“ä½¿ç”¨GraphQLæ—¶ï¼Œä»…ä½¿ç”¨ä¸€ä¸ªç«¯ç‚¹ï¼Œå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨æ¶æ„æŒ‡ä»¤è§£å†³èº«ä»½éªŒè¯ä»»åŠ¡ã€‚ å¦‚ä¸‹ç¼–è¾‘<code>schema.graphql</code>æ–‡ä»¶ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! @isAuthenticated } directive @isAuthenticated on FIELD_DEFINITION</code> </pre> <br> æˆ‘ä»¬åˆ›å»ºäº†<code>isAuthenticated</code>æŒ‡ä»¤ï¼Œå¹¶å°†å…¶åº”ç”¨äº<code>createVideo</code>è®¢é˜…ã€‚ åœ¨ä¸‹ä¸€ä¸ªè‡ªåŠ¨ä»£ç ç”Ÿæˆä¼šè¯ä¹‹åï¼Œæ‚¨éœ€è¦ä¸ºæ­¤æŒ‡ä»¤å®šä¹‰ä¸€ä¸ªå®šä¹‰ã€‚ ç°åœ¨ï¼ŒæŒ‡ä»¤ä»¥ç»“æ„æ–¹æ³•çš„å½¢å¼è€Œä¸æ˜¯æ¥å£çš„å½¢å¼å®ç°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæè¿°ã€‚ æˆ‘ç¼–è¾‘äº†ä½äº<code>server.go</code>æ–‡ä»¶ä¸­çš„è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œå¹¶åˆ›å»ºäº†ä¸€ç§è¿”å›<code>server.go</code>æ–‡ä»¶çš„GraphQLé…ç½®çš„æ–¹æ³•ã€‚ è¿™æ˜¯<code>resolver.go</code>æ–‡ä»¶ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br> è¿™æ˜¯<code>server.go</code>æ–‡ä»¶ï¼š <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware(   db,   handler.GraphQL(     go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)   ) ) http.Handle(<span class="hljs-string"><span class="hljs-string">"/query"</span></span>, auth.AuthMiddleware(rootHandler))</code> </pre> <br> æˆ‘ä»¬ä»ä¸Šä¸‹æ–‡ä¸­è¯»å–ç”¨æˆ·<code>ID</code> ã€‚ ä½ ä¸è§‰å¾—è¿™ä¸ªå¥‡æ€ªå—ï¼Ÿ è¿™ä¸ªå«ä¹‰æ˜¯å¦‚ä½•è¿›å…¥ä¸Šä¸‹æ–‡çš„ï¼Œä¸ºä»€ä¹ˆå®ƒç”šè‡³å‡ºç°åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Ÿ äº‹å®æ˜¯gqlgenä»…åœ¨å®ç°çº§åˆ«æä¾›è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•è¯»å–è¯†åˆ«å™¨æˆ–æŒ‡ä»¤ä¸­çš„ä»»ä½•HTTPè¯·æ±‚æ•°æ®ï¼Œä¾‹å¦‚æ ‡å¤´æˆ–cookieã€‚ ç»“æœï¼Œæ‚¨éœ€è¦å‘ç³»ç»Ÿæ·»åŠ è‡ªå·±çš„ä¸­é—´æœºåˆ¶ï¼Œæ¥æ”¶æ­¤æ•°æ®å¹¶å°†å…¶ç½®äºä¸Šä¸‹æ–‡ä¸­ã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦æè¿°æˆ‘ä»¬è‡ªå·±çš„ä¸­é—´è®¤è¯æœºåˆ¶ï¼Œä»¥ä»è¯·æ±‚ä¸­è·å–è®¤è¯æ•°æ®å¹¶è¿›è¡ŒéªŒè¯ã€‚ <br><br> è¿™é‡Œæ²¡æœ‰å®šä¹‰é€»è¾‘ã€‚ å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå‡ºäºæˆæƒç›®çš„ï¼Œå‡ºäºæ¼”ç¤ºç›®çš„ï¼Œä»…åœ¨æ­¤å¤„ä¼ é€’ç”¨æˆ·<code>ID</code> ã€‚ ç„¶åï¼Œè¯¥æœºåˆ¶åœ¨<code>server.go</code>ä¸æ–°çš„é…ç½®åŠ è½½æ–¹æ³•ç»“åˆåœ¨ä¸€èµ·ã€‚ <br><br> ç°åœ¨ï¼Œè¯¥æŒ‡ä»¤çš„è¯´æ˜æ‰æœ‰æ„ä¹‰ã€‚ æˆ‘ä»¬ä¸ä¼šåœ¨ä¸­é—´ä»¶ä»£ç ä¸­å¤„ç†æœªç»æˆæƒçš„ç”¨æˆ·è¯·æ±‚ï¼Œå› ä¸ºæ­¤ç±»è¯·æ±‚å°†ç”±æŒ‡ä»¤å¤„ç†ã€‚ è¿™æ˜¯å®ƒçš„å¤–è§‚ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/a26/09c/6f6a2609cec8936c024fd68c7ed30096.png"></div><br>  <i><font color="#999999">ä¸æœªç»æˆæƒçš„ç”¨æˆ·ä¸€èµ·å·¥ä½œ</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/267/b92/378/267b923783521a82738973f82600a2a4.png"></div><br>  <i><font color="#999999">ä¸æˆæƒç”¨æˆ·ä¸€èµ·å·¥ä½œ</font></i> <br><br> ä½¿ç”¨æ¨¡å¼æŒ‡ä»¤æ—¶ï¼Œç”šè‡³å¯ä»¥ä¼ é€’å‚æ•°ï¼š <br><br><pre> <code class="go hljs">directive @hasRole(role: Role!) on FIELD_DEFINITION enum Role { ADMIN USER }</code> </pre> <br><h3>  <font color="#3AC1EF">â–æ•°æ®åŠ è½½å™¨</font> </h3><br> åœ¨æˆ‘çœ‹æ¥ï¼Œæ‰€æœ‰è¿™äº›çœ‹èµ·æ¥éƒ½å¾ˆæœ‰è¶£ã€‚ æ‚¨å¯ä»¥åœ¨éœ€è¦æ—¶ä¸‹è½½æ•°æ®ã€‚ å®¢æˆ·ç«¯å…·æœ‰ç®¡ç†æ•°æ®çš„èƒ½åŠ›ï¼›æ‰€éœ€çš„æ­£æ˜¯ä»å­˜å‚¨ä¸­è·å–çš„ã€‚ ä½†æ˜¯ï¼Œä¸€åˆ‡éƒ½æœ‰ä»£ä»·ã€‚ <br><br> ä¸ºè¿™äº›æœºä¼šä»˜å‡ºçš„ä»£ä»·æ˜¯ä»€ä¹ˆï¼Ÿ æŸ¥çœ‹æ‰€æœ‰è§†é¢‘çš„ä¸‹è½½æ—¥å¿—ã€‚ å³ï¼Œæˆ‘ä»¬è°ˆè®ºçš„æ˜¯æˆ‘ä»¬æœ‰8ä¸ªè§†é¢‘å’Œ5ä¸ªç”¨æˆ·çš„äº‹å®ã€‚ <br><br><pre> <code class="go hljs">query{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>){   name   user{     name   } } }</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/562/7c1/b5c/5627c1b5c34f74aec26381f8b0431147.png"></div><br>  <i><font color="#999999">è§†é¢‘ä¸‹è½½è¯¦ç»†ä¿¡æ¯</font></i> <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> è¿™æ˜¯æ€ä¹ˆå›äº‹ ä¸ºä»€ä¹ˆä¼šæœ‰9ä¸ªè¯·æ±‚ï¼ˆå…¶ä¸­1ä¸ªè¯·æ±‚ä¸è§†é¢‘è¡¨ç›¸å…³è”ï¼Œè€Œ8ä¸ªä¸ç”¨æˆ·è¡¨ç›¸å…³è”ï¼‰ï¼Ÿ çœ‹èµ·æ¥ç³Ÿé€äº†ã€‚ å½“æˆ‘ä»¥ä¸ºå¿…é¡»ç”¨è¿™ä¸ªç°æœ‰çš„APIä»£æ›¿ç°æœ‰çš„APIæ—¶ï¼Œæˆ‘çš„å¿ƒå‡ ä¹åœäº†ä¸‹æ¥ã€‚ç¡®å®ï¼Œæ•°æ®åŠ è½½å™¨å¯ä»¥å®Œå…¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ <br><br> è¿™å°±æ˜¯N + 1é—®é¢˜ï¼Œæˆ‘ä»¬æ­£åœ¨è°ˆè®ºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³æœ‰ä¸€ä¸ªæŸ¥è¯¢å¯è·å–æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸”å¯¹äºæ¯æ¡æ•°æ®ï¼ˆNï¼‰ï¼Œè¿˜å°†æœ‰ä¸€ä¸ªæŸ¥è¯¢åˆ°æ•°æ®åº“ã€‚ <br><br> å½“æ¶‰åŠåˆ°æ€§èƒ½å’Œèµ„æºæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼šå°½ç®¡è¿™äº›è¯·æ±‚æ˜¯å¹¶è¡Œçš„ï¼Œä½†å®ƒä»¬ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚ <br><br> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gqlgen</a>åº“ä½œè€…çš„dataloadenåº“ã€‚ è¯¥åº“å…è®¸æ‚¨ç”ŸæˆGoä»£ç ã€‚ é¦–å…ˆï¼Œä¸º<code>User</code>å®ä½“ç”Ÿæˆä¸€ä¸ªæ•°æ®åŠ è½½å™¨ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/vektah/dataloaden dataloaden github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.User</code> </pre> <br> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡ä»¶<code>userloader_gen.go</code> ï¼Œè¯¥æ–‡ä»¶å…·æœ‰<code>Fetch</code> ï¼Œ <code>userloader_gen.go</code>å’Œ<code>Prime</code> ã€‚ <br><br> ç°åœ¨ï¼Œä¸ºäº†è·å¾—ä¸€èˆ¬ç»“æœï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰<code>Fetch</code>æ–¹æ³•ï¼ˆ <code>dataloader.go</code>æ–‡ä»¶ï¼‰ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataloaderMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB, next http.Handler)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handler</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> {   userloader := UserLoader{     wait : <span class="hljs-number"><span class="hljs-number">1</span></span> * time.Millisecond,     maxBatch: <span class="hljs-number"><span class="hljs-number">100</span></span>,     fetch: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]*api.User, []error)</span></span></span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqlQuery <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids) == <span class="hljs-number"><span class="hljs-number">1</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id = ?"</span></span>       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id IN (?)"</span></span>       }       sqlQuery, arguments, err := sqlx.In(sqlQuery, ids)       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       sqlQuery = sqlx.Rebind(sqlx.DOLLAR, sqlQuery)       rows, err := dal.LogAndQuery(db, sqlQuery, arguments...)       <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       userById := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]*api.User{}       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {         user:= api.User{}         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {           errors.DebugPrintf(err)           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, []error{errors.InternalServerError}         }         userById[user.ID] = &amp;user       }       users := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]*api.User, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids))       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, id := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ids {         users[i] = userById[id]         i++       }       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> users, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>     },   }   ctx := context.WithValue(r.Context(), CtxKey, &amp;userloader)   r = r.WithContext(ctx)   next.ServeHTTP(w, r) }) }</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç­‰å¾…1æ¯«ç§’ã€‚ åœ¨æ‰§è¡Œè¯·æ±‚ä¹‹å‰ï¼Œå°†è¯·æ±‚æ”¶é›†åˆ°æœ€å¤š100ä¸ªè¯·æ±‚çš„ç¨‹åºåŒ…ä¸­ã€‚ ç°åœ¨ï¼Œè£…å…¥ç¨‹åºå°†åœ¨è®¿é—®æ•°æ®åº“ä¹‹å‰ç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼Œè€Œä¸æ˜¯åˆ†åˆ«ä¸ºæ¯ä¸ªç”¨æˆ·æ‰§è¡Œè¯·æ±‚ã€‚ æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦é€šè¿‡ä½¿ç”¨ä½¿ç”¨æ•°æ®åŠ è½½å™¨çš„è¯·æ±‚ï¼ˆ <code>resolver.go</code>æ–‡ä»¶ï¼‰é‡æ–°é…ç½®è¯†åˆ«å™¨é€»è¾‘æ¥æ›´æ”¹è¯†åˆ«å™¨é€»è¾‘ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { user, err := ctx.Value(dataloaders.CtxKey).(*dataloaders.UserLoader).Load(obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *user, err }</code> </pre> <br> è¿™æ˜¯åœ¨ä¸ä¸Šè¿°æƒ…å†µç±»ä¼¼çš„æƒ…å†µä¸‹æ—¥å¿—çš„å¤„ç†æ–¹å¼ï¼š <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Dataloader: User : SELECT id, name, email from users WHERE id IN ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>, $<span class="hljs-number"><span class="hljs-number">3</span></span>, $<span class="hljs-number"><span class="hljs-number">4</span></span>, $<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br> æ­¤å¤„ä»…æ‰§è¡Œä¸¤ä¸ªæ•°æ®åº“æŸ¥è¯¢ï¼Œå› æ­¤ï¼Œæ¯ä¸ªäººç°åœ¨éƒ½å¾ˆé«˜å…´ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œå°½ç®¡è¯·æ±‚äº†8ä¸ªè§†é¢‘çš„æ•°æ®ï¼Œä½†ä»…å‘è¯¥è¯·æ±‚å‘é€äº†5ä¸ªç”¨æˆ·æ ‡è¯†ç¬¦ã€‚ è¿™è¡¨æ˜æ•°æ®åŠ è½½å™¨å°†åˆ é™¤é‡å¤çš„è®°å½•ã€‚ <br><br><h3> <font color="#3AC1EF">â– </font> </h3><br> GraphQL   API  ,    .    ,   API   DOS-. <br><br>     ,     . <br><br>   <code>Video</code>  ,   .      GraphQL  <code>Video</code> .           .   â€”  . <br><br>  ,      â€”   : <br><br><pre> <code class="go hljs">{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){   name   url   related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){     name     url     related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){       name       url       related(limit: <span class="hljs-number"><span class="hljs-number">100</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){         name         url       }     }   } } }</code> </pre> <br>           100,        .  (, , )    ,         . <br><br>  gqlgen      ,     .     ,       ( <code>handler.ComplexityLimit(300)</code>   )   GraphQL     (300   ).  ,     ( <code>server.go</code> ): <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware( db, handler.GraphQL(   go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)),   handler.ComplexityLimit(<span class="hljs-number"><span class="hljs-number">300</span></span>) ), )</code> </pre> <br>       ,   ,        .        12.   ,       ,   ,      ( ,  ,  ,   ,     ).    <code>resolver.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//  countComplexity := func(childComplexity int, limit *int, offset *int) int {   return *limit * childComplexity } c.Complexity.Query.Videos = countComplexity c.Complexity.Video.Related = countComplexity //   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br>     ,     ,       . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0a/702/045/d0a7020450bf5115f69c6a1ba61beca4.png"></div><br> <i><font color="#999999">    </font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/057/fec/7e3/057fec7e30f98b63aed8bbb6aec5193f.png"></div><br> <i><font color="#999999">      </font></i> <br><br>       ,   ,   <code>related</code>  . , , ,      ,             . <br><br><h2>  <font color="#3AC1EF">æ€»ç»“</font> </h2><br> ,        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a> .         .       ,     ,      . <br><br>  <b>äº²çˆ±çš„è¯»è€…ä»¬ï¼</b>     GraphQL  ,   Go? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444346/">https://habr.com/ru/post/zh-CN444346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444336/index.html">Swiftæ•è·åˆ—è¡¨ï¼šå¼±é“¾æ¥ï¼Œå¼ºé“¾æ¥å’Œæ— ä¸»é“¾æ¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a></li>
<li><a href="../zh-CN444338/index.html">Python 3ä¸­çš„å°è£…</a></li>
<li><a href="../zh-CN444340/index.html">åœ¨JavaScriptä¸­ä½¿ç”¨Symbolæ•°æ®ç±»å‹çš„åŠŸèƒ½</a></li>
<li><a href="../zh-CN444342/index.html">ä½¿ç”¨Webpackå’Œé«˜çº§WebæŠ€æœ¯å¼€å‘ç®€å•ï¼Œç°ä»£çš„JavaScriptåº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN444344/index.html">æˆåŠŸçš„Pythoné¡¹ç›®çš„10ä¸ªæ­¥éª¤</a></li>
<li><a href="../zh-CN444348/index.html">åŠŸèƒ½æ€§Reactç»„ä»¶ä¸åŸºäºç±»çš„ç»„ä»¶æœ‰ä½•ä¸åŒï¼Ÿ</a></li>
<li><a href="../zh-CN444350/index.html">ç”±äºæŸäº›åŸå› ï¼ŒMVPï¼ˆæœ€ä½å¯è¡Œäº§å“ï¼‰æ— æ³•å¯åŠ¨</a></li>
<li><a href="../zh-CN444352/index.html">Kontur.Kampusï¼šæˆ‘ä»¬é‚€è¯·æ‚¨å‚è§‚åœ£å½¼å¾—å ¡é™„è¿‘çš„å·¥ä¸šå‘å±•å…è´¹å­¦ç”Ÿè¥</a></li>
<li><a href="../zh-CN444356/index.html">Reactæ•™ç¨‹ç¬¬24éƒ¨åˆ†ï¼šç¬¬äºŒå½¢å¼è¯¾</a></li>
<li><a href="../zh-CN444358/index.html">å¯æšä¸¾ï¼šå¦‚ä½•äº§ç”Ÿä¸šåŠ¡ä»·å€¼</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>