<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ต๏ธ ๐คฑ๐พ ๐คน๐ฟ System.IO.Pipelines: IO ุนุงูู ุงูุฃุฏุงุก ูู .NET ๐ฉ๐ผโ๐พ โ๏ธ ๐จ๐ปโ๐ค</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="System.IO.Pipelines ูู ููุชุจุฉ ุฌุฏูุฏุฉ ุชุจุณุท ุชูุธูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู .NET. ูู ุงูุตุนุจ ุถูุงู ุงูุฃุฏุงุก ุงูุนุงูู ูุงูุฏูุฉ ุฅุฐุง ูุงู ุนููู ุงูุชุนุงูู ูุน ุงูุชุนูููุงุช ุงูุจุฑูุฌู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>System.IO.Pipelines: IO ุนุงูู ุงูุฃุฏุงุก ูู .NET</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/423105/" style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">System.IO.Pipelines</a> ูู ููุชุจุฉ ุฌุฏูุฏุฉ ุชุจุณุท ุชูุธูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู .NET.  ูู ุงูุตุนุจ ุถูุงู ุงูุฃุฏุงุก ุงูุนุงูู ูุงูุฏูุฉ ุฅุฐุง ูุงู ุนููู ุงูุชุนุงูู ูุน ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุนูุฏุฉ.  ุชุชูุซู ูููุฉ System.IO.Pipelines ูู ุชุจุณูุท ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ.  ูุฒูุฏ ูู ุงูุชูุงุตูู ุชุญุช ุงูุฎูุถ! <br><br><img src="https://habrastorage.org/webt/nq/me/p-/nqmep-tqvyyv5nlkpcxjnmlw8z4.jpeg"><a name="habracut"></a><br><br>  ูุดุฃุช ุงูููุชุจุฉ ูุชูุฌุฉ ูุฌููุฏ ูุฑูู ุชุทููุฑ .NET Core ูุฌุนู Kestrel ุฃุญุฏ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุณุฑุน ุฎูุงุฏู ุงูููุจ ูู ุงูุตูุงุนุฉ</a> .  ุชู ุชุตูููู ูู ุงูุฃุตู ูุฌุฒุก ูู ุชูููุฐ Kestrel ุ ููููู ุชุทูุฑ ุฅูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ูุงุจูุฉ ูุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู ุ ูุชููุฑุฉ ูู ุงูุฅุตุฏุงุฑ 2.1 ููุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช BCL ูู ุงูุฏุฑุฌุฉ ุงูุฃููู (System.IO.Pipelines). <br><br><h2 style=";text-align:right;direction:rtl">  ูุง ูู ุงููุดุงูู ุงูุชู ุชุญููุงุ </h2><br>  ูุชุญููู ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ ูู ุฏูู ุฃู ูุฃุฎุฐ ุ ุชุญุชุงุฌ ุฅูู ูุชุงุจุฉ ูููุฉ ูุจูุฑุฉ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูููุงุณูุฉ.  ูู ุงูููุช ููุณู ุ ููุงู ุงูุนุฏูุฏ ูู ุงููุฒุงูู ุงูุชู ุชุนูุฏ ุงูููุฏ ููุณู ูุฏุนูู. <br><br><h2 style=";text-align:right;direction:rtl">  ูุง ุงูุตุนูุจุงุช ุงูุชู ุชูุดุฃ ุงููููุ </h2><br>  ููุจุฏุฃ ุจูููุฉ ุจุณูุทุฉ.  ูุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุฎุงุฏู TCP ูุชููู ุฑุณุงุฆู ููุตููุฉ ุจุฎุท (\ n) ูู ุงูุนููู. <br><br><h2 style=";text-align:right;direction:rtl">  ุฎุงุฏู TCP ูุน NetworkStream </h2><br>  ุงูุงูุญุฑุงู: ููุง ูู ุงูุญุงู ูู ุฃู ูููุฉ ุชุชุทูุจ ุฃุฏุงุกู ุนุงูููุง ุ ูุฌุจ ุงููุธุฑ ูู ูู ุญุงูุฉ ูุญุฏุฏุฉ ุจูุงุกู ุนูู ููุฒุงุช ุงูุชุทุจูู ุงูุฎุงุต ุจู.  ูุฏ ูุง ูููู ูู ุงูููุทูู ุฅููุงู ุงูููุงุฑุฏ ุนูู ุงุณุชุฎุฏุงู ุงูููุงูุฌ ุงููุฎุชููุฉ ุ ูุงูุชู ุณูุชู ููุงูุดุชูุง ูุงุญููุง ุ ุฅุฐุง ูู ููู ุญุฌู ุชุทุจูู ุงูุดุจูุฉ ูุจูุฑูุง ุฌุฏูุง. <br><br>  ูุจุฏู ุฑูุฒ .NET ุงูุนุงุฏู ูุจู ุงุณุชุฎุฏุงู ุฎุทูุท ุงูุฃูุงุจูุจ ุดูุฆูุง ูุซู ูุฐุง: <br><br><pre style=";text-align:right;direction:rtl"><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.ReadAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer.Length); <span class="hljs-comment"><span class="hljs-comment">// Process a single line from the buffer ProcessLine(buffer); }</span></span></code> </pre> <br>  ุฑุงุฌุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample1.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a> <br><br>  ูู ุงููุญุชูู ุฃู ูุนูู ูุฐุง ุงูุฑูุฒ ูุน ุงูุงุฎุชุจุงุฑ ุงููุญูู ุ ูููู ุจู ุนุฏุฏ ูู ุงูุฃุฎุทุงุก: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฑุจูุง ุจุนุฏ ููุงููุฉ ูุงุญุฏุฉ ุฅูู ReadAsync ุ ูู ูุชู ุชููู ุงูุฑุณุงูุฉ ุจุงููุงูู (ุฅูู ููุงูุฉ ุงูุณุทุฑ). </li><li style=";text-align:right;direction:rtl">  ูุชุฌุงูู ูุชูุฌุฉ ุทุฑููุฉ stream.ReadAsync () - ูููุฉ ุงูุจูุงูุงุช ุงููููููุฉ ุจุงููุนู ุฅูู ุงููุฎุฒู ุงููุคูุช. </li><li style=";text-align:right;direction:rtl">  ูุง ูุชุนุงูู ุงูุฑูุฒ ูุน ุชููู ุฎุทูุท ูุชุนุฏุฏุฉ ูู ููุงููุฉ ReadAsync ูุงุญุฏุฉ. </li></ul><br>  ูุฐู ูู ุฃุฎุทุงุก ูุฑุงุกุฉ ุจูุงูุงุช ุงูุฏูู ุงูุฃูุซุฑ ุดููุนูุง.  ูุชุฌูุจูุง ุ ุชุญุชุงุฌ ุฅูู ุฅุฌุฑุงุก ุนุฏุฏ ูู ุงูุชุบููุฑุงุช: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุญุชุงุฌ ุฅูู ุชุฎุฒูู ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ ูุคูุชูุง ุญุชู ูุชู ุงูุนุซูุฑ ุนูู ุฎุท ุฌุฏูุฏ. </li><li style=";text-align:right;direction:rtl">  ูู ุงูุถุฑูุฑู ุชุญููู ุฌููุน ุงูุฃุณุทุฑ ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ุฅูู ุงููุฎุฒู ุงููุคูุช. </li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesBuffered = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesRead = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.ReadAsync(buffer, bytesBuffered, buffer.Length - bytesBuffered); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytesRead == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// EOF break; } // Keep track of the amount of buffered bytes bytesBuffered += bytesRead; var linePosition = -1; do { // Look for a EOL in the buffered data linePosition = Array.IndexOf(buffer, (byte)'\n', bytesConsumed, bytesBuffered - bytesConsumed); if (linePosition &gt;= 0) { // Calculate the length of the line based on the offset var lineLength = linePosition - bytesConsumed; // Process the line ProcessLine(buffer, bytesConsumed, lineLength); // Move the bytesConsumed to skip past the line we consumed (including \n) bytesConsumed += lineLength + 1; } } while (linePosition &gt;= 0); } }</span></span></code> </pre> <br>  ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample2.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a> <br><br>  ุฃูุฑุฑ: ูููู ุฃู ูุนูู ูุฐุง ูุน ุงูุงุฎุชุจุงุฑ ุงููุญูู ุ ูููู ูู ุจุนุถ ุงูุฃุญูุงู ูููู ููุงู ุณูุงุณู ุฃุทูู ูู 1 ูููู ุจุงูุช (1024 ุจุงูุช).  ูู ุงูุถุฑูุฑู ุฒูุงุฏุฉ ุญุฌู ูุฎุฒู ุงูุฅุฏุฎุงู ุงููุคูุช ุญุชู ูุชู ุงูุนุซูุฑ ุนูู ุฎุท ุฌุฏูุฏ. <br><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูููู ุจุชุฌููุน ุงููุฎุงุฒู ุงููุคูุชุฉ ูู ุตููู ุนูุฏ ูุนุงูุฌุฉ ุณูุงุณู ุทูููุฉ.  ูููููุง ุชุญุณูู ูุฐู ุงูุนูููุฉ ุจุงุณุชุฎุฏุงู ArrayPool ุ ุงูุชู ุชุชุฌูุจ ุฅุนุงุฏุฉ ุชุฎุตูุต ุงููุฎุงุฒู ุงููุคูุชุฉ ุฃุซูุงุก ุชุญููู ุงูุฎุทูุท ุงูุทูููุฉ ูู ุงูุนููู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;.Shared.Rent(<span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesBuffered = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Calculate the amount of bytes remaining in the buffer var bytesRemaining = buffer.Length - bytesBuffered; if (bytesRemaining == 0) { // Double the buffer size and copy the previously buffered data into the new buffer var newBuffer = ArrayPool&lt;byte&gt;.Shared.Rent(buffer.Length * 2); Buffer.BlockCopy(buffer, 0, newBuffer, 0, buffer.Length); // Return the old buffer to the pool ArrayPool&lt;byte&gt;.Shared.Return(buffer); buffer = newBuffer; bytesRemaining = buffer.Length - bytesBuffered; } var bytesRead = await stream.ReadAsync(buffer, bytesBuffered, bytesRemaining); if (bytesRead == 0) { // EOF break; } // Keep track of the amount of buffered bytes bytesBuffered += bytesRead; do { // Look for a EOL in the buffered data linePosition = Array.IndexOf(buffer, (byte)'\n', bytesConsumed, bytesBuffered - bytesConsumed); if (linePosition &gt;= 0) { // Calculate the length of the line based on the offset var lineLength = linePosition - bytesConsumed; // Process the line ProcessLine(buffer, bytesConsumed, lineLength); // Move the bytesConsumed to skip past the line we consumed (including \n) bytesConsumed += lineLength + 1; } } while (linePosition &gt;= 0); } }</span></span></code> </pre> <br>  <i>ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample3.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a></i> <br><br>  ูุนูู ุงูุฑูุฒ ุ ูููู ุงูุขู ุชุบูุฑ ุญุฌู ุงููุฎุฒู ุงููุคูุช ุ ููุชูุฌุฉ ูุฐูู ุ ุชุธูุฑ ุงูุนุฏูุฏ ูู ุงููุณุฎ ููู.  ูุชู ุงุณุชุฎุฏุงู ุงููุฒูุฏ ูู ุงูุฐุงูุฑุฉ ุฃูุถูุง ุ ูุฃู ุงูููุทู ูุง ูููู ูู ุงููุฎุฒู ุงููุคูุช ุจุนุฏ ูุนุงูุฌุฉ ุงูุฎุทูุท.  ูุชุฌูุจ ุฐูู ุ ููููู ุญูุธ ูุงุฆูุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุ ุจุฏูุงู ูู ุชุบููุฑ ุญุฌู ุงููุฎุฒู ุงููุคูุช ูู ูู ูุฑุฉ ุชุตู ุณูุณูุฉ ุฃุทูู ูู 1 ูููู ุจุงูุช. <br><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุญู ูุง ูุฒูุฏ ุญุฌู ุงููุฎุฒู ุงููุคูุช ุงูุฐู ูุจูุบ 1 ููููุจุงูุช ุ ุญุชู ูุตุจุญ ูุงุฑุบูุง ุชูุงููุง.  ูุฐุง ูุนูู ุฃููุง ุณูููู ูุฎุงุฒู ุฃุตุบุฑ ูุฃุตุบุฑ ุฅูู ReadAsync ุ ููุชูุฌุฉ ูุฐูู ุ ุณูุฒุฏุงุฏ ุนุฏุฏ ุงูููุงููุงุช ุฅูู ูุธุงู ุงูุชุดุบูู. <br><br>  ุณูุญุงูู ุงูุชุฎูุต ูู ูุฐุง ูุณูุฎุตุต ูุฎุฒููุง ูุคูุชูุง ุฌุฏูุฏูุง ุจูุฌุฑุฏ ุฃู ูุตุจุญ ุญุฌู ุงููุฎุฒู ุงูุญุงูู ุฃูู ูู 512 ุจุงูุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BufferSegment</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Buffer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Count { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Remaining =&gt; Buffer.Length - Count; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minimumBufferSize = <span class="hljs-number"><span class="hljs-number">512</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BufferSegment&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumedBufferIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segment = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferSegment { Buffer = ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;.Shared.Rent(<span class="hljs-number"><span class="hljs-number">1024</span></span>) }; segments.Add(segment); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Calculate the amount of bytes remaining in the buffer if (segment.Remaining &lt; minimumBufferSize) { // Allocate a new segment segment = new BufferSegment { Buffer = ArrayPool&lt;byte&gt;.Shared.Rent(1024) }; segments.Add(segment); } var bytesRead = await stream.ReadAsync(segment.Buffer, segment.Count, segment.Remaining); if (bytesRead == 0) { break; } // Keep track of the amount of buffered bytes segment.Count += bytesRead; while (true) { // Look for a EOL in the list of segments var (segmentIndex, segmentOffset) = IndexOf(segments, (byte)'\n', bytesConsumedBufferIndex, bytesConsumed); if (segmentIndex &gt;= 0) { // Process the line ProcessLine(segments, segmentIndex, segmentOffset); bytesConsumedBufferIndex = segmentOffset; bytesConsumed = segmentOffset + 1; } else { break; } } // Drop fully consumed segments from the list so we don't look at them again for (var i = bytesConsumedBufferIndex; i &gt;= 0; --i) { var consumedSegment = segments[i]; // Return all segments unless this is the current segment if (consumedSegment != segment) { ArrayPool&lt;byte&gt;.Shared.Return(consumedSegment.Buffer); segments.RemoveAt(i); } } } } (int segmentIndex, int segmentOffest) IndexOf(List&lt;BufferSegment&gt; segments, byte value, int startBufferIndex, int startSegmentOffset) { var first = true; for (var i = startBufferIndex; i &lt; segments.Count; ++i) { var segment = segments[i]; // Start from the correct offset var offset = first ? startSegmentOffset : 0; var index = Array.IndexOf(segment.Buffer, value, offset, segment.Count - offset); if (index &gt;= 0) { // Return the buffer index and the index within that segment where EOL was found return (i, index); } first = false; } return (-1, -1); }</span></span></code> </pre> <br>  <i>ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample4.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a></i> <br><br>  ููุชูุฌุฉ ูุฐูู ุ ูุฅู ุงูุฑูุฒ ูุนูุฏ ุจุดูู ูุจูุฑ.  ุฃุซูุงุก ุงูุจุญุซ ุนู ุงููุญุฏุฏ ุ ูุชุชุจุน ุงููุฎุงุฒู ุงููุคูุชุฉ ุงููุนุจุฃุฉ.  ููููุงู ุจุฐูู ุ ุงุณุชุฎุฏู ูุงุฆูุฉ ุชุนุฑุถ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุคูุชูุง ุนูุฏ ุงูุจุญุซ ุนู ูุงุตู ุฃุณุทุฑ ุฌุฏูุฏ.  ูุชูุฌุฉ ูุฐูู ุ ุณููุจู ProcessLine ู IndexOf ุงููุงุฆูุฉ ุจุฏูุงู ูู ุงูุจุงูุช [] ูุงูุฅุฒุงุญุฉ ูุงูุนุฏ.  ุณูุจุฏุฃ ููุทู ุงูุชุญููู ูู ูุนุงูุฌุฉ ุฌุฒุก ูุงุญุฏ ูู ุงููุฎุฒู ุงููุคูุช ุฃู ุฃูุซุฑ. <br><br>  ูุงูุขู ุณูููู ุงูุฎุงุฏู ุจูุนุงูุฌุฉ ุงูุฑุณุงุฆู ุงูุฌุฒุฆูุฉ ูุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุงููุดุชุฑูุฉ ูุชูููู ุงูุงุณุชููุงู ุงูููู ููุฐุงูุฑุฉ.  ููุน ุฐูู ุ ูุฌุจ ุฅุฌุฑุงุก ุนุฏุฏ ูู ุงูุชุบููุฑุงุช: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ArrayPoolbyte ูุณุชุฎุฏู ููุท Byte [] - ุงููุตูููุงุช ุงููุฏุงุฑุฉ ุจุดูู ููุงุณู.  ุจูุนูู ุขุฎุฑ ุ ุนูุฏูุง ูุชู ุชูููุฐ ูุธุงุฆู ReadAsync ุฃู WriteAsync ุ ุชุฑุชุจุท ูุชุฑุฉ ุตูุงุญูุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุจููุช ุงูุนูููุฉ ุบูุฑ ุงููุชุฒุงููุฉ (ููุชูุงุนู ูุน ูุงุฌูุงุช ุจุฑูุฌุฉ ุชุทุจููุงุช ุงูุฅุฏุฎุงู / ุงูุฅุฎุฑุงุฌ ุงูุฎุงุตุฉ ุจูุธุงู ุงูุชุดุบูู).  ูุธุฑูุง ูุฃูู ูุง ูููู ููู ุงูุฐุงูุฑุฉ ุงููุซุจุชุฉ ุ ูุฅู ูุฐุง ูุคุซุฑ ุนูู ุฃุฏุงุก ุฌุงูุน ุงูููุงูุฉ ููููู ุฃู ูุณุจุจ ุชุฌุฒุฆุฉ ุงูุตููู.  ูุฏ ุชุญุชุงุฌ ุฅูู ุชุบููุฑ ุชูููุฐ ุงูุชุฌูุน ุ ุงุนุชูุงุฏูุง ุนูู ุงููุฏุฉ ุงูุชู ุณุชูุชุธุฑูุง ุงูุนูููุงุช ุบูุฑ ุงููุชุฒุงููุฉ ููุชูููุฐ. </li><li style=";text-align:right;direction:rtl">  ูููู ุชุญุณูู ุงูุฅูุชุงุฌูุฉ ุนู ุทุฑูู ูุทุน ุงูุงุฑุชุจุงุท ุจูู ููุทู ุงููุฑุงุกุฉ ูุงูุนูููุฉ.  ูุญุตู ุนูู ุชุฃุซูุฑ ุงููุนุงูุฌุฉ ุงููุฌูุนุฉ ุ ูุงูุขู ุณูููู ููุทู ุงูุชุญููู ูุงุฏุฑูุง ุนูู ูุฑุงุกุฉ ูููุงุช ูุจูุฑุฉ ูู ุงูุจูุงูุงุช ุ ููุนุงูุฌุฉ ูุชู ูุจูุฑุฉ ูู ุงููุฎุงุฒู ุงููุคูุชุฉ ุ ุจุฏูุงู ูู ุชุญููู ุงูุฎุทูุท ุงููุฑุฏูุฉ.  ููุชูุฌุฉ ูุฐูู ุ ูุตุจุญ ุงูุฑูุฒ ุฃูุซุฑ ุชุนููุฏูุง: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ุงูุถุฑูุฑู ุฅูุดุงุก ุฏูุฑุชูู ุชุนููุงู ุจุดูู ูุณุชูู ุนู ุจุนุถููุง ุงูุจุนุถ.  ุณููุฑุฃ ุงูุฃูู ุงูุจูุงูุงุช ูู ุงูููุจุณ ุ ูุงูุซุงูู ุณูุญูู ุงููุฎุงุฒู ุงููุคูุชุฉ. </li><li style=";text-align:right;direction:rtl">  ุงููุทููุจ ูู ุทุฑููุฉ ูุฅุฎุจุงุฑ ููุทู ุงูุชุญููู ุจุฃู ุงูุจูุงูุงุช ุฃุตุจุญุช ูุชุงุญุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ุงูุถุฑูุฑู ุฃูุถูุง ุชุญุฏูุฏ ูุง ูุญุฏุซ ุฅุฐุง ูุงูุช ุงูุญููุฉ ุชูุฑุฃ ุงูุจูุงูุงุช ูู ุงูููุจุณ ุจุณุฑุนุฉ ูุจูุฑุฉ.  ูุญุชุงุฌ ุฅูู ุทุฑููุฉ ูุถุจุท ุฏูุฑุฉ ุงููุฑุงุกุฉ ุฅุฐุง ูุงู ููุทู ุงูุชุญููู ูุง ููุงูุจูุง.  ููุดุงุฑ ุฅูู ุฐูู ุนุงุฏุฉ ุจุงุณู "ุงูุชุญูู ูู ุงูุชุฏูู" ุฃู "ููุงููุฉ ุงูุชุฏูู". </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ูุชุฃูุฏ ูู ุฅุฑุณุงู ุงูุจูุงูุงุช ุจุดูู ุขูู.  ุงูุขู ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ูู ูุจู ูู ูู ุฏูุฑุฉ ุงููุฑุงุกุฉ ูุฏูุฑุฉ ุงูุชุญููู ุ ููู ุชุนูู ุจุดูู ูุณุชูู ุนู ุจุนุถูุง ุงูุจุนุถ ุนูู ุณูุงุณู ูุฎุชููุฉ. </li><li style=";text-align:right;direction:rtl">  ูุดุชุฑู ููุทู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุฃูุถูุง ูู ุฌุฒุฃูู ูุฎุชูููู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ: ุงุณุชุนุงุฑุฉ ุงูุจูุงูุงุช ูู ุชุฌูุน ุงููุฎุฒู ุงููุคูุช ุ ุงูุฐู ููุฑุฃ ุงูุจูุงูุงุช ูู ุงูููุจุณ ุ ูุงูุนูุฏุฉ ูู ุชุฌูุน ุงููุฎุฒู ุงููุคูุช ุ ููู ููุทู ุงูุชุญููู. </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุนูู ุงููุฑุก ุชูุฎู ุงูุญุฐุฑ ุงูุดุฏูุฏ ูู ุฅุนุงุฏุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุจุนุฏ ุชูููุฐ ููุทู ุงูุชุญููู.  ุฎูุงู ุฐูู ุ ููุงู ูุฑุตุฉ ุจุฃู ูุนูุฏ ุงููุฎุฒู ุงููุคูุช ุงูุฐู ูุง ูุฒุงู ููุชุจ ููู ููุทู ูุฑุงุกุฉ ูุฃุฎุฐ ุงูุชูุตูู. </li></ul></li></ol><br>  ูุจุฏุฃ ุงูุชุนููุฏ ุจุงููุฑูุฑ ูู ุงูุณูู (ููุฐุง ุจุนูุฏ ุนู ูู ุงูุญุงูุงุช!).  ูุฅูุดุงุก ุดุจูุฉ ุนุงููุฉ ุงูุฃุฏุงุก ุ ุชุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุฑูุฒ ูุนูุฏ ููุบุงูุฉ. <br><br>  ุงูุบุฑุถ ูู System.IO.Pipelines ูู ุชุจุณูุท ูุฐุง ุงูุฅุฌุฑุงุก. <br><br><h4 style=";text-align:right;direction:rtl">  ุฎุงุฏู TCP ู System.IO.Pipelines </h4><br>  ุฏุนููุง ูุฑู ููู ูุนูู System.IO.Pipelines: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Socket socket</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pipe = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pipe(); Task writing = FillPipeAsync(socket, pipe.Writer); Task reading = ReadPipeAsync(pipe.Reader); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.WhenAll(reading, writing); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FillPipeAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Socket socket, PipeWriter writer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minimumBufferSize = <span class="hljs-number"><span class="hljs-number">512</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Allocate at least 512 bytes from the PipeWriter Memory&lt;byte&gt; memory = writer.GetMemory(minimumBufferSize); try { int bytesRead = await socket.ReceiveAsync(memory, SocketFlags.None); if (bytesRead == 0) { break; } // Tell the PipeWriter how much was read from the Socket writer.Advance(bytesRead); } catch (Exception ex) { LogError(ex); break; } // Make the data available to the PipeReader FlushResult result = await writer.FlushAsync(); if (result.IsCompleted) { break; } } // Tell the PipeReader that there's no more data coming writer.Complete(); } async Task ReadPipeAsync(PipeReader reader) { while (true) { ReadResult result = await reader.ReadAsync(); ReadOnlySequence&lt;byte&gt; buffer = result.Buffer; SequencePosition? position = null; do { // Look for a EOL in the buffer position = buffer.PositionOf((byte)'\n'); if (position != null) { // Process the line ProcessLine(buffer.Slice(0, position.Value)); // Skip the line + the \n character (basically position) buffer = buffer.Slice(buffer.GetPosition(1, position.Value)); } } while (position != null); // Tell the PipeReader how much of the buffer we have consumed reader.AdvanceTo(buffer.Start, buffer.End); // Stop reading if there's no more data coming if (result.IsCompleted) { break; } } // Mark the PipeReader as complete reader.Complete(); }</span></span></code> </pre> <br>  <i>ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample5.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a></i> <br><br>  ุชุญุชูู ูุณุฎุฉ ุฎุท ุงูุฃูุงุจูุจ ูู ูุงุฑุฆ ุงูุฎุท ุนูู ุญููุชูู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุฑุฃ FillPipeAsync ูู ูุฃุฎุฐ ุงูุชูุตูู ูููุชุจ ุฅูู PipeWriter. </li><li style=";text-align:right;direction:rtl">  ููุฑุฃ ReadPipeAsync ูู PipeReader ูููุฒุน ุงูุฎุทูุท ุงููุงุฑุฏุฉ. </li></ul><br>  ุนูู ุนูุณ ุงูุฃูุซูุฉ ุงูุฃููู ุ ูุง ุชูุฌุฏ ูุฎุงุฒู ูุคูุชุฉ ูุฎุตุตุฉ ููุฐุง ุงูุบุฑุถ.  ูุฐู ุฅุญุฏู ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ ูู System.IO.Pipelines.  ูุชู ููู ุฌููุน ููุงู ุฅุฏุงุฑุฉ ุงููุฎุฒู ุงููุคูุช ุฅูู ุชุทุจููุงุช PipeReader / PipeWriter. <br><br>  ุงูุฅุฌุฑุงุก ูุจุณุท: ูุณุชุฎุฏู ุงูููุฏ ููุท ูููุทู ุงูุฃุนูุงู ุ ุจุฏูุงู ูู ุชุทุจูู ุฅุฏุงุฑุฉ ุงููุฎุฒู ุงููุคูุช ุงููุนูุฏุฉ. <br><br>  ูู ุงูุญููุฉ ุงูุฃููู ุ ูุชู ุงุณุชุฏุนุงุก PipeWriter.GetMemory (int) ุฃููุงู ููุญุตูู ุนูู ูุฏุฑ ูุนูู ูู ุงูุฐุงูุฑุฉ ูู ุงููุงุชุจ ุงูุฑุฆูุณู.  ุซู ูุชู ุงุณุชุฏุนุงุก PipeWriter.Advance (int) ุ ูุงูุฐู ูุฎุจุฑ PipeWriter ุจููุฏุงุฑ ุงูุจูุงูุงุช ุงูููุชูุจุฉ ุจุงููุนู ุฅูู ุงููุฎุฒู ุงููุคูุช.  ููุชุจุน ุฐูู ุงุณุชุฏุนุงุก PipeWriter.FlushAsync () ุจุญูุซ ูููู PipeReader ุงููุตูู ุฅูู ุงูุจูุงูุงุช. <br><br>  ุชุณุชููู ุงูุญููุฉ ุงูุซุงููุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุงูุชู ูุชุจูุง PipeWriter ูููู ุชู ุงุณุชูุงููุง ูู ุงูุฃุตู ูู ุงูููุจุณ.  ุนูุฏูุง ูุชู ุฅุฑุฌุงุน ุงูุทูุจ ุฅูู PipeReader.ReadAsync () ุ ูุญุตู ุนูู ReadResult ูุญุชูู ุนูู ุฑุณุงูุชูู ูููุชูู: ุงูุจูุงูุงุช ุงูุชู ูุชู ูุฑุงุกุชูุง ูู ุงููููุฐุฌ ReadOnlySequence ุ ุจุงูุฅุถุงูุฉ ุฅูู ููุน ุงูุจูุงูุงุช ุงูููุทููุฉ IsCompleted ุ ูุงูุชู ุชุฎุจุฑ ุงููุงุฑุฆ ูุง ุฅุฐุง ูุงู ุงููุงุชุจ ูุฏ ุงูุชูู ูู ุงูุนูู (EOF).  ุนูุฏูุง ูุชู ุงูุนุซูุฑ ุนูู ุญุฑู ููุงูุฉ ุงูุฎุท (EOL) ููุชู ุชุญููู ุงูุณูุณูุฉ ุ ุณูููู ุจุชูุณูู ุงููุฎุฒู ุงููุคูุช ุฅูู ุฃุฌุฒุงุก ูุชุฎุทู ุงูุฌุฒุก ุงูุฐู ุชูุช ูุนุงูุฌุชู ุจุงููุนู.  ุจุนุฏ ุฐูู ุ ูุชู ุงุณุชุฏุนุงุก PipeReader.AdvanceTo ููุฎุจุฑ PipeReader ุนู ูููุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุงุณุชููุงููุง. <br><br>  ูู ููุงูุฉ ูู ุฏูุฑุฉ ุ ููุชูู ูู ูู ุงููุงุฑุฆ ูุงููุงุชุจ.  ููุชูุฌุฉ ูุฐูู ุ ุชุทูู ุงูููุงุฉ ุงูุฑุฆูุณูุฉ ุฌููุน ุงูุฐุงูุฑุฉ ุงููุฎุตุตุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  System.io.pipelines </h2><br><h4 style=";text-align:right;direction:rtl">  ูุฑุงุกุฉ ุฌุฒุฆูุฉ </h4><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุ ูุคุฏู System.IO.Pipelines ูุธููุฉ ูููุฉ ุฃุฎุฑู: ููู ูููู ุจูุณุญ ุงูุจูุงูุงุช ูู ุงูููุงุฉ ุ ููููู ูุง ูุณุชููููุง. <br><br>  ูุญุชูู PipeReader ุนูู ูุงุฌูุชูู ุฑุฆูุณูุชูู API: ReadAsync ู AdvanceTo.  ูุชููู ReadAsync ุจูุงูุงุช ูู ุงูููุงุฉ ุ ูุฎุจุฑ AdvanceTo ูููุน TubeReader ุฃู ุงููุงุฑุฆ ูู ูุนุฏ ูุทููุจูุง ูู ุงููุงุฑุฆ ุ ูุฐุง ููููู ุงูุชุฎูุต ูููุง (ุนูู ุณุจูู ุงููุซุงู ุ ุฅุนุงุฏุชูุง ุฅูู ุชุฌูุน ุงููุฎุฒู ุงููุคูุช ุงูุฑุฆูุณู). <br><br>  ูููุง ููู ูุซุงู ููุญูู HTTP ุงูุฐู ููุฑุฃ ุงูุจูุงูุงุช ูู ูุฎุงุฒู ุจูุงูุงุช ุงูููุงุฉ ุงูุฌุฒุฆูุฉ ุญุชู ูุชููู ุฎุท ุจุฏุงูุฉ ููุงุณุจ. <br><br><img src="https://habrastorage.org/webt/9c/lp/d8/9clpd8h1r6b1m1jrwultkuggw6i.png"><br><br><h2 style=";text-align:right;direction:rtl">  ReadOnlySequenceT </h2><br>  ูุฎุฒู ุชูููุฐ ุงูููุงุฉ ูุงุฆูุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุฐุงุช ุงูุตูุฉ ุงูุชู ุชู ุชูุฑูุฑูุง ุจูู PipeWriter ู PipeReader.  ูุนุฑุถ PipeReader.ReadAsync ReadOnlySequence ุ ููู ููุน ุฌุฏูุฏ ูู BCL ููุชููู ูู ููุทุน ReadOnlyMemory &lt;T&gt; ูุงุญุฏ ุฃู ุฃูุซุฑ.  ุฅูู ูุดุจู Span ุฃู Memory ุ ููุง ูููุญูุง ุงููุฑุตุฉ ูููุธุฑ ูู ุงููุตูููุงุช ูุงูุฃูุชุงุฑ. <br><br><img src="https://habrastorage.org/webt/79/y0/kw/79y0kwylohggq941soblji6qd2o.png"><br><br>  ููุฌุฏ ุฏุงุฎู ุงูููุงุฉ ูุคุดุฑุงุช ุชูุถุญ ููุงู ูุฌูุฏ ุงููุงุฑุฆ ูุงููุงุชุจ ูู ุงููุฌููุนุฉ ุงูุนุงูุฉ ููุจูุงูุงุช ุงููููุฒุฉ ุ ููุง ูุชู ุชุญุฏูุซูุง ุฃุซูุงุก ูุชุงุจุฉ ุงูุจูุงูุงุช ููุฑุงุกุชูุง.  SequencePosition ูู ููุทุฉ ูุงุญุฏุฉ ูู ูุงุฆูุฉ ุงููุฎุงุฒู ุงููุคูุชุฉ ุงููุฑุชุจุทุฉ ูุชุณุชุฎุฏู ููุตู ReadOnlySequence ุจููุงุกุฉ &lt;T&gt;. <br><br>  ูุธุฑูุง ูุฃู ReadOnlySequence &lt;T&gt; ูุฏุนู ููุทุนูุง ูุงุญุฏูุง ุฃู ุฃูุซุฑ ุ ูุฅู ุงูุชุดุบูู ุงูููุงุณู ููููุทู ุนุงูู ุงูุฃุฏุงุก ูู ูุตู ุงููุณุงุฑุงุช ุงูุณุฑูุนุฉ ูุงูุจุทูุฆุฉ ุงุณุชูุงุฏูุง ุฅูู ุนุฏุฏ ุงูุฃุฌุฒุงุก. <br><br>  ููุซุงู ุ ููุง ุฏุงูุฉ ุชุญูู ASCII ReadOnlySequence ุฅูู ุณูุณูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAsciiString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ReadOnlySequence&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.IsSingleSegment) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Encoding.ASCII.GetString(buffer.First.Span); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Create((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)buffer.Length, buffer, (span, sequence) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segment <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sequence) { Encoding.ASCII.GetChars(segment.Span, span); span = span.Slice(segment.Length); } }); }</code> </pre> <br>  ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">sample6.cs</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a> <br><br><h4 style=";text-align:right;direction:rtl">  ููุงููุฉ ุงูุชุฏูู ูุงูุชุญูู ูู ุงูุชุฏูู </h4><br>  ูู ุงููุงุญูุฉ ุงููุซุงููุฉ ุ ุชุนูู ุงููุฑุงุกุฉ ูุงูุชุญููู ูุนูุง: ูุณุชููู ุฏูู ุงููุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงูุดุจูุฉ ููุถุนูุง ูู ุงููุฎุงุฒู ุงููุคูุชุฉ ุ ุจูููุง ููุดุฆ ุฏูู ุงูุชุญููู ููุงูู ุงูุจูุงูุงุช ุงูููุงุณุจุฉ.  ูุณุชุบุฑู ุงูุชุญููู ุนุงุฏุฉู ููุชูุง ุฃุทูู ูู ูุฌุฑุฏ ูุณุฎ ูุชู ุงูุจูุงูุงุช ูู ุงูุดุจูุฉ.  ููุชูุฌุฉ ูุฐูู ุ ูููู ุฃู ูุซูู ุฏูู ุงููุฑุงุกุฉ ุจุณูููุฉ ุฏูู ุงูุชุญููู.  ูุฐูู ุ ุณูุถุทุฑ ุฏูู ุงููุฑุงุกุฉ ุฅูุง ุฅูู ุฅุจุทุงุก ุฃู ุงุณุชููุงู ุงููุฒูุฏ ูู ุงูุฐุงูุฑุฉ ูุญูุธ ุงูุจูุงูุงุช ูู ุฏูู ุงูุชุญููู.  ูุถูุงู ุงูุฃุฏุงุก ุงูุฃูุซู ุ ููุฒู ุงูุชูุงุฒู ุจูู ุชุฑุฏุฏ ุงูุฅููุงู ุงููุคูุช ูุชุฎุตูุต ูุณุงุญุฉ ูุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ. <br><br>  ูุญู ูุฐู ุงููุดููุฉ ุ ูุญุชูู ุฎุท ุงูุฃูุงุจูุจ ุนูู ูุธููุชูู ููุชุญูู ูู ุชุฏูู ุงูุจูุงูุงุช: PauseWriterThreshold ู ResumeWriterThreshold.  ูุญุฏุฏ PauseWriterThreshold ููุฏุงุฑ ุงูุจูุงูุงุช ุงูุชู ูุฌุจ ุชุฎุฒูููุง ูุคูุชูุง ูุจู ุฃู ูุชู ุฅููุงู PipeWriter.FlushAsync ูุคูุชูุง.  ุชุญุฏุฏ ResumeWriterThreshold ููุฏุงุฑ ุงูุฐุงูุฑุฉ ุงูุชู ูููู ุฃู ูุณุชููููุง ุงููุงุฑุฆ ูุจู ุงุณุชุฆูุงู ุชุดุบูู ุงููุณุฌู. <br><br><img src="https://habrastorage.org/webt/qf/yj/5u/qfyj5u6aahkadlp8nk1gtc9bqr4.png"><br><br>  PipeWriter.FlushAsync "ูููู" ุนูุฏูุง ุชุชุฌุงูุฒ ูููุฉ ุงูุจูุงูุงุช ูู ุงูุชุฏูู ุงูููุฌู ููุฃูุงุจูุจ ุงูุญุฏ ุงููุนูู ูู PauseWriterThreshold ุ ู "ููุชุญ" ุนูุฏูุง ูููู ุฃูู ูู ุงูุญุฏ ุงููุนูู ูู ResumeWriterThreshold.  ูููุน ุชุฌุงูุฒ ุญุฏ ุงูุงุณุชููุงู ุ ูุชู ุงุณุชุฎุฏุงู ูููุชูู ููุท. <br><br><h4 style=";text-align:right;direction:rtl">  ุฌุฏููุฉ I / O </h4><br>  ุนูุฏ ุงุณุชุฎุฏุงู async / await ุ ุนุงุฏุฉ ูุง ูุชู ุงุณุชุฏุนุงุก ุงูุนูููุงุช ุงููุงุญูุฉ ุฅูุง ูู ุณูุงุณู ุนูููุงุช ุงูุชุฌูุน ุฃู ูู SynchronizationContext ุงูุญุงูู. <br><br>  ุนูุฏ ุฅุฌุฑุงุก ุงูุฅุฏุฎุงู / ุงูุฅุฎุฑุงุฌ ุ ูู ุงูููู ุฌุฏูุง ูุฑุงูุจุฉ ููุงู ุชูููุฐู ุจุนูุงูุฉ ูู ุฃุฌู ุงุณุชุฎุฏุงู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูููุนุงูุฌ ุจุดูู ุฃูุถู.  ูุฐุง ุฃูุฑ ุจุงูุบ ุงูุฃูููุฉ ููุชุทุจููุงุช ุนุงููุฉ ุงูุฃุฏุงุก ูุซู ุฎูุงุฏู ุงูููุจ.  ูุณุชุฎุฏู System.IO.Pipelines PipeScheduler ูุชุญุฏูุฏ ููุงู ุชูููุฐ ุนูููุงุช ุงูุงุณุชุฑุฌุงุนุงุช ุบูุฑ ุงููุชุฒุงููุฉ.  ูุฐุง ูุณูุญ ูู ุจุงูุชุญูู ุจุฏูุฉ ูู ุงูุชุฏููุงุช ุงูุชู ุชุณุชุฎุฏู ูู I / O. <br><br>  ูุซุงู ุนูู ุงูุชุทุจูู ุงูุนููู ูู ุงูููู Kestrel Libuv ุ ุญูุซ ูุชู ุฅุฌุฑุงุก ุนูููุงุช ุฑุฏ ุงูุงุชุตุงู I / O ุนูู ูููุงุช ูุฎุตุตุฉ ูุญููุฉ ุงูุญุฏุซ. <br><br><h2 style=";text-align:right;direction:rtl">  ููุงู ููุงุฆุฏ ุฃุฎุฑู ููุงูุจ PipeReader. </h2><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุฏุนู ุจุนุถ ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ "ุงูุงูุชุธุงุฑ ุฏูู ุชุฎุฒูู ูุคูุช": ูุณุช ุจุญุงุฌุฉ ุฅูู ุชุฎุตูุต ูุฎุฒู ูุคูุช ุญุชู ุชุธูุฑ ุงูุจูุงูุงุช ุงููุชุงุญุฉ ูู ุงููุธุงู ุงูุฃุณุงุณู.  ูุฐูู ุ ูู Linux ูุน epoll ุ ูุง ููููู ุชูููุฑ ูุฎุฒู ูุคูุช ูููุฑุงุกุฉ ุญุชู ุชุตุจุญ ุงูุจูุงูุงุช ุฌุงูุฒุฉ.  ูุฐุง ูุชุฌูุจ ุงููููู ุนูุฏูุง ูููู ููุงู ุงูุนุฏูุฏ ูู ูุคุดุฑุงุช ุงูุชุฑุงุจุท ูู ุงูุชุธุงุฑ ุงูุจูุงูุงุช ุ ูุชุญุชุงุฌ ุฅูู ุญุฌุฒ ูุณุงุญุฉ ูุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ ุนูู ุงูููุฑ. </li><li style=";text-align:right;direction:rtl">  ูุฌุนู ุฎุท ุงูุฃูุงุจูุจ ุงูุงูุชุฑุงุถู ูู ุงูุณูู ูุชุงุจุฉ ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ ูุฑูุฒ ุงูุดุจูุฉ: ููุทู ุงูุชุญููู ูููุตู ุนู ุฑูุฒ ุงูุดุจูุฉ ุ ููุง ุชููู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ ุฅูุง ุจุชุดุบูู ูุฐุง ุงูููุทู ูู ุงููุฎุงุฒู ุงููุคูุชุฉ ูู ุงูุฐุงูุฑุฉ ุ ุจุฏูุงู ูู ุงุณุชููุงูู ูุจุงุดุฑุฉ ูู ุงูุดุจูุฉ.  ููุง ุฃูู ูุณูู ุงุฎุชุจุงุฑ ุงูุฃููุงุท ุงููุนูุฏุฉ ุนู ุทุฑูู ุฅุฑุณุงู ุจูุงูุงุช ุฌุฒุฆูุฉ.  ูุณุชุฎุฏูู ASP.NET Core ูุงุฎุชุจุงุฑ ูุฎุชูู ุฌูุงูุจ ุฃุฏูุงุช ุชุญููู http ูู Kestrel. </li><li style=";text-align:right;direction:rtl">  ุชุนุชุจุฑ ุงูุฃูุธูุฉ ุงูุชู ุชุณูุญ ูููุฏ ุงููุณุชุฎุฏู ุจุงุณุชุฎุฏุงู ุงููุฎุงุฒู ุงูุฑุฆูุณูุฉ ููุธุงู ุงูุชุดุบูู (ุนูู ุณุจูู ุงููุซุงู ุ ูุงุฌูุงุช ุจุฑูุฌุฉ ุชุทุจููุงุช Windows I / O ุงููุณุฌูุฉ) ููุงุณุจุฉ ูุจุฏุฆููุง ูุงุณุชุฎุฏุงู ุฎุทูุท ุงูุฃูุงุจูุจ ูุฃู ุชุทุจูู PipeReader ูููุฑ ุฏุงุฆููุง ุงููุฎุงุฒู ุงููุคูุชุฉ. </li></ul><br><h4 style=";text-align:right;direction:rtl">  ุฃููุงุน ุฃุฎุฑู ุฐุงุช ุตูุฉ </h4><br>  ุฃุถููุง ุฃูุถูุง ุนุฏุฏูุง ูู ุฃููุงุน BCL ุงูุจุณูุทุฉ ุงูุฌุฏูุฏุฉ ุฅูู System.IO.Pipelines: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MemoryPoolT</a> ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">IMemoryOwnerT</a> ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MemoryManagerT</a> .  ุชูุช ุฅุถุงูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ArrayPoolT</a> ูู .NET Core 1.0 ุ ููู .NET Core 2.1 ุ ููุฌุฏ ุงูุขู ุชูุซูู ุชุฌุฑูุฏู ุฃูุซุฑ ุนููููุฉ ูุชุฌูุน ูุนูู ูุน ุฃู MemoryT.  ูุญุตู ุนูู ููุทุฉ ุงููุงุจููุฉ ููุชูุณุนุฉ ุงูุชู ุชุณูุญ ููุง ุจุชูููุฐ ุงุณุชุฑุงุชูุฌูุงุช ุชูุฒูุน ุฃูุซุฑ ุชูุฏููุง ุ ุจุงูุฅุถุงูุฉ ุฅูู ุฅุฏุงุฑุฉ ุงููุฎุฒู ุงููุคูุช ููุชุญูู (ุนูู ุณุจูู ุงููุซุงู ุ ุงุณุชุฎุฏุงู ุงููุฎุงุฒู ุงููุคูุชุฉ ุงููุญุฏุฏุฉ ูุณุจููุง ุจุฏูุงู ูู ุงููุตูููุงุช ุงููุฏุงุฑุฉ ุญุตุฑููุง). </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">IBufferWriterT</a> ูู ุฌูุงุฒ ุงุณุชูุจุงู ูุชุณุฌูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ุงููุชุฒุงููุฉ (ุงูุชู ุชููุฐูุง PipeWriter). </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">IValueTaskSource</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุฏ</a> ูุฌุฏุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ValueTaskT</a> ููุฐ ุฅุตุฏุงุฑ .NET Core 1.1 ุ ูููู ูู .NET Core 2.1 ุงูุชุณุจุช ุฃุฏูุงุช ูุนุงูุฉ ููุบุงูุฉ ุชููุฑ ุนูููุงุช ุบูุฑ ูุชุฒุงููุฉ ุฏูู ุงููุทุงุน ุฏูู ุชูุฒูุน.  ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> ููุฒูุฏ ูู ุงููุนูููุงุช. </li></ul><br><h2 style=";text-align:right;direction:rtl">  ููููุฉ ุงุณุชุฎุฏุงู ุงููุงููุงุชุ </h2><br>  ุชูุฌุฏ ูุงุฌูุงุช ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ูู ุญุฒูุฉ nuget <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">System.IO.Pipelines</a> . <br><br>  ููุญุตูู ุนูู ูุซุงู ูุชุทุจูู ุฎุงุฏู .NET Server 2.1 ุงูุฐู ูุณุชุฎุฏู ุฎุทูุท ุงูุฃูุงุจูุจ ููุนุงูุฌุฉ ุงูุฑุณุงุฆู ุงูุตุบูุฑุฉ (ูู ุงููุซุงู ุฃุนูุงู) ุ ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> .  ูููู ุงูุจุฏุก ุจุงุณุชุฎุฏุงู ุชุดุบูู dotnet (ุฃู Visual Studio).  ูู ุงููุซุงู ุ ูู ุงููุชููุน ุฃู ูุชู ููู ุงูุจูุงูุงุช ูู ูุฃุฎุฐ ุงูุชูุตูู ุนูู ุงููููุฐ 8087 ุ ุซู ุชุชู ูุชุงุจุฉ ุงูุฑุณุงุฆู ุงููุณุชููุฉ ุนูู ูุญุฏุฉ ุงูุชุญูู.  ููููู ุงุณุชุฎุฏุงู ุนููู ุ ูุซู netcat ุฃู ูุนุฌูู ุ ููุงุชุตุงู ุจุงููููุฐ 8087.  ุฃุฑุณู ุฑุณุงูุฉ ุตุบูุฑุฉ ูุดุงูุฏ ููู ุชุนูู. <br><br>  ูุนูู ุฎุท ุงูุฃูุงุจูุจ ุญุงูููุง ุนูู Kestrel ู SignalR ุ ููุฃูู ุฃู ูุฌุฏ ุชุทุจูููุง ุฃูุณุน ูู ุงูุนุฏูุฏ ูู ููุชุจุงุช ุงูุดุจูุงุช ูููููุงุช ูุฌุชูุน .NET ูู ุงููุณุชูุจู. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar423105/">https://habr.com/ru/post/ar423105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar423093/index.html">ูุฒูุฏ ุนุดูุงุฆูุฉ ุญูููุฉ ุฃูู [ุนูู ุงูุฃุฑุฌุญ] [ุชูุฑูุจูุง] ุนู ุทุฑูู ุงูุตุฏูุฉ</a></li>
<li><a href="../ar423095/index.html">ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ูู Apple Presentation</a></li>
<li><a href="../ar423097/index.html">ุงูููุงู ูุงูุญููู ูููุงุชู PostgreSQL</a></li>
<li><a href="../ar423101/index.html">ูุดุฑ ุชุฎุฒูู LINSTOR ูู Proxmox</a></li>
<li><a href="../ar423103/index.html">Python Podcasts: ูุฐุง ูู ูุง ูุฌุฏูุงู</a></li>
<li><a href="../ar423107/index.html">ูุฏุนูู ุฅูู ุงุฌุชูุงุน Go in Production</a></li>
<li><a href="../ar423109/index.html">ูุง ูุฏูุชู Apple ููุง ูููุฑ ุจู ูุทูุฑู iOS</a></li>
<li><a href="../ar423115/index.html">ุชุฃุซูุฑุงุช ูุญุณูุฉ ูุน ูุถุน ูุฒุฌ ุทุจูุฉ ุงูุฎูููุฉ CSS</a></li>
<li><a href="../ar423117/index.html">ุนุด ููุชุฑุฉ ุฃุทูู ุฃู ุชูุจุฑ ุจุจุทุก: ููุฌ ุชูููููุฌู ููุจุงุฑ ุงูุณู</a></li>
<li><a href="../ar423119/index.html">ุขูุฉ DIY TTL ุงูููุฑุงุช ... ูู 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>