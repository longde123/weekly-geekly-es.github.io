<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåï üë®üèø‚Äçüè´ ü¶ñ Fazendo qualquer processo funcionar com NTFS transacional: minha primeira etapa na cria√ß√£o de uma sandbox para Windows ü•ô ‚ÜñÔ∏è üöõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° um m√≥dulo no kernel do Windows que √© respons√°vel por oferecer suporte ao agrupamento de opera√ß√µes de arquivo em alguma entidade chamada transa√ß√£o ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fazendo qualquer processo funcionar com NTFS transacional: minha primeira etapa na cria√ß√£o de uma sandbox para Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485784/"><p><img src="https://habrastorage.org/webt/p0/-s/fi/p0-sfitxnzzpywfqxuc4arx1fps.png" align="right" alt="TransactionMaster">  H√° um m√≥dulo no kernel do Windows que √© respons√°vel por oferecer suporte ao agrupamento de opera√ß√µes de arquivo em alguma entidade chamada <strong>transa√ß√£o</strong> .  As a√ß√µes nessa entidade s√£o isoladas e at√¥micas: elas podem ser <em>aplicadas</em> tornando-as permanentes ou <em>revertidas</em> .  Muito conveniente ao instalar programas, concorda?  Sempre passamos de um estado acordado para outro e, se algo der errado, todas as altera√ß√µes ser√£o revertidas. </p><br><p> Desde que soube do suporte a essa funcionalidade, sempre quis ver o mundo por dentro dessas transa√ß√µes.  E voc√™ sabe o que: achei um m√©todo simples e verdadeiramente maravilhoso para fazer qualquer processo funcionar dentro de uma transa√ß√£o de arquivo, <del>  mas as margens do livro s√£o muito estreitas para ele </del>  .  Na maioria dos casos, isso nem exige privil√©gios administrativos. </p><br><p>  Vamos descobrir como funciona, experimentar meu programa e entender o que s√£o as caixas de areia. </p><a name="habracut"></a><br><h2 id="repozitoriy">  Reposit√≥rio </h2><br><p>  Para quem est√° ansioso para experimentar: <a href="https://github.com/diversenok/TransactionMaster">TransactionMaster no GitHub</a> . </p><br><h2 id="teoriya">  Teoria </h2><br><p>  O suporte para NTFS transacional, ou <strong>TxF</strong> , apareceu no Windows Vista e tornou poss√≠vel simplificar significativamente o c√≥digo respons√°vel pela recupera√ß√£o de erros no processo de atualiza√ß√£o do software e do pr√≥prio sistema operacional.  De fato, a tarefa de restaura√ß√£o foi transferida para o kernel do sistema operacional, que come√ßou a aplicar a <a href="https://ru.wikipedia.org/wiki/ACID">sem√¢ntica</a> completa do <a href="https://ru.wikipedia.org/wiki/ACID"><abbr title="Atomicidade, Consist√™ncia, Isolamento, Durabilidade">ACID</abbr></a> √†s opera√ß√µes de arquivo - basta perguntar. </p><br><p> Para suportar essa tecnologia, foram adicionadas novas fun√ß√µes de API que duplicaram a funcionalidade existente, adicionando um novo par√¢metro - uma transa√ß√£o.  A transa√ß√£o em si se tornou um dos muitos objetos do kernel no sistema operacional, junto com arquivos, processos e objetos de sincroniza√ß√£o.  No caso mais simples, a sequ√™ncia de a√ß√µes ao trabalhar com transa√ß√µes consiste em criar um objeto de transa√ß√£o chamando <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-createtransaction"><code>CreateTransaction</code></a> , trabalhando com arquivos (usando fun√ß√µes como <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-createfiletransactedw"><code>CreateFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-movefiletransactedw"><code>MoveFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-deletefiletransactedw"><code>DeleteFileTransacted</code></a> e similares) e aplicando / revertendo a transa√ß√£o usando <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-committransaction"><code>CommitTransaction</code></a> / <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-rollbacktransaction"><code>RollbackTransaction</code></a> . </p><br><p>  Agora vamos dar uma olhada na arquitetura desses recursos.  Sabemos que a camada API documentada, de bibliotecas como <code>kernel32.dll</code> , n√£o transfere diretamente o controle para o kernel do sistema operacional, mas refere-se √† camada de abstra√ß√£o subjacente no modo de usu√°rio - <code>ntdll.dll</code> , que j√° faz uma chamada de sistema.  E aqui uma surpresa nos espera: <u>simplesmente n√£o h√° duplica√ß√£o de fun√ß√µes para trabalhar com arquivos no contexto de transa√ß√µes no <strong>ntdll</strong> , como no kernel</u> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ke/ql/5q/keql5q2xtkbwehzymrrnivsniq8.png" alt="Camadas de API"></div><br><p>  No entanto, os prot√≥tipos dessas fun√ß√µes da API nativa n√£o mudaram desde tempos imemoriais, o que significa que eles aprender√£o de algum outro lugar no contexto de qual transa√ß√£o executar a opera√ß√£o.  Mas de onde?  A resposta √© que cada encadeamento possui um campo especial no qual o identificador da transa√ß√£o atual √© armazenado.  A √°rea da mem√≥ria em que est√° localizada √© chamada <abbr title="Bloco ambiental de encadeamento">TEB</abbr> , o bloco do ambiente de fluxo.  De coisas conhecidas, o <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror">√∫ltimo c√≥digo de erro</a> e <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid">identificador de fluxo</a> tamb√©m s√£o armazenados l√°. </p><br><p>  Portanto, fun√ß√µes com o sufixo <code>*Transacted</code> definem o campo da transa√ß√£o atual, chamam uma fun√ß√£o semelhante sem sufixo e, em seguida, restaura o valor anterior.  Eles fazem isso usando um par de <a href=""><code>RtlSetCurrentTransaction</code></a> / <a href=""><code>RtlSetCurrentTransaction</code></a> do <code>ntdll</code> .  O c√≥digo das pr√≥prias fun√ß√µes √© muito direto, com exce√ß√£o do caso do <abbr title="Windows no Windows de 64 bits">WoW64</abbr> , que ser√° <abbr title="Windows no Windows de 64 bits">discutido</abbr> abaixo. </p><br><p>  O que tudo isso significa para n√≥s?  <strong>Alterando uma vari√°vel na mem√≥ria do processo, podemos controlar no contexto de qual transa√ß√£o ela est√° trabalhando com o sistema de arquivos.</strong>  Voc√™ n√£o precisa definir traps e interceptar chamadas de fun√ß√£o, apenas entregue o descritor de transa√ß√£o ao processo de destino e corrija alguns bytes em sua mem√≥ria para cada um dos encadeamentos.  Isso parece elementar, vamos faz√™-lo! </p><br><h2 id="podvodnye-kamni">  Armadilhas </h2><br><p>  Os primeiros experimentos mostraram que a id√©ia √© vi√°vel: o <a href="https://farmanager.com/">Far Manager</a> , que eu uso em vez do Windows Explorer, sobrevive perfeitamente √† substitui√ß√£o de transa√ß√µes dinamicamente e permite que voc√™ veja o mundo em seu contexto.  Mas tamb√©m havia programas que constantemente criam novos threads para opera√ß√µes de arquivo.  E no cen√°rio original, essa √© uma lacuna, pois n√£o √© muito conveniente rastrear a cria√ß√£o de threads em outro processo (sem mencionar o fato de que "atraso" √© cr√≠tico aqui).  Um exemplo de um aplicativo da segunda classe √© o <a href="https://github.com/microsoft/winfile">WinFile</a> recentemente portado. </p><br><h3 id="otslezhivayuschaya-dll">  DLL de rastreamento </h3><br><p>  Felizmente, o rastreamento s√≠ncrono da cria√ß√£o do encadeamento e a configura√ß√£o subsequente das transa√ß√µes para eles s√£o completamente elementares a partir do processo de destino.  Basta incorporar uma DLL nela, e o carregador do m√≥dulo chama seu ponto de entrada com o par√¢metro <a href="https://docs.microsoft.com/ru-ru/windows/win32/dlls/dllmain"><code>DLL_THREAD_ATTACH</code></a> toda <b>*</b> vez ao criar um novo encadeamento.  Ao implementar essa funcionalidade, corrigi a compatibilidade com uma d√∫zia de outros programas. </p><br><p>  <strong>*</strong> Tecnicamente, uma chamada nem sempre funciona, e esse comportamento √†s vezes pode ser observado na interface do meu programa.  Na maioria das vezes, as exce√ß√µes s√£o encadeamentos do pool de trabalho do pr√≥prio carregador de m√≥dulos.  O problema √© que as bibliotecas DLL s√£o notificadas sob o bloqueio do carregador de inicializa√ß√£o e isso significa: voc√™ n√£o pode carregar novos m√≥dulos no momento.  E os threads do carregador, como voc√™ sabe, fazem exatamente isso, paralelizando o acesso ao sistema de arquivos.  √â fornecida uma exce√ß√£o para esses casos: se voc√™ especificar <a href=""><code>THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH</code></a> como um sinalizador ao chamar <a href=""><code>NtCreateThreadEx</code></a> , poder√° evitar adicionar um novo encadeamento √†s DLLs existentes e, respectivamente, deadlocks.  Sobre isso √© o que acontece aqui. </p><br><h3 id="zapuskaem-provodnik">  Iniciar o Explorer </h3><br><p>  Resta a terceira e √∫ltima categoria de programas que ainda falham ao tentar faz√™-los funcionar em uma transa√ß√£o.  Um desses programas √© o Windows Explorer.  N√£o consigo diagnosticar o problema com precis√£o, mas o aplicativo √© complicado e a troca a quente dentro da transa√ß√£o n√£o o afeta muito.  Talvez o motivo seja o fato de ter muitos descritores de arquivos abertos, alguns dos quais deixam de ser v√°lidos no novo contexto.  Ou talvez seja outra coisa.  Nessas situa√ß√µes, reiniciar o processo ajuda, para que ele funcione desde o in√≠cio da transa√ß√£o.  Ent√£o, nenhuma inconsist√™ncia deve surgir. </p><br><p>  E, portanto, adicionei a capacidade de iniciar novos processos no programa, para os quais a transa√ß√£o e o rastreamento de novos fluxos s√£o configurados antes mesmo de chegar ao ponto de entrada, enquanto o processo est√° em pausa.  E voc√™ sabe o que, funcionou!  √â verdade que, como o Explorer usa ativamente objetos COM fora do processo, a visualiza√ß√£o √© interrompida ao mover arquivos.  Mas, caso contr√°rio, tudo √© est√°vel. </p><br><h3 id="chto-tam-s-wow64">  O que h√° com o WoW64? </h3><br><p>  Esse subsistema para iniciar programas de 32 bits em sistemas de 64 bits √© uma ferramenta extremamente conveniente, mas a necessidade de levar em conta seus recursos geralmente complica a programa√ß√£o do sistema.  <code>Rtl[Get/Set]CurrentTransaction</code> acima que o comportamento de <code>Rtl[Get/Set]CurrentTransaction</code> marcadamente diferente no caso de processos similares.  A raz√£o para isso reside no fato de que os threads nos processos WoW64 t√™m at√© dois blocos de ambiente.  Eles t√™m tamanhos diferentes do ponteiro, e √© desej√°vel mant√™-los em um estado consistente, embora, no caso de transa√ß√µes, o TEB de 64 bits tenha preced√™ncia.  Quando estabelecemos transa√ß√µes remotamente, devemos reproduzir o comportamento dessas fun√ß√µes.  N√£o √© dif√≠cil, mas voc√™ n√£o deve esquec√™-lo, e detalhes podem ser encontrados <a href="">aqui</a> .  Finalmente, os processos WoW64 precisam de uma c√≥pia adicional de 32 bits da nossa DLL de rastreamento. </p><br><h3 id="nereshyonnye-problemy">  Problemas n√£o resolvidos </h3><br><p>  For√ßado a sofrer - o primeiro cen√°rio que vem √† mente, a saber, o lan√ßamento de instaladores de programas nesse modo - ainda n√£o est√° operacional.  Primeiramente, ele n√£o est√° configurado para capturar processos filhos na mesma transa√ß√£o.  Existem v√°rias solu√ß√µes aqui, estou trabalhando nisso.  Mas se o aplicativo criar v√°rios processos, ainda √© muito cedo para us√°-lo em combina√ß√£o com transa√ß√µes. </p><br><p>  Em segundo lugar, o caso com arquivos execut√°veis ‚Äã‚Äãque n√£o existem fora da transa√ß√£o merece aten√ß√£o especial.  Lembro-me de que havia algum tipo de v√≠rus que enganava antiv√≠rus ing√™nuos dessa maneira: era descompactado em uma transa√ß√£o, se lan√ßava e depois revertia a transa√ß√£o.  Existe um processo, mas n√£o h√° arquivo execut√°vel.  O antiv√≠rus pode decidir que n√£o h√° nada para verificar e ignorar a amea√ßa.  Tamb√©m precisamos trabalhar em solu√ß√µes criativas, porque, por algum motivo, <a href=""><code>NtCreateUserProcess</code></a> (e, consequentemente, <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw"><code>CreateProcess</code></a> ) ignora a transa√ß√£o atual.  Obviamente, o <a href=""><code>NtCreateProcessEx</code></a> sempre permanece, mas espera-se muita confus√£o para corrigir problemas de compatibilidade.  Vou pensar em alguma coisa. </p><br><h2 id="prichyom-tut-pesochnicy">  E onde est√£o as caixas de areia? </h2><br><p>  D√™ uma olhada na foto.  Aqui, tr√™s programas diferentes mostram o conte√∫do da mesma pasta em tr√™s transa√ß√µes diferentes.  Legal, n√©? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9f/ml/ds/9fmldsooc30vlqq7plchzoxystc.png" alt="Um olhar de dentro da transa√ß√£o"></div><br><p>  E, no entanto, meu programa n√£o √© de modo algum uma caixa de areia, falta um detalhe importante - <strong>a fronteira de seguran√ßa</strong> .  Obviamente, isso n√£o impede que algumas empresas vendam artesanato semelhante sob o disfarce de caixas de areia de pleno direito, uma vergonha para elas, o que posso dizer.  E, apesar de isso parecer completamente imposs√≠vel, como podemos impedir que um programa altere uma vari√°vel em nossa mem√≥ria, mesmo se formos um depurador?  - Tenho um truque delicioso que me permitir√° concluir o que iniciei e criar a primeira caixa de prote√ß√£o que conhe√ßo, que n√£o exigir√° um driver, mas virtualizar√° o sistema de arquivos.  At√© l√°, aguarde atualiza√ß√µes, use o <a href="https://sandboxie.com/">Sandboxie</a> e experimente a tecnologia <a href="https://docs.microsoft.com/ru-ru/windows/win32/secauthz/appcontainer-isolation">AppContainer</a> .  Obrigado pela aten√ß√£o. </p><br><p>  Reposit√≥rio do projeto no GitHub: <strong><a href="https://github.com/diversenok/TransactionMaster">TransactionMaster</a></strong> . <br>  <a href="https://habr.com/en/post/485788/">O mesmo artigo em ingl√™s</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485784/">https://habr.com/ru/post/pt485784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485766/index.html">Regras de alimenta√ß√£o</a></li>
<li><a href="../pt485768/index.html">Tend√™ncias da Web para 2020 que vale a pena experimentar</a></li>
<li><a href="../pt485770/index.html">Pol√™mica incorreta</a></li>
<li><a href="../pt485776/index.html">Em toda a geografia: navega√ß√£o e tarefas geod√©sicas em diferentes idiomas</a></li>
<li><a href="../pt485780/index.html">Rob√¥s, ressonadores de quartzo, microcontroladores ... o que a Epson faz?</a></li>
<li><a href="../pt485786/index.html">Li√ß√£o de casa aritm√©tica</a></li>
<li><a href="../pt485788/index.html">Como fazer com que qualquer processo funcione com o NTFS transacional: minha primeira etapa para escrever uma sandbox para Windows</a></li>
<li><a href="../pt485790/index.html">Entrevistas: expectativas versus realidade</a></li>
<li><a href="../pt485792/index.html">Ivan Lilekvist e Kim Dotkom, uma grande entrevista: a hist√≥ria do Megaupload, extradi√ß√£o para os Estados Unidos, liberdade, bitcoin. Parte 2</a></li>
<li><a href="../pt485794/index.html">Voc√™ est√° desenvolvendo no .NET Core? Vamos para o Ubuntu, eu preparei tudo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>