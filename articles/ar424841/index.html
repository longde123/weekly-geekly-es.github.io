<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚅 ♠️ 🙎🏼 تخزين أرشيف صور لموقع في تخزين Azure BLOB 🦖 👾 🛅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="تصف المقالة تجربة تنظيم تخزين الميزانية لأرشيف الصور لموقع يحتوي على ملايين الإعلانات. 



 في حالتي ، تُفهم الصور على أنها صور للشقق والمنازل والمؤام...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تخزين أرشيف صور لموقع في تخزين Azure BLOB</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424841/" style=";text-align:right;direction:rtl"> تصف المقالة تجربة تنظيم تخزين الميزانية لأرشيف الصور لموقع يحتوي على ملايين الإعلانات. <br><br><img src="https://habrastorage.org/webt/9c/_6/sg/9c_6sgzywejobg-vzsrzgazv7_w.png"><br><a name="habracut"></a><br>  في حالتي ، تُفهم الصور على أنها صور للشقق والمنازل والمؤامرات وما إلى ذلك.  لدي <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مشروع خاص</a> بي وهو موقع يحتوي على إعلانات لبيع وتأجير العقارات.  الموقع موجود منذ حوالي 6 سنوات وخلال هذا الوقت تراكم عدد كبير من الإعلانات.  يتم عرض صور بطاقة كل كائن ، في المتوسط ​​8 صور لكل إعلان.  في الواقع ، سأقوم بتخزين هذه الصور في السحابة حتى أتمكن من عرضها في وقت لاحق للزوار على بطاقات الكائنات. <br><br>  كيف قمت بتخزينها من قبل؟  - مستحيل.  لم أحتفظ بالصور باستثناء تلك التي تم وضعها يدويًا.  في معظم الحالات ، تصل الإعلانات إلى الموقع من خلال الشركاء من خلال التحميل التلقائي للخلاصة.  في الخلاصة لكل كائن هناك روابط إلى الصور - أقوم بتخزين الروابط وإعطاء الزائر صورة مباشرة من الشريك.  تعمل هذه الدائرة بشكل رائع وتوفر الكثير من الموارد. <br><br>  يتم تحميل الصور التي يراها الزوار في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">اختيار الإعلانات</a> أو في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">بطاقة الكائن في</a> الواقع من موارد الجهات الخارجية. <br><br>  هناك تحذير واحد يتعلق بخصائص الموقع - لا يتم حذف كائنات الأرشيف.  على سبيل المثال  بعد إزالة الإعلان من المنشور ، يختفي بالتأكيد من نتائج البحث ، ولكن الرابط المباشر متاح دائمًا (بدون جهات اتصال البائع).  لبعض الوقت ، لا تزال الروابط إلى الصور حية ، أحيانًا لسنوات ، لكنها تموت عاجلاً أم آجلاً.  تعتبر العناصر المؤرشفة ذات قيمة لأن الزوار من محركات البحث يواصلون القدوم إليهم.  أيضًا ، تم <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">إنشاء خريطة أسعار</a> من الأرشيف (سبق لي أن <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">كتبت عنها</a> ) ، واكتشفت بالصدفة مصدرًا إضافيًا للدخل للمشروع في شكل بيع معلومات الاتصال بكائنات الأرشيف.  لماذا يشترونها؟ لا أعرف بالتأكيد ، لكنني أفترض أن الزوار يريدون الحصول على جهات اتصال لأنهم يعتقدون أن الإعلان قد تمت إزالته من المنشور عن طريق الخطأ أو عن طريق الخطأ.  ربما يحدث أيضًا أنهم يريدون تعلم شيء من المالكين السابقين.  بطريقة أو بأخرى ، من المرجح شراء إعلان يحتوي على صور في هذه الحالة.  تزداد قيمة الصور الفوتوغرافية بعد الوعي بهذا الفارق الدقيق. <br><br>  يبلغ حجم البيانات التي سأخزنها في السحابة حوالي 3-4 تيرابايت.  بالإضافة إلى مكسب يومي من عدة غيغابايت.  بالنظر إلى أن هذا الابتكار لن يجلب المال بشكل مباشر ، فإنه يمكن أن يؤثر بشكل غير مباشر فقط على عملية اتخاذ القرار من قبل الزائر ، فالميزانية التي أردت أن أقابل بها ميزانية متواضعة للغاية هي 1000-2000 ص.  شهريا.  سيكون الأمر رائعًا على الإطلاق مجانًا ، لكنني لم أجد مثل هذه الفرصة. <br><br><h2 style=";text-align:right;direction:rtl">  أزور </h2><br>  لقد بحثت بطريقة ما على الفور تجاه Azure لأنني أعمل على .net ، وغالبًا ما أرى مقالات إعلانية جميلة حول هذا الموضوع.  بالإضافة إلى ذلك ، لا بد لي من استخدام هذه المنصة لوظيفتي الرئيسية ، ولكن هناك قدراتي محدودة بمتطلبات العمل ورغبات الإدارة. <br><br>  يوفر Azure تخزين BLOB مع ثلاثة مستويات تخزين: ساخن ، بارد ، وأرشيف.  تختلف الأسعار على جميع المستويات.  بشكل عام ، كلما كانت القراءة / الكتابة أكثر تكلفة كلما كانت رسوم التخزين الشهرية أغلى ، والعكس صحيح.  على Hot - من المربح أن تكتب / تقرأ وتحذف الكثير ، ولكن تكلفة تخزينها لفترة طويلة.  الأرشيف سهل التخزين ولكنه مكلف للقراءة / الكتابة.  أيضًا ، على مستوى الأرشيف والبارد ، هناك رسوم للحذف المبكر - وهذا يعني أنه إذا قمت بحذف (أو نقل إلى مستوى آخر) كائن قبل فترة معينة ، فسيتم محاسبتي على هذه الفترة بأكملها.  بالنسبة لمستوى الأرشيف ، هذا هو 180 يومًا ، للبرد - 30. <br><br><h2 style=";text-align:right;direction:rtl">  الأسعار </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">تبلغ تكلفة التخزين</a> 0.0023 دولارًا لكل غيغابايت شهريًا على مستوى الأرشيف ، و 0.01 دولارًا للبرد و 0.0196 دولارًا للساعة.  بالمعدل الحالي ، هذا هو ما يقرب من 0.15 و 0.65 و 1.28 روبل ، على التوالي. <br><br>  قارنت التكلفة مع Amazon و Google ، اتضح أن Azure أرخص. <br><br><table style=";text-align:right;direction:rtl"><tbody><tr><td></td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">أزور</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">أمازون (S3)</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">جوجل</a></b> </td></tr><tr><td>  <b>حار</b> </td><td>  0.0196 دولار </td><td>  0.024 دولار </td><td>  0.026 دولار </td></tr><tr><td>  <b>رائع</b> </td><td>  0.01 دولار </td><td>  0.01 دولار </td><td>  0.01 دولار </td></tr><tr><td>  <b>الأرشيف</b> </td><td>  0.0023 دولار </td><td>  0.0045 دولار </td><td>  0.007 دولار </td></tr></tbody></table><br><br>  بالإضافة إلى تكلفة التخزين ، من الضروري مراعاة تكلفة العمليات - فهي أيضًا مختلفة على جميع المستويات.  الأسعار لـ 10000 معاملة. <br><br>  <b>حار</b> <br>  قراءة: 0.0043 دولار ، كتابة: 0.054 دولار <br><br>  <b>رائع</b> <br>  قراءة: 0.01 دولار ، كتابة: 0.10 دولار <br><br>  <b>الأرشيف</b> <br>  قراءة: 6 دولارات ، كتابة: 0.12 دولارًا <br><br><h2 style=";text-align:right;direction:rtl">  منطق العمل </h2><br><br>  عندما يكون الإعلان نشطًا ، يتم عرض الصور الموجودة فيه عن طريق روابط من مصادر خارجية (من شركاء).  بعد إزالة الإعلان من المنشور ، يصبح أرشيفية ، لكن الروابط إلى الصور لا تزال حية لبعض الوقت.  عاجلاً أم آجلاً ، يموتون ، وتحتاج إلى التأكد من وجود نسخة أرشيف في هذا الوقت. <br><br>  يمكن وصف عملية معالجة الصور في الخطوات التالية: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  بمجرد اختفاء الإعلان من ملف استيراد الشريك ، أي  توقف الشريك عن نشره ، ويتم تكوين إدخال في قائمة انتظار الأولوية ، حيث تكون الأولوية هي عدد المشاهدات من قبل الزوار - كلما زادت المشاهدات ، زادت احتمالية أن يتم أرشفة الكائن. </li><li style=";text-align:right;direction:rtl">  عند معالجة سجل من قائمة الانتظار ، يتم تكوين كائن BLOB يحتوي على صور مخفضة (حتى 800x600) للإعلان.  يرجع أيضًا استخدام العناصر المركبة بدلاً من الصور الفوتوغرافية المباشرة إلى الوفورات - بدلاً من 8 عمليات تسجيل (في المتوسط ​​8 صور لكل كائن) ، يتم تنفيذ واحدة ، وتكلف كل عملية أموالًا. </li><li style=";text-align:right;direction:rtl">  يتم تحميل BLOB أولاً في Hot ، ثم يتم نقله على الفور إلى الأرشيف.  لا توجد إمكانية للكتابة مباشرة إلى الأرشيف ، وبما أن Cool لديها رسوم للحذف المبكر ، فمن الأرخص استخدام Hot كنقطة عبور. </li><li style=";text-align:right;direction:rtl">  أرشيف BLOB طالما أن الروابط إلى الصور الأصلية نشطة (يتم عرض الصور حتى الآن بواسطة الروابط من الشركاء). </li><li style=";text-align:right;direction:rtl">  يتم التحقق من الروابط للحصول على الوظائف عندما يزور الزائر بطاقة الكائن - إذا ذهبوا إليها ، فإن الكائن يكون شائعًا ومن المنطقي استعادة الصور من الأرشيف. </li><li style=";text-align:right;direction:rtl">  إذا ماتت الروابط إلى الصور الأصلية ، أتحقق مما إذا كانت هناك نسخة من الأرشيف ، وإذا كان الأمر كذلك ، فأرسل طلبًا للاستعادة من الأرشيف إلى Cool (قد يستغرق الأمر ما يصل إلى 15 ساعة لاستعادة نقطة من الأرشيف - وهذا يسمى الإماهة من Microsoft). </li><li style=";text-align:right;direction:rtl">  بمجرد استعادة BLOB من الأرشيف ، يتم نسخه إلى التخزين المحلي وتقسيمه إلى صور عادية.  التخزين المحلي هو محرك الأقراص الثابت لخادمي. </li><li style=";text-align:right;direction:rtl">  الصور الموجودة على بطاقة الإعلان معطاة بالفعل من التخزين المحلي. </li><li style=";text-align:right;direction:rtl">  يتم تخزين الصور في التخزين المحلي لعدة أيام.  إذا كانت هناك عمليات مسح خلال هذا الوقت ، يتم تمديد فترة التخزين المحلية.  إذا لم تكن هناك مشاهدات ، يتم حذف الصور من التخزين المحلي ، ولكنها تظل في مستوى Cool في Azure. </li><li style=";text-align:right;direction:rtl">  من Cool إلى Archive يتم نسخها إذا لم يكن هناك مشاهدات لمدة شهرين - من الواضح أن الكائن ليس شائعًا ، وبالتالي ، لا معنى للدفع الزائد للتخزين في Cool. </li></ol><br><br><h2 style=";text-align:right;direction:rtl">  الإطلاق الأول </h2><br>  عندما تمت كتابة العملية واختبارها ، حان وقت التشغيل التجريبي ، وكانت هناك مشاكل متوقعة.  في قائمة الانتظار في ذلك الوقت كان هناك حوالي 10 مليون كائن ، قررت أن أبدأ الترحيل من 30000 كائن في اليوم.  قم بإعداد رسومات جميلة على لوحة القيادة وبدأت في المراقبة.  في الإحصائيات ، رأيت "غارات" غريبة مع طلبات GetBlobProperties.  تحدث بفاصل زمني متساوٍ تقريبًا مدته ساعة واحدة ، وتبدأ دائمًا بعد ساعة ونصف تقريبًا من بداية الترحيل ، وتستمر لبعض الوقت بعد اكتمالها. <br><br><img src="https://habrastorage.org/webt/wm/qx/qr/wmqxqrsvn7zctu-xyulyvr-25wu.png"><br><br>  كان عدد هذه الطلبات أكبر من أن يتم تجاهلها.  نظرت إلى السجلات ورأيت أن هذه الطلبات لا تأتي من خادمي بل من عناوين IP أجنبية.  لم أرد أن أدفع لهم على الإطلاق. <br><br>  لقد بحثت في المكدس وفي الوثائق ، ولكن دون جدوى.  كتب <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">سؤالا عن Stackoverflow</a> والدعم الفني.  ونتيجة لذلك ، بعد مراسلات طويلة مع الدعم الفني ، وتزويدهم بالسجلات ، أخبروني أنه يمكنهم إعادة إنتاج الموقف وهذا خطأ في جانبهم. <br><br>  هناك فارق بسيط مثير للاهتمام هو أن سؤالي حول Stackoverflow تم الإجابة عليه لا يشرح الأسباب ، ولكن فقط يؤكد أنني سأدفع مقابل هذه الطلبات ، لكن الشخص الذي أعطى الإجابة طلب مني بإصرار وضع علامة عليها على أنها صحيحة.  كما ألمح إلي أنه لم يكن (في الدعم) مرحبًا بهم لنشر الخلل في منتجاتهم الخاصة.  أخبرته أنني لن أفعل ذلك حتى يكتب الحقيقة.  يمكنني كتابة هذا بنفسي ، لكنني اعتقدت أن موظفي الدعم الفني ربما قاموا بقياس عدد الإجابات المؤكدة ، لذلك طلبت منه أن يكتب السبب الحقيقي وفي هذه الحالة أضع علامة على إجابته على أنها صحيحة.  بعد بعض التردد ، وافق على تعليقه واستكمله بتقرير خطأ.  بشكل عام ، أحببت كيف يعمل الدعم الفني - حتى تم نقلي إلى فتاة روسية لا تزال تبقيني على علم بالتغييرات في هذه المشكلة. <br><br>  إن حقيقة أن الخطأ تم التعرف عليه لا يرضي إلا أخلاقيا ، لكنني أردت تشغيل الآلية ، وفي الوقت نفسه لم أدفع المال للطلبات اليسرى.  خاصة بالنظر إلى أنني عادة ما أكون مرتبكًا لتقليل عدد الطلبات وبالتالي التكلفة. <br><br>  في الدعم الفني ، نصحوني بالانتظار مع الإطلاق وبعد أسبوعين كتبوا أن الخطأ تم إصلاحه ، ولكن عندما يكون الإصدار مع الإصلاح ، فإنه غير معروف.  عرضوا تمكين التسجيل والعمل على هذا النحو ، وبعد الإصدار ، طلب التعويض في Microsoft.  في الواقع ، في هذا الوضع ، لا يزال يعمل.  كل يوم أبدأ ترحيل عدد صغير من الكائنات وانتظر الإصدار. <br><br><h2 style=";text-align:right;direction:rtl">  الخلاصة </h2><br>  تكلفة 30000 قطعة يوميا لا تزال 900 ص.  في الشهر - وهذا مقبول تمامًا.  معظم النفقات هي عمليات الكتابة.  لذلك عندما تتم معالجة قائمة الانتظار بالكامل وتبدأ مرحلة العمل المخطط لها ، سيكون من الواضح التكلفة الحقيقية لمثل هذا التخزين.  ولكن وفقًا لحساباتي ، سيحدث هذا في غضون عام تقريبًا. <br><br>  عندما يكون هناك إصدار في Azure Blob-storage ، سأضيف هنا ما إذا تمكنت من الحصول على تعويض.  فيما يتعلق بالمصروفات الشهرية ، فإن هذا يمثل حوالي 10٪ من التكلفة. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar424841/">https://habr.com/ru/post/ar424841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar424823/index.html">كيف تؤثر التغذية منخفضة السعرات الحرارية على الشيخوخة</a></li>
<li><a href="../ar424825/index.html">الروبوتات والشيوعية</a></li>
<li><a href="../ar424827/index.html">وهم الفضاء: كيف يجعل سبايدرمان الجديد غرفًا بدون هندسة</a></li>
<li><a href="../ar424831/index.html">ما يستثمر في الاقتصاد الرقمي</a></li>
<li><a href="../ar424835/index.html">كيفية تقليل مخاطر الاستثمار في البورصة: 3 عوامل للتنويع</a></li>
<li><a href="../ar424843/index.html">هل IBOutlet خاص في تطبيقات iOS الخاصة بك؟</a></li>
<li><a href="../ar424845/index.html">حساب المربعات السحرية باستخدام GPU</a></li>
<li><a href="../ar424847/index.html">MNaaS و eSIM - إيجابيات وسلبيات المحاكاة الافتراضية لمشغلي الهاتف المحمول وعملائهم</a></li>
<li><a href="../ar424849/index.html">ما الذي يجعل UCS C480 ML M5 الجديد مثيرًا للاهتمام - خادم التعلم الآلي من Cisco</a></li>
<li><a href="../ar424851/index.html">ما هو الخطأ في توظيف تكنولوجيا المعلومات؟</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>