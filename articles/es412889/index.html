<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚öïÔ∏è ‚úäüèª üñäÔ∏è Desarrollo de dispositivos inteligentes utilizando el ejemplo de un controlador de piso calentado en ESP8266 üë®‚Äçüíº üë®üèΩ‚Äçüè´ üë≤üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quiero compartir mi experiencia en el desarrollo de un dispositivo inteligente. En esta publicaci√≥n, describir√© el hardware (brevemente) y el software...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desarrollo de dispositivos inteligentes utilizando el ejemplo de un controlador de piso calentado en ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412889/">  Quiero compartir mi experiencia en el desarrollo de un dispositivo inteligente.  En esta publicaci√≥n, describir√© el hardware (brevemente) y el software (con m√°s detalle). <br><br>  El controlador est√° dise√±ado para analizar las lecturas de los sensores (cableados e inal√°mbricos) y mantener la temperatura establecida (incluido el horario, incluidos los d√≠as de la semana) en cada zona individual encendiendo / apagando la caldera y controlando los circuitos de calefacci√≥n del piso de agua usando los cabezales t√©rmicos en el colector. <br><a name="habracut"></a><br><h2>  Hardware </h2><br>  Como controlador, se seleccion√≥ ESP8266 (WeMos D1 mini), como  Tiene wifi a bordo.  En lugar del ESP8266, se puede utilizar cualquier otro controlador o microordenador: las ideas generales permanecer√°n sin cambios, lo principal es que un servidor WEB con soporte para sockets WEB podr√≠a implementarse en el sistema seleccionado.  Los siguientes tambi√©n fueron utilizados en el proyecto: <br><br><ul><li>  RTC: DS3231: es necesario determinar el d√≠a de la semana y la hora actual.  El proyecto fue concebido como un dispositivo independiente que puede funcionar sin Internet, por lo que NTP no es adecuado. </li><li>  Sensores de temperatura inal√°mbricos: NoName, 433MHz, de la estaci√≥n meteorol√≥gica china, una soluci√≥n llave en mano, funcionan con bater√≠as.  ¬øQu√© m√°s necesitas?  Pero es necesario que el per√≠odo de transferencia de datos no sea fijo.  El problema es que el per√≠odo de transmisi√≥n es de 35 segundos y no nada mucho.  Y hay situaciones en las que las se√±ales de dos sensores se superponen.  En este caso, uno o dos sensores abandonan el sistema por un tiempo.  El problema se puede resolver utilizando sensores similares, en los cuales la conmutaci√≥n de canales tambi√©n cambia el per√≠odo de transmisi√≥n de datos. </li><li>  Receptor de 433MHz: Rxb6: las revisiones de Internet y la experiencia personal no son un mal receptor. </li><li>  Sensores de temperatura con cable: DS18B20: muy conveniente ya que no necesita saber la cantidad de sensores por adelantado. </li><li>  1Wire bus master: DS2482-100: el protocolo 1Wire es muy sensible a los tiempos, por lo tanto, todas las implementaciones del programa bus master usan delay, lo que no es muy bueno para la multitarea.  Con este chip, puede aprovechar el bus 1Wire y deshacerse de sus defectos transmitiendo 1Wire &lt;-&gt; i2c.  El protocolo i2c tiene una l√≠nea de sincronizaci√≥n, por lo que no es cr√≠tico para los tiempos y a menudo se implementa en el hardware de los controladores. </li><li>  Temporizador de vigilancia: TPL5000DGST: el tiempo de actividad continuo no es tan importante para este proyecto, sin embargo, la accesibilidad es muy importante.  El ESP8266 tiene un temporizador de vigilancia incorporado.  Pero como ha demostrado la pr√°ctica, a veces todav√≠a hay situaciones en las que no puede hacer frente y el sistema se congela.  Un temporizador de vigilancia de hardware externo est√° dise√±ado para hacer frente a situaciones de emergencia.  Configurado para un retraso de 64 segundos.  Conectado a la TX TX: durante la operaci√≥n, el sistema escribe constantemente informaci√≥n de depuraci√≥n en Serial y la falta de actividad durante m√°s de un minuto indica un bloqueo del sistema. </li><li>  Expansor de puerto: 74HC595: el uso de este expansor requiere 4 patas del controlador, tres para transmitir el estado y una para que los rel√©s no hagan clic cuando se aplica energ√≠a.  La pr√≥xima vez usar√© PCF8574: el bus i2c todav√≠a se usa, es decir  no se requieren patas MCU adicionales y las salidas 1 se configuran cuando se aplica energ√≠a. </li><li>  M√≥dulo de rel√©: Sin nombre, 8 canales, 5 V: no hay nada que decir, excepto que el rel√© se enciende a un nivel bajo en las entradas del m√≥dulo.  Los rel√©s de estado s√≥lido no est√°n permitidos en este proyecto, ya que  Los contactos de la caldera deben cambiarse mediante un contacto seco; en general, no conozco el voltaje y la corriente continua o alterna en los contactos. </li></ul><br><h2>  Sistema operativo </h2><br>  El sistema operativo es todo el software que garantiza la operatividad del programa de aplicaci√≥n.  El sistema operativo tambi√©n es una capa entre el hardware y el programa de aplicaci√≥n, que proporciona una interfaz de alto nivel para acceder a los recursos de hardware.  En el caso de ESP, los componentes del sistema operativo pueden considerarse: <br><br><h3>  Sistema de archivos </h3><br>  El proyecto usa SPIFFS, todo parece estar claro aqu√≠, esta es la forma m√°s f√°cil.  Para acceder f√°cilmente a los archivos en el dispositivo desde el exterior, utilizo la biblioteca nailbuster / esp8266FTPServer. <br><br><h3>  Sistema de asignaci√≥n de tiempo de CPU </h3><br>  Esta es una de las funciones principales del sistema operativo y ESP no ser√° una excepci√≥n.  Para la ejecuci√≥n paralela de varios flujos del algoritmo, el objeto global (singleton) Timers es responsable.  La clase es bastante simple y proporciona la siguiente funcionalidad: <br><br><ul><li>  Ejecuci√≥n peri√≥dica de la funci√≥n, con un intervalo especificado.  Ejemplo de inicializaci√≥n del temporizador: <br><br><pre><code class="cpp hljs">Timers.add(doLoop, <span class="hljs-number"><span class="hljs-number">6000</span></span>, F(<span class="hljs-string"><span class="hljs-string">"OneWireSensorsClass::doLoop"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//   ‚Äì  </span></span></code> </pre> </li><li>  Una sola ejecuci√≥n de una funci√≥n despu√©s de un per√≠odo de tiempo especificado.  Por ejemplo, un escaneo retrasado de redes WiFi se realiza de esta manera: <br><br><pre> <code class="cpp hljs">Timers.once([]() { WiFi.scanNetworks(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);}, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> </li></ul><br>  Por lo tanto, la funci√≥n de bucle se ve as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ESP.wdtFeed(); Timers.doLoop(); CPULoadInfo.doLoop(); }</code> </pre><br>  En la pr√°ctica, la funci√≥n de bucle contiene algunas l√≠neas m√°s, que se describir√°n a continuaci√≥n. <br>  Se adjunta una lista de la clase Timers. <br><br><h3>  Contabilidad de tiempo de CPU </h3><br>  Funci√≥n de servicio que no tiene aplicaci√≥n pr√°ctica.  Sin embargo, ella es.  Implementado por el singleton CPULoadInfo.  Cuando se inicializa el objeto, se mide el n√∫mero de iteraciones del bucle vac√≠o durante un corto per√≠odo de tiempo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::init() { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); <span class="hljs-comment"><span class="hljs-comment">//      1 while ((millis() - currTime) &lt; 10) { delay(0); MaxLoopsInSecond++; } MaxLoopsInSecond *= 100; }</span></span></code> </pre> <br>  Luego, contamos el n√∫mero de llamadas de procedimiento de bucle por segundo, calculamos la carga del procesador en porcentaje y guardamos los datos en el b√∫fer: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::doLoop() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> prevTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); LoopsInSecond++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((currTime - prevTime) &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { memmove(CPULoadPercentHistory, &amp;CPULoadPercentHistory[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> load = ((MaxLoopsInSecond - LoopsInSecond) * <span class="hljs-number"><span class="hljs-number">100</span></span>) / MaxLoopsInSecond; CPULoadPercentHistory[<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>] = load; prevTime = currTime; LoopsInSecond = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  El uso de este enfoque le permite obtener el mismo uso de procesador por cada subproceso individual (si conecta este subsistema con la clase Timers), pero como dije, no veo ninguna aplicaci√≥n pr√°ctica para esto. <br><br><h3>  Sistema de entrada-salida </h3><br>  Para comunicarse con el usuario, se utilizan la interfaz UART-USB y WEB.  Pienso en UART, no necesito hablar en detalle.  Lo √∫nico a lo que vale la pena prestar atenci√≥n es por conveniencia y compatibilidad con no ESP, se implementa la funci√≥n serialEvent (): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ if (Serial.available()) serialEvent(); // ‚Ä¶ }</span></span></code> </pre><br>  Con la interfaz WEB, todo es mucho m√°s interesante.  Le dedicamos una secci√≥n separada. <br><br><h3>  Interfaz WEB </h3><br>  En el caso de los dispositivos inteligentes, en mi opini√≥n, la interfaz WEB es la soluci√≥n m√°s f√°cil de usar. <br><br>  Considero que el uso de una pantalla conectada al dispositivo es una pr√°ctica desactualizada: es imposible crear una interfaz simple, conveniente y hermosa cuando se usa una pantalla peque√±a y un conjunto limitado de botones. <br><br>  El uso de programas espec√≠ficos para controlar el dispositivo impone restricciones al usuario, agrega la necesidad de desarrollar y soportar estos programas, y tambi√©n requiere que el desarrollador se encargue de la entrega de estos programas a los dispositivos terminales del usuario.  En el buen sentido, la aplicaci√≥n debe publicarse en las tiendas de aplicaciones de Google, Apple y Windows, y tambi√©n debe estar disponible en repositorios de Linux en forma de paquetes deb y rpm; de lo contrario, el acceso a la interfaz del dispositivo puede ser dif√≠cil para alguna parte de la audiencia. <br><br>  El acceso a la interfaz WEB del dispositivo est√° disponible desde cualquier sistema operativo: Linux, Windows, Android, MacOS, en el escritorio, computadora port√°til, tableta, tel√©fono inteligente, solo para tener un navegador.  Por supuesto, el desarrollador de la interfaz WEB debe tener en cuenta las caracter√≠sticas de varios dispositivos, pero esto se refiere principalmente al tama√±o y la resoluci√≥n.  El acceso a la interfaz WEB de un dispositivo inteligente en una casa / apartamento / caba√±a se proporciona f√°cilmente desde el exterior a trav√©s de Internet; ahora es dif√≠cil imaginar una casa / apartamento en el que haya dispositivos inteligentes y sin enrutador e Internet, y en el enrutador este acceso se configura en unos pocos clics (para aquellos que completamente fuera de tema, las palabras clave ayudar√°n: "reenv√≠o de puertos" y "DNS din√°mico").  En el caso de una residencia de verano, se puede proporcionar acceso mediante un enrutador 3G. <br><br>  Para implementar la interfaz WEB, se requiere un servidor WEB.  Estoy usando la biblioteca me-no-dev / ESPAsyncWebServer.  Esta biblioteca proporciona la siguiente funcionalidad: <br><br><ul><li>  Devoluci√≥n de contenido est√°tico, incluido  con soporte de compresi√≥n gzip.  Los directorios virtuales son compatibles, con la capacidad de especificar un archivo principal (que generalmente es index.htm) para cada directorio. </li><li>  Asignaci√≥n de funciones de devoluci√≥n de llamada a diferentes URL en funci√≥n del tipo de solicitud (GET, POST, ...) </li><li>  Soporte para sockets WEB en el mismo puerto (es importante cuando se reenv√≠a el puerto). </li><li>  Autorizaci√≥n B√ÅSICA.  Adem√°s, la autorizaci√≥n se establece individualmente para cada URL.  Esto es importante porque  por ejemplo, Google Chrome, cuando crea un acceso directo de p√°gina en la pantalla principal, solicita un icono y un archivo de manifiesto y no transfiere datos de autorizaci√≥n.  Por lo tanto, algunos archivos se colocan en un directorio virtual y la autorizaci√≥n est√° deshabilitada para este directorio. </li></ul><br><h3>  Sistema operativo de servicios HTTP </h3><br>  En el proyecto actual, todas las configuraciones del sistema operativo se realizan mediante servicios HTTP.  El servicio HTTP es una peque√±a funcionalidad independiente de recuperaci√≥n / modificaci√≥n de datos disponible a trav√©s de HTTP.  Luego, considere una lista de estos servicios. <br><br><h4>  Ayuda </h4><br>  La implementaci√≥n de cualquier lista de comandos, creo que es correcto comenzar con la implementaci√≥n del equipo HELP.  A continuaci√≥n se muestra el bloque de inicializaci√≥n del servidor WEB: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HTTPserverClass::init() { <span class="hljs-comment"><span class="hljs-comment">//SERVER INIT help_info.concat(F("/'doc_hame.ext': load file from server. Allow methods: HTTP_GET\n")); AsyncStaticWebHandler&amp; handler = server.serveStatic("na/", SPIFFS, "na/"); serveStaticHandlerNA = &amp;handler; //       server.serveStatic("/", SPIFFS, "/"); //    //info //       help_info.concat(F("/info: get system info. Allow methods: HTTP_GET\n")); server.on("/info", HTTP_GET, handleInfo); ‚Ä¶ server.on("/help", HTTP_GET, [](AsyncWebServerRequest *request) { request-&gt;send(200, ContentTypesStrings[ContentTypes::text_plain], help_info.c_str()); }); //    setAuthentication(ConfigStore.getAdminName(), ConfigStore.getAdminPassword()); DefaultHeaders::Instance().addHeader("Access-Control-Allow-Origin", "*"); //  -  //   server.begin(); //       DEBUG_PRINT(F("HTTP server started")); }</span></span></code> </pre><br>  ¬øPor qu√© necesito un sistema de ayuda? Creo que no vale la pena contarlo.  Algunos desarrolladores posponen la implementaci√≥n del sistema de ayuda para m√°s adelante, pero este "m√°s tarde" generalmente no ocurre.  Es mucho m√°s f√°cil implementarlo al comienzo del proyecto y complementarlo durante el desarrollo del proyecto. <br>  En mi proyecto, tambi√©n se muestra una lista de posibles servicios con un error 404: no se encontr√≥ la p√°gina.  Actualmente implementa los siguientes servicios: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://tc-demo.vehs.ru/help</a> <br><br><pre> <code class="hljs sql">/'doc_hame.ext': <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> server. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /info: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> info. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">20140527</span></span>T123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /uptime: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> uptime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">123</span></span>D123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /rtc: <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> RTC time. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ? [dir=...] &amp; [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /edit: edit files. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_PUT, HTTP_DELETE, HTTP_POST /wifi: edit wifi settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /wifi-<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span> ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /wifi-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /ap: edit soft ap settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: edit <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> flash. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /restart: restart system. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /ws: web socket url. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">help</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> URLs. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET</code> </pre><br>  Como puede ver, en la lista de servicios no hay servicios de aplicaci√≥n.  Todos los servicios HTTP est√°n relacionados con el sistema operativo.  Cada servicio realiza una peque√±a tarea.  Adem√°s, si el servicio requiere la entrada de cualquier dato, entonces, previa solicitud, GET devuelve un formulario de entrada minimalista: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> USE_RTC_CLOCK help_info.concat(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc: set RTC time. Allow methods: HTTP_GET, HTTP_POST\n"</span></span></span><span class="hljs-meta">)); const char* urlNTP = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">; server.on(urlNTP, HTTP_GET, [](AsyncWebServerRequest *request) { DEBUG_PRINT(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">)); request-&gt;send(200, ContentTypesStrings[ContentTypes::text_html], String(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;head&gt;&lt;title&gt;RTC time&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form method=\"post\" action=\"rtc\"&gt;&lt;input name=\"newtime\" length=\"15\" placeholder=\"yyyyMMddThhmmss\"&gt;&lt;button type=\"submit\"&gt;set&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"</span></span></span><span class="hljs-meta">))); }); server.on(urlNTP, HTTP_POST, handleSetRTC_time); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// USE_RTC_CLOCK</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/cr/-6/na/cr-6napgtebfgiquecvuezhxqia.png"><br><br>  M√°s tarde, este servicio se utiliza en una interfaz m√°s bonita: <br><br><img src="https://habrastorage.org/webt/tt/mn/-o/ttmn-oyhy9v3lygwrk0jk2wzp2o.png"><br><br><h2>  Software de aplicaci√≥n </h2><br>  Finalmente llegamos al punto para el cual se cre√≥ el sistema.  A saber: a la implementaci√≥n de la tarea aplicada. <br><br>  Cualquier aplicaci√≥n debe recibir los datos de origen, procesarlos y producir el resultado.  Tambi√©n es posible que el sistema informe el estado actual. <br><br>  Los datos de origen para el controlador de calefacci√≥n por suelo radiante son: <br><br><ul><li>  Datos del sensor: el sistema no est√° vinculado a sensores espec√≠ficos.  Se genera un identificador √∫nico para cada sensor.  Para los sensores de radio, su identificador se rellena con ceros a 16 bits; para los sensores de 1 cable, CRC16 se calcula en funci√≥n de su identificador interno y se utiliza como el identificador del sensor.  Por lo tanto, todos los sensores tienen identificadores con una longitud de 2 bytes. </li><li>  Datos sobre zonas de calentamiento: el n√∫mero de zonas no es fijo, el n√∫mero m√°ximo est√° limitado por el m√≥dulo de rel√© utilizado.  Dada esta limitaci√≥n, tambi√©n se desarroll√≥ la interfaz WEB. </li><li>  Temperatura objetivo y programa: intent√© hacer las configuraciones m√°s flexibles, puede crear varios esquemas de calefacci√≥n e incluso puede asignar su propio esquema de configuraciones a cada zona. </li></ul><br>  Por lo tanto, hay una serie de configuraciones que deben establecerse de alguna manera, y hay una serie de par√°metros que el sistema informa como el estado actual. <br>  Para la comunicaci√≥n entre el controlador y el mundo exterior, implement√© un int√©rprete de comandos que me permiti√≥ implementar tanto el control del controlador como la recepci√≥n de datos de estado.  Los comandos se transmiten al controlador en forma legible y pueden transmitirse a trav√©s de un conector UART o WEB (si lo desea, puede implementar soporte para otros protocolos, por ejemplo, telnet). <br>  La l√≠nea de comando comienza con el car√°cter '#' y termina con un car√°cter nulo o un car√°cter de nueva l√≠nea.  Todos los comandos consisten en un nombre de comando y un operando, separados por dos puntos.  Para algunos comandos, el operando es opcional; en este caso, los dos puntos y el operando no est√°n especificados.  Los comandos en una l√≠nea est√°n separados por una coma.  Por ejemplo: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#ZonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">SensorsInfo</span></span></code> </pre> <br>  Y, por supuesto, la lista de comandos comienza con el comando Ayuda, que muestra una lista de todos los comandos v√°lidos (por conveniencia, los comandos transmitidos comienzan con '&gt;' en lugar de '#'): <br><br><pre> <code class="hljs dos">&gt;<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Help</span></span> SetZonesCount Zone SetName SetSensor ... LoadCfg SaveCfg #<span class="hljs-built_in"><span class="hljs-built_in">Cmd</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">Help</span></span>,CmdRes:Ok</code> </pre> <br>  Una caracter√≠stica de la implementaci√≥n del int√©rprete de comandos es que la informaci√≥n sobre el resultado de la ejecuci√≥n del comando tambi√©n se emite en forma de un comando o un conjunto de comandos: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">help</span></span> ‚Ä¶ <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Help</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Value</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Error</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span> 123 <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">range</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">SchemasInfo</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SchemasCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:SchemasInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  En el lado del cliente WEB, tambi√©n se implementa un shell que acepta estos comandos y los convierte en una vista gr√°fica.  Por ejemplo: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5680</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DeltaT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:-20</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ZonesInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre> <br>  La interfaz WEB envi√≥ una solicitud al controlador sobre la zona n√∫mero 3, y en respuesta recibi√≥ el nombre de la zona, el identificador del sensor asociado con la zona, el identificador del circuito asignado a la zona y la correcci√≥n de temperatura para la zona.  El caparaz√≥n no comprende n√∫meros fraccionarios, por lo que la temperatura se transmite en d√©cimas de grado, es decir.  12.3 grados son 123 d√©cimas. <br><br>  La caracter√≠stica clave es que el controlador responde a todos los clientes a la vez para cualquier comando, independientemente del m√©todo para ingresar el comando.  Esto le permite mostrar el cambio de estado inmediatamente en todas las sesiones de la interfaz WEB.  Porque  El transporte de intercambio principal entre el controlador y la interfaz WEB son los enchufes WEB, luego el controlador puede transmitir datos sin una solicitud, por ejemplo, cuando los datos nuevos provienen de sensores: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5A20</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:w433th</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">battery</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">button_tx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">channel</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">temperature</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">humidity</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:34</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">uptime_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:130308243</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">time_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20180521T235126</span></span></code> </pre> <br>  O, por ejemplo, que estas zonas deben actualizarse: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">TargetTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:220</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  La interfaz WEB del controlador se basa en el uso de comandos de texto.  En una de las pesta√±as de la interfaz hay un terminal con el que puede ingresar comandos en forma de texto.  Adem√°s, esta pesta√±a, para fines de depuraci√≥n, le permite averiguar qu√© comandos env√≠a y recibe la interfaz WEB con diversas acciones del usuario. <br><br>  El int√©rprete de comandos facilita el cambio y aumenta la funcionalidad del dispositivo al cambiar los comandos existentes y agregar otros nuevos.  Al mismo tiempo, la depuraci√≥n de dicho sistema se simplifica enormemente, porque  La comunicaci√≥n con el controlador se realiza exclusivamente en un lenguaje legible por humanos. <br><br><h2>  Conclusi√≥n </h2><br>  Usando un enfoque similar, a saber: <br><br><ul><li>  Separaci√≥n de software en sistema operativo y programa de aplicaci√≥n </li><li>  Implementaci√≥n de la configuraci√≥n del sistema operativo en forma de servicios HTTP minimalistas </li><li>  Separar la l√≥gica del sistema de la presentaci√≥n de datos </li><li>  Usar protocolos de comunicaci√≥n legibles por humanos </li></ul><br>  le permite crear soluciones que sean comprensibles tanto para los usuarios como para los desarrolladores.  Dichas soluciones son f√°ciles de modificar.  Basado en tales soluciones, es f√°cil construir nuevos dispositivos con una l√≥gica completamente diferente, pero que funcionar√° con los mismos principios.  Puede crear una l√≠nea de dispositivos con el mismo tipo de interfaz: <br><br><img src="https://habrastorage.org/webt/5b/mg/mh/5bmgmh1jpuzsrdjpreb6jw_yopy.png"><br><br>  Como puede ver, en este proyecto solo las primeras tres p√°ginas de la interfaz est√°n directamente relacionadas con la aplicaci√≥n, y el resto son casi universales. <br><br>  En esta publicaci√≥n, describo solo mi opini√≥n sobre la construcci√≥n de dispositivos inteligentes, y en ning√∫n caso pretendo ser la verdad definitiva. <br><br>  Para qui√©n es interesante este tema: escriba, tal vez me equivoque sobre algo, pero tal vez algunos detalles tengan sentido para describir con m√°s detalle. <br><br>  Lo que sucedi√≥ al final: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fiasco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La historia de un IoT casero</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es412889/">https://habr.com/ru/post/es412889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es412877/index.html">Rutenio (Ru): el cuarto elemento con propiedades ferromagn√©ticas a temperatura ambiente</a></li>
<li><a href="../es412879/index.html">Problema n. ¬∞ 24: capacitaci√≥n en TI: problemas y desaf√≠os actuales de compa√±√≠as l√≠deres</a></li>
<li><a href="../es412881/index.html">Bj√∂rn Straustrup: problema con la programaci√≥n</a></li>
<li><a href="../es412885/index.html">Ciencia patol√≥gica</a></li>
<li><a href="../es412887/index.html">Resumen de eventos de TI de junio</a></li>
<li><a href="../es412891/index.html">Citrix XenServer 7.0 I / O no optimizado Management Agent no instalado</a></li>
<li><a href="../es412893/index.html">Para llegar a un programador senior en cuatro a√±os: el m√©todo "Escuela 21"</a></li>
<li><a href="../es412895/index.html">Vesta Matveeva: la lucha contra el cibercrimen es una elecci√≥n moral</a></li>
<li><a href="../es412897/index.html">Monitoreo de productos Atlassian con Prometheus</a></li>
<li><a href="../es412899/index.html">Lectura de fin de semana: 30 materiales sobre sonido, la historia de las marcas de audio y la industria del cine.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>