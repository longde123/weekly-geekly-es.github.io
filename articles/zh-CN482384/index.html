<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍👦 🧑🏽 👏🏽 我的未实现项目。 200个MikroTik路由器网络 🧒🏻 😽 🧒🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好 本文适用于那些在公园中拥有许多Mikrotik设备并且希望最大程度地统一以便不分别连接每个设备的用户。 在本文中，我将描述一个不幸的项目，该项目由于人为因素未能达到战斗条件。 简而言之：超过200台路由器，快速配置和人员培训，按区域统一，过滤网络和特定主机，轻松向所有设备添加规则，日志记录和...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我的未实现项目。 200个MikroTik路由器网络</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482384/"><img src="https://habrastorage.org/webt/rj/fr/8k/rjfr8k3mzobowrnnzojsvnryi5o.jpeg"><br><br> 大家好 本文适用于那些在公园中拥有许多Mikrotik设备并且希望最大程度地统一以便不分别连接每个设备的用户。 在本文中，我将描述一个不幸的项目，该项目由于人为因素未能达到战斗条件。 简而言之：超过200台路由器，快速配置和人员培训，按区域统一，过滤网络和特定主机，轻松向所有设备添加规则，日志记录和访问控制的能力。 <br><a name="habracut"></a><br> 下面描述的内容并不能算是完整的案例，但是希望对您的网络规划和最小化错误有帮助。 也许有些观点和决定对您来说不合适-如果是这样，请在评论中写下。 在这种情况下，批评将是普通存钱罐中的一种经验。 因此，请读者看一下评论，也许作者犯了一个严重的错误-社区会有所帮助。 <br><br> 路由器的数量为200-300，分布在不同城市的Internet连接质量不同。 有必要将所有事情做得漂亮，并随时向本地管理员说明一切如何工作。 <br><br> 因此，任何项目从哪里开始。 当然，使用<b>TK</b> 。 <br><br><ol><li> 根据客户要求为所有分支机构组织网络计划，进行网络分段（分支机构中从3到20个网络，具体取决于设备的数量）。 </li><li> 在每个分支中配置设备。 在不同的工作条件下检查提供商的实际带宽。 </li><li> 组织设备保护，白名单管理，在一定时间范围内通过自动将其列入黑名单来自动检测攻击，并尽量减少使用各种技术来拦截控制访问和拒绝服务。 </li><li> 根据客户要求，通过网络过滤来组织安全的VPN连接。 每个分支到中心至少3个VPN连接。 </li><li> 根据第1、2段。选择构建容错VPN的最佳方法。 如果承包商正确选择了动态路由技术，则可以选择。 </li><li> 根据客户使用的协议，端口，主机和其他特定服务来组织流量优先级。  （VOIP，提供重要服务的主机） </li><li> 组织监视和记录路由器事件，以响应技术支持人员。 </li></ol><br> 据我们了解，在许多情况下，传统知识是根据需求编制的。 在听完主要问题后，我自己制定了这些要求。 我承认其他人可能会执行这些要点。 <br><br> 将使用哪些工具来满足这些要求： <br><br><ol><li>  ELK堆栈（一段时间后，人们了解到将使用fluentd代替logstash）。 </li><li> 太好了 为了简化管理和共享访问权限，我们将使用AWX。 </li><li>  GITLAB。 无需解释。 没有配置的版本控制的地方。 </li><li> 威力 初始配置将有一个简单的脚本。 </li><li>  Doku Wiki，用于编写文档和手册。 在这种情况下，请使用habr.com。 </li><li> 监视将通过zabbix完成。 将在此处绘制连接图以进行一般理解。 </li></ol><br><h3>  EFK设置时刻 </h3><br> 在第一段中，我将仅描述构建索引所依据的意识形态。 有很多 <br> 关于从运行mikrotik的设备设置和接收日志的优秀文章。 <br><br> 我将在以下几点上做详细说明： <br><br>  1.根据该方案，值得考虑从不同地方和不同端口接收日志。 为此，我们将使用日志聚合器。 此外，我们还希望为所有路由器制定通用时间表，以实现共享访问。 然后我们按如下方式构建索引： <br><br><div class="spoiler">  <b class="spoiler_title">这是流利的配置</b> <div class="spoiler_text"> 类型Elasticsearch <br>  logstash_format为true <br>  index_name mikrotiklogs.north <br>  logstash_prefix mikrotiklogs.north <br>  flush_interval 10秒 <br> 主持人<a href="http://elasticsearch/">elasticsearch</a> ：9200 <br>  9200端口 <br><br></div></div><br> 因此，我们可以根据计划mikrotiklogs.west，mikrotiklogs.south，mikrotiklogs.east组合路由器和分段。 为什么使这个复杂化？ 我们知道我们将拥有200台或更多的设备。 不要跟踪所有内容。 从Elasticsearch 6.8版开始，我们可以访问安全设置（无需购买许可证），因此我们可以在技术支持人员或本地系统管理员之间分配查看权限。 <br> 表格，图表-在这里您只需要同意-可以使用相同的表格，也可以各自使用适合自己的表格。 <br><br>  2.通过记录。 如果启用防火墙规则中的登录，那么我们将使用不带空格的名称。 可以看出，使用流利的简单配置，我们可以过滤数据并制作方便的面板。 在下面的图片中，我的家用路由器。 <br><br><img src="https://habrastorage.org/webt/0r/za/ou/0rzaousdy0qmt6eolcy3dubw1ms.jpeg" alt="图片"><br><br>  3.根据占用的地方和日志。 平均而言，每小时每小时有1000条消息，日志每天占用2-3 mb，这并不算多。  Elasticsearch 7.5版。 <br><br><h3>  ANSI.AWX </h3><br> 对我们来说幸运的是，我们有一个现成的用于路由器的模块 <br> 我指出了AWX，但以下命令仅是最纯形式的ansible-我认为对于使用ansible的用户来说，使用gui awx不会有任何问题。 <br><br> 老实说，我承认在看过其他使用ssh的指南之前，每个人在响应时间和其他问题上都有不同的问题。 我再说一遍，它并没有进入战斗，将这些信息作为一次实验，并没有超出20台路由器的范围。 <br><br> 我们需要使用证书或会计。 由您决定，我需要证书。 关于权利的一些微妙之处。 我具有写权限-至少无法完成“重置配置”。 <br><br> 生成，复制证书和导入应该没有问题： <br><br><div class="spoiler">  <b class="spoiler_title">队伍短名单</b> <div class="spoiler_text"> 在您的电脑上 <br>  ssh-keygen -t RSA，回答问题，保存密钥。 <br> 复制到mikrotik： <br> 用户ssh-keys导入public-key-file = id_mtx.pub user = ansible <br> 首先，您需要创建一个帐户并为其分配权限。 <br> 通过证书检查连接 <br>  ssh -p 49475 -i /键/ mtx ansible@192.168.0.120 <br><br> 我们写vi / etc / ansible /主机 <br>  MT01 ansible_network_os =路由器oss ansible_ssh_port = 49475 ansible_ssh_user = ansible <br>  MT02 ansible_network_os =路由器oss ansible_ssh_port = 49475 ansible_ssh_user = ansible <br>  MT03 ansible_network_os =路由器oss ansible_ssh_port = 49475 ansible_ssh_user = ansible <br>  MT04 ansible_network_os =路由器oss ansible_ssh_port = 49475 ansible_ssh_user = ansible <br></div></div><br><div class="spoiler">  <b class="spoiler_title">好吧，一个剧本的例子：</b> <div class="spoiler_text">  -名称：add_work_sites <br> 主持人：testmt <br> 序列号：1 <br> 连接：network_cli <br>  remote_user：mikrotik.west <br>  collect_facts：是 <br> 任务： <br>  -名称：添加Work_sites <br>  routeros_command： <br> 命令： <br>  -/ ip防火墙地址列表添加地址= gov.ru列表= work_sites注释= Ticket665436_Ochen_nado <br>  -/ ip防火墙地址列表添加地址= habr.com列表= work_sites注释= for_habr <br></div></div><br> 从上面的配置可以看到，编译您的剧本非常容易。 掌握cli mikrotik就足够了。 设想一种情况，在所有路由器上，您都需要删除包含某些数据的地址列表，然后： <br><br><div class="spoiler">  <b class="spoiler_title">查找和删除</b> <div class="spoiler_text">  / ip firewal地址列表删除[查找列表=“ gov.ru”] <br></div></div><br> 我故意没有在此处插入防火墙的整个清单。 每个项目都将是单独的。 但是可以肯定的是，仅使用地址列表。 <br><br> 通过GITLAB，一切都清楚了。 我不会在这一刻详述。 对于单独的任务，模板，处理程序，一切都很漂亮。 <br><br><h3> 动力壳 </h3><br> 将有3个文件。 为什么使用powershell？ 任何人都可以选择生成配置的工具。 在这种情况下，每个人的PC上都有窗口，所以为什么在Powershell更方便的情况下在bash上执行此操作。 给谁比较方便。 <br><br><div class="spoiler">  <b class="spoiler_title">脚本本身（简单明了）：</b> <div class="spoiler_text">  [cmdletBinding（）] <br> 参数（ <br>  [参数（必填= $ true）] <br>  [string] $ EXTERNALIPADDRESS， <br>  [参数（必填= $ true）] <br>  [string] $ EXTERNALIPROUTE， <br>  [参数（必填= $ true）] <br>  [string] $ BWorknets， <br>  [参数（必填= $ true）] <br>  [string] $ CWorknets， <br>  [参数（必填= $ true）] <br>  [string] $ BVoipNets， <br>  [参数（必填= $ true）] <br>  [string] $ CVoipNets， <br>  [参数（必填= $ true）] <br>  [string] $ CClientss， <br>  [参数（必填= $ true）] <br>  [string] $ BVPNWORKs， <br>  [参数（必填= $ true）] <br>  [string] $ CVPNWORKs， <br>  [参数（必填= $ true）] <br>  [string] $ BVPNCLIENTSs， <br>  [参数（必填= $ true）] <br>  [string] $ cVPNCLIENTSs， <br>  [参数（必填= $ true）] <br>  [string] $ NAMEROUTER， <br>  [参数（必填= $ true）] <br>  [string] $ ServerCertificates， <br>  [参数（必填= $ true）] <br>  [string] $ infile， <br>  [参数（必填= $ true）] <br>  [string] $ outfile <br>  ） <br><br> 获取内容$ infile |  Foreach对象{$ _。替换（“ EXTERNIP”，$ EXTERNALIPADDRESS）} | <br>  Foreach对象{$ _。替换（“ EXTROUTE”，$ EXTERNALIPROUTE）} | <br>  Foreach对象{$ _。替换（“ BWorknet”，$ BWorknets）} | <br>  Foreach对象{$ _。替换（“ CWorknet”，$ CWorknets）} | <br>  Foreach对象{$ _。替换（“ BVoipNet”，$ BVoipNets）} | <br>  Foreach对象{$ _。替换（“ CVoipNet”，$ CVoipNets）} | <br>  Foreach对象{$ _。替换（“ CClients”，$ CClientss）} | <br>  Foreach对象{$ _。替换（“ BVPNWORK”，$ BVPNWORKs）} | <br>  Foreach对象{$ _。替换（“ CVPNWORK”，$ CVPNWORKs）} | <br>  Foreach对象{$ _。Replace（“ BVPNCLIENTS”，$ BVPNCLIENTSs）} | <br>  Foreach对象{$ _。替换（“ CVPNCLIENTS”，$ cVPNCLIENTSs）} | <br>  Foreach对象{$ _。Replace（“ MYNAMERROUTER”，$ NAMEROUTER）} | <br>  Foreach对象{$ _。替换（“ ServerCertificate”，$ ServerCertificates）} | 设置内容$ outfile <br></div></div><br><br> 请原谅我，我不能列出所有规则，因为 它不会很漂亮。 您可以在最佳实践的指导下自己制定规则。 <br><br><div class="spoiler">  <b class="spoiler_title">例如，这是我受其引导的链接列表：</b> <div class="spoiler_text">  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/手册</a> ：Securing_Your_Router <br>  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/手册</a> ：IP /防火墙/过滤器 <br>  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/Manual：OSPF</a>示例 <br>  <a href="https://wiki.mikrotik.com/wiki/Drop_port_scanners">wiki.mikrotik.com/wiki/Drop_port_scanners</a> <br>  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/Manual：Winbox</a> <br>  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/手册</a> ： <a href="https://wiki.mikrotik.com/wiki/Manual">Upgradeing_RouterOS</a> <br>  <a href="https://wiki.mikrotik.com/wiki/Manual">wiki.mikrotik.com/wiki/Manual：IP</a> / <a href="https://wiki.mikrotik.com/wiki/Manual">快速通道</a> -在这里您需要知道，启用快速通道时，对流量进行优先级排序和整形的规则将不起作用-对弱设备有用。 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">变量符号：</b> <div class="spoiler_text"> 以以下网络为例： <br>  192.168.0.0/24工作网络 <br>  172.22.4.0/24 VOIP网络 <br>  10.0.0.0/24网络（无局域网访问） <br> 大型分支机构的192.168.255.0/24 VPN网络 <br>  172.19.255.0/24小型VPN网络 <br><br> 网络地址由4个十进制数字组成，分别为ABCD，替换按照相同的原理工作，如果启动时要求输入B，则需要为网络192.168.0.0/24输入一个数字0，对于C = 0。 <br>  $ EXTERNALIPADDRESS-提供者的专用地址。 <br>  $ EXTERNALIPROUTE-到网络的默认路由是0.0.0.0/0 <br>  $ BWorknets-工作网络，在我们的示例中将为168 <br>  $ CWorknets-工作网络，在我们的示例中为0 <br>  $ BVoipNets-这里的示例中的VOIP网络22 <br>  $ CVoipNets-这里的示例中的VOIP网络4 <br>  $ CClientss-客户网络-仅Internet访问，此处为0 <br>  $ BVPNWORKs-大型分支机构的VPN网络，在我们的示例20中 <br>  $ CVPNWORKs-大型分支机构的VPN网络，在我们的示例中为255 <br>  $ BVPNCLIENTS-小型分支机构的VPN网络，然后是19 <br>  $ CVPNCLIENTS-小型分支机构的VPN网络，表示255 <br>  $ NAMEROUTER-路由器的名称 <br>  $ ServerCertificate-您预先导入的证书名称 <br>  $ infile-指定从中读取配置文件的路径，例如D：\ config.txt（英文路径最好不要带引号和空格） <br>  $ outfile-指示保存路径，例如D：\ MT-test.txt <br></div></div><br> 出于明显的原因，我有意更改了示例中的地址。 <br><br> 我略过了检测攻击和异常行为的要点-这值得一提。 但值得指出的是，在此类别中，您可以将监控数据的值与Zabbix结合使用+通过elasticsearch计算出卷曲数据。 <br><br>  <b>在什么时候您需要关注：</b> <br><br><ol><li> 网络计划。 最好使其立即可读。 足够了。 不幸的是，我经常看到网络是按照以下原则编译的：“出现了一个新分支，这里是/ 24”。 没有人知道应该在给定位置放置多少台设备以及是否会进一步增长。 例如，开了一家小商店，最初很明显该设备将不超过10，为什么分配/ 24？ 相反，在大型分支机构中-他们分配/ 24，并且有500台设备-您可以只添加一个网络，但您想立即考虑所有问题。 </li><li> 过滤规则。 如果项目假定网络和最大细分之间将存在分离。 最佳做法会随着时间而变化。 以前，他们共享一个PC网络和一个打印机网络，现在不共享这些网络是很正常的。 值得使用常识，不要在不需要它们的地方创建很多子网，也不要将所有设备都连接到一个网络中。 </li><li> 所有路由器上的“黄金”设置。 即 如果您已决定一个计划。 值得立即预见所有内容并尝试确保所有设置都相同-只有不同的地址列表和ip地址。 如果出现问题，调试时间将更少。 </li><li> 组织问题同技术问题一样重要。 通常，懒惰的员工会“手动”遵循这些建议，而不使用现成的配置和脚本，这最终会导致从头开始的问题。 </li></ol><br> 通过动态路由。 使用带分区的OSPF。 但这是一个试验台，在战斗条件下，进行此类设置更有趣。 <br><br> 我希望没有人不发布路由器的配置而感到沮丧。 我认为将有足够的链接，然后一切都取决于需求。 当然，测试还需要更多测试。 <br><br> 我希望每个人都能在新的一年中实施他们的项目。 是的，授予访问权限将伴随您！！！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482384/">https://habr.com/ru/post/zh-CN482384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482366/index.html">机器人专家对特斯拉自动驾驶仪有何看法</a></li>
<li><a href="../zh-CN482370/index.html">nodejs：流程管理器和ES6模块</a></li>
<li><a href="../zh-CN482372/index.html">在Hyper-V中为Arch Linux guest虚拟机启用增强的会话模式</a></li>
<li><a href="../zh-CN482378/index.html">Wacom的简史：图形输入板技术如何应用​​于电子阅读器</a></li>
<li><a href="../zh-CN482382/index.html">翻译的四个原则，或者一个人不会以什么方式屈服于机器翻译？</a></li>
<li><a href="../zh-CN482386/index.html">Visual Studio for Mac：通过键盘绑定控制IDE</a></li>
<li><a href="../zh-CN482390/index.html">Ember.js教程中的教程。 超级租赁应用程序。 第1.2部分</a></li>
<li><a href="../zh-CN482396/index.html">如何选择教授IT专业的商业课程</a></li>
<li><a href="../zh-CN482398/index.html">从PostgreSQL到Erlang的逻辑复制</a></li>
<li><a href="../zh-CN482400/index.html">有趣的统计事实的选择＃2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>