<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛢️ 👆🏻 🤹🏽 Boot dich selbst, der Frühling kommt (Teil 2) 🖊️ 🍹 🗻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) und Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) sprechen weiterhin über die Verwendung von Sprin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Boot dich selbst, der Frühling kommt (Teil 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) und Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">tolkkv Tolkachev</a> (Cyan.Finance, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> ) sprechen weiterhin über die Verwendung von Spring Boot zur Lösung der Probleme der imaginären Braavos Iron Bank.  Im zweiten Teil konzentrieren wir uns auf die Profile und Feinheiten beim Starten der Anwendung. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Den ersten Teil des Artikels finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </p><br><p>  Also kam der Kunde bis vor kurzem und verlangte nur, einen Raben zu schicken.  Jetzt hat sich die Situation geändert.  Der Winter ist gekommen, die Mauer ist gefallen. </p><br><p> Erstens ändert sich das Prinzip der Kreditvergabe.  Wenn sie früher mit einer Wahrscheinlichkeit von 50% an alle außer Starks ausgegeben haben, geben sie jetzt nur an diejenigen aus, die Schulden zurückzahlen.  Daher ändern wir die Regeln für die Ausgabe von Krediten in unserer Geschäftslogik.  Aber nur für Filialen der Bank, die sich dort befinden, wo bereits der Winter gekommen ist, bleibt im Übrigen alles wie bisher.  Ich erinnere Sie daran, dass dies ein Dienst ist, der entscheidet, ob ein Darlehen gewährt wird oder nicht.  Wir werden nur einen weiteren Service anbieten, der nur im Winter funktioniert. </p><br><p>  Wir gehen zu unserer Geschäftslogik: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  Wir haben bereits eine Liste derjenigen, die Schulden zurückzahlen. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  Und es gibt eine Klasse, die bereits mit Eigentum verbunden ist - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  Wie in früheren Zeiten injizieren wir es einfach hier: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Denken Sie an die Konstruktorinjektion (über magische Anmerkungen): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Fast fertig. </p><br><p>  Jetzt dürfen wir nur an diejenigen ausgeben, die Schulden zurückzahlen: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Aber hier haben wir ein kleines Problem.  Jetzt haben wir zwei Implementierungen: den alten und den neuen Dienst. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend… - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper… - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  Es ist logisch, diese Beans in verschiedene Profile aufzuteilen.  <code></code> <code></code> und <code></code> .  Lassen Sie unseren neuen Service nur im <code></code> Profil <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Und der alte Service ist im <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  Aber der Winter kommt langsam.  In den Königreichen neben der zerbrochenen Mauer ist bereits Winter.  Aber irgendwo im Süden - noch nicht.  Das heißt,  Anwendungen in verschiedenen Branchen und Zeitzonen sollten unterschiedlich funktionieren.  Entsprechend den Bedingungen unserer Aufgabe können wir die alte Implementierung, in der der Winter gekommen ist, nicht löschen und die neue Klasse verwenden.  Wir möchten, dass die Bankangestellten überhaupt nichts tun: Wir liefern ihnen eine Anwendung, die im Sommermodus funktioniert, bis der Winter kommt.  Und wenn der Winter kommt, starten sie ihn einfach neu und das wars.  Sie müssen den Code nicht ändern und keine Klassen löschen.  Daher haben wir zunächst zwei Profile: Ein Teil des Behälters wird im Sommer und ein Teil des Behälters im Winter erstellt. </p><br><p>  Aber ein anderes Problem tritt auf: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Jetzt haben wir keine einzige Bean, da wir zwei Profile angegeben haben und die Anwendung im Standardprofil startet. </p><br><p>  Wir haben also eine neue Anforderung vom Kunden. </p><br><h2>  Eisengesetz 2. Kein Profil ist erlaubt </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  Wir wollen den Kontext nicht erhöhen, wenn das Profil nicht aktiviert ist, da der Winter bereits gekommen ist und alles sehr schlecht geworden ist.  Es gibt bestimmte Dinge, die passieren sollten oder nicht, je nachdem, ob der <code></code> oder der <code></code> .  Schauen Sie sich auch die Ausnahme an, deren Text oben angegeben ist.  Er erklärt nichts.  Ein Profil ist nicht definiert, daher gibt es keine Implementierung von <code>ProphetService</code> .  Gleichzeitig sagte niemand, dass es notwendig sei, ein Profil festzulegen. </p><br><p>  Aus diesem Grund möchten wir jetzt ein zusätzliches Teil in unseren Starter schrauben, das beim Erstellen des Kontexts überprüft, ob ein bestimmtes Profil festgelegt ist.  Wenn es nicht gesetzt ist, werden wir nicht hochgehen und nur eine solche Ausnahme auslösen (und keine Ausnahme über das Fehlen eines Behälters). </p><br><p>  Können wir dies mit unserem Anwendungs-Listener tun?  Nein.  Dafür gibt es drei Gründe: </p><br><ul><li>  Der Hörer mit Einzelverantwortung ist dafür verantwortlich, dass der Rabe fliegt.  Der Listener sollte nicht prüfen, ob ein Profil aktiviert wurde, da das Aktivieren eines Profils nicht nur den Listener selbst betrifft, sondern auch vieles mehr. </li><li>  Wenn ein Kontext erstellt wird, passieren verschiedene Dinge.  Und wir möchten nicht, dass sie auftreten, wenn kein Profil festgelegt wurde. </li><li>  Listener arbeitet ganz am Ende, wenn der Kontext aufgelöst wird.  Und die Tatsache, dass es kein Profil gibt, wissen wir viel früher.  Warum auf diese bedingten fünf Minuten warten, bis der Service fast steigt und dann alles fällt? </li></ul><br><p>  Außerdem weiß ich immer noch nicht, welche Fehler auftreten werden, da wir ohne Profil zu steigen begannen (angenommen, ich kenne die Geschäftslogik nicht).  In Ermangelung eines Profils ist es daher erforderlich, den Kontext sehr früh zu reduzieren.  Wenn Sie eine Spring Cloud verwenden, wird dies übrigens für Sie noch relevanter, da die Anwendung viele Dinge in einem frühen Stadium erledigt. </p><br><p>  Um die neue Anforderung zu implementieren, gibt es <code>ApplicationContextInitializer</code> .  Dies ist eine weitere Schnittstelle, mit der wir einen bestimmten Punkt des Frühlings erweitern können, indem wir ihn in spring.factories angeben. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  Wir implementieren diese Schnittstelle und haben einen Context Initializer mit einem <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Damit können wir die Umwelt schaffen - das, was SpringApplication für uns vorbereitet hat.  Das gesamte Eigentum, das wir ihm übergeben haben, ist dort angekommen.  Sie enthalten unter anderem auch Profile. </p><br><p>  Wenn dort keine Profile vorhanden sind, sollten wir eine Ausnahme auslösen, die besagt, dass Sie so nicht arbeiten können. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Jetzt müssen Sie dieses Zeug in spring.factories registrieren. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  Anhand der obigen Ausführungen können Sie erraten, dass <code>ApplicationContextInitializer</code> ein Erweiterungspunkt ist.  <code>ApplicationContextInitializer</code> funktioniert, wenn der Kontext gerade erst erstellt wird. Es sind noch keine Bins vorhanden. </p><br><p>  Die Frage stellt sich: Wenn wir <code>ApplicationContextInitializer</code> , warum sollte es als Listener nicht in einer Konfiguration geschrieben werden, die sich sowieso erstreckt?  Die Antwort ist einfach: Weil es viel früher funktionieren sollte, wenn es keinen Kontext und keine Konfigurationen gibt.  Das heißt,  es kann noch nicht injiziert werden.  Deshalb schreiben wir es als separates Stück vor. </p><br><p>  Ein Startversuch zeigte, dass alles schnell genug gefallen war und berichtete, dass wir ohne Profil starteten.  Versuchen wir nun, ein Profil anzugeben, und alles funktioniert - der Rabe wird gesendet. </p><br><p>  <code>ApplicationContextInitializer</code> - Wird erfüllt, wenn der Kontext bereits erstellt wurde, aber nichts anderes als die Umgebung darin enthalten ist. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Wer schafft die Umwelt?  Carlson - <code>SpringBootApplication</code> .  Er füllt es mit verschiedenen Meta-Informationen, die dann aus dem Kontext gezogen werden können.  Die meisten Dinge können über <code>@value</code> injiziert werden, etwas kann aus der Umgebung bezogen werden, da wir gerade Profile erhalten haben. </p><br><p>  Hier kommen zum Beispiel verschiedene Eigenschaften: </p><br><ul><li>  welcher Spring Boot bauen kann; </li><li>  die beim Start über die Kommandozeile übertragen werden; </li><li>  systemisch; </li><li>  als Umgebungsvariablen geschrieben; </li><li>  vorgeschrieben in Anwendungseigenschaften; </li><li>  in einigen anderen Eigenschaftendateien registriert. </li></ul><br><p>  All dies wird gesammelt und in ein Umgebungsobjekt gesetzt.  Es enthält auch Informationen darüber, welche Profile aktiv sind.  Das Umgebungsobjekt ist das einzige, was zum Zeitpunkt der Erstellung des Kontexts durch Spring Boot vorhanden ist. </p><br><p>  Ich würde gerne automatisch erraten, wie das Profil aussehen wird, wenn die Leute vergessen haben, es mit ihren Händen zu fragen (wir tun alles, damit Bankangestellte, die ohne Programmierer hilflos genug sind, die Anwendung starten können, damit alles für sie funktioniert, egal was passiert).  Zu diesem Zweck fügen wir unserem Starter etwas hinzu, das das Profil - ob <code></code> oder nicht - abhängig von der Temperatur auf der Straße errät.  Und eine weitere neue magische Oberfläche wird uns allen dabei helfen - <code>EnvironmentPostProcessor</code> , da wir dies tun müssen, bevor <code>ApplicationContextInitializer</code> funktioniert.  Und vor <code>ApplicationContextInitializer</code> gibt es nur <code>EnvironmentPostProcessor</code> . </p><br><p>  Wir implementieren wieder eine neue Schnittstelle.  Es gibt nur eine Methode, die <code>ConfigurableEnvironment</code> auf die gleiche Weise in <code>SpringApplication</code> , da <code>ConfigurableContext</code> noch nicht vorhanden ist (sie ist bereits in <code>SpringInitializer</code> nicht hier; es gibt nur Umgebung). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  In dieser Umgebung können wir das Profil festlegen.  Aber zuerst müssen Sie überprüfen, ob es noch niemand installiert hat.  Daher müssen wir <code>getActiveProfiles</code> überprüfen.  Wenn die Leute wissen, was sie tun, und ein Profil erstellen, werden wir nicht versuchen, für sie zu raten.  Aber wenn es kein Profil gibt, werden wir versuchen, das Wetter zu verstehen. </p><br><p>  Und das zweite - wir müssen verstehen, ob wir jetzt Winter- oder Sommerwetter haben.  Wir werden die Temperatur von <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Unter dieser Bedingung haben wir Winter und können ein neues Profil erstellen.  Wir erinnern uns, dass das Profil <code></code> heißt: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Jetzt müssen wir den <code>EnvironmentPostProcessor</code> in spring.factories angeben. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  Infolgedessen startet die Anwendung ohne Profil. Wir sagen, dass es sich um eine Produktion handelt, und prüfen, in welchem ​​Profil sie bei uns gestartet wurde.  Magischerweise haben wir erkannt, dass unser Profil <code></code> .  Und die Anwendung ist nicht gefallen, da als nächstes der <code>ApplicationContextInitializer</code> folgt, der prüft, ob ein Profil vorhanden ist. <br>  Das Ergebnis: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Wir haben über <code>EnvironmentPostProcessor</code> , der vor <code>ApplicationContextInitializer</code> .  Aber wer leitet es? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  Dieser Freak startet es, was anscheinend der uneheliche Sohn von <code>ApplicationListener</code> und <code>EnvironmentPostProcessor</code> , da es sowohl von <code>ApplicationListener</code> als auch von <code>EnvironmentPostProcessor</code> geerbt wird.  Es heißt <code>ConfigFileApplicationListener</code> (warum "ConfigFile" - niemand weiß). </p><br><p>  Er ist unser Carlson, d.h.  Spring Application bietet eine vorbereitete Umgebung zum Abhören von zwei Ereignissen: <code>ApplicationPreparedEvent</code> und <code>ApplicationEnvironmentPreparedEvent</code> .  Wir werden jetzt nicht analysieren, wer diese Ereignisse auslöst.  Es gibt noch eine weitere Ebene (meiner Meinung nach ist sie zumindest in dieser Phase der Frühjahrsentwicklung bereits völlig überflüssig), die ein Ereignis auslöst, bei dem die Erstellung der Umgebung beginnt (Application.yml, Eigenschaften, Umgebungsvariablen werden analysiert usw.). ) <br>  Nachdem der Listener <code>ApplicationEnvironmentPreparedEvent</code> , muss er die Umgebung konfigurieren. Suchen Sie den gesamten <code>EnvironmentPostProcessor</code> und lassen Sie ihn arbeiten. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  Danach weist er <code>SpringFactoriesLoader</code> an, alles, was Sie bestellt haben, nämlich alle <code>EnvironmentPostProcessor</code> , an spring.factories zu liefern.  Anschließend wird der gesamte <code>EnvironmentPostProcessor</code> in einer Liste zusammengefasst. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  und versteht, dass auch er (gleichzeitig) ein <code>EnvironmentPostProcessor</code> , deshalb drängt er sich dorthin, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  Gleichzeitig werden sie sortiert, mit ihnen <code>postProcessEnvironment</code> und die <code>postProcessEnvironment</code> jeder Methode <code>postProcessEnvironment</code> . </p><br><p>  Auf diese Weise werden alle <code>postProcessEnvironment</code> frühzeitig vor <code>SpringApplicationInitializer</code> .  In diesem Fall wird auch ein unverständlicher <code>EnvironmentPostProcessor</code> namens <code>ConfigFileApplicationListener</code> . </p><br><p>  Wenn die Umgebung eingerichtet ist, kehrt alles wieder zu Carlson zurück. </p><br><p>  Wenn die Umgebung bereit ist, können Sie einen Kontext erstellen.  Und Carlson beginnt, mit dem <code>ApplicationInitializer</code> einen Kontext aufzubauen.  Hier haben wir unser eigenes Stück, das überprüft, ob es im Kontext eine Umgebung gibt, in der es aktive Profile gibt.  Wenn nicht, fallen wir, weil wir sonst später noch Probleme haben werden.  Dann arbeiten die Starter mit allen üblichen Konfigurationen bereits. </p><br><p>  Das Bild oben zeigt, dass der Frühling auch nicht gut läuft.  Solche Außerirdischen treffen sich dort regelmäßig, einzelne Verantwortung wird nicht respektiert und Sie müssen vorsichtig klettern. </p><br><p>  Jetzt wollen wir ein wenig über die andere Seite dieser seltsamen Kreatur sprechen, die auf der einen Seite Listener und auf der anderen <code>EnvironmentPostProcessor</code> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  Wie <code>EnvironmentPostProcessor</code> es application.yml, Anwendungseigenschaften, alle Arten von Umgebungsvariablen, Befehlsargumente usw. laden.  Und als Zuhörer kann er zwei Ereignisse anhören: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  Die Frage ist: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  Alle diese Ereignisse waren im alten Frühling.  Und diejenigen, über die wir oben gesprochen haben, sind Ereignisse von Spring Boot (besondere Ereignisse, die er für seinen Lebenszyklus hinzugefügt hat).  Und es gibt eine ganze Reihe von ihnen.  Dies sind die wichtigsten: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  Diese Liste ist weit von allem entfernt.  Es ist jedoch wichtig, dass sich einige von ihnen auf Spring Boot beziehen und sich auf Spring beziehen (gutes altes <code>ContextRefreshedEvent</code> usw.). </p><br><p>  Die Einschränkung ist, dass nicht alle diese Ereignisse in der Anwendung enthalten sind (bloße Sterbliche - verschiedene Großmütter - können nicht nur die komplexen Ereignisse hören, die Spring Boot auslöst).  Wenn Sie jedoch die geheimen Mechanismen von spring.factories kennen und Ihren Application Listener auf der Ebene von spring.factories definieren, werden Sie von diesen Ereignissen ab dem frühesten Stadium des Anwendungsstarts erfasst. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  Dadurch können Sie den Start Ihrer Bewerbung frühzeitig beeinflussen.  Der Witz ist jedoch, dass ein Teil dieser Arbeit in anderen Entitäten ausgeführt wird - wie z. B. <code>EnvironmentPostProcessor</code> und <code>ApplicationContextInitializer</code> . </p><br><p>  Sie könnten alles mit Zuhörern machen, aber es wäre unpraktisch und hässlich.  Wenn Sie alle Ereignisse abhören möchten, die Spring <code>ContextRefreshedEvent</code> , und nicht nur <code>ContextRefreshedEvent</code> und <code>ContextStartedEvent</code> , müssen Sie den Listener nicht wie üblich wie eine Bean registrieren (andernfalls wird er zu spät erstellt).  Es muss auch über spring.factories registriert werden, dann wird es viel früher erstellt. </p><br><p>  Übrigens, als wir uns diese Liste angesehen haben, war uns nicht klar, wann <code>ContextStartedEvent</code> und <code>ContextStoppedEvent</code> überhaupt <code>ContextStartedEvent</code> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  Es stellte sich heraus, dass diese Ereignisse überhaupt nicht funktionieren.  Wir haben lange darüber nachgedacht, welche Ereignisse abgefangen werden sollten, um zu verstehen, dass die Anwendung wirklich gestartet wurde.  Und es stellte sich heraus, dass die Ereignisse, über die wir gesprochen haben, jetzt angezeigt werden, wenn Sie Methoden mit Nachdruck aus dem Kontext ziehen: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  Das heißt,  <code>SpringApplication.run</code> werden nur <code>SpringApplication.run</code> , wenn wir <code>SpringApplication.run</code> , den Kontext <code>ctx.start();</code> und <code>ctx.start();</code> daraus ziehen <code>ctx.start();</code>  oder <code>ctx.stop();</code>  .  Es ist nicht sehr klar, warum dies notwendig ist.  Aber sie gaben Ihnen wieder einen Erweiterungspunkt. </p><br><p>  Hat der Frühling etwas damit zu tun?  Wenn ja, sollte es irgendwo eine Ausnahme geben: </p><br><ul><li> <code>ctx.stop();</code>  (1) </li><li> <code>ctx.start();</code>  (2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  (4) </li></ul><br><p>  In der Tat wird es in der letzten Zeile sein, weil nach <code>ctx.close();</code>  Mit dem Kontext kann nichts gemacht werden.  Rufen Sie jedoch <code>ctx.stop();</code>  vor <code>ctx.start();</code>  - Sie können (Spring ignoriert diese Ereignisse einfach - sie sind nur für Sie). </p><br><p>  Schreiben Sie Ihren Zuhörern, hören Sie sich selbst zu, <code>ctx.stop();</code> Sie sich Ihre Gesetze, was Sie auf <code>ctx.stop();</code> tun <code>ctx.stop();</code>  und was auf <code>ctx.start();</code> zu tun ist <code>ctx.start();</code>  . </p><br><p>  Insgesamt sieht das Interaktions- und Anwendungslebenszyklusdiagramm ungefähr so ​​aus: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  Die Farben hier zeigen verschiedene Lebensabschnitte. </p><br><ul><li>  Blau ist Spring Boot, die Anwendung wurde bereits gestartet.  Dies bedeutet, dass Tomcat-Serviceanfragen, die von Clients eingehen, verarbeitet werden, der gesamte Kontext definitiv ausgelöst wird, alle Beans funktionieren, die Datenbanken verbunden sind usw. </li><li>  Grün - ein Ereignis <code>ContextRefreshedEvent</code> eingetroffen und der Kontext wird erstellt.  Ab diesem Moment arbeiten beispielsweise Anwendungslistener, die Sie entweder durch Festlegen der ApplicationListener-Annotation oder über die gleichnamige Schnittstelle mit einem Generikum implementieren, das auf bestimmte Ereignisse wartet.  Wenn Sie weitere Ereignisse empfangen möchten, müssen Sie denselben springListener in spring.factories schreiben (der übliche Frühling funktioniert hier).  Ein Balken zeigt an, wo der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spring Ripper-</a> Bericht beginnt. </li><li>  Zu einem früheren Zeitpunkt funktioniert SpringApplication, das den Kontext für uns vorbereitet.  Dies ist die Aufgabe der Vorbereitung der Anwendung, die wir als reguläre Spring-Entwickler erstellt haben.  Zum Beispiel konfiguriertes WebXML. </li><li>  Es gibt aber noch frühere Stadien.  Es zeigt wer, wo und für wen es funktioniert. </li><li>  Es gibt immer noch eine graue Phase, in der es unmöglich ist, sich in irgendeiner Weise zu verkeilen.  Dies ist die Phase, in der SpringApplication sofort ausgeführt wird (nur in den Code einsteigen). </li></ul><br><p>  Wenn Sie während des zweiteiligen Berichts bemerkt haben, sind wir von rechts nach links gegangen: Wir haben ganz am Ende angefangen, die vom Starter geflogene Konfiguration verschraubt und dann Folgendes hinzugefügt usw.  Lassen Sie uns nun schnell die gesamte Kette in die entgegengesetzte Richtung sprechen. <br>  Sie schreiben in Ihre Hauptdatei <code>SpringApplication.run</code> .  Er findet verschiedene Zuhörer, wirft ihnen ein Ereignis zu, das er zu bauen begann.  Danach finden die Listener <code>EnvironmentPostProcessor</code> und lassen sie die Umgebung konfigurieren.  Sobald die Umgebung eingerichtet ist, beginnen wir mit dem Aufbau des Kontexts (Carlson tritt ein).  Carlson erstellt den Kontext und ermöglicht allen Anwendungsinitialisierern, etwas mit diesem Kontext zu tun.  Wir haben einen Erweiterungspunkt.  Danach ist der Kontext bereits konfiguriert und dann beginnt das gleiche wie in der üblichen Spring-Anwendung, wenn der Kontext erstellt wird - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , die Beans werden konfiguriert.  Das macht der gewöhnliche Frühling. </p><br><h2>  Wie man läuft </h2><br><p>  Wir haben den Prozess des Schreibens einer Bewerbung abgeschlossen. </p><br><p>  Aber wir hatten noch eine Sache, die Entwickler nicht mögen.  Sie denken nicht gerne darüber nach, wie ihre Bewerbung am Ende beginnen wird.  Wird der Administrator es in Tomcat, JBoss oder in WebLogic ausführen?  Es muss einfach funktionieren.  Wenn es nicht funktioniert, muss der Entwickler im schlimmsten Fall etwas neu konfigurieren </p><br><p>  Was sind unsere Startmethoden? </p><br><ul><li>  Katerkrieg; </li><li>  Idee; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  Tomcat ist kein Massentrend, wir werden nicht im Detail darüber sprechen. </p><br><p>  Idee ist auch im Prinzip nicht sehr interessant.  Es ist nur ein bisschen kniffliger als ich weiter unten sagen werde.  Aber in der Idee sollte es im Prinzip keine Probleme geben.  Sie sieht, welche Abhängigkeiten der Starter mit sich bringen wird. <br>  Wenn wir <code>java -jar</code> , besteht das Hauptproblem darin, einen Klassenpfad zu erstellen, bevor wir die Anwendung starten. </p><br><p>  Was haben die Leute 2001 gemacht?  Sie schrieben <code>java -jar</code> welches jar ausgeführt werden sollte, dann wurden dort ein Leerzeichen, ein <code>classpath=...</code> und Skripte angegeben.  In unserem Fall wurden 150 MB verschiedener Abhängigkeiten hinzugefügt.  Und das alles müsste manuell gemacht werden.  Das macht natürlich niemand.  Wir schreiben einfach: <code>java -jar</code> , welches Glas soll ausgeführt werden und das <code>java -jar</code> .  Irgendwie wird der Klassenpfad noch gebaut.  Wir werden jetzt darüber sprechen. </p><br><p>  Beginnen wir mit der Vorbereitung der JAR-Datei, damit sie auch ohne Tomcat gestartet werden kann.  Bevor Sie <code>java -jar</code> , müssen Sie ein Glas bauen.  Dieses Glas sollte offensichtlich ungewöhnlich sein, eine Art Kriegsanalog, in dem sich alles befindet, einschließlich des eingebetteten Tomcat. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  Als wir das Projekt heruntergeladen haben, hat bereits jemand ein Plug-In in unserem POM registriert.  Hier können Sie übrigens Konfigurationen werfen, aber dazu später mehr.     jar,   Maven  Gradle  ,   jar .      : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>     : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>     war-. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , —    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  Das heißt,     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property — <code>Start-class</code> . </p><br><p>  Das heißt,       .     class path  jar. ,    — <code>org.springframework.boot</code> —   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     —  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> —   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> —   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   –  mainClass: </p><br><ul><li>     –    .     —     main class; </li><li>    – ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    —  exception   ,    main class,  ,     jar-  .  Das heißt,    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  —   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Du kannst.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar —  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     — <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  —      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    — <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     —     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   —     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  </h2><br><p>         ,  Spring Boot —   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring —      Spring Boot.    ,         ,        — , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   —   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Minute der Werbung. 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">«          [Joker Edition]»</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">«Micronaut vs Spring Boot,     ?»</a>  .  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425333/">https://habr.com/ru/post/de425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425323/index.html">"Kaninchenbau." UX Designer im Produktteam</a></li>
<li><a href="../de425325/index.html">DIY Bytecode Interpreter</a></li>
<li><a href="../de425327/index.html">Funktionsprogrammierung: Siebenmal messen, einmal schneiden</a></li>
<li><a href="../de425329/index.html">Einige Ratschläge an die Millennials von den "Oldies". Wie man in unserer digitalen Welt erfolgreich ist</a></li>
<li><a href="../de425331/index.html">Alice hilft Entwicklern, Objekte in Benutzeranforderungen zu finden. NER in Dialogen</a></li>
<li><a href="../de425335/index.html">Unbesiegte Armada Garmin</a></li>
<li><a href="../de425337/index.html">So skalieren Sie Scrum - ein paar Worte zum agilen Entwicklungsframework von Nexus</a></li>
<li><a href="../de425339/index.html">Internetinformationsarchitektur Teil 2</a></li>
<li><a href="../de425341/index.html">Übersicht über „Top 3D Expo. Digitale Bildung 2018 »</a></li>
<li><a href="../de425343/index.html">25 nützliche Kubernetes-Tools: Bereitstellung und Verwaltung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>