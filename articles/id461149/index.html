<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➿ 🍜 🧖🏿 Migrasi MongoDB yang tidak terhalang ke Kubernetes 🧙🏾 👎 🏨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artikel ini melanjutkan materi migrasi RabbitMQ kami baru - baru ini dan didedikasikan untuk MongoDB. Karena kami melayani banyak kluster Kubernet dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migrasi MongoDB yang tidak terhalang ke Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/461149/"><img src="https://habrastorage.org/webt/bs/yp/j2/bsypj2ufj_cj0l5tjgzoxumac_e.png"><br><br>  Artikel ini melanjutkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">materi</a> migrasi RabbitMQ kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">baru</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">baru ini</a> dan didedikasikan untuk MongoDB.  Karena kami melayani banyak kluster Kubernet dan MongoDB, kami telah sampai pada kebutuhan alami untuk memigrasikan data dari satu instalasi ke instalasi lainnya dan melakukannya tanpa downtime.  Skenario utama adalah sama: transfer MongoDB dari server virtual / besi ke Kubernetes atau transfer MongoDB dalam satu cluster Kubernetes (dari satu namespace ke yang lain). <a name="habracut"></a><br><br>  Resep kami ditujukan untuk kasus-kasus ketika cluster MongoDB lama berfungsi (misalnya, dari 3 node dan terletak sudah di K8s atau di server lama) dengan mana aplikasi yang dihosting di Kubernetes bekerja: <br><br><img src="https://habrastorage.org/webt/8d/k8/ny/8dk8nyfnonyyonbrulniylesb6s.png"><br><br>  Bagaimana kita akan mentransfer cluster seperti itu ke produksi baru di Kubernetes? <br><br><h2>  Teori </h2><br>  Algoritma migrasi umum mirip dengan yang dijelaskan dalam situasi dengan RabbitMQ. <br><br>  Penting untuk dicatat bahwa kemampuan untuk pindah membutuhkan server dengan MongoDB dan Kubernetes berada di jaringan yang sama.  Node dari cluster MongoDB akan berkomunikasi satu sama lain melalui IP server lama (di mana instalasi MongoDB lama berada) dan nama DNS pod dari MongoDB di K8s.  Oleh karena itu, pada server besi (dengan instalasi lama), akan perlu untuk meneruskan rute ke pod, dan kemudian mengkonfigurasinya untuk menggunakan server DNS yang berjalan di Kubernetes (atau mendaftarkan nama-nama yang diperlukan di <code>/etc/hosts</code> , meskipun dalam kasus umum lebih baik untuk menghindari kemungkinan ini ) <br><br>  Langkah selanjutnya adalah meningkatkan cluster MongoDB di pod Kubernetes.  Dalam kasus kami, cluster database terdiri dari 3 node dan setiap node terletak di pod yang terpisah dari K8 - namun, jumlahnya mungkin berbeda.  Di ConfigMap Anda perlu menentukan alamat master MongoDB dari instalasi lama: maka node MongoDB yang terletak di pod di K8s akan segera mulai menyinkronkannya. <br><br>  Setelah semua pod naik, cluster MongoDB 6-node terbentuk: <br><br><img src="https://habrastorage.org/webt/6b/7s/eu/6b7seucfvwnqtdziyhuod0huiru.png"><br><br>  Harap perhatikan bahwa pod akan naik untuk waktu yang lama, karena setiap pod dimulai secara bergantian, dan pada saat peluncurannya akan menyinkronkan data dari wizard. <br><br>  Setelah itu, Anda dapat beralih aplikasi untuk menggunakan server MongoDB baru: <br><br><img src="https://habrastorage.org/webt/nf/_b/cc/nf_bcckhuh6ia3xgxzrzcozpmla.png"><br><br>  Dan itu tetap hanya untuk menghapus node lama dari cluster MongoDB, setelah itu langkah dapat dianggap selesai: <br><br><img src="https://habrastorage.org/webt/nn/fm/sq/nnfmsqgo7zxio4avng2ubnzcm3w.png"><br><br>  Kami sering menggunakan skema ini dalam produksi dan, untuk kenyamanan penggunaannya, kami mengimplementasikannya dalam modul <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">addon-operator</a> (kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">baru-baru</a> ini <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengumumkan</a> utilitas ini), yang memungkinkan kami untuk mendistribusikan konfigurasi MongoDB yang khas di banyak kluster.  Kami berencana untuk menerbitkan modul kami dalam waktu dekat, tetapi untuk saat ini kami menyajikan instruksi terpisah yang dengannya Anda dapat mencoba solusi yang diusulkan dalam tindakan dan tanpa menggunakan addon-operator. <br><br><h2>  Kami mencoba dalam praktik </h2><br><h3>  Persyaratan </h3><br>  Detail: <br><br><ul><li>  Cluster Kubernetes (minikube juga cocok); </li><li>  Cluster MongoDB (dapat digunakan pada bare metal, dan dibuat sebagai cluster reguler di Kubernet dari bagan Helm resmi). </li></ul><br>  Dalam contoh yang dijelaskan di bawah ini, cluster lama dengan MongoDB akan disebut <code>mongo-old</code> dan diinstal di cluster Kubernetes yang sama, di mana di masa depan kita akan menginstal yang baru ( <code>mongo-new</code> ). <br><br><h3>  Mempersiapkan cluster lama </h3><br>  1. Untuk contoh yang menunjukkan skema yang dijelaskan dalam tindakan, kami akan membuat kluster MongoDB "lama" (yaitu, akan mengalami migrasi) langsung di Kubernetes (pada kenyataannya, ia juga dapat ditemukan di server terpisah di luar K8).  Untuk melakukan ini, unduh grafik Helm: <br><br><pre> <code class="bash hljs">helm fetch --untar stable/mongodb-replicaset</code> </pre> <br>  ... dan edit sedikit dengan mengatur otorisasi: <br><br><pre> <code class="plaintext hljs">auth: enabled: true adminUser: mongo adminPassword: pa33w0rd # metricsUser: metrics # metricsPassword: password # key: keycontent # existingKeySecret: # existingAdminSecret: # exisitingMetricsSecret:</code> </pre> <br>  Juga di <code>values.yaml</code> Anda dapat mengkonfigurasi sertifikat dan banyak lagi. <br><br>  2. Atur grafik: <br><br><pre> <code class="bash hljs">helm install . --name mongo-old --namespace mongo-old</code> </pre> <br>  Setelah itu, uji coba instalasi "lama" MongoDB akan diluncurkan: <br><br><pre> <code class="bash hljs">kubectl --namespace=mongo-old get pods</code> </pre> <br><img src="https://habrastorage.org/webt/4r/zz/98/4rzz98piyayem0kpw2jcdqrdb_q.png"><br><br>  Mari kita pergi ke pod dengan masternya dan membuat basis tes: <br><br><pre> <code class="bash hljs">kubectl --namespace=mongo-old <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -ti mongo-old-mongodb-replicaset-0 mongo use admin db.auth(<span class="hljs-string"><span class="hljs-string">'mongo'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>) use music db.artists.insert({ artistname: <span class="hljs-string"><span class="hljs-string">"The Tea Party"</span></span> }) show dbs</code> </pre> <br><img src="https://habrastorage.org/webt/vn/4d/ld/vn4dldit0pmgpb_3mz4hhbhhgjq.png"><br><br>  Pergi ke pod yang berbeda, saya menemukan bahwa masternya adalah <code>mongo-old-mongodb-replicaset-0</code> .  Namun, untuk solusi yang lebih mudah untuk masalah ini, setelah menginstal Helm-chart, sebuah perintah ditampilkan tentang cara menentukan <code>MASTER_POD</code> .  Dalam kasus saya (untuk <code>mongo-old</code> dari 3 node) kelihatannya seperti ini: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ((i = 0; i &lt; 3; ++i)); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> kubectl <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> --namespace mongo-old mongo-old-mongodb-replicaset-<span class="hljs-variable"><span class="hljs-variable">$i</span></span> -- sh -c <span class="hljs-string"><span class="hljs-string">'mongo --eval="printjson(rs.isMaster())"'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Mengenai hal ini, persiapan instalasi MongoDB lama, yang datanya akan ditransfer, siap. <br><br><h3>  Migrasi Cluster MongoDB </h3><br>  Sekarang kami akan menggunakan instalasi MongoDB baru, yang akan berlokasi di Kubernetes dan digunakan oleh aplikasi dalam produksi. <br><br>  <i><b>NB</b> : Harap dicatat bahwa versi MongoDB yang sama harus digunakan seperti sebelumnya.</i>  <i>Jika tidak, ada risiko masalah kompatibilitas.</i> <br><br>  Dengan analogi dengan bagian sebelumnya (di mana kita meniru instalasi MongoDB "lama"), kita mengambil Helm-chart yang sudah disebutkan (menggunakan perintah <code>helm fetch</code> ) dan mengkonfigurasi otorisasi, serta parameter lainnya, jika digunakan.  Selain itu, kami akan memperbaiki file <code>init/on-start.sh</code> dengan menambahkan sementara pada baris 165 alamat wizard yang diperoleh pada langkah sebelumnya (atau diketahui oleh Anda dari instalasi MongoDB pada server terpisah): <br><br><pre> <code class="bash hljs">peers=<span class="hljs-string"><span class="hljs-string">'mongo-old-mongodb-replicaset-0.mongo-old-mongodb-replicaset.mongo-old.svc.cluster.local:27017'</span></span></code> </pre> <br>  Kami siap membuat instalasi MongoDB baru: <br><br><pre> <code class="bash hljs">helm install . --name mongo-new --namespace mongo-new</code> </pre> <br>  Kami menunggu hingga semua pod memulai (jika ada banyak data, maka peluncurannya bisa memakan waktu berjam-jam): <br><br><img src="https://habrastorage.org/webt/ml/nd/qq/mlndqqjwkem8wb2jaoqm2f-v9ca.png"><br><br>  Sekarang kami membuat <code>exec</code> di pod baru dan melihat daftar pangkalan: <br><br><pre> <code class="bash hljs">kubectl --namespace=mongo-new <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -ti mongo-new-mongodb-replicaset-0 mongo</code> </pre> <br><img src="https://habrastorage.org/webt/np/du/rd/npdurd5ummgmodiawop0bi2c4w8.png"><br><br>  Dua cluster MongoDB digabungkan menjadi satu, terdiri dari 6 node. <br><br>  Saat ini, Anda sudah bisa beralih aplikasi ke cluster baru, tetapi beberapa langkah tetap untuk menyelesaikan migrasi. <br><br>  Dari file <code>init/on-start.sh</code> di instalasi baru, kami menghapus baris yang kami tambahkan: <br><br><pre> <code class="bash hljs">peers=<span class="hljs-string"><span class="hljs-string">'mongo-old-mongodb-replicaset-0.mongo-old-mongodb-replicaset.mongo-old.svc.cluster.local:27017'</span></span></code> </pre> <br>  Sekarang mari kita masuk ke master lama dari cluster dan "menggulingkan" itu - maka master baru akan ditugaskan di cluster.  Kami masuk ke pod dengan master MongoDB: <br><br><pre> <code class="bash hljs">kubectl --namespace=mongo-old <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -ti mongo-old-mongodb-replicaset-0 mongo use admin db.auth(<span class="hljs-string"><span class="hljs-string">'mongo'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>)</code> </pre> <br>  Setelah itu, kami mengubah prioritas node dan mengubah wisaya: <br><br><pre> <code class="bash hljs">cfg = rs.conf() cfg.members[5].priority = 2 rs.reconfig(cfg) rs.stepDown(120)</code> </pre> <br>  Node saat ini telah berhenti menjadi master - pemilihan baru akan terjadi.  Saat kami mengubah prioritas, simpul yang kita butuhkan akan menjadi master. <br><br>  <i><b>NB</b> : Secara default, semua node MongoDB memiliki prioritas 1. Di atas kita menaikkan menjadi 2 prioritas dari simpul yang kita butuhkan.</i>  <i>Dengan demikian, anggota cluster baru pasti akan menjadi tuan bersama.</i>  <i>Anda dapat membaca lebih lanjut tentang bagaimana mekanisme ini bekerja di MongoDB dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> .</i> <br><br>  Nonaktifkan instalasi MongoDB lama, lalu pergi ke wizard baru dan hapus node lama: <br><br><pre> <code class="bash hljs">rs.remove(<span class="hljs-string"><span class="hljs-string">"mongo-old-mongodb-replicaset-0.mongo-old-mongodb-replicaset.mongo-old.svc.cluster.local:27017"</span></span>) rs.remove(<span class="hljs-string"><span class="hljs-string">"mongo-old-mongodb-replicaset-1.mongo-old-mongodb-replicaset.mongo-old.svc.cluster.local:27017"</span></span>) rs.remove(<span class="hljs-string"><span class="hljs-string">"mongo-old-mongodb-replicaset-2.mongo-old-mongodb-replicaset.mongo-old.svc.cluster.local:27017"</span></span>)</code> </pre> <br>  Setelah ini, migrasi dapat dianggap selesai: kami berhasil beralih dari cluster MongoDB lama ke yang baru! <br><br><h2>  Ringkasan </h2><br>  Skema yang dijelaskan cocok untuk hampir semua kasus ketika Anda perlu mentransfer MongoDB atau hanya pindah ke cluster baru. <br><br>  Mungkin nuansa utama selama transfer adalah kebutuhan untuk meneruskan alamat IP dari pod baru ke server instalasi MongoDB lama, jika di luar K8, dan menamai dengan benar dalam DNS (atau <code>/etc/hosts</code> ).  Dalam contoh ini, langkah-langkah ini tidak diperlukan, karena migrasi terjadi antara ruang nama yang berbeda dari kluster Kubernet yang sama. <br><br><h2>  PS </h2><br>  Baca juga di blog kami: <br><br><ul><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Migrasi RabbitMQ yang tidak terhalang ke Kubernetes</a> ”; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Database dan Kubernetes (laporan ulasan dan video)</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">K8 tips &amp; trik: Mempercepat bootstrap dari database besar.</a> " </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id461149/">https://habr.com/ru/post/id461149/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id461137/index.html">Bagaimana kami mengembangkan perangkat untuk memonitor perhatian pengemudi. Pengalaman Yandex.Taxi</a></li>
<li><a href="../id461141/index.html">Hari pertamaku dengan Haiku: dia baik-baik saja</a></li>
<li><a href="../id461143/index.html">Tentang masalah desain game saat ini dan cara mengatasinya. Lihat dari bawah</a></li>
<li><a href="../id461145/index.html">Apa yang harus dipimpin tim: peran, tanggung jawab, dan keterampilan</a></li>
<li><a href="../id461147/index.html">Cara menyimpan 64 jam dengan menggabungkan tombol di PowerPoint</a></li>
<li><a href="../id461151/index.html">Dari ide ke produksi - Pengembangan proyek IoT</a></li>
<li><a href="../id461153/index.html">WebComponents sebagai kerangka kerja, interaksi komponen</a></li>
<li><a href="../id461155/index.html">Charity Cloud: Panduan Migrasi</a></li>
<li><a href="../id461157/index.html">Apa yang akan ditawarkan oleh Asisten Umpan Balik - platform pengembang yang akan menggantikan Bug Reporter</a></li>
<li><a href="../id461159/index.html">Ivideon Bridge: cara menghubungkan sistem CCTV lama ke cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>