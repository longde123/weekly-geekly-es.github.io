<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗝️ ⚖️ 👷🏻 以sql-dumper为例在Go中进行测试以达到100％代码覆盖率的方式 👨🏾‍✈️ 🛳️ 🤛🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在这篇文章中，我将讨论如何用Go语言编写一个控制台程序，该程序用于将数据从数据库上传到文件，并试图通过100％测试覆盖整个代码。 我将从描述为什么需要此程序开始。 我将继续描述第一个困难，其中一些是由Go语言的功能引起的。 接下来，我将介绍在Travis CI上进行的一些构建，然后再讨论如何编写测试...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>以sql-dumper为例在Go中进行测试以达到100％代码覆盖率的方式</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418565/"><p><img src="https://habrastorage.org/getpro/habr/post_images/cc4/3fe/2c1/cc43fe2c1f16d831ccbf66843bded446.png" alt="图片"></p><br><p> 在这篇文章中，我将讨论如何用Go语言编写一个控制台程序，该程序用于将数据从数据库上传到文件，并试图通过100％测试覆盖整个代码。 我将从描述为什么需要此程序开始。 我将继续描述第一个困难，其中一些是由Go语言的功能引起的。 接下来，我将介绍在Travis CI上进行的一些构建，然后再讨论如何编写测试，以覆盖100％的代码。 我将稍微测试一下数据库和文件系统的工作。 总而言之，我要说一下用测试覆盖代码的愿望以及该指标的含义。 我将提供包含文档链接和项目提交示例的材料。 </p><a name="habracut"></a><br><h1 id="naznachenie-programmy"> 计划目的 </h1><br><p> 该程序应从命令行启动，并带有表列表及其某些列的指示，指定的第一列的数据范围，所选表之间相互关系的枚举以及具有使用数据库连接设置指定文件的能力。 工作的结果应该是一个文件，该文件描述创建具有指定列和所选数据的插入表达式的指定表的请求。 假定使用这种程序将简化从大型数据库提取一部分数据并在本地部署这部分数据的方案。 此外，这些卸载的sql文件应该由另一个程序处理，该程序将根据特定模板替换部分数据。 </p><br><p> 使用数据库的任何流行客户端和足够多的手动工作都可以实现相同的结果。 该应用程序应该简化此过程并尽可能地自动化。 </p><br><p> 该程序应该由我的实习生开发，目的是培训和随后在他们的进一步培训中使用。 但是事实证明，他们拒绝了这个想法。 但是我决定尝试在业余时间编写这样的程序，以实现使用Go语言进行开发的目的。 </p><br><p> 解决方案是不完整的；它有许多限制，请参见自述文件。 无论如何，这不是战斗项目。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用示例和源代码</a> 。 </p><br><h1 id="pervye-trudnosti"> 最初的困难 </h1><br><p>表及其列的列表作为字符串形式的参数传递给程序，即事先未知。 在Go上使用数据库的大多数示例都暗示该数据库结构是预先已知的，我们只需创建一个指示每列类型的<code>struct</code>即可。 但是，在这种情况下，效果并不理想。 </p><br><p> 解决方案是使用<code>MapScan</code>方法，该方法创建了一个大小等于示例列数的接口切片。 下一个问题是如何从这些接口获取真实的数据类型。 解决方案是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">按类型切换</a> 。 这样的解决方案看起来不是很漂亮，因为所有类型都需要转换为字符串：按原样是整数，要转义的字符串并用引号引起来，但同时还要描述可能来自数据库的所有类型。 我没有找到解决此问题的更优雅的方法。 </p><br><p> 对于这些类型，还显示了Go语言功能-字符串类型的变量不能采用值<code>nil</code> ，但是空字符串和<code>NULL</code>都可以来自数据库。 为了解决这个问题， <code>database/sql</code>包中有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解决方案</a> -使用特殊的<code>strut</code> ，无论值是否为<code>NULL</code> ，它都存储值和符号。 </p><br><h1 id="sborka-i-vychislenie-procenta-pokrytiya-koda-testami"> 通过测试汇编和计算代码覆盖率的百分比 </h1><br><p> 对于汇编，我使用Travis CI，以获取测试覆盖代码的百分比-Coveralls。 程序集的<code>.travis.yml</code>文件非常简单： </p><br><pre> <code class="hljs powershell">language: go go: - <span class="hljs-number"><span class="hljs-number">1.9</span></span> script: - go get <span class="hljs-literal"><span class="hljs-literal">-t</span></span> <span class="hljs-literal"><span class="hljs-literal">-v</span></span> ./... - go get golang.org/x/tools/cmd/cover - go get github.com/mattn/goveralls - go test <span class="hljs-literal"><span class="hljs-literal">-v</span></span> <span class="hljs-literal"><span class="hljs-literal">-covermode</span></span>=count <span class="hljs-literal"><span class="hljs-literal">-coverprofile</span></span>=coverage.out ./... - <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/gopath/bin/goveralls <span class="hljs-literal"><span class="hljs-literal">-coverprofile</span></span>=coverage.out <span class="hljs-literal"><span class="hljs-literal">-service</span></span>=travis<span class="hljs-literal"><span class="hljs-literal">-ci</span></span> <span class="hljs-literal"><span class="hljs-literal">-repotoken</span></span> <span class="hljs-variable"><span class="hljs-variable">$COVERALLS_TOKEN</span></span></code> </pre> <br><p> 在Travis CI设置中，您只需要指定环境变量<code>COVERALLS_TOKEN</code> ，其值必须在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">site上获取</a> 。 </p><br><p>  Coveralls使您可以方便地找出整个项目的百分比，对于每个文件，突出显示一行原始代码，结果证明这是一个未发现的测试。 例如，在第<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个版本中</a> ，很明显在解析用户请求时我没有针对某些错误情况编写测试。 </p><br><p>  100％的代码覆盖率意味着编写了测试，其中包括在<code>if</code>为每个分支执行代码。 在编写测试以及通常在开发应用程序时，这是最繁琐的工作。 </p><br><p> 您可以使用本地测试来计算覆盖率，例如，使用相同的<code>go test -v -covermode=count -coverprofile=coverage.out ./...</code> ，但是您可以在CI中做得更好，可以在Github上放置一个盘子。 </p><br><p> 由于我们在谈论骰子，因此我发现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://goreportcard.com</a>的骰子很有用，它可以分析以下指标： </p><br><ul><li>  gofmt-代码格式设置，包括<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">简化结构</a> </li><li>  go_vet-检查可疑结构 </li><li>  gocyclo-显示圈复杂度的问题 </li><li>  golint-对我来说，它正在检查所有必要评论的可用性 </li><li> 许可证-项目必须具有许可证 </li><li>  ineffassign-检查无效的作业 </li><li> 拼写错误-检查拼写错误 </li></ul><br><h1 id="trudnosti-pokrytiya-koda-testami-na-100"> 测试覆盖代码的难度为100％ </h1><br><p> 如果解析用户对组件的小的请求主要是将字符串从字符串转换为某些结构，并且很容易被测试覆盖，那么对于测试与数据库兼容的代码，解决方案就不是那么明显了。 </p><br><p> 或者，连接到真实的数据库服务器，在每个测试中预先填充数据，进行选择并清除。 但这是一个困难的解决方案，远未进行单元测试，并且对环境（包括CI服务器）提出了要求。 </p><br><p> 另一种选择是使用内存中的数据库，例如sqlite（ <code>sqlx.Open("sqlite3", ":memory:")</code> ），但这意味着代码应尽可能弱地绑定到数据库引擎，这会使项目变得非常复杂但是对于集成测试来说还是相当不错的。 </p><br><p> 对于单元测试，对数据库使用模拟是合适的。 我找到了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这个</a> 。 使用此软件包，您可以在正常结果的情况下和在错误的情况下测试行为，以指示哪个请求应返回哪个错误。 </p><br><p> 编写测试表明，连接到实际数据库的函数需要移至main.go，因此可以在测试中为将返回模拟实例的函数重新定义该函数。 </p><br><p> 除了使用数据库之外，还必须使使用文件系统的工作成为单独的依赖项。 这将允许通过写入内存来替换实际文件的记录，以简化测试并减少耦合。 这就是<code>FileWriter</code>界面的<code>FileWriter</code>以及返回的文件界面的外观。 为了测试错误情况，创建了这些接口的辅助实现并将其放置在<code>filewriter_test.go</code>文件中，因此它们不属于常规版本，但可以在测试中使用。 </p><br><p> 一段时间后，我有一个问题，如何<code>main()</code>测试覆盖<code>main()</code> 。 那时，我在那里有足够的代码。 如搜索结果所示，这<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">不是</a>在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Go中完成</a>的。 相反，需要从<code>main()</code>提取的所有代码都必须被提取。 在我的代码中，我只剩下解析选项和命令行参数（ <code>flag</code>包），连接到数据库，实例化将写入文件的对象，并调用将完成其余工作的方法。 但是这些行不允许您获得完全100％的覆盖率。 </p><br><p> 在测试Go中，存在诸如“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">示例函数</a> ”之类的东西。 这些是测试功能，可将输出与该功能内部的注释中所描述的进行比较。 可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">go包</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">源代码中</a>找到此类测试的示例。 如果此类文件不包含测试和基准，那么它们将以前缀<code>example_</code>命名，并以<code>_test.go</code> 。 每个此类测试函数的名称应以<code>Example</code>开头。 在此基础上，我编写了一个针对将sql写入文件的对象的测试，并用模拟代替了文件中的真实记录，您可以从中获取内容并显示它们。 将该结论与标准进行比较。 方便的是，您无需用手进行比较，并且在注释中写几行很方便。 但是，在测试将数据写入csv文件的对象时，出现了困难。 根据<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RFC4180，</a> CSV中的行必须用CRLF分隔，并且<code>go fmt</code>用LF替换所有行，这导致以下事实：由于不同的行分隔符，注释中的标准与当前输出不匹配。 我必须为此对象编写常规测试，同时还要通过从其中删除<code>example_</code>重命名该文件。 </p><br><p> 问题仍然存在，如果使用示例测试和常规测试都对文件（例如<code>query.go</code>进行了测试，是否应该有两个文件<code>example_query_test.go</code>和<code>query_test.go</code> ？ 例如，在这里只有一个<code>example_test.go</code> 。 使用搜索“ go test example”仍然很有趣。 </p><br><p> 我学会了根据Google给出的“编写测试”指南，在Go中编写测试。 我碰到的大多数（ <a href="">1、2、3、4</a> ）建议将结果与表格的预期设计进行比较 </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v != <span class="hljs-number"><span class="hljs-number">1.5</span></span> { t.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Expected 1.5, got "</span></span>, v) }</code> </pre> <br><p> 但是，在比较类型时，熟悉的构造会演变为使用“反射”或类型声明的堆。 或另一个示例，当您需要检查切片或贴图是否具有必要的值时。 代码变得繁琐。 因此，我想为测试编写<a href="">辅助功能</a> 。 尽管这里的一个好的解决方案是使用库进行测试。 我找到了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/stretchr/testify</a> 。 它使您可以<a href="">单行</a>进行<a href="">比较</a> 。 该解决方案减少了代码量，并简化了测试的读取和支持。 </p><br><h1 id="droblenie-koda-i-testirovanie"> 代码分段和测试 </h1><br><p> 为可与多个对象一起使用的高级功能编写测试，可让您立即显着增加测试的代码覆盖率，因为在此测试过程中，将执行单个对象的许多行代码。 如果您将目标设置为仅100％覆盖率，那么在系统的小型组件上编写单元测试的动机就消失了，因为这不会影响代码覆盖率的价值。 </p><br><p> 另外，如果不检查测试功能的结果，这也不会影响代码覆盖率的值。 您可以获得很高的覆盖率，但无法检测到应用程序中的严重错误。 </p><br><p> 另一方面，如果您的<a href="">代码具有许多分支</a> ，之后又调用了一个庞大的函数，那么将很难用测试将其覆盖。 在这里，您有动力去改进此代码，例如， <a href="">将</a>所有分支带入一个单独的函数并为其编写<a href="">单独的测试</a> 。 这将积极影响代码的可读性。 </p><br><p> 如果代码具有很强的耦合性，那么很可能您将无法对其进行测试，这意味着您将不得不对其进行更改，这将对代码的质量产生积极影响。 </p><br><h1 id="zaklyuchenie"> 结论 </h1><br><p> 在进行此项目之前，我没有设定将测试覆盖100％的目标。 我可以在10个小时的开发过程中得到一个可以运行的应用程序，但是我花了20到30个小时才达到95％的覆盖率。 通过一个小例子，我了解了代码覆盖率的值如何影响其质量以及需要花费多少精力来维护它。 </p><br><p> 我的结论是，如果您看到仪表板对某人的代码覆盖率很高，那么它几乎没有说明该应用程序的测试水平。 无论如何，您需要自己观察测试。 但是，如果您自己设置了100％诚实的课程，那么这将帮助您更好地编写应用程序。 </p><br><p> 您可以在以下材料及其注释中阅读有关此内容的更多信息： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">100％代码覆盖率的悲剧，</a>在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">哈布雷</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">关于如何获得100％的覆盖率，但不检查任何内容</a> </li></ul><br><div class="spoiler">  <b class="spoiler_title">扰流板</b> <div class="spoiler_text"><p>  “涂层”一词大约使用了20次。 不好意思 </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418565/">https://habr.com/ru/post/zh-CN418565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418553/index.html">Kotlin + React与Javasript + React</a></li>
<li><a href="../zh-CN418557/index.html">利用特征方法计算液压管路中的波动过程</a></li>
<li><a href="../zh-CN418559/index.html">NL2API：为Web API创建自然语言接口</a></li>
<li><a href="../zh-CN418561/index.html">MVP服务中的状态机。 Yandex讲座</a></li>
<li><a href="../zh-CN418563/index.html">263号移动开发人员的有趣材料摘要（7月23日至7月29日）</a></li>
<li><a href="../zh-CN418567/index.html">戴尔将不再是一家私人公司，这将是5年以来的首次</a></li>
<li><a href="../zh-CN418569/index.html">新卫星-新错误：GOES-17卫星红外传感器不能很好地冷却</a></li>
<li><a href="../zh-CN418573/index.html">Waterius：通过Wi-Fi将水读数传输至手机（电池续航4年）</a></li>
<li><a href="../zh-CN418575/index.html">“请勿起飞”：6个不常见的音频小工具</a></li>
<li><a href="../zh-CN418577/index.html">使用标签管理您的书签-使您自己和您的同事高兴</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>