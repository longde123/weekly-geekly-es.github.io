<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêç üèüÔ∏è üçî D√©couvrez le cadre du microservice Moleculer üëºüèª ü§≠ üë©üèº‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut% habrauser%! 

 Aujourd'hui, je veux vous parler d'un excellent, √† mon avis, le cadre de microservice Moleculer . 



 Initialement, ce cadre a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©couvrez le cadre du microservice Moleculer</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439810/"> Salut% habrauser%! <br><br>  Aujourd'hui, je veux vous parler d'un excellent, √† mon avis, le cadre de microservice <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Moleculer</a> . <br><br><img src="https://habrastorage.org/webt/n1/8a/ew/n18aewfs_oj6ndbonuakkyjfwte.png"><br><br>  Initialement, ce cadre a √©t√© √©crit dans Node.js, mais plus tard, il est apparu sur des ports dans d'autres langages tels que Java, Go, Python et .NET et, tr√®s probablement, d'autres impl√©mentations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">appara√Ætront</a> dans un avenir proche.  Nous l'utilisons en production dans plusieurs produits depuis environ un an maintenant et il est difficile de d√©crire avec des mots √† quel point il nous a sembl√© b√©ni apr√®s avoir utilis√© Seneca et nos v√©los.  Nous avons obtenu tout ce dont nous avons besoin: collecte des m√©triques, mise en cache, √©quilibrage, tol√©rance aux pannes, transports s√©lectionn√©s, validation des param√®tres, journalisation, d√©clarations de m√©thode concises, plusieurs fa√ßons d'interaction interservices, mixins, et bien plus encore.  Et maintenant en ordre. <br><a name="habracut"></a><br><h2>  Pr√©sentation </h2><br>  Le cadre se compose en fait de trois composants (en fait, non, mais vous en apprendrez plus √† ce sujet ci-dessous). <br><br><h4>  Transporteur </h4><br>  Responsable de la d√©couverte des services et de la communication entre eux.  Il s'agit d'une interface que vous pouvez impl√©menter vous-m√™me si vous le souhaitez, ou vous pouvez utiliser des impl√©mentations pr√™tes √† l'emploi qui font partie du cadre lui-m√™me.  7 transports sont disponibles dans la bo√Æte: TCP, Redis, AMQP, MQTT, NATS, NATS Streaming, Kafka.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici</a> vous pouvez en voir plus.  Nous utilisons le transport Redis, mais nous pr√©voyons de passer √† TCP avec sa sortie de l'√©tat exp√©rimental. <br><br>  En pratique, lors de l'√©criture de code, nous n'interagissons pas avec ce composant.  Vous avez juste besoin de savoir ce qu'il est.  Le transport utilis√© est sp√©cifi√© dans la configuration.  Ainsi, pour passer d'un transport √† un autre, il suffit de changer la configuration.  C‚Äôest tout.  Quelque chose comme √ßa: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ./moleculer.config.js module.exports = { transporter: 'redis://:pa$$w0rd@127.0.0.1:6379', // ...   }</span></span></code> </pre> <br>  Par d√©faut, les donn√©es sont au format JSON.  Mais vous pouvez utiliser n'importe quoi: Avro, MsgPack, Notepack, ProtoBuf, Thrift, etc. <br><br><h4>  Le service </h4><br>  La classe dont nous h√©ritons lors de l'√©criture de nos microservices. <br><br>  Voici le service le plus simple sans m√©thodes, qui sera cependant d√©tect√© par d'autres services: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ./services/telemetry/telemetry.service.js const { Service } = require('moleculer'); module.exports = class TelemetryService extends Service { constructor(broker) { super(broker); this.parseServiceSchema({ name: 'telemetry', }); } };</span></span></code> </pre><br><br><h4>  Courtier de service </h4><br>  Le c≈ìur du cadre. <br><br><img src="https://habrastorage.org/webt/t7/wp/qo/t7wpqorpz4zhmczcvir_fs9cems.png"><br><br>  Exag√©rant, on peut dire qu'il s'agit d'une couche entre transport et service.  Lorsqu'un service souhaite interagir avec un autre service d'une mani√®re ou d'une autre, il le fait via un courtier (des exemples seront donn√©s ci-dessous).  Le courtier est engag√© dans l'√©quilibrage de charge (prend en charge plusieurs strat√©gies, y compris celles personnalis√©es, par d√©faut - round-robin), en tenant compte des services en direct, des m√©thodes disponibles dans ces services, etc.  Pour cela, ServiceBroker utilise un autre composant sous le capot - le Registre, mais je ne m'y attarderai pas, nous n'en aurons pas besoin pour faire connaissance. <br><br>  Avoir un courtier nous donne une chose extr√™mement pratique.  Maintenant, je vais essayer d'expliquer, mais je vais devoir m'√©carter un peu.  Dans le contexte du cadre, il existe une chose telle que le n≈ìud.  Dans un langage simple, un n≈ìud est un processus dans le syst√®me d'exploitation (c'est-√†-dire ce qui se passe lorsque nous saisissons ¬´node index.js¬ª dans la console, par exemple).  Chaque n≈ìud est un ServiceBroker avec un ensemble d'un ou plusieurs microservices.  Oui, vous avez bien entendu.  Nous pouvons construire notre pile de services selon nos d√©sirs.  Pourquoi est-ce pratique?  Pour le d√©veloppement, nous d√©marrons un n≈ìud dans lequel tous les microservices sont lanc√©s en m√™me temps (1 chacun), un seul processus dans le syst√®me avec la possibilit√© de connecter tr√®s facilement hotreload, par exemple.  En production - un n≈ìud distinct pour chaque instance du service.  Eh bien, ou un m√©lange, quand une partie des services dans un n≈ìud, une partie dans un autre, et ainsi de suite (m√™me si je ne sais pas pourquoi le faire, juste pour comprendre que vous pouvez le faire aussi). <br><br><div class="spoiler">  <b class="spoiler_title">Voici √† quoi ressemble notre index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { resolve } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ServiceBroker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moleculer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./moleculer.config.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { SERVICES, NODE_ENV, } = process.env; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> broker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceBroker(config); broker.loadServices( resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'services'</span></span>), SERVICES ? <span class="hljs-string"><span class="hljs-string">`*/@(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${SERVICES.split(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">','</span></span></span></span><span class="hljs-string"><span class="hljs-subst">).map(i =&gt; i.trim()).join(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'|'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">).service.js`</span></span> : <span class="hljs-string"><span class="hljs-string">'*/*.service.js'</span></span>, ); broker.start().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>) { broker.repl(); } });</code> </pre><br></div></div><br>  En l'absence de variable d'environnement, tous les services du r√©pertoire sont charg√©s, sinon par masque.  Soit dit en passant, broker.repl () est une autre fonctionnalit√© pratique du framework.  Lors du d√©marrage en mode d√©veloppement, nous avons juste l√†, dans la console, une interface pour appeler les m√©thodes (ce que vous feriez, par exemple, via postman dans votre microservice qui communique via http), seulement ici c'est beaucoup plus pratique: l'interface est dans la m√™me console o√π ils ont commenc√© npm. <br><br><h2>  Interaction interservices </h2><br>  Elle s'effectue de trois mani√®res: <br><br><h4>  appeler </h4><br>  Le plus couramment utilis√©.  A fait une demande, a re√ßu une r√©ponse (ou une erreur). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   "report",     "csv". async getCsvReport({ jobId }) { const rows = []; // ... return this.broker.call('csv.stringify', { rows }); }</span></span></code> </pre><br>  Comme mentionn√© ci-dessus, les appels sont automatiquement √©quilibr√©s.  Nous augmentons simplement le nombre requis d'instances de service, et le cadre lui-m√™me fera l'√©quilibrage. <br><br><img src="https://habrastorage.org/webt/jl/nj/r4/jlnjr4zxz943pfzpc9epoxpbgw8.gif"><br><br><h4>  √©mettre </h4><br>  Utilis√© lorsque nous voulons simplement informer d'autres services d'un √©v√©nement, mais nous n'avons pas besoin du r√©sultat. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   "user"    . async registerUser({ email, password }) { // ... this.broker.emit('user_registered', { email }); return true; }</span></span></code> </pre><br>  D'autres services peuvent s'abonner √† cet √©v√©nement et r√©pondre en cons√©quence.  Facultativement, le troisi√®me argument, vous pouvez d√©finir explicitement les services disponibles pour recevoir cet √©v√©nement. <br><br>  Le point important est que l'√©v√©nement ne recevra qu'une seule instance de chaque type de service, c'est-√†-dire  si nous avons 10 services ¬´courrier¬ª et 5 services ¬´abonnement¬ª qui sont abonn√©s √† cet √©v√©nement, alors en fait seulement 2 exemplaires le recevront - un ¬´courrier¬ª et un ¬´abonnement¬ª.  Ressemble sch√©matiquement √† ceci: <br><br><img src="https://habrastorage.org/webt/yf/fg/oj/yffgoj5ce8pzhcfdl_rdian6hpg.gif"><br><br><h4>  diffuser </h4><br>  Identique √† √©mettre, mais sans restrictions.  Les 10 services de courrier et 5 abonnements participeront √† cet √©v√©nement. <br><br><h2>  Validation des param√®tres </h2><br>  Par d√©faut, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le validateur le plus rapide est</a> utilis√© pour valider les param√®tres, il semble √™tre tr√®s rapide.  Mais rien n'emp√™che d'utiliser un autre, par exemple, le m√™me joi, si vous avez besoin d'une validation plus avanc√©e. <br><br>  Lorsque nous √©crivons un service, nous h√©ritons de la classe de base Service, d√©clarons des m√©thodes avec une logique m√©tier, mais ces m√©thodes sont ¬´priv√©es¬ª, elles ne peuvent pas √™tre appel√©es de l'ext√©rieur (d'un autre service) jusqu'√† ce que nous le voulions explicitement, en les d√©clarant dans section d'actions sp√©ciales lors de l'initialisation du service (les m√©thodes publiques de services dans le contexte du cadre sont appel√©es actions). <br><br><div class="spoiler">  <b class="spoiler_title">Exemple d'une d√©claration de m√©thode avec validation</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JobService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'job'</span></span>, <span class="hljs-attr"><span class="hljs-attr">actions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">update</span></span>: { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">convert</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-attr"><span class="hljs-attr">empty</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">optional</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'object'</span></span>, <span class="hljs-attr"><span class="hljs-attr">optional</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update(ctx.params); }, }, }, }); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> update({ id, name, data }) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br></div></div><br><h2>  Mixins </h2><br>  Utilis√©, par exemple, pour initialiser une connexion √† une base de donn√©es.  √âvitez la duplication de code d'un service √† l'autre. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de mixin pour initialiser une connexion √† Redis</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Redis = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ioredis'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ key = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'redis'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, options } = {}</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">settings</span></span>: { [key]: options, }, created() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Redis(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.settings[key]); }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> started() { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key].connect(); }, stopped() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key].disconnect(); }, });</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Utiliser mixin dans le service</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Service, Errors } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moleculer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> redis = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../mixins/redis'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../mixins/server'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> router = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./router'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, } = process.env; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> redisOpts = { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: REDIS_HOST, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: REDIS_PORT, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: REDIS_PASSWORD, <span class="hljs-attr"><span class="hljs-attr">lazyConnect</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'auth'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mixins</span></span>: [redis({ <span class="hljs-attr"><span class="hljs-attr">options</span></span>: redisOpts }), server({ router })], }); } }</code> </pre> <br></div></div><br><h2>  Mise en cache </h2><br>  Les appels de m√©thode (actions) peuvent √™tre mis en cache de plusieurs mani√®res: LRU, Memory, Redis.  Facultativement, vous pouvez sp√©cifier par quels appels de cl√©s seront mis en cache (par d√©faut, le hachage d'objet est utilis√© comme cl√© de mise en cache) et avec quel TTL. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de d√©claration de m√©thode mise en cache</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InventoryService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'inventory'</span></span>, <span class="hljs-attr"><span class="hljs-attr">actions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">getInventory</span></span>: { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">steamId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-attr"><span class="hljs-attr">pattern</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^76\d{15}$/</span></span> }, <span class="hljs-attr"><span class="hljs-attr">appId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">integer</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">contextId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">integer</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, }, <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: { <span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [<span class="hljs-string"><span class="hljs-string">'steamId'</span></span>, <span class="hljs-string"><span class="hljs-string">'appId'</span></span>, <span class="hljs-string"><span class="hljs-string">'contextId'</span></span>], <span class="hljs-attr"><span class="hljs-attr">ttl</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }, }, }, }); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br></div></div><br>  La m√©thode de mise en cache est d√©finie via la configuration ServiceBroker. <br><br><h2>  Journalisation </h2><br>  Ici, cependant, tout est √©galement assez simple.  Il y a un assez bon enregistreur int√©gr√© qui √©crit sur la console, il est possible de sp√©cifier un formatage personnalis√©.  Rien n'emp√™che de voler tout autre enregistreur populaire, que ce soit Winston ou Bunyan.  Un manuel d√©taill√© se trouve dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> .  Personnellement, nous utilisons l'enregistreur int√©gr√©, le formateur personnalis√© pour quelques lignes de code qui spamment dans la console JSON est simplement coup√© dans le prod, apr√®s quoi ils entrent dans graylog en utilisant le pilote de journal docker. <br><br><h2>  Mesures </h2><br>  Si vous le souhaitez, vous pouvez collecter des m√©triques pour chaque m√©thode et tout suivre dans un zipkin.  Voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la</a> liste compl√®te des exportateurs disponibles.  Actuellement, il y en a cinq: Zipkin, Jaeger, Prometheus, Elastic, Console.  Il est configur√©, comme la mise en cache, lors de la d√©claration d'une m√©thode (action). <br><br>  Des exemples de visualisation pour le paquet elasticsearch + kibana utilisant le module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©lastique-apm-node</a> peuvent √™tre consult√©s sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce lien</a> dans Github. <br><br>  La mani√®re la plus simple, bien s√ªr, est d'utiliser l'option console.  Cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/eu/dq/20/eudq20mgo7wtbqmstlp_aiidicy.png"><br><br><h2>  Tol√©rance aux pannes </h2><br>  Le cadre poss√®de un disjoncteur int√©gr√©, qui est contr√¥l√© via les param√®tres ServiceBroker.  Si un service √©choue et que le nombre de ces √©checs d√©passe un certain seuil, il sera marqu√© comme malsain, ses demandes seront s√©v√®rement limit√©es jusqu'√† ce qu'il cesse de faire des erreurs. <br><br>  En prime, il existe √©galement une solution de secours r√©glable individuellement pour chaque m√©thode (action), au cas o√π nous supposerions que la m√©thode pourrait √©chouer et, par exemple, envoyer des donn√©es en cache ou un talon. <br><br><h2>  Conclusion </h2><br>  L'introduction de ce cadre pour moi est devenue une bouff√©e d'air frais, ce qui a permis d'√©conomiser une √©norme quantit√© de chutes (√† l'exception du fait que l'architecture de microservice est un gros probl√®me) et le cyclisme, a rendu l'√©criture du prochain microservice simple et transparente.  Il n'y a rien de superflu, il est simple et tr√®s flexible, et vous pouvez √©crire le premier service dans une heure ou deux apr√®s avoir lu la documentation.  Je serai heureux si ce mat√©riel vous est utile et dans votre prochain projet vous voudrez essayer ce miracle, comme nous l'avons fait (et nous ne l'avons pas encore regrett√©).  Bon √† tous! <br><br>  De plus, si vous √™tes int√©ress√© par ce cadre, rejoignez le chat dans Telegram - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@moleculerchat</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439810/">https://habr.com/ru/post/fr439810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439794/index.html">Douleurs dorsales - comprendre du point de vue de la m√©decine moderne</a></li>
<li><a href="../fr439796/index.html">Spring Boot 2: ce qu'ils n'√©crivent pas dans les notes de version</a></li>
<li><a href="../fr439804/index.html">Zen des tests unitaires</a></li>
<li><a href="../fr439806/index.html">Noms de domaine SSL valides pour les conteneurs Docker locaux</a></li>
<li><a href="../fr439808/index.html">Les plus grands t√©lescopes. De l'ordinateur portable et des yeux aux appareils photo 340 m√©gapixels et aux centres de donn√©es. Partie 1</a></li>
<li><a href="../fr439812/index.html">Approches Kaggle pour CV en prod: vous ne pouvez pas impl√©menter pour couper</a></li>
<li><a href="../fr439818/index.html">Caract√©ristiques des approches de conception dans le secteur manufacturier r√©el</a></li>
<li><a href="../fr439822/index.html">Cr√©ation d'un affichage alternatif pour le synth√©tiseur / √©chantillonneur Ensoniq EPS16 + et ASR10</a></li>
<li><a href="../fr439824/index.html">Quand les frameworks JavaScript vont-ils dispara√Ætre?</a></li>
<li><a href="../fr439826/index.html">D√©sactiver l'analogique. Qu'arrivera-t-il √† la t√©l√©vision?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>