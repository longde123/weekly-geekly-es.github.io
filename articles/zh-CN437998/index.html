<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš ğŸ¶ ğŸ¤¶ğŸ¿ é€šè¿‡æ¼”å‘˜å’ŒCSPç”¨C ++ç¼–å†™â€œç°ä»£â€ç”¨é¤å“²å­¦å®¶ ğŸ‘¨ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦ ğŸ“³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ä¹…å‰ï¼ŒæŒ‡å‘â€œç°ä»£é¤é¥®å“²å­¦å®¶â€çš„æ–‡ç« çš„é“¾æ¥éå¸ƒRedditå’ŒHackerNewsç­‰èµ„æºã€‚ è¿™ç¯‡æ–‡ç« å¾ˆæœ‰è¶£ï¼Œå®ƒå±•ç¤ºäº†ä½¿ç”¨åŸºäºä»»åŠ¡çš„æ–¹æ³•åœ¨ç°ä»£C ++ä¸­å®ç°çš„è¿™é¡¹ä¼—æ‰€å‘¨çŸ¥çš„ä»»åŠ¡çš„å‡ ç§è§£å†³æ–¹æ¡ˆã€‚ å¦‚æœè¿˜æ²¡æœ‰äººè¯»è¿‡è¿™ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆèŠ±æ—¶é—´å»é˜…è¯»å®ƒæ˜¯æœ‰æ„ä¹‰çš„ã€‚ 


 ä½†æ˜¯ï¼Œæˆ‘ä¸èƒ½è¯´æœ¬æ–‡ä¸­ä»‹ç»çš„è§£å†³æ–¹æ¡ˆå¯¹æˆ‘æ¥è¯´ä¼¼...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é€šè¿‡æ¼”å‘˜å’ŒCSPç”¨C ++ç¼–å†™â€œç°ä»£â€ç”¨é¤å“²å­¦å®¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437998/"><p> ä¸ä¹…å‰ï¼ŒæŒ‡å‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">â€œç°ä»£é¤é¥®å“²å­¦å®¶â€</a>çš„æ–‡ç« çš„é“¾æ¥éå¸ƒRedditå’ŒHackerNewsç­‰èµ„æºã€‚ è¿™ç¯‡æ–‡ç« å¾ˆæœ‰è¶£ï¼Œå®ƒå±•ç¤ºäº†ä½¿ç”¨åŸºäºä»»åŠ¡çš„æ–¹æ³•åœ¨ç°ä»£C ++ä¸­å®ç°çš„è¿™é¡¹ä¼—æ‰€å‘¨çŸ¥çš„ä»»åŠ¡çš„å‡ ç§è§£å†³æ–¹æ¡ˆã€‚ å¦‚æœè¿˜æ²¡æœ‰äººè¯»è¿‡è¿™ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆèŠ±æ—¶é—´å»é˜…è¯»å®ƒæ˜¯æœ‰æ„ä¹‰çš„ã€‚ </p><br><p> ä½†æ˜¯ï¼Œæˆ‘ä¸èƒ½è¯´æœ¬æ–‡ä¸­ä»‹ç»çš„è§£å†³æ–¹æ¡ˆå¯¹æˆ‘æ¥è¯´ä¼¼ä¹å¾ˆç®€å•å¹¶ä¸”å¯ä»¥ç†è§£ã€‚ è¿™å¯èƒ½æ˜¯ç”±äºä½¿ç”¨ä»»åŠ¡ã€‚ å®ƒä»¬å¤ªå¤šï¼Œæ˜¯é€šè¿‡å„ç§åˆ†æ´¾å™¨/åºåˆ—åŒ–å™¨åˆ›å»ºå’Œåˆ†æ´¾çš„ã€‚ å› æ­¤ï¼Œå¹¶ä¸æ€»æ˜¯æ¸…æ¥šåœ¨ä½•å¤„ï¼Œä½•æ—¶ä»¥åŠæ‰§è¡Œä»€ä¹ˆä»»åŠ¡ã€‚ </p><br><p> æ­¤å¤–ï¼ŒåŸºäºä»»åŠ¡çš„æ–¹æ³•ä¸æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„å”¯ä¸€ä¸€ç§æ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆä¸çœ‹çœ‹é€šè¿‡Actorå’ŒCSPçš„æ¨¡å‹å¦‚ä½•è§£å†³â€œç”¨é¤å“²å­¦å®¶â€çš„ä»»åŠ¡å‘¢ï¼Ÿ </p><br><p> å› æ­¤ï¼Œæˆ‘å°è¯•ä½¿ç”¨Actorå’ŒCSPæŸ¥æ‰¾å¹¶å®æ–½äº†é’ˆå¯¹æ­¤é—®é¢˜çš„å‡ ç§è§£å†³æ–¹æ¡ˆã€‚ è¿™äº›è§£å†³æ–¹æ¡ˆçš„ä»£ç å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">åœ¨GitHubçš„å­˜å‚¨åº“ä¸­æ‰¾åˆ°</a> ã€‚ å¹¶åœ¨åˆ€å…·çš„ä¸‹æ–¹è¿›è¡Œäº†è§£é‡Šå’Œè¯´æ˜ï¼Œå› æ­¤ï¼Œä»»ä½•æœ‰å…´è¶£çš„äººï¼Œè¯·éšæ—¶å…³æ³¨ã€‚ </p><a name="habracut"></a><br><h1 id="neskolko-obschih-slov"> ä¸€äº›å¸¸ç”¨è¯ </h1><br><p> æˆ‘çš„ç›®æ ‡ä¸æ˜¯è¦å®Œå…¨é‡å¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">â€œç°ä»£é¤é¥®å“²å­¦å®¶â€ä¸€</a>æ–‡ä¸­æ˜¾ç¤ºçš„å†³å®šï¼Œå°¤å…¶æ˜¯å› ä¸ºæˆ‘ä»æ ¹æœ¬ä¸Šä¸å–œæ¬¢ä¸€ä»¶é‡è¦çš„äº‹æƒ…ï¼šå®é™…ä¸Šï¼Œå“²å­¦å®¶å¯¹è¿™äº›å†³å®šä¸åšä»»ä½•äº‹æƒ…ã€‚ ä»–åªè¯´â€œæˆ‘è¦åƒâ€ï¼Œç„¶åæœ‰äººç¥å¥‡åœ°ç»™äº†ä»–å‰å­ï¼Œæˆ–è€…è¯´â€œç°åœ¨ä¸è¡Œäº†â€ã€‚ </p><br><p> å¾ˆæ˜æ˜¾ï¼Œä½œè€…ä¸ºä»€ä¹ˆè¦è¯‰è¯¸è¿™ç§è¡Œä¸ºï¼šå®ƒå…è®¸å°†â€œå“²å­¦å®¶â€çš„ç›¸åŒå®ç°ä¸â€œåè®®â€çš„ä¸åŒå®ç°ç»“åˆä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œåœ¨æˆ‘ä¸ªäººçœ‹æ¥ï¼Œå½“â€œå“²å­¦å®¶â€å°è¯•å…ˆæ’ä¸€ä¸ªæ’å¤´å†æ’å¦ä¸€ä¸ªæ’å¤´æ—¶ï¼Œè¿™æ›´æœ‰è¶£ã€‚ å¹¶ä¸”å½“â€œå“²å­¦å®¶â€è¢«è¿«å¤„ç†ä¸æˆåŠŸçš„å°è¯•æ¥è·å–å‰å­æ—¶ã€‚ </p><br><p> æˆ‘æ­£æ˜¯è¯•å›¾åšåˆ°çš„è¿™äº›â€œè¿›é¤å“²å­¦å®¶â€ä»»åŠ¡çš„å®ç°ã€‚ åŒæ—¶ï¼ŒæŸäº›è§£å†³æ–¹æ¡ˆä½¿ç”¨ä¸ä¸Šè¿°æ–‡ç« ç›¸åŒçš„æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œç”±ForkLevelPhilosopherProtocolå’ŒWaiterFairåè®®å®ç°ï¼‰ã€‚ </p><br><p> æˆ‘åŸºäº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SObjectizer</a>åšå‡ºäº†å†³å®šï¼Œè¿™ä¸å¤ªå¯èƒ½ä½¿ä»¥å‰é˜…è¯»è¿‡æˆ‘çš„æ–‡ç« çš„äººæ„Ÿåˆ°æƒŠè®¶ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœè¿˜æ²¡æœ‰äººå¬è¯´è¿‡SObjectizerï¼šè¿™æ˜¯ä¸ºC ++å¼€å‘çš„å°‘æ•°â€‹â€‹å‡ ä¸ªç°æˆçš„ï¼Œæ­£åœ¨å¼€å‘çš„OpenSourceâ€œè§’è‰²æ¡†æ¶â€ä¹‹ä¸€ï¼ˆä¹Ÿå¯ä»¥æåŠ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">CAF</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">QP / C ++</a> ï¼‰ã€‚ æˆ‘å¸Œæœ›ä¸Šé¢çš„ä¾‹å­å’Œæˆ‘çš„è¯„è®ºå³ä½¿å¯¹äºä¸ç†Ÿæ‚‰SObjectizerçš„äººä¹Ÿè¶³å¤Ÿæ¸…æ¥šã€‚ å¦‚æœæ²¡æœ‰ï¼Œæˆ‘å°†å¾ˆä¹æ„åœ¨è¯„è®ºä¸­å›ç­”é—®é¢˜ã€‚ </p><br><h1 id="resheniya-na-baze-aktorov"> æ¼”å‘˜è§£å†³æ–¹æ¡ˆ </h1><br><p> æˆ‘ä»¬å°†å¼€å§‹ä¸åŸºäºActorçš„è§£å†³æ–¹æ¡ˆè¿›è¡Œè®¨è®ºã€‚ é¦–å…ˆï¼Œè€ƒè™‘Edsger Dijkstraè§£å†³æ–¹æ¡ˆçš„å®ç°ï¼Œç„¶åç»§ç»­ç ”ç©¶å…¶ä»–å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå¹¶æŸ¥çœ‹æ¯ä¸ªè§£å†³æ–¹æ¡ˆçš„è¡Œä¸ºå¦‚ä½•ä¸åŒã€‚ </p><br><h2 id="reshenie-deykstry"> è¿ªå…‹æ–¯ç‰¹æ‹‰çš„å†³å®š </h2><br><p>  Edsger Dijkstraï¼Œä»–ä¸ä»…åˆ¶å®šäº†â€œç”¨é¤ç”Ÿèœâ€çš„ä»»åŠ¡ï¼ˆæ‰˜å°¼Â·éœå°”ï¼ˆTony Hoarï¼‰æ›¾ç”¨â€œå‰å­â€å’Œâ€œæ„å¤§åˆ©é¢æ¡â€æ¥æ‹Ÿå®šå®ƒï¼‰ï¼Œè¿˜æå‡ºäº†ä¸€ä¸ªéå¸¸ç®€å•è€Œä¼˜ç¾çš„è§£å†³æ–¹æ¡ˆã€‚ å³ï¼šå“²å­¦å®¶åªåº”æŒ‰å¢åŠ å‰å­æ•°é‡çš„é¡ºåºæŠ“ä½å‰å­ï¼Œå¦‚æœå“²å­¦å®¶è®¾æ³•æ‹¿èµ·äº†ç¬¬ä¸€æŠŠå‰å­ï¼Œä»–å°†ä¸ä¼šæ¾æ‰‹ç›´åˆ°æ”¶åˆ°ç¬¬äºŒæŠŠå‰å­ã€‚ </p><br><p> ä¾‹å¦‚ï¼Œå¦‚æœå“²å­¦å®¶éœ€è¦ä½¿ç”¨æ•°å­—5å’Œ6çš„å‰å­ï¼Œé‚£ä¹ˆå“²å­¦å®¶å¿…é¡»é¦–å…ˆé€‰æ‹©æ•°å­—5çš„å‰å­ã€‚ç„¶åä»–æ‰èƒ½é€‰æ‹©æ•°å­—6çš„å‰å­ã€‚å› æ­¤ï¼Œå¦‚æœæ•°å­—è¾ƒå°çš„å‰å­åœ¨å“²å­¦å®¶çš„å·¦è¾¹ï¼Œé‚£ä¹ˆå“²å­¦å®¶åº”è¯¥é¦–å…ˆæ‹¿å·¦å‰ï¼Œç„¶åä»–æ‰èƒ½æ‹¿å³å‰ã€‚ </p><br><p> åˆ—è¡¨ä¸­æœ€åä¸€ä½å¿…é¡»å¤„ç†æ•°å­—ï¼ˆN-1ï¼‰å’Œ0çš„åˆ†å‰çš„å“²å­¦å®¶åšç›¸åçš„äº‹æƒ…ï¼šä»–é¦–å…ˆé€‰æ‹©æ•°å­—0çš„å³åˆ†å‰ï¼Œç„¶åé€‰æ‹©æ•°å­—ï¼ˆN-1ï¼‰çš„å·¦åˆ†å‰ã€‚ </p><br><p> è¦å®æ–½è¿™ç§æ–¹æ³•ï¼Œå°†éœ€è¦ä¸¤ç§ç±»å‹çš„å‚ä¸è€…ï¼šä¸€ç§æ˜¯å‰å­ï¼Œå¦ä¸€ç§æ˜¯å“²å­¦å®¶ã€‚ å¦‚æœå“²å­¦å®¶æƒ³åƒä¸œè¥¿ï¼Œä»–ä¼šå‘ç›¸åº”çš„åˆ†å‰æ¼”å‘˜å‘é€ä¸€æ¡æ¶ˆæ¯ä»¥æ•è·åˆ†å‰ï¼Œç„¶ååˆ†å‰æ¼”å‘˜ä¼šä»¥å“åº”æ¶ˆæ¯è¿›è¡Œå“åº”ã€‚ </p><br><p> å¯ä»¥åœ¨<a href="" rel="nofollow">æ­¤å¤„</a>çœ‹åˆ°å®ç°æ­¤æ–¹æ³•çš„ä»£ç ã€‚ </p><br><h3 id="soobscheniya"> ç•™è¨€å†…å®¹ </h3><br><p> åœ¨è°ˆè®ºå‚ä¸è€…ä¹‹å‰ï¼Œæ‚¨éœ€è¦æŸ¥çœ‹å‚ä¸è€…å°†äº¤æ¢çš„æ¶ˆæ¯ï¼š </p><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">take_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> m_who; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_philosopher_index; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">taken_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">put_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {};</code> </pre> <br><p> å½“æ¼”å‘˜-å“²å­¦å®¶æƒ³è¦æ’å…¥æ’å¤´æ—¶ï¼Œä»–å°†<code>take_t</code>æ¶ˆæ¯å‘é€ç»™fork <code>take_t</code> ï¼Œå¹¶ä¸”fork actorä¼šä»¥<code>taken_t</code>æ¶ˆæ¯è¿›è¡Œå“åº”ã€‚ å½“æ¼”å‘˜å“²å­¦å®¶åƒå®Œé¥­å¹¶æƒ³æŠŠå‰å­æ”¾å›æ¡Œå­ä¸Šæ—¶ï¼Œä»–å°†put_tæ¶ˆæ¯å‘é€ç»™<code>put_t</code>å‰å­ã€‚ </p><br><p> åœ¨<code>take_t</code>æ¶ˆæ¯ä¸­ï¼Œ <code>take_t</code>å­—æ®µè¡¨ç¤ºå“²å­¦å®¶æ¼”å‘˜çš„é‚®ç®±ï¼ˆaka mboxï¼‰ã€‚ å°†å·²<code>taken_t</code>å“åº”æ¶ˆæ¯å‘é€åˆ°æ­¤<code>taken_t</code> ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­æœªä½¿ç”¨<code>take_t</code>çš„ç¬¬äºŒä¸ªå­—æ®µï¼Œå½“æˆ‘ä»¬åˆ°è¾¾waiter_with_queueå’Œwaiter_with_timestampsçš„å®ç°æ—¶ï¼Œå°†éœ€è¦å®ƒã€‚ </p><br><h3 id="aktor-vilka"> æ¼”å‘˜å‰ </h3><br><p> ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‰å­æ¼”å‘˜ã€‚ è¿™æ˜¯ä»–çš„ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fork_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">fork_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">context_t</span></span> ctx ) : so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(ctx) } {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">so_define_agent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     'free'. this &gt;&gt;= st_free; //   'free'    . st_free .event( [this]( mhood_t&lt;take_t&gt; cmd ) { this &gt;&gt;= st_taken; so_5::send&lt; taken_t &gt;( cmd-&gt;m_who ); } ); //   'taken'   . st_taken .event( [this]( mhood_t&lt;take_t&gt; cmd ) { //     . m_queue.push( cmd-&gt;m_who ); } ) .event( [this]( mhood_t&lt;put_t&gt; ) { if( m_queue.empty() ) //     . this &gt;&gt;= st_free; else { //      . const auto who = m_queue.front(); m_queue.pop(); so_5::send&lt; taken_t &gt;( who ); } } ); } private : //    . const state_t st_free{ this, "free" }; const state_t st_taken{ this, "taken" }; //   . std::queue&lt; so_5::mbox_t &gt; m_queue; };</span></span></code> </pre> <br><p>  SObjectizerä¸­çš„æ¯ä¸ªactorå¿…é¡»ä»åŸºç±»<code>agent_t</code> ã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„ç±»å‹ä¸º<code>fork_t</code> ã€‚ </p><br><p> åœ¨<code>so_define_agent()</code>ç±»ä¸­é‡å†™äº†<code>so_define_agent()</code>æ–¹æ³•ã€‚ è¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ï¼Œåœ¨æ³¨å†Œæ–°ä»£ç†æ—¶SObjectizerä¼šè‡ªåŠ¨è°ƒç”¨å®ƒã€‚ åœ¨<code>so_define_agent()</code>æ–¹æ³•ä¸­ï¼Œå°†<code>so_define_agent()</code> â€œé…ç½®â€ä¸ºåœ¨SObjectizerä¸­å·¥ä½œï¼šå¯åŠ¨çŠ¶æ€æ›´æ”¹ï¼Œå¿…è¦çš„æ¶ˆæ¯å·²è®¢é˜…ã€‚ </p><br><p>  SObjectizerä¸­çš„æ¯ä¸ªå‚ä¸è€…éƒ½æ˜¯å…·æœ‰çŠ¶æ€çš„çŠ¶æ€æœºï¼ˆå³ä½¿å‚ä¸è€…ä»…ä½¿ç”¨ä¸€ä¸ªé»˜è®¤çŠ¶æ€ï¼‰ã€‚  <code>fork_t</code> actorå…·æœ‰ä¸¤ç§çŠ¶æ€ï¼š <em>free</em>å’Œ<code>fork_t</code> ã€‚ å½“æ¼”å‘˜å¤„äº<em>è‡ªç”±</em>çŠ¶æ€æ—¶ï¼Œæ’å¤´å¯ä»¥è¢«å“²å­¦å®¶â€œä¿˜è·â€ã€‚ å¹¶ä¸”åœ¨æ•è·äº†â€œ forkâ€ä¹‹åï¼Œ <code>fork_t</code> actoråº”è¯¥è¿›å…¥<code>fork_t</code>çŠ¶æ€ã€‚ åœ¨<code>fork_t</code>ç±»å†…éƒ¨<code>fork_t</code>çŠ¶æ€ç”±ç‰¹æ®Š<code>state_t</code>ç±»å‹çš„<code>st_free</code>å’Œ<code>st_taken</code>å®ä¾‹è¡¨ç¤ºã€‚ </p><br><p> çŠ¶æ€å…è®¸æ‚¨ä»¥ä¸åŒæ–¹å¼å¤„ç†ä¼ å…¥æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼Œåœ¨<em>è‡ªç”±</em>çŠ¶æ€ä¸‹ï¼Œä»£ç†ä»…å¯¹<code>take_t</code>ä½œå‡ºå“åº”ï¼Œå¹¶ä¸”æ­¤ååº”éå¸¸ç®€å•ï¼š <code>take_t</code>çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”<code>taken_t</code>å“åº”<code>taken_t</code> ï¼š </p><br><pre> <code class="cpp hljs">st_free .event( [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span>&gt; cmd ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_taken; so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span> &gt;( cmd-&gt;m_who ); } );</code> </pre> <br><p> è€Œæ‰€æœ‰å…¶ä»–æ¶ˆæ¯ï¼ŒåŒ…æ‹¬å¤„äº<em>ç©ºé—²</em>çŠ¶æ€çš„<code>put_t</code>éƒ½å°†è¢«å¿½ç•¥ã€‚ </p><br><p> åœ¨<code>take_t</code>çŠ¶æ€ä¸‹ï¼Œactorå¤„ç†ä¸¤æ¡æ¶ˆæ¯ï¼Œç”šè‡³<code>take_t</code> message <code>take_t</code>å…¶å¤„ç†æ–¹å¼ä¹Ÿä¸åŒï¼š </p><br><pre> <code class="cpp hljs">st_taken .event( [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span>&gt; cmd ) { m_queue.push( cmd-&gt;m_who ); } ) .event( [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span>&gt; ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( m_queue.empty() ) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_free; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> who = m_queue.front(); m_queue.pop(); so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span> &gt;( who ); } } );</code> </pre> <br><p>  <code>put_t</code>çš„å¤„ç†ç¨‹åºåœ¨<code>put_t</code>æœ€æœ‰è¶£ï¼šå¦‚æœæ­£åœ¨ç­‰å¾…çš„å“²å­¦å®¶çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿”å›<em>free</em> ï¼Œä½†æ˜¯å¦‚æœå®ƒä¸ä¸ºç©ºï¼Œåˆ™éœ€è¦å°†å…¶ç¬¬ä¸€ä¸ªå‘é€ç»™<code>taken_t</code> ã€‚ </p><br><h3 id="aktor-filosof"> å“²å­¦å®¶æ¼”å‘˜ </h3><br><p>  <a href="" rel="nofollow">æ¼”å‘˜å“²å­¦å®¶çš„ä»£ç é‡</a>å¾ˆå¤§ï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä¸ä¼šå®Œå…¨ç»™å‡ºã€‚ æˆ‘ä»¬å°†åªè®¨è®ºæœ€é‡è¦çš„ç‰‡æ®µã€‚ </p><br><p> æ¼”å‘˜å“²å­¦å®¶æœ‰æ›´å¤šçš„çŠ¶æ€ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_thinking{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"thinking.normal"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_wait_left{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"wait_left"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_wait_right{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"wait_right"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_eating{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"eating"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_done{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"done"</span></span> };</code> </pre> <br><p> æ¼”å‘˜åœ¨<em>æ€è€ƒ</em>çŠ¶æ€ä¸‹å¼€å§‹å·¥ä½œï¼Œç„¶ååˆ‡æ¢åˆ°<em>wait_left</em> ï¼Œå†åˆ‡æ¢åˆ°<em>wait_right</em> ï¼Œç„¶åå†<em>åƒé¥­</em> ã€‚ ä»<em>åƒåˆ°é¥±ï¼Œ</em>æ¼”å‘˜å°±å¯ä»¥é‡æ–°<em>æ€è€ƒï¼Œ</em>æˆ–è€…å¦‚æœå“²å­¦å®¶å·²ç»åƒé¥±äº†åº”è¯¥åƒçš„ä¸€åˆ‡ï¼Œä»–å°±å¯ä»¥å»åšã€‚ </p><br><p> è¡Œä¸ºè€…å“²å­¦å®¶çš„çŠ¶æ€å›¾å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/ir/j0/sm/irj0smrzaedcsud20y71aynfqb4.png" alt="å›¾ç‰‡"></p><br><p> æ¼”å‘˜çš„è¡Œä¸ºé€»è¾‘åœ¨ä»–çš„<code>so_define_agent()</code>æ–¹æ³•çš„å®ç°ä¸­è¿›è¡Œäº†æè¿°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">so_define_agent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   thinking     stop_thinking. st_thinking .event( [=]( mhood_t&lt;stop_thinking_t&gt; ) { //    . this &gt;&gt;= st_wait_left; so_5::send&lt; take_t &gt;( m_left_fork, so_direct_mbox(), m_index ); } ); //        taken. st_wait_left .event( [=]( mhood_t&lt;taken_t&gt; ) { //     .   . this &gt;&gt;= st_wait_right; so_5::send&lt; take_t &gt;( m_right_fork, so_direct_mbox(), m_index ); } ); //    ,    taken. st_wait_right .event( [=]( mhood_t&lt;taken_t&gt; ) { //    ,  . this &gt;&gt;= st_eating; } ); //      stop_eating. st_eating // 'stop_eating'        'eating'. .on_enter( [=] { so_5::send_delayed&lt; stop_eating_t &gt;( *this, eat_pause() ); } ) .event( [=]( mhood_t&lt;stop_eating_t&gt; ) { //      . so_5::send&lt; put_t &gt;( m_right_fork ); so_5::send&lt; put_t &gt;( m_left_fork ); //     . ++m_meals_eaten; if( m_meals_count == m_meals_eaten ) this &gt;&gt;= st_done; //  ,  ,  . else think(); } ); st_done .on_enter( [=] { //   ,   . completion_watcher_t::done( so_environment(), m_index ); } ); }</span></span></code> </pre> <br><p> ä¹Ÿè®¸åº”è¯¥ç‰¹åˆ«å¼ºè°ƒçš„å”¯ä¸€ç‚¹æ˜¯æ¨¡ä»¿â€œæ€è€ƒâ€å’Œâ€œé¥®é£Ÿâ€è¿‡ç¨‹çš„æ–¹æ³•ã€‚ è§’è‰²ä»£ç ä¸­æ²¡æœ‰<code>this_thread::sleep_for</code> ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•å…¶ä»–æ–¹å¼æ¥é˜»æ­¢å½“å‰å·¥ä½œçº¿ç¨‹ã€‚ è€Œæ˜¯ä½¿ç”¨æœªå†³æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼Œå½“æ¼”å‘˜è¿›å…¥<em>è¿›é¤</em>çŠ¶æ€æ—¶ï¼Œä»–ä¼šå‘è‡ªå·±å‘é€ä¸€æ¡æœªå†³çš„<code>stop_eating_t</code>æ¶ˆæ¯ã€‚ è¯¥æ¶ˆæ¯è¢«æä¾›ç»™SObjectizerè®¡æ—¶å™¨ï¼Œè®¡æ—¶å™¨åœ¨æ—¶é—´åˆ°æ—¶å°†æ¶ˆæ¯ä¼ é€’ç»™Actorã€‚ </p><br><p> ä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯ä½¿æ‚¨å¯ä»¥åœ¨å•ä¸ªå·¥ä½œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œæ‰€æœ‰å‚ä¸è€…ã€‚ ç²—ç•¥åœ°è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹ä»æŸä¸ªé˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œå¹¶ä»ç›¸åº”çš„æ¥æ”¶è€…å‚ä¸è€…ä¸­æå–ä¸‹ä¸€ä¸ªæ¶ˆæ¯å¤„ç†ç¨‹åºã€‚ æœ‰å…³æ¼”å‘˜çš„å·¥ä½œç¯å¢ƒçš„æ›´å¤šä¿¡æ¯å°†åœ¨ä¸‹é¢è®¨è®ºã€‚ </p><br><h3 id="rezultaty"> ç»“æœ </h3><br><p> æ­¤å®ç°çš„ç»“æœå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼ˆä¸€ä¸ªå°ç‰‡æ®µï¼‰ï¼š </p><br><pre> <code class="plaintext hljs"> Socrates: tttttttttttLRRRRRRRRRRRRRREEEEEEEttttttttLRRRRRRRRRRRRRREEEEEEEEEEEEE Plato: ttttttttttEEEEEEEEEEEEEEEEttttttttttRRRRRREEEEEEEEEEEEEEttttttttttLLL Aristotle: ttttEEEEEtttttttttttLLLLLLRRRREEEEEEEEEEEEttttttttttttLLEEEEEEEEEEEEE Descartes: tttttLLLLRRRRRRRREEEEEEEEEEEEEtttLLLLLLLLLRRRRREEEEEEttttttttttLLLLLL Spinoza: ttttEEEEEEEEEEEEEttttttttttLLLRRRREEEEEEEEEEEEEttttttttttRRRREEEEEEtt Kant: ttttttttttLLLLLLLRREEEEEEEEEEEEEEEttttttttttLLLEEEEEEEEEEEEEEtttttttt Schopenhauer: ttttttEEEEEEEEEEEEEttttttLLLLLLLLLEEEEEEEEEttttttttLLLLLLLLLLRRRRRRRR Nietzsche: tttttttttLLLLLLLLLLEEEEEEEEEEEEEttttttttLLLEEEEEEEEEttttttttRRRRRRRRE Wittgenstein: ttttEEEEEEEEEEtttttLLLLLLLLLLLLLEEEEEEEEEttttttttttttRRRREEEEEEEEEEEt Heidegger: tttttttttttLLLEEEEEEEEEEEEEEtttttttLLLLLLREEEEEEEEEEEEEEEtttLLLLLLLLR Sartre: tttEEEEEEEEEttttLLLLLLLLLLLLRRRRREEEEEEEEEtttttttLLLLLLLLRRRRRRRRRRRR</code> </pre> <br><p> å¦‚ä¸‹é˜…è¯»ï¼š </p><br><ul><li>  <code>t</code>è¡¨ç¤ºå“²å­¦å®¶åœ¨â€œæ€è€ƒâ€ï¼› </li><li>  <code>L</code>è¡¨ç¤ºå“²å­¦å®¶å¸Œæœ›æ•è·å·¦å‰ï¼ˆå¤„äº<em>wait_left</em>çŠ¶æ€ï¼‰ï¼› </li><li>  <code>R</code>è¡¨ç¤ºå“²å­¦å®¶æœŸæœ›æ•è·æ­£ç¡®çš„åˆ†å‰ï¼ˆå¤„äº<em>wait_right</em>çŠ¶æ€ï¼‰ï¼› </li><li>  <code>E</code>è¡¨ç¤ºå“²å­¦å®¶â€œåƒâ€ã€‚ </li></ul><br><p> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰åœ¨è¨ç‰¹ï¼ˆSartreï¼‰æ”¾ä¸‹å‰å­åï¼Œè‹æ ¼æ‹‰åº•æ‰èƒ½æŠŠå‰å­æ”¾åœ¨å·¦è¾¹ã€‚ ä¹‹åï¼Œè‹æ ¼æ‹‰åº•å°†ç­‰åˆ°æŸæ‹‰å›¾æ¾å¼€å³å‰ã€‚ è¿™æ ·è‹æ ¼æ‹‰åº•æ‰èƒ½åƒä¸œè¥¿ã€‚ </p><br><h2 id="prostoe-reshenie-bez-arbitra-oficianta"> æ²¡æœ‰ä»²è£å‘˜ï¼ˆæœåŠ¡å‘˜ï¼‰çš„ç®€å•å†³å®š </h2><br><p> å¦‚æœæˆ‘ä»¬åˆ†æè¿ªå…‹æ–¯ç‰¹æ‹‰å†³å®šçš„ç»“æœï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å“²å­¦å®¶èŠ±è´¹å¤§é‡æ—¶é—´ç­‰å¾…å‰å­çš„æ•è·ã€‚ ä»€ä¹ˆä¸å¥½ï¼Œå› ä¸º è¿™æ®µæ—¶é—´ä¹Ÿå¯ä»¥èŠ±åœ¨åæ€ä¸Šã€‚ å¹¶éæ²¡æœ‰é“ç†çš„æ„è§æ˜¯ï¼Œå¦‚æœæ‚¨ç©ºè…¹æ€è€ƒï¼Œæ‚¨ä¼šå¾—åˆ°æ›´å¤šæœ‰è¶£å’Œæ„æƒ³ä¸åˆ°çš„ç»“æœï¼›ï¼‰ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­å¦‚æœå“²å­¦å®¶æ— æ³•æ•è·ç¬¬äºŒä¸ªå‰å­ï¼Œåˆ™ä»–å°†è¿”å›ç¬¬ä¸€ä¸ªè¢«æ•è·çš„å‰å­ï¼ˆåœ¨ä¸Šè¿°æ–‡ç« â€œç°ä»£é¤é¥®å“²å­¦å®¶â€ä¸­ï¼Œæ­¤è§£å†³æ–¹æ¡ˆç”±ForkLevelPhilosopherProtocolå®ç°ï¼‰ã€‚ </p><br><p> åœ¨<a href="" rel="nofollow">è¿™é‡Œ</a>å¯ä»¥çœ‹åˆ°è¯¥å®ç°çš„æºä»£ç ï¼Œ <a href="" rel="nofollow">åœ¨è¿™é‡Œ</a>å¯ä»¥çœ‹åˆ°ç›¸åº”çš„å“²å­¦å®¶çš„ä»£ç ã€‚ </p><br><h3 id="soobscheniya-1"> ç•™è¨€å†…å®¹ </h3><br><p> æ­¤è§£å†³æ–¹æ¡ˆä½¿ç”¨å‡ ä¹ç›¸åŒçš„æ¶ˆæ¯é›†ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">take_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> m_who; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_philosopher_index; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">busy_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">taken_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">put_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> {};</code> </pre> <br><p> å”¯ä¸€çš„åŒºåˆ«æ˜¯<code>busy_t</code>ä¿¡å·çš„å­˜åœ¨ã€‚ å¦‚æœå‰å­å·²ç»è¢«å¦ä¸€ä½å“²å­¦å®¶æ•è·ï¼Œåˆ™actor-forkå‘é€æ­¤ä¿¡å·ä»¥å“åº”è¯¥å“²å­¦å®¶-actorã€‚ </p><br><h3 id="aktor-vilka-1"> æ¼”å‘˜å‰ </h3><br><p> æ­¤è§£å†³æ–¹æ¡ˆä¸­çš„fork actoræ¯”Dijkstraè§£å†³æ–¹æ¡ˆä¸­çš„ç®€å•ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fork_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">fork_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">context_t</span></span> ctx ) : so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span>( ctx ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_free; st_free.event( [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>]( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span>&gt; cmd ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_taken; so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span> &gt;( cmd-&gt;m_who ); } ); st_taken.event( []( <span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span>&gt; cmd ) { so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">busy_t</span></span> &gt;( cmd-&gt;m_who ); } ) .just_switch_to&lt; <span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span> &gt;( st_free ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_free{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> st_taken{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }; };</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä¿æŒç­‰å¾…å“²å­¦å®¶çš„è·¯çº¿ã€‚ </p><br><h3 id="aktor-filosof-1"> å“²å­¦å®¶æ¼”å‘˜ </h3><br><p> æ­¤å®ç°ä¸­çš„å“²å­¦è§’è‰²ç±»ä¼¼äºDijkstraçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è¿™é‡Œçš„å“²å­¦è§’è‰²ä¹Ÿå¿…é¡»å¤„ç†<code>busy_t</code> ï¼Œå› æ­¤çŠ¶æ€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/xa/ek/c8/xaekc8xbxewoj1e7myao4le6jn0.png" alt="å›¾ç‰‡"></p><br><p> ç±»ä¼¼åœ°ï¼Œè¡Œä¸ºå“²å­¦å®¶çš„æ•´ä¸ªé€»è¾‘åœ¨<code>so_define_agent()</code>å®šä¹‰ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">so_define_agent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ st_thinking .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">stop_thinking_t</span></span> &gt;( [=] { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_wait_left; so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span> &gt;( m_left_fork, so_direct_mbox(), m_index ); } ); st_wait_left .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span> &gt;( [=] { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_wait_right; so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span> &gt;( m_right_fork, so_direct_mbox(), m_index ); } ) .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">busy_t</span></span> &gt;( [=] { think( st_hungry_thinking ); } ); st_wait_right .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span> &gt;( [=] { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_eating; } ) .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">busy_t</span></span> &gt;( [=] { so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span> &gt;( m_left_fork ); think( st_hungry_thinking ); } ); st_eating .on_enter( [=] { so_5::send_delayed&lt; <span class="hljs-keyword"><span class="hljs-keyword">stop_eating_t</span></span> &gt;( *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, eat_pause() ); } ) .event&lt; <span class="hljs-keyword"><span class="hljs-keyword">stop_eating_t</span></span> &gt;( [=] { so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span> &gt;( m_right_fork ); so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span> &gt;( m_left_fork ); ++m_meals_eaten; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( m_meals_count == m_meals_eaten ) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &gt;&gt;= st_done; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> think( st_normal_thinking ); } ); st_done .on_enter( [=] { <span class="hljs-keyword"><span class="hljs-keyword">completion_watcher_t</span></span>::done( so_environment(), m_index ); } ); }</code> </pre> <br><p> é€šå¸¸ï¼Œè¿™ä¸Dijkstraè§£å†³æ–¹æ¡ˆä¸­çš„ä»£ç å‡ ä¹ç›¸åŒï¼Œé™¤äº†æœ‰å‡ ä¸ª<code>busy_t</code>çš„å¤„ç†ç¨‹åºã€‚ </p><br><h3 id="rezultaty-1"> ç»“æœ </h3><br><p> å·¥ä½œç»“æœçœ‹èµ·æ¥æœ‰æ‰€ä¸åŒï¼š </p><br><pre> <code class="plaintext hljs"> Socrates: tttttttttL..R.....EEEEEEEEEEEEttttttttttR...LL..EEEEEEEttEEEEEE Plato: ttttEEEEEEEEEEEttttttL.....L..EEEEEEEEEEEEEEEttttttttttL....L.... Aristotle: ttttttttttttL..LR.EEEEEEtttttttttttL..L....L....R.....EEEEEEEEE Descartes: ttttttttttEEEEEEEEttttttttttttEEEEEEEEttttEEEEEEEEEEEttttttL..L.. Spinoza: ttttttttttL.....L...EEEEEEtttttttttL.L......L....L..L...R...R...E Kant: tttttttEEEEEEEttttttttL.L.....EEEEEEEEttttttttR...R..R..EEEEEtttt Schopenhauer: tttR..R..L.....EEEEEEEttttttR.....L...EEEEEEEEEEEEEEEEttttttttttt Nietzsche: tttEEEEEEEEEEtttttttttEEEEEEEEEEEEEEEttttL....L...L..L....EEEEEEE Wittgenstein: tttttL.L..L.....RR....L.....L....L...EEEEEEEEEEEEEEEtttttttttL. Heidegger: ttttR..R......EEEEEEEEEEEEEttttttttttR..L...L...L..L...EEEEtttttt Sartre: tttEEEEEEEtttttttL..L...L....R.EEEEEEEtttttEEEEtttttttR.....R..R.</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ–°çš„ç¬¦å·ï¼Œè¿™æ„å‘³ç€æ¼”å‘˜å“²å­¦å®¶å¤„äºâ€œé¥¥é¥¿çš„æ€æƒ³â€ä¹‹ä¸­ã€‚ </p><br><p> å³ä½¿æ˜¯ä¸€å°æ®µï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å“²å­¦å®¶åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•è¿›é£Ÿã€‚ è¿™æ˜¯å› ä¸ºè¯¥è§£å†³æ–¹æ¡ˆå¯ä»¥é¿å…æ­»é”é—®é¢˜ï¼Œä½†ä¸èƒ½é˜²æ­¢é¥¥é¥¿ã€‚ </p><br><h2 id="reshenie-s-oficiantom-i-ocheredyu"> æœåŠ¡å‘˜å’Œé˜Ÿåˆ—çš„å†³å®š </h2><br><p> ä¸Šé¢æ˜¾ç¤ºçš„æ²¡æœ‰ä»²è£ç¨‹åºçš„æœ€ç®€å•è§£å†³æ–¹æ¡ˆä¸èƒ½é˜²æ­¢é¥¥é¥¿ã€‚ ä¸Šé¢æåˆ°çš„â€œç°ä»£é¥®é£Ÿå“²å­¦å®¶â€ä¸€æ–‡åŒ…å«äº†ä¸€ç§ä»¥WaiterFairåè®®å½¢å¼ç¦é£Ÿçš„è§£å†³æ–¹æ¡ˆã€‚ æœ€é‡è¦çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä»²è£å‘˜ï¼ˆæœåŠ¡å‘˜ï¼‰ï¼Œå“²å­¦å®¶åœ¨æƒ³åƒä¸œè¥¿æ—¶ä¼šæ±‚åŠ©äºä»²è£å‘˜ã€‚ æœåŠ¡å‘˜æœ‰æ¥è‡ªå“²å­¦å®¶çš„ç”³è¯·é˜Ÿåˆ—ã€‚ åªæœ‰ç°åœ¨ä¸¤ä¸ªå‰å­éƒ½ç©ºé—²æ—¶ï¼Œå“²å­¦å®¶æ‰èƒ½å¾—åˆ°å‰å­ï¼Œå¹¶ä¸”åœ¨é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»ä½•å“²å­¦å®¶çš„é‚»å±…è½¬å‘æœåŠ¡å‘˜ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç›¸åŒçš„è§£å†³æ–¹æ¡ˆåœ¨è§’è‰²ä¸Šçš„å¤–è§‚ã€‚ </p><br><p> å¯åœ¨<a href="" rel="nofollow">æ­¤å¤„</a>æ‰¾åˆ°æ­¤å®ç°çš„æºä»£ç ã€‚ </p><br><h3 id="tryuk"> ç»æ‹› </h3><br><p> æœ€ç®€å•çš„æ–¹æ³•æ˜¯å¼•å…¥ä¸€ç»„æ–°çš„æ¶ˆæ¯ï¼Œå“²å­¦å®¶å¯ä»¥é€šè¿‡è¿™äº›æ¶ˆæ¯ä¸æœåŠ¡å‘˜è¿›è¡Œäº¤æµã€‚ ä½†æ˜¯æˆ‘ä¸ä»…è¦ä¿å­˜å·²ç»å­˜åœ¨çš„æ¶ˆæ¯é›†ï¼ˆå³<code>take_t</code> ï¼Œ <code>taken_t</code> ï¼Œ <code>busy_t</code> ï¼Œ <code>put_t</code> ï¼‰ã€‚ æˆ‘è¿˜å¸Œæœ›ä½¿ç”¨ä¸å…ˆå‰è§£å†³æ–¹æ¡ˆä¸­ç›¸åŒçš„æ¼”å‘˜å“²å­¦å®¶ã€‚ å› æ­¤ï¼Œæˆ‘ä¸å¾—ä¸è§£å†³ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¦‚ä½•ä½¿æ¼”å‘˜å“²å­¦å®¶ä¸å”¯ä¸€çš„æ¼”å‘˜ä¾è€…äº¤æµï¼Œä½†åŒæ—¶åˆè®¤ä¸ºä»–ç›´æ¥ä¸æ¼”å‘˜å‰ï¼ˆå·²ç»æ¶ˆå¤±ï¼‰è¿›è¡Œäº¤äº’ã€‚ </p><br><p> ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æŠ€å·§å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šä¸€ä¸ªactor-waiteråˆ›å»ºäº†ä¸€ç»„mbox-sï¼Œä¸ä¹‹é“¾æ¥çš„æ˜¯é“¾æ¥åˆ°Philosopher-actorçš„fork actorçš„mbox-sã€‚ åŒæ—¶ï¼Œactor-waiterè®¢é˜…äº†æ¥è‡ªæ‰€æœ‰è¿™äº›mboxçš„æ¶ˆæ¯ï¼ˆåœ¨SObjectizerä¸­å¾ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºSObjectizerä¸ä»…å®ç°äº†/å°½å¯èƒ½å¤šçš„Actoræ¨¡å‹ï¼Œè€Œä¸”è¿˜æä¾›äº†å¼€ç®±å³ç”¨çš„Pub / Subçš„å®ç°ï¼‰ ã€‚ </p><br><p> åœ¨ä»£ç ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">waiter_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">waiter_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">context_t</span></span> ctx, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> forks_count ) : so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(ctx) } , m_fork_states( forks_count, <span class="hljs-keyword"><span class="hljs-keyword">fork_state_t</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">free</span></span> ) { <span class="hljs-comment"><span class="hljs-comment">//  mbox-   "" m_fork_mboxes.reserve( forks_count ); for( std::size_t i{}; i != forks_count; ++i ) m_fork_mboxes.push_back( so_environment().create_mbox() ); } ... void so_define_agent() override { //      "". for( std::size_t i{}; i != m_fork_mboxes.size(); ++i ) { //     .   . //          //    . so_subscribe( fork_mbox( i ) ) .event( [i, this]( mhood_t&lt;take_t&gt; cmd ) { on_take_fork( std::move(cmd), i ); } ) .event( [i, this]( mhood_t&lt;put_t&gt; cmd ) { on_put_fork( std::move(cmd), i ); } ); } } private : ... //     "". std::vector&lt; so_5::mbox_t &gt; m_fork_mboxes;</span></span></code> </pre> <br><p> å³ é¦–å…ˆï¼Œä¸ºä¸å­˜åœ¨çš„â€œå‰å­â€åˆ›å»ºä¸€ä¸ªmbox-sçš„å‘é‡ï¼Œç„¶åè®¢é˜…å®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªã€‚ æ˜¯çš„ï¼Œæˆ‘ä»¬è®¢é˜…çŸ¥é“è¯·æ±‚ä¸å“ªä¸ªç‰¹å®šæ’ä»¶ç›¸å…³ã€‚ </p><br><p>  <code>on_take_fork()</code>å…¥ç«™è¯·æ±‚çš„çœŸæ­£å¤„ç†ç¨‹åºæ˜¯<code>on_take_fork()</code>æ–¹æ³•ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_take_fork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mhood_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">take_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; cmd, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fork_index )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,       //    . if( fork_index == cmd-&gt;m_philosopher_index ) handle_take_left_fork( std::move(cmd), fork_index ); else handle_take_right_fork( std::move(cmd), fork_index ); }</span></span></code> </pre> <br><p> é¡ºä¾¿è¯´ä¸€å¥ï¼Œæ­£æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦<code>take_t</code>æ¶ˆæ¯ä¸­çš„ç¬¬äºŒä¸ªå­—æ®µã€‚ </p><br><p> å› æ­¤ï¼Œåœ¨<code>on_take_fork()</code>æˆ‘ä»¬æœ‰åŸå§‹è¯·æ±‚ä»¥åŠè¯¥è¯·æ±‚<code>on_take_fork()</code>ç›¸å…³çš„forkçš„ç´¢å¼•ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šå“²å­¦å®¶æ˜¯è¦æ±‚å·¦å‰è¿˜æ˜¯å³å‰ã€‚ å¹¶ä¸”ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œä¸åŒçš„å¤„ç†ï¼ˆå¹¶ä¸”æˆ‘ä»¬å¿…é¡»å¯¹å®ƒä»¬è¿›è¡Œä¸åŒçš„å¤„ç†ï¼‰ã€‚ </p><br><p> ç”±äºå“²å­¦å®¶æ€»æ˜¯é¦–å…ˆè¦æ±‚å·¦å‰ï¼Œå› æ­¤æˆ‘ä»¬æ­¤æ—¶éœ€è¦è¿›è¡Œæ‰€æœ‰å¿…è¦çš„æ£€æŸ¥ã€‚ å¹¶ä¸”æˆ‘ä»¬å¯èƒ½ä¼šå‘ç°è‡ªå·±å¤„äºä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š </p><br><ol><li> ä¸¤æŠŠå‰å­éƒ½æ˜¯å…è´¹çš„ï¼Œå¯ä»¥äº¤ç»™å‘é€è¯·æ±‚çš„å“²å­¦å®¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬<code>taken_t</code>å“²å­¦å®¶ï¼Œå¹¶å°†å³å‰æ ‡è®°ä¸ºä¿ç•™ï¼Œä»¥ä¾¿å…¶ä»–ä»»ä½•äººéƒ½ä¸èƒ½ä½¿ç”¨å®ƒã€‚ </li><li> ä¸èƒ½æŠŠå‰å­äº¤ç»™å“²å­¦å®¶ã€‚ ä¸ç®¡ä¸ºä»€ä¹ˆ ä¹Ÿè®¸å…¶ä¸­ä¸€äº›äººç°åœ¨å¾ˆå¿™ã€‚ æˆ–è€…è¯´æ˜¯å“²å­¦å®¶çš„é‚»å±…ä¹‹ä¸€ã€‚ æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å°†å‘é€è¯·æ±‚çš„å“²å­¦å®¶æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œç„¶åæˆ‘ä»¬<code>busy_t</code>ä»–ã€‚ </li></ol><br><p> ç”±äºè¿™ç§å·¥ä½œé€»è¾‘ï¼Œæ”¶åˆ°å·¦å‰çš„<code>taken_t</code>çš„å“²å­¦å®¶å¯ä»¥å®‰å…¨åœ°å‘é€å³å‰çš„<code>take_t</code>è¯·æ±‚ã€‚ è¯¥è¯·æ±‚å°†ç«‹å³å¾—åˆ°æ»¡è¶³ï¼Œå› ä¸º å‰å­å·²ç»ä¸ºè¿™ä¸ªå“²å­¦å®¶ä¿ç•™äº†ã€‚ </p><br><h3 id="rezultaty-2"> ç»“æœ </h3><br><p> å¦‚æœè¿è¡Œç»“æœè§£å†³æ–¹æ¡ˆï¼Œæ‚¨å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs"> Socrates: tttttttttttL....EEEEEEEEEEEEEEttttttttttL...L...EEEEEEEEEEEEEtttttL. Plato: tttttttttttL....L..L..L...L...EEEEEEEEEEEEEtttttL.....L....L.....EEE Aristotle: tttttttttL.....EEEEEEEEEttttttttttL.....L.....EEEEEEEEEEEtttL....LL Descartes: ttEEEEEEEEEEtttttttL.L..EEEEEEEEEEEEtttL..L....L....L.....EEEEEEEEEE Spinoza: tttttttttL.....EEEEEEEEEttttttttttL.....L.....EEEEEEEEEEEtttL....LL Kant: ttEEEEEEEEEEEEEtttttttL...L.....L.....EEEEEttttL....L...L..L...EEEEE Schopenhauer: ttttL...L.....L.EEEEEEEEEEEEEEEEEtttttttttttL..L...L..EEEEEEEttttttt Nietzsche: tttttttttttL....L..L..L...L...L.....L....EEEEEEEEEEEEttL.....L...L.. Wittgenstein: tttttttttL....L...L....L....L...EEEEEEEttttL......L.....L.....EEEEEE Heidegger: ttttttL..L...L.....EEEEEEEEEEEEtttttL...L..L.....EEEEEEEEEEEttttttL. Sartre: ttEEEEEEEEEEEEEttttttttL.....L...EEEEEEEEEEEEttttttttttttL.....EEEEE</code> </pre> <br><p> æ‚¨å¯ä»¥æ³¨æ„ç¼ºå°‘å­—ç¬¦<code>R</code> è¿™æ˜¯å› ä¸ºåœ¨æ­£ç¡®çš„forkè¯·æ±‚ä¸Šä¸ä¼šå‘ç”Ÿå¤±è´¥æˆ–æœŸæœ›ã€‚ </p><br><h2 id="esche-odno-reshenie-s-ispolzovaniem-arbitra-oficianta"> ä½¿ç”¨ä»²è£å‘˜ï¼ˆæœåŠ¡å‘˜ï¼‰çš„å¦ä¸€é¡¹å†³å®š </h2><br><p> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå…ˆå‰çš„waiter_with_queueè§£å†³æ–¹æ¡ˆå¯èƒ½ä¼šæ˜¾ç¤ºä¸æ­¤ç±»ä¼¼çš„ç»“æœï¼š </p><br><pre> <code class="plaintext hljs"> Socrates: tttttEEEEEEEEEEEEEEtttL.....LL...L....EEEEEEEEEttttttttttL....L.....EE Plato: tttttL..L..L....LL...EEEEEEEEEEEEEEEttttttttttttL.....EEEEEEEEEttttttt Aristotle: tttttttttttL..L...L.....L.....L....L.....EEEEEEEEEEEEtttttttttttL....L.. Descartes: ttttttttttEEEEEEEEEEttttttL.....L....L..L.....L.....L..L...L..EEEEEEEEtt Spinoza: tttttttttttL..L...L.....L.....L....L.....L..L..L....EEEEEEEEEEtttttttttt Kant: tttttttttL....L....L...L...L....L..L...EEEEEEEEEEEttttttttttL...L......E Schopenhauer: ttttttL....L..L...L...LL...L...EEEEEtttttL....L...L.....EEEEEEEEEttttt Nietzsche: tttttL..L..L....EEEEEEEEEEEEEttttttttttttEEEEEEEEEEEEEEEttttttttttttL... Wittgenstein: tttEEEEEEEEEEEEtttL....L....L..EEEEEEEEEtttttL..L..L....EEEEEEEEEEEEEEEE Heidegger: tttttttttL...L..EEEEEEEEttttL..L.....L...EEEEEEEEEtttL.L..L...L....L...L Sartre: ttttttttttL..L....L...L.EEEEEEEEEEEtttttL...L..L....EEEEEEEEEEtttttttttt</code> </pre> <br><p> æ‚¨ä¼šçœ‹åˆ°å­˜åœ¨è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œå³ä½¿å­˜åœ¨å…è´¹å‰å­ï¼Œå“²å­¦å®¶ä¹Ÿæ— æ³•è¿›é£Ÿã€‚ ä¾‹å¦‚ï¼Œåº·å¾·çš„å·¦ï¼Œå³å‰å­å¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½æ˜¯å…è´¹çš„ï¼Œä½†åº·å¾·ä¸èƒ½å¸¦èµ°å®ƒä»¬ï¼Œå› ä¸º ä»–çš„é‚»å±…å·²ç»åœ¨æ’é˜Ÿç­‰å€™ã€‚ å“ªäº›æ­£åœ¨ç­‰å¾…ä»–ä»¬çš„é‚»å±…ã€‚ è°åœ¨ç­‰é‚»å±… </p><br><p> å› æ­¤ï¼Œä¸Šè¿°è®¨è®ºçš„waiter_with_queueçš„å®ç°å¯ä»¥é˜²æ­¢é¥¥é¥¿ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œå“²å­¦å®¶è¿Ÿæ—©ä¼šåƒä¸œè¥¿ã€‚ è¿™æ˜¯å¯¹ä»–çš„ä¿è¯ã€‚ ä½†æ˜¯ç¦é£ŸæœŸå¯èƒ½ä¼šå¾ˆé•¿ã€‚ è€Œä¸”èµ„æºåˆ©ç”¨ç‡æœ‰æ—¶å¯èƒ½ä¸æ˜¯æœ€ä½³çš„ã€‚ </p><br><p> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å®ç°äº†å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆwaiter_with_timestampï¼ˆå¯ä»¥åœ¨<a href="" rel="nofollow">æ­¤å¤„</a>æ‰¾åˆ°å…¶ä»£ç ï¼‰ã€‚ ä»–ä»¬æ²¡æœ‰æ’é˜Ÿï¼Œè€Œæ˜¯è€ƒè™‘ç¦é£Ÿæ—¶é—´æ¥ä¼˜å…ˆè€ƒè™‘å“²å­¦å®¶çš„è¯·æ±‚ã€‚ å“²å­¦å®¶é¥¿å¾—è¶Šä¹…ï¼Œä»–çš„è¦æ±‚å°±è¶Šä¼˜å…ˆã€‚ </p><br><p> æˆ‘ä»¬å°†ä¸è€ƒè™‘æ­¤è§£å†³æ–¹æ¡ˆçš„ä»£ç ï¼Œå› ä¸º æ€»çš„æ¥è¯´ï¼Œå®ƒçš„ä¸»è¦é—®é¢˜æ˜¯ä½¿ç”¨ä¸€ç»„ç”¨äºä¸å­˜åœ¨çš„â€œ forksâ€çš„mboxçš„ç›¸åŒæŠ€å·§ï¼Œæˆ‘ä»¬å·²ç»åœ¨å¯¹è¯ä¸­è®¨è®ºäº†waiter_with_queueçš„å®ç°ã€‚ </p><br><h2 id="neskolko-detaley-realizacii-na-kotorye-hotelos-by-obratit-vnimanie"> æˆ‘æƒ³å¼•èµ·æ³¨æ„çš„ä¸€äº›å®æ–½ç»†èŠ‚ </h2><br><p> æˆ‘æƒ³å…³æ³¨åŸºäºActorçš„å®ç°ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼Œå› ä¸º è¿™äº›ç»†èŠ‚å±•ç¤ºäº†SObjectizerçš„æœ‰è¶£åŠŸèƒ½ã€‚ </p><br><h3 id="rabochiy-kontekst-dlya-aktorov"> æ¼”å‘˜çš„å·¥ä½œç¯å¢ƒ </h3><br><p> åœ¨è€ƒè™‘çš„å®ç°ä¸­ï¼Œæ‰€æœ‰ä¸»è¦å‚ä¸è€…ï¼ˆ <code>fork_t</code> ï¼Œ <code>philosopher_t</code> ï¼Œ <code>waiter_t</code> ï¼‰éƒ½åœ¨ä¸€ä¸ªå…¬å…±å·¥ä½œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­å·¥ä½œã€‚ è¿™æ ¹æœ¬ä¸æ„å‘³ç€åœ¨SObjectizerä¸­æ‰€æœ‰å‚ä¸è€…ä»…åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå·¥ä½œã€‚ åœ¨SObjectizerä¸­ï¼Œæ‚¨å¯ä»¥å°†è§’è‰²ç»‘å®šåˆ°ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åœ¨è§£å†³æ–¹æ¡ˆno_waiter_simpleä¸­çš„åŠŸèƒ½ä»£ç <code>run_simulation()</code>ä¸­çœ‹åˆ°ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æ¥è‡ªno_waiter_simpleçš„Run_simulationä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_simulation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">environment_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; env, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">names_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; names )</span></span></span><span class="hljs-function"> </span></span>{ env.introduce_coop( [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop ) { coop.make_agent_with_binder&lt; <span class="hljs-keyword"><span class="hljs-keyword">trace_maker_t</span></span> &gt;( so_5::disp::one_thread::create_private_disp( env )-&gt;binder(), names, <span class="hljs-keyword"><span class="hljs-keyword">random_pause_generator_t</span></span>::trace_step() ); coop.make_agent_with_binder&lt; <span class="hljs-keyword"><span class="hljs-keyword">completion_watcher_t</span></span> &gt;( so_5::disp::one_thread::create_private_disp( env )-&gt;binder(), names ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> count = names.size(); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> * &gt; forks( count, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != count; ++i ) forks[ i ] = coop.make_agent&lt; <span class="hljs-keyword"><span class="hljs-keyword">fork_t</span></span> &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != count; ++i ) coop.make_agent&lt; <span class="hljs-keyword"><span class="hljs-keyword">philosopher_t</span></span> &gt;( i, forks[ i ]-&gt;so_direct_mbox(), forks[ (i + <span class="hljs-number"><span class="hljs-number">1</span></span>) % count ]-&gt;so_direct_mbox(), default_meals_count ); }); }</code> </pre> </div></div><br><p> åœ¨æ­¤å‡½æ•°ä¸­ï¼Œ <code>completion_watcher_t</code> <code>trace_maker_t</code>å’Œ<code>completion_watcher_t</code>ç±»å‹çš„å…¶ä»–å‚ä¸è€…ã€‚ ä»–ä»¬å°†æ ¹æ®ä¸ªäººå·¥ä½œç¯å¢ƒå·¥ä½œã€‚ ä¸ºæ­¤ï¼Œ <code>one_thread</code>äº†ä¸€ä¸ª<code>one_thread</code>ç±»å‹çš„è°ƒåº¦ç¨‹åºçš„ä¸¤ä¸ªå®ä¾‹ï¼Œå¹¶å°†actorç»‘å®šåˆ°è¿™äº›è°ƒåº¦ç¨‹åºçš„å®ä¾‹ã€‚ è¿™æ„å‘³ç€è¿™äº›å‚ä¸è€…å°†å……å½“<em>æ´»åŠ¨å¯¹è±¡</em> ï¼šæ¯ä¸ªå‚ä¸è€…å°†æ‹¥æœ‰è‡ªå·±çš„å·¥ä½œçº¿ç¨‹ã€‚ </p><br><p>  SObjectizeræä¾›äº†ä¸€ç»„å¯ä»¥ç«‹å³ä½¿ç”¨çš„å‡ ç§ä¸åŒçš„è°ƒåº¦ç¨‹åºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨å…¶åº”ç”¨ç¨‹åºä¸­åˆ›å»ºæ‰€éœ€æ•°é‡çš„è°ƒåº¦ç¨‹åºå®ä¾‹ã€‚ </p><br><p>    ,        ,       . ,      <code>fork_t</code>     ,   <code>philosopher_t</code>   . </p><br><div class="spoiler"> <b class="spoiler_title"> run_simulation  no_waiter_simple_tp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_simulation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">environment_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; env, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">names_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; names )</span></span></span><span class="hljs-function"> </span></span>{ env.introduce_coop( [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop ) { coop.make_agent_with_binder&lt; <span class="hljs-keyword"><span class="hljs-keyword">trace_maker_t</span></span> &gt;( so_5::disp::one_thread::create_private_disp( env )-&gt;binder(), names, <span class="hljs-keyword"><span class="hljs-keyword">random_pause_generator_t</span></span>::trace_step() ); coop.make_agent_with_binder&lt; <span class="hljs-keyword"><span class="hljs-keyword">completion_watcher_t</span></span> &gt;( so_5::disp::one_thread::create_private_disp( env )-&gt;binder(), names ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> count = names.size(); <span class="hljs-comment"><span class="hljs-comment">//     thread_pool-. so_5::disp::thread_pool::bind_params_t bind_params; bind_params.fifo( so_5::disp::thread_pool::fifo_t::individual ); std::vector&lt; so_5::agent_t * &gt; forks( count, nullptr ); //     -. auto fork_disp = so_5::disp::thread_pool::create_private_disp( env, 3u //  . ); for( std::size_t i{}; i != count; ++i ) //      . forks[ i ] = coop.make_agent_with_binder&lt; fork_t &gt;( fork_disp-&gt;binder( bind_params ) ); //     -. auto philosopher_disp = so_5::disp::thread_pool::create_private_disp( env, 6u //  . ); for( std::size_t i{}; i != count; ++i ) coop.make_agent_with_binder&lt; philosopher_t &gt;( philosopher_disp-&gt;binder( bind_params ), i, forks[ i ]-&gt;so_direct_mbox(), forks[ (i + 1) % count ]-&gt;so_direct_mbox(), default_meals_count ); }); }</span></span></code> </pre> </div></div><br><p>            <code>fork_t</code>  <code>philosopher_t</code> . </p><br><h3 id="trassirovka-smeny-sostoyaniy-aktorov">     </h3><br><p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Modern dining philosophers</a>    ,     , : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doEat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ eventLog_.startActivity(ActivityType::eat); wait(randBetween(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>)); eventLog_.endActivity(ActivityType::eat);</code> </pre> <br><p>          SObjectizer   .  ,   , . ç”±äºä»€ä¹ˆï¼Ÿ </p><br><p>   ,   SObjectizer-   :   .       <code>agent_state_listener_t</code> .     ,  SObjectizer        . </p><br><p>        <code>greedy_philosopher_t</code>  <code>philosopher_t</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">philosopher_t</span></span>(...) ... { so_add_destroyable_listener( <span class="hljs-keyword"><span class="hljs-keyword">state_watcher_t</span></span>::make( so_environment(), index ) ); }</code> </pre> <br><p>  <code>state_watcher_t</code> â€”       . </p><br><div class="spoiler"> <b class="spoiler_title"> state_watcher_t</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state_watcher_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_state_listener_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> m_mbox; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_index; <span class="hljs-keyword"><span class="hljs-keyword">state_watcher_t</span></span>( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> mbox, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> index ); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">environment_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; env, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_state_listener_unique_ptr_t</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state_watcher_t</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">trace_maker_t</span></span>::make_mbox(env), index } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">agent_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">state_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; state )</span></span></span><span class="hljs-function"> override</span></span>; };</code> </pre> </div></div><br><p>   <code>state_watcher_t</code>    SObjectizer   <code>changed()</code>    .    <code>state_watcher_t::changed</code>      -. </p><br><div class="spoiler"> <b class="spoiler_title">  state_watcher_t::changed</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state_watcher_t</span></span>::changed( so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> &amp;, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">state_t</span></span> &amp; state ) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> detect_label = []( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp; name ) {...}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> state_label = detect_label( state.query_name() ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-string"><span class="hljs-string">'?'</span></span> == state_label ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; so_5::send&lt; trace::<span class="hljs-keyword"><span class="hljs-keyword">state_changed_t</span></span> &gt;( m_mbox, m_index, state_label ); }</code> </pre> </div></div><br><h1 id="resheniya-na-baze-csp">    CSP </h1><br><p>     ,     .       (no_waiter_dijkstra, no_waiter_simple, waiter_with_timestamps)     <code>std::thread</code>  SObjectizer- mchain- (,  ,  CSP- ). ,  ,  CSP-        (   <code>take_t</code> , <code>taken_t</code> , <code>busy_t</code> , <code>put_t</code> ). </p><br><p>  CSP-  ""   .   ,         <code>std::thread</code> . </p><br><h2 id="reshenie-deykstry-1">   </h2><br><p>       <a href="" rel="nofollow"></a> . </p><br><h3 id="nit-dlya-vilki">    </h3><br><p>         :       +    <code>take_t</code>  <code>put_t</code> .    <code>fork_process</code>  : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fork_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fork_ch )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  :   . bool taken = false; //   . std::queue&lt; so_5::mbox_t &gt; wait_queue; //        . so_5::receive( so_5::from( fork_ch ), [&amp;]( so_5::mhood_t&lt;take_t&gt; cmd ) { if( taken ) //  ,     . wait_queue.push( cmd-&gt;m_who ); else { //    . taken = true; so_5::send&lt; taken_t &gt;( cmd-&gt;m_who ); } }, [&amp;]( so_5::mhood_t&lt;put_t&gt; ) { if( wait_queue.empty() ) taken = false; //     . else { //       . const auto who = wait_queue.front(); wait_queue.pop(); so_5::send&lt; taken_t &gt;( who ); } } ); }</span></span></code> </pre> <br><p>   <code>fork_process</code>   :  ,   -   . </p><br><p>    <code>fork_process</code> â€”  ""       ,     .        <code>receive()</code> : </p><br><pre> <code class="cpp hljs">so_5::receive( so_5::from( fork_ch ), [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span>&gt; cmd ) {...}, [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">put_t</span></span>&gt; ) {...} );</code> </pre> <br><p>  SObjectizer-     <code>receive()</code>       .           .      .   ,      .   ,    . </p><br><p>      -.           <code>fork_t</code>     . ,  ,  . </p><br><h3 id="nit-dlya-filosofa">    </h3><br><p>       <code>philosopher_process</code> .      ,        . </p><br><div class="spoiler"> <b class="spoiler_title">  philosopher_process</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">oid </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">philosopher_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">trace_maker_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; tracer, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> control_ch, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> philosopher_index, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left_fork, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right_fork, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> meals_count )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> meals_eaten{ <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">random_pause_generator_t</span></span> pause_generator; <span class="hljs-comment"><span class="hljs-comment">//         . auto self_ch = so_5::create_mchain( control_ch-&gt;environment() ); while( meals_eaten &lt; meals_count ) { tracer.thinking_started( philosopher_index, thinking_type_t::normal ); //    . std::this_thread::sleep_for( pause_generator.think_pause( thinking_type_t::normal ) ); //    . tracer.take_left_attempt( philosopher_index ); so_5::send&lt; take_t &gt;( left_fork, self_ch-&gt;as_mbox(), philosopher_index ); //  ,  . so_5::receive( so_5::from( self_ch ).handle_n( 1u ), [&amp;]( so_5::mhood_t&lt;taken_t&gt; ) { //   ,   . tracer.take_right_attempt( philosopher_index ); so_5::send&lt; take_t &gt;( right_fork, self_ch-&gt;as_mbox(), philosopher_index ); //  ,  . so_5::receive( so_5::from( self_ch ).handle_n( 1u ), [&amp;]( so_5::mhood_t&lt;taken_t&gt; ) { //    .  . tracer.eating_started( philosopher_index ); //     . std::this_thread::sleep_for( pause_generator.eat_pause() ); //     . ++meals_eaten; //     . so_5::send&lt; put_t &gt;( right_fork ); } ); //     . so_5::send&lt; put_t &gt;( left_fork ); } ); } //   ,   . tracer.philosopher_done( philosopher_index ); so_5::send&lt; philosopher_done_t &gt;( control_ch, philosopher_index ); }</span></span></code> </pre> </div></div><br><p>     : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">philosopher_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">trace_maker_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; tracer, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> control_ch, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> philosopher_index, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left_fork, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right_fork, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> meals_count )</span></span></span></span></code> </pre> <br><p>         . </p><br><p>     SObjectizer- ,             ,       Actor-.         : </p><br><pre> <code class="cpp hljs">tracer.thinking_started( philosopher_index, <span class="hljs-keyword"><span class="hljs-keyword">thinking_type_t</span></span>::normal );</code> </pre> <br><p>   <code>tracer</code>      ,     . </p><br><p>  <code>control_ch</code>  ,       <code>philosopher_done_t</code>  ,    ,   .            . </p><br><p>  <code>left_fork</code>  <code>right_fork</code>      .        <code>take_t</code>  <code>put_t</code> .    ,     <code>mbox_t</code>  <code>mchain_t</code> ? </p><br><p>   !       ,    .    ,  mchain â€”  -   mbox-,    mchain-     <code>mbox_t</code> . </p><br><p>    ,    : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> meals_eaten{ <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">random_pause_generator_t</span></span> pause_generator; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> self_ch = so_5::create_mchain( control_ch-&gt;environment() );</code> </pre> <br><p>     â€”  <code>self_ch</code> .    ,         . </p><br><p>           . å³       ,     . </p><br><p>  ,        ,       <code>this_thread::sleep_for</code>   . </p><br><p>       ,      : </p><br><pre> <code class="cpp hljs">so_5::send&lt; <span class="hljs-keyword"><span class="hljs-keyword">take_t</span></span> &gt;( left_fork, self_ch-&gt;as_mbox(), philosopher_index );</code> </pre> <br><p>       <code>take_t</code> .       <code>mbox_t</code> ,   <code>self_ch</code>   <code>mchain_t</code> .              <code>as_mbox()</code> . </p><br><p>     <code>receive()</code> : </p><br><pre> <code class="cpp hljs">so_5::receive( so_5::from( self_ch ).handle_n( <span class="hljs-number"><span class="hljs-number">1u</span></span> ), [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span>&gt; ) {...} );</code> </pre> <br><p>         <code>taken_t</code>    .      .  ,         . </p><br><p>  -   ,       <code>philosopher_process</code> .        <code>receive()</code>      : </p><br><pre> <code class="cpp hljs">so_5::receive( so_5::from( self_ch ).handle_n( <span class="hljs-number"><span class="hljs-number">1u</span></span> ), [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span>&gt; ) { ... so_5::receive( so_5::from( self_ch ).handle_n( <span class="hljs-number"><span class="hljs-number">1u</span></span> ), [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span>&gt; ) {...} ); ... } );</code> </pre> <br><p>           -  . </p><br><h3 id="funkciya-zapuska-simulyacii">    </h3><br><p>             <code>run_simulation()</code> ,         .      CSP-  <code>run_simulation()</code>   .     ,       ,       (      ). </p><br><div class="spoiler"> <b class="spoiler_title">   run_simulation</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_simulation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">environment_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; env, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">names_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; names )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> table_size = names.size(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> join_all = []( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread&gt; &amp; threads ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp; t : threads ) t.join(); }; <span class="hljs-keyword"><span class="hljs-keyword">trace_maker_t</span></span> tracer{ env, names, <span class="hljs-keyword"><span class="hljs-keyword">random_pause_generator_t</span></span>::trace_step() }; <span class="hljs-comment"><span class="hljs-comment">//  . std::vector&lt; so_5::mchain_t &gt; fork_chains; std::vector&lt; std::thread &gt; fork_threads( table_size ); for( std::size_t i{}; i != table_size; ++i ) { //     . fork_chains.emplace_back( so_5::create_mchain(env) ); //     . fork_threads[ i ] = std::thread{ fork_process, fork_chains.back() }; } //      . auto control_ch = so_5::create_mchain( env ); //  . const auto philosopher_maker = [&amp;](auto index, auto left_fork_idx, auto right_fork_idx) { return std::thread{ philosopher_process, std::ref(tracer), control_ch, index, fork_chains[ left_fork_idx ]-&gt;as_mbox(), fork_chains[ right_fork_idx ]-&gt;as_mbox(), default_meals_count }; }; std::vector&lt; std::thread &gt; philosopher_threads( table_size ); for( std::size_t i{}; i != table_size - 1u; ++i ) { //      . philosopher_threads[ i ] = philosopher_maker( i, i, i+1u ); } //        . philosopher_threads[ table_size - 1u ] = philosopher_maker( table_size - 1u, table_size - 1u, 0u ); //     . so_5::receive( so_5::from( control_ch ).handle_n( table_size ), [&amp;names]( so_5::mhood_t&lt;philosopher_done_t&gt; cmd ) { fmt::print( "{}: done\n", names[ cmd-&gt;m_philosopher_index ] ); } ); //     . join_all( philosopher_threads ); //     . for( auto &amp; ch : fork_chains ) so_5::close_drop_content( ch ); //       . join_all( fork_threads ); //  . tracer.done(); //   SObjectizer. env.stop(); }</span></span></code> </pre> </div></div><br><p>  ,    <code>run_simulation()</code>   - .      . </p><br><p>      .        : </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; so_5::<span class="hljs-keyword"><span class="hljs-keyword">mchain_t</span></span> &gt; fork_chains; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread &gt; fork_threads( table_size ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != table_size; ++i ) { fork_chains.emplace_back( so_5::create_mchain(env) ); fork_threads[ i ] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread{ fork_process, fork_chains.back() }; }</code> </pre> <br><p>       ,   ,    .         .      ,    <code>join</code>  . </p><br><p>                , ..      <code>join</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread &gt; philosopher_threads( table_size ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != table_size - <span class="hljs-number"><span class="hljs-number">1u</span></span>; ++i ) { philosopher_threads[ i ] = philosopher_maker( i, i, i+<span class="hljs-number"><span class="hljs-number">1u</span></span> ); } philosopher_threads[ table_size - <span class="hljs-number"><span class="hljs-number">1u</span></span> ] = philosopher_maker( table_size - <span class="hljs-number"><span class="hljs-number">1u</span></span>, table_size - <span class="hljs-number"><span class="hljs-number">1u</span></span>, <span class="hljs-number"><span class="hljs-number">0u</span></span> );</code> </pre> <br><p>          .        : </p><br><pre> <code class="cpp hljs">so_5::receive( so_5::from( control_ch ).handle_n( table_size ), [&amp;names]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">philosopher_done_t</span></span>&gt; cmd ) { fmt::print( <span class="hljs-string"><span class="hljs-string">"{}: done\n"</span></span>, names[ cmd-&gt;m_philosopher_index ] ); } );</code> </pre> <br><p>   <code>receive()</code>      <code>table_size</code>   <code>philosopher_done_t</code> . </p><br><p>      <code>philosopher_done_t</code>    . </p><br><p>  <code>join</code>     : </p><br><pre> <code class="cpp hljs">join_all( philosopher_threads );</code> </pre> <br><p>     <code>join</code>    .    <code>join</code> , ..    .        <code>receive()</code>     .              <code>join</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp; ch : fork_chains ) so_5::close_drop_content( ch ); join_all( fork_threads );</code> </pre> <br><p>          . </p><br><h4 id="neskolko-slov-o-noexcept">    noexcept </h4><br><p> ,   <code>run_simulation</code>        ,      <em>noexcept</em> .   ,    exception-safety     .            â€”     . </p><br><p>   <code>run_simulation</code>       ? </p><br><p>  ,                .    - exception-safety      ,    .  -  ,            : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != table_size; ++i ) { fork_chains.emplace_back( so_5::create_mchain(env) ); fork_threads[ i ] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread{ fork_process, fork_chains.back() }; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( ... ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != fork_chains.size(); ++i ) { so_5::close_drop_content( fork_chains[ i ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( fork_threads[ i ].joinable() ) fork_threads[ i ].join(); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; }</code> </pre> <br><p>  ,     . å› ä¸º         ,       .    -   : </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fork_threads_stuff_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; so_5::<span class="hljs-keyword"><span class="hljs-keyword">mchain_t</span></span> &gt; m_fork_chains; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread &gt; m_fork_threads; <span class="hljs-keyword"><span class="hljs-keyword">fork_threads_stuff_t</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> table_size ) : m_fork_threads( table_size ) {} ~<span class="hljs-keyword"><span class="hljs-keyword">fork_threads_stuff_t</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != m_fork_chains.size(); ++i ) { so_5::close_drop_content( m_fork_chains[ i ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( m_fork_threads[ i ].joinable() ) m_fork_threads[ i ].join(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i{}; i != m_fork_threads.size(); ++i ) { m_fork_chains.emplace_back( so_5::create_mchain(env) ); m_fork_threads[ i ] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread{ fork_process, m_fork_chains.back() }; } } } fork_threads_stuff{ table_size }; <span class="hljs-comment"><span class="hljs-comment">//   . fork_threads_stuff.run(); //     . //       fork_threads_stuff.</span></span></code> </pre> <br><p>     ,           (, Boost- ScopeExit-, GSL- finally()   ). </p><br><p>         .       . </p><br><p> ,        exception-safety  <code>run_simulation()</code> ,   <code>run_simulation()</code>   ,    .      ,          -.       exception-safety  <code>run_simulation()</code>     <em>noexcept</em> ,     <code>std::terminate</code>    . ,          . </p><br><p>   ,   ,       ,       ,   .    ,     <code>join</code> ,            <code>join</code> .         . </p><br><h2 id="prostoe-reshenie-bez-ispolzovaniya-arbitra-oficianta">      () </h2><br><p>    ,   CSP-          ,   . </p><br><p>       <a href="" rel="nofollow"></a> . </p><br><h3 id="nit-dlya-vilki-1">    </h3><br><p>      <code>fork_process</code> ,    : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fork_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fork_ch )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  :   . bool taken = false; //      . so_5::receive( so_5::from( fork_ch ), [&amp;]( so_5::mhood_t&lt;take_t&gt; cmd ) { if( taken ) so_5::send&lt; busy_t &gt;( cmd-&gt;m_who ); else { taken = true; so_5::send&lt; taken_t &gt;( cmd-&gt;m_who ); } }, [&amp;]( so_5::mhood_t&lt;put_t&gt; ) { if( taken ) taken = false; } ); }</span></span></code> </pre> <br><p>  ,   <code>fork_process</code> ,      (      ,      ). </p><br><h3 id="nit-dlya-filosofa-1">    </h3><br><p>      <code>philosopher_process</code> ,    ,      . </p><br><div class="spoiler"> <b class="spoiler_title">  philosopher_process</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">philosopher_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">trace_maker_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; tracer, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> control_ch, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> philosopher_index, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left_fork, so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mbox_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right_fork, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> meals_count )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> meals_eaten{ <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//       . thinking_type_t thinking_type{ thinking_type_t::normal }; random_pause_generator_t pause_generator; //      . auto self_ch = so_5::create_mchain( control_ch-&gt;environment() ); while( meals_eaten &lt; meals_count ) { tracer.thinking_started( philosopher_index, thinking_type ); //    . std::this_thread::sleep_for( pause_generator.think_pause( thinking_type ) ); //  ,     . thinking_type = thinking_type_t::hungry; //    . tracer.take_left_attempt( philosopher_index ); so_5::send&lt; take_t &gt;( left_fork, self_ch-&gt;as_mbox(), philosopher_index ); //  ,  . so_5::receive( so_5::from( self_ch ).handle_n( 1u ), []( so_5::mhood_t&lt;busy_t&gt; ) { /*     */ }, [&amp;]( so_5::mhood_t&lt;taken_t&gt; ) { //   ,   . tracer.take_right_attempt( philosopher_index ); so_5::send&lt; take_t &gt;( right_fork, self_ch-&gt;as_mbox(), philosopher_index ); //  ,  . so_5::receive( so_5::from( self_ch ).handle_n( 1u ), []( so_5::mhood_t&lt;busy_t&gt; ) { /*     */ }, [&amp;]( so_5::mhood_t&lt;taken_t&gt; ) { //    ,  . tracer.eating_started( philosopher_index ); //     . std::this_thread::sleep_for( pause_generator.eat_pause() ); //     . ++meals_eaten; //      . so_5::send&lt; put_t &gt;( right_fork ); //        "normal". thinking_type = thinking_type_t::normal; } ); //       . so_5::send&lt; put_t &gt;( left_fork ); } ); } //    . tracer.philosopher_done( philosopher_index ); so_5::send&lt; philosopher_done_t &gt;( control_ch, philosopher_index ); }</span></span></code> </pre> </div></div><br><p>  -  <code>philosopher_process</code>     <code>philosopher_process</code>   .     . </p><br><p> -,   <code>thinking_type</code> .    ,      ,     ,      "" . </p><br><p> -,     <code>busy_t</code> .       <code>receive()</code> : </p><br><pre> <code class="cpp hljs">so_5::receive( so_5::from( self_ch ).handle_n( <span class="hljs-number"><span class="hljs-number">1u</span></span> ), []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">busy_t</span></span>&gt; ) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> }, [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span>&gt; ) { ... so_5::receive( so_5::from( self_ch ).handle_n( <span class="hljs-number"><span class="hljs-number">1u</span></span> ), []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">busy_t</span></span>&gt; ) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> }, [&amp;]( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mhood_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">taken_t</span></span>&gt; ) {...} );</code> </pre> <br><p> ,   <code>busy_t</code> ,   ,           <code>receive()</code> ,       <code>receive()</code> .    <code>busy_t</code>    .      , ..    <code>receive()</code>   <code>busy_t</code>  .     <code>receive()</code>        <code>busy_t</code> . </p><br><h2 id="reshenie-s-oficiantom-i-vremennymi-otmetkami">       </h2><br><p>   CSP-     ,       .            ():    waiter_with_queue,      ,      waiter_with_timestamps.         :    mbox-   ,  mbox-  ,    mbox-  . </p><br><p>      CSP-  ,        <code>philosopher_process</code>   no_waiter_simple.       mchain-           ,  ? </p><br><p>  , . </p><br><p>   mchain-  .   ,       mchain-. </p><br><p>  SObjectizer-   <code>select()</code> ,    , ,    : </p><br><pre> <code class="cpp hljs">so_5::select( so_5::from_all(), case_(ch1, one_handler_1, one_handler_2, one_handler_3, ...), case_(ch2, two_handler_1, two_handler_2, two_handler_3, ...), ...);</code> </pre> <br><p>   <code>select()</code> ,            -.       " "        .   CSP-           . </p><br><p>     . </p><br><p> ,   ,     <code>take_t</code>  <code>put_t</code>      .     -   .         <code>take_t</code>  <code>put_t</code> ,       : </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extended_take_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> m_who; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_philosopher_index; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_fork_index; <span class="hljs-keyword"><span class="hljs-keyword">extended_take_t</span></span>( so_5::<span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> who, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> philosopher_index, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fork_index ) : m_who{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(who) } , m_philosopher_index{ philosopher_index } , m_fork_index{ fork_index } {} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extended_put_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_fork_index; <span class="hljs-keyword"><span class="hljs-keyword">extended_put_t</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fork_index ) : m_fork_index{ fork_index } {} };</code> </pre> <br><blockquote>  ,       <code>so_5::message_t</code> ,         (     ).         ,      SObjectizer- . </blockquote><p>    ,         .       <code>take_t</code>  <code>put_t</code> ,    <code>extended_take_t</code>  <code>extended_put_t</code> ,    . </p><br><p>      mbox.   :) </p><br><div class="spoiler"> <b class="spoiler_title">  mbox-</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrapping_mbox_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::extra::mboxes::proxy::<span class="hljs-keyword"><span class="hljs-keyword">simple_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base_type_t</span></span> = so_5::extra::mboxes::proxy::<span class="hljs-keyword"><span class="hljs-keyword">simple_t</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    . const so_5::mbox_t m_target; //  ,      . const std::size_t m_fork_index; //    . static std::type_index original_take_type; static std::type_index original_put_type; public : wrapping_mbox_t( const so_5::mbox_t &amp; target, std::size_t fork_index ) : base_type_t{ target } , m_target{ target } , m_fork_index{ fork_index } {} //    so_5::abstract_message_box_t   . //       . void do_deliver_message( const std::type_index &amp; msg_type, const so_5::message_ref_t &amp; message, unsigned int overlimit_reaction_deep ) const override { if( original_take_type == msg_type ) { //     . const auto &amp; original_msg = so_5::message_payload_type&lt;::take_t&gt;:: payload_reference( *message ); //     . so_5::send&lt; extended_take_t &gt;( m_target, original_msg.m_who, original_msg.m_philosopher_index, m_fork_index ); } else if( original_put_type == msg_type ) { //     . so_5::send&lt; extended_put_t &gt;( m_target, m_fork_index ); } else base_type_t::do_deliver_message( msg_type, message, overlimit_reaction_deep ); } //       wrapping_mbox_t. static auto make( const so_5::mbox_t &amp; target, std::size_t fork_index ) { return so_5::mbox_t{ new wrapping_mbox_t{ target, fork_index } }; } }; std::type_index wrapping_mbox_t::original_take_type{ typeid(::take_t) }; std::type_index wrapping_mbox_t::original_put_type{ typeid(::put_t) };</span></span></code> </pre> </div></div><br><p>        mbox-:    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">so_5_extra</a>  ,        .           <code>so_5::abstract_message_box_t</code>      . </p><br><p>     ,    <code>wrapping_mbox_t</code> .          ,       .      wrapping_mbox,          mchain .   <code>waiter_process</code> ,      ,      : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waiter_process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( so_5::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mchain_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> waiter_ch, details::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">waiter_logic_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; logic )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        . so_5::receive( so_5::from( waiter_ch ), [&amp;]( so_5::mhood_t&lt;details::extended_take_t&gt; cmd ) { logic.on_take_fork( std::move(cmd) ); }, [&amp;]( so_5::mhood_t&lt;details::extended_put_t&gt; cmd ) { logic.on_put_fork( std::move(cmd) ); } ); }</span></span></code> </pre> <br><p>  ,               ,      .      waiter_with_timestamps <a href="" rel="nofollow"></a> . </p><br><p>       : "      <code>philosopher_process</code>  mbox-?"  ,    waiter_with_timestamps    mbox,   mchain. </p><br><p>  ,       mchain.       , ..  so_5_extra        mchain- (    ).          mbox-  mchain-. </p><br><h1 id="zaklyuchenie"> ç»“è®º </h1><br><p> , ,  ,          CSP .       ,     .   ,  ,     . ,  -   . </p><br><p>     ,   SObjectizer-.    ,         ""  SObjectizer â€”  5.6,     5.5.        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a> ). -   ,    SO-5.6   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a> (      ). </p><br><p>     ,          ! </p><br><p>  PSã€‚  ""      ,       .        C++14. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437998/">https://habr.com/ru/post/zh-CN437998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437988/index.html">Reactæ•™ç¨‹ï¼Œç¬¬12éƒ¨åˆ†ï¼šç ”è®¨ä¼šï¼Œç¬¬3é˜¶æ®µTODOåº”ç”¨</a></li>
<li><a href="../zh-CN437990/index.html">Reactæ•™ç¨‹ç¬¬13éƒ¨åˆ†ï¼šåŸºäºç±»çš„ç»„ä»¶</a></li>
<li><a href="../zh-CN437992/index.html">å¾®æœåŠ¡ã€‚ ä½¿ç”¨TFSåœ¨æŒç»­é›†æˆå’Œéƒ¨ç½²ç³»ç»ŸCI / CDä¸­è¿›è¡Œç‰ˆæœ¬æ§åˆ¶çš„æ¡ˆä¾‹ç ”ç©¶</a></li>
<li><a href="../zh-CN437994/index.html">æ±½è½¦æŒ¤å¥¶å’Œè‡ªåŠ¨æ¸©å®¤ï¼šå°å‹é«˜ç§‘æŠ€å†œåœºçš„è¿ä½œæ–¹å¼</a></li>
<li><a href="../zh-CN437996/index.html">SITIS CTFï¼šå°å°å¦‚ä½•å¸®åŠ©CTFè·èƒœ</a></li>
<li><a href="../zh-CN438000/index.html">åˆ›å»ºé¡¹ç›®çš„æˆåŠŸä¸å¤±è´¥ï¼ˆå¯åŠ¨ï¼‰</a></li>
<li><a href="../zh-CN438002/index.html">ä¸ºNextcloudå’ŒONLYOFFICEé…ç½®åå‘ä»£ç†</a></li>
<li><a href="../zh-CN438004/index.html">è‹¹æœè¿˜æ˜¯çµé­‚ç”µå­ï¼šæ— çº¿å¥èº«è€³æœºçš„æŒ‘æˆ˜å’Œé¢†å¯¼åœ°ä½</a></li>
<li><a href="../zh-CN438006/index.html">å°å‹ä¼ä¸šCRMï¼šæˆåŠŸå®æ–½çš„ç§˜è¯€</a></li>
<li><a href="../zh-CN438008/index.html">åœ¨ç‹¬ç«‹å’Œäº‘æ¨¡å¼ä¸‹é…ç½®Zyxelæ™ºèƒ½è®¾å¤‡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>