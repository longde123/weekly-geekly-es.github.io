<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈴 👨🏽‍🎓 🚍 如何连接GitLab和Pantheon并优化Drupal和WordPress工作流程 ☢️ 🤳🏼 👩‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们的嘉宾是Pantheon开发人员工具的创建者，讨论了如何使用GitLab CI / CD自动执行WordPress部署。 


 在Pantheon，我负责开发人员关系，因此我一直在寻找新方法来帮助WordPress和Drupal开发人员解决其工作流程中的自动化问题。 为此，我喜欢尝试使用新工具...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何连接GitLab和Pantheon并优化Drupal和WordPress工作流程</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447966/"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p> 我们的嘉宾是Pantheon开发人员工具的创建者，讨论了如何使用GitLab CI / CD自动执行WordPress部署。 </p><br><p> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pantheon，</a>我负责开发人员关系，因此我一直在寻找新方法来帮助WordPress和Drupal开发人员解决其工作流程中的自动化问题。 为此，我喜欢尝试使用新工具并将它们相互结合以进行有效的工作。 </p><br><p>  <strong>我经常看到开发人员被一台开发服务器折磨。</strong> </p><br><p>太有趣了-等待轮到您使用服务器或向客户端发送带有注释的URL：“看这里，但不要看这里”。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Multidev环境</a>是Pantheon的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">出色</a>工具之一，可以解决此问题，因为有了它们，您可以根据需要为Git分支创建环境。 每个multidev环境都有其自己的URL和数据库，因此开发人员可以安静地工作，检查质量并获得批准，而不会互相影响。 </p><br><p> 但是Pantheon没有用于版本控制或持续集成和部署（CI / CD）的工具。 但这是一个灵活的平台，您可以使用它集成任何工具。 </p><br><p>  <strong>我还注意到，对于团队的发展，他们使用一种工具，而在组装和部署中则使用其他工具。</strong> </p><br><p> 例如，他们具有用于版本控制和CI / CD的不同工具。 您必须四处乱逛，并在各种工具之间切换以编辑代码和诊断问题。 </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab</a>有一套完善的开发工具：用于版本控制，票证，合并请求，同类中最好的CI / CD管道，容器寄存器以及所有这些东西。 我没有碰到过太多需要管理开发工作流程的应用程序。 </p><br><p> 我喜欢自动化，所以我学习了如何将Pantheon连接到GitLab，以便将对GitLab的主要分支的提交部署到Pantheon的主要开发环境中。  GitLab上的合并请求可以创建代码并将其部署到Pantheon的multidev环境中。 </p><br><p> 在本指南中，我将向您展示如何在GitLab和Pantheon之间建立连接以及如何优化WordPress和Drupal工作流程。 </p><br><p> 当然，您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">镜像GitLab存储库</a> ，但是我们将用笔做所有事情来挖掘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab CI，</a>并不仅将其用于将来的部署。 </p><br><h3 id="vvedenie"> 引言 </h3><br><p> 对于这篇文章，您需要了解Pantheon将每个站点分为三个元素：代码，数据库和文件。 </p><br><p> 该代码包括CMS文件，例如内核，插件和WordPress主题。 这些文件在Pantheon托管<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的Git存储库中</a>进行管理，也就是说，我们可以使用Git将代码从GitLab部署到Pantheon。 <br> 万神殿中的文件称为媒体文件，即网站的图片。 通常，它们是由用户下载的，而Git会忽略它们。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建一个免费帐户</a> ，了解有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pantheon工作流程的</a>更多信息<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，</a>或在pantheon.io上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">注册演示</a> 。 </p><br><h3 id="predpolozheniya"> 假设条件 </h3><br><p>我在Pantheon和GitLab上的项目称为<code>pantheon-gitlab-blog-demo</code> 。 项目的名称必须唯一。 在这里，我们将与WordPress网站合作。 您可以采用Drupal，但需要进行一些更改。 </p><br><p> 我将使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Git命令行</a> ，并且您可以根据需要在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GUI中</a>工作。 </p><br><h3 id="sozdaem-proekt"> 建立专案 </h3><br><p> 首先，创建<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个GitLab项目</a> （我们将回到该项目）。 </p><br><p> 现在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在Pantheon上创建一个WordPress网站</a> 。 然后为仪表板站点安装WordPress。 </p><br><blockquote> 如果您的手发痒，请进行一些更改，例如，删除并添加插件，请耐心等待。 该站点尚未连接到GitLab，我们希望所有代码更改都通过GitLab。 </blockquote><p> 当我们安装WordPress时，我们将返回Pantheon网站仪表板并将开发模式更改为Git。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  GitLab初始提交 </h3><br><p> 现在，您需要将初始的WordPress代码从Pantheon网站转移到GitLab。 为此，我们从本地的Pantheon网站的Git存储库中克隆代码，然后将其发送到GitLab存储库。 </p><br><p> 为了使其更简单，更安全， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们将SSH密钥添加到Pantheon，</a>并且在每次克隆Pantheon Git存储库时都不会输入密码。 同时， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们</a>将向<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab添加SSH密钥</a> 。 </p><br><p> 为此，我们通过复制站点仪表板上的“使用Git克隆”字段中的命令来在本地克隆Pantheon站点。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>如果需要帮助，请阅读<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pantheon</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Git入门</a>文档。</em> </p><br><p> 现在将<code>git remote origin</code>更改为指向GitLab而不是Pantheon。 这可以通过<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code> git remote</code></a>来完成。 </p><br><p> 让我们转到GitLab项目，然后从项目详细信息页面上的“克隆”下拉列表中复制存储库URL。 我们已经选择了“使用SSH克隆”选项，因为我们已经配置了SSH密钥。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p> 默认情况下，代码存储库本地副本的<code>git remote</code>是<code>origin</code> 。 可以使用<code>git remote set-url origin [URL  GitLab]</code>进行更改，在这里输入实际URL代替括号。 </p><br><p> 最后，运行<code>git push origin master --force</code>将您的WordPress代码从Pantheon提交到GitLab。 </p><br><blockquote>  –force选项仅需要一次。 然后在GitLab上的<code>git push</code>命令中就不会了。 </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye"> 配置凭证和变量 </h3><br><p> 还记得我们如何在本地添加SSH密钥以登录Pantheon和GitLab吗？  SSH令牌可用于授权GitLab和Pantheon。 </p><br><p>  GitLab有一些很棒的文档。 让我们看看有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在GitLab CI / CD上使用SSH密钥的文档中有关使用Docker执行程序时SSH密钥</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">部分</a> 。 </p><br><p> 现在，我们将完成前两个步骤： <em>使用ssh-keygen在本地创建一对新的SSH密钥，并将私钥作为变量添加到项目中</em> 。 </p><br><p> 然后，在项目设置中将<code>SSH_PRIVATE_KEY</code>设置为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab CI / CD环境变量</a> 。 <br> 在第三步和第四步中，创建一个<code>.gitlab-ci.yml</code> ，其内容如下： </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p> 在提交<code>.gitlab-ci.yml</code> ，需要向其添加其他内容。 </p><br><p> 现在，我们执行第五步， <em>并将在</em>第一步中<em>创建的公钥添加到构建环境中需要访问的服务中</em> 。 </p><br><p> 在我们的案例中，我们想从GitLab访问Pantheon。 请按照Pantheon文档中的说明， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">将SSH密钥添加到Pantheon，</a>然后完成此步骤。 </p><br><blockquote> 切记：在GitLab中关闭SSH，在万神殿中打开。 </blockquote><p> 设置更多的环境变量。 第一个称为PANTHEON_SITE。 它的含义是计算机上万神殿站点的名称。 </p><br><p> 计算机上的名称在“使用Git克隆”命令的末尾指示。 您已经在本地克隆了站点，因此这将是本地存储库目录的名称。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p> 接下来，设置<code>PANTHEON_GIT_URL</code>环境<code>PANTHEON_GIT_URL</code> 。 这是我们已经使用的Pantheon网站的Git存储库URL。 </p><br><blockquote> 我们仅输入SSH信息库的URL，最后没有<code>git clone</code>和站点名称。 </blockquote><p> 唷。 这样就完成了，现在我们可以完成<code>.gitlab-ci.yml</code> 。 </p><br><h3 id="sozdaem-zadachu-deploya"> 创建部署任务 </h3><br><p> 我们最初使用GitLab CI所做的工作与之前使用Git存储库所做的非常相似。 但是这一次，将Pantheon存储库添加为第二个远程Git源，然后将代码从GitLab发送到Pantheon。 </p><br><p> 为此，请配置<code>deploy</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">阶段</a>和<code>deploy:dev</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务</a> ，因为我们将部署到Pantheon上的开发环境。 结果， <code>.gitlab-ci.yml</code>将如下所示： </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p> 变量<code>SSH_PRIVATE_KEY, PANTHEON_SITE</code>和<code>PANTHEON_GIT_URL</code>应该看起来很熟悉-我们之前已经设置了这些环境变量。 使用这些变量，我们可以多次使用<code>.gitlab-ci.yml</code>的值，并且只需要在一个地方更新它们即可。 </p><br><p> 最后，添加<code>.gitlab-ci.yml</code>并将其<code>.gitlab-ci.yml</code>到GitLab。 </p><br><h3 id="proveryaem-deploy"> 检查部署 </h3><br><p> 如果我们做对了所有事情，那么<code>deploy:dev</code>任务将在GitLab CI / CD中成功完成，并将<code>.gitlab-ci.yml</code>发送给Pantheon。 让我们看看。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon"> 我们将合并请求的分支发送到万神殿 </h3><br><p> 在这里，我们将使用我最喜欢的Pantheon功能<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-multidev</a> ，您可以根据要求为Git分支创建其他Pantheon环境。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">对multidev的访问受到限制</a> ，因此此部分是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可选的</a> 。 但是，如果有访问权限，则可以通过从GitLab合并请求在Pantheon上设置自动创建multidev环境来严重提高生产率。 </p><br><p> 首先，使用<code>git checkout -b multidev-support</code>在本地创建一个新的Git分支。 现在， <code>.gitlab-ci.yml</code>某些内容将再次更改。 </p><br><p> 我想在Pantheon环境名称中指出合并请求编号。 例如，第一个合并请求是<code>mr-1</code> ，第二个是<code>mr-2</code> ， <code>mr-2</code> 。 </p><br><p> 合并请求正在更改，因此我们需要动态识别Pantheon分支名称。 在GitLab上，这很简单-您需要使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">预定义的环境变量</a> 。 </p><br><p> 我们可以使用<code>$CI_MERGE_REQUEST_IID</code>来指示合并请求号。 让我们将所有这些与之前指定的全局环境变量一起应用，并在<code>.gitlab-ci.yml</code>末尾添加一个新的deploy： <code>.gitlab-ci.yml</code>任务。 </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p> 它将类似于我们的<code>deploy:dev</code>任务，仅将分支发送给Pantheon，而不发送给<code>master</code> 。 </p><br><p> 我们添加并提交了更新的<code>.gitlab-ci.yml</code> ，现在使用<code>git push -u origin multidev-support</code> <code>.gitlab-ci.yml</code>将新分支发送到GitLab。 </p><br><p> 现在，通过单击<em>创建合并请求</em>从<code>multidev-support</code>分支创建一个新的<em>合并请求</em> 。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p> 创建合并请求后，我们将研究如何执行CI / CD <code>deploy:multidev</code> 。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p> 请参阅-新分支已发送至万神殿。 但是，如果转到Pantheon网站仪表板上的multidev部分，则看不到那里的新环境。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p> 看一下“ Git分支”部分。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p> 结果，我们的<code>mr-1</code>分支到达了万神殿。 从<code>mr-1</code>分支创建环境。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p> 我们创建了一个multidev环境，现在回到GitLab并查看<em>Operations&gt; Environments</em>部分。 我们将看到<code>dev</code>和<code>mr-1</code>条目。 </p><br><p> 这是因为我们在CI / CD任务中添加了一个名为<code>name</code>和<code>url</code>的<code>environment</code>条目。 如果单击打开环境图标，我们将转到Pantheon multidev环境URL。 </p><br><h3 id="avtomatiziruem-sozdanie-multidev"> 自动创建multidev </h3><br><p> 原则上，您可以在这里停下来，只记得为每个合并请求创建一个multidev环境，但是此过程可以自动化。 </p><br><p>  Pantheon有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Terminus</a>命令行工具，您可以在其中自动使用平台。 在Terminus中，您可以从命令行创建Multidev环境，这是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab CI的</a>理想选择。 </p><br><p> 我们需要一个新的合并请求来对其进行测试。 使用<code>git checkout -b auto-multidev-creation</code>创建一个新分支。 </p><br><p> 要在GitLab CI / CD任务中使用Terminus，您需要在Terminus中进行身份验证的机器令牌和带有Terminus的容器映像。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建Pantheon机器令牌</a> ，将其保存在安全的地方，并将其添加为GitLab中的全局环境变量，名称为<code>PANTHEON_MACHINE_TOKEN</code> 。 </p><br><blockquote> 如果您忘记了如何添加GitLab环境变量，请回到定义<code>PANTHEON_SITE</code> 。 </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus"> 用Terminus创建一个Dockerfile </h3><br><p> 如果您不使用Docker或不喜欢<code>Dockerfile</code> ，请使用我的<code>registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest</code>图像，并跳过此部分。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab有一个容器注册表</a> ，您可以在其中为我们的项目构建和托管Dockerfile。 让我们用Terminus创建一个Dockerfile与Pantheon一起使用。 </p><br><p>  Terminus是PHP中的命令行工具，因此让我们从PHP映像开始。 我通过Composer安装Terminus，所以我将以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方的Docker Composer映像</a>为基础。 在本地存储库目录中创建具有以下内容的<code>Dockerfile</code> ： </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p> 请遵循<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">容器注册表文档中</a> “ <em>构建并推送图像”</em>部分中有关组装和发送图像的说明，以从<code>Dockerfile</code>收集图像并将其发送到GitLab。 </p><br><p> 在GitLab项目中打开“ <em>注册表”</em>部分。 如果一切按计划进行，将有我们的形象。 记录指向图像标签的链接<code>.gitlab-ci.yml</code>需要它。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  <code>deploy:multidev</code>的<code>script</code>部分开始增长，因此让我们将其移动到单独的文件中。 创建一个新的<code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p> 该脚本位于私有目录中， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">并且不提供Pantheon上的Web访问</a> 。 我们有一个用于multidev逻辑的脚本。 现在，让我们更新<code>.gitlab-ci.yml</code>文件的<code>deploy:multidev</code> <code>.gitlab-ci.yml</code> <code>deploy:multidev</code>以获取此信息： </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p> 我们需要确保我们的任务在创建的自定义映像中执行，因此我们在<code>.gitlab-ci.yml</code>添加带有注册表URL的定义<code>image</code> 。 结果，我们得到了以下<code>.gitlab-ci.yml</code> ： </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p> 添加，提交和发送<code>private/multidev-deploy.sh</code> <code>.gitlab-ci.yml</code>和<code>.gitlab-ci.yml</code> 。 现在回到GitLab并等待CI / CD任务完成。 请耐心：multidev可能需要几分钟。 </p><br><p> 然后我们去看万神殿的multidev列表。 哦，奇迹！  multidev <code>mr-2</code>环境已经在这里。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie"> 结论 </h3><br><p> 当我们开始打开合并请求并自动创建环境时，我的团队获得了很多乐趣。 </p><br><p> 使用功能强大的GitLab和Pantheon工具，您可以将GitLab自动连接到Pantheon。 </p><br><p> 一旦我们使用了GitLab CI / CD，我们的工作流程将在哪里发展。 这里有一些入门思路： </p><br><ul><li> 添加一个构建步骤。 </li><li> 添加自动化测试。 </li><li> 添加任务以确保符合代码标准。 </li><li> 添加<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">动态应用程序安全性测试</a> 。 </li></ul><br><p> 写出您对GitLab，万神殿和自动化的看法。 </p><br><p>  PS您是否知道<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可以通过插件扩展</a> Pantheon命令行工具Terminus？ </p><br><p> 我们在万神殿（Pantheon）努力<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">为支持</a> GitLab的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Terminus构建工具开发插件的第二</a>版。 如果您不想修改每个项目的设置，请尝试使用此插件并帮助我们测试Beta v2。 对于Terminus <code>build:project:create</code>命令，您仅需要Pantheon令牌和GitLab令牌。 她将使用Composer和自动化测试部署一个示例项目，在新的Pantheon站点GitLab中创建一个新项目，并使用环境变量和SSH密钥将它们连接起来。 </p><br><h3 id="ob-avtore"> 关于作者 </h3><br><p> 安德鲁·泰勒（Andrew Taylor）在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">万神殿（Pantheon）</a>创建开发人员工具。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN447966/">https://habr.com/ru/post/zh-CN447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN447956/index.html">ITMO大学的量子通信-牢不可破的数据传输系统项目</a></li>
<li><a href="../zh-CN447958/index.html">CJM用于错误触发DrWeb防病毒</a></li>
<li><a href="../zh-CN447960/index.html">Elbrus OS上的Veeam Linux备份。 导入替换['？' | '。' | '！']</a></li>
<li><a href="../zh-CN447962/index.html">黑客可以使用自动驾驶仪系统远程控制Tesla Model S</a></li>
<li><a href="../zh-CN447964/index.html">物联网微机测试</a></li>
<li><a href="../zh-CN447968/index.html">用Rust + CUDA C编写</a></li>
<li><a href="../zh-CN447970/index.html">超级简单的Javascript记录-两个装饰器，并完成</a></li>
<li><a href="../zh-CN447976/index.html">照相灯的开发和组装</a></li>
<li><a href="../zh-CN447980/index.html">为什么必须为您的企业投资和开发品牌的出租车应用程序？</a></li>
<li><a href="../zh-CN447982/index.html">摘要：有关家庭影院屏幕和投影仪的10种材料</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>