<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòé üñçÔ∏è üöµüèæ ¬øCu√°l fue el resultado de la migraci√≥n de ClickHouse sin autorizaci√≥n a ClickHouse con autorizaci√≥n? üíπ ü§±üèø üí†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comencemos con un poco de historia. En nuestra empresa, un proyecto est√° en mantenimiento, que hasta hace poco estaba en la etapa de prueba / desarrol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øCu√°l fue el resultado de la migraci√≥n de ClickHouse sin autorizaci√≥n a ClickHouse con autorizaci√≥n?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/468779/"><img src="https://habrastorage.org/webt/nt/i1/bm/nti1bmodzcztxtnclfwsh3z5vfs.png"><br><p>  Comencemos con un poco de historia.  En nuestra empresa, un proyecto est√° en mantenimiento, que hasta hace poco estaba en la etapa de prueba / desarrollo.  En ese momento, utilizaba ClickHouse con 3 fragmentos, 2 r√©plicas cada uno.  Teniendo en cuenta que la infraestructura de este proyecto era de prueba y no requer√≠a ninguna autorizaci√≥n adicional (ClickHouse estaba en un segmento cerrado), nadie hizo esta pregunta. </p><br><p>  Con el tiempo, el proyecto creci√≥, ClickHouse se convirti√≥ en una base de producci√≥n y migramos los datos de la infraestructura anterior a la nueva con 1 fragmento, 3 r√©plicas en 3 servidores diferentes (ClickHouse se encuentra en Kubernetes basado en StatefulSets) y, por supuesto, con autorizaci√≥n. </p><br><p>  Esto es lo que sucedi√≥ despu√©s. </p><a name="habracut"></a><br><p>  Casi inmediatamente despu√©s de comenzar el proyecto en producci√≥n, descubrimos que en el DataDir ClickHouse de la base de datos del usuario, en tablas no fragmentarias (en nuestro caso, las que se encuentran localmente en cada nodo, sin el postfix fragmentado, del tipo Distribuido), hab√≠a una gran cantidad de no perdido bin-logs.  La fecha de los registros precedi√≥ a la fecha de instalaci√≥n en la autorizaci√≥n de ClickHouse. </p><br><p>  La siguiente es la salida de la consola para una de las r√©plicas de ClickHouse de la tabla tabla_1 de la base de datos de prueba: </p><br><pre><code class="plaintext hljs">ls -l /var/lib/clickhouse/data/test/table_1/test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000 | tail -n 10 -rw-r----- 1 clickhouse clickhouse 1472 Jul 8 08:26 9983.bin -rw-r----- 1 clickhouse clickhouse 1453 Jul 8 08:26 9985.bin -rw-r----- 1 clickhouse clickhouse 1383 Jul 8 08:26 9987.bin -rw-r----- 1 clickhouse clickhouse 1461 Jul 8 08:27 9989.bin -rw-r----- 1 clickhouse clickhouse 1458 Jul 8 08:28 9991.bin -rw-r----- 1 clickhouse clickhouse 1468 Jul 8 08:29 9993.bin -rw-r----- 1 clickhouse clickhouse 1413 Jul 8 08:29 9995.bin -rw-r----- 1 clickhouse clickhouse 1509 Jul 8 08:32 9997.bin -rw-r----- 1 clickhouse clickhouse 1504 Jul 8 08:32 9999.bin drwxr-x--- 2 clickhouse clickhouse 4096 Sep 16 12:59 tmp</code> </pre> <br><p>  Es decir  los datos en s√≠ se colocaron en la tabla Distribuida local de una r√©plica espec√≠fica, pero por una raz√≥n desconocida en ese momento, no se movi√≥ a una tabla con un c√≥digo postal fragmentado (como ReplicatedMergeTree), al que se puede acceder desde todas las r√©plicas del cl√∫ster accediendo a trav√©s de una tabla local (sin c√≥digo postal) fragmentado). </p><br><p>  Como result√≥ despu√©s del an√°lisis, los datos que se registraron en la base de datos ClickHouse en la infraestructura anterior, es decir  antes de habilitar la autorizaci√≥n, ya no pod√≠an distribuirse entre r√©plicas en la nueva infraestructura, porque  En los nuevos servidores ClickHouse, la autorizaci√≥n ya se ha habilitado. </p><br><p>  Por qu√©  Cuando los datos se escriben en ClickHouse sin autorizaci√≥n, se genera un enlace del siguiente formulario en el directorio de datos de clickHouse en los directorios de la base de datos correspondiente y la tabla (el enlace se genera en funci√≥n de una solicitud realizada a la base de datos): </p><br><pre> <code class="plaintext hljs">test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> <br><p>  Miremos con m√°s detalle.  El usuario prueba_usr accede al enlace anterior, pero no se especifica la contrase√±a para la autorizaci√≥n.  Y lo que sucede, si antes de habilitar la autorizaci√≥n en la base de datos, se registraba una gran cantidad de datos en ClickHouse, que formaba registros de bin, y ClickHouse en los servidores antiguos no ten√≠a tiempo de perderlos, luego, despu√©s de habilitar la autorizaci√≥n en los nuevos servidores ClickHouse y migrar los viejos no perdidos bin-logs a nuevos servidores, estos bin-logs ya no se pueden reproducir, porque  el enlace ya se ha generado sin autorizaci√≥n para el usuario test_usr. </p><br><p>  Todos los nuevos datos entrantes en ClickHouse tambi√©n generar√°n bin-logs en los directorios y tablas de bases de datos correspondientes, que luego se reproducir√°n, pero con un enlace diferente, donde se indica la autorizaci√≥n (ya que la aplicaci√≥n ya est√° accediendo a ClickHouse en la nueva infraestructura se realiza con la contrase√±a para el usuario test_usr, de lo contrario la solicitud simplemente no llegar√° a la base de datos): </p><br><pre> <code class="plaintext hljs">test_usr:password@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> <br><p>  Porque  los datos se escriben en la base de datos de forma asincr√≥nica, es decir, primero se colocan en una r√©plica local de ClickHouse a la que se accedi√≥, y solo luego se env√≠an a otras r√©plicas del cl√∫ster. </p><br><p>  En consecuencia, los datos antiguos que se registraron en una de las r√©plicas locales de ClickHouse, pero no se distribuyeron entre el resto de las r√©plicas del cl√∫ster (dado que el enlace generado no conten√≠a la contrase√±a para el usuario, pero ya estaba configurado), ni siquiera se pod√≠a acceder a ellos. para leer en la r√©plica en la que se ubicaron directamente los bin-logs no aplicados. </p><br><p>  ¬øC√≥mo resolvimos el problema y no perdimos datos no asignados? </p><br><p>  Todo result√≥ ser bastante simple.  Es suficiente realizar las siguientes manipulaciones con datos no asignados en la base de datos: </p><br><ol><li>  Los enlaces generados para cada una de las tablas de la base de datos del problema deben ser renombrados (renombrados) a la forma requerida: <br><pre> <code class="plaintext hljs">mv /var/lib/clickhouse/data/test/table_1/test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000 /var/lib/clickhouse/data/test/table_1/test_usr:password@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> </li><li>  Reinicie las r√©plicas de ClickHouse, que inicia el proceso de reproducci√≥n de registros de bin y su colocaci√≥n en nuestras tablas fragmentadas (ReplicatedMergeTree). </li></ol><br><p>  <strong>PD</strong> : Recomiendo a todos que verifiquen el funcionamiento de sus servidores ClickHouse para ver los problemas descritos.  Si se encuentran, entonces esta nota lo ayudar√° a ahorrar tiempo buscando una soluci√≥n y ser√° m√°s cuidadoso al configurar / cambiar una contrase√±a en ClickHouse en el futuro. </p><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Lea tambi√©n otros art√≠culos en nuestro blog: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Implementaci√≥n azul-verde de aplicaciones Spring con el servidor web Nginx</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥mo ejecutar m√∫ltiples canalizaciones usando GitLab CI / CD</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">/etc/resolv.conf para pods Kubernetes, opci√≥n ndots: 5, ya que esto puede afectar negativamente el rendimiento de la aplicaci√≥n</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comprender el paquete de contexto en Golang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tres trucos simples para reducir las im√°genes acoplables</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468779/">https://habr.com/ru/post/468779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468765/index.html">La importancia de confirmar los comandos de control usando Delimobile como ejemplo</a></li>
<li><a href="../468767/index.html">Juguetes de madera, segunda parte - 1986-1988</a></li>
<li><a href="../468769/index.html">Xavier Noria on Rails 6, consultor√≠a y m√°s</a></li>
<li><a href="../468773/index.html">La compa√±√≠a india de energ√≠a NTPC construir√° un parque solar de 5,000 megavatios</a></li>
<li><a href="../468775/index.html">AI supremac√≠a: Leela Chess. O sobre c√≥mo gan√≥ una red neuronal completamente abierta</a></li>
<li><a href="../468781/index.html">Jugando con n√∫meros complejos</a></li>
<li><a href="../468785/index.html">Intel Stratix 10 DX completa la l√≠nea Stratix 10 FPGA</a></li>
<li><a href="../468789/index.html">2. Casos de uso t√≠picos para Check Point Maestro</a></li>
<li><a href="../468791/index.html">Dos experimentos curiosos del cerebro humano que vale la pena conocer</a></li>
<li><a href="../468793/index.html">Nos ocupamos de la criptomoneda Libra. Detalles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>