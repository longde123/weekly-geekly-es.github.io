<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòó üÜö üéÑ El ABC de la seguridad en Kubernetes: autenticaci√≥n, autorizaci√≥n, auditor√≠a ü§ë üò≠ üë©üèø‚Äçü§ù‚Äçüë©üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tarde o temprano, el funcionamiento de cualquier sistema plantea la cuesti√≥n de la seguridad: garantizar la autenticaci√≥n, la separaci√≥n de derechos, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El ABC de la seguridad en Kubernetes: autenticaci√≥n, autorizaci√≥n, auditor√≠a</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/468679/"><img src="https://habrastorage.org/webt/ao/pp/ke/aoppkeeufk5-tv1rmtmtw9oce7a.png"><br><br>  Tarde o temprano, el funcionamiento de cualquier sistema plantea la cuesti√≥n de la seguridad: garantizar la autenticaci√≥n, la separaci√≥n de derechos, la auditor√≠a y otras tareas.  Ya se han creado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muchas soluciones</a> para Kubernetes que pueden lograr el cumplimiento de las normas incluso en entornos muy exigentes ... El mismo material est√° dedicado a los aspectos b√°sicos de seguridad implementados en el marco de los mecanismos integrados de K8.  En primer lugar, ser√° √∫til para aquellos que comienzan a familiarizarse con Kubernetes, como punto de partida para estudiar problemas de seguridad. <a name="habracut"></a><br><br><h2>  Autenticaci√≥n </h2><br>  Kubernetes tiene dos tipos de usuarios: <br><br><ul><li>  <i>Cuentas de servicio</i> : cuentas administradas por la API de Kubernetes; </li><li>  <i>Usuarios</i> : <i>usuarios</i> "normales" controlados por servicios externos e independientes. </li></ul><br>  La principal diferencia entre estos tipos es que para las Cuentas de servicio hay objetos especiales en la API de Kubernetes (se llaman Cuentas de servicio) que est√°n vinculados a un espacio de nombres y a un conjunto de datos de autorizaci√≥n almacenados en un cl√∫ster en objetos de tipo Secretos.  Dichos usuarios (Cuentas de servicio) est√°n destinados principalmente a administrar los derechos de acceso a los procesos API de Kubernetes que se ejecutan en un cl√∫ster de Kubernetes. <br><br>  Los usuarios ordinarios no tienen entradas en la API de Kubernetes: deben ser administrados por mecanismos externos.  Est√°n destinados a personas o procesos que viven fuera del cl√∫ster. <br><br>  Cada solicitud a la API est√° vinculada a la cuenta de servicio o al usuario, o se considera an√≥nima. <br><br>  Los datos de autenticaci√≥n del usuario incluyen: <br><br><ul><li>  <i>Nombre de usuario</i> - nombre de usuario (may√∫sculas y min√∫sculas); </li><li>  <i>UID</i> es una cadena de identificaci√≥n de usuario legible por m√°quina que es "m√°s coherente y √∫nica que el nombre de usuario"; </li><li>  <i>Grupos</i> : una lista de grupos a los que pertenece el usuario; </li><li>  <i>Extra</i> : campos adicionales que puede utilizar el mecanismo de autorizaci√≥n. </li></ul><br>  Kubernetes puede utilizar una gran cantidad de mecanismos de autenticaci√≥n: certificados X509, tokens de portador, proxies de autenticaci√≥n, autenticaci√≥n b√°sica HTTP.  Con estos mecanismos, se puede implementar una gran cantidad de esquemas de autorizaci√≥n: desde un archivo est√°tico con contrase√±as hasta OpenID OAuth2. <br><br>  Adem√°s, se permiten m√∫ltiples esquemas de autorizaci√≥n al mismo tiempo.  Por defecto, el cl√∫ster usa: <br><br><ul><li>  tokens de cuenta de servicio - para Cuentas de servicio; </li><li>  X509 - para usuarios. </li></ul><br>  La pregunta sobre la administraci√≥n de ServiceAccounts est√° m√°s all√° del alcance de este art√≠culo, pero recomiendo comenzar a aprender m√°s sobre este tema en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">p√°gina de documentaci√≥n oficial</a> .  Consideraremos con m√°s detalle el tema del trabajo de los certificados X509. <br><br><h3>  Certificados para usuarios (X.509) </h3><br>  La forma cl√°sica de trabajar con certificados implica: <br><br><ul><li>  generaci√≥n clave: <br><br><pre> <code class="bash hljs">mkdir -p ~/mynewuser/.certs/ openssl genrsa -out ~/.certs/mynewuser.key 2048</code> </pre> </li><li>  generaci√≥n de solicitud de certificado: <br><br><pre> <code class="bash hljs">openssl req -new -key ~/.certs/mynewuser.key -out ~/.certs/mynewuser.csr -subj <span class="hljs-string"><span class="hljs-string">"/CN=mynewuser/O=company"</span></span></code> </pre> </li><li>  procesando la solicitud de certificado utilizando las claves de CA del cl√∫ster de Kubernetes, obteniendo un certificado de usuario (para obtener un certificado, debe usar una cuenta que tenga acceso a la clave de autoridad de certificado del cl√∫ster de Kubernetes, que se encuentra en <code>/etc/kubernetes/pki/ca.key</code> de forma predeterminada): <br><br><pre> <code class="bash hljs">openssl x509 -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ~/.certs/mynewuser.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out ~/.certs/mynewuser.crt -days 500</code> </pre> </li><li>  creando un archivo de configuraci√≥n: <br><ul><li>  Descripci√≥n del cl√∫ster (especifique la direcci√≥n y ubicaci√≥n del archivo de certificado de CA de la instalaci√≥n particular del cl√∫ster): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.100.200:6443</code> </pre> </li><li>  o, si <b>no es la</b> opci√≥n recomendada, puede omitir el certificado ra√≠z (entonces kubectl no verificar√° la correcci√≥n del cl√∫ster del servidor api): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --insecure-skip-tls-verify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --server=https://192.168.100.200:6443</code> </pre> </li><li>  Agregar un usuario al archivo de configuraci√≥n: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-credentials mynewuser --client-certificate=.certs/mynewuser.crt --client-key=.certs/mynewuser.key</code> </pre> </li><li>  agregando contexto: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-context mynewuser-context --cluster=kubernetes --namespace=target-namespace --user=mynewuser</code> </pre> </li><li>  asignaci√≥n de contexto predeterminada: <br><br><pre> <code class="bash hljs">kubectl config use-context mynewuser-context</code> </pre> </li></ul></li></ul><br>  Despu√©s de las manipulaciones anteriores, se crear√° una configuraci√≥n del formulario en el archivo <code>.kube/config</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: v1 clusters: - cluster: certificate-authority: /etc/kubernetes/pki/ca.crt server: https://192.168.100.200:6443 name: kubernetes contexts: - context: cluster: kubernetes namespace: target-namespace user: mynewuser name: mynewuser-context current-context: mynewuser-context kind: Config preferences: {} users: - name: mynewuser user: client-certificate: /home/mynewuser/.certs/mynewuser.crt client-key: /home/mynewuser/.certs/mynewuser.key</code> </pre> <br>  Para facilitar la transferencia de la configuraci√≥n entre cuentas y servidores, es √∫til editar los valores de las siguientes claves: <br><br><ul><li> <code>certificate-authority</code> </li> <li> <code>client-certificate</code> </li> <li> <code>client-key</code> </li> </ul><br>  Para hacer esto, puede codificar los archivos indicados en ellos usando base64 y registrarlos en la configuraci√≥n agregando el sufijo <code>-data</code> al nombre de las claves, es decir.  obtener <code>certificate-authority-data</code> , etc. <br><br><h3>  Certificados con kubeadm </h3><br>  Con el lanzamiento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kubernetes 1.15,</a> trabajar con certificados se ha vuelto mucho m√°s f√°cil gracias a la versi√≥n alfa de su soporte en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la utilidad kubeadm</a> .  Por ejemplo, as√≠ es como puede verse ahora la generaci√≥n de un archivo de configuraci√≥n con claves de usuario: <br><br><pre> <code class="bash hljs">kubeadm alpha kubeconfig user --client-name=mynewuser --apiserver-advertise-address 192.168.100.200</code> </pre> <br>  <i><b>NB</b> : <i>la direcci√≥n de publicidad</i> requerida se puede ver en la configuraci√≥n del servidor api, que se encuentra en <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> de forma predeterminada.</i> <br><br>  La configuraci√≥n resultante se enviar√° a stdout.  Debe guardarse en <code>~/.kube/config</code> cuenta de usuario o en el archivo especificado en la <code>KUBECONFIG</code> entorno <code>KUBECONFIG</code> . <br><br><h3>  Cavar m√°s profundo </h3><br>  Para aquellos que desean comprender a fondo los problemas descritos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo separado</a> sobre el trabajo con certificados en la documentaci√≥n oficial de Kubernetes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Un buen art√≠culo de Bitnami</a> , que aborda el tema de los certificados desde un punto de vista pr√°ctico. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de</a> autenticaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">general</a> en Kubernetes. </li></ul><br><h2>  Iniciar sesi√≥n </h2><br>  Una cuenta autenticada no tiene permiso para actuar en un cl√∫ster de forma predeterminada.  Kubernetes tiene un mecanismo de autorizaci√≥n para otorgar permisos. <br><br>  Antes de la versi√≥n 1.6, Kubernetes usaba un tipo de autenticaci√≥n llamado <b>ABAC</b> (control de acceso basado en atributos).  Los detalles al respecto se pueden encontrar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> .  Actualmente, este enfoque se considera heredado, pero a√∫n puede usarlo al mismo tiempo que otros tipos de autorizaci√≥n. <br><br>  La forma real (y m√°s flexible) de dividir los derechos de acceso al cl√∫ster se denomina <b>RBAC</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">control de acceso basado en roles</a> ).  Se ha declarado estable desde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kubernetes 1.8</a> .  RBAC implementa un modelo de derechos que proh√≠be todo lo que no est√© expl√≠citamente permitido. <br>  <b>Para habilitar RBAC</b> , debe ejecutar el servidor de API Kubernetes con la <code>--authorization-mode=RBAC</code> .  Los par√°metros se establecen en el manifiesto con la configuraci√≥n del servidor api, que por defecto se encuentra en la ruta <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> , en la secci√≥n de <code>command</code> .  Sin embargo, RBAC ya est√° habilitado de forma predeterminada, por lo que probablemente no deber√≠a preocuparse por esto: puede verificar esto mediante el valor del <code>authorization-mode</code> de <code>authorization-mode</code> (en el ya mencionado <code>kube-apiserver.yaml</code> ).  Por cierto, entre sus valores puede haber otros tipos de autorizaci√≥n ( <code>node</code> , <code>webhook</code> , <code>always allow</code> ), pero los dejaremos fuera del alcance del material. <br><br>  Por cierto, ya hemos publicado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo</a> con una historia bastante detallada sobre los principios y caracter√≠sticas de trabajar con RBAC, por lo que me limitar√© a una breve lista de los conceptos b√°sicos y ejemplos. <br><br>  Las siguientes entidades API se utilizan para controlar el acceso a Kubernetes a trav√©s de RBAC: <br><br><ul><li>  <code>Role</code> y <code>ClusterRole</code> son roles que describen privilegios: </li><li>  <code>Role</code> permite describir los derechos dentro de un espacio de nombres; </li><li>  <code>ClusterRole</code> : dentro del cl√∫ster, incluidos los objetos espec√≠ficos del cl√∫ster, como nodos, URL que no son recursos (es decir, no est√°n relacionados con los recursos de Kubernetes, por ejemplo, <code>/version</code> , <code>/logs</code> , <code>/api*</code> ); </li><li>  <code>RoleBinding</code> y <code>ClusterRoleBinding</code> : sirve para vincular <code>Role</code> y <code>ClusterRole</code> a un usuario, grupo de usuarios o ServiceAccount. </li></ul><br>  Las entidades Role y RoleBinding est√°n limitadas por el espacio de nombres, es decir  debe estar dentro del mismo espacio de nombres.  Sin embargo, RoleBinding puede referirse a ClusterRole, que le permite crear un conjunto de permisos est√°ndar y controlar el acceso con ellos. <br><br>  Los roles describen derechos utilizando conjuntos de reglas que contienen: <br><br><ul><li>  Grupos de API: consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> de apiGroups y la salida de <code>kubectl api-resources</code> ; </li><li>  recursos ( <i>recursos</i> : <code>pod</code> , <code>namespace</code> , <code>deployment</code> , etc.); </li><li>  verbos ( <i>verbos</i> : <code>set</code> , <code>update</code> , etc.). </li><li>  nombres de recursos ( <code>resourceNames</code> ): para el caso en que necesita proporcionar acceso a un recurso espec√≠fico y no a todos los recursos de este tipo. </li></ul><br>  Puede encontrar una discusi√≥n m√°s detallada sobre la autorizaci√≥n en Kubernetes en la p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> .  En cambio (o m√°s bien, adem√°s de esto) dar√© ejemplos que ilustran su trabajo. <br><br><h3>  Ejemplos de entidades RBAC </h3><br>  Un <code>Role</code> simple que le permite obtener la lista y el estado de los pods y monitorearlos en el <code>target-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: target-namespace name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Un ejemplo de <code>ClusterRole</code> , que le permite obtener una lista y el estado de los pods y monitorearlos en todo el cl√∫ster: <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: #  "namespace" ,   ClusterRole    name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Ejemplo <code>RoleBinding</code> , que permite al usuario <code>mynewuser</code> "leer" pods en el <code>my-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: read-pods namespace: target-namespace subjects: - kind: User name: mynewuser #     ! apiGroup: rbac.authorization.k8s.io roleRef: kind: Role #    ‚ÄúRole‚Äù  ‚ÄúClusterRole‚Äù name: pod-reader #  Role,      namespace, #   ClusterRole,   #    apiGroup: rbac.authorization.k8s.io</code> </pre> <br><h2>  Auditoria de eventos </h2><br>  Esquem√°ticamente, la arquitectura de Kubernetes se puede representar de la siguiente manera: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/617/793/499/6177934998b4bf1c5c8816c75beaef3f.png" alt="imagen"><br><br>  El componente clave de Kubernetes, que se encarga de procesar las solicitudes, es <b>api-server</b> .  Todas las operaciones en el cl√∫ster pasan a trav√©s de √©l.  Lea m√°s sobre estos mecanismos internos en el art√≠culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬øQu√© sucede en Kubernetes cuando comienza la ejecuci√≥n de kubectl?</a>  ". <br><br>  La auditor√≠a del sistema es una caracter√≠stica interesante en Kubernetes, que est√° desactivada de forma predeterminada.  Le permite registrar todas las llamadas a la API de Kubernetes.  Como puede adivinar f√°cilmente, a trav√©s de esta API se realizan todas las acciones relacionadas con la supervisi√≥n y el cambio del estado del cl√∫ster.  Una buena descripci√≥n de sus caracter√≠sticas se puede encontrar (como de costumbre) en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial de</a> K8.  A continuaci√≥n, intentar√© presentar el tema en un lenguaje m√°s simple. <br><br>  Entonces, <b>para habilitar la auditor√≠a</b> , necesitamos pasar tres par√°metros requeridos al contenedor en el servidor api, m√°s sobre el cual se describe a continuaci√≥n: <br><br><ul><li> <code>--audit-policy-file=/etc/kubernetes/policies/audit-policy.yaml</code> </li> <li> <code>--audit-log-path=/var/log/kube-audit/audit.log</code> </li> <li> <code>--audit-log-format=json</code> </li> </ul><br>  Adem√°s de estos tres par√°metros necesarios, hay muchas configuraciones adicionales relacionadas con la auditor√≠a: desde la rotaci√≥n de registros hasta las descripciones de webhook.  Par√°metros de rotaci√≥n de registro de ejemplo: <br><br><ul><li> <code>--audit-log-maxbackup=10</code> </li> <li> <code>--audit-log-maxsize=100</code> </li> <li> <code>--audit-log-maxage=7</code> </li> </ul><br>  Pero no nos detendremos en ellos con m√°s detalle: puede encontrar todos los detalles en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de kube-apiserver</a> . <br><br>  Como ya se mencion√≥, todos los par√°metros se establecen en el manifiesto con la configuraci√≥n del servidor api (por defecto <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ), en la secci√≥n de <code>command</code> .  Volvamos a los 3 par√°metros requeridos y anal√≠celos: <br><br><ol><li>  <code>audit-policy-file</code> : ruta al archivo YAML con la descripci√≥n de la pol√≠tica de auditor√≠a.  Volveremos a su contenido, pero por ahora noto que el archivo debe ser accesible para que el proceso api-server pueda leerlo.  Por lo tanto, es necesario montarlo dentro del contenedor, para lo cual puede agregar el siguiente c√≥digo a las secciones apropiadas de la configuraci√≥n: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /etc/kubernetes/policies name: policies readOnly: true volumes: - hostPath: path: /etc/kubernetes/policies type: DirectoryOrCreate name: policies</code> </pre> </li><li>  <code>audit-log-path</code> : ruta al archivo de registro.  La ruta tambi√©n debe ser accesible para el proceso del servidor api, por lo tanto, describimos de manera similar su montaje: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /var/log/kube-audit name: logs readOnly: false volumes: - hostPath: path: /var/log/kube-audit type: DirectoryOrCreate name: logs</code> </pre> </li><li>  <code>audit-log-format</code> : formato del registro de auditor√≠a.  Por defecto, esto es <code>json</code> , pero el formato de texto heredado tambi√©n est√° disponible. </li></ol><br><h3>  Pol√≠tica de auditor√≠a </h3><br>  Ahora sobre el archivo mencionado con la descripci√≥n de la pol√≠tica de registro.  El primer concepto de pol√≠tica de auditor√≠a es el <code>level</code> , el <b>nivel de registro</b> .  Son los siguientes: <br><br><ul><li>  <code>None</code> : no inicie sesi√≥n; </li><li>  <code>Metadata</code> : metadatos de solicitud de registro: usuario, tiempo de solicitud, recurso de destino (pod, espacio de nombres, etc.), tipo de acci√≥n (verbo), etc. </li><li>  <code>Request</code> : registrar metadatos y cuerpo de solicitud; </li><li>  <code>RequestResponse</code> : <code>RequestResponse</code> metadatos, cuerpo de solicitud y cuerpo de respuesta. </li></ul><br>  Los dos √∫ltimos niveles ( <code>Request</code> y <code>RequestResponse</code> ) no registran las solicitudes que no tuvieron acceso a los recursos (llamadas a las llamadas URL sin recursos). <br><br>  Adem√°s, todas las solicitudes pasan por <b>varias etapas</b> : <br><br><ul><li>  <code>RequestReceived</code> : la etapa en la que el controlador recibe la solicitud y a√∫n no se ha transferido a lo largo de la cadena de controladores; </li><li>  <code>ResponseStarted</code> : encabezados de respuesta enviados, pero antes de enviar el cuerpo de respuesta.  Generado para consultas largas (por ejemplo, <code>watch</code> ); </li><li>  <code>ResponseComplete</code> - cuerpo de respuesta enviado, no se enviar√° m√°s informaci√≥n; </li><li>  <code>Panic</code> : los eventos se generan cuando se detecta una emergencia. </li></ul><br>  Puede usar <code>omitStages</code> para omitir cualquier etapa. <br><br>  En el archivo de pol√≠ticas, podemos describir varias secciones con diferentes niveles de registro.  Se aplicar√° la primera regla coincidente encontrada en la descripci√≥n de la pol√≠tica. <br><br>  El demonio kubelet monitorea el cambio de manifiesto con la configuraci√≥n del servidor api y, si se detecta alguno, reinicia el contenedor con el servidor api.  Pero hay un detalle importante: <b>ignorar√°n los cambios en el archivo de pol√≠ticas</b> .  Despu√©s de realizar cambios en el archivo de pol√≠ticas, deber√° reiniciar api-server manualmente.  Dado que api-server se ejecuta como un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pod est√°tico</a> , el <code>kubectl delete</code> no lo reiniciar√°.  Tendr√° que hacer que <code>docker stop</code> manualmente en kube-masters donde se ha cambiado la pol√≠tica de auditor√≠a: <br><br><pre> <code class="bash hljs">docker stop $(docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>)</code> </pre> <br>  Cuando habilita la auditor√≠a, es importante recordar que <b>kube-apiserver tiene una carga m√°s alta</b> .  En particular, el consumo de memoria para almacenar el contexto de las solicitudes est√° aumentando.  El registro comienza solo despu√©s de enviar el encabezado de respuesta.  Adem√°s, la carga depende de la configuraci√≥n de la pol√≠tica de auditor√≠a. <br><br><h3>  Ejemplos de pol√≠ticas </h3><br>  Analicemos la estructura de los archivos de pol√≠ticas utilizando ejemplos. <br><br>  Aqu√≠ hay un archivo de <code>policy</code> simple para registrar todo en el nivel de <code>Metadata</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: Metadata</code> </pre> <br>  Puede especificar una lista de usuarios ( <code>Users</code> y <code>ServiceAccounts</code> ) y grupos de usuarios en la pol√≠tica.  Por ejemplo, as√≠ es como ignoraremos a los usuarios del sistema, pero registraremos todo lo dem√°s en el nivel de <code>Request</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: None userGroups: - "system:serviceaccounts" - "system:nodes" users: - "system:anonymous" - "system:apiserver" - "system:kube-controller-manager" - "system:kube-scheduler" - level: Request</code> </pre> <br>  Tambi√©n es posible describir el objetivo: <br><br><ul><li>  <code>namespaces</code> </li><li>  verbos ( <i>verbos</i> : <code>get</code> , <code>update</code> , <code>delete</code> y otros); </li><li>  recursos ( <i>recursos</i> , a saber: <code>pod</code> , <code>configmaps</code> , etc.) y grupos de recursos ( <code>apiGroups</code> ). </li></ul><br>  <b>¬°Presta atenci√≥n!</b>  Los recursos y grupos de recursos (grupos API, es decir, apiGroups), as√≠ como sus versiones instaladas en el cl√∫ster, se pueden obtener mediante los comandos: <br><br><pre> <code class="bash hljs">kubectl api-resources kubectl api-versions</code> </pre> <br>  La siguiente pol√≠tica de auditor√≠a se proporciona como una demostraci√≥n de las mejores pr√°cticas en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de Alibaba Cloud</a> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1beta1 kind: Policy #    RequestReceived omitStages: - "RequestReceived" rules: #   ,     : - level: None users: ["system:kube-proxy"] verbs: ["watch"] resources: - group: "" #  api group   ,    #   Kubernetes,  ‚Äúcore‚Äù resources: ["endpoints", "services"] - level: None users: ["system:unsecured"] namespaces: ["kube-system"] verbs: ["get"] resources: - group: "" # core resources: ["configmaps"] - level: None users: ["kubelet"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None userGroups: ["system:nodes"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None users: - system:kube-controller-manager - system:kube-scheduler - system:serviceaccount:kube-system:endpoint-controller verbs: ["get", "update"] namespaces: ["kube-system"] resources: - group: "" # core resources: ["endpoints"] - level: None users: ["system:apiserver"] verbs: ["get"] resources: - group: "" # core resources: ["namespaces"] #     read-only URLs: - level: None nonResourceURLs: - /healthz* - /version - /swagger* #   ,     ‚Äú‚Äù: - level: None resources: - group: "" # core resources: ["events"] #   Secret, ConfigMap  TokenReview    , #         - level: Metadata resources: - group: "" # core resources: ["secrets", "configmaps"] - group: authentication.k8s.io resources: ["tokenreviews"] #   get, list  watch   ;    - level: Request verbs: ["get", "list", "watch"] resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #        API - level: RequestResponse resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #         - level: Metadata</code> </pre> <br><br>  Otro buen ejemplo de pol√≠tica de auditor√≠a es el <a href="">perfil utilizado en GCE</a> . <br><br>  Para una respuesta r√°pida a los eventos de auditor√≠a, es posible <b>describir un webhook</b> .  Este problema se revela en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> , lo dejar√© fuera del alcance de este art√≠culo. <br><br><h2>  Resumen </h2><br>  El art√≠culo proporciona una descripci√≥n general de los mecanismos b√°sicos de seguridad en los grupos de Kubernetes que le permiten crear cuentas de usuario personalizadas, compartir sus derechos y registrar sus acciones.  Espero que sea √∫til para aquellos que enfrentan tales preguntas en teor√≠a o ya en la pr√°ctica.  Tambi√©n le recomiendo que consulte la lista de otros materiales sobre el tema de la seguridad en Kubernetes, que se encuentra en el "PS", tal vez entre ellos encontrar√° los detalles necesarios sobre temas que son relevantes para usted. <br><br><h2>  PS </h2><br>  Lea tambi√©n en nuestro blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">33+ Herramientas de seguridad de Kubernetes</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Introducci√≥n a las pol√≠ticas de red de Kubernetes para profesionales de la seguridad</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comprender RBAC en Kubernetes</a> "; </li><li>  "Las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">9 mejores pr√°cticas de seguridad en Kubernetes</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">11 maneras de (no) convertirse en una v√≠ctima del pirateo de Kubernetes</a> ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468679/">https://habr.com/ru/post/468679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468657/index.html">Bailes con apoyo: tipos y formas de apoyo. Sistemas de soporte trabajando en batalla</a></li>
<li><a href="../468663/index.html">End2 End Approach en tareas de reconocimiento autom√°tico de voz</a></li>
<li><a href="../468665/index.html">¬øPero es hora de comprar un irrigador?</a></li>
<li><a href="../468673/index.html">Taller "Garantizar la seguridad de los datos personales" - 3 de octubre, San Petersburgo</a></li>
<li><a href="../468677/index.html">El anuncio del tel√©fono inteligente Xiaomi Mi Mix Alpha</a></li>
<li><a href="../468683/index.html">Teor√≠a y pr√°ctica de la estandarizaci√≥n de los servicios de Docker.</a></li>
<li><a href="../468687/index.html">Analizamos las nuevas iniciativas del Banco Central para regular el mercado de valores: 3 grupos de inversores, restricciones para principiantes</a></li>
<li><a href="../468689/index.html">Registrar su negocio de TI en Singapur: ¬øqu√© debo hacer?</a></li>
<li><a href="../468691/index.html">Controladores de terceros peligrosos en su sistema o LOLDrivers</a></li>
<li><a href="../468693/index.html">C√≥mo la automatizaci√≥n destruye a los empleados de Walmart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>