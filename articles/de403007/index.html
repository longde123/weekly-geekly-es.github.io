<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üë©üèΩ‚Äç‚úàÔ∏è ü•Å Laden Sie die Firmware √ºber USB auf STM32 herunter ü§ò ü§òüèΩ ‚ôçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In meinem Projekt verwende ich den STM32F103C8-Mikrocontroller und das stm32duino-Framework . Dieser Klon von Arduino bietet einen speziellen Bootload...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laden Sie die Firmware √ºber USB auf STM32 herunter</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/403007/"><img src="https://habrastorage.org/getpro/geektimes/post_images/50c/046/5e3/50c0465e38ec8d772f985a4cc26288a6.png" alt="Bild"><br><br>  In meinem Projekt verwende ich den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">STM32F103C8-Mikrocontroller</a> und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">stm32duino-Framework</a> .  Dieser Klon von Arduino bietet einen speziellen Bootloader, mit dem Sie Firmware √ºber USB hochladen k√∂nnen, ohne externe Komponenten wie ST-Link oder USB-UART-Adapter zu verwenden. <br><br>  Heute musste ich mit einem nackten Controller unter CooCox und ohne stm32duino arbeiten.  Aber hier ist das Problem.  Selbst eine einfache Blinkerlampe, die durch diesen Bootloader gegossen wird, funktioniert nicht. <br><br>  Lass es uns richtig machen.  Vielleicht scheinen meine Berechnungen f√ºr einige allt√§glich zu sein.  Aber ich fange gerade an, STM32-Controller zu studieren und habe mindestens einen halben Tag get√∂tet, um das Problem zu finden.  Pl√∂tzlich verk√ºrzt dieser Artikel die Entwicklungszeit f√ºr jemanden. <br><a name="habracut"></a><br>  Ich habe nichts gegen ST-Link und andere Debugger.  Aber in meinem fertigen Ger√§t wird es nicht sein, aber es wird definitiv USB geben.  Warum nicht sofort die M√∂glichkeit zum Aktualisieren der Firmware √ºber USB festlegen?  Pers√∂nlich finde ich diese Methode bequem.  Umso mehr, ich habe bereits ein Kabel angeschlossen, an das Strom und USB Serial angeschlossen sind. <br><br>  Mal sehen, wie der Bootloader funktioniert.  Erste Schritte mit dem Beispiel von AVR-Controllern.  Warum habe ich mich an ihn erinnert?  Ich wechselte von Arduino und erwartete unbewusst das gleiche Verhalten.  Aber in STM32 lief alles anders.  Daher m√∂chte ich √ºber den Unterschied zwischen diesen beiden Mikrocontrollern sprechen. <br><br>  Also.  In AVeg ATMega-Mikrocontrollern kann gegen Ende des Flashs eine bestimmte Speichermenge f√ºr den Bootloader reserviert werden.  Mit Sicherungsbits k√∂nnen Sie steuern, von welcher Adresse aus das Programm gestartet wird.  Wenn kein Bootloader vorhanden ist, startet das Programm an der Adresse 0x0000.  Wenn es einen Bootloader gibt, beginnt er an einer anderen Adresse (z. B. in ATMega32 mit 0x3C00, wenn die Bootloader-Gr√∂√üe 2 KB betr√§gt). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/32a/c00/3a7/32ac003a7b0509cd8b322ba9b3ffc359.png" alt="Bild"></div><br>  Wenn der Bootloader seine Arbeit erledigt hat, √ºbertr√§gt er die Steuerung von der Adresse 0x0000 an das Hauptprogramm.  Das hei√üt,  Das Programm startet immer um 0x0000.  Der Compiler und der Linker arbeiten mit der Tatsache, dass sich der Code am Anfang des Adressraums befindet. <br><br>  Bei STM32-Mikrocontrollern ist alles anders.  Alle Programme starten ab der Adresse 0x0800000.  Ein Bootloader ist nicht so besonders.  Dies ist das gleiche Programm, das von derselben Startadresse startet.  Dabei kann der Bootloader die Firmware empfangen (√ºber USB oder UART, von einem USB-Flash-Laufwerk lesen, von einem Satelliten empfangen, von einem Unterraum abrufen, was auch immer ...) und an Adressen schreiben, die h√∂her als der Bootloader selbst sind.  Und nat√ºrlich am Ende seiner Arbeit die Kontrolle auf das Hauptprogramm √ºbertragen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/82d/bdf/a0a/82dbdfa0ac179f37a3f8ee67cb4d4c44.png" alt="Bild"></div><br>  Wenn Sie also die Firmware kompilieren, m√ºssen Sie wissen, wo der Bootloader die Firmware schreibt, und die Adressen entsprechend anpassen. <br><br>  Das ist alles mit Theorie.  Lass uns weiter √ºben.  Im Folgenden finden Sie eine schrittweise Anleitung zum Anbringen des USB-Bootloaders an den Mikrocontrollern der STM32F1xx-Serie und m√∂glicherweise auch an einigen anderen. <br><br>  Es gibt jedoch einige Einschr√§nkungen f√ºr die Schaltung.  Hier bin ich leider nicht stark.  ITP ben√∂tigt einen 1,5k Pull-Up-Widerstand f√ºr den PA12-Port (auch bekannt als USB D +).  Dadurch kann der Bootloader zum richtigen Zeitpunkt eine Verbindung zu USB herstellen und trennen. <br><br>  Anleitung: <br><br><ul><li>  Laden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/rogerclarkmelbourne/STM32duino-bootloader</a> herunter.  Im Verzeichnis STM32F1 \ binaries befindet sich bereits ein Paket kompilierter Bootloader f√ºr verschiedene Boards.  Der Index am Ende des Dateinamens gibt an, wo die LED angeschlossen ist.  Bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">meiner</a> Karte, bei der die LED an Pin C13 angeschlossen ist, habe ich die Datei generic_boot20_pc13.bin verwendet. <br><br></li><li>  Wir blinken <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gem√§√ü den Anweisungen</a> .  Ja, hier ben√∂tigen Sie einen USB-UART-Adapter, aber Sie k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auch einen Debugger verwenden</a> . <br><br></li><li>  Jetzt kann der Mikrocontroller √ºber den USB-Bootloader flashen.  Sie m√ºssen jedoch noch die Firmware selbst reparieren.  Und Sie m√ºssen zwei Dinge tun: <br><br><ul><li>  Geben Sie dem Linker eine Startadresse.  In CooCox erfolgt dies in den Projekteinstellungen, Registerkarte Verkn√ºpfung, Abschnitt Speicherbereiche, IROM1-Startadresse.  Der Bootloader ben√∂tigt die ersten 8 Kilobyte, was bedeutet, dass die Startadresse der Firmware 0x0800000 + 0x2000 = 0x08002000 lautet.  Das Feld Gr√∂√üe sollte wahrscheinlich auch um 8 KB reduziert werden. <br><br></li><li>  Rufen Sie irgendwo zu Beginn des Programms an, bevor Sie die Peripherie initialisieren <br><br><pre><code class="cpp hljs">NVIC_SetVectorTable(NVIC_VectTab_FLASH, <span class="hljs-number"><span class="hljs-number">0x2000</span></span>);</code> </pre> <br><br>  UPDATE 17.05.2008: In der modernen Version von STM32Cube gibt es keine NVIC_SetVectorTable () -Funktion.  Stattdessen k√∂nnen Sie den Fehler VECT_TAB_OFFSET in der Datei system_stm32f1xx.c (oder √§hnlichem f√ºr einen anderen Mikrocontroller) beheben. <br></li></ul><br></li><li>  Die Firmware-F√ºllung kann <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aus dem stm32duino-Projekt entnommen werden</a> .  Suchen Sie im Tools-Verzeichnis nach einem Skript namens maple_upload.  Ich habe nur die Windows-Version verwendet - maple_upload.bat. <br><br></li><li>  Laufen Sie so: <br><br><pre> <code class="hljs css">"<span class="hljs-selector-tag"><span class="hljs-selector-tag">maple_upload</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bat</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">COM20</span></span> 2 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">EAF</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0003</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">Path</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Firmware</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bin</span></span>"</code> </pre> <br>  Anstelle von COM20 m√ºssen Sie Ihren Port ersetzen, an dem der Mikrocontroller angeschlossen ist. <br><br>  Der Ausgie√üer ist eine sehr zarte Sache, er mag keine relativen Wege.  Daher muss der Pfad zur Firmware vollst√§ndig angegeben werden. <br><br>  1EAF: 0003 ist die VID und PID <br><br>  2 - Dies ist der AltID-Parameter, der angibt, dass die Firmware unter 0x08002000 hochgeladen werden soll (lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ). <br></li></ul><br>  Noch ein paar Nuancen.  Vor dem Hochladen der Firmware m√ºssen Sie den Bootloader ausf√ºhren.  Am einfachsten ist es, die Reset-Taste zu dr√ºcken.  Danach startet der Bootloader und wartet einige Sekunden auf die Firmware.  Wenn zu diesem Zeitpunkt niemand maple_upload gestartet hat, √ºbertr√§gt der Bootloader die Kontrolle an die Hauptfirmware. <br><br>  Um nicht jedes Mal auf Zur√ºcksetzen zu dr√ºcken, verwenden libmaple / stm32duino-basierte Boards einen Trick.  Sie h√∂ren auf die serielle USB-Schnittstelle.  Wenn dort ein DTR-Signal auftritt und eine Schl√ºsselfolge von Bytes √ºbertragen wird, wird der Mikrocontroller erneut in den Bootloader geladen.  Schauen Sie <a href="">sich die Funktion rxHook () an</a> . <br><br>  Dies kann zu Unannehmlichkeiten f√ºhren.  Wenn der Mikrocontroller heruntergefahren wird und h√§ngt, h√∂rt er nicht mehr auf den Port.  Daher kann er die Tastenfolge nicht h√∂ren und den Bootloader neu starten.  Dann nur zur√ºcksetzen, um zu helfen. <br><br>  Das ist alles.  Ich hoffe, mein Artikel gibt Aufschluss dar√ºber, wie der Bootloader in STM32 funktioniert und wie Firmware √ºber einen USB-Anschluss heruntergeladen wird.  Leider ist die Eintrittsschwelle immer noch hoch, aber pl√∂tzlich wird mein Artikel jemandem helfen, sie zu √ºberwinden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de403007/">https://habr.com/ru/post/de403007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de402995/index.html">BrickerBot-Malware verwandelt IoT-Gadgets in einen Baustein</a></li>
<li><a href="../de402997/index.html">Erstes Mal: ‚Äã‚ÄãEine kurze Filmkritik</a></li>
<li><a href="../de402999/index.html">Mehrphasenschlaf - eine Geschichte guter Erfahrungen</a></li>
<li><a href="../de403003/index.html">Wissenschaftler haben Bakterien entwickelt, die Kolitis bei M√§usen erkennen k√∂nnen</a></li>
<li><a href="../de403005/index.html">Faktenpr√ºfung: Wer entscheidet, woran er glaubt?</a></li>
<li><a href="../de403009/index.html">Alizar erzielte 5.000 Ver√∂ffentlichungen zu Geektimes</a></li>
<li><a href="../de403011/index.html">Von Kopf bis Fu√ü: einige Beispiele f√ºr schicke Kleidung und Accessoires</a></li>
<li><a href="../de403013/index.html">Forschung: Die Domestizierung moderner W√∂lfe ist m√∂glich</a></li>
<li><a href="../de403015/index.html">Ist StarShot Hawking-Milner m√∂glich?</a></li>
<li><a href="../de403017/index.html">Kosmische virtuelle Realit√§t: eine Auswahl f√ºr den Kosmonautik-Tag f√ºr Kinder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>