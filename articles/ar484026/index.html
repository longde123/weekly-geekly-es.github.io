<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๐ผ ๐๐ป ๐ช๐ป ุงูุฌุฒุก 6: ุชุฑููุฉ MemTest86 + ุฅูู RISC-V ๐ท๏ธ ๐๐ป ๐๏ธ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุฑุจูุง ูุญุชุงุฌ ุนุฏุฏ ูููู ูู ููุธูู ุชูููููุฌูุง ุงููุนูููุงุช ุฅูู ุดุฑุญ ูุงููุฉ Memtest86 + - ุฑุจูุง ุฃุตุจุญ ุจุงููุนู ุฃูุซุฑ ุฃู ุฃูู ูู ุงููุนูุงุฑ ูู ุงุฎุชุจุงุฑ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุน...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุฌุฒุก 6: ุชุฑููุฉ MemTest86 + ุฅูู RISC-V</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br><p style=";text-align:right;direction:rtl"> ุฑุจูุง ูุญุชุงุฌ ุนุฏุฏ ูููู ูู ููุธูู ุชูููููุฌูุง ุงููุนูููุงุช ุฅูู ุดุฑุญ ูุงููุฉ Memtest86 + - ุฑุจูุง ุฃุตุจุญ ุจุงููุนู ุฃูุซุฑ ุฃู ุฃูู ูู ุงููุนูุงุฑ ูู ุงุฎุชุจุงุฑ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุนูู ุฌูุงุฒ ููุจููุชุฑ.  ุนูุฏูุง ุตุงุฏูุช ูู ุฃุญุฏ <a href="https://habr.com/ru/post/459470/">ุงูุฃุฌุฒุงุก ุงูุณุงุจูุฉ</a> ุดุฑูุท ุฐุงูุฑุฉ ูุนุทูุงู ูุฑูููุง ุจุงูููุญุฉ ุ ุจุฏุง (ูุน ูุชุจููู ูุฒูุฏ ุจุชูููุฉ DDR2) ุญูุงู ูุงุถุญูุง.  ุณุคุงู ุขุฎุฑ ูู ุฃูู ุ ูู ุญูุซ ุงููุจุฏุฃ ุ ูุงูุช ุงูุนูููุฉ ุบูุฑ ุงููุณุชูุฑุฉ ูููุธุงู ูุฑุฆูุฉ ููุนูู ุงููุฌุฑุฏุฉ.  ูู ุงูุญุงูุงุช ุงูุฃูุซุฑ ุตุนูุจุฉ ุ ุณูุนุช ุฃูู ุจุงูุฅุถุงูุฉ ุฅูู "ุงูุชูุตุช" ุบูุฑ ุงูุนุงุฏู ูุฎูุงูุง ุงูุฐุงูุฑุฉ ุฅูู ูุง ูุง ููุงูุฉ ุ ุชุณุชุฎุฏู ูุฐู ุงูุฃุฏุงุฉ ุจุนุถ ุฃููุงุท ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุงูุชู ูู ุงููุญุชูู ุฃู ูุชู ุงูุชุดุงู ุงูุฃุฎุทุงุก ูู ุชุดุบูู DDR ุนูููุง.  ุจุดูู ุนุงู ุ ุดูุก ุฑุงุฆุน ุ ุฅูู ูุฃูุฑ ูุคุณู ุฃูู ุญุชู ูู ุงูุงุณู ูููู: 86 - "ููุท ููุฃูุธูุฉ ุงููุชูุงููุฉ ูุน x86."  ุฃู ูุงุ </p><br><p style=";text-align:right;direction:rtl">  ุชุญุช ุงููุต ุ ุณุชุฑู ูุญุงููุงุชู ูุชูุตูู MemTest86 + v5.1 ุฅูู RISC-V ูุงูุฅุฌูุงูู ุงููุฑุนู.  <em>ุงูููุณุฏ: ูุชุญุฑู!</em> </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  <strong>ุฅุฎูุงุก ุงููุณุฆูููุฉ: ุชู ุงุฎุชุจุงุฑ ุงููุดุฑูุน ุงููุงุชุฌ ุฅูู ุงูุญุฏ ุงูุฃุฏูู ุนูู ูุฌู ุงูุชุญุฏูุฏ ูู ูุจูู ุนูู ูุฌููุนุฉ RocketChip ูุญุฏุฏุฉ ุนูู ููุญุฉ ูุญุฏุฏุฉ.</strong>  <strong>ุงูุฏูุฉ ูุงูุณูุงูุฉ (ุฎุงุตุฉ ูู ุงูุฃูุธูุฉ ุงูุฃุฎุฑู) ุบูุฑ ูุถูููุฉ.</strong>  <strong>ุงุณุชุฎุฏุงู ุนูู ูุณุคูููุชู ุงูุฎุงุตุฉ.</strong>  <strong>ุนูู ูุฌู ุงูุฎุตูุต ุ ูุง ุชุชู ูุนุงูุฌุฉ ููุงุทู ุงูุฐุงูุฑุฉ ุงููุญุฌูุฒุฉ ุญุงูููุง ุจุฃู ุทุฑููุฉ ุฅุฐุง ูุงูุช ุชูุน ูู ูุทุงู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู.</strong> </p><br><p style=";text-align:right;direction:rtl">  ููุง ููุช ุจุงููุนู ุ ููุฐ ููุช ููุณ ุจุจุนูุฏ ุงุดุชุฑูุช ุงูููุญุฉ ุงูุฃู ูุน Cyclone IV ุนูู AliExpress ุ ููู ุงูุฐุงูุฑุฉ ููู ูุงูุช ุนุฑุจุงุช ุงูุชู ุชุฌุฑูุง ุงูุฏูุงุจ.  ูุญุณู ุงูุญุธ ุ ูุงูุช ุฅุญุฏู ุงูููุฒุงุช ุงููููุฉ ูู ูุฐุง ุงูููุชุฏู ูู ุงุณุชุฎุฏุงู ูุญุฏุงุช DDR2 SO-DIMM ุงูุชูููุฏูุฉ - ููุง ูู ุงูุญุงู ูู ูุชุจููู ุงููุฏูู ุงูุฎุงุต ุจู.  ููุน ุฐูู ุ ุณูููู ูู ุงููุซูุฑ ููุงูุชูุงู ุงูุญุตูู ุ ุฅุฐุง ุฌุงุฒ ุงูุชุนุจูุฑ ุ ุนูู ุญู ูุณุชุถุงู ุฐุงุชููุง ูุงุฎุชุจุงุฑ ูุญุฏุงุช ุงูุฐุงูุฑุฉ (ููู ุงููุงูุน ุ ุฃูุถูุง ูุญุฏุฉ ุงูุชุญูู).  ูุงู ุงุญุชูุงู ุชุตุญูุญ ุฃุฎุทุงุฆู ูู ุธุฑูู ุงูุฐุงูุฑุฉ ุงูุณูุฆุฉ ุจุทุฑููุฉ ูุง ุบูุฑ ูุฑุถู ุนูู ุงูุฅุทูุงู.  ุฎุงุตุฉู ูุง ุขูู ูู ุญู ุณุฑูุน ูุงูุงุณุชุนุฏุงุฏ ุงูุฐููู ูุชุฃุฌูู ุฅุนุงุฏุฉ ูุชุงุจุฉ ูุงููุฉ ูู ูุฌูุน ุขุฎุฑ ููุชุฑุฉ ุทูููุฉ ุฅูู ุงูุฃุจุฏ ุ ูุชุญุช ููุงูุฉ ููููุจูุฏูุง ุนูู Memtest86 + ูุฑุฃูุช ูุฌุฃุฉ "ููุชูุจ ูู: C ูุงูุชุฌูุน" ูู ุงูุจุทุงูุฉ.  ูู ุ ููุฐุง ูู ุ ุนูู ุงูุฑุบู ูู ุฃู "... 86" ุ ูููู ูู ููุชุจ ุจุงููุงูู ูู ุงููุฌูุนุ  ูุฐุง ูุดุฌุน.  ูุจูู ููุท ูููู ุงูุนูุงูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุฐุง ุ ุงูุชูู ุฅูู <a href="http://www.memtest.org/" rel="nofollow">memtest.org</a> ููู ุจุชูุฒูู ุงูุฅุตุฏุงุฑ 5.01 ุถูู GPL2.  ูุณูููุฉ ุงูุชุทููุฑ ุ ููุช <a href="https://github.com/atrosinenko/memtest86-plus-riscv" rel="nofollow">ุจุฅุนุงุฏุฉ</a> ุชุญูููู ุนูู ุฌูุซุจ.  ูุญุณู ุงูุญุธ ุ ูุจุงุดุฑุฉ ูู ุฃุฑุดูู ุงููุตุฏุฑ ุ ุงุณุชูุจููุง ููู <a href="https://github.com/atrosinenko/memtest86-plus-riscv/blob/68b365d13cf22accd52f88af49c33f57c6643ae5/README.background" rel="nofollow">README.background</a> ุ ุงููุนููู </p><br><blockquote style=";text-align:right;direction:rtl">  ุนูู ุงูุชุดุฑูุญ ูุนูู ูุธุงุฆู ุงูุฃุนุถุงุก ูู Memtest86-SMP </blockquote><p style=";text-align:right;direction:rtl"> ูููุถุญ ูู ุจุนุถ ุงูุชูุงุตูู (ูุญุชู ูุน ุงูุตูุฑ ูู ุดูู ASCII ุงููู) ุนูููุฉ ุฑููุนุฉ ุงููุณุชูู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ.  ูู ุจุฏุงูุฉ ุงููุณุชูุฏ ุ ูุฑู <em>ุชุฎุทูุทูุง ุซูุงุฆููุง</em> ูุชููู ูู <code>bootsect.o</code> ู <code>setup.o</code> ู <code>head.o</code> ูุจุนุถ <code>memtest_shared</code> .  ูู ุงูุณูู ูุนุฑูุฉ ุฃูู ูุชู ุงูุญุตูู ุนูู ูููุงุช ุงููุงุฆูุงุช ุงูุซูุงุซุฉ ูุฐู ูู ูุตุงุฏุฑ ุงููุฌููุน ุงูููุงุธุฑุฉ.  ูููููุฉ ุงูุฃููู ุ ูู ุดูุก ุขุฎุฑ ููุชูุจ ูู C!  ููุณ ุณูุฆุง ุ ููุณ ุณูุฆุง ... </p><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ููุช ุจูุณุฎ <code>Makefile</code> ุฅูู <code>Makefile.arch</code> ูุจุฏุฃุช ูู ุฅุนุงุฏุฉ ูุชุงุจุฉ ูู ุดูุก ุ ูุญุงูู ุงูุชุฎูุต ููุง ูุง ูุชูุงูู.  ุฃููุงู ููุจู ูู ุดูุก ุ ุจุงูุทุจุน ุ ููุช ุจุญุงุฌุฉ ุฅูู ุณูุณูุฉ ุฃุฏูุงุช ูู ุฃุฌู RISC-V ุ ูุงูุชู ุ ูุญุณู ุงูุญุธ ุ ูุงูุช ูุง ุชุฒุงู ูุนู ููุฐ ุงูุชุฌุงุฑุจ ุงูุณุงุจูุฉ.  ูู ุงูุจุฏุงูุฉ ุ ููุฑุช ูู ุฅูุดุงุก ูููุฐ ูููุฏุณุฉ 32 ุจุช ุ ููููู ุชุฐูุฑุช ุจุนุฏ ุฐูู ุฃูู ุชู ุชุญููู ูุนุงูุฌ 64 ุจุช ุนูู ุงูููุญุฉ ุ ููุงู ูุฏูู ุณูุณูุฉ <code>riscv64-</code> ุจูุง ุจุงุฏุฆุฉ <code>riscv64-</code> . </p><br><p style=";text-align:right;direction:rtl">  <em>ุงูุงูุญุฏุงุฑ ุงูุบูุงุฆู:</em> ุจุงูุทุจุน ุ ูุงู ุฃูู ุดูุก ูู ุฏุฑุงุณุฉ ูุณุฃูุฉ ุชูุงูู ุงูููุฏ 32 ู 64 ุจุช.  ูุชูุฌุฉ ูุฐูู ุ ูุฅู ุงูููุงุตูุงุช ุงูุฎุงุตุฉ ุจุงูุฌุฒุก ุบูุฑ ุงููููุฒ ูู ISA (ุจููุฉ ูุฌููุนุฉ ุงูุชุนูููุงุช) ููุฌูุฏุฉ ูู ุงูููุฑุฉ <code>1.3 RISC-V ISA Overview</code> ุจูุงู <code>1.3 RISC-V ISA Overview</code> : </p><br><blockquote style=";text-align:right;direction:rtl">  ุงูููุฒุฉ ุงูุฑุฆูุณูุฉ ููุตู ISAs ุงูุฃุณุงุณู ุจุดูู ุตุฑูุญ ูู ุฃูู ูููู ุชุญุณูู ูู ISA ISA ูุงุญุชูุงุฌุงุชู ุฏูู ุงูุญุงุฌุฉ ุฅูู ุฏุนู ุฌููุน ุงูุนูููุงุช ุงููุงุฒูุฉ ููุนุงููุฑ ISA ุงูุฃุณุงุณูุฉ ุงูุฃุฎุฑู.  ุนูู ุณุจูู ุงููุซุงู ุ ูููู ุฃู ูููู RV64I ุจุญุฐู ุงูุชุนูููุงุช ู CSRs ุงููุทููุจุฉ ููุท ููุชุนุงูู ูุน ุงูุณุฌูุงุช ุงูุฃุถูู ูู RV32I.  ูููู ุฃู ุชุณุชุฎุฏู ุฎูุงุฑุงุช RV32I ูุณุงุญุฉ ุงูุชุฑููุฒ ุงููุญุฌูุฒุฉ ุนูู ุฎูุงู ุฐูู ููุชุนูููุงุช ุงููุทููุจุฉ ููุท ูู ุฎูุงู ุงููุชุบูุฑุงุช ูุณุงุญุฉ ุงูุนููุงู ุงูุฃูุณุน. </blockquote><p style=";text-align:right;direction:rtl">  ุฃุฑูุฏ ุฃูุถูุง ุฃู ุฃุดูุฑ ุฅูู ุฃู ุณูุณูุฉ ุงูุฃุฏูุงุช ูุน ุจุงุฏุฆุฉ <code>riscv64-</code> ุงููุญุชูู ุฃู ุชุฌูุน ุจุณูููุฉ ุฑูุฒ 32 ุจุช ุฅุฐุง ุชู ุชุญุฏูุฏ ุงูุจููุฉ ุงููุฏู ุจุดูู ุตุญูุญ - ุงููุฒูุฏ ุญูู ุฐูู ูุงุญููุง. </p><br><p style=";text-align:right;direction:rtl">  ูู ุนูููุฉ ุงูููู ุ ูู ุงูููุทูู ุงูุญูุงุธ ุนูู ูุฐู ุงููุณุชูุฏุงุช ูู ูุชูุงูู ุงููุฏ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://riscv.org/specifications/" rel="nofollow">ุฏููู ุชุนููู RISC-V ุ ุงููุฌูุฏ ุงูุฃูู: ISA ุบูุฑ ุงููููุฒ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://riscv.org/specifications/privileged-isa/" rel="nofollow">ุฏููู ุงูุชุนูููุงุช ููุฌููุนุฉ RISC-V ุ ุงููุฌูุฏ ุงูุซุงูู: ุงูููุฏุณุฉ ุงููููุฒุฉ</a> </li><li style=";text-align:right;direction:rtl">  ุฃูุถูุง ุ ุจุนุถ <a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">ุฏููู SiFive FU540-C000</a> - ุฏููู ููุฑูุงูุฉ ุ ูุดุจู ุณููู ุงููุนุงูุฌ ุงููุงุนู ุ ูุงูุฐู ูุณุชุฎุฏู ููุชุตุญูุญ ูู FPGAs ุ ูู ูููู ูู ุบูุฑ ูุญูู </li></ul><br><h2 id="nastroyka-sborki" style=";text-align:right;direction:rtl">  ุจูุงุก ุงูุฅุนุฏุงุฏ </h2><br><p style=";text-align:right;direction:rtl">  ููุจุฏุฃ ุจุงูููุงููุฉ: ุฃุฑูุฏ ุงูุญุตูู ุนูู ูููุฐ ููุงุณุจ ููุฒูุฏ ูู ุงูููู ุฅูู ุงูุจููุงุช ุงูุฃุฎุฑู ุบูุฑ x86 ู RISC-V.  ุฃูุชุฑุญ ุฃูุถูุง ุฅููุงุก ุฃูุฑุงุต ูุฑูุฉ ุงูุชูููุฏ ูุชูุงุตูู x86 ุงูุฃุฎุฑู ุฎุงุฑุฌ ุจููุฉ ุงููุธุงู ุงูุฃุณุงุณู ุงููุดุชุฑู. </p><br><p style=";text-align:right;direction:rtl">  ูุง ูุฏููุง ูู ุงูููุงูุฉ: ููุงู ุซูุงุซุฉ ูููุงุช ูุฌููุน: <code>bootsect.S</code> ู <code>setup.S</code> ู <code>head.S</code>  ููุงู ุญุงุฌุฉ ุฅูู ุงูุฃูููู ููุท ุนูุฏ ุจุฏุก ุงูุชุดุบูู ุ ูุงูุซุงูุซ ูุทููุจ ูุงุญููุง ุนูุฏ ุงูุงูุชูุงู ุฅูู ููุทูุฉ ุฐุงูุฑุฉ ุฃุฎุฑู.  ูุงูุญูููุฉ ูู ุฃูู ูู ุฃุฌู ุงุฎุชุจุงุฑ ุงูุฐุงูุฑุฉ "ุชุญุช ููุณู" ุ ูุฌุจ ุฃู ููุชูู ุฑูุฒ ุงูุงุฎุชุจุงุฑ ุฃููุงู ุฅูู ููุงู ุฌุฏูุฏ.  ูุชู ุฌูุน ูููุงุช Sich ูู ELF ุ ููู ุซู ูุชู ุฃุฎุฐ ุฃูุณุงู ุงูููุฏ ูุงูุจูุงูุงุช ููุง ุฅูู ุฐูู.  ุนูุงูุฉ ุนูู ุฐูู ุ ูุชู ุฌูุนูุง ูู ุดูู PIC (ุฑูุฒ ุงููุธููุฉ ุงููุณุชููุฉ) - ูู ุงูุจุฏุงูุฉ ููุช ููุฏูุดูุง: ุนูู ุงูุฑุบู ูู ุฃู ุงูููุฏ ูุงุฆู ุจุฐุงุชู (ุฃู ุ ุจุฏูู ููุงุฉ ุ libc ุ ุฅูุฎ) ุ ูุฅูู ูุณุชุฎุฏู ูุฐู ุงูููุฒุงุช ุงููุชูุฏูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุนูุงูุฉ ุนูู ุฐูู ุ ุชุธูุฑ ุงููุนููุงุช ุงูุชู ุชุญุฏุฏ ุงูุจููุฉ ุจุดูู ุฏูุฑู ูู Makefile: <code>-march=i486</code> ู <code>-m32</code> ููุง ุดุงุจู.  ุฃุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุดูุก ูู ูุฐุง ุงููุจูู ุ <del>  ููู ุซู ูุซู ูุตุงุตุฉ </del>  .  ุงููุถุน ูุน ุจููุฉ RISC-V ูุดุจู ูุฐุง: ููุงู <code>rv64</code> ู <code>rv64</code> (ุนูู <code>rv64</code> ุ ูุง ูุฒุงู ููุงู ุฃูุซุฑ ูุถูู ู rv128 ูุญุฌูุฒูู ูููุณุชูุจู ุ ููููุง ูุณูุง ููุชููู ุจูุง) ุ ููุชู ุชูููู ุงุณู ISA ุนู ุทุฑูู ุชุนููู ุฃุญุฑู ููุฐู ุงูุจุงุฏุฆุฉ ุงูุงูุชุฏุงุฏุงุช: <code>i</code> - ูุฌููุนุฉ ุงูุฃุนุฏุงุฏ ุงูุตุญูุญุฉ ุงูุตุญูุญุฉ ุ <code>m</code> - ุนุฏุฏ ุงูุฃุนุฏุงุฏ ุงูุตุญูุญุฉ ูุงููุณูุฉ ุ ... ุจุงูุทุจุน ุ ุฃูุฏ ุฃู ุฃูุนู <code>rv64i</code> ุ ููู ุจุงููุงุฏ ุณูุชู ููู Memtest86 ุจุณูููุฉ ุฅูู ุงููููู ุฏูู ูุถุงุนูุฉ.  ุตุญูุญ ุ ูุจุฏู ุฃู ุงููุชุฑุฌู ุณูููู ุจุจุณุงุทุฉ ุจุฅูุดุงุก ุงุณุชุฏุนุงุกุงุช ุงูุฏูุงู ุจุฏูุงู ูู ุฅุฑุดุงุฏุงุช "ูุดููุฉ" ุ ูููู ููุงู ูุฎุงุทุฑุฉ ูู ุงูุจูุงุก ูุน ุฃุฏุงุก ููุฎูุถ ุฅูู ุญุฏ ูุจูุฑ (ูุงููู ุนู ุญูููุฉ ุฃู ูุฐู ุงูุฏุงูุงุช ุณุชุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุฃู ุฃุฎุฐูุง ูู ููุงู ูุง). </p><br><p style=";text-align:right;direction:rtl">  ุณูู ุชุญุชุงุฌ ุฃูุถุง ุฅูู ุฎุท ABI.  ูู ุญูุซ ุงููุจุฏุฃ ุ ุชู ุชูุถูุญ ุฃุณุงุณูุงุช ุงุตุทูุงุญ ุงููุฏุงุก ุจุงููุนู ูู <code>Volume I</code> ุงููุญุฏุฏ ูู "ุฏููู RISC-V ุงูุชุฌููุน ูุจุฑูุฌ" ุ ูุฐูู ุณุฃูุนู ููุท ุดูุก ูุซู </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help riscv64-linux-gnu-gcc-9: error: unrecognized argument in option '-mabi=help' riscv64-linux-gnu-gcc-9: note: valid arguments to '-mabi=' are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f riscv64-linux-gnu-gcc-9: fatal error: no input files compilation terminated.</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจุฏูู ุชูููุฑ <code>lp64</code> ุ ุณุขุฎุฐ <code>lp64</code> .  <em>ุจุงููุธุฑ ุฅูู ุงููุณุชูุจู ุ ุณุฃููู ุฃูู ูุน ABI ุ ูู ุชูุฌุญ ูููุงุช ุงูุฑุฃุณ ูู ุงูููุชุจุฉ ุงูููุงุณูุฉ ุ ูุฐุง ุฃุฎุฐุช <code>lp64f</code> ุ ูุชูุช ุชุฑููุฉ ARCH ุฅูู <code>rv64imf</code> .</em>  <em>ุจุฏูู ุฐุนุฑ ุ ูุง ุฃุฎุทุท ุญููุง ูุงุณุชุฎุฏุงู ุงูููุทุฉ ุงูุนุงุฆูุฉ ูู ูููุฐู.</em> </p><br><p style=";text-align:right;direction:rtl">  ูุธุฑูุง ูุฃููู ูุง ุฃุฑูุฏ ุจุทุฑููุฉ ูุง ุฃู ุฃุนูู ูู ูุชุงุจุฉ ุงูุจุฑุงูุฌ ุงููุตูุฉ <code>head.S</code> ุนุจุฑ ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ - ูุจุงูุชุงูู ูู ุฃุชููู ูู <em>ุงูุนุซูุฑ ุนูู ููุงุชูุญ ld ุนูู</em> ุงูููุฑ ุ ููุฏ ูุฑุฑุช ุงูุญุตูู ุนูู ููู <code>head.S</code> ุงููุฌููุน. ุชูุณูู ุจุจููุฉ ุงููุธุงุฆู ุจุงุณุชุฎุฏุงู <code>memtest_shared.arch.lds</code> .  ููุฏ ุทุฑุญุช ูุคุดุฑุงู ุนูู ุชูุณูู ุงูุฅุฎุฑุงุฌ ูุงูุจููุฉ ููู (ุจุนุฏ ูู ุดูุก ุ ูู ุงูุฃุณูู ุชุบููุฑู ูู ูุชุบูุฑ ูู Makefile) ุ ููุง ุนููุช ูุคูุชูุง ุนูู <code>DISCARD</code> ูู ุงูููุงูุฉ ุ ููู ุฃุชููู ูู ูุนุฑูุฉ ุงูุฃูุณุงู ุงููุญุฏุฏุฉ ููุนูููุงุช ุชุตุญูุญ ุงูุฃุฎุทุงุก ุงูุชู ุฃุญุชุงุฌ ุฅูููุง.  <em>(ุงูุชุทูุน ุฅูู ุงููุณุชูุจู: ูุนูููุงุช ุชุตุญูุญ ุฃุฎุทุงุก ุฌูุฏุฉ ุ ูููู ูุฌุจ ุฅุถุงูุฉ <code>.rela</code> )</em> ุจุดูู ุนุงู ุ ุฃูุฏุช ูุณุฎุฉ x86 ุนูู ุงูุญุงุฌุฉ ูุชูุงุณุจ 64 <em><code>.rela</code></em> - ุขูู ุฃู ูููู ูุฐุง ูุฑุชุจุทูุง ุจุทุฑููุฉ ูุง ุจููุฒุงุช ุงููุถุน ุงูุญูููู ููุง ููุชู ุจูุง ุนูู RISC-V .  ูุชูุฌุฉ ูุฐูู ุ ุณูุชู ุฌูุน ุงููุงุฆู ุงููุดุชุฑู ูุน PIC ุ ููุง ูู ุงูุญุงู ูู ุงููุต ุงูุฃุตูู ุ ุณูุชู ูู ุงูุดูุฑุฉ ูุงูุจูุงูุงุช ุงูุชู ุณูุชู ุชุญููููุง ูู ุงูุฐุงูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูููู ุจุฌูุน ... ูููุน <code>reloc.c</code> ููู <code>reloc.c</code> ุงูุฃูู - ูุจุฏู ุฃูู ูุฃุฎูุฐ ูู ุจุนุถ <code>ld-linux.so</code> ููู ูุณุคูู ุนู ุฏุนู ุฌุฏูู ุงูุฃููุณุช ุงูุนุงููู ุ ุฅูุฎ.  ูููุง ูุงุชูุงููุงุช ุงูุฏุนูุฉ ุฅูู x86.  ุงุชุถุญ ุฃูู ูุชุทูุจ ุงูุนูู ูุจุงุดุฑุฉ ูุน ุงูุณุฌูุงุช ุจุงุณุชุฎุฏุงู ุฅุฏุฑุงุฌ ุงููุฌูุน.  ููููุง ูู RISC-V - ุชู ุฅุนุฏุงุฏู ุฃุตูุงู ูุฏุนู PIC ุงูุฃุตูู ุ ูุฐูู ูุง ุชุชุฑุฏุฏ ูู ุฑูู <code>reloc.c</code> .  ุนูุงูุฉ ุนูู ุฐูู ุ ูุง ูุฒุงู ููุงู ุฅุฏุฑุงุฌ ุ ูู ุจุนุถ ุงูุฃุญูุงู ุทูููุฉ ุฌุฏุง.  ูุญุณู ุงูุญุธ ุ ูุงููุง ุฅูุง ูู ุฑูุฒ ุงูุงุฎุชุจุงุฑ ููุฑูุง ุจุนุฏ ููุฏ C ุงูููุถุญ ุ ูุงูุฐู ูุงููุง ุจุชุญุณููู (ูู ุจูููู ููุช ูุฑุฉ ุฃุฎุฑู ุจุนูู ูุทุน ูุงููุฉ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุชู ุชุจุฏูููุง ุจูุงุณุทุฉ ุชูุฌูู ุงููุนุงูุฌ ุงููุณุจู) ุฃู ุฃู ุดูุก ูุนุชูุฏ ุนูู ุงููุธุงู ุงูุฃุณุงุณู ุ ูุจุฏูู ุฐูู ุ ูู ุงูุญุงูุงุช ุงููุตูู ุ ูููููู (ุนูู ุงูุฃุฑุฌุญ) ุชูุนู (ูุซู ุชุดุบูู / ุฅููุงู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุ ูุทุฑุญ CPUID ุ ููุง ุฅูู ุฐูู).  ุฃุฎูุฑูุง ุ ูุงูุช ููุงู ุจุนุถ ุงูุฃุดูุงุก ูุซู ุงุณุชุฏุนุงุก <code>rdtsc</code> ุ ูุฃูุง <code>rdtsc</code> ุ ุฏูู ุฃู ูุดุงูู ูุจูุฑุฉ ูุถุนุช ูู ุฑุฃุณ ูุนุชูุฏ ุนูู ุงููุธุงู ุงูุฃุณุงุณู <code>rdtsc</code> ููููุง ูููุซุงุฆู ุงูููุฌูุฏุฉ ุนูู RISC-V. </p><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ุญุตููุง ุนูู ุฏููู <code>arch/i386</code> ุ ุญูุซ ุชู ููู ูุฏุฑ ูุจูุฑ ูู ุฑูุฒ ุฏุนู PCI ุ ููุฑุงุกุฉ ุงููุนูููุงุช ูู ุงูุดุฑุงุฆุญ ุ ูุชุนุฑููุงุช ุฎุงุตุฉ ุจุงููุธุงู ุงูุฃุณุงุณู ููุนูุงููู ุงููุนููุฉ ุจุงูุฐุงูุฑุฉ ุ ุฅูุฎ.  ุฃูุถูุง ุ <code>test_start</code> ุจุฏุงูุฉ ุฏุงูุฉ <code>test_start</code> ุ ููู ููุทุฉ ุงูุฏุฎูู ูู <code>setup.S</code> ุฅูู ุงูููุฏ C. ูู ูู ุงูููุช ุ ูุตูุฑ ุ ูููู ูุน ุงูุชุนููู ุนูู ูู ูุง ูู ูููู ูุชุญููู ูู ุดูุก ูุง ูููู ุงูุชุนููู ุนููู ุถูู RISC-V (ูุซู <code>setup.S</code> ูุฑูุฒ ุงูุนูู ูุน ุงููููุฐ ุงูุชุณูุณูู ูู ุชูููุฐ SiFive) ุ ุญุตูุช ุนูู ุฏููู <code>arch/riscv</code> ุ ูุงูุฐู ุชู ุชุฌููุน ูู ุดูุก ุจู ุจุดูู ุฃู ุจุขุฎุฑ. </p><br><p style=";text-align:right;direction:rtl">  ุฃูุง ูุถุทุฑ ููุง ูุชูุถูุญ ุฃู ุงูุชุฌุงุฑุจ ููุณูุง ูุฏ ุฃุฌุฑูุช ุฌุฒุฆููุง ูุจู ูุชุงุจุฉ ุงูููุงู ุ ูุฐูู ูุฏ ูุญุชูู <em>ุชุณูุณู</em> ูุญุฏุฏ <em>ูู</em> ุงูุฅุฌุฑุงุกุงุช ุนูู ูุฏุฑ ูุนูู ูู "ุงูุฎูุงู ุงูููู".  ููุน ุฐูู ุ ุฃุญุงูู ุนูู ุงูุฃูู ุฅุฌุฑุงุก ุงูุนุฑุถ ุงูุชูุฏููู ุจุทุฑููุฉ ุชูุซู ุนูู ุฃู ุญุงู ุฃุญุฏ ุงููุณุงุฑุงุช ุงูููููุฉ <em>(ุฃูุง ูุจุฑูุฌ ุ ุฃุชุฐูุฑ ุฐูู)</em> .  ูุฐูู ุฏุนููุง ูุฑู ููููุฉ ุจุฏุก ูู ุดูุก. </p><br><h2 id="zapusk-na-zheleze" style=";text-align:right;direction:rtl">  ูุนูู ุนูู ุงูุญุฏูุฏ </h2><br><p style=";text-align:right;direction:rtl">  ููุฐ ุงูุชุฌุงุฑุจ ุงูุณุงุจูุฉ ุ ูุง ูุฒุงู ูุฏู "ุญุงูู" ูุชุฑุจ ูู Raspberry Pi ุ ุชู ุชูุตููู ุจููุญุฉ ุงูุชุตุญูุญ.  ุชููุฑ ุงูุฃุณูุงู UART ู JTAG ููุญูููุง ูุน ุจุทุงูุฉ SD.  ูุชู ูุฎูุท ูุนุงูุฌ RV64 ูุนูู ูุน ูุญุฏุฉ ุชุญูู DDR2 ูู ุฐุงูุฑุฉ ุงูุชูููู.  ููุง ูู ุงููุฑุงุช ุงูุณุงุจูุฉ ุ ุฃููู ุจุชุดุบูู "ุงูุชูุช" ุ ููุชุญ ุฌูุณุชูู SSH ูุจูู ุ ูุงุญุฏุฉ ูููุง ุชุนูุฏ ุชูุฌูู ูููุฐ TCP 3333 ูุชูุตูู gdb ุฅูู OpenOCD.  ูู ุฅุญุฏู ุงูุฌูุณุงุช ุ ุฃุจุฏุฃ minicom ููุดุงูุฏุฉ UART ุ ูู ุฌูุณุฉ ุฃุฎุฑู - openocd ูุชุตุญูุญ ุงูุฃุฎุทุงุก ูู ุงููุถูู ุนุจุฑ JTAG.  ุฃููู ุจุชุดุบูู ููุญุฉ - ูุงูุฑุณุงุฆู ูู ูุญุฏุฉ ุงูุชุญูู ุญูู ููููุฉ ุชุญููู ุงูุจูุงูุงุช ูู SD ุงููุฏู. </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ููููู ุชุดุบูู ุงูุฃูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:3333' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \ -ex 'add-symbol-file /path/to/memtest_shared 0x80010000' -ex 'set $pc=0x80010000'</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>-ex</code> ุฎูุงุฑุงุช <code>-ex</code> ุจุงูุชุธุงูุฑ ุจุฃู ุงููุณุชุฎุฏู ูุฏ ุฃุฏุฎู ูุฐู ุงูุฃูุงูุฑ ูู ูุญุฏุฉ ุงูุชุญูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุฃูู ุชุฃุณูุณ ุงุชุตุงู ูุน OpenOCD </li><li style=";text-align:right;direction:rtl">  ุงูุซุงูู ุจูุณุฎ ูุญุชููุงุช ููู ุงููุถูู ุงููุญุฏุฏ ุฅูู ุงูุนููุงู ุงููุญุฏุฏ </li><li style=";text-align:right;direction:rtl">  ููุถุญ ุงูุฌุฒุก ุงูุซุงูุซ ูู gdb ุฃู ุงููุนูููุงุช ุญูู ุงูููุฏ ุงููุตุฏุฑู ูุฌุจ ุฃู ุชุคุฎุฐ ูู <em>ูุฐุง</em> ุงูููู ุ ูุน ุงูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุญูููุฉ ุฃูู ุชู ุชูุฒููู ุนูู <em>ูุฐุง</em> ุงูุนููุงู (ูููุณ ูุง ูู ูุจูู ูู ููุณู) <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุงุญุธุฉ: ูุฃุฎุฐ ุงูุฃุญุฑู ูู ููู ELF ุ ููุญููู ุงูุซูุงุฆู "ุงูุฎุงู" </li></ul></li><li style=";text-align:right;direction:rtl">  ุฃุฎูุฑูุง ุ ูููู ุงูุฑุงุจุน ุจุชุฑุฌูุฉ ูุคุดุฑ ุงูุฃูุฑ ุงูุญุงูู ุฅูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจูุง </li></ul><br><p style=";text-align:right;direction:rtl">  ูุณูุก ุงูุญุธ ุ ูุง ูุณูุฑ ูู ุดูุก ุจุณูุงุณุฉ ุชูุงููุง ุ ูุนูู ุงูุฑุบู ูู ุนุฑุถ ุฃุณุทุฑ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู ุงููุตุญุญ ุจุดูู ุตุญูุญ ุ ูููู ูู ุฌููุน ุงููุชุบูุฑุงุช ุงูุนุงูุฉ - ุงูุฃุตูุงุฑ.  ูู ุงููุงูุน ุ ุฅุฐุง ูููุง ุจุชูููุฐ ุฃูุฑ ูู ุงููููุฐุฌ <code>p &amp;global_var</code> ูู <code>p &amp;global_var</code> ุ ูุฅููุง ุ ููุฃุณู ุ ูุฑู ุงูุนููุงู ููููุง ูุนููุงู ุงูุชูุฒูู ุงูุฃููู (ูุฏู <code>0x0</code> ) ุ ูุงูุฐู ูู ูุชู ุชุญุฏูุฏู ุจุงุณุชุฎุฏุงู <code>add-symbol-file</code> .  ูุนุงุฏ ุ ูููู ุญู ุจุณูุท ููุบุงูุฉ ุ ููุฏ ุฃุถูุช <code>0x80010000</code> ุจุจุณุงุทุฉ ุฅูู ุงูุนููุงู ุงููุญุฏุฏ ูุฏููุง ููุธุฑุช ุฅูู ูุญุชููุงุช ุงูุฐุงูุฑุฉ ูู ุฎูุงู <code>x/x 0xADDR</code> .  ูู ุงููุงูุน ุ ุณูููู ูู ุงููููู ุงูุฅุดุงุฑุฉ ูุคูุชูุง ุฅูู ุนููุงู ุงูุจุฏุก ุงูุตุญูุญ ูู ุงูุจุฑูุงูุฌ ุงููุตู ููุฑุงุจุท ุ ูุงูุฐู ุณูุชุฒุงูู <em>ูู ุงูููุช ุงูุญุงูู</em> ูุน ุนููุงู ุงูุชูุฒูู ูู <em>ุชูููู ุงูุงุฎุชุจุงุฑ ูุฐุง</em> . </p><br><h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah" style=";text-align:right;direction:rtl">  ููุฒุงุช ุงูููู ุนูู ุงููุจุงูู ุงูุญุฏูุซุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ููููุฉ ุชูุฒูู ุงูููุฏ ุจุทุฑููุฉ ุฃู ุจุฃุฎุฑู ุงูุชุดููุงู - ุจุฏุฃูุง ุชุดุบููู.  ูุง ูุนูู  ููุธูุฑ ุชุตุญูุญ ุงูุฃุฎุทุงุก ุฎุทูุฉ ุจุฎุทูุฉ ุฃููุง ููุน ุฃุซูุงุก ุชุดุบูู ูุธููุฉ <code>switch_to_main_stack</code> - ูุจุฏู ุฃูู ูุง ูุฒุงู ูุญุงูู ุงุณุชุฎุฏุงู ุงููููุฉ ุบูุฑ ุงูููุตูุฉ ูุนููุงู ุงูุฑูุฒ ุงููุทุงุจู ูููุฏุณ ุงูุนูู. </p><br><p style=";text-align:right;direction:rtl">  ููุน ุฐูู ุ ูุฅู ุงููุฌูุฏ ุงูุฃูู ูู ุงููุซุงุฆู ูุฎุจุฑูุง ุจุงูุชุนูููุงุช ุงูุฒุงุฆูุฉ ุงููุฎุชููุฉ ูุนูููู ูุน PIC ุฏุงุฎู ูุฎุงุฑุฌ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="ุจุนุถ ุชุนูููุงุช RISC-V ุงูุฒุงุฆูุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ุงููุจุฏุฃ ุงูุนุงู ูู ุฃู ุงูุนูุงููู ูู ุงูุฐุงูุฑุฉ ุชุญุณุจ ูู ุงูุชุนูููุงุช ุงูุญุงููุฉ ุ ูุน ุฅุถุงูุฉ ุงูุฃูู ุฃุนูู ุงูุฅุฒุงุญุฉ ุ <code>add</code> ุงูุชุงููุฉ ุชูููุน ุงูุจุชุงุช ููุฎูุถุฉ ุงูุชุฑุชูุจ.  ุจุงููุงุฏ ูุณุงุนุฏ ุนูู ุฅุนูุงู ูุชุบูุฑ ุนุงููู ูุซู </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vars</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ูุญู ูุฃุฎุฐ ูุซุงุฆู RISC-V ELF psABI ูุน <a href="" rel="nofollow">ูุตู ูุฃููุงุน ุนูููุงุช ุงูุชุฑุญูู</a> <code>reloc.c</code> ุงูุฌุฒุก ุงูุฎุงุต <code>reloc.c</code> ุงูุฃุณุงุณู ูู ุฃุฌู <code>reloc.c</code> .  ููุง ุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ุงูููู ุงูุฃุตูู ุ ุนูู ูุง ูุจุฏู ุ ูุฏ ุฃุฎุฐ ูู ููุฏ ุงููุธุงู ุงูุฃุณุงุณู ุงููุดุชุฑู.  ููุงู ุ ุญุชู ุจุฏูุงู ูู ุชุญุฏูุฏ ุนูู ุจุช ูุนูู ุ ูุชู ุงุณุชุฎุฏุงู ูุญุฏุงุช ูุงูุฑู ูู ููุน <code>ElfW(Addr)</code> ุ <code>Elf32_Addr</code> ูู <code>Elf32_Addr</code> ุฃู <code>Elf64_Addr</code> .  ููุน ุฐูู ุ ููุณ ูู ูู ููุงู ุ ููุฐุง ูู ุงูุณุจุจ ูู ุฃููุง <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> ุญูุซ ุฃููู ููุณูุง ูู ุงูููุฏ ุงูุนุงู (ููุฐูู ูู <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> - ุจุนุฏ ูู ุดูุก ุ ุจุงููุณุจุฉ ุฅูู RISC-V ุ ูุง ููุฌุฏ ุฃู ูุนูู ุฎุงุต <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> ุจุนูู ุจุช ูุญุฏุฏ ุ ุญูุซ ูุง ููุฌุฏ ูุทููุจ). </p><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ุจุฏุฃ <code>switch_to_main_stack</code> ุจุงููุฑูุฑ (ูููุณ ุจุฏูู ุฅุฑุดุงุฏุงุช ุงููุฌููุน ุงูุชู ุชุนุชูุฏ ุนูู ุงููุธุงู ุงูุฃุณุงุณู ุ ุจุงูุทุจุน).  ูุธูุฑ ุงููุตุญุญ ุงููุชุบูุฑุงุช ุงูุนููููุฉ ูุง ูุฒุงู crookedly.  ุญุณูุง ุ ุญุณูุง :( </p><br><h2 id="opredelenie-oborudovaniya" style=";text-align:right;direction:rtl">  ุชุนุฑูู ุงูุฃุฌูุฒุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุจุงูุทุจุน ุ ุจุงููุณุจุฉ ููุงุฎุชุจุงุฑุงุช ุ ุณูููู ูู ุงููููู ุงุณุชุฎุฏุงู ุงูุซูุงุจุช ุงูุซุงุจุชุฉ ุงูุชุฑููุฒ ุจุฏูุงู ูู ููุฏ ุชุนุฑูู ุงููุนุฏุงุช ุงูุฐู ุชู ุทุฑุญู ุ ููู ุจุงููุณุจุฉ ููู ูุฌููุนุฉ ูุญุฏุฏุฉ ูู ุงููุนุงูุฌุงุช ุ ูุฅู ุฅุนุงุฏุฉ ุจูุงุก memtest ููููุฉ ููุบุงูุฉ ููููุง ููุนุงููุฑ ุทูุจู.  ูุฐูู ุ ุณูู ูุชุตุฑู "ูุจุงูุบูู ุฌุงุฏูู".  ูุญุณู ุงูุญุธ ุ ุนูู RISC-V (ูุฑุจูุง ูู ูุนุธู ุงูุจููุงุช ุงูุญุฏูุซุฉ) ุ ูู ุงููุนุชุงุฏ ุฃู ูููู ูุญูู ุงูุฅููุงุน ุจุชูุฑูุฑ ุฑูุฒ ุฅูู <a href="https://en.wikipedia.org/wiki/Device_tree" rel="nofollow">Device Tree Blob</a> ุ ููู ุฅุตุฏุงุฑ ูุชุฑุฌู ูู ูุตู DTS ูุซู ูุฐุง: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">zeowaa-1gb.dts</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/dts-v1/; / { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-dev"; model = "freechips,rocketchip-unknown"; chosen { bootargs = "console=ttySIF0,125200 debug loglevel=7"; }; firmware { sifive,uboot = "YYYY-MM-DD"; }; L16: aliases { serial0 = &amp;L8; }; L15: cpus { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; timebase-frequency = ^_^lt๓ดgt^_^; L5: cpu@0 { device_type = "cpu"; clock-frequency = ^_^lt&amp;#0;gt^_^; compatible = "sifive,rocket0", "riscv"; d-cache-block-size = ^_^lt gt^_^; d-cache-sets = ^_^lt@gt^_^; d-cache-size = ^_^ltแgt^_^; d-tlb-sets = ^_^lt gt^_^; d-tlb-size = ^_^lt gt^_^; i-cache-block-size = ^_^lt gt^_^; i-cache-sets = ^_^lt@gt^_^; i-cache-size = ^_^ltแgt^_^; i-tlb-sets = ^_^lt gt^_^; i-tlb-size = ^_^lt gt^_^; mmu-type = "riscv,sv39"; next-level-cache = &lt;&amp;L10&gt;; reg = &lt;0x0&gt;; riscv,isa = "rv64imafdc"; status = "okay"; timebase-frequency = ^_^lt๓ดgt^_^; tlb-split; L3: interrupt-controller { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,cpu-intc"; interrupt-controller; }; }; }; L10: ram@80000000 { device_type = "memory"; reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;; reg-names = "mem"; }; L14: soc { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-soc", "simple-bus"; ranges; L1: clint@2000000 { compatible = "riscv,clint0"; interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;; reg = &lt;0x2000000 0x10000&gt;; reg-names = "control"; }; L2: debug-controller@0 { compatible = "sifive,debug-013", "riscv,debug-013"; interrupts-extended = &lt;&amp;L3 65535&gt;; reg = &lt;0x0 0x1000&gt;; reg-names = "control"; }; L9: gpio@64002000 { #gpio-cells = ^_^lt gt^_^; #interrupt-cells = ^_^lt gt^_^; compatible = "sifive,gpio0"; gpio-controller; interrupt-controller; interrupt-parent = &lt;&amp;L0&gt;; interrupts = &lt;3 4 5 6 7 8&gt;; reg = &lt;0x64002000 0x1000&gt;; reg-names = "control"; }; L0: interrupt-controller@c000000 { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,plic0"; interrupt-controller; interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;; reg = &lt;0xc000000 0x4000000&gt;; reg-names = "control"; riscv,max-priority = ^_^lt gt^_^; riscv,ndev = ^_^lt gt^_^; }; L6: rom@10000 { compatible = "sifive,maskrom0"; reg = &lt;0x10000 0x2000&gt;; reg-names = "mem"; }; L8: serial@64000000 { compatible = "sifive,uart0"; interrupt-parent = &lt;&amp;L0&gt;; clocks = &lt;&amp;tlclk&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64000000 0x1000&gt;; reg-names = "control"; }; L7: spi@64001000 { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; compatible = "sifive,spi0"; interrupt-parent = &lt;&amp;L0&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64001000 0x1000&gt;; clocks = &lt;&amp;tlclk&gt;; reg-names = "control"; L12: mmc@0 { compatible = "mmc-spi-slot"; disable-wp; reg = &lt;0x0&gt;; spi-max-frequency = ^_^lt gt^_^; voltage-ranges = &lt;3300 3300&gt;; }; }; tlclk: tlclk { #clock-cells = ^_^lt&amp;#0;gt^_^; clock-frequency = ^_^lt gt^_^; clock-output-names = "tlclk"; compatible = "fixed-clock"; }; }; };</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงุนุชุฏุช ุนูู ุชุญููู ูููุงุช ELF ุ ููููู ุงูุขู ููุชูุน ูุฑุฉ ุฃุฎุฑู ุจุดุฌุฑุฉ ุงูุฌูุงุฒ ุงููุณุทุญุฉ (FDT): <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">ุชุชู</a> ูุชุงุจุฉ ูุฐู <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">ุงูููุงุตูุงุช</a> ุงููุฑููุฉ ุจูุงุณุทุฉ <em>ุฃุดุฎุงุต ููุชููู ุฌูุฏูุง</em> <del>  (ูุง ูุฒุงู ุ ูู ุฃููุณูู ุซู ุชุญููู ุฐูู!) </del>  ูุชุญููู ูุฐู ุงููููุงุช (ุนูู ุงูุฃูู ุญุชู ุชุญุชุงุฌ ุฅูู ูุนุงูุฌุฉ ูุฏุฎูุงุช ุบูุฑ ููุซูู ุจูุง) ูุง ููุซู ุฃู ูุดุงูู ุฎุงุตุฉ.  ููุง: ูู ุจุฏุงูุฉ ุงูููู ุ ุชูุฌุฏ ุจููุฉ ุฑุฃุณ ุจุณูุทุฉ ุชุญุชูู ุนูู ุฑูู ุณุญุฑู <code>0xd00dfeed</code> ูุนุฏุฏ ูููู ูู ุงูุญููู.  ูุญู ููุชููู ุจุฅุฒุงุญุฉ "ุงูุดุฌุฑุฉ ุงููุณุทุญุฉ" <code>off_dt_struct</code> ูุฌุฏูู ุงูุตููู <code>off_dt_strings</code> .  ูู ุงููุงูุน ุ ุชุญุชุงุฌ ุฃูุถูุง ุฅูู ูุนุงูุฌุฉ <code>off_mem_rsvmap</code> ุ ูุงูุฐู ูุนุฏุฏ ููุงุทู ุงูุฐุงูุฑุฉ ุงูุชู ูุฌุจ ุชุฌูุจูุง.  ูุง ุฒูุช ุฃุชุฌุงูููู (ููุณูุง ุนูู ููุญุชู) ุ ููู <strong>ูุง ุชูุฑุฑ ูุฐุง ูู ุงูููุฒู</strong> . </p><br><p style=";text-align:right;direction:rtl">  ูู ุญูุซ ุงููุจุฏุฃ ุ ุงููุนุงูุฌุฉ ููุณุช ุตุนุจุฉ ุจุดูู ุฎุงุต: ุชุญุชุงุฌ ููุท ุฅูู ุงููุดู ุนูู ุดุฌุฑุฉ ูุณุทุญุฉ ููููุง ููุฑููุฒ.  <em>ููุงู</em> ุซูุงุซุฉ ุฑููุฒ <em>ุฑุฆูุณูุฉ</em> : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>FDT_BEGIN_NODE</code> - ูู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ ุงูุชุงููุฉ ูุจุงุดุฑุฉ ุ ูุฃุชู ุงุณู ุนูุตุฑ ุงูุดุฌุฑุฉ ุงููุฑุนูุฉ ูู ุดูู ุณูุณูุฉ ููุชููุฉ ุจูููุฉ ุฎุงููุฉ.  ููุท ุฃุถู ุงูุงุณู ุฅูู ุงูููุฏุณ </li><li style=";text-align:right;direction:rtl">  <code>FDT_END_NODE</code> - ุงูุดุฌุฑุฉ ุงููุฑุนูุฉ ูุฏ ุงูุชูุช ุ ูุฅุฒุงูุฉ ุงูุนูุตุฑ ูู ุงูููุฏุณ </li><li style=";text-align:right;direction:rtl">  <code>FDT_PROP</code> - ููุง ุฃุตุนุจ ููููุงู: ูุชุจุนู ูููู ุ ูุชุจูุนูุง ุจุงูุช ุจุงูุช ูู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ.  ูููู ุงุณู "ุงููุชุบูุฑ" ูู ุงุณู ุงูุฅุฒุงุญุฉ ูู ุฌุฏูู ุงูุณูุณูุฉ <br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> nameoff; }</code> </pre> </li></ul><br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ุจุดูู ุนุงู ุ ูุฐุง ูู ุดูุก: ูุฐูุจ ุฅูู ูุฐุง ุงููุณู ุ ุฏูู ุฃู ููุณู ููุงุญุธุฉ ุงููุญุงุฐุงุฉ ุจููุฏุงุฑ 4 ุจุงูุช.  ุฃูู ูุนู ุ ุฐุจุงุจุฉ ูู ุงููุฑูู: ุงูุฃุฑูุงู ูู FDT ุชููู ุจุชูุณูู endian ุงููุจูุฑ ุ ูุฐูู ูููู ุจุนูู ุจุณูุท </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ูู <code>riscv_entry</code> ุฃูู ุดูุก ูุฌุจ ูุนูู ูู ุชุญููู FDT ุ <code>head.S</code> ุฃู ุฌุฒุก <code>head.S</code> ุงููุณุคูู ุนู ููู ุงูุชุญูู ุฅูู <code>riscv_entry</code> ูุดุจู ูุฐุง </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> .globl startup_32 #  --    ... startup_32: lla sp, boot_stack_top mv s0, a0 # s0, s1 -- callee-saved mv s1, a1 # ...  .bss #   jal _dl_start #      mv a0, s0 mv a1, s1 j riscv_entry</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงูุณุฌู <code>a0</code> ุญุตููุง ุนูู ูุนุฑูู hart (hart ูุดุจู ุฏูู ุงูุฃุฌูุฒุฉ ูู ูุตุทูุญุงุช RISC-V) - ุฃูุง ูุง ุฃุณุชุฎุฏูู ุจุนุฏ ุ ูุณูุชุนูู ุนูู ูุนุฑูุฉ ุฐูู ูู ุญุงูุฉ ููุฑุฏุฉ ุงูุชุฑุงุจุท.  ูู <code>a1</code> ูุถุน ุฃุฏุงุฉ ุชุญููู ุงูุชุดุบูู ูุคุดุฑูุง ุฅูู FDT.  <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> ุฅูู ุงูุฏุงูุฉ <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> . </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ุ ูุน ุธููุฑ FDT parsilka ูู ุงูููุฏ ุ ุฃุตุจุญ ุชุณูุณู ุชุญููู ุงูููุญุฉ ููุง ููู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุฏูุฑู ุนูู ุงูุณูุทุฉ </li><li style=";text-align:right;direction:rtl">  ุงูุชุธุฑ ูุญุฏุฉ ุงูุชุดุบูู U- ุงูุชูููุฏ </li><li style=";text-align:right;direction:rtl">  ุฃุฏุฎู ุงูุฃูุงูุฑ ููู ูุฅุนุฏุงุฏ FDT ุงูุตุญูุญ.  ุนูู ูุฌู ุงูุฎุตูุต ุ ุชุฎุฒู ุตุญููุฉ <code>/chosen/bootargs</code> command <code>/chosen/bootargs</code> ุณุทุฑ ุฃูุงูุฑ kernel.  ูู ุดูุก ุฃุฎุฐู ูู FDT - ูุทุงู RAM ุ ุนููุงู UART ุ ... - ูููู ููุฌุจ ุชุฑูู ููุง ูู <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">run fdtsetup fdt set /chosen bootargs "console=ttyS0 btrace"</code> </pre> </li><li style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ <code>fdt addr</code> ุ ุงูุชุดู ุนููุงู ุชูุฒูู FDT ุ ุฅุฐุง ูู ุชูุธุฑ </li></ul><br><p style=";text-align:right;direction:rtl">  ููู ุฌุงูุจ gdb ุ ุชุชู ุฅุถุงูุฉ ุงูุฃูุฑ </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>-ex 'set $a1=0xfdtaddr'</code> </li> </ul><br><h2 id="vyvod-informacii-na-ekran" style=";text-align:right;direction:rtl">  ุฅุฎุฑุงุฌ ุงููุนูููุงุช ุฅูู ุงูุดุงุดุฉ </h2><br><p style=";text-align:right;direction:rtl">  ููุง ุงุชุถุญ ุ ุจุงูุฅุถุงูุฉ ุฅูู ุฅุฏุฑุงุฌ ุงููุฌููุน ุ ููุงู ุฃูุถูุง ุนูุงููู ุฐุงูุฑุฉ ูุนุฑููุฉ.  ุนูู ุณุจูู ุงููุซุงู <code>SCREEN_ADR</code> (ุชูุงููุง ูุซู ุฐูู ุ ูุน <code>D</code> ูุงุญุฏ) ุ ูุงูุฐู ูุดูุฑ ุฅูู ุงูููุทูุฉ ุงูููุงุจูุฉ ููุง ูุชู ุนุฑุถู ุนูู ุงูุดุงุดุฉ.  ุนูุฏูุง ุตุงุฏูุช ูุฐุง ุ ูุถุนุช ุจุจุณุงุทุฉ ูุน ููุชุฉ ูุงุณุนุฉ ูู ูุง ูุดูุฑ ุฅูููุง ุชุญุช <code>#if HAS_SCREEN</code> ุ ุซู ููุชุฑุฉ ุทูููุฉ ุชุตุญูุญ ุนููุงุก.  ููุฏ ููุฑุช ุจุงููุนู ูุฏูููุง ูุฑุฉ ูุงุญุฏุฉ ูู ุจุนุถ ุงูููุช ูู ุชูุฑูุบ ูุฐุง ุงููู ุฅูู ูุญุฏุฉ ุงูุชุญูู ุ ููู ุจุนุฏ ุฐูู ูุงุญุธุช ุฃู ููุณ ุงูุฑูุฒ ุงููุคูู ูุฎุฑุฌ ุงูุนุฏูุฏ ูู ุชุณูุณู ุงููุฑูุจ ุฅูู ุงููููุฐ ุงูุชุณูุณูู.  ุงุชุถุญ ุฃู ูู ุดูุก ูุฏ ูุชุจ ุจุงููุนู ุฃูุงููุง ุ ูุง ุนููู ุณูู ูุถุน ุงูุชุนุฑููุงุช ุจุฏูุฉ ุฃูุจุฑ - ูููุง ุ ุงููุงุฌูุฉ ุงููุฃูููุฉ (ูุฅู ูุงูุช ุจุงูุฃุจูุถ ูุงูุฃุณูุฏ) ูู ูุงูุฐุฉ minicom!  (ูู ุงูููุช ุงูุญุงูู ุ ูุง ูุชู ุงุณุชุฎุฏุงู HAS_SCREEN ุนูู ุงูุฅุทูุงู - ููุฏ ุจุฏุฃุช ููุชู ูุฌููุนุฉ <code>dummy_con</code> ูุชุบููุฑ ุงูุฑูุฒ ุงูุฃุตูู ูุญุฏ ุฃุฏูู.) </p><br><h2 id="otladka-na-qemu" style=";text-align:right;direction:rtl">  ุชุตุญูุญ ุงูุฃุฎุทุงุก ุนูู QEMU </h2><br><p style=";text-align:right;direction:rtl">  ูุฐูู ููุช ุจุชุตุญูุญ ูู ุดูุก ุนูู ููุญุฉ ุญููููุฉ ุ ูููุฐ ุจุนุถ ุงูููุช ุงูุขู - ููุง ุญุชู ุนููุงุก.  ูููู ูู ุดูุก ูุจุทุฆ ุนูู JTAG - ุงูุฑุนุจ!  ุญุณููุง ุ ูู ุงูููุงูุฉ ุ ูุฌุจ ุฃู ูุนูู ูู ุดูุก ุนูู ุฃุฌูุฒุฉ ุญููููุฉ ุ ูููู ุณูููู ูู ุงูุฌูุฏ ุชุตุญูุญ ุงูุฃุฎุทุงุก ุนูู QEMU.  ุจุนุฏ ุนุฏุฏ ูุนูู ูู ุงูุชุฌุงุฑุจ ุ ุชุจูู ุฃู ุดูุฆูุง ูุง ุบุฑูุจูุง ุ ููููู ูุดุงุจู ุฌุฏูุง ููุนูู ูุน ููุญุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ qemu-system-riscv64 -M help Supported machines are: none empty machine sifive_e RISC-V Board compatible with SiFive E SDK sifive_u RISC-V Board compatible with SiFive U SDK spike_v1.10 RISC-V Spike Board (Privileged ISA v1.10) (default) spike_v1.9.1 RISC-V Spike Board (Privileged ISA v1.9.1) virt RISC-V VirtIO Board (Privileged ISA v1.10)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญู ููุธุฑ ุฅูู ุฃู ูุฌุงูุณ QEMU ูุณุชุนุฏุฉ ููุญุงูุงุฉ.  ุฃูุง ููุชู <code>sifive_u</code> ูุชูุงููุฉ ูุน <code>sifive_u</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace   $ ls -l on -rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on $ dtc -I dtb &lt; on &gt; on.dts #   $ vim on.dts #  bootargs $ dtc &lt; on.dts &gt; on.dtb &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุขู ูุฏููุง blob ุดุฌุฑุฉ ุงูุฌูุงุฒ "ุซุงุจุช".  <strong>ุจุฏูู ุชุบููุฑ ุชูููู VM</strong> (ุนูุงุฒุงุช!) ุ ูู ุจุชุดุบูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">qemu-system-riscv64 \ -M sifive_u -m 1g \ -serial stdio \ -s -S</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>-serial stdio</code> ูุนูุฏ ุชูุฌูู ุงููููุฐ ุงูุชุณูุณูู ุฅูู ูุญุฏุฉ ุงูุชุญูู ุ ูุฃูู ุณูุชู ุงุณุชุฎุฏุงู ุชุณูุณู ุงููุฑูุจ ุจูุดุงุท.  ุชุฒูุฏ ุฎูุงุฑุงุช <code>-s -S</code> gdbserver ูุฅูุดุงุก VM ููุชููู ุ ุนูู ุงูุชูุงูู.  ููููู ุชูุฒูู ุงูููุฏ ุจุงุณุชุฎุฏุงู <code>loader</code> ุ ูููู ุนููู ุฅุนุงุฏุฉ ุชุดุบูู QEMU ูู ูู ูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ููููู ุงูุงุชุตุงู ุจุงุณุชุฎุฏุงู </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:1234' \ -ex 'restore /path/to/on.dtb binary 0x80100000' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \ -ex 'add-symbol-file memtest_shared 0x80100000' \ -ex 'set $a1=0x80020000' \ -ex 'set $pc=0x80100000'</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ูู ุดูุก ูุนูู ุฃูุซุฑ ูู ุจุฐูุงุก! </p><br><h2 id="obschiy-princip-raboty" style=";text-align:right;direction:rtl">  ุงููุจุฏุฃ ุงูุนุงู ููุนูู </h2><br><p style=";text-align:right;direction:rtl"> , ,  ,   Memtest86+   <code>btrace</code> ,        ,      (  ,     QEMU): </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="btrace mode"></p><br><p style=";text-align:right;direction:rtl">  ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  ยซยป   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   โ <code>mepc</code> (?),   โ <code>mtval</code> (    ?),    . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="Illegal instruction"></p><br><p style=";text-align:right;direction:rtl">   ,      : </p><br><p style=";text-align:right;direction:rtl"> <strong>head.S:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#       #   = 0 ---   ,   #  ,    ,     ... lla t1, _trap_entry csrw mtvec, t1 # ... _trap_entry: csrr a0, mcause csrr a1, mepc csrr a2, mtval jal riscv_trap_entry</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code> : </p><br><p style=";text-align:right;direction:rtl"> <strong>arch.c:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errors[] = { <span class="hljs-string"><span class="hljs-string">"Instruction address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Instruction access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Illegal instruction"</span></span>, <span class="hljs-string"><span class="hljs-string">"Breakpoint"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO access fault"</span></span>, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Instruction page fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load page fault"</span></span>, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Store/AMO page fault"</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">riscv_trap_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EXCP: "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cause &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, errors[cause]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { itoa(buf, cause); cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, buf); } cprint(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PC: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, epc, <span class="hljs-number"><span class="hljs-number">8</span></span>); cprint(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Addr: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, tval, <span class="hljs-number"><span class="hljs-number">8</span></span>); HALT(); }</code> </pre> <br><p style=";text-align:right;direction:rtl">        โ    ยซ ยป   .   ,   ยซยป    ,  ,      ,  . </p><br><p style=";text-align:right;direction:rtl">         :     .       ,  memtest  :    : ยซ       ,   ,    .        ยป.    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       โ    ยซยป ,    memtest.       ,    <code>run_at</code> ,    memtest  <code>_start</code>  <code>_end</code>    (   ยซยป  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      ยซยป    ,    ยซยป. </p><br><p style=";text-align:right;direction:rtl">      ,    <strong> </strong>  <code>bss</code>    โ    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code> . </p><br><p style=";text-align:right;direction:rtl">   ,  Memtest86+ โ ,         <code>barrier_s</code>    .       ,          . ,   ,       . </p><br><h2 id="podvodnye-kamni" style=";text-align:right;direction:rtl">   </h2><br><p style=";text-align:right;direction:rtl">    ,   :   .   :           .    <em></em> : ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://stackoverflow.com/questions/12491578/whats-the-actual-effect-of-successful-unaligned-accesses-on-x86" rel="nofollow"> </a> ,   load/store  x86   ,     โ .    ,    QEMU    ,  ยซ  ,      ยป. </p><br><p style=";text-align:right;direction:rtl"> ,     ,  <em>  </em> โ   unaligned access  .. </p><br><p style=";text-align:right;direction:rtl"> ,   ,     RocketChip,   โ QEMU,   ,  ,   RocketChip โ unaligned access trap,  QEMU  ยซ  ยป. <br>   ยซmisalignedยป            ,   </p><br><blockquote style=";text-align:right;direction:rtl"> Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated. </blockquote><p style=";text-align:right;direction:rtl">  , ,  โ   ,  user-mode code   ,             .     .   , ,   .   ,       โ -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped . </p><br><p style=";text-align:right;direction:rtl">    :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    โฆ ,     โ   : <code>head.S</code>       <code>initial_load_addr</code> ,    <code>riscv_entry</code>    <code>move_to_correct_addr</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_to_correct_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_start = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_start; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_end = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_end; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_start == low_test_addr || cur_start == high_test_adr) { <span class="hljs-comment"><span class="hljs-comment">//  ,     return; } if (cur_start == initial_load_addr &amp;&amp; (cur_start - low_test_addr) &lt; (cur_end - cur_start) ) { //   " ":   , //           //     ,    ,   //     ... serial_echo_print("FIRST STARTUP RELOCATION...\n"); void *temp_addr = (((uintptr_t)&amp;_end &gt;&gt; 12) + 1) &lt;&lt; 12; run_at(temp_addr, 0); } else { // ,    --- ,  . serial_echo_print("FINAL STARTUP RELOCATION...\n"); run_at(low_test_addr, 0); } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> ,     โ   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code> . </p><br><p style=";text-align:right;direction:rtl">     ,   ยซยป ,    -,   โ  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code> ),   32- x86   <code>uint32_t</code> ,    ยซ 64 ยป   <code>uint64_t</code> .       ยซ!!! Good: ffffffff Real: ffffffff Bad bits: 00000000ยป.   ?       - -1,  32    1.   ,         ,        0โฆ  ,     : ,  <code>ulong</code>      ( <code>uint32_t</code> ),          ( <code>uintptr_t</code> ). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    โ    UB. <del>     memtest  UBSan. </del>  ,  ,  UBSan   trap-on-error        JTAG. </p><br><h2 id="upakovyvaem-dlya-zagruzchika" style=";text-align:right;direction:rtl">    </h2><br><p style=";text-align:right;direction:rtl"> ,  memtest -  ,    ,          U-Boot. </p><br><p style=";text-align:right;direction:rtl">       :    <code>mkimage</code>   U-Boot   <em>  Linux</em> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \ -a 0x80000000 -e 0x80000000 \ -n memtest -d memtest.bin memtest.uboot</code> </pre> <br><p style=";text-align:right;direction:rtl">      SD-      </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code> </pre> <br><p style=";text-align:right;direction:rtl"> (   ,   <code>run</code>     โ        ). </p><br><p style=";text-align:right;direction:rtl">      :       FDT: <code>0xbffb7c80</code> . ,  :    <code>ffffffff</code> ,     .     ,         (     ),    :   HiFive_U-Boot      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> theKernel(machid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)images-&gt;ft_addr);</code> </pre> <br><p style=";text-align:right;direction:rtl">    ,     </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*theKernel)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arch, uint params);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,     , ,  ,  32        ,     <code>head.S</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> li t0, 0xffffffffL and a1, a1, t0</code> </pre> <br><h2 id="promezhutochnyy-itog" style=";text-align:right;direction:rtl">   </h2><br><p style=";text-align:right;direction:rtl"> ,  , - ,  ,     ,  : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">     x86.       โ       review         <strong>   </strong> </li><li style=";text-align:right;direction:rtl">   SMP   RISC-V </li><li style=";text-align:right;direction:rtl">        <code>arch/</code> -  </li><li style=";text-align:right;direction:rtl">     <code>test.c</code>  RISC-V (      <code>-O0</code> !) </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar484026/">https://habr.com/ru/post/ar484026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar484012/index.html">ุชุจุณูุท ุนูููุฉ ุงููุชุงุจุฉ ูู ุฏูุชุฑ ูุชูุฉ</a></li>
<li><a href="../ar484014/index.html">10 ูู ูุจุงุฑ ุงููุณุฆูููู ุงูุงูุชุตุงุฏููู ุงูุฎุฑุงูุงุช ูุชุฑู ูุฑุงุกูุง ูู ุนุงู 2020</a></li>
<li><a href="../ar484016/index.html">ุฃุณุงุณูุงุช ุงูุชุนูู ุงูุนููู ุนูู ุณุจูู ุงููุซุงู ูู ุงูุชุตุญูุญ ุงูุชููุงุฆู ุ ุงูุฌุฒุก ุฑูู 1</a></li>
<li><a href="../ar484018/index.html">ุงูุฌุงูุจ ุงูุชููู ูููุฎูุช</a></li>
<li><a href="../ar484020/index.html">ูู ุงูุฐู ุชุญุงูู ุฅููุงุนู ุจููุงุนูุฏู ุงูููุงุฆูุฉุ</a></li>
<li><a href="../ar484028/index.html">ุญุฏูุฉ ุจููุฏ - ูุฑุต ูุงุจู ููุชุญููู ูุน ุนุฑุถ ูุงุจูุฉ ููุทู</a></li>
<li><a href="../ar484034/index.html">ุชูููุฐ ุฎุทุฉ ุนูู ุงูุชุฎุฒูู ุงููุณุชูุฏู ููุจุถุงุฆุน ุนูู ุฃุณุงุณ ูุญุฏุฉ ูุญุงุณุจุฉ ุงููุณุชูุฏุนุงุช 1C ุงูุฃุชูุชุฉ ุงููุชูุงููุฉ 2</a></li>
<li><a href="../ar484036/index.html">ูุฌููุนุฉ ุตูุงุนุฉ ุฌุฏูุฏุฉ ุชุฎูู ูุนูุงุฑ ุนุงููู ููููุงุฒู ุงูุฐููุฉ</a></li>
<li><a href="../ar484046/index.html">ุงูุชุญูู ูู Emby ูุน PVS-Studio</a></li>
<li><a href="../ar484048/index.html">PHP ูุงูุชุนุจูุฑุงุช ุงูุนุงุฏูุฉ: ุฃุณุงุณูุงุช ูููุจุชุฏุฆูู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>