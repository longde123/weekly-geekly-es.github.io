<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ ๐๏ธ ุฃุณุงุณูุงุช ููุชูุณ ๐ค๐ป ๐๐พ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Futex (futex - ุงุฎุชุตุงุฑ ูู "Fast userpace mutex") ูู ุขููุฉ ุงูุชุฑุญูุง ูุทูุฑู Linux ูู IBM ูู 2002 ูุฏุฎูุช ุงูููุงุฉ ูู ููุงูุฉ 2003. ูุงูุช ุงูููุฑุฉ ุงูุฑุฆูุณูุฉ ูู ุชูููุฑ ุท...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุฃุณุงุณูุงุช ููุชูุณ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/418705/" style=";text-align:right;direction:rtl">  <b>Futex</b> (futex - ุงุฎุชุตุงุฑ ูู "Fast userpace mutex") ูู ุขููุฉ ุงูุชุฑุญูุง ูุทูุฑู Linux ูู IBM ูู 2002 ูุฏุฎูุช ุงูููุงุฉ ูู ููุงูุฉ 2003.  ูุงูุช ุงูููุฑุฉ ุงูุฑุฆูุณูุฉ ูู ุชูููุฑ ุทุฑููุฉ ุฃูุซุฑ ูุนุงููุฉ ููุฒุงููุฉ ุณูุงุณู ุฑุณุงุฆู ุงููุณุชุฎุฏู ูุน ุงูุญุฏ ุงูุฃุฏูู ูู ุงูููุงููุงุช ุฅูู ูุธุงู ุชุดุบูู kernel. <br><br>  ูู ูุฐู ุงูููุงูุฉ ุ ุณูุฑุงุฌุน ุงูุนููุฏ ุงูุขุฌูุฉ ุ ููุญุงูู ููู ูุจุงุฏุฆ ุนูููู ุ ููุณุชุฎุฏููุง ุฃูุถูุง ูุทูุจ ูุจูุงุก ูุงุฆูุงุช ูุฒุงููุฉ ุนุงููุฉ ุงููุณุชูู (ููุฃูููุฉ ููุง). <br><br>  ููุทุฉ ูููุฉ: Futexes ูู ุฃุฏุงุฉ ููุฎูุถุฉ ุงููุณุชูู ุฅูู ุญุฏ ูุง ุ ูุฌุฏุฑ ุงุณุชุฎุฏุงููุง ูุจุงุดุฑุฉ ููุท ุนูุฏ ุชุทููุฑ ุงูููุชุจุงุช ุงูุฃุณุงุณูุฉ ุ ูุซู ููุชุจุฉ C / C ++ ุงูููุงุณูุฉ.  ูู ุบูุฑ ุงููุญุชูู ุฌุฏูุง ุฃูู ุณุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู ุงูุนููุงุช ุงูุฃุฌูุจูุฉ ูู ุชุทุจูู ููุชุธู. <br><a name="habracut"></a><br><h3 style=";text-align:right;direction:rtl">  ุงูุฏุงูุน </h3><br>  ูุจู ุธููุฑ ุงูุนููุฏ ุงูุขุฌูุฉ ุ ูุงู ูู ุงูุถุฑูุฑู ุฅุฌุฑุงุก ููุงููุงุช ุงููุธุงู (ุจุงุณุชุฎุฏุงู ุ ุนูู ุณุจูู ุงููุซุงู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">semop</a> ) ูู ูู ูุฑุฉ ููุชุญูู ูู ุงููุตูู ุฅูู ุงูููุงุฑุฏ ุงููุดุชุฑูุฉ ูู ุนุฏุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุณูุงุณู ูุญุงุฏุซุงุช</a> ุ ูุงูุชู ุ ููุง ุชุนูู ุ ุชุณุชููู ููุงุฑุฏ ูุซูุฑุฉ ุ ุญูุซ ุชุชุทูุจ ูู ููุงููุฉ ุชุจุฏูู ุงูุณูุงู ูู ูุถุน ุงููุณุชุฎุฏู ุฅูู ูุถุน kernel.  ูุน ุฒูุงุฏุฉ ุนุฏุฏ ุงูููู ูู ุงููุนุงูุฌุงุช ุงูุญุฏูุซุฉ ูุฒูุงุฏุฉ ุนุฏุฏ ุงูุฎููุท ูู ุงูุจุฑุงูุฌ ุงูุชุทุจูููุฉ ุ ุฃุตุจุญ ูุฐุง ูุดููุฉ ูุจูุฑุฉ.  ุจู ุฅููุง ุฃูุซุฑ "ูุณูุฆุฉ" ุ ูุธุฑูุง ูุฃู ุฌููุน ูุฐู ุงูููุงููุงุช ูุง ุชุญูู ุฃู ูุธููุฉ ูุทุจูุฉ ุ ููุง ุชููุฐ ุฃู ููุทู ุชุฌุงุฑู ุ ูููููุง ุชุถูู ููุท ุงูุชุดุบูู ุงูุตุญูุญ ูุจููุฉ ุงูุดูุฑุฉ. <br><br>  ุงุณุชูุฏ ุงูุชุฑุงุญ ุฅุถุงูุฉ ููููู ุฌุฏูุฏ ูู "futex" ุฅูู ูุธุงู ุงูุชุดุบูู ุฅูู ููุงุญุธุฉ ุจุณูุทุฉ: ูู ูุนุธู ุงูุญุงูุงุช ุ ุชููู ูุญุงููุฉ ุงูุชูุงุท ูุงุฆู ุงูุชุฒุงูู ูุงุฌุญุฉ ูู ุงููุฑุฉ ุงูุฃููู.  ูููู ุงููุจุฑูุฌูู ุจูุชุงุจุฉ ุงูุจุฑุงูุฌ ุจุทุฑููุฉ ุชูุฑ ูู ุฃูู ููุช ูููู ูู ููู ุงูููู ุฅูู ูุชุญู ุ ููุง ูุนูู ุฃู ููุงู ูุฑุตูุง ูุจูุฑุฉ ุฌุฏูุง ูุฃู ูุญุงููุฉ ุงูุชูุงุท ุณูุณูุฉ ุฑุณุงุฆู ุฃุฎุฑู ูู ุชูุงุฌู ุนูุจุงุช.  ุนูุฏูุง ูุตู ุงูุฏูู ุฅูู ูุงุฆู ุงูุชุฒุงูู "ุงููุฌุงูู" ุ ูููููุง ุงูุชูุงุทู ุฏูู ุฅุฌุฑุงุก ููุงููุฉ ูุธุงู ุจุงุณุชุฎุฏุงู ุงูุนูููุงุช ุงูุฐุฑูุฉ ุงูุฑุฎูุตุฉ ูุณุจููุง.  ูููุงู ูุฑุตุฉ ูุจูุฑุฉ ุฌุฏุง ููุฌุงุญ ุงูุนูููุฉ ุงูุฐุฑูุฉ. <br><br>  ูู ูุฐู ุงูุญุงูุฉ ุงููุงุฏุฑุฉ ุ ุนูุฏูุง ูุง ูุฒุงู ูุญุงูู ุงููุตูู ุฅูู ููุฑุฏ ุชู ุญุธุฑู ุจูุงุณุทุฉ ูุคุดุฑ ุชุฑุงุจุท ุขุฎุฑ ุ ุณุชุนุฑุถ ุงูุนูููุฉ ุงูุฐุฑูุฉ ุฎุทุฃ.  ูู ูุฐู ุงูุญุงูุฉ ุ ูุฏููุง ุฎูุงุฑุงู.  ูููููุง ุฅูุง ุงูุฏูุฑุงู ูู ุจุนุถ ููู ูุถุน ุงููุณุชุฎุฏู ุ ุจุงูุชุธุงุฑ ุฅุตุฏุงุฑ ุงูููุฑุฏ (ุงูุฐู ุณูุฃูู ููุงุฑุฏ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ) ุ ุฃู ูุทูุจ ูู ุงูููุงุฉ ุฃู ุชุถุนูุง ูู ูุถุน ุงูุณููู ุ ุจุงูุชุธุงุฑ ุฅุตุฏุงุฑ ุงูููุฑุฏ.  ูุฐุง ูู ุงูููุงู ุงูุฐู ุชุฃุชู ููู ุงูุนููุงุช ุงูุฃุฌูุจูุฉ ุฅูู ุงููุดูุฏ. <br><br><h3 style=";text-align:right;direction:rtl">  ุงูุงุณุชุฎุฏุงู ุงูุจุณูุท ููููุชูุณ - ุงูุชููุน ูุงูุตุญูุฉ </h3><br>  ุชุฌูุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฏุนูุฉ ูุธุงู futex</a> ุจูู ูุฌููุนุฉ ูุชููุนุฉ ูู ุงููุธุงุฆู.  ูู ูููุฑ ูู ุงูุฎูุงุฑุงุช ุงููุนูุฏุฉ ููุง (ุจุนุถูุง ููุตู ููุบุงูุฉ ูุฏุฑุฌุฉ ุฃูู ูู ูุชู ูุตููุง ุญุชู ูู ุงููุซุงุฆู ุงูุฑุณููุฉ) ุ ููููุง ุณูุฑูุฒ ุนูู ุงูุนูููุงุช FUTEX_WAIT ู FUTEX_WAKE.  ุณูููู ุงููุตู ูู ุงููุซุงุฆู ุงูุฑุณููุฉ ุจูุซุงุจุฉ ูุงุนุฏุฉ ุฌูุฏุฉ: <br><blockquote style=";text-align:right;direction:rtl">  ูููุฑ ุงุณุชุฏุนุงุก ุงููุธุงู futex () ููุจุฑุงูุฌ ุทุฑููุฉ ููุงูุชุธุงุฑ ุญุชู ุชุชุญูู ุญุงูุฉ ูุนููุฉ.  ุนุงุฏุฉู ุ ุชุณุชุฎุฏู ุงุณุชุฏุนุงุก ุงููุธุงู ูุฐุง ุจููุฉ ุญุธุฑ ูู ุณูุงู ูุฒุงููุฉ ุงูุฐุงูุฑุฉ ุงููุดุชุฑูุฉ.  ุนูุฏ ุงุณุชุฎุฏุงู futexes ุ ูุชู ุชูููุฐ ุนูููุงุช ุงููุฒุงููุฉ ุงูุฑุฆูุณูุฉ ูู ูุณุงุญุฉ ุงููุณุชุฎุฏู.  ุชููู ุจุฑุงูุฌ ูุณุงุญุฉ ุงููุณุชุฎุฏู ุจุชูููุฐ ุงุณุชุฏุนุงุก ูุธุงู futex () ููุท ุนูุฏูุง ูููู ูู ุงูุถุฑูุฑู ุฃู ูุฏุฎู ุงูุจุฑูุงูุฌ ูู ูุถุน ุงูุงุณุชุนุฏุงุฏ ููุชุฑุฉ ุทูููุฉ ุญุชู ูุตุจุญ ุงูุดุฑุท ุตุญูุญูุง.  ุฃูุถูุง ุ ูููู ุงุณุชุฎุฏุงู futex () ูุฅููุงุธ ุงูุนูููุงุช ุฃู ุณูุงุณู ุงูุนูููุงุช ุงูุชู ุชุชููุน ุญุงูุฉ ูุนููุฉ. </blockquote>  ุจุจุณุงุทุฉ ุ ุฅู futex ุนุจุงุฑุฉ ุนู ุจููุฉ kernel ุชุณุงุนุฏ ููุฏ ุงููุณุชุฎุฏู ุนูู ูุฒุงููุฉ ุณูุงุณู ุงููุญุงุฏุซุงุช ุนูุฏ ุญุฏูุซ ุดูุก ูุง.  ูููู ูุจุนุถ ุงูุนูููุงุช (ุฃู ุณูุงุณู ุงูุนูููุงุช) ุงูุชุธุงุฑ ุงูุฃุญุฏุงุซ ูู ููุงููุฉ FUTEX_WAIT ุ ุจูููุง ูููู ููุขุฎุฑูู ุงุณุชุฏุนุงุก ูุฐู ุงูุฃุญุฏุงุซ ุจุงุณุชุฎุฏุงู FUTEX_WAKE.  ูุนูู ุงูุงูุชุธุงุฑ ุจููุงุกุฉ - ูุชู ุชุนููู ุณูุงุณู ุงูุงูุชุธุงุฑ ุจูุงุณุทุฉ ุงูููุงุฉ ููุง ุชุณุชุฎุฏู ููุงุฑุฏ ุงููุนุงูุฌ ุญุชู ูุชู ุฅููุงุธูุง ุนูุฏ ูููุน ุญุฏุซ ูุชููุน. <br><br>  ุฎุตุต ููุชูุง ููุฑุงุกุฉ ุงููุซุงุฆู ุจุงููุงูู.  ุญุณููุง ุ ุฃู ุนูู ุงูุฃูู ุงูุฑุฃ ุงูุฃูุณุงู ูู FUTEX_WAIT ู FUTEX_WAKE. <br><br>  ุฏุนููุง ูููู ูุธุฑุฉ ุนูู <a href="">ูุซุงู ุจุณูุท</a> ููุถุญ ุงูุงุณุชุฎุฏุงู ุงูุฃุณุงุณู ููุนููุงุช ุงูุฃุฌูุจูุฉ ูุชูุณูู ุนูู ุนูููุชูู. <br><br>  ุนูููุฉ ุงูุทูู: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุชุธุฑ 0xA ูู ูุชุญุฉ ุงูุฐุงูุฑุฉ ุงูุนุงูุฉ </li><li style=";text-align:right;direction:rtl">  ููุชุจ ุงููููุฉ 0xB ููุฐู ุงููุชุญุฉ </li></ol><br>  ุงูุนูููุฉ ุงูุฃู ูู ุงูููุช ุงูุญุงูู: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุชุจ ูููุฉ 0xA ุฅูู ูุชุญุฉ ุฐุงูุฑุฉ ูุดุชุฑูุฉ </li><li style=";text-align:right;direction:rtl">  ููุชุธุฑ ุธููุฑ 0xB ููู </li></ol><br>  ูุซู "ุงููุตุงูุญุฉ" ุจูู ุนูููุชูู.  ูุฐุง ูู ุงูุฑูุฒ: <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shm_id = shmget(IPC_PRIVATE, <span class="hljs-number"><span class="hljs-number">4096</span></span>, IPC_CREAT | <span class="hljs-number"><span class="hljs-number">0666</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shm_id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"shmget"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* shared_data = shmat(shm_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); *shared_data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> forkstatus = fork(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forkstatus &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"fork"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forkstatus == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   printf("child waiting for A\n"); wait_on_futex_value(shared_data, 0xA); printf("child writing B\n"); //  0xB         *shared_data = 0xB; wake_futex_blocking(shared_data); } else { //   printf("parent writing A\n"); //  0xA         *shared_data = 0xA; wake_futex_blocking(shared_data); printf("parent waiting for B\n"); wait_on_futex_value(shared_data, 0xB); // Wait for the child to terminate. wait(NULL); shmdt(shared_data); } return 0; }</span></span></code> </pre> <br>  ุงูุชุจู ุฅูู ููุงููุงุช POSIX ูุชุฎุตูุต ุงูุฐุงูุฑุฉ ุงููุดุชุฑูุฉ ุจูู ุงูุนูููุงุช.  ูู ูุชููู ูู ุงุณุชุฎุฏุงู ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุงููุนุชุงุฏ ููุง ุ ุญูุซ ุฃู ููุณ ุนููุงู ุงููุคุดุฑุงุช ูู ุงูุนูููุงุช ุงููุฎุชููุฉ ุณูุดูุฑ ุจุงููุนู ุฅูู ูุชู ุฐุงูุฑุฉ ูุฎุชููุฉ (ูุฑูุฏุฉ ููู ุนูููุฉ). <br><br>  ูุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ูุฐุง ุงููุซุงู ููุญุฑู ุฅูู ุญุฏ ูุง ุนู ุงูุดุฑุงุฆุน ุ ูุฃู ูููุชูุณ ุชู ุฅูุดุงุคู ูู ุงูุฃุตู ูุงูุชุธุงุฑ ุชุบููุฑ ูู ูุนูู ูุนูู "ูู ุดูุก ูุนูู ุฅูู ุฃู ุดูุก" ุ ูููุณ "ูู ุฃู ุดูุก ุฅูู ุดูุก ูุญุฏุฏ".  ุฃุนุทูุช ูุฐุง ุงููุซุงู ูุฅุซุจุงุช ูุซู ูุฐุง ุงูุงุญุชูุงู ุ ูุณููุธุฑ ุฃุฏูุงู ูู ุงููุณุฎุฉ ุงูุฃุณุงุณูุฉ (ูุทุจู ุนูููุง ูุงุฆู ุงููุฒุงููุฉ). <br><br>  ูุฅููู ุฑูุฒ ุฏุงูุฉ wait_on_futex_value: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_on_futex_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* futex_addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(futex_addr, FUTEX_WAIT, val, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errno != EAGAIN) { perror(<span class="hljs-string"><span class="hljs-string">"futex"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*futex_addr == val) { <span class="hljs-comment"><span class="hljs-comment">//    return; } } else { abort(); } } }</span></span></code> </pre> <br>  ุงููููุฉ ุงูุฑุฆูุณูุฉ ููุฐู ุงููุธููุฉ (ุฅูู ุฌุงูุจ ุ ูู ุงููุงูุน ุ ุงุณุชุฏุนุงุก ูุธุงู futex) ูู ุฏูุฑุฉ ูุชู ุชุดุบูููุง ุนูุฏูุง ูุณุชููุธ ูุงุฐุจุฉ (ุบูุฑ ููุชู ุจูุง).  ูููู ุฃู ูุญุฏุซ ูุฐุง ุนูุฏูุง ูุชู ุชุซุจูุช ูููุฉ ุฌุฏูุฏุฉ ุ ูููู ูุง ูุชููุนูุง ุ ูู ูุชุญุฉ ุงูุฐุงูุฑุฉ ุงููุดุชุฑูุฉ.  ุญุณููุง ุ ุฃู ูู ุญุงูุฉ ุงุณุชููุงุธ ุนูููุฉ ุฃุฎุฑู ูู ููุช ุฃุจูุฑ ูู ุนูููุชูุง (ูุง ูููู ุฃู ูุญุฏุซ ูุฐุง ูู ุญุงูุชูุง ุงูุฎุงุตุฉ ุ ูููู ุจุทุฑููุฉ ุฃูุซุฑ ุนููููุฉ ุ ูููู ุฐูู). <br><br>  ุฏูุงูุงุช Futex ูู ุฃุดูุงุก ุตุนุจุฉ ููุบุงูุฉ!  ุณูุชู ุฅุฑุฌุงุน ุงุณุชุฏุนุงุก FUTEX_WAIT ุนูู ุงูููุฑ ุฅุฐุง ูุงูุช ุงููููุฉ ูู ุนููุงู futex ูุง ุชุณุงูู ูููุฉ ุงููุณูุทุฉ ุงูุชู ุชู ุชูุฑูุฑูุง.  ูู ุญุงูุชูุง ุ ูููู ุฃู ูุญุฏุซ ูุฐุง ุฅุฐุง ุฐูุจุช ุงูุนูููุฉ ุงููุฑุนูุฉ ููุงูุชุธุงุฑ ูุจู ุฃู ููุชุจ ุงููุงูุฏ ุงููููุฉ 0xA ูู ุงููุชุญุฉ.  ูููุชูุณ ูู ูุฐู ุงูุญุงูุฉ ุฅุฑุฌุงุน ุงููููุฉ EAGAIN. <br><br>  ูุฅููู ุฑูุฒ ูุธููุฉ wake_futex_blocking: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wake_futex_blocking</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* futex_addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(futex_addr, FUTEX_WAKE, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { perror(<span class="hljs-string"><span class="hljs-string">"futex wake"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre> <br>  ูุฐุง ุบูุงู ููุน ุนูู FUTEX_WAKE ูุนูู ุจุณุฑุนุฉ ููุนูุฏ ูููุฉ ุ ุจุบุถ ุงููุธุฑ ุนู ุนุฏุฏ ุงููุณุชูุนูู ุงูุฐูู ูุชููุนูููุง.  ูู ูุซุงููุง ุ ููุณุชุฎุฏู ูุฐุง ูุฌุฒุก ูู "ูุตุงูุญุฉ" ุ ูููู ููุงู ุงุณุชุฎุฏุงูุงุช ุฃุฎุฑู ููููุฉ. <br><br><h3 style=";text-align:right;direction:rtl">  Futexes ูู ุทูุงุจูุฑ ููุงุฉ ููุฑูุฒ ุงููุฎุตุต. </h3><br>  ุจุจุณุงุทุฉ ุ ูุฅู ุณูู ุชุฏุงูู ุงูุนููุงุช ุงูุฃุฌูุจูุฉ ูู ูุงุฆูุฉ ุงูุชุธุงุฑ ูุฏููุนุฉ ุจุงูููุงุฉ ูุญู ููุงู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุฎุตุตุฉ.  ูุณูุญ ูููุฏ ุงููุณุชุฎุฏู ุฃู ูุทูุจ ูู ุงูููุงุฉ ุชุนููู ุชูููุฐ ุณูุณูุฉ ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ ุจูุง ุญุชู ูููุน ุญุฏุซ ุ ูุฅูู ูุคุดุฑ ุงูุชุฑุงุจุท ุงูุขุฎุฑ ูู ููุณ ุงูููุช ููุฅุดุงุฑุฉ ุฅูู ูุฐุง ุงูุญุฏุซ ูุฅููุงุธ ุฌููุน ุณูุงุณู ุงูุฑุณุงุฆู ุงูุชู ุชูุชุธุฑู.  ุฐูุฑูุง ุณุงุจููุง ุงููุฏุฑุฉ ุนูู ุชูุธูู ููู ุฏูุงุฑ ูู ูุถุน ุงููุณุชุฎุฏู ุ ูู ุงูุชุธุงุฑ ุงูููุงุก ุจุจุนุถ ุงูุดุฑูุท.  ููุน ุฐูู ุ ูุฅู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูู ุงูููุงุฉ ูู ุจุฏูู ุฃูุถู ุจูุซูุฑ ุ ูุฃููุง ุชุญูููุง ูู ุจูุงููู ุชุนูููุงุช ุงููุนุงูุฌ ุงูููุฏุฑุฉ ุงูุชู ูุชู ุชูููุฐูุง ูู ุญููุฉ ุงูุชุธุงุฑ. <br><br>  ููุง ุงูุฑุณู ุงูุชุฎุทูุทู ูู ููุงูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"ูุธุฑุฉ ุนุงูุฉ ูุชุญุฏูุซ</a> ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุฑูุณ"</a> ุนูู LWN: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/476/433/d4e/476433d4e5a9ba7dcd840a7fe5eb3d87.png" alt="ุงูุตูุฑุฉ"><br><br>  ูู ููุฏ ููุงุฉ ููููุณ ุ ูุชู ุชูููุฐ ุงูุนููุฏ ุงูุขุฌูุฉ ูู ููู kernel / futex.c.  ุชููู ุงูููุงุฉ ุจุชุฎุฒูู ุฌุฏูู ุชุฌุฒุฆุฉ ุญูุซ ุชููู ุงูููุงุชูุญ ุนูุงููู - ููุนุซูุฑ ุนูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงููุทููุจุฉ ุจุณุฑุนุฉ ูุฅุถุงูุฉ ุนูููุฉ ุงูุงุชุตุงู ุฅูููุง.  ูู ุดูุก ุ ุจุงูุทุจุน ุ ููุณ ุจูุฐู ุงูุจุณุงุทุฉ - ุจุนุฏ ูู ุดูุก ุ ุงูููุงุฉ ููุณูุง ุชุญุชุงุฌ ุฅูู ูุฒุงููุฉ ุงููุตูู ุฅูู ุงูุจูุงูุงุช ูู ุงูุฏุงุฎู ุ ุจุงูุฅุถุงูุฉ ุฅูู ุฏุนู ุฌููุน ุฃููุงุน ุงูุฎูุงุฑุงุช ุงูุฅุถุงููุฉ ูู futeksov. <br><br><h3 style=";text-align:right;direction:rtl">  ุงูุชุธุฑ ููุชุฑุฉ ูุญุฏูุฏุฉ ูุน FUTEX_WAIT </h3><br>  ูุญุชูู ุงุณุชุฏุนุงุก ูุธุงู futex ุนูู ูุนููุฉ ูููุฉ ุชุชูุญ ูููุณุชุฎุฏู ุชุญุฏูุฏ ุงููุฏุฉ ุงูุชู ูููู ูููุง ุฌุงูุฒูุง ููุงูุชุธุงุฑ.  ููุง <a href="">ูุซุงู</a> ูุงูู ุญูุซ ูุชู ุชูููุฐ ุฐูู ุ ูููู ููุง ุงูุฌุฒุก ุงูุฑุฆูุณู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"child waiting for A\n"</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timespec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timeout</span></span></span><span class="hljs-class"> = {</span></span>.tv_sec = <span class="hljs-number"><span class="hljs-number">0</span></span>, .tv_nsec = <span class="hljs-number"><span class="hljs-number">500000000</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> t1 = time_ns(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> futex_rc = futex(shared_data, FUTEX_WAIT, <span class="hljs-number"><span class="hljs-number">0xA</span></span>, &amp;timeout, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"child woken up rc=%d errno=%s, elapsed=%llu\n"</span></span>, futex_rc, futex_rc ? strerror(errno) : <span class="hljs-string"><span class="hljs-string">""</span></span>, time_ns() - t1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (futex_rc == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; *shared_data == <span class="hljs-number"><span class="hljs-number">0xA</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br>  ุฅุฐุง ุชุฃุฎุฑ ุงูุงูุชุธุงุฑ ููุฏุฉ 500 ูููู ุซุงููุฉ ุ ูุณุชูุชูู ูุธููุฉ futex ุ ููู ุงูุชูุฑุงุฑ ุงูุชุงูู ููุญููุฉ ูููููุง ุงูุชูุงุนู ุจุทุฑููุฉ ุฃู ุจุฃุฎุฑู ูุน ูุฐุง (ุนุฑุถ ุดูุก ูุง ุนูู ุงูุดุงุดุฉ ุฃู ุงููุชุงุจุฉ ุฅูู ุงูุณุฌู ุฃู ูุชุงุจุนุฉ ุงูุงูุชุธุงุฑ ุฃู ุงูุชููู). <br><br><h3 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ููุชูุณ ูุชูููุฐ ูุงุฆู ุงููุฒุงููุฉ </h3><br>  ุจุฏุฃูุง ูุฐู ุงูููุงูุฉ ุจุญูููุฉ ุฃู ุงูุนููุงุช ุงูุฃุฌูุจูุฉ ุฐุงุช ูุงุฆุฏุฉ ุนูููุฉ ูู ุชูููุฐ ูุงุฆูุงุช ุงูุชุฒุงูู ุฐุงุช ุงููุณุชูู ุงูุฃุนูู.  ุฏุนููุง ูุญุงูู ุงุณุชุฎุฏุงููุง (ููุฐูู ุงูุฐุฑุงุช) ูุชูููุฐ ูุงุฆู ุงููุฒุงููุฉ ุงูุชูููุฏู.  ูุนุชูุฏ ุงูุชูููุฐ ุฃุฏูุงู ุนูู ุงูุฑูุฒ ุงููุงุฑุฏ ูู ููุงูุฉ "Futexes are Tricky" ุงูุชู ูุชุจูุง Ulrich Drepper. <br><br>  ูู ูุฐุง ุงููุซุงู ุ ุฃุณุชุฎุฏู C ++ ุ ุจุดูู ุฃุณุงุณู ูููุฏุฑุฉ ุนูู ุงุณุชุฎุฏุงู ุฐุฑุงุช ูู ูุนูุงุฑ C ++ 11.  ููููู ุงูุนุซูุฑ ุนูู ุงูููุฏ ุงููุงูู <a href="">ููุง</a> ุ ูููู ุฃูู ุฌุฒุก ูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutex</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Mutex() : atom_(<span class="hljs-number"><span class="hljs-number">0</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = cmpxchg(&amp;atom_, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// If the lock was previously unlocked, there's nothing else for us to do. // Otherwise, we'll probably have to wait. if (c != 0) { do { // If the mutex is locked, we signal that we're waiting by setting the // atom to 2. A shortcut checks is it's 2 already and avoids the atomic // operation in this case. if (c == 2 || cmpxchg(&amp;atom_, 1, 2) != 0) { // Here we have to actually sleep, because the mutex is actually // locked. Note that it's not necessary to loop around this syscall; // a spurious wakeup will do no harm since we only exit the do...while // loop when atom_ is indeed 0. syscall(SYS_futex, (int*)&amp;atom_, FUTEX_WAIT, 2, 0, 0, 0); } // We're here when either: // (a) the mutex was in fact unlocked (by an intervening thread). // (b) we slept waiting for the atom and were awoken. // // So we try to lock the atom again. We set teh state to 2 because we // can't be certain there's no other thread at this exact point. So we // prefer to err on the safe side. } while ((c = cmpxchg(&amp;atom_, 0, 2)) != 0); } } void unlock() { if (atom_.fetch_sub(1) != 1) { atom_.store(0); syscall(SYS_futex, (int*)&amp;atom_, FUTEX_WAKE, 1, 0, 0, 0); } } private: // 0 means unlocked // 1 means locked, no waiters // 2 means locked, there are waiters in lock() std::atomic&lt;int&gt; atom_; };</span></span></code> </pre><br>  ูู ูุฐุง ุงูููุฏ ุ ุชุนุฏ ูุธููุฉ cmpxhg ุบูุงููุง ุจุณูุทูุง ููุงุณุชุฎุฏุงู ุงูุฃูุซุฑ ููุงุกูุฉ ููุฐุฑุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// An atomic_compare_exchange wrapper with semantics expected by the paper's // mutex - return the old value stored in the atom. int cmpxchg(std::atomic&lt;int&gt;* atom, int expected, int desired) { int* ep = &amp;expected; std::atomic_compare_exchange_strong(atom, ep, desired); return *ep; }</span></span></code> </pre> <br>  ูุญุชูู ูุซุงู ุงูุฑูุฒ ูุฐุง ุนูู ุงูุนุฏูุฏ ูู ุงูุชุนูููุงุช ุงูุชู ุชูุถุญ ููุทู ุนูููุงุชูุง.  ูู ูุถุฑ ูุฐุง ุ ูุฃู ููุงู ุฎุทุฑูุง ูุจูุฑูุง ูู ุฑุบุจุชู ูู ูุชุงุจุฉ ูุณุฎุฉ ุฃุจุณุท ููููุงู ุ ูููููุง ุบูุฑ ุตุญูุญุฉ ุชูุงููุง.  ุฃูุง ุจุงููุณุจุฉ ููุฐุง ุงูุฑูุฒ - ููู ููุณ ูุซุงูููุง ูู ูู ุดูุก.  ุนูู ุณุจูู ุงููุซุงู ุ ูุญุงูู ุฅุฌุฑุงุก ุงูุชุฑุงุถ ุญูู ุฌูุงุฒ ุฏุงุฎูู ูู ุงูููุน std :: atomic ุ ููููู ูุญุชููุงุชู ุฅูู int * ููุชูุฑูุฑ ุฅูู ููุงููุฉ futex.  ูุฐุง ููุณ ูู ุงูุญุงู ุจุดูู ุนุงู.  ูุชู ุชุฌููุน ุงูุฑูุฒ ูุชุดุบููู ุนูู Linux x64 ุ ูููู ููุณ ูุฏููุง ุถูุงู ููุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ ุงูุฃุฎุฑู.  ููุญุตูู ุนููู ุ ูุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ุทุจูุฉ ุชุจุนูุฉ ููุตุฉ ููุฐุฑุงุช.  ูุธุฑูุง ูุฃู ูุฐุง ููุณ ููุถูุน ูุฐู ุงูููุงูุฉ (ูุฃูุถูุง ูุฃูู ูู ุบูุฑ ุงููุญุชูู ุฌุฏูุง ุฃู ุชุฎูุท ุงูุนููุงุช ุงูุฃุฌูุจูุฉ ูู ููุณ ูุญุฏุฉ C ++) ุ ูุณูู ูุญุฐู ูุฐุง ุงูุชูููุฐ.  ูุฐุง ูุฌุฑุฏ ุนุฑุถ! <br><br><h3 style=";text-align:right;direction:rtl">  ูุนุงููุงุช Glibc ูุฃููุงู ููุฎูุถุฉ ุงููุณุชูู </h3><br>  ูุฐูู ูุตููุง ุฅูู ุงูููุทุฉ ุงูุชู ุชููุฐ ูููุง glibc ุณูุงุณู POSIX ุ ุฌุฒุก ูููุง ูู ููุน pthread_mutex_t.  ููุง ููุช ูู ุจุฏุงูุฉ ูุฐู ุงูููุงูุฉ ุ ูุฅู ุงูุนููุฏ ุงูุขุฌูุฉ ููุณุช ูู ุงูุดูุก ุงูุฐู ุณูุญุชุงุฌู ุงููุทูุฑ ุงูุนุงุฏู.  ูุชู ุงุณุชุฎุฏุงููุง ูู ูุจู ููุชุจุงุช ููุช ุงูุชุดุบูู ุฃู ุดูุก ูุชุฎุตุต ููุบุงูุฉ ูุชูููุฐ ุจุฏุงุฆูุงุช ุงูุชุฒุงูู ุนูู ูุณุชูู ุฃุนูู.  ูู ูุฐุง ุงูุณูุงู ุ ูู ุงููุซูุฑ ููุงูุชูุงู ุงููุธุฑ ูู ุชูููุฐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชูุจ ุจูุงูุงุช ูุนุงูุฏุฉ ุนุฏู ุงูุชุดุงุฑ ุงูุฃุณูุญุฉ ุงูููููุฉ</a> .  ูู ููุฏ glibc ุ ูุฐุง ูู ููู nptl / pthread_mutex_lock.c. <br><br>  ุงูุฑูุฒ ูุนูุฏ ุชูุงููุง ุจุณุจุจ ุงูุญุงุฌุฉ ุฅูู ุฏุนู ุฃููุงุน ูุฎุชููุฉ ูู ูุงุฆูุงุช ุงููุฒุงููุฉ ุ ูููู ูููููุง ุงูุนุซูุฑ ุนูู ูุชู ูุฃูููุฉ ุชูุงููุง ุฅุฐุง ุฑุบุจุช ูู ุฐูู.  ููููู ุฃูุถูุง ุฅููุงุก ูุธุฑุฉ ุนูู ูููุงุช sysdeps / unix / sysv / linux / x86_64 / lowlevellock.h ู nptl / lowlevellock.c.  ุงูุฑูุฒ ูุญูุฑ ุฅูู ุญุฏ ูุง ุ ูููู ูุง ูุฒุงู ุงูุฌูุน ุจูู ููุงููุงุช ุงูููุงุฑูุฉ ูุงูุชุจุงุฏู ูููุชูุณ ุฃูุฑูุง ุณููุงู. <br><br>  ูุฌุจ ุฃู ุชููู ุจุงููุนู ุงูุชุนููู ุงูุฃููู ูููู systeds / nptl / lowlevellock.h ุฌูุฏูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Low-level locks use a combination of atomic operations (to acquire and release lock ownership) and futex operations (to block until the state of a lock changes). A lock can be in one of three states: 0: not acquired, 1: acquired with no waiters; no other threads are blocked or about to block for changes to the lock state, &gt;1: acquired, possibly with waiters; there may be other threads blocked or about to block for changes to the lock state. We expect that the common case is an uncontended lock, so we just need to transition the lock between states 0 and 1; releasing the lock does not need to wake any other blocked threads. If the lock is contended and a thread decides to block using a futex operation, then this thread needs to first change the state to &gt;1; if this state is observed during lock release, the releasing thread will wake one of the potentially blocked threads. .. */</span></span></code> </pre> <br><h3 style=";text-align:right;direction:rtl">  ุงุฐูุจ ููุนูู ูู ุณูู ุงูููุฑูุณ </h3><br>  ูุง ูุณุชุฎุฏู Rantime Go libc (ูู ูุนุธู ุงูุญุงูุงุช).  ูุจุงูุชุงูู ุ ูุง ูููููุง ุงูุงุนุชูุงุฏ ุนูู ุชูููุฐ ุณูุงุณู POSIX.  ุจุฏูุงู ูู ุฐูู ุ ูุชุตู ูุจุงุดุฑุฉ ููุงููุงุช ุงููุธุงู ุฐุงุช ุงููุณุชูู ุงูุฃุฏูู.  ูุฐุง ูุฌุนููุง ูุซุงู ุฌูุฏ ุนูู ุงุณุชุฎุฏุงู ุงูุนููุงุช ุงูุฃุฌูุจูุฉ.  ูุธุฑูุง ูุนุฏู ูุฌูุฏ ุทุฑููุฉ ูุงุณุชุฏุนุงุก pthread_mutex_t ุ ูุฌุจ ุนููู ูุชุงุจุฉ ุงูุงุณุชุจุฏุงู ุงูุฎุงุต ุจู.  ุฏุนููุง ูุฑู ููู ูุชู ุฐูู ุ ููุจุฏุฃ ูุน ููุน sync.Mutex ุงููุฑุฆู ูููุณุชุฎุฏู (ูู src / sync / mutex.go). <br><br>  ุชุญุงูู ุทุฑููุฉ ุงูููู ูู ูุฐุง ุงูููุน ุงุณุชุฎุฏุงู ุนูููุฉ ุงููุจุงุฏูุฉ ุงูุฐุฑูุฉ ูุงูุชูุงุท ุงูููู ุจุณุฑุนุฉ.  ุฅุฐุง ุชุจูู ุฃูู ุจุญุงุฌุฉ ุฅูู ุงูุงูุชุธุงุฑ ุ ูุฅูู ูุณุชุฏุนู runtime_SemacquireMutex ุ ูุงูุฐู ูุณุชุฏุนู runtime.lock.  ุชู ุชุนุฑูู ูุฐู ุงููุธููุฉ ูู src / runtime / lock_futex.go ูุชุนูู ุงูุนุฏูุฏ ูู ุงูุซูุงุจุช ุงูุชู ูุฏ ุชุจุฏู ูุฃูููุฉ ูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ( mutex_unlocked = <span class="hljs-number"><span class="hljs-number">0</span></span> mutex_locked = <span class="hljs-number"><span class="hljs-number">1</span></span> mutex_sleeping = <span class="hljs-number"><span class="hljs-number">2</span></span> ... ) <span class="hljs-comment"><span class="hljs-comment">// Possible lock states are mutex_unlocked, mutex_locked and mutex_sleeping. // mutex_sleeping means that there is presumably at least one sleeping thread.</span></span></code> </pre><br>  ูุญุงูู runtime.lock ุฃูุถูุง ุงูุชูุงุท ุงูููู ุจุงุณุชุฎุฏุงู ูุธููุฉ ุฐุฑูุฉ.  ูุฐุง ุฃูุฑ ููุทูู ุ ุญูุซ ูุชู ุงุณุชุฏุนุงุก runtime.lock ูู ุงูุนุฏูุฏ ูู ุฃูุงูู ููุช ุชุดุบูู Go ุ ูููู ูุจุฏู ูู ุฃูู ุณูููู ูู ุงููููู ุชุญุณูู ุงูุฑูุฒ ุจุทุฑููุฉ ุฃู ุจุฃุฎุฑู ุนู ุทุฑูู ุฅุฒุงูุฉ ููุงููุชูู ูุชุชุงููุชูู ูููุธููุฉ ุงูุฐุฑูุฉ ุนูุฏ ุงุณุชุฏุนุงุก runtime.lock ูู Mutex.lock. <br><br>  ุฅุฐุง ุงุชุถุญ ุฃูู ุจุญุงุฌุฉ ุฅูู ุงูุงูุชุธุงุฑ ุ ูุชู ุงุณุชุฏุนุงุก ูุธููุฉ futexsleep ุงููุนุชูุฏุฉ ุนูู ุงููุธุงู ุงูุฃุณุงุณู ุ ูุงูุชู ูุชู ุชุนุฑูููุง ููุธุงู ุงูุชุดุบูู Linux ูู ููู src / runtime / os_linux.go.  ุชููู ูุฐู ุงููุธููุฉ ุจุฅุฌุฑุงุก ุงุณุชุฏุนุงุก ููุธุงู futex ุจุฑูุฒ FUTEX_WAIT_PRIVATE (ูู ูุฐู ุงูุญุงูุฉ ุ ูุฐุง ููุงุณุจ ุ ุญูุซ ุฃู ููุช ุชุดุบูู Go ูุนูุด ูู ุนูููุฉ ูุงุญุฏุฉ). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar418705/">https://habr.com/ru/post/ar418705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar418691/index.html">ุฑุงูุดุฑ: Kubernetes ูู 5 ุฏูุงุฆู ุนูู ุงููุนุฏู</a></li>
<li><a href="../ar418693/index.html">ููุงุฐุง ูุตุนุจ ุงูุชุดุงู ุงูุณุนุงุฏุฉ ูู ุงูุฏูุงุบ</a></li>
<li><a href="../ar418695/index.html">ุญุฑูุจ ููุงูุญุฉ ุงููุฑุตูุฉ - ุงูุฅูุจุฑุงุทูุฑูุฉ ุชุนูุฏ ุงูุถุฑุจุงุช</a></li>
<li><a href="../ar418699/index.html">ุฅูุดุงุก ุขูุฉ ููุฑ ุงููุญุงูู. ุงูุฌุฒุก 3</a></li>
<li><a href="../ar418701/index.html">ูุฏุฑุณ ุงููุญูู ุงููุบูู ููุบุฉ ุงูุฑูุณูุฉ</a></li>
<li><a href="../ar418707/index.html">KDispatcher - Eventbus ุฎูููุฉ ุงููุฒู ููุฑูุญุฉ ููุงุณุชุฎุฏุงู ุงููููู</a></li>
<li><a href="../ar418709/index.html">ุชุญุชุงุฌ ุฅูู ูุฑุถ ููุณู: ุงูุณุงุฆููู ูุญูุงุฌุฒ ุงููุงุฌูุฉ</a></li>
<li><a href="../ar418711/index.html">ุชุณุฌููุงุช ุงูุฑูุฒ ุงูููุฏุงุฑ 1.0</a></li>
<li><a href="../ar418713/index.html">ูุนุจุฉ ูุชุญุณูู ุฌูุฏุฉ ููููุจูุฏูุง</a></li>
<li><a href="../ar418715/index.html">ูุง ูุฏู ููุงุกุฉ ูุธุงู ุงููููุงุช ุงูุธุงูุฑู procfs ููู ูู ุงููููู ุชุญุณููู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>