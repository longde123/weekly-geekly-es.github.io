<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📘 🧔🏻 👨🏼‍🚀 Accélération instagram.com. partie 1 🐳 🕌 👨🏾‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ces dernières années, beaucoup de nouvelles choses sont apparues sur instagram.com . Beaucoup. Par exemple - outils de narration, filtres, outils créa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Accélération instagram.com. partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/468227/">  Ces dernières années, beaucoup de nouvelles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">choses</a> sont apparues sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instagram.com</a> .  Beaucoup.  Par exemple - outils de narration, filtres, outils créatifs, notifications, messages directs.  Cependant, à mesure que le projet grandissait, tout cela a donné un triste effet secondaire, à savoir que les performances d'instagram.com ont commencé à décliner.  Au cours de la dernière année, l'équipe de développement d'Instagram a fait des efforts continus pour résoudre ce problème.  Cela a conduit au fait que le temps de chargement total du flux Instagram (page de flux) a diminué de près de 50%. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/wl/oy/ns/wloynshoivqpdf3vtudd3xypwxq.jpeg"></a> <br><br>  Aujourd'hui, nous publions une traduction du premier matériel d'une série d'articles consacrés à l'histoire de la façon dont instagram.com a été accéléré. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">À propos de l'optimisation des performances des projets Web</font> </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/032/871/987/0328719872d42adf9b7690c1a6b63693.png"></div><br>  <i><font color="#999999">Amélioration des performances au cours de la dernière année (flux Instagram, métrique Display Done, ms.)</font></i> <br><br>  L'une des approches les plus importantes pour améliorer les performances des applications Web consiste à hiérarchiser correctement les ressources de chargement et de traitement et à réduire les temps d'arrêt du navigateur pendant le chargement des pages.  Dans notre cas, bon nombre de ces optimisations se sont révélées plus efficaces que la réduction de la taille du code.  En règle générale, nous n'avons eu aucune plainte concernant la taille du code.  C'était assez compact.  Ses dimensions ont commencé à nous déranger seulement après que de nombreuses petites améliorations ont été apportées au projet (nous prévoyons également de parler de l'optimisation de la taille du code).  Ces améliorations ont en outre eu moins d'impact sur le processus de développement du projet.  Ils ont nécessité moins de changements de code et moins de refactoring.  En conséquence, nous avons initialement concentré nos efforts précisément sur ce domaine, en commençant par les ressources de préchargement. <br><br><h2>  <font color="#3AC1EF">Une histoire sur le préchargement d'images, le code JavaScript et les matériaux nécessaires pour terminer les requêtes, ainsi que les précautions à prendre</font> </h2><br>  Le principe général de nos optimisations était d'informer le navigateur le plus rapidement possible des ressources nécessaires pour charger la page.  En tant que développeurs de projets, dans de nombreux cas, nous savions à l'avance ce qui serait exactement nécessaire pour cela.  Mais le navigateur ne pouvait en avoir aucune idée jusqu'à ce qu'une certaine partie du matériel de la page soit chargée et traitée.  Les ressources en question, pour la plupart, comprenaient celles qui sont chargées dynamiquement à l'aide de JavaScript (par exemple, d'autres scripts, images, matériaux nécessaires pour exécuter les requêtes XHR).  Le fait est que le navigateur ne peut pas détecter ces ressources dépendantes tant qu'il n'a pas analysé et exécuté du code JavaScript. <br><br>  Au lieu d'attendre que le navigateur lui-même trouve ces ressources, nous pourrions lui donner un indice, après quoi il pourrait immédiatement commencer à les télécharger.  Nous l'avons fait en utilisant les attributs HTML de <code>preload</code> .  Cela ressemble à ceci: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"my-js-file.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Nous utilisons des conseils similaires pour deux types de ressources sur les chemins de chargement des pages critiques.  Il s'agit de code JavaScript chargé dynamiquement et de matériaux chargés dynamiquement de demandes de données GraphQL XHR.  Les scripts chargés dynamiquement sont des scripts qui sont chargés à l'aide de constructions de l' <code>import('...')</code> formulaire <code>import('...')</code> pour des itinéraires client spécifiques.  Nous maintenons une liste de correspondance des points d'entrée du serveur et des scripts de routage client.  Par conséquent, lorsque nous recevons, sur le serveur, une demande de chargement de la page, nous connaissons les scripts pour lesquels les itinéraires client que vous devez télécharger.  En conséquence, nous pouvons, lors de la génération du code HTML de la page, lui ajouter des conseils appropriés. <br><br>  Par exemple, lorsque vous travaillez avec le point d'entrée <code>FeedPage</code> nous savons que le routeur client finira par terminer une demande de téléchargement de <code>FeedPageContainer.js</code> .  Par conséquent, nous pouvons ajouter la construction suivante au code de la page: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/FeedPageContainer.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  De même, si nous savons qu'une requête GraphQL est prévue pour être exécutée pour le point d'entrée d'une page particulière, cela signifie que nous devons précharger des matériaux pour accélérer l'exécution de cette requête.  Ceci est particulièrement important en raison du fait que l'exécution de telles requêtes GraphQL prend parfois beaucoup de temps et que la page ne peut pas être rendue tant que les résultats de la requête ne sont pas retournés.  Pour cette raison, nous devons faire en sorte que le serveur s'engage le plus tôt possible dans la formation des réponses à de telles demandes. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/graphql/query?id=12345"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fetch"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/json"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Les changements dans les fonctionnalités de chargement des pages sont particulièrement visibles sur les connexions lentes.  En simulant une connexion 3G rapide (le premier graphique en cascade ci-dessous, qui illustre la situation lorsque le préchargement des ressources n'est pas utilisé), nous pouvons voir que le chargement de <code>FeedPageContainer.js</code> et l'exécution de la requête GraphQL qui lui est associée ne commencent qu'après le chargement de <code>Consumer.js</code> .  Toutefois, dans le cas où le préchargement est utilisé, le chargement du script <code>FeedPageContainer.js</code> et l'exécution de la requête GraphQL peuvent commencer immédiatement après que la page HTML est disponible.  De plus, cela réduit le temps requis pour télécharger les scripts mineurs qui utilisent des mécanismes de chargement paresseux.  Ici, <code>FeedSidebarContainer.js</code> et <code>ActivityFeedBox.js</code> (qui dépendent de <code>FeedPageContainer.js</code> ) commencent à se charger presque immédiatement après le traitement de <code>Consumer.js</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fe0/10c/222/fe010c2222b31034b109f5cc0d378613.png"></div><br>  <i><font color="#999999">Précharge non utilisée</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e3f/e33/b78/e3fe33b78b3b5fe1c04fa3175809e25d.png"></div><br>  <i><font color="#999999">Précharge utilisée</font></i> <br><br><h2>  <font color="#3AC1EF">Avantages de prioriser la précharge</font> </h2><br>  En plus d'utiliser l'attribut de <code>preload</code> pour démarrer plus rapidement le chargement des ressources, l'utilisation de ce mécanisme présente un autre avantage.  Elle consiste à augmenter la priorité réseau de chargement de script asynchrone.  Cela devient important lors de l'utilisation de scripts chargés de manière asynchrone dans des chemins critiques pour charger des pages, car par défaut, ils se chargent avec une faible priorité.  Par conséquent, la priorité des demandes XHR et des images liées à la zone de page visible par les utilisateurs sera plus élevée que celle des documents en dehors de la zone de visualisation.  Mais cela peut conduire à des situations où les scripts critiques nécessaires au rendu de la page sont bloqués ou forcés de partager la bande passante avec d'autres ressources.  Si vous êtes intéressé, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici un</a> compte rendu détaillé des priorités des ressources de Chrome.  Une utilisation réfléchie du mécanisme de préchargement (nous en parlerons plus loin ci-dessous) donne au développeur un certain niveau de contrôle sur la façon dont le navigateur priorise le processus de chargement initial de la page.  Cela est particulièrement vrai dans les cas où le développeur sait quelles ressources sont importantes pour l'affichage correct de la page. <br><br><h2>  <font color="#3AC1EF">Problèmes de priorisation de préchargement</font> </h2><br>  Le problème du préchargement des ressources réside précisément dans le fait qu'il offre au développeur un levier supplémentaire pour influencer la priorité de chargement des ressources.  Cela signifie que le développeur a plus de responsabilité pour la bonne priorisation.  Par exemple, lors du test d'un site dans des régions où la vitesse des réseaux mobiles et WiFi est très faible, et où un pourcentage important de perte de paquets est observé, nous avons remarqué que la requête exécutée lors du traitement de <code>&lt;link rel="preload" as="script"&gt;</code> obtient une priorité plus élevée que la demande qui est exécutée lors du traitement de la <code>&lt;script /&gt;</code> ensembles JavaScript utilisés dans les chemins de rendu de page critiques.  Cela entraîne une augmentation du temps de chargement global des pages. <br><br>  La source de ce problème était la façon dont nous avons placé les balises de préchargement sur nos pages.  À savoir, nous avons ajouté des astuces de préchargement uniquement pour les bundles, qui font partie de la page actuelle, que nous allions charger de manière asynchrone avec le routeur client. <br><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--   ,    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SomeConsumerRoute.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Common.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Consumer.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Par exemple, sur la page de déconnexion, nous chargeons <code>SomeConsumerRoute.js</code> dans <code>Common.js</code> et <code>Consumer.js</code> , et puisque les ressources de préchargement sont chargées avec une priorité plus élevée, mais elles ne sont pas analysées, cela bloque <code>Common.js</code> et <code>Consumer.js</code> parsing <code>Consumer.js</code> .  L'équipe de développement de Chrome Data Saver a détecté un problème de préchargement similaire et a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">décrit</a> sa solution à ce problème.  Dans leur cas, il a été décidé de toujours placer des constructions pour le préchargement des ressources asynchrones après les balises <code>&lt;script /&gt;</code> de ces ressources qui utilisent ces ressources asynchrones.  Nous avons décidé de précharger tous les scripts et de placer les constructions correspondantes dans le code dans l'ordre dans lequel elles seraient nécessaires.  Cela nous donne la possibilité de commencer à précharger toutes les ressources de script de la page le plus rapidement possible.  Cela inclut des balises pour le chargement synchrone de scripts qui ne peuvent pas être ajoutés au HTML jusqu'à ce que des données de serveur spécifiques soient placées sur la page.  Cela nous permet de contrôler l'ordre de chargement des scripts. <br><br>  Voici le balisage qui précharge tous les bundles JavaScript. <br><br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Common.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Consumer.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   ,    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SomeConsumerRoute.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"script"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Common.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Consumer.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SomeConsumerRoute.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Précharge d'image</font> </h2><br>  L'un des principaux domaines de travail d'instagram.com est Feed.  Il s'agit d'une page d'image et de vidéo qui prend en charge le défilement sans fin.  Nous remplissons cette page comme ceci.  Tout d'abord, téléchargez l'ensemble initial de publications, puis, lorsque l'utilisateur fait défiler la page, chargez des ensembles supplémentaires de documents.  Cependant, nous ne voudrions pas que l'utilisateur attende que de nouveaux matériaux soient chargés chaque fois qu'il atteint le bas de la bande.  Par conséquent, afin de faciliter le travail avec cette page, nous téléchargeons de nouveaux ensembles de documents avant que l'utilisateur n'atteigne la fin de la bande. <br><br>  En pratique, cela, pour plusieurs raisons, n'est pas une tâche facile: <br><br><ul><li>  Nous devons télécharger des documents qui ne sont pas visibles par l'utilisateur, afin qu'ils ne prennent pas les ressources réseau et processeur des documents qu'il consulte. </li><li>  Nous ne voudrions pas transmettre des données inutiles sur le réseau, en essayant trop fort de précharger des publications que l'utilisateur pourrait même ne pas voir.  Mais, d'autre part, si nous ne préchargeons pas une quantité suffisante de matériel, cela signifiera souvent le risque que l'utilisateur «se heurte» à la fin de la bande. </li><li>  Le projet instagram.com est conçu pour fonctionner sur différents appareils et sur des écrans de différentes tailles.  Par conséquent, nous <code>srcset</code> les images sur la bande à l'aide de l'attribut <code>srcset</code> de la <code>&lt;img&gt;</code> .  Cet attribut permet au navigateur, compte tenu de la taille de l'écran, de décider quelle résolution d'image utiliser.  Cela signifie qu'il n'est pas si facile pour nous de déterminer à l'avance la résolution des images à télécharger.  De plus, il existe un risque de préchargement d'images que le navigateur n'utilisera pas. </li></ul><br>  L'approche que nous avons utilisée pour résoudre ce problème était de créer une abstraction de la tâche de priorisation, qui est responsable de la mise en file d'attente des tâches asynchrones (dans ce cas, il s'agit de tâches de préchargement du prochain ensemble de publications pour la sortie dans la bande).  Une tâche similaire est initialement mise en file d'attente avec priorité <code>idle</code> (ici, <code>requestIdleCallback</code> utilisé).  Cela signifie que l'exécution d'une telle tâche ne démarrera pas tant que le navigateur sera occupé par tout autre travail important.  Cependant, si l'utilisateur fait défiler la page suffisamment près de l'endroit où se termine l'ensemble actuel des publications téléchargées, la priorité de cette tâche de préchargement des documents passe à <code>high</code> .  Cela se fait en annulant le rappel de veille, après quoi le processus de préchargement démarre immédiatement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b62/701/f67/b62701f67c074ca53154fe434123c756.png"></div><br>  <i><font color="#999999">Au début et au milieu de la bande, la tâche de préchargement des données a une priorité inactive et à la fin de la bande, la priorité est élevée</font></i> <br><br>  Une fois le téléchargement des données JSON terminé pour le prochain lot de publications, nous mettons en file d'attente une tâche d'arrière-plan répétitive pour le préchargement des images de ce lot.  Le préchargement d'image est effectué dans l'ordre dans lequel les publications sont affichées dans le flux plutôt qu'en parallèle.  Cela nous permet de hiérarchiser les tâches de chargement des données et d'afficher des images pour les publications les plus proches de l'endroit sur la page que l'utilisateur voit.  Pour télécharger des images de la bonne taille, nous utilisons un composant média caché, dont les paramètres correspondent aux paramètres de la bande actuelle.  À l'intérieur de ce composant, il y a un élément <code>&lt;img&gt;</code> qui utilise l'attribut <code>srcset</code> , le même qui est utilisé pour afficher les publications réelles dans le flux.  Cela signifie que nous pouvons fournir au navigateur la possibilité de prendre des décisions sur les images à précharger.  Par conséquent, le navigateur utilisera la même logique lors de l'affichage des images qu'il a utilisé lors de leur préchargement.  Cela signifie également que nous, en utilisant un composant multimédia similaire, pouvons précharger des images pour d'autres zones du site.  Telles que les pages de profil utilisateur. <br><br>  L'effet global des améliorations ci-dessus a entraîné une réduction de 25% du temps requis pour télécharger des photos.  Nous parlons de la durée entre le moment où le code de publication est ajouté au DOM et le moment où l'image de la publication est chargée et affichée.  En outre, cela a entraîné une réduction de 56% du temps que les utilisateurs, ayant atteint la fin du flux, passaient à attendre pour télécharger de nouveaux documents. <br><br>  <b>Chers lecteurs!</b>  Utilisez-vous des mécanismes de préchargement des données pour optimiser vos projets Web? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/it/t5/3p/itt53pns2iucwylb3bwn1fmmtnu.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468227/">https://habr.com/ru/post/fr468227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468213/index.html">tinc-boot - réseau maillé sans douleur</a></li>
<li><a href="../fr468217/index.html">Dr. Jekyll et M. Hyde Culture d'entreprise</a></li>
<li><a href="../fr468219/index.html">Mécanismes d'extensibilité extensible en JavaScript</a></li>
<li><a href="../fr468223/index.html">Habr Weekly # 19 / BT-porte pour le chat, pourquoi l'IA triche, que demander au futur employeur, une journée avec iPhone 11 Pro</a></li>
<li><a href="../fr468225/index.html">Réduction des tailles de bundle avec Webpack Analyzer et React Lazy / Suspense</a></li>
<li><a href="../fr468229/index.html">Une note sur void en JavaScript et TypeScript</a></li>
<li><a href="../fr468231/index.html">La sécurité dans AEM est-elle un problème de plate-forme ou d'implémentation?</a></li>
<li><a href="../fr468233/index.html">La façon de taper la vérification de 4 millions de lignes de code Python. partie 1</a></li>
<li><a href="../fr468235/index.html">La façon de taper la vérification de 4 millions de lignes de code Python. 2e partie</a></li>
<li><a href="../fr468237/index.html">La façon de taper la vérification de 4 millions de lignes de code Python. 3e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>