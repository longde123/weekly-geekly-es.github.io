<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç¨ üçç üê≤ Migration transparente (ou presque) entre les principales versions de PostgreSQL √† l'aide de la r√©plication logique ‚ùÑÔ∏è üò© üë©üèø‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans True Engineering, sur un projet, le besoin est venu de changer la version de PostgreSQL de 9.6 √† 11.1. 

 Pourquoi? La base de donn√©es sur le pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration transparente (ou presque) entre les principales versions de PostgreSQL √† l'aide de la r√©plication logique</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/437318/">  Dans True Engineering, sur un projet, le besoin est venu de changer la version de PostgreSQL de 9.6 √† 11.1. <br><br>  Pourquoi?  La base de donn√©es sur le projet a d√©j√† une taille de 1,5 To et se d√©veloppe.  La performance est l'une des principales exigences du syst√®me.  Et la structure de donn√©es elle-m√™me √©volue: de nouvelles colonnes sont ajout√©es, celles existantes sont modifi√©es.  La nouvelle version de Postgres a appris √† travailler efficacement avec l'ajout de nouvelles colonnes avec une valeur par d√©faut, il n'est donc pas n√©cessaire de cl√¥turer les b√©quilles personnalis√©es au niveau de l'application.  M√™me dans la nouvelle version, plusieurs nouveaux modes de partitionnement des tables ont √©t√© ajout√©s, ce qui est √©galement extr√™mement utile dans des conditions de grande quantit√© de donn√©es. <br><br>  Donc, c'est d√©cid√©, nous migrons.  Bien s√ªr, vous pouvez cr√©er une nouvelle version du serveur PostgreSQL en parall√®le avec l'ancienne, arr√™ter l'application, utiliser dump / restore (ou pg_upgrade) pour d√©placer la base de donn√©es et red√©marrer l'application.  Cette solution ne nous convenait pas en raison de la grande taille de la base, en plus, l'application fonctionne en mode combat, et il n'y a que quelques minutes pour les temps d'arr√™t. <br><br>  Par cons√©quent, nous avons d√©cid√© d'essayer la migration en utilisant la r√©plication logique dans PostgreSQL en utilisant un plugin tiers appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pglogical</a> . <br><br>  Dans le processus ¬´d'essai¬ª, nous sommes tomb√©s sur une documentation tr√®s fragmentaire sur ce processus (et en russe, ce n'est pas du tout), ainsi que sur certains pi√®ges et nuances non √©videntes.  Dans cet article, nous voulons pr√©senter notre exp√©rience sous la forme d'un tutoriel. <br><br><img src="https://habrastorage.org/webt/cp/i7/oi/cpi7oixtsenmioqdrcyyotgagyk.png"><br><br>  <b>TL; DR</b> <br><br><ul><li>  Tout s'est av√©r√© (non sans b√©quilles, un article √† leur sujet). </li><li>  Vous pouvez migrer dans la version PostgreSQL de 9.4 √† 11.x, de n'importe quelle version vers n'importe quelle version, vers le bas ou vers le haut. </li><li>  Le temps d'arr√™t est √©gal au temps n√©cessaire √† votre application pour se reconnecter au nouveau serveur de base de donn√©es (dans notre cas, il s'agissait d'un red√©marrage de l'application enti√®re, mais dans la nature, √©videmment, "options possibles"). </li></ul><a name="habracut"></a><br><h3>  Pourquoi la solution ¬´front¬ª ne nous convenait-elle pas </h3><br>  Comme nous l'avons d√©j√† dit, la solution la plus simple consiste √† augmenter la nouvelle version du serveur PostgreSQL en parall√®le avec l'ancienne, √† arr√™ter l'application, √† utiliser dump / restore (ou pg_upgrade) pour d√©placer la base de donn√©es et √† red√©marrer l'application.  Pour les bases de donn√©es de petit volume, en principe, c'est une option tout √† fait appropri√©e (ou, dans le cas g√©n√©ral, le volume est sans importance lorsque vous avez la possibilit√© d'indisponibilit√© de l'application pour la p√©riode de "transfusion" de la base de donn√©es de l'ancien serveur au nouveau, quelle que soit la dur√©e).  Mais dans notre cas, la base de donn√©es prend environ 1,5 To sur le disque, et le d√©placer n'est pas une question de minutes, mais de plusieurs heures.  L'application, √† son tour, fonctionne en mode combat, et je voulais vraiment √©viter les temps d'arr√™t pendant plus de quelques minutes. <br><br>  Cette option √©tait √©galement contre le fait que nous utilisons la r√©plication ma√Ætre-esclave et que nous ne pouvons pas d√©sactiver le serveur esclave du flux de travail en toute s√©curit√©.  Ainsi, pour basculer l'application de l'ancienne version de PostgreSQL vers la nouvelle apr√®s la migration du serveur ma√Ætre, il serait n√©cessaire de pr√©parer un nouveau serveur esclave avant le d√©marrage de l'application.  Et c'est encore quelques heures de temps d'arr√™t jusqu'√† ce que l'esclave soit cr√©√© (bien que beaucoup moins que la migration du ma√Ætre). <br><br>  Par cons√©quent, nous avons d√©cid√© d'essayer la migration en utilisant la r√©plication logique dans PostgreSQL en utilisant un plugin tiers appel√© pglogical. <br><br><h3>  Informations g√©n√©rales </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pglogical</a> est un syst√®me de r√©plication logique utilisant le d√©codage logique natif dans PostgreSQL et impl√©ment√© en tant qu'extension PostgreSQL.  Vous permet de configurer la r√©plication s√©lective √† l'aide du mod√®le d'abonnement / publication.  Il ne n√©cessite pas la cr√©ation de d√©clencheurs dans la base de donn√©es ni l'utilisation d'aucun utilitaire externe pour la r√©plication. <br><br>  L'extension fonctionne sur n'importe quelle version de PostgreSQL, √† partir de 9.4 (depuis le d√©codage logique est apparue pour la premi√®re fois en 9.4), et vous permet de migrer entre toutes les versions prises en charge de PostgreSQL dans n'importe quelle direction. <br><br>  Configurer manuellement la r√©plication √† l'aide de pglogical n'est pas tr√®s simple, bien qu'en principe cela soit tout √† fait possible.  Heureusement, il existe un utilitaire tiers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pgrepup</a> pour automatiser le processus de configuration, que nous utiliserons. <br><br><h3>  M√©mo d'espace disque </h3><br>  √âtant donn√© que nous pr√©voyons de mettre √† jour la nouvelle version de PostgreSQL sur les m√™mes serveurs en parall√®le avec l'ancienne, les exigences de disque pour la base de donn√©es sur les serveurs ma√Ætre et esclave sont doubl√©es.  Il semblerait que cela soit √©vident, mais ... Prenez juste suffisamment d'espace libre avant de commencer la r√©plication, afin de ne pas regretter les ann√©es pass√©es sans but. <br><br>  Dans notre cas, des modifications de la base de donn√©es √©taient n√©cessaires, ainsi que le format de stockage lors de la migration entre 9,6 et 11 ¬´houles¬ª en faveur de la derni√®re version, donc l'espace disque devait √™tre augment√© non pas de 2, mais d'environ 2,2 fois.  Louez LVM, cela peut √™tre fait dans le processus de migration √† la vol√©e. <br><br>  En g√©n√©ral, prenez-en soin. <br><br><h3>  Installer PostgreSQL 11 sur Master </h3><br><blockquote>  Remarque: Nous utilisons Oracle Linux et tous les √©l√©ments suivants seront affin√©s pour cette distribution.  Il est possible que d'autres distributions Linux n√©cessitent une petite r√©vision avec un fichier, mais il est peu probable qu'elles soient significatives. </blockquote><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #   postgresql11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #   /usr/pgsql-11/bin/postgresql-11-setup initdb</span></span></code> </pre> <br>  L'ancien datadir est situ√© dans <b>/var/lib/pgsql/9.6/data</b> , le nouveau, en cons√©quence, se trouve dans <b>/ var / lib / pgsql / 11 / data</b> <br><br>  Copiez les param√®tres d'acc√®s ( <b>pg_hba.conf</b> ) et les param√®tres du serveur ( <b>postgresql.conf</b> ) de 9,6 √† 11. <br><br>  Pour ex√©cuter deux serveurs PostgreSQL sur la m√™me machine, dans la configuration de configuration <b>postgresql.conf</b> 11, changez le port en 15432 (port = 15432). <br><br>  Ici, vous devez r√©fl√©chir soigneusement √† ce que vous devez faire d'autre dans la nouvelle version de PostgreSQL sp√©cifiquement dans votre cas, afin qu'il commence par votre <b>postgresql.conf</b> (et que votre application puisse √©ventuellement fonctionner avec).  Dans notre cas, il √©tait n√©cessaire d'installer les extensions PostgreSQL utilis√©es par nous dans la nouvelle version.  Cela d√©passe le cadre de l'article, faites simplement d√©marrer le nouveau PostgreSQL, travaillez-le et faites-le vous convenir compl√®tement :) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,  ,  shared libraries, whatever... # .... #  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Nous regardons dans <b>/ var / lib / pgsql / 11 / data / pg_log /</b> .  Tout va bien?  Nous continuons! <br><br><h3>  Installer et configurer pgrepup </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  python yum install python yum install python2-pip #  pgrepup pip install pgrepup #   pgrepup config</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/zg/xz/9o/zgxz9oct5l-qglkxyeyrqejh4we.png"><br><br>  Nuances: <br><br><ol><li>  En tant que <b>propri√©taire de l'application, nous sp√©cifions</b> l'utilisateur sous lequel les serveurs PostgreSQL s'ex√©cutent. </li><li>  Pour <b>Base de donn√©es,</b> sp√©cifiez <b>template1</b> . </li><li>  <b>Nom d'utilisateur</b> et <b>mot de passe</b> - donn√©es pour l'acc√®s superutilisateur.  Dans notre cas, la m√©thode de <b>confiance a</b> √©t√© sp√©cifi√©e dans <b>pg_hba.conf</b> pour les connexions locales de l'utilisateur <b>postgres</b> , vous pouvez donc sp√©cifier un mot de passe arbitraire. </li></ol><br><h3>  Configurer la r√©plication </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup check</span></span></code> </pre><br>  Nous obtenons la sortie d'une liste de nombreux param√®tres qui doivent √™tre configur√©s selon les besoins. <br><br>  Exemples de r√©sultats de v√©rification: <br><br><img src="https://habrastorage.org/webt/h3/wu/zm/h3wuzmcevo7idf-xlyrz3ae8av8.png"><br><br><img src="https://habrastorage.org/webt/58/zh/bb/58zhbbubdbfvzzgat051bviywqy.png"><br><br>  Toutes les erreurs lors de la v√©rification devront √™tre √©limin√©es.  Dans les param√®tres des deux serveurs, d√©finissez <b>wal_level = LOGICAL</b> (pour que le d√©codage logique fonctionne), les param√®tres n√©cessaires pour le moteur de r√©plication (nombre d'emplacements et <b>wal_senders</b> ).  Les conseils de l'utilitaire pgrepup sont assez informatifs; les questions ne devraient pas se poser sur la plupart des points. <br><br>  Nous faisons tous les r√©glages n√©cessaires que pgrepup demande. <br><br>  Dans les deux fichiers <b>pg_hba.conf</b> , nous ajoutons des autorisations pour l'utilisateur qui effectuera la r√©plication, le tout √† l'invite pgrepup: <br><br><pre> <code class="bash hljs">host replication pgrepup_replication 127.0.0.1/32 md5 host all pgrepup_replication 127.0.0.1/32 md5</code> </pre> <br><h3>  Ajouter des cl√©s primaires </h3><br>  Pour que la r√©plication fonctionne, une cl√© primaire doit √™tre d√©finie dans toutes les tables. <br><br>  Dans notre cas, PK n'√©tait pas partout, par cons√©quent, au moment de la r√©plication, vous devez l'ajouter et, √† la fin de la r√©plication, si n√©cessaire, le supprimer. <br><br>  Une liste de tables sans PK, entre autres, produit <code>pgrepup check</code> .  Pour toutes les tables de cette liste, vous devez ajouter une cl√© primaire de la mani√®re qui vous convient.  Dans notre cas, c'√©tait quelque chose comme: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> %s <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> temporary_pk <span class="hljs-type"><span class="hljs-type">BIGSERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span></code> </pre> <br>  L'utilitaire pgrepup poss√®de une commande int√©gr√©e pour effectuer cette op√©ration ( <code>pgrepup fix</code> ), et m√™me s'il est utilis√©, il est entendu que si la r√©plication <code>pgrepup fix</code> , ces colonnes temporaires seront automatiquement supprim√©es.  Mais, malheureusement, cette fonctionnalit√© √©tait tellement illusoire et incroyablement bugg√©e sur de grandes bases que nous avons d√©cid√© de ne pas l'utiliser, mais de faire cette op√©ration manuellement, car cela nous convient. <br><br><h3>  Installer l'extension pglogical </h3><br>  Les instructions d'installation de l'extension sont disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  L'extension doit √™tre install√©e sur les deux serveurs. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       curl https://access.2ndquadrant.com/api/repository/dl/default/release/9.6/rpm | bash curl https://access.2ndquadrant.com/api/repository/dl/default/release/11/rpm | bash #   yum install postgresql96-pglogical postgresql11-pglogical</span></span></code> </pre> <br>  Ajoutez la charge de biblioth√®que dans <b>postgresql.conf des</b> deux serveurs: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical'</span></span></code> </pre> <br><h3>  Installer l'extension pgl_ddl_deploy </h3><br>  Il s'agit d'une extension d'assistance que pgrepup utilise pour la r√©plication DDL logique. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      git clone https://github.com/enova/pgl_ddl_deploy.git #       PATH=/usr/pgsql-9.6/bin/:$PATH USE_PGXS=1 make USE_PGXS=1 make install make clean #       PATH=/usr/pgsql-11/bin/:$PATH make CLANG=true make install</span></span></code> </pre> <br>  Ajoutez la charge de biblioth√®que dans <b>postgresql.conf des</b> deux serveurs: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical,pgl_ddl_deploy'</span></span></code> </pre> <br><h3>  V√©rification des modifications </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   postgresql systemctl restart postgresql-11</span></span></code> </pre> <br>  Maintenant, en utilisant <code>pgrepup check</code> vous devez vous assurer que tout va bien avec le serveur cible et que tous les commentaires concernant le serveur cible ont √©t√© compl√®tement √©limin√©s. <br><br>  Si tout va bien, vous pouvez red√©marrer l'ancien serveur.  Ici, vous devez r√©fl√©chir √† la fa√ßon dont votre application r√©agira au red√©marrage du serveur de base de donn√©es, vous devriez peut-√™tre l'arr√™ter en premier. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl restart postgresql-9.6 #  pgrepup check</span></span></code> </pre> <br>  Maintenant, dans la sortie de la commande, tous les √©l√©ments doivent √™tre marqu√©s comme OK. <br><br>  Il semblerait que vous puissiez commencer la migration, mais ... <br><br><h3>  Correction des bugs de pgrepup </h3><br>  Il existe plusieurs bogues dans la version actuelle de pgrepup qui rendent la migration impossible.  Des demandes d'extraction ont √©t√© envoy√©es, mais h√©las, elles sont ignor√©es, vous devrez donc apporter des corrections manuellement. <br><br>  Nous allons dans le dossier d'installation de pgrepup (notre cas est <b>/usr/lib/python2.7/site-packages/pgrepup/commands/</b> ). <br><br>  Faites-le une fois.  Dans chaque fichier <b>* .py</b> , ajoutez les <code>**kwargs</code> manquants dans la description de la fonction.  Une image vaut mieux que mille mots: <br><br><img src="https://habrastorage.org/webt/l3/zc/uo/l3zcuo2exe8lq_0u3gwv_nq8jty.png"><br><br>  Engagez-vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Faites deux.  Dans <b>setup.py,</b> nous recherchons ¬´sh -c¬ª, deux entr√©es, toutes les commandes shell multi-lignes doivent √™tre effectu√©es sur une seule ligne. <br><br>  Engagez-vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h3>  Lancer la migration </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  pgrepup setup</span></span></code> </pre> <br>  Avec cette commande, pgrepup pr√©pare les deux serveurs √† d√©marrer la r√©plication, cr√©e un utilisateur, configure pglogical, transf√®re le sch√©ma de la base de donn√©es. <br><br><img src="https://habrastorage.org/webt/ww/km/jd/wwkmjdmmpmwyvgbdqyktohnhmmy.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup start</span></span></code> </pre> <br>  Il a dit: "Allons-y!"  et agita la main: <br><br><img src="https://habrastorage.org/webt/3k/xc/_r/3kxc_rgde-t7q6yuhtvwkol5acs.png"><br><br>  La r√©plication est en cours d'ex√©cution.  La situation actuelle peut √™tre vue en utilisant la commande <code>pgrepup status</code> : <br><br><img src="https://habrastorage.org/webt/ig/gs/wb/iggswbqldii-c6cd5a1y7qyqawu.png"><br><br>  Ici, nous voyons que deux bases de donn√©es ont d√©j√† √©t√© d√©plac√©es et que la r√©plication est en cours et qu'une est toujours en cours de d√©placement.  Maintenant, il ne reste plus qu'√† boire du caf√© et attendre que tout le volume de la base de donn√©es d'origine soit pomp√©. <br><br>  En chemin, vous pouvez regarder plus profond√©ment dans la fa√ßade de pgrepup et voir ce qui se passe sous le capot.  Pour les esprits curieux, voici une liste de requ√™tes comme point de d√©part: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_replication_origin_status <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> remote_lsn <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_xlog_location_diff(s.sent_location,s.replay_location) byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> application_name=<span class="hljs-string"><span class="hljs-string">'subscription_copy'</span></span></code> </pre> <br>  Avoir beaucoup de caf√© (sur le serveur de test lors de la r√©daction de cet article, la migration de ~ 700 Go de donn√©es a dur√© environ une journ√©e), nous voyons enfin l'image suivante: <br><br><img src="https://habrastorage.org/webt/ep/2e/q2/ep2eq2c_mtywxboftk4ocb0e_1c.png"><br><br>  Et cela signifie qu'il est temps de pr√©parer un nouvel esclave. <br><br><h3>  Installer PostgreSQL 11 sur Slave </h3><br>  Ici tout est simple et selon le manuel, pas de nuances. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #  postgresql 11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #      su - postgres pg_basebackup -h db-master.hostname -p 15432 -D /var/lib/pgsql/11/data/ -R -P -U replication -X stream -c fast</span></span></code> </pre> <br>  Copiez les param√®tres d'acc√®s ( <b>pg_hba.conf</b> ) et les param√®tres du serveur ( <b>postgresql.conf</b> ) de 9,6 √† 11. Dans la configuration de la version <b>postgresql.conf</b> 11, changez le port en 15432 (port = 15432) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br><pre> <code class="pgsql hljs">#     Master <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; #     Slave <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> now()-pg_last_xact_replay_timestamp();</code> </pre><br><h3>  Sous-totaux </h3><br>  Apr√®s toutes ces proc√©dures, nous obtenons ce sch√©ma de r√©plication d√©licat: <br><br><img src="https://habrastorage.org/webt/70/ns/ej/70nsejcslxlccih_yktvesptqjg.png"><br><br>  Ici, comme derni√®re v√©rification (et, au final, c'est tout simplement magnifique), vous pouvez effectuer une MISE √Ä JOUR dans la base de donn√©es 9.6 Master et voir comment elle est r√©pliqu√©e sur les trois autres serveurs. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/c42/89e/7c0c4289e8a00b100f58ce751bd9209e.png" alt="image"><br><br><h3>  Passer de l'application √† la nouvelle version de PostgreSQL </h3><br>  Jusqu'√† pr√©sent, notre application n'a rien suspect√© de la nouvelle version de PostgreSQL, il est temps de la corriger.  Les options ici d√©pendent fondamentalement de seulement deux choses: <br>  Allez-vous l'emporter sur les nouveaux services sur les m√™mes ports sur lesquels les anciens fonctionnaient, <br>  et si votre application n√©cessite un red√©marrage lors du red√©marrage du serveur de base de donn√©es. <br><br>  Pour le plaisir, nous r√©pondrons ¬´oui¬ª aux deux questions et continuerons. <br><br>  Nous arr√™tons l'application. <br><br><pre> <code class="pgsql hljs"># ,   , : <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity;</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    #       sequences. pgrepup stop</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/cz/hc/2t/czhc2t8k6pjk-6ivvilidj5k9xq.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      pgrepup uninstall</span></span></code> </pre><br><img src="https://habrastorage.org/webt/2w/ud/dq/2wuddqovqbninwwz9rx9fia8psa.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  master: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11 #  slave: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11</span></span></code> </pre> <br>  Nous renvoyons le port standard dans la configuration <b>postgresql.conf</b> de la nouvelle version √† Master et Slave. <br><br>  Sur le nouvel esclave, nous changeons √©galement le port en celui standard dans <b>recovery.conf</b> . <br><br>  En cours de route, il y a une suggestion de sin pour changer davantage le port sur l'ancienne version qui devient inactive: <br>  Nous exposons le port non standard dans <b>postgresql.conf de l'</b> ancienne version √† Master et Slave. <br>  Sur l'ancien esclave, nous changeons √©galement le port en un port non standard dans <b>recovery.conf</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   master systemctl enable postgresql-11 systemctl start postgresql-11 #   slave: systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  V√©rifiez les journaux. <br><br>  V√©rifiez l'√©tat de la r√©plication sur le ma√Ætre. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s;</code> </pre> <br>  Nous lan√ßons l'application.  Nous sommes heureux pendant une demi-heure. <br><br>  <b>Et enfin, une litt√©rature utile sur le sujet:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Instructions d'installation pour pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mise √† niveau de PostgreSQL de 9.4 √† 10.3 avec pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pgrepup - mettre √† niveau PostgreSQL en utilisant la r√©plication logique</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pgrepup - PostgreSQL REPlicate et UPgrade</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mise √† niveau de PostgreSQL de 9.6 √† 10 avec un temps d'arr√™t minimal √† l'aide de pglogical</a> </li></ul><br>  Bonne chance! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437318/">https://habr.com/ru/post/fr437318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437308/index.html">Cycle de le√ßon SDL 2.0: Le√ßon 4 - Gestion des √©v√©nements</a></li>
<li><a href="../fr437310/index.html">Bordures de d√©grad√© CSS</a></li>
<li><a href="../fr437312/index.html">Impl√©mentation d'un rechargement √† chaud du code C ++ sur Linux et macOS: creuser plus profond√©ment</a></li>
<li><a href="../fr437314/index.html">Enigma italienne: machines cryptographiques OMI</a></li>
<li><a href="../fr437316/index.html">L'Internet Development Institute a nomm√© des sites qui pourraient √™tre d√©connect√©s sur RuNet depuis le 1er f√©vrier</a></li>
<li><a href="../fr437320/index.html">Indice de d√©veloppement de la sph√®re des m√©dias 2018: stagnation de la t√©l√©vision, confiance accrue dans les m√©dias informels</a></li>
<li><a href="../fr437322/index.html">L'√âtat est engag√© dans BigDate</a></li>
<li><a href="../fr437324/index.html">Baiser sanglant: propri√©t√©s de vasorelaxation de la salive des chauves-souris vampires</a></li>
<li><a href="../fr437326/index.html">Sur la question de la multiplication, de l'extraction des racines carr√©es, de la substitution des importations et de l'entreprise Milander</a></li>
<li><a href="../fr437330/index.html">devleads - parle de burnout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>