<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏽 🕜 🤜🏼 Kubernetes冒险Dailymotion：在云端+内部部署基础设施 🕺 🏂🏼 🥀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注意事项 佩雷夫 ：Dailymotion是全球最大的视频托管服务之一，因此是著名的Kubernetes用户。 在本文中，系统架构师David Donchez分享了为公司创建基于K8s的生产平台的结果，该平台首先在GKE中安装了云，然后以混合解决方案结束，从而可以缩短响应时间并节省基础架构成本。 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes冒险Dailymotion：在云端+内部部署基础设施</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/460877/"><img src="https://habrastorage.org/webt/2w/sg/pd/2wsgpd04mceffldc5shv-aomsyw.png"><br><br>  <i><b>注意事项</b></i>  <i><b>佩雷夫</b></i>  <i>：Dailymotion是全球最大的视频托管服务之一，因此是著名的Kubernetes用户。</i>  <i>在本文中，系统架构师David Donchez分享了为公司创建基于K8s的生产平台的结果，该平台首先在GKE中安装了云，然后以混合解决方案结束，从而可以缩短响应时间并节省基础架构成本。</i> <br><br> 三年前决定重建核心的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Dailymotion</a> API时，我们希望开发一种更有效的方式来托管应用程序并简化<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">开发和生产过程</a> 。 为此，我们决定使用容器编排平台，并自然选择了Kubernetes。 <br><br> 为什么值得创建自己的基于Kubernetes的平台？ <a name="habracut"></a><br><br><h2> 尽快使用Google Cloud进行生产级API </h2><br><blockquote>  2016年夏季 </blockquote><br> 三年前，在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">维旺迪（Vivendi）</a>收购Dailymotion之后，我们的工程团队专注于一个全球目标：创造一款全新的Dailymotion产品。 <br><br> 基于对容器，业务流程解决方案的分析以及我们过去的经验，我们确保Kubernetes是正确的选择。 一些开发人员已经对基本概念有所了解，并且知道如何使用它，这对于基础结构转换具有巨大的优势。 <br><br> 从基础架构的角度来看，需要一种功能强大且灵活的系统来托管新型的云原生应用程序。 我们选择在旅途的开始阶段留在云中，以便从容构建最可靠的本地平台。 他们决定使用Google Kubernetes Engine部署应用程序，尽管他们知道我们迟早会切换到自己的数据中心并采用混合策略。 <br><br><h3> 为什么选择GKE？ </h3><br> 我们之所以做出此选择，主要是出于技术原因。 此外，有必要快速提供满足公司业务需求的基础架构。 我们有一些应用程序需求，例如地理分布，可伸缩性和容错能力。 <br><br><img src="https://habrastorage.org/webt/xu/s7/oj/xus7oj23f2icpor8zqehfbuqe3u.png"><br>  <i>Dailymotion中的GKE集群</i> <br><br> 由于Dailymotion是全球可用的视频平台，因此我们确实希望通过减少<i>延迟</i>来提高服务质量。 以前， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们的API</a>仅在巴黎可用，这不是最佳选择。 我希望不仅可以在欧洲，而且可以在亚洲和美国托管应用程序。 <br><br> 这种对延迟的敏感性意味着我们将不得不认真研究平台的网络架构。 大多数云服务迫使他们在每个区域中创建自己的网络，然后通过VPN或某个托管服务将它们连接起来，而Google Cloud使创建覆盖Google所有区域的完全可路由的统一网络成为可能。 就操作和系统效率而言，这是一大优势。 <br><br> 此外，Google Cloud的网络服务和负载平衡器也表现出色。 它们仅允许您使用每个区域中的任意公共IP地址，出色的BGP协议负责其余部分（即，将用户重定向到最近的群集）。 显然，如果发生故障，流量将自动流向另一个区域，而无需任何人工干预。 <br><br><img src="https://habrastorage.org/webt/ki/nu/lm/kinulmtbiqjzg7n9lnrz0bvqz58.png"><br>  <i>Google负载平衡监控</i> <br><br> 我们的平台还积极使用图形处理器。  Google Cloud使在Kubernetes集群中直接使用它们非常高效。 <br><br> 那时，基础架构团队主要集中在物理服务器上部署的旧堆栈上。 这就是使用托管服务（包括Kubernetes主组件）满足我们的要求并允许我们培训团队使用本地集群的原因。 <br><br> 结果，我们在工作开始后仅6个月便开始接受Google Cloud基础架构上的生产流量。 <br><br> 但是，尽管有许多优势，但与云提供商合作会带来一定的成本，成本可能会根据负载而增加。 因此，我们仔细分析了每个使用的托管服务，希望将来在本地实现它们。 实际上，本地集群的引入始于2016年底，同时启动了混合策略。 <br><br><h2> 启动Dailymotion本地容器编排平台 </h2><br><blockquote>  2016年秋季 </blockquote><br> 在整个堆栈准备好生产并且API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">仍在继续</a>工作的情况下，有时间集中精力于区域集群。 <br><br> 当时，用户每月观看超过30亿个视频。 当然，多年来，我们一直在运营自己的分支内容交付网络。 我们想利用这种情况，在现有数据中心中部署Kubernetes集群。 <br><br>  Dailymotion基础架构在六个数据中心内总计有超过2.5千台服务器。 所有都使用Saltstack进行配置。 我们开始准备用于创建主节点和工作节点以及etcd集群的所有必要配方。 <br><br><img src="https://habrastorage.org/webt/ba/kx/76/bakx76nb_2zroyhn5jrko3ewqec.jpeg"><br><br><h3> 网络部分 </h3><br> 我们的网络是完全可路由的。 每个服务器使用Exabgp在网络上宣布其IP。 我们比较了几种网络插件，而<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Calico</a>是满足所有需求的唯一插件（由于L3级别使用的方法）。 它完全适合现有的网络基础架构模型。 <br><br> 因为我想使用所有可用的基础架构元素，所以首先，我不得不处理我们自己开发的网络实用程序（用于所有服务器）：使用它来宣布具有Kubernetes节点的网络上的IP地址范围。 我们允许Calico为Pod分配IP地址，但未使用它，也仍未将其用于网络设备上的BGP会话。 实际上，路由是由Exabgp处理的，Exabgp宣布了Calico使用的子网。 这使我们可以从内部网络（尤其是从负载平衡器）连接到任何Pod。 <br><br><h3> 我们如何管理入口流量 </h3><br> 要将传入的请求重定向到所需的服务，由于它与Kubernetes入口资源集成在一起，因此决定使用入口控制器。 <br><br> 三年前，nginx-ingress-controller是最成熟的控制器：Nginx已经使用了很长时间，并且以其稳定性和性能而闻名。 <br><br> 在我们的系统中，我们决定将控制器放置在专用的10 Gb刀片服务器上。 每个控制器都连接到相应集群的kube-apiserver的端点。 这些服务器还使用Exabgp来宣布公共或私有IP地址。 我们网络的拓扑结构使我们可以使用这些控制器中的BGP将所有流量直接路由到Pod，而无需使用NodePort之类的服务。 这种方法有助于避免节点之间的水平通信并提高效率。 <br><br><img src="https://habrastorage.org/webt/1i/_w/vj/1i_wvjnlyr5ayfbsohwwf_nl1hc.png"><br>  <i>流量从Internet到Pod的移动</i> <br><br> 既然您已经了解了我们的混合平台，就可以深入研究流量迁移的过程。 <br><br><h2> 将流量从Google Cloud迁移到Dailymotion基础架构 </h2><br><blockquote>  2018年秋季 </blockquote><br> 经过近两年的创建，测试和配置，我们终于获得了完整的Kubernetes堆栈，准备接收一些流量。 <br><br><img src="https://habrastorage.org/webt/8x/vo/cw/8xvocwrmmroc6lkjbs8gyhggqy8.jpeg"><br><br> 当前的路由策略非常简单，但是可以满足需求。 除了公共IP（在Google Cloud和Dailymotion中）之外，AWS Route 53还用于设置策略并将用户重定向到我们选择的集群。 <br><br><img src="https://habrastorage.org/webt/g4/zi/xs/g4zixslqqh52usdkl3hrthlazs8.png"><br>  <i>使用路由53的示例路由策略</i> <br><br> 使用Google Cloud，这很容易，因为我们对所有群集使用一个IP，并将用户重定向到最近的GKE群集。 对于我们的集群来说，技术是不同的，因为它们的IP是不同的。 <br><br> 在迁移期间，我们试图将区域请求重定向到各个集群，并评估了这种方法的优势。 <br><br> 由于我们的GKE群集配置为使用自定义指标自动扩展，因此它们会根据传入流量增加/减少容量。 <br><br> 在正常模式下，所有区域流量都会路由到本地集群，GKE会在出现问题时用作备用（运行状况检查由Route 53进行）。 <br><br><h2>  ... </h2><br> 将来，我们希望使路由策略完全自动化，以获得一种能够不断提高用户可访问性的自主混合策略。 至于优点：云的成本大大降低，甚至可以减少API的响应时间。 我们相信最终的云平台，并准备在必要时将更多流量重定向到该平台。 <br><br><h2> 译者的PS </h2><br> 您可能也对最近有关Daily Kubernetes的Dailymotion出版物感兴趣。 它专门用于将Helm应用程序部署到许多Kubernetes集群上，大约一个月前发布。 <br><br> 另请参阅我们的博客： <br><br><ul><li>  “将<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Tinder切换到Kubernetes</a> 。” </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第10部分：</a> “ </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第9部分： <b>欧洲核子研究组织（CERN）和210个K8s机群</b></a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第八部分： <b>华为</b></a> “； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第7部分： <b>BlackRock</b></a> “； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第6部分：“ <b>BlaBlaCar</b></a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第5部分：“ <b>Monzo Digital Bank</b></a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第4部分： <b>SoundCloud（作者Prometheus）</b></a> </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分： <b>GitHub</b></a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分： <b>同意和SAP</b></a> “; </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes在生产中的成功案例。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分： <b>在eBay上有4,200个炉膛和TessMaster</b></a> 。” </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460877/">https://habr.com/ru/post/zh-CN460877/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460865/index.html">月亮上的人。 资料来源</a></li>
<li><a href="../zh-CN460867/index.html">Sourcery自动转换为Realm对象结构</a></li>
<li><a href="../zh-CN460869/index.html">使用YOLOv3在iOS上进行实时对象识别</a></li>
<li><a href="../zh-CN460873/index.html">为什么选择《 Turok：N64的恐龙猎人》比它的时代要早几年</a></li>
<li><a href="../zh-CN460875/index.html">QIWI的我们如何看待MVVM中View和ViewModel之间的通用交互方式</a></li>
<li><a href="../zh-CN460879/index.html">DUMP喀山2019-tar斯坦开发者大会。 我们接受报告申请</a></li>
<li><a href="../zh-CN460881/index.html">在DLP系统中应用OCR技术的困难，或者我们如何准备OCR</a></li>
<li><a href="../zh-CN460883/index.html">关于不断变化的需求和小功能的好处世界中的生活</a></li>
<li><a href="../zh-CN460885/index.html">根据Plesk在HighLoad ++ Siberia 2019上的有趣报告</a></li>
<li><a href="../zh-CN460887/index.html">没有其他编程语言。 第三部分：物理</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>