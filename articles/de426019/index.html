<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🎤 🐞 🙎🏻 Wetterstation auf Arduino von A bis Z. Teil 5 🥋 ➖ 👨🏻‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Ende. Der vorherige Teil . 


 Inhaltsverzeichnis: 


- Teil 1. Anforderungen. Die Wahl des Eisens. Allgemeines Schema 
- Teil 2. Software. Zentra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wetterstation auf Arduino von A bis Z. Teil 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p>  Das Ende.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Der vorherige Teil</a> . </p><br><p>  Inhaltsverzeichnis: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1. Anforderungen.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Wahl des Eisens.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Allgemeines Schema</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2. Software.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zentraleinheit, Eisen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3. Zentraleinheit, Software</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 4. Fenstersensor</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Außenborder Sensor.  Software </h1><br><p>  Sprechen Sie über die Software für den Übersee-Sensor.  Danach erhalten Sie ein komplettes System, mit dem Sie bereits experimentieren können. </p><br><p>  Ich möchte Sie daran erinnern, dass der <em>Server</em> eine zentrale Heimeinheit ist, die über WLAN mit dem Internet kommunizieren kann, und der <em>Client</em> ein sofort einsatzbereiter Remote-Sensor ist, der Daten drahtlos an den Server überträgt. </p><br><p> Der Quellcode für den Server und den Client <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ist hier</a> . <br>  Die Ausgangstexte werden mit detaillierten Kommentaren versehen. </p><br><p>  Auf dem Client muss fast nichts konfiguriert werden. </p><a name="habracut"></a><br><p>  Für den Funksender nRF24L01 +, genauer gesagt für die RadioHead-Bibliothek, müssen die Server- und Client-Adressen angegeben werden.  Adressen werden angegeben, wenn Sie mehr als einen Server und einen Client haben.  Eine Adresse ist nur eine beliebige Ganzzahl.  Wenn ein Client ein Datenpaket an einen Server sendet, gibt er an, für welchen Server dieses Paket bestimmt ist.  Der Server, der seine eigene Adresse kennt, bestimmt wiederum, ob dieses Paket für ihn bestimmt ist. </p><br><p> Daher sollte <code>SERVER_ADDRESS</code> auf dem Server und auf dem Client identisch sein, <code>CLIENT_ADDRESS</code> für verschiedene Clients sollte jedoch unterschiedlich sein.  Mit anderen Worten, wenn Sie in Zukunft einen weiteren neuen Sensor an unser System anschließen, muss <code>CLIENT_ADDRESS</code> dafür geändert werden. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  Die <code>RF_CHANNEL</code> -Funkkanalnummer muss für alle gleich sein.  Standardmäßig ist es 2. Ich habe die Standardnummer geändert, Sie können jede andere auswählen. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  Die Voltmetereinstellungen zur Messung der Batterieversorgungsspannung müssen geändert werden: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  Um Energie zu sparen, wird die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lightweight Low Power Library für Arduino verwendet</a> . </p><br><p>  Hier sind meine tatsächlichen Verbrauchsmessungen für den Arduino Pro Mini mit dieser Bibliothek: </p><br><ul><li>  normalerweise 25mA </li><li>  bei der Arbeit mit DHT das gleiche </li><li>  mit Funkübertragung 38 mA </li><li>  bei LowPower.idle 15 mA </li><li>  bei LowPower.powerdown 7,5 mA </li></ul><br><p>  Der Client misst Temperatur, Luftfeuchtigkeit und Versorgungsspannung, packt dies alles in eine Datenstruktur, sendet die Daten an den Server und „schläft ein“.  Wenn während der Übertragung Fehler aufgetreten sind, wird die Übertragung sofort wiederholt. </p><br><p>  Der Server (Zentraleinheit, Heimeinheit) empfängt wiederum Daten, bestätigt den Empfang und verarbeitet sie. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Datenbank, MySQL, PHP, WWW-Server </h1><br><p>  Nach der Arbeit haben wir ein voll funktionsfähiges Design der Wetterstation.  Aber jetzt gibt es ein Dutzend solcher Wetterstationen, lokales Handwerk ist nicht mehr in Mode.  Immerhin haben wir ein Internet der Dinge. </p><br><p>  Daher werden wir darüber sprechen, wie der Zugriff auf diese Ihr Internet erfolgt, wir werden eine Datenbank und ein Webface an unsere Wetterstation anhängen. </p><br><p>  Die Problemstellung für die "Webcam": </p><br><ul><li>  Empfangen und Speichern von Wetterstationsdaten: Temperatur, Luftfeuchtigkeit, Luftdruck, Versorgungsspannung </li><li>  Zeigen Sie diese Daten an </li><li>  Diagramme erstellen. </li></ul><br><p>  In diesem Fall benötigen wir Hosting mit Unterstützung für Apache, PHP und MySQL mit dem mysqli-Modul.  Und diese Bedingungen werden von fast jedem Hosting auf dem Planeten Erde erfüllt.  Anstatt zu hosten, spielt Ihr Computer die Rolle eines Servers, der mit einem Heimnetzwerk-Router verbunden ist und über einen Internetzugang verfügt. </p><br><h2 id="sozdanie-bazy-dannyh">  Datenbankerstellung </h2><br><p>  Beginnen wir von vorne, nämlich mit dem Entwurf und der Erstellung der Datenbank. </p><br><p>  Datenbanken sind Ihre Welt, und Sie können sie lange studieren. Wir werden daher nur kurz auf die Dinge eingehen, die wir direkt benötigen. </p><br><p>  Alle SQL-Skripte befinden sich im Verzeichnis <code>weather-station/server/php-sql/</code> </p><br><p>  Wo beginnt das Datenbankdesign?  Mit einer logischen und physischen Darstellung. </p><br><p>  Logische Ansicht oder Datenbankschema: </p><br><ul><li>  DHT-Temperatur- und Luftfeuchtigkeitstabelle </li><li>  BMP-Datentabelle des Druck- und Temperatursensors </li><li>  Die angegebenen Tabellen haben keine Beziehung zueinander, genauer gesagt, die Links werden nicht benötigt. </li></ul><br><p>  Das physische Schema basiert auf einem bestimmten DBMS und Datentypen.  Es ist einfacher, mit einem bestimmten Beispiel zu zerlegen.  Das SQL-Skript <code>make_tables.sql</code> die logischen und physischen Schemas. </p><br><p>  Jede Tabelle sollte ein Typfeld haben </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  Der Feldname kann in verschiedenen Datenbanken unterschiedlich sein, aber es gibt nur einen Sinn - dies ist eine eindeutige Kennung, ein Datensatzschlüssel.  Wenn Sie für die Zukunft eine Datenbank in Tabellen sehen, die keinen solchen Zähler haben, sollten Sie wissen, dass diese Datenbank von einer Person entworfen wurde, die weit von der Programmierung entfernt ist, höchstwahrscheinlich von den Geisteswissenschaften. </p><br><p>  Wir speichern die Daten von Sensoren desselben Typs in einer Tabelle, für Sensoren eines anderen Typs erstellen wir eine andere Tabelle.  Dies verkompliziert die Datenbank- und PHP-Bindung geringfügig, vereinfacht jedoch in Zukunft die Erweiterung oder Änderung des gesamten Systems. </p><br><p>  In unserem Projekt gibt es zwei Tabellen.  Die Tabelle <code>arduino_dht</code> speichert Daten von den Sensoren des Typs DHT (Temperatur, Luftfeuchtigkeit), die Tabelle <code>arduino_bmp</code> speichert Daten von den Sensoren des Typs BMP (Temperatur, Druck).  Wenn Sie in Zukunft beispielsweise einen Gassensor oder einen Bewegungsmelder haben möchten, erstellen Sie zusätzliche Tabellen. Seien Sie nicht faul.  Wenn Sie einen anderen Sensor vom Typ DHT11 oder DHT22 anschließen, müssen Sie keine zusätzliche Tabelle erstellen. Verwenden Sie die Tabelle <code>arduino_dht</code> .  Ich hoffe, das Prinzip ist klar: Eine separate physische Einheit ist eine separate Tabelle. </p><br><p>  Wenn Daten von mehreren Sensoren desselben Typs in einer Tabelle gespeichert werden, wie können sie dann unterschieden werden?  Geben Sie dazu in jede Tabelle ein Feld ein </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  Tatsächlich ist es <code>CLIENT_ADDRESS</code> das wir in der <code>client/client.ino</code> für jede Instanz des Remote-Client-Clients und in <code>server/server.ino</code> für den Sensor <code>server/server.ino</code> der direkt mit dem Server verbunden ist - der Zentraleinheit. </p><br><p>  In industriellen Systemen sollte es eine andere Tabelle geben - die Entsprechung von <code>idSensor</code> und seine verbale, für Menschen lesbare Beschreibung.  Ein Sensor mit <code>idSensor</code> = 2 lautet beispielsweise <em>"Temperatur, Luftfeuchtigkeit in der Wohnung"</em> usw.  Aber in unserem Projekt werden wir nicht komplizieren, denken Sie daran: </p><br><ul><li>  ein Sensor mit <code>idSensor</code> , es ist <code>CLIENT_ADDRESS</code> , gleich 11 - dies ist der <code>CLIENT_ADDRESS</code> auf dem Server - die Zentraleinheit, </li><li>  Als Sensor mit <code>idSensor</code> ist es auch <code>CLIENT_ADDRESS</code> , gleich 20 - dies ist der erste (in unserem Projekt und der einzige) fensterbasierte Sensor-Client. </li></ul><br><p>  Weiter.  In den Tabellen werden folgende Daten gespeichert: </p><br><ul><li>  ipRemote - IP-Adresse der Wetterstation (Server), von der die Daten stammen, nützlich zum Debuggen und Überwachen, </li><li>  dateCreate - Datum, an dem der Datensatz erstellt wurde. </li><li>  Millis - nützlich für das Debuggen. Dies ist die Zeit in Millisekunden seit dem Beginn der Skizze auf dem Arduino. </li><li>  Temperatur - Temperatur </li><li>  Luftfeuchtigkeit - Luftfeuchtigkeit </li><li>  Spannung - Versorgungsspannung, </li><li>  Druck - Druck </li><li>  Fehler - die Anzahl der Fehler (nicht verwendet).  Es war beabsichtigt, die Anzahl der Übertragungsfehler usw. zu speichern, damit Sie den Status des gesamten Systems aus der Ferne bewerten können. </li></ul><br><p>  Wie Sie sehen können, sind die <code>arduino_bmp</code> <code>arduino_dht</code> und <code>arduino_bmp</code> sehr ähnlich, der Unterschied besteht nur in den Feldern Druck und Luftfeuchtigkeit, und es besteht der Wunsch, alles in einem Heap (Tabelle) <code>arduino_bmp</code> .  Aber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erste normale Form</a> befiehlt dies nicht, viele anfängliche Programmierer haben versucht, es zu umgehen, aber keiner von ihnen hat es geschafft, und wir werden es nicht tun.  Auf diese Weise kann man das Gesetz der universellen Gravitation nicht beachten, da es sich vorerst durchaus herausstellen kann. </p><br><p>  Die Tabelle <code>arduino_error_log</code> nützlich zum Debuggen - sie ist ein Protokoll von Fehlern und anderen Systemmeldungen. </p><br><p>  Das Erstellen einer Datenbank und ihres Benutzers mit Rechten wird in <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  Dies geschieht einmal, der Datenbankname und der Benutzername können sich einen eigenen einfallen lassen.  Und was genau getan werden muss, ist Ihr Passwort festzulegen. </p><br><h2 id="php-i-veb-server">  PHP und Webserver </h2><br><p>  Alle Webinterface-Einstellungen werden in <code>config.php</code> gespeichert.  Ändern Sie es entsprechend Ihren Datenbankeinstellungen. </p><br><p>  Stellen Sie Ihre Zeitzone im PHP-Format ein </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Alle verfügbaren <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zeitzonen werden hier beschrieben</a> . </p><br><p>  Legen Sie Ihren geheimen Schlüssel für den Zugriff (als Nummer) fest, der mit der Konstante <code>SOURCE_KEY</code> aus der Skizze <code>server.ino</code> </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  In unserem Webserver gibt es keine Autorisierung, Passworteingabe, dies würde das gesamte Design komplizieren.  Für einen Prototyp ist dies nicht erforderlich.  Daher basiert der gesamte Schutz auf der Datei <code>robots.txt</code> , dem Fehlen von <code>index.php</code> und diesem geheimen Schlüssel für den Zugriff. </p><br><p>  Das PHP-Hauptskript <code>weather.php</code> akzeptiert eine einfache HTTP-GET-Anforderung mit Daten und speichert sie in den entsprechenden Datenbanktabellen.  Wenn der Schlüssel <code>$access_key</code> nicht übereinstimmt, wird die Anforderung abgelehnt. </p><br><p>  Das <code>weather-view.php</code> zum Anzeigen von Datentabellen verwendet und enthält Hyperlinks zu anderen Skripten der Weboberfläche.  Nenn ihn so </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  Zum Beispiel </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> zeigt einfache Beschriftungen an, an die Sie sich erinnern müssen: </p><br><ul><li>  Der Sensor mit der ID 11 ist der Heimsensor auf dem Server. </li><li>  Der Sensor mit der ID 20 ist ein Fenstersensor. </li></ul><br><p>  Das Skript <code>function.php</code> enthält Funktionen, die allen PHP-Skripten gemeinsam sind. </p><br><p>  Das <code>chart-dht.php</code> ist für das Charting mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google Charts verantwortlich</a> .  Hier ist zum Beispiel ein Diagramm der Versorgungsspannung des Überseesensors.  Die Spannung steigt an einem sonnigen Tag aufgrund der Solarbatterie an, und dann entlädt sich die Stromversorgung der Batterien allmählich. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Grafik"></p><br><p>  <code>export-dht.php</code> exportiert Daten aus MySQL-Datenbanktabellen in eine CSV-Datei.  Zum weiteren Importieren und Analysieren in Tabellenkalkulationen. </p><br><p>  <code>export-voltage.php</code> exportiert Daten zur Versorgungsspannung vom Fenstersensor aus der MySQL-Datenbank in eine CSV-Datei.  Nützlich zum Debuggen. </p><br><p>  <code>truncate.php</code> löscht alle Tabellen, d.h.  löscht alle unsere Daten.  Nützlich zum Debuggen.  Es gibt keine Links zu diesem Skript von <code>weather-view.php</code> , daher müssen Sie es über einen direkten Link in der Adressleiste Ihres Browsers mit <code>$access_key</code> . </p><br><p>  Beim Empfang von Daten wird häufig die Funktion <code>mysqli_real_escape_string()</code> verwendet, um zu verhindern, dass falsche Werte in die Datenbank gelangen. </p><br><p>  Vergessen Sie nicht, <code>robots.txt</code> im Stammverzeichnis Ihrer Website zu platzieren, um zu verhindern, dass es in Suchmaschinen gelangt. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi und Datenübertragung </h1><br><p>  Und jetzt zurück zur <code>server.ino</code> Skizze, zu dem Teil davon, der eine Verbindung zum WiFi-Zugangspunkt herstellt und Daten an den Webserver sendet. </p><br><p>  Wie ich bereits schrieb, konnte ich keine normale Bibliothek für Arduino finden, um das ESP8266-Modul mit AT-Befehlen zu steuern. Ich musste mich selbst "kollektiv bewirtschaften".  Ich möchte Sie auch daran erinnern, dass Sie eine bestimmte Firmware-Version in ESP8266-01 flashen müssen.  Und jetzt, wenn alles fertig ist, wollen wir sehen, wie es funktioniert. </p><br><p>  Um auf den Webserver in der <code>server.ino</code> Skizze <code>server.ino</code> , müssen <code>server.ino</code> diese Konstanten ändern </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p>  In <code>server.ino</code> in der Funktion <code>void setup()</code> der ESP8266 zuerst in den Stationsmodus geschaltet, d. H.  Es beginnt als WiFi-Client zu arbeiten </p><br><pre> <code class="hljs lisp">espSendCmd(«AT+CWMODE_CUR=1», «OK», <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  und folgt dann der Verbindung zum Zugangspunkt </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Wenn die Verbindung nicht hergestellt wird, wird der Versuch (einmal) wiederholt. </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Wählen Sie dann den TCP / IP-Einzelverbindungsmodus </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Beim Senden von Daten von Sensoren vom Typ DHT an den Webserver wird eine Funktion verwendet, die den Datentyp als <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Beim Senden von Daten von BMP-Sensoren an einen Webserver wird dieselbe Funktion mit dem als <code>type=bmp</code> angegebenen Datentyp verwendet </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Die Funktion <code>espSendData()</code> akzeptiert eine HTTP-GET-Anforderungszeichenfolge und sendet sie wie beabsichtigt an den Webserver. </p><br><p>  In sich selbst überprüft <code>espSendData()</code> die Verfügbarkeit des ESP-Moduls, indem es den Befehl „AT“ sendet. Anschließend überprüft es die WiFi-Verbindung und stellt bei Bedarf erneut eine Verbindung her.  Dann werden die Daten gesendet und die TCP-Verbindung geschlossen. </p><br><h1 id="android-prilozhenie">  Android App </h1><br><p>  Wenn heutzutage jeder eine LED blinken kann, werden Sie niemanden mit einer Wetterstation überraschen.  Aber wenn das Handwerk weiß, wie man über WLAN mit dem Server kommuniziert, ein Webface und eine mobile Anwendung hat, dann ist dies etwas!  Mit Server meinen wir hier natürlich den Anwendungsserver, d.h.  In unserem Fall ist dies eine PHP-Bindung und ein MySQL-DBMS.  Es gibt nicht genug Kirschen auf dem Kuchen, nämlich die Android-Anwendung, die wir jetzt schreiben werden. </p><br><h2 id="arhitektura">  Architektur </h2><br><p>  Die Architektur der gesamten Wetterstationssoftwareplattform ist einfach: </p><br><ul><li>  Der Serverteil (Zentraleinheit) der Wetterstation sammelt Daten von Remote-Sensor-Clients </li><li>  Anschließend werden Daten an den Webserver von Anwendungen übertragen, der diese Daten in der Datenbank speichert </li><li>  Die Android-Anwendung (oder eine andere Remote-Anwendung: iOS, Browser) fordert Daten von einem Webserver an und zeigt sie auf dem Bildschirm an. </li></ul><br><p>  Auf dem Bildschirm des Android-Geräts werden die aktuellen und neuesten Sensorwerte angezeigt. </p><br><h2 id="http-get-i-json">  HTTP GET und JSON </h2><br><p>  Die Frage, die zuerst gelöst werden muss, ist, wie Daten vom Webserver zur Android-Anwendung übertragen werden. </p><br><p>  Hier muss nichts erfunden werden, alles wurde bereits für uns erfunden - das sind HTTP GET und JSON. </p><br><p>  In unserem Fall kann eine einfache GET-Anforderung an den Webserver manuell kompiliert und debuggt werden, während die Android-Anwendung noch nicht bereit ist. </p><br><p>  In Java und Android gibt es vorgefertigte Bibliotheken für die Verarbeitung von Daten im JSON-Format.  JSON ist ein für Menschen lesbares Textformat, das zum Debuggen nützlich ist. </p><br><p>  Erstellen Sie ein neues PHP-Skript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">last-data-to-json.php</a> auf dem Webserver, um aktuelle Daten von Wetterstationssensoren zu generieren. </p><br><p>  Skriptaufruf: </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  Dabei ist <code>&lt;access_key&gt;</code> , wie wir uns erinnern, der geheime Datenbankzugriffsschlüssel. </p><br><p>  Beispielantwort im JSON-Format: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  Es muss daran erinnert werden, dass wir 3 Sensoren haben.  Ihre ID und ihr Typ (DHT oder BMP) sind im gesamten Wetterstationscode fest codiert.  Diese Methode der Hardcore-Codierung ist ideologisch falsch, aber für einen kniegezeichneten Prototyp (bei dem eine schnelle und einfache Lösung erforderlich ist) ist dies ein vernünftiger Kompromiss. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  Das <code>last-data-to-json.php</code> entnimmt die neuesten Daten dieser heterogenen Sensoren aus der Datenbank und packt sie in das JSON-Format.  Die Auswahl der Daten aus der Datenbank „vom Ende“ erfolgt folgendermaßen: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Jetzt schreiben wir eine einfache Android-Anwendung, die JSON-Daten anfordert, empfängt, decodiert und Informationen auf dem Bildschirm anzeigt. </p><br><p>  Unsere Android-Anwendung wird so einfach wie möglich sein, nur das Wesentliche der Technologie.  Weiter um dieses "Skelett" wird es bereits möglich sein, verschiedene "Schönheiten" aufzuziehen. </p><br><p>  Hier ist ein Screenshot dessen, was dazu führen sollte </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  Wie Sie sehen können, ist die Benutzeroberfläche nur spartanisch, basierend auf LinearLayout, nichts weiter. </p><br><p>  Oben in der Textansicht werden die ID der Sensoren und ihre meteorologischen Daten angezeigt.  Die Schaltfläche Aktualisieren initiiert eine zweite Anforderung an den Webserver.  Weiter in EditText ist die einzige Programmeinstellung - dies ist die Anforderungs-URL im Formular </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  Was ist zu beachten? </p><br><p>  Fügen Sie im Manifest Leitungen hinzu, die das Internet ermöglichen und den Status der Netzwerkverbindung überprüfen: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Die Arbeit mit dem Netzwerk und das Empfangen von Daten von der Website ist wie folgt. </p><br><p>  Wir verwenden AsyncTask, um eine Hintergrundaufgabe zu erstellen, die vom Haupt-UI-Thread getrennt ist.  Diese Hintergrundaufgabe verwendet die Anforderungs-URL und verwendet sie zum Erstellen der <code>HttpURLConnection</code> . </p><br><p>  Nachdem die Verbindung hergestellt wurde, lädt AsyncTask den Inhalt der Webseite (JSON) als InputStream.  Als nächstes wird der InputStream in eine Zeichenfolge konvertiert, die mit JSONObject dekodiert und mit der Methode <code>onPostExecute()</code> in der Benutzeroberfläche angezeigt wird. </p><br><p>  Ändern Sie in MainActivity.java die URL in: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  Es wird standardmäßig verwendet, wenn Sie zum ersten Mal eine Android-Anwendung ausführen. </p><br><h2 id="epilog">  Nachwort </h2><br><p>  Nun, etwas hat schon funktioniert.  Dann können Sie etwas optimieren, etwas ersetzen, alles wegwerfen, aber auch etwas ausleihen. </p><br><p>  Ein separater großer Wundpunkt ist der <strong>Energieverbrauch</strong> .  Ich empfehle, Kommentare zu Beiträgen zu lesen, in denen es viele praktische Tipps gibt. </p><br><p>  <em>Bis ins Unendliche ... und darüber hinaus.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de426019/">https://habr.com/ru/post/de426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de426001/index.html">MIT-Kurs "Computer Systems Security". Vorlesung 11: Ur / Web-Programmiersprache, Teil 3</a></li>
<li><a href="../de426009/index.html">Epic Fail Resistance 1 oder Fox schlichen sich unbemerkt an. Testen von Anonymität und Sicherheit + VPN für den Benutzer</a></li>
<li><a href="../de426013/index.html">Karriere Steroide</a></li>
<li><a href="../de426015/index.html">Einsatz gesägter ziviler Drohnen für die professionelle geodätische Luftaufnahme des Gebiets</a></li>
<li><a href="../de426017/index.html">So reduzieren Sie die Anzahl der Tierversuche</a></li>
<li><a href="../de426021/index.html">libgdx und Gefühle</a></li>
<li><a href="../de426023/index.html">Offene Lektion "Virtuelles Labor bei Vagrant"</a></li>
<li><a href="../de426025/index.html">Verwenden offensiver Methoden zur Bereicherung der Bedrohungsintelligenz</a></li>
<li><a href="../de426027/index.html">Analyse von Amazon Cloud Services und Anlageportfolios</a></li>
<li><a href="../de426029/index.html">Gibst du auf und willst die Aufgabe beenden? So sieht eine effektive Entwicklerschulung aus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>