<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👨🏼 💔 🧜🏿 Editor de imágenes simple en VueJS 🛎️ ⏮️ 🎇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, tuve la oportunidad de escribir un servicio para una tienda en línea que ayudaría a hacer un pedido para imprimir mis fotos. 

 El serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Editor de imágenes simple en VueJS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417697/">  Recientemente, tuve la oportunidad de escribir un servicio para una tienda en línea que ayudaría a hacer un pedido para imprimir mis fotos. <br><br>  El servicio asumió un editor de imágenes "simple", cuya creación me gustaría compartir.  Y todo porque entre la abundancia de todo tipo de complementos no encontré la funcionalidad adecuada, además, los matices de las transformaciones CSS, de repente se convirtieron en una tarea muy trivial para mí. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/884/ce8/2b3/884ce82b3d7a7c04c28705fd678fa6aa.jpg" alt="imagen"><br><a name="habracut"></a><br><h3>  Las tareas principales: </h3><br><ol><li>  Posibilidad de subir imágenes desde su dispositivo, Google Drive e Instagram. </li><li>  Edición de imágenes: movimiento, rotación, reflexión horizontal y vertical, zoom, alineación automática de imágenes para llenar el área de recorte. </li></ol><br>  Si el tema resulta interesante, en la próxima publicación describiré en detalle la integración con Google Drive e Instagram en la parte de back-end de la aplicación, donde se utilizó la popular combinación NodeJS + Express. <br><br>  Para la organización de la interfaz, elegí el maravilloso marco Vue.  Solo porque me inspira después de Reacciones angulares y molestas.  Creo que no tiene sentido describir la arquitectura, las rutas y otros componentes, vayamos directamente al editor. <br><br>  Por cierto, la demostración del editor se puede pinchar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . <br><br>  Necesitaremos dos componentes: <br><br>  <b>Editar</b> : contendrá la lógica principal y los controles <br>  <b>Vista previa</b> : será responsable de mostrar la imagen <br><br><div class="spoiler">  <b class="spoiler_title">Edición de plantilla de componente:</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Edit</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Preview</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"preview"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:matrix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"matrix"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:image</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:transform</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transform"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">resized</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"areaResized"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">loaded</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"imageLoaded"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">moved</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"imageMoved"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"range"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"minZoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"maxZoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">step</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"any"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">change</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onZoomEnd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-model.number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transform.zoom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rotateMinus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Rotate left<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rotatePlus"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Rotate right<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flipY"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Flip horizontal<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flipX"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:disabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!imageReady"</span></span></span><span class="hljs-tag">&gt;</span></span>Flip vertical<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Edit</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  El componente Vista previa puede desencadenar 3 eventos: <br><br>  <i>cargado</i> - evento de carga de imagen <br>  <i>redimensionado</i> - evento de cambio de <i>tamaño de</i> ventana <br>  <i>movido</i> - evento de imagen en movimiento <br><br>  Parámetros: <br><br>  <i>imagen</i> - enlace de <i>imagen</i> <br>  <i>matriz</i> - matriz de transformación para transformar la propiedad CSS <br>  <i>transformar</i> - un objeto que describe la transformación <br><br>  Para controlar mejor la posición de la imagen, img tiene un posicionamiento absoluto, y la propiedad de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">origen de transformación</a> , el punto de referencia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">transformación</a> , se establece en el valor inicial "0 0", que corresponde al origen en la esquina superior izquierda de la imagen original (¡antes de la transformación!). <br><br>  El principal problema que encontré es que debe asegurarse de que el punto de origen de la transformación esté siempre en el centro del área de edición, de lo contrario, durante las transformaciones, la parte seleccionada de la imagen cambiará.  El uso de esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">matriz de transformación</a> ayuda a resolver este problema. <br><br><h3>  Edición de componentes </h3><br><div class="spoiler">  <b class="spoiler_title">Propiedades del componente Editar:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { Preview }, data () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">imageReady</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">imageRect</span></span>: {}, <span class="hljs-comment"><span class="hljs-comment">//   areaRect: {}, //   minZoom: 1, //   maxZoom: 1, //   //   transform: { center: { x: 0, y: 0, }, zoom: 1, rotate: 0, flip: false, flop: false, x: 0, y: 0 } } }, computed: { matrix() { let scaleX = this.transform.flop ? -this.transform.zoom : this.transform.zoom; let scaleY = this.transform.flip ? -this.transform.zoom : this.transform.zoom; let tx = this.transform.x; let ty = this.transform.y; const cos = Math.cos(this.transform.rotate * Math.PI / 180); const sin = Math.sin(this.transform.rotate * Math.PI / 180); let a = Math.round(cos)*scaleX; let b = Math.round(sin)*scaleX; let c = -Math.round(sin)*scaleY; let d = Math.round(cos)*scaleY; return { a, b, c, d, tx, ty }; } }, ... }</span></span></code> </pre><br></div></div><br>  El componente Vista previa nos pasa los valores de imageRect y areaRect, llamando a los métodos imageLoaded y areaResized, respectivamente, los objetos tienen la estructura: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">size</span></span>: { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-attr"><span class="hljs-attr">center</span></span>: { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> } }</code> </pre><br>  Los valores centrales se pueden calcular cada vez, pero es más fácil escribirlos una vez. <br><br>  La propiedad de matriz calculada es los mismos coeficientes de la matriz de transformación. <br><br>  La primera tarea que debe resolverse es centrar la imagen con una relación de aspecto arbitraria en el área de recorte, mientras que la imagen debe poder ajustarse completamente, las áreas sin rellenar (solo) arriba y abajo, o (solo) izquierda y derecha son aceptables.  Con cualquier transformación, esta condición debe mantenerse. <br><br>  En primer lugar, limitaremos los valores de zoom, para esto verificaremos la relación de aspecto, teniendo en cuenta la orientación de la imagen. <br><br><div class="spoiler">  <b class="spoiler_title">Métodos componentes</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> _setMinZoom(){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rotate = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c !== <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> horizontal = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.height &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.width; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> areaSize = (horizontal &amp;&amp; !rotate || !horizontal &amp;&amp; rotate) ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.width : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.height; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageSize = horizontal ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.width : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.imageRect.size.height; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom = areaSize/imageSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minZoom; }, _setMaxZoom(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.areaRect.size.width/config.image.minResolution; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.zoom = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxZoom; },</code> </pre><br></div></div><br>  Ahora pasemos a las transformaciones.  Para comenzar, describimos los reflejos, porque no cambian la región visible de la imagen. <br><br><div class="spoiler">  <b class="spoiler_title">Métodos componentes</b> <div class="spoiler_text"><pre> <code class="javascript hljs">flipX(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.b == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop; }, flipY(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.b == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix.c == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flop : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip = !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.flip; },</code> </pre><br></div></div><br>  Las transformaciones de zoom, rotación y desplazamiento ya requerirán ajustes de origen de transformación. <br><br><div class="spoiler">  <b class="spoiler_title">Métodos componentes</b> <div class="spoiler_text"><pre> <code class="javascript hljs">onZoomEnd(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, rotatePlus(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.rotate += <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._setMinZoom(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, rotateMinus(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.rotate -= <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._setMinZoom(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); }, imageMoved(translate){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._translate(); },</code> </pre><br></div></div><br>  Es el método <b>_translate el</b> responsable de todas las sutilezas de las transformaciones.  Se deben introducir dos sistemas de referencia.  El primero, llamémoslo cero, comienza en la esquina superior izquierda de la imagen, cuando multiplicamos las coordenadas por la matriz de transformación, vamos a otro sistema de coordenadas, lo llamamos local.  En este caso, podemos revertir la transición de local a cero al encontrar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">matriz de</a> transformación <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">inversa</a> . <br><br>  Resulta que necesitamos dos funciones. <br><br>  El primero es ir de cero al sistema local, el navegador realiza las mismas conversiones cuando especificamos la propiedad de transformación css. <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">matrix</span></span>(a, b, c, d, tx, ty); }</code> </pre><br>  El segundo: para encontrar las coordenadas originales de la imagen, que ya ha transformado las coordenadas. <br><br>  Es más conveniente escribir estas funciones utilizando métodos de una clase separada. <br><br><div class="spoiler">  <b class="spoiler_title">Transformar clase:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transform</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(center, matrix){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.init(center, matrix); } init(center, matrix){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(center) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.center = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({},center); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(matrix) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({},matrix); } getOrigins(current){ <span class="hljs-comment"><span class="hljs-comment">//     let tr = {x: current.x - this.center.x, y: current.y - this.center.y}; //         const det = 1/(this.matrix.a*this.matrix.d - this.matrix.c*this.matrix.b); const x = ( this.matrix.d*(tr.x - this.matrix.tx) - this.matrix.c*(tr.y - this.matrix.ty) ) * det + this.center.x; const y = (-this.matrix.b*(tr.x - this.matrix.tx) + this.matrix.a*(tr.y - this.matrix.ty) ) * det + this.center.y; return {x, y}; } translate(current){ //     const origin = {x: current.x - this.center.x, y: current.y - this.center.y}; //        let x = this.matrix.a*origin.x + this.matrix.c*origin.y + this.matrix.tx + this.center.x; let y = this.matrix.b*origin.x + this.matrix.d*origin.y + this.matrix.ty + this.center.y; return {x, y}; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">_ Método de traducción con comentarios detallados:</b> <div class="spoiler_text"><pre> <code class="javascript hljs">_translate(checkAlign = <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Transform(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transform.center, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.matrix); <span class="hljs-comment"><span class="hljs-comment">// , ,  ,       const newCenter = tr.getOrigins(this.areaRect.center); this.transform.center = newCenter; //      this.transform.x = this.areaRect.center.x - newCenter.x; this.transform.y = this.areaRect.center.y - newCenter.y; //   tr.init(this.transform.center, this.matrix); //        ,      let x0y0 = tr.translate({x: 0, y: 0}); let x1y1 = tr.translate({x: this.imageRect.size.width, y: this.imageRect.size.height}); //  (  )       let result = { left: x1y1.x - x0y0.x &gt; 0 ? x0y0.x : x1y1.x, top: x1y1.y - x0y0.y &gt; 0 ? x0y0.y : x1y1.y, width: Math.abs(x1y1.x - x0y0.x), height: Math.abs(x1y1.y - x0y0.y) }; //       ,   "" let rightOffset = this.areaRect.size.width - (result.left + result.width); let bottomOffset = this.areaRect.size.height - (result.top + result.height); let alignedCenter; //   if(this.areaRect.size.width - result.width &gt; 1){ //align center X alignedCenter = tr.getOrigins({x: result.left + result.width/2, y: this.areaRect.center.y}); }else{ //align left if(result.left &gt; 0){ alignedCenter = tr.getOrigins({x: result.left + this.areaRect.center.x, y: this.areaRect.center.y}); //align right }else if(rightOffset &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x - rightOffset, y: this.areaRect.center.y}); } } if(alignedCenter){ this.transform.center = alignedCenter; this.transform.x = this.areaRect.center.x - alignedCenter.x; this.transform.y = this.areaRect.center.y - alignedCenter.y; tr.init(this.transform.center, this.matrix); } //   if(this.areaRect.size.height - result.height &gt; 1){ //align center Y alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: result.top + result.height/2}); }else{ //align top if(result.top &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: result.top + this.areaRect.center.y}); //align bottom }else if(bottomOffset &gt; 0){ alignedCenter = tr.getOrigins({x: this.areaRect.center.x, y: this.areaRect.center.y - bottomOffset}); } } if(alignedCenter){ this.transform.center = alignedCenter; this.transform.x = this.areaRect.center.x - alignedCenter.x; this.transform.y = this.areaRect.center.y - alignedCenter.y; tr.init(this.transform.center, this.matrix); } },</span></span></code> </pre><br></div></div><br>  La alineación crea el efecto de "pegar" la imagen a los bordes del recorte, evitando campos vacíos. <br><br><h3>  Componente de vista previa </h3><br>  La tarea principal de este componente es mostrar la imagen, aplicar transformaciones y responder al movimiento del botón del mouse sobre la imagen.  Calculando el desplazamiento, actualizamos los parámetros <b>transform.x</b> y <b>transform.y</b> , al final del movimiento activamos el evento <b>movido</b> , diciéndole al componente Editar que necesitamos volver a calcular la posición del centro de transformación y ajustar transform.x y transform.y. <br><br><div class="spoiler">  <b class="spoiler_title">Vista previa de la plantilla del componente:</b> <div class="spoiler_text">  &lt;div ref = "area" class = "edit-zone" <br>  @ mousedown = "onMoveStart" <br>  @ touchstart = "onMoveStart" <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">mouseup</a> = "onMoveEnd" <br>  @ touchend = "onMoveEnd" <br>  @ mousemove = "onMove" <br>  @ touchmove = "onMove"&gt; <br>  &lt;img <br>  v-if = "imagen" <br>  ref = "imagen" <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">load</a> = "imageLoaded" <br>  : src = "imagen" <br>  : style = "{'transform': transformStyle, 'transform-origin': transformOrigin}"&gt; <br></div></div><br>  La funcionalidad del editor está claramente separada del proyecto principal y se encuentra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . <br><br>  Espero que este material te sea útil.  Gracias </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es417697/">https://habr.com/ru/post/es417697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es417683/index.html">Código obsoleto - Código de terceros</a></li>
<li><a href="../es417685/index.html">Seminarios web de Skillbox Friday: aprendizaje continuo gratis</a></li>
<li><a href="../es417687/index.html">Asimetría de la vida</a></li>
<li><a href="../es417689/index.html">Mobio habla con el CEO de Appnext sobre el mercado CPI y las tendencias de aplicaciones móviles</a></li>
<li><a href="../es417691/index.html">Nuestra estantería es un programador de C #. Que hay de ti</a></li>
<li><a href="../es417699/index.html">Western Digital cierra otra fábrica de HDD debido a la menor demanda</a></li>
<li><a href="../es417701/index.html">Desde simples scripts hasta aplicaciones cliente-servidor de bricolaje en WCF: por qué me gusta trabajar en CM</a></li>
<li><a href="../es417703/index.html">Código de red Age of Empires: 1,500 arqueros por módem de 28.8 kbps</a></li>
<li><a href="../es417705/index.html">Cómo un fabricante de tarjetas gráficas afecta la rentabilidad de la minería de GPU</a></li>
<li><a href="../es417707/index.html">CSS-in-JS - mitos y realidad (componentes con estilo como ejemplo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>