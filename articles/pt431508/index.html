<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéé üë©üèª‚Äç‚öïÔ∏è üç† Gerenciamento eficiente de transa√ß√µes na primavera üíÖ üê¢ ü§æ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bom dia a todos! 

 Bem, o final do m√™s √© sempre intenso e resta apenas um dia para o in√≠cio do segundo fluxo do curso "Developer on Spring Framework"...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gerenciamento eficiente de transa√ß√µes na primavera</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/431508/">  Bom dia a todos! <br><br>  Bem, o final do m√™s √© sempre intenso e resta apenas um dia para o in√≠cio do segundo fluxo do curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Developer on Spring Framework"</a> , um curso maravilhoso e interessante ministrado pelo igualmente bonito e zangado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Yuri</a> (como alguns alunos chamam de acordo com o n√≠vel de requisitos) em DZ), ent√£o vamos ver outro material que preparamos para voc√™. <br><br>  Vamos l√° <br><br>  <b>1. Introdu√ß√£o</b> <br><br>  Na maioria das vezes, os desenvolvedores n√£o atribuem import√¢ncia ao gerenciamento de transa√ß√µes.  Como resultado, a maior parte do c√≥digo precisa ser reescrita posteriormente, ou o desenvolvedor implementa o gerenciamento de transa√ß√µes sem saber como ele realmente deve funcionar ou quais aspectos devem ser usados ‚Äã‚Äãespecificamente no caso deles. <br><br>  Um aspecto importante no gerenciamento de transa√ß√µes √© determinar os limites corretos de uma transa√ß√£o, quando uma transa√ß√£o deve come√ßar e quando terminar, quando os dados devem ser adicionados ao banco de dados e quando devem ser bombeados de volta (no caso de uma exce√ß√£o). <br><br><img src="https://habrastorage.org/webt/qg/8n/mw/qg8nmwe4wvoqd2iuw3xv3ldpse0.png"><a name="habracut"></a><br><br>  O aspecto mais importante para os desenvolvedores √© entender como implementar melhor o gerenciamento de transa√ß√µes em um aplicativo.  Ent√£o, vamos olhar para as v√°rias op√ß√µes. <br><br>  <b>M√©todos de gerenciamento de transa√ß√µes</b> <br><br>  As transa√ß√µes podem ser gerenciadas das seguintes maneiras: <br><br>  <i><b>1. Programe o controle escrevendo c√≥digo personalizado</b></i> <br><br>  Este √© um m√©todo antigo de gerenciamento de transa√ß√µes. <br><br><pre><code class="java hljs">EntityManagerFactory factory = Persistence.createEntityManagerFactory(<span class="hljs-string"><span class="hljs-string">"PERSISTENCE_UNIT_NAME"</span></span>); EntityManager entityManager = entityManagerFactory.createEntityManager(); Transaction transaction = entityManager.getTransaction() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { transaction.begin(); someBusinessCode(); transaction.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { transaction.rollback(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex; }</code> </pre> <br>  <b>Pr√≥s</b> : <br><br><ul><li>  Os limites da transa√ß√£o s√£o √≥bvios no c√≥digo. </li></ul><br>  <b>Contras</b> : <br><br><ul><li>  √â repetitivo e propenso a erros. </li><li>  Qualquer erro pode ter um impacto muito grande. </li><li>  Voc√™ tamb√©m precisa escrever muitos modelos, se quiser chamar outro m√©todo a partir desse m√©todo, precisar√° control√°-lo novamente a partir do c√≥digo. </li></ul><br>  <i><b>2. Usando o Spring para o gerenciamento transacional</b></i> <br><br>  O Spring suporta dois tipos de gerenciamento de transa√ß√µes <br><br>  <b>1. Gerenciamento de transa√ß√µes de software</b> : voc√™ deve gerenciar transa√ß√µes por meio de programa√ß√£o.  Este m√©todo √© flex√≠vel o suficiente, mas dif√≠cil de manter. <br><br>  <b>2. Gerenciamento de transa√ß√µes declarativo</b> : voc√™ separa o gerenciamento de transa√ß√µes da l√≥gica de neg√≥cios.  Voc√™ usa apenas anota√ß√µes na configura√ß√£o baseada em XML para gerenciamento de transa√ß√µes. <br><br>  <u><b>√â altamente recomend√°vel usar transa√ß√µes declarativas.</b></u>  <u><b>Se voc√™ deseja conhecer os motivos, continue lendo, caso contr√°rio, v√° diretamente para a se√ß√£o Gerenciamento de Transa√ß√µes Declarativas, se desejar implementar esta op√ß√£o.</b></u> <br><br>  Agora vamos ver cada abordagem em detalhes. <br><br>  <i><b>2.1</b></i>  <i><b>Gerenciamento program√°tico de transa√ß√µes:</b></i> <br><br>  A estrutura do Spring fornece duas ferramentas para gerenciamento program√°tico de transa√ß√µes. <br><br>  a.  Usando o <code>TransactionTemplate</code> (recomendado pela equipe Spring): <br><br>  Vamos ver como implementar esse tipo usando o c√≥digo de exemplo abaixo (extra√≠do da documenta√ß√£o do Spring com algumas altera√ß√µes) <br><br>  <u>Observe que os trechos de c√≥digo s√£o retirados do Spring Docs.</u> <br><br>  Arquivo XML de contexto: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Initialization for data source --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"driverClassName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.mysql.jdbc.Driver"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"url"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jdbc:mysql://localhost:3306/TEST"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Initialization for TransactionManager --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Definition for ServiceImpl bean --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"serviceImpl"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.service.ServiceImpl"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Classe de <code>Service</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TransactionTemplate transactionTemplate; <span class="hljs-comment"><span class="hljs-comment">//       PlatformTransactionManager public ServiceImpl(PlatformTransactionManager transactionManager) { this.transactionTemplate = new TransactionTemplate(transactionManager); } //       ,   ,    //       xml  this.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_UNCOMMITTED); this.transactionTemplate.setTimeout(30); //30  ///    public Object someServiceMethod() { return transactionTemplate.execute(new TransactionCallback() { //         public Object doInTransaction(TransactionStatus status) { updateOperation1(); return resultOfUpdateOperation2(); } }); }}</span></span></code> </pre><br>  Se n√£o houver valor de retorno, use a conveniente classe <code>TransactionCallbackWithoutResult</code> com uma classe an√¥nima, como mostrado abaixo: <br><br><pre> <code class="java hljs">transactionTemplate.execute(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionCallbackWithoutResult() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInTransactionWithoutResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TransactionStatus status)</span></span></span><span class="hljs-function"> </span></span>{ updateOperation1(); updateOperation2(); } });</code> </pre><br><ul><li>  As inst√¢ncias da classe <code>TransactionTemplate</code> s√£o seguras para threads, portanto, nem todos os estados de di√°logo s√£o suportados. </li><li>  No entanto, as inst√¢ncias <code>TransactionTemplate</code> suportam o estado de configura√ß√£o; portanto, se uma classe precisar usar um TransactionTemplate com configura√ß√µes diferentes (por exemplo, um n√≠vel de isolamento diferente), ser√° necess√°rio criar duas inst√¢ncias TransactionTemplate diferentes, embora algumas classes possam usar a mesma inst√¢ncia TransactionTemplate. </li></ul><br>  b.  Usando a implementa√ß√£o <code>PlatformTransactionManager</code> diretamente: <br><br>  Vamos olhar para esta op√ß√£o no c√≥digo novamente. <br><br><pre> <code class="java hljs">&lt;!-- Initialization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data source --&gt; &lt;bean id=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span></span>&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"driverClassName"</span></span> value=<span class="hljs-string"><span class="hljs-string">"com.mysql.jdbc.Driver"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"url"</span></span> value=<span class="hljs-string"><span class="hljs-string">"jdbc:mysql://localhost:3306/TEST"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"username"</span></span> value=<span class="hljs-string"><span class="hljs-string">"root"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"password"</span></span> value=<span class="hljs-string"><span class="hljs-string">"password"</span></span>/&gt; &lt;/bean&gt; &lt;!-- Initialization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> TransactionManager --&gt; &lt;bean id=<span class="hljs-string"><span class="hljs-string">"transactionManager"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span>&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> ref=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> /&gt; &lt;/bean&gt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PlatformTransactionManager transactionManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTransactionManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PlatformTransactionManager transactionManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transactionManager = transactionManager; } DefaultTransactionDefinition def = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultTransactionDefinition(); <span class="hljs-comment"><span class="hljs-comment">//     -  ,       def.setName("SomeTxName"); def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); TransactionStatus status = txManager.getTransaction(def); try { //   -  } catch (Exception ex) { txManager.rollback(status); throw ex; } txManager.commit(status); }</span></span></code> </pre> <br>  Agora, antes de avan√ßar para o pr√≥ximo m√©todo de gerenciamento de transa√ß√µes, vamos ver como decidir qual tipo de gerenciamento de transa√ß√µes escolher. <br><br>  Escolhendo entre <b>Gerenciamento de Transa√ß√µes</b> <b>Program√°tico</b> e <b>Declarativo</b> : <br><br><ul><li>  O gerenciamento program√°tico de transa√ß√µes √© uma boa op√ß√£o apenas se voc√™ tiver um pequeno n√∫mero de opera√ß√µes transacionais.  (Na maioria dos casos, essas n√£o s√£o transa√ß√µes.) </li><li>  Um nome de transa√ß√£o s√≥ pode ser definido explicitamente no Program Transaction Management. </li><li>  O gerenciamento de transa√ß√µes program√°ticas deve ser usado quando voc√™ deseja controlar explicitamente o gerenciamento de transa√ß√µes. </li><li>  Por outro lado, se seu aplicativo contiver in√∫meras opera√ß√µes transacionais, vale a pena usar o gerenciamento declarativo. </li><li>  O gerenciamento declarativo n√£o permite gerenciar transa√ß√µes na l√≥gica de neg√≥cios e n√£o √© dif√≠cil de configurar. </li></ul><br>  <i><b>2.2</b></i>  <i><b>Transa√ß√µes declarativas (geralmente usadas em quase todos os cen√°rios de qualquer aplicativo da web)</b></i> <br><br>  <b>Etapa 1</b> : defina o gerenciador de transa√ß√µes no arquivo xml de contexto do seu aplicativo spring. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"txManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tx:annotation-driven</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">transaction-manager</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"txManager"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  <b>Etapa 2</b> : ative o suporte √† anota√ß√£o adicionando uma entrada no arquivo xml de contexto do seu aplicativo spring. <br><br>  OU adicione <code>@EnableTransactionManagement</code> ao seu arquivo de configura√ß√£o, conforme mostrado abaixo: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableTransactionManagement</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppConfig</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  <i><b>O Spring recomenda a anota√ß√£o apenas de classes espec√≠ficas (e m√©todos de classes espec√≠ficas) com a anota√ß√£o <code>@Transactional</code> compara√ß√£o com as interfaces de anota√ß√£o.</b></i> <br><br>  A raz√£o para isso √© porque voc√™ coloca a anota√ß√£o no n√≠vel da interface e, se voc√™ usa classes de proxy ( <code>proxy-target-class = ¬´true¬ª</code> ) ou o aspecto entrela√ßado ( <code>mode = ¬´aspectj¬ª</code> ), os par√¢metros da transa√ß√£o n√£o s√£o reconhecidos pela infraestrutura do proxy e plexos, por exemplo, o comportamento transacional n√£o se aplicar√°. <br><br>  <b>Etapa 3</b> : adicione a anota√ß√£o <b><code>@Transactional</code></b> √† classe (m√©todo da classe) ou interface (m√©todo da interface). <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tx:annotation-driven</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">proxy-target-class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Configura√ß√£o padr√£o: <code>proxy-target-class="false"</code> <br><br><ul><li>  <code>@Transactional</code> pode ser colocada antes de uma defini√ß√£o de interface, um m√©todo de interface, uma defini√ß√£o de classe ou um m√©todo de classe p√∫blica. </li><li>  Se voc√™ quiser que alguns m√©todos de classe (marcados com anota√ß√£o <code>@Transactional</code> ) tenham configura√ß√µes de atributo diferentes, como n√≠vel de isolamento ou n√≠vel de propaga√ß√£o, coloque a anota√ß√£o no n√≠vel do m√©todo para substituir as configura√ß√µes de atributo no n√≠vel de classe. </li><li>  No modo proxy (que √© definido por padr√£o), apenas as chamadas de m√©todo "externo" que passam pelo proxy podem ser interceptadas.  Isso significa que uma "chamada independente", por exemplo, um m√©todo no destino que chama algum outro m√©todo do destino, n√£o levar√° a uma transa√ß√£o real no tempo de execu√ß√£o, mesmo se o m√©todo chamado estiver marcado com <code>@Transactional</code> . </li></ul><br>  Agora vamos <code>@Transactional</code> diferen√ßa entre os <code>@Transactional</code> anota√ß√£o <code>@Transactional</code> <br><br> <b><code>@Transactional (isolation=Isolation.READ_COMMITTED)</code></b> <br> <br><ul><li>  O padr√£o √© <code>Isolation.DEFAULT</code> </li><li>  Na maioria dos casos, voc√™ usar√° as configura√ß√µes padr√£o at√© ter requisitos especiais. </li><li>  Informa ao gerenciador de transa√ß√µes ( <code>tx</code> ) que o pr√≥ximo n√≠vel de isolamento deve ser usado para a <code>tx</code> atual.  Ele deve ser instalado no ponto de partida de <code>tx</code> , porque n√£o podemos alterar o n√≠vel de isolamento ap√≥s o in√≠cio de tx. </li></ul><br>  <b>PADR√ÉO</b> : Use o n√≠vel de isolamento padr√£o no banco de dados base. <br><br>  <b>READ_COMMITTED</b> (lendo dados fixos): Uma constante indicando que a leitura suja foi impedida;  Podem ocorrer leituras n√£o repetidas e fantasmas. <br><br>  <b>READ_UNCOMMITTED</b> (ler dados n√£o confirmados): este n√≠vel de isolamento indica que uma transa√ß√£o pode ler dados que ainda n√£o foram exclu√≠dos por outras transa√ß√µes. <br><br>  <b>REPEATABLE_READ</b> (repetibilidade de leitura): Uma constante indicando que a leitura suja e a leitura n√£o repet√≠vel s√£o impedidas;  leitura fantasma pode aparecer. <br><br>  <b>SERIALIZABLE</b> : Permanente, indicando que leitura suja, leitura n√£o repet√≠vel e leitura fantasma s√£o impedidas. <br><br>  O que esses jarg√µes significam: leitura "suja", leitura fantasma ou leitura repetida? <br><br><ul><li>  <b>Leitura Suja</b> : A transa√ß√£o A grava.  Enquanto isso, a transa√ß√£o "B" l√™ o mesmo registro at√© a transa√ß√£o A. Mais tarde, a transa√ß√£o A decide reverter e agora temos altera√ß√µes na transa√ß√£o B que s√£o incompat√≠veis.  Esta √© uma leitura suja.  A transa√ß√£o B funcionou no n√≠vel de isolamento READ_UNCOMMITTED, para poder ler as altera√ß√µes feitas pela transa√ß√£o A antes da conclus√£o da transa√ß√£o. </li><li>  <b>Leitura n√£o repet√≠vel</b> : a transa√ß√£o "A" l√™ alguns registros.  A transa√ß√£o "B" grava esse registro e o confirma.  Posteriormente, a transa√ß√£o A l√™ o mesmo registro novamente e pode receber valores diferentes, uma vez que a transa√ß√£o B fez altera√ß√µes nesse registro e as confirmou.  Esta √© uma leitura n√£o repetida. </li><li>  <b>Leitura fantasma</b> : a transa√ß√£o "A" l√™ uma s√©rie de registros.  Enquanto isso, a transa√ß√£o "B" insere um novo registro na mesma linha que a transa√ß√£o A. Mais tarde, a transa√ß√£o A l√™ o mesmo intervalo novamente e tamb√©m recebe o registro que a transa√ß√£o B. acabou de inserir. Esta √© uma leitura fantasma: a transa√ß√£o recuperou uma s√©rie de registros v√°rias vezes do banco de dados e recebeu conjuntos de resultados diferentes (contendo registros fantasmas). </li></ul><br> <code><b>@Transactional(timeout=60)</b></code> <br> <br>  O padr√£o √© o tempo limite padr√£o para o sistema de transa√ß√µes subjacente. <br><br>  Informa o gerente de TX sobre o tempo de espera at√© que a TX fique ociosa antes de decidir reverter as transa√ß√µes n√£o respondidas. <br><br> <code><b>@Transactional(propagation=Propagation.REQUIRED)</b></code> <br> <br>  Se n√£o especificado, o comportamento de propaga√ß√£o padr√£o √© <code>REQUIRED</code> . <br><br>  Outras op√ß√µes s√£o <code>REQUIRES_NEW, MANDATORY, SUPPORTS, NOT_SUPPORTED, NEVER</code> e <code>NESTED</code> . <br><br>  <b>NECESS√ÅRIO</b> <br><br>  Indica que o m√©todo de destino n√£o pode funcionar sem uma TX ativa.  Se o tx j√° estiver em execu√ß√£o antes de chamar esse m√©todo, ele continuar√° no mesmo tx ou o novo tx ser√° iniciado logo ap√≥s a chamada desse m√©todo. <br><br>  <b>REQUIRES_NEW</b> <br><br><ul><li>  Indica que um novo tx deve ser executado sempre que o m√©todo de destino for chamado.  Se o tx j√° estiver em execu√ß√£o, ele ser√° pausado antes de iniciar um novo. </li></ul><br>  <b>Mandato</b> <br><br><ul><li>  Indica que o m√©todo de destino requer tx ativo.  Se tx n√£o continuar, n√£o falhar√°, lan√ßando uma exce√ß√£o. </li></ul><br>  <b>SUPORTE</b> <br><br><ul><li>  Indica que o m√©todo de destino pode ser executado independentemente de tx.  Se o tx funcionar, ele participar√° do mesmo tx.  Se executado sem tx, ainda ser√° executado se n√£o houver erros. </li></ul><br><ul><li>  Os m√©todos que recuperam dados s√£o os melhores candidatos para esta op√ß√£o. </li></ul><br>  <b>NOT_SUPPORTED</b> <br><br><ul><li>  Indica que o m√©todo de destino n√£o requer propaga√ß√£o de contexto de transa√ß√£o. </li><li>  Basicamente, os m√©todos executados em uma transa√ß√£o, mas que executam opera√ß√µes com RAM, s√£o os melhores candidatos para essa op√ß√£o. </li></ul><br>  <b>Nunca</b> <br><br><ul><li>  Indica que o m√©todo de destino lan√ßar√° uma exce√ß√£o se executado em um processo transacional. </li><li>  Essa op√ß√£o na maioria dos casos n√£o √© usada em projetos. </li></ul><br> <b><code>@Transactional (rollbackFor=Exception.class)</code></b> <br> <br>  Valor padr√£o: <code>rollbackFor=RunTimeException.class</code> <br><br>  No Spring, todas as classes de API lan√ßam uma RuntimeException, o que significa que, se algum m√©todo falhar, o cont√™iner sempre reverte a transa√ß√£o atual. <br><br>  O problema √© apenas com exce√ß√µes verificadas.  Portanto, esse par√¢metro pode ser usado para reverter declarativamente uma transa√ß√£o se ocorrer uma <code>Checked Exception</code> verificada. <br><br> <code><b>@Transactional (noRollbackFor=IllegalStateException.class)</b></code> <br> <br>  Indica que a revers√£o n√£o deve ocorrer se o m√©todo de destino gerar essa exce√ß√£o. <br><br>  Agora, o √∫ltimo, mas mais importante passo no gerenciamento de transa√ß√µes, √© postar a anota√ß√£o <code>@Transactiona</code> .  Na maioria dos casos, surge uma confus√£o onde a anota√ß√£o deve estar localizada: no n√≠vel do servi√ßo ou no DAO? <br><br>  <b><code>@Transactional</code> : n√≠vel de servi√ßo ou DAO?</b> <br><br>  Servi√ßo √© o melhor local para colocar <code>@Transactional</code> , o n√≠vel de servi√ßo deve conter o comportamento do caso de uso no n√≠vel de detalhe da intera√ß√£o do usu√°rio, que logicamente entra na transa√ß√£o. <br><br>  Existem muitos aplicativos CRUD que n√£o possuem l√≥gica comercial significativa, com um n√≠vel de servi√ßo que simplesmente transfere dados entre controladores e objetos de acesso a dados, o que n√£o √© √∫til.  Nesses casos, podemos colocar a anota√ß√£o da transa√ß√£o no n√≠vel do DAO. <br><br>  Portanto, na pr√°tica, voc√™ pode coloc√°-los em qualquer lugar, depende de voc√™. <br><br>  Al√©m disso, se voc√™ colocar <code>@Transactional</code> na camada DAO e se a camada DAO for reutilizada por servi√ßos diferentes, ser√° dif√≠cil coloc√°-la na camada DAO, pois servi√ßos diferentes podem ter requisitos diferentes. <br><br>  Se o seu n√≠vel de servi√ßo recuperar objetos usando o Hibernate, e digamos que voc√™ tenha inicializa√ß√µes pregui√ßosas na defini√ß√£o de um objeto de dom√≠nio, ser√° necess√°rio abrir a transa√ß√£o no n√≠vel do servi√ßo, caso contr√°rio, voc√™ encontrar√° uma LazyInitializationException lan√ßada pelo ORM. <br><br>  Considere outro exemplo em que seu n√≠vel de servi√ßo pode chamar dois m√©todos diferentes de DAO para executar opera√ß√µes de banco de dados.  Se sua primeira opera√ß√£o do DAO falhar, as outras duas poder√£o ser transferidas e voc√™ encerrar√° o estado inconsistente do banco de dados.  A anota√ß√£o de n√≠vel de servi√ßo pode salv√°-lo de tais situa√ß√µes. <br><br>  Espero que este artigo tenha ajudado voc√™. <br><br>  O FIM <br><br>  √â sempre interessante ver seus coment√°rios ou perguntas. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt431508/">https://habr.com/ru/post/pt431508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431498/index.html">O WebP assumir√° a Web em breve, mas n√£o demorar√° muito</a></li>
<li><a href="../pt431500/index.html">Bancos de dados e Kubernetes (revis√£o e reportagem em v√≠deo)</a></li>
<li><a href="../pt431502/index.html">Confer√™ncia para desenvolvedores de iOS Kolesa Mobile 3.0. Relat√≥rio de v√≠deo</a></li>
<li><a href="../pt431504/index.html">Phishing - funciona. Cr√¥nica de roubo do iPhone XS seguido por roubo de dados do iCloud</a></li>
<li><a href="../pt431506/index.html">Xcode e depura√ß√£o avan√ßada no LLDB: parte 1</a></li>
<li><a href="../pt431510/index.html">Como coletar informa√ß√µes do contorno.Comprar com Selenium</a></li>
<li><a href="../pt431512/index.html">Um pequeno estudo das propriedades de uma rede U simples, uma rede convolucional cl√°ssica para segmenta√ß√£o</a></li>
<li><a href="../pt431514/index.html">Entrevista para entrevistadores</a></li>
<li><a href="../pt431516/index.html">Um dia na vida de um consultor financeiro</a></li>
<li><a href="../pt431518/index.html">Microsoft Connect (); Meetup em Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>