<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏽 🕺🏽 🔬 老大哥正在注视着……他自己或一张带有HomeAssistant运动历史的地图 👨🏾‍🔬 🥖 👨🏻‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="参赛作品 
 对于我的家庭自动化，我已经使用HomeAssistant很长时间了。 他们说，一旦有朋友问我，为什么HomeAssistant能够仅在地图上指示跟踪器的当前位置，却无法显示整个路线？ 从那时起，这个主意吸引了我。 一旦我意识到我真的很想立即拥有此功能。 每个对此有兴趣的人，欢迎来到这只...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>老大哥正在注视着……他自己或一张带有HomeAssistant运动历史的地图</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448656/"><h3> 参赛作品 </h3><br> 对于我的家庭自动化，我已经使用HomeAssistant很长时间了。 他们说，一旦有朋友问我，为什么HomeAssistant能够仅在地图上指示跟踪器的当前位置，却无法显示整个路线？ 从那时起，这个主意吸引了我。 一旦我意识到我真的很想立即拥有此功能。 每个对此有兴趣的人，欢迎来到这只猫... <br><a name="habracut"></a><br><h3> 智商 </h3><br> 实际上，要显示路线，您需要具有一组带坐标的点，因此第一步是找出HomeAssistant在哪里存储必要的数据（如果有的话）以及如何从那里获取数据。 对主要来源的简短研究立即得出了解决方案：您需要使用随附的记录器模块在不同的时间点记录数据库中所需传感器的状态，以及历史记录模块，该模块可以使您以优美的方式从数据库中获取数据。 历史记录模块具有详细记录的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">REST API</a> 。 你需要什么！ <br><br> 接下来，您需要以某种方式在地图上显示接收到的数据。 有许多不同的服务可让您显示运动的历史记录。 我可能没有尝试过所有方法，但是请允许我说说我检查过的内容： <br>  <b>A．</b>  yandex和Google。 实际上满足我的需求，甚至还有更多，但是由于付费服务和免费版本的严格限制，它们不适合我。 例如，Yandex只允许免费使用开放项目（也就是说，任何人都应该可以随时打开您的资源并利用其功能），更不用说对请求数量的其他限制。 只有懒惰的人没有写过Google关于api政策的更改。 目前，据我所知，对地图api或路线图api的每个请求都是付费的，请求越多-越便宜。 但是，每位拥有银行卡的用户都可以免费获得每月200美元的限额。 最上面的所有内容都会立即从您的卡中支付。 将卡链接到帐户不是我们的方式。 <br><br> 如果我在google和/或yandex某个地方犯了一个错误，请更正。 <br><br>  <b>B．</b> 一堆<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OpenRouteService</a>和OpenRouteService映射。 原则上，这些功能与google或yandex并没有太大区别（无论如何，我都没有注意到）。 完全免费（每天和每分钟的请求数量有限制，如果超出限制，建议与支持人员联系...根本没有任何付费资费的描述）。 但是，事实证明使用OpenRouteService地图资源很不方便（长时间加载应用程序以及左侧烦人的宽菜单，默认情况下该菜单打开且未被API禁用，此外，该服务无法从移动设备正确打开）。 公平地说，可以将OpenRouteService映射放置在您的服务器上，并且很有可能在那里自己配置所有内容。 <br><br>  <b>B．</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mapbbcode</a> 我偶然发现了一种有趣的简单格式的卡片实现。 原则上，该项目绝对适合我的任务，但是，从本文中，我了解了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Leaflet，</a>并决定转向源代码。 最后，他停了下来... <br><br>  <b>G．</b> 传单。 非常好的用于地图的开源js库，易于学习且文档齐全。 从芯片：允许您使用许多服务（openstreetmaps，yandex，google，mapbox，microsoft等）中的图块。 另外，我使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">leaflet.polylineDecorator</a>插件来指示地图上的移动方向。 <br><br> 值得一提的是，所考虑的最后两个资源不支持“路线”，也就是说，它们不知道如何沿现有道路和/或人行道连接点，而只是将它们与直线连接起来。 就我个人而言，这不是问题，而是有意识的一步。 如果您需要在道路上导航，则需要朝付费Google，Yandex或免费的openrouteservice方向看。 <br><br><h3> 实作 </h3><br> 通过REST-API向历史记录模块的请求非常简单（以下代码将使用HomeAssistant语言，即python），并允许您以易于理解的JSON形式获得答案： <br><br><pre><code class="python hljs">response = requests.get(self._haddr + <span class="hljs-string"><span class="hljs-string">'/api/history/period/'</span></span> + dayBegin + <span class="hljs-string"><span class="hljs-string">'?filter_entity_id='</span></span> + self._myid, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer '</span></span> + self._token, <span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) data = response.json()[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br> 这里self._haddr是您的HA地址，与前端设置中指定的地址相同，self._myid是我们将构建其路线的device_tracker的设备ID，dayBegin是显示路线的开始时间，我默认选择了今天的开始时间， self._token是用于访问api的长令牌，可以在HomeAssistant界面中获得。 <br><br> 当我们试图在地图上显示其历史的对象长时间静止不动或移动得非常缓慢时，我们将得到一堆位置很近的点，从而阻塞了地图。 要纠正这种情况，请让生成的坐标数组通过过滤器：如果上一个点和下一个点之间的距离小于100米，则不要在地图上显示该点。 为了计算两个相邻点之间的距离，我们使用带有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">等角近似</a>的简化公式。 当相邻点之间的距离不超过几公里时，适用近似值： <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, latA, lonA, latB, lonB)</span></span></span><span class="hljs-function">:</span></span> dst = <span class="hljs-number"><span class="hljs-number">0</span></span> latRadA = math.radians(latA) lonRadA = math.radians(lonA) latRadB = math.radians(latB) lonRadB = math.radians(lonB) x = latRadB - latRadA y = (lonRadB-lonRadA)*math.cos((latRadB+latRadA)*<span class="hljs-number"><span class="hljs-number">0.5</span></span>) dst = <span class="hljs-number"><span class="hljs-number">6371</span></span>*math.sqrt(x*x+y*y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dst</code> </pre> <br>  dst是公里的距离。 <br><br> 在这里描述Leaflet API一点都不重要。 为此-在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方网站上</a> 。 该模块的工作方式如下：每n秒（我将其设置为300）对我感兴趣的对象的当前历史记录进行一次请求。 生成的坐标数组通过距离过滤器运行，从而减少了点数。 此外，在www文件夹中具有HomeAssistant配置的文件夹中，形成2个文件：index.html和route.html。  route.html文件包含创建地图的所有逻辑。 而且index.html文件是防止页面缓存的终生工具。 默认情况下，HomeAssistant会缓存所有可能的内容，并且仅重置缓存有助于更新地图上的数据，这当然是不可接受的。 在index.html文件中，将调用route.html的内容，但是会使用动态生成的随机参数来调用，该参数可让您始终从服务器请求最新版本的route.html： <br><br><pre> <code class="xml hljs">src = 'route.html?datetime=' + (new Date()).getTime() + Math.floor(Math.random() * 1000000)</code> </pre> <br><h3> 关于安全的一点 </h3><br> 设计HomeAssistant的目的是使www目录中的所有文件都是公共的，也就是说，www目录中的任何文件都可以在任何浏览器中打开而无需任何授权，并且知道直接链接。 对于我的模块，此链接是： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">your_address_homeassistant / local / route / index.html</a> 。 如果这对您而言并不重要，则可以跳过本节。 我走得更远，将授权与路线固定在页面上。 为此，我使用了nginx（您可以选择另一个具有反向代理支持的Web服务器）作为代理服务器。  HomeAssistant网站具有有关设置此配置的官方<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明</a> 。 设置代理并检查操作后，您需要向nginx配置中的必要页面添加授权： <br><br><pre> <code class="plaintext hljs">location /local/route/route.html { proxy_pass http://localhost:8123/local/route/route.html; proxy_set_header Host $host; proxy_redirect http:// https://; proxy_http_version 1.1; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; auth_basic "Unauthorized"; auth_basic_user_file /etc/nginx/.htpasswd; }</code> </pre> <br> 然后创建文件“ /etc/nginx/.htpasswd”，并在控制台中执行以下命令： <br><br><pre> <code class="bash hljs">sh -c <span class="hljs-string"><span class="hljs-string">"echo -n 'admin:' &gt;&gt; /etc/nginx/.htpasswd"</span></span> sh -c <span class="hljs-string"><span class="hljs-string">"openssl passwd -apr1 &gt;&gt; /etc/nginx/.htpasswd"</span></span></code> </pre> <br>  admin-替换为所需的登录名。 <br><br> 之后，重新启动nginx并检查：尝试打开带有路由的页面时，浏览器应请求用户名和密码。 我注意到这是一个单独的授权，与HomeAssistant本身的授权无关。 <br><br><h3> 结论 </h3><br> 关于这个模块，也许所有这些都可以说。 <br> 有兴趣的人， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里是</a>该模块<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的链接</a> 。 沿着以下路径放置文件：config_folder_homeassistant / custom_components / route / sensor.py，请不要忘记权限。 <br><br> 如果不存在，则创建config_folder_homeassistant / www文件夹并为其赋予适当的权限。 <br><br> 在配置文件configuration.yaml中，编写以下几行： <br><br><pre> <code class="plaintext hljs">sensor: - platform: route name: route entityid: your_device_tracker_entity_id haddr: your_address_homeassistant token: your_long_life_token</code> </pre> <br> 这里your_device_tracker_entity_id是设备device_tracker的ID，your_address_homeassistant是HomeAssistant的外部地址，your_long_life_token是先前在HomeAssistant前端中收到的使用REST API的访问令牌。 <br><br> 之后，重新启动HomeAssistant并享受。 该地图将通过直接链接提供： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">your_address_homeassistant / local / route / index.html</a> 。 如果愿意，可以使用panel_iframe将其添加到HA菜单中，也可以通过lovelace卡“ iframe”将其添加到任何HA窗口中。 <br> 就这样，谢谢您的关注。 <br><br>  <b>UPD：</b> <br> 添加了到GitHub的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">链接</a> 。 修改了一些地方（从配置haddr中删除，自动获取config_dir，添加了设置我的时区的功能） <br><br><div class="spoiler">  <b class="spoiler_title">看起来如何？</b>  <b class="spoiler_title">小心，布鲁尔！</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/_v/2_/tw_v2_gufir0tcuzo02dt1e-zig.jpeg" alt="图片"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448656/">https://habr.com/ru/post/zh-CN448656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448640/index.html">SSD GIGABYTE Aorus RGB M.2：小巧，甚至可以遥控RGB LED（2个部分）</a></li>
<li><a href="../zh-CN448642/index.html">FreeBSD中的强制性权利分配模型</a></li>
<li><a href="../zh-CN448648/index.html">如何让每个人都坐上科学，而不是将办公室变成仇恨的温床</a></li>
<li><a href="../zh-CN448652/index.html">Raspberry Pi上的Mozilla WebThings-入门</a></li>
<li><a href="../zh-CN448654/index.html">Mozilla WebThings-网关设置</a></li>
<li><a href="../zh-CN448658/index.html">通过汽车中的OBD连接器可以做什么</a></li>
<li><a href="../zh-CN448664/index.html">在Swift上像Tinder一样创建卡片</a></li>
<li><a href="../zh-CN448666/index.html">我们如何选择与客户进行电子文档管理的服务</a></li>
<li><a href="../zh-CN448668/index.html">敏捷：IT中最大的思想问题</a></li>
<li><a href="../zh-CN448670/index.html">嵌入式接口设计</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>