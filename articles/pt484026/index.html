<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóø üë®üèæ‚Äç‚öñÔ∏è üñåÔ∏è Parte 6: Portando o MemTest86 + para o RISC-V üó£Ô∏è ‚úäüèª ü§¶üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Provavelmente poucas pessoas de TI precisam explicar o que √© o Memtest86 + - talvez ele j√° tenha se tornado mais ou menos o padr√£o no teste de RAM em ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parte 6: Portando o MemTest86 + para o RISC-V</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br><p> Provavelmente poucas pessoas de TI precisam explicar o que √© o Memtest86 + - talvez ele j√° tenha se tornado mais ou menos o padr√£o no teste de RAM em um PC.  Quando em uma das <a href="https://habr.com/ru/post/459470/">partes anteriores</a> me deparei com uma barra de mem√≥ria quebrada que acompanha a placa, ela (junto com um netbook habilitado para DDR2) parecia uma solu√ß√£o √≥bvia.  Outra quest√£o √© que ali, em princ√≠pio, a opera√ß√£o inst√°vel do sistema era vis√≠vel a olho nu.  Em casos mais complicados, ouvi dizer que, al√©m do banal "toque" das c√©lulas de mem√≥ria at√© o infinito, essa ferramenta usa alguns padr√µes de dados especiais nos quais os erros na opera√ß√£o de DDR t√™m mais probabilidade de serem detectados.  Em geral, uma coisa maravilhosa, √© uma pena que mesmo no nome esteja escrito: 86 - "Somente para sistemas compat√≠veis com x86".  Ou n√£o? </p><br><p>  Abaixo do corte, voc√™ ver√° minhas tentativas de portar o MemTest86 + v5.1 para o RISC-V e o subtotal.  <em>Spoiler: ele se move!</em> </p><a name="habracut"></a><br><p>  <strong>AVISO LEGAL: o projeto resultante foi minimamente testado especificamente por mim em uma montagem RocketChip espec√≠fica em um quadro espec√≠fico.</strong>  <strong>Precis√£o e seguran√ßa (especialmente em outros sistemas) n√£o s√£o garantidas.</strong>  <strong>Use por sua conta e risco.</strong>  <strong>Em particular, as √°reas de mem√≥ria atualmente reservadas n√£o s√£o processadas de forma alguma se estiverem dentro do intervalo de RAM.</strong> </p><br><p>  Como eu j√° disse, h√° pouco tempo comprei uma placa-m√£e com o Cyclone IV no AliExpress, mas a mem√≥ria era de buggy.  Felizmente, uma das caracter√≠sticas importantes desta placa foi o uso de m√≥dulos DDR2 SO-DIMM convencionais - o mesmo que no meu antigo netbook.  No entanto, seria interessante obter, por assim dizer, uma solu√ß√£o auto-hospedada para testar m√≥dulos de mem√≥ria (e, de fato, tamb√©m o controlador).  A perspectiva de depurar meus erros nas condi√ß√µes de mem√≥ria ruim n√£o era de todo agrad√°vel.  Especialmente sem esperar por uma solu√ß√£o r√°pida e mentalmente me preparando para adiar a reescrita completa em outro montador por tempo indeterminado, abri um artigo da Wikipedia no Memtest86 + e de repente vi ‚ÄúEscrito em: C e montagem‚Äù no cart√£o.  Hmm, isto √©, ele, embora "... 86", mas n√£o est√° escrito inteiramente em assembler?  Isso √© encorajador.  Resta apenas entender o relacionamento. </p><br><p>  Ent√£o, v√° para <a href="http://www.memtest.org/" rel="nofollow">memtest.org</a> e fa√ßa o download da vers√£o 5.01 na GPL2.  Para facilitar o desenvolvimento, eu o <a href="https://github.com/atrosinenko/memtest86-plus-riscv" rel="nofollow">recarreguei</a> no GitHub.  Felizmente, no arquivo de origem, somos recebidos pelo arquivo <a href="https://github.com/atrosinenko/memtest86-plus-riscv/blob/68b365d13cf22accd52f88af49c33f57c6643ae5/README.background" rel="nofollow">README.background</a> , intitulado </p><br><blockquote>  Anatomia e Fisiologia do Memtest86-SMP </blockquote><p> Explica com alguns detalhes (e mesmo com imagens na forma de arte ASCII) a opera√ß√£o de alto n√≠vel do c√≥digo.  No in√≠cio do documento, vemos um <em>layout bin√°rio</em> , composto por <code>bootsect.o</code> , <code>setup.o</code> , <code>head.o</code> e alguns <code>memtest_shared</code> .  √â f√°cil ver que esses tr√™s arquivos de objeto s√£o obtidos das fontes correspondentes do assembler.  √Ä primeira vista, tudo o resto est√° escrito em C!  Nada mal, nada mal ... </p><br><p>  Como resultado, copiei o <code>Makefile</code> para <code>Makefile.arch</code> e comecei a reescrever tudo, e tentei jogar fora o que n√£o corresponde.  Antes de tudo, √© claro, eu precisava de uma cadeia de ferramentas para o RISC-V, que, felizmente, ainda est√° comigo desde os experimentos anteriores.  No come√ßo, pensei em criar uma porta para arquitetura de 32 bits, mas depois lembrei que um processador de 64 bits foi carregado na placa e eu tinha a <code>riscv64-</code> com o prefixo <code>riscv64-</code> . </p><br><p>  <em>Digress√£o l√≠rica: √©</em> claro, a primeira coisa foi estudar a quest√£o da compatibilidade do c√≥digo de 32 e 64 bits.  Como resultado, a especifica√ß√£o para a parte n√£o privilegiada do ISA (Instruction Set Architecture) encontrada no par√°grafo <code>1.3 RISC-V ISA Overview</code> declara√ß√£o <code>1.3 RISC-V ISA Overview</code> : </p><br><blockquote>  A principal vantagem de separar explicitamente os ISAs de base √© que cada ISA de base pode ser otimizado para suas necessidades sem exigir o suporte de todas as opera√ß√µes necess√°rias para outros ISAs de base.  Por exemplo, o RV64I pode omitir instru√ß√µes e CSRs necess√°rios apenas para lidar com os registros mais restritos no RV32I.  As op√ß√µes do RV32I podem usar espa√ßo de codifica√ß√£o, caso contr√°rio, reservado para instru√ß√µes exigidas apenas por variantes mais amplas do espa√ßo de endere√ßo. </blockquote><p>  Tamb√©m quero observar que a cadeia de ferramentas com o prefixo <code>riscv64-</code> provavelmente coletar√° facilmente o c√≥digo de 32 bits se a arquitetura de destino for selecionada corretamente - mais sobre isso mais tarde. </p><br><p>  No processo de portabilidade, faz sentido manter esses documentos √† m√£o: </p><br><ul><li>  <a href="https://riscv.org/specifications/" rel="nofollow">O manual de instru√ß√µes do RISC-V, Volume I: ISA n√£o privilegiado</a> </li><li>  <a href="https://riscv.org/specifications/privileged-isa/" rel="nofollow">O conjunto de instru√ß√µes do RISC-V Manual Volume II: Arquitetura Privilegiada</a> </li><li>  Al√©m disso, alguns <a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">manuais do SiFive FU540-C000</a> - um manual para o chip, com comportamento semelhante ao do processador flex√≠vel, usado para depura√ß√£o em FPGAs - n√£o ser√£o substitu√≠dos. </li></ul><br><h2 id="nastroyka-sborki">  Configura√ß√£o de compila√ß√£o </h2><br><p>  Vamos come√ßar concordando: desejo obter uma porta adequada para portar outras arquiteturas que n√£o sejam x86 e RISC-V.  Tamb√©m proponho lan√ßar disquetes de inicializa√ß√£o e outros detalhes espec√≠ficos do x86 da compila√ß√£o de plataforma cruzada. </p><br><p>  Em √∫ltima an√°lise, o que temos: existem tr√™s arquivos assembler: <code>bootsect.S</code> , <code>setup.S</code> e <code>head.S</code>  Os dois primeiros s√£o necess√°rios apenas na inicializa√ß√£o, e o terceiro √© necess√°rio mais tarde ao se mudar para outra √°rea de mem√≥ria.  O fato √© que, para testar a mem√≥ria "debaixo de si", o c√≥digo de teste deve primeiro se mover para um novo local.  Arquivos Sich s√£o coletados no ELF, a partir do qual se√ß√µes de c√≥digo, dados etc. s√£o retiradas.  Al√©m disso, ele √© coletado na forma de PIC (C√≥digo Independente de Posi√ß√£o) - a princ√≠pio, fiquei surpreso: embora o c√≥digo seja aut√¥nomo (ou seja, sem um kernel, libc, etc.), ele usa recursos avan√ßados. </p><br><p>  Al√©m disso, os par√¢metros que definem a arquitetura periodicamente s√£o encontrados no Makefile: <code>-march=i486</code> , <code>-m32</code> e similares.  Eu preciso escrever algo assim, <del>  e depois como um ot√°rio </del>  .  A situa√ß√£o com a arquitetura RISC-V √© mais ou menos assim: existem <code>rv64</code> e <code>rv64</code> (como, ainda h√° as incorporadas e rv128 mais truncadas reservadas para o futuro, mas n√£o estamos muito interessadas nelas), e o nome ISA √© formado atribuindo letras a esse prefixo extens√µes: <code>i</code> - o conjunto inteiro b√°sico de instru√ß√µes, <code>m</code> - multiplica√ß√£o e divis√£o de n√∫meros inteiros ... √â claro que eu gostaria de fazer o <code>rv64i</code> , mas o Memtest86 dificilmente ser√° facilmente portado para a arquitetura sem multiplica√ß√£o.  √â verdade que parece que o compilador simplesmente gera chamadas de fun√ß√£o em vez de instru√ß√µes "problem√°ticas", mas existe o risco de permanecer com desempenho bastante reduzido (sem mencionar que essas fun√ß√µes precisar√£o ser gravadas ou levadas a algum lugar). </p><br><p>  Voc√™ tamb√©m precisar√° da linha ABI.  Em princ√≠pio, os princ√≠pios b√°sicos da conven√ß√£o de chamada j√° est√£o descritos no <code>Volume I</code> especificado no "Manual do Programador de Montagem RISC-V", portanto, farei algo como </p><br><pre> <code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help riscv64-linux-gnu-gcc-9: error: unrecognized argument in option '-mabi=help' riscv64-linux-gnu-gcc-9: note: valid arguments to '-mabi=' are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f riscv64-linux-gnu-gcc-9: fatal error: no input files compilation terminated.</code> </pre> <br><p>  E sem pensar <code>lp64</code> , eu vou pegar <code>lp64</code> .  <em>Olhando para o futuro, direi que, com essa ABI, os arquivos de cabe√ßalho da biblioteca padr√£o n√£o funcionaram, por isso peguei <code>lp64f</code> e o ARCH "atualizou" para <code>rv64imf</code> .</em>  <em>Sem p√¢nico, n√£o pretendo realmente usar ponto flutuante na minha porta.</em> </p><br><p>  Como de alguma forma eu n√£o queria me aprofundar na escrita de scripts de vinculador de plataforma cruzada - e, portanto, n√£o consegui <em>encontrar</em> imediatamente <em>as chaves para ld</em> , decidi seguir com o arquivo <code>head.S</code> do assembler, agarrando-me ao restante das fun√ß√µes usando <code>memtest_shared.arch.lds</code> .  Deitei uma indica√ß√£o do formato e da arquitetura de sa√≠da (afinal, √© mais f√°cil alter√°-lo de uma vari√°vel no Makefile) e tamb√©m comentei temporariamente o <code>DISCARD</code> no final, n√£o sendo capaz de descobrir quais se√ß√µes espec√≠ficas das informa√ß√µes de depura√ß√£o eu precisava.  <em>(Olhando para o futuro: informa√ß√µes detalhadas sobre depura√ß√£o, mas a <code>.rela</code> precisava ser adicionada)</em> De um modo geral, a vers√£o x86 enfatizava a necessidade de caber em 64k - espero que isso esteja de alguma forma relacionado aos recursos do modo real e n√£o nos preocupe no RISC-V .  Como resultado, o objeto compartilhado com o PIC ser√° coletado, como no original, o c√≥digo e os dados que ser√£o carregados na mem√≥ria ser√£o removidos. </p><br><p>  N√≥s coletamos ... e a compila√ß√£o cai no primeiro arquivo <code>reloc.c</code> - aparentemente, √© retirado de algum <code>ld-linux.so</code> e √© respons√°vel por dar suporte √† Tabela Global de Compensa√ß√µes, etc.  de acordo com as conven√ß√µes de chamada para x86.  Aconteceu que era necess√°rio trabalhar diretamente com registradores usando inser√ß√µes de montador.  Mas estamos no RISC-V - ele foi originalmente criado para oferecer suporte nativo ao PIC, portanto, sinta-se livre para lan√ßar <code>reloc.c</code> .  Al√©m disso, ainda havia inser√ß√µes, √†s vezes bastante longas.  Felizmente, eles estavam no c√≥digo de teste imediatamente ap√≥s o c√≥digo C comentado, que eles otimizam (a partir deles, novamente fiz trechos de c√≥digo completos alternados pela diretiva de pr√©-processador) ou algo dependente da plataforma, sem o qual, em casos extremos, eu posso (provavelmente) do (como ligar / desligar o cache, subtrair o CPUID, etc.).  Finalmente, houve algumas coisas como a chamada <code>rdtsc</code> , que eu <code>rdtsc</code> , sem grandes problemas, coloquei em um cabe√ßalho dependente da plataforma e o implementei de acordo com a documenta√ß√£o no RISC-V. </p><br><p>  Como resultado, obtivemos o diret√≥rio <code>arch/i386</code> , onde uma grande quantidade de c√≥digo de suporte PCI se moveu, leu informa√ß√µes dos chipsets, defini√ß√µes espec√≠ficas da plataforma de endere√ßos mapeados na mem√≥ria, etc.  Al√©m disso, o in√≠cio da fun√ß√£o <code>test_start</code> , que √© o ponto de entrada da <code>setup.S</code> para o c√≥digo C. Quanto tempo, curto, mas comentando tudo o que √© poss√≠vel e realizando tudo o que n√£o pode ser comentado no RISC-V (como a <code>setup.S</code> e o c√≥digo para trabalhar com porta serial na implementa√ß√£o do SiFive), obtive o <code>arch/riscv</code> , com o qual tudo foi mais ou menos compilado. </p><br><p>  Aqui sou for√ßado a esclarecer que os experimentos foram realizados parcialmente antes da reda√ß√£o do artigo, de modo que uma <em>sequ√™ncia</em> espec√≠fica <em>de</em> a√ß√µes possa conter uma certa quantidade de "fic√ß√£o art√≠stica".  No entanto, tento conduzir pelo menos a apresenta√ß√£o de tal forma que, de qualquer forma, represente um dos caminhos poss√≠veis <em>(sou programador, lembro disso)</em> .  Ent√£o, vamos ver como come√ßar tudo. </p><br><h2 id="zapusk-na-zheleze">  Correndo em ferro </h2><br><p>  Desde experimentos anteriores, ainda tenho um suporte empoeirado do Raspberry Pi, conectado √† placa de depura√ß√£o.  Os fios fornecem UART, JTAG e um adaptador com um cart√£o SD.  Um determinado processador RV64 com um controlador DDR2 √© costurado na mem√≥ria de configura√ß√£o.  Como nos tempos anteriores, eu ligo o ‚Äúraspberry‚Äù, abro duas sess√µes SSH antes dele, uma das quais encaminha a porta 3333 TCP para conectar o gdb ao OpenOCD.  Em uma das sess√µes, inicio o minicom para assistir ao UART, em outra - openocd para depura√ß√£o do host via JTAG.  Ligo a alimenta√ß√£o do quadro - e mensagens no console sobre como ele carrega dados do SD executado. </p><br><p>  Agora voc√™ pode executar o comando: </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:3333' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \ -ex 'add-symbol-file /path/to/memtest_shared 0x80010000' -ex 'set $pc=0x80010000'</code> </pre> <br><p>  as op√ß√µes <code>-ex</code> gdb a fingir que o usu√°rio inseriu esses comandos no console: </p><br><ul><li>  o primeiro estabelece uma conex√£o com o OpenOCD </li><li>  o segundo copia o conte√∫do do arquivo host especificado para o endere√ßo especificado </li><li>  o terceiro explica ao gdb que as informa√ß√µes sobre o c√≥digo-fonte devem ser extra√≠das <em>desse</em> arquivo, levando em considera√ß√£o o fato de que ele foi baixado <em>nesse</em> endere√ßo (e n√£o o que √© indicado nele) <br><ul><li>  nota: pegamos os caracteres do arquivo ELF e carregamos o bin√°rio "bruto" </li></ul></li><li>  finalmente, o quarto converte √† for√ßa o ponteiro de comando atual para o nosso c√≥digo </li></ul><br><p>  Infelizmente, nem tudo corre absolutamente bem e, embora as linhas de c√≥digo no depurador sejam exibidas corretamente, mas em todas as vari√°veis ‚Äã‚Äãglobais - zeros.  De fato, se executarmos um comando no formato <code>p &amp;global_var</code> no gdb, veremos o endere√ßo de acordo com o endere√ßo de download inicial (eu tenho <code>0x0</code> ), que n√£o √© especificado usando <code>add-symbol-file</code> .  Como muleta, mas como uma solu√ß√£o muito simples, simplesmente adicionei <code>0x80010000</code> ao endere√ßo especificado manualmente e examinei o conte√∫do da mem√≥ria atrav√©s de <code>x/x 0xADDR</code> .  De fato, seria poss√≠vel indicar temporariamente o endere√ßo inicial correto no script do vinculador, que <em>no momento</em> coincidir√° com o endere√ßo de download <em>nessa configura√ß√£o de teste</em> . </p><br><h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah">  Recursos de realoca√ß√£o em arquiteturas modernas </h2><br><p>  Bem, como fazer o download do c√≥digo, de alguma forma, descobrimos - come√ßamos.  N√£o funciona  A depura√ß√£o passo a passo mostra que ca√≠mos durante a opera√ß√£o da fun√ß√£o <code>switch_to_main_stack</code> - parece que ele ainda est√° tentando usar o valor n√£o relacionado do endere√ßo do s√≠mbolo correspondente √† pilha de trabalho. </p><br><p>  Mesmo assim, o primeiro volume de documenta√ß√£o nos fala sobre diferentes pseudo-instru√ß√µes e seu trabalho com o PIC ligado e desligado: </p><br><p><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="Algumas pseudo-instru√ß√µes do RISC-V"></p><br><p>  Como voc√™ pode ver, o princ√≠pio geral √© que os endere√ßos na mem√≥ria s√£o contados a partir da instru√ß√£o atual, com o primeiro adicionando a parte superior do deslocamento e o pr√≥ximo <code>add</code> polindo os bits de ordem inferior.  Dificilmente ajuda declarar uma vari√°vel global como </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vars</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><p>  Portanto, pegamos a documenta√ß√£o do RISC-V ELF psABI com <a href="" rel="nofollow">descri√ß√µes dos tipos de realoca√ß√µes</a> e escrevemos a parte espec√≠fica da plataforma para <code>reloc.c</code> .  Aqui deve-se notar que o arquivo original, aparentemente, foi retirado do c√≥digo de plataforma cruzada.  L√°, mesmo em vez de especificar uma profundidade de bits espec√≠fica, <code>ElfW(Addr)</code> macros do tipo <code>ElfW(Addr)</code> , <code>Elf32_Addr</code> para <code>Elf32_Addr</code> ou <code>Elf64_Addr</code> .  No entanto, em todos os lugares, no entanto, √© por isso que os adicionamos onde n√£o est√£o no c√≥digo geral (assim como no c√≥digo <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> - afinal, para o RISC-V, n√£o h√° um sentido especial a ser vinculado a uma profundidade de bits espec√≠fica, onde n√£o h√° necess√°rio). </p><br><p>  Como resultado, <code>switch_to_main_stack</code> come√ßou a passar (n√£o sem as instru√ß√µes do montador dependente da plataforma, √© claro).  O depurador mostra vari√°veis ‚Äã‚Äãglobais ainda tortas.  Bem, ok :( </p><br><h2 id="opredelenie-oborudovaniya">  Defini√ß√£o de Hardware </h2><br><p>  Obviamente, para testes, seria poss√≠vel usar constantes codificadas em vez do c√≥digo de defini√ß√£o de equipamento descartado, mas para cada conjunto espec√≠fico de processador, a reconstru√ß√£o do memtest √© muito cara pelos padr√µes do meu aplicativo.  Portanto, agiremos "como adultos s√©rios".  Felizmente, no RISC-V (e provavelmente na maioria das arquiteturas modernas), √© habitual que o gerenciador de inicializa√ß√£o transmita um c√≥digo ao <a href="https://en.wikipedia.org/wiki/Device_tree" rel="nofollow">Device Tree Blob</a> , que √© uma vers√£o compilada da descri√ß√£o do DTS como esta: </p><br><div class="spoiler">  <b class="spoiler_title">zeowaa-1gb.dts</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/dts-v1/; / { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-dev"; model = "freechips,rocketchip-unknown"; chosen { bootargs = "console=ttySIF0,125200 debug loglevel=7"; }; firmware { sifive,uboot = "YYYY-MM-DD"; }; L16: aliases { serial0 = &amp;L8; }; L15: cpus { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; timebase-frequency = ^_^ltÛ¥âÄgt^_^; L5: cpu@0 { device_type = "cpu"; clock-frequency = ^_^lt&amp;#0;gt^_^; compatible = "sifive,rocket0", "riscv"; d-cache-block-size = ^_^lt gt^_^; d-cache-sets = ^_^lt@gt^_^; d-cache-size = ^_^lt·ÄÄgt^_^; d-tlb-sets = ^_^lt gt^_^; d-tlb-size = ^_^lt gt^_^; i-cache-block-size = ^_^lt gt^_^; i-cache-sets = ^_^lt@gt^_^; i-cache-size = ^_^lt·ÄÄgt^_^; i-tlb-sets = ^_^lt gt^_^; i-tlb-size = ^_^lt gt^_^; mmu-type = "riscv,sv39"; next-level-cache = &lt;&amp;L10&gt;; reg = &lt;0x0&gt;; riscv,isa = "rv64imafdc"; status = "okay"; timebase-frequency = ^_^ltÛ¥âÄgt^_^; tlb-split; L3: interrupt-controller { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,cpu-intc"; interrupt-controller; }; }; }; L10: ram@80000000 { device_type = "memory"; reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;; reg-names = "mem"; }; L14: soc { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-soc", "simple-bus"; ranges; L1: clint@2000000 { compatible = "riscv,clint0"; interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;; reg = &lt;0x2000000 0x10000&gt;; reg-names = "control"; }; L2: debug-controller@0 { compatible = "sifive,debug-013", "riscv,debug-013"; interrupts-extended = &lt;&amp;L3 65535&gt;; reg = &lt;0x0 0x1000&gt;; reg-names = "control"; }; L9: gpio@64002000 { #gpio-cells = ^_^lt gt^_^; #interrupt-cells = ^_^lt gt^_^; compatible = "sifive,gpio0"; gpio-controller; interrupt-controller; interrupt-parent = &lt;&amp;L0&gt;; interrupts = &lt;3 4 5 6 7 8&gt;; reg = &lt;0x64002000 0x1000&gt;; reg-names = "control"; }; L0: interrupt-controller@c000000 { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,plic0"; interrupt-controller; interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;; reg = &lt;0xc000000 0x4000000&gt;; reg-names = "control"; riscv,max-priority = ^_^lt gt^_^; riscv,ndev = ^_^lt gt^_^; }; L6: rom@10000 { compatible = "sifive,maskrom0"; reg = &lt;0x10000 0x2000&gt;; reg-names = "mem"; }; L8: serial@64000000 { compatible = "sifive,uart0"; interrupt-parent = &lt;&amp;L0&gt;; clocks = &lt;&amp;tlclk&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64000000 0x1000&gt;; reg-names = "control"; }; L7: spi@64001000 { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; compatible = "sifive,spi0"; interrupt-parent = &lt;&amp;L0&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64001000 0x1000&gt;; clocks = &lt;&amp;tlclk&gt;; reg-names = "control"; L12: mmc@0 { compatible = "mmc-spi-slot"; disable-wp; reg = &lt;0x0&gt;; spi-max-frequency = ^_^lt gt^_^; voltage-ranges = &lt;3300 3300&gt;; }; }; tlclk: tlclk { #clock-cells = ^_^lt&amp;#0;gt^_^; clock-frequency = ^_^lt gt^_^; clock-output-names = "tlclk"; compatible = "fixed-clock"; }; }; };</code> </pre> </div></div><br><p>  Costumava analisar arquivos ELF, mas agora estou novamente convencido do FDT (√°rvore plana de dispositivos): essas <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">especifica√ß√µes s√£o</a> escritas por <em>pessoas atenciosas</em> <del>  (Ainda assim, eles mesmos analisam!) </del>  e analisar esses arquivos (pelo menos at√© que voc√™ precise processar entradas n√£o confi√°veis) n√£o apresenta problemas espec√≠ficos.  Ent√£o aqui: no in√≠cio do arquivo, existe uma estrutura de cabe√ßalho simples que cont√©m o n√∫mero m√°gico <code>0xd00dfeed</code> e mais alguns campos.  Estamos interessados ‚Äã‚Äãno deslocamento da "√°rvore plana" <code>off_dt_struct</code> e da tabela de linhas <code>off_dt_strings</code> .  Na verdade, voc√™ tamb√©m precisa processar <code>off_mem_rsvmap</code> , que enumera √°reas da mem√≥ria que devem ser evitadas.  Ainda os ignoro (eles n√£o est√£o no meu quadro), mas <strong>n√£o o repito em casa</strong> . </p><br><p>  Em princ√≠pio, o processamento n√£o √© particularmente dif√≠cil: voc√™ s√≥ precisa andar em uma √°rvore plana de acordo com os tokens.  <em>Existem</em> tr√™s tokens <em>principais</em> : </p><br><ul><li>  <code>FDT_BEGIN_NODE</code> - nos dados extras imediatamente a seguir, vem o nome do elemento da sub√°rvore na forma de uma sequ√™ncia terminada em nulo.  Basta adicionar o nome √† pilha </li><li>  <code>FDT_END_NODE</code> - a sub√°rvore acabou, remova o elemento da pilha </li><li>  <code>FDT_PROP</code> - aqui est√° um pouco mais complicado: √© seguido por uma estrutura, seguida por len bytes de dados extras.  O nome da "vari√°vel" est√° no nome do deslocamento na tabela de cadeias <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> nameoff; }</code> </pre> </li></ul><br><p>  Bem, em geral, √© tudo: passamos por esta se√ß√£o, sem esquecer de observar o alinhamento em 4 bytes.  Ah, sim, uma mosca na pomada: os n√∫meros no FDT est√£o no formato big endian, ent√£o criamos uma fun√ß√£o simples </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre> <br><p>  Como resultado, no <code>riscv_entry</code> primeira coisa a fazer √© analisar o FDT e a parte do <code>head.S</code> respons√°vel pela transfer√™ncia do controle para o <code>riscv_entry</code> √© algo parecido com isto </p><br><pre> <code class="plaintext hljs"> .globl startup_32 #  --    ... startup_32: lla sp, boot_stack_top mv s0, a0 # s0, s1 -- callee-saved mv s1, a1 # ...  .bss #   jal _dl_start #      mv a0, s0 mv a1, s1 j riscv_entry</code> </pre> <br><p>  No registro <code>a0</code> hart id √© passado para n√≥s (hart √© algo como um fluxo de hardware na terminologia RISC-V) - eu ainda n√£o o uso, eu precisaria descobrir isso em um caso de thread √∫nico.  Em <code>a1</code> carregador de inicializa√ß√£o coloca um ponteiro para o FDT.  Passamos para a fun√ß√£o <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> . </p><br><p>  Agora, com o advento da FDT parsilka no meu c√≥digo, a sequ√™ncia de carregamento da placa ficou assim: </p><br><ul><li>  ligue a energia </li><li>  aguarde o console de inicializa√ß√£o U </li><li>  insira comandos para preparar o FDT correto.  Em particular, a <code>/chosen/bootargs</code> command <code>/chosen/bootargs</code> armazena a linha de comando do kernel.  Tudo o que eu retiro do FDT - intervalo de RAM, endere√ßo UART, ... - pode e deve ser deixado como est√° <br><pre> <code class="plaintext hljs">run fdtsetup fdt set /chosen bootargs "console=ttyS0 btrace"</code> </pre> </li><li>  usando o comando <code>fdt addr</code> , descubra o endere√ßo de download do FDT, se voc√™ n√£o procurou </li></ul><br><p>  E do lado do gdb, o comando √© adicionado </p><br><ul><li> <code>-ex 'set $a1=0xfdtaddr'</code> </li> </ul><br><h2 id="vyvod-informacii-na-ekran">  Sa√≠da de informa√ß√µes na tela </h2><br><p>  Como se viu, al√©m das inser√ß√µes do assembler, tamb√©m existem endere√ßos de mem√≥ria conhecidos.  Por exemplo, <code>SCREEN_ADR</code> (exatamente assim, com um <code>D</code> ), que aponta para a √°rea correspondente ao que √© exibido na tela.  Quando me deparei com isso, simplesmente coloquei com um gesto amplo tudo o que se refere a ele em <code>#if HAS_SCREEN</code> e depois <code>#if HAS_SCREEN</code> cegamente por um longo tempo.  Eu j√° pensei manualmente, de vez em quando, em despejar tudo isso no console, mas notei que o mesmo c√≥digo dolorosamente muitas seq√º√™ncias de escape saem para a porta serial.  Aconteceu que tudo j√° havia sido escrito antes de n√≥s, basta colocar as defini√ß√µes com mais precis√£o - e aqui est√°, a interface familiar (embora em preto e branco) na janela do minicom!  (No momento, o HAS_SCREEN n√£o √© usado - iniciei a matriz <code>dummy_con</code> para alterar o c√≥digo original no m√≠nimo.) </p><br><h2 id="otladka-na-qemu">  Depurando no QEMU </h2><br><p>  Ent√£o, depurei tudo em um quadro real e j√° h√° algum tempo - nem mesmo √†s cegas.  Mas tudo diminui a velocidade no JTAG - horror!  Bem, no final, tudo deve funcionar em hardware real, mas seria bom depurar no QEMU.  Ap√≥s v√°rias experi√™ncias, algo acabou sendo uma muleta, mas muito semelhante ao trabalho com uma prancha: </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M help Supported machines are: none empty machine sifive_e RISC-V Board compatible with SiFive E SDK sifive_u RISC-V Board compatible with SiFive U SDK spike_v1.10 RISC-V Spike Board (Privileged ISA v1.10) (default) spike_v1.9.1 RISC-V Spike Board (Privileged ISA v1.9.1) virt RISC-V VirtIO Board (Privileged ISA v1.10)</code> </pre> <br><p>  Examinamos quais placas o QEMU est√° pronto para emular.  Estou interessado em hardware compat√≠vel com <code>sifive_u</code> . </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace   $ ls -l on -rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on $ dtc -I dtb &lt; on &gt; on.dts #   $ vim on.dts #  bootargs $ dtc &lt; on.dts &gt; on.dtb &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code> </pre> <br><p>  Agora temos um blob da √°rvore de dispositivos "fixo".  <strong>Sem alterar a configura√ß√£o da VM</strong> (muletas!), Execute: </p><br><pre> <code class="plaintext hljs">qemu-system-riscv64 \ -M sifive_u -m 1g \ -serial stdio \ -s -S</code> </pre> <br><p>  <code>-serial stdio</code> redireciona a porta serial para o console, porque as seq√º√™ncias de escape ser√£o ativamente usadas.  As op√ß√µes <code>-s -S</code> aumentam o gdbserver e criam uma VM para pausar, respectivamente.  Voc√™ pode baixar o c√≥digo usando o <code>loader</code> , mas √© necess√°rio reiniciar o QEMU sempre. </p><br><p>  Voc√™ pode conectar usando </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:1234' \ -ex 'restore /path/to/on.dtb binary 0x80100000' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \ -ex 'add-symbol-file memtest_shared 0x80100000' \ -ex 'set $a1=0x80020000' \ -ex 'set $pc=0x80100000'</code> </pre> <br><p>  Como resultado, tudo funciona mais do que com intelig√™ncia! </p><br><h2 id="obschiy-princip-raboty">  Princ√≠pio geral do trabalho </h2><br><p> , ,  ,   Memtest86+   <code>btrace</code> ,        ,      (  ,     QEMU): </p><br><p><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="modo btrace"></p><br><p>  ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  ¬´¬ª   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   ‚Äî <code>mepc</code> (?),   ‚Äî <code>mtval</code> (    ?),    . </p><br><p><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="Instru√ß√£o ilegal"></p><br><p>   ,      : </p><br><p> <strong>head.S:</strong> </p><br><pre> <code class="plaintext hljs">#       #   = 0 ---   ,   #  ,    ,     ... lla t1, _trap_entry csrw mtvec, t1 # ... _trap_entry: csrr a0, mcause csrr a1, mepc csrr a2, mtval jal riscv_trap_entry</code> </pre> <br><p>  ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code> : </p><br><p> <strong>arch.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errors[] = { <span class="hljs-string"><span class="hljs-string">"Instruction address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Instruction access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Illegal instruction"</span></span>, <span class="hljs-string"><span class="hljs-string">"Breakpoint"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO access fault"</span></span>, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Instruction page fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load page fault"</span></span>, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Store/AMO page fault"</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">riscv_trap_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EXCP: "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cause &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, errors[cause]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { itoa(buf, cause); cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, buf); } cprint(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PC: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, epc, <span class="hljs-number"><span class="hljs-number">8</span></span>); cprint(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Addr: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, tval, <span class="hljs-number"><span class="hljs-number">8</span></span>); HALT(); }</code> </pre> <br><p>        ‚Äî    ¬´ ¬ª   .   ,   ¬´¬ª    ,  ,      ,  . </p><br><p>         :     .       ,  memtest  :    : ¬´       ,   ,    .        ¬ª.    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       ‚Äî    ¬´¬ª ,    memtest.       ,    <code>run_at</code> ,    memtest  <code>_start</code>  <code>_end</code>    (   ¬´¬ª  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      ¬´¬ª    ,    ¬´¬ª. </p><br><p>      ,    <strong> </strong>  <code>bss</code>    ‚Äî    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code> . </p><br><p>   ,  Memtest86+ ‚Äî ,         <code>barrier_s</code>    .       ,          . ,   ,       . </p><br><h2 id="podvodnye-kamni">   </h2><br><p>    ,   :   .   :           .    <em></em> : ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://stackoverflow.com/questions/12491578/whats-the-actual-effect-of-successful-unaligned-accesses-on-x86" rel="nofollow"> </a> ,   load/store  x86   ,     ‚Äî .    ,    QEMU    ,  ¬´  ,      ¬ª. </p><br><p> ,     ,  <em>  </em> ‚Äî   unaligned access  .. </p><br><p> ,   ,     RocketChip,   ‚Äî QEMU,   ,  ,   RocketChip ‚Äî unaligned access trap,  QEMU  ¬´  ¬ª. <br>   ¬´misaligned¬ª            ,   </p><br><blockquote> Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated. </blockquote><p>  , ,  ‚Äî   ,  user-mode code   ,             .     .   , ,   .   ,       ‚Äî -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped . </p><br><p>    :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    ‚Ä¶ ,     ‚Äî   : <code>head.S</code>       <code>initial_load_addr</code> ,    <code>riscv_entry</code>    <code>move_to_correct_addr</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_to_correct_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_start = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_start; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_end = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_end; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_start == low_test_addr || cur_start == high_test_adr) { <span class="hljs-comment"><span class="hljs-comment">//  ,     return; } if (cur_start == initial_load_addr &amp;&amp; (cur_start - low_test_addr) &lt; (cur_end - cur_start) ) { //   " ":   , //           //     ,    ,   //     ... serial_echo_print("FIRST STARTUP RELOCATION...\n"); void *temp_addr = (((uintptr_t)&amp;_end &gt;&gt; 12) + 1) &lt;&lt; 12; run_at(temp_addr, 0); } else { // ,    --- ,  . serial_echo_print("FINAL STARTUP RELOCATION...\n"); run_at(low_test_addr, 0); } }</span></span></code> </pre> <br><p> ,     ‚Äî   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code> . </p><br><p>     ,   ¬´¬ª ,    -,   ‚Äî  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code> ),   32- x86   <code>uint32_t</code> ,    ¬´ 64 ¬ª   <code>uint64_t</code> .       ¬´!!! Good: ffffffff Real: ffffffff Bad bits: 00000000¬ª.   ?       - -1,  32    1.   ,         ,        0‚Ä¶  ,     : ,  <code>ulong</code>      ( <code>uint32_t</code> ),          ( <code>uintptr_t</code> ). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    ‚Äî    UB. <del>     memtest  UBSan. </del>  ,  ,  UBSan   trap-on-error        JTAG. </p><br><h2 id="upakovyvaem-dlya-zagruzchika">    </h2><br><p> ,  memtest -  ,    ,          U-Boot. </p><br><p>       :    <code>mkimage</code>   U-Boot   <em>  Linux</em> : </p><br><pre> <code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \ -a 0x80000000 -e 0x80000000 \ -n memtest -d memtest.bin memtest.uboot</code> </pre> <br><p>      SD-      </p><br><pre> <code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code> </pre> <br><p> (   ,   <code>run</code>     ‚Äî        ). </p><br><p>      :       FDT: <code>0xbffb7c80</code> . ,  :    <code>ffffffff</code> ,     .     ,         (     ),    :   HiFive_U-Boot      : </p><br><pre> <code class="cpp hljs"> theKernel(machid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)images-&gt;ft_addr);</code> </pre> <br><p>    ,     </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*theKernel)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arch, uint params);</code> </pre> <br><p>  ,     , ,  ,  32        ,     <code>head.S</code> : </p><br><pre> <code class="plaintext hljs"> li t0, 0xffffffffL and a1, a1, t0</code> </pre> <br><h2 id="promezhutochnyy-itog">   </h2><br><p> ,  , - ,  ,     ,  : </p><br><ul><li>     x86.       ‚Äî       review         <strong>   </strong> </li><li>   SMP   RISC-V </li><li>        <code>arch/</code> -  </li><li>     <code>test.c</code>  RISC-V (      <code>-O0</code> !) </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484026/">https://habr.com/ru/post/pt484026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484012/index.html">Simplifique o processo de escrita em um bloco de notas</a></li>
<li><a href="../pt484014/index.html">10 mitos de SEO para deixar para tr√°s em 2020</a></li>
<li><a href="../pt484016/index.html">No√ß√µes b√°sicas de aprendizado profundo no exemplo do autoencoder de depura√ß√£o, n√∫mero da pe√ßa 1</a></li>
<li><a href="../pt484018/index.html">Lado t√©cnico de TI do iatismo</a></li>
<li><a href="../pt484020/index.html">Quem voc√™ est√° tentando impressionar com seus prazos?</a></li>
<li><a href="../pt484028/index.html">Horseshoe Bend - tablet convers√≠vel com visor dobr√°vel</a></li>
<li><a href="../pt484034/index.html">Implementa√ß√£o do esquema de trabalho do armazenamento direcionado de mercadorias com base na unidade cont√°bil do armaz√©m 1C Integrated Automation 2</a></li>
<li><a href="../pt484036/index.html">Novo grupo da ind√∫stria cria padr√£o universal para casas inteligentes</a></li>
<li><a href="../pt484046/index.html">Verificando o Emby com o PVS-Studio</a></li>
<li><a href="../pt484048/index.html">PHP e express√µes regulares: o b√°sico para iniciantes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>