<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🏭 👩🏾‍🍳 📪 Bermigrasi ke Google Cloud Platform (Google Cloud Platform - GCP) ♏️ 👶🏼 🛬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[bagian 2 dari 2] 


 [bagian 1 dari 2] 





 Bagaimana kami melakukannya? 


 Kami memutuskan untuk beralih ke GCP untuk meningkatkan kinerja aplika...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bermigrasi ke Google Cloud Platform (Google Cloud Platform - GCP)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/430874/"><h3 id="chast-2-iz-2">  [bagian 2 dari 2] </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">[bagian 1 dari 2]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos">  Bagaimana kami melakukannya? </h2><br><p>  Kami memutuskan untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">beralih ke GCP</a> untuk meningkatkan kinerja aplikasi - sambil meningkatkan skala, tetapi tanpa biaya yang signifikan.  Seluruh proses memakan waktu lebih dari 2 bulan.  Untuk mengatasi masalah ini, kami telah membentuk kelompok insinyur khusus. </p><br><p>  Dalam publikasi ini, kami akan berbicara tentang pendekatan yang dipilih dan implementasinya, serta bagaimana kami berhasil mencapai tujuan utama - untuk melaksanakan proses ini semulus mungkin dan mentransfer seluruh infrastruktur ke Google Cloud Platform, tanpa mengurangi kualitas layanan pengguna. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="gambar"></p><a name="habracut"></a><br><h2 id="planirovanie">  Perencanaan </h2><br><ol><li>  Daftar periksa terperinci telah disiapkan untuk mengidentifikasi setiap langkah yang mungkin.  Diagram alir telah dibuat untuk menggambarkan urutan. </li><li>  Rencana reset telah dikembangkan yang kami, jika ada, dapat digunakan. </li></ol><br><p>  Beberapa sesi curah pendapat - dan kami telah mengidentifikasi pendekatan yang paling mudah dipahami dan paling sederhana untuk mengimplementasikan skema aktif-aktif.  Terdiri dari fakta bahwa sekelompok kecil pengguna di-host di satu cloud, dan sisanya di host lain.  Namun, pendekatan ini menyebabkan masalah, terutama di sisi klien (terkait dengan manajemen DNS), dan menyebabkan keterlambatan dalam replikasi database.  Karena itu, hampir mustahil untuk mengimplementasikannya dengan aman.  Metode yang jelas tidak memberikan solusi yang diperlukan, dan kami harus mengembangkan strategi khusus. </p><br><p>  Berdasarkan diagram ketergantungan dan persyaratan keselamatan operasional, kami membagi layanan infrastruktur menjadi 9 modul. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="gambar"></p><br><p>  <em>(Modul dasar untuk menggunakan infrastruktur hosting)</em> </p><br><p>  Setiap kelompok infrastruktur mengelola layanan internal dan eksternal umum. </p><br><p>  ⊹ <strong>Layanan pesan infrastruktur</strong> : MQTT, HTTPs, Hemat, server Gunicorn, modul antrian, klien Async, server Jetty, cluster Kafka. <br>  ⊹ <strong>Layanan Gudang Data</strong> : Cluster Terdistribusi MongoDB, Redis, Cassandra, Hbase, MySQL, dan MongoDB. <br>  ⊹ <strong>Layanan analisis infrastruktur</strong> : Kafka cluster, cluster data warehouse (HDFS, HIVE). </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu">  Mempersiapkan hari yang penting: </h2><br><p>  ✓ Rencana terperinci untuk beralih ke GCP untuk setiap layanan: urutan, gudang data, rencana pengaturan ulang. <br>  ✓ Jejaring lintas proyek (shared cloud private virtual VPC [XPN]) di GCP untuk mengisolasi berbagai bagian infrastruktur, mengoptimalkan manajemen, meningkatkan keamanan dan konektivitas. <br>  ✓ Beberapa terowongan VPN antara GCP dan virtual private cloud (VPC) yang sedang berjalan untuk menyederhanakan transfer sejumlah besar data melalui jaringan selama replikasi, serta untuk kemungkinan penyebaran selanjutnya dari sistem paralel. <br>  ✓ Mengotomatiskan pemasangan dan konfigurasi seluruh tumpukan menggunakan sistem Chef. <br>  ✓ Skrip dan alat otomatisasi untuk penyebaran, pemantauan, pencatatan, dll. <br>  ✓ Konfigurasikan semua subnet yang diperlukan dan aturan firewall yang dikelola untuk aliran sistem. <br>  ✓ Replikasi di beberapa pusat data (Multi-DC) untuk semua sistem penyimpanan. <br>  ✓ Konfigurasikan penyeimbang beban (GLB / ILB) dan grup instance terkelola (MIG). <br>  ✓ Skrip dan kode untuk mentransfer wadah penyimpanan objek ke Penyimpanan Cloud GCP dengan pos-pos pemeriksaan. </p><br><p>  Segera, kami memenuhi semua prasyarat yang diperlukan dan menyiapkan daftar elemen untuk memindahkan infrastruktur ke platform GCP.  Setelah berbagai diskusi, serta mempertimbangkan jumlah layanan dan diagram ketergantungan mereka, kami memutuskan untuk mentransfer infrastruktur cloud ke GCP dalam tiga malam untuk mencakup semua layanan sisi server dan penyimpanan data. </p><br><h2 id="perehod">  Transisi </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki">  Strategi Transfer Load Balancer: </h3><br><p>  Kami mengganti cluster yang dikelola HAProxy yang sebelumnya digunakan dengan penyeimbang beban global untuk memproses puluhan juta koneksi pengguna aktif setiap hari. </p><br><p>  ⊹ <strong>Tahap 1:</strong> </p><br><ul><li>  MIG dibuat dengan aturan penerusan paket untuk meneruskan semua lalu lintas ke alamat IP MQTT di cloud yang ada. </li><li>  Penyeimbang SSL dan TCP Proxy telah dibuat dengan MIG sebagai bagian server. </li><li>  Untuk MIG, HAProxy diluncurkan dengan server MQTT sebagai bagian server. </li><li>  Dalam DNS, kebijakan perutean berbasis berat telah menambahkan alamat IP GLB eksternal. </li></ul><br><p>  Koneksi pengguna secara bertahap digunakan saat melacak kinerjanya. </p><br><p>  ⊹ <strong>Langkah 2:</strong> Transisi tonggak sejarah, mulailah mengerahkan layanan di GCP. <br>  ⊹ <strong>Tahap 3:</strong> Tahap akhir transisi, semua layanan ditransfer ke GCP. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="gambar"></p><br><p>  <em>(Tahapan transfer penyeimbang beban)</em> </p><br><p>  Pada tahap ini, semuanya berjalan seperti yang diharapkan.  Segera, tiba saatnya untuk menyebarkan beberapa layanan HTTP internal dalam GCP dengan routing - mengingat bobot dari koefisien.  Kami memantau dengan cermat semua indikator.  Ketika kami mulai meningkatkan lalu lintas secara bertahap, sehari sebelum transisi yang direncanakan, penundaan interaksi VPC melalui VPN (penundaan 40 ms - 100 ms dicatat, meskipun sebelumnya mereka kurang dari 10 ms) meningkat. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="gambar"></p><br><p>  <em>(Jepretan memeriksa keterlambatan jaringan saat dua VPC berinteraksi)</em> </p><br><p>  Pemantauan jelas menunjukkan: ada sesuatu yang salah dengan kedua saluran jaringan cloud menggunakan terowongan VPN.  Bahkan throughput terowongan VPN tidak mencapai tanda optimal.  Situasi ini mulai berdampak negatif pada beberapa layanan pengguna kami.  Kami segera mengembalikan semua layanan HTTP yang sebelumnya dimigrasikan ke keadaan semula.  Kami menghubungi tim pendukung TAM dan layanan cloud, memberikan data awal yang diperlukan dan mulai memahami mengapa penundaan bertambah.  Spesialis dukungan sampai pada kesimpulan bahwa bandwidth jaringan maksimum di saluran cloud antara dua penyedia layanan cloud telah tercapai.  Karenanya pertumbuhan keterlambatan jaringan selama transfer sistem internal. </p><br><p>  Peristiwa ini memaksa untuk menunda transisi ke cloud.  Penyedia layanan cloud tidak dapat menggandakan bandwidth dengan cukup cepat.  Karena itu, kami kembali ke tahap perencanaan dan merevisi strategi.  Kami memutuskan untuk mentransfer infrastruktur cloud ke GCP dalam satu malam, bukan tiga dan termasuk dalam rencana semua layanan dari bagian server dan penyimpanan data.  Ketika jam "X" tiba, semuanya berjalan lancar: beban kerja berhasil ditransfer ke Google Cloud tanpa disadari oleh pengguna kami! </p><br><h2 id="strategiya-perenosa-bazy-dannyh">  Strategi Migrasi Basis Data: </h2><br><p>  Itu diperlukan untuk mentransfer lebih dari 50 titik akhir basis data untuk DBMS relasional, penyimpanan dalam-memori, serta NoSQL dan cluster yang terdistribusi dan terukur dengan latensi rendah.  Kami telah menempatkan replika semua database di GCP.  Ini dilakukan untuk semua penyebaran kecuali HBase. </p><br><p>  ⊹ Replikasi <strong>Master-slave:</strong> diimplementasikan untuk cluster MySQL, Redis, MongoDB, dan MongoS. <br>  <strong>Replikasi Multi Multi-DC:</strong> diterapkan untuk cluster Cassandra. <br>  ⊹ <strong>Cluster Ganda: Cluster</strong> paralel telah dikonfigurasi untuk Gbase di GCP.  Data yang ada dimigrasikan, entri ganda dikonfigurasi sesuai dengan strategi menjaga konsistensi data di kedua cluster. </p><br><p>  Dalam kasus HBase, masalahnya ada pada Ambari.  Kami mengalami beberapa kesulitan ketika menempatkan cluster di beberapa pusat data, misalnya, ada masalah dengan DNS, skrip pengenalan rak, dll. </p><br><p>  Langkah terakhir (setelah memindahkan server) termasuk memindahkan replika ke server utama dan mematikan basis data lama.  Sesuai rencana, menentukan prioritas transfer database, kami menggunakan Zookeeper untuk konfigurasi yang diperlukan dari cluster aplikasi. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="gambar"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy">  Strategi Migrasi Layanan Aplikasi </h2><br><p>  Untuk mentransfer beban kerja layanan aplikasi dari hosting saat ini ke cloud GCP, kami menggunakan pendekatan lift-and-shift.  Untuk setiap layanan aplikasi, kami membuat grup instance yang dikelola (MIG) dengan penskalaan otomatis. </p><br><p>  Sesuai dengan rencana terperinci, kami mulai memigrasi layanan ke GCP, dengan mempertimbangkan urutan dan dependensi gudang data.  Semua layanan tumpukan perpesanan dimigrasikan ke GCP tanpa downtime.  Ya, ada beberapa gangguan kecil, tetapi kami segera menanganinya. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="gambar"></p><br><p>  Di pagi hari, saat aktivitas pengguna meningkat, kami dengan cermat mengikuti semua dasbor dan indikator untuk mengidentifikasi masalah dengan cepat.  Beberapa kesulitan benar-benar muncul, tetapi kami dapat dengan cepat menghilangkannya.  Salah satu masalah adalah karena keterbatasan penyeimbang beban internal (ILB), yang dapat menangani tidak lebih dari 20.000 koneksi bersamaan.  Dan kami membutuhkan 8 kali lebih banyak!  Oleh karena itu, kami menambahkan ILB tambahan ke lapisan manajemen koneksi kami. </p><br><p>  Pada jam-jam pertama beban puncak setelah transisi, kami mengontrol semua parameter terutama dengan hati-hati, karena seluruh beban tumpukan pesan ditransfer ke GCP.  Ada beberapa gangguan kecil yang kami tangani dengan sangat cepat.  Saat memigrasi layanan lain, kami mengambil pendekatan yang sama. </p><br><h2 id="perenos-hranilischa-obektov">  Migrasi penyimpanan objek: </h2><br><p>  Kami menggunakan layanan penyimpanan objek terutama dalam tiga cara. </p><br><p>  ⊹ Penyimpanan file media yang dikirim ke obrolan pribadi atau grup.  Periode penyimpanan ditentukan oleh kebijakan manajemen siklus hidup. <br>  ⊹ Penyimpanan gambar dan thumbnail profil pengguna. <br>  ⊹ Penyimpanan file media dari bagian "History" dan "Timeline" dan gambar mini yang sesuai. </p><br><p>  Kami menggunakan alat transfer penyimpanan Google untuk menyalin objek lama dari S3 ke GCS.  Kami juga menggunakan MIG berbasis Kafka khusus untuk mentransfer objek dari S3 ke GCS ketika logika khusus diperlukan. </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi">  Transisi dari S3 ke GCS mencakup langkah-langkah berikut: </h3><br><p>  ● Untuk case use pertama dari object store, kami mulai menulis data baru untuk S3 dan GCS, dan setelah berakhirnya kami mulai membaca data dari GCS menggunakan logika di sisi aplikasi.  Mentransfer data lama tidak masuk akal, dan pendekatan ini hemat biaya. <br>  ● Untuk kasus penggunaan kedua dan ketiga, kami mulai menulis objek baru ke GCS dan mengubah jalur untuk membaca data sehingga pencarian pertama kali dilakukan dalam GCS dan hanya kemudian, jika objek tidak ditemukan, dalam S3. <br>  Butuh <strong>berbulan</strong> - <strong>bulan untuk</strong> merencanakan, memverifikasi kebenaran konsep, menyiapkan dan membuat prototipe, tetapi kemudian kami memutuskan transisi dan mengimplementasikannya dengan sangat cepat.  Kami menilai risiko dan menyadari bahwa migrasi cepat lebih disukai dan hampir tidak terlihat. <br>  Proyek berskala besar ini telah membantu kami mendapatkan posisi yang kuat dan meningkatkan produktivitas tim di banyak bidang, karena sebagian besar operasi manual tentang pengelolaan infrastruktur cloud sekarang ada di masa lalu. <br>  ● Mengenai pengguna, sekarang kami telah menerima semua yang diperlukan untuk memastikan kualitas tertinggi dari layanan mereka.  Downtime hampir menghilang, dan fitur-fitur baru sedang diterapkan lebih cepat. <br>  ● Tim kami menghabiskan lebih sedikit waktu untuk tugas pemeliharaan dan dapat fokus pada proyek otomatisasi dan membuat alat baru. <br>  ● Kami mendapat akses ke seperangkat alat yang belum pernah ada sebelumnya untuk bekerja dengan data besar, serta fungsionalitas siap pakai untuk pembelajaran dan analisis mesin.  Lihat detailnya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini.</a> <br>  ● Komitmen Google Cloud untuk bekerja dengan proyek sumber terbuka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kubernetes</a> juga sejalan dengan rencana pengembangan kami untuk tahun ini. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id430874/">https://habr.com/ru/post/id430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id430864/index.html">Cocok bukan mainan?</a></li>
<li><a href="../id430866/index.html">Beijing akan memperkenalkan peringkat sosial bagi penduduk pada tahun 2020</a></li>
<li><a href="../id430868/index.html">Apa yang harus diingat saat membeli NGFW? Periksa daftar</a></li>
<li><a href="../id430870/index.html">Instal BigBlueButton di Ubuntu 16.04</a></li>
<li><a href="../id430872/index.html">Siapa yang akan memenangkan perdebatan mesh vs ESB</a></li>
<li><a href="../id430876/index.html">Pengembangan melalui pengujian: meningkatkan keterampilan</a></li>
<li><a href="../id430878/index.html">PhpStorm 2018.3 tersedia</a></li>
<li><a href="../id430880/index.html">Implementasi Pemrosesan Data Lainnya</a></li>
<li><a href="../id430882/index.html">Xiaomi Aqara Beralih redo dari ZigBee ke Z-Wave</a></li>
<li><a href="../id430884/index.html">Pabrik percetakan: mengapa "LANIT-Integration" membuka "percetakan" sendiri</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>