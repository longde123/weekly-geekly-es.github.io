<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÆ ‚§µÔ∏è ‚ôåÔ∏è Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind üë©üèΩ‚Äçüöí üêç üë©üèº‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo trata sobre c√≥mo configurar un servidor de correo moderno. 
 Postfix + Dovecot. SPF + DKIM + rDNS. Con IPv6. 
 Con cifrado TLS. Con sopo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413689/">  Este art√≠culo trata sobre c√≥mo configurar un servidor de correo moderno. <br>  Postfix + Dovecot.  SPF + DKIM + rDNS.  Con IPv6. <br>  Con cifrado TLS.  Con soporte para m√∫ltiples dominios, parte con un certificado SSL real. <br>  Con protecci√≥n antispam y alta calificaci√≥n antispam en otros servidores de correo. <br>  Con soporte para m√∫ltiples interfaces f√≠sicas. <br>  Con OpenVPN, que se conecta a trav√©s de IPv4 y que proporciona IPv6. <br><br>  Si no desea aprender todas estas tecnolog√≠as, pero desea configurar dicho servidor, este art√≠culo es para usted. <br><br>  No hay intentos de explicar cada detalle en el art√≠culo.  La explicaci√≥n va a lo que no est√° configurado de manera est√°ndar o es importante desde el punto de vista del consumidor. <br><a name="habracut"></a><br>  La motivaci√≥n para configurar un servidor de correo es mi viejo sue√±o.  Puede sonar tonto, pero en mi humilde opini√≥n, es mucho mejor que so√±ar con un auto nuevo de su marca favorita. <br><br>  La motivaci√≥n para configurar IPv6 es dos.  Los profesionales de TI necesitan aprender nuevas tecnolog√≠as constantemente para sobrevivir.  Quisiera hacer mi modesta contribuci√≥n a la lucha contra la censura. <br><br>  La motivaci√≥n para configurar OpenVPN es solo para que IPv6 funcione en la m√°quina local. <br>  La motivaci√≥n para configurar varias interfaces f√≠sicas es que en mi servidor una interfaz es "lenta pero ilimitada" y la otra es "r√°pida, pero con una tarifa". <br><br>  La motivaci√≥n para configurar los ajustes de Bind es que mi proveedor proporciona un servidor DNS inestable y Google tambi√©n se bloquea.  Quiero un servidor DNS estable para uso personal. <br><br>  Motivaci√≥n para escribir un art√≠culo: un borrador se escribi√≥ hace 10 meses y ya lo he examinado dos veces.  Si incluso el autor necesita esto regularmente, existe una alta probabilidad de que otros lo necesiten. <br><br>  No hay una soluci√≥n universal para el servidor de correo.  Pero intentar√© escribir algo como "hazlo as√≠ y luego, cuando todo funcione como deber√≠a, tira el exceso". <br><br>  Hay un servidor de Colocaci√≥n de tech.ru.  Es posible comparar con OVH, Hetzner, AWS.  Para resolver este problema, la cooperaci√≥n con tech.ru ser√° mucho m√°s efectiva. <br><br>  Debian 9 est√° instalado en el servidor. <br><br>  En el servidor hay 2 interfaces `eno1` y` eno2`.  El primero es ilimitado y el segundo es r√°pido, respectivamente. <br><br>  Hay 3 direcciones IP est√°ticas, XX.XX.XX.X0 y XX.XX.XX.X1 y XX.XX.XX.X2 en la interfaz `eno1` y XX.XX.XX.X5 en la interfaz` eno2`. <br><br>  Hay XXXX: XXXX: XXXX: XXXX :: / 64 un conjunto de direcciones IPv6 que se asignan a la interfaz `eno1` y desde all√≠ XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 a mi solicitud asignado a` eno2`. <br><br>  Hay 3 dominios `dominio1.com`,` dominio2.com`, `dominio3.com`.  Para `dominio1.com` y`dominio3.com` hay un certificado SSL. <br><br>  Hay una cuenta de Google a la que desea vincular el buz√≥n `vasya.pupkin @ domain1.com` (recibir correo y enviar correo directamente desde la interfaz de gmail). <br>  Deber√≠a haber un buz√≥n `support @ domain2.com`, una copia del correo desde el que quiero ver en mi correo.  Y rara vez es posible enviar algo en nombre de `support @ domain2.com` a trav√©s de la interfaz web. <br><br>  Deber√≠a haber un buz√≥n `ivanov @ domain3.com`, que Ivanov usar√° desde su iPhone. <br><br>  Las cartas enviadas deben cumplir con todos los requisitos actuales contra correo no deseado. <br>  Debe haber el nivel m√°s alto de cifrado proporcionado en las redes p√∫blicas. <br>  Debe haber compatibilidad con IPv6 para enviar y recibir correos electr√≥nicos. <br>  Debe haber un SpamAssassin que nunca borre correos electr√≥nicos.  Y rebotar√°, saltar√° o enviar√° la carpeta Spam a IMAP. <br>  El autoaprendizaje de SpamAssassin debe configurarse: si muevo la letra a la carpeta Spam, aprender√© de esto;  Si muevo la carta de la carpeta Spam, aprender√© de esto.  Resultados de aprendizaje de SpamAssassin: deben afectar el alcance del mensaje en la carpeta Spam. <br>  Los scripts PHP deber√≠an poder enviar correo en nombre de cualquier dominio en este servidor. <br>  Debe haber un servicio openvpn con la capacidad de usar IPv6 en un cliente que no tiene IPv6. <br><br>  Primero debe configurar las interfaces y el enrutamiento, incluido IPv6. <br>  Luego, deber√° configurar OpenVPN, que se conectar√° a trav√©s de IPv4 y proporcionar√° al cliente una direcci√≥n IPv6 est√°tica-real.  Este cliente tendr√° acceso a todos los servicios IPv6 en el servidor y acceso a cualquier recurso IPv6 en Internet. <br>  Entonces ser√° necesario configurar Postfix para enviar cartas + SPF + DKIM + rDNS y otras bagatelas similares. <br>  Luego deber√° configurar Dovecot y configurar Multidominio. <br>  Luego deber√° configurar SpamAssassin y configurar el entrenamiento. <br>  Finalmente, instale Bind. <br><br><h2>  ============== Multi-interfaces ============== </h2><br>  Para configurar las interfaces, debe registrar esto en "/ etc / network / interfaces". <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eno1 iface eno1 inet static address XX.XX.XX.X0/24 gateway XX.XX.XX.1 dns-nameservers 127.0.0.1 213.248.1.6 post-up ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t post-up ip route add default via XX.XX.XX.1 table eno1t post-up ip rule add table eno1t from XX.XX.XX.X0 post-up ip rule add table eno1t to XX.XX.XX.X0 auto eno1:1 iface eno1:1 inet static address XX.XX.XX.X1 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X1 post-up ip rule add table eno1t to XX.XX.XX.X1 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2 iface eno1 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1::/64 gateway X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:1 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE # The secondary network interface allow-hotplug eno2 iface eno2 inet static address XX.XX.XX.X5 netmask 255.255.255.0 post-up ip route add XX.XX.XX.0/24 dev eno2 src XX.XX.XX.X5 table eno2t post-up ip route add default via XX.XX.XX.1 table eno2t post-up ip rule add table eno2t from XX.XX.XX.X5 post-up ip rule add table eno2t to XX.XX.XX.X5 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t iface eno2 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2::/96 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE # OpenVPN network iface tun0 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80</span></span></code> </pre> <br>  Esta configuraci√≥n se puede aplicar en cualquier servidor en tech.ru (con una peque√±a coordinaci√≥n con el soporte) e inmediatamente funcionar√° como deber√≠a. <br><br>  Si la experiencia de configurar cosas similares para Hetzner, OVH - hay novia.  M√°s duro <br><br>  eno1 es el nombre de la tarjeta de red n. ¬∞ 1 (lenta pero ilimitada). <br>  eno2 es el nombre de la tarjeta de red # 2 (r√°pido, pero con una tarifa). <br>  tun0 es el nombre de la tarjeta de red virtual de OpenVPN. <br>  XX.XX.XX.X0 - IPv4 # 1 en eno1. <br>  XX.XX.XX.X1 - IPv4 # 2 en eno1. <br>  XX.XX.XX.X2 - IPv4 # 3 en eno1. <br>  XX.XX.XX.X5 - IPv4 # 1 en eno2. <br>  XX.XX.XX.1: puerta de enlace IPv4. <br>  XXXX: XXXX: XXXX: XXXX :: / 64 - IPv6 a todo el servidor. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 - IPv6 para eno2, todo lo dem√°s va a eno1 desde el exterior. <br>  XXXX: XXXX: XXXX: XXXX :: 1 - Puerta de enlace IPv6 (vale la pena se√±alar que puede / necesita hacer un amigo aqu√≠. Indique el interruptor IPv6). <br>  dns-nameservers: se especifican 127.0.0.1 (porque bind est√° instalado localmente) y 213.248.1.6 (esto es de tech.ru). <br><br>  ‚ÄúTable eno1t‚Äù y ‚Äútable eno2t‚Äù: el significado de estas reglas de ruta es que el tr√°fico que pasa por eno1 -&gt; lo atraviesa y el tr√°fico que pasa por eno2 -&gt; lo atraviesa.  Y tambi√©n las conexiones iniciadas por el servidor pasar√≠an por eno1. <br><br><pre> <code class="bash hljs">ip route add default via XX.XX.XX.1 table eno1t</code> </pre> <br>  Con este comando establecemos que cualquier tr√°fico incomprensible que se encuentre bajo cualquier regla con "tabla eno1t" marcado -&gt; enviar a la interfaz eno1. <br><br><pre> <code class="bash hljs">ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t</code> </pre> <br>  Con este comando configuramos que dirija cualquier tr√°fico iniciado por el servidor a la interfaz eno1. <br><br><pre> <code class="bash hljs">ip rule add table eno1t from XX.XX.XX.X0 ip rule add table eno1t to XX.XX.XX.X0</code> </pre> <br>  Con este comando, establecemos las reglas para marcar el tr√°fico nosotros mismos. <br><br><pre> <code class="bash hljs">auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2</code> </pre> <br>  Este bloque define el segundo IPv4 para la interfaz eno1. <br><br><pre> <code class="bash hljs">ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t</code> </pre> <br>  Con este comando establecemos la ruta desde clientes OpenVPN a IPv4 local, excepto XX.XX.XX.X0. <br>  ¬øPor qu√© este comando es suficiente para todos los IPv4? Todav√≠a no lo entiendo. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 gateway XXXX:XXXX:XXXX:XXXX::1</code> </pre> <br>  Esto establecemos la direcci√≥n de la interfaz en s√≠.  El servidor lo usar√° como una direcci√≥n "saliente".  Ya no se utilizar√°. <br><br>  ¬øPor qu√© se indica ": 1: 1 ::" tan complicado?  Que OpenVPN funcion√≥ correctamente y solo para esto.  M√°s sobre esto m√°s tarde. <br><br>  Sobre el tema de la puerta de enlace: as√≠ es como funciona.  Pero de la manera correcta: aqu√≠ debe especificar el conmutador IPv6 al que est√° conectado el servidor. <br><br>  Sin embargo, por alguna raz√≥n, IPv6 deja de funcionar si hago esto.  Tal vez estos sean algunos problemas de tech.ru. <br><br><pre> <code class="bash hljs">ip -6 addr add XXXX:XXXX:XXXX:XXXX:1:1:1:1/64 dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span></code> </pre> <br>  Esto est√° agregando direcciones IPv6 a la interfaz.  Si necesita cien direcciones, significa cien l√≠neas en este archivo. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 ... iface eno2 inet6 static address XXXX:XXXX:XXXX:XXXX:1:2::/96 ... iface tun0 inet6 static address XXXX:XXXX:XXXX:XXXX:1:3::/80</code> </pre> <br><blockquote>  Marc√≥ las direcciones y subredes de todas las interfaces para que quedara claro. <br>  eno1 - debe ser "/ 64" - porque este es nuestro grupo completo de direcciones. <br>  tun0: la subred debe ser mayor que eno1.  De lo contrario, no puede configurar la puerta de enlace IPv6 para clientes OpenVPN. <br>  eno2: la subred debe ser m√°s grande que tun0.  De lo contrario, los clientes de OpenVPN no podr√°n obtener direcciones IPv6 locales. <br>  Para mayor claridad, eleg√≠ el paso 16 de subred, pero incluso puede tomar el paso "1" si lo desea. <br>  En consecuencia, 64 + 16 = 80 y 80 + 16 = 96. <br><br>  Para mayor claridad: <br>  XXXX: XXXX: XXXX: XXXX: 1: 1: AAAA: AAAA: estas son direcciones que deben asignarse a sitios o servicios espec√≠ficos en la interfaz eno1. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2: AAAA: AAAA: estas son direcciones que deben asignarse a sitios o servicios espec√≠ficos en la interfaz eno2. <br>  XXXX: XXXX: XXXX: XXXX: 1: 3: AAAA: AAAA son direcciones que deben asignarse a clientes OpenVPN o usarse como direcciones de servicio OpenVPN. </blockquote><br><br>  Para configurar la red, deber√≠a ser posible reiniciar el servidor. <br>  Los cambios de IPv4 se recogen durante la ejecuci√≥n (aseg√∫rese de incluirlo en la pantalla; de lo contrario, este comando simplemente dejar√° caer la red en el servidor): <br><br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre> <br>  En el archivo "/ etc / iproute2 / rt_tables" agregue al final: <br><br><pre> <code class="bash hljs">100 eno1t 101 eno2t</code> </pre> <br>  Sin esto, no puede usar tablas personalizadas en el archivo "/ etc / network / interfaces". <br>  Los n√∫meros deben ser √∫nicos e inferiores a 65535. <br><br>  Los cambios de IPv6 cambian f√°cilmente sin reiniciar, pero para esto necesita aprender al menos tres comandos: <br><br><pre> <code class="bash hljs">ip -6 addr ... ip -6 route ... ip -6 neigh ...</code> </pre> <br>  Configuraci√≥n de "/etc/sysctl.conf" <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Uncomment the next line to enable packet forwarding for IPv4 net.ipv4.ip_forward = 1 # Do not accept ICMP redirects (prevent MITM attacks) net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 # Do not send ICMP redirects (we are not a router) net.ipv4.conf.all.send_redirects = 0 # For receiving ARP replies net.ipv4.conf.all.arp_filter = 0 net.ipv4.conf.default.arp_filter = 0 # For sending ARP net.ipv4.conf.all.arp_announce = 0 net.ipv4.conf.default.arp_announce = 0 # Enable IPv6 net.ipv6.conf.all.disable_ipv6 = 0 net.ipv6.conf.default.disable_ipv6 = 0 net.ipv6.conf.lo.disable_ipv6 = 0 # IPv6 configuration net.ipv6.conf.all.autoconf = 1 net.ipv6.conf.all.accept_ra = 0 # For OpenVPN net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1 # For nginx on boot net.ipv6.ip_nonlocal_bind = 1</span></span></code> </pre> <br>  Estas son las configuraciones sysctl de mi servidor.  Tomo nota de lo importante. <br><br><pre> <code class="bash hljs">net.ipv4.ip_forward = 1</code> </pre> <br>  Sin esto, OpenVPN no funcionar√° de ninguna manera. <br><br><pre> <code class="bash hljs">net.ipv6.ip_nonlocal_bind = 1</code> </pre> <br>  Cualquier persona que intente vincular IPv6 (por ejemplo nginx) justo despu√©s de que la interfaz est√© activada recibir√° un error.  Que tal direcci√≥n no est√° disponible. <br><br>  Para evitar tal situaci√≥n, se realiza dicha configuraci√≥n. <br><br><pre> <code class="bash hljs">net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1</code> </pre> <br>  Sin estas configuraciones de IPv6, el tr√°fico del cliente OpenVPN no va al mundo. <br><br>  Otras configuraciones son irrelevantes o no recuerdo por qu√© lo son. <br>  Pero por si acaso, lo dejo "como est√°". <br><br>  Para que los cambios en este archivo se recojan sin reiniciar el servidor, debe ejecutar el comando: <br><br><pre> <code class="bash hljs">sysctl -p</code> </pre> <br>  M√°s detalles sobre las reglas de "tabla": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/post/108690</a> <br><br><h2>  ============== OpenVPN ============== </h2><br>  OpenVPN IPv4 no funciona sin iptables. <br><br>  Tengo estas iptables para VPN: <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 <span class="hljs-comment"><span class="hljs-comment">##iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</span></span></code> </pre> <br>  YY.YY.YY.YY es mi direcci√≥n IPv4 est√°tica de la m√°quina local. <br>  10.8.0.0/24: red IPv4 openvpn.  Direcciones IPv4 para clientes openvpn. <br>  La secuencia de reglas es importante. <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT ... iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</code> </pre> <br>  Esta es una limitaci√≥n para que solo yo pueda usar OpenVPN desde mi IP est√°tica. <br><br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 --  -- iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE</code> </pre> <br>  Para reenviar paquetes IPv4 entre clientes OpenVPN e Internet, debe registrar uno de estos comandos. <br><br>  Para diferentes casos, una de las opciones no es adecuada. <br>  Ambos equipos son adecuados para mi caso. <br>  Despu√©s de leer la documentaci√≥n, eleg√≠ la primera opci√≥n, porque consume menos CPU. <br><br>  Para que todas las configuraciones de iptables se recojan despu√©s del reinicio, debe guardarlas en alg√∫n lugar. <br><br><pre> <code class="bash hljs">iptables-save &gt; /etc/iptables/rules.v4 ip6tables-save &gt; /etc/iptables/rules.v6</code> </pre> <br>  Tales nombres no fueron elegidos por casualidad.  El paquete iptables-persistent los usa. <br><br><pre> <code class="bash hljs">apt-get install iptables-persistent</code> </pre> <br>  Instalaci√≥n del paquete principal de OpenVPN: <br><br><pre> <code class="bash hljs">apt-get install openvpn easy-rsa</code> </pre> <br>  Configure una plantilla para certificados (sustituya sus valores): <br><br><pre> <code class="bash hljs">make-cadir ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca ln -s openssl-1.0.0.cnf openssl.cnf</code> </pre> <br>  Editemos la configuraci√≥n de la plantilla de certificado: <br><br><pre> <code class="bash hljs">mcedit vars</code> </pre> <br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># These are the default values for fields # which will be placed in the certificate. # Don't leave any of these fields blank. export KEY_COUNTRY="RU" export KEY_PROVINCE="Krasnodar" export KEY_CITY="Dinskaya" export KEY_ORG="Own" export KEY_EMAIL="admin@domain1.com" export KEY_OU="VPN" # X509 Subject Field export KEY_NAME="server" ...</span></span></code> </pre> <br>  Crear un certificado de servidor: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./clean-all ./build-ca ./build-key-server server ./build-dh openvpn --genkey --secret keys/ta.key</code> </pre> <br>  Prepararemos la oportunidad de crear los archivos resultantes "client-name.opvn": <br><br><pre> <code class="bash hljs">mkdir -p ~/client-configs/files chmod 700 ~/client-configs/files cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf mcedit ~/client-configs/base.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client mode client # Interface tunnel type dev tun # TCP protocol proto tcp-client # Address/Port of VPN server remote XX.XX.XX.X0 1194 # Don't bind to local port/address nobind # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Remote peer must have a signed certificate remote-cert-tls server ns-cert-type server # Enable compression comp-lzo # Custom ns-cert-type server tls-auth ta.key 1 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Prepararemos un script que unir√° todos los archivos en un solo archivo opvn. <br><br><pre> <code class="bash hljs">mcedit ~/client-configs/make_config.sh chmod 700 ~/client-configs/make_config.sh</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # First argument: Client identifier KEY_DIR=~/openvpn-ca/keys OUTPUT_DIR=~/client-configs/files BASE_CONFIG=~/client-configs/base.conf cat ${BASE_CONFIG} \ &lt;(echo -e '&lt;ca&gt;') \ ${KEY_DIR}/ca.crt \ &lt;(echo -e '&lt;/ca&gt;\n&lt;cert&gt;') \ ${KEY_DIR}/${1}.crt \ &lt;(echo -e '&lt;/cert&gt;\n&lt;key&gt;') \ ${KEY_DIR}/${1}.key \ &lt;(echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;') \ ${KEY_DIR}/ta.key \ &lt;(echo -e '&lt;/tls-auth&gt;') \ &gt; ${OUTPUT_DIR}/${1}.ovpn</span></span></code> </pre> <br>  Creamos el primer cliente OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./build-key client-name <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/client-configs ./make_config.sh client-name</code> </pre> <br>  El archivo "~ / client-configs / files / client-name.ovpn" se env√≠a al cliente. <br><br>  Para los clientes de iOS, deber√° hacer el truco: <br>  El contenido de la etiqueta tls-auth debe estar sin comentarios. <br>  Y tambi√©n ponga "key-direction 1" inmediatamente antes de la etiqueta "tls-auth". <br><br>  Configure la configuraci√≥n del servidor OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca/keys cp ca.crt ca.key server.crt server.key ta.key dh2048.pem /etc/openvpn gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | tee /etc/openvpn/server.conf mcedit /etc/openvpn/server.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Listen port port 1194 # Protocol proto tcp-server # IP tunnel dev tun0 tun-ipv6 push tun-ipv6 # Master certificate ca ca.crt # Server certificate cert server.crt # Server private key key server.key # Diffie-Hellman parameters dh dh2048.pem # Allow clients to communicate with each other client-to-client # Client config dir client-config-dir /etc/openvpn/ccd # Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh" # Server mode and client subnets server 10.8.0.0 255.255.255.0 server-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80 topology subnet # IPv6 routes push "route-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:/64" push "route-ipv6 2000::/3" # DNS (for Windows) # These are OpenDNS push "dhcp-option DNS 208.67.222.222" push "dhcp-option DNS 208.67.220.220" # Configure all clients to redirect their default network gateway through the VPN push "redirect-gateway def1 bypass-dhcp" push "redirect-gateway ipv6" #For iOS # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Ping every 10s. Timeout of 120s. keepalive 10 120 # Enable compression comp-lzo # User and group user vpn group vpn # Log a short status status openvpn-status.log # Logging verbosity ##verb 4 # Custom config tls-auth ta.key 0 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Esto es necesario para establecer una direcci√≥n est√°tica para cada cliente (no es necesario, pero yo uso): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client config dir client-config-dir /etc/openvpn/ccd</span></span></code> </pre> <br>  El detalle m√°s dif√≠cil y clave. <br><br>  Desafortunadamente, OpenVPN a√∫n no puede configurar de manera independiente la puerta de enlace IPv6 para los clientes. <br>  Tenemos que reenviar esto manualmente para cada cliente. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh"</span></span></code> </pre> <br>  Archivo "/etc/openvpn/server-clientconnect.sh": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") echo $ipv6 fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Create proxy rule /sbin/ip -6 neigh add proxy $ipv6 dev eno1</span></span></code> </pre> <br><br>  Archivo "/etc/openvpn/server-clientdisconnect.sh": <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Delete proxy rule /sbin/ip -6 neigh del proxy $ipv6 dev eno1</span></span></code> </pre> <br>  Ambos scripts usan el archivo "/ etc / openvpn / variables": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Subnet prefix=X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">2: # netmask prefixlen=112</span></span></code> </pre> <br>  ¬øPor qu√© est√° escrito aqu√≠? Me resulta dif√≠cil recordarlo. <br><br>  Ahora parece extra√±o netmask = 112 (justo deber√≠a haber 96). <br>  Y el prefijo es extra√±o, no coincide con la red tun0. <br>  Pero est√° bien, lo dejo "como est√°". <br><br><pre> <code class="bash hljs">cipher DES-EDE3-CBC</code> </pre> <br>  Este es un aficionado: eleg√≠ este m√©todo de cifrar la conexi√≥n. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s informaci√≥n sobre c√≥mo configurar OpenVPN IPv4.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s informaci√≥n sobre c√≥mo configurar OpenVPN IPv6.</a> <br><br><h2>  ============== Postfix ============== </h2><br>  Instalaci√≥n del paquete principal: <br><br><pre> <code class="bash hljs">apt-get install postfix</code> </pre> <br>  Al instalar, seleccione "sitio de internet". <br><br>  Mi "/etc/postfix/main.cf" se ve as√≠: <br><br><pre> <code class="bash hljs">smtpd_banner = <span class="hljs-variable"><span class="hljs-variable">$myhostname</span></span> ESMTP <span class="hljs-variable"><span class="hljs-variable">$mail_name</span></span> (Debian/GNU) biff = no <span class="hljs-comment"><span class="hljs-comment"># appending .domain is the MUA's job. append_dot_mydomain = no readme_directory = no # See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on # fresh installs. compatibility_level = 2 # TLS parameters smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key smtpd_use_tls=yes smtpd_tls_auth_only = yes smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1 smtp_tls_security_level = may smtp_tls_ciphers = export smtp_tls_protocols = !SSLv2, !SSLv3 smtp_tls_loglevel = 1 smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination myhostname = domain1.com alias_maps = hash:/etc/aliases alias_database = hash:/etc/aliases myorigin = domain1.com mydestination = localhost relayhost = mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 mailbox_size_limit = 0 recipient_delimiter = + inet_interfaces = all inet_protocols = ipv4 internal_mail_filter_classes = bounce # Storage type virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf # SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, #reject_invalid_hostname, #reject_unknown_recipient_domain, reject_unauth_destination, reject_rbl_client sbl.spamhaus.org, check_policy_service unix:private/policyd-spf smtpd_helo_restrictions = #reject_invalid_helo_hostname, #reject_non_fqdn_helo_hostname, reject_unknown_helo_hostname smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_helo_hostname, permit # SPF policyd-spf_time_limit = 3600 # OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock # IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br>  Consideremos los detalles de esta configuraci√≥n. <br><br><pre> <code class="bash hljs">smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br><br><hr><blockquote><div class="spoiler">  <b class="spoiler_title">Seg√∫n los ciudadanos de Khabrovsk, este bloque contiene "informaci√≥n err√≥nea y tesis falsas".</b> <div class="spoiler_text">  Solo 8 a√±os despu√©s del comienzo de mi carrera, comenc√© a entender c√≥mo funciona SSL. <br><br>  Por lo tanto, me tomar√© la libertad de describir c√≥mo usar SSL (sin responder las preguntas ‚Äú¬øC√≥mo funciona?‚Äù Y ‚Äú¬øPor qu√© funciona?‚Äù). <br><br>  La base del cifrado moderno es la creaci√≥n de un par de claves (dos l√≠neas muy largas de caracteres). <br><br>  Una "clave" es privada, la otra es "p√∫blica".  Mantenemos la clave privada con mucho cuidado en secreto.  Distribuimos la clave p√∫blica a todos. <br><br>  Con una clave p√∫blica, puede cifrar una cadena de texto para que solo el propietario de la clave privada pueda descifrar. <br>  Bueno, esa es toda la base de la tecnolog√≠a. <br><br>  Paso # 1 - sitios https. <br>  Al acceder al sitio, el navegador aprende del servidor web que el sitio es https y, por lo tanto, solicita una clave p√∫blica. <br>  El servidor web da la clave p√∫blica.  Usando la clave p√∫blica, el navegador encripta la solicitud http y la env√≠a. <br>  El contenido de la solicitud http solo puede ser le√≠do por alguien que tenga una clave privada, es decir, solo el servidor al que se realiza la llamada. <br>  Http-request contiene al menos un URI.  Por lo tanto, si el pa√≠s est√° tratando de restringir el acceso no a todo el sitio, sino a una p√°gina espec√≠fica, entonces para los sitios https esto no se puede hacer. <br><br>  El paso 2 es la respuesta encriptada. <br>  El servidor web proporciona una respuesta que se puede leer f√°cilmente en el camino. <br>  La soluci√≥n es extremadamente simple: el navegador genera localmente el mismo par de claves p√∫blica-privada para cada sitio https. <br>  Y junto con la solicitud de la clave p√∫blica del sitio, env√≠a su clave p√∫blica local. <br>  El servidor web lo recuerda y, cuando env√≠a una respuesta http, se cifra con esta clave p√∫blica de un cliente espec√≠fico. <br>  Ahora, la respuesta http solo puede ser descifrada por el propietario de la clave privada del navegador del cliente (es decir, el propio cliente). <br><br>  Paso n√∫mero 3: establecer una conexi√≥n segura a trav√©s de un canal p√∫blico. <br>  En el ejemplo No. 2 hay una vulnerabilidad: nada impide que los simpatizantes intercepten la solicitud http y editen la informaci√≥n de clave p√∫blica. <br>  Por lo tanto, el intermediario ver√° casi todo el contenido de los mensajes enviados y recibidos hasta que cambie el canal de comunicaci√≥n. <br>  Combatir esto es extremadamente simple: simplemente env√≠e la clave p√∫blica del navegador como un mensaje cifrado con la clave p√∫blica del servidor web. <br>  El servidor web env√≠a una respuesta como "su clave p√∫blica es as√≠" y cifra este mensaje con la misma clave p√∫blica. <br>  El navegador mira la respuesta: si se recibe el mensaje "su clave p√∫blica es as√≠", esta es una garant√≠a del 100% de que este canal de comunicaci√≥n es seguro. <br>  ¬øQu√© tan seguro es? <br>  La creaci√≥n de un canal de comunicaci√≥n tan seguro ocurre a una velocidad ping * 2.  Por ejemplo, 20ms. <br>  Un atacante debe tener la clave privada de una de las partes por adelantado.  O tome una clave privada por un par de milisegundos. <br>  Hackear una clave privada moderna llevar√° d√©cadas en una supercomputadora. <br><br>  Paso # 4: base de datos p√∫blica de claves p√∫blicas. <br>  Obviamente, en toda esta historia existe la posibilidad de que un atacante se sienta en el canal de comunicaci√≥n entre el cliente y el servidor. <br>  El servidor presenta la oportunidad para el cliente y el cliente debe presentar el servidor.  Y emule un par de claves en ambas direcciones. <br>  Luego, el atacante ver√° todo el tr√°fico y podr√° "editar" el tr√°fico. <br>  Por ejemplo, cambie la direcci√≥n donde enviar dinero o copie la contrase√±a del banco en l√≠nea o bloquee el contenido "objetable". <br>  Para combatir a estos atacantes, crearon una base de datos p√∫blica con claves p√∫blicas para cada sitio https. <br>  Cada navegador "sabe" acerca de la existencia de aproximadamente 200 de estas bases de datos.  Esto est√° preinstalado en cada navegador. <br>  El "conocimiento" est√° respaldado por una clave p√∫blica para cada certificado.  Es decir, es imposible simular una conexi√≥n con cada autoridad de certificaci√≥n espec√≠fica. <br><br>  Ahora hay una comprensi√≥n simple de c√≥mo usar SSL para https. <br>  Si mueve sus cerebros, quedar√° claro c√≥mo los servicios especiales pueden descifrar algo en este dise√±o.  Pero les costar√° enormes esfuerzos. <br>  Y organizaciones m√°s peque√±as que la NSA o la CIA: es casi imposible romper el nivel de protecci√≥n existente, incluso para vip. <br><br>  Tambi√©n agregar√© sobre conexiones ssh.  No hay claves p√∫blicas, qu√© hacer.  El problema se resuelve de dos maneras. <br>  Opci√≥n de contrase√±a ssh: <br>  En la primera conexi√≥n, el cliente ssh deber√≠a advertir que aqu√≠ tenemos una nueva clave p√∫blica del servidor ssh. <br>  Y con m√°s conexiones, si aparece la advertencia "una nueva clave p√∫blica del servidor ssh", significar√° que est√°n tratando de escucharlo. <br>  O en la primera conexi√≥n que le escucharon, y ahora est√° hablando con el servidor sin intermediarios. <br>  En realidad, debido al hecho de que las escuchas telef√≥nicas se revelan f√°cil, r√°pidamente y sin esfuerzo, este ataque se usa solo en casos especiales para un cliente espec√≠fico. <br><br>  Opci√≥n ssh clave: <br>  Tomamos una unidad flash, escribimos una clave privada para el servidor ssh (para esto hay t√©rminos y muchos matices importantes, pero estoy escribiendo un programa educativo, no instrucciones de uso). <br>  Dejamos la clave p√∫blica en la m√°quina donde estar√° el cliente ssh y tambi√©n la mantenemos en secreto. <br>  Traemos la unidad flash al servidor, pegamos, copiamos la clave privada y la quemamos y dispersamos el polvo en el viento (o al menos formateamos con ceros). <br>  Eso es todo: despu√©s de tal operaci√≥n, ser√° imposible descifrar una conexi√≥n ssh de este tipo.  Por supuesto, durante 10 a√±os puedes ver el tr√°fico en una supercomputadora, pero esta es una historia diferente. <br><br>  Pido disculpas por el tema. <br></div></div></blockquote>  As√≠ que ahora que se conoce la teor√≠a.  Le contar√© sobre el flujo de creaci√≥n del certificado SSL. <br><br>  Usando "openssl genrsa" creamos una clave privada y "espacios en blanco" para la clave p√∫blica. <br>  Enviamos los "espacios en blanco" a una empresa externa, a la que pagamos aproximadamente $ 9 por el certificado m√°s simple. <br><br>  En un par de horas, recibimos de esta compa√±√≠a de terceros nuestra clave "p√∫blica" y otro conjunto de varias claves p√∫blicas. <br><br>  ¬øPor qu√© una compa√±√≠a de terceros debe pagar por la emisi√≥n de mi clave p√∫blica? Un tema separado que no consideraremos aqu√≠. <br><br>  Ahora est√° claro cu√°l es el significado de la inscripci√≥n: <br><br><pre> <code class="plaintext hljs">smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br>  En la carpeta "/ etc / ssl" se almacenan todos los archivos para las preguntas SSL. <br>  dominio1.com: nombre de dominio. <br>  2018 es el a√±o de la creaci√≥n de claves. <br>  "Clave": designaci√≥n de que el archivo es de clave privada. <br><br>  Y el significado de este archivo: <br><br>  smtpd_tls_cert_file = / etc / ssl / domain1.com.2018.chained.crt <br>  dominio1.com: nombre de dominio. <br>  2018 es el a√±o de la creaci√≥n de claves. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encadenado: una designaci√≥n de que hay una cadena de claves p√∫blicas (la primera es nuestra clave p√∫blica y el resto es lo que proviene de la empresa que emiti√≥ la clave p√∫blica). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crt: designaci√≥n de que hay un certificado listo (clave p√∫blica con explicaciones t√©cnicas).</font></font><br><br><pre> <code class="bash hljs">smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = XXXX:XXXX:XXXX:XXXX:1:1:1:1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta configuraci√≥n no se utiliza en este caso, pero se escribe como un ejemplo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a que un error en este par√°metro conducir√° al env√≠o de spam desde su servidor (sin su voluntad). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego demuestre a todos que no tiene la culpa.</font></font><br><br><pre> <code class="bash hljs">recipient_delimiter = +</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiz√°s muchos no lo saben, por lo que este es un s√≠mbolo est√°ndar para el pastoreo, y esto es compatible con la mayor√≠a de los servidores de correo modernos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, si tiene un buz√≥n "username@gmail.com" intente enviarlo a "username+spam@gmail.com" - vea qu√© sucede.</font></font><br><br><pre> <code class="bash hljs">inet_protocols = ipv4</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiz√°s esto sea confuso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero esto no es justo. </font><font style="vertical-align: inherit;">Cada nuevo dominio es por defecto solo IPv4, luego habilito IPv6 para cada uno individualmente.</font></font><br><br><pre> <code class="bash hljs">virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ establecemos que todo el correo entrante va a palomar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y las reglas para dominio, buz√≥n, alias: busque en la base de datos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postfix/mysql-virtual-mailbox-domains.cf</font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_domains WHERE name=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-mailbox-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-alias-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT destination FROM virtual_aliases WHERE <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora, Postfix sabe que solo puede aceptar correo para su posterior env√≠o mediante autorizaci√≥n con Dovecot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realmente no entiendo por qu√© esto se duplica aqu√≠. </font><font style="vertical-align: inherit;">Ya hemos indicado en virtual_transport todo lo que se necesita. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero el sistema de postfix es muy antiguo, probablemente sean los castillos de los viejos tiempos.</font></font><br><br><pre> <code class="bash hljs">smtpd_recipient_restrictions = ... smtpd_helo_restrictions = ... smtpd_client_restrictions = ...</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto se configura para cada servidor de correo a su manera. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengo 3 servidores de correo a mi disposici√≥n y estas configuraciones son muy diferentes debido a los diferentes requisitos de uso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debe configurar con cuidado; de lo contrario, el spam lo inundar√° o, lo que es peor, el spam lo inundar√°.</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SPF policyd-spf_time_limit = 3600</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuraci√≥n para alg√∫n tipo de complemento relacionado con la verificaci√≥n SPF de mensajes entrantes. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configurando que todas las cartas salientes debemos proporcionar una firma DKIM. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un detalle clave en el enrutamiento de correo electr√≥nico al enviar correos electr√≥nicos desde scripts php. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/postfix/sdd_transport.pcre":</font></font><br><br><pre> <code class="bash hljs">/^www-domain1@domain1\.com$/ domain1: /^www-domain2@domain1\.com$/ domain2: /^www-domain3@domain1\.com$/ domain3: /@domain1\.com$/ domain1: /@domain2\.com$/ domain2: /@domain3\.com$/ domain3:</code> </pre> <br><blockquote>  ‚Äî  .  ‚Äî ,   . <br> Postfix     ‚Äî        . <br><br>     postfix    ‚Äî    ¬´master.cf¬ª. <br><br>  4, 5, 6 ‚Äî  .       ‚Äî    . <br>     php       ¬´from¬ª.      . <br><br>     ‚Äî       nginx+fpm. <br><br>  ‚Äî       linux-user .    fpm-pool. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fpm-pool usa cualquier versi√≥n de php (esto es genial cuando puedes usar una versi√≥n diferente de php e incluso un php.ini diferente en el mismo servidor para sitios vecinos). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, un usuario de Linux en particular "www-domain2" tiene un sitio domain2.com. </font><font style="vertical-align: inherit;">Este sitio tiene un c√≥digo para enviar cartas sin especificar el campo de origen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, incluso en este caso, las letras desaparecer√°n correctamente y nunca entrar√°n en el correo basura.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mi "/etc/postfix/master.cf" tiene este aspecto: </font></font><br><br><pre> <code class="bash hljs">... smtp inet n - y - - smtpd -o content_filter=spamassassin ... submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject ... policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span> ... domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1 domain2 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X5 -o smtp_helo_name=domain2.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:2:1:1 -o syslog_name=postfix-domain2 domain3 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X2 -o smtp_helo_name=domain3 -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:5:1 -o syslog_name=postfix-domain3</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El archivo no est√° completamente dado, ya es muy grande. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not√≥ solo lo que ha cambiado.</font></font><br><br><pre> <code class="bash hljs">smtp inet n - y - - smtpd -o content_filter=spamassassin ... spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estos son los ajustes relacionados con spamassasin, sobre esto m√°s adelante. </font></font><br><br><pre> <code class="bash hljs">submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le permitimos conectarse al servidor de correo a trav√©s del puerto 587. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para hacer esto, aseg√∫rese de iniciar sesi√≥n.</font></font><br><br><pre> <code class="bash hljs">policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Activa la verificaci√≥n SPF. </font></font><br><br><pre> <code class="bash hljs">apt-get install postfix-policyd-spf-python</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instale el paquete para verificaciones SPF anteriores. </font></font><br><br><pre> <code class="bash hljs">domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1</code> </pre> <br><blockquote>    .          IPv4/IPv6 . <br><br>    rDNS. rDNS ‚Äî   -   IP . <br>         ,  helo   rDNS  ,    email. <br><br>  helo    ,      ‚Äî   . <br><br> Helo   rDNS ‚Äî    . <br>        IP . <br>  OVH ‚Äî      rDNS. <br>  tech.ru ‚Äî    . <br>  AWS ‚Äî    . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Inet_protocols" y "smtp_bind_address6": as√≠ es como habilitamos el soporte de IPv6. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para IPv6, tambi√©n debe registrar rDNS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Syslog_name", y esto es para la conveniencia de leer registros.</font></font></blockquote><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomiendo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comprar certificados </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">aqu√≠</font></a><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurando un mont√≥n de postfix + dovecot aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de SPF.</font></font></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Dovecot ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql dovecot-antispam</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure mysql, instale los paquetes ellos mismos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/10-auth.conf"</font></font><br><br><pre> <code class="bash hljs">disable_plaintext_auth = yes auth_mechanisms = plain login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La autorizaci√≥n solo est√° encriptada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/10-mail.conf"</font></font><br><br><pre> <code class="bash hljs">mail_location = maildir:/var/mail/vhosts/%d/%n</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ indicamos la ubicaci√≥n de las letras. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiero que se almacenen en archivos y se agrupen por dominio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/10-master.conf"</font></font><br><br><pre> <code class="bash hljs">service imap-login { inet_listener imap { port = 0 } inet_listener imaps { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 0 } inet_listener pop3s { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 995 ssl = yes } } service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { mode = 0600 user = postfix group = postfix } } service imap { } service pop3 { } service auth { unix_listener auth-userdb { mode = 0600 user = vmail } unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } user = dovecot } service auth-worker { user = vmail } service dict { unix_listener dict { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es el archivo de configuraci√≥n principal de palomar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ desconectamos las conexiones no seguras. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y permitir conexiones seguras. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/10-ssl.conf"</font></font><br><br><pre> <code class="bash hljs">ssl = required ssl_cert = &lt;/etc/nginx/ssl/domain1.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain1.com.2018.key <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> XX.XX.XX.X5 { ssl_cert = &lt;/etc/nginx/ssl/domain2.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain2.com.2018.key }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar ssl. </font><font style="vertical-align: inherit;">Indicamos que se requiere ssl. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y el certificado en s√≠. </font><font style="vertical-align: inherit;">Y un detalle importante es la directiva "local". </font><font style="vertical-align: inherit;">Indica cuando se conecta a qu√© IPv4 local, qu√© certificado SSL usar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por cierto, IPv6 no est√° configurado aqu√≠, corregir√© esta omisi√≥n como un hilo m√°s adelante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X5 (dominio2): sin certificado. </font><font style="vertical-align: inherit;">Para conectar clientes, debe especificar domain1.com. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X2 (dominio3): hay un certificado, puede especificar dominio1.com o dominio3.com para conectar clientes.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Archivo "/etc/dovecot/conf.d/15-lda.conf" </font></font><br><br><pre> <code class="bash hljs">protocol lda { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto ser√° necesario en el futuro para spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/20-imap.conf"</font></font><br><br><pre> <code class="bash hljs">protocol imap { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> antispam }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un complemento antispam. </font><font style="vertical-align: inherit;">Es necesario para entrenar spamassasin en el momento de la transferencia hacia / desde la carpeta Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/20-pop3.conf"</font></font><br><br><pre> <code class="bash hljs">protocol pop3 { }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solo ese archivo es. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/20-lmtp.conf"</font></font><br><br><pre> <code class="bash hljs">protocol lmtp { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve postmaster_address = admin@domain1.com }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar lmtp. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/90-antispam.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { antispam_backend = pipe antispam_trash = Trash;trash antispam_spam = Junk;Spam;SPAM antispam_pipe_program_spam_arg = --spam antispam_pipe_program_notspam_arg = --ham antispam_pipe_program = /usr/bin/sa-learn antispam_pipe_program_args = --username=%Lu }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de entrenamiento de Spamassasin en el momento de la transferencia hacia / desde la carpeta Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/90-sieve.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { sieve = ~/.dovecot.sieve sieve_dir = ~/sieve sieve_after = /var/lib/dovecot/sieve/default.sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un archivo que indica qu√© hacer con los correos electr√≥nicos entrantes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/var/lib/dovecot/sieve/default.sieve"</font></font><br><br><pre> <code class="bash hljs">require [<span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>, <span class="hljs-string"><span class="hljs-string">"mailbox"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> header :contains <span class="hljs-string"><span class="hljs-string">"X-Spam-Flag"</span></span> <span class="hljs-string"><span class="hljs-string">"YES"</span></span> { fileinto :create <span class="hljs-string"><span class="hljs-string">"Spam"</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es necesario compilar el archivo: "sievec default.sieve". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/conf.d/auth-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">passdb { driver = sql args = /etc/dovecot/dovecot-sql.conf.ext } userdb { driver = static args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especificaci√≥n de archivos sql para autorizaci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y el archivo en s√≠ es una forma de autorizaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/dovecot-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">driver = mysql connect = host=127.0.0.1 dbname=servermail user=usermail password=password default_pass_scheme = SHA512-CRYPT password_query = SELECT email as user, password FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%u'</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto corresponde a la misma configuraci√≥n para postfix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/dovecot/dovecot.conf"</font></font><br><pre> <code class="bash hljs">protocols = imap lmtp pop3 listen = *, :: dict { } !include conf.d/*.conf !include_try local.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El archivo de configuraci√≥n principal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo importante es que especificamos aqu√≠, agregamos protocolos.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== SpamAssassin ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install spamassassin spamc</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instala los paquetes. </font></font><br><br><pre> <code class="bash hljs">adduser spamd --disabled-login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue un usuario en cuyo nombre. </font></font><br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> spamassassin.service</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Active el servicio de descarga autom√°tica spamassassin en el arranque. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/ etc / default / spamassassin":</font></font><br><br><pre> <code class="bash hljs">CRON=1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Active la actualizaci√≥n autom√°tica de reglas de forma predeterminada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo "/etc/spamassassin/local.cf":</font></font><br><br><pre> <code class="bash hljs">report_safe 0 use_bayes 1 bayes_auto_learn 1 bayes_auto_expire 1 bayes_store_module Mail::SpamAssassin::BayesStore::MySQL bayes_sql_dsn DBI:mysql:sa:localhost:3306 bayes_sql_username sa bayes_sql_password password</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es necesario hacer la base de datos "sa" en mysql con el usuario "sa" con la contrase√±a "contrase√±a" (reemplazar con algo adecuado). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_safe: en lugar de una carta, se enviar√° un informe sobre el mensaje de spam. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_bayes son configuraciones de aprendizaje autom√°tico de spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las configuraciones restantes de spamassassin se aplicaron anteriormente en el art√≠culo. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El escenario general es spamassassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerca de mover nuevos correos electr√≥nicos no deseados a la carpeta de correo no deseado IMAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre un simple grupo de Dovecot + SpamAssassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomiendo leer la teor√≠a de aprender spamassasin al mover letras en carpetas imap (y no lo recomiendo para su uso)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Contactando a la comunidad ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n me gustar√≠a lanzar una idea a la comunidad sobre c√≥mo aumentar el nivel de seguridad de las cartas enviadas. </font><font style="vertical-align: inherit;">Ya que estoy tan profundamente inmerso en el tema del correo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que el usuario pueda crear un par de claves en su cliente (Outlook, Thunderbird, navegador-plugin, ...). </font><font style="vertical-align: inherit;">P√∫blico y privado. </font><font style="vertical-align: inherit;">P√∫blico: enviar a DNS. </font><font style="vertical-align: inherit;">Privado: guardar en el cliente. </font><font style="vertical-align: inherit;">Los servidores de correo podr√≠an usar la clave p√∫blica para enviar a un destinatario espec√≠fico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y para protegerse contra el correo no deseado con dichos correos electr√≥nicos (s√≠, el servidor de correo no podr√° ver el contenido), ser√° necesario introducir 3 reglas:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Firma DKIM real obligatoria, SPF obligatorio, rDNS obligatorio. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Una red neuronal sobre el tema del entrenamiento antispam + DB en el lado del cliente. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El algoritmo de cifrado debe ser tal que el lado emisor debe gastar 100 veces m√°s potencia de CPU en el cifrado que el lado receptor. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s de las cartas p√∫blicas, para desarrollar una carta de invitaci√≥n est√°ndar "para comenzar una correspondencia segura". </font><font style="vertical-align: inherit;">Uno de los usuarios (buz√≥n) env√≠a una carta al otro buz√≥n con un archivo adjunto. </font><font style="vertical-align: inherit;">En la carta, la propuesta de texto para iniciar un canal de comunicaci√≥n seguro para la correspondencia y la clave p√∫blica del propietario del buz√≥n (con la clave privada en el lado del cliente).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incluso puede hacer un par de claves espec√≠ficamente para cada correspondencia. El usuario receptor puede aceptar esta oferta y enviar su clave p√∫blica (tambi√©n hecha espec√≠ficamente para esta correspondencia). Luego, el primer usuario env√≠a una carta de control de servicio (encriptada con la clave p√∫blica del segundo usuario), al recibirla, el segundo usuario puede considerar confiable el canal de comunicaci√≥n formado. Luego, el segundo usuario env√≠a una carta de control, y luego el primer usuario tambi√©n puede considerar el canal formado como protegido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para combatir la interceptaci√≥n de claves en el camino, es necesario en el protocolo proporcionar la posibilidad de transmitir al menos una clave p√∫blica utilizando una unidad flash. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y lo m√°s importante, que todo funciona (la pregunta es "¬øqui√©n pagar√° por ello?"):</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduzca certificados por correo con un valor de $ 10 por 3 a√±os. </font><font style="vertical-align: inherit;">Lo que permitir√° al remitente indicar en dns que "mis claves p√∫blicas est√°n ah√≠ afuera". </font><font style="vertical-align: inherit;">Y le dar√°n la oportunidad de iniciar una conexi√≥n segura. </font><font style="vertical-align: inherit;">Al mismo tiempo, tome tales compuestos de forma gratuita. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gmail finalmente monetiza a sus usuarios. </font><font style="vertical-align: inherit;">Por $ 10 en 3 a√±os: el derecho a crear canales seguros de correspondencia.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Conclusi√≥n ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para probar todo el art√≠culo, iba a alquilar un servidor dedicado durante un mes y comprar un dominio con un certificado SSL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero las circunstancias de la vida se desarrollaron, por lo que este problema se prolong√≥ durante 2 meses. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y cuando apareci√≥ nuevamente el tiempo libre, decid√≠ publicar el art√≠culo tal cual y no arriesgarme a que la publicaci√≥n se retrase un a√±o m√°s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si hay muchas preguntas como "pero esto no se describe con suficiente detalle", entonces probablemente habr√° fuerzas para tomar un servidor dedicado con un nuevo dominio y un nuevo certificado SSL y describir con m√°s detalle y lo m√°s importante: identificar todos los detalles importantes que faltan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n me gustar√≠a recibir comentarios sobre el tema de ideas sobre certificados de correo. Si te gusta la idea, intentar√© encontrar la fuerza para escribir un borrador para rfc.</font></font><br><br> <b>     ‚Äî     . <br>       ‚Äî     . <br>           .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413689/">https://habr.com/ru/post/es413689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413675/index.html">Joker 2018: Club de desarrolladores Java an√≥nimos</a></li>
<li><a href="../es413677/index.html">Lanzamiento de ROS en el robot de autoequilibrio EduMIP</a></li>
<li><a href="../es413679/index.html">Angular 6. PWA M√≥dulos de carga lenta. Despliegue autom√°tico en Firebase</a></li>
<li><a href="../es413681/index.html">La t√©cnica de desarrollar servidores altamente confiables en Go</a></li>
<li><a href="../es413683/index.html">ILV ha desbloqueado 7 millones de direcciones IP. Permanecer bloqueado 4 millones</a></li>
<li><a href="../es413691/index.html">Inicio</a></li>
<li><a href="../es413693/index.html">Hecho a mano: teclado programable para el comercio en l√≠nea h√°galo usted mismo</a></li>
<li><a href="../es413695/index.html">Seguridad de mensajer√≠a: por qu√© almacenar mensajes en blockchain podr√≠a ser una buena idea</a></li>
<li><a href="../es413697/index.html">C√≥mo no escribir c√≥digo</a></li>
<li><a href="../es413699/index.html">"Qui√©n agita el agua - 2": o todo lo que quer√≠a saber sobre la √≥smosis inversa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>