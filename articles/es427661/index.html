<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø ‚ò¶Ô∏è ü§µüèø Sportiduino - sistema de marcado electr√≥nico para eventos deportivos, parte 3 üë©üèº‚Äçü§ù‚Äçüë®üèΩ üöø üë©üèæ‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Parte 1 , Parte 2 

 Ha pasado un a√±o desde la √∫ltima publicaci√≥n, y a menudo me preguntan qu√© ha cambiado desde entonces. En resumen, se hizo la tr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sportiduino - sistema de marcado electr√≥nico para eventos deportivos, parte 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427661/">  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2</a> <br><br>  Ha pasado un a√±o desde la √∫ltima publicaci√≥n, y a menudo me preguntan qu√© ha cambiado desde entonces.  En resumen, se hizo la transici√≥n a los chips Ntag, se hicieron peque√±os cambios en el circuito para proporcionar una mejor sensibilidad, volumen de se√±al y el movimiento correcto del reloj, y se cre√≥ un software para trabajar con el sistema.  En general, el sistema se ha estabilizado y est√° listo para su reproducci√≥n y uso.  M√°s detalles a continuaci√≥n. <br><a name="habracut"></a><br>  En primer lugar, te contar√© sobre los chips RFID, por qu√© se hizo la transici√≥n hacia Ntag.  Perm√≠tame recordarle que la memoria Mifare Classic 1K contiene 1024 bytes, de los cuales 752 bytes est√°n disponibles para almacenar informaci√≥n.  La estructura de la memoria se divide en 16 bloques, que contienen 4 p√°ginas de 16 bytes, uno de los cuales est√° reservado para el cifrado.  Si utiliza una p√°gina como servicio, a√∫n quedan 46 p√°ginas para registrar marcas. <br><br>  Al comienzo del desarrollo, utilic√© la memoria libremente: una p√°gina de 16 bytes por marca, lo que limita el uso de inicios de tama√±o mediano.  Y para rogaining, orientaci√≥n tur√≠stica o carreras de aventura, 46 estaciones son pocas.  Por lo tanto, se realiz√≥ la idea de compactaci√≥n: se escribieron dos marcas en cada p√°gina.  Al mismo tiempo, exist√≠a el riesgo de p√©rdida de datos, porque la unidad de grabaci√≥n es una p√°gina, y al volver a grabar, debe leer la mitad ya grabada para volver a escribirla.  En realidad, pis√© este rastrillo durante Rogaining en noviembre pasado, se perdi√≥ una peque√±a parte de los datos, tuve que editar mucho manualmente.  Y, aunque se detect√≥ un error en el c√≥digo, decid√≠ cambiar a chips m√°s potentes sin riesgo de p√©rdida de datos durante la reescritura. <br><br>  Una de las opciones posibles es usar chips Mifare 4K, cuya estructura difiere de 1K en solo cuatro veces la gran cantidad de memoria.  Pero tales chips son m√°s caros y la duraci√≥n de la limpieza, las marcas con su uso aumentar√≠an.  Otra opci√≥n es usar los chips de la serie Ntag (213/215/216).  La estructura de memoria de los chips Ntag es bastante simple: la memoria se divide en p√°ginas de 4 bytes, las primeras 4 y las √∫ltimas 5 p√°ginas est√°n reservadas para almacenar informaci√≥n de servicio, el resto se puede utilizar.  Los chips de la serie Ntag difieren en tama√±o de memoria, Ntag213 tiene 36 p√°ginas (144 bytes) libres, Ntag215 tiene 126 p√°ginas (504 bytes) y Ntag216 tiene 222 p√°ginas (888 bytes).  Como resultado, implement√© el soporte para todos los chips de esta serie, aunque Ntag215 puede considerarse √≥ptimo, cuya memoria es suficiente para 120 marcas, y el precio es bastante bajo (alrededor de $ 0.2 por chip en forma de pegatina o $ 0.4 en forma de llavero).  Adem√°s, siguiendo el consejo de SFR, decidi√≥ negarse a almacenar informaci√≥n cr√≠tica: el n√∫mero de la √∫ltima p√°gina gratuita a favor de su b√∫squeda binaria.  Esto aument√≥ la marca de tiempo, pero aument√≥ la confiabilidad. <br><br>  La p√°gina de memoria Ntag contiene 4 bytes, en los que debe ajustar el n√∫mero de estaci√≥n - 1 byte y la marca de tiempo - 4 bytes.  El problema se resolvi√≥ por el hecho de que el tiempo completo de inicializaci√≥n (limpieza) del chip se escribe en una p√°gina separada y, cuando est√° marcado, solo los 3 bytes inferiores del tiempo.  Luego, al leer, el tiempo de las marcas se restaura por completo en funci√≥n del tiempo de inicializaci√≥n.  Otra p√°gina en el chip est√° ocupada por el n√∫mero de chip y dos quedan en reserva.  La estructura resultante se presenta a continuaci√≥n: <br><br><img src="https://habrastorage.org/webt/x4/zv/yv/x4zvyv3m8q5tmcznc__em4jcaqy.jpeg"><br><br>  El uso de Ntag permiti√≥ resolver el problema de la grabaci√≥n segura de una gran cantidad de marcas en el chip, pero surgi√≥ otro problema.  Los chips Ntag requieren m√°s potencia del transmisor que Mifare con la misma √°rea de antena, y los chips de llavero en los que la antena es del orden de 2 cm ^ 2 pueden no funcionar bien en el m√≥dulo RC522 como est√°ndar.  La soluci√≥n al problema fue soldar las inductancias en el m√≥dulo a otras m√°s potentes.  Al mismo tiempo, el rango de respuesta aument√≥ significativamente, para chips Ntag de hasta 2 cm y para Mifare de hasta 3 cm. Pero algunos m√≥dulos comenzaron a funcionar mal debido a dicha soldadura: los chips se registraron solo con un rango de distancias determinado y bastante impredecible desde la antena transmisora.  Tuve que ingresar a la biblioteca RC522 Arduino y encontrar el par√°metro de ganancia all√≠, que es responsable de la potencia de la antena; la edici√≥n para estaciones individuales resolvi√≥ el problema.  Tambi√©n domin√≥ la fabricaci√≥n manual de chips en un brazalete con pegatinas.  Alibaba ya est√° a la venta lista para usar y hermosa, pero su √°rea de antena es casi la mitad de eso, la marca pasa menos estable.  Tambi√©n noto que dej√© el soporte para los chips Mifare 1K, puede trabajar con ellos, pero para esto necesita usar un firmware separado, y la capacidad del chip est√° limitada a 42 marcas, pero vienen con m√≥dulos RC522. <br><br><img src="https://habrastorage.org/webt/d3/gm/oc/d3gmocpv7hk81ahbkk2fbddxhea.jpeg"><br><br>  Otro problema que tuvo que resolverse durante el desarrollo fue el curso incorrecto del reloj.  En algunas estaciones, el reloj comenz√≥ a retrasarse o apresurarse hasta 5 minutos al d√≠a.  Durante mucho tiempo no pude entender cu√°l era la raz√≥n, luego descubr√≠ que solo las estaciones con una placa de circuito impreso fabricada en la f√°brica tienen errores, mientras que todo funciona bien en las grabadas manualmente.  Pens√© en lo que esto podr√≠a estar relacionado.  En pistas grabadas a mano bastante gruesas debido a su abundante esta√±ado, menos resistencia.  Result√≥ que el condensador en la salida del estabilizador no es suficiente para desacoplar la potencia del reloj en pistas delgadas de f√°brica.  Puse otro condensador cerca del reloj, y el problema, en su mayor parte, se resolvi√≥.  Una peque√±a parte del reloj todav√≠a falla, pero ya asocio esto con el matrimonio de relojes baratos con Ali, necesita buscar proveedores confiables. <br><br>  Bueno, el √∫ltimo cambio en el circuito es la amplificaci√≥n de la se√±al de sonido.  Anteriormente, el control y la potencia del tweeter en el circuito se realizaban desde el pie del microcontrolador, por lo tanto, su potencia era bastante limitada.  Ahora la energ√≠a proviene directamente de las bater√≠as, y el control se realiza a trav√©s de un transistor, que aument√≥ significativamente el volumen de la se√±al.  Todos estos cambios ahora se tienen en cuenta y se introducen en los archivos de Gerber, pero modifiqu√© manualmente unas 40 estaciones, tuve que elegir el compuesto, cortar las pistas, colgar el transistor en los cables, hab√≠a algunas estaciones rotas. <br><br><img src="https://habrastorage.org/webt/tm/n4/y9/tmn4y9n0ild0bvrr1bzh_jvoweq.jpeg"><br><br>  Debido a la transici√≥n a otros chips, el firmware de las estaciones base tuvo que modificarse sustancialmente, pero el principio y la l√≥gica del trabajo, en su mayor parte, permanecieron igual.  Los mismos modos de ahorro de energ√≠a, sue√±o, trabajo, configuraci√≥n usando chips maestros.  Pero el firmware de la puerta de enlace se ha redise√±ado por completo.  El protocolo de comunicaci√≥n anterior, cuando los datos se transmit√≠an en un puerto COM en un flujo continuo, parec√≠a vulnerable: se omiti√≥ un byte y todos los datos se convirtieron en una calabaza.  Adaptarse a los protocolos de transferencia de datos existentes parec√≠a aburrido, por lo que invent√≥ su bicicleta. <br><br>  La informaci√≥n se transmite y recibe secuencialmente transmitiendo paquetes de hasta 32 bytes.  Si los datos transmitidos no caben en el paquete, la transmisi√≥n se realiza reenviando secuencialmente los paquetes.  El paquete comienza con el byte de inicio 0xFE, seguido del n√∫mero de comando, la longitud del paquete, los datos y al final de la suma de verificaci√≥n.  Los comandos pasan solo con el valor correcto de la suma de verificaci√≥n y comienzan los bytes.  Bastante simple y lo suficientemente confiable. <br><br><img src="https://habrastorage.org/webt/oo/cr/ma/oocrma2ibcdulbqoncpeyqqkdlm.jpeg"><br><br>  Se estableci√≥ la conexi√≥n, pero era necesario escribir un software normal para la computadora, mis habilidades en el procesamiento no eran adecuadas para esto.  Semyon Yakimov, quien cre√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un m√≥dulo de</a> Python para trabajar con el sistema, asumi√≥ esto, por lo cual est√° muy agradecido.  El m√≥dulo le permite comunicarse con la puerta de enlace, transmitir y recibir datos en un formato conveniente.  Despu√©s de eso, domin√© Python como primera aproximaci√≥n y escrib√≠ una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicaci√≥n GUI</a> simple basada en este m√≥dulo y PyQt, que se puede usar para configurar el sistema, as√≠ como para recopilar datos de chips en forma de un archivo JSON.  Bueno, entonces los datos pueden procesarse usando peque√±os guiones para competiciones con una variedad de condiciones y reglas, emitidas en una forma conveniente ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">orientaci√≥n tur√≠stica</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">itinerancia</a> ).  Pero, de todos modos, esto implica algunas habilidades, y la felicidad ser√≠a incompleta si no fuera por los desarrolladores del programa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SportOrg</a> , que agregaron soporte para Sportiduino (adem√°s de Sportident y SFR).  El programa se est√° desarrollando activamente y muchas cosas pueden juzgar los inicios de orientaci√≥n. <br><br><h3>  Conclusi√≥n </h3><br>  Por lo tanto, en este momento hay un hardware y software de trabajo estable.  Creo que se ha logrado el objetivo de la empresa: ha aparecido un sistema de marcado electr√≥nico barato.  No voy a cambiar nada dentro del marco de este esquema, excepto si hay alg√∫n tipo de error.  El sistema de marcado fue desarrollado y probado ya en una gran cantidad de competiciones diferentes: orientaci√≥n, rogaining, marcha-lanzamiento, sendero, etapas tur√≠sticas.  Adem√°s de m√≠, es utilizado por varias personas en diferentes lugares.  Alguien jug√≥ el sistema, alguien hizo adiciones all√≠, por ejemplo, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√≥dulo de radio</a> o el uso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bater√≠as</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">litio y</a> chips <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mifare</a> como los principales. <br><br>  El desarrollo es abierto y no comercial, bajo licencia GNU GPLv3.  Cualquiera puede copiarlo, reproducirlo, modificarlo y usarlo libremente.  Durante el a√±o pasado, he planteado muchas preguntas sobre si estoy haciendo una venta en la estaci√≥n.  No, no quiero hacer esto.  Por otro lado, no me importa si alguien llena este nicho.  Solo estoy listo para dar consejos sobre el montaje y el uso, ya que todo es bastante simple all√≠. <br><br>  El proyecto est√° disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> , hay diagramas ubicados, instrucciones y otro material √∫til.  Gracias por su atencion </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427661/">https://habr.com/ru/post/es427661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427647/index.html">Informe Tesla (TSLA) Q3 2018</a></li>
<li><a href="../es427649/index.html">Matriz de cocina en casa</a></li>
<li><a href="../es427653/index.html">Distribuir y conquistar: dise√±o ahora y ahora</a></li>
<li><a href="../es427655/index.html">Traefik como controlador de entrada para K8S</a></li>
<li><a href="../es427657/index.html">Uso de Animation Inspector en Chrome Developer Tools</a></li>
<li><a href="../es427663/index.html">Habro osos y cangrejo</a></li>
<li><a href="../es427665/index.html">Las mejores escalas inteligentes (seg√∫n Wareable)</a></li>
<li><a href="../es427669/index.html">KNX Home Control: iluminaci√≥n</a></li>
<li><a href="../es427671/index.html">Sberbank y Yandex lanzaron oficialmente la plataforma comercial Beru, la versi√≥n rusa de Amazon</a></li>
<li><a href="../es427673/index.html">Machine learning @ booking.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>