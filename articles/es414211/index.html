<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∫ ü§∂üèæ üîá Desarrollo de un servidor TELNET basado en W5500 y ATMEGA8 üëÑ ü§òüèº üï¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, el complejo de software y hardware Arduino se ha vuelto muy popular, y est√° dise√±ado para desarrollar varios dise√±os electr√≥nicos inter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desarrollo de un servidor TELNET basado en W5500 y ATMEGA8</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414211/">  Recientemente, el complejo de software y hardware Arduino se ha vuelto muy popular, y est√° dise√±ado para desarrollar varios dise√±os electr√≥nicos interesantes.  Los dise√±os se realizan conectando la placa base Arduino con los m√≥dulos adicionales necesarios.  En la placa base Arduino hay un microcontrolador, cuyo firmware est√° escrito en un entorno de desarrollo especial para Arduino utilizando, por regla general, bibliotecas preparadas para uno u otro m√≥dulo. <br><br>  Uno de los m√≥dulos, el W5500, est√° destinado a la fabricaci√≥n de estructuras electr√≥nicas que se conectar√°n a Internet.  En este caso, con mayor frecuencia, implica el control remoto de su estructura.  Por ejemplo, puede ser una "casa inteligente", un robot y similares.  El proyecto m√°s trivial (excepto Hello world) es la inclusi√≥n remota de LED a trav√©s de un navegador web (Fig. 1).  Si, en lugar de los LED, se conectan interruptores de transistor y rel√©s, se pueden conmutar cargas m√°s potentes.  Por lo tanto, en esencia, el programa (firmware) de este dise√±o es un servidor web que procesa las solicitudes http de un usuario remoto. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qj/xj/w5/qjxjw5zozlcgxty2zaxpld3tfow.jpeg"></div>  <i>Fig.</i>  <i>1. Gesti√≥n de LED a trav√©s de un navegador.</i> <br><br>  El m√≥dulo W5500 se basa en el propio chip W5500 con su kit de cuerpo, as√≠ como un conector BLS para MK a trav√©s de SPI, un conector RJ-45 para conectarse a una red inform√°tica y un regulador de voltaje lineal para 3.3 V (Fig.2). <br><br><img src="https://habrastorage.org/webt/ta/sd/nz/tasdnz169igf5gzmdd6geetdsc4.jpeg" width="375" height="375"><br><br>  <i>Fig.</i>  <i>2. El m√≥dulo W5500.</i> <br><br>  El chip W5500 es un controlador completo con procesamiento integrado de una pila completa de protocolos de red, desde Ethernet hasta TCP (Fig. 3).  Al implementar un dise√±o basado en este chip, el programador no necesita escribir el c√≥digo de procesamiento del protocolo TCP / IP, es suficiente implementar solo el protocolo de capa de aplicaci√≥n, que se integrar√° en TCP.  En el ejemplo anterior (en Arduino), http se utiliza como protocolo de aplicaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5n/a0/dx/5na0dx-_xgs06can1rxipmlul7y.jpeg"></div>  <i>Fig.</i>  <i>3. La estructura del chip W5500.</i> <br><br>  Sin hacer Arduino, decid√≠ estudiar la documentaci√≥n del chip W5500 en detalle e implementar independientemente el programa basado en el microcontrolador Atmega8.  Este programa no incluir√° un controlador http.  Se requiere implementar el intercambio de datos m√°s simple (RAW) a trav√©s del protocolo TCP utilizando un terminal remoto.  No es del todo exacto hablar sobre el protocolo Telnet, como dice el t√≠tulo de este art√≠culo.  Tiene sus propias caracter√≠sticas espec√≠ficas basadas en el intercambio de informaci√≥n adicional sobre los par√°metros de los terminales.  Sin embargo, la mayor√≠a de los clientes de telnet admiten RAW y no requieren lo anterior.  Por lo tanto, el programa Atmega8 MK no incluir√° un controlador de protocolo de nivel de aplicaci√≥n.  Solo se ocupar√° de la inicializaci√≥n del W5500, la gesti√≥n de socket, la recepci√≥n y transmisi√≥n de datos. <br><br>  La aplicaci√≥n principal de este dise√±o es la gesti√≥n de dispositivos a trav√©s de un terminal remoto.  En este caso, el dise√±o se conecta al dispositivo administrado a trav√©s de la interfaz UART (tres cables GND, TxD, RxD).  La gesti√≥n a trav√©s del terminal es un enfoque profesional cl√°sico en un √°rea particular en ausencia de una interfaz gr√°fica.  Por ejemplo, una l√≠nea de comandos de Windows o Linux, o una forma de configurar un enrutador a trav√©s de un terminal utilizando el protocolo Telnet.  El √∫ltimo ejemplo es en realidad equivalente a la idea discutida en este art√≠culo. <br><br>  Al desarrollar este o aquel dispositivo, si es necesario, preveo controlarlo con comandos de texto a trav√©s de un terminal conectado a trav√©s de la interfaz UART.  Esto puede ser una conexi√≥n a una PC normal al puerto COM RS-232 a trav√©s del chip adaptador MAX232, o al USB (puerto COM virtual) a trav√©s del chip PL2303.  Puede usar el programa HyperTerminal est√°ndar como terminal.  Con la expansi√≥n de los tel√©fonos inteligentes Android, se hizo conveniente conectarse a trav√©s de Bluetooth: un m√≥dulo Bluetooth (por ejemplo, HC-06) est√° conectado a la interfaz UART del dispositivo, y un tel√©fono inteligente est√° conectado al m√≥dulo de forma inal√°mbrica.  Existen muchas aplicaciones en Internet que implementan el terminal a trav√©s de Bluetooth.  Por lo tanto, puede controlar el dispositivo a trav√©s del terminal desde un tel√©fono m√≥vil a trav√©s de Bluetooth en un rango corto.  El dise√±o discutido en este art√≠culo le permite implementar el control a trav√©s del terminal usando Internet.  El terminal puede ser el HyperTerminal est√°ndar, que viene con Windows XP, o puede ejecutar la utilidad telnet desde la l√≠nea de comandos de Windows y trabajar en ella.  Si hablamos de un tel√©fono inteligente, puede elegir una de las aplicaciones en Android (tambi√©n hay una gran cantidad de ellas) (Fig. 4). <br><br><img src="https://habrastorage.org/webt/4g/ia/x7/4giax7dezsah7q-pjb5eso6tftm.jpeg" width="400" height="640"><br><br>  <i>Fig.</i>  <i>4. Aplicaciones para "terminal TCP" en Google Play.</i> <br><br>  El chip W5500 tiene 8 z√≥calos independientes, cada uno de los cuales tiene una memoria para recibir y transmitir informaci√≥n de m√°s de 2 KB.  Total, la memoria total es de 16 KB para recibir y 16 KB para transmitir informaci√≥n.  Estos par√°metros se usan por defecto, pero si es necesario, en la etapa de inicializaci√≥n del chip, la memoria se puede reasignar a trav√©s de sockets.  La aplicaci√≥n que se describe aqu√≠ utilizar√° la configuraci√≥n de memoria predeterminada y los 8 sockets est√°n involucrados.  A cada socket en la etapa de su inicializaci√≥n se le asignan muchos par√°metros, el principal de los cuales es su modo de operaci√≥n y puerto TCP.  El modo de operaci√≥n de los ocho sockets que necesitamos es el modo del servidor TCP.  Debe asignar diferentes puertos a cada socket.  Tom√© ocho puertos consecutivos, comenzando, por ejemplo, desde 4000. En la etapa de inicializaci√≥n del m√≥dulo W5500, se le asignan par√°metros de red conectados al programa Atmega8 MK: direcci√≥n IP, m√°scara de subred, direcci√≥n IP de la puerta de enlace e incluso la direcci√≥n MAC f√≠sica.  La configuraci√≥n de red del W5500 debe coincidir con la configuraci√≥n de la red dom√©stica a la que se conecta.  Cuando se conecta de forma remota a nuestro dispositivo descrito, la configuraci√≥n del terminal indica la direcci√≥n del host (direcci√≥n IP o nombre de dominio) y el puerto.  La direcci√≥n del host se refiere al dispositivo W5500, y el puerto se refiere al z√≥calo en el dispositivo.  Un socket puede funcionar con una sola conexi√≥n.  Por lo tanto, es posible hacer ocho conexiones simult√°neas independientes.  La Figura 5 muestra los par√°metros de conexi√≥n en el programa HyperTerminal est√°ndar al W5500 con la direcci√≥n IP 192.168.0.111 al z√≥calo 0 (puerto 4000).  Para conectarse a Internet global (desde el exterior), debe configurar correctamente su enrutador dom√©stico. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gl/xf/dt/glxfdtxvfstq3pbj0_bguqpusm8.jpeg"></div>  <i>Fig.</i>  <i>5. Conexi√≥n a trav√©s de TCP / IP en HyperTerminal.</i> <br><br>  Prob√© muchas aplicaciones de terminal TCP diferentes, cada una tiene sus propias ventajas y desventajas.  En primer lugar, por el m√©todo de empaquetar un paquete TCP, se pueden distinguir dos casos.  En el primer caso, se genera un paquete TCP y se env√≠a al servidor inmediatamente cuando se ingresa un car√°cter en el terminal.  Por lo tanto, el campo de datos de cada paquete toma 1 byte y contiene el car√°cter ingresado por el usuario.  El programa HyperTerminal funciona solo en este modo.  En el segundo caso, el juego de caracteres (comando) se ingresa en un campo de texto separado, y cuando hace clic en el bot√≥n "Enviar", solo se forma un paquete con un campo de datos, cuyo contenido es un juego de caracteres ingresado por el usuario.  El tama√±o del campo de datos de dicho paquete en bytes coincide con el n√∫mero de caracteres ingresados.  El segundo caso es el m√°s preferible y conveniente, adem√°s de econ√≥mico en el tr√°fico.  Nuestro dise√±o funciona con ambos casos, transfiriendo a la salida (TxD) del UART MK Atmega8 todos los caracteres ingresados ‚Äã‚Äãpor el usuario remoto desde cualquier socket. <br><br>  En cuanto a la organizaci√≥n de la transferencia de informaci√≥n del servidor al cliente, aqu√≠ tambi√©n tienen sus propias caracter√≠sticas.  Es posible hacer que el programa MK genere un paquete TCP de un solo byte tambi√©n directamente, al recibir un byte (car√°cter) en el tramo RxD UART MK.  Puede crear un paquete TCP a partir de un conjunto de bytes entrantes al MK mediante la presencia de una se√±al adicional especial, que solo est√° presente durante la transmisi√≥n de la secuencia desde el dispositivo conectado (se√±al de empaque).  Por cierto, esta se√±al se usa para cambiar el MAX485 a transmisi√≥n en el caso de convertir RS-232 a interfaz RS-485 semid√∫plex.  Sin embargo, como estaba convencido, es m√°s conveniente usar un temporizador, es decir  un peque√±o retraso durante el cual se realizar√° la recepci√≥n de caracteres y la formaci√≥n del paquete TCP.  Este es el m√©todo que implement√© en la construcci√≥n descrita.  Funciona de la siguiente manera.  El temporizador (el tiempo se establece aproximadamente 0.3 segundos) Comienza cuando llega el primer personaje y se reinicia cuando llega el siguiente personaje en el UART MK.  Si no llegaron caracteres en un tiempo espec√≠fico, se forma un paquete con los caracteres recibidos y se env√≠a al cliente, y el temporizador se detiene.  En mi caso particular, hay un correo masivo en todos los sockets a los que est√°n conectados los clientes. <br><br>  Ahora ser√° sobre la privacidad.  El terminal remoto descrito no est√° protegido contra escuchas usando analizadores de tr√°fico.  Incluso el protocolo Telnet en s√≠ no proporciona autenticaci√≥n y cifrado de contrase√±a.  Para esto, hay otros protocolos modernos de terminal remota.  Y en el caso de Telnet, as√≠ como en el caso de RAW (sin un protocolo de aplicaci√≥n), puede implementar un m√©todo indirecto de autenticaci√≥n de contrase√±a, que solo ser√° ineficaz con una intervenci√≥n intencional intencional.  Sin embargo, este m√©todo de autorizaci√≥n proteger√° contra el tr√°fico "izquierdo" no controlado.  Puede provenir de spyware, que, clasificando el rango de direcciones IP de proveedores conocidos y el rango de puertos, puede conectarse repentinamente a nuestro dispositivo (si "escucha" las conexiones de Internet).  En mi firmware, implement√© una p√°gina de bienvenida del cliente, si estaba conectada al servidor, es decir.  al dise√±o basado en el m√≥dulo W5500. <br><br>  La p√°gina de bienvenida contiene informaci√≥n sobre la direcci√≥n IP del cliente, el n√∫mero de socket (para monitoreo) y una solicitud para ingresar una contrase√±a (Fig. 6). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ea/nw/2q/eanw2qiq7wtm974w7brndgscqja.jpeg"></div>  <i>Fig.</i>  <i>6. P√°gina de bienvenida para el servidor W5500.</i> <br><br>  Despu√©s de conectarse dentro del programa MK, se inicia un temporizador (durante aproximadamente 18 segundos), durante el cual el usuario debe tener tiempo para ingresar una contrase√±a espec√≠fica (la misma en todos los enchufes).  Si la contrase√±a se ingresa de manera incorrecta, una vez transcurrido el tiempo establecido, el usuario informa el mensaje correspondiente y el servidor se desconecta (Fig. 7). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qi/i5/rh/qii5rh4vsutckz8oyinxlurdsv8.jpeg"></div>  <i>Fig.</i>  <i>7. Informar una contrase√±a incorrecta.</i> <br><br>  En el caso de una contrase√±a ingresada correctamente, al usuario tambi√©n se le muestra el mensaje correspondiente (Fig. 8).  Despu√©s de eso, se establece un puente "transparente" entre el terminal remoto y la interfaz UART del MK, al que se conecta el m√≥dulo W5500 a trav√©s de SPI.  El funcionamiento de dicho puente se prob√≥ solo a nivel de equipos de usuarios.  Es posible que no se garantice un intercambio de datos de alta velocidad completo si, en algunos casos, la aplicaci√≥n del cliente no es un terminal de usuario, sino alg√∫n otro programa.  Y a√∫n m√°s, el dise√±o descrito no garantiza (m√°s precisamente, no est√° previsto) el intercambio de datos full-duplex. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9j/lx/4c/9jlx4c2o2sjavhkdq2gut43oo7m.jpeg"></div>  <i>Fig.</i>  <i>8. Mensaje sobre la contrase√±a correcta.</i> <br><br>  Cuando se ingresa una contrase√±a, el usuario no devuelve los caracteres que ingresa al terminal, y tampoco funciona "Retroceso" (retroceder con un car√°cter ingresado incorrectamente).  La longitud de la contrase√±a es de 8 caracteres.  El programa MK escanea los primeros 8 caracteres recibidos del cliente, independientemente de su distribuci√≥n a trav√©s de paquetes TCP.  Pero cualquier paquete no debe exceder los 10 bytes.  Por cierto, la funci√≥n "Enviar archivo de texto" en HyperTerminal funciona de manera bastante interesante.  Como se verific√≥ utilizando un analizador de tr√°fico, cuando se realiza esta funci√≥n, se forman dos paquetes TCP: el primer paquete con datos de 1 byte contiene el primer car√°cter del archivo de texto transmitido, y el segundo paquete contiene el resto del contenido. <br><br>  El servidor proporciona dos contrase√±as diferentes.  Una contrase√±a se usa para establecer el puente TCP-UART (uso normal), como se describi√≥ anteriormente, y la segunda contrase√±a se usa para controlar el m√≥dulo W5500 u otros par√°metros de dise√±o.  Si se ingresa esta contrase√±a, se muestra al usuario otra p√°gina de bienvenida y se ingresa al modo de control.  Proporcion√© intencionalmente que este modo solo era posible en uno de los z√≥calos libres.  Si un socket con este modo est√° ocupado y se intenta iniciar sesi√≥n en este modo en otro socket, el servidor desconectar√° inmediatamente la conexi√≥n.  Antes del descanso, se mostrar√° un mensaje sobre el n√∫mero de socket que ya est√° funcionando (ocupado) en el modo de control (Fig. 9). <br><br>  El modo de control proporciona los comandos que he definido, una lista de los cuales se puede ver ingresando el comando de ayuda.  El comando debe terminar con un car√°cter de nueva l√≠nea (tecla Intro).  Adem√°s, si el modo de control est√° activo, el servidor W5500 env√≠a mensajes de servicio al terminal, por ejemplo, sobre la conexi√≥n de clientes a otros z√≥calos con sus direcciones IP o sobre un z√≥calo libre.  La figura 10 muestra lo anterior.  La lista de equipos a√∫n no est√° completa, se repondr√° con el tiempo. <br><br><img src="https://habrastorage.org/webt/mb/bu/v_/mbbuv_bfry1kuj83z8wgwzxwbqm.jpeg" width="400" height="340"><br><br>  <i>Fig.</i>  <i>9. Un mensaje sobre un socket ocupado cuando ingresa la contrase√±a del modo de control.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/es/dk/sn/esdksn_il5ajj_btzatrxlaxeb4.jpeg"></div>  <i>Fig.</i>  <i>10. Modo de control W5500.</i> <br><br>  El comando echo deshabilita o habilita el retorno del car√°cter impreso al terminal (autocontrol).  Los siguientes dos comandos son para leer y escribir el registro de direcci√≥n del chip W5500.  Los valores de los registros para las direcciones se indican en la documentaci√≥n del chip W5500.  Introduje estos comandos universales, principalmente para la depuraci√≥n.  El comando rl reinicia inmediatamente el n√∫mero de socket indicado despu√©s.  Del mismo modo, el comando sr lee el estado del socket, dando su valor como un n√∫mero HEX.  El comando "ens" proporciona una tabla de estados para cada socket: estado "0": el socket est√° libre, esperando al cliente, estado "1": el socket en uso normal, estado "2": el socket en modo de control.  Puede ingresar una cantidad mucho mayor de comandos.  Ser√° √∫til cambiar los par√°metros que se ajustan al chip en la etapa de inicializaci√≥n cuando se enciende el dispositivo (por ejemplo, par√°metros de red), almacen√°ndolos en la memoria no vol√°til del MK.  Tambi√©n puede ser √∫til ingresar comandos especiales que controlar√°n pines MK libres adicionales.  Por ejemplo, "PC0 = 1", "PC2 = 0", etc.  Aseg√∫rese de necesitar el comando de configuraci√≥n UART interface MK. <br><br>  Considere los detalles m√°s sutiles del trabajo del programa MK.  Adem√°s de los temporizadores mencionados anteriormente, se activa un temporizador, gracias al cual, cada aproximadamente medio minuto, se denomina  Paquetes de control TCP "keep-alive".  Esto es necesario para verificar la conexi√≥n en ausencia de intercambio de datos del usuario.  Si por alguna raz√≥n no hay confirmaci√≥n del cliente dentro de un cierto tiempo establecido dentro del W5500, el llamado  tiempo de espera y el z√≥calo se reiniciar√°.  La conexi√≥n puede perderse repentinamente, por ejemplo, debido a una interrupci√≥n en el enlace de datos o la capa f√≠sica: desconectaron un cable Ethernet, desconectaron Internet o perdieron una conexi√≥n Wi-Fi, etc. <br><br>  Seg√∫n la documentaci√≥n del chip W5500 (hoja de datos), las siguientes funciones se implementan en el c√≥digo del programa.  En primer lugar, las funciones b√°sicas de escribir y leer registros W5500 en direcciones.  Funciones de nivel superior: reinicio de hardware, inicializaci√≥n de chip, inicializaci√≥n de socket, abrir un socket, escuchar socket, desconectar y cerrar el socket, enviar el comando "keep_alive", reiniciar el socket.  La √∫ltima funci√≥n es una composici√≥n de las funciones anteriores: cierre, apertura, escucha.  La mayor√≠a de las funciones devuelven un valor de estado de socket despu√©s de que se ejecutan.  Finalmente, las funciones m√°s b√°sicas son procesar la informaci√≥n recibida (lectura del b√∫fer RX) y procesar la informaci√≥n enviada (escribir en el b√∫fer TX).  Tom√© recomendaciones sobre la implementaci√≥n de estas funciones del sitio web oficial del fabricante de chips W5500 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> ).  La funci√≥n de recepci√≥n sobrescribe los datos recibidos del b√∫fer RX en su propio b√∫fer sin anillo de 128 bytes.  Este tama√±o es suficiente para aplicaciones simples, y no puede obtener mucho del microcontrolador Atmega8.  El b√∫fer TX del W5500 tambi√©n transfiere datos del b√∫fer intermedio, que tambi√©n es de tama√±o peque√±o.  Y a su vez, los datos del b√∫fer de anillo UART entran en √©l.  Este √∫ltimo se implementa autom√°ticamente en el entorno de desarrollo CVAVR utilizando la utilidad CodeWizardAVR en la etapa de creaci√≥n del proyecto. <br><br>  El W5500 est√° conectado a la interfaz MKI SPI (MOSI, MISO, SCK, SCLK).  Adem√°s, el pin RST (reinicio de hardware) est√° conectado a una salida MK espec√≠fica, y el pin INT correspondiente est√° conectado a la entrada de interrupci√≥n externa INT0.  Este √∫ltimo se utiliza para su prop√≥sito previsto: cuando ocurre un evento en el m√≥dulo W5500, genera un pulso en el pin INT, que es procesado por el controlador en el cuerpo de la interrupci√≥n externa.  MK aprende en qu√© sockets se produjo el evento, luego reescribe los c√≥digos de evento para cada socket en una matriz espec√≠fica.  El procesamiento adicional de la interrupci√≥n ocurre dentro del ciclo principal del programa.  En total, se documentaron cinco eventos: el cliente se conect√≥, el cliente se desconect√≥ (m√°s precisamente, present√≥ una solicitud de desconexi√≥n), se recibieron datos del cliente, se agot√≥ el tiempo de espera, los datos se enviaron con √©xito.  En el bucle principal, se procesan todos los eventos excepto el √∫ltimo.  La declaraci√≥n de cambio de caso se coloca en este proceso.  La mayor parte del c√≥digo C se encuentra en la secci√≥n de procesamiento del tercer evento (recepci√≥n de datos).  En √©l, despu√©s de la funci√≥n de procesar la informaci√≥n recibida, tambi√©n se coloca el operador de caja de conmutaci√≥n, pero en este caso este "interruptor" est√° asociado con una variable responsable del estado del socket mencionado anteriormente (valores 0, 1, 2).  La primera secci√≥n es responsable del procedimiento de reconocimiento de contrase√±a.  Los caracteres recibidos se sobrescriben en un b√∫fer de contrase√±a separado.  Bajo ciertas condiciones, las funciones de comparar la cadena recibida con cadenas constantes que contienen contrase√±as funcionan.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En caso de coincidencia, se asigna el estado correspondiente. La segunda secci√≥n es la m√°s simple: el contenido de su propio b√∫fer de informaci√≥n recibida se redirige al UART del microcontrolador. Este es un modo de uso normal. La tercera secci√≥n (la m√°s grande) se encarga de procesar los comandos: modo de control del dispositivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s de la continuaci√≥n del controlador de interrupciones, el bucle principal del programa contiene controladores de temporizador virtual: un tiempo de espera para desconectarse cuando la contrase√±a no tiene √©xito, env√≠e peri√≥dicamente "keep-alive" y env√≠e un paquete formado por el temporizador TCP al cliente. La funci√≥n de lectura de UART tambi√©n se coloca en el cuerpo del bucle principal, dentro del cual los caracteres recibidos por el controlador se transfieren a su propio b√∫fer de transmisi√≥n (intermedio) y se reinicia el temporizador, que es responsable de la formaci√≥n del paquete TCP.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los procedimientos de socket se colocan en un ciclo de 0 a 7, cuyo iterador est√° vinculado al n√∫mero de socket. Por lo tanto, se produce el procesamiento secuencial de todos los sockets. Inicialmente, quise decir que si asigna el mismo n√∫mero de puerto a cada uno de los ocho sockets, puede conectar hasta ocho usuarios en el mismo puerto. Sin embargo, esta configuraci√≥n no funcion√≥ y este problema se pospuso para el futuro.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al dise√±ar el dise√±o de la placa de circuito, proporcion√© un reloj en tiempo real (RTC) en el chip DS1307. El Atmega8 MK, cuarzo para la frecuencia de 11.0592 MHz (frecuencia seleccionada para precisi√≥n UART), un conector para el m√≥dulo W5500, conectores de puerto MK (incluido SPI para firmware, UART), RTC con su propio compartimento de bater√≠a de cuarzo y CR2032 est√°n ubicados en una placa de circuito impreso de dos lados , Regulador lineal de 5 V (7805), conector de alimentaci√≥n y m√°s. El boceto de la placa de circuito impreso en el programa Sprint Layout se muestra en la Figura 11. El √∫nico elemento que se muestra en rojo est√° soldado en la parte posterior, pero lo solt√© en la parte frontal.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/po/fd/zapofdoavvxgcamlagyghd_zkae.jpeg"></div>  <i>Fig.</i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. Boceto de la placa de circuito.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Las fotos de la construcci√≥n terminada se presentan en la Figura 12. Se usar√° un reloj en esta construcci√≥n para marcar la hora durante varios eventos de los enchufes W5500, y esta vez se asignar√° al usuario en el terminal al lado del mensaje si el usuario est√° conectado en modo de control. Y tambi√©n, el reloj ser√° √∫til para el futuro para experimentos con el protocolo de tiempo NTP o para cualquier otro prop√≥sito.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/fv/_r/hffv_rfjm1svqdgzmvmauahrmw0.jpeg"></div>  <i>Fig.</i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. Fotos de la estructura terminada.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En conclusi√≥n, vale la pena se√±alar que el dise√±o interno en su mayor parte justifica dispositivos similares a nivel industrial. La principal ventaja es el precio. Result√≥ ser mucho m√°s barato de fabricar que el precio de un dispositivo similar terminado. Y una desventaja como la funcionalidad limitada es inevitable. En este caso, se utiliz√≥ un controlador Atmega8 simplificado, ya que se estableci√≥ el objetivo simplificado correspondiente.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/ko/fx/hykofxdictcvxijma6idea8hczq.jpeg"></div>  <i>Fig.</i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13. Convertidor industrial TCP / IP - RS-232.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La Figura 13 muestra un ejemplo de un convertidor industrial TCP / IP a RS-232 basado en el chip W5100, muy similar al W5500. Adem√°s de su interfaz de administraci√≥n flexible, tiene una ventaja m√°s. Adem√°s de trabajar con un terminal TCP / IP, es posible utilizar un controlador especial que viene con el dispositivo para instalar un puerto COM virtual en el lado del cliente. A trav√©s de √©l, puede conectarse usando un terminal normal que no tiene modo de conexi√≥n TCP / IP. Adem√°s, el dispositivo puede admitir el intercambio de datos RS-232 completo si alg√∫n programa est√° conectado en lugar del terminal a trav√©s de un puerto COM virtual. Es decir, el dispositivo representado en la Figura 13 es un puente RS-232 completo a trav√©s de la infraestructura de red.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414211/">https://habr.com/ru/post/es414211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414199/index.html">Skynet, hola: la inteligencia artificial ha aprendido a ver a las personas a trav√©s de las paredes</a></li>
<li><a href="../es414201/index.html">C√≥digo Divino (c√≥digo de DIOS)</a></li>
<li><a href="../es414203/index.html">Estafa o no estafa? Verificamos ICO por cinco m√©todos</a></li>
<li><a href="../es414207/index.html">El problema del innovador, o por qu√© necesita recurrir a la experiencia de otras personas.</a></li>
<li><a href="../es414209/index.html">IGNG - Algoritmo incremental de gas neuronal incremental</a></li>
<li><a href="../es414213/index.html">¬°Uno, dos, tres! Chatbot de Google Sheets usando el ejemplo de un juego PvP para Alice</a></li>
<li><a href="../es414215/index.html">Bloques personalizados en chips (Silicon IP): c√≥mo funciona</a></li>
<li><a href="../es414217/index.html">Smartphones locales Vertex: primero en calidad, primero en chips, primero en dise√±o</a></li>
<li><a href="../es414219/index.html">La experiencia del uso de la energ√≠a solar en la regi√≥n de Mosc√∫: a favor, en contra y qui√©n la necesita</a></li>
<li><a href="../es414221/index.html">Analizando y trabajando con Codificable en Swift 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>