<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèΩ ‚õÑÔ∏è üëó 3 problemas na transfer√™ncia de dados para o Google Analytics por meio do Protocolo de avalia√ß√£o üé° üîò üòÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Ivan Spiridonov, sou o criador do servi√ßo de an√°lise de ponta a ponta R7K12. Nosso sistema ajuda a identificar as fontes mais ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>3 problemas na transfer√™ncia de dados para o Google Analytics por meio do Protocolo de avalia√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485482/">  Ol√° pessoal!  Meu nome √© Ivan Spiridonov, sou o criador do servi√ßo de an√°lise de ponta a ponta R7K12.  Nosso sistema ajuda a identificar as fontes mais eficazes de publicidade que trazem lucro real para a empresa, e n√£o apenas gastam o or√ßamento.  Para analisar estat√≠sticas de visitas, vendas, chamadas direcionadas, alguns clientes usam n√£o apenas o R7K12, mas tamb√©m o Google Analytics (daqui em diante GA). <br><a name="habracut"></a><br>  Portanto, hoje queremos compartilhar nossa pr√≥pria experi√™ncia na transfer√™ncia de dados para o GA usando o Protocolo de Medi√ß√£o (doravante, MP).  Tenho certeza que muitos achar√£o essas informa√ß√µes √∫teis.  Como configurar o envio de informa√ß√µes usando MP e o que √© descrito em detalhes <a href="https://netpeak.net/ru/blog/measurement-protocol-podklyuchayem-offlayn-biznes-k-google-analytics/">aqui</a> .  E vou falar sobre as "armadilhas" do instrumento e mostrar como voc√™ pode contorn√°-las.  Ao transferir dados para o GA atrav√©s do MP, os seguintes problemas costumam surgir: <br><br><ol><li>  Leitura incorreta do endere√ßo IP. </li><li>  Substituir o tipo de dispositivo do usu√°rio. </li><li>  Atribui√ß√£o aleat√≥ria de fontes de publicidade. </li></ol><br>  Vamos considerar cada um deles com mais detalhes. <br><br><h3>  Leitura de endere√ßo IP inv√°lida </h3><br>  O MP possibilita a transfer√™ncia de dados (aplicativos, vendas, telefonemas) de fontes offline para o GA.  O sistema determina com precis√£o os endere√ßos IP dos visitantes usando um contador instalado no site. <br><br><img src="https://habrastorage.org/webt/ib/uq/yw/ibuqywgt7czcs3rrz5hl8nfqtqk.png"><br><br>  Considere esse ponto com mais detalhes em um exemplo espec√≠fico.  Vamos ao site <a href="https://www.r7k12.ru/">www.r7k12.ru</a> e abrimos o c√≥digo da p√°gina.  Na guia "Rede", pode ser visto que n√£o h√° endere√ßo IP nos par√¢metros de solicita√ß√£o.  Isso ocorre porque quando o contador do GA √© acionado no site, o sistema determina o pa√≠s / cidade com base no IP do usu√°rio. <br><br><img src="https://habrastorage.org/webt/ht/zb/qx/htzbqxlzr-qrvoygfii43hkiaxg.png"><br><br>  Dessa forma, uma visita ao sistema de an√°lise ser√° gravada com a geolocaliza√ß√£o correta. <br><br><img src="https://habrastorage.org/webt/_g/et/zo/_getzob1u-3of89egtd4x0f5ke0.png"><br><br>  Agora, tentaremos enviar os dados de vendas MP para o GA no ID do cliente meia hora depois (ap√≥s o t√©rmino da sess√£o atual).  Esclarecerei imediatamente que farei uma solicita√ß√£o de um servidor localizado na Alemanha. <br><br><img src="https://habrastorage.org/webt/dg/ww/xr/dgwwxrb-947zi-ykpx8g8ptg-vy.png"><br><br>  Ent√£o, depois de transferir dados para o GA, vemos que no mesmo ID do cliente, uma sess√£o da Alemanha foi aberta.  Por que isso aconteceu? <br><br><img src="https://habrastorage.org/webt/mi/nq/pz/minqpzkggkci4na5u9oke4hrnkc.jpeg"><br><br>  O fato √© que, quando informa√ß√µes adicionais sobre MP s√£o recebidas no sistema de an√°lise ap√≥s o final da sess√£o principal, uma nova √© criada e o GA l√™ o endere√ßo IP do servidor do qual a solicita√ß√£o foi transmitida.  Assim, todos os dados obtidos dessa maneira receber√£o o mesmo IP. <br><br>  Essa nuance pode criar discrep√¢ncias bastante grandes nos relat√≥rios, especialmente se os usu√°rios e o servidor tiverem uma localiza√ß√£o geogr√°fica diferente.  Por exemplo, no nosso caso, o servidor est√° localizado na Alemanha e os aplicativos dos clientes v√™m da Ucr√¢nia.  No entanto, no relat√≥rio do GA, um pedido enviado usando MP ap√≥s o final da sess√£o ter√° um endere√ßo IP inv√°lido. <br><br><img src="https://habrastorage.org/webt/at/5x/g2/at5xg2qlfj0ew-jj4f26-4nn-7e.jpeg"><br><br>  Assim, o GA corrige apenas o endere√ßo IP do servidor, e n√£o usu√°rios espec√≠ficos, para que todas as vendas tenham um IP alem√£o. <br><br><img src="https://habrastorage.org/webt/6r/t0/d0/6rt0d0o4fow3j8matwxqq-koyuu.png"><br><br>  Para resolver esse problema, recomendo adicionar um par√¢metro especial (uip) ao enviar uma solicita√ß√£o, com a qual voc√™ pode transferir os endere√ßos IP dos visitantes.  Se o site estiver escrito em PHP, os dados para o par√¢metro poder√£o ser obtidos da vari√°vel $ _SERVER ['REMOTE_ADDR']. <br><br><img src="https://habrastorage.org/webt/lt/mu/3v/ltmu3vmhzmlcf5rxcthvtpal0ms.png"><br><br>  A consulta final deve se parecer com isso: <br><br><img src="https://habrastorage.org/webt/a8/p-/du/a8p-dur-tyh6aom3m4hp5ukskmy.png"><br><br>  Depois disso, as seguintes altera√ß√µes s√£o vis√≠veis no GA: <br><br><img src="https://habrastorage.org/webt/8u/hy/o3/8uhyo3cgtzkglpzrwuufalklax8.png"><br><br><h3>  Substitui√ß√£o do tipo de dispositivo do usu√°rio </h3><br>  O sistema de an√°lise determina informa√ß√µes sobre o tipo de dispositivo dos cabe√ßalhos que s√£o transmitidos junto com a solicita√ß√£o.  Portanto, como no caso de endere√ßos IP, ao enviar dados via MP ap√≥s a conclus√£o da sess√£o principal no GA, o valor desses dados geralmente ser√° "desktop" (o agente do usu√°rio do servidor atual √© usado), mesmo que o visitante tenha deixado uma solicita√ß√£o de um telefone celular ou tablet. <br><br><img src="https://habrastorage.org/webt/dj/fw/nc/djfwncc2jox566idkc4xybqbdt4.png"><br><br>  Em tal situa√ß√£o, n√£o podemos determinar corretamente a convers√£o do dispositivo ou navegador, por isso devemos novamente usar tags adicionais ao enviar uma solicita√ß√£o ao GA.  Aqui o par√¢metro ua nos ajudar√°. <br><br><img src="https://habrastorage.org/webt/d8/uc/tb/d8uctbtcles0-rldtnkx2b1zbqu.png"><br><br>  E √© assim que a consulta ficar√°, o que ajudar√° a determinar o tipo de dispositivo do usu√°rio. <br><br><img src="https://habrastorage.org/webt/f3/er/wd/f3erwdabajsmn1dtqisvrwojr7a.png"><br><br><h3>  Atribuindo fontes de an√∫ncio </h3><br>  Al√©m disso, ao enviar via MP, existem alguns recursos da atribui√ß√£o de plataformas de publicidade.  Ou seja, o servi√ßo do GA tem seu pr√≥prio algoritmo para determin√°-los.  Por exemplo, um usu√°rio foi ao site da fonte do Google Adwords √†s 15:31 e deixou uma solicita√ß√£o. <br><br><img src="https://habrastorage.org/webt/l8/g8/ze/l8g8zeejhr-nsmtnpc1cvfbbylc.png"><br><br>  A segunda visita foi com Yandex / cpc, e a √∫ltima foi uma liga√ß√£o direta √†s 18:13.  Enviou a venda √†s 18:48, ap√≥s a conclus√£o da √∫ltima visita do usu√°rio.  Nesse sentido, a GA lan√ßou outra sess√£o com acesso direto ao site. <br><br><img src="https://habrastorage.org/webt/1t/ng/fe/1tngfe6bhzxo9dz540xti7jdnvc.png"><br><br>  O relat√≥rio mostra que todas as tr√™s sess√µes e a transa√ß√£o foram atribu√≠das √† plataforma de publicidade yandex / cpc, embora, de fato, a visita e o aplicativo tenham sido com o Google Adwords.  Como isso aconteceu? <br><br><img src="https://habrastorage.org/webt/jc/kq/fd/jckqfdl5tlhnfoabu8uxqtsm-2u.png"><br><br>  O GA atribui dados nos relat√≥rios √† √∫ltima visita indireta do usu√°rio.  E isso significa que, se no momento em que os dados n√£o foram enviados ao sistema de an√°lise, o cliente visitou o site de outras fontes de publicidade, o aplicativo ser√° corrigido para uma delas.  Uma situa√ß√£o semelhante √© t√≠pica para sites em que a venda ocorre algum tempo ap√≥s o envio do pedido e o cliente consegue visitar o site novamente.  Por exemplo, b2b, onde o intervalo entre o aplicativo e a venda pode variar de um dia a v√°rios meses. <br><br>  Assim, a defini√ß√£o de fontes de publicidade se torna um problema.  A √∫nica sa√≠da √© adicionar manualmente todos os sites usados ‚Äã‚Äãao GA ao enviar uma solicita√ß√£o MP usando par√¢metros especiais (cn, ck, cc, cm, cs). <br><br><img src="https://habrastorage.org/webt/60/td/pf/60tdpf7gwwklsyys523vnj7rxbw.png"><br><img src="https://habrastorage.org/webt/6z/bj/fh/6zbjfhtqj_icmhj4bpxpppkcnxw.png"><br><img src="https://habrastorage.org/webt/fn/25/a-/fn25a-gqlhgtv672mfd8awk6q3e.png"><br><img src="https://habrastorage.org/webt/dq/wi/se/dqwisezb2heu3jgkd900k9utviu.png"><br><br>  Se voc√™ enviar uma solicita√ß√£o indicando a fonte (neste exemplo, google / cpc), a transa√ß√£o ser√° atribu√≠da ao canal de publicidade correto. <br><br><img src="https://habrastorage.org/webt/1y/y0/jt/1yy0jtuwgvq9ed0ggaohs38gk2o.png"><br><br>  O conjunto de par√¢metros √© assim: <br><br><img src="https://habrastorage.org/webt/ic/nj/5v/icnj5vookhybrm41vb7xjnithmu.png"><br><br>  Mas h√° uma nuance importante que deve ser levada em considera√ß√£o ao formar uma solicita√ß√£o.  A publicidade do GoogleAds n√£o funciona com tags UTM; no entanto, o sistema tem uma fun√ß√£o especial de codifica√ß√£o autom√°tica - o ID de clique do Google (GCLID). <br><br><img src="https://habrastorage.org/webt/9d/oi/mw/9doimwtrl2ioqgke2zedovzwewq.png"><br><br>  Isso significa que, para a exibi√ß√£o correta das empresas de publicidade, ser√° necess√°rio enviar n√£o apenas tags UTM, mas tamb√©m GCLID.  Exemplo da consulta final: <br><br><img src="https://habrastorage.org/webt/m-/bm/oy/m-bmoys5mjiladueveg-ugdta7g.png"><br><br>  Em conclus√£o, quero resumir todas as op√ß√µes acima em rela√ß√£o ao MP.  Essa ferramenta possui alguns recursos que voc√™ precisa conhecer sobre a transmiss√£o de informa√ß√µes ao Google Analytics.  Para que os dados sejam enviados corretamente, √© imperativo especificar par√¢metros adicionais na solicita√ß√£o.  Com a ajuda deles, fontes de publicidade, tipo de dispositivo, endere√ßos IP dos visitantes e outras informa√ß√µes importantes ser√£o exibidas corretamente pelo servi√ßo GA. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485482/">https://habr.com/ru/post/pt485482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485468/index.html">Variante de trabalhar com soquetes da Web no iOS no Swift / Escreveu um gerente para trabalhar com o websocket</a></li>
<li><a href="../pt485470/index.html">HighLoad ++, Andrey Gushchin (Zabbix): alto desempenho e particionamento nativo</a></li>
<li><a href="../pt485472/index.html">O que h√° de novo a esperar da AMD?</a></li>
<li><a href="../pt485476/index.html">Tend√™ncias e negocia√ß√£o na bolsa: 4 indicadores populares de an√°lise t√©cnica</a></li>
<li><a href="../pt485480/index.html">Coluna port√°til Z-poject Doublebeef - mono duplo em russo. Testar, desmontar e atualizar</a></li>
<li><a href="../pt485484/index.html">[Locomizer de caso] Que conhecimento pode realmente ser extra√≠do de um conjunto de dados an√¥nimo com coordenadas do usu√°rio</a></li>
<li><a href="../pt485486/index.html">Suporte para Buildpacks no Spring Boot 2.3.0</a></li>
<li><a href="../pt485488/index.html">Mais uma vez sobre DevOps e SRE</a></li>
<li><a href="../pt485490/index.html">Por que Musk n√£o podia nascer na R√∫ssia?</a></li>
<li><a href="../pt485492/index.html">Os cientistas dizem qu√£o r√°pido o universo est√° se expandindo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>