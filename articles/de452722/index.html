<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🚀 👩🏼‍🎤 🥕 Machen Sie Freunde CI, Unit-Tests und Datenbank 🤴 👨🏿‍🔬 🧔🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel wird die Interaktion mit der Datenbank in CI getestet. Ich habe mehrere Lösungen mit Docker und Testcontainern gesehen, aber ich hab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Machen Sie Freunde CI, Unit-Tests und Datenbank</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="Bild"></div><br>  In diesem Artikel wird die Interaktion mit der Datenbank in CI getestet.  Ich habe mehrere Lösungen mit Docker und Testcontainern gesehen, aber ich habe meine eigene und möchte sie teilen. <br><a name="habracut"></a><br>  Mein früheres Java-Projekt war eng mit einer Datenbank verbunden.  Lange Verarbeitung mit Wiederholungsversuchen, Multithreading und Sperren.  Für die Aufgabe mussten einige knifflige SQL-Abfragen korrigiert werden.  Ich war es irgendwie gewohnt, meinen Code mit Tests zu bedecken, aber vorher wurde das gesamte SQL auf primitive Abfragen reduziert und konnte auf einer H2-Basis im Speicher ausgeführt werden.  Und hier auf Hardcore. <br><br>  Ich könnte einfaches SQL mit meinen Händen testen und feige auf Selbsttests hämmern, was mich rechtfertigt: "Ich bin kein Bagodel, es gibt Fehler im einfachen Code."  Tatsächlich treten Fehler aufgrund der Verfügbarkeit von Tests seltener auf.  Es war möglich, die Verantwortung auf die Tester zu übertragen - wenn ich irgendwo einen Fehler machte, würden sie ihn finden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="Bild"></div><br>  Nach der Ideologie des Unit-Tests werden Tests nur zum Testen einzelner Module benötigt. Wenn das Modul etwas von außen verwendet, sollte dies durch einen Stub ersetzt werden.  In der Praxis wird das Modul einfach ignoriert, wenn es zu schwierig wird, einen Stub zu implementieren.  Geschwindigkeit und Modularität sind wichtig, aber es ist wichtiger, den Code nicht ungetestet zu lassen, auch wenn er nicht in den Abdeckungsmetriken angezeigt wird.  Daher wird das Modul nicht mehr als separate Klasse betrachtet, sondern zusammen mit der Konfiguration als verbundene Gruppe.  Die Hauptsache bei solchen Aussagen ist, nicht zum Konzept der Einheitsausdehnung auf die Clusterebene zu gelangen. <br><br>  Für lokale Tests hat jeder Entwickler sein eigenes Schema, aber Tests werden auf Jenkins ausgeführt und es besteht dort noch keine Verbindung zur Datenbank.  CI braucht einen separaten Stromkreis, das scheint offensichtlich zu sein.  In einem leeren Diagramm ist es jedoch nicht sehr korrekt, Tests auszuführen. Das Erstellen einer Datenbankstruktur in jedem Test ist zeitaufwändig und mit einer Diskrepanz zwischen der Struktur im Test und im Kampf behaftet.  Laufen Sie auf einer vorbereiteten Basis - ich habe eine Reihe von Problemen mit Zweigen.  Sie können die Datenbank vorbereiten, bevor Sie alle Tests mit liquibase ausführen. Zuerst löschen Sie alles auf Null und aktualisieren dann auf die neueste Version. <br><br>  Das Zurücksetzen des Rollbacks wird oft vergessen, und Sie müssen die Basen in Testumgebungen mit den Händen reinigen.  Teste es und ihn!  Der Algorithmus ist wie folgt: <br><br><ol><li>  Entfernen Sie alles unter der Wurzel (für die Reinheit des Experiments) </li><li>  Update auf die neueste Version </li><li>  Führen Sie Rollback 1-2 Versionen zurück </li><li>  Update auf die neueste Version (Tests müssen für die neue Datenbankstruktur durchgeführt werden, und es muss überprüft werden, ob beim Rollback nichts vergessen wurde, um zu verhindern, dass das Update erneut ausgeführt wird.) </li></ol><br>  Mitentwickler möchten beim Starten jedes Tests keine Rollback-Tests ausführen.  Wir machen den Wechsel. <br><br><pre><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br>  Während Katzen trainiert werden, ist alles in Ordnung.  Ein sich dynamisch entwickelndes Projekt nimmt jedoch seine eigenen Anpassungen vor - 2 Pull-Quests, gleichzeitige Montage.  Eine Instanz testet etwas und die zweite schlägt die Basis unter ihren Füßen hervor.  Es wird durch ein einfaches Verbot paralleler Baugruppen gelöst. <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="Bild"><br><br>  Und wieder ein Sturz - ich habe beschlossen, Tests mit dem Jenkins-Konto durchzuführen, weil  In persönlicher Hinsicht ist alles in Ordnung, und der Pool an Anfragen fällt aus unklaren Gründen.  Wir erinnern uns an die leidenschaftliche Rede, dass DevOps eine Kultur ist und die Verwendung technischer Konten für persönliche Zwecke nicht akzeptabel ist. <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="Bild"><br><br>  Insgesamt 10 Anfragen gesammelt.  Alles gesammelt, neu verteilt, können Sie zusammenführen.  Der erste ging, der Hauptzweig wechselte - der Rest steht zusammen für den Wiederaufbau.  Sie können im Laufe der Zeit zusammenführen, es gibt jedoch Prioritäten.  Dringendere und weniger dringende Pull-Anfragen hängen aufgrund von Fehlern im Code ebenfalls auf.  Parallelisieren Sie im Allgemeinen zurück. <br><br>  Die Montage sollte einfach sein, aus einfachen Schritten bestehen und auch für den gestrigen Schüler verständlich sein.  Bei 99% besteht kein Problem darin, dass die Zusammenstellung des Anforderungs- und Freigabepools sequentiell und nicht parallel erfolgt.  Wenn die Überprüfung nicht mehr als 1-2 PR umfasst, ist das Verbot gleichzeitiger Baugruppen völlig ausreichend. <br><br>  Und für den parallelen Start benötigen wir Basen oder Schemata, auf die jeder gestartete Test exklusiven Zugriff hat. <br><br>  Option eins ist die dynamische Zuordnung.  Das Erstellen eines Schemas in der Datenbank ist schnell.  Mit einer Cloud mit einer API können Sie dort eine Datenbank zuweisen. <br><br>  Wenn Sie das Löschen alter Datenbanken nicht klären, können Sie den Speicherplatz schnell beenden, wenn die Tests fallen, und „vergessen“, Ressourcen freizugeben.  Es ist "wann", nicht "wenn". <br><br>  Option zwei - ein Datenbank- / Schemapool mit einem separaten Verwaltungsdienst.  Die API ragt heraus, gibt die Basis für die Zeit an und nimmt die freie Basis vor der Laufzeit zurück.  Was es zurückgibt: Ein dedizierter Server mit einer Datenbank oder nur einem kleinen Schema spielt keine Rolle.  Die Hauptsache ist, dass die Ressource nicht für immer verloren geht. <br><br>  Option drei - ein Pool von Grundlagen / Systemen zur Selbstregulierung.  Für den Informationsaustausch über Sperren und den Datenbankpool selbst wird eine Ressource benötigt. <br><br>  Ich habe mich für die letztere Option entschieden, da es für mich einfacher ist, sie zu befestigen, und es nicht besonders erforderlich ist, sie zu unterstützen.  Die Logik lautet wie folgt: Es werden mehrere (z. B. 10) Schaltkreise erstellt und alle erforderlichen Informationen zum Herstellen einer Verbindung werden der gemeinsam genutzten Ressource hinzugefügt. Jede Testinstanz vor dem Start setzt eine Startmarkierung, nach dem Ende löscht sie.  Wenn der Test vor dem Abschluss abstürzt, wird die Schaltung am Ende des Timeouts als frei betrachtet. <br><br>  Leseeinstellungen: <br><br><pre> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br>  Das Arbeiten mit SQL aus Gradle-Skripten erfordert das Laden des Treibers: <br><pre> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br>  Verbindung: <br><br><pre> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br>  Der Informationsaustausch kann über die Datenbanktabelle erfolgen.  Initialisierung der Referenztabelle (sollte einmal funktionieren, dann lebt die Tabelle bis zum Ende der Zeit): <br><br><pre> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br>  Entwickler haben ihre eigenen Schemata für das Debuggen und Zusammenstellen, daher muss die Verwendung des Pools deaktiviert werden: <br><br><pre> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br>  Nehmen Sie und freie Basis: <br><br><pre> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br>  Wenn Sie die Assembly zweimal hintereinander abschließen, können unterschiedliche Schemata ausgewählt werden, und beim Zusammenstellen der Eigenschaftendateien bleiben unterschiedliche Werte erhalten.  Bei lokalen Starts sind die Einstellungen statisch. <br><br><pre> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br>  Aufgaben zum Testen des Rollbacks: <br><br><pre> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br>  Und richten Sie die Ausführungsreihenfolge ein: <br><br><pre> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br>  Datenbankzuweisung und Rollback-Tests können in Tests platziert werden.  Möglichkeiten zum Ausführen von Code vor und nach Abschluss aller Tests: In Junit5 ist dies BeforeAllCallback in TestNG BeforeSuite. <br><br>  Auf die Frage „Warum sollte SQL vom Java-Programmierer getestet werden?“ Lautet die Antwort, dass jeder Code getestet werden sollte.  Es gibt Ausnahmen und das Testen von Code ist zu einem bestimmten Zeitpunkt irrational. <br><br>  Ich möchte wissen, wie das Problem des Testens der Interaktion mit der Datenbank von anderen Programmierern gelöst wird.  Sind Container in jedem Haus angekommen oder werden Integrationstests auf die Schultern von Testern übertragen? <br><br><div class="spoiler">  <b class="spoiler_title">Vollständige Auflistung</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452722/">https://habr.com/ru/post/de452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452706/index.html">1983 wurde dieser Computer von Bella Labs der erste Großmeister.</a></li>
<li><a href="../de452712/index.html">Wie wir versucht haben, in einem Team zu arbeiten und was dabei herauskam</a></li>
<li><a href="../de452714/index.html">Achten Sie auf Nummer 5: Zusammenfassung der Artikel zu Produktdenken, Verhaltenspsychologie und Produktivität</a></li>
<li><a href="../de452716/index.html">Auf der Suche nach einem optimalen Einsatzort der Humanressourcen</a></li>
<li><a href="../de452718/index.html">PsyGuide: Aufmerksamkeitsdefizit. # 0001/1001</a></li>
<li><a href="../de452724/index.html">Phoenix LiveView: Wenn Javascript-Code Spaß macht *</a></li>
<li><a href="../de452726/index.html">Süße Knochen 3D: hyperelastisches Knochenmaterial für Schädeldefekte aus Kunststoff</a></li>
<li><a href="../de452730/index.html">Zertifizierung von Informationssystemen nach dem Prinzip der Standardsegmente. Mythen und Wirklichkeit</a></li>
<li><a href="../de452734/index.html">Migrieren Sie iOS (ARM) -Anwendungen mithilfe von Bitcode automatisch auf macOS (x86)</a></li>
<li><a href="../de452736/index.html">Nachrichtenverschlüsselung in SecureDialogues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>