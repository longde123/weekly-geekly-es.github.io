<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé§ üìñ ü§∑üèΩ Sur les options du pilote Linux ou comment j'ai pass√© le week-end üéÄ üê¥ üë©üèº‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Nous sommes paresseux et curieux" 


 Cette fois, la raison de la publication √©tait un article dans un bon magazine d√©di√© au syst√®me d'exploitation L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sur les options du pilote Linux ou comment j'ai pass√© le week-end</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431860/"><h3>  "Nous sommes paresseux et curieux" </h3><br><img src="https://habrastorage.org/webt/sh/n6/_h/shn6_hdnwzoz1wv0ifrfabhtbpg.jpeg"><br><br>  Cette fois, la raison de la publication √©tait un article dans un bon magazine d√©di√© au syst√®me d'exploitation Linux (ci-apr√®s d√©nomm√© L), dans lequel "l'expert" attir√© a f√©licit√© le pilote connectant l'√©cran LCD √† la carte Raspbery.  √âtant donn√© que de telles choses (connexion, pas le syst√®me d'exploitation) entrent dans le champ de mes int√©r√™ts professionnels, j'ai parcouru l'article avec attention, puis j'ai trouv√© le texte r√©el du ¬´pilote¬ª et j'ai √©t√© l√©g√®rement surpris que l'informatique puisse √™tre lou√©e.  Eh bien, en g√©n√©ral, le niveau d'expert peut √™tre d√©termin√©, ne serait-ce que parce qu'il a obstin√©ment appel√© le programme un pilote, malgr√© le fait que ce ne soit en aucun cas.  Il semblerait, et les figues avec lui, vous ne savez jamais ce que quelqu'un √©crit pour lui-m√™me, mais pour le publier dans le domaine public - "Je ne savais pas que c'√©tait possible." <br><br>  Particuli√®rement satisfait du fait que l'adresse du p√©riph√©rique sur le bus I2C a √©t√© directement d√©finie dans le texte du programme et son changement a n√©cessit√© une recompilation (enfin, ce n'est pas tout le noyau).  Soit dit en passant, j'ai remarqu√© que sur les forums consacr√©s √† L, la r√©ponse la plus populaire √† toute question concernant les probl√®mes logiciels est ¬´reconstruire la derni√®re version du noyau¬ª.  Cette approche me semble un peu √©trange, probablement, je ne sais pas quelque chose.  Mais, n√©anmoins, la question s'est pos√©e de savoir comment le param√©trage du pilote est r√©ellement impl√©ment√© (√† l'int√©rieur, pas √† l'ext√©rieur - tout est simple et clair) dans A, la r√©ponse √† laquelle ce billet est consacr√©. <br><a name="habracut"></a><br>  Ce n'est pas que j'√©crivais constamment des pilotes pour L, mais avec le processus dans son ensemble, je suis familier et Google a confirm√© de vagues souvenirs qu'il existe un ensemble de macros qui devraient √™tre utilis√©es lors de la cr√©ation du code source du module afin de pouvoir lui transmettre des param√®tres de fonctionnement, par exemple, l'adresse de l'appareil √† au bus.  N√©anmoins, la m√©canique du processus lui-m√™me n'a √©t√© d√©crite nulle part.  J'ai vu le m√™me texte dans de nombreux liens (en passant, une question int√©ressante - pourquoi faire cela, c'est-√†-dire placer le fragment du texte de quelqu'un d'autre sur ma ressource - je ne comprends pas vraiment la signification de cette op√©ration), qui d√©crivait les macros ci-dessus.  Je n'ai pas trouv√© une seule mention du m√©canisme pour effectuer l'op√©ration, pour un autre syst√®me d'exploitation bien connu (Windows), je devrais √©noncer un fait et me limiter √† cela, mais l'un des avantages de A est la disponibilit√© des textes sources et la possibilit√© de trouver une r√©ponse √† toute question sur sa structure interne, ce que nous ferons.  Je constate tout de suite que j'essaierai de ne pas dupliquer les informations que vous pouvez obtenir aupr√®s d'autres sources, et je me limiterai seulement √† ce qui est n√©cessaire √† la compr√©hension du texte. <br><br>  Mais avant de regarder la source, nous allons d'abord r√©fl√©chir un peu, mais comment ferions-nous si nous obtenions une t√¢che similaire (et soudain, apr√®s ce post, ils m'inviteront chez les mineurs L, et vous ne refuserez pas).  Il y a donc la possibilit√© de cr√©er un module - une certaine unit√© de programme sp√©cialement con√ßue qui peut √™tre charg√©e en m√©moire pour √™tre ex√©cut√©e √† l'aide d'un utilitaire syst√®me (insmode - ci-apr√®s I), tandis qu'une cha√Æne de caract√®res est transmise en tant que param√®tres de lancement.  Cette ligne peut inclure des unit√©s lexicales strictement d√©finies, dont la description du format est sp√©cifi√©e lors de la cr√©ation du texte source du module, et ces unit√©s contiennent des informations qui vous permettent de modifier la valeur des variables internes de ce module. <br><br>  Examinons plus attentivement la mani√®re de d√©crire les unit√©s lexicales ci-dessus, nous en avons besoin pour envisager diff√©rentes solutions.  L'unit√© d'analyse est d√©termin√©e en appelant la macro, qui est inform√©e des informations n√©cessaires - le nom de la variable qui doit √™tre modifi√©e pendant le processus de configuration, son nom externe (g√©n√©ralement le m√™me que le pr√©c√©dent), le type de la variable de l'ensemble limit√© et les droits d'acc√®s √† la variable dans le style de rw-rw-rw.  De plus, une cha√Æne de texte (facultative) d√©crivant la variable peut √™tre sp√©cifi√©e.  De toute √©vidence, ces informations sont n√©cessaires et suffisantes (en conjonction avec les r√®gles de conception des unit√©s syntaxiques - s√©parateurs et jetons) pour construire l'analyseur de la liste de param√®tres sp√©cifi√©e sous la forme d'une cha√Æne de texte, mais laissent de la place pour la mise en ≈ìuvre de la distribution des fonctions entre le participant au processus. <br><br>  Pour configurer le module, nous avons besoin de: <br><br><ol><li>  formulaire (enfin, c'est au stade de la compilation, vous pouvez le faire comme vous le souhaitez, bien que ce soit toujours int√©ressant de voir comment) et stocker un tableau des param√®tres ci-dessus </li><li>  analyser les param√®tres d'entr√©e selon ce tableau et </li><li>  apporter des modifications √† certaines zones de la m√©moire en fonction du r√©sultat de l'analyse d'une unit√© syntaxique. </li></ol><br>  Nous r√©fl√©chirons un peu dans le style de ¬´si j'√©tais le r√©alisateur¬ª et proposerons des impl√©mentations possibles.  Comment nous pourrions impl√©menter le comportement similaire de l'utilitaire syst√®me et du module - nous commencerons l'analyse des options dans une complexit√© croissante. <br><br>  La premi√®re solution est que l'utilitaire And ne fait presque rien, appelle simplement le module qui lui est indiqu√© et lui transf√®re les param√®tres restants dans le style de ligne de commande, et le module les analyse d√©j√†, en s'appuyant sur les informations disponibles et en effectuant les modifications n√©cessaires.  Cette solution est simple, compr√©hensible et tout √† fait r√©alisable, mais la circonstance suivante doit √™tre prise en compte: en aucun cas l'analyse des param√®tres ne doit √™tre laiss√©e √† la volont√© de l'auteur du module, car cela lui donnera un espace inacceptable, et apr√®s tout, deux programmeurs √©criront toujours trois options d'analyseur.  Et donc nous sommes all√©s √† sa rencontre, en lui permettant des param√®tres de type ind√©fini, qui ont une cha√Æne de texte comme valeur. <br><br>  Par cons√©quent, un certain analyseur standard devrait √™tre automatiquement inclus dans le texte du module, c'est facile √† impl√©menter au niveau de la substitution de macro. <br><br>  Cette solution pr√©sente deux inconv√©nients: <br><br><ol><li>  on ne sait pas pourquoi nous en avons besoin. Et vous pouvez imm√©diatement appeler le module avec des param√®tres √† partir de la ligne de commande, </li><li>  le code du module (partie initialisation) doit contenir les trois sections des informations n√©cessaires, et ces informations sont n√©cessaires uniquement lorsque le module est d√©marr√© et n'est pas utilis√© √† l'avenir, et il prend toujours de la place.  Faites imm√©diatement une r√©servation que ces informations prennent n√©cessairement de la place dans le fichier, mais elles peuvent ne pas aller en m√©moire lors du chargement du module, si tout est fait avec soin.  Pour ce faire, nous rappelons les directives _init et _initdata (au fait, mais comment elles fonctionnent, nous devrons le comprendre - c'est le sujet du prochain billet - vous attendez-vous avec impatience?).  Mais dans ce dernier cas, les sections 2 et 3 des informations du fichier sont clairement redondantes, car le m√™me code sera pr√©sent dans de nombreux modules, violant malicieusement le principe DRY. </li></ol><br>  En raison des lacunes constat√©es, la mise en ≈ìuvre de cette option est hautement improbable.  De plus, on ne sait pas pourquoi dans la macro d√©finir des informations sur le type de param√®tre, car le module lui-m√™me sait tr√®s bien ce qu'il modifie (bien que cela puisse √™tre n√©cessaire pour l'analyseur lors de la v√©rification des param√®tres).  L'√©valuation globale de la probabilit√© d'une telle d√©cision est de 2 √† 3%. <br><br>  La digression n√©cessaire au sujet de l'inconv√©nient not√© 2 - J'ai √©t√© form√© en tant que sp√©cialiste √† l'√©poque o√π 256 kilo-octets de RAM √©taient suffisants pour organiser 4 postes de travail, 56 kilo-octets avaient un syst√®me d'exploitation √† double t√¢che et un syst√®me d'exploitation √† t√¢che unique a commenc√© √† fonctionner √† 16 kilo-octets.  Eh bien, 650 ko, ce qui devrait √™tre suffisant pour n'importe quel programme, √©taient g√©n√©ralement quelque chose du domaine de la fiction non scientifique.  Par cons√©quent, j'ai l'habitude de penser que la RAM est une ressource rare et je d√©sapprouve extr√™mement son utilisation inutile, √† moins qu'elle ne soit absolument n√©cessaire (en r√®gle g√©n√©rale, les exigences de performance), et dans ce cas, je n'observe pas une telle situation.  Puisque la plupart de mes lecteurs se sont form√©s dans des r√©alit√©s diff√©rentes, vous pouvez avoir vos propres √©valuations de la pr√©f√©rence de telle ou telle option. <br><br>  La deuxi√®me solution - l'analyseur lui-m√™me est transf√©r√© vers AND, qui transf√®re les donn√©es extraites au module (sa partie d'initialisation) - le num√©ro et la valeur du param√®tre.  Ensuite, nous pr√©servons l'uniformit√© des param√®tres et r√©duisons les exigences de taille du module.  La question demeure, comment fournir une liste ET de param√®tres possibles, mais cela est fourni par des macros en cr√©ant une structure pr√©d√©termin√©e du module et l'emplacement du bloc √† un endroit sp√©cifique (fichier ou m√©moire).  La solution est meilleure que la pr√©c√©dente, mais la m√©moire exc√©dentaire du module demeure.  En g√©n√©ral, j'aime la solution, car mon analyseur (qui est pire que tous les autres programmeurs, j'ai mon propre analyseur, non sans d√©fauts, mais certainement pas fatal) fonctionne selon ce sch√©ma, renvoyant le num√©ro de la r√®gle et la valeur identifi√©es au programme principal param√®tre.  N√©anmoins, la probabilit√© de mettre en ≈ìuvre cette option particuli√®re n'est pas tr√®s √©lev√©e - 5%. <br><br>  Une sous-option de la deuxi√®me solution consiste √† transf√©rer les param√®tres extraits non pas vers la partie de d√©part du module, mais directement vers sa partie active charg√©e, par exemple via ioctl - les besoins en m√©moire sont les m√™mes.  Nous avons une opportunit√© unique de changer les param√®tres "√† la vol√©e", ce qui n'est pas impl√©ment√© dans les autres versions.  Il n'est pas tr√®s clair pourquoi nous pourrions avoir besoin d'une telle fonctionnalit√©, mais elle est magnifique.  L'inconv√©nient est 1) vous devez r√©server une partie de la zone de fonction √† l'avance pour une demande √©ventuellement inutilis√©e, et 2) le code de modification doit √™tre pr√©sent en m√©moire en permanence.  Estimation de la probabilit√© de mise en ≈ìuvre - pourcentage 5. <br><br>  La troisi√®me solution est de transf√©rer vers Et aussi la modification des param√®tres.  Ensuite, dans le processus de chargement du code binaire du module Et, il peut modifier les donn√©es dans la m√©moire interm√©diaire et charger le code du pilote avec les param√®tres modifi√©s √† l'emplacement de d√©ploiement permanent, ou apporter ces modifications directement dans la zone de m√©moire dans laquelle le binaire a √©t√© charg√©, et la table des param√®tres pr√©sente dans le fichier est en m√©moire peut √† la fois charger et ne pas l'occuper (rappelez-vous des directives).  La d√©cision est responsable, elle n√©cessitera, comme la pr√©c√©dente, la pr√©sence d'une zone de communication pr√©d√©finie entre le module et ET pour stocker la description des param√®tres, mais elle r√©duit encore les exigences de m√©moire excessive dans le module.  Imm√©diatement, on note le principal inconv√©nient d'une telle solution - l'incapacit√© √† contr√¥ler les valeurs des param√®tres et leur coh√©rence, mais il n'y a rien √† faire.  C'est une solution tout √† fait normale, tr√®s probablement - 75%. <br><br>  Une variante de la troisi√®me solution - les informations sur les param√®tres ne sont pas stock√©es dans le module lui-m√™me, mais dans un fichier auxiliaire, il n'y a tout simplement pas de m√©moire exc√©dentaire dans le module.  En principe, la m√™me chose peut √™tre faite dans la version pr√©c√©dente, lorsque le module contient la partie de configuration, qui est utilis√©e ET pendant le processus de d√©marrage, mais n'est pas charg√©e dans la RAM contenant la partie ex√©cutable r√©elle du module.  Par rapport √† la version pr√©c√©dente, un fichier suppl√©mentaire a √©t√© ajout√© et il n'est pas clair pour quoi nous payons, mais peut-√™tre qu'ils ont fait des directives d'initialisation avant l'invention - 5%. <br><br>  Les 7% restants seront laiss√©s √† d'autres options que je n'ai pas pu trouver.  Eh bien, maintenant que notre fantaisie s'est √©puis√©e (la mienne √† coup s√ªr, s'il y a plus d'id√©es, veuillez demander dans le commentaire), nous allons commencer √† √©tudier la source de L. <br><br>  Pour commencer, je note que, apparemment, l'art de distribuer des textes sources dans des fichiers a √©t√© perdu avec le syst√®me d'exploitation, qui tient dans 16 ko, car la structure des r√©pertoires, leurs noms et noms de fichiers sont li√©s au contenu un peu plus que rien.  √âtant donn√© la pr√©sence d'inclusions int√©gr√©es, l'√©tude classique des sources t√©l√©charg√©es avec l'aide d'un √©diteur se transforme en une qu√™te √©trange et sera improductive.  Heureusement, il existe un charmant utilitaire Elixir, disponible en ligne, qui vous permet d'effectuer des recherches contextuelles, et avec lui, le processus devient beaucoup plus int√©ressant et fructueux.  J'ai effectu√© mes recherches compl√©mentaires sur le site elixir.bootlin.com.  Oui, ce site n'est pas une collection officielle de fromages √† noyau, contrairement √† kernel.org, mais esp√©rons que leur code source soit identique. <br><br>  Tout d'abord, regardons une macro pour d√©terminer les param√®tres - premi√®rement, nous connaissons son nom, et deuxi√®mement, cela devrait √™tre plus facile (ouais, maintenant).  Il se trouve dans le fichier moduleparam.h - c'est tout √† fait raisonnable, mais c'est une agr√©able surprise, compte tenu de ce que nous verrons plus tard.  Macro <br><br><pre><code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">0</span></span>}module_param(name,type,perm)</code> </pre> <br>  est un wrapper sur <br><br><pre> <code class="cpp hljs"> {<span class="hljs-number"><span class="hljs-number">0</span></span>a}module_param_named(n,n,t,p)</code> </pre> <br>  - sucre syntaxique pour le cas le plus courant.  Dans le m√™me temps, pour une raison quelconque, l'√©num√©ration des valeurs autoris√©es de l'un des param√®tres, √† savoir le type de la variable, est donn√©e dans les commentaires avant le texte de l'encapsuleur, et non dans la deuxi√®me macro, qui fait vraiment le travail et peut √™tre utilis√©e directement. <br><br>  La macro {0a} contient un appel √† trois macros <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">1</span></span>}param_check_#<span class="hljs-meta"><span class="hljs-meta">#t(n,&amp;v)</span></span></code> </pre> <br>  (il existe un ensemble de macros pour tous les types valides) <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">2</span></span>}module_param_cb(n,&amp;op##t,&amp;v,p)</code> </pre> <br>  et <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">3</span></span>}__MODULE_PARM_TYPE(n,t)</code> </pre> <br>  (faites attention aux noms, cependant, charme), et le premier d'entre eux est utilis√© ailleurs, c'est-√†-dire que les recommandations d'Occam et le principe KISS sont √©galement hardiment n√©glig√©s par les cr√©ateurs de A - apparemment, une sorte de travail pr√©paratoire pour l'avenir.  Bien s√ªr, ce ne sont que des macros, mais elles ne co√ªtent rien, mais quand m√™me ... <br><br>  La premi√®re des trois macros {1}, comme son nom l'indique, v√©rifie la correspondance des types de param√®tres et encapsule <br><br><pre> <code class="cpp hljs">__param_check(n,p,t)</code> </pre> <br>  Notez qu'√† la premi√®re √©tape de l'habillage, le niveau d'abstraction des macros diminue, et √† la seconde, il augmente probablement d'une mani√®re diff√©rente, et il me semble seulement que cela pourrait √™tre plus simple et plus logique, d'autant plus que la macro moyenne n'est utilis√©e nulle part ailleurs.  D'accord, mettons une autre fa√ßon de v√©rifier les param√®tres macro dans la tirelire et de continuer. <br><br>  Mais les deux macros suivantes g√©n√®rent en fait un √©l√©ment de la table des param√®tres.  Pourquoi ne demandez-vous pas deux, et pas un, j'ai depuis longtemps cess√© de comprendre la logique des cr√©ateurs de L. Tr√®s probablement, en fonction de la diff√©rence de style de ces deux macros, √† commencer par les noms, le second a √©t√© ajout√© plus tard pour √©tendre les fonctionnalit√©s et modifier la structure existante C'√©tait impossible, car au d√©part, ils regrettaient d'attribuer une place pour indiquer l'option des param√®tres.  La macro {2}, comme toujours, nous masque la macro <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">2</span></span>a}_module_param_call(MODULE_PARAM_PREFIX,n,ops,arg,p,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  (c'est dr√¥le que cette macro ne soit appel√©e directement nulle part sauf 8250_core.c, o√π elle est appel√©e avec les m√™mes param√®tres suppl√©mentaires), mais cette derni√®re produit d√©j√† le code source. <br><br>  Une petite remarque - pendant la recherche, nous nous assurons que la navigation de texte fonctionne bien, mais il y a deux circonstances d√©sagr√©ables: la recherche par le fragment de nom ne fonctionne pas (check_param_ n'a pas √©t√© trouv√©, bien que check_param_byte a √©t√© trouv√©) et la recherche ne fonctionne que sur les d√©clarations d'objets (la variable n'est pas trouv√©e, puis est trouv√© dans ce fichier par ctrF, mais la recherche int√©gr√©e par source n'est pas d√©tect√©e).  Pas tr√®s encourageant, car nous aurons peut-√™tre besoin de rechercher un objet en dehors du fichier courant, mais "au final, nous n'en avons pas d'autre". <br><br>  √Ä la suite du travail de {1} dans le texte du module compil√© en pr√©sence des deux lignes suivantes <br><br><pre> <code class="cpp hljs">module_param_named(name, c, byte, <span class="hljs-number"><span class="hljs-number">0x444</span></span>); module_param_named(name1, i, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-number"><span class="hljs-number">0x444</span></span>);</code> </pre> <br>  un fragment du type ci-dessous appara√Æt <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __param_str_name[] = <span class="hljs-string"><span class="hljs-string">"MODULE"</span></span> <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kernel_param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param_name</span></span></span><span class="hljs-class"> \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">used__</span></span></span><span class="hljs-class">)) \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unused</span></span></span><span class="hljs-class">,__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">section__</span></span></span><span class="hljs-class"> ("__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">"),</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)))) \ = {</span></span> __param_str_name, ((struct <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>), &amp;param_ops_byte, (<span class="hljs-number"><span class="hljs-number">0x444</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { &amp;c } }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __UNIQUE_ID_nametype72[] \ __attribute__((__used__)) __attribute__((section(<span class="hljs-string"><span class="hljs-string">".modinfo"</span></span>), unused, aligned(<span class="hljs-number"><span class="hljs-number">1</span></span>))) \ = <span class="hljs-string"><span class="hljs-string">"parmtype"</span></span> <span class="hljs-string"><span class="hljs-string">"="</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">"byte"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __param_str_name1[] = <span class="hljs-string"><span class="hljs-string">"MODULE"</span></span> <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-string"><span class="hljs-string">"name1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kernel_param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param_name1</span></span></span><span class="hljs-class"> \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">used__</span></span></span><span class="hljs-class">)) \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unused</span></span></span><span class="hljs-class">,__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">section__</span></span></span><span class="hljs-class"> ("__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">"),</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)))) \ = {</span></span> __param_str_name1, ((struct <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>), &amp;param_ops_int, (<span class="hljs-number"><span class="hljs-number">0x444</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { &amp;i } }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __UNIQUE_ID_name1type73[] __attribute__((__used__)) \ __attribute__((section(<span class="hljs-string"><span class="hljs-string">".modinfo"</span></span>), unused, aligned(<span class="hljs-number"><span class="hljs-number">1</span></span>))) \ = <span class="hljs-string"><span class="hljs-string">"parmtype"</span></span> <span class="hljs-string"><span class="hljs-string">"="</span></span> <span class="hljs-string"><span class="hljs-string">"name1"</span></span> <span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">"int"</span></span>;</code> </pre> <br>  (en fait, des fichiers sur une seule ligne y sont g√©n√©r√©s, je les ai divis√©s en lignes pour en faciliter l'examen) et nous pouvons imm√©diatement dire qu'il n'y a aucune allusion √† l'inclusion d'une section de programme d'analyse ou d'un module pour attribuer des valeurs aux param√®tres dans le texte source, donc les options 1 et 2 peuvent consid√©r√© comme exclu de tout examen ult√©rieur.  La pr√©sence d'attributs sp√©ciaux pour l'√©diteur de liens, pour ainsi dire, sugg√®re l'existence d'une r√©gion de communication situ√©e √† un endroit pr√©d√©termin√© √† travers lequel la description des param√®tres est transmise.  Dans le m√™me temps, nous constatons avec √©tonnement l'absence totale de toute description du bloc g√©n√©r√© de param√®tres possibles sous forme de texte qui pourrait √™tre utilis√© par le module analyseur.  Il est clair qu'un code bien √©crit est auto-document√©, mais pas dans la m√™me mesure que cela n'augmente pas la probabilit√© de l'option 1 ou 2, l'analyseur √©tant √©crit par le d√©veloppeur du module. <br><br>  La combinaison des attributs __used__ et inutilis√©s en m√™me temps semble dr√¥le dans la derni√®re ligne g√©n√©r√©e, surtout si vous regardez le prochain fragment de code de macro <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> GCC_VERSION &lt; 30300 # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __used __attribute__((__unused__)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __used __attribute__((__used__)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Quel est le genre d'agilit√© que les d√©veloppeurs de A fument, la mani√®re douloureusement tortueuse de leurs pens√©es incarn√©e dans le code.  Je sais que vous pouvez utiliser les deux formes d'√©criture d'attributs, mais pourquoi le faire sur la m√™me ligne - je ne comprends pas. <br><br>  On peut noter une autre caract√©ristique int√©ressante du code r√©sultant - la duplication d'informations sur le nom de la variable et son type.  On ne sait pas encore pourquoi cela a √©t√© fait, mais le fait lui-m√™me ne fait aucun doute.  Bien s√ªr, ces informations sont coh√©rentes, car elles sont construites en mode automatique, et cette coh√©rence sera pr√©serv√©e lorsque le texte source change (et c'est bien), mais il est dupliqu√© (et c'est mauvais), peut-√™tre plus tard nous comprendrons la n√©cessit√© d'une telle solution.  De plus, la n√©cessit√© de former un nom unique en utilisant le num√©ro de ligne du code source reste incertaine, car la premi√®re ligne g√©n√©r√©e s'en est sortie. <br><br>  Une autre note - comprendre exactement ce que la d√©finition du param√®tre se transforme n'√©tait pas une t√¢che compl√®tement triviale, mais gr√¢ce √† MinGW, elle √©tait toujours termin√©e.  Sous le capot, il y avait une stringification et un double collage des param√®tres, la formation de noms uniques, ainsi que d'autres astuces d√©licates de travail avec les macros, mais je ne pr√©sente que les r√©sultats.  R√©sumant le r√©sultat interm√©diaire, je peux dire que l'√©tude des macros A n'est pas ce dont je voudrais gagner ma vie, c'est seulement possible comme divertissement, mais nous continuons. <br><br>  Nous ne ferons pas avancer la compr√©hension des macros pour comprendre la t√¢che, nous nous tournons donc vers le code source de l'utilitaire And et essayons de comprendre ce qu'il fait. <br><br>  Tout d'abord, nous sommes √©tonn√©s de voir que les fromages requis ne sont pas inclus dans les sources du noyau.  Oui, je suis pr√™t √† admettre que le I est un utilitaire et interagit avec le noyau via le point d'entr√©e pour charger le module, mais tout livre sur les pilotes L nous parle de cet utilitaire, donc l'absence d'une version ¬´officielle¬ª de sa source quelque part pr√®s de la source du noyau provoque me mal compris.  Bon, d'accord, Google ne nous a pas laiss√© tomber, et nous avons quand m√™me pris le fromage. <br><br>  La deuxi√®me chose √©tonnante est que cet utilitaire est form√© √† partir d'un package dont le nom n'est en aucun cas associ√© √† son nom, il existe plus d'un de ces packages, et chacun est nomm√© √† sa mani√®re √† diff√©rents endroits - pour le moins dr√¥le.  Si vous avez install√© L, alors avec la commande - vous pouvez d√©couvrir √† partir de quel package l'utilitaire I est construit, puis le rechercher, mais si nous effectuons des recherches th√©oriques (personnellement, je ne garde pas L sur mon ordinateur personnel pour plusieurs raisons, dont certaines que je J'ai √©nonc√© mes posts, un tel boxeur th√©orique), alors cette m√©thode ne nous est pas accessible et il ne reste qu'une recherche sur Internet, heureusement, elle donne des r√©sultats. <br><br>  Eh bien, la troisi√®me chose √©tonnante est que le nom de l'utilitaire lui-m√™me n'appara√Æt nulle part dans le code source, il n'est pas utilis√© dans les noms de fichiers et se trouve uniquement dans le fichier make, je sais qu'en C, nous sommes oblig√©s de nommer la fonction principale principale, et cela n'est pas discut√© (je ne suis pas personnellement Je m'en r√©jouis, puisque Pascal est g√¢t√©, mais ils ne m'ont pas demand√© mon avis lors de la conception du langage), mais au moins il serait possible d'√©crire le nom externe de l'utilitaire dans les commentaires.  Remarque n√©cessaire - beaucoup de choses dans le langage C ont √©t√© faites sur le principe "c'est tellement habituel avec nous", il √©tait probablement difficile de rendre les choses diff√©rentes parfois, voire impossibles, mais que pouvez-vous faire maintenant, en faisant glisser une valise sans poign√©e plus loin. <br><br>  Nous trouvons deux paquets contenant le texte source. Et, nous trouvons √©galement les fromages sur github, nous voyons qu'ils sont identiques et nous croyons que c'est √† cela que ressemble le code source de l'utilitaire.  Ensuite, nous √©tudions uniquement le fichier sur git, d'autant plus qu'il s'appelle ici insmod.c, et que pour commencer, il convertit la liste des param√®tres en une longue cha√Æne termin√©e par un caract√®re nul, dans laquelle les √©l√©ments individuels sont s√©par√©s par des espaces.  Ensuite, il appelle deux fonctions, dont la premi√®re s'appelle grub_file et ouvre √©videmment le binaire, tandis que la seconde a le nom init_module et prend un pointeur vers le fichier ouvert avec le module binaire et une cha√Æne de param√®tres et s'appelle load_module, ce qui sugg√®re le but de cette fonction comme chargement avec modification des param√®tres. <br><br>  Nous passons au texte de la deuxi√®me fonction, qui se trouve dans le fichier ... et voici une d√©ception - pas dans aucun des fichiers du d√©p√¥t √©tudi√© sur le Geet (eh bien, c'est juste logique, cela fait partie du noyau et sa place n'est pas ici) ce n'est pas le cas.  Google √† nouveau press√© d'aider et nous renvoie aux fromages en grains sous Elixir et au fichier module.c.  Il convient de noter que, de mani√®re surprenante, le nom du fichier contenant les fonctions de travail avec les modules semble logique, je ne comprends m√™me pas comment l'expliquer, cela est probablement arriv√© par accident. <br><br>  Maintenant, il est devenu clair pour nous le manque de texte Et √† c√¥t√© du noyau - il ne fait pratiquement rien, il transf√®re uniquement les param√®tres d'une forme √† une autre et transf√®re le contr√¥le au noyau lui-m√™me, il est donc m√™me indigne de se trouver √† c√¥t√© de lui.  √Ä partir de ce moment, il devient clair qu'il n'y a pas d'informations externes claires sur la structure des param√®tres, car le noyau les a ignor√©s dans ses propres macros et sait tout √† leur sujet parfaitement, et les autres n'ont besoin de rien savoir de la structure interne (√† la lumi√®re du fait que la source sont disponibles pour consultation, quelques commentaires ne feraient pas de mal, mais en principe c'est vraiment de plus en plus clair m√™me sans eux), mais jusqu'√† pr√©sent, il n'a presque jamais mis en lumi√®re la mise en ≈ìuvre du m√©canisme d'ex√©cution lui-m√™me. <br><br>  Remarque - concernant le transfert de contr√¥le vers le noyau, je suis un peu excit√©, car pour l'instant nous voyons l'utilisation de la fonction dans la source du noyau, si la partie binaire sera li√©e au module, ou si elle se trouve dans l'image du noyau elle-m√™me, est encore inconnue.  Le fait que le point d'entr√©e vers le traitement de cette fonction soit encadr√© de mani√®re particuli√®re, via SYSCALL_DEFINE3, t√©moigne indirectement en faveur de la deuxi√®me option, mais j'ai longtemps compris que mes id√©es sur le logique et l'illogique, l'acceptable et l'inacceptable, ainsi que le admissible et l'inacceptable, sont tr√®s significatives s'√©carter de ceux des d√©veloppeurs de L. <br><br>  Remarque - un caillou de plus dans le jardin de recherche int√©gr√© - lors de la recherche d'une d√©finition pour cette macro, j'ai vu de nombreux endroits pour l'utiliser en tant que fonction, parmi lesquels la d√©finition m√™me de celle-ci en tant que macro s'est cach√©e tr√®s modestement. <br><br>  Par exemple, je ne comprends pas pourquoi un utilitaire externe est n√©cessaire pour traduire les param√®tres du formulaire standard pour le syst√®me d'exploitation (agrc, argv) sous la forme d'une cha√Æne termin√©e par un z√©ro avec des espaces comme s√©parateurs, qui est ensuite trait√©e par le module syst√®me - cette approche d√©passe quelque peu la mienne capacit√©s cognitives.  Surtout, √©tant donn√© que l'utilisateur entre une cha√Æne de param√®tres sous la forme d'une cha√Æne termin√©e par un z√©ro avec des espaces comme s√©parateurs, et l'utilitaire dans le noyau la convertit en une forme (argc, argv).  Rappelle fortement la vieille plaisanterie "Nous retirons la bouilloire du po√™le, en versons de l'eau et obtenons un probl√®me dont la solution est d√©j√† connue."  Et puisque j'essaie d'adh√©rer au principe ¬´Ne consid√©rez pas votre interlocuteur plus stupide que vous, jusqu'√† ce qu'il prouve le contraire.  Et m√™me apr√®s cela, vous pouvez vous tromper ¬ª, et en ce qui concerne les d√©veloppeurs de A, la premi√®re phrase est d√©finitivement valable, cela signifie que je me m√©prends sur quelque chose, mais je n'y suis pas habitu√©.  Si quelqu'un peut offrir une explication raisonnable du fait d√©clar√© de la double conversion, alors je demande dans le commentaire.  Mais nous continuons l'enqu√™te. <br><br>  Les perspectives de mise en ≈ìuvre des options 1 et 2 deviennent ¬´tr√®s faiblement visibles¬ª (un charmant libell√© d'un article r√©cent sur les perspectives de d√©veloppement d'ADC domestiques √† haut d√©bit), car il serait tr√®s √©trange de charger un module en m√©moire √† l'aide de la fonction noyau, puis de lui passer le contr√¥le pour impl√©menter le noyau fonction int√©gr√©e dans son corps.  Et pour s√ªr, dans le texte de la fonction load_module, nous trouvons assez rapidement l'appel parse_args - il semble que nous soyons sur la bonne voie.  Ensuite, nous passons rapidement en revue la cha√Æne d'appels (comme toujours, nous verrons les fonctions wrapper et les macros wrapper, mais nous sommes d√©j√† habitu√©s √† fermer les yeux sur ces farces si mignonnes des d√©veloppeurs) et nous trouvons la fonction parse_one, qui place le param√®tre requis au bon endroit. <br><br>  Notez qu'il n'y a pas de contr√¥le sur la validit√© des param√®tres, comme on pourrait s'y attendre, car le noyau, contrairement au module lui-m√™me, ne sait rien de leur fonction.  Il y a des v√©rifications de syntaxe et le nombre d'√©l√©ments dans le tableau (oui, il peut y avoir un tableau d'entiers comme param√®tre) et lorsque des erreurs de ce type sont d√©tect√©es, le chargement du module s'arr√™te, mais rien de plus.  Cependant, tout n'est pas perdu, car apr√®s le chargement, le contr√¥le est transf√©r√© √† la fonction init_module, qui peut effectuer la validation n√©cessaire des param√®tres d√©finis et, si la <s>sauvegarde est</s> n√©cessaire, mettre fin au processus de d√©marrage. <br><br>  Cependant, nous avons compl√®tement ignor√© la question de savoir comment les fonctions d'analyse acc√®dent √† un tableau d'√©chantillons de param√®tres, car sans cela, l'analyse est quelque peu difficile.  Un rapide coup d'≈ìil au code montre qu'un hack sale a √©t√© appliqu√©, une astuce √©vidente - dans le fichier binaire, la fonction find_module_sections recherche la section nomm√©e __param, divise sa taille par la taille de l'enregistrement (fait beaucoup plus) et renvoie les donn√©es n√©cessaires via la structure.  Je mettrais toujours les lettres p devant les noms des param√®tres de cette fonction, mais c'est une question de go√ªt. <br><br>  Tout semble √™tre clair et compr√©hensible, la seule chose qui inqui√®te est le manque de l'attribut __initdata sur les donn√©es g√©n√©r√©es, peut-il vraiment rester en m√©moire apr√®s l'initialisation, cet attribut est probablement d√©crit quelque part dans la partie g√©n√©rale, par exemple, dans les donn√©es de l'√©diteur de liens, pour √™tre honn√™te , paresseux √† regarder, voir l'√©pigraphe. <br><br>  En r√©sum√© - le week-end a √©t√© utile, il √©tait int√©ressant de comprendre le code source de L, de se souvenir de quelque chose et d'apprendre quelque chose, mais la connaissance n'est jamais superflue. <br>  Eh bien, dans mes hypoth√®ses, je n'ai pas devin√©, dans L, une option a √©t√© mise en ≈ìuvre qui s'est av√©r√©e √™tre dans les 7% restants, mais ce n'√©tait douloureusement pas √©vident. <br><br>  Eh bien, en conclusion, le cri de Yaroslavna (comment peut-on s'en passer) pourquoi dois-je chercher les informations n√©cessaires (je ne parle pas de la cuisine interne, mais de la pr√©sentation externe) de diverses sources qui n'ont pas de statut officiel, o√π un document similaire au livre <br>  ¬´Logiciel d'un ordinateur.  Syst√®me d'exploitation fonctionnel. <br>  RAFOS.  Guide du programmeur syst√®me. ", Ou ne le font-ils plus? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431860/">https://habr.com/ru/post/fr431860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431848/index.html">Comme j'ai √©crit le plus gros script pour Altium Designer</a></li>
<li><a href="../fr431850/index.html">Heisenbug 2018 Moscou: diffusion en ligne gratuite, f√™te et bien plus encore</a></li>
<li><a href="../fr431854/index.html">Coh√©rence des donn√©es dans les syst√®mes fortement charg√©s</a></li>
<li><a href="../fr431856/index.html">Extension de l'√©diteur Unity avec la fen√™tre de l'√©diteur, l'objet scriptable et l'√©diteur personnalis√©</a></li>
<li><a href="../fr431858/index.html">Mitap Sbertekh √† Rostov-sur-le-Don</a></li>
<li><a href="../fr431862/index.html">Mitap Sbertekh √† Iekaterinbourg</a></li>
<li><a href="../fr431864/index.html">PVS-Studio ROI: comment ne pas perdre des millions (version provisoire de l'article)</a></li>
<li><a href="../fr431866/index.html">Id√©es fausses des programmeurs sur les noms - avec des exemples</a></li>
<li><a href="../fr431868/index.html">Heures sur les lampes √† d√©charge (GRI), ce sont des horloges Nixie</a></li>
<li><a href="../fr431870/index.html">Un d√©veloppeur de livres interactifs avec LED se plaint du vol d'id√©es par les employ√©s de Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>