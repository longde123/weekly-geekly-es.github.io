<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯЪ╢ ЁЯПК ЁЯзУ рджреЛрд╕реНрддреЛрдВ PyTorch рдФрд░ C ++ рдХреИрд╕реЗ рдмрдирд╛рдпреЗред рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ ЁЯШ▓ ЁЯСЗЁЯП╜ ЁЯМЮ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд▓рдЧрднрдЧ рдПрдХ рд╕рд╛рд▓ рдкрд╣рд▓реЗ, PyTorch Developers рдиреЗ TorchScript рд╕рдореБрджрд╛рдп рдХреЛ рдкреЗрд╢ рдХрд┐рдпрд╛ рдерд╛, рдЬреЛ рдПрдХ рдЯреВрд▓ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЕрдЬрдЧрд░ рдореЗрдВ рдкрд╛рдЗрдк рд▓рд╛рдЗрди рд╕реЗ рдПрд▓реНрдпреБрдорд┐рдирд┐рдпрдо рдХреЗ рд╣рд▓ рдХреЛ рджреЛ рдорд╛рдЙрд╕ рдХреНрд▓...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рджреЛрд╕реНрддреЛрдВ PyTorch рдФрд░ C ++ рдХреИрд╕реЗ рдмрдирд╛рдпреЗред рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ods/blog/480328/"><p> рд▓рдЧрднрдЧ рдПрдХ рд╕рд╛рд▓ рдкрд╣рд▓реЗ, PyTorch Developers рдиреЗ <strong>TorchScript</strong> рд╕рдореБрджрд╛рдп рдХреЛ рдкреЗрд╢ рдХрд┐рдпрд╛ рдерд╛, рдЬреЛ рдПрдХ рдЯреВрд▓ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЕрдЬрдЧрд░ рдореЗрдВ рдкрд╛рдЗрдк рд▓рд╛рдЗрди рд╕реЗ рдПрд▓реНрдпреБрдорд┐рдирд┐рдпрдо рдХреЗ рд╣рд▓ рдХреЛ рджреЛ рдорд╛рдЙрд╕ рдХреНрд▓рд┐рдХ рдХреЗ рд╕рд╛рде рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ C ++ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдиреАрдЪреЗ рдореИрдВ рдЗрд╕рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рдЕрдиреБрднрд╡ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реВрдВ рдФрд░ рдЗрд╕ рдорд╛рд░реНрдЧ рдкрд░ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдиреБрдХрд╕рд╛рди рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реВрдВред  рдореИрдВ рд╡рд┐рдВрдбреЛрдЬ рдкрд░ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкрд░ рд╡рд┐рд╢реЗрд╖ рдзреНрдпрд╛рди рджреВрдВрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ рд╣рд╛рд▓рд╛рдВрдХрд┐ рдПрдордПрд▓ рдореЗрдВ рд╢реЛрдз рдЖрдорддреМрд░ рдкрд░ рдЙрдмрдВрдЯреВ рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЕрдВрддрд┐рдо рд╕рдорд╛рдзрд╛рди рдЕрдХреНрд╕рд░ (рдЕрдЪрд╛рдирдХ!) "рд╡рд┐рдВрдбреЛрдЬрд╝" рдХреЗ рддрд╣рдд рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддрд╛ рд╣реИред </p><br><p>  рдореЙрдбрд▓ рдХреЗ рдирд┐рд░реНрдпрд╛рдд рдХреЗ рд▓рд┐рдП рдирдореВрдирд╛ рдХреЛрдб рдФрд░ рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ C ++ рдкреНрд░реЛрдЬреЗрдХреНрдЯ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial">GitHub рдкрд░ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА</a> рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial">рд╣реИ</a> ред </p><br><p> <a href="https://habr.com/ru/company/ods/blog/480328/"><img src="https://habrastorage.org/webt/3k/u1/ub/3ku1ubmzigl3j016ezncczdonqm.jpeg"></a> </p><a name="habracut"></a><br><a name="continue"></a><br><p>  PyTorch Developers рдХреЛ рдмреЗрд╡рдХреВрдл рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдирдпрд╛ рдЯреВрд▓ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрдкрдХреЛ PyTorch рдореЗрдВ рдПрдХ рд╢реЛрдз рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рдХреБрдЫ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕реЛрдВ рдореЗрдВ C ++ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдПрдореНрдмреЗрдбреЗрдб рдХреЛрдб рдореЗрдВ рдФрд░ рдХреБрдЫ рдХреМрд╢рд▓ рдХреЗ рд╕рд╛рде рддреЗрдЬреА рд╕реЗ рдЪрд╛рд▓реВ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред </p><br><p>  TorchScript PyTorch рд╕рдВрд╕реНрдХрд░рдг 1.0 рдореЗрдВ рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ рдФрд░ рдЗрд╕рдХрд╛ рд╡рд┐рдХрд╛рд╕ рдФрд░ рдкрд░рд┐рд╡рд░реНрддрди рдЬрд╛рд░реА рд╣реИред  рдпрджрд┐ рдПрдХ рд╕рд╛рд▓ рдкрд╣рд▓реЗ рдкрд╣рд▓рд╛ рд╕рдВрд╕реНрдХрд░рдг рдмрдЧ рд╕реЗ рднрд░рд╛ рд╣реБрдЖ рдерд╛ рдФрд░ рдЕрдзрд┐рдХ рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рдерд╛, рддреЛ рд╡рд░реНрддрдорд╛рди рд╕рдВрд╕реНрдХрд░рдг 1.3 рдХрдо рд╕реЗ рдХрдо рджреВрд╕рд░реЗ рдмрд┐рдВрджреБ рдкрд░ рдмрд┐рд▓реНрдХреБрд▓ рдЕрд▓рдЧ рд╣реИ: рдЖрдк рдЗрд╕реЗ рдЕрдм рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рдирд╣реАрдВ рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдХрд╛рдлреА рдЙрдкрдпреБрдХреНрдд рд╣реИред  рдореИрдВ рдЙрд╕ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реВрдВрдЧрд╛ред </p><br><p>  TorchScript рдХреЗ рджрд┐рд▓ рдореЗрдВ рдкрд╛рдпрдерди рдЬреИрд╕реА рднрд╛рд╖рд╛ рдХрд╛ рдЕрдкрдирд╛ рд╕реНрдЯреИрдВрдбрдЕрд▓реЛрди (рдкрд╛рдпрдерди-рдлреНрд░реА) рдХрдВрдкрд╛рдЗрд▓рд░ рд╣реИ, рд╕рд╛рде рд╣реА рдЗрд╕рдореЗрдВ рдкрд╛рдпрдерди рдФрд░ PyTorch рдореЗрдВ рд▓рд┐рдЦреЗ рдЧрдП рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреВрд▓ рд╣реИрдВ, рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдореЙрдбреНрдпреВрд▓ рдХреЛ рдмрдЪрд╛рдиреЗ рдФрд░ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдФрд░ C ++ рдореЗрдВ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╣реИред  рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ CPU рдХреЗ рд▓рд┐рдП CPU рдФрд░ 300MB рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рдЧрднрдЧ 70MB (рд╡рд┐рдВрдбреЛрдЬ рдХреЗ рд▓рд┐рдП) рдХреЗ рдХреБрд▓ рд╡рдЬрди рдХреЗ рд╕рд╛рде рдХрдИ DLL рдЬреЛрдбрд╝рдиреЗ рд╣реЛрдВрдЧреЗред  рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЕрдзрд┐рдХрд╛рдВрд╢ PyTorch рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдФрд░ рдкрд╛рдпрдерди рднрд╛рд╖рд╛ рдХреА рдореБрдЦреНрдп рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ, рдЬреИрд╕реЗ рдХрд┐ OpenCV рдпрд╛ NumPy, рдХреЛ рднреВрд▓рдирд╛ рд╣реЛрдЧрд╛ред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, NumPy рдХреЗ рдХрдИ рдХрд╛рд░реНрдпреЛрдВ рдореЗрдВ PyTorch рдореЗрдВ рдПрдХ рдПрдирд╛рд▓реЙрдЧ рд╣реИред </p><br><h2 id="konvertiruem-payplayn-na-pytorch-model-na-torchscript">  рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд░ рдкрд╛рдЗрд░реЙрдЪ рдореЙрдбрд▓ рдореЗрдВ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрдиреНрд╡рд░реНрдЯ рдХрд░реЗрдВ </h2><br><p>  рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛рдпрдерди рдХреЛрдб рдХреЛ рдЕрдкрдиреЗ рдЖрдВрддрд░рд┐рдХ рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рджреЛ рддрд░реАрдХреЗ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ: рдЕрдиреБрд░реЗрдЦрдг рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ (рдЕрдиреБрд░реЗрдЦрдг рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ)ред  рджреЛ рдХреНрдпреЛрдВ?  рдирд╣реАрдВ, рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ, рдЬрд╝рд╛рд╣рд┐рд░ рд╣реИ, рдХрд┐ рджреЛ рдПрдХ рд╕реЗ рдмреЗрд╣рддрд░ рд╣реИрдВ ... </p><br><p><img src="https://habrastorage.org/webt/lh/xp/ww/lhxpwwynynljq2_sxj35jhpp9yc.jpeg"></p><br><p>  рд▓реЗрдХрд┐рди рдЗрди рддрд░реАрдХреЛрдВ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдкреНрд░рд╕рд┐рджреНрдз рдХрд╛рдореЛрджреНрджреАрдкрдХ рдореЗрдВ, рдмрд╛рдПрдВ рдФрд░ рджрд╛рдПрдВ рд╡рд┐рдЪрд▓рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ: рджреЛрдиреЛрдВ рдмрджрддрд░ рд╣реИрдВред  рдЦреИрд░, рджреБрдирд┐рдпрд╛ рдПрдХрджрдо рд╕рд╣реА рдирд╣реАрдВ рд╣реИред  рдмрд╕ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рдЖрдкрдХреЛ рдЙрд╕ рдПрдХ рдХреЛ рдЪреБрдирдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рдЕрдзрд┐рдХ рдЙрдкрдпреБрдХреНрдд рд╣реИред </p><br><p>  рдЕрдиреБрд░реЗрдЦрдг рд╡рд┐рдзрд┐ рдмрд╣реБрдд рд╕рд░рд▓ рд╣реИред  рдбреЗрдЯрд╛ рдХрд╛ рдПрдХ рдирдореВрдирд╛ рд▓рд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЖрдорддреМрд░ рдкрд░ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╕рдВрдЦреНрдпрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдЖрд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ), рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдпрд╛ рд╡рд░реНрдЧ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рд╣рдореЗрдВ рд░реБрдЪрд┐ рджреЗрддрд╛ рд╣реИ, рдФрд░ PyTorch рдирд┐рд░реНрдорд╛рдг рдЧреНрд░рд╛рдл рдХреЛ рдЙрд╕реА рддрд░рд╣ рд╕реЗ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдЖрдорддреМрд░ рдкрд░ рдПрдХ рддрдВрддреНрд░рд┐рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рддреЗ рд╕рдордп рд╣реЛрддрд╛ рд╣реИред  рд╡реЛрдЗрд▓рд╛ - рд╕реНрдХреНрд░рд┐рдкреНрдЯ рддреИрдпрд╛рд░ рд╣реИ: </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torchvision model = torchvision.models.resnet34(pretrained = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) model.eval() sample = torch.rand(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>) scripted_model = torch.jit.trace(model, sample)</code> </pre> <br><p>  рдКрдкрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЙрджрд╛рд╣рд░рдг ScriptModule рд╡рд░реНрдЧ рдХрд╛ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рддрд╛ рд╣реИред  рдЗрд╕реЗ рдмрдЪрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ </p><br><pre> <code class="python hljs">scripted_model.save(<span class="hljs-string"><span class="hljs-string">'my_script.pth'</span></span>)</code> </pre> <br><p>  рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдореВрд▓ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рдмрдЬрд╛рдп <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">C ++ рдкреНрд░реЛрдЧреНрд░рд╛рдо</a> (рдЙрд╕ рдкрд░ рдЕрдзрд┐рдХ) рдпрд╛ рдкрд╛рдпрдерди рдХреЛрдб <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">рдореЗрдВ</a> рд▓реЛрдб рдХрд░реЗрдВ: </p><br><div class="spoiler">  <b class="spoiler_title">рд╕рд╣реЗрдЬреЗ рдЧрдП рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдореВрдирд╛ рдкрд╛рдпрдерди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> torchvision.transforms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Compose, ToTensor, Normalize transforms = Compose([ToTensor(), Normalize(mean=[<span class="hljs-number"><span class="hljs-number">0.485</span></span>, <span class="hljs-number"><span class="hljs-number">0.456</span></span>, <span class="hljs-number"><span class="hljs-number">0.406</span></span>], std=[<span class="hljs-number"><span class="hljs-number">0.229</span></span>, <span class="hljs-number"><span class="hljs-number">0.224</span></span>, <span class="hljs-number"><span class="hljs-number">0.225</span></span>])]) img = cv2.resize(cv2.imread(<span class="hljs-string"><span class="hljs-string">'pics/cat.jpg'</span></span>), (<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>)) img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) x = transforms(img).unsqueeze(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># add batch dimension scripted_model = torch.jit.load('my_script.pth') y = scripted_model(x) print(y[0].argmax(), y[0][y[0].argmax()])</span></span></code> </pre> <br><pre> <code class="plaintext hljs">tensor(282) tensor(12.8130, grad_fn=&lt;SelectBackward&gt;)</code> </pre> </div></div><br><p>  рдкрд░рд┐рдгрд╛рдореА <code>ScriptModule</code> рдХрд╣реАрдВ рднреА рджрд┐рдЦрд╛рдИ рджреЗ рд╕рдХрддреА рд╣реИред </p><br><p>  рд╡рд░реНрдгрд┐рдд рддрд░реАрдХреЗ рд╕реЗ, рдЖрдк <code>nn.Module</code> рд╡рд░реНрдЧ рдФрд░ рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ (рдмрд╛рдж рд╡рд╛рд▓реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, <code>torch._C.Function</code> рдХреНрд▓рд╛рд╕ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг <code>torch._C.Function</code> )ред </p><br><p>  рдЗрд╕ рдкрджреНрдзрддрд┐ (рдЕрдиреБрд░реЗрдЦрдг) рдХрд╛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд▓рд╛рдн рд╣реИ: рдЗрд╕ рддрд░рд╣ рдЖрдк рд▓рдЧрднрдЧ рдХрд┐рд╕реА рднреА рдкрд╛рдпрдерди рдХреЛрдб рдХреЛ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдмрд╛рд╣рд░реА рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдПрдХ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рджреЛрд╖ рд╣реИ: рдХрд┐рд╕реА рднреА рд╢рд╛рдЦрд╛ рдХреЗ рд▓рд┐рдП, рдХреЗрд╡рд▓ рдЙрд╕ рд╢рд╛рдЦрд╛ рдХреЛ рдЬрд┐рд╕реЗ рдкрд░реАрдХреНрд╖рдг рдбреЗрдЯрд╛ рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЙрд╕реЗ рдпрд╛рдж рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -x my_abs_traced = torch.jit.trace(my_abs, torch.tensor(<span class="hljs-number"><span class="hljs-number">0</span></span>)) print(my_abs_traced(torch.tensor(<span class="hljs-number"><span class="hljs-number">1</span></span>)), my_abs_traced(torch.tensor(<span class="hljs-number"><span class="hljs-number">-1</span></span>)))</code> </pre> <br><pre> <code class="plaintext hljs">c:\miniconda3\lib\site-packages\ipykernel_launcher.py:2: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs! tensor(1) tensor(-1)</code> </pre> <br><p>  рдКрдкреНрд╕!  рдпрд╣ рд╡рд╣реА рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рд╣рдо рдЪрд╛рд╣реЗрдВрдЧреЗ, рд╣реИ рдирд╛?  рдпрд╣ рдЕрдЪреНрдЫрд╛ рд╣реИ рдХрд┐ рдХрдо рд╕реЗ рдХрдо рдПрдХ рдЪреЗрддрд╛рд╡рдиреА рд╕рдВрджреЗрд╢ (TracerWarning) рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдРрд╕реЗ рд╕рдВрджреЗрд╢реЛрдВ рдкрд░ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИред </p><br><p>  рдпрд╣рд╛рдБ рджреВрд╕рд░реА рд╡рд┐рдзрд┐ рд╣рдорд╛рд░реА рд╕рд╣рд╛рдпрддрд╛ рдХреЗ рд▓рд┐рдП рдЖрддреА рд╣реИ - рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ: </p><br><pre> <code class="python hljs">my_abs_script = torch.jit.script(my_abs) print(my_abs_script(torch.tensor(<span class="hljs-number"><span class="hljs-number">1</span></span>)), my_abs_script(torch.tensor(<span class="hljs-number"><span class="hljs-number">-1</span></span>)))</code> </pre> <br><pre> <code class="plaintext hljs">tensor(1) tensor(1)</code> </pre> <br><p>  рд╣реБрд░реНрд░реЗ, рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ!  рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдкреБрдирд░рд╛рд╡рд░реНрддреА рд░реВрдк рд╕реЗ рдкрд╛рдпрдерди рдХреЛрдб рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддреА рд╣реИ рдФрд░ рдЗрд╕реЗ рдЕрдкрдиреА рднрд╛рд╖рд╛ рдореЗрдВ рдХреЛрдб рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рддреА рд╣реИред  рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ, рд╣рдореЗрдВ <code>ScriptModule</code> рдХреНрд▓рд╛рд╕ (рдореЙрдбреНрдпреВрд▓реНрд╕ рдХреЗ рд▓рд┐рдП) рдпрд╛ <code>torch._C.Function</code> (рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рд▓рд┐рдП) рднреА <code>torch._C.Function</code> ред  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ, рдпрд╣рд╛рдБ рдпрд╣ рд╣реИ, рдЦреБрд╢реА!  рд▓реЗрдХрд┐рди рдПрдХ рдФрд░ рд╕рдорд╕реНрдпрд╛ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ: рдЯреЙрд░реНрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЖрдВрддрд░рд┐рдХ рднрд╛рд╖рд╛ рдкрд╛рдЗрдерди рдХреЗ рд╡рд┐рдкрд░реАрдд, рджреГрдврд╝рддрд╛ рд╕реЗ рдЯрд╛рдЗрдк рдХреА рдЬрд╛рддреА рд╣реИред  рдкреНрд░рддреНрдпреЗрдХ рдЪрд░ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдкрд╣рд▓реЗ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рддрд░реНрдХ рдХрд╛ рдкреНрд░рдХрд╛рд░ <code>Tensor</code> ред  рдЗрд╕рд▓рд┐рдП, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдкрд░рд┐рдЪрд┐рдд рдкреИрдЯрд░реНрди </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> y = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: y = x <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y my_func = torch.jit.script(my_func)</code> </pre> <br><p>  рдЯреНрд░реЗрд╕рд┐рдВрдЧ рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдЧреАред </p><br><div class="spoiler">  <b class="spoiler_title">рдПрдХ рдЯреНрд░реЗрд╕ рддреНрд░реБрдЯрд┐ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рд╣реИ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">RuntimeError Traceback (most recent call last) &lt;ipython-input-9-25414183a687&gt; in &lt;module&gt;() ----&gt; 1 my_func = torch.jit.script(my_func) d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb) 1224 if _rcb is None: 1225 _rcb = _gen_rcb(obj, _frames_up) -&gt; 1226 fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj)) 1227 # Forward docstrings 1228 fn.__doc__ = obj.__doc__ RuntimeError: Variable 'y' previously has type None but is now being assigned to a value of type Tensor : at &lt;ipython-input-8-75677614fca6&gt;:4:8 def my_func(x): y = None if x.max() &gt; 0: y = x ~ &lt;--- HERE return y</code> </pre> </div></div><br><p>  рдпрд╣ рдЙрд▓реНрд▓реЗрдЦрдиреАрдп рд╣реИ рдХрд┐ рд╣рд╛рд▓рд╛рдВрдХрд┐ рдПрдХ рддреНрд░реБрдЯрд┐ рддрдм рд╣реЛрддреА рд╣реИ рдЬрдм <code>torch.jit.script</code> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛрдб рдореЗрдВ рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдмрдирддрд╛ рд╣реИ рд╡рд╣ рднреА рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><p>  рд╕реНрдерд┐рд░рд╛рдВрдХ рдХреА рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рдиреЗ рдХреЗ рдмрд╛рдж рднреА рдЕрдВрдХ: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: y = <span class="hljs-number"><span class="hljs-number">1.25</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y my_func = torch.jit.script(my_func)</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">рдХреЛрдИ рддреНрд░реБрдЯрд┐ рджреЗрдЧрд╛</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">RuntimeError Traceback (most recent call last) &lt;ipython-input-10-0a5f18586763&gt; in &lt;module&gt;() 5 y = 0 6 return y ----&gt; 7 my_func = torch.jit.script(my_func) d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb) 1224 if _rcb is None: 1225 _rcb = _gen_rcb(obj, _frames_up) -&gt; 1226 fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj)) 1227 # Forward docstrings 1228 fn.__doc__ = obj.__doc__ d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in _rcb(name) 1240 # closure rcb fails 1241 result = closure_rcb(name) -&gt; 1242 if result: 1243 return result 1244 return stack_rcb(name) RuntimeError: bool value of Tensor with more than one value is ambiguous</code> </pre> </div></div><br><p>  рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ <code>0</code> рд▓рд┐рдЦрдирд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди <code>0.</code> рддрд╛рдХрд┐ рджреЛрдиреЛрдВ рд╢рд╛рдЦрд╛рдУрдВ рдореЗрдВ рдкреНрд░рдХрд╛рд░ рд╕рдорд╛рди рд╣реЛ!  рдлреБрдард░рдорд▓рд╕рд╛, рддреБрдореНрд╣реЗрдВ рдкрддрд╛ рд╣реИ, рдЕрдкрдиреЗ рдЕрдЬрдЧрд░ рдХреЗ рд╕рд╛рде! </p><br><p>  рдпрд╣ рдХреЗрд╡рд▓ рдЙрди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рд╕реВрдЪреА рдХреА рд╢реБрд░реБрдЖрдд рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЛ рдЕрдЬрдЧрд░ рдХреЛрдб рдореЗрдВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрд╕реЗ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЙрдбреНрдпреВрд▓ рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред  рдореИрдВ рд╕рдмрд╕реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдорд╛рдорд▓реЛрдВ рдХреЛ <a href="https://habr.com/ru/company/ods/blog/480328/">рдмрд╛рдж</a> рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░реВрдВрдЧрд╛ред  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдпрд╣рд╛рдВ рдХреЛрдИ рд░реЙрдХреЗрдЯ рд╡рд┐рдЬреНрдЮрд╛рди рдирд╣реАрдВ рд╣реИ рдФрд░ рдЖрдкрдХреЗ рдХреЛрдб рдХреЛ рддрджрдиреБрд╕рд╛рд░ рдареАрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рдмрд╛рд░ рдореИрдВ рддреГрддреАрдп-рдкрдХреНрд╖ рдореЙрдбреНрдпреВрд▓ рдХреЛ рдареАрдХ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛, рдЬрд┐рд╕рдореЗрдВ <code>torchvision</code> рд╕реЗ рдорд╛рдирдХ рдорд╛рдирдХ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдФрд░ рд╣рдореЗрд╢рд╛ рдХреА рддрд░рд╣ рд╡реЗ рдЖрдорддреМрд░ рдкрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред </p><br><p>  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рджреЛрдиреЛрдВ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХрд┐рдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдЬреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ рдЙрд╕реЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЬреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдирд╣реАрдВ рд╣реИ рд╡рд╣ рдЯреНрд░реЗрд╕ рд╣реЛ рд░рд╣рд╛ рд╣реИ: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> super(MyModule, self).__init__() self.resnet = torchvision.models.resnet34(pretrained = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment">#       torch.jit.script(my_module) #    -   resnet34. #     self.resnet  ScriptModule. self.resnet.eval() # NB:     !  -  ! self.resnet = torch.jit.trace(self.resnet, torch.rand((1,3,224,224), dtype=torch.float)) def forward(self, x): if x.shape[2] &lt; 224 or x.shape[3] &lt; 224: return torch.tensor(0) else: return self.resnet(x) my_module = MyModule() my_module = torch.jit.script(my_module)</span></span></code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдЕрдиреБрд░реЗрдЦрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рдореЙрдбреНрдпреВрд▓ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдореЙрдбреНрдпреВрд▓ рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдпреЛрдЧреНрдп рдирд╣реАрдВ рд╣реИ рдЬрд╣рд╛рдВ рдкрд░реНрдпрд╛рдкреНрдд рдЯреНрд░реЗрд╕ рдирд╣реАрдВ рд╣реИ рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рдЙрд▓рдЯреА рд╕реНрдерд┐рддрд┐ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрдЧрд░ рд╣рдореЗрдВ ONNX рдкрд░ рдПрдХ рдореЙрдбрд▓ рдЕрдкрд▓реЛрдб рдХрд░рдирд╛ рд╣реИ, рддреЛ рдЯреНрд░реЗрд╕рд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдЯреНрд░реЗрд╕ рдХрд┐рдП рдЧрдП рдореЙрдбрд▓ рдореЗрдВ рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдлрд╝рдВрдХреНрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рддрд░реНрдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╢рд╛рдЦрд╛рдУрдВ рдФрд░ рдЫреЛрд░реЛрдВ рдХреЛ рд╡рд╣рд╛рдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ!  рдПрдХ рдЙрджрд╛рд╣рд░рдг <a href="https://pytorch.org/docs/stable/onnx.html">рд╕рд░рдХрд╛рд░реА рджрд╕реНрддрд╛рд╡реЗрдЬ рдореЗрдВ torch.onnx рдХреЗ рд▓рд┐рдП рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ</a> ред </p><br><p>  TorchScript рдореЙрдбреНрдпреВрд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП PyTorch рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЛ <a href="https://pytorch.org/docs/stable/jit.html">рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдкреНрд░рд▓реЗрдЦрди</a> рдФрд░ <code>torch.jit</code> рдореЗрдВ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдореИрдВрдиреЗ <code>torch.jit.trace</code> <code>torch.jit.script</code> рдмрд╛рд░реЗ рдореЗрдВ рдбреЗрдХреЛрд░реЗрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ <code>torch.jit.trace</code> рдФрд░ <code>torch.jit.script</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рддрд░реАрдХреЗ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдирд╣реАрдВ рдХрд┐рдпрд╛ред  рдпрд╣ рдФрд░ рдмрд╣реБрдд рдХреБрдЫ рдкреНрд░рд▓реЗрдЦрди рдореЗрдВ рд╣реИред </p><br><h2 id="anchorcppanchorvklyuchaem-model-v-proekt-na-c"><a name="cpp"></a>  рд╣рдо рдореЙрдбрд▓ рдХреЛ C ++ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░рддреЗ рд╣реИрдВ </h2><br><p>  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, <a href="https://pytorch.org/tutorials/advanced/cpp_export.html">рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рджрд╕реНрддрд╛рд╡реЗрдЬ</a> " <code>torch.ones</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрддреНрдкрдиреНрди 2 <code>torch.ones</code> рдЬреЛрдбрд╝реЗрдВ" рдлреЙрд░реНрдо рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рддрдХ рд╕реАрдорд┐рдд рд╣реИред  рдореИрдВрдиреЗ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рдХреЗ рдХрд░реАрдм рдПрдХ рдкрд░рд┐рдпреЛрдЬрдирд╛</a> рдХрд╛ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">рдПрдХ</a> рдЙрджрд╛рд╣рд░рдг рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬреЛ рдУрдкрдирд╕реАрд╡реА рд╕реЗ рддрдВрддреНрд░рд┐рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рдПрдХ рддрд╕реНрд╡реАрд░ рднреЗрдЬрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЯреЗрдВрд╕рд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рдЪрд░ рдХреА рдПрдХ рдЯреБрдХрдбрд╝реА, рд╡рд┐рднрд╛рдЬрди рдХреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рддрд╕реНрд╡реАрд░ред </p><br><p>  рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ ResNet34 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд░реНрдЧреАрдХрд░рдг рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ DeepLabV3 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рднрд╛рдЬрдиред  рдЗрди рд▓рд┐рдкрд┐рдпреЛрдВ рдХреЛ рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/blob/master/prepare_scripts.ipynb">рдЗрд╕ рдЬреНрдпреВрдкрд┐рдЯрд░ рдиреЛрдЯрдкреИрдб</a> рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рд╣рдореЗрдВ <code>torchlib</code> рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЖрдк рдЗрд╕реЗ рдХрдИ рддрд░реАрдХреЛрдВ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><ol><li>  рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА PyTorch рд╕реНрдерд╛рдкрд┐рдд рд╣реИ рдЬреЛ <code>pip install</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдкрд╛рдпрдерди рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: <code>&lt;Miniconda3&gt;\Lib\site-packages\torch</code> ; </li><li>  рдпрджрд┐ рдЖрдкрдиреЗ PyTorch рдХреЛ рд╕реНрд░реЛрдд рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╡рд╣рд╛рдВ рд╣реИ: <code>&lt;My Pytorch repo&gt;\build\lib.win-amd64-3.6\torch</code> ; </li><li>  рдЕрдВрдд рдореЗрдВ, рдЖрдк <a href="https://pytorch.org/">pytorch.org</a> рд╕реЗ рдЕрд▓рдЧ рд╕реЗ <a href="https://pytorch.org/">рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ</a> рднрд╛рд╖рд╛ = C ++ рдЪреБрдирдХрд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрдЧреНрд░рд╣ рдХреЛ рдЕрдирдЬрд╝рд┐рдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </li></ol><br><p>  C ++ рдХреЛрдб рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИред  рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ: </p><br><ol><li>  рд╣реЗрдбрд░ рдлрд╝рд╛рдЗрд▓ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ <br><pre> <code class="plaintext hljs">#include &lt;torch/script.h&gt;</code> </pre> </li><li>  рдореЙрдбрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ <br><pre> <code class="plaintext hljs">torch::jit::script::Module module = torch::jit::load("../resnet34_infer.pth");</code> </pre> </li><li>  рдбреЗрдЯрд╛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ <br><pre> <code class="plaintext hljs">torch::Tensor tensor = torch::from_blob(img.data, { img.rows, img.cols, 3 }, torch::kByte);</code> </pre> </li><li>  рдлрдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ рдФрд░ рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ <br><pre> <code class="plaintext hljs">auto output = module.forward( { tensor } )</code> </pre> </li><li>  рдкрд░рд┐рдгрд╛рдо рд╕реЗ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред  рдпрд╣ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ рдпрд╣ рдЗрд╕ рдмрд╛рдд рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рддрдВрддреНрд░рд┐рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдХреНрдпрд╛ рд▓реМрдЯрд╛рддрд╛ рд╣реИред  рд╡реИрд╕реЗ, рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рди рдХреЗрд╡рд▓ рдПрдХ рддрд╕реНрд╡реАрд░ рдХреЛ рднреА рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдкреВрд░реЗ <a href="">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд╕реНрд░реЛрдд рдХреЛрдб</a> рдХреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдмреЗрд╣рддрд░ рд╣реИ, рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдлреНрд▓реЛрдЯ рдкреНрд░рдХрд╛рд░ рдХреЗ рдПрдХ рдЖрдпрд╛рдореА рдЯреЗрдВрд╕рд░ рд╕реЗ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП: <br><pre> <code class="plaintext hljs">float* data = static_cast&lt;float*&gt;(output.toTensor().data_ptr());</code> </pre> </li><li>  рдПрдХ рдФрд░ рд╕реВрдХреНрд╖реНрдорддрд╛ рд╣реИред  рдХреЛрдб рдореЗрдВ <code>with torch.no_grad()</code> рдПрдирд╛рд▓реЙрдЧ рд╕рдореНрдорд┐рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛ рддрд╛рдХрд┐ рдЧреНрд░реЗрдбрд┐рдПрдВрдЯреНрд╕ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдФрд░ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдмрд░реНрдмрд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рди рдХрд░реЗрдВ, рдЬрд┐рдирдХреА рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдЗрд╕ рдХрдорд╛рдВрдб рдХреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕реЗ C ++ рдХреЛрдб рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛: <br><pre> <code class="plaintext hljs">torch::NoGradGuard no_grad;</code> </pre> </li></ol><br><p>  рд╕реАрдПрдордХреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ <a href="https://pytorch.org/tutorials/advanced/cpp_export.html">рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдХрд╛</a> рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИред  рд▓реЗрдХрд┐рди рд╡рд┐рдЬрд╝реБрдЕрд▓ рд╕реНрдЯреВрдбрд┐рдпреЛ рдореЗрдВ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╡рд┐рд╖рдп рдХрд╛ рдЦреБрд▓рд╛рд╕рд╛ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдЗрд╕реЗ рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рдКрдВрдЧрд╛ред  рдЖрдкрдХреЛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдЯреНрд╡рд┐рдХ рдХрд░рдирд╛ рд╣реЛрдЧрд╛: </p><br><ol><li>  рдореИрдВрдиреЗ Visual Studio 2017 рдкрд░ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ред рдореИрдВ рдЕрдиреНрдп рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рдХрд╣ рд╕рдХрддрд╛ред </li><li>  V14.11 рдЯреВрд▓рд╕реЗрдЯ v141 рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП ( <code>"VC++ 2017 version 15.4 v14.11 toolset"</code> рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдореЗрдВ <code>"VC++ 2017 version 15.4 v14.11 toolset"</code> )ред </li><li>  рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо <code>x64</code> рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред </li><li>  <code>General тЖТ Platform Toolset</code> <code>v141(Visual Studio 2017)</code> рдЪрдпрди рдХрд░реЗрдВ <code>v141(Visual Studio 2017)</code> </li><li>  <code>C/C++ тЖТ General тЖТ Additional Include Directories</code> рдореЗрдВ <code>&lt;libtorch dir&gt;\include</code> </li><li>  <code>Linker тЖТ General тЖТ Additional Library Directories</code> <code>&lt;libtorch dir&gt;\lib</code> рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ </li><li>  <code>Linker тЖТ Input тЖТ Additional Dependencies</code> <code>torch.lib; c10.lib</code> рдЬреЛрдбрд╝реЗрдВ <code>torch.lib; c10.lib</code>  <code>torch.lib; c10.lib</code> ред  рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░, рд╡реЗ рд▓рд┐рдЦрддреЗ рд╣реИрдВ рдХрд┐ <code>caffe2.lib</code> рдЕрднреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ, рдФрд░ GPU рдХреЗ рд▓рд┐рдП рдФрд░ рдХреБрдЫ рдФрд░ <code>&lt;libtorch dir&gt;\lib</code> , рд▓реЗрдХрд┐рди рд╡рд░реНрддрдорд╛рди рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ, рдЗрди рджреЛрдиреЛрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝рдирд╛ рдореЗрд░реЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдерд╛ред  рд╢рд╛рдпрдж рдпрд╣ рдкреБрд░рд╛рдиреА рдЬрд╛рдирдХрд╛рд░реА рд╣реИред </li><li>  рд╡реЗ рдпрд╣ рднреА рд▓рд┐рдЦрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреЛ <code>C/C++ тЖТ Language тЖТ Conformance Mode</code> = <code>No</code> рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореБрдЭреЗ рдЕрдВрддрд░ рджрд┐рдЦрд╛рдИ рдирд╣реАрдВ рджрд┐рдпрд╛ред </li></ol><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ <code>__cplusplus</code> рдЪрд░ рдХреЛ рдШреЛрд╖рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  <a href="https://docs.microsoft.com/ru-ru/cpp/build/reference/zc-cplusplus%3Fview%3Dvs-2017"><code>  /Zc:__cplusplus</code></a> рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ <a href="https://docs.microsoft.com/ru-ru/cpp/build/reference/zc-cplusplus%3Fview%3Dvs-2017"><code>  /Zc:__cplusplus</code></a> <code>ivalue.h</code> рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдХрд▓рди рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХрд╛ рдкрд░рд┐рдгрд╛рдо рджреЗрдЧрд╛ред </p><br><p>  <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">рд╕рдВрд▓рдЧреНрди рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ,</a> рдкрде рд╕реЗрдЯрд┐рдВрдЧреНрд╕ (рди рдХреЗрд╡рд▓ рдЯреЙрд░реНрд▓рд┐рдм рдХреЗ рд▓рд┐рдП, рдмрд▓реНрдХрд┐ рдУрдкрдирд╕реАрд╡реА рдФрд░ рд╕реАрдпреВрдбреАрдПрдП рдХреЗ рд▓рд┐рдП рднреА) рдХреЛ рдкреНрд░реЙрдкрд░ <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/blob/master/cpp_proj/cpp_proj.props">рдлрд╝рд╛рдЗрд▓</a> рдореЗрдВ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╡рд┐рдзрд╛рдирд╕рднрд╛ рд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд╕реНрдерд╛рдиреАрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЙрдиреНрд╣реЗрдВ рд╡рд╣рд╛рдВ рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╡рд╣, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╕рдм рд╣реИред </p><br><h2 id="anchortipsanchorchto-eschyo-sleduet-imet-v-vidu"><a name="tips"></a>  рдФрд░ рдХреНрдпрд╛ рдзреНрдпрд╛рди рд░рдЦреЗрдВ </h2><br><p>  рдпрджрд┐ рд╡рд░реНрдгрд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдкрдХреЛ рдмрд╣реБрдд рд╕рд░рд▓ рд▓рдЧрддреА рд╣реИ, рддреЛ рдЖрдкрдХрд╛ рдЕрдВрддрд░реНрдЬреНрдЮрд╛рди рдЖрдкрдХреЛ рдзреЛрдЦрд╛ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред  рдкрд╛рдпрдерди рдореЗрдВ рд▓рд┐рдЦреЗ рдЧрдП рдЯреЙрд░реНрдЪрд░ рдХреЛ рдЯреЙрд░реНрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдИ рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдореИрдВ рдЙрди рд▓реЛрдЧреЛрдВ рдХреА рд╕реВрдЪреА рдиреАрдЪреЗ рджреВрдВрдЧрд╛ рдЬрд┐рдирдХрд╛ рдореБрдЭреЗ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рд╛ рдерд╛ред  рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдХреБрдЫ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВ рд╕рдм рдХреБрдЫ рдПрдХ рд╣реА рд╕реНрдерд╛рди рдкрд░ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреЛрд╣рд░рд╛рддрд╛ рд╣реВрдВред </p><br><p><img src="https://habrastorage.org/webt/iv/xy/q-/ivxyq-lqqw8s1aqd_cy4t4uwj5i.jpeg"></p><br><ul><li>  рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рджрд┐рдП рдЧрдП рдЪрд░ рдХреЗ рдкреНрд░рдХрд╛рд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЯреЗрдиреНрд╕рд░ рд╣реИред  рдпрджрд┐ рдХреБрдЫ (рдмрд╣реБрдд рд▓рдЧрд╛рддрд╛рд░) рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдпрд╣ рдЕрд╕реНрд╡реАрдХрд╛рд░реНрдп рд╣реИ, рддреЛ рдЖрдкрдХреЛ MyPy- рд╢реИрд▓реА рдХреЗ рдкреНрд░рдХрд╛рд░ рдПрдиреЛрдЯреЗрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдШреЛрд╖рд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдХреБрдЫ рдЗрд╕ рддрд░рд╣: </li></ul><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_letter_statistics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cls_preds: List[Tensor], cls_thresh: float)</span></span></span><span class="hljs-function">-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></span></code> </pre> <br><p>  рдпрд╛ рддреЛ: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_letter_statistics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cls_preds, cls_thresh)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># type: (List[Tensor], float)-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></span></code> </pre> <br><ul><li>  рдЪрд░ рджреГрдврд╝рддрд╛ рд╕реЗ рдЯрд╛рдЗрдк рдХрд┐рдП рдЧрдП рд╣реИрдВ рдФрд░ рдкреНрд░рдХрд╛рд░, рдпрджрд┐ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИ, рддреЛ рдкрд╣рд▓реЗ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдкреНрд░рдкрддреНрд░ <code>x=[]; for ...: x.append(y)</code> рдкрд░рд┐рдЪрд┐рдд рдирд┐рд░реНрдорд╛рдг <code>x=[]; for ...: x.append(y)</code>  <code>x=[]; for ...: x.append(y)</code> рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐  <code>[]</code> рдЕрд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд╕рдордп <code>[]</code> рд╕рдВрдХрд▓рдХ рдпрд╣ рдкрддрд╛ рдирд╣реАрдВ рд▓рдЧрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рд╕реВрдЪреА рдореЗрдВ рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╣реЛрдЧрд╛ред  рдЗрд╕рд▓рд┐рдП, рдЖрдкрдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рдХрд╛рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> List x: List[float] = []</code> </pre> <br><p>  рдпрд╛ (рдПрдХ рдФрд░ "рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП") </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Tensor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dict, Tuple, List x: Dict[int: Tuple[float, List[Tensor], List[List[int]]]] = {}</code> </pre> <br><ul><li>  рдКрдкрд░ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдпрд╣ рд╡реЗ рдирд╛рдо рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдпрд╛рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпреЗ рдирд╛рдо рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛрдб рдореЗрдВ рд╕рд┐рд▓ рджрд┐рдП рдЧрдП рд╣реИрдВред  рд╡реИрдХрд▓реНрдкрд┐рдХ, рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ рдХрд╛рдиреВрдиреА, рджреГрд╖реНрдЯрд┐рдХреЛрдг </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> typing x: typing.List[torch.Tensor] = []</code> </pre> <br><p>  рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рддреЗ рд╕рдордп рдПрдХ <em>рдЕрдЬреНрдЮрд╛рдд рдкреНрд░рдХрд╛рд░ рдХреЗ рдирд┐рд░реНрдорд╛рддрд╛ рдЯрд╛рдЗрдкрд┐рдВрдЧ</em> рдореЗрдВ рдкрд░рд┐рдгрд╛рдо рджреЗрдЧрд╛ред <em>рдЙрд╕рдХреА</em> рддреНрд░реБрдЯрд┐ </p><br><ul><li>  рдПрдХ рдФрд░ рдкрд░рд┐рдЪрд┐рдд рдбрд┐рдЬрд╛рдЗрди рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рднрд╛рдЧ рд▓реЗрдирд╛ рд╣реИ: </li></ul><br><pre> <code class="python hljs">x = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  рджреЛ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВред  рдпрд╛ рджреЛрдиреЛрдВ рдмрд╛рд░ Tensor рдЕрд╕рд╛рдЗрди рдХрд░реЗрдВ (рдпрд╣ рддрдереНрдп рдХрд┐ рдпрд╣ рд╡рд┐рднрд┐рдиреНрди рдЖрдпрд╛рдореЛрдВ рдХрд╛ рд╣реИ рдбрд░рд╛рд╡рдирд╛ рдирд╣реАрдВ рд╣реИ): </p><br><pre> <code class="python hljs">x = torch.tensor(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  рдФрд░ рдЗрд╕ рддрд░рд╣ рдХреЗ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдХреЗ рдмрд╛рдж рдХреНрдпрд╛ рдЯреВрдЯ рдЬрд╛рдПрдЧрд╛, рдпрд╣ рджреЗрдЦрдирд╛ рди рднреВрд▓реЗрдВред  рдпрд╛ рдИрдорд╛рдирджрд╛рд░реА рд╕реЗ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ: </p><br><pre> <code class="python hljs">x: Optional[Tensor] = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  рд▓реЗрдХрд┐рди рдлрд┐рд░ <code>x</code> рдЖрдЧреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рд╕рд╛рде рдЬрд╣рд╛рдВ рдЯреЗрдВрд╕рд░ рдХреА рдЙрдореНрдореАрдж рдХреА рдЬрд╛рддреА рд╣реИ, рд╣рдо рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рдПрдХ рддреНрд░реБрдЯрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗ: <em>рддрд░реНрдХ 'рдПрдХреНрд╕' рдХреЗ рд▓рд┐рдП рдЯрд╛рдЗрдк 'рдЯреЗрдВрд╕рд░' рдХреЗ рдореВрд▓реНрдп рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░реЗрдВ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдмрдЬрд╛рдп 'рд╡реИрдХрд▓реНрдкрд┐рдХ [рдЯреЗрдиреНрд╕рд░] рдЯрд╛рдЗрдк рдХрд░реЗрдВред</em> </p><br><ul><li><p>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкрд╣рд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рджреМрд░рд╛рди <code>x=0.</code> рд▓рд┐рдЦрдирд╛ рди рднреВрд▓реЗрдВ <code>x=0.</code>  рд╕рд╛рдорд╛рдиреНрдп <code>x=0</code> , рдЖрджрд┐ рдХреЗ рдмрдЬрд╛рдп, рдпрджрд┐ рдЪрд░ <code>x</code> рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br></li><li><p>  рдпрджрд┐ рдХрд╣реАрдВ рд╣рдордиреЗ <code>x = torch.Tensor(...)</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдЯреЗрдВрд╕рд░ рдХреЗ рдкреБрд░рд╛рдиреЗ рдЬрдорд╛рдиреЗ рдХреЗ рдЖрд░рдВрднреАрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рд╕рд╛рде рднрд╛рдЧ рд▓реЗрдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдЫреЛрдЯреЗ рд╕рдВрд╕реНрдХрд░рдг <code>x = torch.tensor(...)</code> рд╕рд╛рде рдПрдХ рдЫреЛрдЯреЗ рд╕рдВрд╕реНрдХрд░рдг рд╕реЗ рдмрджрд▓рдирд╛ рд╣реЛрдЧрд╛ред  рдЕрдиреНрдпрдерд╛, рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди рдпрд╣ рдЙрдбрд╝ рдЬрд╛рдПрдЧрд╛: <em>рдЕрдЬреНрдЮрд╛рдд рдмрд┐рд▓реНрдЯ рдСрдк: aten :: Tensorред</em>  <em>рдпрд╣рд╛рдБ рдХреБрдЫ рд╕реБрдЭрд╛рд╡ рджрд┐рдП рдЧрдП рд╣реИрдВ: рдкреНрд░рд╛рдпрд╢реНрдЪрд┐рддреНрдд: рд╕реНрдкрд░реНрд╢рдХ</em> ред  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╡реЗ рдпрд╣ рднреА рд╕рдордЭрд╛рддреЗ рд╣реИрдВ рдХрд┐ рд╕рдорд╕реНрдпрд╛ рдХреНрдпрд╛ рд╣реИ, рдФрд░ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЖрдк рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рд╣реА рдЙрддреНрддрд░ рдЬрд╛рдирддреЗ рд╣реИрдВред </p><br></li><li><p>  рдХреЛрдб рдХреЛ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд╣рд╛рдВ <code>torch.jit.script</code> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдЕрдЧрд░ рдХрд╣реАрдВ, рд╕реНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреНрд▓рд╛рд╕ рдпрд╛ рдлрд╝рдВрдХреНрд╢рди рдХреЗ <code>math.pow</code> , рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>math.pow</code> , рддреЛ рдЖрдкрдХреЛ рд╕рдВрдХрд▓рди рдореЙрдбреНрдпреВрд▓ рдореЗрдВ <code>import math</code> рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛ред  рдФрд░ рдЬрд╣рд╛рдВ рдпрд╣ рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЙрд╕ рд╡рд░реНрдЧ рдХреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛ рдмреЗрд╣рддрд░ рд╣реИ: рдпрд╛ рддреЛ <code>@torch.jit.script</code> рдбреЗрдХреЛрд░реЗрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛, рдпрд╛ рдЗрд╕рдХреЗ рдмрдЧрд▓ рдореЗрдВ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдлрд╝рдВрдХреНрд╢рди рдШреЛрд╖рд┐рдд рдХрд░рдХреЗ рдЬреЛ ScriptModule рдХреЛ рдЗрд╕рд╕реЗ рдмрд╛рд╣рд░ рдХрд░рддрд╛ рд╣реИред  рдЕрдиреНрдпрдерд╛, рд╣рдореЗрдВ рдПрдХ <em>рдЕрдкрд░рд┐рднрд╛рд╖рд┐рдд рдореВрд▓реНрдп рдЧрдгрд┐рдд</em> рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдорд┐рд▓рддрд╛ рд╣реИ рдЬрдм рд╣рдо рдПрдХ рдореЙрдбреНрдпреВрд▓ рд╕реЗ рдПрдХ рд╡рд░реНрдЧ рдХреЛ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ, рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░, <code>math</code> рдЖрдпрд╛рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред </p><br></li><li><p>  рдЕрдЧрд░ рдХрд╣реАрдВ рдкрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ <code>my_tensor[my_tensor &lt; 10] = 0</code> рдпрд╛ рдЗрд╕реА рддрд░рд╣ рдХреЗ рдлреЙрд░реНрдо рдХрд╛ рдирд┐рд░реНрдорд╛рдг рд╣реИ, рддреЛ рдЖрдкрдХреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдХрд░рддреЗ рд╕рдордп рдПрдХ рдЧреБрдкреНрдд рддреНрд░реБрдЯрд┐ рдорд┐рд▓реЗрдЧреА: </p><br><pre> <code class="plaintext hljs">*aten::index_put_(Tensor(a!) self, Tensor?[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):* *Expected a value of type 'Tensor' for argument 'values' but instead found type 'int'.* *aten::index_put_(Tensor(a!) self, Tensor[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):* *Expected a value of type 'List[Tensor]' for argument 'indices' but instead found type 'List[Optional[Tensor]]'.*</code> </pre> <br><p>  рдЖрдкрдХреЛ рдЯреЗрдВрд╕рд░ рдХреЗ рд╕рд╛рде рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрдпрд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ: <code>my_tensor[my_tensor &lt; 10] = torch.tensor(0.).to(my_tensor.device)</code> ред  рдФрд░ <code>my_tensor</code> рдкреНрд░рдХрд╛рд░ рдХреЗ рдкрддреНрд░рд╛рдЪрд╛рд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ) рдФрд░ рдмрдирд╛рдП рдЧрдП рдЯреЗрдВрд╕рд░ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдлреНрд▓реЛрдЯ) рдФрд░ b) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ <code>.to(my_tensor.device)</code> ред  рдпрджрд┐ рдЖрдк рджреВрд╕рд░реЗ рдХреЛ рднреВрд▓ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рд╕рдм рдХреБрдЫ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдкрд╣рд▓реЗ рд╕реЗ рд╣реА GPU рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ, рдЖрдк рдкрд░реЗрд╢рд╛рди рд╣реЛ рдЬрд╛рдПрдВрдЧреЗ, рдЬреЛ рдХрд┐ рдЧреБрдкреНрдд рд╢рдмреНрджреЛрдВ рдХреА рддрд░рд╣ рджрд┐рдЦреЗрдЧрд╛ <em>CUDA рддреНрд░реБрдЯрд┐: рдПрдХ рдЕрд╡реИрдз рдореЗрдореЛрд░реА рдПрдХреНрд╕реЗрд╕ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рд╛</em> , рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд┐рдП рдмрд┐рдирд╛ рдХрд┐ рддреНрд░реБрдЯрд┐ рдХрд╣рд╛рдВ рд╣реБрдИ! </p><br></li><li><p>  рдпрд╣ рдордд рднреВрд▓реЛ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ <code>nn.Module</code> рджреНрд╡рд╛рд░рд╛ рдФрд░, рддрджрдиреБрд╕рд╛рд░, рдорд╢рд╛рд▓ рд╕рдВрд╢реЛрдзрди рд╕реЗ рдореЙрдбрд▓ "рдЯреНрд░реЗрди рдореЛрдб" рдореЗрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЖрдк рдЗрд╕реЗ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рдкрддрд╛ <a href="https://fooobar.com/questions/16769103/error-when-converting-pytorch-model-to-torchscript/25666033">рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдРрд╕рд╛ рдХреЛрдИ рдореЛрдб рд╣реИ</a> )ред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЯреНрд░реЗрди рдореЛрдб рд╕реЗ рдбреНрд░реЙрдкрдЖрдЙрдЯ рдФрд░ рдЕрдиреНрдп рдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдпрд╛ рддреЛ рдЯреНрд░реЗрд╕ рдХреЛ рддреЛрдбрд╝рддреЗ рд╣реИрдВ рдпрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдкрд░ рдЕрдкрд░реНрдпрд╛рдкреНрдд рдкрд░рд┐рдгрд╛рдо рджреЗрддреЗ рд╣реИрдВред  рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдпрд╛ рдЯреНрд░реЗрд╕рд┐рдВрдЧ рд╕реЗ рдкрд╣рд▓реЗ <code>model.eval()</code> рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдпрд╛рдж рд░рдЦреЗрдВред </p><br></li><li><p>  рдлрд╝рдВрдХреНрд╢рдВрд╕ рдФрд░ рд╕рд╛рдзрд╛рд░рдг рд╡рд░реНрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ nn.Module - рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЯрд╛рдЗрдк рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ </p><br></li><li><p>  рдПрдХ рд╡реИрд╢реНрд╡рд┐рдХ рдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдкрджреНрдзрддрд┐ рдореЗрдВ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ </p><br></li></ul><br><pre> <code class="python hljs">cls_thresh = <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> ... x = r &lt; cls_thresh ...</code> </pre> <br><p>  рдкрд░рд┐рдгрд╛рдо рдХреА рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рддреНрд░реБрдЯрд┐ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк <em>рдЯрд╛рдЗрдк 'рдлреНрд▓реЛрдЯ' рдХреЗ рдЕрдЬрдЧрд░ рдореВрд▓реНрдп рдХреЛ рдореВрд▓реНрдп рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ</em> ред  рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдореЗрдВ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ: </p><br><pre> <code class="python hljs">cls_thresh = <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... self.cls_thresh = cls_thresh ... x = r &lt; self.cls_thresh ...</code> </pre> <br><ul><li>  рдпрджрд┐ рд╢реНрд░реЗрдгреА рд╡рд┐рд╢реЗрд╖рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реНрд▓рд╛рдЗрд╕ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ рдФрд░ рд╕реВрдХреНрд╖реНрдорддрд╛ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ: </li></ul><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FPN</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, block, num_blocks, num_layers =</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ... self.num_layers = num_layers <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (p3, p4, p5, p6, p7)[:self.num_layers]</code> </pre> <br><p>  рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рддреНрд░реБрдЯрд┐ рдХреЗ рдХрд╛рд░рдг <em>рдЯреБрд▓реНрд▓ рд╕реНрд▓рд╛рдЗрд╕ рдЗрдВрдбреЗрдХреНрд╕ рдкреВрд░реНрдгрд╛рдВрдХ рд╕реНрдерд┐рд░рд╛рдВрдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП</em> ред  рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ num_layers рд╡рд┐рд╢реЗрд╖рддрд╛ рд╕реНрдерд┐рд░ рд╣реИ рдФрд░ рд╡рд╣ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдирд╣реАрдВ рд╣реЛрдЧреА: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FPN</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(nn.Module)</span></span></span><span class="hljs-class">:</span></span> num_layers: torch.jit.Final[int] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, block, num_blocks, num_layers =</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><ul><li>  рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдЬрд╣рд╛рдВ рдЯреЗрдирд╕рд░ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдлрд┐рдЯ рд╣реЛрддреЗ рдереЗ, рдЖрдкрдХреЛ рд╕рдВрдЦреНрдпрд╛ рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдкрд╛рд╕ рдХрд░рдирд╛ рд╣реЛрдЧрд╛: </li></ul><br><pre> <code class="python hljs">xx1 = x1.clamp(min=x1[i])</code> </pre> <br><p>  рд╕реНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдореЗрдВ рддреНрд░реБрдЯрд┐ рддрдм рдЖрддреА рд╣реИ рдЬрдм <em><code>Expected a value of type 'Optional[number]' for argument 'min' but instead found type 'Tensor'.</code></em>  ред  рдЦреИрд░, рдпрд╣рд╛рдБ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рд╕реЗ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИ: </p><br><pre> <code class="python hljs">xx1 = x1.clamp(min=x1[i].item())</code> </pre> <br><p>  рдЯреНрд░реЗрд╕рд┐рдВрдЧ рдХрд░рддреЗ рд╕рдордп рдЙрдкрд░реЛрдХреНрдд рд╕рдорд╕реНрдпрд╛рдПрдВ рд╣реЛрддреА рд╣реИрдВред  рдпрд╣ рдЙрдирдХреЗ рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдЖрдорддреМрд░ рдкрд░ рдЯреЙрд░реНрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рддреИрдпрд╛рд░ рдХрд┐рдП рдЧрдП рд╕рдорд╛рдзрд╛рдиреЛрдВ рдХреЛ рдмрд╕ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдЖрдкрдХреЛ рдпрд╛ рддреЛ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рд╕реНрд░реЛрдд рдХреЛрдб рдХреА рдорд╛рд▓рд┐рд╢ рдХрд░рдиреА рд╣реЛрдЧреА (рдпрджрд┐ рд╕реНрд░реЛрдд рдХреЛрдб рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╣реИ) рдпрд╛ рдЯреНрд░реЗрд╕рд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред  рд▓реЗрдХрд┐рди рдЯреНрд░реЗрд╕ рдХреА рдЕрдкрдиреА рдмрд╛рд░реАрдХрд┐рдпрд╛рдВ рд╣реИрдВ: </p><br><ul><li>  рдкреНрд░рдкрддреНрд░ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдЯреНрд░реЗрд╕ рдореЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ </li></ul><br><pre> <code class="plaintext hljs">tensor_a.to(tensor_b.device)</code> </pre> <br><p>  рдЬрд┐рд╕ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдЯреЗрдВрд╕рд░ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рд╡рд╣ рдЯреНрд░реЗрд╕рд┐рдВрдЧ рдХреЗ рд╕рдордп рддрдп рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди рдирд╣реАрдВ рдмрджрд▓рддрд╛ рд╣реИред  рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдЯреЗрдВрд╕рд░ рдХреЛ <code>nn.Module</code> рдкреНрд░рдХрд╛рд░ <code>Parameter</code> <code>nn.Module</code> рд╕рджрд╕реНрдп рдШреЛрд╖рд┐рдд рдХрд░рдХреЗ рдЖрдВрд╢рд┐рдХ рд░реВрдк рд╕реЗ рджреВрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдлрд┐рд░, рдЬрдм рдореЙрдбрд▓ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ, рддреЛ рдпрд╣ рдЙрд╕ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдмреВрдЯ рд╣реЛрдЧрд╛ рдЬреЛ <code>torch.jit.load</code> рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИред <code>torch.jit.load</code> рдлрд╝рдВрдХреНрд╢рдиред </p><br><h2 id="epilog">  рдЙрдкрд╕рдВрд╣рд╛рд░ </h2><br><p>  рдЙрдкрд░реЛрдХреНрдд рд╕рднреА, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рд╕рдорд╕реНрдпрд╛рдПрдВ рдкреИрджрд╛ рдХрд░рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдЯрд╛рд░реНрдЪрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЖрдкрдХреЛ рдПрдХ рд╣реА рдкреВрд░реЗ рдореЙрдбрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдорд╛рдзрд╛рди рдХреЛ рд╕рдВрдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдФрд░ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдФрд░ рдкрд╛рдпрдерди рдХреЛрдб рдЬреЛ рдкреВрд░реНрд╡ рдФрд░ рдмрд╛рдж рдХреЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рд╣рд╛рдВ, рдФрд░ рдЙрдкрд░реЛрдХреНрдд рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рд╕рдВрдХрд▓рди рдХреЗ рд▓рд┐рдП рд╕рдорд╛рдзрд╛рди рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп, рд╕рдорд╛рдзрд╛рди рдмрдирд╛рдиреЗ рдХреА рд▓рд╛рдЧрдд рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрддреБрд▓рдиреАрдп рд░реВрдк рд╕реЗ рдХрдо рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдВ PyTorch рдорд╣рд╛рди рд▓рд╛рдн рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЦреЗрд▓ рдореЛрдордмрддреНрддреА рдХреЗ рд▓рд╛рдпрдХ рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/v0/3m/qt/v03mqtayxdfh5be4ut3nrr0c86q.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi480328/">https://habr.com/ru/post/hi480328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi480310/index.html">рд╣рд╛рдмрд░рд╛ рдЬрд╛рд╕реВрд╕: рд╕рдорд╛рдЪрд╛рд░ рд╕рдВрдкрд╛рджрдХреЛрдВ рдХрд╛ рд░рд╣рд╕реНрдп</a></li>
<li><a href="../hi480316/index.html">рд╡рд╛рдИрдлрд╝рд╛рдИ рдореЙрдбреНрдпреВрд▓ рдХреА рдЦрдкрдд рдХреЛ рджрд╕ рдпрд╛ рдЕрдзрд┐рдХ рдмрд╛рд░ рдХреИрд╕реЗ рдХрдо рдХрд░реЗрдВ</a></li>
<li><a href="../hi480318/index.html">рдорд╛рд╕реНрдХреЛ рдореЗрдВ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЖрдЧрд╛рдореА рдирд┐: рд╢реБрд▓реНрдХ рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдЪрдпрди # 3 (16-24 рджрд┐рд╕рдВрдмрд░)</a></li>
<li><a href="../hi480320/index.html">рд░реВрд╕ рдореЗрдВ рдУрдПрдирд╡рд╛рдИрдПрдХреНрд╕ рдХреЗ рджрд╕ рд╕рд╛рд▓ - рдЗрд╕ рд╕рдордп рдХреЗ рджреМрд░рд╛рди рддрдХрдиреАрдХ, рдкрд╛рдардХ рдФрд░ рдмрд╛рдЬрд╛рд░ рдХреИрд╕реЗ рдмрджрд▓ рдЧрдП рд╣реИрдВ</a></li>
<li><a href="../hi480324/index.html">рд╕реАрдкреАрдереЙрди рдореЗрдВ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдкреНрд░рдХрд╛рд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</a></li>
<li><a href="../hi480330/index.html">рдЖрджрд░реНрд╢ рдХрд░реНрдордЪрд╛рд░реА рдореВрд▓реНрдпрд╛рдВрдХрди рдЙрдкрдХрд░рдг</a></li>
<li><a href="../hi480332/index.html">рдореЙрд╕реНрдХреЛ рд╕рд┐рдЯреА рдбреНрдпреВрдорд╛ рдореЗрдВ 2019 рдмреНрд▓реЙрдХрдЪреЗрди рдорддрджрд╛рди рдХреЗ рдЖрдВрдХрдбрд╝реЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
<li><a href="../hi480334/index.html">QtQML / рддреНрд╡рд░рд┐рдд рд╕рд╣рд╕рдВрдмрдВрдз рдкреИрдирд▓</a></li>
<li><a href="../hi480338/index.html">3 рдбреА рдЧреЗрдо рд░реЗрдВрдбрд░рд┐рдВрдЧ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: рд░реИрд╕реНрдЯрд┐рд░реЗрд╢рди рдФрд░ рд░реЗ рдЯреНрд░реЗрд╕рд┐рдВрдЧ</a></li>
<li><a href="../hi480340/index.html">рдореИрдВрдиреЗ рдПрдХ рдЕрдХреНрд╖рдо рдкреНрд░рдмрдВрдзрдХ рдХрд╛ рд╡рд┐рд░реЛрдз рдХрд┐рдпрд╛, рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ рдкрджреЛрдиреНрдирдд рдХрд┐рдпрд╛ рдЧрдпрд╛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>