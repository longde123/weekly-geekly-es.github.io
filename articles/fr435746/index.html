<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôçÔ∏è ü§¥üèª üë®üèº‚Äçüî¨ G√©n√©ration DAG dynamique dans le flux d'air üë©üèæ‚Äçüíº üò¶ ü§∞üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Mon nom est Anton, √† Rostelecom je d√©veloppe un entrep√¥t de donn√©es central. Notre stockage se compose de modules, dont l'orchestrateu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>G√©n√©ration DAG dynamique dans le flux d'air</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/435746/"><p>  Bonjour √† tous!  Mon nom est Anton, √† Rostelecom je d√©veloppe un entrep√¥t de donn√©es central.  Notre stockage se compose de modules, dont l'orchestrateur utilise plusieurs instances Informatica, dont certaines que nous souhaitons transf√©rer vers Airflow dans le cadre de la transition vers des solutions open source.  √âtant donn√© qu'Informatica et Airflow sont des outils fondamentalement diff√©rents, prendre et r√©p√©ter une impl√©mentation existante n'est pas si simple.  Nous voulions obtenir un workflow, d'une part, aussi proche que possible de l'impl√©mentation actuelle et, d'autre part, en utilisant le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier principe d'Airflow</a> le plus int√©ressant - le dynamisme, ce qui donne de la flexibilit√©. </p><br><p>  Dans ce court article, je veux parler de la g√©n√©ration vraiment dynamique des DAG dans Airflow.  Sur ce sujet, Internet contient principalement de nombreux articles de d√©veloppeurs indiens, qui sont des mat√©riaux de la forme <em>"vous pouvez g√©n√©rer dynamiquement des dags dans Airflow, voici un exemple: &lt;exemple pour g√©n√©rer 10 t√¢ches / dags HelloWorld&gt;"</em> .  Mais nous √©tions int√©ress√©s par la g√©n√©ration de dags, qui √©volueront dans le temps avec un nombre et des noms de t√¢ches variables. </p><br><p><img src="https://habrastorage.org/webt/zl/yr/sk/zlyrskhcw1q8wswrizaqcep2-pa.png" title="Apache Airflow"></p><a name="habracut"></a><br><p>  Actuellement, Airflow est impl√©ment√© pour lancer un module qui g√©n√®re des paquets de donn√©es sur des serveurs source distants pour un t√©l√©chargement ult√©rieur vers le r√©f√©rentiel.  Il se d√©roule selon un planning simple, il n'est pas tr√®s int√©ressant de l'examiner en d√©tail.  En outre, une orchestration sera bient√¥t introduite via le module Airflow, qui fournit des paquets de donn√©es pour un chargement suppl√©mentaire couche par couche dans le transfert interm√©diaire.  Ici, nous attendons une s√©rie de r√¢teaux, dont je n'ai trouv√© la description nulle part et je veux partager mon exp√©rience. </p><br><p>  Sur Airflow sur Habr√©, il y a quelques articles de d√©veloppeurs de Mail.ru dans lesquels les choses de base sont bien d√©crites: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Description g√©n√©rale d'Airflow</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Branchement, param√©trage via jinja et communication au sein du DAG via Xcom</a> </p><br><h2 id="nebolshoy-glossariy">  Petit glossaire: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DAG / DAG</a> est un graphique acyclique dirig√©.  Dans ce cas, nous entendons une s√©quence d'actions qui d√©pendent les unes des autres et ne forment pas de cycles. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SubDAG / Sabdag</a> - le m√™me que DAG, mais situ√© √† l'int√©rieur d'un autre DAG, lanc√© dans le cadre du DAG parent (c'est-√†-dire, √©tant une t√¢che) et n'ayant pas de calendrier s√©par√©. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Op√©rateur / Op√©rateur</a> - une √©tape sp√©cifique du dag, effectuant une action sp√©cifique.  Par exemple, PythonOperator. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">T√¢che / T√¢che</a> - une instance sp√©cifique de l'op√©rateur lors du d√©marrage du DAG, est visualis√©e comme un petit carr√© dans l'interface Web.  Par exemple, PythonOperator, qui est appel√© <em>run_task</em> et s'ex√©cute dans le DAG <em>check_dag</em> . </p><br><h2 id="ideya-dinamicheskoy-generacii-taskov-v-dage-problemy-i-nedostatki">  L'id√©e de la g√©n√©ration dynamique de t√¢ches en dag, probl√®mes et inconv√©nients </h2><br><p>  Donn√©es d'entr√©e: </p><br><p>  Il y a une table dans le r√©f√©rentiel d'orchestre, appelons-la PKG_TABLE. <br>  Il existe un m√©canisme qui ajoute des entr√©es √† la table PKG_TABLE que le paquet de donn√©es est pr√™t √† t√©l√©charger. </p><br><p>  Ce que nous voulions: </p><br><p>  DAG, qui sera g√©n√©r√© pour les packages pr√™ts √† t√©l√©charger et commencer √† les t√©l√©charger (spoiler: √† la fin, tout s'est av√©r√©). </p><br><p> En utilisant le code ci-dessous, nous g√©n√©rons un dag compos√© de la t√¢che LatestOnlyOperator et de sa t√¢che d√©pendante, qui est cr√©√©e lorsque la fonction pkg_subdag_factory est ex√©cut√©e, qui re√ßoit une liste de packages de la table PKG_TABLE et g√©n√®re plusieurs PythonOperators.  S'il n'y a aucun package √† t√©l√©charger, un DummyOperator est g√©n√©r√©. </p><br><p>  Ils ont d√©cid√© de cr√©er la premi√®re version avec un PythonOperator, en la redistribuant dans un workflow d√©taill√© √† l'aide d'Airflow. </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- """  DAG    """ from airflow.models import DAG from airflow.operators.python_operator import PythonOperator from airflow.operators.subdag_operator import SubDagOperator from airflow.operators.dummy_operator import DummyOperator from airflow.operators.latest_only_operator import LatestOnlyOperator from airflow.hooks.oracle_hook import OracleHook from datetime import datetime, timedelta import logging from scripts.lib import run_load, select_pkg_data def pkg_subdag_factory( oracle_hook, parent_dag_name, child_dag_name, start_date, schedule_interval, param_dict): """ ,  DAG    PythonOperator\` (1  - 1 PythonOperator)  : oracle_hook - airflow.hooks.oracle_hook.OracleHook parent_dag_name -  ""  child_dag_name -    start_date -       schedule_interval -      param_dict -     """ dag = DAG( '%s.%s' % (parent_dag_name, child_dag_name), schedule_interval=schedule_interval, start_date=start_date, catchup=False ) logging.info('selecting pkg data...') pkg_set = select_pkg_data(oracle_hook) if len(pkg_set): logging.info('pkg_set:') logging.info(pkg_set) for pkg in pkg_set: pkg_id = pkg[1] pkg_dict = {'pkg_data_' + str(pkg_id): pkg} param_dict.update(pkg_dict) task_name = 'pkg_' + str(pkg_id) PythonOperator( task_id=task_name, python_callable=run_load, op_kwargs={ 'oracle_hook': oracle_hook, 'param_dict': param_dict, 'pkg_id': pkg_id }, retries=0, dag=dag ) else: logging.info('Undelivered packages not found') DummyOperator(task_id='no_packages_dummy', retries=0, dag=dag) return dag interval = '*/10 * * * *' args = { 'owner': 'airflow', 'start_date': datetime(2018, 11, 12) } oracle_hook = OracleHook('ora_meta') main_dag_name = 'load' load_dag_name = 'load_packages' param_dict = { #       } main_dag = DAG( dag_id=main_dag_name, default_args=args, schedule_interval=interval, catchup=False ) subdag = SubDagOperator( subdag=pkg_subdag_factory( oracle_hook, main_dag_name, load_dag_name, args['start_date'], interval, param_dict ), task_id=load_dag_name, dag=main_dag ) #  ,       latest_only = LatestOnlyOperator(task_id='latest_only', dag=main_dag) subdag.set_upstream(latest_only)</span></span></code> </pre> <br><p>  Les captures d'√©cran suivantes montrent √† quoi cela ressemble en cons√©quence. <br>  Apparence de DAG: </p><br><p><img src="https://habrastorage.org/webt/_x/tl/sd/_xtlsduwcwvecmuwk2qfd2rlpyq.png" title="Apparition de DAG"></p><br><p>  Apparence du sous-dag en l'absence de colis pour la livraison: </p><br><p><img src="https://habrastorage.org/webt/z7/vn/gy/z7vngyipby78gaksu29i0km1y04.png" title="En l'absence de colis pour la livraison"></p><br><p>  Apparition du sous-dag en pr√©sence de colis pour la livraison: </p><br><p><img src="https://habrastorage.org/webt/-3/ig/9f/-3ig9fawopeyqupws_ya7pp3ve0.png" title="S'il y a des colis pour la livraison"></p><br><h2 id="problemy-i-nyuansy">  Probl√®mes et nuances </h2><br><ul><li>  Le rattrapage n'a pas fonctionn√© comme pr√©vu: apr√®s avoir allum√© le dag √©teint, plusieurs lancements ont eu lieu (pas pour toute la p√©riode du calendrier, mais 2-3 en m√™me temps).  Pour cette raison, j'ai d√ª ajouter LatestOnlyOperator, afin que tous les lancements, sauf le dernier, deviennent inactifs. </li><li>  Si vous cr√©ez un sous-dag, vous devez l'activer explicitement via la ligne de commande avec la commande "airflow unpause &lt;subdag_name&gt;", sinon il ne d√©marre pas, et vous devez le faire lors de la cr√©ation de chaque nouveau sous-dag (un sous-dag avec un nouveau nom), ce qui rendra tr√®s g√™nant la g√©n√©ration dynamique .  Si vous d√©finissez le param√®tre "dags_are_paused_at_creation" = false dans la configuration de l'airflow ($ airflow_home / airflow.cfg), cela ne sera pas n√©cessaire, mais cela peut entra√Æner des cons√©quences d√©sagr√©ables avec le lancement automatique automatique d'un nouveau dag - il me semble que vous devez d√©marrer de nouveaux dagas manuellement. </li></ul><br><p>  Comme le dit la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , "Une des principales capacit√©s d'Airflow est que ces DAG Runs sont des √©l√©ments atomiques et idempotents, &lt;...&gt;", ce qui signifie: "Il est entendu que le DAG est g√©n√©r√© inchang√©."  Du fait que nous avons viol√© cette "capacit√© cl√©", nous avons appris certaines choses: </p><br><ul><li>  Un dag vide (sans t√¢ches) commence et ne peut pas se terminer, obstruant tous les parall√®les possibles.  Cela s'est produit s'il n'y avait aucun package de t√©l√©chargement au moment du lancement du fichier.  Pour contourner ce probl√®me, un DummyOperator est cr√©√©. </li><li>  Si pendant le travail, le fichier de t√¢ches est r√©g√©n√©r√© et qu'il n'y a plus de t√¢che dans le fichier de donn√©es mis √† jour - il s'arr√™tera avec interruption du processus en cours.  Et cela se produit √† chaque √©tape du sheduler, mais pas plus souvent qu'indiqu√© dans le param√®tre min_file_process_interval dans la configuration de l'airflow ($ airflow_home / airflow.cfg).  Pour contourner cela, nous avons fait la g√©n√©ration de packs de t√¢ches non seulement par le statut "pr√™t √† t√©l√©charger", mais aussi par le statut "chargement en cours" afin qu'il continue d'√™tre g√©n√©r√© pendant le t√©l√©chargement. </li><li>  Si la version actuelle du dag ne contient aucune t√¢che ant√©rieure - par exemple, une t√¢che portant le nom "pkg_123" a √©t√© charg√©e plus t√¥t et n'est pas cr√©√©e dans la version actuelle du dag, vous ne pouvez pas voir de statistiques sur cette t√¢che dans l'interface Web.  Bien que toutes les informations soient stock√©es dans la base de donn√©es de flux d'air et sur sa base, il est possible de construire un beau tableau de bord pour les lancements anciens par des moyens externes.  Lorsque la question se pose sur la fr√©quence de mise √† jour des DAG et la possibilit√© de le d√©sactiver, vous pouvez lire √† ce sujet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </li><li>  En raison de la g√©n√©ration dynamique de task_id, vous devez lancer un dictionnaire avec les donn√©es de tous les packages actuels dans chacune de ces t√¢ches, ainsi que l'ID du package actuel, de sorte que lorsque la fonction elle-m√™me fonctionne, s√©lectionnez les donn√©es n√©cessaires dans le m√™me dictionnaire par ID de package.  Sinon, toutes les t√¢ches ont d√©marr√© pour le m√™me package. </li></ul><br><h2 id="execution_date-v-logah-i-fakticheskoe-vremya-zapuska">  Date d'ex√©cution dans les journaux et heure de d√©but r√©elle </h2><br><p>  Je terminerai par une autre nuance d'Airflow, qui au d√©but confond et n'est pas d√©crite en termes simples dans d'autres articles - date_ex√©cution (qui est affich√©e dans tous les journaux, dans l'interface, etc.) et l'heure de d√©but r√©elle.  En principe, la description se trouve dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation du flux d'air</a> et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FAQ</a> , mais le r√©sultat n'est pas √©vident, il me semble donc qu'une clarification est n√©cessaire. </p><br><p>  <em>Documentation</em> : "Le planificateur lance votre travail √† la fin de la p√©riode" <br>  <em>R√©sultat</em> : si vous cr√©ez un dag avec une planification, par exemple @daily, une ex√©cution avec la date d'ex√©cution "2018-01-01 00:00:00" s'ex√©cutera r√©ellement "2018-02-01 00:00:00". </p><br><h2 id="poleznye-ssylki">  Liens utiles: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation de rattrapage</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plus de documentation sur LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exemple d'utilisation de LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quelques nuances</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Question sur les d√©pendances par rapport au lancement pr√©c√©dent</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un petit exemple de g√©n√©ration dynamique</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Une question sur la g√©n√©ration dynamique avec une petite description</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435746/">https://habr.com/ru/post/fr435746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435734/index.html">Comment ne pas se laisser berner en faisant de la physique</a></li>
<li><a href="../fr435738/index.html">Technique de projet de bricolage. Premi√®re partie</a></li>
<li><a href="../fr435740/index.html">L'inscription est ouverte au GraphQL Meetup √† Saint-P√©tersbourg</a></li>
<li><a href="../fr435742/index.html">Gestion des ressources dans Zimbra Collaboration Suite</a></li>
<li><a href="../fr435744/index.html">Fintech-digest: la Banque de Russie va pouvoir bloquer des sites, les volumes de pr√™ts P2P baissent, la crypto en Europe</a></li>
<li><a href="../fr435748/index.html">Metasploit Framework 5.0 est sorti</a></li>
<li><a href="../fr435750/index.html">R√©capitulatif des √©v√©nements informatiques de janvier</a></li>
<li><a href="../fr435752/index.html">Moscow Python Conf ++ 2019 - la premi√®re conf√©rence o√π nous pr√©parons nous-m√™mes des intervenants</a></li>
<li><a href="../fr435756/index.html">Vente du Nouvel An</a></li>
<li><a href="../fr435760/index.html">Inside Quake: D√©finir des surfaces visibles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>