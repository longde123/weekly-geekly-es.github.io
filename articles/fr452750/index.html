<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÑ üö£üèø üéÖ Nextcloud √† l'int√©rieur et √† l'ext√©rieur d'OpenLiteSpeed: configurer le proxy inverse üßòüèΩ üë©üèº‚Äç‚úàÔ∏è üå∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment configurer OpenLiteSpeed ‚Äã‚Äãpour inverser le proxy dans Nextcloud, situ√© sur le r√©seau interne? 


 √âtonnamment, une recherche sur Habr√© pour O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nextcloud √† l'int√©rieur et √† l'ext√©rieur d'OpenLiteSpeed: configurer le proxy inverse</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452750/"><h3>  Comment configurer OpenLiteSpeed ‚Äã‚Äãpour inverser le proxy dans Nextcloud, situ√© sur le r√©seau interne? </h3><br><p>  √âtonnamment, une recherche sur Habr√© pour OpenLiteSpeed ‚Äã‚Äãne donne rien!  Je m'empresse de corriger cette injustice, car LSWS est un serveur Web digne.  Je l'aime pour l'interface d'administration Web rapide et √† la mode: </p><br><p><img src="https://habrastorage.org/webt/ex/pr/ai/expraidfnnddzqcw-222w5tbbto.png" alt="image"></p><br><p>  Malgr√© le fait que OpenLiteSpeed ‚Äã‚Äãest surtout connu comme un "acc√©l√©rateur" de WordPress, dans l'article d'aujourd'hui, je vais montrer son application plut√¥t sp√©cifique.  √Ä savoir inverser les demandes de proxy (proxy inverse).  Vous dites qu'il est plus courant d'utiliser nginx pour cela?  Je serai d'accord.  Mais √ßa nous a vraiment fait mal d'aimer LSWS! </p><br><p>  Procuration ok, mais o√π?  Nextcloud est un service tout aussi merveilleux.  Nous utilisons Nextcloud pour cr√©er des ¬´nuages ‚Äã‚Äãde partage de fichiers¬ª priv√©s.  Pour chaque client, nous allouons une machine virtuelle distincte avec Nextcloud, et nous ne voulons pas les exposer "out".  Au lieu de cela, nous mandatons les demandes via un proxy inverse commun.  Cette solution vous permet de: </p><br><ol><li>  supprimer le serveur sur lequel les donn√©es client sont stock√©es d'Internet et </li><li>  enregistrer les adresses IP. </li></ol><br><p>  Le sch√©ma ressemble √† ceci: </p><br><p><img src="https://habrastorage.org/webt/pt/iw/dk/ptiwdkww_5xiebu_7rzjk1q_nn4.png" alt="image"></p><br><p>  Il est clair que le sch√©ma est simplifi√©, car  l'organisation d'une infrastructure de services Web n'est pas le sujet de l'article d'aujourd'hui. </p><br><p>  Aussi dans cet article je vais omettre l'installation et la configuration de base de non-clauda, ‚Äã‚Äãd'autant plus qu'il y a des mat√©riaux sur ce sujet sur Habr√©.  Mais je vais certainement montrer les param√®tres, sans lesquels Nextcloud ne fonctionnera pas pour le proxy. </p><a name="habracut"></a><br><p>  √âtant donn√©: Nextcloud est install√© sur l'h√¥te 1 et configur√© pour fonctionner via http (sans SSL), il n'a qu'une interface r√©seau locale et une adresse IP "grise" 172.16.22.110. </p><br><p>  Configurons OpenLiteSpeed ‚Äã‚Äãsur l'h√¥te 2. Il a deux interfaces, une externe (regarde sur Internet) et une interne avec une adresse IP sur le r√©seau 172.16.22.0/24 </p><br><p>  Le nom DNS cloud.connect.link m√®ne √† l'adresse IP de l'interface externe de l'h√¥te 2 </p><br><p>  T√¢che: se rendre d'Internet via le lien ' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://cloud.connect.link</a> ' (SSL) vers Nextcloud sur le r√©seau interne. </p><br><ul><li>  Installez OpenLiteSpeed ‚Äã‚Äãsur Ubuntu 18.04.2. </li></ul><br><p>  Ajoutez un r√©f√©rentiel: </p><br><blockquote>  wget -O - <a href="">http://rpms.litespeedtech.com/debian/enable_lst_debain_repo.sh</a> | sudo bash <br>  mise √† jour sudo apt-get </blockquote><p>  d√©finir, ex√©cuter: </p><br><blockquote>  sudo apt-get install openlitespeed <br>  sudo / usr / local / lsws / bin / lswsctrl start </blockquote><br><ul><li>  Minimisez le pare-feu. <br><blockquote>  sudo ufw autorise ssh <br>  sudo ufw par d√©faut autorise les sorties <br>  sudo ufw par d√©faut refuser l'entr√©e <br>  sudo ufw autorise http <br>  sudo ufw autorise https <br>  sudo ufw autorise depuis <em>votre h√¥te de gestion</em> vers n'importe quel port 7080 <br>  sudo ufw enable <br></blockquote></li><li>  Configurez OpenLiteSpeed ‚Äã‚Äãen tant que proxy inverse. <br>  Cr√©ez des r√©pertoires pour virtualhost. <br><blockquote>  cd / usr / local / lsws / <br>  sudo mkdirc cloud.connect.link <br>  cd cloud.connect.link/ <br>  sudo mkdir {conf, html, logs} <br>  sudo chown lsadm: lsadm ./conf/ <br></blockquote></li></ul><br><p>  Configurez l'h√¥te virtuel √† partir de l'interface Web LSWS. <br>  Ouvrez la gestion des URL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://cloud.connect.link:7080</a> <br>  Identifiant / mot de passe par d√©faut: admin / 123456 </p><br><p><img src="https://habrastorage.org/webt/cw/1w/he/cw1whegtkiqtmeolcucdy5poqci.png" alt="image"></p><br><p>  Ajoutez un h√¥te virtuel (H√¥tes virtuels&gt; Ajouter). </p><br><p>  Lors de l'ajout, un message d'erreur appara√Æt - il n'y a pas de fichier de configuration.  Ceci est normal, r√©solu en cliquant sur Cliquer pour cr√©er. </p><br><p><img src="https://habrastorage.org/webt/yo/_0/-p/yo_0-p7xc0c80x4bdaswadf1fpg.png" alt="image"></p><br><p>  Dans l'onglet G√©n√©ral, sp√©cifiez Document Root (bien qu'il ne soit pas n√©cessaire, la configuration ne d√©marrera pas sans elle).  Le nom de domaine, s'il n'est pas sp√©cifi√©, sera tir√© du nom d'h√¥te virtuel, que nous avons nomm√© le nom de notre domaine. </p><br><p><img src="https://habrastorage.org/webt/eo/7j/m_/eo7jm_yuk5x5plv6cimesnxxbso.png" alt="image"></p><br><p>  Il est maintenant temps de se rappeler que nous n'avons pas seulement un serveur Web, mais un proxy inverse.  Les param√®tres suivants indiquent √† LSWS ce qu'il faut proxy et o√π.  Dans les param√®tres de l'h√¥te virtuel, ouvrez l'onglet Application externe et ajoutez une nouvelle application telle qu'un serveur Web: </p><br><p><img src="https://habrastorage.org/webt/ls/_k/9q/ls_k9qnq-b83jduewm-euwucaku.png" alt="image"></p><br><p>  Indiquez le nom et l'adresse.  Le nom peut √™tre sp√©cifi√© arbitrairement, mais il doit √™tre m√©moris√©, utile dans les √©tapes suivantes.  L'adresse est l'endroit o√π Nextcloud vit sur le r√©seau interne: </p><br><p><img src="https://habrastorage.org/webt/lc/aj/ah/lcajahhbytgrbchjugfl5nz0hoq.png" alt="image"></p><br><p>  Dans les m√™mes param√®tres de l'h√¥te virtuel, ouvrez l'onglet Contexte et cr√©ez un nouveau contexte de type Proxy: </p><br><p><img src="https://habrastorage.org/webt/mj/mq/yg/mjmqyg_hy4gsxza_dcjb-sc1ldu.png" alt="image"></p><br><p>  Sp√©cifiez les param√®tres: URI = /, Web server = nextcloud_1 (nom de l'√©tape pr√©c√©dente) </p><br><p><img src="https://habrastorage.org/webt/km/e_/x9/kme_x90yobopk29vt86fymdc7uu.png" alt="image"></p><br><p>  Red√©marrez LSWS.  Cela se fait en un clic depuis l'interface web, miracles!  (le porte-souris h√©r√©ditaire parle en moi) </p><br><p><img src="https://habrastorage.org/webt/qw/vr/bl/qwvrblflsbimg6ya16ay29m_pus.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/1f/z_/p5/1fz_p5uigm1ef5sdx3vrvptniic.png" alt="image"></p><br><ul><li>  Nous mettons le certificat, configurez https. <br>  Nous allons omettre la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proc√©dure d'obtention d'un certificat</a> , convenir que nous l'avons d√©j√† et coucher avec la cl√© dans le r√©pertoire /etc/letsencrypt/live/cloud.connect.link. </li></ul><br><p>  Cr√©ez un ¬´auditeur¬ª (Listeners&gt; Add), appelez-le ¬´https¬ª.  Nous le pointons sur le port 443 et notons qu'il sera s√©curis√©: </p><br><p><img src="https://habrastorage.org/webt/ou/1q/mf/ou1qmfazgmggv1wwo1alxxtpxl8.png" alt="image"></p><br><p>  Dans l'onglet SSL, sp√©cifiez le chemin d'acc√®s √† la cl√© et au certificat: </p><br><p><img src="https://habrastorage.org/webt/tr/xg/c0/trxgc0tcpnnca9f53yvvpk2_5hq.png" alt="image"></p><br><p>  Un ¬´√©couteur¬ª a √©t√© cr√©√©, maintenant dans la section Virtual Host Mappings nous y ajoutons notre h√¥te virtuel: </p><br><p><img src="https://habrastorage.org/webt/-0/y9/2b/-0y92bbvfhdefzynyjuoipouwea.png" alt="image"></p><br><p>  Si LSWS se connecte √† un seul service, la configuration peut √™tre termin√©e.  Mais nous pr√©voyons de l'utiliser pour transf√©rer des demandes √† diff√©rentes "autorit√©s" en fonction du nom de domaine.  Et tous les domaines auront leurs propres certificats.  Par cons√©quent, vous devez acc√©der √† la configuration de virtualhost et sp√©cifier √† nouveau sa cl√© et son certificat dans l'onglet SSL.  √Ä l'avenir, cela doit √™tre fait pour chaque nouvel h√¥te virtuel. </p><br><p><img src="https://habrastorage.org/webt/us/ap/7z/usap7zccpjkyyko7llyawrkkz7g.png" alt="image"></p><br><p>  Il reste √† configurer la r√©√©criture d'URL afin que les requ√™tes http soient adress√©es √† https. </p><br><p>  <i>(Soit dit en passant, quand cela se terminera-t-il? Il est temps que les navigateurs et autres logiciels acc√®dent √† https par d√©faut et effectuent un transfert sans SSL manuellement si n√©cessaire).</i> <br>  Activer Activer la r√©√©criture et √©crire des r√®gles de r√©√©criture: </p><br><blockquote>  RewriteCond% {SERVER_PORT} 80 <br>  RewriteRule ^ (. *) $ <a href="">Https: //% {SERVER_NAME}% {REQUEST_URI</a> } [R = 301, L] </blockquote><p><img src="https://habrastorage.org/webt/ki/rn/xq/kirnxqm_dendpov7gniojwnsk7q.png" alt="image"></p><br><p>  Il est impossible d'appliquer les r√®gles de r√©√©criture avec le red√©marrage Graceful habituel en raison d'un √©trange malentendu.  Par cons√©quent, le red√©marrage de LSWS n'est pas √©l√©gant, mais grossier et efficace: </p><br><blockquote>  sudo systemctl restart lsws.service </blockquote><p>  Pour que le serveur √©coute le 80e port, cr√©ez un autre √©couteur.  Appelons-le http, sp√©cifiez le 80e port et qu'il sera non s√©curis√©: </p><br><p><img src="https://habrastorage.org/webt/k3/za/ji/k3zajihurrtkg4ddc8eabk_njuq.png" alt="image"></p><br><p>  Par analogie avec la configuration de l'√©couteur https, attachons-y notre h√¥te virtuel. </p><br><p>  Maintenant, LSWS √©coutera le 80e port et enverra des requ√™tes √† celui-ci au 443, en r√©√©crivant l'URL. <br>  En conclusion, je recommande d'abaisser le niveau de journalisation LSWS, qui est d√©fini comme Debug par d√©faut.  Dans ce mode, les journaux se multiplient √† une vitesse fulgurante!  Dans la plupart des cas, un niveau d'avertissement est suffisant.  Acc√©dez √† Configuration du serveur&gt; Journal: </p><br><p><img src="https://habrastorage.org/webt/c5/cb/pl/c5cbplov4zgqtonzcw8x6bb0poy.png" alt="image"></p><br><p>  Ceci termine la configuration d'OpenLiteSpeed ‚Äã‚Äãen tant que proxy inverse.  Encore une fois, nous red√©marrons LSWS, suivez le lien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://cloud.connect.link</a> et voyez: </p><br><p><img src="https://habrastorage.org/webt/nn/vo/_d/nnvo_dsr_qk_pzkv0j6xoixedve.png" alt="image"></p><br><p>  Pour que Nextcloud nous laisse entrer, vous devez ajouter le domaine cloud.connect.link √† la liste des domaines de confiance.  Allez √©diter config.php.  J'ai install√© Nextcloud automatiquement lors de l'installation d'Ubuntu et la configuration est ici: / var / snap / nextcloud / current / nextcloud / config. </p><br><p>  √Ä la cl√© trusted_domains, ajoutez le param√®tre 'cloud.connect.link': </p><br><blockquote>  'trusted_domains' =&gt; <br>  tableau ( <br>  0 =&gt; '172.16.22.110', <br>  1 =&gt; 'cloud.connect.link', <br>  ), </blockquote><p><img src="https://habrastorage.org/webt/ow/62/kd/ow62kdr0pbvhfqgcrj-04yvicfi.png" alt="image"></p><br><p>  De plus, dans la m√™me configuration, vous devez sp√©cifier l'adresse IP de notre proxy.  J'attire l'attention sur le fait que l'adresse doit √™tre sp√©cifi√©e, visible par le serveur Nextcloud, c'est-√†-dire  Interface locale IP LSWS.  Sans cette √©tape, l'interface Web Nextcloud fonctionne, mais les applications ne sont pas autoris√©es. </p><br><blockquote>  'trusted_proxies' =&gt; <br>  tableau ( <br>  0 =&gt; '172.16.22.100', <br>  ), </blockquote><p>  Eh bien, apr√®s cela, nous pouvons entrer dans l'interface d'autorisation: </p><br><p><img src="https://habrastorage.org/webt/ln/wk/ty/lnwktyhkca3giakan3fqnk0v7ji.png" alt="image"></p><br><p>  Le probl√®me est r√©solu!  Maintenant, chaque client peut utiliser en toute s√©curit√© le ¬´nuage de fichiers¬ª dans son URL personnelle, le serveur avec les fichiers est s√©par√© d'Internet, les futurs clients obtiendront la m√™me chose et aucune adresse IP suppl√©mentaire ne sera affect√©e. <br>  De plus, vous pouvez utiliser un proxy inverse pour fournir du contenu statique, mais dans le cas de Nextcloud, cela n'entra√Ænera pas une augmentation notable de la vitesse.  C'est donc facultatif et facultatif. </p><br><p>  Heureux de partager cette histoire, j'esp√®re que quelqu'un vous sera utile.  Si vous connaissez des m√©thodes plus √©l√©gantes et efficaces pour r√©soudre la t√¢che - je serai reconnaissant pour les commentaires! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452750/">https://habr.com/ru/post/fr452750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452740/index.html">Une s√©lection de jeux de donn√©es pour l'apprentissage automatique</a></li>
<li><a href="../fr452742/index.html">Configuration du test automatique d'une application hybride</a></li>
<li><a href="../fr452744/index.html">Existe-t-il une vie compl√®te d'un √©loign√© sans √©changes ind√©pendants?</a></li>
<li><a href="../fr452746/index.html">Le livre "L'art de la programmation dans R. Immerger dans le Big Data"</a></li>
<li><a href="../fr452748/index.html">Principes de d√©veloppement d'applications modernes √† partir de NGINX. Partie 1</a></li>
<li><a href="../fr452752/index.html">BigData fait maison. Partie 1. Pratique Spark Streaming sur un cluster AWS</a></li>
<li><a href="../fr452754/index.html">19% des images Docker les plus populaires n'ont pas de mot de passe root</a></li>
<li><a href="../fr452756/index.html">Cr√©ation de Tower Defense dans Unity: Enemies</a></li>
<li><a href="../fr452760/index.html">Vitamine D. Boire ou ne pas boire, telle est la question. (Ou une histoire sur la fa√ßon dont j'ai r√©ussi une analyse qui ne m'a pas √©t√© prescrite)</a></li>
<li><a href="../fr452762/index.html">MVCC-7. Nettoyage auto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>