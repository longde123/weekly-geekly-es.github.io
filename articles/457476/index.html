<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§òüèø üö∂üèº üßò Reducir el tama√±o de una imagen acoplable con una aplicaci√≥n de arranque por resorte üññüèΩ üñï üÉè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes 


 Recientemente, me enfrent√© a la tarea de lanzar aplicaciones Spring Boot 2 en un cl√∫ster de Kubernetes usando una imagen acoplable. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reducir el tama√±o de una imagen acoplable con una aplicaci√≥n de arranque por resorte</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457476/"><p>  Buenas tardes </p><br><p> Recientemente, me enfrent√© a la tarea de lanzar aplicaciones Spring Boot 2 en un cl√∫ster de Kubernetes usando una imagen acoplable.  Este problema no es nuevo, r√°pidamente encontr√© ejemplos en Google y empaqu√© mi aplicaci√≥n.  Me sorprendi√≥ mucho no encontrar la imagen alpina de jdk11 y esperaba que ese tama√±o fuera lo suficientemente peque√±o, pero cuando envi√© la imagen al registro de la ventana acoplable, not√© que su tama√±o era de casi 422 megabytes.  Debajo del gato hay una descripci√≥n de c√≥mo reduje la imagen de la ventana acoplable con mi bota de primavera y Java 11 a 144 megabytes. </p><br><p><img src="https://habrastorage.org/webt/zx/nk/bg/zxnkbgwnb8bdpshj6q1mypq6z0q.png"></p><a name="habracut"></a><br><h2 id="prilozhenie">  App </h2><br><p>  Como mencion√© anteriormente, mi aplicaci√≥n est√° construida usando Spring Boot 2 y es un contenedor API REST sobre una base de datos relacional (usando @RepositoryRestResource).  Mis dependencias incluyen: </p><br><pre><code class="plaintext hljs">org.springframework.boot:spring-boot-starter-data-rest org.springframework.boot:spring-boot-starter-data-jpa org.flywaydb:flyway-core org.postgresql:postgresql</code> </pre> <br><p>  El archivo jar recopilado tiene un tama√±o de 37,6 megabytes. </p><br><p>  Dockerfile: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim WORKDIR /home/demo ARG REVISION COPY target/spring-boot-app-${REVISION}.jar app.jar ENTRYPOINT ["java","-jar","app.jar"]</code> </pre> <br><p>  Como resultado del ensamblaje, obtengo una imagen de tama√±o: 422 mb de acuerdo con la salida del comando docker images.  Curiosamente, cuando se utiliza la imagen obsoleta de 8-jdk-slim, el tama√±o se reduce a 306 mb. </p><br><h2 id="popytka-1-drugoy-bazovyy-obraz">  Intento 1: otra imagen b√°sica </h2><br><p>  El primer paso l√≥gico fue un intento de encontrar una imagen m√°s ligera, preferiblemente basada en alpino.  Escane√© los repositorios Java m√°s populares: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://hub.docker.com/_/openjdk</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk11</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk11-openj9</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk8</a> </li></ul><br><p>  (11 como la versi√≥n actual de LTS y 8 ya que todav√≠a hay una cantidad suficiente de aplicaciones que no podr√≠an migrar a versiones m√°s modernas) </p><br><p>  Una tabla con im√°genes y etiquetas (~ 2700), sus tama√±os al momento de escribir est√° disponible <a href="">aqu√≠</a> </p><br><p>  Aqu√≠ hay algunos de ellos: </p><br><pre> <code class="plaintext hljs">openjdk 8 488MB openjdk 8-slim 269MB openjdk 8-alpine 105MB openjdk 8-jdk-slim 269MB openjdk 8-jdk-alpine 105MB openjdk 8-jre 246MB openjdk 8-jre-slim 168MB openjdk 8-jre-alpine 84.9MB openjdk 11 604MB openjdk 11-slim 384MB openjdk 11-jdk 604MB openjdk 11-jdk-slim 384MB openjdk 11-jre 479MB openjdk 11-jre-slim 273MB adoptopenjdk/openjdk8 alpine 221MB adoptopenjdk/openjdk8 alpine-slim 89.7MB adoptopenjdk/openjdk8 jre 200MB adoptopenjdk/openjdk8 alpine-jre 121MB adoptopenjdk/openjdk11 alpine 337MB adoptopenjdk/openjdk11 alpine-slim 246MB adoptopenjdk/openjdk11 jre 218MB adoptopenjdk/openjdk11 alpine-jre 140MB</code> </pre> <br><p>  Por lo tanto, si cambia la imagen base a adoptopenjdk / openjdk11: alpine-jre, puede reducir la imagen con la aplicaci√≥n a 177 mb. </p><br><h2 id="popytka-2-custom-runtime">  Intento 2: tiempo de ejecuci√≥n personalizado </h2><br><p>  Desde el lanzamiento de jdk9 y la modularizaci√≥n, fue posible construir su propio tiempo de ejecuci√≥n que contiene solo los m√≥dulos que son necesarios para su aplicaci√≥n.  Puede leer m√°s sobre esta funcionalidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><p>  Intentemos determinar los m√≥dulos necesarios para la aplicaci√≥n de arranque de prueba de primavera: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s target/app-1.0.0.jar app-1.0.0.jar -&gt; java.base app-1.0.0.jar -&gt; java.logging app-1.0.0.jar -&gt; not found</code> </pre> <br><p>  Ok, parece que jdeps no puede manejar el fat-jar creado con Spring Boot, pero podemos descomprimir el archivo y escribir el classpath: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: byte-buddy-1.9.12.jar is a multi-release jar file but --multi-release option is not set ~/app ·êÖ jdeps -s --multi-release 11 -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: aspectjweaver-1.9.2.jar is not a multi-release jar file but --multi-release option is set</code> </pre> <br><p>  En este sentido, actualmente hay un error abierto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://bugs.openjdk.java.net/browse/JDK-8207162</a> </p><br><p>  Intent√© descargar jdk12 para obtener esta informaci√≥n, pero me encontr√© con el siguiente error: </p><br><pre> <code class="plaintext hljs">Exception in thread "main" com.sun.tools.classfile.Dependencies$ClassFileError ... Caused by: com.sun.tools.classfile.ConstantPool$InvalidEntry: unexpected tag at #1: 53</code> </pre> <br><p>  Por prueba, error y b√∫squeda de m√≥dulo por ClassNotFoundException, determin√© que mi aplicaci√≥n necesita los siguientes m√≥dulos: </p><br><ul><li>  java.base </li><li>  java.logging </li><li>  java.sql </li><li>  java.naming </li><li>  java.management </li><li>  java.instrument </li><li>  java.desktop </li><li>  java.security.jgss </li></ul><br><p>  Rantime para ellos se puede recolectar usando: </p><br><pre> <code class="plaintext hljs">jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime</code> </pre> <br><p>  Intentemos construir una imagen de acoplador b√°sica usando estos m√≥dulos: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime RUN ln -s /usr/lib/jvm/spring-boot-runtime/bin/java /usr/bin/java</code> </pre> <br><p>  y rec√≥gelo: </p><br><pre> <code class="plaintext hljs">docker build . -t spring-boot-runtime:openjdk-11-slim</code> </pre> <br><p>  Como resultado, el tama√±o era de 106 megabytes, que es significativamente m√°s peque√±o que la mayor√≠a de las im√°genes base encontradas con openjdk.  Si lo usa para mi aplicaci√≥n, el tama√±o resultante ser√° de 144 megabytes. </p><br><p>  Adem√°s, podemos usar <code>spring-boot-runtime:openjdk-11-slim</code> como imagen base para todas las aplicaciones de arranque de primavera si tienen dependencias similares.  En el caso de varias dependencias, es posible utilizar un ensamblaje de imagen de varias etapas para cada una de las aplicaciones en las que se recopilar√° el tiempo de ejecuci√≥n de Java en la primera etapa, y el archivo con la aplicaci√≥n se agregar√° en la segunda. </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,YOUR_MODULES --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime WORKDIR /home/demo ARG REVISION COPY target/app-${REVISION}.jar app.jar ENTRYPOINT ["/usr/lib/jvm/spring-boot-runtime/bin/java","-jar","app.jar"]</code> </pre> <br><h2 id="vyvod">  Conclusi√≥n </h2><br><p>  Actualmente, la mayor√≠a de las im√°genes de Docker para Java tienen un volumen lo suficientemente grande, lo que puede afectar negativamente el tiempo de inicio de la aplicaci√≥n, especialmente si las capas necesarias a√∫n no est√°n en el servidor.  Usando etiquetas con jre o usando la modularizaci√≥n de java, puede construir su propio tiempo de ejecuci√≥n, lo que reducir√° significativamente el tama√±o de la imagen de la aplicaci√≥n. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457476/">https://habr.com/ru/post/457476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457462/index.html">Uber: descripci√≥n general de los algoritmos clave de gesti√≥n de la plataforma</a></li>
<li><a href="../457464/index.html">Deduplicaci√≥n de anuncios en Yandex.Real Estate</a></li>
<li><a href="../457466/index.html">C√≥mo desarrollamos TI en Leroy Merlin: reconstruyendo un motor sobre la marcha</a></li>
<li><a href="../457468/index.html">Memoria universal: SRAM, DRAM y memoria flash en una botella</a></li>
<li><a href="../457470/index.html">Matem√°ticas de la hoja: c√≥mo un arbusto inusual cambi√≥ la ecuaci√≥n de un modelo de crecimiento de plantas</a></li>
<li><a href="../457480/index.html">Crear una aplicaci√≥n de escucha para ver el tr√°fico MMORPG m√≥vil</a></li>
<li><a href="../457490/index.html">Aisioshechka de Zuckerberg - brevemente y en el caso de Libra</a></li>
<li><a href="../457494/index.html">"Y si no s√© matem√°ticas, ¬øestoy desesperado?" - especialistas responden preguntas frecuentes sobre profesiones en ciencia de datos</a></li>
<li><a href="../457496/index.html">"Encuentra las cinco diferencias". Diferencia escalable y generacional: nuevo lote de pruebas</a></li>
<li><a href="../457500/index.html">C√≥mo hicimos el piloto autom√°tico para una estaci√≥n de servicio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>