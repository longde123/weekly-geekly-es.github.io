<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïó üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë© ‚û°Ô∏è Solicitud-respuesta sincr√≥nica usando Apache Kafka üì∏ ‚ùî üòÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Event Driven Architecture en general, y Apache Kafka en particular, han atra√≠do mucha atenci√≥n recientemente. Para aprovechar al m√°ximo la arquitectur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solicitud-respuesta sincr√≥nica usando Apache Kafka</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476156/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Event Driven Architecture</a> en general, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apache Kafka</a> en particular, han atra√≠do mucha atenci√≥n recientemente.  Para aprovechar al m√°ximo la arquitectura controlada por eventos, el mecanismo de delegaci√≥n de eventos debe ser esencialmente as√≠ncrono.  Sin embargo, puede haber algunos escenarios / flujos de uso espec√≠ficos que requieren la sem√°ntica de una <b>solicitud-respuesta sincr√≥nica</b> .  Esta versi√≥n muestra c√≥mo implementar <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Solicitud-Respuesta</a></b> usando <b>Apache Kafka</b> . <br><br>  Traducido por <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@middle_java</a></b> <br><a name="habracut"></a><br>  Fecha del art√≠culo original: 26 de octubre de 2018 <br><br>  Apache Kafka es inherentemente as√≠ncrono.  Por lo tanto, <b>la</b> sem√°ntica de <b>Solicitud-Respuesta</b> para Apache Kafka no es natural.  Sin embargo, este desaf√≠o no es nuevo.  El patr√≥n de integraci√≥n <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">-solicitud de respuesta</a></b> empresarial proporciona un mecanismo probado para la mensajer√≠a sincr√≥nica a trav√©s de canales asincr√≥nicos: <br><br><img src="https://habrastorage.org/webt/ww/cy/0h/wwcy0hvrj6iie7amwxpk1twfbui.gif"><br><br>  El patr√≥n de <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">direcci√≥n de retorno</a></b> complementa el patr√≥n de <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solicitud-respuesta</a></b> con un mecanismo para que el solicitante indique la direcci√≥n a la que se debe enviar la respuesta: <br><br><img src="https://habrastorage.org/webt/rw/nd/qq/rwndqqxh42kt82xadcbvgjb76wa.gif"><br><br>  Recientemente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Spring Kafka</a> <b>2.1.3</b> agreg√≥ soporte desde el cuadro de patr√≥n Solicitud Solicitud, y en la versi√≥n <b>2.2</b> se puli√≥ parte de su aspereza.  Veamos c√≥mo funciona este soporte: <br><br><h2>  Lado del cliente: ReplyingKafkaTemplate </h2><br>  La conocida abstracci√≥n de la <b>Plantilla</b> forma la base para la parte del cliente del mecanismo de Solicitud-Respuesta en Spring. <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReplyingKafkaTemplate &lt; String, Request, Reply &gt; replyKafkaTemplate( ProducerFactory &lt; String, Request &gt; pf, KafkaMessageListenerContainer &lt; String, Reply &gt; lc) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplyingKafkaTemplate &lt; &gt; (pf, lc); }</code> </pre> <br>  Aqu√≠ todo es bastante sencillo: configuramos <b>ReplyingKafkaTemplate</b> , que env√≠a mensajes de solicitud con claves de cadena y recibe mensajes de respuesta con claves de cadena.  Sin embargo, ReplyingKafkaTemplate debe basarse en la solicitud ProducerFactory, la respuesta ConsumerFactory y el MessageListenerContainer con las configuraciones apropiadas de consumidor y productor.  Por lo tanto, la configuraci√≥n requerida es bastante pesada: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">"${kafka.topic.car.reply}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String replyTopic; <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map &lt; String, Object &gt; consumerConfigs() { Map &lt; String, Object &gt; props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap &lt; &gt; (); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class); props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> props; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map &lt; String, Object &gt; producerConfigs() { Map &lt; String, Object &gt; props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap &lt; &gt; (); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> props; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ProducerFactory &lt; String, Request &gt; requestProducerFactory() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultKafkaProducerFactory &lt; &gt; (producerConfigs()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConsumerFactory &lt; String, Reply &gt; replyConsumerFactory() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultKafkaConsumerFactory &lt; &gt; (consumerConfigs(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringDeserializer(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializer &lt; Reply &gt; ()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KafkaMessageListenerContainer &lt; String, Reply &gt; replyListenerContainer() { ContainerProperties containerProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerProperties(replyTopic); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KafkaMessageListenerContainer &lt; &gt; (replyConsumerFactory(), containerProperties); }</code> </pre> <br>  En este caso, el uso de <b>replyKafkaTemplate</b> para enviar una solicitud s√≠ncrona y recibir una respuesta es la siguiente: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">"${kafka.topic.car.request}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String requestTopic; <span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">"${kafka.topic.car.reply}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String replyTopic; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReplyingKafkaTemplate &lt; String, Request, Reply &gt; requestReplyKafkaTemplate; ... RequestReply request = RequestReply.request(...); <span class="hljs-comment"><span class="hljs-comment">// producer record ProducerRecord &lt; String, Request &gt; record = new ProducerRecord &lt; String, Request &gt; (requestTopic, request); //       record.headers().add(new RecordHeader(KafkaHeaders.REPLY_TOPIC, requestReplyTopic.getBytes())); //     Kafka          RequestReplyFuture &lt; String, Request, Reply &gt; sendAndReceive = requestReplyKafkaTemplate.sendAndReceive(record); sendAndReceive.addCallback(new ListenableFutureCallback &lt; ConsumerRecord &lt; String, Reply &gt;&gt; () { @Override public void onSuccess(ConsumerRecord &lt; String, Reply &gt; result) { //   consumer record Reply reply = result.value(); System.out.println("Reply: " + reply.toString()); } });</span></span></code> </pre> <br>  Tambi√©n hay una gran cantidad de repeticiones y una API de bajo nivel, e incluso esta obsoleta API <b>ListenableFuture en</b> lugar de la <b>CompletableFuture</b> moderna. <br><br>  <b>requestReplyKafkaTemplate</b> se encarga de generar y configurar el encabezado <b>KafkaHeaders.CORRELATION_ID</b> , pero debemos establecer expl√≠citamente el encabezado <b>KafkaHeaders.REPLY_TOPIC</b> para la solicitud.  Tenga en cuenta tambi√©n que el mismo tema para la respuesta fue demasiado involuntario anteriormente en <b>replyListenerContainer</b> .  Un poco de esti√©rcol.  No es exactamente lo que esperaba de la abstracci√≥n de primavera. <br><br><h2>  Lado del servidor: @SendTo </h2><br>  En el lado del servidor, el <b>KafkaListener</b> habitual que escucha el tema de la solicitud se decora adicionalmente con la anotaci√≥n <b>@SendTo</b> para proporcionar un mensaje de respuesta.  El objeto devuelto por el m√©todo de escucha se ajusta autom√°ticamente en el mensaje de respuesta, <b>se</b> agrega <b>CORRELATION_ID</b> y la respuesta se publica en el tema especificado en el encabezado <b>REPLY_TOPIC</b> . <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map &lt; String, Object &gt; consumerConfigs() { Map &lt; String, Object &gt; props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap &lt; &gt; (); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonSerializer.class); props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> props; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map &lt; String, Object &gt; producerConfigs() { Map &lt; String, Object &gt; props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap &lt; &gt; (); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> props; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConsumerFactory &lt; String, Request &gt; requestConsumerFactory() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultKafkaConsumerFactory &lt; &gt; (consumerConfigs(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringDeserializer(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializer &lt; Request &gt; ()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KafkaListenerContainerFactory &lt; ConcurrentMessageListenerContainer &lt; String, Request &gt;&gt; requestListenerContainerFactory() { ConcurrentKafkaListenerContainerFactory &lt; String, Request &gt; factory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentKafkaListenerContainerFactory &lt; &gt; (); factory.setConsumerFactory(requestConsumerFactory()); factory.setReplyTemplate(replyTemplate()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> factory; } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ProducerFactory &lt; String, Reply &gt; replyProducerFactory() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultKafkaProducerFactory &lt; &gt; (producerConfigs()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KafkaTemplate &lt; String, Reply &gt; replyTemplate() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KafkaTemplate &lt; &gt; (replyProducerFactory()); }</code> </pre> <br>  Aqu√≠ tambi√©n se requiere alguna configuraci√≥n, pero la configuraci√≥n del oyente es m√°s simple: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@KafkaListener</span></span>(topics = <span class="hljs-string"><span class="hljs-string">"${kafka.topic.car.request}"</span></span>, containerFactory = <span class="hljs-string"><span class="hljs-string">"requestListenerContainerFactory"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@SendTo</span></span>() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Reply </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request request)</span></span></span><span class="hljs-function"> </span></span>{ Reply reply = ...; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reply; }</code> </pre> <br><h2>  ¬øPero qu√© pasa con m√∫ltiples instancias del consumidor? </h2><br>  Todo parece funcionar hasta que usamos varias instancias del consumidor.  Si tenemos varias instancias de cliente, debemos asegurarnos de que la respuesta se env√≠e a la instancia de cliente correcta.  La documentaci√≥n de Spring Kafka supone que cada consumidor puede usar un tema √∫nico o que se env√≠a un valor de encabezado <b>KafkaHeaders</b> adicional con la solicitud. <b>RESPONSE_PARTITION</b> es un campo de cuatro bytes que contiene una representaci√≥n BIG-ENDIAN del n√∫mero de secci√≥n entero.  El uso de temas separados para diferentes clientes claramente no es muy flexible, por lo que elegimos la configuraci√≥n expl√≠cita <b>REPLY_PARTITION</b> .  Entonces el cliente debe saber a qu√© partici√≥n est√° asignado.  La documentaci√≥n sugiere usar una configuraci√≥n expl√≠cita para seleccionar una partici√≥n particular.  A√±√°dalo a nuestro ejemplo: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Value</span></span>(<span class="hljs-string"><span class="hljs-string">"${kafka.topic.car.reply.partition}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> replyPartition; ... <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KafkaMessageListenerContainer &lt; String, RequestReply &gt; replyListenerContainer() { ContainerProperties containerProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerProperties(replyTopic); TopicPartitionInitialOffset initialOffset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TopicPartitionInitialOffset(replyTopic, replyPartition); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KafkaMessageListenerContainer &lt; &gt; (replyConsumerFactory(), containerProperties, initialOffset); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] intToBytesBigEndian(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] { (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), }; } ... record.headers().add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RecordHeader(KafkaHeaders.REPLY_TOPIC, requestReplyTopic.getBytes())); record.headers().add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RecordHeader(KafkaHeaders.REPLY_PARTITION, intToBytesBigEndian(replyPartition))); RequestReplyFuture &lt; String, RequestReply, RequestReply &gt; sendAndReceive = requestReplyKafkaTemplate.sendAndReceive(record); ...</code> </pre> <br>  No es muy bonita, pero funciona.  La configuraci√≥n requerida es extensa y la API parece de bajo nivel.  La necesidad de configurar particiones expl√≠citamente complica el proceso de escalar din√°micamente el n√∫mero de clientes.  Obviamente, puedes hacerlo mejor. <br><br><h2>  Encapsulando el procesamiento de temas para respuesta y partici√≥n </h2><br>  Comencemos encapsulando el patr√≥n de <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Direcci√≥n de retorno</a></b> , pasando el tema de la respuesta y la partici√≥n.  El tema de la respuesta debe inyectarse en <b>RequestReplyTemplate</b> y, por lo tanto, no debe estar presente en la API.  Cuando se trata de particiones para una respuesta, haremos lo contrario: extraer las particiones asignadas al oyente del tema para la respuesta y transferir esta partici√≥n autom√°ticamente.  Esto elimina la necesidad de que el cliente se encargue de estos encabezados. <br>  Al mismo tiempo, hagamos que la API se parezca al <b>KafkaTemplate</b> est√°ndar (sobrecargue el m√©todo <b>sendAndReceive () con</b> par√°metros simplificados y agregue los m√©todos sobrecargados correspondientes utilizando el tema predeterminado) <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PartitionAwareReplyingKafkaTemplate</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">K</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReplyingKafkaTemplate</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">K</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class"> &gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PartitionAwareReplyingKafkaTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProducerFactory &lt; K, V &gt; producerFactory, GenericMessageListenerContainer &lt; K, R &gt; replyContainer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(producerFactory, replyContainer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TopicPartition </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFirstAssignedReplyTopicPartition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getAssignedReplyTopicPartitions() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; getAssignedReplyTopicPartitions().iterator().hasNext()) { TopicPartition replyPartition = getAssignedReplyTopicPartitions().iterator().next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.isDebugEnabled()) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.debug(<span class="hljs-string"><span class="hljs-string">"Using partition "</span></span> + replyPartition.partition()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> replyPartition; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KafkaException(<span class="hljs-string"><span class="hljs-string">"Illegal state: No reply partition is assigned to this instance"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] intToBytesBigEndian(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] { (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((data &gt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>), }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RequestReplyFuture &lt; K, V, R &gt; sendAndReceiveDefault(<span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> V data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sendAndReceive(getDefaultTopic(), data); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RequestReplyFuture &lt; K, V, R &gt; sendAndReceiveDefault(K key, <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> V data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sendAndReceive(getDefaultTopic(), key, data); } ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RequestReplyFuture &lt; K, V, R &gt; sendAndReceive(String topic, <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> V data) { ProducerRecord &lt; K, V &gt; record = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProducerRecord &lt; &gt; (topic, data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doSendAndReceive(record); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RequestReplyFuture &lt; K, V, R &gt; sendAndReceive(String topic, K key, <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> V data) { ProducerRecord &lt; K, V &gt; record = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProducerRecord &lt; &gt; (topic, key, data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doSendAndReceive(record); } ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RequestReplyFuture &lt; K, V, R &gt; sendAndReceive(ProducerRecord &lt; K, V &gt; record) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doSendAndReceive(record); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> RequestReplyFuture &lt; K, V, R &gt; doSendAndReceive(ProducerRecord &lt; K, V &gt; record) { TopicPartition replyPartition = getFirstAssignedReplyTopicPartition(); record.headers() .add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RecordHeader(KafkaHeaders.REPLY_TOPIC, replyPartition.topic().getBytes())) .add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RecordHeader(KafkaHeaders.REPLY_PARTITION, intToBytesBigEndian(replyPartition.partition()))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.sendAndReceive(record); } }</code> </pre> <br>  Siguiente paso: Adaptar el <b>ListenableFuture</b> al <b>CompletableFuture</b> m√°s moderno. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompletableFutureReplyingKafkaTemplate</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">K</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PartitionAwareReplyingKafkaTemplate</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">K</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class"> &gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompletableFutureReplyingKafkaTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProducerFactory &lt; K, V &gt; producerFactory, GenericMessageListenerContainer &lt; K, R &gt; replyContainer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(producerFactory, replyContainer); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CompletableFuture &lt; R &gt; requestReplyDefault(V value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adapt(sendAndReceiveDefault(value)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CompletableFuture &lt; R &gt; requestReplyDefault(K key, V value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adapt(sendAndReceiveDefault(key, value)); } ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CompletableFuture &lt; R &gt; requestReply(String topic, V value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adapt(sendAndReceive(topic, value)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CompletableFuture &lt; R &gt; requestReply(String topic, K key, V value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adapt(sendAndReceive(topic, key, value)); } ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CompletableFuture &lt; R &gt; adapt(RequestReplyFuture &lt; K, V, R &gt; requestReplyFuture) { CompletableFuture &lt; R &gt; completableResult = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompletableFuture &lt; R &gt; () { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mayInterruptIfRunning)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> result = requestReplyFuture.cancel(mayInterruptIfRunning); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.cancel(mayInterruptIfRunning); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }; <span class="hljs-comment"><span class="hljs-comment">//       requestReplyFuture.getSendFuture().addCallback(new ListenableFutureCallback &lt; SendResult &lt; K, V &gt;&gt; () { @Override public void onSuccess(SendResult &lt; K, V &gt; sendResult) { // NOOP } @Override public void onFailure(Throwable t) { completableResult.completeExceptionally(t); } }); //     requestReplyFuture.addCallback(new ListenableFutureCallback &lt; ConsumerRecord &lt; K, R &gt;&gt; () { @Override public void onSuccess(ConsumerRecord &lt; K, R &gt; result) { completableResult.complete(result.value()); } @Override public void onFailure(Throwable t) { completableResult.completeExceptionally(t); } }); return completableResult; } }</span></span></code> </pre> <br>  Empaquetaremos esto en una biblioteca de utilidades y ahora tenemos una API que es mucho m√°s consistente con <b>la</b> filosof√≠a de dise√±o principal de Spring, <b>"Convenci√≥n sobre configuraci√≥n"</b> .  Aqu√≠ est√° el c√≥digo final del cliente: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CompletableFutureReplyingKafkaTemplate &lt; String, Request, Reply &gt; requestReplyKafkaTemplate; ... requestReplyKafkaTemplate.requestReply(request).thenAccept(reply - &gt; System.out.println(<span class="hljs-string"><span class="hljs-string">"Reply: "</span></span> + reply.toString()); );</code> </pre> <br><h2>  Para resumir </h2><br>  Para resumir, Spring for Kafka 2.2 proporciona una implementaci√≥n completamente funcional del patr√≥n de <b>Solicitud-Respuesta</b> en Apache Kafka, pero la API todav√≠a tiene algunas asperezas.  En este n√∫mero, vimos que algunas abstracciones y adaptaciones adicionales de la API pueden proporcionar una API de alto nivel m√°s l√≥gica. <br><br>  <b>Advertencia 1:</b> <br>  Una de las principales ventajas de una arquitectura basada en eventos es el desacoplamiento de los productores y consumidores de eventos, lo que hace posible crear sistemas mucho m√°s flexibles y en evoluci√≥n.  El uso de la sem√°ntica s√≠ncrona "Solicitud-Respuesta" es exactamente lo contrario cuando las partes solicitantes y las que responden est√°n fuertemente relacionadas.  Por lo tanto, debe usarse solo si es necesario. <br><br>  <b>Advertencia 2:</b> <br>  Si se requiere una <b>solicitud-respuesta sincr√≥nica</b> , entonces el <b>protocolo</b> basado en <b>HTTP es</b> mucho m√°s simple y m√°s eficiente que usar <b>un canal as√≠ncrono como Apache Kafka</b> . <br>  Sin embargo, puede haber escenarios en los que tenga sentido una <b>solicitud-respuesta sincr√≥nica a trav√©s de Kafka</b> .  Razonablemente elija la mejor herramienta para el trabajo. <br><br>  Puede encontrar un ejemplo completamente funcional en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/callistaenterprise/blog-synchronous-kafka</a> . <br><br><h2>  Comentarios </h2><br>  <i>Federico ‚Ä¢ Hace 7 meses</i> <br>  ¬øY cuando tenemos necesidades h√≠bridas, por ejemplo, en el 50% de los casos necesitamos una solicitud de respuesta y en el 50% necesitamos la gesti√≥n de eventos?  ¬øC√≥mo hacemos esto?  La configuraci√≥n que necesita Spring Kafka se ve bastante horrible. <br><br>  <i>Jehanzeb Qayyum ‚Ä¢ Hace 6 meses</i> <br>  Spring ahora tiene soporte predeterminado usando particiones en un tema com√∫n para la respuesta. <br><br>  A partir de la versi√≥n 2.2, la plantilla intenta determinar el tema para la respuesta o partici√≥n desde el contenedor de respuesta configurado (contenedor de respuesta). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://docs.spring.io/spring-kafka/reference/html/#replying-template</a> <br><br>  <i>nir rozenberg ‚Ä¢ Hace 8 meses</i> <br>  Hola <br>  En el √∫ltimo p√°rrafo, escribi√≥ que puede haber escenarios en los que una solicitud-respuesta sincr√≥nica a trav√©s de Kafka tiene sentido en comparaci√≥n con HTTP. <br>  ¬øPuedes dar ejemplos de tales escenarios? <br>  Gracias <br>  Nir <br><br>  <i>Janne Keskitalo nir rozenberg ‚Ä¢ Hace 8 meses</i> <br>  Vamos a dividir un sistema de procesamiento de transacciones de gran volumen en varios microservicios, y tengo la idea de usar el mensaje de Solicitud-Respuesta de Kafka para lograr una afinidad de procesamiento similar.  B√°sicamente, Kafka se utiliza para enrutar todas las llamadas de un cliente al mismo proceso del procesador de transacciones, que luego las ejecuta secuencialmente de una en una.  Este tipo de procesamiento garantiza la linealizaci√≥n ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://stackoverflow.com/a/19515375/7430325</a> ), conectividad causal y tambi√©n permite un almacenamiento en cach√© eficiente.  Esencialmente, los esfuerzos de coordinaci√≥n se transferir√≠an de la base de datos a Kafka, y podr√≠amos iniciar la base de datos en modo de aislamiento estricto serializable. <br>  Todav√≠a tengo que profundizar en los detalles de nuestra sem√°ntica de transacciones para ver d√≥nde se queda corto, as√≠ que esto es solo una idea. <br><br>  Traducido por <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@middle_java</a></b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/476156/">https://habr.com/ru/post/476156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../476140/index.html">¬øC√≥mo mejorar la escucha si conoces 7000 palabras pero no las entiendes de o√≠do?</a></li>
<li><a href="../476142/index.html">¬øPor qu√© evitar el uso de excepciones para controlar su flujo en Java?</a></li>
<li><a href="../476144/index.html">C√≥mo necesitas y no necesitas escribir un chat para bots usando el ejemplo de mi bot para jugar a Secret Santa</a></li>
<li><a href="../476146/index.html">C√≥mo escalar centros de datos. Informe Yandex</a></li>
<li><a href="../476148/index.html">postfix + dovecot + mysql en FreeBSD</a></li>
<li><a href="../476160/index.html">El nacimiento del software educativo y su historia: de las m√°quinas mec√°nicas a las primeras computadoras</a></li>
<li><a href="../476162/index.html">Creamos una aplicaci√≥n web moderna. Conocimiento del proyecto y preparaci√≥n para el trabajo. Parte 1</a></li>
<li><a href="../476164/index.html">"Esto tambi√©n es an√°lisis de datos". Hable sobre bioinform√°tica con Mikhail Gelfand</a></li>
<li><a href="../476166/index.html">"Real Iron Man" rompi√≥ un r√©cord de velocidad de vuelo</a></li>
<li><a href="../476172/index.html">SOMBRERO NEGRO Conferencia de Estados Unidos. Hazte rico o muere: gana dinero en Internet con Black Hat. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>