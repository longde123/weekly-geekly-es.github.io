<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöä üòñ üòå Batalha de MERGE. Cr√¥nica com conclus√µes e moralidade üçÉ üëáüèæ ‚õπüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algumas semanas antes do importante festival de commit - o √∫ltimo antes da vers√£o de feature freeze do PostgreSQL 11 - os boletins de hackers , compri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Batalha de MERGE. Cr√¥nica com conclus√µes e moralidade</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/412605/"> Algumas semanas antes do importante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">festival de commit</a> - o √∫ltimo antes da vers√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>feature freeze</code></a> do <b>PostgreSQL 11</b> - os boletins de <b>hackers</b> , comprimindo o chipset no pacote esquerdo, assistiram ao thriller da <b>MERGE</b> .  O diretor de suspense e CEO da <b>2ndQuadrant, <i>Simon Riggs</i></b> , tentou <b>lan√ßar</b> um patch que implementa a sintaxe do comando MERGE com impressionante perseveran√ßa e engenhosidade.  Riggs √© um comediante desde 2009 e, com o status de comediante, voc√™ pode aprovar patches.  Ele foi criticado por comit√™s e veteranos do PostgreSQL n√£o menos respeitados.  As paix√µes fervilhavam de forma clara e impl√≠cita, nem chegou a insultar diretamente - um fato surpreendente para os frequentadores de muitos f√≥runs dom√©sticos.  No entanto, alguma tens√£o permaneceu at√© agora quando a quest√£o foi resolvida, e n√£o h√° nada para discutir. <a name="habracut"></a><br><br>  Mas paix√µes s√£o paix√µes (elas ser√£o discutidas mais adiante), e eu gostaria de separar desapaixonadamente a ess√™ncia desse problema completamente rebuscado. <br><br><img src="https://habrastorage.org/webt/t5/zc/ra/t5zcramwnjffszncwjkkkl9xt2g.jpeg"><br><h3>  MERGE fora </h3><br>  Se √© completamente simplificador, o problema √© o seguinte: temos 2 tabelas com os mesmos campos e dados diferentes.  Suponha nome e idade.  Precisamos combin√°-los em um.  Mas seria necess√°rio decidir o que fazer com as personalidades que est√£o nas duas tabelas.  O mais prov√°vel √© que desejemos tudo na mesa final e atualizemos as informa√ß√µes para corresponder aos indiv√≠duos.  √â claro que, mesmo nesse cen√°rio, essa √© uma tarefa muito comum.  Pode ser resolvido sem <code>MERGE</code> , fazendo uma solicita√ß√£o complexa, voc√™ pode usar gatilhos e assim por diante.  Mas √© inconveniente.  No entanto, a vers√£o n√£o can√¥nica do MERGE, chamada UPSERT (UPdate + inSERT), resolve esse problema. <br><br>  O operador MERGE est√° no padr√£o SQL-2003 e j√° est√° em toda a sua gl√≥ria no SQL-2008.  √â implementado no Oracle, DB2 e no MS SQL, o que significa que a falta de MERGE incomodar√° aqueles que est√£o pensando em mudar desses DBMSs para o PostgreSQL.  O desejo de Simon Riggs o mais r√°pido poss√≠vel, j√° no PostgreSQL 11, foi alimentado pelos desejos dos clientes do 2ndQuadrant, e n√£o pela ambi√ß√£o ou brigas. <br><br>  De fato, o MERGE possui recursos avan√ßados, os dados n√£o precisam ser extra√≠dos de tabelas, especialmente de estruturas similares. <br><br>  A sintaxe do comando √© a seguinte: <br><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tablename <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> table_reference <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (condition) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> column1 = value1 [, column2 = value2 ...] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (column1 [, column2 ...]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (value1 [, value2 ...]);</code> </pre> <br>  Voc√™ pode, no entanto, assim: <br><br><pre> <code class="hljs powershell">MERGE <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">hint</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">INTO</span></span></span></span> <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">schema</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">.</span></span></span><span class="hljs-function">] {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">table</span></span></span></span> | view} <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">table_alias</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USING</span></span></span></span> { subquery | <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">schema</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">.</span></span></span><span class="hljs-function">] { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">table</span></span></span></span> | view}} <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">table_alias</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ON</span></span></span></span> ( condition ) [ <span class="hljs-type"><span class="hljs-type">merge_update_clause</span></span> ] [ <span class="hljs-type"><span class="hljs-type">merge_insert_clause</span></span> ] [ <span class="hljs-type"><span class="hljs-type">error_logging_clause</span></span> ] ;</code> </pre> <br>  Essa sintaxe √© implementada no Oracle.  Em palavras, MERGE executa a√ß√µes que modificam os registros na tabela de destino target_table_name usando data_source em um √∫nico comando SQL, que pode, de acordo com as condi√ß√µes, INSERT, UPDATE ou DELETE com rela√ß√£o aos registros em target_table_name.  Nesse caso, target_table_name pode ser uma visualiza√ß√£o e data_source pode ser um conjunto de <b>tabelas ou visualiza√ß√µes, o resultado de uma subconsulta</b> . <br><br>  Primeiro, a <code>MERGE</code> executa uma <code>left outer join</code> no <code>data_source</code> com <code>target_table_name</code> , sugerindo 0 ou mais registros de altera√ß√£o de candidatos;  <code>WHEN</code> cl√°usulas <code>WHEN</code> s√£o calculadas na ordem especificada;  assim que a condi√ß√£o for atendida, a a√ß√£o correspondente ser√° executada.  Palavras-chave <code>WHEN [NOT] MATCH THEN</code> n√£o √© muito comum no <code>SQL</code> , portanto, lembramos que essa √© uma constru√ß√£o de controle como <code>if-else</code> em outros idiomas.  <code>MERGE</code> atua da mesma maneira que <code>UPDATE, INSERT</code> ou <code>DELETE</code> em rela√ß√£o a <code>target_table_name</code> , apenas a sintaxe de todo o comando √© diferente. <br><br>  Uma cl√°usula com <code>ON</code> deve fazer uma conex√£o em todas as colunas da chave prim√°ria ou, se outras colunas forem especificadas, algum √≠ndice exclusivo deve ser usado para que as condi√ß√µes <code>[NOT] MATCHED</code> determinem imediatamente as a√ß√µes do registro candidato, a fim de excluir a intera√ß√£o com outras transa√ß√µes. <br><br>  Comando determin√≠stico <code>MERGE</code> : voc√™ n√£o pode atualizar o mesmo registro v√°rias vezes no mesmo comando MERGE. <br>  Um exemplo: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> CustomerAccount CA <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> RecentTransactions T <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> T.CustomerId = CA.CustomerId <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> Balance = Balance + TransactionValue <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (CustomerId, Balance) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (T.CustomerId, T.TransactionValue);</code> </pre> <br>  ou com uma subconsulta: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> bonuses D <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> employee_id, salary, department_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> department_id = <span class="hljs-number"><span class="hljs-number">80</span></span>) S <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (D.employee_id = S.employee_id) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> D.bonus = D.bonus + S.salary*<span class="hljs-number"><span class="hljs-number">.01</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (S.salary &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (D.employee_id, D.bonus) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (S.employee_id, S.salary*<span class="hljs-number"><span class="hljs-number">.01</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (S.salary &lt;= <span class="hljs-number"><span class="hljs-number">8000</span></span>);</code> </pre> <br>  No <b>IBM DB2, a</b> sintaxe tamb√©m funcionar√°.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como se costuma dizer</a> , "sob o cap√¥", isso ser√° feito da mesma forma que a constru√ß√£o <code>UPDATE FROM</code> . <br>  Desde 2008, o <b>MS SQL</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tamb√©m possui</a> <code>MERGE</code> . <br><br>  Mas, mesmo atr√°s de uma √∫nica sintaxe padr√£o, come√ßa o problema de escolher entre um n√∫mero consider√°vel de mecanismos e m√©todos de implementa√ß√£o.  A equipe deve trabalhar em diferentes n√≠veis de isolamento de transa√ß√£o, com diferentes algoritmos de bloqueio, concentrando-se no modo de opera√ß√£o altamente competitivo ou n√£o.  E, como voc√™ pode imaginar, para implementar essa l√≥gica complicada, voc√™ precisa tocar em muitos componentes do DBMS. <br><br><h3>  UPSERT, pseudo-MERGE </h3><br>  √â claro que os desenvolvedores de DBMS estavam procurando solu√ß√µes comprometidas, recusando-se a reproduzir literalmente a sintaxe padr√£o.  A vantagem dessa abordagem √© a liberdade.  Voc√™ pode usar mecanismos org√¢nicos para um DBMS espec√≠fico. Voc√™ pode otimizar a implementa√ß√£o para tarefas que considere mais relevantes para seus usu√°rios. <br><br>  Por exemplo, no <b>MySQL,</b> h√° um comando <code>REPLACE</code> que funciona como um <code>INSERT</code> , mas se as linhas novas e antigas tiverem os mesmos valores no √≠ndice <code>PRIMARY KEY</code> ou <code>UNIQUE</code> , a linha antiga ser√° eliminada antes da inser√ß√£o da nova.  Mas tamb√©m h√° <code>INSERT ... ON DUPLICATE KEY UPDATE</code> onde <code>INSERT</code> e <code>UPDATE</code> ocorrem (em vez de <code>DELETE</code> in <code>REPLACE</code> ).  Isso √© <code>UPSERT</code> .  E <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">existe o</a> <code>INSERT IGNORE</code> , que simplesmente n√£o realiza a inser√ß√£o, sem gerar um erro (mas aviso) sob certas restri√ß√µes na tabela de destino. <br><br><h3>  Cr√¥nicas de PG MERGE </h3><br>  Na comunidade PostgreSQL, as discuss√µes sobre o MERGE come√ßaram em 2005, quando Jaime Casanova perguntou <i>se algu√©m da comunidade havia come√ßado a desenvolver o</i> <code>MERGE</code> .  <i>Peter Eisentraut</i> <a href="">sugeriu discutir</a> <i>se o PostgreSQL deve desenvolver uma das op√ß√µes do MERGE: semelhante √† implementa√ß√£o do MySQL, ou melhor, direcionar o esfor√ßo para uma vers√£o funcionalmente leve do tipo <code>MERGE</code> da Oracle.</i>  <i>No entanto, vale a pena fazer esfor√ßos nesse sentido?</i> <br><br>  No meio de uma breve discuss√£o, o protagonista desta narrativa <i>Simon Riggs</i> aparece com as palavras: <br>  <i>MERGE √© √∫til tanto para sistemas OLTP quanto para DW (Data Warehouse - data warehouses, ou seja, aplicativos anal√≠ticos em que consultas complexas, mas ambientes e dados n√£o muito competitivos, raramente s√£o atualizados e, se atualizados, geralmente em grandes blocos. &lt;...&gt; Podemos implementar o MERGE como uma variante do COPY FROM, ser√° muito legal.</i> <br><br>  Todo mundo concorda: sim, legal.  Mais precisamente, quase tudo: <i>Stephen Frost</i> : <i>Acho que n√£o sou o √∫nico que diz que preciso de um padr√£o MERGE completo e compat√≠vel.</i> <br><br>  Bruce Momjian tem uma proposta diferente e mais pragm√°tica: <i>parece-me que precisamos implementar no</i> <code>MERGE</code> <i>algumas op√ß√µes que podemos implementar e, no restante, cometeremos um erro (e nos casos em que ser√° necess√°rio bloquear a tabela inteira).</i>  <i>E depois de recebermos o feedback dos usu√°rios e pensaremos no que fazer a seguir.</i> <br><br>  Mas at√© agora nada est√° acontecendo. <br><br><h3>  O gelo quebrou </h3><br>  Em <b>2008,</b> <i>Simon Riggs</i> novamente pediu para lidar com o MERGE - qual das maneiras de escolher (at√© ent√£o uma nova vers√£o do MERGE no padr√£o SQL-2008, que ainda est√° em rascunho, j√° est√° aparecendo).  Ele pinta detalhadamente a implementa√ß√£o naquele momento do Oracle, IBM e MS SQL e sintaxe alternativa do MySQL e Teradata.  E um pouco mais tarde, ele j√° menciona o <b>in√≠cio dos trabalhos no 2ndQuadrant</b> nessa dire√ß√£o. <br><br>  Peter Eisentraut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreve em seu blog</a> : <i>Obviamente, Riggs √© um dos especialistas mais qualificados, ele pode liderar o trabalho de implementa√ß√£o do MERGE.</i> <br><br>  Mas aqui vem a primeira virada inesperada: um <b>aluno</b> est√° envolvido no problema - um participante no desenvolvimento do programa <b>GSoC</b> , ou seja, o Google Summer of Code.  O nome dele √© <i>Boxuan Bxzhai</i> - n√£o pretendo transcrever o sobrenome.  Logo ele escreve que o trabalho est√° quase pronto. <br><br>  Mas quase n√£o conta.  <i>Greg Smith,</i> do 2ndQuadrant (ou seja, Simon Riggs aliado) escreve: <br>  <i>Portanto, temos um patch no c√≥digo do qual meia d√∫zia de problemas s√©rios n√£o resolvidos.</i>  <i>Fico em sil√™ncio sobre os mesquinhos.</i>  <i>Os problemas s√£o muito profundos para finalizar o c√≥digo para o commitfest.</i>  <i>Enquanto isso, nada foi ouvido de Boxuan por um longo tempo.</i>  <i>N√≥s poder√≠amos ajud√°-lo, mas onde ele est√°?</i>  <i>Quem est√° a par?</i> <br><br>  Uma discuss√£o sobre caminhos de implementa√ß√£o surge novamente em <b>2014</b> , mas novamente nada acontece: n√£o h√° c√≥digo. <br><br>  Finalmente, j√° em <b>2017,</b> <i>Simon Riggs</i> escreve: <br>  <i>Estou trabalhando no c√≥digo para confirmar o <code>MERGE</code> no <b>PostgreSQL</b> vers√£o <b>11</b> .</i>  <i>Usamos os mesmos mecanismos subjacentes ao <code>INSERT ON CONFLICT</code> , que j√° est√° funcionando, para que n√£o sejam necess√°rias altera√ß√µes na infraestrutura, basicamente implementando a sintaxe al√©m do que est√° dispon√≠vel.</i>  <i>Mas eu escrevo meu c√≥digo do zero, n√£o uso desenvolvimentos anteriores.</i> <br><br>  Estamos falando de Peter Geoghegan ( <b>VMware</b> ) implementado na √©poca j√° na 9.5 sintaxe alternativa <code>INSERT .. ON CONFLICT UPDATE</code> , diferente do padr√£o SQL, mas ainda relacionado a <code>MERGE</code> e <code>REPLACE</code> no MySQL. <br><br>  A princ√≠pio, o trabalho de Simon foi recebido com exclama√ß√µes do belo trabalho!  No entanto, <i>Robert Haas</i> , apesar de favor√°vel, alerta para poss√≠veis anomalias de serializa√ß√£o.  Por exemplo, para lidar com <code>INSERT .. ON CONFLICT UPDATE</code> , sem MERGE em sua base, √© de alguma forma mais calmo. <br><br>  O <code>UPSERT</code> autor do PostgreSQL <code>UPSERT</code> : <br>  <i>Eu n√£o misturaria o <code>MERGE</code> <code>ON CONFLICT DO UPDATE</code> e <code>MERGE</code> .</i>  <i>&lt;...&gt; Para carregar grandes quantidades de dados ( <code>bulk load</code> ), por exemplo, usaria o algoritmo de <code>merge join</code> .</i>  <i>&lt;...&gt; Em geral, as vantagens do <code>MERGE</code> estariam relacionadas ao fato de que as conex√µes normais funcionariam l√° da maneira usual: <code>nested loop, hash, merge</code> .</i>  <i>E em <code>INSERT ‚Ä¶ ON CONFLICT</code> n√£o h√° jun√ß√µes.</i> <br><br>  Haas: <i>Como Peter, acho que, se feito dessa maneira, um bloqueio t√£o forte ao executar uma solicita√ß√£o <code>DML</code> parece mais ou menos.</i>  <i>√â improv√°vel que algu√©m fique satisfeito com o fato de apenas uma pessoa poder trabalhar com o <code>MERGE</code> por vez.</i> <br><br>  Para os curiosos: Geigan desmonta as sutilezas e diferen√ßas <code>UPSERT</code> entre <code>MERGE</code> e <code>MERGE</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> (armazenamos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">correspond√™ncia arquivada do</a> PostgreSQL em nosso site). <br><br>  Simon resiste.  Ele apela √† hist√≥ria recente.  Como sobre o corte, eles tamb√©m disseram "uma nova sintaxe, nada mais".  Mas acabou sendo uma coisa muito √∫til.  <i>Mas n√£o me proponho a perceber imediatamente tudo o que est√° em MERGE.</i>  <i>Faremos o mesmo que com o particionamento - dividimos o desenvolvimento em fases.</i> <br><br>  E mais um argumento, na minha opini√£o, √© muito convincente: <i>bom.</i>  <i>Mas vamos escolher.</i>  <i>Eu sugiro uma op√ß√£o pr√°tica.</i>  <i><b>Em breve, 10 anos vir√£o</b> da primeira tentativa s√©ria de desenvolver o <code>MERGE</code> .</i>  <i>N√£o √© hora de come√ßar a fazer alguma coisa, obter uma solu√ß√£o √∫til, em vez de esperar mais 10 anos da Solu√ß√£o Perfeita?</i>  <i>Supondo que exista.</i> <br><br>  Finalmente, o patch chega √† comunidade.  Que data?  Imagine por favor.  N√£o, eles n√£o adivinharam: Simon o envia em 30 de dezembro de 2017.  E estipula que este √© um patch WIP, ou seja, Work in Progress - um patch em trabalho. <br><br>  Simon, janeiro: <br>  <i>O patch √© conclu√≠do sem erros especiais.</i>  <i><b>1200 linhas de c√≥digo,</b> al√©m de testes e documenta√ß√£o.</i>  <i>Vou compromet√™-lo com este commitfest e concluiremos o RLS (Seguran√ßa no n√≠vel da linha - prote√ß√£o no n√≠vel da grava√ß√£o) e o suporte ao particionamento posteriormente.</i> <br><br><h3>  Casta de comiss√µes </h3><br>  Aqui temos que dar um passo √† parte e explicar o papel do comiss√°rio na comunidade.  As fun√ß√µes do comiss√°rio, isto √©, aquele com poderes para aceitar o patch na pr√≥xima vers√£o, mudaram historicamente.  Era uma vez, quando havia poucos desenvolvedores, o direito de confirmar era distribu√≠do generosamente.  Por exemplo, o famoso (em um campo completamente diferente) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>Julian Assange</b></a> recebeu o t√≠tulo de comandante, sendo o autor de apenas seis patches.  Agora n√£o √© f√°cil se tornar um comiss√°rio, n√£o h√° empresas iniciantes na lista de algumas d√∫zias de pessoas.  Boyus Momdjan ( <b>EnterpriseDB</b> ) possui 13.363 commits, Tom Lane (Tom Lane, <b>Crunchy Data</b> ) 13127, Robert Haas ( <b>EnterpriseDB</b> ) - 2074. A prop√≥sito, o <b>√∫nico committer da R√∫ssia</b> √© <i>Fedor Sigaev</i> ( <b>Postgres Professional</b> ) com seus 383 commits .  O pr√≥prio Simon Riggs possui 449. Repito: ele, como comiss√°rio, tem autoridade suficiente para receber e corrigir patches - ele e seus funcion√°rios.  Outra coisa √© que dificilmente vale a pena fazer isso, negligenciando francamente as opini√µes de outros comit√™s-luminares importantes.  Eles tamb√©m podem privar o status de um comiss√°rio, mas pelo menos <code>revert</code> patch. <br><br><h3>  Fratura em batalha </h3><br>  Obviamente, no patch "sem esperan√ßa", feito, em geral, √†s pressas, eles encontram novos erros.  Novas vers√µes s√£o lan√ßadas em resposta. <br><br>  No final de janeiro, um novo personagem aparece: o desenvolvedor do 2ndQuadrant <i>Pavan</i> (seu nome √© todo mundo pelo nome; completamente Pavan Deolasee).  Agora a comunidade est√° lidando com um conjunto: Pavan envia novas vers√µes e agradece as cr√≠ticas, e Simon as quebra com uma press√£o de marketing not√°vel. <br><br>  Haas: <i>N√£o acho que valha a pena tomar decis√µes unilaterais sobre a exclus√£o de recursos que funcionam em qualquer lugar.</i>  <i>Se concordarmos que alguns recursos n√£o ser√£o inclu√≠dos neste patch - isso √© uma coisa.</i>  <i>E √© completamente diferente que, nos coment√°rios desta ocasi√£o, todos tenham expressado discord√¢ncia.</i>  <i>E, na verdade, n√£o ouvimos as raz√µes pelas quais esses recursos deveriam ser exclu√≠dos.</i> <br><br>  A l√≥gica foi apresentada da seguinte forma: <br><br><ul><li>  a priori, existem problemas s√©rios porque eles n√£o podem deixar de estar nos desenvolvimentos no estilo de "ataque de cavalaria". </li><li>  Suporte para recursos importantes, como novo particionamento nas vers√µes 10-11, CTE (Common Table Expressions = WITH query) ou RLS (Row Level Security) podem ser conclu√≠dos mesmo depois que o patch for aceito na vers√£o atual, mas somente se a arquitetura proposta for adequada para constru√ß√£o em cima a funcionalidade desejada. </li></ul><br>  O segundo Peter Geigan formula isso: <br>  <i>Normalmente presto aten√ß√£o ao <b>suporte de v√°rias funcionalidades, pois, se for, refor√ßa a cren√ßa geral de que o design √© feito como deveria</b> .</i>  <i>E se tais problemas s√£o causados ‚Äã‚Äãpelo suporte das express√µes <code>WITH</code> [ou seja, <code>CTE</code> ], entendi que a arquitetura subjacente √© tal que causar√° problemas aqui e ali.</i> <br><br>  Enquanto isso, a hora X (a √∫ltima comit√™) est√° se aproximando, e as nuvens sobre MERGE est√£o se aproximando.  N√£o √© que os pais fundadores procurassem especificamente problemas s√©rios na arquitetura dos patches feitos por Simon e depois por Pavan.  N√£o precisava procurar problemas, eles se abriram de bom grado. <br><br><h3>  O desenlace est√° se aproximando </h3><br>  O enredo est√° acelerando.  Apesar da atitude descolada de outros comit√™s em rela√ß√£o a seu empreendimento, <b>em 2 de abril,</b> Simon decide cometer o patch <b>Command: SQL: 2016</b> , adiciona os arquivos, Depesz (Hubert Lubachevsky) consegue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anunci√°-lo</a> em seu blog, mas no mesmo dia Simon reverte tudo porque erros. <br><br>  No dia seguinte, confirme novamente adicionando o suporte <code>WITH</code> . <br><br>  Em resposta, as alega√ß√µes s√£o realmente graves.  <i>Andres Freund</i> ( <b>EnterpriseDB</b> ) escreve: <br>  <i>A arquitetura do MERGE no analisador e no executor n√£o me impressionou de maneira confi√°vel.</i>  <i>Criar jun√ß√µes ocultas durante a an√°lise de an√°lise √© uma p√©ssima id√©ia.</i>  <i>Essa estrutura do executor deve ser completamente alterada.</i> <br><br>  Tom Lane: <br>  <i>O design da √°rvore de an√°lise √© fraco.</i> <br><br><br><br>  <i>Voc√™ sobrecarrega a fun√ß√£o <code>InsertStmt</code> , ele continua, ela n√£o faz <code>INSERT</code> , mas aleatoriamente tem os mesmos campos que o original.</i>  <i>E n√£o todos, mas alguns.</i>  <i>Isso √© ruim, leva √† confus√£o.</i> <br><br>  Vamos adicionar observa√ß√µes de <i>Fedor Sigayev</i> : <br>  <i>No analisador, os n√≥s <code>INSERT</code> relacionados ao <code>MERGE</code> apareceram, pendurados com <code>MERGE</code> campos adicionais.</i>  <i>Se voc√™ observar o plano de execu√ß√£o em <code>ANALIZE</code> , n√£o entender√° imediatamente se est√° lidando com um <code>INSERT</code> regular ou com o <code>MERGE</code> : para entender, √© necess√°rio examinar campos adicionais.</i> <br><br><br>  Simon, calmamente: <i>OK, mudaremos isso e enviaremos um novo arquivo amanh√£</i> . <br>  Haas: <i>Eu concordo com Peter.</i>  <i>A escolha da arquitetura n√£o teve √™xito.</i> <br><br>  Simon n√£o desiste.  <b>O dia 6 de abril,</b> em resposta √†s cr√≠ticas a Tom Lane, comete um novo patch, conforme corrigido no analisador. <br><br><h3>  Negocia√ß√£o e entrega </h3><br>  Bruce Momjan <b>6 de abril</b> : <br>  <i>Quero observar que as pessoas n√£o pediram para voc√™ trabalhar duro para corrigir algo com urg√™ncia.</i>  <i>Eles pediram para voc√™ retirar o patch.</i>  <i>Voc√™ pode, √© claro, trabalhar duro, esperando que eles mudem de id√©ia, mas - novamente - eles n√£o perguntaram sobre isso.</i> <br><br>  Simon: <i>Se Tom [Lane] e Andres [Freund] pelos pr√≥ximos dias ainda sentirem que seus medos n√£o foram dissipados, <b>terei prazer em reverter o patch</b> sem mais delongas.</i> <br><br>  Tom Lane: <i>Eu ainda voto para que o patch seja revertido.</i>  <i>Mesmo se ele fosse perfeito agora, agora as pessoas n√£o t√™m tempo para se convencer disso - na garganta de outros assuntos urgentes.</i> <br><br>  S√≥ isso. <br><br>  Simon disse que <code>MERGE</code> bem, e a batalha na <code>MERGE</code> terminado.  Todos os patches foram revertidos, o t√≥pico foi movido para o pr√≥ximo commitfest com o status "Aguardando conclus√£o do autor".  Os participantes do show fizeram as pazes. <br><br><img src="https://habrastorage.org/webt/ad/zw/ry/adzwryarovhxoldwxewpneljyms.jpeg"><br>  No entanto, a julgar pela correspond√™ncia das √∫ltimas semanas, alguma tens√£o parece permanecer. <br><br><h3>  Moralidade Prometida </h3><br><ul><li>  Felizmente, a comunidade do PostgreSQL possui mecanismos naturais e formais para a triagem (quase) livre de conflitos de tentativas de solu√ß√µes imaturas.  Mesmo que sejam atingidos por desenvolvedores respeitados no posto de chefe da empresa, cuja contribui√ß√£o para o desenvolvimento do PostgreSQL √© enorme.  E os clientes que n√£o t√™m funcionalidade est√£o pressionando para investir. </li><li>  Infelizmente, a comunidade geralmente p√°ra.  √â inercial na ado√ß√£o de desenvolvimentos mesmo inequ√≠vocos.  √Äs vezes, o perfeccionismo irracional est√° inclu√≠do.  A experi√™ncia do Postgres Professional, onde trabalho, confirma isso.  N√≥s perfuramos um patch grande e importante dos <b>√≠ndices INCLUDE</b> por 3 anos.  Uma s√©rie √∫til de corre√ß√µes para trabalhar com <b>JSON / JSONB</b> ainda est√° aguardando.  A express√£o "dar seu desenvolvimento √† comunidade" <b>n√£o</b> significa <b>realmente dar, mas dar um soco</b> : o h√≥spede √© recebido de bra√ßos abertos e escoltado para quarentena. </li></ul><br>  PS: <i>Isen√ß√£o de responsabilidade do autor</i> : n√≥s apenas quer√≠amos mostrar um peda√ßo da vida da comunidade.  Todas as correspond√™ncias de nomes s√£o aleat√≥rias :) <br>  PPS: Samurai <i>Natalia Levshina</i> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412605/">https://habr.com/ru/post/pt412605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412591/index.html">Construindo um jetpack: 29 de maio √© o Memorial Day de Wendell Moore</a></li>
<li><a href="../pt412593/index.html">Novos produtos, plataformas e tudo como servi√ßo: semin√°rios on-line da HPE</a></li>
<li><a href="../pt412595/index.html">Relat√≥rio do Clube de Roma de 2018, cap√≠tulo 1.1.2: ‚ÄúFinanciamento‚Äù</a></li>
<li><a href="../pt412597/index.html">Jeff Bezos vai construir uma col√¥nia na superf√≠cie da lua</a></li>
<li><a href="../pt412603/index.html">Instru√ß√µes php estranhas</a></li>
<li><a href="../pt412607/index.html">Esta√ß√£o de solda revers√≠vel classe HI-END</a></li>
<li><a href="../pt412609/index.html">10 dicas para produtividade no CLion, um IDE C / C ++ multiplataforma</a></li>
<li><a href="../pt412611/index.html">O que a minera√ß√£o eficaz e a teoria dos jogos t√™m em comum</a></li>
<li><a href="../pt412613/index.html">Aritm√©tico inteiro. Divida arredondando o resultado. Parte 1</a></li>
<li><a href="../pt412615/index.html">Presen√ßa do alvo da rota nos an√∫ncios BGP entre PE e CE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>