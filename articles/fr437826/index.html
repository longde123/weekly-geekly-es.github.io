<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöô üë¶üèø üí¢ Comment nous avons migr√© la base de donn√©es de Redis et Riak KV vers PostgreSQL. Partie 1: le processus üéØ üë©üèº‚Äçüî¨ ‚ÄºÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ceci est la premi√®re partie de l'article dans laquelle je parlerai de la fa√ßon dont nous avons construit le processus de travail sur un grand projet d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons migr√© la base de donn√©es de Redis et Riak KV vers PostgreSQL. Partie 1: le processus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/437826/">  Ceci est la premi√®re partie de l'article dans laquelle je parlerai de la fa√ßon dont nous avons construit le processus de travail sur un grand projet de migration de base de donn√©es: sur les exp√©riences s√ªres, la planification d'√©quipe et l'interaction entre √©quipes.  Dans les articles suivants, je parlerai plus en d√©tail des probl√®mes techniques que nous avons r√©solus: la mise √† l'√©chelle et la tol√©rance aux pannes de PostgreSQL et les tests de charge. <br><br><img src="https://habrastorage.org/webt/h3/cq/xn/h3cqxnvyiw1x3frzzx_tzfwlxzw.png"><br><br>  Pendant longtemps, la base de donn√©es principale de Miro (ex-RealtimeBoard) √©tait Redis.  Nous y avons stock√© toutes les informations de base: donn√©es sur les utilisateurs, les comptes, les tableaux, etc.  Tout a fonctionn√© rapidement, mais nous avons rencontr√© un certain nombre de probl√®mes. <br><br>  <b>Probl√®mes avec Redis</b> <br><br><ol><li>  D√©pendance √† la latence du r√©seau.  Maintenant, dans notre cloud, il est environ 20 heures de Moscou, mais lorsque vous l'augmentez, l'application commencera √† fonctionner tr√®s lentement. </li><li>  Le manque d'index dont nous avons besoin au niveau de la logique m√©tier.  Leur mise en ≈ìuvre ind√©pendante peut compliquer la logique m√©tier et conduire √† une incoh√©rence des donn√©es. </li><li>  La complexit√© du code rend √©galement difficile le maintien de la coh√©rence des donn√©es. </li><li>  Intensit√© des ressources des requ√™tes avec s√©lections. </li></ol><br>  Ces probl√®mes, associ√©s √† une augmentation de la quantit√© de donn√©es sur les serveurs, ont √©t√© √† l'origine de la migration de la base de donn√©es. <br><a name="habracut"></a><br><h2>  √ânonc√© du probl√®me </h2><br>  La d√©cision sur la migration a √©t√© prise.  L'√©tape suivante consiste √† comprendre quelle base de donn√©es convient √† notre mod√®le de donn√©es. <br><br>  Nous avons men√© une √©tude pour s√©lectionner la base de donn√©es optimale pour nous et nous sommes install√©s sur PostgreSQL.  Notre mod√®le de donn√©es s'int√®gre bien avec une base de donn√©es relationnelle: PostgreSQL dispose d'outils int√©gr√©s pour assurer la coh√©rence des donn√©es, il existe un type JSONB et la possibilit√© d'indexer certains champs dans JSONB.  Cela nous convient. <br><br>  L'architecture simplifi√©e de notre application ressemblait √† ceci: il y a des serveurs d'applications qui acc√®dent √† Redis et RiakKV via la couche de donn√©es. <br><br>  Notre serveur d'applications est une application Java monolithique.  La logique m√©tier est √©crite dans un framework adapt√© √† NoSQL.  L'application poss√®de son propre syst√®me transactionnel, qui vous permet de fournir plusieurs utilisateurs sur n'importe laquelle de nos cartes. <br><br>  Nous avons utilis√© RiakKV pour stocker des donn√©es √† partir de tableaux d'archives qui ne se sont pas ouverts pendant 7 jours. <br><br>  Ajoutez PostgreSQL √† ce sch√©ma.  Nous faisons fonctionner les serveurs d'applications avec la nouvelle base de donn√©es.  Copiez les donn√©es de Redis et RiakKV vers PostgreSQL.  Le probl√®me est r√©solu! <br><br>  <b>Rien de compliqu√©, mais il y a des nuances:</b> <br><br><ul><li>  Nous avons 2,2 millions d'utilisateurs enregistr√©s.  Chaque jour, Miro emploie 50 000 utilisateurs, la charge de pointe pouvant atteindre 14 000 en m√™me temps.  Les utilisateurs ne devraient pas rencontrer d'erreurs dues √† notre travail, ils ne devraient g√©n√©ralement pas remarquer le moment de passer √† une nouvelle base. </li><li>  1 To de donn√©es dans la base de donn√©es ou 410 millions d'objets. </li><li>  Sortie continue de nouvelles fonctionnalit√©s par d'autres √©quipes, dont le travail ne doit pas nous g√™ner. </li></ul><br><h2>  Options pour r√©soudre le probl√®me </h2><br>  Nous avons √©t√© confront√©s √† un choix de deux options pour la migration des donn√©es: <br><br><ol><li>  Arr√™tez le d√©veloppement du service ‚Üí r√©√©crivez le code sur le serveur ‚Üí testez la fonctionnalit√© ‚Üí lancez une nouvelle version. </li><li>  Effectuez une migration en douceur: transf√©rez progressivement des parties du produit vers une nouvelle base de donn√©es, prenant en charge PostgreSQL et Redis et n'interrompant pas le d√©veloppement de nouvelles fonctionnalit√©s. </li></ol><br>  Arr√™ter le d√©veloppement d'un service est une perte de temps que nous pourrions utiliser pour la croissance, ce qui signifie une perte d'utilisateurs et de parts de march√©.  Ceci est essentiel pour nous, nous avons donc choisi l'option avec une migration en douceur.  Malgr√© le fait que dans la complexit√©, ce processus peut √™tre compar√© au remplacement des roues d'une voiture pendant la conduite. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Rrjgk1PksgU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Lors de l'√©valuation du travail, nous avons divis√© notre produit en blocs principaux: utilisateurs, comptes, tableaux, etc.  Par ailleurs, des travaux ont √©t√© men√©s pour cr√©er l'infrastructure PostgreSQL.  Et ils mettent des risques dans l'√©valuation en cas de probl√®me (comme cela s'est produit). <br><br><h2>  Sprints et objectifs </h2><br>  L'√©tape suivante consiste √† constituer une √©quipe de cinq personnes afin que chacun se d√©place √† la bonne vitesse vers un objectif commun. <br><br>  Nous avons deux points: le d√©but du travail sur la t√¢che et le but final.  Id√©al lorsque nous nous dirigeons directement vers l'objectif.  Mais il arrive souvent que nous voulions aller dans le bon sens, mais cela se passe comme suit: <br><br><img src="https://habrastorage.org/webt/td/ab/5p/tdab5prpw4exyylbudctzzzcp8s.png"><br><br>  Par exemple, en raison de difficult√©s et de probl√®mes qui ne pouvaient pas √™tre pr√©vus √† l'avance. <br><br>  Une situation est possible dans laquelle nous n'atteindrons pas du tout l'objectif.  Par exemple, si nous proc√©dons √† une refactorisation en profondeur ou √† la r√©√©criture de l'application enti√®re. <br><br><img src="https://habrastorage.org/webt/9v/ef/66/9vef66oubzjo89rj7rtedo2a89u.png"><br><br>  Nous avons divis√© la t√¢che en sprints hebdomadaires pour minimiser les difficult√©s d√©crites ci-dessus.  Si l'√©quipe part soudainement sur le c√¥t√©, elle peut rapidement revenir en arri√®re avec un minimum de pertes pour le projet, car de courtes it√©rations ne vous permettent pas d'aller trop loin "dans le mauvais sens". <br><br>  Chaque it√©ration a son propre objectif, ce qui d√©place l'√©quipe vers le grand r√©sultat final. <br><br><img src="https://habrastorage.org/webt/ci/lv/z6/cilvz6zsakszbtskmwkc9ipt-w8.png"><br><br>  Si une nouvelle t√¢che appara√Æt pendant le sprint, nous √©valuons si sa mise en ≈ìuvre nous rapproche de l'objectif.  Oui - prenez le prochain sprint ou changez les priorit√©s dans l'actuel, sinon - ne le prenez pas.  Si des erreurs apparaissent, nous leur accordons une priorit√© √©lev√©e et les corrigeons rapidement. <br><br>  Il arrive que les d√©veloppeurs d'un sprint doivent effectuer des t√¢ches dans une s√©quence strictement d√©finie.  Ou, par exemple, le d√©veloppeur remet la t√¢che termin√©e √† l'ing√©nieur QA pour des tests urgents.  Au stade de la planification, nous essayons de cr√©er des relations similaires entre les t√¢ches pour chaque membre de l'√©quipe.  Cela permet √† toute l'√©quipe de voir qui fera quoi et quand, sans oublier la d√©pendance aux autres. <br><br>  L'√©quipe a des synchronisations quotidiennes et hebdomadaires.  Chaque matin, nous discutons qui, quoi et dans quelle priorit√© fera aujourd'hui.  Apr√®s chaque sprint, nous nous synchronisons les uns avec les autres pour √™tre s√ªrs que tout le monde va dans la bonne direction.  Assurez-vous de planifier des versions importantes ou complexes.  Nous nommons des d√©veloppeurs en service qui, si n√©cessaire, sont pr√©sents lors de la sortie et contr√¥lons que tout est en ordre. <br><br>  La planification et la synchronisation au sein de l'√©quipe permettent d'impliquer tous les participants √† toutes les √©tapes du projet.  Les plans et les √©valuations ne nous viennent pas d'en haut, nous les faisons nous-m√™mes.  Cela augmente la responsabilit√© et l'int√©r√™t de l'√©quipe dans l'ex√©cution des t√¢ches. <br><br>  C'est l'un de nos sprints.  Nous portons tout sur la planche Miro: <br><br><img src="https://habrastorage.org/webt/fq/uz/l2/fquzl2taefgfyi0ge6w4q8x52qm.png"><br><br><h2>  Modes et exp√©riences s√©curitaires </h2><br>  Pendant la migration, nous avons d√ª garantir le fonctionnement stable du service dans des conditions de combat.  Pour ce faire, vous devez vous assurer que tout est test√© et qu'il n'y a aucune erreur nulle part.  Pour atteindre cet objectif, nous avons d√©cid√© de rendre notre migration en douceur encore plus fluide. <br><br>  L'id√©e √©tait de basculer progressivement les blocs de produits vers une nouvelle base de donn√©es.  Pour ce faire, nous avons propos√© une s√©quence de modes. <br><br>  <b>Dans le premier mode ¬´Redis Read / Write¬ª,</b> seule l'ancienne base de donn√©es, Redis, fonctionne. <br><br><img src="https://habrastorage.org/webt/aq/zs/rc/aqzsrc1smjopt9khha7zrkxfg_c.png"><br><br>  <b>Dans le deuxi√®me mode ¬´PostgreSQL Passive Write¬ª,</b> nous pouvons nous assurer que l'√©criture dans la nouvelle base de donn√©es est correcte et que les bases de donn√©es sont coh√©rentes. <br><br><img src="https://habrastorage.org/webt/rl/gj/2v/rlgj2vmdvm2efjihl-dfccsmitq.png"><br><br>  <b>Le troisi√®me mode ¬´Lecture / √©criture PostgreSQL, √©criture passive Redis¬ª</b> vous permet de v√©rifier l'exactitude des donn√©es de lecture de PostgreSQL et de voir comment la nouvelle base de donn√©es se comporte dans des conditions de combat.  Dans le m√™me temps, Redis reste la base principale, ce qui nous a permis de trouver des cas sp√©cifiques de travail avec des cartes pouvant conduire √† des erreurs. <br><br><img src="https://habrastorage.org/webt/0n/77/23/0n7723633vpttzrti6pp6kajjui.png"><br><br>  <b>Dans le dernier mode ¬´PostgreSQL Read / Write¬ª,</b> seule la nouvelle base de donn√©es est en cours d'ex√©cution. <br><br><img src="https://habrastorage.org/webt/p4/c7/go/p4c7gokfrrvxrn-c-ltg7fhtvts.png"><br><br>  Le travail de migration pourrait affecter les principales fonctions du produit, nous devions donc √™tre s√ªrs √† 100% que nous ne casserons rien et que la nouvelle base de donn√©es fonctionne au moins aussi lentement que l'ancienne.  Par cons√©quent, nous avons commenc√© √† mener des exp√©riences s√ªres avec les modes de commutation. <br><br>  Nous avons commenc√© √† changer de mode sur notre compte d'entreprise, que nous utilisons quotidiennement au travail.  Apr√®s nous √™tre assur√©s qu'il n'y avait aucune erreur, nous avons commenc√© √† changer de mode sur une petite s√©lection d'utilisateurs externes. <br><br>  La chronologie du lancement des exp√©riences avec les modes est la suivante: <br><br><ul><li>  Janvier-f√©vrier: Redis lecture / √©criture </li><li>  Mars-avril: √©criture passive PostgreSQL </li><li>  Mai-juin: PostgreSQL en lecture / √©criture, base de donn√©es principale - Redis </li><li>  Juillet-ao√ªt: PostgreSQL en lecture / √©criture </li><li>  Septembre-d√©cembre: migration compl√®te. </li></ul><br>  Si des erreurs se sont produites, nous avons eu la possibilit√© de les corriger rapidement, car nous pouvions nous-m√™mes r√©aliser des versions sur des serveurs o√π travaillaient les utilisateurs participant √† l'exp√©rience.  Nous ne d√©pendions pas de la version principale, nous avons donc corrig√© les erreurs rapidement et √† tout moment. <br><br><h2>  Collaboration entre √©quipes </h2><br>  Pendant la migration, nous avons souvent crois√© des √©quipes qui ont publi√© de nouvelles fonctionnalit√©s.  Nous avons une base de code unique et, dans le cadre de leur travail, les √©quipes peuvent modifier les structures existantes dans une nouvelle base de donn√©es ou en cr√©er de nouvelles.  Dans le m√™me temps, des intersections d'√©quipes pour le d√©veloppement et le retrait de nouvelles fonctionnalit√©s pourraient se produire.  Par exemple, l'une des √©quipes produit a promis √† l'√©quipe marketing de publier une nouvelle fonctionnalit√© √† une date pr√©cise;  l'√©quipe marketing a pr√©vu une campagne publicitaire pour cette p√©riode;  Une √©quipe commerciale attend une fonctionnalit√© et une campagne pour commencer √† communiquer avec de nouveaux clients.  Il s'av√®re que tout le monde d√©pend les uns des autres, et retarder les d√©lais d'une √©quipe perturbe les plans de l'autre. <br><br>  Pour √©viter de telles situations, nous avons √©labor√©, avec d'autres √©quipes, une feuille de route unique pour l'√©picerie, synchronis√©e plusieurs fois par trimestre, et avec certaines √©quipes chaque semaine. <br><br><h2>  Conclusions </h2><br>  Ce que nous avons appris au cours de ce projet: <br><br><ol><li>  N'ayez pas peur de vous lancer dans des projets complexes.  Apr√®s d√©composition, √©valuation et d√©veloppement d'approches du travail, les projets complexes cessent de para√Ætre impossibles. </li><li>  Ne perdez pas de temps et d'efforts sur les estimations pr√©liminaires, la d√©composition et la planification.  Cela permet de mieux comprendre le probl√®me avant de commencer √† travailler dessus et de comprendre le volume et la complexit√© du travail. </li><li>  Risque dans les projets techniques et organisationnels difficiles.  Au cours du travail, vous rencontrerez s√ªrement un probl√®me qui n'a pas √©t√© pris en compte lors de la planification. </li><li>  Ne migrez pas sauf si cela est n√©cessaire. </li></ol><br>  Dans les articles suivants, je parlerai davantage des probl√®mes techniques que nous avons r√©solus lors de la migration. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437826/">https://habr.com/ru/post/fr437826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437814/index.html">Xcode 10.2, macOS Mojave 10.14.4, iOS 12.1 et autres versions b√™ta</a></li>
<li><a href="../fr437816/index.html">MPLS est partout. Comment est l'infrastructure r√©seau Yandex.Cloud</a></li>
<li><a href="../fr437818/index.html">Nous enseignons √† un ordinateur √† distinguer les sons: se familiariser avec le concours DCASE et assembler votre classificateur audio en 30 minutes</a></li>
<li><a href="../fr437820/index.html">50 nuances de s√©curit√© Drupal</a></li>
<li><a href="../fr437824/index.html">Extension universelle 1C pour Google Sheets et Docs - prendre et utiliser</a></li>
<li><a href="../fr437828/index.html">Webinaire ouvert "SELECT ordre d'ex√©cution des requ√™tes et plan de requ√™te dans MS SQL Server"</a></li>
<li><a href="../fr437830/index.html">Programmation fiable par langage - revue noob. Partie 1</a></li>
<li><a href="../fr437832/index.html">Open source: humour de code, astuces de code, PAS de code</a></li>
<li><a href="../fr437834/index.html">Deux histoires sur la fa√ßon dont les √©v√©nements de programmation ont eu lieu √† Iekaterinbourg</a></li>
<li><a href="../fr437836/index.html">Under the hood Screeps - virtualisation dans le sandbox MMO pour les programmeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>