<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🏫 🏨 💥 Saya tidak menghargai enkapsulasi, atau menggunakan tipe tabel metode yang berbeda untuk memanggil metode privat dengan cepat ✅ 🚣🏿 👩‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo semuanya. Saya ingin membagikan contoh menggunakan StructLayout untuk sesuatu yang lebih menarik daripada contoh dengan byte, int dan angka lainn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Saya tidak menghargai enkapsulasi, atau menggunakan tipe tabel metode yang berbeda untuk memanggil metode privat dengan cepat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423657/"> Halo semuanya.  Saya ingin membagikan contoh menggunakan StructLayout untuk sesuatu yang lebih menarik daripada contoh dengan byte, int dan angka lainnya, di mana semuanya terjadi sedikit lebih dari yang diharapkan. <br><a name="habracut"></a><br>  Sebelum memulai pelanggaran enkapsulasi kilat-cepat, singkatnya ada baiknya mengingat apa itu StructLayout.  Sebenarnya, ini bahkan merupakan StructLayoutAttribute, yaitu atribut yang memungkinkan Anda membuat struktur dan kelas yang mirip dengan penyatuan dalam C ++.  Secara lebih rinci, atribut ini memungkinkan Anda untuk mengontrol penempatan anggota kelas dalam memori.  Dengan demikian, ditempatkan di atas kelas.  Biasanya, jika kelas memiliki 2 bidang, kami berharap mereka akan diatur secara berurutan, yaitu, mereka akan independen satu sama lain (jangan tumpang tindih).  Namun, StructLayout memungkinkan untuk menentukan bahwa lokasi bidang akan ditentukan bukan oleh lingkungan, tetapi oleh pengguna.  Untuk secara eksplisit menunjukkan offset bidang, gunakan parameter LayoutKind.Explicit.  Untuk menunjukkan pada apa offset relatif terhadap awal kelas / struktur (selanjutnya disebut sebagai kelas) kita ingin menempatkan bidang, kita harus meletakkan atribut FieldOffset di atasnya, yang mengambil sebagai parameter jumlah byte - indentasi dari awal kelas.  Nilai negatif tidak dapat diteruskan, jadi jangan berpikir tentang memanjakan pointer ke tabel metode atau indeks blok sinkronisasi, itu akan menjadi sedikit lebih rumit. <br><br>  Mari kita mulai menulis kode.  Untuk memulai, saya sarankan memulai dengan contoh sederhana.  Buat kelas dengan bentuk berikut: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"CUSTOM"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Field { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); }</code> </pre> <br>  Selanjutnya, kami menggunakan mekanisme di atas untuk secara eksplisit mengatur offset bidang. <br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">StructLayout</span></span>(<span class="hljs-type"><span class="hljs-type">LayoutKind.Explicit</span></span>)] public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStructWithLayout</span></span></span></span> { [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public string Str; [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public CustomClass SomeInstance; }</code> </pre><br>  Untuk saat ini, saya akan menunda penjelasan dan menggunakan kelas tertulis sebagai berikut: <br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> { static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Main</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomStructWithLayout</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomStructWithLayout</span></span></span><span class="hljs-class">(); </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class"> = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomClass</span></span></span><span class="hljs-class">(); </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Str</span></span></span><span class="hljs-class"> = "4564"; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteLine</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetType</span></span></span><span class="hljs-class">()); //</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteLine</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">()); //4564 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Read</span></span></span><span class="hljs-class">(); } }</span></span></code> </pre><br>  Total  Panggilan ke metode GetType () mengembalikan string, metode ToString () nakal dan memberi kita string "4564". <br>  Debit untuk otak: Apa yang akan ditampilkan ketika CustomClass properti virtual dipanggil? <br><br>  Seperti yang mungkin sudah Anda duga, kami menginisialisasi CustomStructWithLayout, kedua tautan adalah nol, lalu kami menginisialisasi bidang tipe kami, dan setelah itu kami menetapkan string ke bidang Str.  Akibatnya, sedikit lebih banyak yang tersisa dari CustomClass daripada tidak sama sekali.  Di atasnya ada garis dengan semua struktur internalnya, termasuk tabel metode dan indeks blok sinkronisasi.  Tetapi kompiler melihat bidang masih dari jenis kelas kami. <br>  Sebagai bukti, saya akan memberikan kliping kecil dari WinDbg: <br><img src="https://habrastorage.org/webt/l5/rb/oo/l5rbooilguqctypvbhwoyfhyq5m.jpeg"><br>  Di sini Anda dapat melihat beberapa hal yang tidak biasa.  Yang pertama adalah bahwa dalam objek alamat pada tabel metode memiliki bidang yang berbeda untuk bidang kelas, seperti yang diharapkan, tetapi alamat nilai bidang adalah satu.  Yang kedua - Anda dapat melihat bahwa kedua bidang terletak di offset 4. Saya pikir sebagian besar akan mengerti, tetapi untuk berjaga-jaga, saya akan menjelaskan, langsung di alamat objek ada tautan ke tabel metode.  Kolom dimulai dengan offset 4 byte (untuk z 32 bit), dan indeks blok sinkronisasi terletak dengan offset -4. <br><br>  Sekarang setelah Anda mengetahui apa yang sedang terjadi, Anda dapat mencoba menggunakan offset untuk memanggil sesuatu yang seharusnya tidak Anda panggil. <br>  Untuk melakukan ini, saya mengulangi struktur kelas string di salah satu kelas saya.  Benar, saya ulangi hanya permulaan, karena kelas string sangat banyak. <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomClassLikeString</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeAlignConst = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeCharPtrAlignConst = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> FakeStringEmpty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FakeFirstChar; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeLength = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimBoth = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimHead = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimTail = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stub1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">800</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">801</span></span>; } }</code> </pre><br>  Nah, struktur dengan Layout berubah sedikit <br><pre> <code class="hljs powershell"> [<span class="hljs-type"><span class="hljs-type">StructLayout</span></span>(<span class="hljs-type"><span class="hljs-type">LayoutKind.Explicit</span></span>)] public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStructWithLayout</span></span></span></span> { [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public string Str; [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public CustomClassLikeString SomeInstance; }</code> </pre><br>  Lebih jauh, ketika memanggil FakeLength atau metode CompareTo (), karena offset yang identik dari anggota kelas ini relatif terhadap alamat objek itu sendiri, metode string yang sesuai (dalam kasus ini) akan dipanggil.  Butuh waktu cukup lama untuk sampai ke metode pribadi pertama di jalur yang dapat saya gunakan, jadi saya memutuskan metode yang umum.  Tapi lapangan itu pribadi, semuanya adil.  By the way, metode yang dibuat virtual untuk melindungi terhadap semua jenis optimasi, yang mengganggu pekerjaan (misalnya, embedding), dan juga agar metode ini disebut dengan offset dalam tabel metode. <br><br>  Jadi, kinerja.  Adalah fakta bahwa pesaing langsung dalam tantangan apa yang tidak perlu menyebabkan dan dalam pelanggaran enkapsulasi adalah refleksi.  Saya pikir sudah jelas bahwa kita lebih cepat dari hal ini, kita semua tidak menganalisis metadata.  Nilai Tepat: <br><table><tbody><tr><th>  Metode </th><th>  Ayub </th><th>  Berarti </th><th>  Kesalahan </th><th>  Stddev </th><th>  Median </th></tr><tr><td>  StructLayoutField </td><td>  Clr </td><td>  0,0597 ns </td><td>  0,0344 ns </td><td>  0,0396 ns </td><td>  0,0498 ns </td></tr><tr><td>  ReflectionField </td><td>  Clr </td><td>  197.1257 ns </td><td>  1.9148 ns </td><td>  1,7911 ns </td><td>  197.4787 ns </td></tr><tr><td>  StructLayoutMethod </td><td>  Clr </td><td>  3,5195 ns </td><td>  0,0382 ns </td><td>  0,0319 ns </td><td>  3,5285 ns </td></tr><tr><td>  Metode Refleksi </td><td>  Clr </td><td>  743.9793 ns </td><td>  13.7378 ns </td><td>  12.8504 ns </td><td>  743.8471 ns </td></tr></tbody></table>  Berikut adalah sepotong kode panjang dengan cara saya mengukur kinerja (Jika seseorang membutuhkannya): <br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">ClrJob</span></span>] [RPlotExporter, RankColumn] [InProcessAttribute] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Benchmarking</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CustomStructWithLayout instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> str; [GlobalSetup] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Setup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomStructWithLayout(); instance.SomeInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomClassLikeString(); instance.Str = <span class="hljs-string"><span class="hljs-string">"4564"</span></span>; str = <span class="hljs-string"><span class="hljs-string">"4564"</span></span>; } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StructLayoutField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance.SomeInstance.FakeLength; } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>).GetField(<span class="hljs-string"><span class="hljs-string">"m_stringLength"</span></span>, BindingFlags.Instance | BindingFlags.NonPublic).GetValue(str); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StructLayoutMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance.SomeInstance.CompareTo(<span class="hljs-string"><span class="hljs-string">"4564"</span></span>); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>).GetMethod(<span class="hljs-string"><span class="hljs-string">"CompareTo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) }).Invoke(str, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"4564"</span></span> }); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> summary = BenchmarkRunner.Run&lt;Benchmarking&gt;(); } }</code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id423657/">https://habr.com/ru/post/id423657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id423647/index.html">Buat jaringan saraf sederhana</a></li>
<li><a href="../id423649/index.html">"Kubernet ke semua bidang!" - Wawancara dengan komite program konferensi DevOops</a></li>
<li><a href="../id423651/index.html">Kami mengundang semua orang ke Hack SmartMail hackathon: Tentang Selamat Datang</a></li>
<li><a href="../id423653/index.html">PsRealVehicle, atau Plugin Fisika Tangki Sumber Terbuka dalam Perang Lapis Baja: Penyerangan</a></li>
<li><a href="../id423655/index.html">Generik + Musim Semi: Semoga Kekuatan Bersamamu</a></li>
<li><a href="../id423663/index.html">Kami menulis penerjemah sederhana dalam Lisp - III</a></li>
<li><a href="../id423667/index.html">Sejarah video game mikroprosesor pertama</a></li>
<li><a href="../id423677/index.html">Pilot Jetpack: Frankie West</a></li>
<li><a href="../id423679/index.html">Tugas dengan gedung pencakar langit dan telur - bukan tempat sampah Newton?</a></li>
<li><a href="../id423683/index.html">Berdasarkan akal sehat: menumbuhkan DevOps dari awal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>