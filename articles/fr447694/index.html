<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèø üàπ ‚úãüèΩ Configuration du syst√®me distribu√© compil√© üó∫Ô∏è üç• ‚óºÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je voudrais vous dire un m√©canisme int√©ressant pour travailler avec une configuration de syst√®me distribu√©. La configuration est pr√©sent√©e directement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configuration du syst√®me distribu√© compil√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/primetalk/blog/447694/"><p>  Je voudrais vous dire un m√©canisme int√©ressant pour travailler avec une configuration de syst√®me distribu√©.  La configuration est pr√©sent√©e directement dans un langage compil√© (Scala) en utilisant des types s√ªrs.  Dans cet article, un exemple d'une telle configuration est analys√© et divers aspects de l'introduction d'une configuration compil√©e dans le processus de d√©veloppement global sont examin√©s. </p><br><p><img src="https://habrastorage.org/webt/71/bl/ax/71blaxtldz-ia4yftyebaxbam7c.png" alt="Cycle de vie de la configuration"></p><br><p>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">anglais</a> ) </p><a name="habracut"></a><br><h3 id="vvedenie">  Pr√©sentation </h3><br><p>  La construction d'un syst√®me distribu√© fiable implique que tous les n≈ìuds utilisent la configuration correcte, synchronis√©e avec les autres n≈ìuds.  En r√®gle g√©n√©rale, les technologies DevOps (terraform, ansible ou quelque chose comme √ßa) sont utilis√©es pour g√©n√©rer automatiquement des fichiers de configuration (souvent les leurs pour chaque n≈ìud).  Nous aimerions √©galement √™tre s√ªrs que tous les n≈ìuds en interaction utilisent des protocoles identiques (y compris la m√™me version).  Sinon, l'incompatibilit√© sera int√©gr√©e dans notre syst√®me distribu√©.  Dans le monde JVM, l'une des cons√©quences de cette exigence est la n√©cessit√© d'utiliser partout la m√™me version d'une biblioth√®que contenant des messages de protocole. </p><br><p>  Qu'en est-il des tests de syst√®mes distribu√©s?  Bien entendu, nous supposons que des tests unitaires sont fournis pour tous les composants avant de passer aux tests d'int√©gration.  (Pour que nous puissions extrapoler les r√©sultats des tests √† l'ex√©cution, nous devons √©galement fournir un ensemble identique de biblioth√®ques au stade des tests et √† l'ex√©cution.) </p><br><p>  Lorsque vous travaillez avec des tests d'int√©gration, il est souvent plus facile partout d'utiliser un seul chemin de classe sur tous les n≈ìuds.  Nous n'aurons qu'√† nous assurer que le m√™me chemin de classe est impliqu√© dans le runtime.  (Malgr√© le fait qu'il soit tout √† fait possible d'ex√©cuter diff√©rents n≈ìuds avec des chemins de classe diff√©rents, cela entra√Æne des complications de la configuration enti√®re et des difficult√©s avec les tests de d√©ploiement et d'int√©gration.) Dans le cadre de cette publication, nous supposons que le m√™me chemin de classe sera utilis√© sur tous les n≈ìuds. </p><br><p>  La configuration √©volue avec l'application.  Pour identifier les diff√©rentes √©tapes de l'√©volution des programmes, nous utilisons des versions.  Il semble logique d'identifier √©galement diff√©rentes versions des configurations.  Et la configuration elle-m√™me doit √™tre plac√©e dans le syst√®me de contr√¥le de version.  S'il n'y a qu'une seule configuration en production, alors nous pouvons simplement utiliser le num√©ro de version.  Si de nombreuses instances de production sont utilis√©es, nous avons besoin de plusieurs <br>  branches de configuration et une √©tiquette suppl√©mentaire en plus de la version (par exemple, le nom de la branche).  Ainsi, nous pouvons identifier de mani√®re unique la configuration exacte.  Chaque identificateur de configuration correspond de mani√®re unique √† une certaine combinaison de n≈ìuds distribu√©s, de ports, de ressources externes et de versions de biblioth√®que.  Dans le cadre de cet article, nous partirons du fait qu'il n'y a qu'une seule branche, et nous pouvons identifier la configuration de la mani√®re habituelle en utilisant trois nombres s√©par√©s par un point (1.2.3). </p><br><p>  Dans les environnements modernes, les fichiers de configuration sont cr√©√©s manuellement assez rarement.  Le plus souvent, ils sont g√©n√©r√©s lors du d√©ploiement et ils ne sont plus touch√©s (pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne rien casser</a> ).  Une question logique se pose, pourquoi utilisons-nous toujours un format texte pour stocker la configuration?  Une alternative tout √† fait viable est la possibilit√© d'utiliser du code normal pour la configuration et de b√©n√©ficier des contr√¥les lors de la compilation. </p><br><p>  Dans cet article, nous explorons simplement l'id√©e de repr√©senter une configuration √† l'int√©rieur d'un artefact compil√©. </p><br><h3 id="kompiliruemaya-konfiguraciya">  Configuration compil√©e </h3><br><p>  Cette section d√©crit un exemple de configuration compil√©e statique.  Deux services simples sont mis en ≈ìuvre - le service d'√©cho et le service d'√©cho client.  Sur la base de ces deux services, deux versions du syst√®me sont assembl√©es.  Dans un mode de r√©alisation, les deux services sont situ√©s sur le m√™me n≈ìud, dans un autre mode de r√©alisation, sur des n≈ìuds diff√©rents. </p><br><p> En r√®gle g√©n√©rale, un syst√®me distribu√© contient plusieurs n≈ìuds.  Les n≈ìuds peuvent √™tre identifi√©s √† l'aide de valeurs d'un certain type <code>NodeId</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Backend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Frontend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span></span></code> </pre> <br><p>  ou </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">hostName: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  ou m√™me </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span></code> </pre> <br><p>  Les n≈ìuds jouent diff√©rents r√¥les, des services y sont lanc√©s et des communications TCP / HTTP peuvent √™tre √©tablies entre eux. </p><br><p>  Pour d√©crire les communications TCP, nous avons besoin d'au moins un num√©ro de port.  Nous aimerions √©galement refl√©ter le protocole pris en charge sur ce port afin de garantir que le client et le serveur utilisent le m√™me protocole.  Nous d√©crirons la connexion en utilisant cette classe: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TcpEndPoint</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">node: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">NodeId</span></span></span></span><span class="hljs-class"><span class="hljs-params">, port: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Port</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Protocol</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  o√π <code>Port</code> est juste un entier <code>Int</code> avec une plage de valeurs valides: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortNumber</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">Closed</span></span>[_0, <span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-number"><span class="hljs-number">65535</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Types raffin√©s</b> <div class="spoiler_text"><p>  Voir la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">raffin√©e</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> .  En bref, la biblioth√®que vous permet d'ajouter des types de contraintes v√©rifi√©es lors de la compilation.  Dans ce cas, les valeurs de num√©ro de port valides sont des nombres entiers de 16 bits.  Pour une configuration compil√©e, l'utilisation de la biblioth√®que raffin√©e est facultative, mais elle peut am√©liorer la capacit√© du compilateur √† v√©rifier la configuration. </p></div></div><br><p>  Pour les protocoles HTTP (REST), en plus du num√©ro de port, nous pouvons √©galement avoir besoin d'un chemin d'acc√®s au service: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlPathPrefix</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">MatchesRegex</span></span>[<span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-string"><span class="hljs-string">"[a-zA-Z_0-9/]*"</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortWithPrefix</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">portNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">PortNumber</span></span></span></span><span class="hljs-class"><span class="hljs-params">, pathPrefix: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UrlPathPrefix</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Types fant√¥mes</b> <div class="spoiler_text"><p>  Pour identifier le protocole au stade de la compilation, nous utilisons un param√®tre de type qui n'est pas utilis√© √† l'int√©rieur de la classe.  Cette d√©cision est due au fait qu'√† l'ex√©cution, nous n'utilisons pas d'instance de protocole, mais nous aimerions que le compilateur v√©rifie la compatibilit√© du protocole.  Gr√¢ce au protocole, nous ne pourrons pas transf√©rer le service inadapt√© comme d√©pendance. </p></div></div><br><p>  Un protocole commun est l'API REST avec la s√©rialisation Json: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonHttpRestProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  o√π <code>RequestMessage</code> est le type de demande, <code>ResponseMessage</code> est le type de r√©ponse. <br>  Bien s√ªr, vous pouvez utiliser d'autres descriptions de protocoles qui fournissent la pr√©cision dont nous avons besoin. </p><br><p>  Aux fins de cet article, nous utiliserons une version simplifi√©e du protocole: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleHttpGetRest</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  Ici, la demande est une cha√Æne ajout√©e √† l'URL et la r√©ponse est la cha√Æne renvoy√©e dans le corps de la r√©ponse HTTP. </p><br><p>  La configuration du service est d√©crite par le nom du service, les ports et les d√©pendances.  Ces √©l√©ments peuvent √™tre repr√©sent√©s dans Scala de plusieurs mani√®res (par exemple, <code>HList</code> , types de donn√©es alg√©briques).  Aux fins de cet article, nous utiliserons le mod√®le de g√¢teau et repr√©senterons les modules en utilisant les <code>trait</code> .  (Cake Pattern n'est pas un √©l√©ment n√©cessaire de l'approche d√©crite. Ce n'est qu'une des impl√©mentations possibles.) </p><br><p>  Les d√©pendances entre les services peuvent √™tre repr√©sent√©es comme des m√©thodes qui renvoient <code>EndPoint</code> ports <code>EndPoint</code> d'autres n≈ìuds: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">SimpleHttpGetRest</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8081</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoPort</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]](portNumber, <span class="hljs-string"><span class="hljs-string">"echo"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoService</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = providedSimpleService(echoPort) }</code> </pre> <br><p>  Pour cr√©er un service d'√©cho, seuls un num√©ro de port et une indication que ce port prend en charge le protocole d'√©cho sont suffisants.  Nous n'avons pas pu indiquer de port sp√©cifique, car  les traits vous permettent de d√©clarer des m√©thodes sans impl√©mentation (m√©thodes abstraites).  Dans ce cas, lors de la cr√©ation d'une configuration sp√©cifique, le compilateur nous obligerait √† fournir une impl√©mentation de m√©thode abstraite et √† fournir un num√©ro de port.  Depuis que nous avons impl√©ment√© la m√©thode, lors de la cr√©ation d'une configuration sp√©cifique, nous ne pouvons pas sp√©cifier un autre port.  La valeur par d√©faut sera utilis√©e. </p><br><p>  Dans la configuration client, nous d√©clarons une d√©pendance au service d'√©cho: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMessage</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pollInterval</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">FiniteDuration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoServiceDependency</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[_, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] }</code> </pre> <br><p>  La d√©pendance est du m√™me type que le service export√© <code>echoService</code> .  En particulier, dans le client d'√©cho, nous avons besoin du m√™me protocole.  Par cons√©quent, lors de la connexion des deux services, nous pouvons √™tre s√ªrs que tout fonctionnera correctement. </p><br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation des services</b> <div class="spoiler_text"><p>  Pour d√©marrer et arr√™ter le service, une fonction est requise.  (La possibilit√© d'arr√™ter le service est essentielle pour les tests.) Encore une fois, il existe plusieurs options pour impl√©menter cette fonction (par exemple, nous pourrions utiliser des classes de type bas√©es sur le type de configuration).  Aux fins de cet article, nous utiliserons le mod√®le de g√¢teau.  Nous repr√©senterons le service √† l'aide de la classe <code>cats.Resource</code> , car  Dans cette classe, les moyens de lib√©ration s√ªre et s√©curis√©e des ressources en cas de probl√®me sont d√©j√† fournis.  Pour obtenir la ressource, nous devons fournir une configuration et un contexte d'ex√©cution pr√™t.  La fonction de d√©marrage du service peut prendre la forme suivante: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResourceReader</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">Reader</span></span>[<span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Resource</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>]] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> implicit resolver: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">AddressResolver</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], timer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Timer</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], contextShift: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ContextShift</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], ec: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span><span class="hljs-class"><span class="hljs-params">, applicative: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Applicative</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] }</code> </pre> <br><p>  o√π </p><br><ul><li>  <code>Config</code> - type de configuration pour ce service </li><li>  <code>AddressResolver</code> - un objet d'ex√©cution qui vous permet de trouver les adresses d'autres n≈ìuds (voir ci-dessous) </li></ul><br><p>  et d'autres types de la biblioth√®que des <code>cats</code> : </p><br><ul><li>  <code>F[_]</code> - type d'effet (dans le cas le plus simple, <code>F[A]</code> peut simplement √™tre une fonction <code>() =&gt; A</code> Dans ce post, nous utiliserons <code>cats.IO</code> ) </li><li>  <code>Reader[A,B]</code> - plus ou moins synonyme de la fonction <code>A =&gt; B</code> </li><li>  <code>cats.Resource</code> - une ressource qui peut √™tre obtenue et publi√©e </li><li>  <code>Timer</code> - minuterie (vous permet de vous endormir pendant un certain temps et de mesurer les intervalles de temps) </li><li>  <code>ContextShift</code> - analogue d' <code>ExecutionContext</code> </li><li>  <code>Applicative</code> - une classe de type d'effet qui vous permet de combiner des effets individuels (presque une monade).  Dans les applications plus complexes, il semble pr√©f√©rable d'utiliser <code>Monad</code> / <code>ConcurrentEffect</code> . </li></ul><br><p>  En utilisant cette signature de fonction, nous pouvons impl√©menter plusieurs services.  Par exemple, un service qui ne fait rien: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Any</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resource</span></span></span></span>(...): <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] = <span class="hljs-type"><span class="hljs-type">Reader</span></span>(_ =&gt; <span class="hljs-type"><span class="hljs-type">Resource</span></span>.pure[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>](())) }</code> </pre> </div></div><br><p>  (Voir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code source</a> pour d'autres services - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service d'</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©cho, client d'√©cho</a> <br>  et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contr√¥leurs √† vie</a> .) </p><br><p>  Un n≈ìud est un objet qui peut d√©marrer plusieurs services (le lancement de la cha√Æne de ressources est assur√© par le Cake Pattern): </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  Veuillez noter que nous indiquons le type exact de configuration requis pour ce n≈ìud.  Si nous oublions de sp√©cifier l'un des types de configuration requis par un service distinct, il y aura une erreur de compilation.  De plus, nous ne pourrons pas d√©marrer le n≈ìud si nous ne fournissons pas un objet du type appropri√© avec toutes les donn√©es n√©cessaires. </p><br><div class="spoiler">  <b class="spoiler_title">R√©solution du nom d'h√¥te</b> <div class="spoiler_text"><p>  Pour se connecter √† un h√¥te distant, nous avons besoin d'une v√©ritable adresse IP.  Il est possible que l'adresse soit connue plus tard que le reste de la configuration.  Par cons√©quent, nous avons besoin d'une fonction qui mappe l'identifiant du n≈ìud √† l'adresse: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeAddress</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodeId</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">host: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Uri</span></span></span></span><span class="hljs-class"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Host</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressResolver</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolve</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>](nodeId: <span class="hljs-type"><span class="hljs-type">NodeId</span></span>): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">NodeAddress</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>]] }</code> </pre> <br><p>  Vous pouvez proposer plusieurs fa√ßons de mettre en ≈ìuvre une telle fonction: </p><br><ol><li>  Si les adresses nous sont connues avant le d√©ploiement, nous pouvons g√©n√©rer un code Scala avec <br>  adresses, puis d√©marrez l'assemblage.  Cela compilera et ex√©cutera les tests. <br>  Dans ce cas, la fonction sera connue statiquement et pourra √™tre repr√©sent√©e dans le code comme un affichage de carte <code>Map[NodeId, NodeAddress]</code> . </li><li>  Dans certains cas, une adresse valide n'est connue qu'apr√®s le d√©marrage du n≈ìud. <br>  Dans ce cas, nous pouvons impl√©menter un ¬´service de d√©couverte¬ª (d√©couverte), qui s'ex√©cute avant que les autres n≈ìuds et tous les n≈ìuds s'enregistrent dans ce service et demandent les adresses des autres n≈ìuds. </li><li>  Si nous pouvons modifier <code>/etc/hosts</code> , alors nous pouvons utiliser des noms d'h√¥te pr√©d√©finis (comme <code>my-project-main-node</code> et <code>echo-backend</code> ) et simplement lier ces noms <br>  avec des adresses IP pendant le d√©ploiement. </li></ol><br><p>  Dans le cadre de cet article, nous ne traiterons pas ces cas plus en d√©tail.  Pour nos <br>  Dans un exemple de jouet, tous les n≈ìuds auront une adresse IP - <code>127.0.0.1</code> . </p></div></div><br><p>  Ensuite, nous consid√©rons deux options pour un syst√®me distribu√©: </p><br><ol><li>  Placement de tous les services sur un n≈ìud. </li><li>  Et le placement du service d'√©cho et du client d'√©cho sur diff√©rents n≈ìuds. </li></ol><br><p>  Configuration pour un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">seul n≈ìud</a> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuration √† n≈ìud unique</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">single</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configuration</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span> <span class="hljs-comment"><span class="hljs-comment">/** Type safe service port specification. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8088</span></span> <span class="hljs-comment"><span class="hljs-comment">// configuration of client /** We'll use the service provided by the same host. */ def echoServiceDependency = echoService override def testMessage: UrlPathElement = "hello" def pollInterval: FiniteDuration = 1.second // lifecycle controller configuration def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 requests, not 9. }</span></span></code> </pre> </div></div><br><p>  L'objet impl√©mente la configuration du client et du serveur.  La configuration de la dur√©e de vie est √©galement utilis√©e afin de terminer le programme apr√®s une <code>lifetime</code> .  (Ctrl-C fonctionne √©galement et lib√®re correctement toutes les ressources.) </p><br><p>  Le m√™me ensemble de traits de configuration et d'impl√©mentations peut √™tre utilis√© pour cr√©er un syst√®me compos√© de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux n≈ìuds distincts</a> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuration pour deux n≈ìuds</b> <div class="spoiler_text"><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeServerConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigTermLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeIdImpl</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeServer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8080</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeClientConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// NB! dependency specification def echoServiceDependency = NodeServerConfig.echoService def pollInterval: FiniteDuration = 1.second def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 request, not 9. def testMessage: String = "dolly" }</span></span></code> </pre> </div></div><br><p>  Important!  Notez comment la liaison de service est effectu√©e.  Nous indiquons le service impl√©ment√© par un n≈ìud comme l'impl√©mentation de la m√©thode de d√©pendance d'un autre n≈ìud.  Le type de d√©pendance est v√©rifi√© par le compilateur, car  contient le type de protocole.  Une fois lanc√©e, la d√©pendance contiendra l'identifiant correct du n≈ìud cible.  Gr√¢ce √† ce sch√©ma, nous indiquons le num√©ro de port exactement une fois et nous garantissons toujours de faire r√©f√©rence au port correct. </p><br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation de deux n≈ìuds syst√®me</b> <div class="spoiler_text"><p>  Pour cette configuration, nous utilisons la m√™me impl√©mentation de service sans modifications.  La seule diff√©rence est que nous avons maintenant deux objets qui impl√©mentent diff√©rents ensembles de services: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeServerImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigIntLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">SigTermLifecycleConfig</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeClientImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  Le premier n≈ìud impl√©mente le serveur et n'a besoin que de la configuration du serveur.  Le deuxi√®me n≈ìud est impl√©ment√© par le client et utilise une autre partie de la configuration.  Les deux n≈ìuds doivent √©galement g√©rer la dur√©e de vie.  Le n≈ìud serveur s'ex√©cute ind√©finiment jusqu'√† ce qu'il soit arr√™t√© par <code>SIGTERM</code> , et le n≈ìud client se termine apr√®s un certain temps.  Voir l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application de lancement</a> . </p></div></div><br><h4 id="obschiy-process-razrabotki">  Processus de d√©veloppement g√©n√©ral </h4><br><p>  Voyons comment cette approche de configuration affecte le processus de d√©veloppement global. </p><br><p>  La configuration sera compil√©e avec le reste du code et un artefact (.jar) sera g√©n√©r√©.  Apparemment, il est logique de placer la configuration dans un artefact s√©par√©.  Cela est d√ª au fait que nous pouvons avoir de nombreuses configurations bas√©es sur le m√™me code.  Encore une fois, vous pouvez g√©n√©rer des artefacts qui correspondent √† diff√©rentes branches de configuration.  Avec la configuration, les d√©pendances sur des versions sp√©cifiques des biblioth√®ques sont pr√©serv√©es et ces versions sont pr√©serv√©es pour toujours, chaque fois que nous d√©cidons de d√©ployer cette version de la configuration. </p><br><p>  Tout changement de configuration se transforme en un changement de code.  Et donc, chacun de ces <br>  Le changement sera couvert par le processus habituel d'assurance qualit√©: </p><br><p>  Un ticket dans le bugtracker -&gt; PR -&gt; revue -&gt; fusion avec les branches correspondantes -&gt; <br>  int√©gration -&gt; d√©ploiement </p><br><p>  Les principales cons√©quences de l'impl√©mentation d'une configuration compil√©e: </p><br><ol><li><p>  La configuration sera coordonn√©e sur tous les n≈ìuds du syst√®me distribu√©.  En raison du fait que tous les n≈ìuds re√ßoivent la m√™me configuration d'une seule source. </p><br></li><li><p>  Il est probl√©matique de modifier la configuration dans un seul des n≈ìuds.  Par cons√©quent, une ¬´d√©rive de configuration¬ª est peu probable. </p><br></li><li><p>  Il devient plus difficile de faire de petits changements de configuration. </p><br></li><li><p>  La plupart des modifications de configuration se produiront dans le cadre du processus de d√©veloppement global et seront examin√©es. </p><br></li></ol><br><p>  Ai-je besoin d'un r√©f√©rentiel s√©par√© pour stocker la configuration de production?  Une telle configuration peut contenir des mots de passe et d'autres informations secr√®tes, auxquelles nous aimerions restreindre.  Sur cette base, il semble logique de stocker la configuration finale dans un r√©f√©rentiel s√©par√©.  Vous pouvez diviser la configuration en deux parties - l'une contenant les param√®tres de configuration publics et l'autre contenant les param√®tres d'acc√®s restreint.  Cela permettra √† la plupart des d√©veloppeurs d'avoir acc√®s √† des param√®tres communs.  Cette s√©paration est facile √† r√©aliser en utilisant des traits interm√©diaires contenant des valeurs par d√©faut. </p><br><h3 id="vozmozhnye-variacii">  Variations possibles </h3><br><p>  Essayons de comparer la configuration compil√©e avec quelques alternatives courantes: </p><br><ol><li>  Un fichier texte sur la machine cible. </li><li>  Stockage centralis√© de valeurs-cl√©s ( <code>etcd</code> / <code>etcd</code> ). </li><li>  Composants de processus qui peuvent √™tre reconfigur√©s / red√©marr√©s sans red√©marrer le processus. </li><li>  Stockage de la configuration en dehors de l'artefact et du contr√¥le de version. </li></ol><br><p>  Les fichiers texte offrent une grande flexibilit√© en termes de petits changements.  L'administrateur syst√®me peut acc√©der au n≈ìud distant, apporter des modifications aux fichiers correspondants et red√©marrer le service.  Pour les grands syst√®mes, cependant, une telle flexibilit√© peut √™tre ind√©sirable.  Des modifications apport√©es, il n'y a aucune trace dans d'autres syst√®mes.  Personne n'examine les modifications.  Il est difficile de d√©terminer qui a effectu√© les changements et pour quelle raison.  Les modifications ne sont pas test√©es.  Si le syst√®me est distribu√©, l'administrateur peut oublier d'effectuer la modification correspondante sur d'autres n≈ìuds. </p><br><p>  (Il convient √©galement de noter que l'utilisation d'une configuration compil√©e ne bloque pas la possibilit√© d'utiliser des fichiers texte √† l'avenir. Il suffira d'ajouter un analyseur et un validateur qui donnent le m√™me type de <code>Config</code> en sortie, et vous pouvez utiliser des fichiers texte. Il s'ensuit imm√©diatement que la complexit√© du syst√®me avec la configuration compil√©e est quelque peu moins que la complexit√© d'un syst√®me utilisant des fichiers texte, car les fichiers texte n√©cessitent du code suppl√©mentaire.) </p><br><p>  Le stockage centralis√© des valeurs-cl√©s est un bon m√©canisme de distribution des m√©ta-param√®tres d'une application distribu√©e.  Nous devons d√©cider quels sont les param√®tres de configuration et quelles sont simplement les donn√©es.  Supposons que nous ayons une fonction <code>C =&gt; A =&gt; B</code> , les param√®tres <code>C</code> changeant rarement et les donn√©es <code>A</code> souvent.  Dans ce cas, nous pouvons dire que <code>C</code> est les param√®tres de configuration et <code>A</code> les donn√©es.  Il semble que les param√®tres de configuration diff√®rent des donn√©es en ce qu'ils changent g√©n√©ralement moins fr√©quemment que les donn√©es.  De plus, les donn√©es proviennent g√©n√©ralement d'une source (de l'utilisateur) et les param√®tres de configuration d'une autre (de l'administrateur syst√®me). </p><br><p>  Si des param√®tres rarement modifi√©s doivent √™tre mis √† jour sans red√©marrer le programme, cela peut souvent entra√Æner une complication du programme, car nous devrons en quelque sorte livrer les param√®tres, stocker, analyser et v√©rifier, traiter les valeurs incorrectes.  Par cons√©quent, du point de vue de la r√©duction de la complexit√© du programme, il est logique de r√©duire le nombre de param√®tres qui peuvent changer pendant le programme (ou de ne pas prendre en charge ces param√®tres du tout). </p><br><p>  Du point de vue de cet article, nous distinguerons les param√®tres statiques et dynamiques.  Si la logique du service n√©cessite de changer les param√®tres pendant le programme, alors nous appellerons ces param√®tres dynamiques.  Sinon, les param√®tres sont statiques et peuvent √™tre configur√©s √† l'aide d'une configuration compil√©e.  Pour la reconfiguration dynamique, nous pouvons avoir besoin d'un m√©canisme pour red√©marrer des parties du programme avec de nouveaux param√®tres, semblable √† la fa√ßon dont les processus du syst√®me d'exploitation sont red√©marr√©s.  (√Ä notre avis, il est conseill√© d'√©viter la reconfiguration en temps r√©el, car la complexit√© du syst√®me augmente. Si possible, il est pr√©f√©rable d'utiliser les capacit√©s standard du syst√®me d'exploitation pour red√©marrer les processus.) </p><br><p>  Un aspect important de l'utilisation d'une configuration statique qui oblige les utilisateurs √† envisager une reconfiguration dynamique est le temps n√©cessaire au red√©marrage du syst√®me apr√®s une mise √† jour de la configuration (temps d'arr√™t).  En fait, si nous devons apporter des modifications √† la configuration statique, nous devrons red√©marrer le syst√®me pour que les nouvelles valeurs prennent effet.  Le probl√®me de temps d'arr√™t a une gravit√© diff√©rente pour diff√©rents syst√®mes.  Dans certains cas, vous pouvez planifier un red√©marrage √† un moment o√π la charge est minimale.  Si vous souhaitez fournir un service continu, vous pouvez impl√©menter les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"connexions de drainage" (drainage de connexion AWS ELB)</a> .  Dans le m√™me temps, lorsque nous devons red√©marrer le syst√®me, nous lan√ßons une instance parall√®le de ce syst√®me, basculons vers l'√©quilibreur et attendons que les anciennes connexions soient termin√©es.  Une fois toutes les anciennes connexions termin√©es, nous d√©sactivons l'ancienne instance du syst√®me. </p><br><p>  Examinons maintenant la question du stockage de la configuration √† l'int√©rieur ou √† l'ext√©rieur de l'artefact.  Si nous stockons la configuration √† l'int√©rieur de l'artefact, au moins nous avons eu l'occasion lors de l'assemblage de l'artefact de s'assurer que la configuration √©tait correcte.  Si la configuration est en dehors de l'artefact contr√¥l√©, il est difficile de suivre qui et pourquoi ont apport√© des modifications √† ce fichier.  Est-ce important?  √Ä notre avis, pour de nombreux syst√®mes de production, il est important d'avoir une configuration stable et de haute qualit√©. </p><br><p>  La version de l'artefact vous permet de d√©terminer quand il a √©t√© cr√©√©, quelles valeurs il contient, quelles fonctions sont activ√©es / d√©sactiv√©es, qui est responsable de tout changement dans la configuration.  Bien s√ªr, le stockage de la configuration √† l'int√©rieur de l'artefact n√©cessite un certain effort, vous devez donc prendre une d√©cision √©clair√©e. </p><br><h3 id="za-i-protiv">  Le pour et le contre </h3><br><p>  Je voudrais m'attarder sur les avantages et les inconv√©nients de la technologie propos√©e. </p><br><h4 id="preimuschestva">  Les avantages </h4><br><p>  Voici une liste des principales caract√©ristiques d'une configuration de syst√®me distribu√© compil√©: </p><br><ol><li>  V√©rification de la configuration statique.  Vous permet d'√™tre s√ªr que <br>  La configuration est correcte. </li><li>   .         .   Scala      ,   . ,    <br> trait'    ,     ,    val',    (DRY)    .        ( <code>Seq</code> , <code>Map</code> ,  ). </li><li> DSL.  Scala    ,   DSL.        ,         , ,           .  , ,     . </li><li>     .    ,           ,       ,    ,   .        ,          .       ,       . </li><li>    .    ,    ,        . </li><li>   .          ,     . </li><li>  .     ,      .     . (  ,     ,     ,     ,     -.)       ‚Äî    .  , ,    ,       ,    . </li><li>  .          ,         .   , ,        .                .        .       ,       production'. </li><li> .    ,            .  ,           ,    ‚Äî   .      production- . </li><li>  Test.     mock-,     ,   . </li><li>  .                  .  , , ,     . </li></ol><br><h4 id="nedostatki-i-ogranicheniya">    </h4><br><p>               .    : </p><br><ol><li>  .       production',    .        .          .           . </li><li>  .  ,      ,        . </li><li> .      ,     ,    .    /      . </li><li>   .   DevOps    .             . </li><li>    .               (CI/CD).      . </li></ol><br><p>       ,      : </p><br><ol><li>      ,    ,        .    ,    Cake Pattern'     , , <code>HList</code>     (case class')   . </li><li>     ,     : ( <code>package</code> , <code>import</code> ,  ; <code>override def</code> '  ,    ).    ,    DSL.  ,    (, XML),       . </li><li>            . </li></ol><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>                  Scala.                 xml-   .   ,      Scala,          (  Kotlin, C#, Swift, ...).         , ,  ,    ,    ,   . </p><br><p> ,      .       . </p><br><p>     : </p><br><ol><li>         . </li><li>   DSL        . </li><li>         . ,       ,  (1)      ; (2)       . </li></ol><br><h3 id="blagodarnosti">  </h3><br><p>     ,          . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447694/">https://habr.com/ru/post/fr447694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447682/index.html">Space Data Center: 24 heures avant le lancement</a></li>
<li><a href="../fr447684/index.html">Comment afficher les valeurs de l'entreprise dans un bureau (sans affiches ni slogans)</a></li>
<li><a href="../fr447686/index.html">Un param√®tre tr√®s important des lampes LED, que peu de gens connaissent</a></li>
<li><a href="../fr447688/index.html">√Ä la question sur le bitset</a></li>
<li><a href="../fr447690/index.html">Configuration compilable d'un syst√®me distribu√©</a></li>
<li><a href="../fr447696/index.html">Pourquoi les villes s'opposent √† Amazon Go, les premiers magasins non cash</a></li>
<li><a href="../fr447698/index.html">Poudlard rouge: acad√©micien sans dipl√¥me</a></li>
<li><a href="../fr447700/index.html">La flexibilit√© √©motionnelle est la cl√© de la croissance personnelle.</a></li>
<li><a href="../fr447702/index.html">Le cercle math√©matique id√©al n'existe pas</a></li>
<li><a href="../fr447704/index.html">Escalade d'Elbrus - Reconnaissance au combat. Partie technique 1. Registres, piles et autres d√©tails techniques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>