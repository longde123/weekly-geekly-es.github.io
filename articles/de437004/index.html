<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏼 👨‍👩‍👦‍👦 ↕️ Träumen YML-Programmierer von ansiblen Tests? 🤾🏿 🏺 ⚛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist die Textversion der Performance 2018-04-25 bei der Saint-Petersburg Linux User Group . Beispielcode hier: https://github.com/ultral/ansible-r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Träumen YML-Programmierer von ansiblen Tests?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437004/"><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="Küchen-CI-Schema"></p><br><p>  Dies ist die Textversion der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Performance</a> 2018-04-25 bei der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Saint-Petersburg Linux User Group</a> .  Beispielcode hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/ultral/ansible-role-testing</a> </p><br><p>  Ich glaube, dass Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfigurationsmanagement verwenden, nicht Bash</a> .  Das heißt,  Ihre Konfiguration ist Code.  Wenn wir sagen, dass Infrastruktur Code ist, sollte bei ihrer Erstellung dieselbe Philosophie angewendet werden wie bei der Softwareentwicklung.  Hast du darüber nachgedacht?  Wie machst du das  Und andere? </p><a name="habracut"></a><br><h1 id="prerekvizity">  Voraussetzungen </h1><br><p>  Im beschriebenen Fall gab es viele einleitende: </p><br><ul><li>  Viele ansible Rollen. </li><li>  Hyper-V als primärer Hypervisor. </li><li> Private Cloud mit eingeschränkten Funktionen zum Erstellen virtueller Maschinen im laufenden Betrieb. </li><li>  Proxy für den Zugang zum Internet. </li><li>  Die Unfähigkeit, Tests von ansiblen Rollen in Docker auszuführen, da die Rolle die Konfiguration der gesamten VM ist, einschließlich beispielsweise der Netzwerkeinstellungen. </li><li>  Sie möchten die Richtlinie des grünen Assistenten für ein Repository mit ansiblen Rollen verwenden. </li></ul><br><p>  Bevor wir das tun, was wir tun, vergleichen wir vorhandene Lösungen. </p><br><table><thead><tr><th>  Projekt </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Küche testen</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Molekül</a> </th><th>  Eigen </th></tr></thead><tbody><tr><td>  Sprache </td><td>  Rubin </td><td>  Python </td><td>  Bash / Rubin </td></tr><tr><td>  Beobachter </td><td>  132 </td><td>  126 </td><td>  0 </td></tr><tr><td>  Sterne </td><td>  1413 </td><td>  1154 </td><td>  1 </td></tr><tr><td>  Gabeln </td><td>  502 </td><td>  174 </td><td>  2 </td></tr><tr><td>  Lizenz </td><td>  Apache 2.0 </td><td>  MIT </td><td>  Beliebig </td></tr><tr><td>  Commits </td><td>  1929 </td><td>  1264 </td><td>  0 </td></tr><tr><td>  Veröffentlichungen </td><td>  101 </td><td>  121 </td><td>  0 </td></tr><tr><td>  Mitwirkende </td><td>  109 </td><td>  82 </td><td>  5 </td></tr></tbody></table><br><table><thead><tr><th>  Name </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">testinfra</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Serverspez</a> </th><th>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">inspec</a> </th><th>  Goss </th></tr></thead><tbody><tr><td>  Github </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">philpep / testinfra</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mizzy / serverspec</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">koch / inspec</a> </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aelsabbahy / goss</a> </td></tr><tr><td>  Sprache </td><td>  Python </td><td>  Rubin </td><td>  Rubin </td><td>  geh </td></tr><tr><td>  Beobachter </td><td>  93 </td><td>  145 </td><td>  165 </td><td>  67 </td></tr><tr><td>  Sterne </td><td>  997 </td><td>  2105 </td><td>  1167 </td><td>  2170 </td></tr><tr><td>  Gabeln </td><td>  138 </td><td>  361 </td><td>  330 </td><td>  156 </td></tr><tr><td>  Lizenz </td><td>  Apache 2.0 </td><td>  MIT </td><td>  Apache 2.0 </td><td>  Apache 2.0 </td></tr><tr><td>  Commits </td><td>  380 </td><td>  1854 </td><td>  4609 </td><td>  309 </td></tr><tr><td>  Veröffentlichungen </td><td>  35 </td><td>  282 </td><td>  346 </td><td>  47 </td></tr><tr><td>  Mitwirkende </td><td>  43 </td><td>  110 </td><td>  159 </td><td>  31 </td></tr></tbody></table><br><p>  Wir haben beschlossen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">das Rad</a> nicht <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">neu</a> zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erfinden</a> und eine schlüsselfertige Lösung zu finden.  Unser Infrastruktur-Team kennt sich mit Ruby aus, daher wurde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Test Kitchen</a> &amp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Inspec</a> ausgewählt </p><br><h1 id="kitchen-ci">  Küche-ci </h1><br><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="Küchen-CI-Schema"></p><br><p>  Die Idee ist hässlich einfach.  Wir erstellen eine neue virtuelle Maschine, verwenden die Rolle und führen einen Rauchtest durch. </p><br><h1 id="green-build-policy">  Grüne Baupolitik </h1><br><p><img src="https://habrastorage.org/webt/0i/pj/ky/0ipjkykp-b0bmksesauecyoxbdi.png" alt="Grünes Build-Richtlinienschema"></p><br><p>  Aber wir beschlossen, weiterzumachen.  Verwenden Sie einen Github-Fluss, d.h.  Rollen in einzelnen Brunchs und nach der Überprüfung von Merjim im Master.  Wenn die Tests in Ordnung sind, rollen wir die Rollen auf die Infrastruktur. </p><br><h1 id="vlozhennaya-virtualizaciya">  Verschachtelte Virtualisierung </h1><br><p>  Wie Sie sich erinnern, hatten wir Einschränkungen bei der Erstellung virtueller Maschinen, sodass wir eine unangenehme Entscheidung in Form einer verschachtelten Virtualisierung treffen mussten. </p><br><p><img src="https://habrastorage.org/webt/cy/5r/pn/cy5rpnk2a-hhcqzuyfszpfnvdfo.jpeg" alt="wir müssen tiefer gehen"></p><br><p>  Zunächst haben wir versucht, Virtualbox x32 nicht mit verschachtelter Unterstützung zu versehen.  Dies stellte sich aufgrund der Stabilität der Kernel-Panik als nicht sehr ideell heraus.  Der zweite wichtige Faktor ist, dass wir auf x86_64 sitzen, also wurde die Forschung fortgesetzt (hi libvirt), entschied sich jedoch für virtualbox, wie es auf unterstützten Betriebssystemen häufiger vorkommt. </p><br><h1 id="slozhnosti">  Schwierigkeiten </h1><br><p>  Während des Starts war alles gut. </p><br><h2 id="prokinut-nastroyki-proxy-s-hosta-v-gostya-gostya">  Überspringen Sie die Proxy-Einstellungen vom Host zum Gast </h2><br><p>  In einigen Testszenarien wurden Proxy-Einstellungen verwendet, während auf dem Host mit Testkitchen ein transparenter Proxy verwendet wurde und der Ansible-Bonus keine zusätzlichen Variablen mit leeren Werten akzeptierte. </p><br><p>  <em>Lösung:</em> kitschig - erstellen Sie eine ERB-Vorlage. </p><br><pre><code class="plaintext hljs">&lt;%= ENV['http_proxy'].to_s.empty? ? 'http://proxy.example.com:3128' : ENV['http_proxy'] %&gt;</code> </pre> <br><h2 id="upravlenie-setevymi-nastroykami-cherez-ansible">  Verwaltung der Netzwerkeinstellungen über ansible </h2><br><p>  In einigen Rollen wurde das Netzwerk konfiguriert, in Tests sah es folgendermaßen aus: </p><br><ul><li>  Wir konfigurieren das Netzwerk durch Kopieren der Datei. </li><li>  Wenden Sie die Netzwerkeinstellungen an. </li><li>  Alles ist schlecht. </li></ul><br><p>  <em>Lösung:</em> Fügen Sie der virtuellen Maschine eine Schnittstelle hinzu </p><br><h2 id="esli-testovyy-nabor-soderzhi-_-vse-padaet">  Wenn der Testsatz "_" enthält, fällt alles </h2><br><p>  Virtualbox kann "_" nicht im Namen der virtuellen Maschine verwenden.  Und die virtuelle Maschine verwendete den Namen des Skripts. </p><br><p>  <em>Lösung:</em> Benennen Sie die Testsätze "vm_" =&gt; "vm-" um </p><br><h2 id="testovye-scenarii-s-ustanovkoy-oracle-bez--v-konce-imeni-virtualnoy-mashiny-padayut">  Testfälle mit der Installation von Oracle ohne "."  am Ende des Namens der virtuellen Maschine fallen </h2><br><p>  Die Rolle wurde in einem bedingten Verkauf verwendet, als sie beschlossen, sie mit Tests abzudecken.  Wenn Sie es in eine vorbereitete VM rollen, erfüllt es die Rolle, es fällt durch die Testküche. </p><br><p>  Kleiner Hinweis </p><br><pre> <code class="plaintext hljs">[root@vm-oracle vagrant]# getent ahosts vm-oracle 127.0.0.1 STREAM vm-oracle 127.0.0.1 DGRAM 127.0.0.1 RAW [root@vm-oracle vagrant]# getent ahosts vm-oracle. fe80::a00:27ff:febd:bd6a STREAM vm-oracle fe80::a00:27ff:febd:bd6a DGRAM fe80::a00:27ff:febd:bd6a RAW 10.0.2.15 STREAM 10.0.2.15 DGRAM 10.0.2.15 RAW [root@oracle vagrant]# getent ahosts oracle.example.com. 192.168.128.182 STREAM oracle.example.local 192.168.128.182 DGRAM 192.168.128.182 RAW</code> </pre> <br><p>  Irgendeine Idee, was los ist? </p><br><p>  Es war ein lustiges Szenario: </p><br><ol><li>  Wir haben die IPv4-Bindung nur in den Oracle Listener-Einstellungen aktiviert. </li><li>  Orakel verwendet den FQDN. </li><li>  Linux enthält eine spezielle Basis "myhostname" zum Auflösen von Domainnamen, die nach / etc / hosts &amp; dns Servern verwendet wurde. </li><li>  Vagrant erstellt VM &amp; Updates <code>/etc/hosts</code> . </li></ol><br><p>  Ich werde ein wenig erklären: <br>  Was passiert bei <em>vm-oracle</em> ? </p><br><ol><li>  Vagrant erstellt eine virtuelle Maschine. </li><li>  vagabundierende Updates <code>/etc/hosts</code> ( <em>vm-oracle</em> x2) </li><li>  Oracle Listener hört IPv4. </li><li>  Oracle Listener löst den <em>VM-Oracle-</em> Domänennamen auf <em>.</em>  &amp; bekommt IPv6. </li><li>  FEHLGESCHLAGEN </li></ol><br><p>  Was passiert bei <em>vm-oracle?</em>  ? </p><br><ol><li>  Vagrant erstellt eine virtuelle Maschine. </li><li>  vagabundierende Updates / etc / hosts ( <em>vm-oracle</em> &amp; <em>vm-oracle.</em> ). </li><li>  Oracle Listener hört IPv4. </li><li>  Oracle Listener löst den <em>VM-Oracle-</em> Domänennamen auf <em>.</em>  &amp; bekommt IPv4 </li><li>  Ok </li></ol><br><h2 id="oom-v-gosti-k-nam-prihodit">  OOM kommt uns besuchen </h2><br><p>  OOM hat virtuelle Maschinen zufällig getötet.  Gleichzeitig gab Testkitchen alle möglichen seltsamen Nachrichten in seine Protokolle. </p><br><p>  <em>Lösung:</em> Erhöhen Sie den Speicherplatz. </p><br><h2 id="medlennye-bildy">  Langsame Builds </h2><br><p>  Dieses ganze Schema arbeitete langsam, zehn Minuten lang, manchmal länger als eine Stunde. </p><br><p>  <em>Lösungen:</em> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Packer</a> .  Stellen Sie Images der virtuellen Maschine vorab zusammen. </li><li>  Führen Sie mehrere Testfälle gleichzeitig aus </li></ul><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Wenn wir sagen, dass Infrastruktur Code ist, sollte bei ihrer Erstellung dieselbe Philosophie angewendet werden wie bei der Softwareentwicklung.  Einerseits haben wir eine funktionierende Lösung, aber es gibt einige unangenehme Momente: </p><br><ul><li>  Nicht freundlich, es sieht alles so aus. </li><li>  Eine Mischung aus Rubin und Python. </li><li>  Es gibt keine Prüfungen und Rollenrollen. </li><li>  Es funktioniert langsam. </li><li>  Schwierig .... </li></ul><br><p>  Am Ausgang sieht das Molekül mit Docker interessant und nativer aus.  Wir denken darüber nach. </p><br><h1 id="ssylki">  Referenzen </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Englische Version</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Leistungsfolien</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Codebeispiel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http://kitchen.ci/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/chef/kitchen-inspec</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://docs.chef.io/config_yml_kitchen.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://docs.chef.io/ctl_kitchen.html</a> </li><li>  <a href="">https://github.com/neillturner/kitchen-ansible/blob/master/provisioner_options.md</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de437004/">https://habr.com/ru/post/de437004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de436994/index.html">Liquibase und Maven</a></li>
<li><a href="../de436996/index.html">Abschlusskurs zur Python-Spezialisierung von Mail.ru Group</a></li>
<li><a href="../de436998/index.html">Schutz von Mikrochips vor Reverse Engineering und unbefugtem Betreten</a></li>
<li><a href="../de437000/index.html">Wie man Menschen den Umgang mit Git beibringt</a></li>
<li><a href="../de437002/index.html">Gültiger ASP.NET Core</a></li>
<li><a href="../de437006/index.html">Wanhao Duplicator 10 3D-Drucker Bewertung</a></li>
<li><a href="../de437008/index.html">NLP. Die Grundlagen. Techniken. Selbstentwicklung. Teil 1</a></li>
<li><a href="../de437010/index.html">Echos der Vergangenheit: Young's Erfahrung auf der Basis der neuen Röntgenspektroskopie-Methode</a></li>
<li><a href="../de437014/index.html">Die Aufgabe von N Körpern oder wie man eine Galaxie in die Luft jagt, ohne die Küche zu verlassen</a></li>
<li><a href="../de437018/index.html">Einige Fallstricke bei der statischen Eingabe in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>