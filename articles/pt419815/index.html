<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüåæ üïê ‚ÜîÔ∏è Segredos da toler√¢ncia a falhas do nosso escrit√≥rio üöµüèº #‚É£ üõåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como √© organizado um banco moderno? H√° um back office onde v√°rias opera√ß√µes s√£o realizadas, contas e relat√≥rios s√£o mantidos. H√° um escrit√≥rio interme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Segredos da toler√¢ncia a falhas do nosso escrit√≥rio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/419815/">  Como √© organizado um banco moderno?  H√° um back office onde v√°rias opera√ß√µes s√£o realizadas, contas e relat√≥rios s√£o mantidos.  H√° um escrit√≥rio intermedi√°rio onde as decis√µes s√£o tomadas e os riscos s√£o avaliados, onde os riscos de cr√©dito s√£o avaliados e os fraudadores s√£o neutralizados.  E existe um escrit√≥rio na frente onde eles atendem aos clientes e s√£o respons√°veis ‚Äã‚Äãpor sua intera√ß√£o com o banco por meio de v√°rios canais. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aad/a71/55c/aada7155cf378d6d91c3b52a528b4384.png"><br><br>  O Sberbank possui centenas de sistemas com disponibilidade e confiabilidade variadas.  Ele tem seu pr√≥prio desenvolvimento e solu√ß√µes in a box com diferentes graus de customiza√ß√£o, diferentes SLAs.  Todos os sistemas s√£o integrados entre si de v√°rias maneiras.  Neste post, mostraremos como todo esse formigueiro front-end √© constru√≠do de maneira a fornecer um atendimento cont√≠nuo ao cliente. <br><a name="habracut"></a><br>  Vamos come√ßar com a teoria.  Os principais princ√≠pios pelos quais um sistema √† prova de falhas √© constru√≠do podem ser emprestados de um submarino: <br><br><ol><li>  O submarino √© dividido em compartimentos independentes.  Se um compartimento √© inundado, o restante ainda sobrevive. <br></li><li>  Todos os componentes cr√≠ticos s√£o reservados.  Motores, tanques de oxig√™nio.  E os Beatles tamb√©m reservavam perisc√≥pios com vigias. <br></li><li>  O submarino √© protegido de condi√ß√µes cr√≠ticas na superf√≠cie - se necess√°rio, pode ir mais fundo e trabalhar l√° como se nada tivesse acontecido. <br></li></ol><br>  Ilustramos o primeiro princ√≠pio com um exemplo de nossa pr√°tica.  T√≠nhamos um sistema de cache distribu√≠do.  E uma vez carregado, um dos n√≥s de dados do cache falhou.  N√£o h√° problema: para manter a replica√ß√£o adequada, o controlador redistribuiu os dados para os n√≥s restantes.  Mas como resultado da redistribui√ß√£o, o tr√°fego de rede saltou e os pacotes come√ßaram a ser perdidos - incluindo sobrecarga de cache.  Em um ponto, o controlador decidiu que outro n√≥ de dados falhou, redistribuiu os dados novamente, o tr√°fego aumentou ... Como resultado, em menos de um minuto o sistema caiu completamente.  Felizmente, foi um circuito de carga e ningu√©m ficou ferido.  Mas passamos muito tempo procurando a causa. <br><br>  Pode-se argumentar que isso n√£o acontece com bancos de dados em cluster e servidores de √∫ltima gera√ß√£o - h√° redund√¢ncia embutida no n√≠vel do hardware.  Para citar Werner Vogels, CTO Amazon: "Tudo falha o tempo todo."  N√≥s ca√≠mos e clusters de banco de dados e servidor high-end.  Caiu devido a erros de configura√ß√£o, devido a problemas no software de gerenciamento.  Com a solu√ß√£o de cada problema, nossa confian√ßa nessas solu√ß√µes diminuiu.  Como resultado, chegamos √† conclus√£o: apenas os sistemas que s√£o divididos em partes independentes um do outro - principalmente independentes em gerenciamento - n√£o recusam. <br><br><h2>  Arquitetura multi-bloco </h2><br>  A solu√ß√£o para nossos problemas foi a arquitetura com v√°rios blocos.  Nele, todos os componentes de hardware, incluindo bancos de dados, s√£o divididos em blocos fracamente acoplados, quase independentes.  Cada bloco serve parte dos clientes, como ao compartilhar em bancos de dados.  Os n√≥s em cada bloco s√£o reservados em todos os n√≠veis, incluindo redund√¢ncia geogr√°fica.  Qualquer problema em um bloco n√£o afeta os outros.  Com um aumento no n√∫mero de clientes, podemos adicionar facilmente novos blocos e continuar trabalhando normalmente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/066/cb5/6c5/066cb56c5cf947823870e31d00c89403.png"><br>  <i>Arquitetura geral de blocos.</i>  <i>Todos os blocos s√£o reservados de acordo com o esquema 2N.</i>  <i>Cada data center possui um poderoso balanceador de carga de hardware.</i>  <i>Os data centers s√£o conectados por 2 a 3 canais de comunica√ß√£o independentes.</i> <br><br>  Os servidores s√£o distribu√≠dos em blocos de cinco tipos: <br><br><ul><li>  Router - uma unidade de controle que distribui clientes para o restante das unidades <br></li><li>  Bloco de clientes - o bloco principal que atende at√© 10 milh√µes de clientes <br></li><li>  Bloco piloto - aqui testamos novas vers√µes de aplicativos em clientes fi√©is (aproximadamente 300 mil pessoas, principalmente funcion√°rios do Sberbank) <br></li><li>  Unidade de convidado - usu√°rios n√£o autenticados s√£o atendidos por ela;  aqueles, por exemplo, que acessam o site <br></li><li>  Bloco de reserva - um bloco de seguran√ßa poderoso o suficiente para substituir dois blocos de clientes ao mesmo tempo <br></li></ul><br>  Dentro de cada bloco, o servidor de aplicativos e o servidor da web s√£o separados por canais de servi√ßo, mas os bancos de dados s√£o comuns.  Assim, podemos isolar os cen√°rios de falha mais comuns para que eles n√£o ultrapassem os limites do nosso canal. <br><br><h2>  Como isso funciona? </h2><br>  Primeiro, o usu√°rio entra na unidade do roteador.  Este bloco verifica a qual cliente o cliente pertence e o envia para l√° (ou para o convidado).  Al√©m disso, uma pessoa trabalha calmamente dentro de seu quarteir√£o.  Se ocorrer uma falha na unidade nativa, a pessoa retornar√° ao roteador e receber√° automaticamente uma dire√ß√£o da unidade de backup para trabalho adicional. <br><br>  O que acontece com os dados durante a opera√ß√£o?  As informa√ß√µes sobre a intera√ß√£o do cliente com o banco s√£o replicadas continuamente dos blocos do cliente para o banco de dados de arquivamento.  Tendo encontrado o usu√°rio, a unidade de backup extrai as informa√ß√µes necess√°rias sobre ele do banco de dados de arquivamento e, se necess√°rio, fornece dados - para que o usu√°rio n√£o congele quando surgem problemas de nossa parte. <br><br>  As opera√ß√µes que s√£o conduzidas na unidade de backup s√£o armazenadas nela.  Quando o bloco do cliente nativo do usu√°rio √© restaurado, ele volta.  As opera√ß√µes acumuladas no bloco de backup s√£o transferidas de forma ass√≠ncrona para os blocos de cliente necess√°rios.  Enquanto os dados s√£o reduzidos √† consist√™ncia, o cliente v√™ uma mensagem informando que todas as opera√ß√µes foram aceitas e salvas, mas devido ao trabalho t√©cnico, as opera√ß√µes mais recentes podem n√£o ser exibidas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/da5/362/a98da53620d3a2d57119975d2872e156.png"><br>  <i>Esquema geral do sistema</i> <br><br>  Em alguns casos, a mudan√ßa para o bloco de backup √© planejada com anteced√™ncia - por exemplo, ao atualizar no bloco do cliente.  Em seguida, a unidade de backup n√£o seleciona as sess√µes do cliente, mas em um determinado momento ela simplesmente inicia todas as novas opera√ß√µes.  Se voc√™ precisar mudar urgentemente para a unidade de backup, o administrador poder√° desativar todas as sess√µes.  Nesse caso, a sess√£o do usu√°rio ser√° interrompida e ele iniciar√° uma nova na unidade de backup.  A unidade do roteador, a prop√≥sito, possui sua pr√≥pria unidade de backup dedicada.  Portanto, ningu√©m fica sem uma roda sobressalente. <br><br><h2>  Atualiza√ß√£o de sistemas </h2><br>  Novas vers√µes de software s√£o implantadas primeiro no bloco piloto e s√£o mostradas a um p√∫blico limitado.  Ent√£o gradualmente nos blocos de clientes, e j√° no final - nos de reserva.  Portanto, se houver problemas no bloco do cliente com a nova vers√£o do software, podemos transferir clientes para o bloco de backup da vers√£o anterior. <br><br>  Quando uma nova funcionalidade rola para um bloco, ela n√£o liga automaticamente.  Os administradores fazem isso usando as caixas de sele√ß√£o - alternar entre recursos.  Voc√™ pode mudar os clientes para a nova vers√£o por grupos - √© assim que verificamos a rea√ß√£o das atualiza√ß√µes ao crescimento do p√∫blico. <br><br><h2>  Autonomia </h2><br>  Nosso sistema em si √© confi√°vel, mas ainda depende do back-end usado para opera√ß√µes.  Como se proteger de problemas?  N√≥s usamos tr√™s ferramentas. <br><br><ol><li>  <i>Pedidos pendentes</i> .  O cliente solicita que a opera√ß√£o seja conclu√≠da.  N√≥s o salvamos em nosso banco de dados e tentamos execut√°-lo no back-end.  Se o back-end n√£o responder, mostramos ao cliente uma mensagem de que a opera√ß√£o foi aceita e est√° sendo processada.  Quando o back-end aumenta, uma "janela de encaixe" separada l√™ opera√ß√µes incompletas do banco de dados e as "empurra" em lotes no sistema de back-end.  Para n√£o sobrecarregar a tabela principal com opera√ß√µes com um grande n√∫mero de consultas de baixa efici√™ncia, tamb√©m usamos a chamada tabela de token - uma lista de identificadores de opera√ß√µes incompletas.  Para n√£o eliminar o back-end que acabou de aumentar em centenas de milhares de opera√ß√µes, usamos lotes - eliminamos duzentas opera√ß√µes e esperamos, por exemplo, por alguns segundos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd3/af8/261/cd3af826195c4c177e55a7bdbbd2d786.png"><br><br>  Mas e se ocorrerem altera√ß√µes importantes entre a solicita√ß√£o do usu√°rio e a recupera√ß√£o de back-end?  Por exemplo, as taxas de c√¢mbio mudaram?  Nesse caso, a verifica√ß√£o dupla √© acionada.  Essas opera√ß√µes s√£o salvas na entrada e depois verificadas na execu√ß√£o.  Se algo n√£o convergir, a opera√ß√£o ser√° ajustada ou rejeitada. <br></li><li>  <i>Armazenamento em cache de dados</i> .  Quando um usu√°rio entra, por exemplo, no Sberbank Online, todas as informa√ß√µes necess√°rias sobre ele j√° s√£o vis√≠veis - contas, cart√µes, empr√©stimos etc.  Esses dados s√£o solicitados atrav√©s de um barramento de servi√ßo de uma d√∫zia de sistemas.  Se a resposta foi coletada rapidamente, em alguns segundos, mostramos os dados para o cliente e salvamos no cache do sistema de nosso banco de dados.  Caso contr√°rio, procuramos no banco de dados dados armazenados em cache anteriormente e mostramos ao cliente.  Obviamente, para isso, o cache n√£o deve ter mais que uma certa idade.  No entanto, quando o barramento de servi√ßo coleta os dados necess√°rios sob demanda, ele √© atualizado no cache do banco de dados e enviado ao cliente em vez dos antigos. <br><br>  Ao usar o aplicativo, isso significa que uma pessoa ver√° o status de sua conta alguns segundos depois de entrar.  Embora os dados possam estar um pouco desatualizados.  Se isso acontecer, depois de alguns segundos, os dados geralmente ser√£o substitu√≠dos pelos dados reais - o que significa que o barramento de servi√ßo coletou tudo o que voc√™ precisa. <br><br>  Al√©m disso, temos pr√©-armazenamento em cache usando replica√ß√£o.  Principalmente para diferentes dados de refer√™ncia.  N√≥s pr√©-carregamos esses dados no back-end, o cliente calmamente faz uma solicita√ß√£o para a opera√ß√£o e os enviamos.  Mesmo se os sistemas respons√°veis ‚Äã‚Äãpela manuten√ß√£o dos dados n√£o funcionarem, o usu√°rio n√£o precisar√° esperar mais uma vez. <br></li><li>  <i>Pausas t√©cnicas</i> .  Se o sistema de back-end falhar ou estiver em manuten√ß√£o, n√≥s o sinalizamos.  E ent√£o as opera√ß√µes que passam por ele s√£o imediatamente atendidas pela recusa.  Portanto, evitamos que o servidor de aplicativos fique cheio de solicita√ß√µes aguardando uma resposta por tempo limite.  Nesse modo, o armazenamento em cache de opera√ß√µes e dados que descrevemos anteriormente pode ser usado.  As quebras t√©cnicas s√£o definidas para cada cen√°rio de integra√ß√£o, manualmente pelo administrador ou automaticamente, com base no n√∫mero de solicita√ß√µes. <br></li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce4/643/7d5/ce46437d574e8a2353f82f3856c2648f.png"><br><br>  De qualquer forma, procuramos minimizar a expectativa do usu√°rio - se houver problemas, ele receber√° imediatamente uma mensagem sobre a impossibilidade da opera√ß√£o.  Tentamos minimizar o n√∫mero dessas mensagens e, portanto, aumentamos o tempo de vida de alguns dados em cache - isso nos permite estender a intera√ß√£o normal com os servi√ßos do banco. <br><br>  Em alguns cen√°rios, o armazenamento em cache n√£o deve ser descartado - por exemplo, ao emitir dinheiro.  √â poss√≠vel fraude por parte do cliente.  Tais opera√ß√µes em caixas eletr√¥nicos e ag√™ncias n√£o s√£o armazenadas em cache.  No banco da Internet, isso √© mais f√°cil - aceitamos o aplicativo, processamos ou rejeitamos. <br><br>  Como resultado, observando os princ√≠pios descritos no artigo, voc√™ pode obter sistemas com uma disponibilidade de 99,99% e superior. <br><br><h2>  Nossos planos </h2><br>  Agora, os planos s√£o minimizar o tempo de coloca√ß√£o no mercado de nosso sistema √∫nico, garantir a omnichannelity, levando em considera√ß√£o os recursos t√©cnicos e de neg√≥cios dos canais.  E tamb√©m migre sistemas legados, mantendo sua operacionalidade durante a mudan√ßa. <br><br>  <i>Agradecemos a Roman Shekhovtsov pela assist√™ncia ativa na prepara√ß√£o do post</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419815/">https://habr.com/ru/post/pt419815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419803/index.html">WANHAO DUPLICATOR 8 Mini coment√°rio</a></li>
<li><a href="../pt419805/index.html">O compilador super min√∫sculo - agora em russo</a></li>
<li><a href="../pt419807/index.html">Glaucoma - como n√£o ficar cego: vamos falar sobre tratamento ...</a></li>
<li><a href="../pt419811/index.html">A evolu√ß√£o dos monitores flex√≠veis</a></li>
<li><a href="../pt419813/index.html">Webinars do Skillbox: sele√ß√£o de sexta-feira</a></li>
<li><a href="../pt419817/index.html">Iniciando o Cluster RabbitMQ no Kubernetes</a></li>
<li><a href="../pt419819/index.html">Biomarcadores de envelhecimento. Fragilidade do painel. Parte 2</a></li>
<li><a href="../pt419823/index.html">Dueto incomum - senhas e imagens mnem√¥nicas</a></li>
<li><a href="../pt419825/index.html">Testando o desempenho de v√°rios tipos de unidades em um ambiente virtual</a></li>
<li><a href="../pt419829/index.html">A criptografia de chave padr√£o do OpenSSH √© pior que nenhuma</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>