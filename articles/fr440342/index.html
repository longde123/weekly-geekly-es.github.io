<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÄ ‚ò™Ô∏è üòá Code C # universel pour NET et JavaScript üàÇÔ∏è üë©‚Äçüë¶‚Äçüë¶ üç≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2013, alors que je travaillais au service photo du GFRANQ, j'ai particip√© au d√©veloppement d'un service web √©ponyme pour la publication et le trait...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Code C # universel pour NET et JavaScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440342/"><p>  En 2013, alors que je travaillais au service photo du GFRANQ, j'ai particip√© au d√©veloppement d'un service web √©ponyme pour la publication et le traitement des photos.  Des filtres et des transformations ont √©t√© d√©finis dans le fichier avec des param√®tres, et tout le traitement a √©t√© effectu√© sur le serveur.  Lors du d√©veloppement du service, il √©tait n√©cessaire de prendre en charge ces transformations c√¥t√© client pour l'aper√ßu.  Selon Larry Wall, l'une des vertus d'un programmeur est la paresse.  Par cons√©quent, en tant que programmeurs vraiment paresseux, nous avons pens√© √† la possibilit√© d'utiliser le m√™me code √† la fois c√¥t√© serveur et c√¥t√© client.  L'ensemble du d√©veloppement a √©t√© r√©alis√© en C #.  Apr√®s avoir recherch√© les biblioth√®ques et quelques tentatives, nous avons fi√®rement conclu que cela √©tait possible et avons commenc√© √† √©crire le code universel. </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ir/gs/y0/irgsy0wvrqkk5ybw0elxt5nagfk.png"></div><p></p><br><p> Pourquoi cet article est-il n√©cessaire?  En effet, 6 ann√©es se sont √©coul√©es depuis 2013, et de nombreuses technologies ont perdu de leur pertinence, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Script #</a> .  En revanche, de nouveaux sont apparus.  Par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bridge.NET</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Blazor</a> bas√© sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WebAssembly de</a> fantaisie. </p><br><p>  N√©anmoins, certaines id√©es peuvent encore √™tre utilis√©es.  Dans cet article, j'ai essay√© de les d√©crire le plus en d√©tail possible.  J'esp√®re que la mention de Silverlight et Flash provoquera un sourire avec un soup√ßon de nostalgie, et non une envie de critiquer les anciennes solutions.  Quoi qu'il en soit, ils ont contribu√© au d√©veloppement de l'industrie du Web. </p><a name="habracut"></a><br><h2 id="contents">  Table des mati√®res </h2><br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Table des mati√®res</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Objectif</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Description des filtres</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Description des collages</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Impl√©mentation</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Choisir une plate-forme pour le traitement des photos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Traduire C # en Javascript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les avantages</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Inconv√©nients</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La structure</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utiliser un alias</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liens vers des fichiers</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Remarques sur la mise en ≈ìuvre de .NET</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation de disposer</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation du verrou</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Stockage des masques en m√©moire</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Remarques sur la mise en ≈ìuvre de JavaScript</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Minification</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Minification manuelle</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Minification automatis√©e</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Modes de d√©bogage et de publication</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">crossOrigin, propri√©t√©</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Optimisations</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation des valeurs pr√©calcul√©es</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conversion d'une image en un tableau de pixels</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exemples de code</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">G√©n√©ral</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©tecter si une cha√Æne est un nombre</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Division enti√®re</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rotation et retournement d'une image √† l'aide du canevas et du bitmap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chargement d'images synchrones et asynchrones</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Script # uniquement</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©tection du type et de la version d'un navigateur</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rendu d'une ligne pointill√©e</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Animation de rotation</a> </li></ul></li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conclusion</a> </li></ul><br><br><h2 id="goal">  Objectif </h2><br><p>  Le d√©fi consiste √† mettre en ≈ìuvre le collage de photos et la fonctionnalit√© de retouche photo bas√©e sur un filtre c√¥t√© client et, si possible, c√¥t√© serveur √©galement.  Pour commencer, je vais couvrir comment les filtres et les collages sont mis en ≈ìuvre. </p><br><h3 id="description-of-filters">  Description des filtres </h3><br><p>  Dans le cadre de notre projet, <strong>un filtre</strong> est une s√©rie d'actions r√©alis√©es dans Photoshop et appliqu√©es √† une photo particuli√®re.  Voici des exemples de telles actions: </p><br><ul><li>  R√©glage de la luminosit√© </li><li>  R√©glage du contraste </li><li>  R√©glage de la saturation </li><li>  Ajustement des courbes de couleur </li><li>  Masquage dans diff√©rents modes </li><li>  Encadrement </li><li>  ... </li></ul><br><p>  Nous avons besoin d'un certain format pour d√©crire ces actions.  Bien s√ªr, il existe des formats courants tels que JSON et XML, mais il a √©t√© d√©cid√© de cr√©er notre propre format pour les raisons suivantes: </p><br><ul><li>  Besoin d'une architecture de code ind√©pendante de la plateforme (.NET, JavaScript, WinPhone, etc.) </li><li>  Besoin d'un format simple non hi√©rarchique de filtres, ce qui facilite l'√©criture d'un analyseur </li><li>  Les donn√©es XML et JSON consomment plus de m√©moire (dans ce cas particulier) </li></ul><br><p>  Voici √† quoi ressemble la s√©quence d'actions pour le filtre <strong>XPro Film</strong> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y_/oy/ad/y_oyadt7qubbsa9an37h32ostqs.png"></div><br><p>  Outre l'√©dition d'une photo avec un filtre, nous devions recadrer et faire pivoter l'image.  Oui, je savais qu'il existe des plugins jQuery pour recadrer et faire pivoter les images, mais ils semblaient surcharg√©s et s'√©cartaient de l'architecture universelle du projet. </p><br><h3 id="description-of-collages">  Description des collages </h3><br><p>  <strong>Un collage</strong> est un arrangement de plusieurs photos miniaturis√©es en une seule photo enti√®re (avec ou sans masque).  Il √©tait √©galement n√©cessaire de permettre aux utilisateurs de glisser-d√©poser les images disponibles sur le collage, de modifier leur position et leur √©chelle.  Votre collage peut ressembler √† ceci: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/084/250/1f8/0842501f87761a3c128b5f117719b10c.jpg"></div><br><p> La fonction de collage implique l'utilisation d'un format simple pour stocker des rectangles avec des coordonn√©es relatives de <code>0</code> √† <code>1</code> , les adresses des photos et les donn√©es de modification d'image.  Les coordonn√©es relatives sont utilis√©es car les m√™mes transformations c√¥t√© client sont appliqu√©es aux images de grande taille c√¥t√© serveur. </p><br><h2 id="implementation">  Impl√©mentation </h2><br><p>  Nous avons d√ª choisir la plateforme permettant aux utilisateurs de travailler avec des filtres et des collages </p><br><h3 id="choosing-a-platform-for-photo-processing">  Choisir une plate-forme pour le traitement des photos </h3><br><p>  Il existe plusieurs technologies Rich Internet Application ( <strong>RIA</strong> ) telles que: </p><br><ul><li>  Adobe flash </li><li>  Microsoft silverlight </li><li>  HTML 5 + JavaScript </li><li>  Client natif </li></ul><br><p>  Pour des raisons √©videntes, Flash et HTML sont les seules technologies qui m√©ritent l'attention car les autres ne sont pas compatibles avec plusieurs plates-formes.  De plus, le client Silverlight commence √† mourir.  Bien que j'aime vraiment le concept de <del>  du sel </del>  NaCl, malheureusement, cette technologie n'est prise en charge que par le navigateur Chrome et on ne sait pas encore quand elle sera prise en charge (et le sera jamais) par d'autres navigateurs populaires.  <em>Remarque √† partir de 2019: il le sera et le nom est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WebAssembly</a> .</em> </p><br><p>  Le choix a √©t√© fait en faveur de la plate-forme HTML5 tendance et progressive, dont la fonctionnalit√© est actuellement prise en charge par iOS, par opposition √† Flash.  Ce choix est √©galement bas√© sur le fait qu'il existe de nombreuses biblioth√®ques, qui vous permettent de compiler le code C # en Javascript.  Vous pouvez √©galement utiliser Visual Studio √† cette fin.  Les d√©tails sont donn√©s ci-dessous. </p><br><h3 id="translating-c-into-javascript">  Traduire C # en Javascript </h3><br><p>  HTML 5 + JavaScript a √©t√© s√©lectionn√© comme plateforme dans la section pr√©c√©dente.  Cela nous laisse donc une question, s'il est possible d'√©crire un code C # universel qui pourrait √™tre compil√© √† la fois .NET et JavaScript. </p><br><p>  Ainsi, un certain nombre de biblioth√®ques pour accomplir la t√¢che ont √©t√© trouv√©es: </p><br><ul><li>  Jsil </li><li>  Sharpkit </li><li>  Script # </li><li>  Et quelques autres disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur GitHub</a> . </li></ul><br><p>  En cons√©quence, il a √©t√© d√©cid√© d'utiliser <strong>Script #</strong> car JSIL fonctionne directement avec les assemblys et g√©n√®re du code moins pur (bien qu'il prenne en charge une plus large gamme de fonctionnalit√©s du langage C #) et SharpKit est un produit commercial.  Pour une comparaison d√©taill√©e de ces outils, voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la question sur stackoverflow</a> . </p><br><p>  Pour r√©sumer, ScriptSharp par rapport √† JavaScript √©crit manuellement pr√©sente les avantages et les inconv√©nients suivants: </p><br><h4 id="advantages">  Les avantages </h4><br><ul><li>  Possibilit√© d'√©crire un code C # universel pouvant √™tre compil√© sur .NET et d'autres plateformes (WinPhone, Mono) </li><li>  D√©veloppement dans un langage C # fortement typ√© supportant la POO </li><li>  Prise en charge des fonctionnalit√©s IDE (autocompl√©tion et refactoring) </li><li>  Capacit√© √† d√©tecter la majorit√© des erreurs au stade de la compilation </li></ul><br><h4 id="disadvantages">  Inconv√©nients </h4><br><ul><li>  Redondance et irr√©gularit√© du code JavaScript g√©n√©r√© (en raison de mscorlib). </li><li>  Prise en charge ISO-2 uniquement (pas de surcharge de fonction ou d'inf√©rence de type, d'extension et de g√©n√©riques) </li></ul><br><h3 id="structure">  La structure </h3><br><p>  Le processus de compilation du m√™me code C # en .NET et Javascript peut √™tre illustr√© par le sch√©ma suivant: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/8ba/bce/32c/8babce32c532d3b3954cdabebabb0e06.png" width="70%" alt="Traduction C # en sch√©ma .NET et JavaScript"></div><br><p>  Bien que .NET et HTML5 soient des technologies compl√®tement diff√©rentes, ils ont √©galement des fonctionnalit√©s similaires.  Cela s'applique √©galement au travail avec les graphiques.  Par exemple, .NET prend en charge <strong>Bitmap</strong> , JavaScript prend en charge son analogue - <strong>Canvas</strong> .  Il en va de m√™me pour les <strong>graphiques</strong> , le <strong>contexte</strong> et les tableaux de pixels.  Afin de tout combiner en un seul code, il a √©t√© d√©cid√© de d√©velopper l'architecture suivante: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/89c/427/74c/89c42774cf90bdc873a0c34619cf7207.png" width="50%" alt="Graphiques .NET et JavaScript courants"></div><br><p>  Bien s√ªr, il n'est pas limit√© √† deux plateformes.  √Ä titre de suivi, il est pr√©vu d'ajouter la prise en charge de WinPhone, puis, peut-√™tre, d'Android et d'iOS. </p><br><p>  Il est √† noter qu'il existe deux types d'op√©rations graphiques: </p><br><ul><li>  <strong>Utilisation des fonctions API</strong> ( <code>DrawImage</code> , <code>Arc</code> , <code>MoveTo</code> , <code>LineTo</code> ).  Les performances √©lev√©es et la prise en charge de l'acc√©l√©ration mat√©rielle sont des avantages comp√©titifs importants.  L'inconv√©nient est qu'ils peuvent √™tre impl√©ment√©s diff√©remment sur diff√©rentes plateformes. </li><li>  <strong>Pixel par pixel.</strong>  La prise en charge de la mise en ≈ìuvre de tous les effets et la couverture multiplateforme sont parmi les avantages.  L'inconv√©nient est la faible performance.  Cependant, vous pouvez att√©nuer les inconv√©nients par la parall√©lisation, les shaders et les tables pr√©calcul√©es (nous en discuterons plus loin dans la section suivante sur l'optimisation). </li></ul><br><p>  Comme vous pouvez le voir, la classe abstraite <strong>Graphics</strong> d√©crit toutes les m√©thodes de travail avec les graphiques;  ces m√©thodes sont impl√©ment√©es pour diff√©rentes plates-formes dans la classe d√©riv√©e.  Les alias suivants ont √©galement √©t√© √©crits pour r√©sumer des classes Bitmap et Canvas.  La version WinPhone utilise √©galement un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mod√®le d'adaptateur</a> . </p><br><h4 id="using-alias">  Utiliser un alias </h4><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP using System.Html; using System.Html.Media.Graphics; using System.Runtime.CompilerServices; using Bitmap = System.Html.CanvasElement; using Graphics = System.Html.Media.Graphics.CanvasContext2D; using ImageData = System.Html.Media.Graphics.ImageData; using Image = System.Html.ImageElement; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET using System.Drawing; using System.Drawing.Imaging; using System.Drawing.Drawing2D; using Bitmap = System.Drawing.Bitmap; using Graphics = System.Drawing.Graphics; using ImageData = System.Drawing.Imaging.BitmapData; using Image = System.Drawing.Bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Malheureusement, il est impossible de cr√©er des alias pour les types et tableaux non s√©curis√©s, en d'autres termes, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Alias ‚Äã‚Äã√† pointer (octet *) en C #</a> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre> <br><p>  Pour effectuer un traitement rapide des pixels √† l'aide de code C # non g√©r√©, tout en le compilant en Script #, nous avons introduit le sch√©ma suivant √† l'aide de directives: </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP PixelArray data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET byte* data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Le tableau de <code>data</code> est ensuite utilis√© pour impl√©menter diverses op√©rations pixel par pixel (telles que le masquage, le fisheye, le r√©glage de la saturation, etc.), parall√©lis√©es ou non. </p><br><h4 id="links-to-files">  Liens vers des fichiers </h4><br><p>  Un projet distinct est ajout√© √† la solution pour chaque plate-forme, mais, bien s√ªr, Mono, Script # et m√™me Silverlight ne peuvent pas faire r√©f√©rence aux assemblys .NET habituels.  Heureusement, Visual Studio dispose d'un m√©canisme pour ajouter des liens vers des fichiers, ce qui vous permet de r√©utiliser le m√™me code dans diff√©rents projets. </p><br><p>  Les directives du compilateur ( <code>DOTNET</code> , <code>SCRIPTSHARP</code> ) sont d√©finies dans les propri√©t√©s du projet dans les symboles de compilation conditionnelle. </p><br><h3 id="notes-on-net-implementation">  Remarques sur la mise en ≈ìuvre de .NET </h3><br><p>  Les abstractions et les alias ci-dessus nous ont aid√©s √† √©crire le code C # avec une faible redondance.  De plus, je tiens √† souligner les probl√®mes avec les plates-formes .NET et JavaScript que nous avons rencontr√©s lors du d√©veloppement du code de la solution. </p><br><h4 id="using-dispose">  Utilisation de disposer </h4><br><p>  Veuillez noter que l'inclusion de toute instance d'une classe C #, qui impl√©mente l'interface <code>IDisposable</code> , n√©cessite d'appeler la m√©thode <strong><code>Dispose</code></strong> ou d'appliquer l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instruction Using</a> .  Dans ce projet, ces classes sont Bitmap et Context.  Ce que j'ai dit ci-dessus n'est pas seulement la th√©orie, il a en fait une application pratique: le traitement d'un grand nombre de photos de grande taille (jusqu'√† 2400 x 2400 dpi) sur ASP.NET Developer Server x86 a entra√Æn√© une exception de m√©moire insuffisante.  Le probl√®me a √©t√© r√©solu apr√®s avoir ajout√© <code>Dispose</code> aux bons endroits.  D'autres conseils utiles sur la manipulation d'image sont donn√©s dans l'article suivant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">20 Pi√®ges de redimensionnement d'image</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fuite de m√©moire .NET: Pour √©liminer ou ne pas √©liminer, c'est la question de 1 Go</a> . </p><br><h4 id="using-lock">  Utilisation du verrou </h4><br><p>  En JavaScript, il existe une diff√©rence entre l'image d√©j√† t√©l√©charg√©e avec la balise <code>img</code> , pour laquelle vous pouvez sp√©cifier la source et l'√©v√©nement de chargement, et la toile marqu√©e avec <code>canvas</code> , sur laquelle vous pouvez dessiner quelque chose.  Dans .NET, ces √©l√©ments sont repr√©sent√©s par la m√™me classe <code>Bitmap</code> .  Ainsi, les alias Bitmap et Image dans .NET pointent vers la m√™me classe <code>System.Drawing.Bitmap</code> . Bitmap comme indiqu√© ci-dessus. </p><br><p>  N√©anmoins, cette division en <code>img</code> et <code>canvas</code> en JavaScript a √©galement √©t√© tr√®s utile dans la version .NET.  Le fait est que les filtres utilisent des masques pr√©charg√©s de diff√©rents threads;  ainsi, le motif de <strong>verrouillage</strong> est n√©cessaire pour √©viter l'exception lors de la synchronisation (l'image est copi√©e avec <strong>verrouillage</strong> et le r√©sultat est utilis√© sans verrouillage): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloneImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Image image</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP Bitmap result = (Bitmap)Document.CreateElement("canvas"); result.Width = image.Width; result.Height = image.Height; Graphics context = (Graphics)result.GetContext(Rendering.Render2D); context.DrawImage(image, 0, 0); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> Bitmap result; lock (image) result = new Bitmap(image); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><p>  Apr√®s tout, le <strong>verrouillage</strong> doit √©galement √™tre utilis√© lors de l'acc√®s aux propri√©t√©s d'un objet synchronis√© (en fait, toutes les propri√©t√©s sont des m√©thodes). </p><br><h4 id="storing-masks-in-memory">  Stockage des masques en m√©moire </h4><br><p>  Pour acc√©l√©rer le traitement, tous les masques potentiellement utilis√©s pour les filtres sont charg√©s en m√©moire au d√©marrage du serveur.  Quel que soit le format du masque, le bitmap t√©l√©charg√© sur le serveur utilise <code>4 * 2400 * 2400</code> ou <code>‚âà24 MB</code> de m√©moire (la taille d'image maximale est de <code>2400 * 2400</code> ; le nombre d'octets par pixel est de 4).  Tous les masques pour les filtres (‚âà30) et les collages (40) consommeront 1,5 Go - ce n'est pas beaucoup pour le serveur;  cependant, √† mesure que le nombre de masques augmente, cette quantit√© peut augmenter consid√©rablement.  √Ä l'avenir, nous utiliserons √©ventuellement des techniques de compression pour les masques stock√©s en m√©moire (aux formats .jpg et .png) suivies d'une d√©compression si n√©cessaire.  En fait, la taille peut √™tre r√©duite jusqu'√† 300 fois.  Un avantage suppl√©mentaire de cette approche est que la copie des images compress√©es va plus vite que les grandes;  ainsi, l'op√©ration de <strong>verrouillage</strong> prendra moins de temps et les threads seront bloqu√©s moins souvent. </p><br><h3 id="notes-on-javascript-implementation">  Remarques sur la mise en ≈ìuvre de JavaScript </h3><br><h4 id="minification">  Minification </h4><br><p>  J'ai refus√© d'utiliser le terme ¬´obscurcissement¬ª pour la raison suivante: ce terme est √† peine applicable √† un langage enti√®rement open-source, qui dans notre cas est JavaScript.  Cependant, l'anonymisation des identifiants peut perturber la lisibilit√© et la logique du code.  Et surtout, cette technique r√©duira consid√©rablement la taille du script (la version compress√©e est de ‚âà80 Ko). </p><br><p>  Il existe deux approches de la minification JavaScript: </p><br><ul><li>  <strong>Minification manuelle,</strong> qui est effectu√©e au stade de la g√©n√©ration √† l'aide de ScriptSharp. </li><li>  <strong>Minification automatis√©e,</strong> qui est effectu√©e apr√®s la phase de g√©n√©ration √† l'aide d'outils externes tels que Google Closure Compiler, Yui et d'autres outils. </li></ul><br><h5 id="manual-minification">  Minification manuelle </h5><br><p>  Pour raccourcir les noms des m√©thodes, classes et attributs, nous avons utilis√© cette syntaxe avant la d√©claration des entit√©s mentionn√©es ci-dessus.  Bien s√ªr, cela n'est pas n√©cessaire si vous travaillez avec des m√©thodes appel√©es √† partir de scripts et de classes externes (publics). </p><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP &amp;&amp; !DEBUG [ScriptName("a0")] #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Quoi qu'il en soit, les variables locales n'ont pas pu √™tre minimis√©es.  Ces constructions polluent le code et nuisent √† la lisibilit√© du code, ce qui est √©galement un s√©rieux inconv√©nient.  Cependant, cette technique peut r√©duire consid√©rablement la quantit√© de code JavaScript g√©n√©r√© et le g√¢cher √©galement. </p><br><p>  Un autre inconv√©nient est que vous devez garder un ≈ìil sur ces noms courts s'ils renomment les noms de m√©thode et de champ (en particulier, les noms remplac√©s dans les classes enfants) car dans ce cas, Script # ne se souciera pas des noms r√©p√©titifs.  Cependant, il n'autorisera pas les classes dupliqu√©es. </p><br><p>  Soit dit en passant, la fonctionnalit√© de minification des m√©thodes et des champs priv√©s et internes a d√©j√† √©t√© ajout√©e √† la version d√©velopp√©e du Script #. </p><br><h5 id="automated-minification">  Minification automatis√©e </h5><br><p>  Bien qu'il existe de nombreux outils pour la minification JavaScript, j'ai utilis√© le Google Closure Compiler pour sa marque et une bonne qualit√© de compression.  L'inconv√©nient de l'outil de minification de Google est qu'il ne peut pas compresser les fichiers CSS;  en revanche, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">YUI rel√®ve</a> ce d√©fi avec succ√®s.  En fait, Script # peut √©galement r√©duire les scripts mais g√®re ce d√©fi bien pire que Google Closure. </p><br><p>  L'outil de minification de Google a plusieurs niveaux de compression: espace, simple et avanc√©.  Nous avons choisi le niveau Simple pour le projet;  bien que le niveau avanc√© nous permette d'atteindre la qualit√© de compression maximale, il n√©cessite du code √©crit de telle mani√®re que les m√©thodes soient accessibles de l'ext√©rieur de la classe.  Cette minification a √©t√© partiellement effectu√©e manuellement √† l'aide de Script #. </p><br><h4 id="debug-and-release-modes">  Modes de d√©bogage et de publication </h4><br><p>  Les biblioth√®ques de d√©bogage et de publication ont √©t√© ajout√©es aux pages ASP.NET comme suit: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Gfranq.JavaScriptFilters.HtmlHelper.IsDebug</span></span></span><span class="hljs-tag">) { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span></code> </pre> <br><p>  Dans ce projet, nous avons r√©duit √† la fois les scripts et les fichiers de description des filtres. </p><br><h4 id="crossorigin-property">  crossOrigin, propri√©t√© </h4><br><p>  Pour acc√©der aux pixels d'une image particuli√®re, nous devons d'abord la convertir en toile.  Mais cela peut conduire √† une erreur CORS (Cross Origin Request Security).  Dans notre cas, le probl√®me a √©t√© r√©solu comme suit: </p><br><ul><li>  D√©finition de l' <code>crossOrigin = ''</code> c√¥t√© serveur. </li><li>  Ajout d'un en-t√™te sp√©cifique au package HTTP c√¥t√© serveur. </li></ul><br><p>  √âtant donn√© que ScriptSharp ne prend pas en charge cette propri√©t√© pour les √©l√©ments img, le code suivant a √©t√© √©crit: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Imported</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdvImage</span></span> { [IntrinsicProperty] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CrossOrigin { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { } } }</code> </pre> <br><p>  Ensuite, nous l'utiliserons comme ceci: </p><br><pre> <code class="plaintext hljs">((AdvImage)(object)result).CrossOrigin = "";</code> </pre> <br><p>  Cette technique vous permet d'ajouter n'importe quelle fonction √† l'objet sans erreurs de compilation.  En particulier, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">propri√©t√© <code>wheelDelta</code> n'est pas encore impl√©ment√©e</a> dans ScriptSharp (au moins dans la version 0.7.5).  Cette propri√©t√© indique le montant de la molette de d√©filement, qui est utilis√© pour cr√©er des collages.  C'est pourquoi il a √©t√© mis en ≈ìuvre de cette fa√ßon.  Un tel hack sale avec les propri√©t√©s n'est pas bon;  normalement, vous devez apporter des modifications au projet.  Mais pour m√©moire, je n'ai pas encore trouv√© de moyen de compiler ScriptSharp √† partir des sources. </p><br><p>  De telles images n√©cessitent que le serveur renvoie les en-t√™tes suivants dans ses en-t√™tes de r√©ponse (dans Global.asax): </p><br><pre> <code class="cs hljs">Response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"\*"</span></span>);</code> </pre> <br><p>  Pour plus d'informations sur Cross Origin Request Security, visitez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://enable-cors.org/</a> . </p><br><h3 id="optimizations">  Optimisations </h3><br><h4 id="using-the-precalculated-values">  Utilisation des valeurs pr√©calcul√©es </h4><br><p>  Nous avons utilis√© l'optimisation pour certaines op√©rations telles que la luminosit√©, le contraste et l'ajustement des courbes de couleur via le calcul pr√©liminaire des composantes de couleur r√©sultantes (r, g, b) pour toutes les valeurs possibles et une utilisation plus pouss√©e des tableaux obtenus pour changer directement les couleurs des pixels .  Il convient de noter que ce type d'optimisation ne convient que pour des op√©rations dans lesquelles la couleur du pixel r√©sultant n'est pas affect√©e par le pixel adjacent. </p><br><p>  Le calcul des composantes de couleur r√©sultantes pour toutes les valeurs possibles: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { r[i] = ActionFuncR(i); g[i] = ActionFuncG(i); b[i] = ActionFuncB(i); }</code> </pre> <br><p>  L'utilisation de composants de couleur pr√©calcul√©s: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; data.Length; i += <span class="hljs-number"><span class="hljs-number">4</span></span>) { data[i] = r[data[i]]; data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = g[data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]]; data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>] = b[data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]]; }</code> </pre> <br><p>  Si de telles op√©rations de table vont une par une, il n'est pas n√©cessaire de calculer des images interm√©diaires - vous pouvez passer uniquement les tableaux de composants de couleur.  Le code fonctionnant assez rapidement c√¥t√© client et c√¥t√© serveur, il a √©t√© d√©cid√© de mettre de c√¥t√© l'impl√©mentation de cette optimisation.  En outre, l'optimisation a provoqu√© un comportement ind√©sirable.  Cependant, je vais vous donner une liste de l'optimisation: </p><br><table><tbody><tr><td>  Code d'origine </td><td>  Code optimis√© </td></tr><tr><td>  `` `cs <br>  // Calcul des valeurs pour la premi√®re table. <br>  pour (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // Calcul de l'image interm√©diaire r√©sultante. <br>  pour (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  donn√©es [i] = r [donn√©es [i]]; <br>  donn√©es [i + 1] = g [donn√©es [i + 1]]; <br>  donn√©es [i + 2] = b [donn√©es [i + 2]]; <br>  } <br>  // ... <br><br>  // Calcul des valeurs pour la deuxi√®me table. <br>  pour (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc2R (i); <br>  g [i] = ActionFunc2G (i); <br>  b [i] = ActionFunc2B (i); <br>  } <br>  // ... <br><br>  // Calcul de l'image r√©sultante. <br>  pour (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  donn√©es [i] = r [donn√©es [i]]; <br>  donn√©es [i + 1] = g [donn√©es [i + 1]]; <br>  donn√©es [i + 2] = b [donn√©es [i + 2]]; <br>  } <br>  `` `` <br><br></td><td>  `` `cs <br>  // Calcul des valeurs pour la premi√®re table. <br>  pour (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = ActionFunc1R (i); <br>  g [i] = ActionFunc1G (i); <br>  b [i] = ActionFunc1B (i); <br>  } <br>  // ... <br><br>  // Calcul des valeurs pour la deuxi√®me table. <br>  tr = r.Clone (); <br>  tg = g.Clone (); <br>  tb = b.Clone (); <br>  pour (int i = 0; i &lt;256; i ++) <br>  { <br>  r [i] = tr [ActionFunc2R (i)]; <br>  g [i] = tg [ActionFunc2G (i)]; <br>  b [i] = tb [ActionFunc2B (i)]; <br>  } <br>  // ... <br><br>  // Calcul de l'image r√©sultante. <br>  pour (int i = 0; i &lt;data.Length; i + = 4) <br>  { <br>  donn√©es [i] = r [donn√©es [i]]; <br>  donn√©es [i + 1] = g [donn√©es [i + 1]]; <br>  donn√©es [i + 2] = b [donn√©es [i + 2]]; <br>  } <br>  `` `` <br><br></td></tr></tbody></table><br><p>  Mais m√™me cela, ce n'est pas tout.  Si vous regardez le tableau de droite, vous remarquerez que de nouveaux tableaux sont cr√©√©s √† l'aide de la m√©thode <code>Clone</code> .  En fait, vous pouvez simplement changer les pointeurs sur les anciens et les nouveaux tableaux au lieu de copier le tableau lui-m√™me (cela rappelle l'analogie de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">double mise en m√©moire tampon</a> ). </p><br><h4 id="converting-an-image-to-an-array-of-pixels">  Conversion d'une image en un tableau de pixels </h4><br><p>  Le profileur JavaScript dans Google Chrome a r√©v√©l√© que la fonction <code>GetImageData</code> (qui est utilis√©e pour convertir le canevas en tableau de pixels) fonctionne suffisamment longtemps.  Soit dit en passant, ces informations peuvent √™tre trouv√©es dans divers articles sur l'optimisation de Canvas en JavaScript. </p><br><p>  Cependant, le nombre d'appels de cette fonction peut √™tre minimis√©.  √Ä savoir, nous pouvons utiliser le m√™me tableau de pixels pour les op√©rations pixel par pixel, par analogie avec l'optimisation pr√©c√©dente. </p><br><h2 id="code-examples">  Exemples de code </h2><br><p>  Dans les exemples ci-dessous, je fournirai les fragments de code que j'ai trouv√© int√©ressants et utiles.  Pour √©viter que l'article ne soit trop long, j'ai cach√© les exemples sous un spoiler. </p><br><h3 id="general">  G√©n√©ral </h3><br><h4 id="detecting-whether-a-string-is-a-number">  D√©tecter si une cha√Æne est un nombre </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNumeric</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !SCRIPTSHARP return ((Number)int.Parse(n)).ToString() != "NaN"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> double number; return double.TryParse(n, out number); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><h4 id="integer-division">  Division enti√®re </h4><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Div</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = n / k; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP result = Math.Floor(n / k); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return result; }</span></span></code> </pre> <br><h4 id="rotating-and-flipping-an-image-using-canvas-and-bitmap">  Rotation et retournement d'une image √† l'aide du canevas et du bitmap </h4><br><p>  Veuillez noter qu'en html5, les images de canevas peuvent √™tre pivot√©es de 90 et 180 degr√©s uniquement √† l'aide de matrices, tandis que .NET offre des fonctionnalit√©s am√©lior√©es.  Ainsi, une fonction pr√©cise appropri√©e pour travailler avec les pixels a √©t√© √©crite. </p><br><p>  Il convient √©galement de noter qu'une rotation de 90 degr√©s sur n'importe quel c√¥t√© dans la version .NET peut renvoyer des r√©sultats incorrects.  Par cons√©quent, vous devez cr√©er un nouveau <code>Bitmap</code> apr√®s avoir utilis√© la fonction <code>RotateFlip</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RotateFlip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap, RotFlipType rotFlipType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP int t, i4, j4, w, h, c; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipNone) return bitmap; GraphicsContext context; PixelArray data; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; for (int i = 0; i &lt; h; i++) { c = (i + 1) * w * 4 - 4; for (int j = 0; j &lt; w / 2; j++) { i4 = (i * w + j) * 4; j4 = j * 4; t = (int)data[i4]; data[i4] = data[c - j4]; data[c - j4] = t; t = (int)data[i4 + 1]; data[i4 + 1] = data[c - j4 + 1]; data[c - j4 + 1] = t; t = (int)data[i4 + 2]; data[i4 + 2] = data[c - j4 + 2]; data[c - j4 + 2] = t; t = (int)data[i4 + 3]; data[i4 + 3] = data[c - j4 + 3]; data[c - j4 + 3] = t; } } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone || rotFlipType == RotFlipType.Rotate180FlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; c = w * 4 - 4; int dlength4 = data.Length - 4; for (int i = 0; i &lt; data.Length / 4 / 2; i++) { i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone) j4 = i4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> j4 = (Math.Truncate((double)i / w) * w + (w - i % w)) * 4; t = (int)data[j4]; data[j4] = data[dlength4 - i4]; data[dlength4 - i4] = t; t = (int)data[j4 + 1]; data[j4 + 1] = data[dlength4 - i4 + 1]; data[dlength4 - i4 + 1] = t; t = (int)data[j4 + 2]; data[j4 + 2] = data[dlength4 - i4 + 2]; data[dlength4 - i4 + 2] = t; t = (int)data[j4 + 3]; data[j4 + 3] = data[dlength4 - i4 + 3]; data[dlength4 - i4 + 3] = t; } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Bitmap tempBitmap = PrivateUtils.CreateCloneBitmap(bitmap); GraphicsContext tempContext = GraphicsContext.GetContext(tempBitmap); PixelArray temp = tempContext.GetPixelArray(); t = bitmap.Width; bitmap.Width = bitmap.Height; bitmap.Height = t; context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = tempBitmap.Width; h = tempBitmap.Height; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone || rotFlipType == RotFlipType.Rotate90FlipX) { c = w * h - w; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c - w * (i % h) + t) * 4; //j4 = (w * (h - 1 - i4 % h) + i4 / h) * 4; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone || rotFlipType == RotFlipType.Rotate270FlipX) { c = w - 1; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c + w * (i % h) - t) * 4; // j4 = w * (1 + i4 % h) - i4 / h - 1; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } context.PutImageData(); } return bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET Bitmap result = null; switch (rotFlipType) { case RotFlipType.RotateNoneFlipNone: result = bitmap; break; case RotFlipType.Rotate90FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate90FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate270FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate270FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate180FlipNone); result = bitmap; break; case RotFlipType.RotateNoneFlipX: bitmap.RotateFlip(RotateFlipType.RotateNoneFlipX); result = bitmap; break; case RotFlipType.Rotate90FlipX: bitmap.RotateFlip(RotateFlipType.Rotate90FlipX); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipX: bitmap.RotateFlip(RotateFlipType.Rotate180FlipX); result = bitmap; break; case RotFlipType.Rotate270FlipX: bitmap.RotateFlip(RotateFlipType.Rotate270FlipX); result = new Image(bitmap); bitmap.Dispose(); break; } return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> </div></div><br><h4 id="synchronous-and-asynchronous-image-loading">  Chargement d'images synchrones et asynchrones </h4><br><p>  Notez que dans la version Script #, nous <code>CollageImageLoad</code> une fonction diff√©rente <code>CollageImageLoad</code> , qui est appel√©e apr√®s le chargement d'une image, tandis que dans la version .NET, ces processus se d√©roulent simultan√©ment (√† partir d'un syst√®me de fichiers ou d'Internet). </p><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollageData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> smallMaskPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bigMaskPath, List&lt;CollageDataPart&gt; dataParts</span></span></span><span class="hljs-function">)</span></span> { SmallMaskImagePath = smallMaskPath; BigMaskImagePath = bigMaskPath; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP CurrentMask = PrivateUtils.CreateEmptyImage(); CurrentMask.AddEventListener("load", CollageImageLoad, false); CurrentMask.Src = CurrentMaskImagePath; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> CurrentMask = PrivateUtils.LoadBitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!CurrentMaskImagePath.Contains("http://") &amp;&amp; !CurrentMaskImagePath.Contains("https://")) CurrentMask = Bitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { var request = WebRequest.Create(CurrentMaskImagePath); using (var response = request.GetResponse()) using (var stream = response.GetResponseStream()) CurrentMask = (Bitmap)Bitmap.FromStream(stream); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> DataParts = dataParts; }</span></span></code> </pre> </div></div><br><h3 id="script-only">  Script # uniquement </h3><br><h4 id="detecting-the-type-and-version-of-a-browser">  D√©tection du type et de la version d'un navigateur </h4><br><p>  Cette fonction est utilis√©e pour d√©terminer les capacit√©s de glisser-d√©poser dans diff√©rents navigateurs.  J'ai essay√© d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modernizr</a> , mais il est revenu que Safari et (dans mon cas, c'√©tait une version Win) IE9 l'impl√©mentent.  En pratique, ces navigateurs ne parviennent pas √† impl√©menter correctement les fonctionnalit√©s de glisser-d√©poser. </p><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BrowserVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { DetectBrowserTypeAndVersion(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _browserVersion; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectBrowserTypeAndVersion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_browserDetected) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userAgent = Window.Navigator.UserAgent.ToLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"opera"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Opera; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"chrome"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Chrome; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"safari"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Safari; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"firefox"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Firefox; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numberIndex = userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) + <span class="hljs-number"><span class="hljs-number">5</span></span>; _browser = BrowserType.IE; _browserVersion = userAgent.Substring(numberIndex, userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">';'</span></span>, numberIndex)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _browser = BrowserType.Unknown; _browserDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </div></div><br><h4 id="rendering-a-dash-dot-line">  Rendu d'une ligne pointill√©e </h4><br><p>  Ce code est utilis√© pour un rectangle de recadrage d'images.  Merci pour les id√©es √† tous ceux qui ont r√©pondu √† cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">question sur stackoverflow</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawDahsedLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GraphicsContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] dashArray</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dashArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] { <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashCount = dashArray.Length; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dx = x2 - x1; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dy = y2 - y1; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> xSlope = Math.Abs(dx) &gt; Math.Abs(dy); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> slope = xSlope ? dy / dx : dx / dy; context.MoveTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> distRemaining = Math.Sqrt(dx * dx + dy * dy); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (distRemaining &gt;= <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashLength = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.Min(distRemaining, dashArray[dashIndex % dashCount]); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> step = Math.Sqrt(dashLength * dashLength / (<span class="hljs-number"><span class="hljs-number">1</span></span> + slope * slope)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xSlope) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += step; y1 += slope * step; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dy &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += slope * step; y1 += step; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashIndex % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) context.LineTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> context.MoveTo(x1, y1); distRemaining -= dashLength; dashIndex++; } }</code> </pre> </div></div><br><h4 id="rotation-animation">  Animation de rotation </h4><br><p>  <code>setInterval</code> fonction <code>setInterval</code> est utilis√©e pour impl√©menter une animation de rotation d'image.  Notez que l'image r√©sultante est calcul√©e pendant l'animation afin qu'il n'y ait aucun d√©calage √† la fin de l'animation. </p><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rotate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cw</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating &amp;&amp; !_flipping) { _rotating = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _cw = cw; RotFlipType oldRotFlipType = _curRotFlipType; _curRotFlipType = RotateRotFlipValue(_curRotFlipType, _cw); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentStep = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stepCount = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(RotateFlipTimeSeconds * <span class="hljs-number"><span class="hljs-number">1000</span></span> / StepTimeTicks); Bitmap result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _interval = Window.SetInterval(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStep &lt; stepCount) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> absAngle = GetAngle(oldRotFlipType) + currentStep / stepCount * Math.PI / <span class="hljs-number"><span class="hljs-number">2</span></span> * (_cw ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>); DrawRotated(absAngle); currentStep++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Window.ClearInterval(_interval); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Draw(result); _rotating = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, StepTimeTicks); result = GetCurrentTransformResult(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating) Draw(result); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawRotated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotAngle</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Save(); _resultContext._graphics.Translate(_result.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, _result.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.Rotate(-rotAngle); _resultContext._graphics.Translate(-_origin.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, -_origin.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.DrawImage(_origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _resultContext.Restore(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Draw2(bitmap, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Width - bitmap.Width) / <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Height - bitmap.Height) / <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre> </div></div><br><h2 id="conclusion">  Conclusion </h2><br><p>  Cet article d√©crit comment le langage C # (combinant du code non manag√© et la compilation pour JavaScript) peut √™tre utilis√© pour cr√©er une solution vraiment multiplateforme.  Malgr√© l'accent mis sur .NET et JavaScript, la compilation sur Android, iOS (en utilisant Mono) et Windows Phone est √©galement possible en fonction de cette approche, qui, bien s√ªr, a ses pi√®ges.  Le code est un peu redondant en raison de son universalit√©, mais il n'affecte pas les performances car les op√©rations graphiques prennent g√©n√©ralement beaucoup plus de temps. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440342/">https://habr.com/ru/post/fr440342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440330/index.html">En bref sur les abstractions</a></li>
<li><a href="../fr440332/index.html">Base de donn√©es dans les nuages: √† qui et pourquoi - l'avis des sp√©cialistes de Data Egret</a></li>
<li><a href="../fr440334/index.html">Webinaire ouvert "D√©veloppement de syst√®mes hautement charg√©s en PHP"</a></li>
<li><a href="../fr440336/index.html">HTML que nous avons perdu</a></li>
<li><a href="../fr440338/index.html">Comment garantir la disponibilit√© d'un service Web dans le cloud en cas de panne du centre de donn√©es</a></li>
<li><a href="../fr440350/index.html">Flying Bear Tornado 2 - un nouvel ours est arriv√©</a></li>
<li><a href="../fr440352/index.html">Piratage de masse VKontakte [ver XSS]</a></li>
<li><a href="../fr440354/index.html">√âv√©nements num√©riques √† Moscou du 18 au 24 f√©vrier</a></li>
<li><a href="../fr440356/index.html">Comment Habr aide √† r√©aliser ses r√™ves et √† collecter des balles</a></li>
<li><a href="../fr440358/index.html">Habro suicide. Discoth√®que rurale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>