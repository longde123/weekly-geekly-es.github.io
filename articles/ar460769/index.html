<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌮 🏠 👩‍👦 تكوين خادم لنشر تطبيق Rails باستخدام Ansible 🕢 😧 🎆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="منذ وقت ليس ببعيد ، كنت بحاجة إلى كتابة العديد من كتب اللعب غير المرئية لإعداد الخادم لنشر تطبيق القضبان. وبشكل مدهش ، لم أجد دليلًا بسيطًا خطوة بخطوة...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تكوين خادم لنشر تطبيق Rails باستخدام Ansible</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460769/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  منذ وقت ليس ببعيد ، كنت بحاجة إلى كتابة العديد من كتب اللعب غير المرئية لإعداد الخادم لنشر تطبيق القضبان.  وبشكل مدهش ، لم أجد دليلًا بسيطًا خطوة بخطوة.  لم أكن أرغب في نسخ كتاب اللعب الخاص بشخص آخر دون فهم ما كان يحدث وكنتيجة لذلك اضطررت إلى قراءة الوثائق وجمع كل شيء بنفسي.  ربما شخص يمكنني المساعدة في تسريع هذه العملية مع هذه المادة. </p><br><p style=";text-align:right;direction:rtl">  أول شيء يجب فهمه هو أن ansible يوفر لك واجهة ملائمة لأداء قائمة محددة مسبقًا من الإجراءات على الخادم (الخوادم) عن بُعد عبر SSH.  لا يوجد سحر هنا ، لا يمكنك تثبيت المكون الإضافي والخروج من مربع تعطل الصفر من نشر التطبيق الخاص بك مع عامل ميناء ، ومراقبة وغيرها من الأشياء الجيدة.  من أجل كتابة كتاب اللعب ، يجب أن تعرف بالضبط ما تريد القيام به وكيفية القيام بذلك.  لذلك ، أنا لا أحب كتب اللعب الجاهزة من جيثب ، أو مقالات مثل: "النسخ والتشغيل ، ستنجح". </p><a name="habracut"></a><br><h2 id="chto-nam-nuzhno" style=";text-align:right;direction:rtl">  ماذا نحتاج؟ </h2><br><p style=";text-align:right;direction:rtl">  كما قلت ، من أجل كتابة كتاب اللعب ، فأنت بحاجة إلى معرفة ما تريد القيام به وكيفية القيام بذلك.  دعنا نقرر ما نحتاجه.  لتطبيق Rails ، سنحتاج إلى عدة حزم نظام: nginx ، postgresql (redis ، إلخ).  بالإضافة إلى ذلك ، نحن بحاجة إلى روبي إصدار معين.  من الأفضل تثبيته من خلال rbenv (rvm ، asdf ...).  يعد تشغيل كل هذا من جذر المستخدم دائمًا فكرة سيئة ، لذلك تحتاج إلى إنشاء مستخدم منفصل وتكوين الحقوق له.  بعد ذلك ، تحتاج إلى تحميل الكود الخاص بنا إلى الخادم ، ونسخ التهيئة لـ nginx ، و postgres ، وغيرها وبدء جميع هذه الخدمات. </p><br><p style=";text-align:right;direction:rtl">  <strong>نتيجة لذلك ، تسلسل الإجراءات كما يلي:</strong> </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  تسجيل الدخول كجذر </li><li style=";text-align:right;direction:rtl">  تثبيت حزم النظام </li><li style=";text-align:right;direction:rtl">  إنشاء مستخدم جديد ، تكوين الحقوق ، مفتاح سه </li><li style=";text-align:right;direction:rtl">  تكوين حزم النظام (nginx وما إلى ذلك) وتشغيلها </li><li style=";text-align:right;direction:rtl">  إنشاء مستخدم في قاعدة البيانات (يمكنك إنشاء قاعدة بيانات على الفور) </li><li style=";text-align:right;direction:rtl">  تسجيل الدخول كمستخدم جديد </li><li style=";text-align:right;direction:rtl">  تثبيت rbenv وروبي </li><li style=";text-align:right;direction:rtl">  تثبيت المجمع </li><li style=";text-align:right;direction:rtl">  ملء رمز التطبيق </li><li style=";text-align:right;direction:rtl">  نبدأ خادم بوما </li></ol><br><p style=";text-align:right;direction:rtl">  علاوة على ذلك ، يمكن القيام بالخطوات الأخيرة باستخدام capistrano ، على الأقل يمكنها نسخ الكود إلى دلائل الإصدار من المربع ، وتبديل الإصدار برمز ارتباط عند نشر ناجح ، ونسخ التكوينات من الدليل المشترك ، وإعادة تشغيل puma ، إلخ.  كل هذا يمكن القيام به مع Ansible ، لكن لماذا؟ </p><br><h2 id="faylovaya-struktura" style=";text-align:right;direction:rtl">  هيكل الملف </h2><br><p style=";text-align:right;direction:rtl">  يحتوي Ansible على <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">بنية ملف</a> صارمة لجميع ملفاته ، لذلك من الأفضل الاحتفاظ بها جميعًا في دليل منفصل.  وليس من المهم للغاية ما إذا كان سيكون في تطبيق القضبان نفسه ، أو بشكل منفصل.  يمكنك تخزين الملفات في مستودع بوابة منفصل.  شخصيا ، كان الأمر الأكثر ملاءمة بالنسبة لي لإنشاء دليل غير مرئي في / config لدليل القضبان للتطبيق وتخزين كل شيء في مستودع واحد. </p><br><h3 id="simple-playbook" style=";text-align:right;direction:rtl">  قواعد اللعبة البسيطة </h3><br><p style=";text-align:right;direction:rtl">  Playbook هو ملف yml يصف ماذا وكيف يجب أن يقوم ansible باستخدام بناء جملة خاص.  دعنا ننشئ أول كتاب لعب لا يفعل شيئًا: </p><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">--- - name: Simple playbook hosts: all</code> </pre> <br><p style=";text-align:right;direction:rtl">  هنا ، نقول ببساطة أن كتاب اللعب الخاص بنا يسمى <code>Simple Playbook</code> وأنه يجب تشغيل محتوياته لجميع المضيفين.  يمكننا حفظه في الدليل / ansible باسم <code>playbook.yml</code> ومحاولة تشغيله: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible-playbook ./playbook.yml PLAY [Simple Playbook] ************************************************************************************************************************************ skipping: no hosts matched</code> </pre> <br><p style=";text-align:right;direction:rtl">  يقول Ansible إنه لا يعرف المضيفين الذين يتطابقون مع كل القائمة.  يجب أن يتم سردها في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ملف مخزون</a> خاص. </p><br><p style=";text-align:right;direction:rtl">  لنقم بإنشائه في نفس الدليل ansible: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">123.123.123.123</code> </pre> <br><p style=";text-align:right;direction:rtl">  لذلك حدد فقط المضيف (من الناحية المثالية ، مضيف VPS الخاص بك للاختبارات ، أو يمكنك تسجيل مضيف محلي) وحفظه تحت اسم <code>inventory</code> . <br>  يمكنك تجربة تشغيل ansible باستخدام ملف invetory: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible-playbook ./playbook.yml -i inventory PLAY [Simple Playbook] ************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ PLAY RECAP ************************************************************************************************************************************</code> </pre> <br><p style=";text-align:right;direction:rtl">  إذا كان لديك وصول ssh إلى المضيف المحدد ، فسيقوم ansible بالاتصال وجمع المعلومات حول النظام البعيد.  (الافتراضي المهام [جمع الحقائق]) وبعد ذلك سوف يقدم تقريرا مرحليا موجزا (PLAY RECAP). </p><br><p style=";text-align:right;direction:rtl">  افتراضيًا ، يتم استخدام اسم المستخدم الذي سجلت بموجبه تسجيل الدخول إلى النظام للاتصال.  على الأرجح لن يكون على المضيف.  في ملف playbook ، يمكنك تحديد المستخدم الذي يجب استخدامه للاتصال باستخدام توجيه remote_user.  أيضًا ، غالبًا ما تكون المعلومات عن النظام البعيد غير ضرورية لك ويجب ألا تضيع الوقت في جمعها.  يمكنك أيضًا إيقاف هذه المهمة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no</code> </pre> <br><p style=";text-align:right;direction:rtl">  حاول تشغيل playbook مرة أخرى وتأكد من أن الاتصال يعمل.  (إذا حددت جذر المستخدم ، فيجب عليك أيضًا تحديد الأمر يصبح: التوجيه الحقيقي للحصول على حقوق مرتفعة. كما تقول الوثائق: <code>become set to 'true'/'yes' to activate privilege escalation.</code> رغم أنه ليس من الواضح سبب ذلك) . </p><br><p style=";text-align:right;direction:rtl">  ربما تحصل على خطأ بسبب الخطأ الذي لا يمكن لمترجم بايثون تحديده ، ثم يمكنك تحديده يدويًا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible_python_interpreter: /usr/bin/python3</code> </pre> <br><p style=";text-align:right;direction:rtl">  حيث يمكنك العثور على <code>whereis python</code> مع أمر <code>whereis python</code> . </p><br><h3 id="ustanovka-sistemnyh-paketov" style=";text-align:right;direction:rtl">  تثبيت حزم النظام </h3><br><p style=";text-align:right;direction:rtl">  يأتي Ansible مع العديد من الوحدات النمطية للعمل مع حزم النظام المختلفة ، لذلك لا يتعين علينا كتابة نصوص bash لأي سبب من الأسباب.  نحتاج الآن إلى إحدى هذه الوحدات لتحديث النظام وتثبيت حزم النظام.  لدي Ubuntu Linux على VPS ، على التوالي ، لتثبيت الحزم ، يمكنني استخدام <code>apt-get</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ووحدة نمطية لذلك</a> .  إذا كنت تستخدم نظام تشغيل مختلفًا ، فقد تحتاج إلى وحدة نمطية مختلفة (تذكر ، قلت في البداية إننا بحاجة إلى معرفة ما سوف نفعله مسبقًا) وكيف.  ومع ذلك ، فإن بناء الجملة من المرجح أن تكون مماثلة. </p><br><p style=";text-align:right;direction:rtl">  نحن نكمل قواعد اللعبة التي نتبعها بالمهام الأولى: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present</code> </pre> <br><p style=";text-align:right;direction:rtl">  المهمة هي المهمة التي سينفذها ansible على الخوادم البعيدة.  نعطي المهمة اسماً لتتبع تقدمها في السجل.  ونصف ، باستخدام بناء جملة وحدة نمطية معينة ، ما الذي يجب القيام به.  في هذه الحالة ، <code>apt: update_cache=yes</code> - يقول تحديث حزم النظام باستخدام الوحدة النمطية apt.  الفريق الثاني هو أكثر تعقيدا قليلا.  نقوم بتمرير قائمة الحزم إلى الوحدة النمطية apt ، ونقول أن حالتها يجب أن تكون <code>present</code> ، أي نقول لتثبيت هذه الحزم.  وبالمثل ، يمكننا أن نقول لهم أن يتم حذفها أو تحديثها ، ببساطة عن طريق تغيير <code>state</code> .  يرجى ملاحظة أنه لكي تعمل القضبان مع postgresql ، نحتاج إلى حزمة postgresql التي نقوم بتثبيتها حاليًا.  يحتاج هذا مرة أخرى إلى أن يكون معروفًا وفعلًا ، ولن يقوم بذلك ansible بحد ذاته. </p><br><p style=";text-align:right;direction:rtl">  حاول تشغيل playbook مرة أخرى وتحقق من تثبيت الحزم. </p><br><h3 id="sozdanie-novyh-polzovateley" style=";text-align:right;direction:rtl">  إنشاء مستخدمين جدد. </h3><br><p style=";text-align:right;direction:rtl">  للعمل مع المستخدمين ، يحتوي Ansible أيضًا على وحدة - مستخدم.  أضف مهمة أخرى (أخفيت الأجزاء المعروفة بالفعل في playbook وراء التعليقات ، حتى لا تنسخها بالكامل في كل مرة): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: my_user shell: /bin/bash password: "{{ 123qweasd | password_hash('sha512') }}"</code> </pre> <br><p style=";text-align:right;direction:rtl">  نخلق مستخدمًا جديدًا ونضع له كلمة مرور وكلمة مرور.  ثم نواجه العديد من المشاكل.  ماذا لو كان يجب أن تكون أسماء المستخدمين مختلفة للمضيفين المختلفين؟  نعم ، وإبقاء كلمة المرور مفتوحة في playbook هي فكرة سيئة للغاية.  بادئ ذي بدء ، سنضع اسم المستخدم وكلمة المرور في متغيرات ، وفي نهاية المقال سوف أعرض كيفية تشفير كلمة المرور. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}"</code> </pre> <br><p style=";text-align:right;direction:rtl">  يتم تعيين المتغيرات باستخدام أقواس مزدوجة مجعد في قواعد اللعبة. </p><br><p style=";text-align:right;direction:rtl">  سنشير إلى قيم المتغيرات في ملف المخزون: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">123.123.123.123 [all:vars] user=my_user user_password=123qweasd</code> </pre> <br><p style=";text-align:right;direction:rtl">  انتبه إلى التوجيه <code>[all:vars]</code> - حيث يشير إلى أن المجموعة التالية من النص هي المتغيرات (vars) وهي قابلة للتطبيق على جميع المضيفين (الكل). </p><br><p style=";text-align:right;direction:rtl">  بناء <code>"{{ user_password | password_hash('sha512') }}"</code> مثير للاهتمام أيضًا.  الحقيقة هي أن ansible لا يقوم بتعيين المستخدم من خلال <code>user_add</code> كما تفعل يدويًا.  وهو يحفظ جميع البيانات مباشرة ، ولهذا السبب يجب علينا أيضًا تحويل كلمة المرور إلى علامة تجزئة مسبقًا ، وهذا ما يفعله هذا الأمر. </p><br><p style=";text-align:right;direction:rtl">  دعنا نضيف مستخدمنا إلى مجموعة sudo.  ومع ذلك ، قبل هذا تحتاج إلى التأكد من وجود مثل هذه المجموعة لأن لا أحد سيفعل ذلك من أجلنا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo"</code> </pre> <br><p style=";text-align:right;direction:rtl">  الأمر بسيط بما فيه الكفاية ، ولدينا أيضًا وحدة نمطية للمجموعات لإنشاء مجموعات ، مع بناء جملة يشبه جدًا apt.  ثم يكفي تسجيل هذه المجموعة للمستخدم ( <code>groups: "sudo"</code> ). <br>  من المفيد أيضًا إضافة مفتاح ssh إلى هذا المستخدم حتى نتمكن من تسجيل الدخول تحته دون كلمة مرور: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p style=";text-align:right;direction:rtl">  في هذه الحالة ، يعد الإنشاء <code>"{{ lookup('file', '~/.ssh/id_rsa.pub') }}"</code> مثيرًا للاهتمام - فهو ينسخ محتويات ملف id_rsa.pub (قد يختلف اسمك) ، أي الجزء العمومي من المفتاح ssh وتحميله إلى قائمة المفاتيح المعتمدة للمستخدم على الخادم. </p><br><h3 id="roli" style=";text-align:right;direction:rtl">  دور </h3><br><p style=";text-align:right;direction:rtl">  يمكن استخدام المهام الثلاث الخاصة بالإنشاء بسهولة كمجموعة مهام واحدة ، وسيكون من الجيد الاحتفاظ بهذه المجموعة منفصلة عن كتاب اللعب الرئيسي حتى لا تنمو أكثر من اللازم.  هناك <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">أدوار</a> لهذا في ansible. <br>  وفقًا لهيكل الملف المشار إليه في البداية ، يجب وضع الأدوار في دليل أدوار منفصل ، لكل دور - دليل منفصل يحمل نفس الاسم ، داخل المهام ، الملفات ، القوالب ، إلخ. <br>  لنقم بإنشاء بنية الملف: <code>./ansible/roles/user/tasks/main.yml</code> (الرئيسي هو الملف الرئيسي الذي سيتم تحميله وتنفيذه عندما يكون الدور متصلاً بكتاب التشغيل ، يمكن توصيل ملفات الدور الأخرى فيه).  يمكنك الآن نقل جميع المهام المتعلقة بالمستخدم إلى هذا الملف: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Create user and add him to groups - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p style=";text-align:right;direction:rtl">  في playbook الرئيسي ، يجب عليك تحديد استخدام دور المستخدم: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present roles: - user</code> </pre> <br><p style=";text-align:right;direction:rtl">  أيضًا ، قد يكون من المنطقي إجراء تحديث للنظام قبل جميع المهام الأخرى ، لذلك يمكنك إعادة تسمية كتلة <code>tasks</code> التي تم تعريفها في <code>pre_tasks</code> . </p><br><h3 id="nastroyka-nginx" style=";text-align:right;direction:rtl">  إعداد Nginx </h3><br><p style=";text-align:right;direction:rtl">  يجب تثبيت Nginx معنا بالفعل ، تحتاج إلى تكوينه وتشغيله.  دعونا نفعل ذلك على الفور في هذا الدور.  إنشاء بنية ملف: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- ansible - roles - nginx - files - tasks - main.yml - templates</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحن الآن بحاجة إلى ملفات وقوالب.  الفرق بين الاثنين هو أن الملفات غير المرئية يتم نسخها مباشرة ، كما هي.  ويجب أن تحتوي القوالب على الامتداد j2 ويمكنها استخدام قيم المتغيرات باستخدام نفس الأقواس المزدوجة المتعرجة. </p><br><p style=";text-align:right;direction:rtl">  دعنا ندرج nginx في ملف <code>main.yml</code> .  لهذا ، لدينا وحدة systemd: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes</code> </pre> <br><p style=";text-align:right;direction:rtl">  هنا لا نقول فقط أنه يجب تشغيل nginx (على سبيل المثال ، تشغيله) ، ولكن نقول على الفور أنه يجب تمكينه. <br>  الآن انسخ ملفات التكوين: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644'</code> </pre> <br><p style=";text-align:right;direction:rtl">  نقوم بإنشاء ملف تكوين nginx الرئيسي (يمكنك أخذه مباشرةً من الخادم أو كتابته بنفسك).  وكذلك ملف التهيئة لتطبيقنا في دليل sites_available (هذا ليس ضروريًا ولكنه مفيد).  في الحالة الأولى ، نستخدم وحدة النسخ لنسخ الملفات (يجب أن يكون الملف في <code>/ansible/roles/nginx/files/nginx.conf</code> ).  في الثاني - نسخ القالب ، استبدال قيم المتغيرات.  يجب أن يكون القالب في <code>/ansible/roles/nginx/templates/my_app.j2</code> ).  وقد يبدو مثل هذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">upstream {{ app_name }} { server unix:{{ app_path }}/shared/tmp/sockets/puma.sock; } server { listen 80; server_name {{ server_name }} {{ inventory_hostname }}; root {{ app_path }}/current/public; try_files $uri/index.html $uri.html $uri @{{ app_name }}; .... }</code> </pre> <br><p style=";text-align:right;direction:rtl">  انتبه إلى <code>{{ app_path }}</code> <code>{{ app_name }}</code> و <code>{{ app_path }}</code> و <code>{{ server_name }}</code> و <code>{{ inventory_hostname }}</code> - فهذه كلها متغيرات ستستبدل قيمها في النص القالب قبل النسخ.  هذا مفيد إذا كنت تستخدم قواعد اللعبة التي تمارسها لمجموعات مضيفة مختلفة.  على سبيل المثال ، يمكننا استكمال ملف المخزون لدينا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">[production] 123.123.123.123 [staging] 231.231.231.231 [all:vars] user=my_user user_password=123qweasd [production:vars] server_name=production app_path=/home/www/my_app app_name=my_app [staging:vars] server_name=staging app_path=/home/www/my_stage app_name=my_stage_app</code> </pre> <br><p style=";text-align:right;direction:rtl">  إذا قمنا بتشغيل كتاب اللعب الخاص بنا الآن ، فسيؤدي المهام المحددة لكلا المضيفين.  ولكن في الوقت نفسه ، بالنسبة إلى المضيف المرحلي ، ستختلف المتغيرات عن الإنتاج ، وليس فقط في الأدوار وكتب التشغيل ، ولكن أيضًا في التكوينات nginx.  <code>{{ inventory_hostname }}</code> لا تحتاج إلى تحديد في ملف المخزون - هذا <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">متغير خاص ansible</a> والمضيف الذي يتم تشغيل playbook حاليًا به مخزّن هناك. <br>  إذا كنت تريد أن يكون لديك ملف مخزون للعديد من المضيفين ، ويتم تشغيله لمجموعة واحدة فقط ، يمكن القيام بذلك باستخدام الأمر التالي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging"</code> </pre> <br><p style=";text-align:right;direction:rtl">  خيار آخر هو أن يكون لديك ملفات جرد منفصلة لمجموعات مختلفة.  أو يمكنك دمج طريقتين إذا كان لديك العديد من المضيفين المختلفين. </p><br><p style=";text-align:right;direction:rtl">  دعنا نعود إلى تكوين nginx.  بعد نسخ ملفات التكوين ، نحتاج إلى إنشاء رابط في sitest_enabled على my_app.conf من sites_available.  وإعادة تشغيل إنجن إكس. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">... # old code in mail.yml - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted</code> </pre> <br><p style=";text-align:right;direction:rtl">  كل شيء بسيط هنا - مرة أخرى ، وحدات ansible مع بناء جملة قياسي إلى حد ما.  ولكن هناك نقطة واحدة.  إعادة تشغيل nginx في كل مرة لا معنى له.  لاحظت أننا لا نكتب أوامر من النموذج: "افعل مثل هذا" ، يبدو بناء الجملة أشبه "يجب أن يكون لهذه الحالة".  وغالبا ما تكون هذه هي الطريقة التي يعمل بها ansible.  إذا كانت المجموعة موجودة بالفعل أو كانت حزمة النظام مثبتة بالفعل ، فسيقوم ansible بالتحقق من ذلك وتخطي المهمة.  أيضا ، لن يتم نسخ الملفات إذا كانت تتزامن تماما مع ما هو موجود بالفعل على الخادم.  يمكننا الاستفادة من هذا وإعادة تشغيل nginx فقط إذا تم تغيير ملفات التكوين.  يوجد توجيه سجل لهذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes register: restart_nginx - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644' register: restart_nginx - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted when: restart_nginx.changed</code> </pre> <br><p style=";text-align:right;direction:rtl">  في حالة تغيير أحد ملفات التكوين ، سيتم تنفيذ <code>restart_nginx</code> وسيتم تسجيل متغير <code>restart_nginx</code> .  وفقط إذا تم تسجيل هذا المتغير ، سيتم إعادة تشغيل الخدمة. </p><br><p style=";text-align:right;direction:rtl">  حسنًا ، بالطبع ، تحتاج إلى إضافة دور nginx إلى playbook الرئيسي. </p><br><h3 id="nastroyka-postgresql" style=";text-align:right;direction:rtl">  إعداد Postgresql </h3><br><p style=";text-align:right;direction:rtl">  نحتاج إلى تمكين postgresql مع systemd ، تمامًا كما فعلنا مع nginx ، وكذلك إنشاء مستخدم سنستخدمه للوصول إلى قاعدة البيانات وقاعدة البيانات نفسها. <br>  قم <code>/ansible/roles/postgresql/tasks/main.yml</code> الدور <code>/ansible/roles/postgresql/tasks/main.yml</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Create user in postgresql - name: enable postgresql and start systemd: name: postgresql state: started enabled: yes - name: Create database user become_user: postgres postgresql_user: name: "{{ db_user }}" password: "{{ db_password }}" role_attr_flags: SUPERUSER - name: Create database become_user: postgres postgresql_db: name: "{{ db_name }}" encoding: UTF-8 owner: "{{ db_user }}"</code> </pre> <br><p style=";text-align:right;direction:rtl">  لن أصف كيفية إضافة متغيرات إلى المخزون ، وقد تم ذلك بالفعل عدة مرات ، بالإضافة إلى بناء جملة postgresql_db و postgresql_user.  يمكن الاطلاع على المزيد من البيانات في الوثائق.  التوجيه <code>become_user: postgres</code> الأكثر إثارة للاهتمام <code>become_user: postgres</code> .  والحقيقة هي أن المستخدم postgres بشكل افتراضي فقط لديه حق الوصول إلى قاعدة بيانات postgresql وفقط محليا.  يسمح لنا هذا التوجيه بتنفيذ الأوامر نيابة عن هذا المستخدم (ما لم يكن لدينا بالطبع إمكانية الوصول). <br>  أيضًا ، قد تضطر إلى إضافة سطر إلى pg_hba.conf لفتح الوصول إلى قاعدة البيانات لمستخدم جديد.  يمكن القيام بذلك بنفس الطريقة التي قمنا بها بتغيير التكوين nginx. </p><br><p style=";text-align:right;direction:rtl">  وبالطبع تحتاج إلى إضافة دور postgresql إلى playbook الرئيسي. </p><br><h3 id="ustanovka-ruby-cherez-rbenv" style=";text-align:right;direction:rtl">  تثبيت روبي من خلال rbenv </h3><br><p style=";text-align:right;direction:rtl">  لا يحتوي Ansible على وحدات للعمل مع rbenv ، ولكن يتم تثبيته عن طريق استنساخ مستودع git.  لذلك ، تصبح هذه المهمة الأكثر غير قياسي.  لنقم بإنشاء الدور / غير <code>/ansible/roles/ruby_rbenv/main.yml</code> لها وابدأ في ملئه: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Install rbenv and ruby - name: Install rbenv become_user: "{{ user }}" git: repo=https://github.com/rbenv/rbenv.git dest=~/.rbenv</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحن نستخدم مرة أخرى توجيه أصبح Bec_user للعمل من تحت المستخدم الذي أنشأناه لهذه الأغراض.  منذ يتم تثبيت rbenv في الدليل الرئيسي ، وليس على الصعيد العالمي.  ونستخدم أيضًا وحدة git لاستنساخ المستودع عن طريق تحديد repo و dest. </p><br><p style=";text-align:right;direction:rtl">  بعد ذلك ، نحتاج إلى تسجيل rbenv init في bashrc وإضافة rbenv إلى PATH في نفس المكان.  لهذا ، لدينا وحدة lineinfile: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- name: Add rbenv to PATH become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'export PATH="${HOME}/.rbenv/bin:${PATH}"' - name: Add rbenv init to bashrc become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'eval "$(rbenv init -)"'</code> </pre> <br><p style=";text-align:right;direction:rtl">  ثم تثبيت ruby_build: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- name: Install ruby-build become_user: "{{ user }}" git: repo=https://github.com/rbenv/ruby-build.git dest=~/.rbenv/plugins/ruby-build</code> </pre> <br><p style=";text-align:right;direction:rtl">  وأخيرا تثبيت روبي.  يتم ذلك عبر rbenv ، أي مجرد أمر bash: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" rbenv install {{ ruby_version }} args: executable: /bin/bash</code> </pre> <br><p style=";text-align:right;direction:rtl">  نقول أي فريق لتنفيذ وكيف.  ومع ذلك ، فإننا نواجه حقيقة أن ansible لا يعمل الكود الموجود في bashrc قبل تشغيل الأوامر.  لذلك ، سوف يتعين تحديد rbenv مباشرة في نفس البرنامج النصي. </p><br><p style=";text-align:right;direction:rtl">  المشكلة التالية هي أن الأمر shell لا يوجد لديه حالة من حيث ansible.  وهذا يعني أن التحقق التلقائي ما إذا كان هذا الإصدار من روبي مثبت أم لا.  يمكننا أن نفعل ذلك بأنفسنا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" if ! rbenv versions | grep -q {{ ruby_version }} then rbenv install {{ ruby_version }} &amp;&amp; rbenv global {{ ruby_version }} fi args: executable: /bin/bash</code> </pre> <br><p style=";text-align:right;direction:rtl">  ويبقى لتثبيت المجمّع: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- name: Install bundler become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" gem install bundler</code> </pre> <br><p style=";text-align:right;direction:rtl">  ومرة أخرى ، أضف دورنا ruby_rbenv إلى playbook الرئيسي. </p><br><h3 id="shared-files" style=";text-align:right;direction:rtl">  الملفات المشتركة. </h3><br><p style=";text-align:right;direction:rtl">  بشكل عام ، يمكن إكمال هذا الإعداد.  ثم يبقى لتشغيل capistrano وسيقوم بنسخ الكود نفسه ، وإنشاء الدلائل اللازمة وتشغيل التطبيق (إذا تم تكوين كل شيء بشكل صحيح).  ومع ذلك ، غالبًا ما يحتاج capistrano إلى ملفات تكوين إضافية ، مثل <code>database.yml</code> أو <code>.env</code> نسخها تمامًا مثل الملفات والقوالب لـ nginx.  لا يوجد سوى دقة واحدة.  قبل نسخ الملفات ، تحتاج إلى إنشاء بنية دليل لهم ، مثل هذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Copy shared files for deploy - name: Ensure shared dir become_user: "{{ user }}" file: path: "{{ app_path }}/shared/config" state: directory</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحدد دليلًا واحدًا فقط وسوف ينشئ ansible الوالد تلقائيًا ، إذا لزم الأمر. </p><br><h2 id="ansible-vault" style=";text-align:right;direction:rtl">  قبو Ansible </h2><br><p style=";text-align:right;direction:rtl">  لقد تعثرت بالفعل حقيقة أن البيانات السرية مثل كلمة مرور المستخدم قد تظهر في المتغيرات.  إذا قمت بإنشاء ملف <code>.env</code> للتطبيق ، و <code>database.yml</code> ، فيجب أن يكون هناك المزيد من هذه البيانات الهامة.  سيكون من الجميل أن نخفيهم عن أعين المتطفلين.  يستخدم <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">قبو Ansible</a> لهذا الغرض. </p><br><p style=";text-align:right;direction:rtl">  لنقم بإنشاء ملف للمتغيرات <code>/ansible/vars/all.yml</code> (هنا يمكنك إنشاء ملفات مختلفة لمجموعات مختلفة من المضيفين ، تمامًا مثل ملف المخزون: production.yml ، staging.yml ، إلخ). <br>  في هذا الملف ، تحتاج إلى نقل جميع المتغيرات التي يجب تشفيرها باستخدام بناء جملة yml القياسي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># System vars user_password: 123qweasd db_password: 123qweasd # ENV vars aws_access_key_id: xxxxx aws_secret_access_key: xxxxxx aws_bucket: bucket_name rails_secret_key_base: very_secret_key_base</code> </pre> <br><p style=";text-align:right;direction:rtl">  ثم يمكن تشفير هذا الملف باستخدام الأمر: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible-vault encrypt ./vars/all.yml</code> </pre> <br><p style=";text-align:right;direction:rtl">  بطبيعة الحال ، أثناء التشفير سيكون من الضروري تعيين كلمة مرور لفك التشفير.  يمكنك رؤية ما يظهر داخل الملف بعد استدعاء هذا الأمر. </p><br><p style=";text-align:right;direction:rtl">  باستخدام <code>ansible-vault decrypt</code> يمكن فك تشفير الملف وتعديله ثم تشفيره مرة أخرى. </p><br><p style=";text-align:right;direction:rtl">  للعمل ، فك تشفير الملف ليست ضرورية.  يمكنك تخزينه في شكل مشفر وتشغيل playbook مع الوسيطة <code>--ask-vault-pass</code> .  سيطلب Ansible كلمة مرور والحصول على المتغيرات وإكمال المهام.  ستبقى جميع البيانات مشفرة. </p><br><p style=";text-align:right;direction:rtl">  يبدو الأمر الكامل للعديد من مجموعات المضيف والقبو غير المرغوب فيه مثل هذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging" --ask-vault-pass</code> </pre> <br><p style=";text-align:right;direction:rtl">  ولن أعطيك النص الكامل للكتب والأدوار ، اكتب لنفسك.  لأن الشيء غير الواضح هو - إذا لم تفهم ما يجب القيام به ، فلن يفعل ذلك. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar460769/">https://habr.com/ru/post/ar460769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar460743/index.html">رفرفة دليل المبتدئين</a></li>
<li><a href="../ar460745/index.html">خبرة في استخدام وحدة GSM في أتمتة المنزل</a></li>
<li><a href="../ar460747/index.html">البحث عن الأرباح أو تشديد المكسرات: توقف Spotify عن العمل مع المؤلفين مباشرةً - ماذا يعني ذلك</a></li>
<li><a href="../ar460751/index.html">كيف أطلقنا الروبوتات في تشيرنوبيل الصغيرة. الجزء 1</a></li>
<li><a href="../ar460755/index.html">ROS Trolley Robot - الجزء الأول: الحديد</a></li>
<li><a href="../ar460773/index.html">تطبيق مطابقة النمط في Java</a></li>
<li><a href="../ar460777/index.html">هذا هو الدور: لماذا غيرت Apple متطلبات مطوري التطبيقات</a></li>
<li><a href="../ar460779/index.html">تصحيح متقدم</a></li>
<li><a href="../ar460783/index.html">إجماع على سمعة العقدة. هل هو ضروري؟</a></li>
<li><a href="../ar460785/index.html">تطبيقات الكتب الإلكترونية على نظام التشغيل Android. الجزء 1. مقدمة والتطبيقات المكتبية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>