<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™ â• ğŸ§š é“¾æ¥å’Œä¸‹è½½Mach-Oæ–‡ä»¶çš„æŠ€å·§ âš™ï¸ ğŸ‘©ğŸ½â€ğŸ“ ğŸŠ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘å‘æ‚¨ä»‹ç»Darling Projectåšå®¢ä¸­æˆ‘æ–‡ç« çš„ç¿»è¯‘ã€‚ å¯¹æ‰€ç”¨æ¦‚å¿µçš„å¸®åŠ©ä¸å¤§ï¼šDarwin-ä¸€ç§åŸºäºmacOSï¼ŒiOSå’ŒAppleçš„å…¶ä»–æ“ä½œç³»ç»Ÿçš„å¼€æºæ“ä½œç³»ç»Ÿï¼› Mach-Oæ˜¯è¾¾å°”æ–‡ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“çš„äºŒè¿›åˆ¶æ ¼å¼ï¼› dyld-è¾¾å°”æ–‡ç”¨äºä¸‹è½½Mach-Oæ–‡ä»¶çš„åŠ¨æ€å¼•å¯¼ç¨‹åºï¼› dylibæ˜¯ä¸€ä¸ªå¯...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é“¾æ¥å’Œä¸‹è½½Mach-Oæ–‡ä»¶çš„æŠ€å·§</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417507/"><p> <em>æˆ‘å‘æ‚¨ä»‹ç»Darling Projectåšå®¢ä¸­æˆ‘æ–‡ç« çš„ç¿»è¯‘ã€‚</em>  <em>å¯¹æ‰€ç”¨æ¦‚å¿µçš„å¸®åŠ©ä¸å¤§ï¼šDarwin-ä¸€ç§åŸºäºmacOSï¼ŒiOSå’ŒAppleçš„å…¶ä»–æ“ä½œç³»ç»Ÿçš„å¼€æºæ“ä½œç³»ç»Ÿï¼›</em>  <em>Mach-Oæ˜¯è¾¾å°”æ–‡ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“çš„äºŒè¿›åˆ¶æ ¼å¼ï¼›</em>  <em>dyld-è¾¾å°”æ–‡ç”¨äºä¸‹è½½Mach-Oæ–‡ä»¶çš„åŠ¨æ€å¼•å¯¼ç¨‹åºï¼›</em>  <em>dylibæ˜¯ä¸€ä¸ªå¯åŠ¨æ€åŠ è½½çš„åº“ï¼ˆé€šå¸¸å…·æœ‰æ‰©å±•å<code>.dylib</code> ï¼‰ã€‚</em> </p><br><p><img src="https://habrastorage.org/webt/q4/to/tb/q4totbx7ltcbh_gj58-qnayiffg.png" alt="å›¾ç‰‡å¼•èµ·å…³æ³¨"></p><br><p>  Darling Projectçš„ç›®æ ‡æ˜¯ä½¿macOSåº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨Linuxä¸Šè¿è¡Œï¼Œå¹¶ä¸”èƒ½å¤Ÿä»¥Mach-Oæ ¼å¼ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶çš„èƒ½åŠ›æ˜¯å®ç°è¯¥ç›®æ ‡çš„å…³é”®æ­¥éª¤ä¹‹ä¸€ã€‚ </p><br><p> æœ€åˆï¼ŒDarlingå›´ç»•å…¶è‡ªèº«çš„Mach-OåŠ è½½å™¨å®ç°ä»¥åŠåœ¨é«˜çº§Darwin APIä¸Linuxå¯¹åº”å¯¹è±¡ä¹‹é—´å¹¿æ’­è°ƒç”¨çš„æƒ³æ³•è€Œæ„å»ºã€‚ ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬çš„é‡ç‚¹å·²è½¬ç§»åˆ°åœ¨è¶Šæ¥è¶Šå­¤ç«‹çš„Darwinå®¹å™¨ä¸­è¿è¡Œä»£ç ã€‚ è‡ªä»æˆ‘ä»¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ”¹ç”¨Darlingçš„å†…éƒ¨ç»„ä»¶ä½¿ç”¨Mach-O</a>ä»¥æ¥ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿä½¿ç”¨Appleçš„åŸå§‹æ¨¡å‹ï¼Œå¹¶æ„å»ºäº†è®¸å¤šå…¶ä»–å¼€æºçš„Darwinç»„ä»¶ã€‚ æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ä¸ªç®€å•çš„Mach-Oå¼•å¯¼ç¨‹åºæ¥å¼•å¯¼dyldæœ¬èº«ã€‚ </p><a name="habracut"></a><br><p>  Mach-Oå’ŒMachæœ¬èº«å¯èƒ½æ˜¯è¾¾å°”æ–‡æœ€è‘—åçš„æ ‡å¿—ï¼ŒAppleæä¾›çš„å„ç§åº“å’Œæ¡†æ¶å¹¿æ³›ä½¿ç”¨äº†Mach-Oæ ¼å¼çš„è®¸å¤šæ™¦æ¶©åŠŸèƒ½ã€‚ è¿™ä½¿å¾—ä¸Mach-Oä¸€èµ·å·¥ä½œæˆä¸ºå¼€å‘Darlingæ—¶æœ€é‡è¦å’Œå€¼å¾—æ³¨æ„çš„ä»»åŠ¡ä¹‹ä¸€ã€‚ ä»å®æ–½æœ¬åœ°Mach-OåŠ è½½ç¨‹åºåˆ°ç»„è£…è¾¾å°”æ–‡ç»„ä»¶ï¼ˆé¦–å…ˆä»¥ç‰¹æ®Šçš„ELFæ–‡ä»¶çš„å½¢å¼ï¼Œç°åœ¨ä»¥çœŸæ­£çš„Mach-Oçš„å½¢å¼ï¼‰-æˆ‘ä»¬éœ€è¦æ¯”æ™®é€šäººæ›´æ·±å…¥åœ°äº†è§£Mach-Oçš„å†…éƒ¨ç»“æ„ã€‚è¾¾å°”æ–‡å¹³å°çš„å¼€å‘äººå‘˜ã€‚ </p><br><p> æˆ‘ä»¬å®Œæˆäº†æœ¬ä»‹ç»ï¼Œç„¶åç»§ç»­è®¨è®ºMach-Oæ ¼å¼å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€äº›æŠ€å·§ã€‚ </p><br><h2 id="ustanovochnye-imena"> å®‰è£…åç§° </h2><br><p> åœ¨Windowså’ŒLinuxä¸Šï¼ŒåŠ¨æ€åº“ç”±å®ƒä»¬çš„åç§°ï¼ˆä¾‹å¦‚<code>libc.so</code> ï¼‰å¼•ç”¨ï¼Œæ­¤åï¼ŒåŠ¨æ€é“¾æ¥ç¨‹åºçš„ä»»åŠ¡æ˜¯åœ¨æ ‡å‡†åº“ç›®å½•ä¹‹ä¸€ä¸­æŸ¥æ‰¾å…·æœ‰åŒ¹é…åç§°çš„åº“ã€‚ è¾¾å°”æ–‡ç«‹å³æ”¹ä¸ºä½¿ç”¨åº“æ–‡ä»¶çš„ï¼ˆå‡ ä¹ï¼‰å®Œæ•´è·¯å¾„ï¼Œè¯¥è·¯å¾„ç§°ä¸ºè¯¥åº“çš„å®‰è£…åç§°ã€‚ å¤§æ¦‚æ˜¯è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢<em>dylib</em> [dylibåŠ«æŒ]çš„<em>æ›¿ä»£</em> -ä¸€ç§æ”»å‡»ï¼Œå…¶ä¸­å°†ä¼ªé€ çš„dylibæ”¾ç½®åœ¨ç›®å½•ä¸­ï¼ŒåŠ¨æ€é“¾æ¥ç¨‹åºå°†åœ¨æ¯”å®é™…çœŸå®ç›®å½•æ—©çš„ä½ç½®æ‰¾åˆ°å®ƒï¼Œä»è€Œå…è®¸ä¼ªé€ çš„dylibä»£è¡¨ç¨‹åºæ‰§è¡Œä»»æ„ä»£ç ï¼Œå› æ­¤ç¡®ä¿¡äº†è¿™ä¸€ç‚¹ã€‚ dylibä¸‹è½½ã€‚ </p><br><p> ä¸ä»…å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“å­˜å‚¨äº†å…¶ä¾èµ–é¡¹çš„å®Œæ•´å®‰è£…åï¼Œè€Œä¸”Mach-Oä¾èµ–é¡¹æœ¬èº«ä¹Ÿâ€œçŸ¥é“â€äº†è‡ªå·±çš„å®‰è£…åã€‚ å®é™…ä¸Šï¼Œé“¾æ¥å™¨å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥äº†è§£è¦ç”¨äºä¾èµ–é¡¹çš„å®‰è£…åç§°ï¼šå®ƒä»ä¾èµ–é¡¹æœ¬èº«ä¸­è¯»å–å®ƒä»¬ã€‚ </p><br><p> é“¾æ¥dylibæ—¶ï¼Œå¯ä»¥ä½¿ç”¨é€‰é¡¹ld <code>-install_name</code>æˆ–<code>-dylib_install_name</code>æ¥æŒ‡å®šå…¶å®‰è£…åç§°ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -install_name /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libfoo.dylib</code> </pre> <br><p> ç°åœ¨ï¼Œå½“æ‚¨å°†å¦ä¸€ä¸ªMach-Oæ–‡ä»¶ï¼ˆä¾‹å¦‚<code>libbar.dylib</code> ï¼‰é“¾æ¥åˆ°<code>libfoo.dylib</code> ï¼Œldå°†åœ¨<code>libbar</code>ä¾èµ–é¡¹<code>libbar</code>å†™å…¥libfooå®‰è£…åç§°- <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> ï¼Œè¿™å°±æ˜¯dyldæ‰€åœ¨çš„ä½ç½®ã€‚ä¼šåœ¨è¿è¡Œæ—¶æŸ¥æ‰¾<code>libfoo</code> ã€‚ </p><br><p> å¯¹äºç³»ç»Ÿåº“è€Œè¨€ï¼Œä½¿ç”¨å®Œæ•´è·¯å¾„å·²ç»è¶³å¤Ÿå¥½äº†ï¼Œäº‹å®ä¸Šï¼Œè¿™äº›ç³»ç»Ÿåº“å·²å®‰è£…åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä»¥å‰å·²çŸ¥çš„ä½ç½®ã€‚ ä½†æ˜¯ä½¿ç”¨åº“ä½œä¸ºåº”ç”¨ç¨‹åºæ†ç»‘åŒ…çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚ å°½ç®¡æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½å¯ä»¥å‡å®šå°†å…¶å®‰è£…åœ¨<code>/Applications/AppName.app</code> ï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ„å‘³ç€åº”ç”¨ç¨‹åºç¨‹åºé›†æ˜¯å¯ç§»æ¤çš„ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è‡ªç”±ç§»åŠ¨ï¼Œå› æ­¤æ­¤ç±»ç¨‹åºé›†ä¸­çš„ç‰¹å®šåº“è·¯å¾„æ— æ³•æå‰çŸ¥é“ã€‚ </p><br><p> ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œè¾¾å°”æ–‡å…è®¸å®‰è£…åç§°ä»¥<code>@executable_path</code> ï¼Œ <code>@loader_path</code>æˆ–<code>@rpath</code> -ä¸æ˜¯ç»å¯¹çš„ï¼Œè€Œæ˜¯æŒ‡ç¤ºç›¸å¯¹äºä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œâ€œåŠ è½½â€è·¯å¾„ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“ï¼Œåˆ†åˆ«ç›´æ¥å–å†³äºæ­¤åº“ï¼‰æˆ–ç›¸å¯¹äºä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶å®šä¹‰çš„è·¯å¾„åˆ—è¡¨ã€‚  <code>@executable_path</code>å’Œ<code>@loader_path</code>å·¥ä½œæ²¡æœ‰å…¶ä»–å¤æ‚æ€§ï¼Œä½†æ˜¯å¦‚æœè‡³å°‘ä¸€ä¸ªä¾èµ–é¡¹ï¼ˆæˆ–å®ƒä»¬çš„ä¼ é€’æ€§ä¾èµ–é¡¹ï¼‰å…·æœ‰ä½¿ç”¨<code>@rpath</code>çš„è®¾ç½®åç§°ï¼Œ <code>@rpath</code>åœ¨ä½¿ç”¨ld <code>-rpath</code>é€‰é¡¹é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå¿…é¡»æ˜¾å¼è®¾ç½®<code>@rpath</code> ã€‚å€æ‚¨éœ€è¦å¤šå°‘ï¼š </p><br><pre> <code class="bash hljs">$ ld -o runme -rpath @executable_path/../Frameworks -rpath @executable_path/../bin/lib</code> </pre> <br><p>  ï¼ˆrpathæ¦‚å¿µåœ¨æŸç§ç¨‹åº¦ä¸Šç ´åäº†ä¼—æ‰€å‘¨çŸ¥çš„åº“è·¯å¾„çš„åŸå§‹æ¦‚å¿µï¼Œå¹¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰“å¼€äº†</a> dylibæ¬ºéª—æ”»å‡»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„</a>å¯èƒ½æ€§ã€‚æˆ‘ä»¬å¯ä»¥å‡è®¾è¿™ä¼šä½¿ä¸å®‰è£…åç§°ç›¸å…³çš„æ‰€æœ‰äº‹æƒ…éƒ½å˜å¾—æ¯«æ— ç”¨å¤„ã€‚ï¼‰ </p><br><h2 id="ciklicheskie-zavisimosti"> å¾ªç¯ä¾èµ– </h2><br><p> å½“ä¸€ä¸ªé¡¹ç›®çš„æºä»£ç å ç”¨å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œå¦‚æœè¿™äº›æ–‡ä»¶ç›¸äº’ä¾èµ–æ˜¯å®Œå…¨æ­£å¸¸çš„ã€‚ åªè¦å°†æ‰€æœ‰è¿™äº›æ–‡ä»¶ç¼–è¯‘ä¸ºå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“ï¼‰ï¼Œæ­¤æ–¹æ³•å°±å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ å½“å‡ ä¸ªåŠ¨æ€åº“ç›¸äº’ä¾èµ–æ—¶ï¼Œä¸èµ·ä½œç”¨ã€‚ </p><br><p> æ‚¨å¯èƒ½ä¼šäº‰è¾©è¯´ï¼Œä¸å…¶é‡æ–°ä½¿ç”¨åŠ¨æ€åº“ä¹‹é—´çš„å¾ªç¯ä¾èµ–å…³ç³»ï¼Œä¸å¦‚é‡æ–°è®¾è®¡é¡¹ç›®ä½“ç³»ç»“æ„ï¼Œè¿™ä¸€ç‚¹æˆ‘åŒæ„ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæœ‰è‹¹æœå…¬å¸çš„å…¸å‹ä»£è¡¨ï¼Œé‚£å°±æ˜¯ä»–ä»¬æ°¸è¿œä¸ä¼šåœæ­¢æ€è€ƒå¹¶æ­£ç¡®åœ°åšäº‹ã€‚ å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä»–ä»¬æŠŠæ‹æ–å’ŒæŠŠæˆæ‘†åœ¨å½¼æ­¤ä¹‹ä¸Šã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºDarlingï¼Œæˆ‘ä»¬éœ€è¦ä½¿å¾ªç¯ä¾èµ–é¡¹èµ·ä½œç”¨ï¼Œå› ä¸ºå„ç§libSystem <code>libSystem</code> ï¼ˆä¾‹å¦‚<code>libsystem_dyld</code> ï¼Œ <code>libsystem_kernel</code>å’Œ<code>libsystem_pthread</code> ï¼‰éƒ½ç›¸äº’ä¾èµ–ã€‚  ï¼ˆç›´åˆ°æœ€è¿‘ï¼Œç”±äºåœ¨Cocotronä¸­å®ç°äº†Core OpenGLçš„æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜ä¸å¾—ä¸å¾ªç¯é“¾æ¥è¯¸å¦‚AppKitï¼ŒCore Graphicså’ŒCore OpenGLä¹‹ç±»çš„Cocoaæ¡†æ¶ï¼Œä½†æ˜¯æˆ‘ä»¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‡æ–°è®¾è®¡äº†</a> Core OpenGLçš„å®ç°æ¶æ„ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‘†è„±è¿™ç§å¾ªç¯ä¾èµ–é¡¹ã€‚ï¼‰ </p><br><p> åŸåˆ™ä¸Šï¼Œå¾ªç¯ä¾èµ–é¡¹åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼šåŠ¨æ€é“¾æ¥å™¨å·²ç»çŸ¥é“å¦‚ä½•ä»…åŠ è½½ä¸€æ¬¡æ¯ä¸ªåº“ï¼Œå› æ­¤æ— é™é€’å½’ä¸ä¼šæœ‰é—®é¢˜ã€‚ é—®é¢˜æ˜¯ä¸èƒ½ç®€å•åœ°<em>é“¾æ¥</em>è¿™æ ·çš„åº“ï¼Œå› ä¸ºæ¯ä¸ªé“¾æ¥ç¨‹åºè°ƒç”¨ä»…åˆ›å»ºä¸€ä¸ªåº“ï¼Œå¹¶ä¸”åœ¨é“¾æ¥ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ï¼Œå¿…é¡»å°†å·²é“¾æ¥çš„æ‰€æœ‰ä¾èµ–é¡¹éƒ½è½¬ç§»åˆ°é“¾æ¥å™¨ã€‚ æˆ‘ä»¬å¿…é¡»é¦–å…ˆé“¾æ¥æˆ‘ä»¬çš„ä¸€ä¸ªåº“ï¼Œç›®å‰å…¶ä»–åº“è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå› æ­¤æˆ‘ä»¬å°†æ— æ³•å°†å®ƒä»¬ä¼ è¾“åˆ°é“¾æ¥å™¨ã€‚ </p><br><p> è¿™é‡Œçš„æŠ€å·§æ˜¯å°†è¿™äº›åº“çš„æŸäº›ï¼ˆæˆ–ä¸ºç®€å•èµ·è§ï¼Œå…¨éƒ¨ï¼‰é“¾æ¥<em>ä¸¤æ¬¡</em> ã€‚ ç¬¬ä¸€æ¬¡ï¼Œå‘Šè¯‰é“¾æ¥ç¨‹åºå¿½ç•¥ç¼ºå°‘çš„ä¾èµ–å…³ç³»ï¼Œå®é™…ä¸Šï¼Œä¸è¦ä¼ é€’ä¾èµ–å…³ç³»ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -flat_namespace -undefined suppress $ ld -o libbar.dylib bar.o -flat_namespace -undefined suppress</code> </pre> <br><p>  ï¼ˆæœ‰å…³<code>-flat_namespace</code>è¯·å‚è§ä¸‹æ–‡ã€‚ï¼‰ </p><br><p> å½“ç„¶ï¼Œå¦‚æœå°è¯•ç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„dylibï¼Œåˆ™ä¼šåœ¨è¿è¡Œæ—¶å‡ºç°åŠ¨æ€é“¾æ¥é”™è¯¯ã€‚ ç›¸åï¼Œè¯·å†æ¬¡é“¾æ¥è¿™äº›åº“ï¼Œå¹¶å°†ç”Ÿæˆçš„dylibä½œä¸ºä¾èµ–é¡¹ä¼ é€’ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o libfoo.dylib</code> </pre> <br><p> è¿™æ¬¡ï¼Œé“¾æ¥å™¨ä¼šçœ‹åˆ°æ‰€æœ‰å­—ç¬¦ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šå‘Šè¯‰ä»–å¿½ç•¥é”™è¯¯ï¼ˆå¦‚æœç¡®å®ä¸¢å¤±äº†æŸäº›å­—ç¬¦ï¼Œåˆ™ä¼šå‡ºç°é”™è¯¯ï¼‰ã€‚ </p><br><p> å°½ç®¡æŸäº›ï¼ˆå¦‚æœä¸æ˜¯å…¨éƒ¨ï¼‰åº“é“¾æ¥åˆ°å…¶ä¾èµ–é¡¹çš„â€œé”™è¯¯â€å‰¯æœ¬ï¼Œåˆ™dyldå°†åœ¨è¿è¡Œæ—¶çœ‹åˆ°æ­£ç¡®çš„ç‰ˆæœ¬ã€‚ ä¸ºæ­¤ï¼Œè¯·ç¡®ä¿æ¯ä¸ªåº“çš„ä¸¤ä¸ªå‰¯æœ¬éƒ½å…·æœ‰ç›¸åŒçš„å®‰è£…åç§°ã€‚ </p><br><p> è¿™é‡Œçš„å¦ä¸€ä¸ªç»†èŠ‚æ˜¯åˆå§‹åŒ–é¡ºåºã€‚ ä»»ä½•ä»£ç éƒ½å¯ä»¥ä½¿ç”¨<code>__attribute__((constructor))</code>ç¼–è¯‘å™¨magicå‘½ä»¤å£°æ˜åˆå§‹åŒ–ç¨‹åºå‡½æ•°ï¼ˆæ­¤ç±»åˆå§‹åŒ–ç¨‹åºçš„åˆ—è¡¨ä½äºMach-Oæ–‡ä»¶çš„<code>__mod_init_func</code>èŠ‚ä¸­ï¼‰ã€‚ å½“åœ¨è°ƒç”¨<code>main()</code>ä¹‹å‰åŠ è½½å®ƒä»¬æ‰€åœ¨çš„äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ï¼Œdyldä¼šè°ƒç”¨è¿™äº›å‡½æ•°ã€‚ é€šå¸¸ï¼Œæ¯ä¸ªåº“çš„åˆå§‹åŒ–å™¨åœ¨å…¶ä¾èµ–é¡¹çš„åˆå§‹åŒ–å™¨ä¹‹åæ‰§è¡Œï¼Œå› æ­¤æ¯ä¸ªåˆå§‹åŒ–å™¨éƒ½å¯ä»¥æœŸæœ›ä¾èµ–é¡¹åº“å·²è¢«åˆå§‹åŒ–å¹¶å¯ä»¥ä½¿ç”¨ã€‚ å½“ç„¶ï¼Œå¯¹äºå¾ªç¯ä¾èµ–æ€§ä¸èƒ½ä¿è¯ã€‚  dyldå°†ä»¥<em>æŸç§</em>é¡ºåºæ‰§è¡Œå…¶åˆå§‹åŒ–ç¨‹åºã€‚ æ‚¨å¯ä»¥å°†ä¾èµ–æ€§æ ‡è®°ä¸ºå‘ä¸Šä¾èµ–æ€§ä»¥è‡ªå®šä¹‰æ­¤é¡ºåºã€‚  dyldå°†æœ€ååˆå§‹åŒ–æŸäººå·²å°†å…¶æ ‡è®°ä¸ºä¾èµ–é¡¹çš„åº“ã€‚ å› æ­¤ï¼Œè¦ä½¿<code>libfoo</code>åœ¨<code>libbar</code>ä¹‹ååˆå§‹åŒ–ï¼Œè¯·åƒè¿™æ ·é“¾æ¥å®ƒä»¬ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o -upward_library libfoo.dylib</code> </pre> <br><p> ä¸ºäº†ä½¿ä¸€åˆ‡æ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>add_circular</code></a>çš„Darling CMakeå‡½æ•°ï¼Œå®ƒå¯ä»¥è§£å†³æ‰€æœ‰å›°éš¾ï¼Œå¹¶å…è®¸æ‚¨åƒè¿™æ ·ç®€å•ä¸”å£°æ˜æ€§åœ°ä½¿ç”¨å®ƒï¼š </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(DYLIB_INSTALL_NAME <span class="hljs-string"><span class="hljs-string">"/usr/lib/system/libdispatch.dylib"</span></span>) add_circular(libdispatch_shared FAT SOURCES <span class="hljs-variable"><span class="hljs-variable">${dispatch_SRCS}</span></span> SIBLINGS system_c system_kernel system_malloc system_blocks system_pthread system_dyld system_duct unwind platform compiler_rt UPWARD objc )</code> </pre> <br><h2 id="dvuhurovnevoe-prostranstvo-imyon-simvolov"> ä¸¤çº§å­—ç¬¦åç§°ç©ºé—´ </h2><br><p>  Mach-Oä¸­çš„ç¬¦å·è¡¨ä¸ä»…å­˜å‚¨ç¬¦å·åç§°ï¼Œå®ƒä»¬è¿˜â€œè®°ä½â€ä»å“ªä¸ªåº“ï¼ˆæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ä¸­æå–ç¬¦å·ã€‚ æ¢å¥è¯è¯´ï¼Œç¬¦å·åç§°å­˜åœ¨äºç”±äºŒè¿›åˆ¶å®šä¹‰å®ƒä»¬çš„åç§°ç©ºé—´ä¸­ã€‚ å› æ­¤ï¼Œâ€œäºŒçº§å‘½åç©ºé—´â€ï¼ˆå¦ä¸€çº§è¡¨ç¤ºç¬¦å·åç§°æœ¬èº«ï¼‰ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼•å…¥</a>äº†ä¸¤çº§åç§°ç©ºé—´ï¼Œä»¥é˜²æ­¢ç¬¦å·åç§°å†²çªã€‚ é€šå¸¸ï¼Œå¦‚æœå¤šä¸ªåº“ç”¨ç›¸åŒçš„åç§°å®šä¹‰å­—ç¬¦ï¼Œåˆ™åœ¨é“¾æ¥æœŸé—´ä¼šå‡ºç°é”™è¯¯ï¼› ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨è¿è¡Œæ—¶åŠ è½½åº“ï¼ˆä¾‹å¦‚æ’ä»¶ï¼‰ï¼Œæˆ–è€…åœ¨é“¾æ¥æ—¶å’Œè¿è¡Œæ—¶åº“çš„ç‰ˆæœ¬ä¸åŒæ—¶ï¼Œè¿™å¯èƒ½ä¸èµ·ä½œç”¨ã€‚ å¯¹äºä½¿ç”¨ä¸¤çº§åç§°ç©ºé—´çš„åº“è€Œè¨€ï¼Œè¿™ä¸æ˜¯é—®é¢˜-å®ƒå…è®¸å¤šä¸ªåº“ä»¥ç›¸åŒçš„åç§°å®šä¹‰å­—ç¬¦è€Œä¸ä¼šäº§ç”Ÿå†²çªã€‚ </p><br><p> å¯ä»¥é€šè¿‡æ¢å¤ä½¿ç”¨â€œå¹³é¢åç§°ç©ºé—´â€æ¥å…³é—­ä¸¤çº§åç§°ç©ºé—´ï¼ˆåŸå› ä¹‹ä¸€æ˜¯ï¼Œä½¿ç”¨ä¸¤çº§åç§°ç©ºé—´æ„å‘³ç€åœ¨é“¾æ¥æœŸé—´å¿…é¡»å…è®¸æ¯ä¸ªå­—ç¬¦ï¼Œå› æ­¤<code>-undefined_suppress</code>éœ€è¦å¹³é¢åç§°ç©ºé—´ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°ï¼‰ã€‚  Ldå…·æœ‰ä¸¤ä¸ªæ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—ä½¿æ‚¨å¯ä»¥åœ¨é“¾æ¥æœŸé—´ç¦ç”¨ä¸¤çº§åç§°ç©ºé—´ï¼š <code>-flat_namespace</code>ä»…å½±å“ä¸€ä¸ªMach-Oæ–‡ä»¶ï¼› <code>-force_flat_namespace</code>ä»…é€‚ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œä¸æ˜¯åº“ï¼Œå¹¶å¼ºåˆ¶æ•´ä¸ªè¿‡ç¨‹ä½¿ç”¨flatå‘½åç©ºé—´ã€‚ å¦å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡<code>DYLD_FORCE_FLAT_NAMESPACE</code>æ¥å¼ºåˆ¶dyldåœ¨è¿è¡Œæ—¶ä½¿ç”¨å¹³é¢åç§°ç©ºé—´ã€‚ </p><br><p> ä½¿ç”¨ä¸¤å±‚åç§°ç©ºé—´çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯ï¼Œæ‚¨å§‹ç»ˆå¿…é¡»å°†æ¯ä¸ªMach-Oæ˜¾å¼é“¾æ¥åˆ°å®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰åº“å’Œæ¡†æ¶ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœé“¾æ¥åˆ°AppKitï¼Œåˆ™ä¸èƒ½ä»…ä½¿ç”¨Foundationã€‚ æ‚¨å¿…é¡»æ˜ç¡®é“¾æ¥åˆ°å¥¹ã€‚ å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯ï¼Œä½œä¸ºåº“æˆ–æ¡†æ¶çš„ä½œè€…ï¼Œæ‚¨ä¸èƒ½åƒä¹ æƒ¯é‚£æ ·éšæ„åœ°æ²¿ä¾èµ–å…³ç³»é“¾è‡ªç”±ç§»åŠ¨ç¬¦å·â€œ downâ€çš„å®ç°ï¼ˆä¾‹å¦‚ï¼Œä¸èƒ½å°†ä»£ç ä»AppKitç§»è‡³Foundationï¼‰ã€‚ ä¸ºæ­¤ï¼ŒMach-Oï¼Œldå’Œdyldå…·æœ‰å‡ ä¸ªé™„åŠ åŠŸèƒ½ï¼Œå³<em>å­åº“</em> ï¼Œ <em>å­—ç¬¦çš„</em> <em>é‡æ–°å¯¼å‡º</em>å’Œ<em>å…ƒå­—ç¬¦</em> ã€‚ </p><br><h2 id="podbiblioteki"> å­åº“ </h2><br><p> å­åº“-å…è®¸ä¸€ä¸ªåº“ï¼ˆç§°ä¸º<em>ç«‹é¢</em>åº“[umbrellaåº“]æˆ–ä¼å½¢åº“[umbrellaåº“]ï¼‰å°†å…¶éƒ¨åˆ†åŠŸèƒ½çš„å®ç°å§”æ´¾ç»™å¦ä¸€ä¸ªåº“ï¼ˆç§°ä¸ºå­åº“[sub-library]ï¼‰çš„æœºåˆ¶ï¼› æˆ–è€…ï¼Œå¦‚æœæ‚¨ä»å¦ä¸€ä¾§çœ‹ï¼Œåˆ™å…è®¸è¯¥åº“å…¬å¼€é‡æ–°å¯¼å‡ºå¦ä¸€ä¸ªåº“æä¾›çš„ç¬¦å·ã€‚ </p><br><p> å†æ¬¡ä½¿ç”¨å®ƒçš„ä¸»è¦åœ°æ–¹æ˜¯<code>libSystem</code>åŠå…¶åœ¨<code>/usr/lib/system</code>å­åº“ï¼› ä½†æ˜¯å®ƒå¯ä»¥ä¸ä»»ä½•ä¸€å¯¹åº“ä¸€èµ·ä½¿ç”¨ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -lobjc -sub_library libobjc <span class="hljs-comment"><span class="hljs-comment"># : $ ld -o libfoo.dylib foo.o -reexport-lobjc</span></span></code> </pre> <br><p> ä¸ä»…é“¾æ¥åˆ°è¯¥åº“ç›¸æ¯”ï¼Œå½±å“æ­¤æ“ä½œçš„å”¯ä¸€å› ç´ æ˜¯å°†<code>LC_REEXPORT_DYLIB</code>å‘½ä»¤å†™å…¥åˆ°ç”Ÿæˆçš„æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„<code>LC_LOAD_DYLIB</code> ï¼ˆåŒ…æ‹¬é“¾æ¥æœŸé—´æ¥è‡ªå­åº“çš„ç¬¦å·<em>ä¸ä¼š</em>å¤åˆ¶åˆ°ä¼çŠ¶åº“ï¼Œå› æ­¤å®ƒç”šè‡³ä¸å¿…å¦‚æœä»¥åå°†æ–°å­—ç¬¦æ·»åŠ åˆ°å­åº“ï¼Œè¯·é“¾æ¥ï¼‰ã€‚ åœ¨è¿è¡Œæ—¶ï¼Œ <code>LC_REEXPORT_DYLIB</code>å·¥ä½œ<code>LC_REEXPORT_DYLIB</code>ä¹Ÿç±»ä¼¼äº<code>LC_LOAD_DYLIB</code> ï¼šdyldå°†åŠ è½½å­åº“å¹¶ä½¿å…¶ä½™å­—ç¬¦å¯ç”¨ï¼ˆä½†ä¸<code>LC_LOAD_DYLIB</code>ä¸åŒï¼Œå°±ä¸¤çº§å‘½åç©ºé—´è€Œè¨€ï¼Œå­—ç¬¦å°†æ¥è‡ªä¼å½¢åº“ï¼‰ã€‚ </p><br><p>  <code>LC_REEXPORT_DYLIB</code>çœŸæ­£åŒºåˆ«åœ¨äºï¼Œå½“æ‚¨å°†<em>å¦ä¸€ä¸ª</em>åº“é“¾æ¥åˆ°<code>libfoo</code>æ—¶ldä¼šåšä»€ä¹ˆï¼šldä¸ä»…ä¼šåœ¨ä¼ é€’ç»™å®ƒçš„æ‰€æœ‰å¯¹è±¡å’Œdylibæ–‡ä»¶ä¸­æŸ¥æ‰¾ç¬¦å·ï¼Œè¿˜ä¼šæ‰“å¼€å¹¶æŸ¥çœ‹é‡æ–°å¯¼å‡ºçš„å­åº“ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼‰ <code>libobjc</code>ç¤ºä¾‹ï¼‰ã€‚ </p><br><p> ä»–æ€ä¹ˆçŸ¥é“åœ¨å“ªé‡Œæ‰¾å¥¹ï¼Ÿ ä¿å­˜åœ¨<code>libfoo.dylib</code>çš„å”¯ä¸€ä¸œè¥¿æ˜¯å®‰è£…åç§°<code>libobjc.dylib</code> ï¼Œå› æ­¤ldå¸Œæœ›æ‰¾åˆ°å®ƒã€‚ è¿™æ„å‘³ç€å¿…é¡»å°†è¯¥åº“å®‰è£…åˆ°ä½ï¼Œç„¶åæ‰èƒ½ç”¨ä½œå…¶ä»–ä»»ä½•å­åº“ã€‚ è¿™å¯¹äºåƒ<code>libobjc</code>è¿™æ ·çš„ç³»ç»Ÿåº“æ¥è¯´æ•ˆæœ<code>libobjc</code> ï¼Œä½†æ˜¯å¦‚æœæ‚¨å°è¯•é‡æ–°å¯¼å‡ºè‡ªå·±çš„å­åº“ï¼Œå¯èƒ½ä¼šéå¸¸ä¸ä¾¿æˆ–å®Œå…¨ä¸å¯èƒ½ã€‚ </p><br><p> ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œldæä¾›äº†<code>-dylib_file</code>é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å…è®¸æ‚¨æŒ‡å®šåœ¨é“¾æ¥æœŸé—´è¦ä½¿ç”¨çš„å…¶ä»–dylibè·¯å¾„ï¼š </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -reexport_library /path/to/libsubfoo.dylib $ ld -o libbar.dylib bar.o libfoo.dylib -dylib_file @executable_path/lib/foo/libsubfoo.dylib:/path/to/libsubfoo.dylib</code> </pre> <br><p> å°½ç®¡<code>libSystem</code>å’Œå…¶ä»–ä¸€äº›ç³»ç»Ÿåº“é‡æ–°å¯¼å‡ºäº†å®ƒä»¬çš„å­åº“ï¼Œ <code>-dylib_file</code>å½“é“¾æ¥macOSä¸Šçš„æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œæ‚¨ä¸å¿…ä½¿ç”¨<code>-dylib_file</code> ã€‚ è¿™æ˜¯å› ä¸ºå·²ç»æ ¹æ®ç³»ç»Ÿåº“çš„å®‰è£…åç§°å®‰è£…äº†ç³»ç»Ÿåº“ã€‚ ä½†æ˜¯ï¼Œåœ¨Linuxä¸Šæ„å»ºDarlingæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å‘æ¯ä¸ªldè°ƒç”¨ä¼ é€’ä¸€äº›<code>-dylib_file</code>é€‰é¡¹ï¼ˆä»¥åŠå…¶ä»–å…¬å…±å‚æ•°ï¼‰ã€‚ æˆ‘ä»¬é€šè¿‡ä½¿ç”¨<code>add_darling_library</code> ï¼Œ <code>add_darling_executable</code>ä»¥åŠå…¶ä»–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‡½æ•°æ—¶</a>ä¼šè‡ªåŠ¨åº”ç”¨çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç‰¹æ®ŠåŠŸèƒ½</a>æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚ </p><br><h2 id="pereeksportirovanie-simvolov"> é‡æ–°å¯¼å‡ºå­—ç¬¦ </h2><br><p> æœ‰æ—¶ä¸€ä¸ªåº“å¯èƒ½éœ€è¦ä»å¦ä¸€ä¸ªåº“ä¸­é‡æ–°å¯¼å‡ºæŸäº›å­—ç¬¦ï¼Œä½†ä¸æ˜¯ä¸€æ¬¡å…¨éƒ¨å¯¼å‡ºã€‚ ä¾‹å¦‚ï¼ŒCore Foundationæ­£åœ¨<code>NSObject</code> ï¼Œå‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ï¼Œ <code>NSObject</code>åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­æ˜¯åœ¨Objective-Cè¿è¡Œæ—¶å†…éƒ¨å®ç°çš„ã€‚ </p><br><p>  ï¼ˆå¦‚æœæ‚¨å¯¹ä¸ºä»€ä¹ˆ<code>NSObject</code>æ›¾ç»åœ¨Core Foundationä¸­è€Œä¸æ˜¯åœ¨Foundationä¸­æ„Ÿå…´è¶£ï¼Œé‚£æ˜¯å› ä¸º<em>å…è´¹è½¬æ¢</em> [å…è´¹ç”µè¯æ¡¥æ¥ï¼Œç›´æ¥åœ¨å¯¹åº”çš„Core Foundationå’ŒFoundationç±»å‹ä¹‹é—´è¿›è¡Œ<em>è½¬æ¢</em>çš„èƒ½åŠ›ï¼Œ [é¢å¤–çš„è½¬æ¢]ï¼Œè¦æ±‚åœ¨Core Foundationä¸­å®ç°Core Foundationä¸Šç±»å‹çš„ç§æœ‰åŒ…è£…ç±»ï¼ˆä¾‹å¦‚<code>__NSCFString</code> ï¼‰ï¼›ä½œä¸ºObjective-Cå¯¹è±¡ï¼Œå®ƒä»¬å¿…é¡»ä»<code>NSObject</code>ç»§æ‰¿ã€‚åˆ°å¦ä¸€ä¸ªï¼Œå°†<code>NSObject</code>åŠå…¶æ‰€æœ‰ç»§æ‰¿äººç•™åœ¨Foundationå’Œå¾ªç¯ä¸­  eskyå°†Core Foundationå’ŒFoundationé“¾æ¥åœ¨ä¸€èµ·ï¼Œä½†æ˜¯Appleå†³å®šå°†è¿™äº›å¸®åŠ©ç¨‹åºç§æœ‰ç±»ä¸<code>NSObject</code>ä¸€èµ·è¿ç§»åˆ°Core Foundationï¼Œåœ¨Darlingä¸­ï¼Œæˆ‘ä»¬ä»¥ç›¸åŒçš„æ–¹å¼ç»´æŠ¤å…¼å®¹æ€§ã€‚ï¼‰ </p><br><p> æ‚¨å¯ä»¥ä½¿ç”¨ldçš„<code>-reexported_symbols_list</code>é€‰é¡¹ä¼ é€’è¦<code>-reexported_symbols_list</code>çš„å­—ç¬¦åˆ—è¡¨ï¼š </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> .objc_class_name_NSObject &gt; reexport_list.exp $ ld -o CoreFoundation CFFiles.o -lobjc -reexported_symbols_list reexport_list.exp</code> </pre> <br><p> å°½ç®¡é‡æ–°å¯¼å‡º<em>æŸäº›</em>ç¬¦å·å¬èµ·æ¥ä¸é‡æ–°å¯¼å‡º<em>æ‰€æœ‰</em>ç¬¦å·éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯å®ç°æ­¤ç¬¦å·çš„æœºåˆ¶ä¸å­åº“çš„å·¥ä½œæ–¹å¼éå¸¸ä¸åŒã€‚ ä¸ä½¿ç”¨ç‰¹æ®Šçš„<code>LC_*_DYLIB</code>å‘½ä»¤ï¼› è€Œæ˜¯åœ¨åç§°è¡¨ä¸­æ’å…¥ä¸€ä¸ªç‰¹æ®Šçš„<em>é—´æ¥ç¬¦å·</em> ï¼ˆç”±<code>N_INDIR</code>æ ‡å¿—æŒ‡ç¤ºï¼‰ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºè¯¥åº“ä¸­å®šä¹‰çš„ç¬¦å·ã€‚ å¦‚æœåº“æœ¬èº«ä½¿ç”¨æ­¤ç¬¦å·ï¼Œåˆ™è¯¥ç¬¦å·çš„<em>ç¬¬äºŒä¸ª</em> â€œä¸ç¡®å®šâ€å‰¯æœ¬å°†<em>å‡ºç°</em>åœ¨åç§°è¡¨ä¸­ï¼ˆå› ä¸ºå®ƒå‘ç”Ÿæ—¶æ²¡æœ‰ä»»ä½•é‡æ–°å¯¼å‡ºï¼‰ã€‚ </p><br><p> ä½¿ç”¨å­—ç¬¦çš„æ˜¾å¼é‡æ–°å¯¼å‡ºæ—¶è¦è®°ä½çš„ä¸€ä»¶é‡è¦çš„å°äº‹æƒ…æ˜¯ï¼Œæ‚¨å¾ˆå¯èƒ½éœ€è¦é’ˆå¯¹ä¸åŒçš„ä½“ç³»ç»“æ„é‡æ–°å¯¼å‡ºå…·æœ‰ä¸åŒåç§°çš„å­—ç¬¦ã€‚ ç¡®å®ï¼ŒObjective-Cçš„[åç§°å¤„ç†çº¦å®š]å‘½åçº¦å®šå’Œi386å’Œx86-64çš„Objective-CäºŒè¿›åˆ¶æ¥å£[ABI]æ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨i386ä¸Šï¼Œæ‚¨åªéœ€è¦<code>.objc_class_name_NSObject</code> ï¼Œåœ¨x86-64ä¸Š- <code>_OBJC_CLASS_$_NSObject</code> ï¼Œ <code>_OBJC_IVAR_$_NSObject.isa</code>å’Œ<code>_OBJC_METACLASS_$_NSObject</code> ã€‚ ä½¿ç”¨å­åº“æ—¶æ— éœ€è€ƒè™‘ï¼Œå› ä¸ºæ¯ç§æ¶æ„çš„æ‰€æœ‰è‡ªåŠ¨å¯ç”¨ç¬¦å·éƒ½ä¼šè‡ªåŠ¨é‡æ–°å¯¼å‡ºã€‚ </p><br><p> å¤§å¤šæ•°ç”¨äºMach-Oçš„å·¥å…·éƒ½é€æ˜åœ°å¤„ç†â€œåšâ€æˆ–é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆMach-Oæ–‡ä»¶åŒ…å«ç”¨äºå¤šä¸ªä½“ç³»ç»“æ„çš„å¤šä¸ªsub-Mach-Oï¼‰ã€‚  Clangå¯ä»¥ç¼–è¯‘å…·æœ‰æ‰€æœ‰è¯·æ±‚çš„ä½“ç³»ç»“æ„çš„é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œdyldä»dylibé€‰æ‹©è¦åŠ è½½çš„ä½“ç³»ç»“æ„ï¼ŒæŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒçš„ä½“ç³»ç»“æ„ï¼Œå¹¶ä¸”ldï¼Œotoolå’Œnmä¹‹ç±»çš„å·¥å…·ä¸å¯¹åº”äºè®¡ç®—æœºä½“ç³»ç»“æ„çš„ä½“ç³»ç»“æ„ä¸€èµ·å·¥ä½œï¼ˆå³ï¼ˆx86-64ï¼‰ï¼Œé™¤éæ‚¨æ˜ç¡®è¦æ±‚ä½¿ç”¨ç‰¹æ®Šæ ‡å¿—çš„å…¶ä»–ä½“ç³»ç»“æ„ã€‚ ,  -   ,     â€“  ,         ,      . </p><br><p>         .  ld          ,  ,     dylib-           lipo: </p><br><pre> <code class="bash hljs">$ ld -o CF_i386.dylib CFFiles.o -arch i386 -lobjc -reexported_symbols_list reexport_i386.exp $ ld -o CF_x86-64.dylib CFFiles.o -arch x86_64 -lobjc -reexported_symbols_list reexport_x86_64.exp $ lipo -arch i386 CF_i386.dylib -arch x86_64 CF_x86-64.dylib -create -output CoreFoundation</code> </pre> <br><p>  Darling   CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>add_separated_framework</code></a> ,        lipo,    CMake-   Core Foundation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> : </p><br><pre> <code class="cmake hljs">add_separated_framework(CoreFoundation CURRENT_VERSION SOURCES <span class="hljs-variable"><span class="hljs-variable">${cf_sources}</span></span> VERSION <span class="hljs-string"><span class="hljs-string">"A"</span></span> DEPENDENCIES objc system icucore LINK_FLAGS <span class="hljs-comment"><span class="hljs-comment"># ...    ) set_property(TARGET CoreFoundation_i386 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_i386.exp") set_property(TARGET CoreFoundation_x86_64 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_x86_64.exp")</span></span></code> </pre> <br><h2 id="meta-simvoly"> - </h2><br><p> - â€“   , ,   Apple     ,    . </p><br><p>   Mach-O-       macOS,   ,     <code>-mmacosx-version-min=10.x</code> (    iOS, tvOS, watchOS    ,  Apple      ).     ;   ,         <code>AVAILABLE_MAC_OS_X_VERSION_10_13_AND_LATER</code>      C++  <code>libstdc++</code> (  GNU)  <code>libc++</code> (  LLVM).      ,        Mach-O.  ,   ld   <code>-macosx_version_min</code> (        <code>m</code> ),     Mach-O- <code>LC_VERSION_MIN_MACOSX</code> ( dyld,    ,        ). </p><br><p>    ,  ld  <code>-macosx_version_min</code>   ,  - <em></em> Mach-O- . - â€“  ,     <code>$ld$</code> ,  ld,    ,    :     ,   .      <code>$ld$$$</code> .  <code></code>   <code>os10.5</code>  ,       - â€“  ,        <em></em>   Mach-O-   <em></em> ,   ; <code></code>   <code>add</code> , <code>hide</code> , <code>install_name</code>  <code>compatibility_version</code> ,   ld ,          <code></code> ,  <code></code>          ( )  , . </p><br><p>  <code></code>     , ,  ,             ; ,   -,   <code>libobjc</code> ,   <code>NSObject</code>  ,      macOS: </p><br><pre> <code class="hljs perl">$ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_METACLASS_$_NSObject</code> </pre> <br><p>           ,   ,   ,          ,   <em></em>   . </p><br><h2 id="rezolvery-simvolov">   </h2><br><p>      dyld â€“   <em> </em> [symbol resolvers],     .    ,  ,          ,  dyld     ,     . </p><br><p>         ld,     .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>.symbol_resolver</code> : </p><br><pre> <code class="hljs mel">;    foo _foo1: movl <span class="hljs-number"><span class="hljs-number">1</span></span>, %eax ret _foo2: movl <span class="hljs-number"><span class="hljs-number">2</span></span>, %eax ret .symbol_resolver _foo ;  -  call _condition jz .ret_foo2 movq _foo1, %rax ret .ret_foo2: movq _foo2, %rax ret ;   ,   _foo  ;   ,     , ;     . .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _foo _foo:</code> </pre> <br><p>    C          ,    ,     C: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         return 0; } static void *foo_resolver() { __asm__(".symbol_resolver _foo"); return condition() ? &amp;foo1 : &amp;foo2; }</span></span></code> </pre> <br><p> (     <code>_foo</code>   <code>foo</code> ,    Darwin        C,          .  ,      Mach-O    Darling,            ELF-,     .) </p><br><p>   <code>_foo</code>     ,          (           ),  <code>foo()</code>  <code>foo_resolver()</code>     ,  : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __asm__(<span class="hljs-string"><span class="hljs-string">".symbol_resolver _foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> condition() ? &amp;foo1 : &amp;foo2; }</code> </pre> <br><p>   ,    â€“     - ,   <code>foo()</code>   ,      (      <code>int</code> -).  ,  ,       :  <code>dlsym("_foo")</code>    <code>_foo</code> â€“  ,      ,       , â€“         . ,       ,    ,      <code>foo()</code>    <code>_foo</code> . </p><br><p>         .  Apple    <code>libplatform</code>                     : </p><br><pre> <code class="hljs tex">#define _OS_VARIANT_RESOLVER(s, v, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__attribute__((visibility(OS_STRINGIFY(v)))) extern void* s(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>void* s(void) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__asm__(".symbol_resolver _" OS_STRINGIFY(s)); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__VA_ARGS__ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} #define _OS_VARIANT_UPMP_RESOLVER(s, v) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>_OS_VARIANT_RESOLVER(s, v, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>uint32_t *_c = (void*)(uintptr_t)_COMM_PAGE_CPU_CAPABILITIES; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (*_c &amp; kUP) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, up)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, up); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} else { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, mp)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, mp); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>})</code> </pre> <br><p>    ,  â€“    â€“     (   <code>kUP</code>    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">commpage</a> ), , ,       [spinlock].            ,                . </p><br><p>  Darling          :    Mach-O-   ELF-  Linux,    [host,    ,      Darling] â€“ ,   <code>libX11</code>  <code>libcairo</code> . </p><br><p>     ELF- â€“  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>libelfloader</code></a> ,     ELF,        ,   ld-linux,  dyld  Linux,    ld-linux      ELF-.    <code>libelfloader</code>  Mach-O     <code>/usr/lib/darling/libelfloader.dylib</code>   Darwin-chroot-;  ,       Darwin-. </p><br><p>     ,  <code>libelfloader</code>  <em></em>     Mach-O  ELF.    ( <code>_elfcalls</code> ),  <a href=""> </a> <code>libSystem</code> ,  Darwin      ,        ELF-  Linux. Â«Â» Darwin  Linux         â€“   ,      C ( <code>libSystem_c</code>  <code>glibc</code> , ). </p><br><p>     ELF-   Darwin,   - <code>libelfloader</code> API  <code>_elfcalls-&gt;dlsym_fatal(_elfcalls-&gt;dlopen_fatal("libX11.so"), "XOpenDisplay")</code> . ,       <a href="">wrapgen</a> ,   ELF-    ,       ,   The Cocotron â€“          Linux â€“   .   wrapgen  ELF- (, <code>libX11.so</code> ),           : </p><br><pre> <code class="hljs delphi">#include &lt;elfcalls.h&gt; extern struct elf_calls* _elfcalls; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void* lib_handle; __attribute__((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ lib_handle = _elfcalls-&gt;dlopen_fatal("libX11.so"); }</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">destructor</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ _elfcalls-&gt;dlclose_fatal(lib_handle); }</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XOpenDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ __asm__(".symbol_resolver _XOpenDisplay"); return _elfcalls-&gt;dlsym_fatal(lib_handle, "XOpenDisplay"); }</span></span></span></span></code> </pre> <br><p>       Mach-O-     <code>/usr/lib/native/libX11.dylib</code> ,   Mach-O-     ,     <em></em> <code>libX11.so</code> ,    Mach-O.  ,    CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>wrap_elf</code></a> ,    wrapgen,  Mach-O-     <code>/usr/lib/native</code> :   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>wrap_elf(X11 libX11.so)</code>      <code>libX11</code> ,         Mach-O-. </p><br><p>       Linux        <em></em> .    ,   Darling   ,      Darwin    Linux,     .  Darling â€“     Darwin ( ,  Darwin); , , ,           Darwin,   <code>libSystem</code> , dyld, XNU  launchd,        ,     ,   commpage.       ,   <code>libsystem_kernel</code> ,    ,         Linux,   Â«Â»   Darwin- â€“ Linux  GNU/Linux   .          Linux-    ,   Linux   (  X server)      ,     [witnessing a magic trick] â€“     <code>libelfloader</code> ,    wrapgen, ,  .   ,    ,   , ,  ,   . </p><br><h2 id="poryadok-simvolov">   </h2><br><p>   -   ,      Mach-O-,    ld      . ( ,     â€“ <em></em> ,  Apple,  ,  .) </p><br><p>   ,   ,     ,      ,  <em> </em> [order file],     ld   : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -order_file foo.order</code> </pre> <br><p>     <code>-reexported_symbols_list</code> ,     , <code>-order_file</code>  ,    : </p><br><pre> <code class="hljs 1c">symbol1 symbol2 <span class="hljs-meta"><span class="hljs-meta">#  . # #    ,     , # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   (   C)  #        . foo.o: _static_function3 #  ,   ,     #     ;    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       #  lipo,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  # . i386:symbol4</span></span></code> </pre> <br><p>   ( ,    ,  )         Â«Â»        .         ,       ,    ,        ,       <code>.subsections_via_symbols</code> ,    Mach-O-   ,     , ,   ,   . </p><br><p>   ,   Apple    â€“     <code>libdispatch</code> . <code>libdispatch</code>     , Â«OS objectÂ»,     ,       .          Objective-C,  <code>libdispatch</code>   <em> </em> (    Core Foundation),     <code>libdispatch</code> -  Objective-C-    ,     Objective-C-.  ,      <code>dispatch_data_t</code>  <code>NSData *</code>      API  Cocoa (    ). </p><br><p>   <a href=""></a>     ,    ,   Objective-C-   <em>OS object vtables</em>     .   ,    <a href=""><code>DISPATCH_OBJECT_TFB</code></a> , ,   Objective-C     <code>libdispatch</code> -,    <code>isa</code>  <code>vtable</code> - <code>dispatch_object</code>  <code>object</code> : </p><br><pre> <code class="hljs tex">#define DISPATCH_OBJECT_TFB(f, o, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (slowpath((uintptr_t)((o)._os_obj-&gt;os_obj_isa) &amp; 1) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &lt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(dispatch_object)) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &gt;= <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(object))) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return f((o), ##__VA_ARGS__); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>}</code> </pre> <br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> ,   ,     <code>libdispatch</code> . </p><br><h2 id="podmena-simvolov">   </h2><br><p>       (   ) â€“    <code>DYLD_INSERT_LIBRARIES</code> ,  dyld     Mach-O-          . ,         ,    ,          <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  ,      ,    <em></em> -  .     (   ),     <code>dlsym()</code>   <code>RTLD_NEXT</code> ,  : </p><br><pre> <code class="hljs lua">int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, int flags, mode_t mode) { printf(<span class="hljs-string"><span class="hljs-string">" open(%s)\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>); // <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"foo"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">"bar"</span></span>; } int (*original_open)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, int, mode_t); original_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> original_open(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, flags, mode); }</code> </pre> <br><p>    , dyld     ,  <em>dyld-</em> [dyld iterposing].      Mach-O-   <code>__interpose</code> , dyld      ,    â€“    . </p><br><p>   ,       â€“ ,        <code>__interpose</code> â€“    <em> </em> [implicit interposing].   ,  <code>__interpose</code>       (     ),  dyld      .  , dyld- <em></em>       ,      - .  , dyld  ,      -    ,     - (   Mach-O-): </p><br><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">int</span></span> my_open(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, mode_t mode) { printf("Called open(%s)\n", <span class="hljs-type"><span class="hljs-type">path</span></span>); // "  " <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-type"><span class="hljs-type">path</span></span>, "foo") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">path</span></span> = "bar"; } //    ,    //  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>()      my_open(). <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, flags, mode); } //      __interpose __attribute__ ((section ("__DATA,__interpose"))) static struct { <span class="hljs-type"><span class="hljs-type">void</span></span> *replacement, *replacee; } replace_pair = { my_open, <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> };</code> </pre> <br><p>  ,      â€“          â€“       Mach-O-  -        [relocation table].        ,   dyld      (    ),     . </p><br><p> ,      <code>dyld_dynamic_interpose</code> ,       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *replacement, *replacee; } replacement_tuple; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mach_header</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dso_handle</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dyld_dynamic_interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct mach_header*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> replacement_tuple replacements[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ replacement_tuple replace_pair = { my_open, open }; dyld_dynamic_interpose(&amp;__dso_handle, &amp;replace_pair, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> ,     ,         ,     . </p><br><p> <code>DYLD_INSERT_LIBRARIES</code>  dyld-         Objective-C,   C,  - ,       Objective-C- ( <code>IMP</code> ),    Objective-C       ,   <em>method swizzling</em> ( <em>isa swizzling</em> ). </p><br><p>      Darling     xtrace,       . </p><br><p>   Darwin    Darwin (    â€“   BSD    Mach- [Mach traps]).        <code>libsystem_kernel</code> ,   ABI     userspace.  Darling,    <code>libsystem_kernel</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>    Darwin     Linux    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Darling-Mach</a> ,    Linux,  Mach   . </p><br><p> strace,       Linux,    ,  Linux-;  strace    Darwin,   Darling,     Linux,       Darwin (    Linux,    ELF- ).   ,    Darwin  Linux      ,   ,    Darwin   â€“  ,       â€“   . </p><br><p>        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">xtrace</a> .    strace,           ,   <code>ptrace()</code> API, xtrace          .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>DYLD_INSERT_LIBRARIES=/usr/lib/darling/libxtrace.dylib</code> ,   - [trampoline functions]       ,        .  xtrace   ,  strace,       ,       ,   : </p><br><pre> <code class="bash hljs">Darling [~]$ xtrace arch &lt;......&gt; [223] mach_timebase_info_trap (...) [223] mach_timebase_info_trap () -&gt; KERN_SUCCESS [223] issetugid (...) [223] issetugid () -&gt; 0 [223] host_self_trap () [223] host_self_trap () -&gt; port right 2563 [223] mach_msg_trap (...) [223] mach_msg_trap () -&gt; KERN_SUCCESS [223] _kernelrpc_mach_port_deallocate_trap (task=2563, name=-6) [223] _kernelrpc_mach_port_deallocate_trap () -&gt; KERN_SUCCESS [223] ioctl (...) [223] ioctl () -&gt; 0 [223] fstat64 (...) [223] fstat64 () -&gt; 0 [223] ioctl (...) [223] ioctl () -&gt; 0 [223] write_nocancel (...) i386 [223] write_nocancel () -&gt; 5 [223] <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (...)</code> </pre> <br><p>    ,       BSD  Mach.   ,   <code>write()</code>  <code>exit()</code> ,     Linux-,       . ,  Mach-   <code>ioctl</code> -   <code>/dev/mach</code> ,     ;   BSD- <code>ioctl()</code> ,   stdio   ,      stdin  stdout (    tty) <a href=""></a>     <code>readlink()</code>    <code>/proc/self/fd/</code> . </p><br><hr><br><p>          Mach-O,        ,     dyld.      : </p><br><ul><li>    ,       ,     dylib,  ,  <em> </em>  . ld       <code>-bundle_loader</code> . </li><li>   ,  <code>LC_LOAD_DYLIB</code> , <code>LC_REEXPORT_DYLIB</code>  <code>LC_DYLIB_ID</code>    ,   <em></em>  <em></em>  [compatibility version, current version] ,    â€“    ,    .              ld <code>-current_version</code>  <code>-compatibility_version</code> , .     dyld ,       ,    ,     . </li><li>      ,  Mach-O     <em>  </em> [source version].     , <code>LC_SOURCE_VERSION</code> .        ld <code>-source_version</code> ,    ,       Mach-O- â€“    <code>-add_source_version</code>  <code>-no_source_version</code> . </li><li>    <code>Info.plist</code>   <code>__info_plist</code> Mach-O-    [codesign] ,           <code>Info.plist</code> .    <a href="">ad-hoc </a>  Security.framework,  ,      <code>CFBundle</code> / <code>NSBundle</code> API,       ,     ,  . </li></ul><br><p> ,  ,       , ld  dyld    ,    Â« Â»,   <code>libSystem</code> ,  -.            <code>/usr/lib/</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417507/">https://habr.com/ru/post/zh-CN417507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417495/index.html">åœ¨è‹±ç‰¹å°”çš„InnovateFPGAç«èµ›æ¬§æ´²å†³èµ›ä¸­ï¼Œä¿„ç½—æ–¯å’Œä¹Œå…‹å…°å›¢é˜Ÿæˆ˜èƒœäº†æ¬§æ´²äºº</a></li>
<li><a href="../zh-CN417497/index.html">Schibsted Media Groupçš„æ•°æ®ç§‘å­¦ä¸“ä¸š4å¹´</a></li>
<li><a href="../zh-CN417501/index.html">Lifehacksåˆ¶é€ ä¸¤å±‚æ¿ï¼ˆLUTï¼‰</a></li>
<li><a href="../zh-CN417503/index.html">Webå¼€å‘äººå‘˜å¿…é¡»è®°ä½è¦åšSEO-Feng Shui</a></li>
<li><a href="../zh-CN417505/index.html">è‹±ç‰¹å°”å‘å¸ƒæ–°çš„MEå›ºä»¶æ¼æ´è¡¥ä¸</a></li>
<li><a href="../zh-CN417509/index.html">KubernetesæŠ€å·§ä¸çªé—¨ï¼šåŠ é€Ÿå¤§å‹æ•°æ®åº“çš„å¼•å¯¼</a></li>
<li><a href="../zh-CN417511/index.html">è‹±ç‰¹å°”æ”¶è´­eASIC-ç»“æ„åŒ–ASICå¼€å‘äººå‘˜</a></li>
<li><a href="../zh-CN417513/index.html">Pythonå’ŒJavaScriptä¸­çš„ç±»ä¼¼ç‰©ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN417515/index.html">æˆ‘åœ¨5å¹´å†…åˆ›é€ äº†100æ¬¾æ¸¸æˆæ‰€å­¦åˆ°çš„ä¸œè¥¿</a></li>
<li><a href="../zh-CN417517/index.html">è‹±ç‰¹å°”å†å²é¡µé¢ã€‚ ç…§ç‰‡çºªäº‹å’Œæµ‹éªŒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>