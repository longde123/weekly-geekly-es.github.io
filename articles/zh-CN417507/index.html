<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍙 ➕ 🧚 链接和下载Mach-O文件的技巧 ⚙️ 👩🏽‍🎓 🍊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我向您介绍Darling Project博客中我文章的翻译。 对所用概念的帮助不大：Darwin-一种基于macOS，iOS和Apple的其他操作系统的开源操作系统； Mach-O是达尔文使用的可执行文件和库的二进制格式； dyld-达尔文用于下载Mach-O文件的动态引导程序； dylib是一个可...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>链接和下载Mach-O文件的技巧</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417507/"><p> <em>我向您介绍Darling Project博客中我文章的翻译。</em>  <em>对所用概念的帮助不大：Darwin-一种基于macOS，iOS和Apple的其他操作系统的开源操作系统；</em>  <em>Mach-O是达尔文使用的可执行文件和库的二进制格式；</em>  <em>dyld-达尔文用于下载Mach-O文件的动态引导程序；</em>  <em>dylib是一个可动态加载的库（通常具有扩展名<code>.dylib</code> ）。</em> </p><br><p><img src="https://habrastorage.org/webt/q4/to/tb/q4totbx7ltcbh_gj58-qnayiffg.png" alt="图片引起关注"></p><br><p>  Darling Project的目标是使macOS应用程序能够在Linux上运行，并且能够以Mach-O格式下载二进制文件的能力是实现该目标的关键步骤之一。 </p><br><p> 最初，Darling围绕其自身的Mach-O加载器实现以及在高级Darwin API与Linux对应对象之间广播调用的想法而构建。 从那时起，我们的重点已转移到在越来越孤立的Darwin容器中运行代码。 自从我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">改用Darling的内部组件使用Mach-O</a>以来，我们已经能够使用Apple的原始模型，并构建了许多其他开源的Darwin组件。 我们仍然需要一个简单的Mach-O引导程序来引导dyld本身。 </p><a name="habracut"></a><br><p>  Mach-O和Mach本身可能是达尔文最著名的标志，Apple提供的各种库和框架广泛使用了Mach-O格式的许多晦涩功能。 这使得与Mach-O一起工作成为开发Darling时最重要和值得注意的任务之一。 从实施本地Mach-O加载程序到组装达尔文组件（首先以特殊的ELF文件的形式，现在以真正的Mach-O的形式）-我们需要比普通人更深入地了解Mach-O的内部结构。达尔文平台的开发人员。 </p><br><p> 我们完成了本介绍，然后继续讨论Mach-O格式可以为我们提供的一些技巧。 </p><br><h2 id="ustanovochnye-imena"> 安装名称 </h2><br><p> 在Windows和Linux上，动态库由它们的名称（例如<code>libc.so</code> ）引用，此后，动态链接程序的任务是在标准库目录之一中查找具有匹配名称的库。 达尔文立即改为使用库文件的（几乎）完整路径，该路径称为该库的安装名称。 大概是这样做是为了防止<em>dylib</em> [dylib劫持]的<em>替代</em> -一种攻击，其中将伪造的dylib放置在目录中，动态链接程序将在比实际真实目录早的位置找到它，从而允许伪造的dylib代表程序执行任意代码，因此确信了这一点。 dylib下载。 </p><br><p> 不仅可执行文件和库存储了其依赖项的完整安装名，而且Mach-O依赖项本身也“知道”了自己的安装名。 实际上，链接器就是通过这种方式来了解要用于依赖项的安装名称：它从依赖项本身中读取它们。 </p><br><p> 链接dylib时，可以使用选项ld <code>-install_name</code>或<code>-dylib_install_name</code>来指定其安装名称： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -install_name /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libfoo.dylib</code> </pre> <br><p> 现在，当您将另一个Mach-O文件（例如<code>libbar.dylib</code> ）链接到<code>libfoo.dylib</code> ，ld将在<code>libbar</code>依赖项<code>libbar</code>写入libfoo安装名称- <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> <code>/usr/local/lib/libfoo.dylib</code> <code>libbar</code> ，这就是dyld所在的位置。会在运行时查找<code>libfoo</code> 。 </p><br><p> 对于系统库而言，使用完整路径已经足够好了，事实上，这些系统库已安装在文件系统中以前已知的位置。 但是使用库作为应用程序捆绑包的一部分时，就会出现问题。 尽管每个应用程序都可以假定将其安装在<code>/Applications/AppName.app</code> ，但是一般来说，这意味着应用程序程序集是可移植的，并且可以在文件系统中自由移动，因此此类程序集中的特定库路径无法提前知道。 </p><br><p> 为了解决此问题，达尔文允许安装名称以<code>@executable_path</code> ， <code>@loader_path</code>或<code>@rpath</code> -不是绝对的，而是指示相对于主要可执行文件路径，“加载”路径（可执行文件或库，分别直接取决于此库）或相对于主要可执行文件定义的路径列表。  <code>@executable_path</code>和<code>@loader_path</code>工作没有其他复杂性，但是如果至少一个依赖项（或它们的传递性依赖项）具有使用<code>@rpath</code>的设置名称， <code>@rpath</code>在使用ld <code>-rpath</code>选项链接可执行文件时，必须显式设置<code>@rpath</code> 。倍您需要多少： </p><br><pre> <code class="bash hljs">$ ld -o runme -rpath @executable_path/../Frameworks -rpath @executable_path/../bin/lib</code> </pre> <br><p>  （rpath概念在某种程度上破坏了众所周知的库路径的原始概念，并<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">打开了</a> dylib欺骗攻击<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的</a>可能性。我们可以假设这会使与安装名称相关的所有事情都变得毫无用处。） </p><br><h2 id="ciklicheskie-zavisimosti"> 循环依赖 </h2><br><p> 当一个项目的源代码占用多个文件时，如果这些文件相互依赖是完全正常的。 只要将所有这些文件编译为单个二进制文件（可执行文件或库），此方法就可以正常工作。 当几个动态库相互依赖时，不起作用。 </p><br><p> 您可能会争辩说，与其重新使用动态库之间的循环依赖关系，不如重新设计项目体系结构，这一点我同意。 但是，如果有苹果公司的典型代表，那就是他们永远不会停止思考并正确地做事。 取而代之的是，他们把拐杖和把戏摆在彼此之上。 在这种情况下，对于Darling，我们需要使循环依赖项起作用，因为各种libSystem <code>libSystem</code> （例如<code>libsystem_dyld</code> ， <code>libsystem_kernel</code>和<code>libsystem_pthread</code> ）都相互依赖。  （直到最近，由于在Cocotron中实现了Core OpenGL的方式，我们还不得不循环链接诸如AppKit，Core Graphics和Core OpenGL之类的Cocoa框架，但是我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">重新设计了</a> Core OpenGL的实现架构，并且能够摆脱这种循环依赖项。） </p><br><p> 原则上，循环依赖项应该可以正常工作：动态链接器已经知道如何仅加载一次每个库，因此无限递归不会有问题。 问题是不能简单地<em>链接</em>这样的库，因为每个链接程序调用仅创建一个库，并且在链接任何二进制文件时，必须将已链接的所有依赖项都转移到链接器。 我们必须首先链接我们的一个库，目前其他库还没有准备好，因此我们将无法将它们传输到链接器。 </p><br><p> 这里的技巧是将这些库的某些（或为简单起见，全部）链接<em>两次</em> 。 第一次，告诉链接程序忽略缺少的依赖关系，实际上，不要传递依赖关系： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -flat_namespace -undefined suppress $ ld -o libbar.dylib bar.o -flat_namespace -undefined suppress</code> </pre> <br><p>  （有关<code>-flat_namespace</code>请参见下文。） </p><br><p> 当然，如果尝试直接使用生成的dylib，则会在运行时出现动态链接错误。 相反，请再次链接这些库，并将生成的dylib作为依赖项传递： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o libfoo.dylib</code> </pre> <br><p> 这次，链接器会看到所有字符，因此我们不会告诉他忽略错误（如果确实丢失了某些字符，则会出现错误）。 </p><br><p> 尽管某些（如果不是全部）库链接到其依赖项的“错误”副本，则dyld将在运行时看到正确的版本。 为此，请确保每个库的两个副本都具有相同的安装名称。 </p><br><p> 这里的另一个细节是初始化顺序。 任何代码都可以使用<code>__attribute__((constructor))</code>编译器magic命令声明初始化程序函数（此类初始化程序的列表位于Mach-O文件的<code>__mod_init_func</code>节中）。 当在调用<code>main()</code>之前加载它们所在的二进制文件时，dyld会调用这些函数。 通常，每个库的初始化器在其依赖项的初始化器之后执行，因此每个初始化器都可以期望依赖项库已被初始化并可以使用。 当然，对于循环依赖性不能保证。  dyld将以<em>某种</em>顺序执行其初始化程序。 您可以将依赖性标记为向上依赖性以自定义此顺序。  dyld将最后初始化某人已将其标记为依赖项的库。 因此，要使<code>libfoo</code>在<code>libbar</code>之后初始化，请像这样链接它们： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o -upward_library libfoo.dylib</code> </pre> <br><p> 为了使一切更方便，我们有一个名为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>add_circular</code></a>的Darling CMake函数，它可以解决所有困难，并允许您像这样简单且声明性地使用它： </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(DYLIB_INSTALL_NAME <span class="hljs-string"><span class="hljs-string">"/usr/lib/system/libdispatch.dylib"</span></span>) add_circular(libdispatch_shared FAT SOURCES <span class="hljs-variable"><span class="hljs-variable">${dispatch_SRCS}</span></span> SIBLINGS system_c system_kernel system_malloc system_blocks system_pthread system_dyld system_duct unwind platform compiler_rt UPWARD objc )</code> </pre> <br><h2 id="dvuhurovnevoe-prostranstvo-imyon-simvolov"> 两级字符名称空间 </h2><br><p>  Mach-O中的符号表不仅存储符号名称，它们还“记住”从哪个库（或可执行文件）中提取符号。 换句话说，符号名称存在于由二进制定义它们的名称空间中。 因此，“二级命名空间”（另一级表示符号名称本身）。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">引入</a>了两级名称空间，以防止符号名称冲突。 通常，如果多个库用相同的名称定义字符，则在链接期间会出现错误； 但是，如果您在运行时加载库（例如插件），或者在链接时和运行时库的版本不同时，这可能不起作用。 对于使用两级名称空间的库而言，这不是问题-它允许多个库以相同的名称定义字符而不会产生冲突。 </p><br><p> 可以通过恢复使用“平面名称空间”来关闭两级名称空间（原因之一是，使用两级名称空间意味着在链接期间必须允许每个字符，因此<code>-undefined_suppress</code>需要平面名称空间，例如我们在上面看到）。  Ld具有两个标志，这些标志使您可以在链接期间禁用两级名称空间： <code>-flat_namespace</code>仅影响一个Mach-O文件； <code>-force_flat_namespace</code>仅适用于可执行文件，而不是库，并强制整个过程使用flat命名空间。 另外，您可以通过设置环境变量<code>DYLD_FORCE_FLAT_NAMESPACE</code>来强制dyld在运行时使用平面名称空间。 </p><br><p> 使用两层名称空间的一个功能是，您始终必须将每个Mach-O显式链接到它所依赖的所有库和框架。 例如，如果链接到AppKit，则不能仅使用Foundation。 您必须明确链接到她。 另一个功能是，作为库或框架的作者，您不能像习惯那样随意地沿依赖关系链自由移动符号“ down”的实现（例如，不能将代码从AppKit移至Foundation）。 为此，Mach-O，ld和dyld具有几个附加功能，即<em>子库</em> ， <em>字符的</em> <em>重新导出</em>和<em>元字符</em> 。 </p><br><h2 id="podbiblioteki"> 子库 </h2><br><p> 子库-允许一个库（称为<em>立面</em>库[umbrella库]或伞形库[umbrella库]）将其部分功能的实现委派给另一个库（称为子库[sub-library]）的机制； 或者，如果您从另一侧看，则允许该库公开重新导出另一个库提供的符号。 </p><br><p> 再次使用它的主要地方是<code>libSystem</code>及其在<code>/usr/lib/system</code>子库； 但是它可以与任何一对库一起使用： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -lobjc -sub_library libobjc <span class="hljs-comment"><span class="hljs-comment"># : $ ld -o libfoo.dylib foo.o -reexport-lobjc</span></span></code> </pre> <br><p> 与仅链接到该库相比，影响此操作的唯一因素是将<code>LC_REEXPORT_DYLIB</code>命令写入到生成的文件中，而不是通常的<code>LC_LOAD_DYLIB</code> （包括链接期间来自子库的符号<em>不会</em>复制到伞状库，因此它甚至不必如果以后将新字符添加到子库，请链接）。 在运行时， <code>LC_REEXPORT_DYLIB</code>工作<code>LC_REEXPORT_DYLIB</code>也类似于<code>LC_LOAD_DYLIB</code> ：dyld将加载子库并使其余字符可用（但与<code>LC_LOAD_DYLIB</code>不同，就两级命名空间而言，字符将来自伞形库）。 </p><br><p>  <code>LC_REEXPORT_DYLIB</code>真正区别在于，当您将<em>另一个</em>库链接到<code>libfoo</code>时ld会做什么：ld不仅会在传递给它的所有对象和dylib文件中查找符号，还会打开并查看重新导出的子库（在此示例中） <code>libobjc</code>示例）。 </p><br><p> 他怎么知道在哪里找她？ 保存在<code>libfoo.dylib</code>的唯一东西是安装名称<code>libobjc.dylib</code> ，因此ld希望找到它。 这意味着必须将该库安装到位，然后才能用作其他任何子库。 这对于像<code>libobjc</code>这样的系统库来说效果<code>libobjc</code> ，但是如果您尝试重新导出自己的子库，可能会非常不便或完全不可能。 </p><br><p> 为了解决此问题，ld提供了<code>-dylib_file</code>选项，该选项允许您指定在链接期间要使用的其他dylib路径： </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -reexport_library /path/to/libsubfoo.dylib $ ld -o libbar.dylib bar.o libfoo.dylib -dylib_file @executable_path/lib/foo/libsubfoo.dylib:/path/to/libsubfoo.dylib</code> </pre> <br><p> 尽管<code>libSystem</code>和其他一些系统库重新导出了它们的子库， <code>-dylib_file</code>当链接macOS上的每个可执行文件时，您不必使用<code>-dylib_file</code> 。 这是因为已经根据系统库的安装名称安装了系统库。 但是，在Linux上构建Darling时，我们必须向每个ld调用传递一些<code>-dylib_file</code>选项（以及其他公共参数）。 我们通过使用<code>add_darling_library</code> ， <code>add_darling_executable</code>以及其他<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">函数时</a>会自动应用的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">特殊功能</a>来执行此操作。 </p><br><h2 id="pereeksportirovanie-simvolov"> 重新导出字符 </h2><br><p> 有时一个库可能需要从另一个库中重新导出某些字符，但不是一次全部导出。 例如，Core Foundation正在<code>NSObject</code> ，出于兼容性的考虑， <code>NSObject</code>在最新版本中是在Objective-C运行时内部实现的。 </p><br><p>  （如果您对为什么<code>NSObject</code>曾经在Core Foundation中而不是在Foundation中感兴趣，那是因为<em>免费转换</em> [免费电话桥接，直接在对应的Core Foundation和Foundation类型之间进行<em>转换</em>的能力， [额外的转换]，要求在Core Foundation中实现Core Foundation上类型的私有包装类（例如<code>__NSCFString</code> ）；作为Objective-C对象，它们必须从<code>NSObject</code>继承。到另一个，将<code>NSObject</code>及其所有继承人留在Foundation和循环中  esky将Core Foundation和Foundation链接在一起，但是Apple决定将这些帮助程序私有类与<code>NSObject</code>一起迁移到Core Foundation，在Darling中，我们以相同的方式维护兼容性。） </p><br><p> 您可以使用ld的<code>-reexported_symbols_list</code>选项传递要<code>-reexported_symbols_list</code>的字符列表： </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> .objc_class_name_NSObject &gt; reexport_list.exp $ ld -o CoreFoundation CFFiles.o -lobjc -reexported_symbols_list reexport_list.exp</code> </pre> <br><p> 尽管重新导出<em>某些</em>符号听起来与重新导出<em>所有</em>符号非常相似，但是实现此符号的机制与子库的工作方式非常不同。 不使用特殊的<code>LC_*_DYLIB</code>命令； 而是在名称表中插入一个特殊的<em>间接符号</em> （由<code>N_INDIR</code>标志指示），其行为类似于该库中定义的符号。 如果库本身使用此符号，则该符号的<em>第二个</em> “不确定”副本将<em>出现</em>在名称表中（因为它发生时没有任何重新导出）。 </p><br><p> 使用字符的显式重新导出时要记住的一件重要的小事情是，您很可能需要针对不同的体系结构重新导出具有不同名称的字符。 确实，Objective-C的[名称处理约定]命名约定和i386和x86-64的Objective-C二进制接口[ABI]是不同的，因此在i386上，您只需要<code>.objc_class_name_NSObject</code> ，在x86-64上- <code>_OBJC_CLASS_$_NSObject</code> ， <code>_OBJC_IVAR_$_NSObject.isa</code>和<code>_OBJC_METACLASS_$_NSObject</code> 。 使用子库时无需考虑，因为每种架构的所有自动可用符号都会自动重新导出。 </p><br><p> 大多数用于Mach-O的工具都透明地处理“厚”或通用二进制文件（Mach-O文件包含用于多个体系结构的多个sub-Mach-O）。  Clang可以编译具有所有请求的体系结构的通用二进制文件，dyld从dylib选择要加载的体系结构，查看可执行文件支持的体系结构，并且ld，otool和nm之类的工具与对应于计算机体系结构的体系结构一起工作（即（x86-64），除非您明确要求使用特殊标志的其他体系结构。 ,  -   ,     –  ,         ,      . </p><br><p>         .  ld          ,  ,     dylib-           lipo: </p><br><pre> <code class="bash hljs">$ ld -o CF_i386.dylib CFFiles.o -arch i386 -lobjc -reexported_symbols_list reexport_i386.exp $ ld -o CF_x86-64.dylib CFFiles.o -arch x86_64 -lobjc -reexported_symbols_list reexport_x86_64.exp $ lipo -arch i386 CF_i386.dylib -arch x86_64 CF_x86-64.dylib -create -output CoreFoundation</code> </pre> <br><p>  Darling   CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>add_separated_framework</code></a> ,        lipo,    CMake-   Core Foundation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> : </p><br><pre> <code class="cmake hljs">add_separated_framework(CoreFoundation CURRENT_VERSION SOURCES <span class="hljs-variable"><span class="hljs-variable">${cf_sources}</span></span> VERSION <span class="hljs-string"><span class="hljs-string">"A"</span></span> DEPENDENCIES objc system icucore LINK_FLAGS <span class="hljs-comment"><span class="hljs-comment"># ...    ) set_property(TARGET CoreFoundation_i386 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_i386.exp") set_property(TARGET CoreFoundation_x86_64 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_x86_64.exp")</span></span></code> </pre> <br><h2 id="meta-simvoly"> - </h2><br><p> - –   , ,   Apple     ,    . </p><br><p>   Mach-O-       macOS,   ,     <code>-mmacosx-version-min=10.x</code> (    iOS, tvOS, watchOS    ,  Apple      ).     ;   ,         <code>AVAILABLE_MAC_OS_X_VERSION_10_13_AND_LATER</code>      C++  <code>libstdc++</code> (  GNU)  <code>libc++</code> (  LLVM).      ,        Mach-O.  ,   ld   <code>-macosx_version_min</code> (        <code>m</code> ),     Mach-O- <code>LC_VERSION_MIN_MACOSX</code> ( dyld,    ,        ). </p><br><p>    ,  ld  <code>-macosx_version_min</code>   ,  - <em></em> Mach-O- . - –  ,     <code>$ld$</code> ,  ld,    ,    :     ,   .      <code>$ld$$$</code> .  <code></code>   <code>os10.5</code>  ,       - –  ,        <em></em>   Mach-O-   <em></em> ,   ; <code></code>   <code>add</code> , <code>hide</code> , <code>install_name</code>  <code>compatibility_version</code> ,   ld ,          <code></code> ,  <code></code>          ( )  , . </p><br><p>  <code></code>     , ,  ,             ; ,   -,   <code>libobjc</code> ,   <code>NSObject</code>  ,      macOS: </p><br><pre> <code class="hljs perl">$ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_METACLASS_$_NSObject</code> </pre> <br><p>           ,   ,   ,          ,   <em></em>   . </p><br><h2 id="rezolvery-simvolov">   </h2><br><p>      dyld –   <em> </em> [symbol resolvers],     .    ,  ,          ,  dyld     ,     . </p><br><p>         ld,     .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>.symbol_resolver</code> : </p><br><pre> <code class="hljs mel">;    foo _foo1: movl <span class="hljs-number"><span class="hljs-number">1</span></span>, %eax ret _foo2: movl <span class="hljs-number"><span class="hljs-number">2</span></span>, %eax ret .symbol_resolver _foo ;  -  call _condition jz .ret_foo2 movq _foo1, %rax ret .ret_foo2: movq _foo2, %rax ret ;   ,   _foo  ;   ,     , ;     . .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _foo _foo:</code> </pre> <br><p>    C          ,    ,     C: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         return 0; } static void *foo_resolver() { __asm__(".symbol_resolver _foo"); return condition() ? &amp;foo1 : &amp;foo2; }</span></span></code> </pre> <br><p> (     <code>_foo</code>   <code>foo</code> ,    Darwin        C,          .  ,      Mach-O    Darling,            ELF-,     .) </p><br><p>   <code>_foo</code>     ,          (           ),  <code>foo()</code>  <code>foo_resolver()</code>     ,  : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __asm__(<span class="hljs-string"><span class="hljs-string">".symbol_resolver _foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> condition() ? &amp;foo1 : &amp;foo2; }</code> </pre> <br><p>   ,    –     - ,   <code>foo()</code>   ,      (      <code>int</code> -).  ,  ,       :  <code>dlsym("_foo")</code>    <code>_foo</code> –  ,      ,       , –         . ,       ,    ,      <code>foo()</code>    <code>_foo</code> . </p><br><p>         .  Apple    <code>libplatform</code>                     : </p><br><pre> <code class="hljs tex">#define _OS_VARIANT_RESOLVER(s, v, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__attribute__((visibility(OS_STRINGIFY(v)))) extern void* s(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>void* s(void) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__asm__(".symbol_resolver _" OS_STRINGIFY(s)); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__VA_ARGS__ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} #define _OS_VARIANT_UPMP_RESOLVER(s, v) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>_OS_VARIANT_RESOLVER(s, v, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>uint32_t *_c = (void*)(uintptr_t)_COMM_PAGE_CPU_CAPABILITIES; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (*_c &amp; kUP) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, up)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, up); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} else { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, mp)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, mp); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>})</code> </pre> <br><p>    ,  –    –     (   <code>kUP</code>    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">commpage</a> ), , ,       [spinlock].            ,                . </p><br><p>  Darling          :    Mach-O-   ELF-  Linux,    [host,    ,      Darling] – ,   <code>libX11</code>  <code>libcairo</code> . </p><br><p>     ELF- –  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>libelfloader</code></a> ,     ELF,        ,   ld-linux,  dyld  Linux,    ld-linux      ELF-.    <code>libelfloader</code>  Mach-O     <code>/usr/lib/darling/libelfloader.dylib</code>   Darwin-chroot-;  ,       Darwin-. </p><br><p>     ,  <code>libelfloader</code>  <em></em>     Mach-O  ELF.    ( <code>_elfcalls</code> ),  <a href=""> </a> <code>libSystem</code> ,  Darwin      ,        ELF-  Linux. «» Darwin  Linux         –   ,      C ( <code>libSystem_c</code>  <code>glibc</code> , ). </p><br><p>     ELF-   Darwin,   - <code>libelfloader</code> API  <code>_elfcalls-&gt;dlsym_fatal(_elfcalls-&gt;dlopen_fatal("libX11.so"), "XOpenDisplay")</code> . ,       <a href="">wrapgen</a> ,   ELF-    ,       ,   The Cocotron –          Linux –   .   wrapgen  ELF- (, <code>libX11.so</code> ),           : </p><br><pre> <code class="hljs delphi">#include &lt;elfcalls.h&gt; extern struct elf_calls* _elfcalls; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void* lib_handle; __attribute__((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ lib_handle = _elfcalls-&gt;dlopen_fatal("libX11.so"); }</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">destructor</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ _elfcalls-&gt;dlclose_fatal(lib_handle); }</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XOpenDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ __asm__(".symbol_resolver _XOpenDisplay"); return _elfcalls-&gt;dlsym_fatal(lib_handle, "XOpenDisplay"); }</span></span></span></span></code> </pre> <br><p>       Mach-O-     <code>/usr/lib/native/libX11.dylib</code> ,   Mach-O-     ,     <em></em> <code>libX11.so</code> ,    Mach-O.  ,    CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>wrap_elf</code></a> ,    wrapgen,  Mach-O-     <code>/usr/lib/native</code> :   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>wrap_elf(X11 libX11.so)</code>      <code>libX11</code> ,         Mach-O-. </p><br><p>       Linux        <em></em> .    ,   Darling   ,      Darwin    Linux,     .  Darling –     Darwin ( ,  Darwin); , , ,           Darwin,   <code>libSystem</code> , dyld, XNU  launchd,        ,     ,   commpage.       ,   <code>libsystem_kernel</code> ,    ,         Linux,   «»   Darwin- – Linux  GNU/Linux   .          Linux-    ,   Linux   (  X server)      ,     [witnessing a magic trick] –     <code>libelfloader</code> ,    wrapgen, ,  .   ,    ,   , ,  ,   . </p><br><h2 id="poryadok-simvolov">   </h2><br><p>   -   ,      Mach-O-,    ld      . ( ,     – <em></em> ,  Apple,  ,  .) </p><br><p>   ,   ,     ,      ,  <em> </em> [order file],     ld   : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -order_file foo.order</code> </pre> <br><p>     <code>-reexported_symbols_list</code> ,     , <code>-order_file</code>  ,    : </p><br><pre> <code class="hljs 1c">symbol1 symbol2 <span class="hljs-meta"><span class="hljs-meta">#  . # #    ,     , # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   (   C)  #        . foo.o: _static_function3 #  ,   ,     #     ;    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       #  lipo,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  # . i386:symbol4</span></span></code> </pre> <br><p>   ( ,    ,  )         «»        .         ,       ,    ,        ,       <code>.subsections_via_symbols</code> ,    Mach-O-   ,     , ,   ,   . </p><br><p>   ,   Apple    –     <code>libdispatch</code> . <code>libdispatch</code>     , «OS object»,     ,       .          Objective-C,  <code>libdispatch</code>   <em> </em> (    Core Foundation),     <code>libdispatch</code> -  Objective-C-    ,     Objective-C-.  ,      <code>dispatch_data_t</code>  <code>NSData *</code>      API  Cocoa (    ). </p><br><p>   <a href=""></a>     ,    ,   Objective-C-   <em>OS object vtables</em>     .   ,    <a href=""><code>DISPATCH_OBJECT_TFB</code></a> , ,   Objective-C     <code>libdispatch</code> -,    <code>isa</code>  <code>vtable</code> - <code>dispatch_object</code>  <code>object</code> : </p><br><pre> <code class="hljs tex">#define DISPATCH_OBJECT_TFB(f, o, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (slowpath((uintptr_t)((o)._os_obj-&gt;os_obj_isa) &amp; 1) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &lt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(dispatch_object)) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &gt;= <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(object))) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return f((o), ##__VA_ARGS__); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>}</code> </pre> <br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> ,   ,     <code>libdispatch</code> . </p><br><h2 id="podmena-simvolov">   </h2><br><p>       (   ) –    <code>DYLD_INSERT_LIBRARIES</code> ,  dyld     Mach-O-          . ,         ,    ,          <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  ,      ,    <em></em> -  .     (   ),     <code>dlsym()</code>   <code>RTLD_NEXT</code> ,  : </p><br><pre> <code class="hljs lua">int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, int flags, mode_t mode) { printf(<span class="hljs-string"><span class="hljs-string">" open(%s)\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>); // <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"foo"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">"bar"</span></span>; } int (*original_open)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, int, mode_t); original_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> original_open(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, flags, mode); }</code> </pre> <br><p>    , dyld     ,  <em>dyld-</em> [dyld iterposing].      Mach-O-   <code>__interpose</code> , dyld      ,    –    . </p><br><p>   ,       – ,        <code>__interpose</code> –    <em> </em> [implicit interposing].   ,  <code>__interpose</code>       (     ),  dyld      .  , dyld- <em></em>       ,      - .  , dyld  ,      -    ,     - (   Mach-O-): </p><br><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">int</span></span> my_open(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, mode_t mode) { printf("Called open(%s)\n", <span class="hljs-type"><span class="hljs-type">path</span></span>); // "  " <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-type"><span class="hljs-type">path</span></span>, "foo") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">path</span></span> = "bar"; } //    ,    //  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>()      my_open(). <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, flags, mode); } //      __interpose __attribute__ ((section ("__DATA,__interpose"))) static struct { <span class="hljs-type"><span class="hljs-type">void</span></span> *replacement, *replacee; } replace_pair = { my_open, <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> };</code> </pre> <br><p>  ,      –          –       Mach-O-  -        [relocation table].        ,   dyld      (    ),     . </p><br><p> ,      <code>dyld_dynamic_interpose</code> ,       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *replacement, *replacee; } replacement_tuple; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mach_header</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dso_handle</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dyld_dynamic_interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct mach_header*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> replacement_tuple replacements[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ replacement_tuple replace_pair = { my_open, open }; dyld_dynamic_interpose(&amp;__dso_handle, &amp;replace_pair, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> ,     ,         ,     . </p><br><p> <code>DYLD_INSERT_LIBRARIES</code>  dyld-         Objective-C,   C,  - ,       Objective-C- ( <code>IMP</code> ),    Objective-C       ,   <em>method swizzling</em> ( <em>isa swizzling</em> ). </p><br><p>      Darling     xtrace,       . </p><br><p>   Darwin    Darwin (    –   BSD    Mach- [Mach traps]).        <code>libsystem_kernel</code> ,   ABI     userspace.  Darling,    <code>libsystem_kernel</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>    Darwin     Linux    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Darling-Mach</a> ,    Linux,  Mach   . </p><br><p> strace,       Linux,    ,  Linux-;  strace    Darwin,   Darling,     Linux,       Darwin (    Linux,    ELF- ).   ,    Darwin  Linux      ,   ,    Darwin   –  ,       –   . </p><br><p>        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">xtrace</a> .    strace,           ,   <code>ptrace()</code> API, xtrace          .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <code>DYLD_INSERT_LIBRARIES=/usr/lib/darling/libxtrace.dylib</code> ,   - [trampoline functions]       ,        .  xtrace   ,  strace,       ,       ,   : </p><br><pre> <code class="bash hljs">Darling [~]$ xtrace arch &lt;......&gt; [223] mach_timebase_info_trap (...) [223] mach_timebase_info_trap () -&gt; KERN_SUCCESS [223] issetugid (...) [223] issetugid () -&gt; 0 [223] host_self_trap () [223] host_self_trap () -&gt; port right 2563 [223] mach_msg_trap (...) [223] mach_msg_trap () -&gt; KERN_SUCCESS [223] _kernelrpc_mach_port_deallocate_trap (task=2563, name=-6) [223] _kernelrpc_mach_port_deallocate_trap () -&gt; KERN_SUCCESS [223] ioctl (...) [223] ioctl () -&gt; 0 [223] fstat64 (...) [223] fstat64 () -&gt; 0 [223] ioctl (...) [223] ioctl () -&gt; 0 [223] write_nocancel (...) i386 [223] write_nocancel () -&gt; 5 [223] <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (...)</code> </pre> <br><p>    ,       BSD  Mach.   ,   <code>write()</code>  <code>exit()</code> ,     Linux-,       . ,  Mach-   <code>ioctl</code> -   <code>/dev/mach</code> ,     ;   BSD- <code>ioctl()</code> ,   stdio   ,      stdin  stdout (    tty) <a href=""></a>     <code>readlink()</code>    <code>/proc/self/fd/</code> . </p><br><hr><br><p>          Mach-O,        ,     dyld.      : </p><br><ul><li>    ,       ,     dylib,  ,  <em> </em>  . ld       <code>-bundle_loader</code> . </li><li>   ,  <code>LC_LOAD_DYLIB</code> , <code>LC_REEXPORT_DYLIB</code>  <code>LC_DYLIB_ID</code>    ,   <em></em>  <em></em>  [compatibility version, current version] ,    –    ,    .              ld <code>-current_version</code>  <code>-compatibility_version</code> , .     dyld ,       ,    ,     . </li><li>      ,  Mach-O     <em>  </em> [source version].     , <code>LC_SOURCE_VERSION</code> .        ld <code>-source_version</code> ,    ,       Mach-O- –    <code>-add_source_version</code>  <code>-no_source_version</code> . </li><li>    <code>Info.plist</code>   <code>__info_plist</code> Mach-O-    [codesign] ,           <code>Info.plist</code> .    <a href="">ad-hoc </a>  Security.framework,  ,      <code>CFBundle</code> / <code>NSBundle</code> API,       ,     ,  . </li></ul><br><p> ,  ,       , ld  dyld    ,    « »,   <code>libSystem</code> ,  -.            <code>/usr/lib/</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417507/">https://habr.com/ru/post/zh-CN417507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417495/index.html">在英特尔的InnovateFPGA竞赛欧洲决赛中，俄罗斯和乌克兰团队战胜了欧洲人</a></li>
<li><a href="../zh-CN417497/index.html">Schibsted Media Group的数据科学专业4年</a></li>
<li><a href="../zh-CN417501/index.html">Lifehacks制造两层板（LUT）</a></li>
<li><a href="../zh-CN417503/index.html">Web开发人员必须记住要做SEO-Feng Shui</a></li>
<li><a href="../zh-CN417505/index.html">英特尔发布新的ME固件漏洞补丁</a></li>
<li><a href="../zh-CN417509/index.html">Kubernetes技巧与窍门：加速大型数据库的引导</a></li>
<li><a href="../zh-CN417511/index.html">英特尔收购eASIC-结构化ASIC开发人员</a></li>
<li><a href="../zh-CN417513/index.html">Python和JavaScript中的类似物。 第二部分</a></li>
<li><a href="../zh-CN417515/index.html">我在5年内创造了100款游戏所学到的东西</a></li>
<li><a href="../zh-CN417517/index.html">英特尔历史页面。 照片纪事和测验</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>