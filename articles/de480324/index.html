<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöà ü§≤ üëèüèæ String-Typ-Implementierung in CPython üç® ‚¨áÔ∏è üë®üèΩ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich werde die Implementierung der Grundtypen in CPython ohne Eile weiter analysieren. Zuvor wurden W√∂rterb√ºcher und ganze Zahlen in Betracht gezogen. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>String-Typ-Implementierung in CPython</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480324/">  Ich werde die Implementierung der Grundtypen in CPython ohne Eile weiter analysieren. Zuvor wurden <a href="https://habr.com/en/post/432996/">W√∂rterb√ºcher</a> und <a href="https://habr.com/en/post/455114/">ganze Zahlen</a> in Betracht gezogen.  Diejenigen, die der Meinung sind, dass ihre Implementierung nichts Interessantes und Listiges enthalten kann, werden aufgefordert, diesen Artikeln beizutreten.  Diejenigen, die sie bereits gelesen haben, wissen, dass CPython viele interessante Funktionen und Implementierungsfunktionen hat.  Sie k√∂nnen hilfreich sein, wenn Sie Ihre eigenen Skripte schreiben, oder als Leitfaden f√ºr Architektur- und Algorithmusl√∂sungen.  Die Zeichenfolgen sind hier keine Ausnahme. <br><br><img src="https://habrastorage.org/webt/3m/lq/kc/3mlqkcmwvt31uagvuvhdqek1rp4.png"><br><a name="habracut"></a><br>  Beginnen wir mit einem kurzen Exkurs in die Geschichte.  Python erschien 1990-91.  Anf√§nglich gab es bei der Entwicklung der Basiscodierung in Python ein gutes altes Einzelbyte-ASCII.  Ungef√§hr zur gleichen Zeit (etwas sp√§ter) hatte die Menschheit es satt, sich mit dem ‚ÄûZoo‚Äú der Kodierungen zu befassen, und 1991 wurde der Unicode-Standard vorgeschlagen.  Aber auch beim ersten Mal hat es nicht funktioniert.  Die Einf√ºhrung von Zwei-Byte-Codierungen begann, aber bald wurde klar, dass zwei Byte nicht f√ºr alle ausreichen w√ºrden. Es wurde eine 4-Byte-Codierung vorgeschlagen.  Leider schien die Zuweisung von 4 Byte f√ºr jedes Zeichen eine Verschwendung von Speicherplatz und Arbeitsspeicher zu sein, insbesondere in den L√§ndern, in denen zuvor ein Einzelbyte-ASCII-Wert ausreichte.  Mehrere Kr√ºcken wurden in eine 2-Byte-Codierung ges√§gt, um mehr Zeichen zu unterst√ºtzen, und all dies √§hnelte der vorherigen Situation mit dem ‚ÄûZoo‚Äú der Codierungen. <br><br>  1993 wurde utf-8 eingef√ºhrt.  Was ein Kompromiss war: ASCII war eine g√ºltige Teilmenge von UTF-8, alle anderen Zeichen haben es erweitert. Um diese M√∂glichkeit zu unterst√ºtzen, mussten wir uns jedoch von einer festen L√§nge jedes Zeichens trennen.  Aber er war dazu bestimmt, <s>alle</s> zu <s>regieren</s> , um genau Unicode zu werden, dh eine einzelne Codierung, die von den meisten Programmen unterst√ºtzt wird, in denen die meisten Dateien gespeichert sind.  Dies wurde insbesondere durch die Entwicklung des Internets beeinflusst, da Webseiten normalerweise nur utf-8 verwenden. <br><br>  Die Unterst√ºtzung f√ºr diese Codierung wurde schrittweise in Programmiersprachen eingef√ºhrt, die wie Python vor utf-8 entwickelt wurden und daher andere Codierungen verwendeten.  Es gibt <a href="https://www.python.org/dev/peps/pep-0100/" rel="nofollow">PEP</a> mit einer netten Nummer 100, die die Unicode-Unterst√ºtzung behandelt.  In <a href="https://www.python.org/dev/peps/pep-0263/" rel="nofollow">PEP-0263 wurde es</a> m√∂glich, die Kodierung der Quelldateien zu deklarieren.  Die Ascodierung war immer noch die Basiscodierung, das Pr√§fix "u" wurde verwendet, um Unicode-Zeichenfolgen zu deklarieren, die Arbeit mit ihnen war immer noch nicht praktisch und nat√ºrlich genug.  Es bestand jedoch die M√∂glichkeit, die folgende H√§resie zu erstellen: <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> ÎπÑÎπîÎ∞•:</span></span> _ = <span class="hljs-number"><span class="hljs-number">2</span></span> ◊ê = ÎπÑÎπîÎ∞•() print(◊ê)</code> </pre> <br>  Am 3. Dezember 2008 fand ein historisches Ereignis f√ºr die gesamte Python-Community statt (und angesichts der Verbreitung dieser Sprache, vielleicht auch f√ºr die ganze Welt) - Python 3. Es wurde beschlossen, die Probleme ein f√ºr alle Mal zu beenden, weil viele Codierungen, und daher ist Unicode die Basiscodierung geworden.  Wir erinnern uns jedoch, dass die Codierung kompliziert ist und beim ersten Mal nicht funktioniert.  Diesmal hat es auch nicht geklappt. <br><br>  Der gro√üe Nachteil von utf-8 ist, dass die L√§nge des Zeichens nicht festgelegt ist, was dazu f√ºhrt, dass eine so einfache Operation wie der Zugriff auf den Index die Komplexit√§t O (N) hat, da der Versatz des Elements nicht im Voraus bekannt ist. Zum Speichern eines Strings zugewiesen, k√∂nnen Sie dessen L√§nge nicht in Zeichen berechnen. <br><br>  Um all diese Probleme in Python zu vermeiden, wurde entschieden, 2- und 4-Byte-Codierungen (je nach Plattform) zu verwenden.  Die Indexbehandlung wurde vereinfacht - der Index musste nur mit 2 oder 4 multipliziert werden. Dies brachte jedoch die folgenden Probleme mit sich: <br><br><ol><li>  Jede Plattform hatte ihre eigene Codierung, was zu Problemen mit der Code-Portabilit√§t f√ºhren konnte </li><li>  Erh√∂hter Speicherverbrauch und / oder Codierungsprobleme f√ºr schwierige Zeichen, die nicht in zwei Bytes passen </li></ol><br>  Eine L√∂sung f√ºr diese Probleme wurde in <a href="https://www.python.org/dev/peps/pep-0393/" rel="nofollow">PEP-393 vorgeschlagen</a> , und wir werden dar√ºber sprechen. <br><br>  Es wurde beschlossen, die Zeilen als Array von Zeichen zu belassen, um den Zugriff durch Index- und andere Operationen zu erleichtern. Die L√§nge der Zeichen begann jedoch zu variieren.  Beim Erstellen einer Zeichenfolge durchsucht der Interpreter alle Zeichen und weist jedem Byte die Anzahl der zum Speichern der ‚Äûgr√∂√üten‚Äú erforderlichen Bytes zu. Wenn Sie also eine ASCII-Zeichenfolge deklarieren, sind alle Zeichen ein Byte, wenn Sie der Zeichenfolge jedoch ein Zeichen hinzuf√ºgen m√∂chten Aus der kyrillischen Sprache werden alle Zeichen bereits aus zwei Bytes bestehen.  Es gibt drei m√∂gliche Optionen: 1, 2 und 4 Bytes pro Zeichen. <br><br>  Der Zeichenfolgentyp (PyUnicodeObject) wird <a href="" rel="nofollow">wie folgt</a> deklariert: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Strings allocated through PyUnicode_FromUnicode(NULL, len) use the PyUnicodeObject structure. The actual string data is initially in the wstr block, and copied into the data block using _PyUnicode_Ready. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyCompactUnicodeObject _base; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *any; Py_UCS1 *latin1; Py_UCS2 *ucs2; Py_UCS4 *ucs4; } data; <span class="hljs-comment"><span class="hljs-comment">/* Canonical, smallest-form Unicode buffer */</span></span> } PyUnicodeObject;</code> </pre><br>  PyCompactUnicodeObject stellt wiederum die <a href="" rel="nofollow">folgende Struktur dar</a> (mit einigen Vereinfachungen und meinen Kommentaren): <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*    ascii  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyASCIIObject _base; Py_ssize_t utf8_length; <span class="hljs-comment"><span class="hljs-comment">/*    utf-8  (  \0 )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *utf8; <span class="hljs-comment"><span class="hljs-comment">/* UTF-8  ( \0 )*/</span></span> Py_ssize_t wstr_length; <span class="hljs-comment"><span class="hljs-comment">/*  code point  wstr. */</span></span> } PyCompactUnicodeObject; <span class="hljs-comment"><span class="hljs-comment">/*   ascii  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyObject_HEAD <span class="hljs-comment"><span class="hljs-comment">/*   (     ) */</span></span> Py_ssize_t length; <span class="hljs-comment"><span class="hljs-comment">/*  code point   */</span></span> Py_hash_t hash; <span class="hljs-comment"><span class="hljs-comment">/*   -1,      */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/* SSTATE_NOT_INTERNED (0) SSTATE_INTERNED_MORTAL (1) SSTATE_INTERNED_IMMORTAL (2) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> interned:<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  : - PyUnicode_WCHAR_KIND (0): * wchar_t (16  32 ,     ( )) - PyUnicode_1BYTE_KIND (1): - PyUnicode_2BYTE_KIND (2): - PyUnicode_4BYTE_KIND (4): */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> kind:<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    ( ,        ,   -  data   ). */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> compact:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*       U+0000-U+007F (ASCII) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ascii:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ,    ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ready:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> :<span class="hljs-number"><span class="hljs-number">24</span></span>; } state; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *wstr; <span class="hljs-comment"><span class="hljs-comment">/* wchar_t  (  \0 ) */</span></span> } PyASCIIObject;</code> </pre><br>  Somit sind 4 Zeilendarstellungen m√∂glich: <br><br><ol><li>  Legacy-String, fertig <br><br><pre> <code class="markdown hljs"> <span class="hljs-bullet"><span class="hljs-bullet">* structure = PyUnicodeObject structure *</span></span>   : !PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_IS_</span></span>COMPACT(op) &amp;&amp; kind != PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_WCHAR_</span></span>KIND <span class="hljs-bullet"><span class="hljs-bullet">* kind = PyUnicode_1BYTE_KIND, PyUnicode_2BYTE_KIND or PyUnicode_4BYTE_KIND *</span></span> compact = 0 <span class="hljs-bullet"><span class="hljs-bullet">* ready = 1 *</span></span> data.any is not NULL <span class="hljs-bullet"><span class="hljs-bullet">* utf8   data.any  utf8_length = length  ascii = 1 *</span></span> utf8<span class="hljs-emphasis"><span class="hljs-emphasis">_length = 0  utf8 is NULL * wstr   with data.any  wstr_</span></span>length = length  kind=PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_2BYTE_</span></span>KIND and sizeof(wchar<span class="hljs-emphasis"><span class="hljs-emphasis">_t)=2 or if kind=PyUnicode_</span></span>4BYTE<span class="hljs-emphasis"><span class="hljs-emphasis">_KIND and sizeof(wchar_</span></span>4)=4 * wstr_length = 0  wstr is NULL</code> </pre></li><li>  Legacy-String, nicht fertig <br><br><pre> <code class="markdown hljs"> <span class="hljs-bullet"><span class="hljs-bullet">* structure = PyUnicodeObject *</span></span>   : kind == PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_WCHAR_</span></span>KIND <span class="hljs-bullet"><span class="hljs-bullet">* length = 0 (use wstr_length) *</span></span> hash = -1 <span class="hljs-bullet"><span class="hljs-bullet">* kind = PyUnicode_WCHAR_KIND *</span></span> compact = 0 <span class="hljs-bullet"><span class="hljs-bullet">* ascii = 0 *</span></span> ready = 0 <span class="hljs-bullet"><span class="hljs-bullet">* interned = SSTATE_NOT_INTERNED *</span></span> wstr is not NULL <span class="hljs-bullet"><span class="hljs-bullet">* data.any is NULL *</span></span> utf8 is NULL * utf8_length = 0</code> </pre></li><li>  kompakte Ascii <br><br><pre> <code class="markdown hljs"> <span class="hljs-bullet"><span class="hljs-bullet">* structure = PyASCIIObject *</span></span>   : PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_IS_</span></span>COMPACT<span class="hljs-emphasis"><span class="hljs-emphasis">_ASCII(op) * kind = PyUnicode_</span></span>1BYTE_KIND <span class="hljs-bullet"><span class="hljs-bullet">* compact = 1 *</span></span> ascii = 1 <span class="hljs-bullet"><span class="hljs-bullet">* ready = 1 *</span></span> (length ‚Äî  utf8  wstr ) <span class="hljs-bullet"><span class="hljs-bullet">* (data    ) *</span></span> (  ascii    utf8 string   data)</code> </pre></li><li>  kompakt <br><br><pre> <code class="markdown hljs"> <span class="hljs-bullet"><span class="hljs-bullet">* structure = PyCompactUnicodeObject *</span></span>   : PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_IS_</span></span>COMPACT(op) &amp;&amp; !PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_IS_</span></span>ASCII(op) <span class="hljs-bullet"><span class="hljs-bullet">* kind = PyUnicode_1BYTE_KIND, PyUnicode_2BYTE_KIND or PyUnicode_4BYTE_KIND *</span></span> compact = 1 <span class="hljs-bullet"><span class="hljs-bullet">* ready = 1 *</span></span> ascii = 0 <span class="hljs-bullet"><span class="hljs-bullet">* utf8  data  *</span></span> utf8<span class="hljs-emphasis"><span class="hljs-emphasis">_length = 0  utf8 is NULL * wstr   data  wstr_</span></span>length=length  kind=PyUnicode<span class="hljs-emphasis"><span class="hljs-emphasis">_2BYTE_</span></span>KIND and sizeof(wchar<span class="hljs-emphasis"><span class="hljs-emphasis">_t)=2 or if kind=PyUnicode_</span></span>4BYTE<span class="hljs-emphasis"><span class="hljs-emphasis">_KIND and sizeof(wchar_</span></span>t)=4 <span class="hljs-bullet"><span class="hljs-bullet">* wstr_length = 0  wstr is NULL *</span></span> (data    )</code> </pre></li></ol><br>  Es ist zu beachten, dass Python 3 auch die Syntax zum Deklarieren von Unicode-Strings √ºber das Pr√§fix "u" unterst√ºtzt. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>b = <span class="hljs-string"><span class="hljs-string">u""</span></span> &gt;&gt;&gt; b <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br>  Diese Funktion wurde hinzugef√ºgt, um die Portierung von Code von der zweiten auf die dritte Version in <a href="https://www.python.org/dev/peps/pep-0414/" rel="nofollow">PEP-414</a> in Python 3.3 erst im Februar 2012 zu vereinfachen. Ich m√∂chte Sie daran erinnern, dass Python 3 im Dezember 2008 ver√∂ffentlicht wurde, aber niemand hatte es eilig mit dem √úbergang. <br><br>  Mit diesem Wissen und dem Standardmodul ctypes k√∂nnen wir auf die internen Felder des Strings zugreifen. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interned</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(enum.Enum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># SSTATE_NOT_INTERNED (0) # SSTATE_INTERNED_MORTAL (1) # SSTATE_INTERNED_IMMORTAL (2) # If interned != SSTATE_NOT_INTERNED, the two references from the # dictionary to this object are *not* counted in ob_refcnt. SSTATE_NOT_INTERNED = 0 SSTATE_INTERNED_MORTAL = 1 SSTATE_INTERNED_IMMORTAL = 2 class Kind(enum.Enum): PyUnicode_WCHAR_KIND = 0 PyUnicode_1BYTE_KIND = 1 PyUnicode_2BYTE_KIND = 2 PyUnicode_4BYTE_KIND = 4 # PyUnicodeObject class StrStruct(ctypes.Structure): _fields_ = [("refcnt", ctypes.c_long), ("type", ctypes.c_void_p), ("length", ctypes.c_long), ("hash", ctypes.c_void_p), # ascii fields ("_interned", ctypes.c_uint, 2), ("_kind", ctypes.c_uint, 3), ("compact", ctypes.c_uint, 1), ("ascii", ctypes.c_uint, 1), ("ready", ctypes.c_uint, 1), ("_rest_state", ctypes.c_uint, 16), # for future use ("wstr", ctypes.c_wchar_p), # PyCompactUnicodeObject ("utf8_length", ctypes.c_ssize_t), # Number of bytes in utf8, excluding the terminating \0. ("utf8", ctypes.c_char_p), ("wstr_length", ctypes.c_ssize_t), # Number of code points ("data", ctypes.c_void_p) # canonical, smallest-form Unicode buffer ] _printable_fields = ("refcnt", "length", "hash", "interned", "kind", "compact", "ascii", "ready", "wstr", "utf8_length", "utf8", "wstr_length", "data") @property def interned(self): return Interned(self._interned) @property def kind(self): return Kind(self._kind) def __repr__(self): new_line = '\n' # f-string expression part cannot include a backslash return f"StrStruct({new_line.join(f'{key}={getattr(self, key)}' for key in self._printable_fields)})" if __name__ == '__main__': string = sys.argv[1] s = StrStruct.from_address(id(string)) print(s)</span></span></code> </pre><br>  Und brechen Sie sogar den Interpreter, wie Sie es im <a href="https://habr.com/en/post/455114/">vorherigen Teil</a> getan haben. <br><br>  HAFTUNGSAUSSCHLUSS: Der folgende Code wird so wie er ist geliefert, der Autor √ºbernimmt keine Verantwortung und kann den Zustand des Dolmetschers sowie die geistige Gesundheit von Ihnen und Ihren Kollegen nach der Ausf√ºhrung dieses Codes nicht garantieren.  Der Code wurde auf cpython Version 3.7 getestet und funktioniert leider nicht mit ASCII-Strings. <br><br>  √Ñndern Sie dazu den oben beschriebenen Code in: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_some_magic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(str1, str2)</span></span></span><span class="hljs-function">:</span></span> s1 = StrStruct.from_address(id(str1)) s2 = StrStruct.from_address(id(str2)) s2.data = s1.data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: string = <span class="hljs-string"><span class="hljs-string">"ÎπÑÎπîÎ∞•"</span></span> string2 = <span class="hljs-string"><span class="hljs-string">"h√°ƒç"</span></span> print(string == string2) <span class="hljs-comment"><span class="hljs-comment"># False make_some_magic(string, string2) print(string == string2) # True</span></span></code> </pre><br><br>  In diesen Beispielen wird die in <a href="https://www.python.org/dev/peps/pep-0498/" rel="nofollow">Python 3.6</a> hinzugef√ºgte Zeichenfolgeninterpolation verwendet.  Python kam nicht sofort zu dieser Methode, um Zeichenfolgen auszugeben:% syntax, format, so etwas <a href="https://www.python.org/dev/peps/pep-3101/" rel="nofollow">wie perl</a> wurden ausprobiert (eine ausf√ºhrlichere Beschreibung mit Beispielen finden Sie <a href="https://habr.com/en/post/421993/">hier</a> ). <br>  Vielleicht war diese √Ñnderung f√ºr seine Zeit (vor Python 3.8 mit seinem `: =` Operator) die umstrittenste.  Die Diskussion (und Verurteilung) wurde sowohl √ºber <a href="https://www.reddit.com/r/Python/comments/3k6qi8/pep_498_approved/" rel="nofollow">reddit</a> als auch in Form von <a href="https://www.python.org/dev/peps/pep-0502/" rel="nofollow">PEP gef√ºhrt</a> .  Verbesserungs- / Korrekturideen wurden in Form von <a href="https://www.python.org/dev/peps/pep-0501/" rel="nofollow">i-lines</a> ausgedr√ºckt <a href="https://www.python.org/dev/peps/pep-0501/" rel="nofollow">,</a> f√ºr die Benutzer ihre Parser schreiben konnten, um die Kontrolle zu verbessern und SQL-Injections und andere Probleme zu vermeiden.  Diese √Ñnderung wurde jedoch verschoben, damit sich die Leute an die F-Linien gew√∂hnen und etwaige Probleme erkennen. <br><br>  F-Linien haben eine Besonderheit (Nachteil): Sie k√∂nnen keine Sonderzeichen mit Schr√§gstrichen angeben, z. B. '\ n' '\ t'.  Dies kann jedoch leicht umgangen werden, indem eine separate Zeile mit Sonderzeichen deklariert und an die f-Zeile √ºbergeben wird, wie im obigen Beispiel beschrieben. Sie k√∂nnen jedoch geschachtelte Klammern verwenden. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>number = <span class="hljs-number"><span class="hljs-number">2</span></span> &gt;&gt;&gt; precision = <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;&gt;&gt; <span class="hljs-string"><span class="hljs-string">f"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{number:.{precision}</span></span></span><span class="hljs-string">f}"</span></span> <span class="hljs-number"><span class="hljs-number">2.000</span></span> <span class="hljs-comment"><span class="hljs-comment"># , format     &gt;&gt;&gt; "{:{}f}".format(number, precision) 2.000</span></span></code> </pre><br>  Wie Sie sehen, speichern Strings ihren Hash, und es gab einen <a href="https://mail.python.org/pipermail/python-dev/2012-October/122238.html%2B%26cd%3D1%26hl%3Den%26ct%3Dclnk%26gl%3Dru%26client%3Dfirefox-b-d" rel="nofollow">Vorschlag,</a> diesen Wert zum Vergleichen von Strings zu verwenden, basierend auf einer einfachen Regel: Wenn die Strings identisch sind, haben sie denselben Hash, und daraus folgt, dass die Strings mit unterschiedlichen Hashes nicht identisch sind.  Es blieb jedoch unerf√ºllt. <br><br>  Beim Vergleich zweier Zeichenketten wird gepr√ºft, ob sich die Zeiger auf die Zeichenketten auf dieselbe Adresse beziehen. Wenn nicht, wird ein zeichenweiser Vergleich oder ein memcmp gestartet, wenn dies zul√§ssig ist. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PyUnicode_Compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyObject *left, PyObject *right)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PyUnicode_Check(left) &amp;&amp; PyUnicode_Check(right)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PyUnicode_READY(left) == <span class="hljs-number"><span class="hljs-number">-1</span></span> || PyUnicode_READY(right) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left == right) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unicode_compare(left, right); <span class="hljs-comment"><span class="hljs-comment">//    memcmp }   }</span></span></code> </pre> <br>  Der Hash-Wert wirkt sich jedoch indirekt auf den Vergleich aus.  Tatsache ist, dass in cpython Zeichenfolgen interniert, d. H. In einem einzelnen W√∂rterbuch gespeichert werden.  Dies gilt nicht f√ºr alle Zeilen, alle Konstanten, W√∂rterbuchschl√ºssel, Felder und Variablen sowie ASCII-Zeilen mit einer L√§nge von weniger als 20 werden interniert. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: string = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] string2 = sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] print(id(string) == id(string2))</code> </pre><br><pre> <code class="plaintext hljs">$ python check_interned.py aa True $ python check_interned.py ÎπÑÎπîÎ∞• ÎπÑÎπîÎ∞• False $ python check_interned.py aaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaa False</code> </pre><br>  Und die leere Zeichenfolge ist in der Regel Singleton <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PyUnicodeObject * _PyUnicode_New(Py_ssize_t length) { PyUnicodeObject *unicode; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> new_size; <span class="hljs-comment"><span class="hljs-comment">/* Optimization for empty strings */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; unicode_empty != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { Py_INCREF(unicode_empty); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (PyUnicodeObject*)unicode_empty; } ... }</code> </pre><br>  Wie wir sehen k√∂nnen, war cpython in der Lage, eine einfache, aber gleichzeitig effiziente Implementierung des Zeichenfolgentyps zu erstellen.  In einigen F√§llen war es dank der memcmp- und memcpy-Funktionen m√∂glich, den verwendeten Speicher zu reduzieren und Vorg√§nge zu beschleunigen, anstatt zeichenweise.  Wie Sie sehen, ist der String-Typ √ºberhaupt nicht so einfach zu implementieren, wie es beim ersten Mal scheinen mag.  Aber die Entwickler von cpython sind sehr geschickt mit ihrem Gesch√§ft umgegangen und deshalb k√∂nnen wir es nutzen und nicht einmal dar√ºber nachdenken, was sich unter der Haube verbirgt. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de480324/">https://habr.com/ru/post/de480324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de480306/index.html">Warum die geschlossene T√ºr schlagen?</a></li>
<li><a href="../de480310/index.html">Habra-Detektiv: Das Geheimnis der Nachrichtenredakteure</a></li>
<li><a href="../de480316/index.html">So reduzieren Sie den Verbrauch von WLAN-Modulen um das Zehnfache oder mehr</a></li>
<li><a href="../de480318/index.html">Eine Auswahl an bevorstehenden kostenlosen Events f√ºr Entwickler in Moskau # 3 (16.-24. Dezember)</a></li>
<li><a href="../de480320/index.html">Zehn Jahre ONYX in Russland - wie sich Technologien, Leser und der Markt in dieser Zeit ver√§ndert haben</a></li>
<li><a href="../de480326/index.html">Die F5 Networks Corporation sendet ihren Kunden Briefe, in denen sie √ºber die aktuelle Situation mit NGINX informiert werden</a></li>
<li><a href="../de480328/index.html">Wie man Freunde macht PyTorch und C ++. TorchScript verwenden</a></li>
<li><a href="../de480330/index.html">Ideales Tool zur Mitarbeiterbewertung</a></li>
<li><a href="../de480332/index.html">Analyse der Daten der Blockchain-Abstimmung 2019 in der Moskauer Stadtduma</a></li>
<li><a href="../de480338/index.html">So funktioniert das Rendern von 3D-Spielen: Rasterisierung und Raytracing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>