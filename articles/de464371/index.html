<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛌🏾 👋🏿 🔽 /etc/resolv.conf für Kubernetes-Pods, Option ndots: 5, da dies die Anwendungsleistung beeinträchtigen kann 🕚 🔪 👨🏽‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor nicht allzu langer Zeit haben wir Kubernetes 1.9 unter AWS mit Kops gestartet. Gestern, als ich reibungslos neuen Datenverkehr auf den größten uns...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>/etc/resolv.conf für Kubernetes-Pods, Option ndots: 5, da dies die Anwendungsleistung beeinträchtigen kann</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/464371/"><p><img src="https://habrastorage.org/webt/og/sh/ky/ogshkyh7cdbhytp_zt9_c40qufm.png"></p><br><p>  Vor nicht allzu langer Zeit haben wir Kubernetes 1.9 unter AWS mit Kops gestartet.  Gestern, als ich reibungslos neuen Datenverkehr auf den größten unserer Kubernetes-Cluster übertrug, bemerkte ich ungewöhnliche DNS-Namensauflösungsfehler, die von unserer Anwendung protokolliert wurden. </p><a name="habracut"></a><br><p> GitHub hat eine ganze Weile darüber gesprochen, also habe ich mich auch entschlossen, es herauszufinden.  Am Ende wurde mir klar, dass dies in unserem Fall auf die erhöhte Belastung von <code>kube-dns</code> und <code>dnsmasq</code> .  Das Interessanteste und Neueste für mich war der Grund für eine signifikante Zunahme des Datenverkehrs bei DNS-Abfragen.  Darüber und was damit zu tun ist, mein Beitrag. </p><br><p>  Die Auflösung des DNS im Container wird - wie bei jedem Linux-System - durch die Konfigurationsdatei <code>/etc/resolv.conf</code> .  Standardmäßig ist Kubernetes <code>dnsPolicy</code> <code>ClusterFirst</code> bedeutet, dass jede DNS-Abfrage an <code>dnsmasq</code> umgeleitet wird, das im <code>kube-dns</code> innerhalb des Clusters ausgeführt wird. <code>kube-dns</code> wird die Abfrage an die <code>kube-dns</code> Anwendung umgeleitet, wenn der Name mit einem Clustersuffix endet, oder Andernfalls auf einen übergeordneten DNS-Server. </p><br><p>  Die Datei <code>/etc/resolv.conf</code> in jedem Container sieht standardmäßig folgendermaßen aus: </p><br><pre> <code class="plaintext hljs">nameserver 100.64.0.10 search namespace.svc.cluster.local svc.cluster.local cluster.local eu-west-1.compute.internal options ndots:5</code> </pre> <br><p>  Wie Sie sehen können, gibt es drei Richtlinien: </p><br><ol><li>  Der Nameserver ist der IP-Dienst von <code>kube-dns</code> </li><li>  4 lokale Suchdomänen angegeben </li><li>  Es gibt eine Option <code>ndots:5</code> </li></ol><br><p>  Ein interessanter Teil dieser Konfiguration ist, wie lokale <code>ndots:5</code> und <code>ndots:5</code> Einstellungen miteinander auskommen.  Um dies zu verstehen, müssen Sie verstehen, wie die DNS-Auflösung für Teilnamen funktioniert. </p><br><h3 id="chto-takoe-polnoe-imya">  Wie lautet der vollständige Name? </h3><br><p>  Ein vollständig qualifizierter Name ist ein Name, für den keine lokale Suche durchgeführt wird, und der Name wird bei der Namensauflösung als absolut betrachtet.  Gemäß der Konvention betrachtet die DNS-Software einen Namen als vollständig qualifiziert, wenn er mit einem Punkt (.) Endet, und nicht vollständig anders.  Das ist <code>google.com.</code>  vollständig definiert, aber <code>google.com</code> nicht. </p><br><h3 id="kak-obrabatyvaetsya-nepolnoe-imya">  Wie wird mit einem unvollständigen Namen umgegangen? </h3><br><p>  Wenn eine Anwendung eine Verbindung zu dem im Namen angegebenen Remote-Host herstellt, erfolgt die DNS-Namensauflösung normalerweise mithilfe eines Systemaufrufs, z. B. <code>getaddrinfo()</code> .  Wenn der Name jedoch unvollständig ist (endet nicht mit.), Frage ich mich, ob der Systemaufruf zuerst versucht, den Namen als absolut aufzulösen, oder ob er zuerst die lokalen Suchdomänen durchläuft.  <code>ndots</code> hängt von der Option <code>ndots</code> . </p><br><p>  Aus dem Handbuch auf <code>resolv.conf</code> : </p><br><pre> <code class="plaintext hljs">ndots:n     ,     ,       .     n  1,  ,      - ,       ,       -   .</code> </pre> <br><p>  Dies bedeutet, dass, wenn <code>ndots</code> auf 5 gesetzt ist und der Name weniger als 5 Punkte enthält, der Systemaufruf versucht, ihn nacheinander aufzulösen, indem zuerst alle lokalen <code>ndots</code> durchlaufen werden, und wenn er nicht erfolgreich ist, wird er schließlich als absoluter Name aufgelöst. </p><br><h3 id="pochemu-zhe-ndots5-mozhet-negativno-skazatsya-na-proizvoditelnost-prilozheniya">  Warum können <code>ndots:5</code> die Anwendungsleistung beeinträchtigen? </h3><br><p>  Wenn Ihre Anwendung für jede hergestellte TCP-Verbindung (oder genauer für jeden aufgelösten Namen) viel externen Datenverkehr verwendet, werden, wie Sie verstehen, 5 DNS-Abfragen ausgegeben, bevor der Name korrekt aufgelöst wird, da zuerst 4 durchlaufen werden lokale Suchdomäne, und am Ende wird eine absolute Namensauflösungsanforderung ausgegeben. </p><br><p>  Das folgende Diagramm zeigt den gesamten Datenverkehr auf unseren 3 kube-dns-Modulen vor und nach dem Umschalten mehrerer in unserer Anwendung konfigurierter Hostnamen auf vollständig definierte. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a42/2d7/84d/a422d784da46831b34013bb54924544d.png" alt="Bild"></p><br><p>  Das folgende Diagramm zeigt die Anwendungsverzögerung vor und nach dem Umschalten mehrerer in unserer Anwendung konfigurierter Hostnamen auf "Vollständig" (die vertikale blaue Linie ist die Bereitstellung): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8a0/746/a24/8a0746a248f511891483ac622adc9374.png" alt="Bild"></p><br><h3 id="reshenie-1---ispolzovat-polnostyu-opredelennye-imena">  Lösung 1 - Verwenden Sie vollständig qualifizierte Namen </h3><br><p>  Wenn Sie nur wenige statische externe Namen haben (dh in der Anwendungskonfiguration definiert), zu denen Sie eine große Anzahl von Verbindungen erstellen, besteht die einfachste Lösung darin, diese durch einfaches Hinzufügen zu vollständig definierten zu wechseln.  Am Ende. </p><br><p>  Dies ist keine endgültige Entscheidung, aber es hilft, die Situation schnell, wenn auch nicht sauber, zu verbessern.  Wir haben diesen Patch angewendet, um unser Problem zu lösen. Die Ergebnisse wurden in den obigen Screenshots gezeigt. </p><br><h3 id="reshenie-2---kastomizaciya-ndots-v-dnsconfig">  Lösung 2 - Anpassen von <code>ndots</code> in <code>dnsConfig</code> </h3><br><p>  In Kubernetes 1.9 wurde im Alpha-Modus (Beta-Version v1.10) eine Funktion angezeigt, die eine bessere Steuerung der DNS-Parameter über die pod-Eigenschaft in <code>dnsConfig</code> .  Unter anderem können Sie den <code>ndots</code> Wert für einen bestimmten Herd anpassen, d. H. </p><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: Pod metadata: namespace: default name: dns-example spec: containers: - name: test image: nginx dnsConfig: options: - name: ndots value: "1"</code> </pre> <br><h3 id="istochniki">  Quellen </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Was ist die DNS-Namensqualifikation?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kubernetes: DNS für Dienste und Pods</a> </li></ul><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Lesen Sie auch andere Artikel in unserem Blog: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Grundlegendes zum Kontextpaket in Golang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Drei einfache Tricks zum Reduzieren von Docker-Bildern</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Stateful Backups in Kubernetes</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sichern einer großen Anzahl heterogener Webprojekte</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegrammbot für Redmine.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wie Sie das Leben für sich und die Menschen vereinfachen können</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de464371/">https://habr.com/ru/post/de464371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de464359/index.html">Funktionen zum Testen von mobilen Webanwendungen</a></li>
<li><a href="../de464361/index.html">Intel Quartz Canyon - NUC für Profis</a></li>
<li><a href="../de464365/index.html">Sicherheitswoche 34: Außergewöhnliche Sicherheitslücken in Windows</a></li>
<li><a href="../de464367/index.html">Und ein weiterer Steam Windows Client Local Privilege Escalation 0day</a></li>
<li><a href="../de464369/index.html">Welchen Blocker benutzt du? Ergebnisse</a></li>
<li><a href="../de464373/index.html">Edge-to-Edge unter Android: Richtig machen</a></li>
<li><a href="../de464375/index.html">Wie Suchmaschinen funktionieren</a></li>
<li><a href="../de464377/index.html">Schmutzige Assembler-Hacks 6502</a></li>
<li><a href="../de464381/index.html">Reise nach Alaska oder KDD'19 mit den Augen eines Augenzeugen</a></li>
<li><a href="../de464383/index.html">Wie ich die Dinge in einem Projekt in Ordnung bringe, in dem es einen Wald direkter Hände gibt (tslint, hübscher usw. Einstellungen)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>