<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüëß‚Äçüëß üòÇ üåü Verificamos a vulnerabilidade fechada e obtemos quatro novos CVEs üê¢ ü§õ üéÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me pediram para continuar a s√©rie de artigos sobre o fechamento de vulnerabilidades e sobre como elas s√£o fechadas (nosso primeiro artigo pode ser lid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verificamos a vulnerabilidade fechada e obtemos quatro novos CVEs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/430408/">  Me pediram para continuar a s√©rie de artigos sobre o fechamento de vulnerabilidades e sobre como elas s√£o fechadas (nosso primeiro artigo pode ser lido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Na √∫ltima vez, descobrimos que, mesmo que o fabricante relate o fechamento da vulnerabilidade, na realidade tudo pode n√£o ser assim. <br><br><img src="https://habrastorage.org/webt/me/ds/nj/medsnjr0lbtdxy9vots_csy_bbg.jpeg"><br><a name="habracut"></a><br><h3>  Crit√©rios de sele√ß√£o: </h3><br>  Os crit√©rios de sele√ß√£o para as vulnerabilidades consideradas desta vez foram os mesmos (com a exce√ß√£o de que desta vez eu queria examinar outros tipos de vulnerabilidades): <br><br><ul><li>  deve haver uma explora√ß√£o - queremos ver que, antes da atualiza√ß√£o, tudo foi mal <s>explorado</s> e, depois disso, ficou bom; </li><li>  a vulnerabilidade deve ser cr√≠tica (idealmente RCE) e com uma pontua√ß√£o alta; </li><li>  o produto deve ser de c√≥digo aberto; </li><li>  o produto n√£o deve ser abandonado e usado ativamente; </li><li>  a vulnerabilidade deve ser relativamente nova; </li><li>  como sempre, o principal √© que n√≥s mesmos estar√≠amos interessados. </li></ul><br><h3>  O que e como eu escolhi: </h3><br>  Fui ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vulners.com</a> e pedi para mostrar todas as fa√ßanhas com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exploit-db.com</a> nas √∫ltimas semanas.  Dessa vez, na categoria Web, quase todas as explora√ß√µes foram criadas por Ihsan Sencan, mas devido ao fato de elas geralmente se relacionarem a inje√ß√µes de sql em aplicativos e plugins antigos n√£o suportados, eu os removi.  Dos demais produtos, apenas a Ferramenta de Gerenciamento de Projetos ProjeQtOr 7.2.5, com vulnerabilidade CVE-2018-18924, se enquadrava na categoria "n√£o abandonado e em desenvolvimento ativo". <br>  Essa vulnerabilidade atendeu a todos os crit√©rios de sele√ß√£o: <br><br><ul><li>  existe uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fa√ßanha</a> ; </li><li>  Vulnerabilidade do RCE (embora exija que o usu√°rio seja autorizado); </li><li>  o produto √© bastante aberto; </li><li> o produto n√£o foi abandonado, em 2018 houve 28 lan√ßamentos e apenas o sourceforge.net havia 702 downloads (e a maioria dos downloads de atualiza√ß√µes resolve o problema do CVE, o que provavelmente indica que as pessoas viram o CVE e come√ßaram a atualizar); </li><li>  CVE de 4 de novembro, uma explora√ß√£o de 25 de outubro, atende aos requisitos de novidade; </li><li>  Eu olhei para o problema e sua solu√ß√£o, fiquei interessado (mais sobre isso mais tarde). </li></ul><br><h4>  Entendendo a ferramenta de gerenciamento de projetos ProjeQtOr </h4><br>  Lemos a descri√ß√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">explora√ß√£o</a> e a descri√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CVE em nist.gov</a> , entendemos que a vers√£o 7.2.5 √© vulner√°vel apenas para um usu√°rio autorizado.  Al√©m disso, voc√™ pode fazer upload de um arquivo .shtml como imagem, embora a mensagem de erro <i>"Este arquivo n√£o seja uma imagem v√°lida"</i> seja exibida, mas o arquivo ainda ser√° salvo nas imagens no servidor e acess√≠vel por meio de um link direto no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">host / arquivos / images / nome_da_imagem</a> . <br><br><img src="https://habrastorage.org/webt/8d/wu/0x/8dwu0x1uezs-x_ws7egw9szchue.png"><br><br>  O acesso via link direto √© bom, mas aqui voc√™ ainda precisa adivinhar o nome com o qual o arquivo ser√° baixado.  Temos sorte e n√£o √© aleat√≥ria, mas √© gerada a partir da hora atual no formato: ano, m√™s, dia, horas, minutos, segundos.  O resultado √© esse n√∫mero 20181114140320. Em seguida, o ID do usu√°rio e o nome do arquivo original passam pelo sublinhado.  Existem algumas inc√≥gnitas: <br><br><ul><li>  Fuso hor√°rio no servidor </li><li>  se o rel√≥gio no servidor estiver inoperante; </li><li>  ID do usu√°rio </li></ul><br>  E, novamente, temos sorte: se voc√™ enviar uma imagem v√°lida, todos esses par√¢metros ser√£o relatados para n√≥s.  N√£o √© dif√≠cil analisar v√°rias op√ß√µes de links (v√°rios, j√° que existem segundos, mas √© dif√≠cil entrar neles imediatamente). <br><br><img src="https://habrastorage.org/webt/zq/ce/lh/zqcelhvlhrk7496dafoiqart2nk.png"><br><br>  Em geral, obter o nome do arquivo n√£o √© um problema.  N√≥s seguimos em frente.  E pensamos: por que n√£o apenas enviar um script php?  Estamos tentando fazer o download, a mesma janela aparece, mas o arquivo n√£o aparece no diret√≥rio  √â hora de olhar para o c√≥digo! <br><br>  O script uploadImage.php √© respons√°vel pelo upload da imagem para o servidor na vers√£o 7.2.5. Estamos interessados ‚Äã‚Äãnas linhas 100 a 117. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { traceHack(<span class="hljs-string"><span class="hljs-string">"Try to upload php file as image in CKEditor"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! move_uploaded_file($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploadfile)) { $error = htmlGetErrorMessage(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); errorLog(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } }</code> </pre> <br>  A linha 100 √© respons√°vel por verificar a extens√£o do arquivo: se for php ou phtm, o arquivo ser√° descartado e n√£o ser√° salvo.  Portanto, os arquivos php n√£o aparecem no diret√≥rio "files / images /".  A linha 115 cria o erro que vemos, mas n√£o faz nada com o arquivo. <br><br>  Bem, n√£o vamos deixar a explora√ß√£o e fazer upload do arquivo com a extens√£o .shtml.  Aqui vale a pena fazer uma pequena digress√£o e dizer o que √© .shtml e o que √© comido. <br><br><h4>  SHTML e SSI </h4><br>  Defini√ß√£o da Wikipedia: <br><br>  SSI (Server Side Include - inclus√£o no servidor) - uma linguagem simples para a "montagem" din√¢mica de p√°ginas da Web no servidor a partir dos componentes individuais e a entrega do documento HTML recebido ao cliente.  Implementado no servidor da web Apache usando o m√≥dulo mod_include.  O recurso inclu√≠do nas configura√ß√µes padr√£o do servidor da Web permite incluir arquivos HTML; portanto, para usar as instru√ß√µes, o arquivo deve terminar com a extens√£o .shtml, .stm ou .shtm. <br><br>  Com suas pr√≥prias palavras: <br><br>  SHTML √© um HTML que pode executar conjuntos de instru√ß√µes do lado do servidor.  Das √∫teis, h√° uma fun√ß√£o exec que executa comandos arbitr√°rios no servidor (sim, podemos fazer o download do arquivo usando o c√≥digo HTML e execut√°-lo). <br><br>  Aqui est√° um c√≥digo de amostra para executar um c√≥digo arbitr√°rio: <br><br><pre> <code class="php hljs">&lt;!--<span class="hljs-comment"><span class="hljs-comment">#exec cmd=‚Äùls‚Äù --&gt;</span></span></code> </pre> <br>  A boa not√≠cia √© que essa funcionalidade n√£o est√° ativada por padr√£o no servidor Apache2 e, para ativ√°-la, voc√™ precisa dan√ßar com um pandeiro.  Algumas horas depois de escolher a configura√ß√£o, consegui fazer o retorno das vari√°veis ‚Äã‚Äãde ambiente funcionar, mas n√£o o comando.  Aqui est√° o meu c√≥digo SSI: <br><br><pre> <code class="php hljs">&lt;html&gt; &lt;head&gt; &lt;title&gt;thegeekstuff.com&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; Today is &lt;!--<span class="hljs-comment"><span class="hljs-comment">#echo var="DATE_LOCAL" --&gt; &lt;!--#exec cmd="ls" --&gt; &lt;/p&gt; &lt;/body&gt; &lt;/html&gt;  : Today is Wednesday, 14-Nov-2018 17:29:14 MSK [an error occurred while processing this directive]</span></span></code> </pre><br>  Se algu√©m lhe disser o que escrever na configura√ß√£o para que funcione corretamente, eu adoraria l√™-la. <br><br><h4>  Explorar vulnerabilidade </h4><br>  Se as estrelas convergirem, voc√™ poder√° fazer o download do arquivo shtml e executar comandos arbitr√°rios (ou, como eu, ver a hora no servidor). <br><br><h4>  Assistindo o patch </h4><br>  A pr√≥xima vers√£o √© 7.2.6, mas n√£o h√° altera√ß√µes em rela√ß√£o √† vulnerabilidade em que estamos interessados ‚Äã‚Äã(nist.gov novamente enganado). <br><br>  Observamos a vers√£o 7.2.7 e parece que tudo est√° consertado (os pr√≥prios desenvolvedores dizem que tudo est√° consertado apenas nesta vers√£o).  H√° duas altera√ß√µes principais: <br><br>  1. Entre as extens√µes proibidas, "shtm" foi adicionado (se os 4 primeiros caracteres forem assim, o shtml tamb√©m cai aqui): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) {</code> </pre> <br><br>  2. Arquivos que n√£o s√£o imagens agora s√£o exclu√≠dos: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); kill($uploadfile); }</code> </pre> <br>  Parece que voc√™ pode divergir, porque as n√£o imagens s√£o exclu√≠das e o shtml nem sequer tenta persistir.  Mas eu sempre n√£o gostei se eles tentassem resolver um problema com listas negras.  Por exemplo, em alguns pa√≠ses, as empresas pro√≠bem as redes sociais.  Isso leva ao fato de os usu√°rios come√ßarem a usar os "espelhos" das redes sociais, onde seus nomes de usu√°rio e senhas s√£o roubados.  Suas senhas coincidem com senhas corporativas, mas pode haver problemas muito maiores do que um funcion√°rio folheando um instagram com uma x√≠cara de caf√©. <br><br>  Na programa√ß√£o da web e em sua seguran√ßa, as listas negras tamb√©m s√£o m√°s. <br><br><h4>  Ignore a lista negra do ProjeQtOr </h4><br>  Bem, tudo √© simples.  Primeiro, vamos ver quais arquivos o Apache2 + PHP pode interpretar nas configura√ß√µes padr√£o (tudo foi instalado no ubuntu 16.04 com um reposit√≥rio atualizado).  A diretiva "FilesMatch" √© respons√°vel pela capacidade de interpretar arquivos.  N√≥s fazemos uma pesquisa nele com o comando ‚Äúgrep -r" &lt;FilesMatch "/ etc / apache2" e aqui est√° o resultado: <br><br><pre> <code class="php hljs">/etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.ph(p[3457]?|t|tml)$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.phps$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ph(p[3457]?|t|tml|ps)$"</span></span>&gt; /etc/apache2/sites-available/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl.conf: &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.(cgi|shtml|phtml|php)$"</span></span>&gt; /etc/apache2/apache2.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ht"</span></span>&gt;</code> </pre> <br>  Na configura√ß√£o default-ssl.conf, todas as extens√µes s√£o simplesmente listadas na √≠ntegra; s√£o elas: cgi, shtml, phtml, php.  Infelizmente, tudo, exceto o cgi, √© filtrado no ProjeQtOr. <br><br>  A configura√ß√£o do php7.0.conf √© muito mais interessante, pois as extens√µes s√£o definidas pela express√£o regular.  Temos: <br><table><tbody><tr><th>  Extens√£o </th><th>  O que √© filtrado </th></tr><tr><td>  php </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php3 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php4 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php5 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php7 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  pht </td><td>  NADA </td></tr><tr><td>  phtml3 </td><td>  substr ($ ext, 0.4) == 'phtm' </td></tr></tbody></table><br>  √ìtimo, uma extens√£o de arquivo que n√£o √© filtrada foi encontrada.  Verificamos que √© realmente interpretado. <br><br>  Crie um arquivo test.pht com o seguinte conte√∫do: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br>  Vamos a este arquivo no navegador e vemos informa√ß√µes sobre o php instalado.  Notavelmente, a lista negra foi ignorada, enquanto nas configura√ß√µes n√£o padr√£o, por algum motivo, outras extens√µes de interpreta√ß√£o podem ser permitidas. <br><br>  Carregamos nosso arquivo de teste na ferramenta de gerenciamento de projetos ProjeQtOr.  Obviamente, obtemos um erro, porque isso n√£o √© uma imagem (na vers√£o anterior √† 7.2.7, j√° temos execu√ß√£o de c√≥digo no servidor, porque mudar o phpinfo para executar comandos n√£o √© dif√≠cil).  Na vers√£o 7.2.7, o arquivo √© exclu√≠do e o c√≥digo n√£o √© executado. <br><br>  Mas n√£o estamos chateados e ignoramos a verifica√ß√£o da imagem. <br><br><h4>  Imagem PHP </h4><br>  A verifica√ß√£o se o arquivo baixado √© uma imagem na Ferramenta de Gerenciamento de Projetos ProjeQtOr √© feita pela fun√ß√£o getimagesize, que simplesmente olha para o cabe√ßalho do arquivo transferido. <br><br>  Aproveitando o fato de que pode haver qualquer lixo no arquivo php, e a interpreta√ß√£o do c√≥digo php come√ßa apenas com os caracteres ‚Äú&lt;? Php‚Äù, escrevemos um pequeno c√≥digo que primeiro grava a imagem e depois o c√≥digo php de que precisamos.  Como imagem, enviaremos uma captura de tela da janela de erro.  3 linhas de c√≥digo python e pronto: <br><br><pre> <code class="python hljs">data = open (<span class="hljs-string"><span class="hljs-string">'test.png'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() data += open (<span class="hljs-string"><span class="hljs-string">'test.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() open (<span class="hljs-string"><span class="hljs-string">'new_pht_png.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'wb'</span></span>).write(data)</code> </pre> <br>  Provavelmente, voc√™ pode simplesmente escrever um cabe√ßalho de imagem v√°lido no in√≠cio do arquivo, mas √© mais f√°cil e, mais ainda, a imagem √© exibida em qualquer visualizador. <br><br>  Carregamos essa cria√ß√£o no servidor e, eis que ela √© carregada (e exibida no visualizador como uma imagem), e tamb√©m √© bom mostrar o nome completo com o qual esse arquivo foi carregado. <br><br><img src="https://habrastorage.org/webt/xi/px/mh/xipxmhyuzvcaqbxl28pcrrezd1q.png"><br><br>  Vamos para o arquivo baixado <a href="">localhost / files / images / 20181114171730_1_new_pht_png.pht</a> e vemos a imagem baixada como texto e a sa√≠da phpinfo abaixo dela.  √â claro que substituir o phpinfo por um simples shell da web n√£o √© dif√≠cil.  Por exemplo, isto: &lt;? Php system ($ _ GET ['cmd']); <br><br><img src="https://habrastorage.org/webt/m-/kv/ad/m-kvadznv4ev99yge_zwwsgzf6m.png"><br><br>  Depois de come√ßar a escolher downloads de arquivos, √© necess√°rio concluir o trabalho e ver onde mais h√° um download de arquivos com ou sem listas negras. <br><br><h4>  Outro upload de arquivo </h4><br>  Vamos assistir na vers√£o mais recente dispon√≠vel.  Supondo que voc√™ use a mesma fun√ß√£o para fazer upload de arquivos como antes, ou seja,  move_uploaded_file, procuramos por ele no diret√≥rio do projeto ‚Äúgrep -r‚Äú move_uploaded_file ‚Äù./‚Äù.  Obtemos os seguintes 5 arquivos: <br><br>  ./tool/uploadImage.php <br>  ./tool/saveDocumentVersion.php <br>  ./tool/uploadPlugin.php <br>  ./tool/import.php <br>  ./tool/saveAttachment.php <br><br>  Arquivo uploadImage.php - j√° olhou. <br>  Arquivo saveDocumentVersion.php - baixa vers√µes de documentos (como o nome indica).  Estamos tentando fazer o download de um documento e analis√°-lo (para come√ßar, sempre carregaremos uma foto).  Ap√≥s o download, vemos que a extens√£o .1 √© adicionada ao arquivo.  Examinamos no c√≥digo como o nome √© obtido (isso √© feito na linha 229): <br><br><pre> <code class="php hljs">$uploadfile = $dv-&gt;getUploadFileName();</code> </pre> <br>  A fun√ß√£o getUploadFileName √© declarada no arquivo DocumentVersionMain.php.  L√°, na linha 227, vemos que "." √â adicionado ao nome retornado.  e ID do documento.  N√£o podemos contornar nem mesmo o ponto adicional: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $uploaddir . $paramPathSeparator . $fileName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id;</code> </pre> <br>  O arquivo uploadPlugin.php pode ser acessado apenas por administradores e o fato de o plug-in ter um c√≥digo incorreto √© muito l√≥gico e dif√≠cil de se livrar sem a necessidade de inserir a valida√ß√£o do plug-in (como fazem o CMS popular).  Obviamente, quando voc√™ tenta fazer o download de algo l√°, ele carrega com sucesso e √© executado. <br><br>  O arquivo import.php tamb√©m est√° dispon√≠vel apenas para administradores.  Ao baixar um arquivo, somos informados de que ele deve ser um arquivo csv ou xlsx.  Obviamente, tentamos carregar o arquivo php e vemos um erro: <br><br><h4>  ERRO - O tipo de arquivo fornecido e o formato de arquivo selecionado n√£o correspondem </h4><br>  Importa√ß√£o anulada <br><br>  O problema √© que, como no bug original do CVE, o arquivo n√£o √© exclu√≠do, mas permanece dispon√≠vel em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">localhost / files / attach / import / import / test.php</a> . <br><br>  O arquivo saveAttachment √© usado ao carregar anexos (por exemplo, ao carregar sua pr√≥pria imagem).  O script PHP n√£o rastreia para l√°, pois h√° uma prote√ß√£o do formul√°rio: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) { $attachment‚ÜífileName.=<span class="hljs-string"><span class="hljs-string">".projeqtor"</span></span>;</code> </pre> <br>  verifica-se nos arquivos de extens√£o php *, phtm *, shtm * a extens√£o ".projeqtor" √© adicionada, ou seja, obviamente nosso arquivo pht rastrear√° at√© l√° (mesmo sem rastrear as imagens).  Tentamos e obtemos tudo no endere√ßo <a href="">localhost / files / attach / attachment_1 / test.pht</a> . <br><br>  Resultado total de cinco locais de download de arquivos encontrados rapidamente: <br><br><ul><li>  conseguiu carregar o script php ou pht 4 vezes; </li><li>  a valida√ß√£o da lista negra √© de dois; </li><li>  a valida√ß√£o da lista branca n√£o est√° em lugar nenhum; </li><li>  uma vez falhou ao baixar o arquivo (falhou ao baixar, mas falhou ao executar), porque  expans√£o estava mudando </li></ul><br><h3>  Conclus√µes sobre a ferramenta de gerenciamento de projetos ProjeQtOr e o CVE-2018-18924 </h3><br><br><ul><li>  a vulnerabilidade relatada foi praticamente eliminada; </li><li>  existem outras vulnerabilidades no c√≥digo (relatadas aos desenvolvedores e eles at√© prometeram listas brancas de extens√µes); </li><li>  a configura√ß√£o adequada do servidor Apache2 pode nos salvar de tudo (limitar os formatos execut√°veis ‚Äã‚Äãapenas ao necess√°rio, proibir a execu√ß√£o de scripts nas pastas do usu√°rio); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O nist.gov</a> n√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cont√©m</a> a vers√£o vulner√°vel mais recente. </li></ul><br><h3>  Nota de amante </h3><br><ul><li>  recusar listas negras sempre que poss√≠vel (n√£o sei onde isso √© imposs√≠vel); </li><li>  tenha cuidado e aten√ß√£o ao processar os arquivos baixados (√© melhor que ele esteja em um s√≥ lugar e n√£o se espalhe por 5); </li><li>  um servidor da Web configurado corretamente evita muitos problemas no c√≥digo do projeto (√© importante escrever o c√≥digo e configurar bem o servidor). </li></ul><br><h3>  Resposta detalhada dos desenvolvedores </h3><br>  A primeira resposta dos desenvolvedores foi algo como "consertamos tudo, ent√£o veja o c√≥digo corrigido".  Eu tive que pintar detalhadamente onde est√£o alguns problemas e como eles podem ser explorados. <br><br>  Ent√£o ele recebeu uma resposta detalhada: ‚ÄúSim, existem problemas e eles ser√£o corrigidos na vers√£o 7.3.0.  Tamb√©m ser√£o adicionadas listas brancas para imagens para xlslx e csv. ‚Äù  Eles tamb√©m escreveram que t√™m uma recomenda√ß√£o para adicionar os diret√≥rios "anexos" e "documentos" fora do acesso √† Web nas instru√ß√µes de instala√ß√£o. <br><br>  Os desenvolvedores me permitiram registrar o CVE e escrever um artigo ap√≥s a atualiza√ß√£o (que saiu e est√° dispon√≠vel para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">download</a> ). <br><br><h3>  Conclus√£o </h3><br>  Como eu escrevi no come√ßo, algumas pessoas baixaram a atualiza√ß√£o que decidiu o CVE (mais de 500 downloads), e √© legal que as pessoas atualizem seu software vulner√°vel, mas √© triste que o software permane√ßa vulner√°vel. <br><br>  Como resultado, quatro CVEs foram atribu√≠das a mim e √† nossa empresa: CVE-2018-19307, CVE-2018-19308, CVE-2018-19309, CVE-2018-19310. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430408/">https://habr.com/ru/post/pt430408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430398/index.html">Como entender que voc√™ n√£o √© bem-vindo ou discutir m√©todos para afastar trabalhadores da empresa</a></li>
<li><a href="../pt430400/index.html">Experi√™ncia no uso de um h√≠brido de teclado e mouse na programa√ß√£o</a></li>
<li><a href="../pt430402/index.html">O que o developer.android.com n√£o menciona sobre o RecyclerView?</a></li>
<li><a href="../pt430404/index.html">Coletamos dados sobre o comportamento do cliente no site</a></li>
<li><a href="../pt430406/index.html">C ++ 20 e M√≥dulos, Redes, Coroutines, Intervalos, Gr√°ficos. Resultados da reuni√£o em San Diego</a></li>
<li><a href="../pt430410/index.html">‚ÄúSempre ter√° que se desenvolver‚Äù: uma entrevista com Evgeny Kuvshinov (ManyChat) sobre o desenvolvimento em uma startup</a></li>
<li><a href="../pt430412/index.html">L√≥gica difusa contra PID. Atravessamos o ouri√ßo e a cobra. Motor de aeronave e algoritmos de controle da NPP</a></li>
<li><a href="../pt430414/index.html">DevOps do Azure para Commodore 64?</a></li>
<li><a href="../pt430418/index.html">Experi√™ncia pessoal usando sensores de proximidade em desenvolvimento</a></li>
<li><a href="../pt430420/index.html">Confer√™ncia "Conte√∫do" - agora com suporte para hyper-threading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>