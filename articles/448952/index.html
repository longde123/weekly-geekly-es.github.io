<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôáüèº üë®üèø‚Äçüé§ üì∂ Configure IPSec VPN de sitio a sitio en hardware de redes de Palo Alto üîê üôéüèΩ üë¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo es una continuaci√≥n del material anterior sobre las caracter√≠sticas de la configuraci√≥n del equipo de Palo Alto Networks . Aqu√≠ queremos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configure IPSec VPN de sitio a sitio en hardware de redes de Palo Alto</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/crosstech/blog/448952/"><img src="https://habrastorage.org/getpro/habr/post_images/a2c/68c/d7c/a2c68cd7c6cbac21b84a65f55eb7dd33.png" alt="imagen"><br><br>  Este art√≠culo es una continuaci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">material anterior</a> sobre las caracter√≠sticas de la configuraci√≥n del equipo de <b>Palo Alto Networks</b> .  Aqu√≠ queremos hablar sobre la configuraci√≥n de <b>VPN de sitio a sitio IPSec</b> en equipos de <b>Palo Alto Networks</b> y sobre una posible opci√≥n de configuraci√≥n para conectar varios proveedores de Internet. <br><a name="habracut"></a><br>  Para la demostraci√≥n, se utilizar√° el esquema est√°ndar de conectar la oficina central a la sucursal.  Para proporcionar una conexi√≥n a Internet tolerante a fallas, la oficina central utiliza la conexi√≥n simult√°nea de dos proveedores: ISP-1 e ISP-2.  La sucursal tiene una conexi√≥n con un solo proveedor, ISP-3.  Entre los cortafuegos PA-1 y PA-2, se construyen dos t√∫neles.  Los t√∫neles funcionan en modo de <b>espera activa</b> , el t√∫nel 1 est√° activo, el t√∫nel 2 comenzar√° a transmitir tr√°fico cuando el t√∫nel 1 falle.  Tunnel-1 usa una conexi√≥n con el proveedor de servicios de Internet ISP-1, Tunnel-2 usa una conexi√≥n con el proveedor de servicios de Internet ISP-2.  Todas las direcciones IP se generan aleatoriamente con fines de demostraci√≥n y no est√°n relacionadas con la realidad. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/312/8a1/67b/3128a167bfa98d8aed104e6e1e85ef22.png" alt="imagen"><br><br>  Para construir una VPN de sitio a sitio, se utilizar√° <b>IPSec</b> , un conjunto de protocolos para proteger los datos transmitidos a trav√©s de IP.  <b>IPSec</b> funcionar√° utilizando el protocolo de seguridad <b>ESP</b> (Encapsulating Security Payload), que proporcionar√° cifrado de los datos transmitidos. <br><br>  <b>IPSec</b> incluye <b>IKE</b> (Internet Key Exchange), el protocolo responsable de negociar los par√°metros de seguridad SA (asociaciones de seguridad) que se utilizan para proteger los datos transmitidos.  Los firewalls PAN admiten <b>IKEv1</b> e <b>IKEv2</b> . <br><br>  En <b>IKEv1</b> VPN, la conexi√≥n se construye en dos etapas: <b>IKEv1 Fase 1</b> (t√∫nel IKE) e <b>IKEv1 Fase 2</b> (t√∫nel IPSec), por lo que se crean dos t√∫neles, uno de los cuales sirve para el intercambio de informaci√≥n de servicio entre firewalls, y el segundo para la transmisi√≥n de tr√°fico.  Hay dos modos de funcionamiento en <b>IKEv1 Fase 1</b> : modo principal y modo agresivo.  El modo agresivo usa menos mensajes y es m√°s r√°pido, pero no admite la Protecci√≥n de identidad de pares. <br><br>  <b>IKEv2</b> reemplaza a <b>IKEv1</b> , y en comparaci√≥n con <b>IKEv1,</b> su principal ventaja es que requiere menos ancho de banda y una negociaci√≥n de SA m√°s r√°pida.  <b>IKEv2</b> usa menos mensajes de servicio (4 en total), admite el protocolo EAP, MOBIKE y agrega un mecanismo de verificaci√≥n de disponibilidad de pares con el que se crea un t√∫nel: <b>Liveness Check</b> , que reemplaza la detecci√≥n de pares muertos en IKEv1.  Si la prueba falla, <b>IKEv2</b> puede restablecer el t√∫nel y luego recuperarse autom√°ticamente lo antes posible.  Puedes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">leer</a> m√°s sobre las diferencias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Si el t√∫nel se construye entre cortafuegos de diferentes fabricantes, puede haber errores en la implementaci√≥n de <b>IKEv2</b> , y para la compatibilidad con dicho equipo es posible usar <b>IKEv1</b> .  En otros casos, es mejor usar <b>IKEv2</b> . <br><br>  Pasos de configuraci√≥n: <br><br>  <b>‚Ä¢ Configuraci√≥n de dos proveedores de Internet en modo Activo \ En espera</b> <br><br>  Hay varias formas de implementar esta caracter√≠stica.  Una de ellas es utilizar el mecanismo de <b>Monitoreo de ruta</b> , que est√° disponible desde <b>PAN-OS 8.0.0</b> .  Este ejemplo usa la versi√≥n 8.0.16.  Esta caracter√≠stica es similar a IP SLA en los enrutadores Cisco.  En el par√°metro de la ruta est√°tica predeterminada, se configura el env√≠o de paquetes de ping a una direcci√≥n IP espec√≠fica desde una direcci√≥n de origen espec√≠fica.  En este caso, la interfaz ethernet1 / 1 hace ping a la puerta de enlace predeterminada una vez por segundo.  Si no hay respuesta a tres pings seguidos, la ruta se considera inoperante y se elimina de la tabla de enrutamiento.  La misma ruta se configura en la direcci√≥n del segundo proveedor de Internet, pero con m√°s m√©tricas (es una copia de seguridad).  Tan pronto como se elimine la primera ruta de la tabla, el firewall comenzar√° a enviar tr√°fico a lo largo de la segunda ruta: <b>conmutaci√≥n por error</b> .  Cuando el primer proveedor comienza a responder a los pings, su ruta volver√° a la tabla y reemplazar√° al segundo debido a la mejor m√©trica: <b>Fail-Back</b> .  El proceso de <b>conmutaci√≥n por error</b> tarda varios segundos dependiendo de los intervalos configurados, pero, en cualquier caso, el proceso no es instant√°neo y en este momento se pierde el tr√°fico.  <b>Fail-Back</b> pasa sin p√©rdida de tr√°fico.  Es posible hacer una <b>conmutaci√≥n por error m√°s</b> r√°pida utilizando <b>BFD</b> , si su ISP proporciona esta opci√≥n.  <b>BFD es</b> compatible a partir de la serie <b>PA-3000</b> y <b>VM-100</b> .  Como la direcci√≥n para hacer ping, es mejor especificar no la puerta de enlace del proveedor, sino una direcci√≥n de Internet p√∫blica y siempre accesible. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/459/47f/546/45947f5469df67a6ecd315180779465b.png" alt="imagen"><br><br>  <b>‚Ä¢ Crear una interfaz de t√∫nel</b> <br><br>  El tr√°fico dentro del t√∫nel se transmite a trav√©s de interfaces virtuales especiales.  Cada uno de ellos debe configurarse con una direcci√≥n IP de la red de tr√°nsito.  En este ejemplo, la subred 172.16.1.0/30 se usar√° para el T√∫nel-1 y la subred 172.16.2.0/30 se usar√° para el T√∫nel-2. <br>  La interfaz del t√∫nel se crea en la secci√≥n <b>Red -&gt; Interfaces -&gt; T√∫nel</b> .  Debe especificar el enrutador virtual y la zona de seguridad, as√≠ como la direcci√≥n IP de la red de transporte correspondiente.  El n√∫mero de interfaz puede ser cualquiera. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b06/a3d/08e/b06a3d08e1ee5088b23f5196aae51d3f.png" alt="imagen"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/13f/9e5/5b6/13f9e55b6855207fc6bc8c2be69657c7.png" alt="imagen"><br><br>  En la secci√≥n <b>Avanzado</b> , puede especificar un <b>Perfil de administraci√≥n</b> que permita hacer ping a esta interfaz, esto puede ser √∫til para las pruebas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b67/f4d/47a/b67f4d47a922bdf70f010be46f3e3fe2.png" alt="imagen"><br><br>  <b>‚Ä¢ Configurar el perfil IKE</b> <br><br>  <b>El perfil IKE</b> es responsable del primer paso para crear una conexi√≥n VPN; aqu√≠, se especifican los par√°metros del t√∫nel <b>IKE Fase 1</b> .  El perfil se crea en la secci√≥n <b>Red -&gt; Perfiles de red -&gt; IKE Crypto</b> .  Debe especificar el algoritmo de cifrado, el hash, el grupo Diffie-Hellman y la vida de la clave.  En general, cuanto m√°s complejos son los algoritmos, peor es el rendimiento; deben seleccionarse en funci√≥n de los requisitos de seguridad espec√≠ficos.  Sin embargo, no se recomienda utilizar el grupo Diffie-Hellman por debajo de 14 para proteger informaci√≥n importante.  Esto se debe a la vulnerabilidad del protocolo, que solo puede nivelarse usando un tama√±o de m√≥dulo de 2048 bits o m√°s, o algoritmos de criptograf√≠a el√≠ptica, que se usan en los grupos 19, 20, 21, 24. Estos algoritmos son m√°s productivos que la criptograf√≠a tradicional.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s detalles aqu√≠</a> .  Y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqui</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ff/18a/d04/3ff18ad0457e792f86045d8b42534e39.png" alt="imagen"><br><br>  <b>‚Ä¢ Configurar el perfil IPSec</b> <br><br>  El segundo paso para crear una conexi√≥n VPN es el t√∫nel IPSec.  Los par√°metros SA para √©l se configuran en <b>Red -&gt; Perfiles de red -&gt; IPSec Crypto Profile</b> .  Aqu√≠ debe especificar el protocolo IPSec - <b>AH</b> o <b>ESP</b> , as√≠ como los par√°metros <b>SA</b> - hashing, algoritmos de cifrado, grupos Diffie-Hellman y vida √∫til de la clave.  Es posible que la configuraci√≥n de SA en IKE Crypto Profile y IPSec Crypto Profile no coincida. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b38/5e2/30c/b385e230c1548d0c65f6b8d7ead35b29.png" alt="imagen"><br><br>  <b>‚Ä¢ Configurar la puerta de enlace IKE</b> <br><br>  <b>Una puerta de enlace IKE</b> es un objeto que identifica el enrutador o firewall con el que se construye un t√∫nel VPN.  Para cada t√∫nel, debe crear su propia <b>puerta de enlace IKE</b> .  En este caso, se crean dos t√∫neles, uno a trav√©s de cada proveedor de Internet.  Se indica la interfaz de salida correspondiente y su direcci√≥n IP, direcci√≥n IP de igual y clave com√∫n.  Puede usar certificados como alternativa a una clave compartida. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a56/251/b36/a56251b36a69840ec730e50568e690e8.png" alt="imagen"><br><br>  Esto indica el <b>perfil criptogr√°fico IKE</b> creado anteriormente.  Los par√°metros para el segundo objeto <b>IKE Gateway</b> son similares, con la excepci√≥n de las direcciones IP.  Si el cortafuegos de Palo Alto Networks est√° ubicado detr√°s de un enrutador NAT, entonces el mecanismo de <b>transversal NAT</b> debe estar habilitado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23b/3cc/da8/23b3ccda8c845371f4bd4e7efd41a7ea.png" alt="imagen"><br><br>  <b>‚Ä¢ Configurar el t√∫nel IPSec</b> <br><br>  <b>El t√∫nel IPSec</b> es un objeto que especifica los par√°metros del t√∫nel IPSec, como su nombre lo indica.  Aqu√≠ debe especificar la interfaz del t√∫nel y los objetos de <b>perfil criptogr√°fico IPSec</b> <b>Gateway</b> creados previamente.  Para garantizar el cambio autom√°tico de enrutamiento al t√∫nel en espera, debe habilitar <b>Tunnel Monitor</b> .  Este es un mecanismo que verifica si un par est√° vivo usando el tr√°fico ICMP.  Como direcci√≥n de destino, debe especificar la direcci√≥n IP de la interfaz del t√∫nel del par con el que se est√° construyendo el t√∫nel.  El perfil indica los temporizadores y la acci√≥n en caso de p√©rdida de conexi√≥n.  <b>Wait Recover</b> : espere hasta que se restablezca la conexi√≥n, <b>Fail Over</b> : env√≠e el tr√°fico en otra ruta, si corresponde.  La configuraci√≥n del segundo t√∫nel es completamente la misma; se indican la interfaz del segundo t√∫nel y la puerta de enlace IKE. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fdb/29c/f75/fdb29cf75864f4fcf0ca5ec1d7459dc4.png" alt="imagen"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/96c/330/1cb/96c3301cb47e3dcbb449f5174227532a.png" alt="imagen"><br><br>  <b>‚Ä¢ Configuraci√≥n de enrutamiento</b> <br><br>  Este ejemplo usa enrutamiento est√°tico.  En el firewall PA-1, adem√°s de dos rutas predeterminadas, debe especificar dos rutas a la subred 10.10.10.0/24 en la rama.  Una ruta usa Tunnel-1, la otra Tunnel-2.  La ruta a trav√©s del T√∫nel-1 es b√°sica porque tiene una m√©trica m√°s baja.  No se utiliza el mecanismo de <b>supervisi√≥n de ruta</b> para estas rutas.  <b>Tunnel Monitor</b> es responsable del cambio. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f94/b4f/3ed/f94b4f3ed8ce6c2d44af95ebfaf3c1b1.png" alt="imagen"><br><br>  Las mismas rutas para la subred 192.168.30.0/24 deben configurarse en PA-2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bdd/a93/ffb/bdda93ffb9dc17d0765d7e6cf78515ad.png" alt="imagen"><br><br>  <b>‚Ä¢ Configurar reglas de red</b> <br><br>  Para que el t√∫nel funcione, necesita tres reglas: <br><br><ol><li>  Para que <b>Path Monitor</b> funcione, habilite ICMP en interfaces externas. </li><li>  Para <b>IPSec,</b> habilite las aplicaciones <b>ike</b> e <b>ipsec</b> en interfaces externas. </li><li>  Permitir tr√°fico entre subredes internas e interfaces de t√∫nel. </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/157/271/34a/15727134adc31c0260c32ef6c2768248.png" alt="imagen"><br><br>  <b>Conclusi√≥n</b> <br><br>  Este art√≠culo describe la configuraci√≥n de una conexi√≥n a Internet a prueba de fallas y una <b>VPN de sitio a sitio</b> .  Esperamos que la informaci√≥n haya sido √∫til, y el lector tenga una idea de las tecnolog√≠as utilizadas en las <b>redes de Palo Alto</b> .  Si tiene preguntas sobre la personalizaci√≥n y sugerencias sobre los temas de futuros art√≠culos, escr√≠balas en los comentarios, estaremos encantados de responder. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/448952/">https://habr.com/ru/post/448952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448940/index.html">Dell Latitude 5491: una robusta laptop corporativa con un potente procesador</a></li>
<li><a href="../448942/index.html">Criptomoneda: ¬øvive o muere?</a></li>
<li><a href="../448944/index.html">Fluido 1.0: sistema de localizaci√≥n flexible</a></li>
<li><a href="../448946/index.html">C√≥mo comenzar a aplicar R en Enterprise. Ejemplo pr√°ctico</a></li>
<li><a href="../448950/index.html">Navaja suiza json</a></li>
<li><a href="../448956/index.html">Ira por el c√≥digo: programadores y negatividad</a></li>
<li><a href="../448958/index.html">C√≥mo Amazon elige sus ofertas aparentemente aleatorias del d√≠a. ¬øY por qu√© los vendedores los persiguen tanto?</a></li>
<li><a href="../448960/index.html">Tecnolog√≠a XR ilimitada en la era de la computaci√≥n distribuida</a></li>
<li><a href="../448962/index.html">La efectividad del embudo de marketing AARRR</a></li>
<li><a href="../448964/index.html">La tostadora brinda a los usuarios m√°s derechos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>