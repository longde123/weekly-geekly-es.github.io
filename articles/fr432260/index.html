<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâüèæ üë∏ ‚èπÔ∏è Modification des param√®tres globaux sur les serveurs de commandes locaux de l'infrastructure √† l'aide de Gitlab CI et d'Ansible [Concept] üìâ üë©üèΩ‚Äçüè≠ üë®üèº‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article d√©crit la capacit√© / id√©e / concept de modifier les param√®tres globaux sur les serveurs de commande locaux dans une grande infrastructure ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modification des param√®tres globaux sur les serveurs de commandes locaux de l'infrastructure √† l'aide de Gitlab CI et d'Ansible [Concept]</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432260/"><hr><br><p>  Cet article d√©crit la capacit√© / id√©e / concept de modifier les param√®tres globaux sur les serveurs de commande locaux dans une grande infrastructure √† l'aide de Gitlab CI et Ansible. </p><br><p>  Disons que vous avez 20 √©quipes de d√©veloppement et 1 √©quipe admin / DevOps.  Comment changer les mots de passe administrateur sur tous les serveurs?  Comment ajouter un certificat racine d'entreprise √† tous les serveurs?  Etc. </p><a name="habracut"></a><br><h2 id="kakuyu-zadachu-reshaet">  Quel probl√®me r√©sout-il? </h2><br><p>  Situation typique: <br>  Il existe des administrateurs / DevOps mondiaux. <br>  Il existe des param√®tres globaux (NTP, DNS, proxy, etc.) <br>  Il existe des √©quipes de d√©veloppement locales: TeamA, TeamB, TeamC, TeamD, etc. <br>  Il y a des d√©veloppeurs qui ne peuvent aller que sur les serveurs de leur √©quipe. <br>  Comment ajouter / mettre √† jour des administrateurs globaux, des param√®tres globaux? </p><br><p><img src="https://habrastorage.org/webt/hh/n6/sa/hhn6sal6fyuse2qaei0nefh9ta4.png"></p><br><p>  La t√¢che est compliqu√©e par le fait que les param√®tres globaux sont stock√©s s√©par√©ment des param√®tres de commande locaux dans des r√©f√©rentiels priv√©s. </p><br><p>  Si vous avez peu de serveurs dans toute l'entreprise, vous pouvez d√©marrer Ansible dans un mode simple - commencer √† mettre √† jour les administrateurs globaux et les param√®tres globaux sur tous les serveurs √† la fois. </p><br><p>  Pour les grandes installations, les entreprises utilisent g√©n√©ralement Puppet, Chef. </p><br><h2 id="koncepciya">  Concept </h2><br><p>  Pour modifier les param√®tres globaux des serveurs de commande locaux dans une grande infrastructure, je propose un m√©canisme de sous-module git. </p><br><p>  Le r√©f√©rentiel avec des param√®tres locaux utilise des sous-modules git avec des param√®tres globaux. </p><br><p>  Vous trouverez ci-dessous un diagramme sch√©matique de connexion d'un r√©f√©rentiel priv√© avec des param√®tres globaux √† des r√©f√©rentiels de commandes locaux. </p><br><p><img src="https://habrastorage.org/webt/sr/cd/3c/srcd3cupezpf06nq7tzn4njhlfm.png"></p><br><p>  Vous pouvez utiliser le concept de mise √† jour des param√®tres globaux √† l'aide du sous-module git dans l'infrastructure avec Puppet, Chef, Salt, mais l'article fournit un exemple avec Ansible. </p><br><p>  Par exemple, installez tomcat, mysql, nginx et appliquez-leur des param√®tres globaux dans une √©quipe appel√©e team. </p><br><p>  Il existe un groupe commun dans gitlab qui contient les param√®tres g√©n√©raux. </p><br><p>  Dans le groupe commun, il existe un projet d'amor√ßage de base qui contient des administrateurs, des param√®tres sysctl, etc. </p><br><p>  Habituellement, dans une entreprise, il existe plusieurs d√©partements de d√©veloppement - plus souvent, ils sont appel√©s √©quipes. </p><br><p>  Dans gitlab, cr√©ez un groupe d'√©quipe (vous aurez votre propre nom d'√©quipe). </p><br><p>  Dans le groupe d'√©quipe, nous cr√©ons des projets: application, base de donn√©es, √©quilibreur de charge. </p><br><p>  Capture d'√©cran de base-bootstrap, application, base de donn√©es, √©quilibreur de charge: </p><br><p><img src="https://habrastorage.org/webt/ty/1v/q9/ty1vq9atrxvq9h6ifjrkw1jdgge.png"></p><br><p>  Le r√©f√©rentiel base-bootstrap est inclus en tant que sous-module git dans le r√©f√©rentiel d'application, de base de donn√©es et d'√©quilibrage de charge. </p><br><p>  Chaque fois que l'application, la base de donn√©es et l'√©quilibreur de charge du r√©f√©rentiel commencent √† mettre √† jour le sous-module de d√©marrage de base. </p><br><p>  Apr√®s cela, ansible-playbook de base-bootstrap et ansible-playbook de base-bootstrap sont appliqu√©s aux serveurs d'applications, de bases de donn√©es et d'√©quilibreurs de charge. </p><br><p><img src="https://habrastorage.org/webt/np/ym/0j/npym0jnwchybipoarkbbejqztgo.png"></p><br><p>  Autrement dit, si vous ajoutez un nouvel administrateur √† base-bootstrap ou modifiez les param√®tres syst√®me dans base-bootstrap, puis avec l'application, la base de donn√©es, l'√©quilibreur de charge, les nouveaux param√®tres de base-bootstrap sont appliqu√©s √† l'application, la base de donn√©es, l'√©quilibreur de charge. </p><br><h2 id="podgotovka">  La pr√©paration </h2><br><p>  Vous devriez lire des articles sur Ansible pour les d√©butants: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Impossible de commencer</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Guide Ansible</a> </p><br><p>  Vous devez avoir d√©ploy√© gitlab et gitlab-runner avec docker install√©. </p><br><p>  L'ex√©cuteur Docker est utilis√© comme exemple ici - vous pouvez utiliser l'ex√©cuteur Shell. </p><br><p>  Comment d√©ployer gitlab et gitlab-runner: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Article de Southbridge Gitlab-CI</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Int√©gration et d√©ploiement continus de Docker dans GitLab CI</a> </p><br><p>  Vous devez avoir 3 serveurs (par exemple, sur ubuntu): application, base de donn√©es, √©quilibreur de charge. </p><br><p>  Application, base de donn√©es, √©quilibreur de charge sont des noms courants. </p><br><p>  Tous les exemples peuvent √™tre d√©velopp√©s, am√©lior√©s, utilis√©s par d'autres logiciels - l'article montre le principe g√©n√©ral. </p><br><h3 id="kak-realizovat">  Comment mettre en ≈ìuvre </h3><br><p>  Les r√©f√©rentiels et tout le code du test peuvent √™tre r√©cup√©r√©s ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/patsevanton/ansible-gitlab-habr</a> </p><br><p>  Si vous allez sur le serveur en utilisant le nom d'utilisateur / mot de passe, alors dans le groupe souhait√© (dans ce cas, l'√©quipe) cr√©ez la variable userpassword (lorsque vous changez, vous devez √©galement changer la variable dans le code aussi) et sp√©cifiez le mot de passe l√† (le mot de passe du mot de passe est utilis√© dans le code) </p><br><p>  N'oubliez pas de cr√©er l'utilisateur n√©cessaire avec les droits sudo sur les serveurs finaux (le code utilisateur est utilis√© dans le code). </p><br><p>  Pour ceux qui se rendent sur le serveur √† l'aide des cl√©s SSH, vous devez cr√©er la variable SSH_PRIVATE_KEY dans le groupe d'√©quipe et y ajouter la cl√© priv√©e de l'utilisateur qui se connectera au serveur. </p><br><p>  Il s'agit d'un exemple simple de connexion aux serveurs, les probl√®mes de s√©curit√© ne sont donc pas trait√©s dans cet article. </p><br><p>  Dans chaque r√©f√©rentiel (application, base de donn√©es, √©quilibreur de charge) cr√©ez un sous-module git: </p><br><pre><code class="plaintext hljs">git submodule add git@gitlab.example.com:common/base-bootstrap.git git submodule add git@gitlab.example.com:team/team-users.git</code> </pre> <br><p>  Un sous-module est n√©cessaire pour acc√©der au r√©f√©rentiel priv√© partag√©. </p><br><p>  Dans notre cas, il s'agit du r√©f√©rentiel avec les param√®tres g√©n√©raux de base-bootstrap et du r√©f√©rentiel d'utilisateurs de l'√©quipe team-users. </p><br><p>  O√π gitlab.example.com est votre serveur gitlab. </p><br><p>  Ensuite, dans .gitmodules, nous changeons le chemin d'acc√®s au r√©f√©rentiel en relatif </p><br><p>  Un exemple: </p><br><pre> <code class="plaintext hljs">[submodule "team-users"] path = team-users url = ../team-users.git [submodule "base-bootstrap"] path = base-bootstrap url = ../../common/base-bootstrap.git</code> </pre> <br><p>  Dans chaque r√©f√©rentiel dans les h√¥tes, nous changeons l'IP en notre propre, dans ansible.cfg nous changeons remote_user en notre utilisateur. </p><br><p>  Si vous n'avez effectu√© aucune validation au cours des derni√®res heures / jours et que vous devez d√©ployer de nouvelles modifications g√©n√©rales sur les serveurs (par exemple, vous devez ajouter un nouvel administrateur) - pour de telles situations, il y a une suppression ansible. </p><br><p>  Configurez ansible-pull pour t√©l√©charger le r√©f√©rentiel common / base-bootstrap. </p><br><p>  Pour ce faire, ajoutez le r√©f√©rentiel de jetons de d√©ploiement. </p><br><p>  Acc√©dez au r√©f√©rentiel common / base-bootstrap, puis acc√©dez √† settings / repository / Deploy Tokens. </p><br><p>  Cr√©ez un jeton.  Le nom d'utilisateur et le mot de passe r√©sultants sont enregistr√©s dans base-bootstrap / vars / cron.yml. </p><br><p>  Apr√®s avoir v√©rifi√© que tout fonctionne correctement, je pense que cela vaut la peine de changer l'heure de d√©but du tirage ansible de "toutes les 2 minutes" √† celle qui vous convient. </p><br><p>  Si ansible-pull est tomb√©, cela signifie que l'IC de ce service va chuter, ce qui d√©marre chaque fois que vous vous engagez dans ce r√©f√©rentiel de service (disons que le service est appel√© application) </p><br><h2 id="proverka">  V√©rifier </h2><br><h3 id="sozdanie-novogo-administratora">  Cr√©ez un nouvel administrateur. </h3><br><p>  Essayez d'ajouter un nouvel administrateur √† <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/users.yml</a> </p><br><h3 id="izmenenie-sysctl">  Changement de syst√®me </h3><br><p>  Essayez d'ajouter / de modifier les param√®tres sysctl dans <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/sysctl.yml</a> </p><br><h3 id="dobavlenie-zapisey-v-cron">  Ajout d'entr√©es √† cron </h3><br><p>  Essayez d'ajouter des entr√©es cron √† <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/commons/base-bootstrap/vars/cron.yml</a> </p><br><h2 id="rasshirenie-ili-ustanovka-vashih-prilozheniy">  Extension ou installation de vos applications </h2><br><p>  Vous devez d'abord trouver un r√¥le pour installer vos applications. </p><br><p>  Acc√©dez √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://galaxy.ansible.com/</a> et recherchez le r√¥le pour installer votre application. </p><br><p>  Essayez d'installer votre application en utilisant le r√¥le √† partir de la console sur vos serveurs.  En r√®gle g√©n√©rale, tous les r√¥les ont des instructions dans les descriptions. </p><br><p>  Par exemple, essayez d'installer java √† c√¥t√© de tomcat.  Installez d'abord le r√¥le geerlingguy.java </p><br><pre> <code class="plaintext hljs">ansible-galaxy install geerlingguy.java</code> </pre> <br><p>  Cr√©ez le fichier ansible.cfg standard de la m√™me mani√®re que les r√©f√©rentiels. </p><br><p>  Cr√©ez un inventaire: </p><br><pre> <code class="plaintext hljs">[java] java ansible_host=IP-</code> </pre> <br><p>  Cr√©er un playbook java.yml </p><br><pre> <code class="plaintext hljs">- hosts: java become: yes vars_files: - vars/main.yml roles: - { role: geerlingguy.java }</code> </pre> <br><p>  Ex√©cutez ansible-playbook java.yml </p><br><p>  Si tout s'est bien pass√©, ajoutez au projet souhait√© (dans ce cas l'application) </p><br><p>  Le r√¥le de geerlingguy.java est ajout√© apr√®s le r√¥le de robertdebock.tomcat <a href="">https://github.com/patsevanton/ansible-gitlab-habr/blob/master/team/application/tomcat-app.yml#L11</a> </p><br><p>  Il en va de m√™me pour toutes les autres applications que vous devez installer sur le serveur. </p><br><h2 id="testirovanie-playbook-i-bezopasnost">  Test et s√©curit√© du Playbook </h2><br><p>  Pour simplifier l'article, le probl√®me du stockage et du test des mots de passe n'est pas r√©solu. </p><br><p>  Il y a des articles sur le test du playbook: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Ansible: tester les playbooks (partie 1)</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># Test et int√©gration continue pour les r√¥les Ansible avec Molecule et Jenkins</a> </p><br><h2 id="otvety-na-voprosy">  R√©ponses aux questions </h2><br><p>  1) Mentat: Et pourquoi, apr√®s tout, n'est-ce pas ainsi que c'est √©crit dans le dock ansible, avec les environnements?  D√®s la premi√®re lecture, cela ressemble √† une tentative de tout r√©inventer.  Il est tout √† fait pratique d'appliquer tout cela comme ansible-playbook -i env / teamA personalAPlaybook.yml <br>  R√©ponse: ce sch√©ma permet de modifier les param√®tres globaux.  Ce qui est d√©crit dans la question est la modification des param√®tres locaux des commandes. </p><br><p>  PS La m√™me fonctionnalit√© est peut-√™tre impl√©ment√©e dans Ansible Tower.  Mais je ne peux rien dire √† ce sujet - je n'ai pas travaill√© avec Ansible Tower. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432260/">https://habr.com/ru/post/fr432260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432248/index.html">T√¢che d'analyse par mise en page (sass, pug, gulp, bem)</a></li>
<li><a href="../fr432250/index.html">Rust News # 3 (novembre 2018)</a></li>
<li><a href="../fr432252/index.html">Comment gagner plus dans le secteur informatique en Russie?</a></li>
<li><a href="../fr432256/index.html">Aggravation de l'automne: comment les pirates RTM ont lanc√© une attaque massive contre les banques et les entreprises au nom des agences gouvernementales</a></li>
<li><a href="../fr432258/index.html">U-NOVUS 2018: atelier</a></li>
<li><a href="../fr432262/index.html">Nous fabriquons notre carte son USB avec isolation galvanique</a></li>
<li><a href="../fr432264/index.html">GitLab 11.5 publi√© avec des panneaux de contr√¥le pour les op√©rateurs et les sp√©cialistes de la s√©curit√© et du contr√¥le d'acc√®s GitLab Pages</a></li>
<li><a href="../fr432268/index.html">Comment transformer un client en donn√©es: nous changeons la vid√©osurveillance et l'analyse vid√©o pour le commerce de d√©tail</a></li>
<li><a href="../fr432270/index.html">HappySecretSantaBot - Bot t√©l√©gramme pour le jeu "Secret Santa"</a></li>
<li><a href="../fr432272/index.html">Comment nous pr√©parons les magasins pour la nouvelle ann√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>