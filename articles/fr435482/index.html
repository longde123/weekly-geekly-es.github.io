<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüåæ ü§ú ü§∞üèΩ Zircon Highlight: vDSO (Virtual Dynamic Shared Object) ü§õüèø üâë ‚öíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zircon? Qu'est ce que c'est 


 En ao√ªt 2016, sans aucune annonce officielle de Google, les sources du nouveau syst√®me d'exploitation ont √©t√© d√©couver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Zircon Highlight: vDSO (Virtual Dynamic Shared Object)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435482/"><h2 id="zircon-chto-eto">  Zircon?  Qu'est ce que c'est </h2><br><p>  En ao√ªt 2016, sans aucune annonce officielle de Google, les sources du nouveau syst√®me d'exploitation ont √©t√© d√©couvertes <img src="https://habrastorage.org/webt/s3/vk/vq/s3vkvqkdg0wsatckxecdfekkdyk.png">  Fuchsia.  Cet OS est bas√© sur un micro-noyau appel√© Zircon, qui √† son tour est bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LK (Little Kernel)</a> . </p><br><blockquote>  Fuchsia n'est pas Linux </blockquote><br><div class="spoiler">  <b class="spoiler_title">Notes du traducteur</b> <div class="spoiler_text"><p>  Je ne <del>  vrai soudeur </del>  Je suis d√©veloppeur et / ou expert chez Zircon.  Le texte sous la coupe est une <em>compilation de</em> traductions partielles: la <a href="">documentation officielle de Zircon vDSO</a> et l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Admiring the Zircon Part 1: Understanding Minimal Process Creation</a> by <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@depletionmode</a> , o√π un petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gag a</a> √©t√© ajout√© (qui a √©t√© supprim√© pour les spoilers).  Par cons√©quent, comme toujours, les suggestions constructives pour am√©liorer l'article sont les bienvenues. </p></div></div><br><h2 id="o-chem-poydet-rech-v-state">  De quoi sera discut√© dans l'article? </h2><br><p>  vDSO dans Zircon est le <strong>seul</strong> moyen d'acc√©der aux <a href="">appels syst√®me (appels syst√®me)</a> . </p><br><p>  Est-il vraiment impossible d'appeler directement les instructions du processeur SYSENTER / SYSCALL √† partir de notre code?  Non, ces instructions de processeur ne font pas partie du syst√®me ABI.  Le code utilisateur est interdit de suivre directement ces instructions. </p><br><p>  Ceux qui veulent en savoir plus sur une telle √©tape architecturale, je vous invite √† Cat. </p><br><p><img src="https://habrastorage.org/webt/ns/64/h3/ns64h3y_inuxdxyycmdcmedcjba.png"></p><a name="habracut"></a><br><h2 id="zircon-vdso-virtual-dynamic-shared-object">  Zircon vDSO (Virtual Dynamic Shared Object) </h2><br><p>  L'acronyme vDSO signifie <strong>V</strong> irtual <strong>D</strong> ynamic <strong>S</strong> hared <strong>O</strong> bject: </p><br><ul><li>  Dynamic Shared Object est un terme utilis√© pour faire r√©f√©rence aux biblioth√®ques partag√©es pour le format ELF (fichiers .so). </li><li>  Cet objet est virtuel car il ne se charge pas √† partir d'un fichier s√©par√© existant sur le syst√®me de fichiers.  L'image vDSO est fournie directement par le noyau. </li></ul><br><h2 id="podderzhka-so-storony-yadra">  Prise en charge du noyau </h2><br><p>  La prise en charge de vDSO en tant que seul ABI contr√¥l√© pour les applications en mode utilisateur est impl√©ment√©e de deux mani√®res: </p><br><ol><li><p> Projection d'un objet m√©moire virtuelle ( <a href="">VMO, Virtual Memory Object</a> ). <br><br>  Lorsque <a href="">zx_vmar_map</a> traite VMO pour vDSO (et <code>ZX_VM_PERM_EXECUTE</code> demand√© dans les arguments), le noyau exige que le d√©calage et la taille correspondent strictement au segment ex√©cutable vDSO.  Cela (y compris) ne garantit qu'une seule projection vDSO dans la m√©moire de processus.  Apr√®s la premi√®re projection r√©ussie de vDSO dans le processus, il ne peut plus √™tre supprim√©.  Et une tentative de re-projeter vDSO dans la m√©moire de processus, les tentatives de suppression du VMO projet√© pour vDSO ou le projet avec le d√©calage et / ou la taille incorrects √©chouent avec l'erreur <code>ZX_ERR_ACCESS_DENIED</code> . <br>  Le d√©calage et la taille du code vDSO sont extraits au stade de la compilation √† partir du fichier ELF puis utilis√©s dans le code du noyau pour effectuer les v√©rifications ci-dessus.  Apr√®s la premi√®re projection vDSO r√©ussie, le noyau du syst√®me d'exploitation se souvient de l'adresse du processus cible afin d'acc√©l√©rer les v√©rifications. </p><br></li><li><p>  V√©rifiez les adresses de retour pour les fonctions d'appel syst√®me. <br><br>  Lorsque le code en mode utilisateur appelle le noyau, un num√©ro d'appel syst√®me de bas niveau est transmis dans le registre.  Les appels syst√®me de bas niveau sont l'interface interne (priv√©e) entre vDSO et le noyau Zircon.  Certains (la plupart) correspondent directement aux appels syst√®me de l'ABI public, d'autres non. <br>  Pour chaque appel syst√®me de bas niveau dans le code vDSO, il existe un ensemble fixe de d√©calages dans le code qui effectuent cet appel.  Le code source de vDSO d√©finit des caract√®res internes qui identifient chacun de ces emplacements.  Au moment de la compilation, ces emplacements sont extraits de la table des symboles vDSO et utilis√©s pour g√©n√©rer du code noyau qui d√©termine la pr√©diction de la validit√© de l'adresse de code pour chaque appel syst√®me de bas niveau.  Ces pr√©dicats vous permettent de v√©rifier rapidement la validit√© du code appelant, compte tenu du d√©calage par rapport au d√©but du segment de code vDSO. <br>  S'il est d√©termin√© par le pr√©dicat que le code appelant n'est pas autoris√© √† effectuer un appel syst√®me, une exception synth√©tique est lev√©e, tout comme si le code appelant tentait d'ex√©cuter une instruction inexistante ou privil√©gi√©e. </p><br></li></ol><br><h2 id="vdso-pri-sozdanii-novogo-processa">  vDSO lors de la cr√©ation d'un nouveau processus </h2><br><p>  Pour d√©marrer l'ex√©cution du premier thread d'un processus nouvellement cr√©√©, l' <a href="">appel</a> syst√®me <a href="">zx_process_start</a> est <a href="">utilis√©</a> .  Le dernier param√®tre de cet appel syst√®me (voir arg2 dans la documentation) transmet l'argument du premier thread du processus cr√©√©.  Selon l'accord accept√©, le chargeur de programme mappe vDSO √† l'espace d'adressage du nouveau processus (√† un endroit al√©atoire s√©lectionn√© par le syst√®me) et transf√®re l'adresse de base du mappage avec l'argument arg2 au premier thread du processus cr√©√©.  Cette adresse est l'adresse d'en-t√™te du fichier ELF, √† laquelle les fonctions nomm√©es n√©cessaires peuvent √™tre trouv√©es pour effectuer des appels syst√®me. </p><br><h2 id="karta-pamyati-layout-vdso">  Carte m√©moire (mise en page) vDSO </h2><br><p>  vDSO est une biblioth√®que partag√©e EFL r√©guli√®re qui peut √™tre consid√©r√©e comme n'importe quelle autre.  Mais pour vDSO, un petit sous-ensemble de l'ensemble du format ELF est intentionnellement s√©lectionn√©.  Cela pr√©sente plusieurs avantages: </p><br><ul><li>  Le mappage d'un tel ELF dans le processus est simple et n'inclut pas de cas limites complexes qui sont n√©cessaires pour soutenir pleinement les programmes ELF. </li><li>  L'utilisation de vDSO ne n√©cessite pas de liaison ELF dynamique enti√®rement fonctionnelle.  En particulier, vDSO n'a pas de d√©localisations dynamiques.  La projection de segments PT_LOAD d'un fichier ELF est la seule action requise. </li><li>  Le code vDSO est sans √©tat et r√©entrant.  Il fonctionne exclusivement avec les registres du processeur et la pile.  Cela le rend appropri√© pour une utilisation dans une grande vari√©t√© de contextes avec des restrictions minimales, ce qui est conforme au syst√®me d'exploitation ABI obligatoire.  Il simplifie √©galement l'analyse et la v√©rification du code pour la fiabilit√© et la s√©curit√©. </li></ul><br><p>  Toute la m√©moire vDSO est repr√©sent√©e par deux segments cons√©cutifs, chacun contenant des pages enti√®res align√©es: </p><br><ol><li>  Le premier segment est en lecture seule et comprend des en-t√™tes ELF ainsi que des donn√©es constantes. </li><li>  Le deuxi√®me segment est ex√©cutable et contient du code vDSO. </li></ol><br><p>  L'image vDSO enti√®re se compose uniquement des pages de ces deux segments.  Seules deux valeurs extraites des en-t√™tes ELF sont requises pour afficher la m√©moire vDSO: le nombre de pages dans chaque segment. </p><br><h2 id="konstantnye-dannye-vremeni-zagruzki-os">  Donn√©es de constante de temps de d√©marrage du syst√®me d'exploitation </h2><br><p>  Certains appels syst√®me renvoient simplement des valeurs constantes (les valeurs doivent √™tre demand√©es au moment de l'ex√©cution et ne peuvent pas √™tre compil√©es en code en mode utilisateur).  Ces valeurs sont soit fix√©es dans le noyau au moment de la compilation, soit d√©termin√©es par le noyau au d√©marrage (param√®tres de d√©marrage et param√®tres mat√©riels).  Par exemple: <a href="">zx_system_get_version ()</a> , <a href="">zx_system_get_num_cpus ()</a> et <a href="">zx_ticks_per_second ()</a> .  La valeur de retour de la derni√®re fonction, par exemple, est affect√©e par le param√®tre de <a href="">ligne de commande</a> du <a href="">noyau</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Attendez, le nombre de CPU est-il constant?</b> <div class="spoiler_text"><p>  Fait int√©ressant, la description de la fonction <a href="">zx_system_get_num_cpus ()</a> indique √©galement explicitement que le syst√®me d'exploitation ne prend pas en charge le <a href="">remplacement √† chaud du</a> nombre de processeurs: </p><br><blockquote>  Ce nombre ne peut pas changer pendant une ex√©cution du syst√®me, uniquement au d√©marrage. </blockquote><p>  Cela, au moins, indique indirectement que le syst√®me d'exploitation n'est pas positionn√© en tant que serveur. </p></div></div><br><p>  √âtant donn√© que ces valeurs sont constantes, cela n'a aucun sens de payer pour des appels syst√®me r√©els vers le noyau du syst√®me d'exploitation.  Au lieu de cela, leur impl√©mentation est de simples fonctions C ++ qui renvoient des donn√©es lues √† partir du segment constant vDSO.  Les valeurs captur√©es lors de la compilation (telles que la cha√Æne de version du syst√®me) sont simplement compil√©es dans vDSO. </p><br><p>  Pour les valeurs d√©termin√©es au d√©marrage, le noyau doit modifier le contenu de vDSO.  Cela se fait √† l'aide d'un code ex√©cutable au d√©but qui forme le VMO vDSO avant que le noyau ne d√©marre le premier processus utilisateur (et lui transmette le descripteur VMO).  Lors de la compilation, les d√©calages de l'image vDSO ( <a href="">vdso_constants</a> ) sont extraits du fichier ELF puis int√©gr√©s au noyau.  Et au d√©marrage, le noyau affiche temporairement des pages couvrant <a href="">vdso_constants</a> dans son propre espace d'adressage pour pr√©-initialiser la structure avec les valeurs correctes (pour le d√©marrage actuel du syst√®me). </p><br><h2 id="k-chemu-vsya-eta-golovnaya-bol">  Pourquoi tout ce <em>mal de t√™te</em> ? </h2><br><p>  L'une des raisons les plus importantes est la s√©curit√©.  Autrement dit, si un attaquant parvient √† ex√©cuter du code (shell-) arbitraire, il devra utiliser des fonctions vDSO pour appeler des fonctions syst√®me.  Le premier obstacle sera la randomisation susmentionn√©e de l'adresse de d√©marrage vDSO pour chaque processus cr√©√©.  Et puisque le noyau du syst√®me d'exploitation est responsable du VMO (objet de m√©moire virtuelle) de vDSO, il peut choisir de mapper un vDSO compl√®tement diff√©rent √† un processus sp√©cifique, interdisant ainsi les appels syst√®me dangereux (et non n√©cessaires pour un processus particulier).  Par exemple: vous pouvez emp√™cher les <a href="">pilotes de</a> g√©n√©rer des processus enfants ou g√©rer la projection de zones MMIO.  C'est un excellent outil pour r√©duire la surface d'attaque. </p><br><p>  Remarque: Actuellement, la prise en charge de plusieurs vDSO est activement d√©velopp√©e.  Il existe d√©j√† une impl√©mentation de preuve de concept et des tests simples, mais davantage de travail est n√©cessaire pour am√©liorer la fiabilit√© de l'impl√©mentation et d√©terminer les options disponibles.  Le concept actuel fournit des options d'image vDSO qui n'exportent qu'un sous-ensemble de l'interface d'appel syst√®me vDSO compl√®te. </p><br><div class="spoiler">  <b class="spoiler_title">Qu'en est-il des autres syst√®mes d'exploitation?</b> <div class="spoiler_text"><p>  Il convient de noter que des techniques similaires ont d√©j√† √©t√© utilis√©es avec succ√®s dans d'autres syst√®mes d'exploitation.  Par exemple, sous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windows, il existe un ProcessSystemCallDisablePolicy</a> : </p><br><blockquote>  Restriction de d√©sactivation des appels syst√®me Win32k pour restreindre la possibilit√© d'utiliser NTUser et GDI </blockquote></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435482/">https://habr.com/ru/post/fr435482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435466/index.html">Tutoriel React Partie 6: Quelques fonctionnalit√©s du cours, JSX et JavaScript</a></li>
<li><a href="../fr435468/index.html">Tutoriel React, partie 7: styles en ligne</a></li>
<li><a href="../fr435470/index.html">Tutoriel React, Partie 8: Poursuite des travaux sur une application TODO, pr√©sentation des propri√©t√©s des composants</a></li>
<li><a href="../fr435476/index.html">Mkcert: certificats HTTPS valides pour localhost</a></li>
<li><a href="../fr435480/index.html">Microsoft et Kroger vont combattre Amazon dans le domaine ... le commerce des aliments</a></li>
<li><a href="../fr435484/index.html">Style de fuzz 1989</a></li>
<li><a href="../fr435488/index.html">Mocks, stubs and spies in the Spock Framework</a></li>
<li><a href="../fr435490/index.html">Modifications fiscales de Google en 2019</a></li>
<li><a href="../fr435494/index.html">Serveur client transparent</a></li>
<li><a href="../fr435496/index.html">Tesla poursuivi pour un accident dans lequel le conducteur et le passager de la Model S sont morts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>