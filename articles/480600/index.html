<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úåÔ∏è üëÉüèø üë©üèæ‚Äçüî¨ Enum m√°s r√°pido üéñÔ∏è ‚≠ïÔ∏è üöá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="tl; dr 
 github.com/QratorLabs/fastenum 


pip install fast-enum  
 ¬øQu√© son las enumeraciones? 
 (Si cree que lo sabe, despl√°cese hacia abajo hasta l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Enum m√°s r√°pido</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/480600/"><h4>  tl; dr </h4><br>  <a href="https://github.com/QratorLabs/fastenum">github.com/QratorLabs/fastenum</a> <br><pre><code class="bash hljs">pip install fast-enum</code> </pre> <br><h3>  ¬øQu√© son las enumeraciones? </h3><br>  (Si cree que lo sabe, despl√°cese hacia abajo hasta la secci√≥n "Enums en la biblioteca est√°ndar"). <br><br>  Imagine que necesita describir un conjunto de todos los estados posibles para las entidades en su modelo de base de datos.  Probablemente usar√° un mont√≥n de constantes definidas como atributos de nivel de m√≥dulo: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># /path/to/package/static.py: INITIAL = 0 PROCESSING = 1 PROCESSED = 2 DECLINED = 3 RETURNED = 4 ...</span></span></code> </pre> <br>  ... o como atributos de nivel de clase definidos en su propia clase: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModelStates</span></span></span><span class="hljs-class">:</span></span> INITIAL = <span class="hljs-number"><span class="hljs-number">0</span></span> PROCESSING = <span class="hljs-number"><span class="hljs-number">1</span></span> PROCESSED = <span class="hljs-number"><span class="hljs-number">2</span></span> DECLINED = <span class="hljs-number"><span class="hljs-number">3</span></span> RETURNED = <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Eso lo ayuda a referirse a esos estados por sus nombres mnemot√©cnicos, mientras persisten en su almacenamiento como enteros simples.  Con esto, se deshace de los n√∫meros m√°gicos dispersos a trav√©s de su c√≥digo y lo hace m√°s legible y descriptivo. <br><br>  Pero, tanto la constante de nivel de m√≥dulo como la clase con los atributos est√°ticos adolecen de la naturaleza inherente de los objetos de python: todos son mutables.  Puede asignar accidentalmente un valor a su constante en tiempo de ejecuci√≥n, y eso es un desastre para depurar y revertir sus entidades rotas.  Por lo tanto, es posible que desee que su conjunto de constantes sea inmutable, lo que significa que tanto el n√∫mero de constantes declaradas como los valores a los que est√°n asignados no deben modificarse en tiempo de ejecuci√≥n. <br><a name="habracut"></a><br>  Para este prop√≥sito, podr√≠a intentar organizarlos en tuplas con nombre con <code>namedtuple()</code> , como ejemplo: <br><pre> <code class="python hljs">MyModelStates = namedtuple(<span class="hljs-string"><span class="hljs-string">'MyModelStates'</span></span>, (<span class="hljs-string"><span class="hljs-string">'INITIAL'</span></span>, <span class="hljs-string"><span class="hljs-string">'PROCESSING'</span></span>, <span class="hljs-string"><span class="hljs-string">'PROCESSED'</span></span>, <span class="hljs-string"><span class="hljs-string">'DECLINED'</span></span>, <span class="hljs-string"><span class="hljs-string">'RETURNED'</span></span>)) EntityStates = MyModelStates(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre> <br>  Sin embargo, esto todav√≠a no parece demasiado comprensible: adem√°s de eso, los objetos con nombre de <code>namedtuple</code> no son realmente extensibles.  Digamos que tiene una interfaz de usuario que muestra todos estos estados.  Luego puede usar sus constantes basadas en m√≥dulos, su clase con los atributos o tuplas con nombre para representarlas (las dos √∫ltimas son m√°s f√°ciles de procesar, mientras estamos en ello).  Pero su c√≥digo no brinda ninguna oportunidad para darle al usuario una descripci√≥n adecuada de cada estado que haya definido.  Adem√°s, si planea implementar soporte multiling√ºe e i18n en su interfaz de usuario, encontrar√° que completar todas las traducciones de estas descripciones se convierte en una tarea incre√≠blemente tediosa.  Es posible que los valores de estado coincidentes no tengan necesariamente descripciones coincidentes, lo que significa que no puede simplemente asignar todos sus estados <code>INITIAL</code> a la misma descripci√≥n en <code>gettext</code> .  En cambio, su constante se convierte en esto: <br><pre> <code class="python hljs">INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'My_MODEL_INITIAL_STATE'</span></span>)</code> </pre> <br>  Tu clase se convierte en esto: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModelStates</span></span></span><span class="hljs-class">:</span></span> INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>)</code> </pre> <br>  Y finalmente, tu <code>namedtuple</code> convierte en esto: <br><pre> <code class="python hljs">EntityStates = MyModelStates((<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>), ...)</code> </pre><br>  Bueno, lo suficientemente bueno, ahora se asegura de que tanto el valor de estado como el c√≥digo auxiliar de traducci√≥n est√©n asignados a los idiomas admitidos por su IU.  Pero ahora puede notar que el c√≥digo que usa esas asignaciones se ha convertido en un desastre.  Siempre que intente asignar un valor a su entidad, tampoco debe olvidar extraer el valor en el √≠ndice 0 de la asignaci√≥n que utiliza: <br><br><pre> <code class="python hljs">my_entity.state = INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre>  o <pre> <code class="python hljs">my_entity.state = MyModelStates.INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre>  o <pre> <code class="python hljs">my_entity.state = EntityStates.INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  Y as√≠ sucesivamente.  Tenga en cuenta que los primeros dos enfoques que usan constantes y atributos de clase, respectivamente, a√∫n sufren de mutabilidad. <br><br><h4>  Y luego Enums viene al escenario </h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyEntityStates</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Enum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, val, description)</span></span></span><span class="hljs-function">:</span></span> self.val = val self.description = description INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>) PROCESSING = (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_BEING_PROCESSED_STATE'</span></span>) PROCESSED = (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_PROCESSED_STATE'</span></span>) DECLINED = (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_DECLINED_STATE'</span></span>) RETURNED = (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_RETURNED_STATE'</span></span>)</code> </pre> <br>  Eso es todo  Ahora podr√≠a iterar f√°cilmente la enumeraci√≥n en su renderizador (sintaxis Jinja2): <br><pre> <code class="python hljs">{% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MyEntityState %} &lt;option value=‚Äù{{ state.val }}‚Äù&gt;{{ _(state.description) }}&lt;/option&gt; {% endfor %}</code> </pre> <br>  Enum es inmutable tanto para el conjunto de miembros (no puede definir un nuevo miembro en tiempo de ejecuci√≥n, ni puede eliminar un miembro ya definido) y los valores de miembro que mantienen (no puede reasignar ning√∫n valor de atributo ni eliminar un atributo). <br><br>  En su c√≥digo, simplemente asigna valores a sus entidades de esta manera: <br><pre> <code class="python hljs">my_entity.state = MyEntityStates.INITIAL.val</code> </pre> <br>  Bueno, lo suficientemente claro.  Autodescriptivo.  Bastante extensible.  Para eso utilizamos Enums. <br><br><h3>  ¬øPor qu√© es m√°s r√°pido? </h3><br>  Pero el ENUM predeterminado es bastante lento, as√≠ que nos preguntamos: ¬øpodr√≠amos hacerlo m√°s r√°pido? <br>  Resulta que s√≠ podemos.  A saber, es posible hacerlo: <br><br><ul><li>  3 veces m√°s r√°pido en el acceso de miembros </li><li>  ~ 8.5 veces m√°s r√°pido en el acceso al atributo ( <code>name</code> , <code>value</code> ) </li><li>  3 veces m√°s r√°pido en el acceso enum por valor (llame a la clase <code>MyEnum(value)</code> enum) </li><li>  1.5 veces m√°s r√°pido en el acceso enum por nombre (dict-like <code>MyEnum[name]</code> ) </li></ul><br>  Los tipos y objetos son din√°micos en Python.  Pero Python tiene las herramientas para limitar la naturaleza din√°mica de los objetos.  Con su ayuda, se puede obtener un aumento significativo del rendimiento utilizando <code>__slots__</code> , as√≠ como evitar el uso de descriptores de datos cuando sea posible sin un crecimiento de complejidad significativo o si puede obtener beneficios en la velocidad. <br><br><h4>  Tragamonedas </h4><br>  Por ejemplo, uno podr√≠a usar una declaraci√≥n de clase con <code>__slots__</code> ; en este caso, las instancias de clase solo tendr√≠an un conjunto restringido de atributos: atributos declarados en <code>__slots__</code> y todos los <code>__slots__</code> de clases primarias. <br><br><h4>  Descriptores </h4><br>  Por defecto, el int√©rprete de Python devuelve un valor de atributo de un objeto directamente: <br><pre> <code class="python hljs">value = my_obj.attribute <span class="hljs-comment"><span class="hljs-comment"># this is a direct access to the attribute value by the pointer that the object holds for that attribute</span></span></code> </pre> <br>  De acuerdo con el modelo de datos de Python, si el valor del atributo de un objeto es en s√≠ mismo un objeto que implementa el Protocolo Descriptor de Datos, significa que cuando intentas obtener ese valor, primero obtienes el atributo como un objeto y luego un m√©todo especial <code>__get__</code> es invoc√≥ a ese atributo-objeto que pasa el objeto guardi√°n como argumento: <br><pre> <code class="python hljs">obj_attribute = my_obj.attribute obj_attribute_value = obj_attribute.__get__(my_obj)</code> </pre> <br><h4>  Enums en la biblioteca est√°ndar </h4><br>  Al menos los atributos de <code>name</code> y <code>value</code> de la implementaci√≥n est√°ndar de Enum se declaran como <code>types.DynamicClassAttribute</code> .  Eso significa que cuando intenta obtener el <code>name</code> (o <code>value</code> ) de un miembro, el flujo es el siguiente: <br><br><pre> <code class="python hljs">one_value = StdEnum.ONE.value <span class="hljs-comment"><span class="hljs-comment"># that is what you write in your code one_value_attribute = StdEnum.ONE.value one_value = one_value_attribute.__get__(StdEnum.ONE)</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># and this is what really __get__ does (python 3.7 implementation): def __get__(self, instance, ownerclass=None): if instance is None: if self.__isabstractmethod__: return self raise AttributeError() elif self.fget is None: raise AttributeError("unreadable attribute") return self.fget(instance)</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># since DynamicClassAttribute is a decorator on Enum methods `name` and `value` the final row of __get__() ends up with: @DynamicClassAttribute def name(self): """The name of the Enum member.""" return self._name_ @DynamicClassAttribute def value(self): """The value of the Enum member.""" return self._value_</span></span></code> </pre> <br>  Entonces, el flujo completo podr√≠a representarse como el siguiente pseudoc√≥digo: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(enum_member, attrname)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># this is also a __dict__ lookup so hash + hashtable scan also occur return getattr(enum_member, f'_{attrnme}_') def get_name_value(enum_member): name_descriptor = get_descriptor(enum_member, 'name') if enum_member is None: if name_descriptor.__isabstractmethod__: return name_descriptor raise AttributeError() elif name_descriptor.fget is None: raise AttributeError("unreadable attribute") return get_func(enum_member, 'name')</span></span></code> </pre> <br>  Hemos creado un script simple que demuestra la conclusi√≥n anterior: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Enum <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StdEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Enum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value, description)</span></span></span><span class="hljs-function">:</span></span> self.v = value self.description = description A = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'One'</span></span> B = <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'Two'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StdEnum.A.name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PyCallGraph <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph.output <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> GraphvizOutput graphviz = GraphvizOutput(output_file=<span class="hljs-string"><span class="hljs-string">'stdenum.png'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> PyCallGraph(output=graphviz): v = get_name()</code> </pre> <br>  Y despu√©s de ejecutar el script, cre√≥ esta imagen para nosotros: <br><img src="https://habrastorage.org/webt/op/ff/m7/opffm7k3v2rgako7xufgkgqtcek.png"><br><br>  Esto demuestra que cada vez que accede al <code>name</code> y al <code>value</code> los atributos de stdlib enum, llama a un descriptor.  Ese descriptor a su vez termina con una llamada a la propiedad <code>def name(self)</code> stdlib enum decorada con el descriptor. <br><br>  Bueno, puedes comparar esto con nuestro FastEnum: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fast_enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FastEnum <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyNewEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FastEnum)</span></span></span><span class="hljs-class">:</span></span> A = <span class="hljs-number"><span class="hljs-number">1</span></span> B = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MyNewEnum.A.name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PyCallGraph <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph.output <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> GraphvizOutput graphviz = GraphvizOutput(output_file=<span class="hljs-string"><span class="hljs-string">'fastenum.png'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> PyCallGraph(output=graphviz): v = get_name()</code> </pre> <br>  Lo que genera esta imagen: <br><img src="https://habrastorage.org/webt/le/ck/td/lecktd3dtx71oi3dmlyax7qyogu.png"><br><br>  Eso es lo que realmente se hace dentro de la implementaci√≥n est√°ndar de Enum cada vez que accede a los atributos de <code>name</code> y <code>value</code> de los miembros de Enum.  Y es por eso que nuestra implementaci√≥n es m√°s r√°pida. <br><br>  <b>La implementaci√≥n de Python Standard Library de la clase Enum utiliza toneladas de llamadas de protocolo descriptor.</b>  Cuando intentamos usar la enumeraci√≥n est√°ndar en nuestros proyectos, notamos cu√°ntas llamadas al protocolo descriptor para los atributos de <code>name</code> y <code>value</code> de los miembros de <code>Enum</code> se invocaron.  Y debido a que las enumeraciones se usaron excesivamente en todo el c√≥digo, el rendimiento resultante fue deficiente. <br><br>  Adem√°s, la clase enum est√°ndar contiene un par de atributos auxiliares "protegidos": <br><ul><li>  <code>_member_names_</code> : una lista que contiene todos los nombres de los miembros de enumeraci√≥n; </li><li>  <code>_member_map_</code> : un OrderedDict que asigna un nombre de un miembro de enumeraci√≥n al miembro mismo; </li><li>  <code>_value2member_map_</code> : un diccionario inverso que asigna valores de miembros de enumeraci√≥n a los miembros de enumeraci√≥n correspondientes. </li></ul><br>  Las b√∫squedas de diccionario son lentas, ya que cada una conduce a un c√°lculo hash y una b√∫squeda de tabla hash, lo que hace que esos diccionarios no sean estructuras de base √≥ptimas para la clase enum.  Incluso la recuperaci√≥n de miembros en s√≠ (como en <code>StdEnum.MEMBER</code> ) es una b√∫squeda de diccionario. <br><br><h4>  Nuestro camino </h4><br>  Mientras desarrollamos nuestra implementaci√≥n de Enum, tuvimos en cuenta esas enumeraciones bonitas en lenguaje C y las hermosas Enums extensibles de Java.  Las principales caracter√≠sticas que quer√≠amos en nuestra implementaci√≥n: <br><br><ul><li>  un Enum debe ser lo m√°s est√°tico posible;  por "est√°tico" queremos decir: si algo se puede calcular una vez y en el momento de la declaraci√≥n, deber√≠a; </li><li>  una Enum no puede subclasificarse (debe ser una clase "final") si una subclase define nuevos miembros de enumeraci√≥n; esto es cierto para la implementaci√≥n est√°ndar de la biblioteca, con la excepci√≥n de que la subclasificaci√≥n est√° prohibida incluso si no se definieron nuevos miembros; </li><li>  un Enum deber√≠a tener grandes posibilidades de extensiones (atributos adicionales, m√©todos, etc.). </li></ul><br>  La √∫nica vez que usamos b√∫squedas de diccionario es en un <code>value</code> mapeo inverso al miembro Enum.  Todos los dem√°s c√°lculos se realizan solo una vez durante la declaraci√≥n de clase (donde los ganchos de metaclases se utilizan para personalizar la creaci√≥n de tipos). <br>  A diferencia de la implementaci√≥n est√°ndar de la biblioteca, tratamos el primer valor despu√©s del signo <code>=</code> en la declaraci√≥n de clase como el valor del miembro: <br>  <code>A = 1, 'One'</code> en la biblioteca est√°ndar enumera toda la tupla <code>1, "One"</code> se trata como <code>value</code> <br>  <code>A: 'MyEnum' = 1, 'One'</code> en nuestra implementaci√≥n solo <code>1</code> se trata como <code>value</code> <br><br>  Se acelera a√∫n m√°s mediante el uso de <code>__slots__</code> siempre que sea posible.  En el modelo de datos de Python, las clases declaradas con <code>__slots__</code> no tienen el atributo <code>__dict__</code> que contiene atributos de instancia (por lo que no puede asignar ning√∫n atributo que no se mencione en <code>__slots__</code> ).  Adem√°s, los atributos definidos en <code>__slots__</code> accedieron en desplazamientos constantes al puntero de objeto de nivel C.  Es acceso a atributos de alta velocidad, ya que evita los c√°lculos hash y los escaneos de tablas hash. <br><br><h3>  ¬øCu√°les son las ventajas adicionales? </h3><br>  FastEnum no es compatible con ninguna versi√≥n de Python anterior a 3.6, ya que utiliza excesivamente el m√≥dulo de <code>typing</code> que se introdujo en Python 3.6;  Se podr√≠a suponer que ayudar√≠a instalar un m√≥dulo de <code>typing</code> con respaldo de PyPI.  La respuesta es: no.  La implementaci√≥n utiliza PEP-484 para algunas funciones y m√©todos, argumentos y sugerencias de tipo de valor de retorno, por lo que no se admite ninguna versi√≥n anterior a Python 3.5 debido a la incompatibilidad de sintaxis.  Pero, de nuevo, la primera l√≠nea de c√≥digo en <code>__new__</code> de la metaclase usa la sintaxis PEP-526 para sugerencias de tipo variable.  Entonces Python 3.5 tampoco lo har√°.  Es posible portar la implementaci√≥n a versiones anteriores, aunque en Qrator Labs tendemos a usar sugerencias de tipo siempre que sea posible, ya que ayuda a desarrollar proyectos complejos en gran medida.  Y oye!  No desea apegarse a ninguna python anterior a 3.6 ya que no hay incompatibilidades con su c√≥digo existente (suponiendo que no est√© usando Python 2), aunque se realiz√≥ mucho trabajo en asyncio en comparaci√≥n con 3.5. <br><br>  Eso, a su vez, hace innecesarias las importaciones especiales como <code>auto</code> , a diferencia de la biblioteca est√°ndar.  Escriba una pista a todos los miembros de Enum con su nombre de clase de Enum, sin proporcionar ning√∫n valor, y el valor se generar√≠a autom√°ticamente.  Aunque python 3.6 es suficiente para trabajar con FastEnum, tenga en cuenta que el orden est√°ndar de garant√≠a de declaraci√≥n del diccionario se introdujo solo en python 3.7.  No conocemos dispositivos √∫tiles en los que el orden de valor generado autom√°ticamente sea importante (dado que asumimos que el valor generado en s√≠ mismo no es el valor que le interesa a un programador).  Sin embargo, consid√©rate advertido si sigues con Python 3.6; <br><br>  Aquellos que necesitan su enumeraci√≥n comienzan desde 0 (cero) en lugar del predeterminado 1 pueden hacerlo con un atributo especial de declaraci√≥n de enumeraci√≥n <code>_ZERO_VALUED</code> , ese atributo se "borra" de la clase Enum resultante; <br><br>  Sin embargo, existen algunas limitaciones: todos los nombres de miembros de enum deben estar CAPITALIZADOS o la metaclase no los recoger√° y no se tratar√°n como miembros de enum; <br><br>  Sin embargo, podr√≠a declarar una clase base para sus enumeraciones (tenga en cuenta que la clase base puede usar la metaclase enum, por lo que no necesita proporcionar metaclase a todas las subclases): puede definir una l√≥gica com√∫n (atributos y m√©todos) en este clase, pero puede no definir miembros de enumeraci√≥n (para que la clase no se "finalice").  Entonces podr√≠a subclasificar esa clase en tantas declaraciones enum como desee y eso le proporcionar√≠a toda la l√≥gica com√∫n; <br><br>  Alias  Los explicaremos en un tema separado (implementado en 1.2.5) <br><br><h3>  Alias ‚Äã‚Äãy c√≥mo podr√≠an ayudar </h3><br>  Supongamos que tiene un c√≥digo que usa: <br><pre> <code class="python hljs">package_a.some_lib_enum.MyEnum</code> </pre> <br>  Y que MyEnum se declara as√≠: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FastEnum)</span></span></span><span class="hljs-class">:</span></span> ONE: <span class="hljs-string"><span class="hljs-string">'MyEnum'</span></span> TWO: <span class="hljs-string"><span class="hljs-string">'MyEnum'</span></span></code> </pre> <br>  Ahora, decidi√≥ realizar algunas refactorizaciones y desea mover su enumeraci√≥n a otro paquete.  Creas algo como esto: <br><pre> <code class="python hljs">package_b.some_lib_enum.MyMovedEnum</code> </pre> <br>  Donde MyMovedEnum se declara as√≠: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyMovedEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MyEnum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br>  Ahora  Est√° listo para comenzar la etapa de "desaprobaci√≥n" de todo el c√≥digo que utiliza sus enumeraciones.  Usted desv√≠a los usos directos de <code>MyEnum</code> para usar <code>MyMovedEnum</code> (este √∫ltimo tiene todos sus miembros en proxy en <code>MyEnum</code> ).  Usted <code>MyEnum</code> dentro de los documentos de su proyecto que <code>MyEnum</code> est√° en desuso y se eliminar√° del c√≥digo en alg√∫n momento en el futuro.  Por ejemplo, en la pr√≥xima versi√≥n.  Considere que su c√≥digo guarda sus objetos con atributos de enumeraci√≥n usando pickle.  En este punto, usa <code>MyMovedEnum</code> en su c√≥digo, pero internamente todos los miembros de su enumeraci√≥n siguen siendo las instancias de <code>MyEnum</code> .  Su pr√≥ximo paso ser√≠a intercambiar declaraciones de <code>MyEnum</code> y <code>MyMovedEnum</code> para que <code>MyMovedEnum</code> ahora no sea una subclase de <code>MyEnum</code> y declare a todos sus miembros;  <code>MyEnum</code> , por otro lado, no declarar√≠a ning√∫n miembro, sino que se convertir√≠a en un alias (subclase) de <code>MyMovedEnum</code> . <br><br>  Y eso lo concluye.  En el reinicio de sus tiempos de ejecuci√≥n en la etapa de inactividad, todos sus valores de enumeraci√≥n se redirigir√°n a <code>MyMovedEnum</code> y se volver√°n a vincular a esa nueva clase.  En el momento en que est√© seguro de que todos sus objetos encurtidos han sido (re) encurtidos con esta estructura de organizaci√≥n de clase, tiene la libertad de hacer una nueva versi√≥n, donde previamente marcado como obsoleto, <code>MyEnum</code> puede declararse obsoleto y borrado de su base de c√≥digo. <br><br>  ¬°Te animamos a que lo pruebes!  <a href="https://github.com/QratorLabs/fastenum">github.com/QratorLabs/fastenum</a> , <a href="https://pypi.org/project/fast-enum/">pypi.org/project/fast-enum</a> .  Todos los cr√©ditos van al autor <a href="https://habr.com/en/users/santjagocorkez/" class="user_link">FastEnum santjagocorkez</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/480600/">https://habr.com/ru/post/480600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../480582/index.html">Security Week 51: vulnerabilidades en procesadores iOS e Intel</a></li>
<li><a href="../480584/index.html">C ++ Rusia: pasado, presente y futuro</a></li>
<li><a href="../480594/index.html">Antes y despu√©s: la evoluci√≥n visual de los videojuegos famosos</a></li>
<li><a href="../480596/index.html">Lo que te espera en el innovador sistema operativo de red ArubaOS-CX</a></li>
<li><a href="../480598/index.html">La base de cualquier programaci√≥n en ... rompecabezas</a></li>
<li><a href="../480606/index.html">Cinco ideas m√°s sobre c√≥mo actualizar sus habilidades como desarrollador front-end (diciembre de 2019)</a></li>
<li><a href="../480608/index.html">Rust supera a C ++ con los resultados del juego de referencia</a></li>
<li><a href="../480610/index.html">C ++ vtables. Parte 2 (herencia virtual + c√≥digo generado por compilador)</a></li>
<li><a href="../480612/index.html">Realice estos cambios para cumplir con los est√°ndares de accesibilidad del dise√±o web.</a></li>
<li><a href="../480614/index.html">ENUM r√°pido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>