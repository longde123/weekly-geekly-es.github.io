<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèª üõ£Ô∏è üï∏Ô∏è Comment d√©marrer un projet pour animaux de compagnie et ne pas obtenir d'avantages üë©üèø‚Äçüè´ üõå üèê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR 

 L'article d√©crit l'utilisation du projet pour animaux de compagnie comme un moyen de maintenir et d'am√©liorer les comp√©tences. L'auteur a cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment d√©marrer un projet pour animaux de compagnie et ne pas obtenir d'avantages</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479122/"><p><img src="https://habrastorage.org/webt/cz/x-/ln/czx-lnrbjewed61t5fm8k_pjvei.png" alt="Comment d√©marrer un projet pour animaux de compagnie et ne pas obtenir d'avantages"></p><br><div class="spoiler">  <b class="spoiler_title">TL; DR</b> <div class="spoiler_text"><p>  L'article d√©crit l'utilisation du projet pour animaux de compagnie comme un moyen de maintenir et d'am√©liorer les comp√©tences.  L'auteur a cr√©√© une <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">biblioth√®que PHP</a> pour installer <a href="https://fias.nalog.ru/" rel="nofollow">FIAS √†</a> partir de fichiers XML. </p></div></div><br><h2 id="cel">  But </h2><br><p>  Je change rarement de poste, par cons√©quent, √©tant donn√© le d√©sir naturel de chaque organisation pour des processus fixes, toute t√¢che se transforme en routine.  D'une part, il est avantageux pour une entreprise de maintenir un tel √©tat, d'autre part, pour moi, cela signifie soit une perte totale, soit une obsolescence des comp√©tences.  PHP se d√©veloppe rapidement et, par cons√©quent, le d√©calage potentiel augmente √©galement rapidement.  Enfin, nous savons tous qu'aujourd'hui, il est difficile pour un programmeur de trouver un bon emploi sans conna√Ætre Elasticsearch, RabbitMQ, Kafka et d'autres technologies qui n'apparaissent pas souvent dans mon travail quotidien. </p><a name="habracut"></a><br><p>  Apr√®s avoir d√©marr√© le prochain site typique, j'ai d√©cid√© qu'il √©tait temps de changer quelque chose.  Je ne voulais pas changer mon travail, mais je me suis souvenu que lors d'une des conf√©rences, le conf√©rencier avait recommand√© d'utiliser son propre projet facultatif, le soi-disant projet pour animaux de compagnie, pour la formation.  La m√©thode semblait appropri√©e et j'ai d√©cid√© de l'essayer. </p><br><h2 id="vybor-zadachi">  S√©lection des t√¢ches </h2><br><p>  Le choix de la t√¢che s'est av√©r√© √™tre la partie la plus difficile de l'entreprise.  Rien de sp√©cial n'est venu √† l'esprit: certains services, comme un analyseur de t√¢ches qui peut √™tre facilement impl√©ment√© sur une pile famili√®re.  J'ai abandonn√© l'id√©e du projet pendant plusieurs mois, jusqu'√† ce que je voie accidentellement la nouvelle du hackathon du minist√®re des Finances.  Il a sugg√©r√© d'utiliser l'une des listes de sources de donn√©es ouvertes pour cr√©er un service.  Entre autres, le Federal Information Address System (FIAS) a √©galement √©t√© indiqu√©.  Malheureusement, le hackathon √©tait d√©j√† termin√© √† ce moment-l√†. </p><br><p>  J'ai d√©couvert FIAS pour la premi√®re fois, mais la t√¢che semblait int√©ressante.  Jugez par vous-m√™me: environ 30 Go de fichiers XML, environ 60 millions de lignes dans la base de donn√©es et, en outre, la biblioth√®que pourrait plus tard s'av√©rer utile dans le travail.  Il y avait des solutions toutes faites sur Github, mais cela ne m'a pas arr√™t√©.  Au contraire, sur la base de leur analyse, j'ai fait des exigences suppl√©mentaires qui mettraient en √©vidence ma mise en ≈ìuvre. </p><br><p>  Pour l'avenir, je constate que j'ai rencontr√© beaucoup moins de difficult√©s que pr√©vu. </p><br><h2 id="formulirovka-zadachi">  √ânonc√© de t√¢che </h2><br><p>  90% du succ√®s est l'√©nonc√© correct du probl√®me.  Apr√®s plusieurs ann√©es de travail sur les mod√®les, il √©tait assez difficile de formuler clairement le probl√®me.  Je voulais juste commencer √† travailler, mais d√©j√† dans le processus, tout se serait √©clairci par lui-m√™me.  Apr√®s une heure de lutte avec la procrastination, j'ai finalement √©crit: cr√©er une biblioth√®que en PHP pour importer des donn√©es FIAS. </p><br><p>  Plus tard, apr√®s un avant-go√ªt, j'ai ajout√© quelques exigences suppl√©mentaires: </p><br><ul><li>  impl√©mentation en PHP sans utiliser d'utilitaires tiers, exclusivement du code en PHP et des extensions de PECL, </li><li>  importation de toutes les donn√©es de l'ensemble FIAS, </li><li>  cycle complet d'installation et de mise √† jour: recherche de la version n√©cessaire, r√©ception de l'archive, d√©ballage, √©criture dans la base de donn√©es, </li><li>  flexibilit√© maximale: possibilit√© de changer l'emplacement de stockage, de modifier les donn√©es avant l'enregistrement, de filtrer le n√©cessaire, etc., </li><li>  La biblioth√®que doit √™tre facilement int√©gr√©e aux projets existants. </li></ul><br><h2 id="fias">  FIAS </h2><br><p>  FIAS a un <a href="https://fias.nalog.ru/" rel="nofollow">site officiel</a> qui nous donne la d√©finition et le but de la cr√©ation d'un syst√®me </p><br><blockquote>  Le Federal Information Address System (FIAS) est le syst√®me d'information de l'√âtat f√©d√©ral qui pr√©voit la formation, la maintenance et l'utilisation du registre d'adresses de l'√âtat. <br><br>  La cr√©ation de la FIAS a pour but la formation d'une ressource f√©d√©rale unique contenant des informations d'adresse structur√©es fiables, uniformes et accessibles au public.  Gr√¢ce √† la mise en ≈ìuvre de FIAS, ces informations peuvent √™tre obtenues gratuitement via Internet sur le portail FIAS officiellement enregistr√©. </blockquote><p>  Les mat√©riaux avec une description sont tout √† fait suffisants √† la fois sur <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">le site Web de la FIAS</a> et sur le <a href="https://habr.com/ru/search/%3Fq%3D%25D0%25A4%25D0%2598%25D0%2590%25D0%25A1">Habr√©</a> , donc je ne me concentrerai pas sur cela. </p><br><p>  Bref.  FIAS est disponible en deux formats: FIAS et KLADR.  Le second est obsol√®te et n'est plus utilis√©.  Les informations sont stock√©es soit dans DBF, soit dans XML.  Chaque changement dans la composition de FIAS est marqu√© d'une nouvelle version.  Vous pouvez demander soit un package avec des donn√©es compl√®tes √† jour ou contenant uniquement des modifications entre les deux versions.  Links fournit un service SOAP.  Le package est une archive RAR contenant des fichiers avec des noms sp√©cialement form√©s.  Ils se composent d'un pr√©fixe, d'un nom de jeu de donn√©es et d'une date de g√©n√©ration.  Il existe deux types de pr√©fixes: AS_ pour les fichiers dont les donn√©es doivent √™tre ajout√©es √† la base de donn√©es et AS <em>DEL</em> pour les fichiers dont les donn√©es doivent √™tre supprim√©es de la base de donn√©es. </p><br><p>  FIAS contient les donn√©es suivantes: </p><br><ul><li>  registre des √©l√©ments de formation d'adresses (c'est le graphe des adresses: r√©gions, villes et rues), </li><li>  des √©l√©ments d'adresse identifiant les objets adressables (num√©ro et donn√©es de la maison), </li><li>  informations sur les terrains </li><li>  des informations sur les locaux (appartements, bureaux, chambres, etc.), </li><li>  des informations sur le document normatif, qui est la base de l'attribution du nom √† l'√©l√©ment d'adresse. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Ainsi que plusieurs dictionnaires</b> <div class="spoiler_text"><ul><li>  une liste des valeurs possibles des intervalles des maisons (r√©gulier, pair, impair), </li><li>  une liste des statuts de pertinence d'une entr√©e d'un √©l√©ment d'adresse selon le classificateur KLADR4.0, </li><li>  une liste des statuts pertinents d'une entr√©e d'un √©l√©ment d'adresse par FIAS, </li><li>  une liste de noms complets et abr√©g√©s des types d'√©l√©ments d'adresse et de leurs niveaux de classification, </li><li>  liste des types de b√¢timents, </li><li>  liste des types de propri√©t√© possibles </li><li>  liste des codes d'op√©rations avec objets adressables, </li><li>  une liste des conditions immobili√®res possibles, </li><li>  liste des types de locaux ou de bureaux, </li><li>  liste des types de chambres, </li><li>  liste des statuts (centres) possibles des objets d'adresse des unit√©s administratives, </li><li>  types de documents r√©glementaires. </li></ul></div></div><br><p>  La structure des donn√©es est d√©crite dans le document, qui se trouve <a href="https://fias.nalog.ru/Updates.aspx" rel="nofollow">dans la section des mises √† jour</a> . </p><br><p>  En fin de compte, nous avons un algorithme d'installation FIAS assez simple et lin√©aire: </p><br><ul><li>  obtenir du service SOAP un lien vers l'archive et le num√©ro de version actuel, </li><li>  t√©l√©charger l'archive, </li><li>  d√©baller </li><li>  √©crire dans la base de donn√©es toutes les donn√©es des fichiers avec le pr√©fixe AS_, </li><li>  supprimer de la base de donn√©es toutes les donn√©es des fichiers avec le pr√©fixe AS <em>DEL</em> (oui, c'est vrai, lors de l'installation, vous devez √©galement supprimer certaines donn√©es), </li><li>  notez le num√©ro de la version install√©e. </li></ul><br><p>  Et un algorithme de mise √† jour non moins simple: </p><br><ul><li>  obtenir du service SOAP une liste avec les num√©ros de version et des liens vers des fichiers avec des modifications, </li><li>  si la version actuelle de la base de donn√©es locale est la derni√®re, arr√™tez l'ex√©cution, </li><li>  obtenir un lien vers l'archive avec les modifications apport√©es √† la prochaine version, </li><li>  t√©l√©charger l'archive, </li><li>  d√©baller </li><li>  √©crire dans la base de donn√©es toutes les donn√©es des fichiers avec le pr√©fixe AS_, </li><li>  supprimer de la base de donn√©es toutes les donn√©es des fichiers avec le pr√©fixe AS <em>DEL</em> , </li><li>  noter le num√©ro de la version mise √† jour, </li><li>  revenir √† la premi√®re √©tape. </li></ul><br><p>  FIAS laisse des impressions contradictoires.  D'une part: automatisation compl√®te de l'ensemble du processus, formats ouverts, bonne documentation.  De l'autre: une d√©cision √©trange d'utiliser le RAR propri√©taire pour les donn√©es ouvertes;  les diff√©rences entre la documentation et la r√©alit√© (principalement li√©es aux attributs obligatoires), qui causent de nombreux petits mais d√©sagr√©ables probl√®mes;  il arrive parfois des archives qui ne peuvent pas √™tre d√©compress√©es sous Linux;  certains deltas entre les versions occupent 4-5 Go. </p><br><h2 id="arhitektura">  L'architecture </h2><br><p>  Chaque biblioth√®que doit √™tre bas√©e sur une id√©e de base, un noyau autour duquel le reste des fonctionnalit√©s se d√©veloppera.  Le sch√©ma de la ¬´cha√Æne de fonctions¬ª me semblait le meilleur choix pour le r√¥le d'une telle id√©e.  Tout d'abord, il est id√©al: plusieurs op√©rations s√©quentielles qu'une personne aurait effectu√©es s'il avait voulu installer FIAS manuellement sont √©videntes pour le d√©veloppeur et s'int√®grent bien dans de petites classes √©crites dans le style SOLID.  Deuxi√®mement, une telle cha√Æne se d√©veloppe tr√®s facilement avec de nouvelles op√©rations √† presque toutes les √©tapes, ce qui offre une bonne flexibilit√©.  Troisi√®mement, je souhaite depuis longtemps √©crire ma propre impl√©mentation. </p><br><p>  En plus des op√©rations, j'ai cr√©√© plusieurs services qui peuvent √™tre transf√©r√©s via DI.  Ils vous permettent de r√©utiliser le code, de remplacer facilement l'impl√©mentation pour des t√¢ches syst√®me de bas niveau (t√©l√©charger un fichier, d√©compresser une archive, √©crire dans une base de donn√©es et autres) et offrent une bonne couverture de test gr√¢ce aux maquettes. </p><br><p>  En cons√©quence, la biblioth√®que contient quatre principaux types d'objets, pour chacun desquels le domaine de responsabilit√© est clairement d√©fini: </p><br><ul><li>  services - fournir des outils pour effectuer des t√¢ches syst√®me de bas niveau, </li><li>  objet d'√©tat - stocke les informations √† transmettre entre les op√©rations, </li><li>  op√©rations - en utilisant les services et en indiquant qu'ils impl√©mentent la partie atomique de la logique m√©tier, </li><li>  cha√Æne d'op√©rations - effectue des op√©rations et transf√®re l'√©tat entre elles. </li></ul><br><p>  En utilisant la liaison des op√©rations et des services fournis par la biblioth√®que, vous pouvez facilement obtenir n'importe quelle nouvelle cha√Æne ou compl√©ter la cha√Æne existante en utilisant uniquement des fichiers de configuration. </p><br><h2 id="freymvorki">  Cadres </h2><br><p>  Avec de longues pauses et un refactoring constant, j'ai travaill√© sur la biblioth√®que pendant un an et demi. </p><br><p>  La premi√®re version relativement stable √©tait pr√™te en deux mois de travail le soir.  En fait, il pouvait exister s√©par√©ment du framework et contenir tout le n√©cessaire: un script d'entr√©e √† ex√©cuter dans la console, un conteneur DI, un add-on sur PDO, son propre logger et des migrations de structure de base de donn√©es - dont j'√©tais tr√®s fier. </p><br><p>  Bien s√ªr, ses coll√®gues l'ont rejet√©e sans piti√©. </p><br><p>  Le principal argument contre cela √©tait le manque de soutien pour les cadres populaires.  Personne ne voulait √©crire un wrapper s√©par√© pour la biblioth√®que.  Pour cette raison, j'ai fait l'erreur la plus co√ªteuse dans le temps: j'ai commenc√© √† prendre en charge la version autonome et les wrappers individuels pour chaque framework.  Les vrais fichiers FIAS sont diff√©rents de ce qui est √©crit dans la documentation.  Chaque fois qu'il √©tait n√©cessaire de supprimer ou d'ajouter, par exemple, non nul dans la description de la colonne, je devais apporter des modifications √† trois r√©f√©rentiels.  En raison de la lenteur du processus, le travail a cal√© pendant encore six mois. </p><br><p>  Le sentiment d'incompl√©tude m'a tourment√© tout ce temps et apr√®s une bataille sanglante avec la paresse m'a oblig√© √† revenir √† la conception d'une nouvelle version.  Pour commencer, j'ai d√©cid√© que personne n'avait besoin d'une biblioth√®que autonome, ce qui signifie que vous devriez supprimer tous les services qui fournissent des cadres du package, en les rempla√ßant par des interfaces.  Nous sommes donc pass√©s sous le couteau: un script d'entr√©e √† ex√©cuter dans la console, un conteneur DI, un module compl√©mentaire sur PDO, notre propre enregistreur et des migrations de structure de base de donn√©es.  Ensuite, j'ai d√©cid√© de cr√©er des packages s√©par√©s pour chaque framework, qui relieront toutes les parties du main √† un script de travail et fourniront des impl√©mentations sp√©cifiques de services. </p><br><p>  Le point cl√© √©tait le mod√®le.  La mise √† jour constante d'ensembles h√©t√©rog√®nes d'objets dans plusieurs r√©f√©rentiels ne le voulait pas.  En m√™me temps, au travail principal, j'ai eu un projet sur Symfony.  Apr√®s une rapide connaissance, j'ai d√©cid√© que la fonctionnalit√© la plus utile de SF est la g√©n√©ration de code et qu'elle r√©soudra tous mes probl√®mes.  J'ai cr√©√© un <a href="" rel="nofollow">fichier yaml</a> dans le package principal, qui contient une description d√©clarative des donn√©es FIAS.  Ensuite, j'ai ajout√© des g√©n√©rateurs de code qui cr√©ent des classes sp√©cifiques pour les mod√®les bas√©s sur cette description: entit√©s Doctrine pour Symfony et objets Eloquent pour Laravel.  Lors du d√©veloppement des g√©n√©rateurs, j'ai r√©alis√© que les mod√®les de brindilles n'√©taient pas adapt√©s √† cela, et j'ai opt√© pour une solution sp√©cialis√©e - <a href="https://github.com/nette/php-generator" rel="nofollow">Nette PHP Generator</a> . </p><br><p>  Comme preuve de concept, j'ai cr√©√© des bundles pour <a href="https://github.com/liquetsoft/fias-laravel" rel="nofollow">Laravel</a> et <a href="https://github.com/liquetsoft/fias-symfony" rel="nofollow">Symfony</a> .  Comme j'ai travaill√© plus longtemps avec le second, je d√©crirai tout ce qui suit dans son contexte. </p><br><h2 id="infrastruktura">  L'infrastructure </h2><br><p>  La plupart de mes projets de combat ont √©t√© √©crits sur des technologies obsol√®tes, donc je ne pouvais pas utiliser d'analyseurs de code modernes sur aucun d'entre eux.  Pour me d√©barrasser de l'oppression h√©rit√©e, j'ai install√© et configur√© tous les outils de contr√¥le de la qualit√© du code que je pouvais: </p><br><ul><li>  <a href="https://github.com/vimeo/psalm" rel="nofollow">Psaume</a> pour v√©rification de type, </li><li>  <a href="https://scrutinizer-ci.com/" rel="nofollow">Scrutinisateur</a> pour l'√©valuation g√©n√©rale de la qualit√© (aide <a href="https://scrutinizer-ci.com/" rel="nofollow">beaucoup</a> avec la complexit√© cyclomatique) </li><li>  <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" rel="nofollow">Fixateur de normes de codage PHP</a> pour v√©rifier le style de code, </li><li>  <a href="https://github.com/sebastianbergmann/phpcpd" rel="nofollow">D√©tecteur de copier / coller PHP</a> pour trouver les doublons, </li><li>  <a href="https://github.com/sebastianbergmann/phpunit" rel="nofollow">PHPUnit</a> pour ex√©cuter des tests unitaires. </li></ul><br><p>  Validation int√©gr√©e dans Github √† l'aide de <a href="https://travis-ci.org/" rel="nofollow">Travis</a> .  Enfin, il a ajout√© un fichier Docker pour cr√©er un environnement de d√©veloppement local avec un fichier make contenant les commandes de base du conteneur (lancement des v√©rifications, des tests, cr√©ation de mod√®les et autres). </p><br><h2 id="itogi-obucheniya">  R√©sultats d'apprentissage </h2><br><h3 id="php-7">  PHP 7 </h3><br><p>  Avant de commencer √† travailler sur la biblioth√®que, je n'ai jamais vraiment utilis√© les <a href="https://www.php.net/manual/ru/migration70.new-features.php" rel="nofollow">nouvelles fonctionnalit√©s de PHP 7</a> .  Ils sont beaux: des types stricts √† une augmentation significative de la productivit√©.  Un merci sp√©cial aux d√©veloppeurs pour l'op√©rateur de coalescence nulle.  Je n'ai pas vu une telle diminution s√©rieuse de la base de code apr√®s l'introduction d'un op√©rateur. </p><br><h3 id="rar">  Rar </h3><br><p>  √âtonnamment, dans PECL, il y avait un <a href="https://www.php.net/manual/ru/book.rar.php" rel="nofollow">package pour travailler avec RAR</a> .  En r√®gle g√©n√©rale, ces extensions ne sont pas fiables et j'essaie de les √©viter.  Il s'est av√©r√© √™tre d'une stabilit√© suspecte: il a √©t√© install√© en 7.2 sans probl√®me, il a pu d√©baller d'√©normes archives relativement rapidement et avec une faible consommation de RAM (6 Go sont d√©ball√©s en 10-20 minutes en fonction des ressources syst√®me disponibles).  Je crains toujours que ce soit une manifestation de la loi de Murphy. </p><br><h3 id="xmlreader">  Xmlreader </h3><br><p>  La lecture de fichiers xml g√©ants n'est pas une t√¢che triviale.  Et encore une fois, l'extension PECL est venue √† la rescousse - <a href="https://www.php.net/manual/ru/book.xmlreader.php" rel="nofollow">XmlReader</a> .  Je n'ai pas imm√©diatement r√©alis√© toute sa puissance, mais dans plusieurs approches, je l'ai adapt√© en conjonction avec le <a href="https://symfony.com/doc/current/components/serializer.html" rel="nofollow">s√©rialiseur Symfony</a> pour obtenir rapidement et √©conomiquement des donn√©es √† partir de fichiers FIAS.  C√¥t√© biblioth√®que, l'objet lecteur impl√©mente l'interface de l'it√©rateur, qui renvoie s√©quentiellement des cha√Ænes xml correspondant √† un enregistrement du fichier.  √Ä l'aide du s√©rialiseur Symfony, ces cha√Ænes sont converties en objets.  Un fichier de 20 Go peut √™tre lu en 3-4 minutes tout en n'utilisant pas plus de 50 Mo de RAM. </p><br><h3 id="zapis-v-bazu-dannyh">  Ecrire dans la base de donn√©es </h3><br><p>  Bien s√ªr, j'ai commenc√© avec des tableaux associatifs avec des donn√©es et des descriptions de table volumineuses.  Le code s'est rapidement transform√© en hachage de configurations et de classes de conversion. </p><br><p>  La magie des entit√©s Doctrine a montr√© comment les objets peuvent se d√©crire d'eux-m√™mes.  J'ai d√©cid√© d'utiliser la m√™me approche, mais en m√™me temps de me d√©barrasser de ma propre impl√©mentation de l'√©criture de donn√©es dans la base de donn√©es √† l'aide de PDO.  Au lieu de cela, j'ai cr√©√© une interface de stockage qui d√©crit les m√©thodes de traitement des objets.  En fonction de la classe d'entit√©, une impl√©mentation de stockage particuli√®re d√©cide exactement comment et o√π √©crire les donn√©es.  Cette approche a facilit√© la connexion d'une grande vari√©t√© de stockages: de MySql aux fichiers csv. </p><br><h3 id="optimizaciya-vstavki-dannyh">  Optimisation de l'insertion des donn√©es </h3><br><p>  J'ai interrompu la premi√®re importation apr√®s qu'elle ait d√©pass√© en 48 heures.  Il est devenu √©vident que vous devez optimiser le processus d'insertion des donn√©es. </p><br><p>  Tout d'abord, je suis pass√© aux <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">colonnes de type ugid</a> pour les cl√©s primaires <a href="https://www.postgresql.org/docs/12/datatype-uuid.html" rel="nofollow">int√©gr√©es dans PostgreSql</a> .  L'√©criture dans une colonne uuid avec un index est beaucoup plus rapide que l'√©criture dans une cha√Æne. </p><br><p>  Par la suite, j'ai abandonn√© tous les index non critiques et les cl√©s √©trang√®res, car le souci de l'int√©grit√© des donn√©es est enti√®rement du c√¥t√© de l'√©quipe FIAS. </p><br><p> J'ai ensuite refait l'interface de stockage pour que le script externe puisse l'informer explicitement de la fin de l'importation.  Cela a permis l'utilisation d'insert en vrac, ce qui a parfois acc√©l√©r√© l'enregistrement.  <a href="https://www.postgresql.org/docs/current/populate.html" rel="nofollow">√Ä la recherche d'informations,</a> je suis √©galement tomb√© sur la commande de <a href="https://www.postgresql.org/docs/current/sql-copy.html" rel="nofollow"><code>copy</code></a> avec <a href="https://www.postgresql.org/docs/current/functions-xml.html" rel="nofollow"><code>query_to_xml</code></a> .  Il avait deux gros inconv√©nients: premi√®rement, l'utilisateur PostgreSql doit avoir des autorisations de lecture pour le fichier, ce que je ne pouvais pas garantir, et deuxi√®mement, la possibilit√© de modifier les donn√©es √† l'int√©rieur du script avant la perte d'√©criture. </p><br><p>  Malgr√© ces changements, le temps d'importation a d√©pass√© 30 heures.  Un changement radical d'approche s'imposait. </p><br><h3 id="parallelnye-processy">  Processus parall√®les </h3><br><p>  Internet regorge d'articles sur l'asynchronie en PHP.  Mon choix s'est <a href="https://amphp.org/" rel="nofollow">port√©</a> sur <a href="https://amphp.org/" rel="nofollow">Amp</a> .  Cela n'a tout simplement pas fonctionn√© de mani√®re asynchrone.  Premi√®rement, le code s'est rapidement transform√© en une terrifiante feuille de rappels et d'appels non √©vidents (c'est probablement ma faute, pas l'approche asynchrone).  Deuxi√®mement, j'ai d√ª abandonner l'utilisation des ORM standard car des appels non bloquants √† la base de donn√©es via un <a href="https://github.com/amphp/mysql" rel="nofollow">cadre sp√©cial</a> sont n√©cessaires.  Troisi√®mement, bien qu'il existe des conditions dans lesquelles PostgreSql peut ins√©rer des lignes en parall√®le, elles sont <a href="" rel="nofollow">extr√™mement</a> <a href="https://wiki.postgresql.org/wiki/Parallel_Query" rel="nofollow">difficiles √†</a> remplir.  En cons√©quence, apr√®s 5 heures de travail, j'ai observ√© comment toutes mes demandes asynchrones √©taient ¬´synchronis√©es¬ª de force du c√¥t√© de la base de donn√©es. </p><br><p>  Mais l'importation est bien divis√©e en processus parall√®les: plusieurs t√¢ches compl√®tement ind√©pendantes qui n'ont pas de ressources communes pour lesquelles elles pourraient rivaliser et des donn√©es qu'elles pourraient √©changer.  De plus, dans le cadre d'un thread, j'ai re√ßu un code beau et lin√©aire. </p><br><p>  Le premier, j'ai d√©cid√© d'essayer l'extension <a href="https://www.php.net/manual/ru/book.parallel.php" rel="nofollow">parall√®le</a> .  Il a une faille fatale - l'interpr√®te doit √™tre construit avec le support de ZTS (Zend Thread Safety).  √âtant donn√© que ZTS ne fonctionne pas dans les scripts Web classiques, il faudrait avoir deux versions diff√©rentes de l'interpr√©teur.  Un, sans ZTS, pour le web, le second, avec ZTS, pour installer FIAS.  L'am√©lioration potentielle des performances l'emportait sur cet inconv√©nient, en particulier compte tenu de la facilit√© d'assemblage d'un nouveau conteneur Docker et de son utilisation conjointement avec l'ancien.  Malheureusement, d√©marrer Symfony dans un nouveau thread a fait d√©border la pile PHP, et je n'√©tais pas pr√™t √† refuser le conteneur DI et la configuration pratique. </p><br><p>  Enfin, j'ai trouv√© le <a href="https://symfony.com/doc/current/components/process.html" rel="nofollow">processus symfony</a> .  En fait, il d√©marre un nouveau processus pour la commande de console sp√©cifi√©e et surveille son ach√®vement.  J'ai d√ª ajouter deux cha√Ænes suppl√©mentaires.  Le premier t√©l√©charge l'archive, la d√©compresse et lance des processus parall√®les pour le traitement des donn√©es.  Le second prend une liste de fichiers de l'argument de ligne de commande et √©crit leur contenu dans la base de donn√©es. </p><br><p>  En raison du manque d'exp√©rience avec les processus parall√®les, il semble que j'ai commis toutes les erreurs des d√©butants. </p><br><p>  Par exemple, mon processus d'initiation a v√©rifi√© l'ach√®vement des enfants en utilisant une boucle infinie et, bien s√ªr, il d√©pensait ind√©cemment beaucoup de ressources processeur pour cela.  L'appel de sommeil entre les it√©rations a aid√©. </p><br><p>  Dans la premi√®re impl√©mentation, les fichiers √©taient r√©partis in√©galement entre les processus.  Les deux plus grands sont tomb√©s en un seul flux, qui a √©t√© trait√© pendant plus de 20 heures.  Dans la deuxi√®me impl√©mentation, j'ai ajout√© un gestionnaire sp√©cial qui distribue les fichiers en fonction du temps n√©cessaire pour les importer.  Maintenant, les processus sont charg√©s uniform√©ment. </p><br><p>  Apr√®s ces modifications, j'ai pu importer la version compl√®te de FIAS en 16-20 heures, selon les ressources du serveur.  Pas aussi bien que nous le souhaiterions, mais je continue de travailler sur l'optimisation.  La prochaine √©tape est un rejet complet de PostgreSql en faveur d'Elasticsearch. </p><br><h2 id="vyvody">  Conclusions </h2><br><p>  Cela en valait-il la peine?  Deux ans de travail sur une biblioth√®que qui ne s'est jamais lanc√©e dans un projet de combat? </p><br><p>  Oui, compl√®tement. </p><br><p>  J'ai quand m√™me chang√© de boulot.  Au cours d'une tourn√©e d'une douzaine d'interviews, je n'ai r√©pondu √† de nombreuses questions d√©licates que gr√¢ce √† mon projet animal. </p><br><p>  La panique que PHP est en train de mourir est de plus en plus forte.  Je ne cacherai pas le fait que je pensais moi-m√™me √† la migration vers une autre langue. </p><br><p>  Apr√®s avoir vu l'√©norme travail que l'√©quipe PHP a mis dans la version 7;  il a √©t√© convaincu par son exemple personnel de la maturit√© de la langue et de la richesse de l'√©cosyst√®me qu'elle a d√©velopp√©;  Je peux dire en toute s√©curit√© que les rumeurs sur la mort de PHP sont grandement exag√©r√©es.  Et ce n'est qu'un d√©but: √† l'avenir, nous attendons le JIT, l'asynchronie pr√™te √† l'emploi et bien plus encore. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479122/">https://habr.com/ru/post/fr479122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479100/index.html">Dojo frontal: projets de formation aux comp√©tences des d√©veloppeurs (5 nouveaux + 43 anciens)</a></li>
<li><a href="../fr479106/index.html">Combien co√ªtent les tours de magie</a></li>
<li><a href="../fr479108/index.html">La vie de chevalier - Arena en ligne avec des √©l√©ments RPG</a></li>
<li><a href="../fr479116/index.html">Impressions sur la recherche Y. Direct: pourquoi vous payez 1,5 fois plus par clic</a></li>
<li><a href="../fr479120/index.html">La participation a √©chou√©: nous amenons AgentTesla √† l'eau potable. 2e partie</a></li>
<li><a href="../fr479124/index.html">[Infographie] L'intelligence artificielle en science-fiction</a></li>
<li><a href="../fr479126/index.html">Python dans le d√©veloppement mobile</a></li>
<li><a href="../fr479128/index.html">Comment fonctionne le service m√©dical de l'a√©roport</a></li>
<li><a href="../fr479132/index.html">Composant externe pour la plate-forme mobile 1C (BroadcastReceiver)</a></li>
<li><a href="../fr479136/index.html">Informatique quantique: la fin de la blockchain?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>