<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ±Ô∏è üêõ üï∫üèª Wir sind von einem anderen Test - wir testen die Datenbank auf MSTest ‚òùÔ∏è üëçüèΩ üëàüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Testen als universelles Prinzip 
 Wir feiern das Jahrtausend seit fast einem Vierteljahrhundert, und das Testen beginnt gerade erst in unserem Leben ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir sind von einem anderen Test - wir testen die Datenbank auf MSTest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481474/"><h4>  Testen als universelles Prinzip </h4><br>  Wir feiern das Jahrtausend seit fast einem Vierteljahrhundert, und das Testen beginnt gerade erst in unserem Leben ... Es ist schwer, unerfahrene Entwickler davon zu √ºberzeugen, diese erstaunliche Technik in ihrer Arbeit zu verwenden ... Was k√∂nnen wir √ºber Entwickler sagen, blo√üe Sterbliche, und es ist nicht immer m√∂glich zu verstehen, dass das Testen die Grundlage ist nachhaltige systeme!  Wie schwierig es ist, eine Verk√§uferin davon zu √ºberzeugen, dass das Testen eines neuen Produkts nicht bedeutet, es zu essen!  Selbst erfahrene Sicherheitskr√§fte arbeiten offensichtlich auf die altmodische Art und Weise - sie versuchen, den Test nachzuholen und auszuw√§hlen.  Und Sie werden ihnen nicht beweisen, dass, wenn der Herr, Gott, selbst, TDD nicht f√ºr seine Arbeit missbilligt (erinnern Sie sich an die Gro√üe Sintflut), dann, wie sie sagen, Gott selbst befahl ... <br><br>  Die Zahl der Scheidungen w√§chst - warum?  Ja, egal!  TDD!  Erst testen - dann heiraten!  Nein, leichtgl√§ubige kleine M√§nner in locker sitzenden Schaffellm√§nteln, die sich f√ºr sexuell ausbeutende Werbung begeistern, bringen eine junge Frau direkt in die Produktion ... <br><br>  Na ja, wir sind bei dir von einem anderen Test, erst testen - dann alles andere! <br><br><h4>  Ich erkenne den Tester am Gang ... </h4><br>  Als ich mit dem Schreiben der n√§chsten Code-First-Datenbank anfing, dachte ich dar√ºber nach, warum ich meine DAL-Schicht nicht direkt anhand der in VisualStudio integrierten Tests automatisch testete. <br><br>  Und ich habe es geschafft!  Transparent f√ºr EntityFramework, ohne Fingerspitzengef√ºhl unter der Decke und Betrug mit gef√§lschten Objekten.  Wen k√ºmmert's - VS aufdecken, wie Tester anziehen und los!  (Ich kleide mich immer wie ein Tester) <br><br><div class="spoiler">  <b class="spoiler_title">Tester Kleidung</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tg/pv/kw/tgpvkwgvjzb4zf7tt-navdbcazi.jpeg" alt="Bild"><br></div></div><a name="habracut"></a><br><h4>  L√ºge alle an, das ist eine Pr√ºfung! </h4><br><div class="spoiler">  <b class="spoiler_title">Lebenssache:</b> <div class="spoiler_text">  Hat an einem Projekt mit folgendem Code gearbeitet: <br><br><pre><code class="plaintext hljs">ObjectLink link = this.ObjectLinks.ToList().Where(x =&gt; x.SpotCode.ToLowerInvariant() == code.ToLowerInvariant()).SingleOrDefault();</code> </pre> <br>  Dieser Code wurde nicht getestet, da er keine Zeit hatte - es war dringend erforderlich, neue Funktionen im Zusammenhang mit Marketing zu starten.  Alles funktionierte beim manuellen √úberpr√ºfen und ich war bereits entspannt ... aber Bill Gates schlich sich unbemerkt ... <br><br>  Es war ein poetischer Herbst in St. Petersburg, Schnee und Regen strichen sanft √ºber mein Gesicht, Schmutz floss fr√∂hlich von den Hosenbeinen herab und unbekannte M√§dchen l√§chelten durch das verteilte Make-up, gossen vorbeifahrende Lastwagen ... Ich griff schon nach meinem Finger, um in meiner Nase herumzustochern, als es t√ºckisch war, ohne Krieg zu erkl√§ren Im Morgengrauen schnitt Microsoft den Stacheldraht ab und ver√∂ffentlichte das Core 3.0-Update.  Der Hoster wurde aktualisiert, ich habe auch aktualisiert, warum gehe ich in den alten - bin ich schlechter als ein Hoster?  Ich habe alles gepr√ºft und das Update rausgebracht ... und dann habe ich meine Augen ausgerollt!  Neue Funktionalit√§t hat nicht funktioniert!  es scheint, dass ich es vorher getestet habe - was k√∂nnte passieren? <br><br>  Und genau das ist passiert: Der alte Billy hat beschlossen, es aus LINQ ToLowerInvariant zu entfernen. Jetzt m√ºssen Sie es im Voraus aufrufen und den fertigen Wert einf√ºgen. Wenn der Code mit Tests bedeckt war, w√ºrde ich es beim Testen sofort bemerken.  Es ist gut, dass ich alles selbst bemerkt habe, ich musste nicht beim Kunden schw√∂ren, weil der Tester sich sch√§mte, rot zu werden ... Ich musste das Problem l√∂sen und einen neuen Einsatz durchf√ºhren. <br></div></div><br><h4>  Ger√§te und Materialien: </h4><br>  Microsoft VisualStudio 2019 <br>  asp.net Core 3.1 (Ich habe es mit dem Studio installiert, wenn etwas √ºber das Projektmen√º "Andere Frameworks installieren" geliefert werden kann.) <br>  SQL Server Express (wird mit dem Studio geliefert) <br>  Git-Erweiterung zu Visual Studio (im Lieferumfang enthalten) <br><br>  In der Regel sollte bei Komponententests jeder Test isoliert werden, und der Zustand zwischen ihnen bleibt nicht bestehen.  Wir werden also Integrationstests bekommen, aber wir werden daf√ºr MSTest verwenden.  Ich hoffe, sie bringen uns nicht zur Polizei. <br><br>  In mehreren Editionen habe ich die Verwendung von Mock-Objekten zum Testen der Datenbank kennengelernt. <br>  Auf den ersten Blick ist die Idee gut, bis komplexe Interaktionen zwischen Tabellen beginnen. <br>  Dann ist das Einrichten eines Mocks mehr als das Testen von selbst erforderlich.  Tats√§chlich ist es aber - Control + C - Control + V!  Wir sind alle Datenbankeinschr√§nkungen, die bereits in EF, Datenbank, DataAnnotations oder FluentAPI-Duplikaten in der Mock-Layer registriert wurden.  Und das Kopieren ist so, als w√ºrde man ein Muster brechen ... ayah, B√ºrger, brechen ... nicht gut! <br><br>  Und wenn die Scheinkonfiguration kompliziert ist und wir zum Beispiel Fehler in den Beschr√§nkungen dort gemacht haben, stellt sich heraus, dass - der Scheintest bestanden wird, aber wird es einen Fehler auf der wirklichen Basis geben? <br><br>  Das alles hat mich interessiert und ich habe beschlossen, einen neuen Ansatz zu testen. <br><br>  Die Idee kam wie immer von TRIZ: Ein <i>ideales System fehlt, aber seine Funktionen werden ausgef√ºhrt</i> .  Und ich dachte, dass ich die Datenbank selbst in den Tests verwenden muss. <br>  Und es hat irgendwie f√ºr mich geklappt.  Ich m√∂chte dies teilen, ich hoffe, jemand hilft. <br><br>  Nachteile von Mock: <br><br><ul><li>  viele presets die das testen </li><li>  Tests werden schmutzig, viel zus√§tzlicher Code </li><li>  schwer zu Migrationen zu testen </li><li>  Verhalten Sie sich gut, nur unter Aufsicht, tats√§chlich kann es zu unbekannten Fehlern kommen </li><li>  Wenn Sie die Struktur der Datenbank √§ndern, m√ºssen Sie st√§ndig in den Schein einsteigen und auch dort alles √§ndern </li></ul><br>  Testprofis auf echter Basis: <br><br><ul><li>  Das Programm verh√§lt sich genauso wie auf einem Kampfserver </li><li>  Tests sind einfacher, Sie k√∂nnen sie nacheinander auf die gleiche Weise erstellen, wie Daten in die Datenbank eingegeben werden </li><li>  Wir selbst k√∂nnen die Sauberkeit der Datenbank anpassen, indem wir die Tests nummerieren (in MSTest werden sie alphabetisch durchgef√ºhrt). </li><li>  Sie k√∂nnen die Zeit sehen, in der der Test durchgef√ºhrt wird (auf einem realen Server ist dies anders, aber zumindest die Reihenfolge ist sichtbar - 10-mal l√§nger, 2-mal, und Sie k√∂nnen bereits bewerten, wie das Programm effizient funktioniert oder nicht). </li><li>  kann gespeicherte Prozeduren testen </li></ul><br>  Es gibt gewisse Schwierigkeiten in diesem Ansatz, mit denen ich seit mehreren Tagen grabe, aber wir werden sie erfolgreich l√∂sen, und m√∂ge mein steinernes Backend bei Ihnen sein! <br><br>  Lass uns gehen! <br><br>  Wir erstellen ein neues Projekt ASP.Net Core 3.1-Webanwendung (Model-View-Controller), √§ndern die Authentifizierung in Einzelbenutzerkonten (Benutzerkonten in der App speichern) und klicken auf Erstellen <br><br><img src="https://habrastorage.org/webt/n1/oq/5c/n1oq5cv0fxxqnuu0sdgdwda7xem.jpeg" alt="Bild"><br><br>  Ab sofort speichere ich Projekt-Schnappsch√ºsse in Git. Sie k√∂nnen sie herunterladen und jeden Zweig hochladen, um damit zu experimentieren <br><br>  <a href="https://github.com/3263927/Habr_1" rel="nofollow">github.com/3263927/Habr_1</a> <br><br>  <b>Snapshot: Snapshot_0_ProjectCreated</b> <br><br><div class="spoiler">  <b class="spoiler_title">√úber das Repository</b> <div class="spoiler_text">  Auch wenn ich alleine arbeite, benutze ich immer das Repository - es ist jetzt sehr praktisch, direkt in Visual Studio integriert, keine Befehlszeile, alles funktioniert perfekt direkt von VS aus.  Sie k√∂nnen experimentieren und √§ndern, was Sie wollen, und dann k√∂nnen Sie immer das Commit-Rollback korrigieren oder zum alten Zweig wechseln.  Spart viel Zeit und M√ºhe, rate ich jedem.  Und integriert sich mit Github kostenlos.  Es ist wahr, dass ein Typ vor ein paar Jahren alles gel√∂scht hat ... F√ºr den Fall, dass ich alle Projekte in Dropbox ablege und sie einmal pro Woche aktualisiere, alle Projekte archiviere und die neuesten Versionen manuell auf Google Drive hochlade.  Nun, auf dem SD-Telefon gibt es auch 120 Gigs, die pl√∂tzlich in Reserve sind ... Ein paar Flash-Laufwerke mit Kopien in der Tasche sind einfach so unsichtbar! <br></div></div><br>  Zu diesem Zeitpunkt habe ich ein Repository erstellt. Jetzt muss die Arbeit geplant werden, um neue Zweige zu erstellen.  In Zukunft k√∂nnen Sie mithilfe des Schl√ºsselworts Snapshot Wiederherstellungspunkte finden, wenn ein Fehler auftritt. <br><br>  Ich werde direkt in VisualStudio einen neuen Zweig im Repository erstellen und ihn kurz ‚ÄûSchwester des Talents‚Äú nennen (Witz, Snap_1_DataBases). <br><br>  <b>Ziel: Schaffung einer funktionierenden Verbindung und Basis</b> . <br><br>  Wir fangen an, unsere Grundlagen zu schaffen. <br><br>  Ich muss sofort sagen, dass wir drei Datenbanken haben werden - einen Test (auf dem lokalen Computer), eine andere Produktion (auf dem Remote-Server) und eine andere lokale Produktion (um den Zustand der Site in der DEBUG-Konfiguration zu √ºberpr√ºfen). <br><br>  Die Logik ist folgende: <br><br><ul><li>  Wenn wir die Site auf dem lokalen Computer ausf√ºhren und sehen m√∂chten, wie sie funktioniert, funktioniert Habr1_Local f√ºr uns </li><li>  Wenn wir den Code in die Produktion aufnehmen, funktioniert Habr1_Production </li><li>  Wenn unsere Testinfrastruktur mit dem Testen beginnt, muss sie die Habr1_Test-Basis finden und ausf√ºhren </li></ul><br>  Wir haben jedoch einen Widerspruch: Es gibt nur zwei Konfigurationen, Debug und Release.  Dies ist immer noch ein Problem, aber dann wird es gel√∂st. <br><br>  Also erstellen wir ein minimal arbeitendes Programm - zun√§chst pr√ºfen wir nur, ob mindestens eine Datenbank f√ºr uns funktioniert.  Lassen Sie uns es schaffen ... mit den H√§nden von Visual Studio selbst! <br><br>  √ñffnen Sie die Datei appsettings.json <br><br>  Es gibt solche Zeilen: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\mssqllocaldb;Database=aspnet-WebApp-[- ,   ];Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  Dort m√ºssen Sie die korrekten Namen der Verbindungszeichenfolgen, den Namen des Servers und den Namen der Datenbank eingeben.  Ich muss gleich sagen, dass andere Anschl√ºsse in der Produktion verwendet werden, aber das brauchen wir jetzt nicht.  Unsere Aufgabe ist es, zwei Datenbanken zu erstellen (lokal und testweise, die Produktion ist nur ein Beispiel - wir werden sie in der Release-Konfiguration verwenden. Dann kann sie durch eine funktionierende entfernte Datenbank ersetzt werden). <br><br>  Warum ist das n√∂tig? <br><br>  In Visual Studio-Konfigurationen k√∂nnen Sie einige Einstellungen √§ndern, indem Sie die Konfiguration im Visual Studio-Bedienfeld √§ndern: <br><br><img src="https://habrastorage.org/webt/qa/8k/nr/qa8knrxqxt8komoewxxf-b-s2qs.jpeg" alt="Bild"><br><br>  Im Allgemeinen deklariert die Entwicklungsumgebung einfach eine DEBUG-Konstante, die dann an einer beliebigen Stelle im Code gelesen werden kann und erkennt, in welcher Konfiguration wir uns gerade befinden und welche aktiv ist. <br><br>  Remote-Debugger ist beispielsweise beim Colocation-Hosting nicht immer verf√ºgbar.  Wir k√∂nnen unseren asp.net-Server lokal ausf√ºhren und eine Verbindung zur Datenbank mit dem Remote-Server herstellen. Au√üerdem k√∂nnen wir alle Fehler anzeigen, die in der Produktion aufgetreten sind.  Hier in der Release-Konfiguration werden wir dies tun und die Debug-Konfiguration wird mit unserer lokalen Datenbank funktionieren.  Aus Sicherheitsgr√ºnden werden wir die Konfiguration nicht testen, um nicht versehentlich Daten zu l√∂schen, und die Konfiguration nicht zu √§ndern <br><br>  Also fangen wir an, die Verbindungszeichenfolge zu √§ndern. <br><br>  Servername - Sie k√∂nnen ihn in der Registerkartenansicht sehen -&gt; SQL Server-Objekt-Explorer <br><br><img src="https://habrastorage.org/webt/mk/-1/tc/mk-1tcplz6dtcpzupszdzpesh84.jpeg" alt="Bild"><br><br>  (Ich werde den Namen meines Computers mit Bedacht l√∂schen, ansonsten werden Sie mich nach IP berechnen und etwas eingeben). <br><br>  Also habe ich diese (localdb) \ ProjectsV13.  Ich wei√ü nicht, warum ich w√§hrend der Installation mein SQL aufgerufen habe. <br>  Dies bedeutet, dass unsere Verbindungszeichenfolge wird <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local; Trusted_Connection=True;MultipleActiveResultSets=true"</span></span></code> </pre> <br>  M√∂glicherweise haben Sie es anders, aber nur ProjectV13.  Der Rest sollte so gelassen werden. <br>  √Ñndern Sie DefaultConnection in Habr1_Local <br><br>  Es stellt sich so heraus: <br><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  Jetzt m√ºssen Sie zur Datei Startup.cs gehen und dort DefaultConnection durch Habr1_Local ersetzen: <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>)));</code> </pre> <br>  verwandelt sich in <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"Habr1_Local"</span></span>)));</code> </pre><br>  Wir starten unser Projekt in der Debug-Konfiguration, der Browser √∂ffnet sich, wir sehen die erste Seite, klicken auf den Login-Button, geben dort eine g√ºltige E-Mail ein (es werden keine Briefe verschickt, es validiert nur das Format) und klicken auf Login - und wir sehen diesen Bildschirm: <br><br><img src="https://habrastorage.org/webt/p3/u3/r4/p3u3r4gkdanievaornpxfxwoous.jpeg" alt="Bild"><br><br>  Klicken Sie auf "Migration anwenden". Wir warten, bis rechts neben der blauen Schaltfl√§che, die die Migration abgeschlossen hat, eine Best√§tigung angezeigt wird. Sie m√ºssen die Seite aktualisieren und auf "Best√§tigen" klicken, um die Daten erneut zu senden. Anschlie√üend wird der Bildschirm "Anmeldung fehlgeschlagen" angezeigt: <br><br><img src="https://habrastorage.org/webt/fc/sw/pc/fcswpc-tqd0gyuhz70cyefi9uls.jpeg" alt="Bild"><br><br>  Wenn ein solcher Bildschirm sichtbar ist, ist alles in Ordnung - nachdem die Anforderung bestanden und ein ung√ºltiger Anmeldeversuch zur√ºckgegeben wurde, ist kein Datenbankfehler aufgetreten, aber es wurde einfach kein solcher Benutzer gefunden. <br><br><div class="spoiler">  <b class="spoiler_title">Ein bisschen √ºber Migration:</b> <div class="spoiler_text">  Dies ist ein komplexes Werkzeug und es ist kaum notwendig, es in diesem Artikel zu ber√ºhren, aber Sie k√∂nnen ein wenig ber√ºhren. <br>  Beispielsweise m√ºssen Sie den Status der Datenbank auf einen bestimmten Status √§ndern. Sie k√∂nnen hierf√ºr einen Datenbank-Snapshot oder mehrere Snapshots f√ºr jeden Status erstellen und diese Images programmgesteuert und mit speziellen Befehlen aktivieren / deaktivieren. <br><br>  Oder wenn Sie etwas auf dem lokalen Computer entwickeln und dann den neuen Status der Datenbank auf dem Server mit dem lokalen synchronisieren m√ºssen, aktualisieren Sie den Produktionsserver auf den Status Ihrer lokalen Datenbank und f√ºhren Sie dies automatisch aus - die Migration kann ebenfalls angewendet werden.  Das ist eigentlich dieser blaue Knopf.  Die Basis wei√ü, dass sich ihr Status vom Status des Codes unterscheidet, und versucht, diese Status zu synchronisieren.  Dazu wird in der Datenbank eine spezielle Tabelle mit dem verschl√ºsselten Zustand der Datenbankstruktur angelegt. <br><br>  Leider wird dieses Tool dadurch kompliziert, dass es keine visuelle Oberfl√§che daf√ºr gibt und Sie √ºber die Befehlszeile damit arbeiten m√ºssen.  Migrationen sind praktisch, wenn Sie Zust√§nde √ºber Git √ºbergeben m√ºssen, indem Sie einfach solche Datenbank-Snapshots als C # -Dateien erstellen.  Dieses Tool birgt jedoch eine Gefahr: Wenn es falsch konfiguriert ist, kann es Daten in der Datenbank l√∂schen. Sie sollten es daher mit Vorsicht verwenden. <br></div></div><br>  √úberpr√ºfen der Verf√ºgbarkeit der Datenbank - Visual Studio sollte diese erstellt haben <br><br><img src="https://habrastorage.org/webt/op/6i/c_/op6ic_e4cdoarqotsmz441fkmkc.jpeg" alt="Bild"><br><br>  Wenn keine Datenbank vorhanden ist, ist ein Fehler aufgetreten. Entweder wurde der SQL-Server nicht installiert, oder es wurde etwas anderes installiert, etwa ein Scherz dar√ºber, wie es w√§re, wenn die Programmierer √Ñrzte w√§ren: ‚ÄûDoktor, mein Bein tut weh ... - na ja, nicht Ich wei√ü, ich habe das gleiche Bein und nichts tut weh! ‚Äú <br><br>  An dieser Stelle mache ich zwei weitere Verbindungszeichenfolgen, appsettings.json nimmt diese Form an: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Test"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Test;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Production"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Production;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre><br>  Ich mache ein Commit und f√ºge den folgenden Snapshot in das Repository ein: <br><br>  <b>Snapshot: Snap_1_DataBases</b> <br><br>  Erstellen Sie einen neuen Zweig, Snap_2_Configurations <br><br>  <b>Ziel: Arbeitskonfigurationen erstellen</b> <br><br>  Beim Wechseln von Konfigurationen k√∂nnen wir von √ºberall im Programm aus ber√ºcksichtigen, welche Konfiguration aktuell ist (in der Tat funktioniert sie in View nicht - wir m√ºssen eine spezielle Funktion ausf√ºhren, dies ist jedoch nicht wichtig): <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG  DEBUG #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta">  RELEASE ( DEBUG   ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  √ñffnen Sie die Datei Startup.cs und konvertieren Sie die ConfigureServices-Methode in diese: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre><br>  Wie Sie sehen, haben wir Habr1_Local durch eine Variable ersetzt. Abh√§ngig von der Konfiguration lautet der Verbindungsstring entweder Habr1_Local oder Habr1_Production <br><br>  Jetzt k√∂nnen Sie das Projekt starten und √ºberpr√ºfen, wie die Datenbanken je nach Konfiguration erstellt werden <br><br>  Wir w√§hlen DEBUG im Panel aus, starten, melden uns an, wenden die Migration an und pr√ºfen, ob die Datenbank erstellt wurde (Habr1_Local) <br><br>  Wir stoppen das Projekt, w√§hlen die Release-Konfiguration aus, starten, melden uns an, wenden die Migration an und pr√ºfen, ob die Datenbank erstellt wurde - wir haben 2 Basen. <br><br>  Fertig <br><br>  <b>Schnappschuss: Snap_3_HabrDB</b> <br><br>  <b>Zweck: Erstellen eines separaten Datenbankprojekts, das dann in verschiedenen Projekten verwendet werden kann</b> <br><br>  Warum ein eigenes Projekt? <br><br>  Einzelne Projekte haben mehrere Vorteile: <br><br><ul><li>  Sie k√∂nnen in anderen Projekten verwendet werden. </li><li>  Sie werden nicht erneut kompiliert, wenn keine √Ñnderungen vorgenommen wurden, was bedeutet, dass sich die Gesamtkompilierungszeit verringert </li><li>  Einzelne Projekte lassen sich leichter testen. </li></ul><br>  Also, die rechte Taste auf der L√∂sung - Hinzuf√ºgen -&gt; Neuer L√∂sungsordner, nennen Sie es DB. <br>  Dann rechts in den erstellten Ordner - neues Projekt hinzuf√ºgen -&gt; .net Standard, Name HabrDB. <br>  Aus irgendeinem Grund habe ich es als .net Standard 2.0 erstellt, ich muss es auf 2.1 √§ndern <br>  (Wenn Sie einen physischen Pfad erstellen, lassen Sie ihn im DB-Ordner und auch physisch liegen.) <br><br>  F√ºr mich sieht es so aus: <br><br><img src="https://habrastorage.org/webt/g4/kb/wu/g4kbwu45mu92my9ucaanuldtuhs.jpeg" alt="Bild"><br><br>  Wir haben also einen ApplicationDBContext im Projekt und einen eigenen erstellt?  Werden sie miteinander in Konflikt stehen?  Jetzt werden wir uns mit ihnen anfreunden.  Wir werden zwei verschiedene Kontexte zu derselben Datenbank haben, die sich nicht durch das Entity Framework schneiden.  Wir werden ihnen einen anderen Schemanamen geben: Einer bleibt standardm√§√üig dbo und der andere ist "habr". <br><br>  Wenn Sie solche Kontexte √ºber die Wurzel der Komposition verbinden, k√∂nnen sie in anderen Projekten fast transparent wiederverwendet werden.  (Z. B. Lagerkontext und Mitarbeiterkontext) <br><br>  Und noch ein architektonischer Moment, manchmal m√ºssen Sie dem Benutzer einige Ihrer Eigenschaften hinzuf√ºgen. Dies gilt nicht direkt f√ºr das Thema des Artikels, aber wir werden es nur tun, um zu wissen, wie es geht.  Au√üerdem k√∂nnen wir unabh√§ngig voneinander Kontexte erstellen und l√∂schen.  Eine gute Idee ist es, die Sicherheitstabelle mit personenbezogenen Daten zu trennen und auf Datenbankebene zu verschl√ºsseln (dies wird in diesem Projekt nicht durchgef√ºhrt, ist jedoch in der Regel manchmal erforderlich, auch gesetzlich). <br><br>  Ja, und es ist einfacher, auf diese Weise zu testen, Sie k√∂nnen nicht alle Tabellen auf einmal erstellen, sondern nur die, die zum Testen des angegebenen Kontexts erforderlich sind. <br><br>  Ich erstelle einen neuen Projektschnappschuss - Phase 4. <br><br>  <b>Die Ziele dieser Phase sind:</b> <br><br><ul><li>  √Ñndern Sie den Standardbenutzer in "Erweitert" </li><li>  Benutzer in Srartup.cs-Datei √§ndern </li><li>  Benutzer in LoginPartial und ViewImports √§ndern </li><li>  Erstellen Sie eine neue Migration, um automatisch eine Datenbank in einem neuen Format zu erstellen </li></ul><br>  Daher √ºbertragen wir die ApplicationDBContext-Klasse aus dem WebApp-Projekt nach HabrDB. <br><br>  Es ist nicht portabel, nur kopiert.  Wir entfernen es aus WebApp, √∂ffnen es aus dem HabrDB-Projekt und √§ndern seinen Namespace in HabrDB. Es treten viele Fehler auf. <br><br>  Ja, in diesem Projekt gibt es keine notwendigen Pakete, jetzt werden wir sie liefern. <br><br>  √úber Nuget m√ºssen Sie im HabrDB-Projekt Microsoft.AspNetCore.Identity.EntityFrameworkCore installieren. <br><br><img src="https://habrastorage.org/webt/wj/-d/q4/wj-dq4ldm5nx32fs9hvzdiya5ys.jpeg" alt="Bild"><br><br>  Wir klicken auf die Gl√ºhbirne und sie bietet uns an, die neuesten Versionen zu installieren. <br><br>  Die endg√ºltige SecurityDBContext-Datei (muss ebenfalls umbenannt werden) hat folgende Form: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SecurityDBContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptions&lt;SecurityDBContext&gt; options</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)</span></span> { } } }</code> </pre> <br>  Nach der Assembly <s>werden die</s> fehlerhaften <s>Dateien sorgf√§ltig verarbeitet. Zu</s> Recht haben wir ApplicationDBContext gel√∂scht und durch SecurityDBContext ersetzt.  Jetzt m√ºssen Sie alle Links zu ApplicationDBContext im gesamten Projekt durch SecurityDBContext ersetzen. <br><br>  Danach tauchten in meinem Projekt gelbe Dreiecke auf Referenzen von WebApp auf, die darauf hinweisen, dass einige Links fehlerhaft funktionieren.  Ich habe das Projekt ges√§ubert (build -&gt; clean solution), das Projekt geschlossen, alle Debug-, Release-, Obj- und Bin-Verzeichnisse aus dem Projektordner gel√∂scht, danach das Projekt erneut ge√∂ffnet, einige Zeit nach den erforderlichen Links im Internet gesucht und diese und Dreiecke geladen verschwunden - dann ist alles in Ordnung. <br><br>  L√∂schen Sie nun den Datenordner aus dem WebApp-Projekt, l√∂schen Sie unsere Datenbanken (Habr1_Local und Habr1_Production) im Fenster des SQL Server-Objekt-Explorers und f√ºhren Sie das Projekt aus.  Wir versuchen uns einzuloggen - und jetzt gibt es anstelle des Angebots zur Migration einen Fehler. <br><br><img src="https://habrastorage.org/webt/z_/ex/ca/z_excar1pqk18n8pdmyvf3eobog.jpeg" alt="Bild"><br><br>  Richtig, wir haben den Datenordner gel√∂scht, in dem sich alle Migrationen befanden, und jetzt wei√ü das Framework nicht mehr, was zu tun ist.  Aber es war so cool?!  Warum?  Dann werden wir jetzt die Benutzerklasse erweitern. <br><br>  F√ºgen Sie dem HabrDB-Projekt eine neue Datei hinzu: <br>  ApplicationUser.cs <br><br>  Wir erben es von IdentityUser <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>:<span class="hljs-title"><span class="hljs-title">IdentityUser</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String NickName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime BirthDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String PassportNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>  F√ºgen Sie in der SecurityDBContext-Datei im Klassenheader Folgendes hinzu: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>&gt;</code> </pre> <br>  Dies ist erforderlich, damit EntityFramework wei√ü, dass Sie beim Erstellen der Datenbank das erweiterte Benutzermodell aus der AppllicationUser-Klasse anstelle des Standardmodells verwenden m√ºssen. <br><br>  Die ConfigureServices-Methode in der Datei Startup.cs hat die folgende Form: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;SecurityDBContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;ApplicationUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;SecurityDBContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre> <br>  (Ersetzen Sie IdentityUser durch ApplicationUser.) <br><br>  F√ºgen Sie in der Datei _ViewImports.cshtml die Zeile hinzu <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">mit</a> HabrDB <br><br>  Jetzt sehen alle Ansichten unser Projekt mit der Basis und Sie m√ºssen zu Beginn der Ansichten nicht mehr <a href="https://habr.com/ru/users/using/" class="user_link">mit</a> HabrDB schreiben. <br><br>  √Ñndern Sie in der Datei _LoginPartial.cshtml all IdentityUser in ApplicationUser. <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">Verwenden von</a> Microsoft.AspNetCore.Identity <br>  Injizieren Sie SignInManager SignInManager <br>  Injizieren Sie UserManager UserManager <br><br>  F√ºr alle F√§lle kompilieren wir das Projekt, um sicherzustellen, dass wir keine Fehler haben und nicht vergessen haben, irgendwo etwas zu ersetzen. <br><br>  F√ºhren Sie nun die Migration durch. <br><br>  Sie m√ºssen die Package Manager-Konsole √∂ffnen, das DB / HabrDB-Projekt ausw√§hlen und darauf schreiben <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-migration initial</code> </pre> <br>  Folgendes habe ich bekommen: <br><br><img src="https://habrastorage.org/webt/95/zv/aj/95zvaj1nj3d42hnzq2rk_bvncvo.jpeg" alt="Bild"><br><br>  Der Migrations-Daddy erschien im HabrDB-Projekt und es gibt Dateien, mit denen wir unsere Datenbank automatisch erstellen k√∂nnen, jetzt jedoch mit unseren zus√§tzlichen Feldern - NickName, BirthDate, PassportNumber. <br><br>  Lassen Sie uns versuchen, wie es funktioniert - lassen Sie uns ausf√ºhren und versuchen, sich anzumelden (nicht registrieren, Sie m√ºssen dort komplexe Passw√∂rter eingeben): <br><br><img src="https://habrastorage.org/webt/01/ib/0u/01ib0ufzxz_bds3n2scb5pqgyoi.jpeg" alt="Bild"><br><br>  Mir wurde angeboten, eine Migration durchzuf√ºhren, und ich stimmte zu - dies ist unsere Basis: <br><br><img src="https://habrastorage.org/webt/qg/af/js/qgafjs_fgtlnj39nlru_bxb9a2a.jpeg" alt="Bild"><br><br>  Mit dieser Phase alles <br><br>  <b>Snapshot: Snap_4_Security ist</b> bereit <br><br>  Erstellen Sie den f√ºnften Schuss. <br><br>  <b>Ziele:</b> <br><br><ul><li>  Testverbindungszeichenfolge zum Laufen bringen </li><li>  Erstellen Sie ein Datenbanktestprojekt </li><li>  Lassen Sie das Testprojekt eine Basis erstellen und etwas N√ºtzliches testen </li></ul><br>  Wir klicken mit der rechten Maustaste auf den DB-Daddy und erstellen ein neues Projekt - MSTest .net core. <br>  Benennen Sie die einzige Datei in diesem Projekt in DBTest um und denken Sie ... <br>  Weiter wird es schwierig sein. <br><br>  Das problem <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie k√∂nnen wir einen Kontext erstellen, der garantiert mit der Testdatenbank kommuniziert, dh ConnectionString nicht nur aus einem anderen Projekt (WebApp) verwendet, sondern auch eine Verbindung mit Release- / Debug-Konfigurationen herstellt? Kann eine neue Konfiguration erstellen, z. B. Test ? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nein, dies ist ein m√∂glicher Datenverlust - irgendwie haben wir vergessen, dass wir vergessen haben, von der Testkonfiguration zu wechseln, auf die Schaltfl√§che Alle Tests ausf√ºhren zu klicken - und dort die gesamte Datenbank zu entfernen ... nein, diese Option funktioniert nicht ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erstellen also eindeutig einen Testkontext! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ñffnen Sie die HabrDBContext-Datei und √§ndern Sie ihren Inhalt in:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String ConnectionString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IConfigurationRoot Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HabrDBContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateTestContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { DirectoryInfo info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(Directory.GetCurrentDirectory()); DirectoryInfo temp = info.Parent.Parent.Parent.Parent; String CurDir = Path.Combine(temp.ToString(), <span class="hljs-string"><span class="hljs-string">"WebApp"</span></span>); String ConnStr = <span class="hljs-string"><span class="hljs-string">"Habr1_Test"</span></span>; Configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder().SetBasePath(CurDir).AddJsonFile(<span class="hljs-string"><span class="hljs-string">"appsettings.json"</span></span>).Build(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbContextOptionsBuilder&lt;HabrDBContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = Configuration.GetConnectionString(ConnStr); builder.UseSqlServer(connectionString); ConnectionString = connectionString; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√ºgen Sie √ºber Nuget der Datenbank die folgenden Bibliotheken hinzu: </font></font><br><br><pre> <code class="plaintext hljs">Microsoft.AspNetCore.Identity.EntityFrameworkCore Microsoft.EntityFrameworkCore Microsoft.EntityFrameworkCore.SqlServer Microsoft.Extensions.Configuration.FileExtensions Microsoft.Extensions.Configuration.Json</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die CreateTestContext-Methode kann einfach nur eine Verbindungszeichenfolge mit dem Namen Habr1_Test zur√ºckgeben. Sie m√ºssen es in einem anderen Projekt √ºbernehmen. Um das Projekt nicht √ºber einen Verweis zu verbinden, da wir nur eine Einstellung ben√∂tigen, bitten wir den Builder, Optionen basierend auf dem angegebenen connectionString zu erstellen. Dazu durchlaufen wir die Verzeichniskette von dem Verzeichnis, in dem das Testprojekt kompiliert wurde, bis zum Projektstammverzeichnis. Sammeln Sie den Pfad zum WebApp-Projekt aus den Teilen. Bitte f√ºgen Sie f√ºr uns die Konfigurationsdatei appsettings.json hinzu, in der unsere Einstellungen gespeichert sind, und kompilieren Sie diese in die Konfiguration. Weiter entfernt von dieser Konfiguration nehmen wir connectionString und merken es uns (wir werden es sp√§ter brauchen).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In gro√üen Projekten k√∂nnen Sie Einstellungen mit Zeichenfolgen, einer DLL oder einem Objekt in ein separates Projekt verschieben, um mit Caching auf Einstellungsdaten zuzugreifen. Vorerst wird ein einfacherer Ansatz ausreichen.</font></font><br><br>  Warum so? <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie k√∂nnen einen Test ConnectionString direkt in das Testprojekt einf√ºgen und die Datenbank damit initialisieren. Sie k√∂nnen einen Test ConnectionString in der Datenbank erstellen. </font><font style="vertical-align: inherit;">Aber dann wird es eine unangenehme Sache geben: Alle Verbindungszeichenfolgen werden an verschiedenen Orten gespeichert. </font><font style="vertical-align: inherit;">Aber ich selbst wei√ü, dass mein Kopf voller L√∂cher ist und ich kann vergessen, etwas zu √§ndern, wenn sich zum Beispiel der Name der Datenbank oder des Servers √§ndert, und damit ich alle Verbindungslinien an einem Ort habe, mache ich das. </font><font style="vertical-align: inherit;">Durch √Ñndern der Konfigurationsdatei appsettings.json k√∂nnen Sie jetzt alle Verbindungen verwalten. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versuchen wir nun, mit der Basis etwas N√ºtzliches zu tun, zum Beispiel etwas zu erstellen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im HabrDB-Projekt habe ich den DBClasses-Ordner erstellt, dort werden nur Datenbanktabellenklassen vorhanden sein. </font><font style="vertical-align: inherit;">Wir arbeiten zuerst den Code durch. Wenn ich mir vorstellen kann, was ich tue, ist es f√ºr mich normalerweise bequemer.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen Sie eine Tabelle wie folgt: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations.Schema; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB.DBClasses</span></span> { [Table(<span class="hljs-string"><span class="hljs-string">"Phones"</span></span>, Schema =<span class="hljs-string"><span class="hljs-string">"Habr"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Phone</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Model { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime DayZero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie meine Klasse der Sch√∂nheit halber "Telefon" und die Tabelle in der Datenbank im Plural "Telefone" hei√üen. </font><font style="vertical-align: inherit;">Daher gebe ich im Tabellenattribut an, wie meine Tabelle benannt werden soll und in welchem ‚Äã‚ÄãNamespace sie sich in der Datenbank befinden soll (in SQL wird dies als Schema bezeichnet). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetzt gibt es noch eine andere Frage der √Ñsthetik: Hier haben wir eine Reihe verschiedener Infrastrukturmethoden in der Datenbankklasse, und dann haben wir verschiedene Tabellen und das alles in einem Haufen - Sie k√∂nnen Teilklassen erstellen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie das Wort partiell nach der Wortklasse in die Datei HabrDBContext.cs ein - wie folgt:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie </font><font style="vertical-align: inherit;">eine Kopie der Datei HabrDBContext.cs - proosto STRG + C - STRG + V auf der Datei, wird </font><font style="vertical-align: inherit;">eine Kopie erstellt wird, wir den urspr√ºnglichen Dateinamen HabrDBContext_Infrastructure.cs √§ndern, die neuen auf HabrDBContext_Data.cs </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New Schreiben:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Phone&gt; Phones { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetzt ist es sch√∂n - wir arbeiten an einem Ort mit Daten, an einem anderen mit Infrastruktur. </font><font style="vertical-align: inherit;">Die Dateien sind unterschiedlich, aber die Klasse ist dieselbe - die Umgebung selbst setzt sie beim Erstellen des Projekts aus mehreren in eine zusammen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, probier es aus! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie den Code in unserer einzigen Testklasse durch:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.Phones.ToList(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.Phones.Add(ph); db.SaveChanges(); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Klicken Sie auf der Registerkarte Test Explorer (oder Test -&gt; Alle Tests ausf√ºhren) auf die Wiedergabetaste und ... </font></font><br><br><img src="https://habrastorage.org/webt/9w/qe/68/9wqe686vdpg6jet-epu30oakdou.jpeg" alt="Bild"><br><br>  Fehler!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier sind die auf. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir lesen, was sie uns schreiben:</font></font><br><br><pre> <code class="plaintext hljs">Message: Test method DBTest.DBTest.TestMethod1 threw exception: System.InvalidOperationException: No database provider has been configured for this DbContext. A provider can be configured by overriding the DbContext.OnConfiguring method or by using AddDbContext on the application service provider. If AddDbContext is used, then also ensure that your DbContext type accepts a DbContextOptions&lt;TContext&gt; object in its constructor and passes it to the base constructor for DbContext.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Irgendeine Schei√üe auf Englisch ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Okay, wir werden nach dem Zufallsprinzip handeln! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K√∂nnte diese Funktion in die Datei HabrDBContext_Infrastructure.cs kopiert werden? </font><font style="vertical-align: inherit;">Lass es uns versuchen!</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfiguring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Configuration == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr= "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> Configuration = new ConfigurationBuilder() .SetBasePath(Directory.GetCurrentDirectory()) .AddJsonFile("appsettings.json").Build(); ConnectionString = Configuration.GetConnectionString(ConnStr); } optionsBuilder.UseSqlServer(ConnectionString); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir fangen an ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das war ein Gl√ºcksfall !!! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine neue Basis wurde geschaffen und darin - unser Tisch! </font></font><br><br><img src="https://habrastorage.org/webt/an/cv/1a/ancv1ahppxwymetpwayqqwdtlzg.jpeg" alt="Bild"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum so?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie den OnConfiguring- und CreateTestContext-Funktionen einige Haltepunkte zuweisen, wird zuerst die CreateTestContext-Methode aufgerufen, und die Verbindungszeichenfolge wird im ConnectionString-Objekt gespeichert. Alles scheint in Ordnung zu sein. Aber dann versucht jemand OnConfiguring anzurufen ... wer ist das? Schauen wir uns die Aufrufliste an - ja, das ist die Zeile db.Database.EnsureCreated () aus dem Test! Tatsache ist, dass wir noch keine Basis als solche haben - die EnsureCreated-Methode schafft es. Diese Methode ben√∂tigt jedoch keine Parameter mehr und der Kontext muss zwischen den Aufrufen des Konstruktors und von EnsureCreated beibehalten werden. Wenn wir diesen Kontext aus dem Projekt selbst verwenden (nicht zum Testen, sondern zum Beispiel auf der Website), versuchen dar√ºber hinaus alle Arten von Middlware, DI und anderen eing√§ngigen Mechanismen, ihn aufzurufen, sodass wir alles im Voraus vorhersehen - wer auch immer unsere Datenbank aufruft ,Wenn er OnConfiguring anrufen m√∂chte, hat er eine solche Gelegenheit. Wir haben f√ºr alles gesorgt.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºhren Sie den Test erneut aus - und ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wieder ein Fehler? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Datenbank ist schon da, die Daten sind ... was ist los? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Basis ist ein best√§ndiges Objekt, das erhalten bleibt, auch wenn wir unser Projekt neu starten ... und jetzt beginnt der wirklich schwierige Teil. Wie l√∂sche ich diese alle Tabellen? Wie l√∂sche ich Daten, setze alle Indizes zur√ºck? </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snapshot: Snap_5_ContextCrafting ist fertig.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schreiben Sie zuerst DAL - Data Access Layer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie eine Kopie der Datei HabrDBContext_Data.cs, ‚Äã‚Äãrufen Sie sie HabrDBContext_DAL.cs auf </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und schreiben Sie darin:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Phone ph</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.Add(ph); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SaveChangesAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;List&lt;Phone&gt;&gt; GetAllPhones() { List&lt;Phone&gt; phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> phones; } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist ein Wrapper √ºber unsere Daten. Ich w√ºrde nicht wollen, wenn ich etwas an den Schnittstellen f√ºr den Zugriff auf die Datenbank √§ndere, um die Suche w√§hrend des gesamten Projekts, in dem ich sie aufgerufen habe, zu behandeln. Aus diesem Grund erstellen wir eine Abstraktionsschicht - die Datenzugriffsschicht. Er wird der Vermittler zwischen den Basis- und MVC-Mechanismen des Standorts oder anderen Mechanismen sein. Und - ein Zufall? - Wir haben sofort Testobjekte! Ein weiterer Grund f√ºr die Verwendung von Tests besteht darin, dass sie L√∂sungen mit geringer Konnektivit√§t provozieren. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ñndern Sie den Funktionscode in den Tests - und zum einen den Namen. Jetzt wissen wir, was wir testen! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telefon hinzuf√ºgen! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir werden das Repository nicht machen, f√ºr ein Demo-Projekt ist dies eine redundante L√∂sung. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normalerweise k√∂nnen Sie alles √ºber DI in startup.cs verbinden, aber f√ºr das Demo-Projekt ist dies zu verwirrend. Lassen wir es also so</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Neuer Testfunktionscode: </font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.GetAllPhones().Result; Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir werden die Leitung mit dem Telefon aus der Testdatenbank entfernen und den Test erneut ausf√ºhren - es sollte funktionieren. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn es nicht funktioniert, haben Sie immer noch ein anderes Bein. </font><font style="vertical-align: inherit;">Bei mir </font></font><br><br><img src="https://habrastorage.org/webt/kc/vz/ea/kcvzeaiyug4owclncwblblpqoaw.jpeg" alt="Bild"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist </font><font style="vertical-align: inherit;">alles gr√ºn: </font><font style="vertical-align: inherit;">Was ist db.GetAllPhones (). Ergebnis? </font><font style="vertical-align: inherit;">Tatsache ist, dass unsere DAL-Funktionen asynchron sind. </font><font style="vertical-align: inherit;">Die Testmethode selbst ist jedoch normal und daher kann wait nicht darin aufgerufen werden. </font><font style="vertical-align: inherit;">Versuchen wir, die Daten zu l√∂schen, die Methode asynchron zu machen und zu sehen, was passiert. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere Funktion ist zu einer asynchronen Aufgabe geworden. Andernfalls wird der Test nicht gestartet, und wo immer asynchrone Methoden aufgerufen werden, m√ºssen Sie auf sie warten</font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist wichtig, dass alle Testfunktionen, bei denen es asynchrone Aufrufe gibt, Task und nicht void zur√ºckgeben. Andernfalls werden die Tests entweder nicht gestartet oder warten nicht auf die R√ºckgabe asynchroner Daten und gehen weiter, und es tritt ein Fehler auf. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also funktioniert mehr oder weniger. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snapshot: Snap_6_Dal</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Und was ist es </font><b><font style="vertical-align: inherit;">notwendig,</font></b><font style="vertical-align: inherit;"> Daten manuell </font><b><font style="vertical-align: inherit;">zu</font></b><font style="vertical-align: inherit;"> l√∂schen?</font></font> Nat√ºrlich nicht! <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir brauchen eine Funktion zum L√∂schen von Tabellen aus der Datenbank ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es w√§re cool, db.Database.EnsureDeleted zu verwenden ... und es ist wirklich m√∂glich! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber besser ist nicht n√∂tig ... Tatsache ist, dass in diesem Projekt unsere Basen nicht mit Passw√∂rtern verbunden sind. Wenn die Datenbank einem Kennwort zugeordnet ist, m√ºssen Sie es separat erstellen - √ºber SQL Management Studio. Wenn Sie es aus db.Database.EnsureDeleted l√∂schen, wird es zusammen mit allen Kennw√∂rtern, Zugriffen und Benutzerrechten gel√∂scht. Wenn das Framework das n√§chste Mal versucht, es zu erstellen, dann gibt es einfach keinen zugriff auf die datenbank, du musst alles neu konfigurieren.</font></font><br><br>  Dies ist der erste. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das zweite ist, dass es besser ist, keine unn√∂tige Arbeit zu leisten. Daher dauern die Datenbanktests l√§nger als die √ºblichen Funktionen, die sich nicht auf externe Mechanismen beziehen, und es ist besser, die Testzeit auf alle m√∂glichen Arten zu optimieren. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und drittens: Vielleicht m√ºssen wir in einem Test eine oder mehrere Tabellen l√∂schen und neu erstellen, w√§hrend die anderen Tabellen intakt bleiben. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie uns versuchen, die Funktion db.Database.EnsureDeleted aufzurufen, die Klammer zu dr√ºcken und zu sehen, was sie akzeptiert und ob sie √úberladungen aufweist ... </font></font><br><br><img src="https://habrastorage.org/webt/uh/by/ti/uhbytib40xtjnbwfapd26iqtrus.jpeg" alt="Bild"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ja, nicht viel ... </font><font style="vertical-align: inherit;">Nun </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ok, lassen Sie uns unsere eigene schreiben. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie der Projektmappe (in der Projektmappe selbst) mit der rechten Maustaste ein neues Projekt hinzu, f√ºgen Sie -&gt; .net standard C # hinzu, und nennen Sie es Extensions. √úberpr√ºfen Sie, ob es sich um die 2.1-Version handelt.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Als N√§chstes m√ºssen Sie die einzige Datei im Extensions-Projekt in DBContextExtensions.cs umbenennen und den folgenden Code dort einf√ºgen: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore.Infrastructure; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Extensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBContextExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { TableDescription Table = GetTableName(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = db.ExecuteSqlRaw(<span class="hljs-string"><span class="hljs-string">$"DROP TABLE [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.Schema}</span></span></span><span class="hljs-string">].[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.TableName}</span></span></span><span class="hljs-string">];"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TableDescription GetTableName&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = dbSet.GetDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = dbContext.Model; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityTypes = model.GetEntityTypes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityType = entityTypes.First(t =&gt; t.ClrType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableNameAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:TableName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableSchemaAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:Schema"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableName = tableNameAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schemaName = tableSchemaAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TableDescription { Schema = schemaName, TableName = tableName }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> infrastructure = dbSet <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IInfrastructure&lt;IServiceProvider&gt;; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceProvider = infrastructure.Instance; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentDbContext = serviceProvider.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ICurrentDbContext)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ICurrentDbContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentDbContext.Context; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TableDescription</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Schema { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String TableName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie Microsoft.EntityFrameworkCore aus Nuget hinzu, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und ein weiteres Paket, Microsoft.EntityFrameworkCore.Relational </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extensions, ist ein sehr praktischer Mechanismus. </font><font style="vertical-align: inherit;">Damit k√∂nnen Sie dem Klassenobjekt zus√§tzliche Funktionen hinzuf√ºgen, wie wir es getan haben - das this-Schl√ºsselwort vor dem Typ des ersten Parameters</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gibt einen erweiterbaren Typ an. Dies bedeutet, dass das DatabaseFacade-Objekt nach dem Schreiben eine neue Methode hat - EnsureDeleted mit einem Parameter, der unsere Funktion ist, die wir gerade geschrieben haben! Wobei TEntity: class am Ende bedeutet, dass TEntity eine Einschr√§nkung hat - eine Einschr√§nkung der Verwendung. Wenn wir versuchen, sie nicht durch eine Klasse, sondern durch etwas anderes zu verallgemeinern, tritt beim Kompilieren ein Fehler auf. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich sehe deine logische Frage voraus - warum ist das so? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die GetTableName-Funktion, die von EnsureDeleted aufgerufen wird, ben√∂tigt diese Einschr√§nkung. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum braucht sie diese Einschr√§nkung? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Welche Funktion GetDbContext, die von GetTableName aufgerufen wird, ben√∂tigt diese Einschr√§nkung ebenfalls ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und warum ben√∂tigt sie diese Einschr√§nkung ??? !!! Sie fragen in erh√∂hten T√∂nen und Sie werden Recht haben ...</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das dbSet, das wir mit der GetDbContext-Methode in der Zeile erweitern m√∂chten</font></font><br><br><pre> <code class="cs hljs">Public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erfordert, dass T ein Referenztyp ist, und Klasse ist nur einer von ihnen ... Bei </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all diesen Schwierigkeiten - f√ºr ein kleines, aber sehr n√ºtzliches Feature - werden der EnsureDeleted-Methode keine Zeichenfolgenwerte als Parameter √ºbergeben. Weil ich ein schlechtes Ged√§chtnis habe. Ich m√∂chte, dass DBContext mir mitteilt, √ºber welche Tabellen er verf√ºgt, und aus diesem Datensatz den Kontext berechnet, ihn √ºber den Dienstanbieter in den aktuellen Kontext bringt, dann das Modell aus diesem Kontext entnimmt, Typen daraus entnimmt und dann nach dem Typ mit diesen Typen sucht Das gleiche wie das Dataset (dies ist bereits in GetTableName enthalten), dann √ºbergibt es durch Annotationen den Namen der Tabelle und des Schemas bereits an EnsureDeleted und dann - verdammt! wieder gibt es keine Funktion wie removetable oder so, man muss SQL-Syrniki aus Strings konstruieren ... na ja, zumindest irgendwie hat es geklappt!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und die Ausnahme ist die Funktion EnsureDeleted, sodass Sie nicht √ºber die Vorgehensweise zum L√∂schen von Tabellen nachdenken k√∂nnen. Wenn dort verwandte Daten vorhanden sind, versuchen Sie nach dem L√∂schen der verwandten Tabellen, die Tabelle erneut zu l√∂schen, ohne sich darum zu k√ºmmern. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie die Methode zu den Tests hinzu (am Ende)</font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laufen, √ºberpr√ºfen, ausatmen ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laufen Sie noch einmal - sollte funktionieren. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jedes Mal, wenn Sie Tests ausf√ºhren, werden die erforderlichen Tabellen erstellt und anschlie√üend gel√∂scht. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snapshot: Snap_7_Extensions</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> neue </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√§morrhoiden</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Horizonte </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber es gibt ein Problem - HabrDBContext Objekt , das </font><font style="vertical-align: inherit;">wir nicht persistent sind (in jedem Testverfahren erstellt). </font><font style="vertical-align: inherit;">(Nun ja, die Kagbe-Idee von Komponententests ist zu isolieren. Und wir versuchen, sie zu durchbrechen! Es ist gut, dass die Polizei nicht sieht ...) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das hei√üt, bei jeder Testmethode wird der Kontext neu erstellt, und wir k√∂nnen dieses Objekt nicht zwischen Funktionen teilen damit es allen gemeinsam ist und einmalig f√ºr alle tests erstellt wird. </font><font style="vertical-align: inherit;">K√∂nnen wir nicht </font><font style="vertical-align: inherit;">Okay, wir werden in jede Funktion schreiben.</font></font><br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und die letzte Methode aufrufen </font></font><br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und einige andere Tische ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist nicht sehr sch√∂n, daher werden wir uns √ºberlegen, wie wir dieses Problem l√∂sen k√∂nnen. Da wir uns wie Tester kleiden, m√ºssen wir dem Bild entsprechen - wir werden nach einer L√∂sung suchen! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klassen haben solch eine interessante Eigenschaft - statische Mitglieder. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie sich eine Zeichnung und ein Objekt aus dieser Zeichnung vorstellen, stellt sich heraus, dass es sich bei einem statischen Element nicht um ein Element handelt, das dem aus der Zeichnung erstellten Objekt eigen ist, sondern um diese Zeichnung selbst. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ist schon interessant ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetzt lass es uns versuchen! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere Testklasse hei√üt DBTest, erstellen Sie ein statisches Objekt daf√ºr - db</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db; [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AA0_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br>  Es funktioniert <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber etwas ist dumm, solche Methoden zu nummerieren. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt eine L√∂sung! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spezielle Testattribute! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie im Testprojekt eine neue Klasse mit dem Namen DBTestBase und erben Sie die DBTest-Klasse davon. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus DBTest m√ºssen Sie alles entfernen, au√üer:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span>:<span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [ClassCleanup] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Der Inhalt der DBTestBase-Klasse: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once before the test run. (Optional) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [AssemblyInitialize] public static void AssemblyInit(TestContext context) { db = new HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes before this class creation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [ClassInitialize] public static void TestFixtureSetup(TestContext context) { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes Before each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestInitialize] public void Setup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once after the test run </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [AssemblyCleanup] public static void AssemblyCleanup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Runs once after all tests in this class are executed. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Not guaranteed that it executes instantly after all tests from the class. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [ClassCleanup] public static void TestFixtureTearDown() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes after each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestCleanup] public void TearDown() { //db.Database.EnsureDeleted();//don`t call! delete database instead of tables! } } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetzt ist alles klar! </font><font style="vertical-align: inherit;">Unsere Datenbank wird als statischer Teil der DBTestBase-Klasse erstellt und ist daher f√ºr alle von ihr geerbten Klassen zug√§nglich. </font><font style="vertical-align: inherit;">Dies bedeutet, dass die Datenbank nur einmal erstellt wird - beim Starten der Tests. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie das Attribut [ClassCleanup] zu jeder Methode einer Klasse hinzu - und f√ºhren Sie einen "saubereren" Test durch - eine Funktion, die etwas bewirkt, nachdem alle Tests dieser Klasse abgeschlossen wurden. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispielsweise werden alle in diesem Test erstellten Tabellen gel√∂scht, ohne dass die Datenbank selbst ber√ºhrt wird.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Da all diese Sonderfunktionen von den Metriken ausgeschlossen sind, k√∂nnen wir die reine Zeit sehen, f√ºr die unsere Funktionen arbeiten - wir f√ºgen einige verbleibende Objekte hinzu und wir sehen einen starken Anstieg der Arbeitszeit der Auswahlfunktion -, was bedeutet, dass etwas mit unseren DAL-Funktionen nicht stimmt und wenn Sie eine Funktion testen Bei einer Testmethode wird sofort klar, wo das Problem liegt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie k√∂nnen auch Wiedergabelisten aus Funktionen erstellen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist notwendig, um zB die Datenaufbereitungsfunktion aufzurufen (nur zum Testen). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann aktualisiert die DAL-Funktion diese Daten, dann eine andere DAL-Funktion, die beispielsweise etwas √ºberlegt oder einen Bericht aus diesen Daten anzeigt, und l√∂scht diese Daten. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So k√∂nnen wir einige Benutzeraktionen aus realen Gesch√§ftsprozessen nachahmen.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Wichtigste ist, dass au√üerhalb dieser Testattribute die Tests in alphabetischer Reihenfolge aufgerufen werden. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie also eine statische Sequenz ben√∂tigen, sollten Sie diese wie </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">folgt bezeichnen </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">T1_AddPhone_Test, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T2_RemovePhone_Test </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usw. ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, Sie k√∂nnen sich keine Sorgen mehr um unsere Datenbank machen - alles wird vollst√§ndig getestet! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und jetzt ist es Zeit zu schlafen! Ich habe dort noch ein M√§dchen nicht getestet ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erfolgreich getestet! Tsch√ºss alle! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Git-Repository-Projekt: </font></font><a href="https://github.com/3263927/Habr_1" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/3263927/Habr_1</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schreiben Sie in die Kommentare, ob dieses Thema interessant ist. Dann schreibe ich einen Beitrag √ºber das Testen von Identit√§t, Rollen, Anspr√ºchen, 3D-Authentifizierung und das Schreiben meines TypeFilterAttribute EHE WIRD NICHT HERAUSGEHEN, BIS GEPR√úFT WERDEN !: /) </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich kann schon, ich habe den Test bestanden</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ek/8u/bl/ek8ublhenuarw7809onfz2l_nx4.jpeg" alt="Bild"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481474/">https://habr.com/ru/post/de481474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481460/index.html">Messaging -> PubSub in OTP</a></li>
<li><a href="../de481462/index.html">Die Geschichte der Lernsoftware: die Entwicklung von PCs und virtuellen Lehrern</a></li>
<li><a href="../de481466/index.html">So erstellen Sie Projekte in Jenkins, wenn Sie viele verschiedene Umgebungen ben√∂tigen</a></li>
<li><a href="../de481470/index.html">Smarte Girlande f√ºr das ganze Jahr</a></li>
<li><a href="../de481472/index.html">DNS-Verlauf: Wenn Domainnamen bezahlt werden</a></li>
<li><a href="../de481476/index.html">Wie ich anfing auf Konferenzen zu sprechen und nicht aufh√∂ren kann</a></li>
<li><a href="../de481478/index.html">STM32 + CMSIS + STM32CubeIDE</a></li>
<li><a href="../de481480/index.html">Dies ist die Norm: Was sind normale Karten und wie funktionieren sie?</a></li>
<li><a href="../de481482/index.html">Cross-Posting auf eine Facebook-Seite mit dem PHP-SDK</a></li>
<li><a href="../de481484/index.html">Die KI, die versucht, Probleme zu vermeiden, lernte komplexes Verhalten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>