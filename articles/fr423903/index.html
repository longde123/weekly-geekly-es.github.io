<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàØÔ∏è üêÑ üåµ Immersion dans AD: nous analysons les attaques avanc√©es sur Microsoft Active Directory et comment les d√©tecter ‚ûï ‚öîÔ∏è ü§ë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Image: Pexels 

 Au cours des quatre derni√®res ann√©es, pas un seul Black Hat ou DEF CON n'a √©t√© sans rapport sur les attaques contre Microsoft Active ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Immersion dans AD: nous analysons les attaques avanc√©es sur Microsoft Active Directory et comment les d√©tecter</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/423903/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/a7/-h/dd/a7-hddi1lio7lql-ftmp3xryg1e.jpeg"></a> <br><br>  <i>Image: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pexels</a></i> <br><br>  Au cours des quatre derni√®res ann√©es, pas un seul Black Hat ou DEF CON n'a √©t√© sans rapport sur les attaques contre Microsoft Active Directory.  Les participants parlent de nouveaux vecteurs et de leurs inventions, mais n'oublient pas les astuces pour les d√©tecter et les pr√©venir.  Dans cet article, nous examinerons les moyens les plus courants d'attaquer la MA et fournirons des recommandations qui vous aideront √† vous prot√©ger contre eux. <a name="habracut"></a><br><br><h2>  Six attaques AD que vous ne pouvez pas ignorer </h2><br>  De nombreux fabricants de logiciels de surveillance de la s√©curit√© prennent d√©j√† en charge une vari√©t√© de techniques d'attaque dans leurs produits.  Examinons certains d'entre eux. <br><br><h3>  Passez le hash </h3><br>  Cette technique est possible gr√¢ce aux caract√©ristiques architecturales du protocole d'authentification NTLM, d√©velopp√© par Microsoft dans les ann√©es 90 du si√®cle dernier.  Afin de se connecter √† un h√¥te distant, un hachage de mot de passe est utilis√©, qui est stock√© dans la m√©moire de l'ordinateur √† partir duquel l'authentification a lieu.  En cons√©quence, il peut en √™tre extrait. <br><br><h3>  Mimikatz </h3><br>  Pour un fonctionnement pratique de Pass-the-Hash, le chercheur fran√ßais Benjamin Delpy (Benjamin Delpy) a d√©velopp√© en 2014 l'utilitaire mimikatz.  Il permet de vider les mots de passe en texte clair et les hachages NTLM de la m√©moire. <br><br><h3>  Force brute </h3><br>  Si l'attaquant n'a pas suffisamment d'informations d'identification qu'il a extraites d'un h√¥te, il peut recourir √† une technique grossi√®re mais efficace pour deviner les mots de passe. <br><br><h3>  utilisateur / domaine net </h3><br>  O√π trouver un dictionnaire de noms d'utilisateurs afin de mener Brute Force?  Tout membre du domaine peut utiliser la commande net user / domain, qui renvoie une liste compl√®te des noms d'utilisateurs d'AD. <br><br><h3>  Kerberoasting </h3><br>  Si le domaine utilise Kerberos comme protocole d'authentification, l'attaquant pourrait recourir √† une attaque Kerberoasting.  Tout utilisateur authentifi√© dans le domaine peut demander un ticket Kerberos pour acc√©der au service d'octroi de tickets.  TGS est chiffr√© avec le hachage de mot de passe du compte √† partir duquel le service cible s'ex√©cute.  Un attaquant qui a ainsi obtenu TGS peut d√©sormais le d√©crypter, en r√©cup√©rant un mot de passe et sans avoir peur de le bloquer, car il le fait hors ligne.  En cas de succ√®s, il re√ßoit un mot de passe du compte associ√© au service, qui est souvent privil√©gi√©. <br><br><h3>  Psexec </h3><br>  Apr√®s que l'attaquant a re√ßu les informations d'identification n√©cessaires, il est confront√© √† la t√¢che d'ex√©cuter des commandes √† distance.  L'utilitaire PsExec de la suite Sysinternals est bien adapt√© √† cela.  Il a fait ses preuves tant aupr√®s des administrateurs informatiques que chez les attaquants. <br><br><h2>  Sept sorts d'attaque pour capturer Active Directory </h2><br>  Nous passons maintenant √† sept sorts, gr√¢ce auxquels les attaquants peuvent prendre le contr√¥le total d'Active Directory.  Nous les diviserons en quatre √©tapes: <br><br><ol><li>  Intelligence. </li><li>  Promotion sur AD. </li><li>  Op√©ration. </li><li>  Capture de domaine. </li></ol><br>  Dans le diagramme, vous pouvez voir les quatre, ainsi que les techniques qui y sont utilis√©es.  Examinons chacun en d√©tail. <br><br><img src="https://habrastorage.org/webt/bq/lw/uf/bqlwufggd4wwixlwo6dsb5w66by.png"><br><br><h2>  √âtape 1. Exploration </h2><br>  Commen√ßons par la phase du renseignement. <br><br><h3>  Powerview </h3><br>  Cet outil fait partie du cadre de test de p√©n√©tration PowerShell populaire - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerSploit</a> .  Il s'appuie √©galement sur l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BloodHound</a> , qui cr√©e un graphique des relations d'objet dans AD. <br><br><img src="https://habrastorage.org/webt/vb/45/xl/vb45xlilemlfooxopnrxytorpq0.png"><br><br>  <i>Repr√©sentation graphique des relations d'objets Active Directory</i> <br><br>  Bloodhound offre imm√©diatement ces fonctionnalit√©s: <br><br><ul><li>  Trouvez les comptes de tous les administrateurs de domaine; </li><li>  rechercher les h√¥tes sur lesquels les administrateurs de domaine sont connect√©s; </li><li>  construire le chemin le plus court de l'h√¥te de l'attaquant √† l'h√¥te avec la session d'administration de domaine. </li></ul><br>  Le dernier paragraphe donne une r√©ponse √† la question de savoir quels h√¥tes doivent √™tre pirat√©s √† un attaquant pour acc√©der au compte d'administrateur de domaine.  Cette approche r√©duit consid√©rablement le temps n√©cessaire pour obtenir un contr√¥le total sur le domaine. <br><br>  PowerView diff√®re des utilitaires int√©gr√©s pour r√©cup√©rer des donn√©es sur les objets AD (par exemple, net.exe) en ce qu'il s'ex√©cute sur le protocole LDAP, pas SAMR.  L'√©v√©nement 1644 d'un contr√¥leur de domaine convient pour d√©tecter cette activit√©.  La journalisation de cet √©v√©nement est activ√©e en ajoutant la valeur appropri√©e dans le registre: <br><br> <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostic\\15 Field Engineering = 5</code> <br> <br><img src="https://habrastorage.org/webt/7q/i2/ny/7qi2nyhavykzj4rqdyohz3ou0pi.png"><br><br>  <i>Activation de la journalisation des √©v√©nements LDAP 1644</i> <br><br><img src="https://habrastorage.org/webt/aj/6m/1b/aj6m1bzfn0tgimroq6gnxva_7_e.png"><br><br>  <i>√âv√©nement 1644 avec param√®tres de demande LDAP</i> <br><br>  Il convient de pr√™ter attention au fait qu'il peut y avoir beaucoup de tels √©v√©nements, et une bonne alternative √† la d√©tection d'√©v√©nements est la d√©tection du trafic, car LDAP est un protocole en texte clair, en cons√©quence, toutes les demandes dans le trafic sont parfaitement visibles. <br><br> <a href=""><img src="https://habrastorage.org/webt/_w/cd/s3/_wcds3rfyfneg4f6fukn2ojjx4q.png"></a> <br><br>  <i>LDAP SearchRequest (cliquez pour ouvrir l'image en taille r√©elle)</i> <br><br>  Une autre caract√©ristique importante de ce framework est qu'il est √©crit en PowerShell pur et n'a aucune d√©pendance.  Et ici, pour la d√©tection, la fonction d'audit avanc√©e introduite dans PowerShell version 5 nous aidera.  L'√©v√©nement 4104 montre le corps d'un script dans lequel nous pouvons rechercher des noms de fonctions sp√©cifiques √† PowerView. <br><br><img src="https://habrastorage.org/webt/4g/3q/ri/4g3qri26i-n9yd52ca5s95o-fg0.png"><br><br><h3>  Analyse SPN </h3><br>  Il peut remplacer le nmap de lancement de l'attaquant.  Une fois que l'attaquant a d√©termin√© quels utilisateurs et groupes se trouvent dans AD, pour compl√©ter l'image, il aura besoin d'informations sur les services disponibles. <br><br><img src="https://habrastorage.org/webt/yt/gp/ro/ytgprok6xzem1x1ihixxn1awb1q.png"><br><br>  Ceci est g√©n√©ralement r√©solu en scannant les ports avec nmap.  Mais maintenant, ces informations peuvent √©galement √™tre obtenues aupr√®s de AD - elles y sont d√©j√† stock√©es.  Vous pouvez voir le r√©sultat d'une telle demande: renvoyer le soi-disant SPN (Service Principal Names).  Le SPN se compose d'une classe de service, il est unique pour chaque type de service, puis vient le nom d'h√¥te sous la forme de FQDN et pour certains services - port. <br><br><img src="https://habrastorage.org/webt/5b/z8/ot/5bz8otu_w7hroldiqy0wscyut-g.png"><br><br>  <i>Exemples SPN</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liste compl√®te des principaux noms de service</a></i> <br><br>  Afin de d√©tecter SPN Scan, l'audit des √©v√©nements LDAP vient √©galement √† la rescousse. <br>  Il est important de noter que le scan SPN a un avantage distinct sur le scan nmap: il est moins bruyant.  Lorsque vous utilisez nmap, vous devez vous connecter √† chaque n≈ìud et envoyer des paquets √† la plage de ports que vous avez sp√©cifi√©e.  Et pour obtenir la liste des SPN, vous devez envoyer une seule demande. <br><br><h3>  √ânum√©ration des sessions √† distance </h3><br>  Une t√¢che importante pour un attaquant au stade du mouvement lat√©ral consiste √† d√©terminer quel utilisateur est connect√© √† quelle machine.  Ou il a d√©j√† des informations d'identification d'utilisateur (hash ou ticket Kerberos), et il recherche des h√¥tes o√π vous pouvez vous connecter sans entrave.  Ou il est √† la recherche d'un h√¥te o√π il y a une session d'administrateur de domaine en direct. <br><br>  Ensuite, le sc√©nario fonctionne: chasse -&gt; compromettant tout h√¥te -&gt; Golfe de Mimikatz -&gt; profit. <br><br>  Vous pouvez utiliser 2 √©v√©nements pour d√©tecter cette technique.  4624 est une connexion r√©ussie sur un syst√®me distant avec une connexion de type 3, ainsi que des √©v√©nements d'acc√®s au r√©seau IPC $, et la nuance est le nom du canal - srvsvc.  La raison pour laquelle un tuyau est ainsi appel√© peut √™tre comprise par le trafic. <br><br> <a href=""><img src="https://habrastorage.org/webt/gl/5k/kf/gl5kkf1bkclyx3b5dgkvwhxpeyo.png"></a> <br><br>  <i>Cliquez pour ouvrir l'image en taille r√©elle.</i> <br><br>  Sur le c√¥t√© gauche, dans les cadres rouges, acc√©dez √† SMB, puis acc√©dez √† pipe - srvsvc.  Ce canal vous permet d'interagir √† l'aide du protocole distant sp√©cial du service serveur.  Il permet aux h√¥tes finaux d'en recevoir diverses informations administratives, notamment  Parmi les requ√™tes, il y en a une appel√©e NetSessEnum.  √Ä la suite de cette demande, une liste compl√®te des utilisateurs connect√©s au syst√®me distant avec l'adresse IP et les noms d'utilisateur est renvoy√©e. <br><br> <a href=""><img src="https://habrastorage.org/webt/6z/3-/oa/6z3-oas3amujm5b6kohgowgops0.png"></a> <br><br>  <i>Dans MaxPatrol SIEM, nous avons effectu√© une d√©tection bas√©e sur une combinaison de ces deux √©v√©nements en tenant compte de srvsvc.</i>  <i>Et une d√©tection de trafic similaire dans PT Network Attack Discovery.</i> <br><br><h2>  √âtape 2. Promotion AD </h2><br><h3>  Overpass-the-hash </h3><br>  La r√©incarnation de Pass-the-Hash.  Poursuivre le th√®me du mouvement lat√©ral.  Que peut faire un attaquant s'il poss√®de un hachage NTLM?  Il peut effectuer une attaque Pass-the-Hash - mais il y a d√©j√† des d√©tections sur elle.  Par cons√©quent, un nouveau vecteur a √©t√© trouv√© - l'attaque Overpass-the-Hash. <br><br>  Le protocole Kerberos a √©t√© con√ßu sp√©cifiquement pour que les mots de passe des utilisateurs sous une forme ou une autre ne soient pas transmis sur le r√©seau.  Pour ce faire, sur sa machine, l'utilisateur hache son mot de passe chiffre la demande d'authentification.  En r√©ponse, le Key Distribution Center (un service sp√©cial h√©berg√© sur le contr√¥leur de domaine) lui d√©livre un ticket pour recevoir d'autres tickets.  Le soi-disant Ticket-Granting Ticket (TGT).  Maintenant, le client est consid√©r√© comme authentifi√© et dans les 10 heures, il peut demander des billets pour acc√©der √† d'autres services.  En cons√©quence, si un hachage sous-jacent d'attaque d'un utilisateur qui est membre d'un groupe de confiance d'un service qui l'int√©resse, par exemple un syst√®me ERP ou une base de donn√©es, l'attaquant peut √©mettre un laissez-passer pour lui-m√™me et se connecter avec succ√®s au service qui l'int√©resse. <br><br><img src="https://habrastorage.org/webt/6s/iy/qv/6siyqv90fxjresvbwwzhw2ioynw.png"><br><br><h4>  Comment d√©tecter </h4><br>  Si l'attaquant utilise la version PowerShell de mimikatz pour cette attaque, la journalisation du corps du script vient √† la rescousse.  Parce que Invoke-Mimikatz est une ligne tr√®s caract√©ristique. <br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br>  Ou 4688 est un √©v√©nement de d√©marrage de processus avec un audit de ligne de commande avanc√©.  M√™me si le binar est renomm√©, alors sur la ligne de commande, nous trouverons une commande tr√®s caract√©ristique de mimikatz. <br><br><img src="https://habrastorage.org/webt/ur/li/cq/urlicqqkfzjpcphbagcrhvzdoxw.png"><br><br>  Le trafic Overpass-the-Hash peut √™tre d√©tect√© en fonction d'une anomalie r√©sultant du fait que Microsoft recommande d'utiliser la demande d'authentification AES256 pour le chiffrement des domaines actuels.  Et mimikatz, lorsqu'il envoie des donn√©es de demande d'authentification, il crypte les donn√©es en utilisant l'ARCFOUR obsol√®te. <br><br> <a href=""><img src="https://habrastorage.org/webt/1n/yh/tr/1nyhtr7fvxksqjh6snv_dwyhtco.png"></a> <br><br>  Dans la circulation, une autre diff√©rence est observ√©e en raison des caract√©ristiques du mimikatz.  Il est bas√© sur la diff√©rence de la suite de chiffrement dans le domaine l√©gitime et sur ce que mimikatz envoie. <br><br><h3>  Billet d'or </h3><br>  Que peut faire un attaquant s'il poss√®de un hachage de mot de passe d'un compte sp√©cial appel√© krbtgt?  Plus t√¥t, nous avons consid√©r√© le cas o√π l'utilisateur pourrait ne pas √™tre privil√©gi√©.  Nous envisageons maintenant un utilisateur avec un hachage de mot de passe dont absolument tous les billets pour d'autres billets (TGT) sont sign√©s.  En cons√©quence, l'attaquant ne s'adresse plus au centre de distribution de cl√©s, il g√©n√®re lui-m√™me ce ticket, car le Golden Ticket, en substance, est TGT.  Ensuite, il peut envoyer des demandes d'authentification √† n'importe quel service dans AD, et pour une dur√©e illimit√©e.  En cons√©quence, il se tourne librement vers cette ressource - le Golden Ticket n'est pas sans raison appel√© golden. <br><br><img src="https://habrastorage.org/webt/58/z6/vh/58z6vh3afwjzkebygy_jmxu6ee0.png"><br><br><h4>  Comment d√©tecter par les √©v√©nements </h4><br>  Il y a l'√©v√©nement 4768, qui dit que TGT a √©t√© √©mis, et l'√©v√©nement 4769, qui dit qu'un ticket de service a √©t√© √©mis, qui est n√©cessaire pour l'authentification sur certains services √† l'int√©rieur d'AD. <br><br><img src="https://habrastorage.org/webt/wx/l5/gx/wxl5gx-fncwjf1oukr1ldumzzv8.png"><br><br>  Ici, nous pouvons jouer sur la diff√©rence:  lors d'une attaque, Golden Ticket ne demande pas de TGT √† un contr√¥leur de domaine (il le g√©n√®re lui-m√™me), et il doit demander un TGS, si nous trouvons une diff√©rence dans le TGT et le TGS re√ßus, nous pouvons supposer qu'une attaque Golden Ticket a lieu. <br><br>  Dans MaxPatrol SIEM, en utilisant des listes de tableaux dans lesquelles nous enregistrons tous les TGT et TGS √©mis, nous avons r√©ussi √† impl√©menter une telle d√©tection. <br><br><h3>  Ex√©cution √† distance WMI </h3><br>  Une fois la t√¢che d'authentification et d'autorisation sur les h√¥tes souhait√©s r√©solue, l'attaquant peut commencer √† ex√©cuter des t√¢ches √† distance.  WMI, en tant que m√©canisme int√©gr√© et con√ßu pour cela, s'int√®gre parfaitement.  Au cours des derni√®res ann√©es, ¬´vivre de la terre¬ª signifie utiliser les m√©canismes Windows int√©gr√©s dans une tendance.  Tout d'abord, car cela vous permet de vous d√©guiser en activit√© l√©gitime. <br><br> <a href=""><img src="https://habrastorage.org/webt/m-/96/ez/m-96ez5gjcxuckslwxweegfopcu.png"></a> <br><br>  Dans la capture d'√©cran, l'utilisation de l'utilitaire wmic int√©gr√©.  Il sp√©cifie l'adresse de l'h√¥te auquel vous souhaitez vous connecter, les informations d'identification, l'instruction create appel de processus et la commande qui doit √™tre ex√©cut√©e sur l'h√¥te distant. <br><br><h4>  Comment d√©tecter </h4><br>  Sur un tas d'√©v√©nements d'une connexion √† distance 4624 (faites attention √† <br>  mania on Logon ID) et l'√©v√©nement 4688, qui parlent du d√©marrage d'un processus avec la ligne de commande.  4688 - vous pouvez voir que le parent du processus lanc√© est WmiPrvSE.exe, un processus de service WMI sp√©cial utilis√© pour l'administration √† distance.  La commande que nous avons envoy√©e √† net user / add est visible et l'ID de connexion correspond √† l'√©v√©nement 4624. Par cons√©quent, nous pouvons dire exactement √† partir de quel h√¥te cette commande s'ex√©cute. <br><br><img src="https://habrastorage.org/webt/7u/eb/ei/7uebeito5oikpqj5c_uth187-3m.png"><br><br><h4>  D√©tection du trafic </h4><br>  Ici, nous voyons clairement les mots caract√©ristiques du processus Win32 cr√©er, ainsi que la ligne de commande, qui est envoy√©e pour d√©marrer.  Dans la capture d'√©cran, nous avons r√©cemment rencontr√© un malware, qui a √©t√© distribu√© dans des r√©seaux virtuels selon un principe similaire √† WannaCry, mais au lieu du cryptage, il a install√© un mineur.  Malvar a emport√© mimikatz et EthernalBlue avec elle, elle a vid√© les comptes, avec leur aide, elle s'est connect√©e √† tous les h√¥tes qu'elle pouvait atteindre sur le r√©seau.  √Ä l'aide de WMI, elle a lanc√© PowerShell sur eux, t√©l√©charg√© la charge utile PowerShell, qui contenait √† nouveau mimikatz, EthernalBlue et le mineur.  Ainsi, une r√©action en cha√Æne a √©t√© obtenue. <br><br><img src="https://habrastorage.org/webt/xm/jy/yb/xmjyybw60n3mxmjjrnm8wwvsrq8.png"><br><br><h2>  Recommandations pour les √©tapes 1 √† 3 </h2><br><blockquote>  1. <b>Mots de passe longs et complexes (&gt; 25 caract√®res) pour les comptes de service.</b>  Cela ne laissera pas √† un attaquant une chance de mener une attaque Kerberoasting, car  Brute aura tr√®s longtemps. <br><br>  2. <b>Journalisation de PowerShell</b> .  Il aidera √† d√©tecter l'utilisation de nombreux outils modernes pour les attaques contre AD <br><br>  3. <b>Passage √† Windows 10, Windows Server 2016.</b> Microsoft a cr√©√© Credential Guard: il ne sera plus possible de vider les hachages NTLM et les tickets Kerberos de la m√©moire <br><br>  4. <b>D√©limitation stricte des r√¥les</b> .  Il est dangereux de combiner en un seul r√¥le l'administrateur de AD, DC, tous les serveurs et machines de travail <br><br>  5. <b>Double changement de mot de passe krbtgt (c'est le m√™me compte avec lequel les tickets TGT s'inscrivent)</b> .  Chaque ann√©e.  Et apr√®s que l'administrateur AD quitte AD: <br><ul><li>  doivent √™tre chang√©s deux fois, car  le mot de passe actuel et pr√©c√©dent sont stock√©s, </li><li>  changer chaque ann√©e, incl.  apr√®s avoir quitt√© l'administrateur de domaine.  M√™me si le r√©seau est d√©j√† compromis et que les attaquants ont √©mis un Golden Ticket, changer le mot de passe rend ce Ticket inutile.  Et encore une fois, ils doivent tout recommencer. </li></ul><br>  6. <b>Rem√®des avec une base de connaissances d'experts constamment mise √† jour</b> .  Il est n√©cessaire de d√©tecter de v√©ritables attaques r√©elles. </blockquote><br><h2>  √âtape 4. Capture de domaine </h2><br><h3>  DCShadow </h3><br>  Le 24 janvier 2018, lors de la conf√©rence Microsoft BlueHat en Isra√´l, Benjamin Delpy et Vincent Le Toux ont pr√©sent√© le nouveau module mimikatz, qui impl√©mente l'attaque DCShadow.  L'essence de l'attaque est qu'un faux contr√¥leur de domaine est cr√©√© pour modifier et cr√©er de nouveaux objets dans AD via la r√©plication.  Les chercheurs ont r√©ussi √† isoler l'ensemble minimal de SPN Kerberos requis pour passer par le processus de r√©plication - ils n'en ont besoin que de 2. De plus, ils ont pr√©sent√© une fonction sp√©ciale qui peut forcer la r√©plication des contr√¥leurs.  Les auteurs de l'attaque le positionnent comme une attaque qui rendra votre SIEM aveugle.  Parce que  un faux contr√¥leur de domaine n'envoie pas d'√©v√©nements √† SIEM, ce qui signifie que les attaquants peuvent faire diverses choses sombres avec AD et SIEM n'en sera pas inform√©. <br><br><img src="https://habrastorage.org/webt/op/t5/nv/opt5nvhaixi6i8da_2ixv5kivmk.png"><br><br><h4>  Mod√®le d'attaque </h4><br>  Sur le syst√®me avec lequel l'attaque est effectu√©e, il est n√©cessaire d'ajouter 2 SPN, qui sont n√©cessaires pour que les autres contr√¥leurs de domaine puissent s'authentifier √† l'aide de kerberos pour la r√©plication.  Parce que  selon la sp√©cification, le contr√¥leur de domaine est repr√©sent√© dans la base de donn√©es AD par un objet de la classe nTDSDSA, il est n√©cessaire de cr√©er un tel objet.  Enfin, appelez la r√©plication √† l'aide de la fonction DRSReplicaAdd. <br><br><h4>  Comment d√©tecter </h4><br>  A quoi ressemble DCShadow dans le trafic.  Par le trafic, nous voyons clairement l'ajout d'un nouvel objet au sch√©ma de configuration de type contr√¥leur de domaine, puis le d√©marrage forc√© de la r√©plication <br><br><img src="https://habrastorage.org/webt/fl/fa/xf/flfaxfzh1dwlccjntfdgcs44aui.png"><br><br>  En raison du fait que notre corr√©lation conna√Æt la liste des contr√¥leurs de domaine l√©gitimes, elle sera d√©clench√©e lorsque la r√©plication se produit √† partir d'un contr√¥leur de domaine qui n'est pas inclus dans cette liste blanche.  En cons√©quence, la division de la s√©curit√© de l'information peut mener une enqu√™te et comprendre d√©j√† qu'il s'agit d'un contr√¥leur de domaine l√©gitime qui a √©t√© ajout√© par le service informatique, ou attaque DCShadow. <br><br><h2>  Conclusion </h2><br>  L'exemple DCShadow montre qu'il existe de nouveaux vecteurs d'attaque pour l'entreprise.  Dans cet oc√©an d'√©v√©nements li√©s √† la s√©curit√© de l'information, il est tr√®s important de rester au sommet de la vague: regardez plus loin et avancez rapidement.  Chaque jour, au PT Expert Security Center, nous recherchons de nouvelles menaces et d√©veloppons des m√©thodes et des outils de d√©tection pour elles.  Et nous sommes pr√™ts √† partager davantage ces informations. <br><br>  <b>Publi√© par</b> Anton Tyurin, chef de l'√©quipe de d√©tection des attaques, Positive Technologies </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423903/">https://habr.com/ru/post/fr423903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423891/index.html">Arbres d'expression de d√©veloppement d'entreprise</a></li>
<li><a href="../fr423893/index.html">Hello World pour recevoir des donn√©es d'un appareil Bluetooth (BLE) via C #</a></li>
<li><a href="../fr423895/index.html">Vous n'avez pas besoin d'un avocat. Mais ce n'est pas s√ªr</a></li>
<li><a href="../fr423897/index.html">Conseils utiles pour l'utilisation de l'assistant DDR HyperLynx pour l'analyse QDR4</a></li>
<li><a href="../fr423901/index.html">Lorsque la vitesse et la mise √† l'√©chelle sont n√©cessaires: serveur d'appareils iOS distribu√©s</a></li>
<li><a href="../fr423905/index.html">Les d√©veloppeurs sont rest√©s inconnus. Conf√©rence Yandex</a></li>
<li><a href="../fr423911/index.html">La photonique sur silicium tr√©buche sur le dernier m√®tre</a></li>
<li><a href="../fr423919/index.html">Comment automatiser la collecte de KPI par mois et laisser les utilisateurs presque satisfaits</a></li>
<li><a href="../fr423921/index.html">10 ans d'Android: souvenez-vous de tout</a></li>
<li><a href="../fr423923/index.html">SAP Leonardo Hackathon de velcom et SAP pour les d√©veloppeurs de Bi√©lorussie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>