<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛹🏻 👒 🔶 在BASCOM AVR环境中用于MK AVR的AQUA RTOS实时操作系统 🚴🏾 🥙 🤚🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="当编写比“闪烁灯”更复杂的MK代码时，开发人员将面临“超级循环加中断”风格的线性编程固有的局限性。 处理中断需要速度和简洁性，这会导致在代码中添加标志，并使项目样式“带有中断和标志的超循环”。 

 如果系统的复杂性增加，则相互依赖标志的数量将成倍增加，并且该项目将迅速变成可读性差且易于管理的“意大...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在BASCOM AVR环境中用于MK AVR的AQUA RTOS实时操作系统</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453708/">当编写比“闪烁灯”更复杂的MK代码时，开发人员将面临“超级循环加中断”风格的线性编程固有的局限性。 处理中断需要速度和简洁性，这会导致在代码中添加标志，并使项目样式“带有中断和标志的超循环”。 <br><br> 如果系统的复杂性增加，则相互依赖标志的数量将成倍增加，并且该项目将迅速变成可读性差且易于管理的“意大利面代码”。 <br><br> 实时操作系统的使用有助于摆脱“ pasta代码”，并将灵活性和可管理性返回给复杂的MK项目。 <br> 已经开发了几种协作式实时操作系统，并在AVR微控制器中非常流行。 但是，它们都是用C或汇编语言编写的，因此不适合在BASCOM AVR环境中对MK进行编程的人员，这使它们失去了编写严重应用程序的有用工具。 <br><br> 为了纠正此缺点，我为BASCOM AVR编程环境开发了一个简单的RTOS，引起了读者的注意。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/0be/c64/cd60bec64b2a0b96ed562770a9063355.jpg" alt="图片"><br><a name="habracut"></a><br> 对于许多人来说，熟悉的MK编程风格就是所谓的  <i>超循环</i> 。 在这种情况下，代码由一组函数，过程和描述符（常量，变量）（可能是库函数）（通常称为“背景代码”）以及包围在<b>do-loop</b>结构中的大型无限循环组成。 在启动时，首先对MK本身的设备和外部设备进行初始化，设置变量的常量和初始值，然后将控制权转移到该无限超循环。 <br> 超循环的简单性显而易见。  MK执行的大多数任务，因为一种方式或另一种周期性。 缺点也很明显：如果某些设备或信号需要立即做出反应，则MK将在周期周转之前立即提供。 如果信号持续时间短于循环周期，则将跳过该信号。 <br><br> 在下面的示例中，我们要检查按钮是否被<b>按下</b> ： <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">' -  if button = 1 then '     '  -  loop</span></span></code> </pre> <br> 显然，如果“某些代码”的工作时间足够长，则MK可能不会注意到短按按钮。 <br><br> 幸运的是，MK配备了可以解决此问题的中断系统：所有关键信号都可以“挂”在中断上，并且可以为每个中断编写处理程序。 因此出现了下一个层次： <i>带有中断</i>的<i>超级循环</i> 。 <br> 下面的示例显示了具有超循环和处理按钮单击的中断的程序结构： <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  loop end '   button_isr: '  -    return</span></span></code> </pre> <br> 但是，使用中断会带来一个新问题：中断处理程序代码应尽可能快且短一些； 内部中断，MK功能受到限制。 由于AVR MK没有分级中断系统，因此另一个中断不能在中断内部发生-此时它们已被硬件禁用。 因此，中断应尽快执行，否则其他中断（可能更重要的中断）将被跳过而不进行处理。 <br><br><div class="spoiler">  <b class="spoiler_title">中断记忆</b> <div class="spoiler_text"> 实际上，在中断内部，MK能够在特殊寄存器中记录另一个中断的事实，以便稍后对其进行处理。 但是，此中断不能立即处理。 <br></div></div><br> 因此，我们不能在中断处理程序中写一些复杂的东西，尤其是如果该代码应该有延迟的话-因为直到延迟起作用，MK才会返回主程序（超级循环），而对其他中断却无所作为。 <br><br> 因此，在中断处理程序内部，您通常只需要用一个标志（每个事件自己拥有）来标志事件的事实，然后检查并处理超循环内的标志即可。 当然，这会延长事件响应时间，但是至少我们不会错过一些重要的事情。 <br><br> 因此，出现了下一级的复杂性- <i>具有中断和标志</i>的超<i>循环</i> 。 <br><br> 显示以下代码： <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  if button_flag = 1 then '     button_flag = 0 '     end if '  -  loop end ' ***    *** button_isr: button_flag = 1 return</span></span></code> </pre> <br>  MK的许多程序都受此限制。 但是，此类程序通常或多或少简单。 如果您编写更复杂的内容，那么标志的数量将像滚雪球一样开始增加，并且代码变得越来越混乱和难以理解。 此外，在上面的示例中，延迟问题尚未解决。 当然，您可以在计时器上“挂起”单独的中断，并且在其中...还可以控制各种标志。 但是，这使程序变得非常丑陋，相互依赖标志的数量呈指数增长，甚至开发人员本人也很难很快找到这样的“ pasta代码”。 在开发新项目的过程中，尝试发现错误或修改代码通常变得同等重要。 <br><br> 如何解决“ Pasta Code”的问题，使其更具可读性和可管理性？  <i>操作系统</i> （OS）可以解决。 在其中，MK应该实现的功能分为任务，其操作由OS控制。 <br><br><h2>  MK的操作系统类型 </h2><br>  MK的操作系统可以分为两大类：拥挤的OS和协作的OS。 在任何这些操作系统中，任务都是由称为<i>调度</i>程序的特殊过程控制的。 在<i>拥挤</i>的操作系统中<i>，</i>调度程序可以随时独立地将执行从一个任务切换到另一个任务，为每个任务分配一定数量的时钟周期（可能会有所不同，具体取决于任务的优先级）。 总体上讲，这种方法很好用，使您完全不必看任务的内容：您至少可以编写任务代码 <br><br><pre> <code class="vbscript hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  -仍将执行其余任务（包括此任务）。 但是，抢占式OS需要大量资源（处理器内存和时钟周期），因为每个开关都应完全保存要禁用的任务的上下文并加载简历的上下文。 这里的上下文指的是机器寄存器和堆栈的内容（BASCOM使用两个堆栈-硬件用于子程序的返回地址，而软件用于参数传递）。 这样的负载不仅需要大量的处理器周期，而且每个任务的上下文都需要存储一段时间才能工作。 在最初面向多任务的“大型”处理器中，这些功能通常在硬件中受支持，并且它们具有更多的资源。 在AVR MK中，不支持多任务处理的硬件（一切都需要“手动”完成），并且可用内存很小。 因此，尽管存在替换OS，但它们不太适合简单的MK。 <br><br> 另一件事是<i>合作操作系统</i> 。 任务本身在此处控制将控制权转移到调度程序的时间，从而允许他启动其他任务。 此外，执行此操作需要执行此处的任务-否则代码执行将停止。 一方面，这种方法似乎降低了整体可靠性：如果任务挂起，它将永远不会调用调度程序，并且整个系统将停止响应。 另一方面，线性代码或超级循环在这方面没有更好的选择-因为它们冻结的风险完全相同。 <br><br> 但是，协作OS具有重要的优势。 由于程序员在此处设置了自己进行切换的时间，因此不可能突然发生，例如，当任务正在使用某些资源或正在计算算术表达式时。 因此，在大多数情况下，在协作式OS中，您可以执行以下操作而无需维护上下文。 这大大节省了处理器时间和内存，因此看起来更适合在MK AVR上实施。 <br><br><h2>  BASCOM AVR中的任务切换 </h2><br> 为了在BASCOM AVR环境中实现任务切换，每个任务代码（均以常规过程实现）必须在某个位置调用调度程序-也以常规过程实现。 <br> 想象一下，我们有两个任务，每个任务在其代码的某个位置由调度程序调用。 <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> task1() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">'  1 '  loop end sub ' ---------------------------------- sub task2() do '  2 '  loop end sub</span></span></code> </pre> <br> 假设任务1已执行，让我们看看执行“调度程序调用”时堆栈上发生了什么： <br><br><blockquote> 返回主代码的地址（2个字节） <br> 堆栈顶部-&gt;返回任务1的地址，该任务调用了调度程序（2个字节） </blockquote><br> 堆栈的顶部将指向任务1中指令的地址，该地址紧跟调度程序调用（在本例中为<b>循环</b>指令）之后。 <br><br> 在最简单的情况下，调度程序的目标是将控制权转移给任务2。问题是如何做到这一点？  （假设调度程序已经知道任务2的地址）。 <br><br> 为此，调度程序应从堆栈（以及要记住的位置）中拉出返回任务1的地址，并将任务2的地址放在堆栈上的该位置，然后发出return命令。 处理器将从堆栈中提取地址，而不是返回到任务1，而是继续执行任务2。 <br><br> 反过来，当任务2调用调度程序时，我们也拉出堆栈并保存可以返回到任务2的地址，然后将先前保存的任务1地址加载到堆栈上。给出<b>return</b>命令，我们将进入任务1的延续点。 <br><br> 结果，我们陷入了混乱： <br><br><blockquote> 任务1-&gt;调度程序-&gt;任务2-&gt;调度程序-&gt;任务1 .... </blockquote><br> 还不错！ 而且有效。 但是，当然，这对于实际可用的操作系统是不够的。 毕竟，并非总是如此，也不是所有任务都应该起作用—例如，它们可以<i>期望</i>一些东西（延迟时间到期，某些信号的出现等）。 因此，任务应具有<i>状态</i> （“工作”，“就绪”，“预期”等）。 另外，最好将任务分配给<i>priority</i> 。 然后，如果准备执行多个任务，则调度程序将继续执行优先级最高的任务。 <br><br><h2> 水族RTOS </h2><br> 为了实现所描述的思想，开发了协作OS AQUA RTOS，它为任务提供了必要的服务，并允许在BASCOM AVR环境中实现协作多任务。 <br><br><div class="spoiler">  <b class="spoiler_title">有关BASCOM AVR中的过程模式的重要通知</b> <div class="spoiler_text"> 在开始描述AUQA RTOS之前，应注意，BASCOM AVR环境支持两种类型的寻址过程。 这由config子模式= new | 旧的。 <br> 在指定旧选项的情况下，首先，编译器将线性编译所有代码，而不管它是否在某个地方使用，其次，没有以子名称/ end sub样式设计的参数的过程将被视为过程。 ，其名称风格为：/ return。 这允许我们使用bylabel修饰符将过程的地址作为标签传递给另一个过程，作为参数。 这也适用于以子名称/结束子样式的样式设计的过程（您需要将过程名称作为标签传递）。 <br> 同时，submode = old模式强加了一些限制：任务过程一定不能包含参数； 通过$ include连接的文件代码线性包含在常规项目中，因此，应在连接的文件中提供绕行功能-使用goto和标签从头到尾进行操作。 <br> 因此，在AQUA RTOS中，用户必须仅使用task_name样式的旧过程表示法：/ return用于任务，或者使用更通用的子名称/ end sub，在其代码开头添加修饰符submode = old，并绕过包含的文件转到标签/包含文件代码/标签：。 <br></div></div><br><h3>  AQUA RTOS任务状态 </h3><br> 为AQUA RTOS中的任务定义了以下状态： <br><br><pre> <code class="vbscript hljs">OSTS_UNDEFINE OSTS_READY OSTS_RUN OSTS_DELAY OSTS_STOP OSTS_WAIT OSTS_PAUSE OSTS_RESTART</code> </pre> <br> 如果任务尚未初始化，则将其分配为状态<b>OSTS_UNDEFINE</b> 。 <br> 初始化后，任务的状态为<b>OSTS_STOP</b> 。 <br> 如果任务<i>准备好执行</i> ，则将其分配为状态<b>OSTS_READY</b> 。 <br> 当前正在运行的任务的状态为<b>OSTS_RUN</b> 。 <br> 从中，她可以进入状态<b>OSTS_STOP，OSTS_READY，OSTS_DELAY，OSTS_WAIT，OSTS_PAUSE</b> 。 <br> 状态<b>OSTS_DELAY</b>具有完成<i>延迟</i>的任务。 <br> 状态<b>OSTS_WAIT</b>分配给正在<i>等待信号量，事件或消息的任务</i> （下面将详细介绍）。 <br><br>  <b>OSTS_STOP</b>和<b>OSTS_PAUSED状态</b>之间有什么区别？ <br> 如果由于某种原因该任务接收到<b>OSTS_STOP</b>的状态， <b>则将</b>从其入口点（即接收到<b>OSTS_READY</b>的状态）执行该任务的后续恢复。 从一开始。 从<b>OSTS_PAUSE</b>的状态<b>开始，</b>任务将在挂起的位置继续工作。 <br><br><h3> 任务状态管理 </h3><br>  OS本身都可以通过调用OS服务来自动管理任务以及用户。 有几种任务管理服务（所有OS服务的名称<b>均以OS_</b>前缀开头）： <br><br><pre> <code class="vbscript hljs">OS_InitTask(task_label, task_prio) OS_Stop() OS_StopTask(task_label) OS_Pause() OS_PauseTask(task_label) OS_Resume() OS_ResumeTask(task_label) OS_Restart()</code> </pre> <br> 它们每个都有两个选项： <b>OS_service</b>和<b>OS_serviceTask</b> （ <b>OS_InitTask</b>服务除外，后者只有一个选项； <b>OS_Init</b>服务初始化OS本身）。 <br><br>  <b>OS_service</b>和<b>OS_serviceTask有</b>什么<b>区别</b> ？ 第一种方法对导致任务的任务本身起作用； 第二个允许您将指向另一个任务的指针设置为参数，从而从一个任务管理另一个任务。 <br><br><div class="spoiler">  <b class="spoiler_title">关于OS_Resume</b> <div class="spoiler_text"> 除OS_Resume和OS_ResumeTask外，所有任务管理服务都将在处理后自动调用任务管理器。 相反，OS_Resume *服务仅将任务状态设置为OSTS_READY。 仅当显式调用调度程序时，才会处理此状态。 <br></div></div><br><h3> 优先级和任务队列 </h3><br> 如上所述，在实际系统中，某些任务可能更重要，而其他任务可能是次要的。 因此，操作系统的一个有用功能是能够分配任务优先级。 在这种情况下，如果同时有多个<i>现成的</i>任务，则操作系统将首先选择优先级最高的任务。 如果<b>所有</b>现成的任务具有相同的优先级，则操作系统将按照称为“轮播”或循环的顺序将它们循环执行。 <br><br> 在AQUA RTOS中，通过调用<b>OS_InitTask</b>服务<i>初始化</i>任务时将优先级分配给任务，该服务<b>接收</b>任务<b>的</b>地址作为第一个参数，并<b>接收</b>从1到15的数字作为第二个参数， <i>数字越小优先级越高</i> 。 在OS操作期间，不提供分配给任务的优先级的更改。 <br><br><h3> 延误 </h3><br> 在每个任务中，延迟都独立于其他任务处理。 <br> 因此，在OS解决一项任务的延迟时，可以执行其他任务。 <br> 为组织延迟提供了服务<b>OS_Delay |</b>  <b>OS_DelayTask</b> 。 参数是任务<i>延迟</i>的毫秒数。 由于参数的维数为<b>dword</b> ，因此最大延迟为4294967295 ms，或大约120小时，对于大多数应用程序来说似乎已经足够。 调用延迟服务后，将自动调用调度程序，该调度程序将在延迟期间将控制权转移到其他任务。 <br><br><h3> 信号量 </h3><br>  AQUA RTOS中的信号量类似于可用于任务的标志和变量。 它们有两种类型-二进制和可数。 第一个只有两种状态：空闲和关闭。 第二个是字节计数器（当前版本的AQUA RTOS中的信号量计数服务尚未实现（我是一个懒惰的驴子，因此下面所述的内容仅适用于二进制信号量）。 <br><br> 信号量和简单标志之间的区别在于，可以使任务<i>等待释放</i>指定的信号量。 在某些方面，信号量的使用确实类似于铁路：到达信号量后，组合（任务）将检查信号量，如果信号量未打开，它将等待使能信号进一步传播。 此时，其他火车（任务）可以继续行驶（运行）。 <br><br> 在这种情况下，所有黑件都分配给调度员。 一旦任务被告知等待信号量，控制权就会自动转移到调度程序，并且他可以启动其他任务-直到释​​放指定的信号量为止。 一旦信号量的状态更改为<i>free</i> ，调度程序就会将等待该信号量的所有任务分配为状态<i>就绪</i> （ <b>OSTS_READY</b> ），并将按照优先级和优先级的顺序执行它们。 <br>  AQUA RTOS总共提供16个二进制信号量（原则上可以通过更改任务控制单元中变量的尺寸来增加此数目，因为在内部它们是作为位标志实现的）。 <br> 二进制信号量通过以下服务工作： <br><br><pre> <code class="vbscript hljs">hBSem OS_CreateBSemaphore() OS_WaitBSemaphore(hBSem) OS_WaitBSemaphoreTask(task_label, hBSem) OS_BusyBSemaphore(hBSem) OS_FreeBSemaphore(hBSem)</code> </pre> <br> 在使用信号量之前，必须先<i>创建</i>一个信号量。 这可以通过调用<b>OS_CreateBSemaphore</b>服务来完成，该服务返回创建的<b>hBSem</b>信号量的唯一字节标识符（句柄），或者通过用户定义的处理程序引发错误<b>OSERR_BSEM_MAX_REACHED</b> ，指示已达到最大数量的二进制信号量。 <br><br> 您可以通过将接收到的标识符作为参数传递给其他信号量服务来使用它。 <br><br> 服务<b>OS_WaitBSemaphore |</b>  <b>OS_WaitBSemaphoreTask</b>将（当前|指定的）任务置于一种状态，以<i>在</i> <b>hBSem</b> <i>信号</i>繁忙时<i>等待</i>该信号<i>的释放</i> ，然后将控制权转移到调度程序，以便它可以启动其他任务。 如果该信号量是空闲的，则不会发生控制转移，并且该任务将继续进行。 <br><br>  <b>OS_BusyBSemaphore</b>和<b>OS_FreeBSemaphore服务分别</b>将<b>hBSem</b>信号量设置为<i>忙</i>或<i>空闲</i> 。 <br><br> 没有提供销毁信号以简化OS并减少代码量的行为。 因此，所有创建的信号量都是静态的。 <br><br><h3> 大事记 </h3><br> 除了信号量之外，任务还可以由事件驱动。 可以指示一个任务<i>预期某个事件</i> ，而另一个任务（以及后台代码）可以<i>指示</i>该事件。 同时，所有等待此事件的任务都将接收<i>准备执行</i>的状态（ <b>OSTS_READY</b> ），并由调度程序将其设置为按优先级和优先级顺序执行。 <br><br> 任务可以响应哪些事件？ 好吧，例如： <br><ul><li> 中断 </li><li> 发生错误； </li><li> 释放资源（有时为此使用信号量更为方便）； </li><li> 更改I / O线的状态或按键盘上的键； </li><li> 通过RS-232接收或发送字符； </li><li> 从应用程序的一部分到另一部分的信息传递（另请参阅消息）。 </li></ul><br> 事件系统是通过以下服务实现的： <br><br><pre> <code class="vbscript hljs">hEvent OS_CreateEvent() OS_WaitEvent(hEvent) OS_WaitEventTask(task_label, hEvent) OS_WaitEventTO(hEvent, dwTimeout) OS_SignalEvent(hEvent)</code> </pre> <br> 使用事件之前，您需要<i>创建它</i> 。 这是通过调用<b>OS_CreateEvent</b>函数完成的，该函数为<b>hEvent</b>事件返回唯一的字节标识符（句柄），或者通过用户定义的处理程序引发<b>OSERR_EVENT_MAX_REACHED</b>错误，表明已达到可在OS中生成的事件数量的限制（最多255个不同事件）。 <br><br> 若要使任务等待<b>hEvent</b>事件，请在其代码中调用<b>OS_WaitEvent</b> ，并将事件句柄作为参数传递。 调用此服务后，控制权将自动转移到调度程序。 <br><br> 与信号量服务不同，事件服务提供了一个选项来等待带有<i>超时</i>的事件。 为此，请使用<b>OS_WaitEventTO</b>服务。 在这里的第二个参数可以指定任务可以预期事件发生的毫秒数。 如果指定的时间已到期，则任务将收到<i>准备好执行</i>状态<i>，</i>就好像事件已发生一样，并且将由调度程序设置为按优先级和优先级顺序继续执行。 该任务可以发现这不是事件，而是超时，任务可以通过检查<b>OS_TIMEOUT</b>全局标志来进行检查。 <br><br> <i></i>             <b>OS_SignalEvent</b> ,       .    ,   ,    <i>  </i> ,           . <br><br><h3>  </h3><br>        ,       :         ,           –   . <br>     : <br><br><pre> <code class="vbscript hljs">hTopic OS_CreateMessage() OS_WaitMessage(hTopic) OS_WaitMessageTask(task_label, hTopic) OS_WaitMessageTO(hTopic, dwTimeout) OS_SendMessage(hTopic, wMessage) word_ptr OS_GetMessage(hTopic) word_ptr OS_PeekMessage(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_GetMessageString(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_PeekMessageString(hTopic)</code> </pre> <br>    ,    <i> </i> .     <b>OS_CreateMessage</b> ,      <b>hTopic</b> ,       <b>OSERR_TOPIC_MAX_REACHED</b> ,   ,       ,     . <br><br>        <b>hTopic</b> ,      <b>OS_WaitMessage</b> ,      .          .  ,        <i>    <b>hTopic</b></i> . <br><br>     <b>OS_WaitMessageTO</b>    <b>OS_WaitEventTO</b>  . <br><br>      <b>OS_SendMessage</b> .     ,     ,   –   <b>word</b> .      ,   <i>  </i> , ,   ,    . <br><br>    ,     BASCOM  <b>varptr</b> , , : <br><br><pre> <code class="vbscript hljs">strMessage = <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span> OS_SendMessage hTopic, varptr (strMessage)</code> </pre> <br>     <b>OS_WaitMessage</b> ,  ,    ,          ,     —      .        .      <b>word</b> ,      ,    ,   .   <b>OS_GetMessage</b>   ,  <b>OS_PeekMessage</b>  . <br><br>     ,   ,    <b>OS_GetMessageString</b>  <b>OS_PeekMessageString</b> ,     ,   ,     . <br><br><h3>    </h3><br>        AQUA RTOS       <b>TIMER0</b> .  ,   (  )     .      , ..          .    1 . <br><br><h2>    AQUA RTOS </h2><br><h3>   </h3><br>       ,           .   <b>OS_SIM = TRUE | FALSE</b> ,    . <br><br>  ,      <b>OS_MAX_TASK</b> ,       .    ,     (  ),      .        ,   . <i>    ,    .</i> <br><br><h3>   </h3><br>    AQUA RTOS   .      <b>OS_Init</b> .      .    ,     –     .  ,   ,    –  . <br><br>         (    ) –      ,            .          ,      -    . <br><br> ,     AQUA RTOS            : <br><br><pre> <code class="vbscript hljs">OS_Init my_err_trap <span class="hljs-comment"><span class="hljs-comment">'... '... '... sub my_err_trap(err_code as byte) print err_code end sub</span></span></code> </pre> <br><h3>   </h3><br>     ,     : <br><br><pre> <code class="vbscript hljs">OS_InitTask task_1, <span class="hljs-number"><span class="hljs-number">1</span></span> OS_InitTask task_2 , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">'... OS_InitTask task_N , 1</span></span></code> </pre> <br><h2>   </h2><br><h3>   </h3><br> ,    ,       Arduino Nano V3.       -  (, test),     bas-: <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() '       led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output ' ***    *** '   OS_Init my_err_trap '   OS_InitTask task_1, 1 OS_InitTask task_2 , 1 '      «» (OSTS_STOP) '    ,     ' «  » (OSTS_READY)   OS_ResumeTask OS_ResumeTask task_1 OS_ResumeTask task_2 '      OS_Sheduler end ' ***  *** sub task_1 () do toogle led_1 '   1 OS_delay 1000 '   1000  loop end sub sub task_2 () do toogle led_2 '   2 OS_delay 333 '   333  loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br>      <b>D4</b>  <b>D5</b>  Arduino (   ,   -  ).     100...500     <b>GND</b> .      .       2  0,66 . <br><br>   . ,     (  ,      aliases),  –  ,   – . <br><br>         «»,     «  » (,       –  -           ,        ,      ;          ).        <b>OS_ResumeTask</b> . <br><br>     ,    .    ? , !          . ,    ,      ,         <b>end</b> . <br><br>    .    ,         <b>do – loop</b> .    –            ,   ,      –       ,      .       <b>OS_Delay</b> .        ,       . <br><br>       <b>OS_SIM = TRUE</b>       ,   ,   ,   . <br><br> ,   , ,      «  »,       .   ,    «   »,         . <br><br>  ,    (, <b>task_1</b> ),       (     <b>end</b>   )     <b>task_1</b> ,       ,    <b>return</b> ,             –  ,    <b>task_1</b> ( <b>do</b>   <b>task_1</b> ). <br><br>  <b>task_1</b> ,   ,   <b>OS_delay</b> , ,   ,   . <br><br>   ,    ,     <b>task_1</b> (  ,    <b>OS_delay</b> , ..  <b>loop</b> ),  , « », ,      <b>task_2</b> .       <b>task_2</b> (      <b>do</b>    <b>task_2</b> )    <b>return</b> ,             –  ,    <b>task_2</b> . <br><br>  <b>task_2</b> ,   ,   <b>OS_delay</b> , ,   ,   . <br><br>   ,    ,     <b>task_1</b> (  ,    <b>OS_delay</b> , ..  <b>loop</b> ),  , « », ,      <b>task_2</b> .       ,       <b>task_1</b>     ,   ,      .  (  <b>loop</b>    <b>task_1</b> ),    . <br><br>  <b>task_1</b>   <b>loop</b> ,     « 1 –  –  2 – »   . <br><br><h3>   </h3><br>         . <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() const OS_SIM = TURE '       '   dim hTopic as byte '     dim task_1_cnt as byte '    1 dim strMessage as string * 16 '  ' ***    *** OS_CreateMessage hTopic OS_Init my_err_trap OS_InitTask task_1 , 1 OS_InitTask task_2 , 1 OS_ResumeTask task_1 OS_ResumeTask task_2 OS_Sheduler end ' ***  *** sub task_1() do print "task 1" OS_Sheduler incr task_1_cnt '    1 if task_1_cnt &gt; 3 then print "task 1 is sending message to task 2" strMessage = "Hello, task 2!" '    2 OS_SendMessage hTopic , varptr(strMessage) task_1_cnt = 0 end if loop end sub sub task_2() do print "task 2 is waiting messages..." '      1 OS_WaitMessage hTopic print "message recieved: " ; OS_GetMessageString (hTopic) loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br>           : <br><br><blockquote> task 1 <br> task 2 is waiting messages… <br> task 1 <br> task 1 <br> task 1 <br> task 1 is sending message to task 2 <br> task 1 <br> message recieved: Hello, task 2! <br> task 2 is waiting messages… <br> task 1 <br> task 1 <br>  ... <br></blockquote><br>  ,        .    1  <b>task 1</b> ,     ,      .  2  <b>task 2 is waiting messages...</b> ,        <b>hTopic</b> ,     ,     1.    <b>task 1</b>     . ,   ,   2   ,     1   <b>incr</b> ,    . <br>   <b>task_1_cnt</b>   1   ,   ,    –   <b>loop</b>    <b>task 1</b> .     ,   ,    2  ,    .    . <br><br><h3>   </h3><br>             : <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_scankeys() declare sub task_led_1() declare sub task_led_2() '        led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output button_1 alias pind.6 button_2 alias pind.7 config portd.6 = input config portd.7 = input '   dim eventButton_1 as byte dim eventButton_2 as byte ' ***    *** eventButton_1 = OS_CreateEvent '       eventButton_2 = OS_CreateEvent OS_Init my_err_trap OS_InitTask task_scankeys , 1 OS_InitTask task_led_1 , 1 OS_InitTask task_led_2 , 1 OS_ResumeTask task_scankeys OS_ResumeTask task_led_1 OS_ResumeTask task_led_2 OS_Sheduler end ' ***  *** sub task_scankeys() do debounce button_1 , 0 , btn_1_click , sub debounce button_2 , 0 , btn_2_click , sub OS_Sheduler loop btn_1_click: OS_SignalEvent eventButton_1 return btn_2_click: OS_SignalEvent eventButton_2 return end sub sub task_led_1() do OS_WaitEvent eventButton_1 toggle led_1 loop end sub sub task_led_2() do OS_WaitEvent eventButton_2 toggle led_2 loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><h2>     AQUA RTOS </h2><br><br>   ,         .           ;     ,   ,  .  ,     : ,      95…97°;               (,  GSM-),      . <br><br><h3>    </h3><br>         « +  + »  ,     .     ,    . <br>        : <br><br><ul><li>     – <b>ControlHeater()</b> </li><li>      – <b>ShowGoods()</b> </li><li>  /    – <b>AcceptMoney()</b> </li><li>   – <b>ScanKeys()</b> </li><li>   – <b>MakeChange()</b> </li><li>   – <b>ReleaseCoffee()</b> </li><li>    – <b>Alarm()</b> </li></ul><br>        . <br> <b>ControlHeater()</b>  ,        .       ,      ,    .      .     5. <br> <b>ShowGoods()</b>   .       ,   -   .      8,             . <br> <b>ScanKeys()</b>     ,       .     3,      40 . <br> <b>AcceptMoney()</b>     .      ,   <b>ScanKeys(),</b>     20 . <br> <b>MakeChange ()</b>     .     <b>ReleaseCoffee()</b>    10. <br> <b>ReleaseCoffee()</b>   ,           .       2. <br>   –    ,  <b>Alarm()</b>      – 1,     ,      . <br><br>  ,       .  ,      EEPROM   ,       . <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    declare sub ControlHeater() declare sub ShowGoods() declare sub AcceptMoney() declare sub ScanKeys() declare sub MakeChange () declare sub ReleaseCoffee() declare sub Alarm()</span></span></code> </pre> <br>     RTOS      :          (  ,    ) –      . <br><br> , <b>ReleaseCoffee()</b>    : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> ReleaseCoffee() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> OS_WaitMessage bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) Release wItem <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre> <br>  <b>ReleaseCoffee</b>        <b>bCoffeeSelection</b>    ,     (   ,      ).    , <b>ReleaseCoffee()</b>    ,    ,     (  ) <b>wItem</b>    <b>OS_GetMessage</b>    .  <b>ReleaseCoffee()</b>   ,       : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage()</code> </pre> <br>    , <b>ShowGoods()</b>            .       <b>ReleaseCoffee()</b> ,   .       : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bGoodsReliased as byte bGoodsReliased = OS_CreateEvent()</code> </pre> <br>    <b>ReleaseCoffee()</b>   <b>Release wItem</b>     <b>bGoodsReliased</b> : <br><br><pre> <code class="vbscript hljs">OS_SignalEvent bGoodsReliased</code> </pre> <br><h3>   </h3><br>  ,     ,    ,      ,     .      <b>OS_Init</b> : <br><br><pre> <code class="vbscript hljs">OS_Init Mailfuncion</code> </pre> <br>       – ,      : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> Mailfuncion (bCoffeeErr) print <span class="hljs-string"><span class="hljs-string">"Mailfunction! Error #: "</span></span>; bCoffeeErr <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isErrCritical (bCoffeeErr) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CallService(bCoffeeErr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre><br>      (    -  :  ,  GSM-  ..),   ,   ,    . <br><br><h3>   </h3><br>   ,  ,   ..     ,   .  ,           <b>OS_InitTask</b> : <br><br><pre> <code class="vbscript hljs">OS_InitTask ControlHeater , <span class="hljs-number"><span class="hljs-number">5</span></span> OS_InitTask ShowGoods , <span class="hljs-number"><span class="hljs-number">8</span></span> OS_InitTask AcceptMoney , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask ScanKeys , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask MakeChange, <span class="hljs-number"><span class="hljs-number">10</span></span> OS_InitTask ReleaseCoffee , <span class="hljs-number"><span class="hljs-number">2</span></span> OS_InitTask Alarm , <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>      , ,    , ,         .          .     ,      <b>OS_ResumeTask</b>    «  »: <br><br><pre> <code class="vbscript hljs">OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm</code> </pre> <br>   ,         ;          «»       .  <b>OS_ResumeTask</b>           (  ),    . ,  ,    ,   . <br><br><h3>   </h3><br>     ,   .     : <br><br><pre> <code class="vbscript hljs">OS_Sheduler</code> </pre> <br>          <b>end</b> –         . <br><br>     : <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $include "coffee_hardware.bas" '      '       Coffee_ $regfile = "m328pdef.dat" ' Arduino Nano v3 $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 Coffee_InitHardware '    '   declare sub Mailfuncion (byval bCoffeeErr as byte) '   declare sub ControlHeater () '   declare sub ShowGoods () '    declare sub AcceptMoney () '   declare sub ScanKeys () '   declare sub MakeChange () '      declare sub ReleaseCoffee () '   declare sub Alarm () '    '     Coffee_InitHardware () '   dim wMoney as long '    dim wGoods as long '   ' ***    *** '   OS_Init Mailfuncion '       dim bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage() '     dim bGoodsReliased as byte bGoodsReliased = OS_CreateEvent() '   OS_InitTask ControlHeater , 5 OS_InitTask ShowGoods , 8 OS_InitTask AcceptMoney , 3 OS_InitTask ScanKeys , 3 OS_InitTask MakeChange, 10 OS_InitTask ReleaseCoffee , 2 OS_InitTask Alarm , 1 '     OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm '   OS_Sheduler end ' ***   *** ' ----------------------------------- sub ControlHeater() do select case GetWaterTemp() case is &gt; 97 Coffee_HeaterOff '   case is &lt; 95 Coffee_HeaterOn '   case is &lt; 5 CallServce (WARNING_WATER_FROZEN) '   end select OS_Delay 60000 '  1  loop end sub ' ----------------------------------- sub ShowGoods() do LEDS = Coffee_GetDrinkSupplies() '    D, '         '   LEDS OS_WaitEvent bGoodsReliased '   " " loop end sub ' ----------------------------------- sub AcceptMoney() do wMoney = wMoney + ReadMoneyAcceptor() OS_Delay 20 loop end sub ' ----------------------------------- sub ScanKeys() do wGoods = ButtonPressed() if wMoney &gt;= GostOf(wGoods) then OS_SendMessage bCoffeeSelection, wGoods '     bCoffeeSelection,  '     end if OS_Delay 40 loop end sub ' ----------------------------------- sub MakeChange() do OS_WaitEvent bGoodsReliased '   " " Refund wMoney loop end sub ' ----------------------------------- sub ReleaseCoffee() do OS_WaitMessage bCoffeeSelection '  bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) '   Release wItem '    wMoney = wMoney – CostOf (wItem) '     OS_SignalEvent bGoodsReliased '     '  ,       : ' MakeChange  ShowGoods '  ,  ,     loop end sub ' ----------------------------------- sub Alarm() do OS_Delay 1000 if Hijack() = 1 then CallPolice() end if loop end sub ' ----------------------------------- ' ***    *** sub Mailfuncion (bCoffeeErr) print "Mailfunction! Error #: "; bCoffeeErr if isErrCritical (bCoffeeErr) = 1 then CallService() end if end sub</span></span></code> </pre> <br> ,             ,    .              <b>OS_SendMessage()</b>  ,        /.     .  ,   ,  ,  ,     . <br><br><h2>   AQUA RTOS </h2><br> <a href=""><b>   1.05     </b></a> <br><br><h2>  </h2><br> <i>Q:  AQUA?</i> <br> A: ,    ,   « »,   ,   .   ,   ,     ,  ,  « »   WiFi-.   ,  ,  ,     EEPROM  ,  , - .            .      –       « »,    ,  .    ,    .    AQUA. <br><br> <i>Q:        ?</i> <br> A: . ,  ,          ,      ,    ,    .   ,        .    ,   ,      ,       ,    ,  , -,  .   ,         . , -     ( ? –   )    .         . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN453708/">https://habr.com/ru/post/zh-CN453708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN453694/index.html">像在Linux中一样通过SSH连接到Windows</a></li>
<li><a href="../zh-CN453696/index.html">角度双向绑定，多一点理解</a></li>
<li><a href="../zh-CN453698/index.html">量子意识中的量子信息</a></li>
<li><a href="../zh-CN453700/index.html">有关SDL 2的课程：第1课-您好，SDL 2</a></li>
<li><a href="../zh-CN453706/index.html">我如何通过Google Cloud Professional数据工程师认证考试</a></li>
<li><a href="../zh-CN453710/index.html">大型项目的开发实践：mitp SberPractice iOS＃1</a></li>
<li><a href="../zh-CN453712/index.html">eBay如何在WebAssembly上进行条形码扫描仪</a></li>
<li><a href="../zh-CN453714/index.html">TON测试客户端（电报开放网络）和用于智能合约的新Fift语言</a></li>
<li><a href="../zh-CN453716/index.html">家庭IT人员的国家/地区合作-有人吗？</a></li>
<li><a href="../zh-CN453720/index.html">C＃中Lambda表达式的精妙之处</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>