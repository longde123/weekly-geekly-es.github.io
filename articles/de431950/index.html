<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíé ü§ô üññüèª So prognostizieren Sie die Nachfrage und automatisieren Eink√§ufe mithilfe von maschinellem Lernen: Ozon-Fall üí™üèΩ ‚úäüèΩ üßî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Ozon Online-Shop bietet fast alles: K√ºhlschr√§nke, Babynahrung, Laptops f√ºr 100.000 usw. Dies bedeutet, dass sich all dies auch in den Lagern des U...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So prognostizieren Sie die Nachfrage und automatisieren Eink√§ufe mithilfe von maschinellem Lernen: Ozon-Fall</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ozontech/blog/431950/"><img src="https://habrastorage.org/webt/rl/bh/0z/rlbh0zbeah9dcpem3uio1wdstxs.png" alt="Bild"><br>  Der Ozon Online-Shop bietet fast alles: K√ºhlschr√§nke, Babynahrung, Laptops f√ºr 100.000 usw.  Dies bedeutet, dass sich all dies auch in den Lagern des Unternehmens befindet - und je l√§nger die Waren dort sind, desto teurer ist das Unternehmen.  Um herauszufinden, wie viel und was die Leute bestellen m√∂chten und was Ozon kaufen m√ºsste, haben wir maschinelles Lernen verwendet. <br><a name="habracut"></a><br><h3>  Umsatzprognose: Herausforderungen </h3><br>  Bevor wir uns mit der Problemstellung befassen, beginnen wir mit einem Beispiel.  Dies ist ein echter Ozon-Verkaufsplan f√ºr eine Weile.  Frage: Wohin wird er als n√§chstes gehen? <br><br><img src="https://habrastorage.org/webt/jl/nk/1j/jlnk1jejwxtqka-skph4hjccxno.png" alt="Bild"><br><br>  Eine Person mit einer nahezu technischen Ausbildung f√ºr eine solche Formulierung des Problems wird Fragen haben: Wo sind die Achsen?  Und was f√ºr ein Produkt?  Und in welchen Einheiten?  An welchem ‚Äã‚ÄãInstitut haben Sie Ihren Abschluss gemacht?  - und viele andere, die aus ethischen Gr√ºnden nicht in diesem Artikel enthalten sind. <br><br>  Tats√§chlich kann niemand die Frage in einer solchen Aussage richtig beantworten, und wenn jemand dies kann, wird er sich h√∂chstwahrscheinlich irren. <br><br>  F√ºgen Sie dieser Tabelle weitere Informationen hinzu: Achsen und Preis√§nderungen auf der Ozon-Website (blau) und auf der Website des Mitbewerbers (orange). <br><br><img src="https://habrastorage.org/webt/n1/m8/ap/n1m8apunf5mos5bid2xs4qsq1ka.png" alt="Bild"><br><br>  Unser Preis fiel irgendwann, aber die Konkurrenz blieb gleich - und die Verk√§ufe von Ozon stiegen.  Wir kennen die Preispl√§ne: Unser Preis wird auf dem gleichen Niveau bleiben, aber der Wettbewerber hat nach Ozon den Preis auf fast unseren gesenkt. <br><br>  Diese Daten reichen aus, um eine aussagekr√§ftige Annahme zu treffen - zum Beispiel, dass der Umsatz auf das vorherige Niveau zur√ºckkehren wird.  Und wenn Sie sich das Diagramm ansehen, stellt sich heraus, dass es so sein wird. <br><br><img src="https://habrastorage.org/webt/rk/mb/aw/rkmbawctxwb2hf4lhs7l025c9y4.png" alt="Bild"><br><br>  Das Problem ist, dass die Nachfrage nach diesem Produkt in der Tat nicht so stark vom Preis beeinflusst wird und das Umsatzwachstum unter anderem durch das Fehlen der meisten Wettbewerber dieses Produkts in unserem Gesch√§ft verursacht wurde.  Es gibt noch viele Faktoren, die wir nicht ber√ºcksichtigt haben: Wurden die Waren im Fernsehen beworben?  oder vielleicht sind es S√º√üigkeiten und bald der 8. M√§rz? <br><br>  Eines ist klar: Eine Vorhersage "auf dem Knie" zu machen, wird nicht funktionieren.  Wir folgten dem Standardpfad eines <s>Rechen und von Kr√ºcken,</s> um einen beliebigen ML-Algorithmus <s>zu</s> erstellen.  Und so war es auch. <br><br><h3>  Metrische Auswahl </h3><br>  Wenn Sie eine Metrik ausw√§hlen, beginnen Sie, wenn mindestens eine andere Person neben Ihnen Ihre Prognose verwendet. <br><br>  Betrachten Sie ein Beispiel: Wir haben drei Prognoseoptionen.  Welches ist besser? <br><img src="https://habrastorage.org/webt/ix/zg/gp/ixzggpclvbgaqpmkzaeehzhamb0.png" alt="Bild"><br>  Aus Sicht der Spezialisten im Lager brauchen wir eine blaue Prognose - wir werden etwas weniger kaufen und Mitte Oktober den H√∂hepunkt verpassen, aber nichts wird im Lager bleiben.  Experten, deren KPI an den Umsatz gebunden ist, sind der gegenteiligen Meinung: Selbst die t√ºrkisfarbene Prognose ist nicht ganz richtig, nicht alle Nachfragespr√ºnge haben sich widerspiegelt - √§ndern Sie sie.  Aber aus der Sicht eines Menschen von au√üen ist im Allgemeinen etwas Besseres angebracht - damit sich jeder gut f√ºhlt oder umgekehrt. <br><br>  Bevor Sie eine Prognose erstellen, m√ºssen Sie daher festlegen, wer sie verwenden wird und warum.  W√§hlen Sie also eine Metrik aus und verstehen Sie, was Sie von einer Prognose erwarten k√∂nnen, die auf einer solchen Metrik basiert.  Und warte darauf. <br><br>  Wir haben MAE gew√§hlt - den durchschnittlichen absoluten Fehler.  Diese Metrik eignet sich f√ºr unser stark unausgeglichenes Trainingsmuster.  Da das Sortiment sehr breit ist (1,5 Millionen Artikel), wird jedes Produkt einzeln in einer bestimmten Region in kleinen Mengen verkauft.  Und wenn wir insgesamt Hunderte von gr√ºnen Kleidern verkaufen, wird ein bestimmtes gr√ºnes Kleid mit Katzen zu 2-3 pro Tag verkauft.  Infolgedessen verschiebt sich die Stichprobe in Richtung kleiner Werte.  Auf der anderen Seite gibt es iPhones, Spinner, ein neues Buch von Olga Buzova (ein Witz) usw.  - und sie werden in jeder Stadt in gro√üen Mengen verkauft.  Mit MAE k√∂nnen Sie auf bedingten iPhones keine hohen Bu√ügelder erhalten und arbeiten im Allgemeinen gut mit dem Gro√üteil der Waren. <br><br><h3>  Erste Schritte </h3><br>  Wir haben zun√§chst die d√ºmmste Prognose erstellt, die es geben k√∂nnte: Eine Zufallszahl von 0 bis 1000 wird in der n√§chsten Woche verkauft und erh√§lt die Metrik MAE = 496. Wahrscheinlich kann es schlimmer sein, aber das ist bereits sehr schlecht.  Wir haben also eine Richtlinie: Wenn wir einen solchen metrischen Wert erhalten, dann machen wir offensichtlich etwas falsch. <br><br>  Dann haben wir angefangen, Leute zu spielen, die wissen, wie man eine Prognose ohne maschinelles Lernen erstellt, und haben versucht, den Verkauf von Waren in der n√§chsten Woche vorherzusagen, der dem durchschnittlichen Umsatz aller letzten Wochen entspricht, und haben die Metrik MAE = 1,45 erhalten - was viel besser ist. <br><br>  Wir haben weiter entschieden, dass die Verk√§ufe der letzten Woche f√ºr die Umsatzprognose f√ºr die n√§chste Woche nicht relevanter sind.  F√ºr eine solche Prognose betrug der MAE 1,26.  In der n√§chsten Runde des prognostischen Denkens haben wir beschlossen, beide Faktoren zu ber√ºcksichtigen und den Umsatz f√ºr die n√§chste Woche als Summe von 50% des durchschnittlichen Umsatzes und 50% des Umsatzes der letzten Woche vorherzusagen - wir haben MAE = 1,23. <br><br>  Aber es schien uns zu einfach, und wir beschlossen, die Dinge zu komplizieren.  Wir haben eine kleine Trainingsstichprobe gesammelt, in der die Anzeichen vergangen waren und der durchschnittliche Umsatz, und die Ziele waren Verk√§ufe in der n√§chsten Woche, und wir haben darauf eine einfache lineare Regression trainiert.  Wir haben Gewichte von 0,46 und 0,55 f√ºr den Durchschnitt und die letzten Wochen und die MAE auf der Testprobe gleich 1,2. <br>  Fazit: Unsere Daten haben Vorhersagepotential. <br><br><h3>  Feature Engineering </h3><br>  Nachdem wir entschieden hatten, dass die Erstellung einer Prognose aus zwei Gr√ºnden nicht unser Niveau ist, haben wir uns zusammengesetzt, um neue komplexe Funktionen zu generieren.  Dies sind Informationen √ºber vergangene Verk√§ufe - vor 1, 2, 3, 4 Wochen, vor einer Woche genau vor einem Jahr usw.  Und Ansichten der letzten Wochen, Erg√§nzungen zum Warenkorb, Konvertierung von Ansichten und Erg√§nzungen zum Warenkorb in Bestellungen - und das alles f√ºr verschiedene Zeitr√§ume. <br><br>  Wir mussten ein Modell des Wissens dar√ºber geben, wie das Produkt als Ganzes verkauft wird, wie sich die Dynamik seines Verkaufs in letzter Zeit ver√§ndert hat, wie sich das Interesse daran entwickelt, wie sein Verkauf vom Preis abh√§ngt und von anderen Faktoren, die unserer Meinung nach n√ºtzlich sein k√∂nnen. <br><br>  Als unsere Ideen ausgegangen waren, gingen wir zu den Experten der Verkaufsabteilung.  Dort haben wir zum Beispiel erfahren, dass das n√§chste Jahr das Jahr des Schweins ist, daher werden Waren, die zumindest aus der Ferne Schweinen √§hneln, sehr beliebt sein.  Oder zum Beispiel, dass unsere Leute ‚Äûnicht gefrieren‚Äú nicht im Voraus kaufen, sondern genau am Tag des ersten Frosts - ber√ºcksichtigen Sie also bitte die Wettervorhersage.  Im Allgemeinen waren alle zufrieden.  Wir - weil wir eine Reihe neuer Ideen erhalten haben, an die wir nie gedacht h√§tten, und Gesch√§ftsleute - werden bald etwas Interessanteres als die Umsatzprognose tun k√∂nnen. <br><br>  Aber es ist immer noch zu einfach - und wir haben kombinierte Symptome hinzugef√ºgt: <br><br><ul><li>  Umstellung von Ansichten auf Verk√§ufe - wie es war, wie es sich ver√§ndert hat; </li><li>  das Verh√§ltnis von Verk√§ufen √ºber 4 Wochen zu Verk√§ufen in der letzten Woche (wenn diese Zahl stark von 4 abweicht, unterliegt die Nachfrage nach diesem Produkt derzeit "Turbulenzen"); </li><li>  das Verh√§ltnis von Produktverk√§ufen zu Verk√§ufen in der gesamten Kategorie - wenn diese Zahl nahe eins liegt, ist das Produkt ein ‚ÄûMonopolist‚Äú. </li></ul><br>  In dieser Phase m√ºssen Sie so viel wie m√∂glich einfallen lassen - werfen Sie in der Trainingsphase nicht informative Zeichen weg. <br><br>  Als Ergebnis haben wir 170 Zeichen.  Mit Blick auf die Zukunft hatte das gr√∂√üte Merkmal Bedeutung <br><br><ul><li>  Verk√§ufe der letzten Woche (f√ºr zwei, drei und vier). </li><li>  Die Produktverf√ºgbarkeit in der letzten Woche ist der Prozentsatz der Zeit, in der das Produkt auf der Website vorhanden war. </li><li>  Der Winkelkoeffizient des Verkaufsplans f√ºr Waren der letzten 7 Tage. </li><li>  Das Verh√§ltnis des vergangenen Preises zur Zukunft - mit einem enormen Rabatt beginnen Sie, Waren aktiver zu kaufen. </li><li>  Die Anzahl der direkten Wettbewerber auf unserer Website.  Wenn zum Beispiel dieser Stift der einzige in seiner Kategorie ist, ist der Umsatz ziemlich station√§r. </li><li>  Produktabmessungen - Es stellte sich heraus, dass L√§nge und Breite die Vorhersehbarkeit des Umsatzes erheblich beeinflussen.  Aus irgendeinem Grund ist der Zeitplan f√ºr lange und schmale Objekte - zum Beispiel Regenschirme oder Angelruten - viel volatiler.  Wir wissen noch nicht, wie wir das erkl√§ren sollen. </li><li>  Tagesnummer des Jahres - zeigt an, ob das neue Jahr kommt, der 8. M√§rz, der Beginn einer saisonalen Umsatzsteigerung usw. </li></ul><br><h3>  Probenahme </h3><br>  Das Trainingsmuster ist Schmerz.  Wir haben es f√ºr ungef√§hr 4 Wochen gesammelt, von denen zwei nur zu verschiedenen Datenverwaltern gingen und nach einem Blick darauf fragten, was sie haben.  Dies geschieht jedes Mal, wenn Sie Daten f√ºr einen l√§ngeren Zeitraum ben√∂tigen.  Selbst in einem idealen Datenerfassungssystem wird lange Zeit etwas im Sinne von ‚ÄûFr√ºher haben wir so gedacht, aber dann haben wir angefangen, anders zu denken und die Daten in dieselbe Spalte zu schreiben‚Äú geschehen.  Oder vor ein oder zwei Jahren st√ºrzte der Server ab, aber niemand schrieb genau auf, wann - und die Nullen bedeuten nicht mehr, dass es keine Verk√§ufe gab. <br><br>  Als Ergebnis hatten wir Informationen dar√ºber, was die Leute auf der Website gemacht haben, was und in welcher Menge sie zu Favoriten und einem Warenkorb hinzugef√ºgt und gekauft wurden.  Wir haben eine Stichprobe von ungef√§hr 15 Millionen Stichproben mit jeweils 170 Merkmalen gesammelt. Das Ziel war die Anzahl der Verk√§ufe f√ºr die n√§chste Woche. <br><br>  Wir haben zweitausend Codezeilen auf Spark geschrieben.  Es funktionierte langsam, erlaubte aber das Kauen gro√üer Datenmengen.  Es scheint nur, dass die Berechnung der Steigung einer Linie einfach ist.  Und es 10kk Mal zu tun, wenn Verk√§ufe von mehreren Basen abgezogen werden - die Aufgabe ist nichts f√ºr schwache Nerven. <br><br>  Eine weitere Woche lang besch√§ftigten wir uns mit der Datenbereinigung, damit das Modell nicht durch Emissionen und lokale Stichprobenmerkmale abgelenkt wurde, sondern nur die tats√§chlichen Abh√§ngigkeiten extrahierte, die mit dem Verkauf von Ozon verbunden sind.  Hier werden 3 Sigma und weitere listige Methoden zur Suche nach Anomalien eingesetzt.  Der schwierigste Fall ist die Wiederherstellung des Umsatzes in Zeiten mangelnder Lagerbest√§nde.  Die einfachste L√∂sung besteht darin, die Wochen wegzuwerfen, in denen das Produkt w√§hrend der ‚ÄûZielwoche‚Äú ausfiel. <br><br><img src="https://habrastorage.org/webt/kk/li/_z/kkli_zozkhocyxgrkur-eocnq3g.png" alt="Bild"><br><br>  Infolgedessen blieben von 15 Millionen Proben 10 Millionen √ºbrig. Es ist hier wichtig, sich nicht mitrei√üen zu lassen und die Vollst√§ndigkeit der Probe nicht zu verlieren (tats√§chlich ist der Mangel an Waren im Lager ein indirektes Merkmal ihrer Bedeutung f√ºr das Unternehmen; das Entfernen solcher Waren aus der Probe ist nicht dasselbe wie das Herauswerfen von Stichproben ) <br><br><h3>  ML Zeit </h3><br>  Auf eine saubere Probe und begann Modelle zu trainieren.  Nat√ºrlich haben wir mit der linearen Regression begonnen und MAE = 1,15 erhalten.  Es scheint, dass dies eine sehr kleine Zunahme ist, aber wenn Sie eine Stichprobe von 10 Millionen haben, bei der die Durchschnittswerte 5 bis 10 betragen, f√ºhrt bereits eine kleine √Ñnderung des metrischen Werts zu einer nicht messbaren Steigerung der visuellen Qualit√§t der Prognose.  Und da Sie die L√∂sung schlie√ülich Gesch√§ftskunden pr√§sentieren m√ºssen, ist die Steigerung ihrer Freude ein wichtiger Faktor. <br><br>  Als n√§chstes kam sklearn.ensemble.RandomForestRegressor, der nach einer kurzen Auswahl von Hyperparametern MAE = 1,10 zeigte.  Als n√§chstes haben wir XGBoost (wo ohne) versucht - alles w√§re in Ordnung und MAE = 1.03 - nur eine sehr lange Zeit.  Leider hatten wir keinen Zugriff auf die GPU, um XGBoost zu trainieren, und auf Prozessoren wurde ein Modell sehr lange trainiert.  Wir haben versucht, etwas schneller zu finden, und uns f√ºr LightGBM entschieden - es trainierte doppelt so schnell und zeigte MAE sogar etwas weniger - 1,01. <br><br>  Wir haben alle Produkte in 13 Kategorien unterteilt, wie im Katalog auf der Website: Tische, Laptops, Flaschen, und f√ºr jede Kategorie haben wir Modelle mit unterschiedlichen Prognosetiefen trainiert - von 5 bis 16 Tagen. <br><br>  Das Training dauerte ungef√§hr f√ºnf Tage, und daf√ºr haben wir riesige Computercluster aufgebaut.  Wir haben eine solche Pipeline entwickelt: Die Zufallssuche funktioniert lange, gibt die Top-10-S√§tze von Hyperparametern an und der Wissenschaftler arbeitet dann manuell mit ihnen - erstellt zus√§tzliche Qualit√§tsmetriken (wir haben die MAE f√ºr verschiedene Zielbereiche berechnet), erstellt Lernkurven (zum Beispiel haben wir einen Teil des Trainings verworfen) Proben und erneut trainiert, um zu √ºberpr√ºfen, ob neue Daten den Verlust der Testprobe und anderer Grafiken verringern. <br><br>  Ein Beispiel f√ºr eine detaillierte Analyse f√ºr einen der Hyperparameters√§tze: <br><br><div class="spoiler">  <b class="spoiler_title">Detaillierte Qualit√§tsmetrik</b> <div class="spoiler_text"><table><tbody><tr><td><p>  Zugset: </p><br></td><td><p>  Testset: </p><br></td></tr><tr><td>  F√ºr Ziel = 0 ist MAE = 0,142222484602 </td><td>  F√ºr 0 MAE = 0,141900737761 </td></tr><tr><td>  F√ºr Ziel&gt; 0 ist MAPE = 45.168530676 </td><td>  F√ºr&gt; 0 MAPE = 45.5771812826 </td></tr><tr><td>  Fehler gr√∂√üer als 0 - 67.931341691% </td><td>  Fehler gr√∂√üer als 0 - 51.6405939896% </td></tr><tr><td>  Fehler gr√∂√üer als 1 - 19.0346986379% </td><td>  Fehler gr√∂√üer als 1 - 12.1977096603% </td></tr><tr><td>  Fehler mehr als 2 - 8.94313926245% </td><td>  Fehler mehr als 2 - 5.16977226441% </td></tr><tr><td>  Fehler mehr als 3 - 5.42406856507% </td><td>  Fehler mehr als 3 - 3.12760834969% </td></tr><tr><td>  Fehler mehr als 4 - 3.67938161595% <br></td><td>  Fehler mehr als 4 - 2.10263125679% </td></tr><tr><td>  Fehler mehr als 5 - 2.67322988948% <br></td><td>  Fehler mehr als 5 - 1,56473158807% <br></td></tr><tr><td>  Fehler mehr als 6 - 2.0618556701% <br></td><td>  Fehler mehr als 6 - 1.19599209102% <br></td></tr><tr><td>  Fehler mehr als 7 - 1.65887701209% </td><td>  Fehler gr√∂√üer als 7 - 0,949300173983% <br></td></tr><tr><td>  Fehler mehr als 8 - 1.36821095777% <br></td><td>  Fehler mehr als 8 - 0,78310772461% </td></tr><tr><td>  Fehler mehr als 9 - 1.15368611519% </td><td>  Fehler gr√∂√üer als 9 - 0,659205318158% <br></td></tr><tr><td>  Fehler mehr als 10 - 0,99199395014% </td><td>  Fehler mehr als 10 - 0,554593106723% </td></tr><tr><td>  Fehler mehr als 11 - 0,863969667827% </td><td>  Fehler mehr als 11 - 0,490045146476% <br></td></tr><tr><td>  Fehler mehr als 12 - 0,764347266082% <br></td><td>  Fehler mehr als 12 - 0,428835873827% <br></td></tr><tr><td>  Fehler mehr als 13 - 0,68086818247% </td><td>  Fehler mehr als 13 - 0,386545830907% <br></td></tr><tr><td>  Fehler mehr als 14 - 0,613446089087% </td><td>  Fehler mehr als 14 - 0,343884822697% <br></td></tr><tr><td>  Fehler mehr als 15 - 0,556297016335% <br></td><td>  Fehler mehr als 15 - 0,316433391328% <br></td></tr><tr><td>  F√ºr Ziel = 0 ist MAE = 0,142222484602 <br></td><td>  F√ºr Ziel = 0 ist MAE = 0,141900737761 <br></td></tr><tr><td>  F√ºr Ziel = 1 ist MAE = 0,63978556493 <br></td><td>  F√ºr Ziel = 1 ist MAE = 0,660823509405 </td></tr><tr><td>  F√ºr Ziel = 2 ist MAE = 1.01528075312 </td><td>  F√ºr Ziel = 2 ist MAE = 1.01098070566 </td></tr><tr><td>  F√ºr Ziel = 3 ist MAE = 1,43762342295 </td><td>  F√ºr Ziel = 3 ist MAE = 1,44836233499 </td></tr><tr><td>  F√ºr Ziel = 4 ist MAE = 1,82790678437 <br></td><td>  F√ºr Ziel = 4 ist MAE = 1,86539223382 <br></td></tr><tr><td>  F√ºr Ziel = 5 ist MAE = 2.15369976552 <br></td><td>  F√ºr Ziel = 5 ist MAE = 2.16017884573 </td></tr><tr><td>  F√ºr Ziel = 6 ist MAE = 2,51629758129 <br></td><td>  F√ºr Ziel = 6 ist MAE = 2,51987403661 <br></td></tr><tr><td>  F√ºr Ziel = 7 ist MAE = 2,80225497415 <br></td><td>  F√ºr Ziel = 7 ist MAE = 2,97580015564 <br></td></tr><tr><td>  F√ºr Ziel = 8 ist MAE = 3.09405048248 <br></td><td>  F√ºr Ziel = 8 ist MAE = 3,21914648525 <br></td></tr><tr><td>  F√ºr Ziel = 9 ist MAE = 3,39256765159 <br></td><td>  F√ºr Ziel = 9 ist MAE = 3,54572928241 <br></td></tr><tr><td>  F√ºr Ziel = 10 ist MAE = 3,6640339953 </td><td>  F√ºr Ziel = 10 ist MAE = 3,84409605282 <br></td></tr><tr><td>  F√ºr Ziel = 11 ist MAE = 4.02797747118 <br></td><td>  F√ºr Ziel = 11 ist MAE = 4,21828735273 <br></td></tr><tr><td>  F√ºr Ziel = 12 ist MAE = 4,17163467899 <br></td><td>  F√ºr Ziel = 12 ist MAE = 3,92536509115 <br></td></tr><tr><td>  F√ºr Ziel = 14 ist MAE = 4,78590364522 <br></td><td>  F√ºr Ziel = 14 ist MAE = 5,11290428675 </td></tr><tr><td>  F√ºr Ziel = 15 ist MAE = 4,89409916994 <br></td><td>  F√ºr Ziel = 15 ist MAE = 5.20892023117 <br></td></tr></tbody></table><br>  Zugverlust = 0,535842111392 <br>  Testverlust = 0,895529959873 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Diagrammvorhersage (Ziel) f√ºr den Trainingssatz</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3m/o6/ho/3mo6hoqfklfc69z55btog7e6q_w.png" alt="Bild"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Graph Vorhersage (Ziel) f√ºr Testprobe</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hq/q6/bm/hqq6bm7aqcbngqum8mgdyhjibna.png" alt="Bild"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Vorhersagefehler von Zeit zu Zeit</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/in/mu/be/inmubedyg9b6hzyttimdneuh5-s.png" alt="Bild"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Sortieren Sie den aufsteigenden Fehler am Testmuster</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/74/h3/kt/74h3ktebx43a9mhmie6sgp5ua_i.png" alt="Bild"><br></div></div><br>  Wenn keine √ºbereinstimmen, suchen Sie erneut nach dem Zufallsprinzip.  So haben wir das Modell 5 oder 5 Tage im industriellen Tempo trainiert.  Wir waren im Dienst, jemand nachts, jemand wachte morgens auf, schaute sich die Top 10 Parameter an, startete das Modell neu oder speicherte es und ging weiter ins Bett.  In diesem Modus haben wir eine Woche lang gearbeitet und 130 Modelle geschult - 13 Warentypen und 10 Prognosetiefen mit jeweils 170 Merkmalen.  Die durchschnittliche MAE f√ºr den 5-fachen Zeitreihen-Lebenslauf betrug 1. <br><br>  Es scheint, dass dies nicht sehr cool ist - und das ist so, es sei denn, Sie haben einen gro√üen Anteil an der Auswahl der Einheiten.  Wie eine Analyse der Ergebnisse zeigt, werden Einheiten am schlimmsten vorhergesagt - die Tatsache, dass ein Produkt einmal pro Woche gekauft wurde, sagt nichts dar√ºber aus, ob eine Nachfrage danach besteht.  Sobald etwas verkauft werden kann, gibt es eine Person, die eine Porzellanfigur in Form eines Zahnarztes kauft, und dies sagt nichts √ºber zuk√ºnftige oder vergangene Verk√§ufe aus.  Im Allgemeinen waren wir dar√ºber nicht sehr ver√§rgert. <br><br><h3>  Tipps und Tricks </h3><br>  Was ist schief gelaufen und wie kann dies vermieden werden? <br><br>  Das erste Problem ist die Auswahl der Parameter.  Wir haben angefangen, RandomizedSearchCV zu verwenden - ein bekanntes Tool von sklearn zum Sortieren von Hyperparametern.  Hier erwartete uns die erste √úberraschung. <br><br><div class="spoiler">  <b class="spoiler_title">So</b> <div class="spoiler_text"><code>from sklearn.model_selection import ParameterSampler <br> from sklearn.model_selection import RandomizedSearchCV <br> <br> estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=72) <br> param_grid = {'boosting_type': boosting_type, 'num_leaves': num_leaves, 'max_depth': max_depth, 'learning_rate':learning_rate, 'n_estimators': n_estimators, 'subsample_for_bin': subsample_for_bin, 'min_child_samples': min_child_samples, 'colsample_bytree': colsample_bytree, 'reg_alpha': reg_alpha, 'max_bin': max_bin} <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=1, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  Die Berechnung bleibt einfach stehen (was wichtig ist, sie f√§llt nicht ab, sondern funktioniert weiter, aber auf einer immer kleineren Anzahl von Kernen und irgendwann h√∂rt sie einfach auf). <br><br><div class="spoiler">  <b class="spoiler_title">Ich musste den Prozess aufgrund von RandomizedSearchCV parallelisieren</b> <div class="spoiler_text"> <code>estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=1) <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=72, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  RandomizedSearchCV erfasst jedoch fast den gesamten Datensatz f√ºr jeden ‚ÄûJob‚Äú.  Dementsprechend ist es notwendig, die RAM-Menge stark zu erweitern, wodurch m√∂glicherweise die Anzahl der Kerne geopfert wird. <br><br>  Wer w√ºrde uns dann von so wunderbaren Dingen wie Hyperopt erz√§hlen!  Da wir gelernt haben, verwenden wir es nur. <br><br>  Ein weiterer Trick, der uns gegen Ende des Projekts einfiel, war die Auswahl von Modellen mit dem Parameter colsample_bytree (dies ist der LightGBM-Parameter, der angibt, wie viel Prozent der Funktionen jedem Lener zugewiesen werden sollen) im Bereich von 0,2 bis 0,3, denn wenn das Auto Es funktioniert in der Produktion, es gibt m√∂glicherweise keine Tabellen und einzelne Features werden m√∂glicherweise nicht richtig gez√§hlt.  Durch eine solche Regularisierung k√∂nnen Sie sicherstellen, dass diese nicht ber√ºcksichtigten Funktionen zumindest nicht alle Lernenden im Modell betreffen. <br>  Empirisch sind wir zu dem Schluss gekommen, dass wir mehr Sch√§tzer erstellen und die Regularisierung h√§rter verdrehen m√ºssen.  Dies ist keine Arbeitsregel f√ºr LightGBM, aber ein solches Schema hat bei uns funktioniert. <br><br>  Nun und nat√ºrlich Spark.  Zum Beispiel gibt es einen Fehler, den Spark selbst kennt: Wenn Sie mehrere Spalten aus einer Tabelle nehmen und eine neue erstellen und dann andere aus derselben Tabelle nehmen und eine neue erstellen und dann die erhaltenen Tabellen einstellen, wird alles kaputt gehen, obwohl dies nicht der Fall sein sollte.  Sie k√∂nnen nur gerettet werden, indem Sie alle faulen Berechnungen loswerden.  Wir haben sogar eine spezielle Funktion geschrieben - bumb_df, die den Datenrahmen in eine RDD zur√ºck in einen Datenrahmen verwandelt.  Das hei√üt, es werden alle verz√∂gerten Berechnungen zur√ºckgesetzt.  Dies kann Sie vor den meisten Spark-Problemen sch√ºtzen. <br><br><div class="spoiler">  <b class="spoiler_title">bumb_df</b> <div class="spoiler_text"> <code>def bump_df(df): <br> # to avoid problem: AnalysisException: resolved attribute(s) <br> df_rdd = df.rdd <br> if df_rdd.isEmpty(): <br> df = df_rdd.toDF(schema=df.schema) <br> return df <br> else: <br> return df_rdd.toDF(schema=df.schema) <br></code> <br></div></div><br><h3>  Die Prognose ist fertig: Wie viel werden wir bestellen? </h3><br>  Die Umsatzprognose ist eine rein mathematische Aufgabe, und wenn die Normalverteilung eines Null-Mittelwert-Fehlers f√ºr einen Mathematiker ein Sieg ist, dann ist dies f√ºr H√§ndler, die jeden Rubel auf ihrem Konto haben, inakzeptabel. <br><br>  Wenn ein zus√§tzliches iPhone oder ein modisches Kleid im Lager kein Problem darstellt, sondern ein Versicherungsbestand, bedeutet das Fehlen desselben iPhones im Lager einen Verlust von mindestens einer Marge und maximalem Image, und dies kann nicht zugelassen werden. <br><br>  Um dem Algorithmus beizubringen, so viel wie n√∂tig zu kaufen, mussten wir die Kosten f√ºr den Wieder- und Unterkauf jedes Produkts berechnen und ein einfaches Modell trainieren, um m√∂gliche Geldverluste zu minimieren. <br><br>  Das Modell erh√§lt am Eingang eine Umsatzprognose, f√ºgt zuf√§lliges, normalverteiltes Rauschen hinzu (wir simulieren die M√§ngel der Lieferanten) und lernt, genau so viel zur Prognose f√ºr jedes einzelne Produkt hinzuzuf√ºgen, um Geldverluste zu minimieren. <br><br>  Ein Auftrag ist also eine Prognose + Sicherheitsbestand, der die Abdeckung des Prognosefehlers und der Unvollkommenheit der Au√üenwelt garantiert. <br><br><h3>  Wie in prod </h3><br>  Ozon hat einen eigenen ziemlich gro√üen Computercluster, in dem jede Nacht eine Pipeline (wir verwenden Luftstrom) von mehr als 15 Jobs gestartet wird.  Es sieht so aus: <br><br><img src="https://habrastorage.org/webt/cc/sq/gb/ccsqgbj2p2xztr9qlllahzgr_4c.png" alt="Bild"><br><br>  Jede Nacht wird der Algorithmus gestartet, zieht etwa 20 GB Daten aus verschiedenen Quellen in lokale HDFS, w√§hlt einen Lieferanten f√ºr jedes Produkt aus, sammelt Funktionen f√ºr jedes Produkt, erstellt eine Verkaufsprognose und generiert Bestellungen basierend auf dem Lieferplan.  Um 6-7 Uhr geben wir dem Tisch Personen, die f√ºr die Arbeit mit Lieferanten verantwortlich sind, vorgefertigte Tische, die per Knopfdruck an die Lieferanten fliegen. <br><br><h3>  Keine einzige Prognose </h3><br>  Das trainierte Modell kennt die Abh√§ngigkeit der Prognose von einem Merkmal. Wenn Sie also N-1-Zeichen einfrieren und eines √§ndern, k√∂nnen Sie beobachten, wie sich dies auf die Prognose auswirkt.  Das Interessanteste daran ist nat√ºrlich, wie der Umsatz vom Preis abh√§ngt. <br><br>  Es ist wichtig zu beachten, dass die Nachfrage nicht nur vom Preis abh√§ngt.  Wenn Sie beispielsweise im Sommer kleine Rabatte auf Schlitten gew√§hren, hilft dies ihnen immer noch nicht beim Verkauf.  Wir machen mehr Rabatt und es erscheinen Leute, die "im Sommer einen Schlitten vorbereiten".  Bis zu einem bestimmten Preisnachlass k√∂nnen wir jedoch immer noch nicht den Teil des Gehirns erreichen, der f√ºr die Planung verantwortlich ist.  Im Winter funktioniert es wie bei jedem Produkt - Sie machen einen Rabatt und es verkauft sich schneller. <br><br><img src="https://habrastorage.org/webt/zp/by/jg/zpbyjgawjuxfa0pfm3rrp0sb4f0.png" alt="Bild"><br><br><h3>  Pl√§ne </h3><br>  Jetzt untersuchen wir aktiv die Clusterbildung von Zeitreihen, um Waren basierend auf der Art der Kurve, die ihre Verk√§ufe beschreibt, auf Cluster zu verteilen.  Zum Beispiel saisonal, traditionell beliebt im Sommer oder umgekehrt im Winter.  Wenn wir lernen, wie Produkte mit einer langen Verkaufshistorie getrennt werden, m√∂chten wir artikelbasierte Funktionen hervorheben, die Ihnen das Verkaufsmuster f√ºr ein neues, gerade erschienenes Produkt zeigen - dies ist vorerst unsere Hauptaufgabe. <br><br>  Neuronale Netze und parametrische Modelle von Zeitreihen und all dies im Ensemble werden sicherlich weiter gehen. <br><br>  Insbesondere dank des neuen Prognosesystems wechselte Ozon vom Einkauf von Waren mit Lagerbest√§nden zu zyklischen Lieferungen, wenn wir von einer Lieferung zur n√§chsten kaufen und keine Salden auf Lager lagern. <br><br>  Jetzt m√ºssen wir entscheiden, wie der Algorithmus gelehrt werden soll, um den Verkauf neuer Produkte und ganzer Kategorien vorherzusagen.  N√§chstes Jahr plant das Unternehmen, den Umsatz um 10 x in Kategorien und um 2,5 in Erf√ºllungsbereichen zu steigern.  Und wir m√ºssen den Modellen mitteilen, dass diese alten Daten relevant sind, aber f√ºr einen anderen, fr√ºheren Speicher.  Und w√§hrend wir dar√ºber nachdenken, wie es geht. <br><br>  Die zweite irrationale Sache, die wir vorhersagen m√ºssen, ist Mode.  Wie k√∂nnte man vorhersagen, dass sich ein Spinner so verkaufen w√ºrde?  Wie kann man den Verkauf neuer B√ºcher von Dan Brown vorhersagen, wenn eines seiner B√ºcher ausverkauft ist und das andere nicht?  W√§hrend wir daran arbeiten. <br><br>  Wenn Sie wissen, wie man es besser macht, oder wenn Sie in den Kommentaren Geschichten √ºber den Einsatz von maschinellem Lernen im Kampf haben, werden wir dar√ºber diskutieren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de431950/">https://habr.com/ru/post/de431950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de431940/index.html">Menschen brennen aus, wenn sie sich nicht wert f√ºhlen. Was tun?</a></li>
<li><a href="../de431942/index.html">Hierarchische Abh√§ngigkeitsinjektion in React und MobX State Tree als Dom√§nenmodell</a></li>
<li><a href="../de431944/index.html">Yealink Meeting Server 2.0 - Neue Videokonferenzfunktionen</a></li>
<li><a href="../de431946/index.html">Sicherheitswoche 49: Hacken von Dell und Marriott</a></li>
<li><a href="../de431948/index.html">Deep Mind lehrte seine KI, die Proteinstruktur vorherzusagen</a></li>
<li><a href="../de431954/index.html">Der ehemalige Vizepr√§sident von Sun und DEC wird Pr√§sident von MIPS / Wave und spricht √ºber Russland und RISC / V.</a></li>
<li><a href="../de431956/index.html">Logik, Erkl√§rbarkeit und zuk√ºnftiges Verst√§ndnis</a></li>
<li><a href="../de431958/index.html">Teslas virtuelles Batteriekraftwerk wird auf 1.000 H√§user in Australien erweitert</a></li>
<li><a href="../de431960/index.html">Nvidia wird verr√ºckt und √∂ffnet PhysX unter BSD-3</a></li>
<li><a href="../de431964/index.html">Sortierungen zusammenf√ºhren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>