<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçü§ù‚Äçüë©üèª üñêüèæ üè© Pr√©chargement en php 7.4: Compositeur et s√©lection des fichiers √† pr√©charger üëàüèº ‚òÇÔ∏è ü•Å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chez Badoo, nous passons activement √† PHP 7.4 et sommes tr√®s enthousiastes √† l'id√©e d'utiliser la nouvelle fonction de pr√©chargement. Il n'y a pas si ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√©chargement en php 7.4: Compositeur et s√©lection des fichiers √† pr√©charger</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/480746/">  Chez Badoo, nous passons activement √† PHP 7.4 et sommes tr√®s enthousiastes √† l'id√©e d'utiliser la nouvelle fonction de pr√©chargement.  Il n'y a pas si longtemps, nous avons <a href="https://habr.com/ru/company/badoo/blog/472528/">parl√©</a> de nos exp√©riences avec elle. <br><br>  Apparemment, la communaut√© est aussi excit√©e que nous.  Les d√©veloppeurs de framework <a href="https://github.com/laravel/ideas/issues/1406">discutent</a> activement de <a href="https://github.com/laravel/ideas/issues/1406">la</a> possibilit√© d'introduire une pr√©charge (et certains ont d√©j√† <a href="https://symfony.com/blog/new-in-symfony-4-4-preloading-symfony-applications-in-php-7-4">fait son support</a> ).  C'est maintenant au tour du gestionnaire de d√©pendances de Composer. <br><br><img src="https://habrastorage.org/webt/t2/b9/bm/t2b9bmzxxtkxl00vu23lyoqwnd4.png"><br><br>  <a href="https://medium.com/%40DarkGhostHunter">Italo Baeza a</a> √©crit <a href="https://medium.com/swlh/composer-how-it-should-preload-in-php-7-4-3f8d19fda40">un article</a> dans lequel il exprime son opinion sur la mani√®re dont Composer devrait travailler avec la pr√©charge.  J'ai d√©cid√© de partager une traduction de ce texte, et en m√™me temps une traduction de <a href="https://medium.com/swlh/preloading-your-php-7-4-project-in-one-line-9ede756f292c">son autre article</a> , sur la fa√ßon dont les d√©veloppeurs Composer eux-m√™mes ont r√©pondu √† la proposition, ainsi que sur un nouvel outil qui facilite le travail avec la pr√©charge. <br><a name="habracut"></a><br><h2>  Comment le compositeur doit pr√©charger en PHP 7.4 </h2><br>  Le pr√©chargement est l'une des fonctionnalit√©s importantes que PHP 7.4 offre aux d√©veloppeurs qui ont besoin de meilleures performances.  Cette fonction peut √™tre appel√©e "√©chauffement" avant d'impl√©menter le moteur JIT, qui appara√Ætra (ou devrait appara√Ætre) en PHP 8. Avant cela, le pr√©chargement sera suffisant, et qui sait, peut-√™tre qu'ils peuvent travailler en tandem. <br><br>  La fonction de pr√©charge est expliqu√©e dans <a href="https://stitcher.io/blog/preloading-in-php-74">cet article</a> .  Le r√©sultat est tr√®s simple: php.ini sp√©cifie un script PHP pour lequel lorsque le processus d√©marre, les fichiers sont charg√©s en m√©moire (pr√©chargement).  En combinaison avec OPCache et la fonction de chargement automatique <a href="https://medium.com/tech-tajawal/php-composer-the-autoloader-d676a2f103aa">, les</a> fichiers Composer peuvent √©galement √™tre compil√©s et li√©s une fois, apr√®s quoi ils seront disponibles pour toutes les demandes ult√©rieures.  Gr√¢ce √† cela, PHP n'a pas besoin de t√©l√©charger et de compiler des fichiers √† chaque demande. <br><br>  Cependant, les d√©veloppeurs de Composer n'√©taient pas d'accord sur la fa√ßon dont il devrait aider au pr√©chargement, en plus de fournir des fonctions de d√©marrage.  Les faits sont les suivants: <br><br><ul><li>  le pr√©chargement a √©t√© annonc√© pour la premi√®re fois en PHP 7.4; <br></li><li>  il n'y a pas de directive Composer pour aider √† pr√©charger les fichiers; <br></li><li>  pour pr√©charger, vous devez avoir acc√®s √† php.ini, c'est-√†-dire au processus lui-m√™me; <br></li><li>  le pr√©chargement de tous les fichiers n'am√©liorera pas n√©cessairement les performances par rapport au pr√©chargement uniquement des fichiers les plus demand√©s. <br></li></ul><br>  En d'autres termes, seuls ceux qui ont un acc√®s complet aux serveurs peuvent utiliser le pr√©chargement.  Cela exclut les serveurs partag√©s et certaines solutions PaaS qui n'impliquent pas de travailler avec php.ini. <br><br>  Alors, comment Composer peut-il aider √† pr√©charger √©tant donn√© qu'il s'agit d'une innovation?  Voici mon avis. <br><br><h2>  Fonctionnement de la pr√©charge </h2><br>  Le m√©canisme de pr√©chargement doit √™tre bas√© sur une liste de fichiers qui seront <i>charg√©s</i> et stock√©s en m√©moire au d√©marrage.  Et comme il s'agit d'une liste, nous devons travailler avec un tableau de fichiers et laisser Composer faire tout le travail, plut√¥t que de <i>charger</i> chaque fichier manuellement. <br><br>  Le compositeur doit prendre la liste des fichiers sp√©cifi√©s par l'application (le projet racine) et tout compiler dans des fichiers que PHP peut utiliser sans aucune difficult√©. <br>  Dans le m√™me temps, nous devons pouvoir ajouter et supprimer des packages du m√©canisme de pr√©charge. <br>  Le pr√©chargement ne devrait jamais fonctionner au niveau du package, car il est de la responsabilit√© du d√©veloppeur d'activer ou de d√©sactiver le pr√©chargement de chaque package. <br><br>  Le pr√©chargement dans Composer doit √™tre facultatif.  Le d√©veloppeur doit pouvoir le d√©sactiver pour que PHP utilise son propre pr√©chargeur, qui peut fonctionner sur la base de l'analyse OPCache - cela d√©pend de la charge de l'application et fonctionne beaucoup plus efficacement que le pr√©chargement de tous les fichiers. <br><br><h3>  Tout commence √† preload.json </h3><br>  Afin de ne pas compliquer le syst√®me, placez le fichier preload.json √† la racine du projet.  Il r√©pertorie les fichiers de pr√©chargement que Composer peut s√©lectionner.  Puisqu'il s'agit d'un fichier JSON, le d√©veloppeur peut m√™me le g√©n√©rer √† l'aide d'une commande sp√©ciale.  Je pense que ce serait formidable si Composer avait un utilitaire pour cr√©er un tel fichier JSON bas√© sur un script. <br><br><pre><code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"pre-compile"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"my-script.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"my-other-script.php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"extensions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"app/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"config/"</span></span>, <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Models/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Controllers/*/Http/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Views/Compiled*.php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"App\\Models"</span></span>, <span class="hljs-string"><span class="hljs-string">"App\\Controllers\\"</span></span>, <span class="hljs-string"><span class="hljs-string">"App\\Views\\MainView"</span></span>, <span class="hljs-string"><span class="hljs-string">"Vendor\\Package\\*"</span></span>, ], <span class="hljs-string"><span class="hljs-string">"packages"</span></span>: { <span class="hljs-string"><span class="hljs-string">"symfony/http-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"robert/*-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"vendor/package"</span></span>: { <span class="hljs-string"><span class="hljs-string">"files"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, <span class="hljs-string"><span class="hljs-string">"foo/bar"</span></span>: { <span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"loaders/*"</span></span> ], <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\DynamicLoaders\\*"</span></span>, <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\Clients"</span></span> ] } }, <span class="hljs-string"><span class="hljs-string">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"preload-compiled.php"</span></span> }</code> </pre> <br>  L'utilisation de preload.json vous permet de v√©rifier rapidement si le pr√©chargement est inclus dans le projet: si le fichier est manquant, le pr√©chargement n'est pas pris en charge ou ind√©sirable. <br><br>  Voyons ce que font les cl√©s. <br><br>  <b>pr√©compiler</b> <br><br>  Ces fichiers seront ex√©cut√©s par Composer.  Chaque script doit renvoyer un tableau de chemins de fichiers absolus pour les ajouter √† la liste de pr√©chargement, qui jouera le r√¥le de la liste principale. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"pre-compile"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"my-script.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"my-other-script.php"</span></span> ]</code> </pre><br>  Ces fichiers seront ex√©cut√©s dans l'ordre sp√©cifi√©. <br><br>  L'objectif est que le d√©veloppeur cr√©e une liste de fichiers comme bon lui semble, plut√¥t que de s'appuyer sur un seul fichier JSON.  Ces fichiers seront d'abord ex√©cut√©s.  Et oui, vous ne pouvez impl√©menter preload.json qu'avec cette cl√©.  Puisque nous parlons de fichiers PHP, lors de la compilation d'un tableau, vous pouvez m√™me ajouter d'autres fichiers. <br><br>  <b>extensions</b> <br><br>  Il s'agit d'une liste d'extensions de fichiers qui doivent √™tre pr√©charg√©es.  Par d√©faut, seuls les fichiers avec l'extension php sont pris. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"extensions"</span></span>: [<span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"php5"</span></span>, <span class="hljs-string"><span class="hljs-string">"php7"</span></span>]</code> </pre> <br>  Par exemple, vous pouvez ajouter un r√©pertoire rempli de fichiers * .phtml, y compris certains fichiers PHP utiles, et Composer ne les s√©lectionnera pas, et non l'int√©gralit√© du contenu du r√©pertoire. <br>  Comme vous le comprenez, ce processus peut √™tre remplac√© en ajoutant des fichiers manuellement. <br><br>  <b>les fichiers</b> <br><br>  Cette cl√© indique √† Composer de t√©l√©charger tous les fichiers de la liste dont les chemins sont relatifs √† l'emplacement de composer.json. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Models/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Controllers/*/Http/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Views/Compiled*.php"</span></span>, ]</code> </pre><br>  Il est facile de trouver la liste: <br><br><ul><li>  utiliser des chemins relatifs pour ajouter des fichiers et des r√©pertoires; <br></li><li>  √† partir des r√©pertoires, seuls les fichiers enfants stock√©s dans ces r√©pertoires seront ajout√©s (pas de mani√®re r√©cursive); <br></li><li>  les chemins r√©cursifs sont indiqu√©s par un ast√©risque se terminant (*); <br></li><li>  en utilisant ce symbole, vous pouvez √©galement, par exemple, ajouter certains fichiers et r√©pertoires: <code>src/Clients/*/Stores</code> ou <code>src/Model*.php</code> . <br></li></ul><br>  L'ajout de fichiers par masque sans s√©lectionner ou cr√©er manuellement des scripts sp√©cifiques √† l'application est particuli√®rement utile lors du d√©veloppement de grandes applications. <br><br>  Si vous avez juste besoin de pr√©charger tous les fichiers √† <a href="">l'</a> aide de <a href="">la cl√© de chargement automatique</a> dans le fichier Composer JSON, d√©finissez-la sur <code>true</code> . <br><br>  <b>espace de noms</b> <br><br>  Cette cl√© indique √† Composer de charger des fichiers avec un espace de noms ou un nom de classe donn√©, comme un <code>file</code> ou un <code>directory</code> .  Le m√™me m√©canisme vous permet d'appeler dynamiquement des noms d'espace √† partir d'autres packages install√©s. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"namespaces"</span></span>: [   <span class="hljs-string"><span class="hljs-string">"App\\Models"</span></span>,   <span class="hljs-string"><span class="hljs-string">"App\\Controllers\\"</span></span>,   <span class="hljs-string"><span class="hljs-string">"App\\Views\\MainView"</span></span>,   <span class="hljs-string"><span class="hljs-string">"Vendor\\Package\\*"</span></span>, ]</code> </pre> <br>  Cela est √©galement pratique lorsque vous travaillez sur des applications volumineuses qui d√©pendent davantage des espaces de noms plut√¥t que des fichiers qui peuvent changer √† tout moment.  Composer extrait automatiquement les fichiers en fonction de l'espace de noms et les place dans une liste. <br><br>  <b>packages</b> <br><br>  Cette cl√© vous permet de charger d'autres fichiers enregistr√©s √† partir de packages externes, tels que des fichiers auxiliaires ou des classes associ√©es √† un espace de noms. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"packages"</span></span>: {   <span class="hljs-string"><span class="hljs-string">"symfony/http-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,   <span class="hljs-string"><span class="hljs-string">"robert/*-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,   <span class="hljs-string"><span class="hljs-string">"vendor/package"</span></span>: {       <span class="hljs-string"><span class="hljs-string">"files"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,       <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>   },   <span class="hljs-string"><span class="hljs-string">"foo/bar"</span></span>: {       <span class="hljs-string"><span class="hljs-string">"files"</span></span>: {           <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>,           <span class="hljs-string"><span class="hljs-string">"loaders/*"</span></span>       },       <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [           <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\DynamicLoaders\\*"</span></span>,           <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\Clients"</span></span>       ]   } }</code> </pre> <br>  Tout est tr√®s simple ici: si la valeur est vraie, alors tout le contenu <a href="">de la cl√© de chargement automatique</a> dans le fichier composer.json de ce paquet sera charg√©.  Sinon, vous pouvez contr√¥ler plus finement l'ajout de pr√©charge. <br><br>  Si la valeur de la cl√© est vraie, elle t√©l√©chargera tous les fichiers enregistr√©s en <code>autoload</code> .  La valeur par d√©faut est <code>false</code> .  Cela est √©galement vrai pour la cl√© d' <code>namespace</code> . <br><br>  Vous pouvez √©galement s√©lectionner des fichiers ou des espaces de noms individuels avec cette r√®gle.  Mais dans ce cas, la cl√© de <code>autoload</code> ne sera pas utilis√©e. <br><br>  <b>sortie</b> <br><br>  Il s'agit simplement du nom du fichier de liste de pr√©chargement compil√©. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"preload-compiled.php"</span></span></code> </pre> <br><h3>  Assemblage facile </h3><br>  Notre liste de pr√©chargement est pr√™te, et nous pouvons appeler Composer pour compiler le script de pr√©chargement principal. <br><br><pre> <code class="php hljs">composer preload</code> </pre> <br>  Par cons√©quent, preload-compiled.php sera cr√©√© avec tous les fichiers que PHP doit pr√©charger.  Bien s√ªr, vous pouvez modifier le nom du fichier comme vous le souhaitez. <br><br>  Vous devez √©galement remplacer les cl√©s de <code>preload</code> param√®tres. <br><br><pre> <code class="php hljs">composer preload \   --input=my-custom-preload-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>.json \   --output=my-preload.php</code> </pre> <br><h3>  D√©sactiv√© par d√©faut </h3><br>  Les projets sans preload.json renverront une erreur si vous essayez de compiler un fichier pour le pr√©chargement.  La raison en est que Composer ne devinera pas (et ne devrait pas) deviner ce qui doit √™tre pr√©charg√©. <br><br>  Permettez-moi de vous rappeler que la pr√©charge n'interf√®re pas avec les fonctionnalit√©s normales de Composer.  Comme il s'agit d'une commande console, avec d√©veloppement local, vous pouvez compl√®tement abandonner le pr√©chargement.  La seule chose dont le m√©canisme de pr√©chargement Composer a besoin est un fichier de chargement automatique, qui devrait √™tre g√©n√©r√© s'il est manquant.  Eh bien, apr√®s tout, presque la 2020e ann√©e est dans la cour, le PSR-4 est utilis√© partout, non? <br><br><h3>  R√©sultat </h3><br>  Vous devriez obtenir un fichier php avec quelque chose comme ceci: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Preloading </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@generated</span></span></span><span class="hljs-comment"> by Composer */</span></span> <span class="hljs-comment"><span class="hljs-comment">// Autoload the classes so those can be preloaded using `require_once`. require_once __DIR__.'/../autoload.php'; // File list $files = [ '/var/www/app/Foo.php', '/var/www/app/Bar.php', '/var/www/helpers/basic.php', '/var/www/helpers/advanced.php', '/var/www/vendor/Foo/Bar/src/Class.php', '/var/www/vendor/Foo/Bar/helpers/helpers.php', '/var/www/vendor/Foo/Bar/config.php', // ... ]; // Preload all root project files foreach ($files as $file) { require_once $file; }</span></span></code> </pre> <br>  En fait, ce n'est qu'une liste de fichiers qui seront pr√©charg√©s √† l'aide de la fonction de chargement automatique dans Composer.  PHP ex√©cutera ce fichier une fois et il deviendra historique. <br><hr><br>  J'esp√®re sinc√®rement que Composer aura un moyen de pr√©charger les fichiers sans avoir √† √©crire un hack. <br><br>  √âtant donn√© que la m√©thode d√©crite ci-dessus ne fait pas partie du noyau Composer, vous pouvez toujours s√©lectionner les fichiers les plus importants pour le pr√©chargement en fonction de l'analyse OPCache sans toucher aux fichiers les moins n√©cessaires.  Imaginez qu'au lieu de pr√©charger 1 500 fichiers d'une capacit√© de 100 Mo, vous ne pouvez t√©l√©charger que 150 fichiers d'une capacit√© de 10 Mo, tout en conservant 99% des performances d'origine. <br><br><h2>  Nous pr√©chargeons le projet PHP 7.4 en une seule ligne </h2><br>  Peu de temps apr√®s avoir √©crit un article sur la fa√ßon dont Composer peut vous aider √† pr√©charger un projet, <a href="https://github.com/Seldaek">Seldaek</a> (un membre de l'√©quipe de d√©veloppement de Composer) a <a href="https://github.com/composer/composer/issues/7777">tu√© tout espoir</a> que Composer aurait une option facile pour pr√©charger le projet dans le processus PHP √† partir du gestionnaire de packages. <br><br><blockquote>  (...) Je vais vous expliquer: je suis s√ªr que dans un proche avenir, nous n‚Äôajouterons rien de li√© au pr√©chargement dans Composer. </blockquote><br>  Pourquoi?  Le pr√©chargement en PHP est plus un probl√®me de d√©veloppement (plut√¥t qu'une d√©pendance); il est r√©solu en modifiant manuellement php.ini - seuls les d√©veloppeurs peuvent le faire s'ils g√®rent eux-m√™mes PHP. <br><br>  Mais cela ne m'emp√™che pas de cr√©er mon propre package pour pr√©charger le projet.  Et toi aussi. <br><br><h2>  Pr√©charge et m√©triques </h2><br>  Le pr√©chargement peut √™tre un bon outil pour une augmentation <a href="https://wiki.php.net/rfc/preload">simple et bon march√©</a> de la productivit√© sans traitement s√©rieux. <br><br>  Mais le probl√®me n'est pas de <i>savoir comment</i> pr√©charger, mais <i>quoi</i> .  Le pr√©chargement de frameworks entiers et de milliers de fichiers √©puisera rapidement la m√©moire, donc le faire aveugl√©ment n'est pas une option, du moins dans les grands projets.  Il est conseill√© de t√©l√©charger uniquement les fichiers les plus demand√©s.  Mais comment les d√©finir? <br><br>  Heureusement, OPCache permet √† <a href="https://www.php.net/manual/en/function.opcache-get-status.php">opcache_get_status ()</a> de collecter des donn√©es sur les fichiers les plus consult√©s.  Vous pouvez non seulement d√©couvrir quels fichiers sont les plus demand√©s, mais m√™me la quantit√© de m√©moire qu'ils consomment quelque temps apr√®s le d√©marrage de l'application. <br><br>  Il est recommand√© d'attendre soit une semaine soit jusqu'au moment o√π OPCache enregistre un certain nombre de hits.  Tout d√©pend de l'application, mais vous obtenez le point. <br>  Cr√©ons donc une liste de pr√©chargement bas√©e sur les statistiques des fichiers les plus populaires.  J'ai fait un paquet pour √ßa. <br><br><h2>  Imaginez ... Preloader! </h2><br>  Ce package cr√©era automatiquement une liste de pr√©chargement pour votre application.  Il collectera les statistiques d'utilisation d'OPCache, triera les fichiers par le nombre de hits et cr√©era une liste afin que la taille totale du fichier ne d√©passe pas le seuil sp√©cifi√©. <br><br><img src="https://habrastorage.org/webt/sm/1b/vi/sm1bvipjlzifwjfc4evvvpaqaau.png"><br><br>  J'ai longtemps √©t√© perplexe √† la recherche de la meilleure strat√©gie pour cr√©er une liste.  Et je suis arriv√© √† la conclusion qu'il est pr√©f√©rable d'y ajouter tous les fichiers jusqu'√† ce que vous rencontriez la limite de m√©moire, qui pour les packages est de 32 Mo par d√©faut.  Les fichiers seront tri√©s par nombre de hits et le package lui-m√™me sera automatiquement exclu. <br><br>  En d'autres termes, PHP am√©liorera les performances des applications lors du traitement de la plupart des requ√™tes. <br><br>  Et comment l'utiliser?  Dites √† Composer Autoloader o√π √©crire le script Preloader, et vous avez termin√©. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DarkGhostHunter</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>; Preloader::make() -&gt;autoload(<span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>) -&gt;output(<span class="hljs-string"><span class="hljs-string">'preload.php'</span></span>) -&gt;generate();</code> </pre><br>  Bien s√ªr, vous devez choisir le moment de g√©n√©rer, mais c'est tout.  Vous pouvez m√™me le faire au hasard et r√©√©crire la liste, par exemple, pour chaque 100e demande. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DarkGhostHunter</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>; Preloader::make() -&gt;whenOneIn(<span class="hljs-number"><span class="hljs-number">100</span></span>) -&gt;autoload(<span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>) -&gt;output(<span class="hljs-string"><span class="hljs-string">'preload.php'</span></span>) -&gt;overwrite() -&gt;generate();</code> </pre><br>  Vous obtiendrez un script de pr√©chargement pr√™t √† l'emploi que vous pouvez mettre dans php.ini. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * This file is generated automatically by Preloader. * * This script uses Composer Autoload file and `require_once` to preload the files in this * list. Add this file to your `php.ini` in `opcache.preload` to preload this list into * PHP at startup. Additionally, this file also includes information about Opcache. * * * Add (or update) this line in `php.ini`: * * opcache.preload=/www/app/vendor/preload.php * * --- Config --- * Generated at: 2019-11-20 15:20:49 UTC * Opcache * - Used Memory: 130585 B * - Free Memory: 294896 B * - Wasted Memory: 347764 B * - Cached files: 2675 * - Hit rate: 94% * - Misses: 542 * Preloader config * - Memory limit: 32 MB * - Overwrite: false * - Files excluded: 0 * - Files appended: 0 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'/www/app/vendor/autoload.php'</span></span>; $files = [ <span class="hljs-string"><span class="hljs-string">'/www/app/ClassFoo.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassBar.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassBaz.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassQuz.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassQux.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/vendor/author/package/src/Example.php'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ... ]; foreach ($files as $file) { require_once $file; }</span></span></code> </pre><br>  Et c'est tout.  Essayez par vous-m√™me: <a href="https://packagist.org/packages/darkghosthunter/preloader%3Fsource%3Dpost_page-----9ede756f292c----------------------">darkghosthunter / preloader - Packagist</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480746/">https://habr.com/ru/post/fr480746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480730/index.html">D√©veloppement Auto-Moto et Nginx</a></li>
<li><a href="../fr480736/index.html">Pourquoi pas toutes les erreurs doivent √™tre corrig√©es pour am√©liorer un produit informatique</a></li>
<li><a href="../fr480738/index.html">Exp√©rience dans la cr√©ation d'un produit en Russie ou Comment cr√©er un aspirateur sans fil ¬´folk¬ª PRO-EXPERT</a></li>
<li><a href="../fr480740/index.html">4 fonctionnalit√©s Numpy int√©ressantes que j'utilise constamment</a></li>
<li><a href="../fr480744/index.html">Comment un programmeur peut-il prot√©ger son projet pour animaux de compagnie</a></li>
<li><a href="../fr480748/index.html">Pourquoi avez-vous besoin de tant de d√©veloppeurs?</a></li>
<li><a href="../fr480752/index.html">L'ICANN suspend la vente de la zone de domaine .ORG</a></li>
<li><a href="../fr480754/index.html">Gestion du chaos: nettoyer avec le routage</a></li>
<li><a href="../fr480756/index.html">Donn√©es ouvertes. Roscosmos. Faisons comme en NASA</a></li>
<li><a href="../fr480760/index.html">Travailler √† l'√©tranger: dans quels pays Internet est-il le plus rapide?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>