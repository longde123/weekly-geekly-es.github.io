<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧓🏾 👨🏽‍🏭 📓 Wie wir uns ins Bein geschossen haben und versucht haben herauszufinden, was genau 🧕🏻 👃🏽 🔮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Frühere Beiträge im Unternehmensblog enthielten kein einziges Konsolenteam, und wir beschlossen, aufzuholen. 


 Unser Unternehmen verfügt über eine M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir uns ins Bein geschossen haben und versucht haben herauszufinden, was genau</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/timeweb/blog/428954/"><p>  Frühere Beiträge im Unternehmensblog enthielten kein einziges Konsolenteam, und wir beschlossen, aufzuholen. </p><br><p>  Unser Unternehmen verfügt über eine Metrik, mit der große Fehler beim Shared Hosting vermieden werden sollen.  Auf jedem gemeinsam genutzten Hosting-Server befindet sich eine Test-Site in WordPress, auf die regelmäßig zugegriffen wird. </p><br><p><img src="https://habrastorage.org/webt/g_/va/ot/g_vaotdagl43wnkctciq39tewes.png" alt="Bild"><br>  <em>So sieht die Testsite auf jedem gemeinsam genutzten Hosting-Server aus</em> </p><br><p><a name="habracut"></a>  Die Geschwindigkeit und der Erfolg der Standortantwort werden gemessen.  Jeder Mitarbeiter des Unternehmens kann sich die allgemeinen Statistiken ansehen und sehen, wie gut es dem Unternehmen geht.  Kann den Prozentsatz der erfolgreichen Antworten einer Testwebsite für das gesamte Hosting oder für einen bestimmten Server anzeigen.  Es ist nicht erforderlich, Mitarbeiter des Unternehmens zu sein. In der Systemsteuerung sehen Kunden auch Statistiken auf dem Server, auf dem sich ihr Konto befindet. </p><br><p>  Wir haben diese <strong>Verfügbarkeitsmetrik genannt</strong> (der Prozentsatz der erfolgreichen Antworten von der Test-Site auf alle Anfragen an die Test-Site).  Kein sehr guter Name, es ist leicht, ihn mit der <em>Verfügbarkeit</em> zu verwechseln, die <em>die Gesamtzeit nach dem letzten Neustart des Servers</em> beträgt. </p><br><p>  Der Sommer verging und der Zeitplan für die Betriebszeit ging langsam zurück. </p><br><p><img src="https://habrastorage.org/webt/h5/-h/n6/h5-hn6fmxnjepsbj8i7j1azozeu.png" alt="Bild"></p><br><p>  Administratoren identifizierten sofort den Grund - Mangel an RAM.  Es war leicht, OOM-Fälle in den Protokollen zu sehen, wenn der Server keinen Speicher mehr hatte und der Kernel Nginx tötete. </p><br><p>  Der Abteilungsleiter Andrey teilt eine Aufgabe mithilfe eines Assistenten in mehrere auf und parallelisiert sie zu verschiedenen Administratoren.  Man wird die Apache-Einstellungen analysieren - vielleicht sind die Einstellungen nicht optimal und bei viel Verkehr nutzt Apache den gesamten Speicher?  Ein anderer analysiert den Speicherverbrauch von mysqld - plötzlich gibt es veraltete Einstellungen aus der Zeit, als Shared Hosting das Gentoo-Betriebssystem verwendete?  Der dritte Teil befasst sich mit den letzten Änderungen an den Nginx-Einstellungen. </p><br><p>  Nacheinander kehren Administratoren mit Ergebnissen zurück.  Jeder konnte den Speicherverbrauch in dem ihm zugewiesenen Bereich reduzieren.  Im Fall von nginx wurde beispielsweise eine eingeschlossene, aber nicht verwendete mod_security erkannt.  OOM ist mittlerweile auch häufig. </p><br><p>  Schließlich ist zu bemerken, dass der Kernspeicherverbrauch (insbesondere SUnreclaim) auf einigen Servern furchtbar hoch ist.  Weder in der ps-Ausgabe noch in htop ist dieser Parameter sichtbar, daher haben wir ihn nicht sofort bemerkt!  Beispielserver mit infernalischem SUnreclaim: </p><br><pre><code class="hljs perl">root@vh28.timeweb.ru:~<span class="hljs-comment"><span class="hljs-comment"># grep SU /proc/meminfo SUnreclaim: 25842956 kB</span></span></code> </pre> <br><p>  Dem Kernel werden 24 Gigabyte RAM zur Verfügung gestellt, und der Kernel gibt sie aus, denn niemand weiß was! </p><br><p>  Der Administrator (nennen wir ihn Gabriel) eilt in die Schlacht.  Setzt den Kernel mit KMEMLEAK-Optionen zur Lecksuche wieder zusammen. </p><br><div class="spoiler">  <b class="spoiler_title">Optionen für den Wiederaufbau</b> <div class="spoiler_text"><p>  Um KMEMLEAK zu aktivieren, geben Sie einfach die unten aufgeführten Optionen an und laden Sie den Kernel mit dem Parameter kmemleak = on. </p><br><pre> <code class="hljs">CONFIG_HAVE_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=10000</code> </pre> </div></div><br><p>  KMEMLEAK schreibt (in <code>/sys/kernel/debug/kmemleak</code> ) diese Zeilen: </p><br><pre> <code class="hljs powershell">unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff88013a028228 (size <span class="hljs-number"><span class="hljs-number">8</span></span>): comm <span class="hljs-string"><span class="hljs-string">"apache2"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23254</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346187846</span></span> (age <span class="hljs-number"><span class="hljs-number">1436.284</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">8</span></span> bytes): <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ........ backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d450a</span></span>&gt;] kmem_cache_alloc_trace+<span class="hljs-number"><span class="hljs-number">0</span></span>xca/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8136dcc3</span></span>&gt;] apparmor_file_alloc_security+<span class="hljs-number"><span class="hljs-number">0</span></span>x23/<span class="hljs-number"><span class="hljs-number">0</span></span>x40 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81332d63</span></span>&gt;] security_file_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x33/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f8013</span></span>&gt;] get_empty_filp+<span class="hljs-number"><span class="hljs-number">0</span></span>x93/<span class="hljs-number"><span class="hljs-number">0</span></span>x1c0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f815b</span></span>&gt;] alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x1b/<span class="hljs-number"><span class="hljs-number">0</span></span>xa0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81728361</span></span>&gt;] sock_alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x91/<span class="hljs-number"><span class="hljs-number">0</span></span>x120 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b52e</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x7e/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff880d67030280 (size <span class="hljs-number"><span class="hljs-number">624</span></span>): comm <span class="hljs-string"><span class="hljs-string">"hrrb"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23713</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346190262</span></span> (age <span class="hljs-number"><span class="hljs-number">1426.620</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">32</span></span> bytes): <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ................ <span class="hljs-number"><span class="hljs-number">00</span></span> e7 <span class="hljs-number"><span class="hljs-number">1</span></span>a <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff ..........vn.... backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d4337</span></span>&gt;] kmem_cache_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>xc7/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172a25d</span></span>&gt;] sock_alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8121082d</span></span>&gt;] alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>x90 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81212b01</span></span>&gt;] new_inode_pseudo+<span class="hljs-number"><span class="hljs-number">0</span></span>x11/<span class="hljs-number"><span class="hljs-number">0</span></span>x60 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172952a</span></span>&gt;] sock_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x1a/<span class="hljs-number"><span class="hljs-number">0</span></span>x80 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81729aef</span></span>&gt;] __sock_create+<span class="hljs-number"><span class="hljs-number">0</span></span>x7f/<span class="hljs-number"><span class="hljs-number">0</span></span>x220 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b502</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x52/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff</code> </pre> <br><p>  Gabriel hat uns nicht alle seine Geheimnisse preisgegeben und nicht erzählt, wie er aus den obigen Zeilen die genaue Ursache des Speicherverlusts herausgefunden hat.  Höchstwahrscheinlich verwendete er den <code>addr2line /usr/lib/debug/lib/modules/`uname -r`/vmlinux ffffffff81722361</code> , um die genaue Zeile zu finden.  Oder öffnen Sie <code>net/socket.c</code> und sehen Sie sie sich an, bis die Datei unangenehm wird. </p><br><p>  Das Problem stellte sich als Patch in der <code>net/socket.c</code> , der vor vielen Jahren zu unserem Repository hinzugefügt wurde.  Der Zweck besteht darin, Clients die Verwendung des Systemaufrufs bind () zu untersagen. Dies ist ein einfacher Schutz gegen Proxyserver, die von Clients gestartet werden.  Der Patch hat seinen Zweck erfüllt, aber den Speicher nach sich selbst nicht gelöscht. <br>  Möglicherweise gab es in PHP neue modische Malware, die versuchte, einen Proxyserver in einer Schleife auszuführen - was zu Hunderttausenden blockierter bind () -Aufrufe und einem Verlust von Gigabyte RAM führte. </p><br><p>  Dann war es einfach - Gabriel reparierte den Patch und baute den Kernel neu auf.  Überwachung des Werts von SUnreclaim auf allen Servern unter Linux hinzugefügt.  Ingenieure warnten Kunden und starteten das Hosting im neuen Kern neu. <br>  OOM verschwand. </p><br><h3 id="no-problema-s-dostupnostyu-saytov-ostalas">  Das Problem mit der Verfügbarkeit von Websites blieb jedoch bestehen </h3><br><p>  Auf allen Servern reagierte die Testwebsite mehrmals täglich nicht mehr. </p><br><p>  Hier fing der Autor an, Haare an verschiedenen Körperteilen zu reißen.  Aber Gabriel blieb ruhig und schaltete die Aufzeichnung des Datenverkehrs zu Teilen der Hosting-Server ein. </p><br><p>  Im Verkehrsdump wurde festgestellt, dass die Anforderung an die Teststelle am häufigsten nach dem plötzlichen Empfang eines <code>TCP RST</code> Pakets fällt.  Mit anderen Worten, die Anforderung erreichte den Server, aber die Verbindung wurde von nginx unterbrochen. <br>  Noch interessanter!  Das von Gabriel gestartete Dienstprogramm strace zeigt, dass der Nginx-Daemon dieses Paket <strong>nicht</strong> sendet.  Wie kann das sein, weil nur Nginx Port 80 abhört? <br>  Der Grund war eine Kombination mehrerer Faktoren: </p><br><ul><li>  In den <code>reuseport</code> Einstellungen wird die Option " <code>reuseport</code> " <code>reuseport</code> (einschließlich der Socket- <code>SO_REUSEPORT</code> ), mit der verschiedene Prozesse Verbindungen an derselben Adresse und demselben Port akzeptieren können </li><li>  In der (zu diesem Zeitpunkt neuesten) Version von Nginx 1.13.0 gibt es einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fehler,</a> aufgrund dessen dieser Nginx-Testprozess beim Starten des Nginx-Konfigurationstests über <code>nginx -t</code> und unter Verwendung der <code>SO_REUSEPORT</code> wirklich begann, Port 80 abzuhören und Anforderungen von echten Clients abzufangen .  Am Ende des Konfigurationstestprozesses erhielten die Clients die <code>Connection reset by peer</code> </li><li>  Schließlich wurde bei der Überwachung des zabbix die Überwachung der Korrektheit der Nginx-Konfiguration auf allen Servern mit installiertem Nginx konfiguriert: Der Befehl <code>nginx -t</code> wurde einmal pro Minute auf ihnen aufgerufen. </li></ul><br><p>  Erst nach der Aktualisierung von Nginx können Sie ruhig ausatmen.  Das Betriebszeitdiagramm der Websites ist gestiegen. </p><br><p>  Was ist die Moral dieser ganzen Geschichte?  Seien Sie optimistisch und vermeiden Sie die Verwendung selbstorganisierter Kernel. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428954/">https://habr.com/ru/post/de428954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428938/index.html">Vom Sieg zum PornHub: Wie Unternehmen dunkle Muster verwenden</a></li>
<li><a href="../de428940/index.html">GitLab 11.4 wurde mit einer Überprüfung der Zusammenführungsanforderung und Plug-In-Funktionen veröffentlicht</a></li>
<li><a href="../de428942/index.html">Vorletzter Beitrag</a></li>
<li><a href="../de428946/index.html">Sicherheitswoche 45: Etwas über Bluetooth-Sicherheitslücken</a></li>
<li><a href="../de428950/index.html">Lösen des Problems der „kurzen Linksverschiebung“</a></li>
<li><a href="../de428956/index.html">Drohnen auf der ISS</a></li>
<li><a href="../de428960/index.html">Bericht des Club of Rome 2018, Kapitel 1.5: Climate Challenge</a></li>
<li><a href="../de428962/index.html">Umzug in Luxoft: Wie bleibt das Leben?</a></li>
<li><a href="../de428964/index.html">Hardware-verschlüsselte SSD-Sicherheitslücken ermöglichen es Angreifern, die Sicherheit einfach zu umgehen</a></li>
<li><a href="../de428972/index.html">Kontinuierliche Integration in Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>