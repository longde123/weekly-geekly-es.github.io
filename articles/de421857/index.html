<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñ±Ô∏è üíì üê¥ ToFoIn v 1. Reservierung von Gateways und Umschalten zwischen externen Kan√§len in FreeBSD üë©‚Äç‚öïÔ∏è üöÄ üåÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anmerkung 
 In einem fr√ºheren Artikel wurde die Organisation der Redundanz f√ºr LAN-Gateways betrachtet. Als L√∂sung wurde ein Skript vorgeschlagen, das...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1. Reservierung von Gateways und Umschalten zwischen externen Kan√§len in FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3>  Anmerkung </h3><br>  In einem fr√ºheren Artikel wurde die Organisation der Redundanz f√ºr LAN-Gateways betrachtet.  Als L√∂sung wurde ein Skript vorgeschlagen, das zu diesem Zeitpunkt das Problem l√∂ste, jedoch eine Reihe von Nachteilen aufwies.  Nach einiger Zeit stellte sich heraus, dass diese M√§ngel beseitigt wurden, der Code teilweise neu geschrieben wurde und an der Ausgabe etwas Akzeptables erzielt wurde.  Jetzt k√∂nnen wir sagen, dass die Skripte genug getestet wurden, um als stabil bezeichnet zu werden.  Um das Verst√§ndnis des gesamten Systems zu vereinfachen, werden die wichtigsten Punkte f√ºr die Einrichtung von Sekund√§rdiensten (in Bezug auf das Thema des Artikels) im Folgenden teilweise dupliziert.  Der Grund ist einfach: W√§hrend dieser Zeit wurden auch die ipfw-Regeln √ºberarbeitet, DNS wurde in AD auf Samba4 mit einem Bind-Frontend und sicher aktualisierten Datens√§tzen von isc-dhcpd unter Verwendung von Kerberos sowie sekund√§ren DNS-Servern als Bindung an die Gateways in Betrieb genommen. konfiguriertes CARP ... Im Allgemeinen ist es viel interessanter geworden, aber weiter unten erfahren Sie, was und wie es funktioniert.  Alles, was mit Verweisen auf die Quelle angegeben werden kann, wird so gestaltet, dass keine Essenz entsteht.  Was von anderen Orten genommen wurde, aber nicht mehr verf√ºgbar ist, wird hier mit relevanten Kommentaren angegeben. <br><a name="habracut"></a><br><h3>  Einf√ºhrung </h3><br>  Es gibt also zwei M√∂glichkeiten, um die St√∂rfestigkeit des Kommunikationskanals mit der Au√üenwelt seitens des Verbrauchers zu erh√∂hen: Sicherung des Gateways und Reservierung des Verbindungspunkts.  Mit anderen Worten, im ersten Fall wird ein zweites Gateway eingerichtet, das aktiviert wird, wenn das erste ausf√§llt. Im zweiten Fall wird ein Backup-Internetkanal organisiert, falls Probleme mit dem Hauptkanal auftreten. Je weiter sie sich kreuzen, desto besser.  Wenn <abbr title="Gemeinsames Adressredundanzprotokoll">CARP</abbr> die erste Aufgabe f√ºr FreeBSD l√∂st, kann die zweite nach dem Organisieren des zweiten externen Kanals wieder auf verschiedene Arten gel√∂st werden.  Zumindest k√∂nnen Sie den Verkehrsausgleich oder das Umschalten zwischen Kan√§len organisieren.  Aufgrund des gro√üen Unterschieds in der Bandbreite externer Kan√§le <abbr title="Toogle Failover des Internets">passte</abbr> die erste Option nicht <abbr title="Toogle Failover des Internets">zu</abbr> mir, daher wurde der Hauptschuldige der Ver√∂ffentlichung geschrieben: <abbr title="Toogle Failover des Internets">ToFoIn</abbr> - eine Reihe von Bash-Skripten, die darauf abzielen, Diagnoseprobleme zu l√∂sen und zu einem funktionierenden externen Kanal zu wechseln.  Nach der Verfeinerung kann es auf n Gateways und m Kan√§le angewendet werden.  Die Situation ist schwach, wo n und m mehr als 2 sind, aber die folgenden Skripte sollten bis zu gro√üen Werten von n und m funktionieren, weil  Logischerweise ist das Limit nicht festgelegt.  Im Allgemeinen vermute ich, dass es mit diesen Skripten m√∂glich ist, eine ziemlich breite Palette von Aufgaben zu l√∂sen, abh√§ngig vom Status der Verbindung, die m√∂glicherweise nur durch Vorstellungskraft begrenzt ist. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Ungef√§hr diese Netzwerktopologie setzt in ihrer einfachsten Form die Verwendung einer Reihe von ToFoIn-Skripten voraus.  Nat√ºrlich sollten die Skripte bei einem einzelnen Router funktionieren, aber in diesem Fall m√ºssen Sie das Daemon-Modul stark √§ndern, um die Abh√§ngigkeit der Reihenfolge der Aktionen vom CARP-Status zu beseitigen, die im System einfach nicht vorhanden sind.  Eine weitere Reservierung dieser und anderer Knoten h√§ngt nur vom Grad der Wichtigkeit der entsprechenden Dienste ab. <br><br><h3>  Ziele und Vorgaben </h3><br>  Ziel des Projekts ist es nach wie vor, ein universelles und leicht skalierbares Softwarepaket zu erstellen, das sich darauf konzentriert, Probleme bei externen und internen Verbindungen zu identifizieren und automatisch auf funktionsf√§hige Verbindungen umzuschalten.  Im Allgemeinen lautet die Logik wie folgt: <br><br><ul><li>  Es gibt n "Router" mit jeweils m externen Kan√§len.  Dar√ºber hinaus befinden sich alle n ‚ÄûRouter‚Äú in einer strengen Hierarchie und sind √ºber CARP an allen erforderlichen Schnittstellen miteinander verbunden. </li><li>  Ein Agent arbeitet unabh√§ngig auf jedem Computer, dessen Aufgabe auf dem aktuellen CARP-Status seines Computers basiert: <br><ul><li>  Bei Sicherung - Erkennen und konfigurieren Sie den Computer auf einem Router, der derzeit der Master ist. </li><li>  Wenn Master - √úberpr√ºfen Sie den Status der Verbindungen zum aktuellen Zeitpunkt und wechseln Sie gegebenenfalls zwischen externen Kan√§len. </li></ul></li></ul><br><h3>  L√∂sung </h3><br>  Das interne Netzwerk verf√ºgt √ºber CARP, das Backup-Gateways bereitstellt und es Ihnen erm√∂glicht, die Einstellungen anderer Netzwerkger√§te im internen Netzwerk beim Kanalwechsel nicht zu √§ndern. <br><br>  Dhcpd arbeitet im prim√§ren - sekund√§ren Modus und im Allgemeinen spielt es keine Rolle, welche anderen Rollen sein Computer spielt - die Verbindung zwischen dhcpd erfolgt im internen Netzwerk, das Router immer betrachten. <br><br>  Die Masterbindung wird in AD entfernt, das im lokalen Netzwerk verborgen ist, w√§hrend sekund√§re Bindungsserver auf den Gateway-Routern gleichberechtigt arbeiten. <br><br>  Die ipfw-Regeln unterscheiden sich je nachdem, welcher Kanal zu einem bestimmten Zeitpunkt als Hauptkanal betrachtet wird, und werden vom Daemon-Modul beim Rollenwechsel neu gestartet. <br><br>  Zum Schluss noch zu den Skripten.  Jetzt befinden sich die Dateien in den entsprechenden Verzeichnissen, arbeiten von ihrem Benutzer aus und haben ein Startskript in rc.d.  Aufgaben, die Root-Zugriff erfordern, werden von sudo gel√∂st.  Es gibt ein Installationsskript, das das m√∂gliche Vorhandensein einer installierten Version ber√ºcksichtigt, sowie eine ziemlich detaillierte Einstellungsdatei.  Die Module sind mit geringf√ºgigen √Ñnderungen identisch, einige haben sich in der Funktionalit√§t fast nicht ge√§ndert: <br><br>  <b>Daemon ist</b> - wie der Name schon sagt - der Hauptprozess, der die Test- und Switch-Module auf einem Timer ausf√ºhrt und auch CARP √ºberwacht. <br>  <b>Tester</b> - testet weiterhin auf externe Kommunikation mit dem Befehl ping.  (Wenn es ausgef√ºhrt wird, wird davon ausgegangen, dass sich auf der Maschine CARP im Master-Status befindet.) <br>  <b>Beurteilung</b> - Bestimmt anhand der Testergebnisse, welcher externe Kanal funktioniert und ob eine Umschaltung erforderlich ist, f√ºhrt eine Umschaltung durch (wenn sie ausgef√ºhrt wird, wird davon ausgegangen, dass die Maschine CARP im Master-Status hat). <br>  <b>Scout</b> ist ein neues Modul.  Es beginnt, wenn sich CARP im Sicherungsstatus befindet.  Es muss ermittelt werden, welcher der verbleibenden Router derzeit der Hauptrouter ist. <br>  <b>Logger</b> - verantwortlich f√ºr die Ereignisprotokollierung.  Es ist notwendig, dass Informationen √ºber Ereignisse nicht dupliziert werden und das Magazin leichter zu lesen ist. <br>  <b>Watchdog</b> - l√§uft planm√§√üig von crontab aus.  Es ermittelt das ‚ÄûEinfrieren‚Äú aller Module und versucht (wann immer m√∂glich), die aufgetretenen Probleme zu l√∂sen.  Das hei√üt,  Nagel alle, einfach ausgedr√ºckt. <br><br>  Zus√§tzlich zu den Skripten selbst sollten einige wichtigere Dateien ber√ºcksichtigt werden: <br><br>  <b>Tofoin.conf</b> - eine einzelne Einstellungsdatei. <br>  <b>Tofoin.log</b> - eine einzelne Ereignisprotokolldatei. <br>  <b>Ergebnis_</b> &lt;interne Kanalnummer&gt; ist die Arbeitsdatei. Die Testergebnisse werden hier hinzugef√ºgt und in / tmp neben .pid und anderen Arbeitsdateien erstellt. <br><br>  Gerne beantworte ich die Fragen zum Betrieb der Module und erkl√§re die L√∂sungen in den Kommentaren. <br><br><h3>  Technischer Teil </h3><br><h4>  Ausr√ºstung </h4><br>  Im Vergleich zur vorherigen Zeit wurden die Gateways auf P4 verschoben, erhielten 1536 MB RAM und drei 40-GB-Festplatten (Spiegel + Ersatz).  Netzwerkkarten sind immer noch PCI, Netzteile sind normal, nat√ºrlich in Gegenwart einer USV. <br>  Die Erh√∂hung der Kapazit√§t ist mit dem freigesetzten Eisen und der √ºberm√§√üig m√ºhsamen Aktualisierung von der Quelle verbunden, meistens jedoch mit der ersten.  OS FreeBSD 11.1, FS zfs. <br><br><h4>  Systemkomponenteneinstellungen </h4><br><div class="spoiler">  <b class="spoiler_title">Weitere Details</b> <div class="spoiler_text">  Der Kernel wird mit solchen zus√§tzlichen Parametern kompiliert (etwas kann auch im Loader eingestellt werden, aber es ist besser so): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Einstellungen /boot/loader.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  Einstellungen /etc/rc.conf auf dem ersten Computer (CARP-Konfiguration ist von prim√§rem Interesse) <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>Legende:</i> <i><br></i>  <i>eth0, eth1, eth2 - physikalische Adapter</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - virtuelle LAN-Adapter,</i> <i><br></i>  <i>vlan222 und vlan555 - Adapter f√ºr redundante Kommunikation zwischen externen Netzwerkkarten (sie werden m√∂glicherweise nicht mehr ben√∂tigt, sie wurden fr√ºher aktiv verwendet)</i> <i><br></i>  <i>vlan111 - der externe Hauptkanal</i> <i><br></i>  <i>vlan444 - externen Kanal sichern</i> <i><br></i>  <i>vlan333 - Telefonie</i> <br>  Einstellungen /etc/rc.conf auf dem zweiten Computer (CARP-Konfiguration ist von Hauptinteresse, einige der doppelten Zeilen werden entfernt): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Einige Regeln, die bei der Konfiguration von ipfw (nat) n√ºtzlich sind, sind: <br>  So erlauben Sie CARP-Verkehr: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  "Nuclear" nat: <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  Verwenden bestimmter Routing-Tabellen mit bestimmten Adaptern: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  Im Allgemeinen k√∂nnte ich einen separaten Artikel √ºber die von mir verwendeten ipfw-Einstellungen schreiben, aber dies ist ein anderes Mal. <br></div></div><br><h4>  Software von Drittanbietern </h4><br><div class="spoiler">  <b class="spoiler_title">Weitere Details</b> <div class="spoiler_text">  Da gleichzeitig mit zwei oder mehr externen Kan√§len gearbeitet werden muss, ist es zweckm√§√üig, mehrere Routing-Tabellen zu haben, eine f√ºr jeden Kanal.  Und es w√§re sch√∂n, wenn diese Tabellen beim Start selbst erstellt w√ºrden.  Das rc.d setfib-Skript hilft dabei.  Die in ToFoIn verwendete Logik setzt voraus, dass der Dateiname (setfib1, setfib2 usw.) mit der Nummer der Tabelle √ºbereinstimmt, in die ein einzelnes Skript eine Standardroute hinzuf√ºgt.  Die Tabelle hat standardm√§√üig die Nummer "0". <br>  DNS-Server mit Bind in der Hauptrolle arbeiten im sekund√§ren Modus, der wichtigste ist samba4 + bind, versteckt im lokalen Netzwerk.  Das Einrichten der sekund√§ren Bindung wird in Cricket Lee und Paul Albitz '"DNS and BIND" -Buch auf wunderbare Weise offenbart.  Ich kann mich an keine besonderen Anforderungen erinnern, die die Verwendung von samba4 f√ºr sekund√§re Server ber√ºcksichtigen, und ich erw√§hne sie nicht in der Einstellungsdatei.  Es sei denn, Sie m√ºssen f√ºr verschiedene Internetkan√§le m√∂glicherweise zwei verschiedene Dateien erstellen, die dann vom ToFoIn-Skript an die Stelle kopiert werden, von der die Bindung selbst sie liest.  Dies liegt an der Tatsache, dass bei der Angabe der Adressen der DNS-Server beider Anbieter in derselben Datei unter Ber√ºcksichtigung der Bindung mit nur einer Routing-Tabelle ein Problem hinsichtlich der Aufl√∂sung von Adressen von Upstream-Servern auftritt, auf die zu einem bestimmten Zeitpunkt nicht zugegriffen werden kann. <br>  Failover isc-dhcpd.  Dhcpd ist f√ºr ToFoIn nicht unbedingt erforderlich. Dar√ºber hinaus wirkt sich das Fehlen √ºberhaupt nicht auf Skripte aus. Wie es mir jedoch erscheint, ist es durchaus logisch, DHCP-Server auf Gateways zu platzieren, und dann stellt sich immer noch die Frage nach dem Failover.  Und hier wurde es im Vergleich zum letzten Mal interessanter ... Zus√§tzlich zu den Einstellungen, die f√ºr das Failover erforderlich sind, das ich beim <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">letzten Mal</a> beschrieben <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">habe</a> (der Anfang des Abschnitts "Voreinstellung" im Dropdown-Men√º). <br>  Sie ben√∂tigen au√üerdem ein Skript, um DNS-Datens√§tze in AD mithilfe von samba4 sicher zu aktualisieren.  Der Samba4-Server selbst sollte nur installiert werden.  Das Einrichten und Starten ist nicht erforderlich. Wir interessieren uns nur f√ºr die mit dem Kit gelieferten Verwaltungstools.  Weitere Informationen finden Sie im Abschnitt "DHCP mit dynamischen DNS-Updates" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unter</a> . <br>  Es sieht be√§ngstigend aus, aber es funktioniert. <br>  Damit ist die Konfiguration der Software von Drittanbietern abgeschlossen. <br></div></div><br><h4>  Ein bisschen √ºber ToFoIn </h4><br>  Der gesamte Projekttext zusammen mit dem Installationsskript ist auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gitlab</a> verf√ºgbar. <br><br><div class="spoiler">  <b class="spoiler_title">Abschlie√üend wird ein Beispiel f√ºr die Parameter der ToFoIn-Einstellungsdatei betrachtet:</b> <div class="spoiler_text">  Die Anzahl der im System verwendeten Router: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  Wenn Sie zus√§tzliche Subnetze verwenden, m√ºssen Sie eine Standardroute festlegen, wenn der Router zur prim√§ren Route wird.  Hier k√∂nnen Sie die Nummer der entsprechenden setfib-Datei angeben, die neu gestartet werden soll.  In diesem Beispiel setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Interner Adaptername: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  Alle anderen Schnittstellen, an denen Router √ºber CARP verbunden sind.  Erforderlich, um den gleichen Status aller Schnittstellen zu steuern und aufrechtzuerhalten: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  vhid, das bei der Konfiguration von CARP verwendet wurde: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  IP-Adressen im internen Netzwerk anderer Router werden bei Bedarf in der Reihenfolge ihrer Wichtigkeit einfach als ASERV_IP_2, ASERV_IP_3 usw. verwendet. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  Anzahl der externen Verbindungskan√§le: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Einstellungen f√ºr den externen Hauptverbindungskanal: <br>  Adaptername: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  Nummer der Routing-Tabelle: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Standard-Gateway: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Einstellungen f√ºr den externen Backup-Verbindungskanal: <br>  Adaptername: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  Nummer der Routing-Tabelle: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  Ein Standard-Gateway ist nicht erforderlich, da f√ºr alle Routing-Tabellen au√üer der Haupttabelle das rc.d-Skript setfib &lt;Tabellennummer&gt; verwendet wird, das, wie die Logik annimmt, mit der Tabellennummer √ºbereinstimmen muss. <br>  Parameter des Testmoduls: <br>  Die Anzahl der zu √ºberpr√ºfenden Adressen: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Adressen der Maschinen, von denen Ping-Anfragen gesendet werden.  Verwenden Sie am besten im ersten Fall den Domainnamen und erst danach die IP-Adresse: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  Die Anzahl der pro Ziel gesendeten Ping-Pakete: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Einstellungen des Richtermoduls <br>  Die Anzahl der erfolgreichen Tests des Hauptkanals vor der R√ºckkehr.  Die R√ºckkehrzeit zum Hauptkanal nach Wiederaufnahme seines Betriebs wird ungef√§hr durch die Formel berechnet: (WNUMBER + 1) * JUDGEPERIOD Sekunden. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Einstellungen des Logger-Moduls <br>  Diese beiden Parameter geben an, wie oft der Logger wiederkehrende Ereignisse aufzeichnet.  Nach der Aufzeichnung des Ereignisses ist LOGFREQ2 die Anzahl der Wiederholungsversuche, wenn das n√§chste Mal die Anzahl der Wiederholungen von LOGFREQ1 gemeldet wird.  Es werden nur Ereignisse in einer Reihe ber√ºcksichtigt. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Modulstart-Timer in Sekunden <br>  Die Startphase des Tester-Moduls.  Es ist sinnvoll, sich auf die Zeit fehlgeschlagener Versuche zu verlassen, um alle Ziele zu testen. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  Die Startphase des Judge-Moduls.  Installieren Sie nicht weniger als TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  Die Startphase des Scout-Moduls. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  Die Wartezeit vor dem √úberpr√ºfen der Startzeitgeber der Tester- und Judge-Module.  Es ist logisch, den Wert von TESTERPERIOD kleiner oder gleich zu setzen. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  Die Zeit, nach der ein Arbeitsmodul als aufgeh√§ngt gilt.  Wird vom Watchdog-Modul verwendet. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Pfade zu Dateien und Verzeichnissen <br>  Pfad zum ipfw-Skript. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Ipfw Einstellungen.  Wenn die ipfw-Einstellungen nicht in eine separate Datei verschoben werden, ist FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Pfad zu den ipfw-Einstellungen f√ºr den externen Hauptkanal: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  √úber den Pfad zu den ipfw-Einstellungen f√ºr den externen Sicherungskanal k√∂nnen Sie bei Bedarf weiter FIRESET_2 usw.: <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Pfade zum Binden von Einstellungen <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Bindungseinstellungen f√ºr den externen Hauptkanal: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Bindungseinstellungen f√ºr den externen Sicherungskanal; <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Pfade zu allen ausf√ºhrbaren ToFoIn-Dateien: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  Ereignisprotokoll.  Diese Datei wird bei der Installation NICHT erstellt: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  Tempor√§re Dateien und Verzeichnisse werden beim Starten der entsprechenden Module erstellt, einige werden beim Stoppen gel√∂scht: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  Zusammenfassung </h3><br>  Es stellte sich heraus, dass es sich um einen voll funktionsf√§higen und zuverl√§ssigen Satz von Skripten handelt, der die Aufgabe des Wechsels zum Arbeitskanal bei 2 Routern mit 2 externen Kommunikationskan√§len gut bew√§ltigt. <br><br><h3>  Pl√§ne </h3><br>  Meine Pl√§ne f√ºr dieses Projekt beziehen sich vielleicht darauf, von Bash auf Pure Sh umzuschreiben, um unn√∂tige Software auf dem Server loszuwerden.  Auf der anderen Seite funktioniert jetzt alles erstaunlich und ich habe wirklich keine Lust, mich in diesen Prozess einzumischen. Au√üerdem ist der Wechsel zu sh mit schrecklicheren Sprachkonstrukten behaftet, die notwendig sind, um das gleiche Ergebnis zu erzielen. <br>  Im √úbrigen lohnt es sich wahrscheinlich, die beste Implementierung von Testmodulen in Betracht zu ziehen. <br><br><h3>  Referenzen: </h3><br>  ‚Üê <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vorheriger Artikel</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ToFoIn-Projektseite auf gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">Der Rest</b> <div class="spoiler_text">  DNS BIND 9: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lee K., Albitz P. - DNS und BIND (5. Auflage)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DNS-Server BIND</a> <br>  DHCP: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Failover dhcp</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DHCP mit dynamischen DNS-Updates</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mehrere Standardrouten in FreeBSD ohne BGP oder √§hnliches</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">setfib und Umschalten zwischen Routing-Tabellen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FreeBSD zwei Anbieter.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">setfib</a> <br>  IPFW + NAT: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Detailliertes ipfw nat Handbuch</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Detailliertes ipfw nat Handbuch</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dummynet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kernel NAT</a> <br>  BASH: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Grundlagen von BASH.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2.</a> <br>  <a href="">Erweitertes Bash-Scripting-Handbuch</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de421857/">https://habr.com/ru/post/de421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de421845/index.html">Was machen Datenanalysten eigentlich? Ergebnisse aus 35 Interviews</a></li>
<li><a href="../de421847/index.html">Springe in die Wolke. Erstellen einer kosteng√ºnstigen IoT-L√∂sung auf NodeMCU + Azure IoT Hub</a></li>
<li><a href="../de421849/index.html">Veranstaltungen f√ºr HR in der IT im September 2018: My Circle Digest</a></li>
<li><a href="../de421851/index.html">Probleme mit Eulen und Globus: Verbinden von zwei Assemblys mit identischen Namespaces und Klassennamen</a></li>
<li><a href="../de421855/index.html">Heimprojektoren: die besten "je nach Version", ultrakurzer Fokus, Meister in Helligkeit und Geschwindigkeit</a></li>
<li><a href="../de421859/index.html">Hinweise des IoT-Anbieters. Ger√§te und √ºberbieten</a></li>
<li><a href="../de421863/index.html">Ein neuer Weg, Nanor√∂hren herzustellen: jetzt in Farbe</a></li>
<li><a href="../de421867/index.html">So machen Sie Code lesbar</a></li>
<li><a href="../de421869/index.html">Erstellen Sie mit dem Firebase ML Kit eine Android-Anwendung zur Gesichtserkennung in Echtzeit</a></li>
<li><a href="../de421871/index.html">So scheitern Sie kl√§glich von der Java- zur Kotlin-Migration in einer Android-Anwendung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>