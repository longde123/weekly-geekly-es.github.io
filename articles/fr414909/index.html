<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèΩ üèùÔ∏è ‚òîÔ∏è Historique d'une seule n√©gociation SSL üßúüèª üå∂Ô∏è üè®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 

 R√©cemment, j'ai d√ª visser SSL avec authentification mutuelle au Spring Reactive Webclient. Il semblerait que ce soit simple, mais ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Historique d'une seule n√©gociation SSL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414909/">  Bonjour, Habr! <br><br>  R√©cemment, j'ai d√ª visser SSL avec authentification mutuelle au Spring Reactive Webclient.  Il semblerait que ce soit simple, mais cela a entra√Æn√© une errance dans les sources du JDK avec une fin inattendue.  L'exp√©rience a √©t√© acquise pour un article entier, qui peut √™tre utile aux ing√©nieurs dans les t√¢ches quotidiennes ou dans la pr√©paration d'un entretien. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u7/k3/q8/u7k3q85jrbyr8hazrcevylms3ai.jpeg"></div><a name="habracut"></a><br><h2>  √ânonc√© du probl√®me </h2><br>  <i>Il existe un service REST c√¥t√© client qui fonctionne via HTTPS.</i> <i><br></i>  <i>Vous devez y acc√©der √† partir d'une application Java cliente.</i> <br><br>  La premi√®re chose qui m'a √©t√© donn√©e dans cette qu√™te √©tait 2 fichiers avec l'extension .pem - un certificat client et une cl√© priv√©e.  J'ai v√©rifi√© leurs performances √† l'aide de Postman: je leur ai sp√©cifi√© les chemins d'acc√®s dans les param√®tres et, apr√®s avoir extrait une demande, j'ai v√©rifi√© que le serveur r√©pond avec 200 OK et un corps de r√©ponse significatif.  S√©par√©ment, j'ai v√©rifi√© que sans certificat client, le serveur renvoie un √©tat HTTP de 500 et un court message dans le corps de la r√©ponse qu'une "exception de s√©curit√©" s'est produite avec un code sp√©cifique. <br><br>  Ensuite, vous devez configurer correctement l'application Java cliente. <br><br>  Pour les demandes REST, j'ai utilis√© Spring Reactive WebClient avec des E / S non bloquantes. <br>  La documentation contient <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple de la</a> fa√ßon dont il peut √™tre personnalis√© en lui lan√ßant un objet SslContext, qui stocke uniquement les certificats et les cl√©s priv√©es. <br><br>  Ma configuration dans une version simplifi√©e √©tait presque du copier-coller de la documentation: <br><br><pre><code class="java hljs">SslContext sslContext = SslContextBuilder .forClient() .keyManager(‚Ä¶) <span class="hljs-comment"><span class="hljs-comment">/*  ,   .pem      (, , ). PEM      . /    openssl .     KeyManagerFactory. */</span></span> .build(); ClientHttpConnector connector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactorClientHttpConnector( builder -&gt; builder.sslContext(sslContext)); WebClient webClient = WebClient.builder() .clientConnector(connector).build();</code> </pre> <br>  En suivant le principe de TDD, j'ai √©galement √©crit un test qui utilise WebTestClient au lieu de WebClient, qui affiche un tas d'informations de d√©bogage.  La toute premi√®re affirmation √©tait la suivante: <br><br><pre> <code class="java hljs">webTestClient .post() .uri([  ]) .body(BodyInserters.fromObject([ ,   ,  ])) .exchange() .expectStatus().isOk()</code> </pre> <br>  Ce test simple n'a pas r√©ussi imm√©diatement: le serveur en a renvoy√© 500 avec le m√™me corps que si Postman n'avait pas sp√©cifi√© de certificat client. <br><br>  S√©par√©ment, je note que lors du d√©bogage, j'ai activ√© l'option "ne pas v√©rifier le certificat du serveur", √† savoir, j'ai transmis l'instance InsecureTrustManagerFactory en tant que TrustManager pour SslContext.  Cette mesure √©tait redondante, mais excluait √† coup s√ªr la moiti√© des options. <br><br>  Les informations de d√©bogage dans le test n'ont pas mis en lumi√®re le probl√®me, mais il semblait que quelque chose n'allait pas au stade de la n√©gociation SSL, j'ai donc d√©cid√© de comparer plus en d√©tail la fa√ßon dont la connexion se produit dans les deux cas: pour Postman et pour le client Java.  Tout cela peut √™tre vu en utilisant Wireshark - c'est un analyseur de trafic r√©seau tr√®s populaire.  En m√™me temps, j'ai vu comment la prise de contact SSL se produit avec l'authentification bidirectionnelle, pour ainsi dire, en direct (ils aiment le demander lors des entretiens): <br><br><ul><li>  Tout d'abord, le client envoie un message <i>Client Hello</i> contenant des m√©ta-informations comme la version du protocole et la liste des algorithmes de cryptage qu'il prend en charge </li><li>  En r√©ponse, le serveur envoie imm√©diatement un paquet des messages suivants: <i>Server Hello, Certificat, Server Key Exchange, Certificate Request, Server Hello Done</i> . <br>  <i>Server Hello</i> indique l'algorithme de chiffrement s√©lectionn√© par le serveur (suite de chiffrement).  √Ä l'int√©rieur du certificat se trouve le certificat du serveur.  <i>L'√©change de cl√©s de serveur</i> contient certaines informations n√©cessaires au chiffrement, selon l'algorithme choisi (nous ne sommes pas int√©ress√©s par les d√©tails maintenant, nous supposons donc que ce n'est qu'une cl√© publique, bien que ce soit incorrect!).  De plus, dans le cas d'une authentification bidirectionnelle, dans le message <i>Demande de certificat</i> , le serveur fait une demande de certificat client et explique les formats qu'il prend en charge et les √©metteurs auxquels il fait confiance. </li><li>  Apr√®s avoir re√ßu ces informations, le client v√©rifie le certificat du serveur et envoie son certificat, sa ¬´cl√© publique¬ª et d'autres informations dans les messages suivants: <i>certificat, √©change de cl√©s client, v√©rification de certificat</i> .  Le dernier est le message <i>ChangeCipherSpec</i> , indiquant que toute communication ult√©rieure se fera sous forme crypt√©e </li><li>  Enfin, apr√®s tous ces brassages, le serveur v√©rifiera le certificat du client et, si tout va bien, il donnera une r√©ponse. </li></ul><br>  Apr√®s quinze minutes de blocage dans le trafic, j'ai remarqu√© que le client Java, en r√©ponse √† la <i>demande</i> de <i>certificat</i> du serveur, pour une raison quelconque n'envoie pas son certificat, contrairement au client Postman.  Autrement dit, il y a un message de certificat, mais il est vide. <br><br>  Ensuite, j'aurais besoin de regarder d'abord <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la sp√©cification du protocole TLS</a> , qui dit litt√©ralement ce qui suit: <br><blockquote>  Si la liste certificate_authorities du message de demande de certificat n'√©tait pas vide, l'un des certificats de la cha√Æne de certificats DEVRAIT √™tre √©mis par l'une des autorit√©s de certification r√©pertori√©es. </blockquote>  Nous parlons de la liste certificate_authorities sp√©cifi√©e dans le message de <i>demande de certificat</i> provenant du serveur.  Un certificat client (au moins une des cha√Ænes) doit √™tre sign√© par l'un des √©metteurs r√©pertori√©s dans cette liste.  Nous appelons cela le <b>ch√®que X.</b> <br><br>  Je ne connaissais pas cette condition et l'ai trouv√©e lorsque j'ai atteint les profondeurs du JDK dans le d√©bogage (je l'ai JDK9).  Netty's HttpClient, qui sous-tend Spring WebClient, utilise SslEngine du JDK par d√©faut.  Alternativement, vous pouvez le basculer vers le fournisseur OpenSSL en ajoutant les d√©pendances n√©cessaires, mais je n'ai finalement pas eu besoin de cela. <br>  J'ai donc d√©fini des points d'arr√™t dans la classe sun.security.ssl.ClientHandshaker et dans le gestionnaire du message serverHelloDone, j'ai trouv√© une v√©rification X qui n'a pas r√©ussi: aucun des √©metteurs de la cha√Æne de certificats client ne figurait dans la liste des √©metteurs auxquels le serveur fait confiance ( du message de <i>demande</i> de <i>certificat</i> du serveur). <br><br>  Je me suis tourn√© vers le client pour un nouveau certificat, mais le client a object√© que tout fonctionnait bien pour lui, et a remis √† Python un script, avec lequel il v√©rifiait g√©n√©ralement les certificats pour la fonctionnalit√©.  Le script n'a rien fait de plus que d'envoyer une demande HTTPS √† l'aide de la biblioth√®que Requ√™tes et a renvoy√© 200 OK.  J'ai finalement √©t√© surpris lorsque la bonne vieille boucle a √©galement retourn√© 200 OK.  Je me suis tout de suite souvenue de la blague: "Toute la soci√©t√© est en d√©calage, un lieutenant fait un pas dans la jambe." <br><br>  Curl est, bien s√ªr, un utilitaire r√©put√©, mais la norme TLS n'est pas non plus un morceau de papier toilette.  Ne sachant pas quoi v√©rifier, j'ai grimp√© sans but autour de la documentation de curl, et sur Github, o√π j'ai trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> bug aussi c√©l√®bre. <br><br>  Le journaliste a d√©crit exactement le test X: en curl avec le backend par d√©faut (OpenSSL), il ne s'ex√©cutait pas, contrairement √† curl avec le backend GnuTLS.  Je n'√©tais pas trop paresseux, j'ai r√©cup√©r√© les boucles de la source avec l'option <i>--with-gnutls</i> et envoy√© une longue demande.  Et, enfin, un autre client, en plus du JDK, a renvoy√© le statut HTTP 500 avec ¬´l'exception de s√©curit√©¬ª! <br><br>  J'ai √©crit √† ce sujet au client en r√©ponse √† l'argument ¬´Eh bien, curl fonctionne¬ª et j'ai re√ßu un nouveau certificat, r√©g√©n√©r√© et soigneusement install√© sur le serveur.  Avec cela, ma configuration pour WebClient a tr√®s bien fonctionn√©.  Fin heureuse. <br><br>  L'√©pop√©e SSL a pris plus de deux semaines avec toute la correspondance (elle comprenait l'√©tude de journaux Java d√©taill√©s, le choix du code d'un autre projet qui fonctionne pour le client, et juste le nez). <br><br>  Ce qui m'a d√©rout√© pendant longtemps, en plus de la diff√©rence de comportement du client, c'est que le serveur a √©t√© configur√© de telle mani√®re que le certificat a demand√©, mais n'a pas v√©rifi√©.  Cependant, il y a des explications √† cela dans la sp√©cification: <br><blockquote>  De plus, si un aspect de la cha√Æne de certificats √©tait inacceptable (par exemple, il n'a pas √©t√© sign√© par une autorit√© de certification connue et fiable), le serveur PEUT, √† sa discr√©tion, poursuivre la prise de contact (en consid√©rant le client non authentifi√©) ou envoyer une alerte fatale. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414909/">https://habr.com/ru/post/fr414909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414897/index.html">Acc√®s aux donn√©es dans les applications multi-utilisateurs</a></li>
<li><a href="../fr414899/index.html">Comment collecter des analyses et ne pas tuer la productivit√©</a></li>
<li><a href="../fr414901/index.html">Dell et DROVA: comment jouer √† des jeux exigeants m√™me sur un ordinateur portable faible</a></li>
<li><a href="../fr414905/index.html">Composants Web Partie 3: Mod√®les HTML et importations</a></li>
<li><a href="../fr414907/index.html">Qu'est-ce qui relie la th√©orie des nombres √† la trajectoire de la lumi√®re?</a></li>
<li><a href="../fr414911/index.html">Aide √† la salle</a></li>
<li><a href="../fr414913/index.html">Le hackathon comme rem√®de √† l'ennui cr√©atif</a></li>
<li><a href="../fr414915/index.html">Une vuln√©rabilit√© dans ICQ a permis de rejoindre absolument n'importe quel chat</a></li>
<li><a href="../fr414917/index.html">Pr√©sentation de Microsoft Arc Mouse</a></li>
<li><a href="../fr414919/index.html">Comment faire la paix avec l'insomnie, ou pourquoi Tolsto√Ø a-t-il gard√© ses pieds pour la nuit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>