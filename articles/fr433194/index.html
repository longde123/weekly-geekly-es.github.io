<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêµ ü§∞üèΩ üëãüèø Veilleuse programm√©e ‚ÜôÔ∏è ü•á üéá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avec la naissance d'un enfant, la question s'est pos√©e d'une lampe de nuit. Quelque part, ils ont lu que c'√©tait n√©cessaire pour un sommeil tranquille...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Veilleuse programm√©e</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433194/"><img src="https://habrastorage.org/webt/nf/ev/13/nfev13d1ijvairxa-ebeg7ng7am.jpeg" alt="image"><br><br>  Avec la naissance d'un enfant, la question s'est pos√©e d'une lampe de nuit.  Quelque part, ils ont lu que c'√©tait n√©cessaire pour un sommeil tranquille.  Rapidement utilis√© pour dormir avec une faible lumi√®re.  Il est tr√®s pratique de se r√©veiller des cris et des hurlements au milieu de la nuit et de voir de quoi le b√©b√© se plaint (si vous pouvez comprendre).  De plus, dans une faible lumi√®re, vous pouvez vous balancer, vous retourner et continuer √† dormir. <br><br>  Initialement, un √©chantillon d'essai de la lampe a √©t√© fabriqu√© √† partir d'un morceau de bande LED jaune (12 volts), qui a √©t√© utilis√© pendant 1,5 an. <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/an/hw/kd/anhwkdovnnwhdziqqhhbcxr0hbc.jpeg" alt="image"><br><br>  En plus de la conception fragile, il a commenc√© √† ennuyer chaque matin pour retirer le bloc d'alimentation de la lampe de la prise.  Je me l√®ve le matin, assez de lumi√®re p√©n√®tre dans la pi√®ce depuis la rue.  Ainsi, la lampe est gaspill√©e plusieurs heures par jour.  Encore une fois, en six mois, le contr√¥leur de bande RVB chinois a oubli√© le r√©glage actuel et il a fallu chercher un panneau de contr√¥le pour lui rappeler comment travailler.  J'ai d√©cid√© de faire une nouvelle lampe avec arr√™t automatique, avec r√©glage des couleurs en utilisant √† la fois des potentiom√®tres et une radio. <br><br>  Assembl√© rapidement un prototype bas√© sur Arduino nano.  D√©boguez les fonctionnalit√©s de base. <br><br><img src="https://habrastorage.org/webt/fb/jy/xu/fbjyxu7k6vr2uk2wa66e2oc58yy.jpeg" alt="image"><br><br>  J'en ai profit√© pour essayer Fritzing.  Je n'aimais pas √ßa, mais les images sont claires et "dr√¥les".  Apparemment, rien de nouveau n'a √©t√© invent√©. <br><br><img src="https://habrastorage.org/webt/el/8v/pr/el8vprz7g0kiuxlvu61ac184t7a.jpeg" alt="image"><br><br>  ¬´Nano¬ª a √©t√© remplac√© par un module compatible arduino peu connu avec un √©metteur-r√©cepteur radio int√©gr√© (contr√¥leur 8 bits, performances et rembourrage comparables √† ¬´Nana¬ª).  Chez moi, j'ai d√©j√† un appareil fonctionnant √† une fr√©quence de 868 MHz, ce sera le second.  Sp√©cifications br√®ves du site Web du fabricant: <br><br><div class="spoiler">  <b class="spoiler_title">Br√®ve caract√©ristiques</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jq/6n/c-/jq6nc-tmx6s5s1xlln6t9bm1m8u.png" alt="image"><br></div></div><br><br><img src="https://habrastorage.org/webt/gu/1d/rl/gu1drlc_2banpoqihqjrlsiawms.jpeg" alt="image"><br><br>  Je ne vois pas de gros probl√®mes √† faire de m√™me sur ESP8266 (il existe un collecteur de micrologiciel en ligne pratique pour les scripts sur LUA).  Un peu plus compliqu√© sur Bluetooth (pour flasher le module HM-10 il faut un programmeur peu co√ªteux, un environnement de d√©veloppement et une compr√©hension du protocole).  Bien que vous puissiez utiliser le module Bluetooth avec l'arduino.  Mais j'ai utilis√© ZUNo, car il ment et m'attend depuis longtemps, et toute l'infrastructure est pr√™te √† connecter et g√©rer des appareils similaires en un seul r√©seau (je parle du contr√¥leur de r√©seau domestique intelligent). <br>  Pour toutes les jambes utilis√©es sur Arduino, des analogues ont √©t√© trouv√©s dans le module. <br><br><img src="https://habrastorage.org/webt/yl/e1/nw/yle1nwmi36wleu53yyx6lunkr0y.png" alt="image"><br><br>  Pour travailler avec le module de l'IDE Arduino, vous devez le configurer (la description des param√®tres se trouve sur le site Web du fabricant).  Aucun miracle ne s'est produit.  En essayant de compiler, j'ai eu l'erreur "ne supporte pas" pour "l'instruction avec des colonnes vides ou sans corps!"  J'ai utilis√© la biblioth√®que Adafruit_NeoPixel.  Je suis mont√© dedans, j'ai vu combien de cycles il y avait et je l'ai ferm√©.  Je devais revenir sur le site Web du fabricant et chercher des exemples de travail avec des LED (un exemple a √©t√© rapidement trouv√©).  Je ne suis donc pas le premier √† rencontrer un probl√®me similaire. <br><br>  Pour que cette lampe soit contr√¥l√©e par radio dans le code Arduino, vous devez ajouter une macro et impl√©menter plusieurs fonctions: <br><br><pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS( ZUNO_SWITCH_MULTILEVEL(getRed, setRed), ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen), ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue), ZUNO_SWITCH_BINARY(switch_getter, switch_setter) );</code> </pre> <br>  Cette macro d√©crit un appareil Z-Wave avec trois commutateurs √† plusieurs niveaux (contr√¥le RVB) et un commutateur simple (marche / arr√™t simple). <br><br>  J'ai la mise en ≈ìuvre la plus simple des fonctions (comme dans les exemples sur le site Web du fabricant).  Vous pouvez le voir dans la liste ci-jointe. <br><br><h3>  <b>S√©lection de cas</b> </h3><br>  J'avais d√©j√† un cas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Scell√© avec un couvercle transparent</a> .  Sous le couvercle, vous pouvez installer 25 LED.  Les tests ont r√©ussi.  La lampe a une grande marge de luminosit√© pour ma chambre.  Le couvercle de cet √©tui est transparent, j'ai donc d√©cid√© de diffuser un peu la lumi√®re. <br><br><img src="https://habrastorage.org/webt/eb/dn/a2/ebdna25kb2xg3dedtuhpib2k8qe.jpeg" alt="image"><br><br>  Croquis de perles color√©es et de cubes en acrylique, remplis d'√©poxy transparent.  La peinture des perles color√©es s'est dissoute sous l'influence de la r√©sine. <br><br><img src="https://habrastorage.org/webt/kq/gh/dn/kqghdnnc4qp4dcxa058oun_zwb4.jpeg" alt="image"><br><br>  La chose la plus int√©ressante est que le capuchon du bo√Ætier √©tanche a fui et presque toute la r√©sine a fui.  Je ne sais pas o√π j'ai r√©ussi √† toucher le couvercle, mais apr√®s s√©chage, la fissure est clairement visible. <br><br><img src="https://habrastorage.org/webt/1h/aa/aq/1haaaqrcyeoacbznogmwonzgb8g.jpeg" alt="image"><br><br>  La carte de circuit imprim√© a √©t√© r√©alis√©e par la m√©thode photor√©sistive. <br><br><img src="https://habrastorage.org/webt/me/3w/th/me3wthtnt9ybhvyzc3v_-nhvy0o.jpeg" alt="image"><br><br><img src="https://habrastorage.org/webt/oa/kh/vl/oakhvltkcldrtlncqd8kwkub_ms.jpeg" alt="image"><br><br>  Apr√®s d√©capage et usinage <br><br><img src="https://habrastorage.org/webt/yh/oy/zy/yhoyzyalmtvzihrg_adlie0l0k0.jpeg" alt="image"><br><br>  Le module avec le microcontr√¥leur a √©t√© remplac√© par son prototype, qui se trouvait dans le placard (car ce n'est pas dommage, mais ZUNo doit √™tre prot√©g√©).  La premi√®re version de ZUNo, mais les dimensions sont plus grandes et pires que l'antenne, et vous ne pouvez pas d√©j√† l'acheter.  Les tests ont plus ou moins r√©ussi.  Le dernier segment a d√ª √™tre ressoud√©.  Il a √©t√© soud√© √† l'origine du mauvais c√¥t√©.  Et ajustez le nombre de LED dans le firmware. <br><br><img src="https://habrastorage.org/webt/_j/wd/ys/_jwdyskx5_cwxqkea6xt7jbkjqk.jpeg" alt="image"><br><br><img src="https://habrastorage.org/webt/gx/qc/qa/gxqcqaaas0qbg7gy54ysyzofbnu.jpeg" alt="image"><br><br>  Voici ce qui s'est pass√©: <br><br><img src="https://habrastorage.org/webt/i7/fb/0u/i7fb0ul-f1kejvabyxrbhzmkcea.jpeg" alt="image"><br><br><h3>  <b>Commande radio</b> </h3><br>  Fen√™tre principale avec canaux de commande de lampe <br><br><img src="https://habrastorage.org/webt/zj/r_/_0/zjr__02hc4it_fasqf-qkhi0gle.png" alt="image"><br><br>  R√©glez la luminosit√© d'un canal de la bande LED <br><br><img src="https://habrastorage.org/webt/1b/80/ho/1b80hohb7oaxhwyyzga6k5osnw0.png" alt="image"><br><br>  R√©glage de l'arr√™t matinal de la veilleuse <br><br><img src="https://habrastorage.org/webt/yx/ar/ua/yxaruahy9rj26onaqu6tbo2uu5a.png" alt="image"><br><br><h3>  <b>Conclusion</b> </h3><br>  L'appareil fonctionne.  Il est compact et soign√©.  Il est aliment√© par la charge d'un t√©l√©phone mobile. <br>  Des probl√®mes constat√©s: <br><br><ul><li>  lors de l'assemblage, a arrach√© une partie des pistes sur des r√©sistances variables, donc en mode manuel, vous ne pouvez contr√¥ler qu'un seul canal. </li><li>  seulement 20 LED sur 25 fonctionnent normalement. J'en ai beaucoup, donc je vais probablement le laisser pour identifier les lacunes plus graves </li></ul><br><div class="spoiler">  <b class="spoiler_title">Croquis de lumi√®re de nuit</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ZUNO_NeoPixel.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PIXELS 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// NB! Z-Uno can not control more than 25 WS2811 without harming RF communications #define PIXEL_SIZE 3 // Three colors per pixel #define BUFF_SIZE (MAX_PIXELS * PIXEL_SIZE) byte pixel_buff[BUFF_SIZE]; NeoPixel pixels(pixel_buff, BUFF_SIZE); #define B_PRESSED 1 #define BUTTON_PIN 1 // Digital IO pin connected to the button. This will be #define DEF_RED 30 #define DEF_GREEN 20 byte red = DEF_RED; byte green = DEF_GREEN; byte blue = 0; #define POWER_ON 1 #define POWER_OFF 0 byte light_power = POWER_ON; byte last_light_power = POWER_OFF; ZUNO_SETUP_CHANNELS( ZUNO_SWITCH_MULTILEVEL(getRed, setRed), ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen), ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue), ZUNO_SWITCH_BINARY(switch_getter, switch_setter) ); void switch_setter(byte value) { Serial.println("switch"); Serial.print("value= "); Serial.println(value); if(value &gt; 1) light_power = POWER_ON; else light_power = POWER_OFF; } byte switch_getter() { return light_power; } int getRed() { return red/2.56; } int getGreen() { return green/2.56; } int getBlue() { return blue/2.56; } void setRed(byte value) { red = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void setGreen(byte value) { green = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void setBlue(byte value) { blue = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void set_LEDS() { for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); } void read_resistors() { red = (analogRead(A0) &gt;&gt; 2) &amp; 0xff; green = (analogRead(A1) &gt;&gt; 2) &amp; 0xff; blue = (analogRead(A3) &gt;&gt; 2) &amp; 0xff; Serial.print(red); Serial.print(" "); Serial.print(green); Serial.print(" "); Serial.print(blue); Serial.print(" "); Serial.println(); set_LEDS(); } #define DEBOUNCE_ACK 10 byte check_button() { static bool oldState = HIGH; byte debounce_cnt = 0; static byte ret = 0; if(digitalRead(BUTTON_PIN) == LOW) { if(ret != B_PRESSED) while(digitalRead(BUTTON_PIN) == LOW) { if(debounce_cnt == DEBOUNCE_ACK) { ret = B_PRESSED; break; } else debounce_cnt++; delay(10); } } else { debounce_cnt = 0; ret = 0; } return ret; } void setup() { Serial.begin(9600); pixels.begin(); pixels.clear(); pinMode(BUTTON_PIN, INPUT_PULLUP); } void loop() { if(check_button() == B_PRESSED) read_resistors(); if(last_light_power != light_power) { Serial.println("set power"); if(light_power == POWER_OFF) { Serial.println("power off"); red = 0; green = 0; blue = 0; } else { Serial.println("power on"); red = DEF_RED; green = DEF_GREEN; blue = 0; } set_LEDS(); last_light_power = light_power; } }</span></span></span></span></code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433194/">https://habr.com/ru/post/fr433194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433182/index.html">Est-il possible de former un agent pour la n√©gociation en bourse avec des renforts? Impl√©mentation du langage R</a></li>
<li><a href="../fr433184/index.html">ASP.NET Core 2.2 est sorti. Quoi de neuf (2 sur 3)</a></li>
<li><a href="../fr433186/index.html">Il ne suffit pas de compter les polygones pour optimiser les mod√®les 3D</a></li>
<li><a href="../fr433188/index.html">Un projet de loi sur le travail autonome de Runet a √©t√© soumis √† la Douma d'√âtat</a></li>
<li><a href="../fr433192/index.html">Kubernetes: une solution de projet personnel incroyablement abordable</a></li>
<li><a href="../fr433196/index.html">Guide cadeaux du Nouvel An</a></li>
<li><a href="../fr433198/index.html">10 dollars pour l'h√©bergement: il y a 20 ans et aujourd'hui</a></li>
<li><a href="../fr433202/index.html">Choisir l'architecture d'une solution pour une place de march√© des services de fret</a></li>
<li><a href="../fr433204/index.html">Comment apprendre le d√©veloppement Java? L'exp√©rience de l'√©tudiante GeekUniversity Nikita Chernetsov</a></li>
<li><a href="../fr433206/index.html">Nous vous invitons le 22 d√©cembre au Data Christmas Tree</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>