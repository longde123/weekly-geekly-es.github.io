<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÇ üë©üèº üêÅ A t√©cnica de desenvolver servidores altamente confi√°veis ‚Äã‚Äãno Go üé• üë®üèø‚Äçüéì üåø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De tempos em tempos, programadores da Web enfrentam tarefas que podem at√© assustar profissionais. Estamos falando sobre o desenvolvimento de aplicativ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A t√©cnica de desenvolver servidores altamente confi√°veis ‚Äã‚Äãno Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/413681/">  De tempos em tempos, programadores da Web enfrentam tarefas que podem at√© assustar profissionais.  Estamos falando sobre o desenvolvimento de aplicativos de servidor que n√£o t√™m o direito de cometer erros, sobre projetos nos quais o custo da falha √© extremamente alto.  O autor do material, cuja tradu√ß√£o publicamos hoje, falar√° sobre como abordar essas tarefas. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/2r/ma/ty/2rmaty9ihtz7cjzhhvzqgm5e7ia.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Qual o n√≠vel de confiabilidade que seu projeto precisa?</font> </h2><br>  Antes de se aprofundar nos detalhes do desenvolvimento de aplicativos de servidor altamente confi√°veis, voc√™ deve se perguntar se o seu projeto realmente precisa do mais alto n√≠vel poss√≠vel de confiabilidade.  O processo de desenvolvimento de sistemas projetados para cen√°rios de trabalho nos quais o erro √© semelhante a uma cat√°strofe universal pode ser irracionalmente complicado para a maioria dos projetos nos quais as consequ√™ncias de poss√≠veis erros n√£o s√£o particularmente assustadoras. <br><br>  Se o custo do erro n√£o for extremamente alto, √© aceit√°vel uma abordagem, na implementa√ß√£o em que o desenvolvedor faz os esfor√ßos mais razo√°veis ‚Äã‚Äãpara garantir a operacionalidade do projeto e, se surgirem problemas, ele simplesmente os entende.  Ferramentas modernas de monitoramento e processos cont√≠nuos de implanta√ß√£o de software permitem identificar rapidamente problemas de produ√ß√£o e corrigi-los quase instantaneamente.  Em muitos casos, isso √© suficiente. <br><br>  No projeto em que estou trabalhando hoje, n√£o √© assim.  Estamos falando da implementa√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blockchain</a> - uma infraestrutura de servidor distribu√≠do para a execu√ß√£o segura de c√≥digo em um ambiente com baixo n√≠vel de confian√ßa e consenso.  Uma aplica√ß√£o dessa tecnologia s√£o as moedas digitais.  Este √© um exemplo cl√°ssico de um sistema com um custo de erro extremamente alto.  Nesse caso, os desenvolvedores do projeto realmente precisam torn√°-lo muito, muito confi√°vel. <br><br>  No entanto, em alguns outros projetos, mesmo que n√£o estejam relacionados a finan√ßas, faz sentido a busca pela maior confiabilidade do c√≥digo.  O custo de manuten√ß√£o de uma base de c√≥digo que freq√ºentemente quebra pode atingir rapidamente valores astron√¥micos.  A capacidade de identificar problemas nos est√°gios iniciais do processo de desenvolvimento, quando o custo para corrigi-los ainda √© baixo, parece uma recompensa muito real pelo investimento oportuno de tempo e esfor√ßo na metodologia de desenvolvimento de sistemas altamente confi√°veis. <br><br><h2>  <font color="#3AC1EF">Talvez a solu√ß√£o seja TDD?</font> </h2><br>  O desenvolvimento por meio de testes ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Test Driven Development</a> , TDD) √© frequentemente considerado a melhor solu√ß√£o para c√≥digos ruins.  TDD √© uma metodologia de desenvolvimento purista, na aplica√ß√£o da qual os testes s√£o escritos primeiro, e somente ent√£o - c√≥digo que √© adicionado ao projeto somente quando os testes que o verificam param de gerar erros.  Esse processo garante 100% de cobertura do c√≥digo com testes e geralmente d√° a ilus√£o de que o c√≥digo √© testado em todas as variantes poss√≠veis de seu uso. <br><br>  No entanto, isso n√£o √© verdade.  O TDD √© uma √≥tima metodologia que funciona bem em algumas √°reas, mas para desenvolver um c√≥digo realmente confi√°vel, mas n√£o o suficiente.  Pior ainda, o TDD inspira o desenvolvedor com falsa confian√ßa e a aplica√ß√£o dessa metodologia pode levar ao fato de que ele simplesmente n√£o ir√°, por pregui√ßa, escrever testes para verificar se h√° falhas no sistema em situa√ß√µes cuja ocorr√™ncia, do ponto de vista do senso comum, √© quase imposs√≠vel.  Falaremos sobre isso mais tarde. <br><br><h2>  <font color="#3AC1EF">Os testes s√£o a chave para a confiabilidade</font> </h2><br>  Na verdade, n√£o importa se voc√™ cria testes antes de escrever o c√≥digo ou depois, se usa uma metodologia de desenvolvimento como TDD ou n√£o.  O principal √© o fato de ter testes.  Os testes s√£o a melhor fortifica√ß√£o defensiva que protege seu c√≥digo contra problemas de produ√ß√£o. <br><br>  Como vamos executar nossos testes com muita frequ√™ncia, idealmente ap√≥s adicionar cada nova linha ao c√≥digo, √© necess√°rio que os testes sejam automatizados.  Nossa confian√ßa na qualidade do c√≥digo n√£o deve se basear em suas verifica√ß√µes manuais.  O problema √© que as pessoas tendem a cometer erros.  A aten√ß√£o de uma pessoa aos detalhes √© enfraquecida depois que ela realiza a mesma tarefa assustadora v√°rias vezes seguidas. <br><br>  Os testes devem ser r√°pidos.  Muito rapido <br><br>  Se levar mais de alguns segundos para concluir o conjunto de testes, os desenvolvedores provavelmente ser√£o pregui√ßosos e adicionar√£o c√≥digo ao projeto sem test√°-lo.  A velocidade √© um dos maiores pontos fortes de Go.  O kit de ferramentas de desenvolvimento nesse idioma √© um dos mais r√°pidos entre os existentes.  Compilar, reconstruir e testar projetos √© feito em segundos. <br><br>  Al√©m disso, os testes s√£o uma das principais for√ßas motrizes dos projetos de c√≥digo aberto.  Por exemplo, isso se aplica a tudo relacionado √† tecnologia blockchain.  O c√≥digo aberto aqui √© quase uma religi√£o.  A base de c√≥digo para ganhar confian√ßa naqueles que a usar√£o deve estar aberta.  Isso permite, por exemplo, conduzir sua auditoria, cria uma atmosfera de descentraliza√ß√£o, na qual n√£o existem certas entidades que controlam o projeto. <br><br>  N√£o faz sentido esperar por uma contribui√ß√£o significativa para o projeto de c√≥digo aberto de desenvolvedores externos, se esse projeto n√£o incluir testes de qualidade.  Os participantes externos do projeto precisam de mecanismos para verificar rapidamente a compatibilidade do que escreveram com o que j√° foi adicionado ao projeto.  De fato, todo o conjunto de testes deve ser realizado automaticamente ap√≥s o recebimento de cada solicita√ß√£o para adicionar novo c√≥digo ao projeto.  Se algo que deve ser adicionado ao projeto por meio de uma solicita√ß√£o desse tipo quebra algo, o teste deve reportar isso imediatamente. <br><br>  A cobertura completa da base de c√≥digo com testes √© uma m√©trica enganosa, mas importante.  O objetivo de atingir 100% de cobertura de c√≥digo com testes pode parecer excessivo, mas se voc√™ pensar bem, acontece que, se o c√≥digo n√£o for totalmente coberto por testes, parte do c√≥digo ser√° enviada para produ√ß√£o sem verifica√ß√£o, o que nunca foi executado antes. <br><br>  A cobertura completa do c√≥digo com testes n√£o significa necessariamente que h√° testes suficientes no projeto e n√£o significa que esses s√£o testes que fornecem absolutamente todas as op√ß√µes para o uso do c√≥digo.  Com confian√ßa, podemos dizer apenas que, se o projeto n√£o for 100% coberto em testes, o desenvolvedor n√£o poder√° ter certeza da confiabilidade absoluta do c√≥digo, pois algumas partes do c√≥digo nunca s√£o testadas. <br><br>  Apesar do exposto, h√° situa√ß√µes em que h√° muitos testes.  Idealmente, todo erro poss√≠vel deve levar √† falha de um teste.  Se o n√∫mero de testes for excessivo, ou seja, testes diferentes verificam os mesmos fragmentos de c√≥digo, modificar o c√≥digo existente e alterar o comportamento do sistema existente levar√° ao fato de que, para que os testes existentes correspondam ao novo c√≥digo, levar√° muito tempo para process√°-los . <br><br><h2>  <font color="#3AC1EF">Por que a Go √© uma √≥tima op√ß√£o para projetos altamente confi√°veis?</font> </h2><br>  Go √© uma linguagem est√°tica digitada.  Tipos s√£o um contrato entre v√°rias partes do c√≥digo que s√£o executadas juntas.  Sem a verifica√ß√£o autom√°tica de tipo durante o processo de montagem do projeto, se voc√™ precisar seguir regras estritas para cobrir o c√≥digo com testes, teremos que implementar testes que verifiquem esses "contratos" por conta pr√≥pria.  Isso, por exemplo, acontece em projetos de servidor e cliente baseados em JavaScript.  Escrever testes complexos destinados apenas a verificar tipos significa muito trabalho adicional, que, no caso de Go, pode ser evitado. <br><br>  Go √© uma linguagem simples e dogm√°tica.  Como voc√™ sabe, o Go inclui muitas id√©ias tradicionais para linguagens de programa√ß√£o, como a heran√ßa cl√°ssica de POO.  A complexidade √© o pior inimigo do c√≥digo confi√°vel.  Os problemas tendem a se esconder nas articula√ß√µes de estruturas complexas.  Isso se expressa no fato de que, embora as op√ß√µes t√≠picas para o uso de um determinado design sejam f√°ceis de testar, h√° casos de fronteira bizarros nos quais o desenvolvedor do teste pode nem pensar.  O projeto, no final, derrubar√° apenas um desses casos.  Nesse sentido, o dogmatismo tamb√©m √© √∫til.  No Go, geralmente h√° apenas uma maneira de executar uma a√ß√£o.  Isso pode parecer um fator que ret√©m o esp√≠rito livre do programador, mas quando algo pode ser feito de apenas uma maneira, √© dif√≠cil fazer algo errado. <br><br>  Ir √© conciso, mas expressivo.  O c√≥digo leg√≠vel √© mais f√°cil de analisar e auditar.  Se o c√≥digo for muito detalhado, seu principal objetivo pode se afogar no "ru√≠do" das constru√ß√µes auxiliares.  Se o c√≥digo for muito conciso, pode ser dif√≠cil ler e entender os programas nele.  Go mant√©m um equil√≠brio entre concis√£o e expressividade.  Por exemplo, n√£o h√° muitas constru√ß√µes auxiliares nele, como em linguagens como Java ou C ++.  Ao mesmo tempo, as constru√ß√µes Go, relacionadas, por exemplo, a √°reas como tratamento de erros, s√£o muito claras e bastante detalhadas, o que simplifica o trabalho do programador, ajudando-o a garantir, por exemplo, que ele verificou tudo o que √© poss√≠vel. <br><br>  O Go possui mecanismos claros de tratamento e recupera√ß√£o de erros ap√≥s falhas.  Mecanismos de manipula√ß√£o de erros de tempo de execu√ß√£o bem ajustados s√£o a pedra angular de um c√≥digo altamente confi√°vel.  O Go possui regras r√≠gidas para retornar e distribuir erros.  Em ambientes como o Node.js, a combina√ß√£o de abordagens para controlar o fluxo de um programa, como retornos de chamada, promessas e fun√ß√µes ass√≠ncronas, geralmente leva a erros n√£o tratados, como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rejei√ß√£o n√£o tratada de uma promessa</a> .  Restaurar o programa ap√≥s eventos semelhantes √© quase <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imposs√≠vel</a> . <br><br>  Go tem uma extensa biblioteca padr√£o.  Depend√™ncias s√£o um risco, especialmente quando sua fonte √© de projetos nos quais aten√ß√£o insuficiente √© dada √† confiabilidade do c√≥digo.  Um aplicativo de servidor que entra em produ√ß√£o cont√©m todas as depend√™ncias.  Al√©m disso, se algo der errado, o desenvolvedor do aplicativo final ser√° respons√°vel por isso, e n√£o aquele que criou uma das bibliotecas usadas por ele.  Como resultado, em ambientes onde os projetos escritos para os quais s√£o sobrecarregados com pequenas depend√™ncias, √© mais dif√≠cil criar aplicativos confi√°veis. <br><br>  Depend√™ncias tamb√©m s√£o um risco de seguran√ßa, pois o n√≠vel de vulnerabilidade de um projeto corresponde ao n√≠vel de vulnerabilidade de sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">depend√™ncia</a> mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">insegura</a> .  A extensa biblioteca padr√£o Go √© mantida por seus desenvolvedores em muito boas condi√ß√µes, sua exist√™ncia reduz a necessidade de depend√™ncias externas. <br><br>  Alta velocidade de desenvolvimento.  Um recurso importante de ambientes como o Node.js √© seu ciclo de desenvolvimento extremamente curto.  Escrever c√≥digo leva menos tempo, como resultado, o programador se torna mais produtivo. <br><br>  Go tamb√©m tem uma alta velocidade de desenvolvimento.  Um conjunto de ferramentas para criar projetos √© r√°pido o suficiente para poder olhar instantaneamente o c√≥digo em a√ß√£o.  O tempo de compila√ß√£o √© extremamente curto; como resultado, a execu√ß√£o do c√≥digo no Go √© percebida como se n√£o tivesse sido compilada, mas interpretada.  Al√©m disso, a linguagem possui abstra√ß√µes suficientes, como um sistema de coleta de lixo, que permite que os desenvolvedores direcionem esfor√ßos para implementar a funcionalidade de seu projeto, e n√£o para resolver tarefas auxiliares. <br><br><h2>  <font color="#3AC1EF">Experi√™ncia pr√°tica</font> </h2><br>  Agora que j√° expressamos pontos gerais suficientes, √© hora de dar uma olhada no c√≥digo.  Precisamos de um exemplo simples o suficiente para que, ao estud√°-lo, possamos nos concentrar na metodologia de desenvolvimento, mas, ao mesmo tempo, ela deve ser avan√ßada o suficiente para que, ao explor√°-la, tenhamos algo sobre o que conversar.  Decidi que seria mais f√°cil tirar algo do que fa√ßo diariamente.  Portanto, proponho analisar a cria√ß√£o de um servidor que processa algo semelhante a transa√ß√µes financeiras.  Os usu√°rios deste servidor poder√£o verificar os saldos das contas associadas √†s suas contas.  Al√©m disso, eles poder√£o transferir fundos de uma conta para outra. <br><br>  Vamos tentar n√£o complicar este exemplo.  Nosso sistema ter√° um servidor.  N√£o entraremos em contato com sistemas de autentica√ß√£o e criptografia.  Essas s√£o partes integrais dos projetos de trabalho.  Mas precisamos nos concentrar no n√∫cleo de um projeto, para mostrar como torn√°-lo o mais confi√°vel poss√≠vel. <br><br><h3>  <font color="#3AC1EF">‚ñçDivis√£o de um projeto complexo em partes convenientes para gerenciar</font> </h3><br>  A complexidade √© o pior inimigo da confiabilidade.  Uma das melhores abordagens ao trabalhar com sistemas complexos √© aplicar o princ√≠pio conhecido de "dividir e conquistar".  A tarefa precisa ser dividida em pequenas subtarefas e resolver cada uma delas separadamente.  Qual lado abordar a parti√ß√£o de nossa tarefa?  Seguiremos o princ√≠pio da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">responsabilidade compartilhada</a> .  Cada parte do nosso projeto deve ter sua pr√≥pria √°rea de responsabilidade. <br><br>  Essa id√©ia se encaixa perfeitamente na arquitetura popular de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">microsservi√ßo</a> .  Nosso servidor consistir√° em servi√ßos separados.  Cada servi√ßo ter√° uma √°rea de responsabilidade claramente definida e uma interface claramente descrita para interagir com outros servi√ßos. <br><br>  Depois de estruturarmos o servidor dessa maneira, poderemos tomar decis√µes sobre como cada um dos servi√ßos deve funcionar.  Todos os servi√ßos podem ser executados juntos, no mesmo processo, de cada um deles, voc√™ pode criar um servidor separado e estabelecer sua intera√ß√£o usando o RPC, separar os servi√ßos e executar cada um deles em um computador separado. <br><br>  N√£o complicaremos a tarefa, escolheremos a op√ß√£o mais simples.  Ou seja, todos os servi√ßos ser√£o executados no mesmo processo, eles trocar√£o informa√ß√µes diretamente, como bibliotecas.  Se necess√°rio, no futuro, essa solu√ß√£o arquitet√¥nica poder√° ser facilmente revisada e alterada. <br><br>  Ent√£o, de quais servi√ßos precisamos?  Nosso servidor talvez seja simples demais para dividi-lo em partes, mas, para fins educacionais, n√≥s, no entanto, o dividiremos.  Precisamos responder √†s solicita√ß√µes HTTP do cliente destinadas a verificar saldos e executar transa√ß√µes.  Um dos servi√ßos pode funcionar com uma interface HTTP para clientes.  <code>PublicApi</code> cham√°-lo de <code>PublicApi</code> .  Outro servi√ßo possui informa√ß√µes sobre o estado do sistema - o balan√ßo patrimonial.  <code>StateStorage</code> cham√°-lo <code>StateStorage</code> .  O terceiro servi√ßo combinar√° os dois descritos acima e implementar√° a l√≥gica dos ‚Äúcontratos‚Äù destinados a alterar os saldos.  A tarefa do terceiro servi√ßo ser√° a execu√ß√£o de contratos.  <code>VirtualMachine</code> cham√°-lo de <code>VirtualMachine</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a2/a04/79b/8a2a0479b551df5fd2a3c46e67bb46a7.png"></div><br>  <i><font color="#999999">Arquitetura do servidor de aplicativos</font></i> <br><br>  Coloque o c√≥digo desses servi√ßos nas pastas do projeto <code>/services/publicapi</code> , <code>/services/virtualmachine</code> e <code>/services/statestorage</code> . <br><br><h3>  <font color="#3AC1EF">‚ñç Defini√ß√£o clara de responsabilidades de servi√ßo</font> </h3><br>  Durante a implementa√ß√£o dos servi√ßos, queremos poder trabalhar com cada um deles individualmente.  √â ainda poss√≠vel dividir o desenvolvimento desses servi√ßos entre diferentes programadores.  Como os servi√ßos s√£o interdependentes e queremos paralelizar seu desenvolvimento, precisamos come√ßar a trabalhar com uma defini√ß√£o clara das interfaces que eles usam para interagir entre si.  Usando essas interfaces, podemos testar servi√ßos autonomamente, preparando stubs para tudo o que est√° fora de cada uma delas. <br><br>  Como descrever a interface?  Uma das op√ß√µes √© documentar tudo, mas a documenta√ß√£o tem a propriedade de se tornar obsoleta. No processo de trabalhar em um projeto, as diferen√ßas come√ßam a se acumular entre a documenta√ß√£o e o c√≥digo.  Al√©m disso, podemos usar as declara√ß√µes da interface Go.  Essa √© uma op√ß√£o interessante, mas √© melhor descrever a interface para que essa descri√ß√£o n√£o dependa de uma linguagem de programa√ß√£o espec√≠fica.  Isso nos ser√° √∫til em uma situa√ß√£o muito real, se, no processo de trabalhar em um projeto, for decidido implementar alguns de seus servi√ßos em outros idiomas, cujas capacidades s√£o mais adequadas para resolver seus problemas. <br><br>  Uma op√ß√£o para descrever interfaces √© usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">protobuf</a> .  Este √© um protocolo simples de idioma e idioma independente para descrever mensagens e pontos de extremidade de servi√ßo. <br><br>  Vamos come√ßar com a interface para o servi√ßo <code>StateStorage</code> .  Apresentaremos o estado do aplicativo na forma de uma estrutura de exibi√ß√£o de valor-chave.  Aqui est√° o c√≥digo para o arquivo <code>statestorage.proto</code> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> statestorage; <span class="hljs-attribute"><span class="hljs-attribute">service</span></span> StateStorage { <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> WriteKey (WriteKeyInput) returns (WriteKeyOutput); <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> ReadKey (ReadKeyInput) returns (ReadKeyOutput); } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyOutput { } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyOutput { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Embora os clientes usem HTTP por meio do servi√ßo <code>PublicApi</code> , ele tamb√©m n√£o interfere na interface clara descrita pelos mesmos meios acima (o arquivo <code>publicapi.proto</code> ): <br><br><pre> <code class="hljs pgsql">syntax = "proto3"; package publicapi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "protocol/transactions.proto"; service PublicApi { rpc Transfer (TransferInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (TransferOutput); rpc GetBalance (GetBalanceInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (GetBalanceOutput); } message TransferInput { protocol.<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message TransferOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; } message GetBalanceInput { protocol.Address <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message GetBalanceOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  Agora precisamos descrever as estruturas de dados <code>Transaction</code> e <code>Address</code> (arquivo <code>transactions.proto</code> ): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> protocol; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Address { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> username = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Transaction { <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> from = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> to = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> amount = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br>  No projeto, proto-descri√ß√µes de servi√ßos s√£o colocadas na pasta <code>/types/services</code> e descri√ß√µes de estruturas de dados de uso geral est√£o na pasta <code>/types/protocol</code> . <br><br>  Quando as descri√ß√µes da interface estiverem prontas, elas poder√£o ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compiladas</a> no c√≥digo Go. <br><br>  As vantagens dessa abordagem s√£o que o c√≥digo que n√£o corresponde √† descri√ß√£o da interface simplesmente n√£o aparece nos resultados da compila√ß√£o.  O uso de m√©todos alternativos exigiria a cria√ß√£o de testes especiais para verificar se o c√≥digo corresponde √†s descri√ß√µes da interface. <br><br>  Defini√ß√µes completas, arquivos Go gerados e instru√ß√µes de compila√ß√£o podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Isso √© poss√≠vel gra√ßas √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Square Engineering</a> e ao desenvolvimento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">goprotowrap</a> . <br><br>  Observe que, em nosso projeto, a RPC da camada de transporte n√£o √© implementada e a troca de dados entre servi√ßos se parece com chamadas de biblioteca comuns.  Quando estamos prontos para distribuir servi√ßos em diferentes servidores, podemos adicionar uma camada de transporte como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gRPC</a> ao sistema. <br><br><h3>  <font color="#3AC1EF">‚ñç Tipos de testes usados ‚Äã‚Äãno projeto</font> </h3><br>  Como os testes s√£o a chave para um c√≥digo altamente confi√°vel, sugiro que primeiro falemos sobre quais testes escreveremos para o nosso projeto. <br><br><h4>  Testes unit√°rios </h4><br>  Os testes de unidade s√£o o n√∫cleo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">da pir√¢mide de testes</a> .  Testaremos cada m√≥dulo isoladamente.  O que √© um m√≥dulo?  No Go, podemos perceber os m√≥dulos como arquivos separados em um pacote.  Por exemplo, se tivermos o arquivo <code>/services/publicapi/handlers.go</code> , colocaremos o teste de unidade no mesmo pacote em <code>/services/publicapi/handlers_test.go</code> . <br><br>  √â melhor colocar testes de unidade no mesmo pacote que o c√≥digo de teste, o que permite que os testes tenham acesso a vari√°veis ‚Äã‚Äãe fun√ß√µes n√£o exportadas. <br><br><h4>  Testes de Servi√ßo </h4><br>  O seguinte tipo de teste √© conhecido por v√°rios nomes.  Estes s√£o os chamados testes de servi√ßo, integra√ß√£o ou componente.  Sua ess√™ncia √© pegar v√°rios m√≥dulos e testar seu trabalho conjunto.  Esses testes s√£o um n√≠vel acima dos testes de unidade na pir√¢mide de testes.  No nosso caso, usaremos testes de integra√ß√£o para testar todo o servi√ßo.  Esses testes determinam as especifica√ß√µes para o servi√ßo.  Por exemplo, os testes para o servi√ßo <code>StateStorage</code> ser√£o colocados na pasta <code>/services/statestorage/spec</code> . <br><br>  √â melhor colocar esses testes em um pacote diferente daquele em que o c√≥digo testado est√° localizado, para que o acesso aos recursos desse c√≥digo seja realizado apenas por meio de interfaces exportadas. <br><br><h4>  Testes de ponta a ponta </h4><br>  Esses testes est√£o no topo da pir√¢mide de testes, com sua ajuda para verificar todo o sistema e todos os seus servi√ßos.  Esses testes descrevem a especifica√ß√£o e2e de ponta a ponta para o sistema, portanto, os colocaremos na pasta <code>/e2e/spec</code> . <br><br>  Testes de ponta a ponta, bem como testes de servi√ßo, devem ser colocados em um pacote diferente daquele em que o c√≥digo testado est√° localizado, para que o sistema possa ser operado apenas atrav√©s de interfaces exportadas. <br><br>  Quais testes devem ser escritos primeiro?  Comece com a funda√ß√£o da "pir√¢mide" e suba?  Ou come√ßar por cima e descer?  Qualquer uma dessas abordagens tem direito √† vida.  Os benef√≠cios de uma abordagem de cima para baixo est√£o na cria√ß√£o da especifica√ß√£o primeiro para todo o sistema.  Geralmente, √© mais f√°cil discutir no in√≠cio do trabalho sobre os recursos do sistema como um todo.  Mesmo se dividirmos o sistema em servi√ßos separados incorretamente, as especifica√ß√µes do sistema permanecer√£o inalteradas.  Al√©m disso, isso nos ajudar√° a entender que algo, em um n√≠vel inferior, √© feito incorretamente. <br><br>  O ponto negativo da abordagem de cima para baixo √© que os testes de ponta a ponta s√£o aqueles usados ‚Äã‚Äãdepois de todos os outros, quando todo o sistema que est√° sendo desenvolvido √© criado.  Isso significa que eles ir√£o gerar erros por um longo tempo.  Ao escrever testes para o nosso projeto, usaremos essa mesma abordagem. <br><br><h3>  <font color="#3AC1EF">Desenvolvimento de teste</font> </h3><br><h4>  Desenvolvimento de teste de ponta a ponta </h4><br>  Antes de criar testes, precisamos decidir se os escreveremos sem o uso de ferramentas auxiliares ou com algum tipo de estrutura.  Confiar na estrutura, us√°-la como uma depend√™ncia de desenvolvimento, √© menos perigoso do que confiar na estrutura no c√≥digo que entra em produ√ß√£o.  No nosso caso, como a biblioteca Go padr√£o n√£o tem suporte decente ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BDD</a> e esse formato √© √≥timo para descrever especifica√ß√µes, escolheremos uma op√ß√£o de trabalho que inclua o uso de uma estrutura. <br><br>  Existem muitas estruturas excelentes que fornecem o que precisamos.  Entre eles est√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GoConvey</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ginkgo</a> . <br><br>  Pessoalmente, gosto de usar uma combina√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ginkgo</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gomega</a> (nomes terr√≠veis, mas o que fazer) que usam constru√ß√µes sint√°ticas como <code>Describe()</code> e <code>It()</code> . <br><br>  Como ser√£o os nossos testes?  Por exemplo, aqui est√° um teste para o mecanismo de verifica√ß√£o do saldo do usu√°rio (arquivo <code>sanity.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Sanity"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( node services.Node ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node = services.NewNode() node.Start() }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should show balances with GET /api/balance"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user1"</span></span>) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(<span class="hljs-string"><span class="hljs-string">"0"</span></span>)) }) })</code> </pre> <br>  Como o servidor √© acess√≠vel do mundo exterior via HTTP, trabalharemos com sua API da web usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://golang.org/pkg/net/">http.Get</a> .  E o teste transacional?  Aqui est√° o c√≥digo para o teste correspondente: <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should transfer funds with POST /api/transfer"</span></span>, func() { resp, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=user1&amp;to=user2&amp;amount=17"</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"-17"</span></span>)) resp, err = http.Post(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user2"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"17"</span></span>)) })</code> </pre><br>  O c√≥digo de teste descreve perfeitamente sua ess√™ncia, podendo at√© substituir a documenta√ß√£o.  Como voc√™ pode ver, admitimos a presen√ßa de saldos negativos da conta do usu√°rio.  Esta √© uma caracter√≠stica do nosso projeto.  Se fosse proibido, essa decis√£o seria refletida no teste. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui est√° o</a> c√≥digo de teste completo <br><br><h4>  Desenvolvimento de Teste de Servi√ßo </h4><br>  Agora, depois de desenvolver testes de ponta a ponta, descemos a pir√¢mide de testes e continuamos a criar testes de servi√ßo.  Tais testes s√£o desenvolvidos para cada servi√ßo individual.  Escolhemos um servi√ßo que depende de outro servi√ßo, pois esse caso √© mais interessante do que desenvolver testes para um servi√ßo independente. <br><br>  Vamos come√ßar com o servi√ßo <code>VirtualMachine</code> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ encontra a interface com proto-descri√ß√µes para este servi√ßo.  Como o servi√ßo <code>VirtualMachine</code> conta com o servi√ßo <code>StateStorage</code> e faz chamadas para ele, precisaremos criar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">objeto simulado</a> para o servi√ßo <code>StateStorage</code> para testar o servi√ßo <code>VirtualMachine</code> isoladamente.  O objeto stub nos permite controlar respostas <code>StateStorage</code> durante o teste. <br><br>  Como implementar um objeto stub no Go?  Isso pode ser feito exclusivamente por meio da linguagem, sem ferramentas auxiliares, ou voc√™ pode recorrer √† biblioteca apropriada, que, al√©m disso, tornar√° poss√≠vel trabalhar com as instru√ß√µes no processo de teste.  Para esse fim, prefiro usar a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">go-mock</a> . <br><br>  <code>/services/statestorage/mock.go</code> o c√≥digo stub no arquivo <code>/services/statestorage/mock.go</code> .  √â melhor colocar objetos de stub no mesmo local que as entidades que eles imitam para fornecer acesso a vari√°veis ‚Äã‚Äãe fun√ß√µes n√£o exportadas.  O stub nesse est√°gio √© uma implementa√ß√£o esquem√°tica do servi√ßo, mas, √† medida que o servi√ßo se desenvolve, podemos precisar desenvolver a implementa√ß√£o do stub.  Aqui est√° o c√≥digo para o objeto stub (arquivo <code>mock.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> statestorage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> MockService <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { mock.Mock } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Called().Bool(<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.WriteKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.WriteKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.WriteKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.ReadKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.ReadKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.ReadKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br>  Se voc√™ der o desenvolvimento de servi√ßos individuais a diferentes programadores, faz sentido primeiro criar stubs e pass√°-los para a equipe. <br><br>  Vamos voltar ao desenvolvimento de um teste de servi√ßo para o <code>VirtualMachine</code> .  Que cen√°rio devo verificar aqui?  √â melhor se concentrar na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">interface de</a> servi√ßo e nos testes de design para cada n√≥ de extremidade.  Implementamos um teste para o terminal <code>CallContract()</code> com um argumento que representa o m√©todo <code>"GetBalance"</code> .  Aqui est√° o c√≥digo correspondente (arquivo <code>contracts.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Contracts"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( service uut.Service stateStorage *_statestorage.MockService ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service = uut.NewService() stateStorage = &amp;_statestorage.MockService{} service.Start(stateStorage) }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should support 'GetBalance' contract method"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) addr := protocol.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>} out, err := service.CallContract(&amp;virtualmachine.CallContractInput{Method: <span class="hljs-string"><span class="hljs-string">"GetBalance"</span></span>, Arg: &amp;addr}) Expect(err).ToNot(HaveOccurred()) Expect(out.Result).To(BeEquivalentTo(<span class="hljs-number"><span class="hljs-number">100</span></span>)) Expect(stateStorage).To(ExecuteAsPlanned()) }) })</code> </pre><br>  Observe que o servi√ßo que estamos testando, <code>VirtualMachine</code> , obt√©m um ponteiro para sua depend√™ncia, <code>StateStorage</code> , no m√©todo <code>Start()</code> atrav√©s de um mecanismo simples de inje√ß√£o de depend√™ncia.  √â aqui que passamos a inst√¢ncia do objeto stub.  Al√©m disso, preste aten√ß√£o √† linha <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> , onde dizemos ao objeto stub como ele deve se comportar ao acess√°-lo. Quando o m√©todo <code>ReadKey</code> √© <code>ReadKey</code> , ele deve retornar um valor 100. Em seguida, na linha <code>Expect(stateStorage).To(ExecuteAsPlanned())</code> , verificamos se esse comando √© chamado exatamente uma vez. <br><br>  Testes similares tornam-se especifica√ß√µes para o servi√ßo.  O conjunto completo de testes para o servi√ßo <code>VirtualMachine</code> pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Os conjuntos de testes para outros servi√ßos do nosso projeto podem ser encontrados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h4>  Desenvolvimento de Teste de Unidade </h4><br>  Talvez a implementa√ß√£o do contrato para o m√©todo <code>"GetBalance"</code> seja muito simples, ent√£o <code>"GetBalance"</code> falar sobre a implementa√ß√£o de um m√©todo de <code>"Transfer"</code> um pouco mais complexo.  O contrato de transfer√™ncia de fundos de uma conta para outra representado por esse m√©todo precisa ler dados sobre os saldos do remetente e destinat√°rio dos fundos, calcular novos saldos e registrar o que aconteceu no estado do aplicativo.  O teste de servi√ßo para tudo isso √© muito semelhante ao que acabamos de implementar (arquivo <code>transactions.go</code> ): <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should support 'Transfer' transaction method"</span></span>, func() { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">t</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> protocol.Transaction{From: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}, To: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}, Amount: <span class="hljs-number"><span class="hljs-number">10</span></span>} out, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> service.ProcessTransaction(<span class="hljs-name"><span class="hljs-name">&amp;virtualmachine</span></span>.ProcessTransactionInput{Method: <span class="hljs-string"><span class="hljs-string">"Transfer"</span></span>, Arg: <span class="hljs-symbol"><span class="hljs-symbol">&amp;t</span></span>}) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">out</span></span>.Result).To(<span class="hljs-name"><span class="hljs-name">BeEquivalentTo</span></span>(<span class="hljs-number"><span class="hljs-number">90</span></span>)) Expect(<span class="hljs-name"><span class="hljs-name">stateStorage</span></span>).To(<span class="hljs-name"><span class="hljs-name">ExecuteAsPlanned</span></span>()) })</code> </pre> <br>  No processo de trabalho no projeto, finalmente criamos seus mecanismos internos e criamos um m√≥dulo localizado no arquivo <code>processor.go</code> , que cont√©m a implementa√ß√£o do contrato.  Aqui est√° a vers√£o original (arquivo <code>processor.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> virtualmachine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *service)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processTransfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fromUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, toUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, amount </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { fromBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: fromUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } toBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: toUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: fromUsername, Value: fromBalance.Value - amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: toUsername, Value: toBalance.Value + amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromBalance.Value - amount, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>  Esse design satisfaz o teste de servi√ßo, mas, no nosso caso, o teste de integra√ß√£o cont√©m apenas um teste do cen√°rio b√°sico.  E os casos lim√≠trofes e poss√≠veis falhas?  Como voc√™ pode ver, qualquer uma das chamadas que fazemos ao <code>StateStorage</code> pode falhar.  Se for necess√°ria uma cobertura de 100% do c√≥digo com testes, precisamos verificar todas essas situa√ß√µes.  O teste de unidade √© √≥timo para implementar esses testes. <br><br>  Como vamos chamar a fun√ß√£o v√°rias vezes com dados de entrada diferentes e simular os par√¢metros para alcan√ßar todas as ramifica√ß√µes do c√≥digo, a fim de tornar esse processo mais eficiente, podemos recorrer a testes baseados em tabela.  Go tende a evitar estruturas de teste de unidade ex√≥ticas.  Podemos recusar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ginkgo</a> , mas provavelmente devemos deixar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gomega</a> .  Como resultado, as verifica√ß√µes realizadas aqui ser√£o semelhantes √†s verificadas em testes anteriores.  Aqui est√° o c√≥digo de teste (arquivo <code>processor_test.go</code> ): <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> virtualmachine import ... var transferTable = []struct{ to <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> //  ,    read1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       read2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> int32 //   errs bool //        }{ {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, } func TestTransfer(t *testing.T) { Œ© := NewGomegaWithT(t) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tt := range transferTable { s := NewService() ss := &amp;_statestorage.MockService{} s.Start(ss) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, tt.read1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, tt.read2Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write2Err) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>, err := s.(*service).processTransfer(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>, tt.to, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tt.errs { Œ©.Expect(err).To(HaveOccurred()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Œ©.Expect(err).ToNot(HaveOccurred()) Œ©.Expect(<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>).To(BeEquivalentTo(tt.<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>)) } } }</code> </pre> <br>     ¬´Œ©¬ª ‚Äî  ,    ‚Äî    (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gomega</a> ).          . <br><br>        ,        TDD,          ,     ,     .       <code>processTransfer()</code>         . <br><br>       <code>VirtualMachine</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . <br><br>    100%   .    ,    .             . <br><br>   ,        ?   .        , ,    ,     . <br><br><h3> <font color="#3AC1EF">‚ñç  -</font> </h3><br>              .         ?  HTTP-  Go     (goroutine).     ,  ‚Äî        ,     . ,      ,  ,   . <br><br>           -               . ,   ,   ,          ,        .  -     <code>/e2e/stress</code> .   - ( <code>stress.go</code> ): <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> stress import ... const NUM_TRANSACTIONS = <span class="hljs-number"><span class="hljs-number">20000</span></span> const NUM_USERS = <span class="hljs-number"><span class="hljs-number">100</span></span> const TRANSACTIONS_PER_BATCH = <span class="hljs-number"><span class="hljs-number">200</span></span> const BATCHES_PER_SEC = <span class="hljs-number"><span class="hljs-number">40</span></span> var <span class="hljs-number"><span class="hljs-number">_</span></span> = Describe(<span class="hljs-string"><span class="hljs-string">"Transaction Stress Test"</span></span>, func() { var ( node services.Node ) BeforeEach(func() { node = services.NewNode() node.Start() }) AfterEach(func() { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should handle lots and lots of transactions"</span></span>, func() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-     transport := http.Transport{ IdleConnTimeout: time.Second*<span class="hljs-number"><span class="hljs-number">20</span></span>, MaxIdleConns: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, MaxIdleConnsPerHost: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, } client := &amp;http.Client{Transport: &amp;transport} //      ledger := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[string]int32{} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { ledger[fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>)] = <span class="hljs-number"><span class="hljs-number">0</span></span> } //     HTTP   rand.Seed(<span class="hljs-number"><span class="hljs-number">42</span></span>) done := make(chan error, TRANSACTIONS_PER_BATCH) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH; i++ { log.Printf(<span class="hljs-string"><span class="hljs-string">"Sending %d transactions... (batch %d out of %d)"</span></span>, TRANSACTIONS_PER_BATCH, i+<span class="hljs-number"><span class="hljs-number">1</span></span>, NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH) time.Sleep(time.Second / BATCHES_PER_SEC) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { from := randomizeUser() to := randomizeUser() amount := randomizeAmount() ledger[from] -= amount ledger[to] += amount go sendTransaction(client, from, to, amount, &amp;done) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { err := &lt;- done Expect(err).ToNot(HaveOccurred()) } } //   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { user := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>) resp, err := client.Get(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=%s"</span></span>, user)) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, ledger[user]))) } }) }) func randomizeUser() string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, rand.Intn(NUM_USERS)+<span class="hljs-number"><span class="hljs-number">1</span></span>) } func randomizeAmount() int32 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand.Int31n(<span class="hljs-number"><span class="hljs-number">1000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> } func sendTransaction(client *http.Client, from string, to string, amount int32, done *chan error) { url := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=%s&amp;to=%s&amp;amount=%d"</span></span>, from, to, amount) resp, err := client.Post(url, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, nil) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == nil { ioutil.ReadAll(resp.Body) resp.Body.Close() } *done &lt;- err }</code> </pre> <br>    ,  -   .           (       <code>rand.Seed(42)</code> )  ,    .         .     ,            ,  ‚Äî ,     . <br><br>    -  HTTP   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>          TCP- (     ,     ,           ).  ,  ,              200     <code>IdleConnection</code>    TCP-   .       ,      100. <br><br>  ‚Ä¶   : <br><br><pre> <code class="hljs go">fatal error: concurrent <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> writes goroutine <span class="hljs-number"><span class="hljs-number">539</span></span> [running]: runtime.throw(<span class="hljs-number"><span class="hljs-number">0x147bf</span></span>60, <span class="hljs-number"><span class="hljs-number">0x15</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/<span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">616</span></span> +<span class="hljs-number"><span class="hljs-number">0x81</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 sp=<span class="hljs-number"><span class="hljs-number">0xc4207159b8</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x102ca01</span></span> runtime.mapassign_faststr(<span class="hljs-number"><span class="hljs-number">0x13f</span></span>5140, <span class="hljs-number"><span class="hljs-number">0xc4201ca0c0</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012001</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/hashmap_fast.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">703</span></span> +<span class="hljs-number"><span class="hljs-number">0x3e9</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 pc=<span class="hljs-number"><span class="hljs-number">0x100d</span></span>879 services/statestorage.(*service).WriteKey(<span class="hljs-number"><span class="hljs-number">0xc42000c060</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e6800</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4206491a0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>) services/statestorage/methods.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">0x10c</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x138339c</span></span> services/virtualmachine.(*service).processTransfer(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a80a1</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x2a4</span></span>, <span class="hljs-number"><span class="hljs-number">0xc420715b30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012928</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>) services/virtualmachine/processor.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> +<span class="hljs-number"><span class="hljs-number">0x16e</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715ad</span></span>0 sp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x13840ee</span></span> services/virtualmachine.(*service).ProcessTransaction(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e67c0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1433660</span></span>, <span class="hljs-number"><span class="hljs-number">0x12a1d</span></span>01) Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">1.288879763s</span></span> Test Suite Failed</code> </pre> <br>  ?   <code>StateStorage</code>       ( <code>map</code> ),   . ,     ,            .     ,           <code>map</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sync.map</a> .     . <br><br>     <a href="">processTransfer()</a> .         ,   ‚Äî      .         , ,         ,        ,     .     ,          <code>processTransfer()</code> . <a href=""></a>  . <br><br>    ,   . ,    ,     . <br><br><pre> <code class="hljs go">e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span> Expected &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7498</span></span> to equal &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7551</span></span> e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> ------------------------------ Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">5.251593179s</span></span> Test Suite Failed</code> </pre> <br>       ,    . ,   ,          ( ,           ).    ,   <a href=""></a> ,    . <br><br>  ‚Äî  .    TDD         .   ?           ,       100%?!   ,    ‚Äî      .    <code>processTransfer()</code>      ,       ,    . <br><br>             .  ,       <a href=""></a>   ,   . <a href=""></a>    . <br><br><h2>  <font color="#3AC1EF">Sum√°rio</font> </h2><br> , ,  ,     -,      ,      ,  ?     ?   ‚Äî . <br><br>       ,     -.  ,  ¬´¬ª  <code>processTransfer()</code>      .  ,  ,    <a href=""></a> .         ,   ‚Äî .    ,      -       .     ,        ,        . <br><br>     . ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .  ,     <code>StateStorage</code>   <code>WriteKey</code> ,     , , ,     <code>WriteKeys</code>    ,         ,       . <br><br>   ,        :          .            ¬´ ¬ª.       -,        ,  ,     ,    ,      .   ‚Äî     .     ,   ,    ‚Äî      . <br><br>       ,       ‚Äî   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  GitHub.          .  ,   ,    , , ,     ,      . <br><br>  <b>Caros leitores!</b>        ? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413681/">https://habr.com/ru/post/pt413681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413669/index.html">Samsung IT School: ensinando os alunos a desenvolver aplicativos m√≥veis</a></li>
<li><a href="../pt413673/index.html">Sobre a quest√£o do desempenho de vers√µes antigas e novas de um n√≥</a></li>
<li><a href="../pt413675/index.html">Coringa 2018: Clube de desenvolvedores Java an√¥nimos</a></li>
<li><a href="../pt413677/index.html">Lan√ßamento do ROS no rob√¥ de auto balanceamento EduMIP</a></li>
<li><a href="../pt413679/index.html">Angular6. PWA. M√≥dulos de carregamento pregui√ßosos. Implantar automaticamente no Firebase</a></li>
<li><a href="../pt413683/index.html">O ILV desbloqueou 7 milh√µes de endere√ßos IP. Permanecem bloqueados 4 milh√µes</a></li>
<li><a href="../pt413689/index.html">Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</a></li>
<li><a href="../pt413691/index.html">Iniciar</a></li>
<li><a href="../pt413693/index.html">Feito √† m√£o: teclado program√°vel para com√©rcio on-line fa√ßa voc√™ mesmo</a></li>
<li><a href="../pt413695/index.html">Seguran√ßa do Messenger: por que armazenar mensagens na blockchain pode ser uma boa ideia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>