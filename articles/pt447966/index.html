<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👩‍👦‍👦 ✔️ 🧔🏻 Como conectar o GitLab e o Pantheon e otimizar os fluxos de trabalho do Drupal e WordPress 🤴🏿 🙋 👨‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nosso convidado, criador das ferramentas de desenvolvedor Pantheon, fala sobre como automatizar as implantações do WordPress usando o GitLab CI / CD. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como conectar o GitLab e o Pantheon e otimizar os fluxos de trabalho do Drupal e WordPress</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447966/"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p>  Nosso convidado, criador das ferramentas de desenvolvedor Pantheon, fala sobre como automatizar as implantações do WordPress usando o GitLab CI / CD. </p><br><p>  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pantheon,</a> trato de relações com desenvolvedores, por isso estou sempre procurando novas maneiras de ajudar os desenvolvedores do WordPress e Drupal a resolver problemas de automação em seus fluxos de trabalho.  Para fazer isso, gosto de experimentar novas ferramentas e combiná-las para um trabalho eficaz. </p><br><p>  <strong>Costumo ver desenvolvedores atormentados com um único servidor de desenvolvimento.</strong> </p><br><p> Tão divertido - esperar sua vez de usar um servidor ou enviar aos clientes uma URL com uma nota: "Olhe aqui, mas não olhe aqui". </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ambientes de vários níveis</a> - uma das ferramentas legais do Pantheon - resolvem esse problema, pois com eles você pode criar ambientes para as ramificações do Git, mediante solicitação.  Cada ambiente multidev possui seu próprio URL e banco de dados, para que os desenvolvedores trabalhem silenciosamente, verifiquem a qualidade e obtenham aprovação sem pisar no calcanhar um do outro. </p><br><p>  Mas o Pantheon não possui ferramentas para controle de versão ou integração e implantação contínuas (CI / CD).  Mas esta é uma plataforma flexível com a qual você pode integrar qualquer ferramenta. </p><br><p>  <strong>Percebi também que, para o desenvolvimento da equipe, eles usam uma ferramenta e para a montagem e implantação - outras.</strong> </p><br><p>  Por exemplo, eles têm ferramentas diferentes para controle de versão e CI / CD.  Você precisa mexer e alternar entre as ferramentas para editar o código e diagnosticar problemas. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O GitLab</a> possui um conjunto completo de ferramentas de desenvolvimento: para controle de versão, tickets, solicitações de mesclagem, o melhor pipeline de CI / CD da classe, um registro de contêineres e tudo mais.  Não encontrei aplicativos em que houvesse muito para gerenciar o fluxo de trabalho de desenvolvimento. </p><br><p>  Eu amo automação, então aprendi como conectar o Pantheon ao GitLab, para que as confirmações da filial principal do GitLab sejam implantadas no ambiente de desenvolvimento principal do Pantheon.  E as solicitações de mesclagem no GitLab podem criar e implantar código em ambientes multidev no Pantheon. </p><br><p>  Neste guia, mostrarei como configurar uma conexão entre o GitLab e o Pantheon e otimizar seu fluxo de trabalho do WordPress e do Drupal. </p><br><p>  É claro que você pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">espelhar o repositório do GitLab</a> , mas faremos tudo com canetas para cavar no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IC do GitLab</a> e usar essa ferramenta não apenas para implantação no futuro. </p><br><h3 id="vvedenie">  1. Introdução </h3><br><p>  Para este post, você precisa entender que o Pantheon divide cada site em três elementos: código, banco de dados e arquivos. </p><br><p>  O código inclui arquivos CMS, como o kernel, plugins e temas do WordPress.  Esses arquivos são gerenciados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">repositório Git</a> hospedado pelo Pantheon, ou seja, podemos implantar código do GitLab no Pantheon com o Git. <br>  Os arquivos no Pantheon são chamados de arquivos de mídia, ou seja, imagens do site.  Geralmente eles são baixados pelos usuários, e o Git os ignora. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Crie uma conta gratuita</a> , saiba mais sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o fluxo de trabalho da Pantheon</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inscreva-se para uma demonstração</a> em pantheon.io. </p><br><h3 id="predpolozheniya">  Pressupostos </h3><br><p> Meu projeto no Pantheon e no GitLab é chamado <code>pantheon-gitlab-blog-demo</code> .  O nome do projeto deve ser exclusivo.  Aqui vamos trabalhar com o site WordPress.  Você pode tomar Drupal, mas precisará mudar alguma coisa. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usarei a linha de comando Git</a> e você poderá trabalhar na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GUI,</a> se desejar. </p><br><h3 id="sozdaem-proekt">  Crie um projeto </h3><br><p>  Para começar, crie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um projeto GitLab</a> (voltaremos a isso). </p><br><p>  Agora <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">crie um site WordPress no Pantheon</a> .  Em seguida, instale o WordPress no site do painel. </p><br><blockquote>  Se suas mãos coçarem, troque algo, por exemplo, remova e adicione plugins, seja paciente.  O site ainda não está conectado ao GitLab e queremos que todas as alterações de código passem pelo GitLab. </blockquote><p>  Quando instalamos o WordPress, retornamos ao painel do site Pantheon e alteramos o modo de desenvolvimento para Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  Confirmação inicial do GitLab </h3><br><p>  Agora você precisa transferir o código WordPress inicial do site Pantheon para o GitLab.  Para fazer isso, clonamos o código do repositório Git do site Pantheon localmente e o enviamos ao repositório GitLab. </p><br><p>  Para torná-lo mais simples e seguro, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adicionaremos uma chave SSH ao Pantheon</a> e não inseriremos a senha sempre que clonarmos o repositório Pantheon Git.  Ao mesmo tempo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adicionaremos uma chave SSH ao GitLab</a> . </p><br><p>  Para fazer isso, clonamos o site Pantheon localmente, copiando o comando do campo Clone com Git no painel do site. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>Se precisar de ajuda, leia a documentação de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">introdução</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Git para Pantheon</a> .</em> </p><br><p>  Agora mude <code>git remote origin</code> para apontar para o GitLab em vez do Pantheon.  Isso pode ser feito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code> git remote</code></a> . </p><br><p>  Vamos para o projeto GitLab e copie o URL do repositório da lista suspensa Clone na página de detalhes do projeto.  Selecionaremos a opção Clonar com SSH, porque já configuramos a chave SSH. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p>  Por padrão, o <code>git remote</code> para a cópia local do repositório de códigos é <code>origin</code> .  Isso pode ser alterado com a <code>git remote set-url origin [URL  GitLab]</code> , onde, em vez de colchetes, inserimos a URL real. </p><br><p>  Por fim, execute o <code>git push origin master --force</code> para enviar seu código WordPress do Pantheon para o GitLab. </p><br><blockquote>  A opção –force é necessária apenas uma vez.  Então, nos comandos <code>git push</code> no GitLab, não será. </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye">  Configurar credenciais e variáveis </h3><br><p>  Lembre-se de como adicionamos localmente uma chave SSH para efetuar login no Pantheon e no GitLab?  O token SSH pode ser usado para autorizar o GitLab e o Pantheon. </p><br><p>  O GitLab tem uma ótima documentação.  Vamos ver a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">seção sobre chaves SSH ao usar o executor do Docker no documento sobre como usar chaves SSH com o GitLab CI / CD</a> . </p><br><p>  Agora concluiremos as duas primeiras etapas: <em>crie um novo par de chaves SSH localmente com ssh-keygen e adicione a chave privada como uma variável ao projeto</em> . </p><br><p>  Em seguida, definimos <code>SSH_PRIVATE_KEY</code> como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">variável de ambiente</a> <code>SSH_PRIVATE_KEY</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CI / CD</a> nas configurações do projeto. <br>  Na terceira e quarta etapas, crie um <code>.gitlab-ci.yml</code> com o seguinte conteúdo: </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p>  Até confirmarmos o <code>.gitlab-ci.yml</code> , outra coisa precisa ser adicionada a ele. </p><br><p>  Agora, executamos a quinta etapa e <em>adicionamos a chave pública que criamos na primeira etapa aos serviços aos quais você precisa acessar no ambiente de construção</em> . </p><br><p>  No nosso caso, queremos ter acesso ao Pantheon a partir do GitLab.  Siga as instruções no documento Pantheon para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adicionar uma chave SSH ao Pantheon</a> e concluir esta etapa. </p><br><blockquote>  Lembre-se: SSH fechado no GitLab, aberto no Pantheon. </blockquote><p>  Configure mais algumas variáveis ​​de ambiente.  O primeiro é chamado PANTHEON_SITE.  Seu significado é o nome do site Pantheon em sua máquina. </p><br><p>  O nome na máquina é indicado no final do comando Clone com Git.  Você já clonou o site localmente, portanto esse será o nome do diretório do repositório local. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p>  Em seguida, configure a <code>PANTHEON_GIT_URL</code> ambiente <code>PANTHEON_GIT_URL</code> .  Este é o URL do repositório Git para o site Pantheon que já usamos. </p><br><blockquote>  Nós inserimos apenas a URL do repositório SSH, sem o <code>git clone</code> e o nome do site na máquina no final. </blockquote><p>  Fuh.  Feito isso, agora podemos concluir nosso <code>.gitlab-ci.yml</code> . </p><br><h3 id="sozdaem-zadachu-deploya">  Crie uma tarefa de implantação </h3><br><p>  O que faremos inicialmente com o GitLab CI é muito semelhante ao que fizemos anteriormente com os repositórios do Git.  Mas desta vez, adicione o repositório Pantheon como a segunda fonte remota do Git e envie o código do GitLab para o Pantheon. </p><br><p>  Para fazer isso, configure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o estágio de</a> <code>deploy</code> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a tarefa</a> <code>deploy:dev</code> , porque iremos implantar no ambiente de desenvolvimento no Pantheon.  Como resultado, o <code>.gitlab-ci.yml</code> ficará assim: </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p>  As variáveis <code>SSH_PRIVATE_KEY, PANTHEON_SITE</code> e <code>PANTHEON_GIT_URL</code> devem parecer familiares - configuramos essas variáveis ​​de ambiente anteriormente.  Com essas variáveis, podemos usar os valores no <code>.gitlab-ci.yml</code> várias vezes e precisaremos atualizá-los apenas em um único local. </p><br><p>  Por fim, adicione, confirme e <code>.gitlab-ci.yml</code> ao GitLab. </p><br><h3 id="proveryaem-deploy">  Verificar implantar </h3><br><p>  Se fizermos tudo certo, a tarefa <code>deploy:dev</code> terá êxito no IC / CD do <code>.gitlab-ci.yml</code> e enviará o <code>.gitlab-ci.yml</code> ao Pantheon.  Vamos ver </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon">  Enviamos ramos de solicitações de mesclagem ao Pantheon </h3><br><p>  Aqui usaremos meu recurso favorito do Pantheon - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">multidev</a> , onde você pode criar ambientes adicionais do Pantheon para as filiais do Git, mediante solicitação. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O acesso ao multidev é limitado</a> , portanto, esta seção é <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">opcional</a> .  Mas se você tiver acesso, poderá aumentar seriamente a produtividade configurando a criação automática de ambientes multidev no Pantheon a partir de solicitações de mesclagem do GitLab. </p><br><p>  Primeiro, faça uma nova ramificação do Git localmente usando o <code>git checkout -b multidev-support</code> .  Agora, novamente, algo mudará em <code>.gitlab-ci.yml</code> . </p><br><p>  Gosto de indicar o número da solicitação de mesclagem no nome do ambiente do Pantheon.  Por exemplo, a primeira solicitação de mesclagem é <code>mr-1</code> , a segunda é <code>mr-2</code> etc. </p><br><p>  A solicitação de mesclagem está mudando, portanto, precisamos identificar dinamicamente os nomes das ramificações do Pantheon.  No GitLab, isso é simples - você precisa usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">variáveis ​​de ambiente predefinidas</a> . </p><br><p>  Podemos <code>$CI_MERGE_REQUEST_IID</code> para indicar o número da solicitação de mesclagem.  Vamos aplicar tudo isso junto às variáveis ​​de ambiente global que especificamos anteriormente e adicionar uma nova tarefa deploy: multidev no final do <code>.gitlab-ci.yml</code> . </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p>  Será semelhante à nossa tarefa <code>deploy:dev</code> , apenas o ramo é enviado ao Pantheon e não ao <code>master</code> . </p><br><p>  Adicionamos e confirmamos o <code>.gitlab-ci.yml</code> atualizado e agora enviamos uma nova ramificação para o <code>.gitlab-ci.yml</code> ao <code>git push -u origin multidev-support</code> . </p><br><p>  Agora crie uma nova <em>solicitação de mesclagem a</em> partir da ramificação de <code>multidev-support</code> multidev, clicando em <em>Criar solicitação de mesclagem</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p>  Após criar a solicitação de mesclagem, examinamos como a <code>deploy:multidev</code> CI / CD <code>deploy:multidev</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p>  Veja - uma nova filial foi enviada ao Pantheon.  Mas se formos para a seção multidev no painel do site Pantheon, não veremos o novo ambiente lá. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p>  Dê uma olhada na seção Git Branches. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p>  Como resultado, nossa filial <code>mr-1</code> alcançou o Pantheon.  Crie um ambiente a partir da ramificação <code>mr-1</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p>  Criamos um ambiente multidev, e agora voltamos ao GitLab e observamos a seção <em>Operações&gt; Ambientes</em> .  Veremos entradas para <code>dev</code> e <code>mr-1</code> . </p><br><p>  Isso ocorre porque adicionamos uma entrada de <code>environment</code> chamada <code>name</code> e <code>url</code> às tarefas de CI / CD.  Se clicarmos no ícone do ambiente aberto, iremos para a URL do ambiente multidev do Pantheon. </p><br><h3 id="avtomatiziruem-sozdanie-multidev">  Automatize a criação de multidev </h3><br><p>  Em princípio, você pode parar por aqui e lembre-se de criar um ambiente multidev para cada solicitação de mesclagem, mas esse processo pode ser automatizado. </p><br><p>  O Pantheon possui uma ferramenta de linha de comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terminus, na</a> qual você pode trabalhar com a plataforma automaticamente.  No Terminus, você pode criar ambientes multidev a partir da linha de comando - ideal para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitLab CI</a> . </p><br><p>  Precisamos de uma nova solicitação de mesclagem para testá-lo.  Crie uma nova ramificação usando <code>git checkout -b auto-multidev-creation</code> . </p><br><p>  Para usar o Terminus nas tarefas de IC / CD do GitLab, você precisa de um token de máquina para autenticação no Terminus e uma imagem de contêiner com o Terminus. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Crie um token de máquina Pantheon</a> , salve-o em um local seguro e adicione-o como uma variável de ambiente global no GitLab com o nome <code>PANTHEON_MACHINE_TOKEN</code> . </p><br><blockquote>  Se você esqueceu como adicionar variáveis ​​de ambiente GitLab, volte para onde definimos <code>PANTHEON_SITE</code> . </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus">  Criar um Dockerfile com o Terminus </h3><br><p>  Se você não usa o Docker ou não gosta do <code>Dockerfile</code> , pegue minha <code>Dockerfile</code> e pule esta seção. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O GitLab possui um registro de contêiner</a> onde você pode criar e hospedar um Dockerfile para o nosso projeto.  Vamos criar um Dockerfile com o Terminus para trabalhar com o Pantheon. </p><br><p>  Terminus é uma ferramenta de linha de comando no PHP, então vamos começar com a imagem do PHP.  Eu instalo o Terminus através do Composer, então tomo a imagem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">oficial do Docker Composer</a> como base.  Crie um <code>Dockerfile</code> no diretório do repositório local com o seguinte conteúdo: </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p>  Siga as instruções para montar e enviar imagens da seção <em>Compilar e enviar imagens</em> na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação do registro de contêiner</a> para coletar a imagem do <code>Dockerfile</code> e enviá-la ao GitLab. </p><br><p>  Abra a seção <em>Registro</em> no projeto GitLab.  Se tudo correu conforme o planejado, haverá nossa imagem.  Grave o link para a tag da imagem - precisamos dele para o <code>.gitlab-ci.yml</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  A seção de <code>script</code> na <code>deploy:multidev</code> começa a crescer, então vamos movê-la para um arquivo separado.  Crie um novo <code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p>  O script está em um diretório privado e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">não fornece acesso à Web no Pantheon</a> .  Temos um script para nossa lógica multidev.  Vamos agora atualizar a <code>deploy:multidev</code> <code>.gitlab-ci.yml</code> arquivo <code>.gitlab-ci.yml</code> para obter isso: </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Precisamos garantir que nossas tarefas sejam executadas na imagem personalizada criada, portanto, adicionamos a <code>image</code> definição com a URL do registro em <code>.gitlab-ci.yml</code> .  Como resultado, obtivemos o seguinte <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Adicione, confirme e envie <code>private/multidev-deploy.sh</code> <code>.gitlab-ci.yml</code> e <code>.gitlab-ci.yml</code> .  Agora, volte ao GitLab e aguarde a conclusão da tarefa de CI / CD.  Seja paciente: multidev pode demorar alguns minutos. </p><br><p>  Então vamos assistir a lista multidev no Pantheon.  Oh milagre!  O ambiente multidev <code>mr-2</code> já está aqui. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie">  Conclusão </h3><br><p>  Minha equipe ganhou muito mais diversão quando começamos a abrir solicitações de mesclagem e criar ambientes automaticamente. </p><br><p>  Com as poderosas ferramentas GitLab e Pantheon, você pode conectar o GitLab ao Pantheon automaticamente. </p><br><p>  Depois de usarmos o GitLab CI / CD, nosso fluxo de trabalho estará onde crescer.  Aqui estão algumas idéias para começar: </p><br><ul><li>  Adicione uma etapa de construção. </li><li>  Adicione testes automatizados. </li><li>  Adicione uma tarefa para garantir a conformidade com os padrões de código. </li><li>  Adicione <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">testes de segurança de aplicativos dinâmicos</a> . </li></ul><br><p>  Escreva o que você acha do GitLab, Pantheon e automação. </p><br><p>  PS Você sabia que o Terminus, a ferramenta de linha de comando Pantheon, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pode ser expandida através de plugins</a> ? </p><br><p>  No Pantheon, trabalhamos duro na versão 2 do nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plugin para ferramentas de construção Terminus</a> habilitadas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para</a> GitLab.  Se você não quiser mexer nas configurações de cada projeto, tente este plug-in e ajude-nos a testar a versão beta 2.  Para o comando Terminus <code>build:project:create</code> , você precisa apenas do token Pantheon e do token GitLab.  Ela implementará um exemplo de projeto com o Composer e testes automatizados, criará um novo projeto no GitLab, o novo site do Pantheon, e os conectará usando variáveis ​​de ambiente e chaves SSH. </p><br><h3 id="ob-avtore">  Sobre o autor </h3><br><p>  Andrew Taylor cria ferramentas de desenvolvedor no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pantheon</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447966/">https://habr.com/ru/post/pt447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447956/index.html">Comunicações quânticas na ITMO University - um projeto de sistemas de transferência de dados inquebráveis</a></li>
<li><a href="../pt447958/index.html">CJM para falso acionamento do antivírus DrWeb</a></li>
<li><a href="../pt447960/index.html">Veeam Linux Backup no Elbrus OS. Substituição de importação ['?' | '.' | '!']</a></li>
<li><a href="../pt447962/index.html">Os hackers podem controlar remotamente o Tesla Model S usando o sistema de piloto automático</a></li>
<li><a href="../pt447964/index.html">Teste de microcomputador para IoT</a></li>
<li><a href="../pt447968/index.html">Escrita em Rust + CUDA C</a></li>
<li><a href="../pt447970/index.html">Log Javascript super simples - dois decoradores e pronto</a></li>
<li><a href="../pt447976/index.html">Desenvolvimento e montagem de uma lâmpada fotográfica</a></li>
<li><a href="../pt447980/index.html">Por que é imperativo investir e desenvolver um aplicativo de táxi de marca para o seu empreendimento?</a></li>
<li><a href="../pt447982/index.html">Resumo: 10 materiais sobre telas e projetores para home theater</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>