<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüé§ ‚ò£Ô∏è üîé Yuri Bushmelev ¬´Carte de r√¢teau sur le champ de collecte et de livraison des grumes¬ª - transcription du rapport üßëüèº‚Äçü§ù‚Äçüßëüèª üë®‚Äçüî¨ üïî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les journaux sont une partie importante du syst√®me, vous permettant de comprendre qu'il fonctionne (ou ne fonctionne pas), comme pr√©vu. Dans les condi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yuri Bushmelev ¬´Carte de r√¢teau sur le champ de collecte et de livraison des grumes¬ª - transcription du rapport</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450098/"><p>  Les journaux sont une partie importante du syst√®me, vous permettant de comprendre qu'il fonctionne (ou ne fonctionne pas), comme pr√©vu.  Dans les conditions de l'architecture de microservices, le travail avec les journaux devient une discipline distincte d'une Olympiade sp√©ciale.  Vous devez r√©soudre imm√©diatement un tas de questions: </p><br><ul><li>  comment √©crire des journaux √† partir de l'application; </li><li>  o√π √©crire les journaux; </li><li>  comment livrer les journaux pour le stockage et le traitement; </li><li>  comment traiter et stocker les journaux. </li></ul><br><p>  L'utilisation des technologies de conteneurisation, d√©sormais tr√®s r√©pandues, ajoute du sable au sommet du r√¢teau au champ d'options pour r√©soudre le probl√®me. </p><br><p>  Juste √† propos de ce d√©codage du rapport de Yuri Bushmelev "Map rake on the field of collection and delivery of logs" </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/NAeedJv-S3I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Peu importe, s'il vous pla√Æt, sous le chat. </p><a name="habracut"></a><br><p>  Je m'appelle Yuri Bushmelev.  Je travaille chez Lazada.  Aujourd'hui, je vais parler de la fa√ßon dont nous avons fait nos journaux, comment nous les avons collect√©s et ce que nous y √©crivons. </p><br><p><img src="https://habrastorage.org/webt/_9/te/o5/_9teo5cvnhsihs4lyyyc_8pcx-m.png"></p><br><p>  D'o√π venons-nous?  Qui sommes nous  Lazada est la boutique en ligne n ¬∞ 1 dans six pays d'Asie du Sud-Est.  Tous ces pays sont distribu√©s par des centres de donn√©es.  Il y a maintenant 4 centres de donn√©es. Pourquoi est-ce important?  Parce que certaines d√©cisions √©taient dues au fait qu'il existe un lien tr√®s faible entre les centres.  Nous avons une architecture de microservice.  J'ai √©t√© surpris de constater que nous avons d√©j√† 80 microservices.  Lorsque j'ai commenc√© la t√¢che avec les journaux, il n'y en avait que 20. De plus, il y a un h√©ritage PHP assez important, avec lequel vous devez √©galement vivre et supporter.  Tout cela nous g√©n√®re actuellement plus de 6 millions de messages par minute dans l'ensemble du syst√®me.  De plus, je montrerai comment nous essayons de vivre avec et pourquoi. </p><br><p><img src="https://habrastorage.org/webt/gy/fj/du/gyfjduafaipfx1ay5efm8xpwtdc.png"></p><br><p>  Nous devons en quelque sorte vivre avec ces 6 millions de messages.  Que devons-nous en faire?  6 millions de messages dont vous avez besoin: </p><br><ul><li>  envoyer depuis l'application </li><li>  accepter pour la livraison </li><li>  livrer pour analyse et stockage. </li><li>  analyser </li><li>  en quelque sorte stocker. </li></ul><br><p><img src="https://habrastorage.org/webt/vq/kr/yt/vqkrytwk4c_gjs9fza8_zn9hanu.png"></p><br><p>  Lorsque trois millions de messages sont apparus, j'avais √† peu pr√®s le m√™me aspect.  Parce que nous avons commenc√© avec quelques centimes.  Il est clair que les journaux d'application y sont √©crits.  Par exemple, je n'ai pas pu me connecter √† la base de donn√©es, j'ai pu me connecter √† la base de donn√©es, mais je n'ai pas pu lire quelque chose.  Mais en plus de cela, chacun de nos microservices √©crit √©galement un journal d'acc√®s.  Chaque demande arrivant √† un microservice tombe dans le journal.  Pourquoi on fait √ßa?  Les d√©veloppeurs veulent pouvoir tracer.  Dans chaque journal d'acc√®s, il y a un champ traceid, le long duquel une interface sp√©ciale d√©roule davantage la cha√Æne enti√®re et affiche magnifiquement la trace.  Trace montre comment la demande s'est d√©roul√©e, ce qui aide nos d√©veloppeurs √† traiter rapidement les d√©chets non identifi√©s. </p><br><p><img src="https://habrastorage.org/webt/me/fd/7d/mefd7deeshbhsvsjb8n7dh81ok4.png"></p><br><p>  Comment vivre avec √ßa?  Je vais maintenant d√©crire bri√®vement le domaine des options - comment en g√©n√©ral ce probl√®me est r√©solu.  Comment r√©soudre le probl√®me de la collecte, du transfert et du stockage des journaux. </p><br><p><img src="https://habrastorage.org/webt/0m/f8/4r/0mf84rxvsn0ewrqui_4egxgb2hk.png"></p><br><p>  Comment √©crire depuis l'application?  Il est clair qu'il existe diff√©rentes mani√®res.  En particulier, il existe de bonnes pratiques, comme nous le disent les camarades √† la mode.  Il y a une ancienne √©cole sous deux formes, comme l'ont dit les grands-p√®res.  Il existe d'autres moyens. </p><br><p><img src="https://habrastorage.org/webt/le/7-/_n/le7-_n8o7wl8nh4g0qadwz-jucq.png"></p><br><p>  Avec la collecte de journaux sur la m√™me situation.  Il n'y a pas beaucoup d'options pour r√©soudre cette partie particuli√®re.  Il y en a d√©j√† plus, mais pas autant. </p><br><p><img src="https://habrastorage.org/webt/kn/id/o2/knido22_ecpa0cgvfjzissz3fei.png"></p><br><p>  Mais avec la livraison et l'analyse ult√©rieure - le nombre de variations commence √† exploser.  Je ne d√©crirai pas chaque option maintenant.  Je pense que les principales options sont entendues par tous ceux qui √©taient int√©ress√©s par le sujet. </p><br><p><img src="https://habrastorage.org/webt/qu/zg/z0/quzgz0a21pgjdb0o8ek5d3nxmwc.png"></p><br><p>  Je vais montrer comment nous l'avons fait √† Lazada et comment tout a commenc√©. </p><br><p><img src="https://habrastorage.org/webt/tu/b_/xt/tub_xtgrnyznjspm2vxf_lepv7o.png"></p><br><p>  Il y a un an, je suis venu √† Lazada et ils m'ont envoy√© dans un projet sur les grumes.  C'√©tait comme √ßa.  Le journal de l'application a √©t√© √©crit sur stdout et stderr.  Ils ont tout fait √† la mode.  Mais ensuite, les d√©veloppeurs l'ont jet√© hors des flux standard, puis l√†, les sp√©cialistes de l'infrastructure vont le r√©gler d'une mani√®re ou d'une autre.  Entre les sp√©cialistes de l'infrastructure et les d√©veloppeurs, il y a aussi des lib√©rateurs qui ont dit: "euh ... d'accord, enveloppons-les simplement dans un fichier avec un shell, c'est tout."  Et comme tout cela se trouve dans le conteneur, ils l'ont emball√© directement dans le conteneur lui-m√™me, ont t√©l√©charg√© le catalogue √† l'int√©rieur et l'ont mis l√†.  Je pense qu'il est √† peu pr√®s √©vident pour tout le monde ce qui en est ressorti. </p><br><p><img src="https://habrastorage.org/webt/l2/pl/lz/l2pllz5jvccjhbz0zzxcitkrmsk.png"></p><br><p>  Voyons un peu plus loin.  Comment d√©livrons-nous ces journaux?  Quelqu'un a choisi td-agent, qui est en fait couramment, mais pas tout √† fait couramment.  Je ne comprenais toujours pas la relation de ces deux projets, mais ils semblent √™tre √† peu pr√®s la m√™me chose.  Et ce fluentd, √©crit en Ruby, lit les fichiers journaux, les analyse en JSON pour certaines p√©riodes r√©guli√®res.  Puis il les a envoy√©s √† Kafka.  Et dans Kafka pour chaque API, nous avions 4 sujets distincts.  Pourquoi 4?  Parce qu'il y a du live, il y a de la mise en sc√®ne, et parce qu'il y a stdout et stderr.  Les d√©veloppeurs leur donnent naissance et les ing√©nieurs d'infrastructure doivent les cr√©er √† Kafka.  De plus, Kafka √©tait contr√¥l√©e par un autre d√©partement.  Par cons√©quent, il √©tait n√©cessaire de cr√©er un ticket pour qu'ils cr√©ent 4 sujets pour chaque API l√†-bas.  Tout le monde l'a oubli√©.  En g√©n√©ral, il y avait des d√©chets et des fum√©es. </p><br><p><img src="https://habrastorage.org/webt/x9/2-/5s/x92-5sqis-vgly1ccyh0gjt2mxy.png"></p><br><p>  Qu'avons-nous fait ensuite avec √ßa?  Nous l'avons envoy√© √† Kafka.  Plus loin de Kafka, la moiti√© des grumes s'est envol√©e pour Logstash.  L'autre moiti√© des journaux a √©t√© partag√©e.  Une partie a vol√© dans un Graylog, une partie - dans un autre Graylog.  En cons√©quence, tout cela s'est envol√© dans un cluster Elasticsearch.  Autrement dit, tout ce g√¢chis est finalement tomb√© l√†.  Vous n'avez pas √† faire √ßa! </p><br><p><img src="https://habrastorage.org/webt/ge/w9/kz/gew9kzazsmr5pwee16cuyor6n2w.png"></p><br><p>  Voici √† quoi cela ressemble si vous regardez √† distance d'en haut.  Ne fais pas √ßa!  Ici, les chiffres indiquent imm√©diatement les zones √† probl√®me.  Il y en a plus, mais 6 sont vraiment tr√®s probl√©matiques, avec lesquelles vous devez faire quelque chose.  Je vais en parler s√©par√©ment maintenant. </p><br><p><img src="https://habrastorage.org/webt/2w/xu/eb/2wxuebmewhsjvjbr_9taaq5zhn4.png"></p><br><p>  Ici (1,2,3), nous √©crivons des fichiers et, en cons√©quence, voici trois r√¢teaux √† la fois. </p><br><p>  Le premier (1) est que nous devons les √©crire quelque part.  Je ne voudrais pas toujours donner √† l'API la possibilit√© d'√©crire directement dans un fichier.  Il est souhaitable que l'API soit isol√©e dans le conteneur, et encore mieux, qu'elle soit en lecture seule.  Je suis un administrateur syst√®me, j'ai donc une vision l√©g√®rement alternative de ces choses. </p><br><p>  Le deuxi√®me point (2,3) - nous avons beaucoup de demandes venant √† l'API.  L'API √©crit de nombreuses donn√©es dans un fichier.  Les fichiers augmentent.  Nous devons les faire pivoter.  Sinon, il n'y a aucun moyen d'obtenir des disques.  Leur rotation est mauvaise car ils sont redirig√©s via le shell vers un r√©pertoire.  Nous ne pouvons en aucun cas le d√©placer.  On ne peut pas dire √† une application de red√©couvrir les descripteurs.  Parce que les d√©veloppeurs vous regarderont comme un idiot: ¬´Quels sont les descripteurs?  Nous √©crivons g√©n√©ralement √† stdout. ¬ª  Les ing√©nieurs d'infrastructure ont fait copytruncate dans logrotate, qui ne fait qu'une copie du fichier et trankeytit l'original.  En cons√©quence, entre ces processus de copie, l'espace disque se termine g√©n√©ralement. </p><br><p>  (4) Nous avions diff√©rents formats et nous √©tions dans diff√©rentes API.  Ils √©taient l√©g√®rement diff√©rents, mais l'expression rationnelle devait √™tre √©crite diff√©remment.  Comme tout cela √©tait contr√¥l√© par Puppet, il y avait un grand nombre de classes avec leurs cafards.  De plus, td-agent la plupart du temps pouvait manger de la m√©moire, stupide, il pouvait simplement pr√©tendre que cela fonctionnait et ne rien faire.  Dehors, il √©tait impossible de comprendre qu'il ne faisait rien.  Au mieux, il tombera et quelqu'un viendra le chercher plus tard.  Plus pr√©cis√©ment, l'alerte arrivera et quelqu'un passera la main. </p><br><p><img src="https://habrastorage.org/webt/x9/8i/a-/x98ia-rs9owg6hl2qqkfjpza-yg.png"></p><br><p>  (6) Et le plus de d√©chets et de d√©chets - c'√©tait Elasticsearch.  Parce que c'√©tait une ancienne version.  Parce que nous n'avions pas de ma√Ætres d√©di√©s √† cette √©poque.  Nous avions des journaux h√©t√©rog√®nes dans lesquels les champs pouvaient se croiser.  Diff√©rents journaux d'applications diff√©rentes pourraient √™tre √©crits avec les m√™mes noms de champ, mais en m√™me temps, il pourrait y avoir des donn√©es diff√©rentes √† l'int√©rieur.  Autrement dit, un journal est fourni avec Entier dans le champ, par exemple, niveau.  Un autre journal contient String dans le champ de niveau.  En l'absence de cartographie statique, une chose aussi merveilleuse est obtenue.  Si, apr√®s la rotation de l'index dans elasticsearch, le premier message avec une cha√Æne est arriv√©, alors nous vivons normalement.  Et s'il est arriv√© en premier avec Integer, tous les messages ult√©rieurs qui sont arriv√©s avec String sont simplement ignor√©s.  Parce que le type de champ ne correspond pas. </p><br><p><img src="https://habrastorage.org/webt/c9/ym/lq/c9ymlqxv89qg1oohi-lnhknyedg.png"></p><br><p>  Nous avons commenc√© √† poser ces questions.  Nous avons d√©cid√© de ne pas rechercher les coupables. </p><br><p><img src="https://habrastorage.org/webt/fl/r1/kv/flr1kvyks_o2kdciv4pekiwtbiy.png"></p><br><p>  Mais quelque chose doit √™tre fait!  La chose √©vidente est de fixer des normes.  Nous avions d√©j√† des normes.  Nous en avons eu un peu plus tard.  Heureusement, un format de journal uniforme pour toutes les API √©tait d√©j√† approuv√© √† l'√©poque.  Il est inscrit directement dans les normes d'interaction des services.  Par cons√©quent, ceux qui souhaitent recevoir des journaux doivent les √©crire dans ce format.  Si quelqu'un n'√©crit pas de journaux dans ce format, nous ne garantissons rien. </p><br><p>  De plus, je voudrais √©tablir une norme unique pour les m√©thodes d'enregistrement, de livraison et de collecte des journaux.  En fait, o√π les √©crire et comment les livrer.  La situation id√©ale est lorsque les projets utilisent la m√™me biblioth√®que.  Voici une biblioth√®que de journalisation distincte pour Go, il existe une biblioth√®que distincte pour PHP.  Tout le monde que nous avons - tout le monde devrait les utiliser.  Pour le moment, je dirais que nous l'obtenons √† 80%.  Mais certains continuent de manger des cactus. </p><br><p>  Et l√† (sur la diapositive) apparaissait √† peine ¬´SLA pour la livraison de journaux¬ª.  Il n'est pas encore l√†, mais nous y travaillons.  Parce que c'est tr√®s pratique lorsque l'infra dit que si vous √©crivez dans tel ou tel format √† tel ou tel endroit et pas plus de N messages par seconde, alors nous sommes susceptibles de livrer tel ou tel l√†-bas.  Cela soulage un tas de maux de t√™te.  S'il y a un SLA, alors c'est tout simplement merveilleux! </p><br><p><img src="https://habrastorage.org/webt/im/aq/aj/imaqajo2oi-qoyb--oja3i2fnyy.png"></p><br><p>  Comment avons-nous commenc√© √† r√©soudre le probl√®me?  Le r√¢teau principal √©tait avec td-agent.  Il n'√©tait pas clair o√π allaient les journaux.  Sont-ils livr√©s?  Vont-ils?  O√π sont-ils?  Par cons√©quent, le premier √©l√©ment a √©t√© d√©cid√© de remplacer td-agent.  J'ai bri√®vement esquiss√© les options pour le remplacer. </p><br><p>  Fluentd  Premi√®rement, je l'ai rencontr√© lors d'un pr√©c√©dent emploi et il y tombait aussi p√©riodiquement.  Deuxi√®mement, c'est la m√™me chose, seulement de profil. </p><br><p>  Filebeat.  Comment √©tait-ce pratique pour nous?  Le fait qu'il soit en Go, et nous avons beaucoup d'expertise en Go.  En cons√©quence, si cela, nous pourrions en quelque sorte l'ajouter pour nous-m√™mes.  Par cons√©quent, nous ne l'avons pas pris.  De sorte que m√™me aucune tentation ne devait commencer √† le r√©√©crire pour vous-m√™me. </p><br><p>  La solution √©vidente pour le sysadmin est tous les syslogs dans cette quantit√© (syslog-ng / rsyslog / nxlog). </p><br><p>  Ou √©crivez quelque chose de notre c√¥t√©, mais nous l'avons laiss√© tomber, tout comme le battement de fichiers.  Si vous √©crivez quelque chose, il vaut mieux √©crire quelque chose d'utile pour les affaires.  Pour la livraison des journaux, il est pr√©f√©rable de prendre quelque chose de pr√™t. </p><br><p>  Par cons√©quent, le choix se r√©sumait en fait au choix entre syslog-ng et rsyslog.  Il s'est pench√© vers rsyslog simplement parce que nous avions d√©j√† des classes pour rsyslog dans Puppet, et je n'ai trouv√© aucune diff√©rence √©vidente entre eux.  Qu'est-ce que Syslog, qu'est-ce que Syslog?  Oui, quelqu'un a une documentation pire, quelqu'un a mieux.  Il sait comment, et il - d'une mani√®re diff√©rente. </p><br><p><img src="https://habrastorage.org/webt/xl/wg/7y/xlwg7yv4du2k8ktumnmdltwci78.png"></p><br><p>  Et un peu sur rsyslog.  Tout d'abord, c'est cool car il a beaucoup de modules.  Il a RainerScript lisible par l'homme (un langage de configuration moderne).  Le bonus impressionnant est que nous pouvons √©muler le comportement de l'agent td en utilisant ses moyens habituels, et rien n'a chang√© pour les applications.  Autrement dit, nous changeons td-agent en rsyslog, mais nous ne touchons pas √† tout le reste.  Et imm√©diatement, nous obtenons une livraison de travail.  Ensuite, mmnormalize est une chose g√©niale dans rsyslog.  Il vous permet d'analyser les journaux, mais pas d'utiliser Grok et regexp.  Elle cr√©e un arbre de syntaxe abstrait.  Il analyse les journaux approximativement, car le compilateur analyse les codes source.  Cela vous permet de travailler tr√®s rapidement, de consommer peu de CPU et, en g√©n√©ral, c'est tr√®s cool.  Il y a des tonnes d'autres bonus.  Je ne m'arr√™terai pas √† leur sujet. </p><br><p><img src="https://habrastorage.org/webt/tf/6w/c0/tf6wc0eulg65fu-dy64mmkjyr4g.png"></p><br><p>  Rsyslog a encore un tas de d√©fauts.  Ils sont √† peu pr√®s les m√™mes que les bonus.  Les principaux probl√®mes - vous devez √™tre capable de le faire cuire et vous devez s√©lectionner la version. </p><br><p><img src="https://habrastorage.org/webt/p-/2l/l5/p-2ll5-sxmfivl2136kopu1oipi.png"></p><br><p>  Nous avons d√©cid√© d'√©crire des journaux sur le socket Unix.  Et pas dans / dev / log, parce que nous avons de la bouillie dans les journaux syst√®me, il y a du journald dans ce pipeline.  √âcrivons donc sur un socket personnalis√©.  Nous l'attachons √† un ensemble de r√®gles distinct.  Nous n'interf√©rerons pas.  Tout sera transparent et clair.  Nous l'avons donc fait.  Le r√©pertoire avec ces sockets est standardis√© et est transmis √† tous les conteneurs.  Les conteneurs peuvent voir la prise dont ils ont besoin, l'ouvrir et l'√©crire. </p><br><p>  Pourquoi pas un fichier?  Parce que tout le monde a lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article sur Badushechka</a> , qui a essay√© de transf√©rer le fichier vers docker, et il s'est av√©r√© qu'apr√®s avoir red√©marr√© rsyslog, le descripteur de fichier change, et docker perd ce fichier.  Il garde ouvert autre chose, mais pas la m√™me prise o√π ils √©crivent.  Nous avons d√©cid√© que nous contournerions ce probl√®me, et en m√™me temps, nous contournerions le probl√®me de blocage. </p><br><p><img src="https://habrastorage.org/webt/ri/kn/r9/riknr9odspcwgtmywqapeq1htmi.png"></p><br><p>  Rsyslog effectue les actions indiqu√©es sur la diapositive et envoie les journaux soit au relais soit √† Kafka.  Kafka correspond √† l'ancienne.  Relais - J'ai essay√© d'utiliser rsyslog pur pour fournir des journaux.  Sans Message Queue, outils rsyslog standard.  Fondamentalement, cela fonctionne. </p><br><p><img src="https://habrastorage.org/webt/wh/bl/fv/whblfvj4lnbmdryfev1fypctp74.png"></p><br><p>  Mais il y a des nuances avec la fa√ßon de les entasser plus tard dans cette partie (Logstash / Graylog / ES).  Cette partie (rsyslog-rsyslog) est utilis√©e entre les centres de donn√©es.  Voici un lien TCP compress√©, qui vous permet d'√©conomiser de la bande passante et, par cons√©quent, d'augmenter en quelque sorte la probabilit√© que nous recevions une sorte de journaux d'un autre centre de donn√©es dans des conditions o√π le canal est plein.  Parce que nous avons l'Indon√©sie, o√π tout va mal.  C'est l√† que se situe ce probl√®me constant. </p><br><p><img src="https://habrastorage.org/webt/zx/bx/gi/zxbxgimmd3xniduuuw0spq0vg1o.png"></p><br><p>  Nous avons r√©fl√©chi √† la fa√ßon dont nous surveillons r√©ellement, avec quelle probabilit√© les journaux que nous avons enregistr√©s √† partir de l'application atteignent-ils cette fin?  Nous avons d√©cid√© d'obtenir les m√©triques.  Rsyslog a son propre module de collecte de statistiques, qui a une sorte de compteurs.  Par exemple, il peut vous montrer la taille de la file d'attente ou le nombre de messages re√ßus lors d'une telle action.  Quelque chose peut d√©j√† leur √™tre retir√©.  De plus, il a des compteurs personnalis√©s qui peuvent √™tre configur√©s et il vous montrera, par exemple, le nombre de messages que certaines API ont √©crit.  Ensuite, j'ai √©crit rsyslog_exporter en Python, et nous avons tout envoy√© √† Prom√©th√©e et trac√©.  Les m√©triques de Graylog voulaient vraiment, mais jusqu'√† pr√©sent, nous n'avons pas eu le temps de les configurer. </p><br><p><img src="https://habrastorage.org/webt/kq/b0/-1/kqb0-1ox3sevtkje8qnb7ekp1is.png"></p><br><p>  Quels sont les probl√®mes?  Des probl√®mes sont survenus avec le fait que nous avons d√©couvert (SOUDEMENT!) Que nos API Live √©crivent 50 000 messages par seconde.  Il s'agit uniquement d'une API en direct sans mise en sc√®ne.  Et Graylog nous montre seulement 12 mille messages par seconde.  Et une question raisonnable s'est pos√©e, mais o√π sont les restes?  D'o√π nous avons conclu que Graylog ne peut tout simplement pas faire face.  Ils ont regard√©, et, en effet, Graylog avec Elasticsearch ne ma√Ætrisait pas ce flux. </p><br><p>  De plus, d'autres d√©couvertes que nous avons faites au cours du processus. </p><br><p>  L'√©criture sur le socket est bloqu√©e.  Comment est-ce arriv√©?  Lorsque j'ai utilis√© rsyslog pour la livraison, √† un moment donn√©, notre canal entre les centres de donn√©es s'est rompu.  La livraison s'est lev√©e √† un endroit, la livraison s'est lev√©e √† un autre endroit.  Tout cela est arriv√© √† une machine avec des API qui √©crivent dans le socket rsyslog.  Il y avait une file d'attente.  Ensuite, la file d'attente pour l'√©criture sur le socket Unix a √©t√© remplie, ce qui par d√©faut est de 128 paquets.  Et la prochaine √©criture () dans l'application est bloqu√©e.  Lorsque nous avons examin√© la biblioth√®que que nous utilisons dans les applications sur Go, il a √©t√© √©crit que l'√©criture dans le socket se produit en mode non bloquant.  Nous √©tions s√ªrs que rien ne bloquait.  Parce que nous avons lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article sur Badushechka</a> qui a √©crit √† ce sujet.  Mais il y a un moment.  Autour de cet appel, il y avait toujours un cycle sans fin dans lequel une tentative √©tait constamment faite pour pousser le message dans la prise.  Nous ne l'avons pas remarqu√©.  J'ai d√ª r√©√©crire la biblioth√®que.  Depuis lors, il a chang√© plusieurs fois, mais maintenant nous nous sommes d√©barrass√©s des verrous dans tous les sous-syst√®mes.  Par cons√©quent, vous pouvez arr√™ter rsyslog et rien ne tombera. </p><br><p>  Il est n√©cessaire de surveiller la taille des files d'attente, ce qui permet de ne pas marcher sur ce r√¢teau.  Premi√®rement, nous pouvons surveiller quand nous commen√ßons √† perdre des messages.  Deuxi√®mement, nous pouvons contr√¥ler qu'en principe nous avons des probl√®mes de livraison. </p><br><p>  Et un autre moment d√©sagr√©able - une amplification 10 fois dans une architecture de microservices - c'est tr√®s facile.  Nous n'avons pas beaucoup de demandes entrantes, mais √† cause du graphique que ces messages parcourent, √† cause des journaux d'acc√®s, nous augmentons vraiment la charge sur les journaux environ une fois sur dix.  Malheureusement, je n'ai pas eu le temps de calculer les chiffres exacts, mais les microservices - ils le sont.  Il faut garder cela √† l'esprit.  Il s'av√®re qu'√† l'heure actuelle, le sous-syst√®me de collecte de journaux est le plus charg√© dans Lazada. </p><br><p><img src="https://habrastorage.org/webt/6a/fd/mi/6afdmitt6iid3yqd6cmdgq8_lkq.png"></p><br><p>  Comment r√©soudre le probl√®me elasticsearch?  Si vous devez obtenir rapidement les journaux en un seul endroit, afin de ne pas ex√©cuter sur toutes les machines et de ne pas les collecter l√†-bas, utilisez le stockage de fichiers.  Cela est garanti de fonctionner.  Il est fabriqu√© √† partir de n'importe quel serveur.  Il vous suffit d'y coller les disques et de mettre syslog.  Apr√®s cela, vous √™tes assur√© d'avoir tous les journaux en un seul endroit.  De plus, il sera d√©j√† possible d'ajuster lentement elasticsearch, graylog, autre chose.  Mais vous aurez d√©j√† tous les journaux et, de plus, vous pourrez les stocker dans un nombre suffisant de baies de disques. </p><br><p><img src="https://habrastorage.org/webt/cx/1d/g3/cx1dg33kkvufonoxpwrrpmmabza.png"></p><br><p>  Au moment de mon rapport, le circuit a commenc√© √† ressembler √† ceci.  Nous avons pratiquement arr√™t√© d'√©crire dans le fichier.  Maintenant, tr√®s probablement, nous d√©sactiverons les restes.  Sur les machines locales ex√©cutant l'API, nous arr√™terons d'√©crire dans les fichiers.  Tout d'abord, il existe un stockage de fichiers qui fonctionne tr√®s bien.  Deuxi√®mement, la place sur ces machines est constamment √©puis√©e, il est n√©cessaire de la surveiller en permanence. </p><br><p>  Cette partie avec Logstash et Graylog, √ßa monte vraiment.  Par cons√©quent, nous devons nous en d√©barrasser.  Vous devez choisir une chose. </p><br><p><img src="https://habrastorage.org/webt/w4/bj/po/w4bjpoxgbdggewegwtrg1ao9mpi.png"></p><br><p>  Nous avons d√©cid√© de jeter Logstash et Kibana.  Parce que nous avons un service de s√©curit√©.  Quelle est la connexion?  La connexion est que Kibana sans X-Pack et sans Shield ne permet pas de diff√©rencier les droits d'acc√®s aux journaux.  Par cons√©quent, ils ont pris Graylog.  Il a tout.  Je ne l'aime pas, mais √ßa marche.  Nous avons achet√© du fer neuf, y avons mis du Graylog frais et d√©plac√© tous les journaux aux formats stricts dans un Graylog distinct.  Nous avons r√©solu le probl√®me avec diff√©rents types de domaines identiques sur le plan organisationnel. </p><br><p><img src="https://habrastorage.org/webt/cn/hr/41/cnhr41tyx4sf0c0skbjqrgbyb90.png"></p><br><p>  Ce qui est exactement inclus dans le nouveau Graylog.  Nous venons de tout enregistrer dans le docker.  Nous avons pris un tas de serveurs, d√©ploy√© trois instances Kafka, 7 serveurs Graylog version 2.3 (parce que je voulais Elasticsearch version 5).      HDD .  indexing rate  100    .    140    . </p><br><p><img src="https://habrastorage.org/webt/wv/yd/yj/wvydyj9d_mfo3xztj9elcbvpdaa.png"></p><br><p>   !     .    6  .   Graylog   . -   . </p><br><p><img src="https://habrastorage.org/webt/xf/2j/lc/xf2jlclf52i3oi3nsxdksth-xpe.png"></p><br><p>    .      SSD.        .     160   .      ,   ,       . </p><br><p><img src="https://habrastorage.org/webt/bn/ck/ss/bnckssznjbmcrm7v4zh7yhgoltw.png"></p><br><p>       .  , ,  , , high availability.     .    ,       .   ,   failover  . </p><br><p>    Graylog. </p><br><p>  rate limit    ,    API,    bandwidth   . </p><br><p>  ,  - SLA c ,      .    ,  . </p><br><p>   . </p><br><p><img src="https://habrastorage.org/webt/cc/hr/az/cchrazzrhareykxd78meljitrso.png"></p><br><p> ,  ,   . -, . -, syslog ‚Äî . -, rsyslog    ,    .     . </p><br><p> <strong></strong> . </p><br><p> <strong></strong> :  -   ‚Ä¶ (filebeat?) </p><br><p> <strong></strong> :    .   .    API     ,        ,      .    pipe.     : ¬´   ,     , ¬ª?    ,   ,  : ¬´ ,      ¬ª. </p><br><p> <strong></strong> :        HDFS? </p><br><p> <strong></strong> :   .      , , ,       ,       long term solution. </p><br><p> <strong></strong> :      . </p><br><p> <strong></strong> :   .  ""  . </p><br><p> <strong></strong> :    rsyslog.    TCP,  UDP.   UDP,      ? </p><br><p> <strong></strong> :   . ,    ,      .  ,     : ¬´       ,      -   ,  - ¬ª,    ¬´!        ,     ,          ,       .¬ª         .    ,     ?        ,     ?   best effort.           ,     100% .       .       . </p><br><p> <strong></strong> :  API  -       ,       ,         ? -   . </p><br><p> <strong></strong> :  ,      .     .         ,       .    ,   API     .   rsyslog    .   API    ,     ,    timestamp      .      Graylog,      timestamp.    . </p><br><p> <strong></strong> : Timestamp    . </p><br><p> <strong></strong> : Timestamp   API.  , ,  .    NTP. API  timestamp    .   rsyslog . </p><br><p> <strong></strong> :      .       , .     ?      ? </p><br><p> <strong></strong> : .       -  .       ,        .     .     Log Relay.  Rsyslog .      .   .         .    .        .   ,       (),       Graylog.        storage.  ,     ,     .   .    . </p><br><p> <strong></strong> :       ? </p><br><p> <strong></strong> :    (  )  . </p><br><p> <strong></strong> :    ,     ? </p><br><p> <strong></strong> :      ,    .    .  ,   Go API,  .   ,        socket.       .   .        socket.   ,    .      .     ,    .      prometheus,   Grafana   .   .   ,   . </p><br><p> <strong></strong> :  elasticsearch     .    ? </p><br><p> <strong></strong> :  . </p><br><p> <strong></strong> :    ? </p><br><p> <strong></strong> :    .     . </p><br><p> <strong></strong> :   rsyslog  - ? </p><br><p> <strong></strong> :      unix socket.       128 .       .     .     ,   128 . , , ,   ,   .        ,          .         . </p><br><p> <strong>c</strong> :     JSON? </p><br><p> <strong></strong> :  JSON      relay,     .    Graylog,     JSON .    ,   ,       rsyslog.      issue,     . </p><br><p> <strong>c</strong> :  Kafka?   RabbitMQ?   Graylog   ? </p><br><p> <strong></strong> :    Graylog  .  Graylog   .    .   . ,   ,   .      rsyslog   elasticsearch    Kibana.      .     ,    Graylog    Kibana. Logstash    .  ,        rsyslog.         elasticsearch.  Graylog   - .     .       . </p><br><p>  Kafka.   .   ,   ,      .          .   ,  ,    .  RabbitMQ‚Ä¶     c RabbitMQ.  RabbitMQ   .     ,     .      ,     .           .    . Graylog    AMQP 0.9,  rsyslog    AMQP 1.0.     ,     ,  .     .      Kafka.     .   omkafka   rsyslog,   ,      ,     rsyslog.     . </p><br><p> <strong>Question</strong> : Utilisez-vous Kafka parce que vous en aviez?  Pas utilis√© √† d'autres fins? </p><br><p>  <strong>R√©ponse</strong> : Kafka, qui a √©t√© utilis√© par l'√©quipe Data Sience.  Il s'agit d'un projet compl√®tement distinct, sur lequel, malheureusement, je ne peux rien dire.  Je ne sais pas.  Elle √©tait dirig√©e par l'√©quipe Data Science.  Lorsque les journaux ont commenc√©, ils ont d√©cid√© de l'utiliser pour ne pas mettre le leur.  Nous avons maintenant mis √† jour Graylog et nous avons perdu la compatibilit√©, car il existe une ancienne version de Kafka.  Nous devions acheter le n√¥tre.  En m√™me temps, nous nous sommes d√©barrass√©s de ces quatre sujets pour chaque API.  Nous avons cr√©√© un sujet large pour tous en direct, un sujet large pour toutes les mises en sc√®ne et simplement tout y faire.  Graylog ratisse tout cela en parall√®le. </p><br><p>  <strong>Question</strong> : Pourquoi ce chamanisme avec des prises est-il n√©cessaire?  Avez-vous essay√© d'utiliser le pilote de journal syslog pour les conteneurs? </p><br><p>  <strong>R√©ponse</strong> : Au moment o√π nous avons pos√© cette question, nous avions une relation tendue avec le docker.  C'√©tait docker 1.0 ou 0.9.  Docker lui-m√™me √©tait bizarre.  Deuxi√®mement, si vous y enfoncez √©galement les journaux ... J'ai une suspicion non v√©rifi√©e qu'il passe tous les journaux par lui-m√™me, via le d√©mon docker.  Si nous avons une API qui devient folle, les autres API sont bloqu√©es dans le fait qu'elles ne peuvent pas envoyer stdout et stderr.  Je ne sais pas o√π cela m√®nera.  J'ai une suspicion au niveau du sentiment que vous n'avez pas besoin d'utiliser le pilote docker syslog √† cet endroit.  Notre d√©partement de tests fonctionnels poss√®de son propre cluster Graylog avec journaux.  Ils utilisent des pilotes de journal docker et tout semble bien se passer l√†-bas.  Mais ils √©crivent imm√©diatement GELF √† Graylog.  Nous, √† ce moment o√π tout cela √©tait en place, nous en avions besoin pour fonctionner.  Peut-√™tre plus tard, quand quelqu'un viendra et dira qu'il fonctionne normalement depuis cent ans, nous essaierons. </p><br><p>  <strong>Question</strong> : Vous effectuez la livraison entre les centres de donn√©es sur rsyslog.  Pourquoi pas √† Kafka? </p><br><p>  <strong>R√©ponse</strong> : Nous faisons les deux, et donc en r√©alit√©.  Pour deux raisons.  Si le canal est compl√®tement mort, nous avons tous les journaux, m√™me sous forme compress√©e, nous ne l'explorerons pas.  Et la kafka leur permet simplement de se perdre dans le processus.  De cette fa√ßon, nous nous d√©barrassons de coller ces journaux.  Nous utilisons simplement Kafka dans ce cas directement.  Si nous avons un bon canal et que nous voulons le lib√©rer, alors nous utilisons leur rsyslog.  Mais en fait, vous pouvez le configurer pour qu'il supprime lui-m√™me ce qui n'a pas ramp√©.  Pour le moment, nous utilisons simplement la livraison rsyslog directement, quelque part Kafka. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450098/">https://habr.com/ru/post/fr450098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450088/index.html">Comment dessiner des illustrations pour des r√©sum√©s math√©matiques dans Inkscape</a></li>
<li><a href="../fr450090/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 457 (04.16.2019-22.04.2019)</a></li>
<li><a href="../fr450092/index.html">Qu'est-ce que quoi et qui est qui sur le march√© de la protection DDoS</a></li>
<li><a href="../fr450094/index.html">Caf√© solaire: augmenter l'efficacit√© des cellules solaires gr√¢ce √† la caf√©ine</a></li>
<li><a href="../fr450096/index.html">Toilette chat automatique</a></li>
<li><a href="../fr450100/index.html">G√©n√©ration de code pour le backend. Que g√©n√©rer, comment et pourquoi?</a></li>
<li><a href="../fr450102/index.html">Montre √† r√©glage automatique avec affichage √©lectronique</a></li>
<li><a href="../fr450104/index.html">Tr√®s difficile et tr√®s int√©ressant: les communaut√©s informatiques sur TechTrain</a></li>
<li><a href="../fr450106/index.html">Le projet d'organisation de la construction et de la reconstruction dans des conditions exigu√´s sur le chantier SPDS</a></li>
<li><a href="../fr450110/index.html">Brevets de conception: deuxi√®me partie (exemples de Microsoft, Snapchat, Samsung, Netflix, Airbnb, Tinder)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>