<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëêüèº üêà ü§üüèæ Novo no SObjectizer-5.5.23: realiza√ß√£o de desejos ou caixa de Pandora? üêØ üë¨ ‚ÜòÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo √© uma continua√ß√£o de um artigo de reflex√£o publicado h√° um m√™s: " √â f√°cil adicionar novos recursos √† estrutura antiga? A agonia da escolha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Novo no SObjectizer-5.5.23: realiza√ß√£o de desejos ou caixa de Pandora?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426983/"><img src="https://habrastorage.org/webt/kt/xf/7o/ktxf7oduhnd0zuhd_tpaju7p_em.jpeg"><br><br>  Este artigo √© uma continua√ß√£o de um artigo de reflex√£o publicado h√° um m√™s: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√â f√°cil adicionar novos recursos √† estrutura antiga? A agonia da escolha baseada no exemplo do desenvolvimento do SObjectizer</a> ".  Esse artigo descreveu a tarefa que quer√≠amos resolver na pr√≥xima vers√£o do SObjectizer, examinou duas abordagens para sua solu√ß√£o e listou as vantagens e desvantagens de cada uma das abordagens. <br><br>  Com o passar do tempo, uma das abordagens foi implementada e novas vers√µes do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SObjectizer</a> , bem como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto</a> anexo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">so_5_extra</a> , j√° chamado de " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">respirar profundamente</a> ".  Voc√™ pode literalmente pegar e tentar. <br><br>  Hoje falaremos sobre o que foi feito, por que foi feito, o que levou a isso.  Se algu√©m estiver interessado em acompanhar o desenvolvimento de uma das poucas estruturas de atores ao vivo, de plataforma cruzada e de plataforma aberta para C ++, voc√™ √© bem-vindo ao gato. <br><a name="habracut"></a><br><h1>  Como tudo come√ßou? </h1><br>  Tudo come√ßou com uma tentativa de resolver o problema do cancelamento garantido de temporizadores.  A ess√™ncia do problema √© que, quando uma mensagem peri√≥dica ou atrasada √© enviada, o programador pode cancelar a entrega da mensagem.  Por exemplo: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> timer_id = so_5::send_periodic&lt;my_message&gt;(my_agent, <span class="hljs-number"><span class="hljs-number">10</span></span>s, <span class="hljs-number"><span class="hljs-number">10</span></span>s, ...); ... <span class="hljs-comment"><span class="hljs-comment">// - . // ,    my_message    . timer_id.release(); //      my_message.</span></span></code> </pre> <br>  Depois de chamar <i>timer_id.release (), o</i> timer n√£o enviar√° mais novas inst√¢ncias da mensagem my_message.  Mas as c√≥pias que j√° foram enviadas e est√£o na fila de destinat√°rios n√£o ser√£o levadas a lugar algum.  Com o tempo, eles ser√£o extra√≠dos dessas mesmas filas e transferidos para os agentes destinat√°rios para processamento. <br><br>  Esse problema √© uma conseq√º√™ncia dos princ√≠pios b√°sicos de opera√ß√£o do SObjectizer-5 e n√£o possui uma solu√ß√£o simples, pois o SObjectizer n√£o pode extrair mensagens das filas.  N√£o √© poss√≠vel porque as filas no SObjectizer pertencem a despachantes, despachantes s√£o diferentes, suas filas tamb√©m s√£o organizadas de maneira diferente.  Inclusive, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">existem despachantes que n√£o fazem parte do SObjectizer</a> e o SObjectizer, em princ√≠pio, n√£o pode saber como esses despachantes funcionam. <br><br>  Em geral, existe esse recurso nos temporizadores nativos do SObjectizer.  N√£o que isso estrague demais os desenvolvedores.  Mas alguns cuidados extras devem ser tomados.  Especialmente para iniciantes que est√£o apenas se familiarizando com a estrutura. <br><br>  E ent√£o, finalmente, as m√£os chegaram ao ponto de propor uma solu√ß√£o para esse problema. <br><br><h1>  Qual caminho da solu√ß√£o foi escolhido? </h1><br>  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> , duas op√ß√µes poss√≠veis foram consideradas.  A primeira op√ß√£o n√£o exigiu modifica√ß√µes no mecanismo de entrega de mensagens no SObjectizer, mas exigiu que o programador alterasse explicitamente o tipo de mensagem enviada / recebida. <br><br>  A segunda op√ß√£o exigia a modifica√ß√£o do mecanismo de entrega de mensagens do SObjectizer.  Foi esse caminho escolhido, pois permitiu ocultar do destinat√°rio da mensagem o fato de que a mensagem foi enviada de alguma maneira espec√≠fica. <br><br><h2>  O que mudou no SObjectizer? </h2><br><h3>  Novo conceito: envelope com mensagem dentro </h3><br>  O primeiro componente da solu√ß√£o implementada √© a adi√ß√£o de um conceito como um envelope ao SObjectizer.  Um envelope √© uma mensagem especial, dentro da qual est√° a mensagem atual (carga √∫til).  O SObjectizer entrega o envelope com a mensagem ao destinat√°rio quase da maneira usual.  A diferen√ßa fundamental no processamento de envelopes √© detectada apenas no √∫ltimo est√°gio de entrega: <br><br><ul><li>  na entrega de uma mensagem regular, o agente destinat√°rio simplesmente procura um manipulador para esse tipo de mensagem e, se esse manipulador for encontrado, o manipulador encontrado ser√° chamado e a mensagem entregue retornar√° como par√¢metro; </li><li>  e ap√≥s a entrega do envelope com a mensagem ap√≥s a localiza√ß√£o do manipulador, primeiro √© feita uma tentativa de tirar a mensagem do envelope.  E somente se o envelope fornecer a mensagem armazenada nele, somente o manipulador ser√° chamado. </li></ul><br>  Existem dois pontos principais aqui que t√™m um grande impacto sobre o porqu√™ e como os envelopes de mensagens podem ser usados. <br><br>  O primeiro ponto importante √© que uma mensagem √© solicitada a partir de um envelope somente quando um manipulador de mensagem √© encontrado no destinat√°rio.  I.e.  somente quando a mensagem realmente foi entregue ao destinat√°rio e o destinat√°rio estar√° aqui e agora processar√° essa mensagem. <br><br>  O segundo ponto-chave aqui √© que o envelope pode n√£o revelar a mensagem.  Ou seja, por exemplo, um envelope pode verificar o hor√°rio atual e decidir que todas as datas de entrega foram perdidas e, portanto, a mensagem deixou de ser relevante e n√£o pode ser processada.  Portanto, o envelope n√£o dar√° a mensagem.  Assim, o SObjectizer simplesmente ignorar√° esse envelope e n√£o executar√° nenhuma a√ß√£o adicional. <br><br><h4>  Como √© um envelope? </h4><br>  Um envelope √© uma implementa√ß√£o da interface envelope_t, definida da seguinte maneira: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SO_5_TYPE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">envelope_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">message_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ... <span class="hljs-comment"><span class="hljs-comment">// -. //   ,       //    . virtual void handler_found_hook( handler_invoker_t &amp; invoker ) noexcept = 0; //   ,      //     . virtual void transformation_hook( handler_invoker_t &amp; invoker ) noexcept = 0; private : kind_t so5_message_kind() const noexcept override { return kind_t::enveloped_msg; } };</span></span></code> </pre> <br>  I.e.  Um envelope √© essencialmente a mesma mensagem que todos os outros.  Mas com um atributo especial, retornado pelo m√©todo so5_message_kind (). <br><br>  O programador pode desenvolver seus envelopes herdando de envelope_t (ou, mais convenientemente, de <a href="">so_5 :: extra :: enveloped_msg :: just_envelope_t</a> ) e substituindo os m√©todos de gancho handler_found_hook () e transform_hook (). <br><br>  Dentro dos m√©todos do gancho, o desenvolvedor do envelope decide se deseja enviar a mensagem dentro do envelope para processamento / transforma√ß√£o ou n√£o.  Se ele quiser, o desenvolvedor deve chamar o m√©todo invoke () e o objeto invoker.  Se ele n√£o quiser, n√£o liga. Nesse caso, o envelope e seu conte√∫do ser√£o ignorados. <br><br><h4>  Como os envelopes resolvem o problema de cancelar temporizadores? </h4><br>  A solu√ß√£o, que agora √© implementada em so_5_extra na forma do namespace so_5 :: extra :: revocable_timer, √© muito simples: quando uma mensagem peri√≥dica ou pendente √© enviada especialmente, um envelope especial √© criado, dentro do qual est√° localizada n√£o apenas a mensagem em si, mas tamb√©m a bandeira at√¥mica revogada.  Se esse sinalizador estiver limpo, a mensagem ser√° considerada relevante.  Se definida, a mensagem √© considerada retirada. <br><br>  Quando o m√©todo do gancho √© chamado no envelope, o envelope verifica o valor do sinalizador revogado.  Se o sinalizador estiver definido, o envelope n√£o enviar√° uma mensagem.  Portanto, a mensagem n√£o √© processada, mesmo que o timer j√° tenha conseguido colocar a mensagem na fila do destinat√°rio. <br><br><h3>  Extens√£o da interface abstract_message_box_t </h3><br>  Adicionar a interface envelope_t √© apenas uma parte da implementa√ß√£o de envelopes no SObjectizer.  A segunda parte est√° levando em considera√ß√£o o fato da exist√™ncia de envelopes no mecanismo de entrega de mensagens dentro do SObjectizer. <br><br>  Aqui, infelizmente, n√£o poderia deixar de tornar as altera√ß√µes vis√≠veis para o usu√°rio.  Em particular, na classe abstract_message_box_t, que define a interface de todas as caixas de correio no SObjectizer, foi necess√°rio adicionar outro m√©todo virtual: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_deliver_enveloped_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::type_index &amp; msg_type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_ref_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> overlimit_reaction_deep )</span></span></span></span>;</code> </pre> <br>  Este m√©todo √© respons√°vel por entregar um envelope de mensagem com uma mensagem do tipo msg_type ao destinat√°rio.  Essa entrega pode diferir nos detalhes da implementa√ß√£o, dependendo do tipo de mbox que √©. <br><br>  Ao adicionar do_deliver_enveloped_msg () a abstract_message_box_t, tivemos uma op√ß√£o: torn√°-lo um m√©todo virtual puro ou oferecer algum tipo de implementa√ß√£o padr√£o. <br><br>  Se torn√°ssemos do_deliver_enveloped_msg () um m√©todo virtual puro, quebrar√≠amos a compatibilidade entre as vers√µes do SObjectizer na ramifica√ß√£o 5.5.  Afinal, os usu√°rios que escreveram suas pr√≥prias implementa√ß√µes de mbox teriam que modificar suas pr√≥prias mboxes ao mudar para o SObjectizer-5.5.23; caso contr√°rio, n√£o seriam capazes de compilar com a nova vers√£o do SObjectizer. <br><br>  Como n√£o quer√≠amos isso, n√£o transformamos do_deliver_enveloped_msg () em um m√©todo virtual puro na v.5.5.23.  Ele tem uma implementa√ß√£o padr√£o que apenas lan√ßa uma exce√ß√£o.  Assim, o usu√°rio mbox-s personalizado poder√° continuar trabalhando normalmente com mensagens regulares, mas se recusar√° automaticamente a aceitar envelopes.  Achamos esse comportamento mais aceit√°vel.  Al√©m disso, no est√°gio inicial, √© improv√°vel que os envelopes com mensagens sejam amplamente utilizados e √© improv√°vel que nas implementa√ß√µes personalizadas "selvagens" das mboxes SObjectizer sejam frequentemente encontradas;) <br><br>  Al√©m disso, existe uma chance zero de que nas vers√µes principais subsequentes do SObjectizer, onde n√£o veremos a compatibilidade com a ramifica√ß√£o 5.5, a interface abstract_message_box_t sofra grandes mudan√ßas.  Mas j√° estamos nos adiantando ... <br><br><h2>  Como enviar envelopes com mensagens </h2><br>  O SObjectizer-5.5.23 em si n√£o fornece um meio simples de enviar envelopes.  Sup√µe-se que um tipo espec√≠fico de envelope e ferramentas apropriadas estejam sendo desenvolvidas para uma tarefa espec√≠fica para enviar convenientemente envelopes de um tipo espec√≠fico.  Um exemplo disso pode ser visto em <a href="">so_5 :: extra :: revocable_timer</a> , onde voc√™ precisa n√£o apenas enviar o envelope, mas tamb√©m fornecer ao usu√°rio um timer_id especial. <br><br>  Para situa√ß√µes mais simples, voc√™ pode usar as ferramentas de <a href="">so_5 :: extra :: enveloped_msg</a> .  Por exemplo, √© assim que uma mensagem √© enviada com uma determinada restri√ß√£o no momento da entrega: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// make     . so_5::extra::enveloped_msg::make&lt;my_message&gt;(... /*    */) // envelope         . //  5s        . .envelope&lt;so_5::extra::enveloped_msg::time_limited_delivery_t&gt;(5s) //        . .send_to(destination);</span></span></code> </pre> <br><h2>  Para tornar tudo divertido: envelopes em envelopes </h2><br>  Os envelopes foram projetados para transportar algumas mensagens dentro de si.  Mas quais? <br><br>  Qualquer. <br><br>  E isso nos leva a uma pergunta interessante: √© poss√≠vel colocar um envelope dentro de outro envelope? <br><br>  Sim voc√™ pode.  Tanto quanto voc√™ quiser.  A profundidade de aninhamento √© limitada apenas pelo senso comum do desenvolvedor e pela profundidade da pilha para a chamada recursiva handler_found_hook / transform_hook. <br><br>  Ao mesmo tempo, o SObjectizer vai para os desenvolvedores de seus pr√≥prios envelopes: o envelope n√£o deve pensar no que est√° dentro dele - uma mensagem espec√≠fica ou outro envelope.  Quando o m√©todo hook √© chamado no envelope e o envelope decide que pode fornecer seu conte√∫do, o envelope simplesmente chama invoke () em handler_invoker_t e passa um link para seu conte√∫do em invoke ().  E j√° invoke () por dentro descobrir√° com o que est√° lidando.  E se esse for outro envelope, invoke () chamar√° o m√©todo de gancho necess√°rio nesse envelope. <br><br>  Usando o kit de ferramentas mostrado acima em so_5 :: extra :: enveloped_msg, o usu√°rio pode criar v√°rios envelopes aninhados como este: <br><br><pre> <code class="cpp hljs">so_5::extra::enveloped_msg::make&lt;my_message&gt;(...) <span class="hljs-comment"><span class="hljs-comment">// ,        my_message. .envelope&lt;inner_envelope_type&gt;(...) // ,      inner_envelope_type. .envelope&lt;outer_envelope_type&gt;(...) .send_to(destination);</span></span></code> </pre> <br><h1>  Alguns exemplos de uso de envelopes </h1><br>  Agora, depois de examinarmos as partes internas do SObjectizer-5.5.23, √© hora de passar para a parte mais √∫til do aplicativo para os usu√°rios.  Abaixo est√£o alguns exemplos que s√£o baseados no que j√° est√° implementado em so_5_extra ou usam as ferramentas de so_5_extra. <br><br><h2>  Temporizadores revog√°veis </h2><br>  Como toda essa cozinha com envelopes foi concebida para resolver o problema da recupera√ß√£o garantida de mensagens temporizadas, vamos ver o que aconteceu no final.  Usaremos o exemplo de so_5_extra-1.2.0, que usa as ferramentas do novo espa√ßo de nome so_5 :: extra :: revocable_timer: <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de c√≥digo com temporizadores revog√°veis</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;so_5_extra/revocable_timer/pub.hpp&gt; #include &lt;so_5/all.hpp&gt; namespace timer_ns = so_5::extra::revocable_timer; class example_t final : public so_5::agent_t { //  ,       //    . struct first_delayed final : public so_5::signal_t {}; struct second_delayed final : public so_5::signal_t {}; struct last_delayed final : public so_5::signal_t {}; struct periodic final : public so_5::signal_t {}; //    . timer_ns::timer_id_t m_first; timer_ns::timer_id_t m_second; timer_ns::timer_id_t m_last; timer_ns::timer_id_t m_periodic; public : example_t( context_t ctx ) : so_5::agent_t{ std::move(ctx) } { so_subscribe_self() .event( &amp;example_t::on_first_delayed ) .event( &amp;example_t::on_second_delayed ) .event( &amp;example_t::on_last_delayed ) .event( &amp;example_t::on_periodic ); } void so_evt_start() override { using namespace std::chrono_literals; //      ... m_first = timer_ns::send_delayed&lt; first_delayed &gt;( *this, 100ms ); m_second = timer_ns::send_delayed&lt; second_delayed &gt;( *this, 200ms ); m_last = timer_ns::send_delayed&lt; last_delayed &gt;( *this, 300ms ); // ...    . m_periodic = timer_ns::send_periodic&lt; periodic &gt;( *this, 75ms, 75ms ); //    220ms.       //    first_delaye, second_delayed  //    periodic. std::cout &lt;&lt; "hang the agent..." &lt;&lt; std::flush; std::this_thread::sleep_for( 220ms ); std::cout &lt;&lt; "done" &lt;&lt; std::endl; } private : void on_first_delayed( mhood_t&lt;first_delayed&gt; ) { std::cout &lt;&lt; "first_delayed received" &lt;&lt; std::endl; //   second_delayed  periodic. //          ,  //       . m_second.revoke(); m_periodic.revoke(); } void on_second_delayed( mhood_t&lt;second_delayed&gt; ) { std::cout &lt;&lt; "second_delayed received" &lt;&lt; std::endl; } void on_last_delayed( mhood_t&lt;last_delayed&gt; ) { std::cout &lt;&lt; "last_delayed received" &lt;&lt; std::endl; so_deregister_agent_coop_normally(); } void on_periodic( mhood_t&lt;periodic&gt; ) { std::cout &lt;&lt; "periodic received" &lt;&lt; std::endl; } }; int main() { so_5::launch( [](so_5::environment_t &amp; env) { env.register_agent_as_coop( "example", env.make_agent&lt;example_t&gt;() ); } ); return 0; }</span></span></span></span></code> </pre> <br></div></div><br>  O que temos aqui? <br><br>  Temos um agente que primeiro inicia v√°rias mensagens de timer e depois bloqueia seu thread de trabalho por um tempo.  Durante esse per√≠odo, o cron√¥metro consegue enfileirar v√°rias solicita√ß√µes no agente como resultado dos cron√¥metros acionados: v√°rias inst√¢ncias peri√≥dicas, uma inst√¢ncia de first_delayed e second_delayed. <br><br>  Portanto, quando um agente desbloqueia seu encadeamento, ele deve receber o primeiro peri√≥dico e o primeiro_delayed.  Ao processar first_delayed, o agente cancela a entrega peri√≥dica e second_delayed.  Portanto, esses sinais n√£o devem alcan√ßar o agente, independentemente de eles j√° estarem na fila do agente ou n√£o (e est√£o). <br><br>  Vemos o resultado do exemplo: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hang</span></span> the agent...done periodic received first_delayed received last_delayed received</code> </pre> <br>  √â sim.  Obteve o primeiro peri√≥dico e o primeiro_delayed.  Ent√£o n√£o h√° peri√≥dico nem segundo_delayed. <br><br>  Mas se no exemplo substituirmos os "temporizadores" de so_5 :: extra :: revocable_timer pelos temporizadores padr√£o do SObjectizer, o resultado ser√° diferente: todas as inst√¢ncias de sinal peri√≥dicas e de segundo atraso que j√° entraram na fila do agente chegar√£o ao agente. <br><br><h2>  Mensagens restritas de tempo de entrega </h2><br>  Outra coisa √∫til, √†s vezes, que ficar√° dispon√≠vel no so_5_extra-1.2.0 √© a entrega de mensagens com um limite de tempo.  Por exemplo, o agente request_handler envia uma mensagem confirm_signature ao agente crypto_master.  Ao mesmo tempo, request_handler deseja que o check_signature seja entregue dentro de 5 segundos.  Se isso n√£o acontecer, n√£o haver√° sentido no processamento da verity_signature, o agente request_handler j√° interromper√° seu trabalho. <br><br>  E o agente crypto_master √© um camarada que gosta de se tornar um "gargalo": √†s vezes ele come√ßa a desacelerar.  Nesse momento, as mensagens s√£o acumuladas na fila, como a acima verifique a assinatura, que pode esperar at√© que o crypto_master seja liberado. <br><br>  Suponha que o request_handler tenha enviado uma mensagem confirm_signature ao agente crypto_master, mas o crypto_master ficou atolado e ficou preso por 10 segundos.  O agente request_handler j√° "caiu", ou seja,  j√° enviou a todos uma nega√ß√£o de servi√ßo e concluiu seu trabalho.  Mas a mensagem confirm_signature permanece na fila crypto_master!  Portanto, quando o crypto_master "desmarcar", ela receber√° esta mensagem e a processar√°.  Embora isso n√£o seja mais necess√°rio. <br><br>  Utilizando o novo envelope so_5 :: extra :: enveloped_msg :: time_limited_delivery_t, podemos resolver este problema: o agente request_handler enviar√° a verifica√ß√£o_signature time_limited_delivery_t entre o envelope com um prazo de entrega: <br><br><pre> <code class="cpp hljs">so_5::extra::enveloped_msg::make&lt;verify_signature&gt;(...) .envelope&lt;so_5::extra::enveloped_msg::<span class="hljs-keyword"><span class="hljs-keyword">time_limited_delivery_t</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">5</span></span>s) .send_to(crypto_master_mbox);</code> </pre> <br>  Agora, se o crypto_master "gruda" e n√£o consegue verificar a assinatura em 5 segundos, o envelope simplesmente n√£o envia essa mensagem para processamento.  E o crypto_master n√£o far√° o trabalho que ningu√©m mais precisa. <br><br><h2>  Relat√≥rios de entrega de destinat√°rios </h2><br>  E, finalmente, um exemplo de algo curioso que n√£o √© implementado regularmente no SObjectizer ou no so_5_extra, mas que pode ser feito independentemente. <br><br>  √Äs vezes, voc√™ deseja receber do SObjectizer algo como uma mensagem de "relat√≥rio de entrega" para o destinat√°rio.  Afinal, uma coisa √© quando a mensagem chegou ao destinat√°rio, mas o destinat√°rio, por algum motivo, n√£o respondeu a ela.  Outra coisa √© quando a mensagem n√£o chegou ao destinat√°rio.  Por exemplo, foi bloqueado por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um mecanismo de prote√ß√£o contra sobrecarga do agente</a> .  No primeiro caso, uma mensagem para a qual n√£o esperamos uma resposta pode ser omitida.  Mas no segundo caso, pode fazer sentido reenviar a mensagem depois de algum tempo. <br><br>  Agora vamos considerar como o mecanismo mais simples de "relat√≥rios de entrega" pode ser implementado usando envelopes. <br><br>  Ent√£o, primeiro fazemos as etapas preparat√≥rias necess√°rias: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;so_5_extra/enveloped_msg/just_envelope.hpp&gt; #include &lt;so_5_extra/enveloped_msg/send_functions.hpp&gt; #include &lt;so_5/all.hpp&gt; using namespace std::chrono_literals; namespace envelope_ns = so_5::extra::enveloped_msg; using request_id_t = int;</span></span></span></span></code> </pre><br>  Agora podemos definir as mensagens que ser√£o usadas no exemplo.  A primeira mensagem √© uma solicita√ß√£o para executar algumas a√ß√µes que precisamos.  E a segunda mensagem √© uma confirma√ß√£o de que a primeira mensagem chegou ao destinat√°rio: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">request_id_t</span></span> m_id; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> m_data; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delivery_receipt_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//   request_t::m_id   request_t. request_id_t m_id; };</span></span></code> </pre> <br>  Em seguida, podemos definir um agente processador_t que processar√° mensagens do tipo request_t.  Mas o processamento ser√° feito com uma imita√ß√£o de "ader√™ncia".  I.e.  processa request_t, ap√≥s o qual altera seu estado de st_normal para st_busy.  No estado st_busy, ele n√£o faz nada e ignora todas as mensagens que chegam a ele. <br><br>  Isso significa que, se o agente do processador_t enviar tr√™s mensagens request_t consecutivas, ele processar√° a primeira e as outras duas ser√£o lan√ßadas, porque  ao processar a primeira mensagem, o agente ir√° para st_busy e ignorar√° o que vir√° enquanto estiver em st_busy. <br><br>  No st_busy, o agente processador_t passar√° 2 segundos, ap√≥s o qual retornar√° novamente ao st_normal e estar√° pronto para processar novas mensagens. <br><br>  Aqui est√° a apar√™ncia do agente processor_t: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processor_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   .     //   . state_t st_normal{this, "normal"}; //  " ".   . state_t st_busy{this, "busy"}; public: processor_t(context_t ctx) : so_5::agent_t{std::move(ctx)} { this &gt;&gt;= st_normal; st_normal.event(&amp;processor_t::on_request); //     ,    . //  2   ,    st_normal. st_busy.time_limit(2s, st_normal); } private: void on_request(mhood_t&lt;request_t&gt; cmd) { std::cout &lt;&lt; "processor: on_request(" &lt;&lt; cmd-&gt;m_id &lt;&lt; ", " &lt;&lt; cmd-&gt;m_data &lt;&lt; ")" &lt;&lt; std::endl; this &gt;&gt;= st_busy; } };</span></span></code> </pre> <br>  Agora podemos definir o agente orders_generator_t, que possui v√°rias solicita√ß√µes que precisam ser entregues ao processador_t.  O agente request_generator_t envia o pacote inteiro a cada 3 segundos e aguarda a confirma√ß√£o da entrega na forma de delivery_receipt_t. <br><br>  Quando delivery_recept_t chega, o agente orders_generator_t lan√ßa a solicita√ß√£o entregue fora do pacote configur√°vel.  Se o pacote estiver completamente vazio, o exemplo ser√° conclu√≠do.  Se algo mais restar, o pacote restante ser√° enviado novamente na pr√≥xima vez que o reenvio chegar. <br><br>  Ent√£o, aqui est√° o c√≥digo do agente request_generator_t.  √â bastante volumoso, mas primitivo.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voc√™ s√≥ pode prestar aten√ß√£o √†s informa√ß√µes internas do m√©todo send_requests (), no qual as mensagens request_t s√£o enviadas, inclu√≠das em um envelope especial. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo do agente Requests_generator_t</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requests_generator_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">agent_t</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    . const so_5::mbox_t m_processor; //  ,       . std::map&lt;request_id_t, std::string&gt; m_requests; struct resend_requests final : public so_5::signal_t {}; public: requests_generator_t(context_t ctx, so_5::mbox_t processor) : so_5::agent_t{std::move(ctx)} , m_processor{std::move(processor)} { so_subscribe_self() .event(&amp;requests_generator_t::on_delivery_receipt) .event(&amp;requests_generator_t::on_resend); } void so_evt_start() override { //    . m_requests.emplace(0, "First"); m_requests.emplace(1, "Second"); m_requests.emplace(2, "Third"); m_requests.emplace(3, "Four"); //  . send_requests(); } private: void on_delivery_receipt(mhood_t&lt;delivery_receipt_t&gt; cmd) { std::cout &lt;&lt; "request delivered: " &lt;&lt; cmd-&gt;m_id &lt;&lt; std::endl; m_requests.erase(cmd-&gt;m_id); if(m_requests.empty()) //    .  . so_deregister_agent_coop_normally(); } void on_resend(mhood_t&lt;resend_requests&gt;) { std::cout &lt;&lt; "time to resend requests, pending requests: " &lt;&lt; m_requests.size() &lt;&lt; std::endl; send_requests(); } void send_requests() { for(const auto &amp; item : m_requests) { std::cout &lt;&lt; "sending request: (" &lt;&lt; item.first &lt;&lt; ", " &lt;&lt; item.second &lt;&lt; ")" &lt;&lt; std::endl; envelope_ns::make&lt;request_t&gt;(item.first, item.second) .envelope&lt;custom_envelope_t&gt;(so_direct_mbox(), item.first) .send_to(m_processor); } //       3 . so_5::send_delayed&lt;resend_requests&gt;(*this, 3s); } };</span></span></code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, temos mensagens e agentes que devem usar essas mensagens para se comunicar. </font><font style="vertical-align: inherit;">Restava apenas uma pequena coisa - de alguma forma, fazendo com que as mensagens delivery_receipt_t chegassem ao entregar request_t ao processador_t. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© feito usando este envelope:</font></font><br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> custom_envelope_t final : <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> envelope_ns::just_envelope_t { //     . const so_5::mbox_t m_to; // ID  . const request_id_t m_id; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: custom_envelope_t(so_5::message_ref_t payload, so_5::mbox_t <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>, request_id_t id) : envelope_ns::just_envelope_t{std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(payload)} , m_to{std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>)} , m_id{id} {} <span class="hljs-type"><span class="hljs-type">void</span></span> handler_found_hook(handler_invoker_t &amp; <span class="hljs-keyword"><span class="hljs-keyword">invoker</span></span>) noexcept override { //    ,     . //     . so_5::send&lt;delivery_receipt_t&gt;(m_to, m_id); //      . envelope_ns::just_envelope_t::handler_found_hook(<span class="hljs-keyword"><span class="hljs-keyword">invoker</span></span>); } };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, n√£o h√° nada complicado. </font><font style="vertical-align: inherit;">Herdamos de so_5 :: extra :: enveloped_msg :: just_envelope_t. </font><font style="vertical-align: inherit;">Esse √© um tipo auxiliar de envelope que armazena a mensagem inclu√≠da nele e fornece a implementa√ß√£o b√°sica dos ganchos </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">handler_found_hook () e transformation_hook (). </font><font style="vertical-align: inherit;">Portanto, podemos salvar apenas os atributos que precisamos dentro de custom_envelope_t e enviar delivery_receipt_t dentro do gancho handler_found_hook ().</font></font><br><br>  Isso, de fato, √© tudo.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se executarmos este exemplo, obtemos o seguinte: </font></font><br><br><pre> <code class="hljs vbscript">sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">0</span></span>, First) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Second</span></span>) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">2</span></span>, Third) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">3</span></span>, Four) processor: on_request(<span class="hljs-number"><span class="hljs-number">0</span></span>, First) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> delivered: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> resend requests, pending requests: <span class="hljs-number"><span class="hljs-number">3</span></span> sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Second</span></span>) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">2</span></span>, Third) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">3</span></span>, Four) processor: on_request(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Second</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> delivered: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> resend requests, pending requests: <span class="hljs-number"><span class="hljs-number">2</span></span> sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">2</span></span>, Third) sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">3</span></span>, Four) processor: on_request(<span class="hljs-number"><span class="hljs-number">2</span></span>, Third) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> delivered: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> resend requests, pending requests: <span class="hljs-number"><span class="hljs-number">1</span></span> sending <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>: (<span class="hljs-number"><span class="hljs-number">3</span></span>, Four) processor: on_request(<span class="hljs-number"><span class="hljs-number">3</span></span>, Four) <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> delivered: <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, devo dizer que, na pr√°tica, um custom_envelope_t simples para gerar relat√≥rios de entrega dificilmente √© adequado. </font><font style="vertical-align: inherit;">Mas se algu√©m estiver interessado neste t√≥pico, ele poder√° ser discutido nos coment√°rios, e n√£o aumentar o volume do artigo.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O que mais poderia ser feito com envelopes? </font></font></h1><br>  √ìtima pergunta!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para o qual n√≥s mesmos n√£o temos uma resposta abrangente. </font><font style="vertical-align: inherit;">Provavelmente, as possibilidades s√£o limitadas apenas pela imagina√ß√£o dos usu√°rios. </font><font style="vertical-align: inherit;">Bem, se para a realiza√ß√£o de fantasias no SObjectizer algo est√° faltando, isso pode ser dito para n√≥s. </font><font style="vertical-align: inherit;">N√≥s sempre ouvimos. </font><font style="vertical-align: inherit;">E, mais importante, √†s vezes at√© fazemos :)</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Integra√ß√£o de agentes com mchain </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falando um pouco mais a s√©rio, esse √© outro recurso que eu gostaria de ter de tempos em tempos e que foi planejado para so_5_extra-1.2.0. Mas o que, provavelmente, n√£o ser√° lan√ßado na vers√£o 1.2.0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trata-se de simplificar a integra√ß√£o de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mchains</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e agentes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O fato √© que inicialmente os mchains foram adicionados ao SObjectizer para simplificar a comunica√ß√£o de agentes com outras partes do aplicativo que s√£o gravadas sem agentes. Por exemplo, existe o encadeamento principal do aplicativo, no qual o usu√°rio interage usando a GUI. E h√° v√°rios agentes-trabalhadores que fazem o trabalho "duro" em segundo plano. Enviar uma mensagem a um agente a partir do encadeamento principal n√£o √© um problema: basta ligar para o envio regular. Mas como transferir informa√ß√µes de volta?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para isso, mchain-s foram adicionados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas com o tempo, descobriu-se que os mchains podem desempenhar um papel muito maior. √â poss√≠vel, em princ√≠pio, criar aplicativos multithread no SObjectizer sem nenhum agente, apenas em mchain-ahs (mais detalhes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). E voc√™ pode usar mchain-s como um meio de equilibrar a carga nos agentes. Como um mecanismo para resolver problemas produtor-consumidor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema com o produtor-consumidor √© que, se o produtor gera mensagens mais rapidamente do que o consumidor pode lidar com elas, ent√£o estamos com problemas. As filas de mensagens aumentam, o desempenho pode diminuir com o tempo ou o aplicativo falha completamente devido ao esgotamento da mem√≥ria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A solu√ß√£o usual que propusemos usar neste caso √© usar</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um par de agentes colecionadores-int√©rpretes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voc√™ tamb√©m pode usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limites de mensagens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (como o principal mecanismo de prote√ß√£o ou como complemento do coletor-executor). Mas escrever um colecionador-executor requer um trabalho adicional do programador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas mchains pode ser usado para esses prop√≥sitos com o m√≠nimo esfor√ßo do desenvolvedor. Portanto, o produtor colocaria a pr√≥xima mensagem no mchain e o consumidor receberia mensagens desse mchain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas o problema √© que, quando o consumidor √© um agente, n√£o √© muito conveniente para um agente trabalhar com o mchain atrav√©s das fun√ß√µes de recebimento () e sele√ß√£o () dispon√≠veis. E esse inconveniente pode ser tentado ser eliminado com a ajuda de alguma ferramenta para integrar agentes e mchain-s.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao desenvolver essa ferramenta, ser√° necess√°rio resolver v√°rios problemas. Por exemplo, quando uma mensagem chega no mchain, em que ponto deve ser extra√≠da do mchain? Se o consumidor √© gratuito e n√£o processa nada, voc√™ pode pegar a mensagem do mchain imediatamente e entreg√°-la ao agente do consumidor. Se uma mensagem j√° foi enviada ao consumidor do mchain, ele ainda n√£o conseguiu processar essa mensagem, mas uma nova mensagem j√° chegou no mchain ... O que deve ser feito neste caso? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° especula√ß√µes de que envelopes podem ajudar nesse caso. Portanto, quando pegamos a primeira mensagem do mchain e a enviamos ao consumidor, envolvemos essa mensagem em um envelope especial. Quando o envelope v√™ que a mensagem foi entregue e processada, solicita a pr√≥xima mensagem do mchain (se houver).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Claro, nem tudo √© t√£o simples aqui. </font><font style="vertical-align: inherit;">Mas at√© agora parece bastante solucion√°vel. </font><font style="vertical-align: inherit;">E, espero, um mecanismo semelhante aparecer√° em uma das pr√≥ximas vers√µes do so_5_extra.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos abrir a caixa de Pandora? </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deve-se notar que, conosco, as pr√≥prias capacidades adicionadas causam sentimentos duplos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por um lado, os envelopes j√° permitiram / permitiram fazer coisas que foram mencionadas anteriormente (mas apenas sonhavam com algo). </font><font style="vertical-align: inherit;">Por exemplo, este √© um cancelamento garantido de cron√¥metros e uma restri√ß√£o no tempo de entrega, relat√≥rios de entrega, a capacidade de recuperar uma mensagem enviada anteriormente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por outro lado, n√£o est√° claro o que isso levar√° posteriormente. </font><font style="vertical-align: inherit;">Afinal, voc√™ pode criar um problema a partir de qualquer oportunidade se come√ßar a us√°-la quando e onde n√£o precisar. </font><font style="vertical-align: inherit;">Ent√£o talvez abrimos a caixa de Pandora e ainda n√£o imaginemos o que nos espera? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resta apenas ter paci√™ncia e ver aonde tudo isso nos levar√°.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sobre os planos de desenvolvimento imediato do SObjectizer em vez de concluir </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez de uma conclus√£o, quero falar sobre como vemos o futuro muito pr√≥ximo (e n√£o apenas) do SObjectizer. Se algu√©m n√£o estiver satisfeito com algo em nossos planos, voc√™ poder√° falar e influenciar como o SObjectizer-5 se desenvolver√°. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As primeiras vers√µes beta do SObjectizer-5.5.23 e so_5_extra-1.2.0 j√° est√£o corrigidas e dispon√≠veis para download e experi√™ncias. Ainda haver√° muito trabalho a ser feito na √°rea de documenta√ß√£o e casos de uso. Portanto, o lan√ßamento oficial est√° previsto para a primeira d√©cada de novembro. Se funcionar mais cedo, faremos mais cedo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O lan√ßamento do SObjectizer-5.5.23 parece significar que a evolu√ß√£o do ramo 5.5 est√° chegando ao fim. O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeiro lan√ßamento desse segmento ocorreu quatro anos atr√°s, em outubro de 2014.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Desde ent√£o, o SObjectizer-5 evoluiu dentro do ramo 5.5 sem grandes altera√ß√µes de quebra entre as vers√µes. N√£o foi f√°cil. Especialmente considerando o fato de que durante todo esse tempo tivemos que olhar para os compiladores que estavam longe do suporte ideal para C ++ 11. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, n√£o vemos motivo para rever a compatibilidade na ramifica√ß√£o 5.5 e, especialmente, nos compiladores C ++ mais antigos. O que poderia ser justificado em 2014, quando o C ++ 14 estava se preparando para ser adotado oficialmente e o C ++ 17 ainda n√£o estava no horizonte, agora parece completamente diferente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, no pr√≥prio SObjectizer-5.5, ele j√° acumulou uma quantidade razo√°vel de rake e backups, que apareceram devido a essa mesma compatibilidade e complicam o desenvolvimento do SObjectizer.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, nos pr√≥ximos meses, agiremos de acordo com o seguinte cen√°rio: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Desenvolvimento da pr√≥xima vers√£o do so_5_extra, na qual desejo adicionar ferramentas para simplificar a grava√ß√£o de testes para agentes. Ainda n√£o est√° claro se ser√°_5_extra-1.3.0 (ou seja, com altera√ß√µes recentes em rela√ß√£o √† 1.2.0) ou se ser√°_5_extra-1.2.1 (ou seja, sem altera√ß√µes). Vamos ver como vai. √â claro que a pr√≥xima vers√£o do so_5_extra ser√° baseada no SObjectizer-5.5.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1a. Se para a pr√≥xima vers√£o do so_5_extra voc√™ precisar fazer algo adicional no SObjectizer-5.5, a pr√≥xima vers√£o 5.5.24 ser√° lan√ßada. Se, para so_5_extra, n√£o for necess√°rio fazer melhorias no n√∫cleo do SObjectizer, a vers√£o 5.5.23 ser√° a √∫ltima vers√£o significativa na estrutura da ramifica√ß√£o 5.5. Lan√ßamentos menores de corre√ß√£o de bugs ser√£o lan√ßados. Mas o pr√≥prio desenvolvimento da ramifica√ß√£o 5.5 para na vers√£o 5.5.23 ou 5.5.24.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Em seguida, ser√° lan√ßada uma vers√£o do SObjectizer-5.6.0, que abrir√° uma nova ramifica√ß√£o. Na ramifica√ß√£o 5.6, limparemos o c√≥digo do SObjectizer de todas as muletas e backups acumulados, bem como do lixo antigo que h√° muito tempo √© marcado como obsoleto. √â prov√°vel que algumas coisas passem por refatora√ß√£o (por exemplo, abstract_message_box_t pode ser alterado), mas dificilmente cardeal. Os princ√≠pios b√°sicos do trabalho e os recursos caracter√≠sticos do SObjectizer-5.5 no SObjectizer-5.6 permanecer√£o na mesma forma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O SObjectizer-5.6 j√° exigir√° C ++ 14 (pelo menos no n√≠vel GCC-5.5). N√£o h√° suporte para compiladores do Visual C ++ abaixo do VC ++ 15 (que √© do Visual Studio 2017). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consideramos a ramifica√ß√£o 5.6 como uma ramifica√ß√£o est√°vel do SObjectizer, que ser√° relevante at√© a primeira vers√£o do SObjectizer-5.7 aparecer.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gostaria de lan√ßar a vers√£o 5.6.0 no in√≠cio de 2019, provisoriamente em fevereiro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Ap√≥s estabilizar o ramo 5.6, gostar√≠amos de come√ßar a trabalhar no ramo 5.7, no qual poder√≠amos revisar alguns princ√≠pios b√°sicos do trabalho do SObjectizer. Por exemplo, abandone completamente os expedidores p√∫blicos, deixando apenas os particulares. Refa√ßa o mecanismo das cooperativas e suas rela√ß√µes pai-filho, eliminando assim o gargalo durante o registro / cancelamento de registro de cooperativas. Remova a divis√£o por mensagem / sinal. Permita que apenas send / send_delayed / send_periodic envie mensagens e oculte os m√©todos deliver_message e schedule_timer "under the hood". Modifique o mecanismo de envio de mensagens para remover completamente dynamic_casts desse processo ou reduzi-las ao m√≠nimo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, h√° para onde se virar. Ao mesmo tempo, o SObjectizer-5.7 j√° exigir√° C ++ 17, independentemente do C ++ 14. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ observar as coisas sem √≥culos cor de rosa, √© bom que a vers√£o 5.7.0 ocorra no final do outono de 2019. a principal vers√£o de trabalho do SObjectizer para 2019 ser√° a ramifica√ß√£o 5.6. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Paralelamente a tudo isso, o so_5_extra se desenvolver√°. Provavelmente, a vers√£o so_5_extra-2 ser√° lan√ßada junto com o SObjectizer-5.6, que durante 2019 incorporar√° novas funcionalidades, mas com base no SObjectizer-5.6.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, n√≥s mesmos vemos evolu√ß√£o progressiva para o SObjectizer-5 com uma revis√£o gradual de alguns dos princ√≠pios b√°sicos do SObjectizer-5. Ao mesmo tempo, tentaremos fazer isso da maneira mais suave poss√≠vel, para que seja poss√≠vel alternar de uma vers√£o para outra com o m√≠nimo de esfor√ßo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, se algu√©m quiser mudan√ßas mais dram√°ticas e significativas do SObjectizer, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temos algumas reflex√µes sobre isso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em poucas palavras: voc√™ pode refazer o SObjectizer como quiser, at√© implementar o SObjectizer-6 para outra linguagem de programa√ß√£o. Mas n√£o faremos isso completamente √†s nossas pr√≥prias custas, como isso acontece com a evolu√ß√£o do SObjectizer-5.</font></font><br><br>  Provavelmente √© tudo.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os coment√°rios </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ao artigo anterior</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acabaram sendo uma discuss√£o boa e construtiva. </font><font style="vertical-align: inherit;">Seria √∫til se uma discuss√£o semelhante acontecesse desta vez. </font><font style="vertical-align: inherit;">Como sempre, estamos prontos para responder a quaisquer perguntas, mas √†s mais sensatas e com prazer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E aos leitores mais pacientes que alcan√ßaram essas linhas, muito obrigado pelo tempo gasto lendo o artigo.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426983/">https://habr.com/ru/post/pt426983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426973/index.html">Sandu√≠ches corporativos</a></li>
<li><a href="../pt426975/index.html">Coringa 2018: o imposs√≠vel √© poss√≠vel</a></li>
<li><a href="../pt426977/index.html">LibreOffice: pesadelo do contador</a></li>
<li><a href="../pt426979/index.html">Como aprender ingl√™s de gra√ßa: 3 ferramentas comuns e instru√ß√µes detalhadas para cada</a></li>
<li><a href="../pt426981/index.html">10 truques para pain√©is avan√ßados no Splunk. Parte 1</a></li>
<li><a href="../pt426985/index.html">kubebox e outras conchas do console para o Kubernetes</a></li>
<li><a href="../pt426987/index.html">Aprenda o OpenGL. Li√ß√£o 6.3 - Ilumina√ß√£o Baseada em Imagem. Irradia√ß√£o difusa</a></li>
<li><a href="../pt426991/index.html">Startup Digest: 10 pr√≥ximos eventos de TI em Moscou</a></li>
<li><a href="../pt426993/index.html">Preciso aprender C para entender como um computador funciona?</a></li>
<li><a href="../pt426995/index.html">A reciclagem prejudica produtos e funcion√°rios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>