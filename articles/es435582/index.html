<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèà üñïüèø ü§∏üèæ ¬øC√≥mo agregar un √≠ndice en un sistema cargado 24/7 sin tiempo de inactividad? üëï üïã ü•î</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Amigos, a fines de enero, comenzaremos un nuevo curso llamado "MS SQL Server Developer ". En anticipaci√≥n a su lanzamiento, le pedimos a la maestra de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øC√≥mo agregar un √≠ndice en un sistema cargado 24/7 sin tiempo de inactividad?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/435582/">  <i>Amigos, a fines de enero, comenzaremos un nuevo curso llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"MS SQL Server Developer</a> ".</i>  <i>En anticipaci√≥n a su lanzamiento, le pedimos a la maestra del curso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kristina Kucherova</a> , que preparara un art√≠culo de autor.</i>  <i>Este art√≠culo le ser√° √∫til si tiene una tabla muy popular en el producto con acceso 24/7 y de repente se da cuenta de que necesita agregar un √≠ndice con urgencia y no romper nada en el proceso.</i> <br><br>  Entonces que hacer?  El m√©todo tradicional CREAR √çNDICE CON (EN L√çNEA = ENCENDIDO) no es adecuado para usted, porque, por ejemplo, causa un bloqueo del sistema y un ataque card√≠aco a su DBA, todas las partes superiores monitorean de cerca el tiempo de respuesta de su sistema y, si aumenta, acuden a usted y a su DBA para hablar. con respecto a las cifras exageradas de su compensaci√≥n por el trabajo. <br><br>  Se utilizaron scripts y t√©cnicas descritas en un sistema con una carga de 400 K solicitudes por minuto, versiones de SQL Server 2012 y 2016 (Enterprise). <br><br>  Existen dos enfoques muy diferentes para crear un √≠ndice, que se utilizan seg√∫n el tama√±o de la tabla. <br><br><h3>  Caso No. 1. Una mesa peque√±a pero muy popular </h3><br>  Una tabla de 50 mil registros (peque√±os), pero muy popular (varios miles de visitas por minuto).  Necesita un nuevo √≠ndice y un tiempo de inactividad m√≠nimo y bloqueos en la mesa. <br>  En la aplicaci√≥n, todo el acceso a la base de datos es solo a trav√©s de procedimientos. <br><br>  Si se produce un error, la aplicaci√≥n volver√° a intentar acceder a la tabla. <br><br><img src="https://habrastorage.org/webt/0b/7k/oj/0b7kojuvqjl6d_ty__et9g3wgiu.png"><br><a name="habracut"></a><br>  ¬øCu√°l es el problema de aplicar este √≠ndice simplemente, preguntas?  Con la oraci√≥n WITH ONLINE = ON (s√≠, tuvimos suerte, y esta fue Enterprise). <br><br>  El hecho es que con un acceso tan activo, lleva alg√∫n tiempo obtener un bloqueo (incluso el m√≠nimo que se necesita con la opci√≥n Online = ON).  En el proceso de espera, se ponen en cola nuevas solicitudes, la cola se acumula, la CPU est√° creciendo, el DBA est√° sudando y entrecerrando los ojos nerviosamente hacia los desarrolladores, mientras que en los gr√°ficos de monitoreo de la aplicaci√≥n su tiempo de respuesta comienza a aumentar sin problemas, pero inevitablemente.  Su Vicepresidente de Ingenier√≠a est√° muy interesado en saber si, debido a este aumento en el tiempo de respuesta, habr√° alg√∫n tipo de tiempo de inactividad del sistema, que al final del a√±o la disponibilidad de la aplicaci√≥n se estimar√° no 5 nueves (99,999), sino menor.  Y luego la compa√±√≠a tiene contratos, obligaciones y fuertes multas en caso de disponibilidad reducida, y, por supuesto, no nos olvidaremos de las p√©rdidas de reputaci√≥n. <br><br>  ¬øQu√© hemos hecho para evitar esta desafortunada situaci√≥n? <br>  El sistema todav√≠a necesita un √≠ndice. <br>  Tomaron los derechos de todos, excepto la sesi√≥n actual en esta tabla. <br>  Aplica el √≠ndice. <br><br>  S√≠, la soluci√≥n tiene un signo negativo: todos los que acudieron a la mesa en estos segundos recibir√°n Acceso denegado.  Si su aplicaci√≥n normalmente maneja tal situaci√≥n y repite la consulta a la base de datos, entonces deber√≠a mirar esta opci√≥n.  En el caso de nuestro proyecto, este m√©todo funcion√≥ bien.  De nuevo, puede eliminar de forma segura ONLINE = ON, ya que sabemos que solo la sesi√≥n tendr√° acceso a la tabla durante la creaci√≥n del √≠ndice. <br><br>  C√≥digo para aplicar el √≠ndice: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Users_Email_Status <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] ([Email],[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2]</code> </pre> <br>  Programaci√≥n del tiempo de respuesta y porcentaje de errores durante las pruebas bajo carga. <br><br><img src="https://habrastorage.org/webt/h_/nd/ug/h_ndugyc0hybrm5-bps5pmxinuo.png" alt="imagen"><br><br>  El m√©todo se puede aplicar si, como en el caso descrito, tiene una tabla peque√±a y sabe que sin carga, el √≠ndice se crear√° en segundos (o en un tiempo aceptable para usted).  Al mismo tiempo, como puede ver en el gr√°fico anterior, el tiempo de respuesta de la aplicaci√≥n no aumentar√°, aunque se puede ver que la tasa de error en segundos sin acceso a la tabla fue mayor. <br><br><h3>  Caso No. 2. Mesa grande </h3><br>  Si tiene una tabla grande y necesita cambiar los √≠ndices, entonces la forma m√°s sencilla de vender es crear una tabla al lado con el √≠ndice correcto y transferir gradualmente los datos a una nueva tabla. <br><br>  Hay 2 formas: <br><br><ol><li>  Si tiene un procedimiento especial para cambiar una tabla, simplemente cambie el c√≥digo del procedimiento para que los datos nuevos se inserten solo en la nueva tabla, la eliminaci√≥n sea de ambos, la actualizaci√≥n tambi√©n se aplic√≥ a ambos y la selecci√≥n se realiz√≥ desde dos tablas con UNION ALL. </li><li>  Si tiene muchas partes diferentes del c√≥digo donde puede cambiar los datos en la tabla, entonces hay dos trucos populares: ver con disparadores o reescribir todas las partes del c√≥digo para insertar datos en una nueva tabla, eliminar de ambas y actualizar ambas tablas.  Una vista con disparadores es una opci√≥n cuando crea una vista con dos tablas y le cambia el nombre, cambia el nombre de su tabla actual a TableOld y la vista a Tabla.  Luego, obtiene autom√°ticamente todas las llamadas de la tabla a la vista, aqu√≠ con el cambio de nombre tambi√©n puede haber un problema, porque SchemaLock es necesario, pero el cambio de nombre pasa muy r√°pido. </li></ol><br>  Una versi√≥n un poco m√°s detallada sobre la reescritura de llamadas a una nueva tabla: <br><br><ol><li>  Tiene la tabla Pedidos, cree una nueva tabla PedidosNuevo con el mismo esquema, pero con el √≠ndice deseado.  Al mismo tiempo, si usa Indentity, debe establecer el primer valor de identidad en la nueva tabla para que sea igual al valor m√°ximo en la tabla anterior + el paso de cambio o la brecha que puede permitirse para desviarse del valor m√°ximo en √ìrdenes. </li><li>  Cree una vista de pedidos, dentro de la cual una selecci√≥n de pedidos UNION TODOS los pedidosNuevo </li><li>  Cambie todos los procedimientos / llamadas para seleccionar datos de la vista, ins√©rtelos en OrdersNew, elimine y modifique ambas tablas. </li><li>  Migre datos de la tabla anterior a la nueva, por ejemplo, as√≠: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @batchsize; WHILE @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Orders <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> deleted.Id ,deleted.Column1 ,deleted.Column2 ,deleted.Column3 <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.OrdersNew (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> ,Column1 ,Column2 ,Column3); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorNumber, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorMessage; THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre><br></li><li>  Devuelva todos los procedimientos a la versi√≥n antes de la migraci√≥n, con una tabla.  Esto se puede hacer a trav√©s de la modificaci√≥n o la eliminaci√≥n y creaci√≥n de procedimientos (luego no se olvide de los derechos), y puede cambiar el nombre de la nueva tabla a Pedidos, eliminando la tabla y la vista vac√≠as. </li></ol><br>  En el paso 2, era posible, si la carga lo permit√≠a, cambiar el nombre de la tabla principal Pedidos -&gt; OrdersOld, y OrdersView -&gt; Orders y la vista en s√≠ a OrdersOld UNION ALL OrdersNew, entonces no es necesario cambiar todos los lugares donde hay una selecci√≥n de la tabla. <br><br>  Al mover bloques de una tabla a otra, los datos se fragmentar√°n. <br>  Si la tabla que se est√° cambiando se usa activamente para la lectura, pero los datos en ella rara vez cambian, puede volver a usar disparadores: escriba una copia de todos los cambios en la tercera tabla, transfiera los datos de la tabla a trav√©s de bcp out y bcp in (o insert masivo) a una nueva tabla , cree √≠ndices despu√©s de la transferencia de datos y luego aplique los cambios de la tabla con el registro de cambios, y cambie una tabla a otra, la actual, renombr√°ndola a TableOld y la nueva de TableNew a Table. <br><br>  La probabilidad de errores en esta situaci√≥n es ligeramente mayor, as√≠ que pruebe la aplicaci√≥n de cambios y diferentes casos de conmutaci√≥n en este caso. <br><br>  Las opciones descritas no son las √∫nicas.  Los utilic√© en una base de datos de SQL Server muy cargada y no causaron problemas durante la aplicaci√≥n, lo que agrad√≥ a nuestro equipo de DBA.  Tal rebote generalmente no es necesario para bases con un modo de carga m√°s tranquilo, cuando puede aplicar cambios de manera segura en las horas de menor actividad.  Los usuarios del proyecto que utilizaron los enfoques descritos se encuentran en los EE. UU. Y Europa y utilizan activamente la aplicaci√≥n entre semana y fines de semana, y las tablas en las que se aplicaron los cambios se usan constantemente en el trabajo.  Los objetos m√°s "silenciosos" generalmente se cambiaron mediante scripts autom√°ticos generados a trav√©s de Redgate Toolkit despu√©s de que el desarrollador y uno de los DBA revisaron los scripts. <br><br>  <i>Bueno para todos!</i>  <i>¬°Comparta en los comentarios si utiliz√≥ alguno de estos m√©todos o describa su m√©todo!</i>  <i>Tambi√©n lo invitamos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una lecci√≥n abierta</a> y una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jornada de puertas abiertas de</a> nuestro nuevo curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"MS SQL Server Developer"</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435582/">https://habr.com/ru/post/es435582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435572/index.html">Anycubic i3 Mega: remake de calidad de Prusa i3</a></li>
<li><a href="../es435574/index.html">¬øC√≥mo funciona zig?</a></li>
<li><a href="../es435576/index.html">1C, sin dolor</a></li>
<li><a href="../es435578/index.html">Spacewalk para Navidad</a></li>
<li><a href="../es435580/index.html">Servicios Java, Spring, Kurento y Media</a></li>
<li><a href="../es435584/index.html">Slush 2018. D√≠a uno, D√≠a dos</a></li>
<li><a href="../es435586/index.html">El arte del chamanismo o firmware personalizado para Olinuxino. Kernel y Ubuntu Parte 3</a></li>
<li><a href="../es435588/index.html">Promoci√≥n de una aplicaci√≥n m√≥vil con experiencia real en n√∫meros.</a></li>
<li><a href="../es435590/index.html">Pronosticando de nuevo, Parte 1</a></li>
<li><a href="../es435592/index.html">Azores: √∫ltima reserva de flora en medio del oc√©ano Atl√°ntico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>