<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíå üÜö üë©üèΩ‚Äç‚öñÔ∏è Sin servidor: 15% m√°s lento y ocho veces m√°s caro üññüèª üàµ üë±üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente decid√≠ experimentar con la API en nuestro sitio web CardGames.io y probar el framework Serverless . En los √∫ltimos a√±os, se ha convertid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sin servidor: 15% m√°s lento y ocho veces m√°s caro</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468625/">  Recientemente decid√≠ experimentar con la API en nuestro sitio web <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CardGames.io</a> y probar el framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serverless</a> .  En los √∫ltimos a√±os, se ha convertido en un tema candente en el mundo de la tecnolog√≠a, y <s>postergu√©</s> mi deseo de mantener actualizadas mis habilidades t√©cnicas y probar algo nuevo.  Por lo tanto, decid√≠ pasar varias horas estudiando Serverless y ver si hay alg√∫n sentido en dicha ubicaci√≥n de API. <br><br><h4>  Configuraci√≥n actual </h4><br>  CardGames.io se ejecuta en AWS.  Todas las p√°ginas html, CSS, JavaScript e im√°genes se almacenan en S3.  Tenemos una API C # alojada en Elastic Beanstalk, se ejecuta en servidores Linux que ejecutan .NET Core con Docker.  Finalmente, usamos CloudFront CDN antes de las estad√≠sticas en S3 y API.  A continuaci√≥n se muestra el puntaje EC2 para agosto de 2019.  Tenemos varias otras instancias, pero las API funcionan en m1.small (s√≠, t2.small probablemente funciona mejor) con el equilibrio de carga cl√°sico.  Si resume lo resaltado en rojo, entonces sale $ 164.21 al mes, no est√° mal.  Incluso inclu√≠ EBS all√≠, porque no estoy seguro de c√≥mo dividir estos gastos, tenemos varios proyectos en EC2. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/682/96b/05e/68296b05e1d7b07d57e0e2683d129c49.png" width="550"></div><br>  <i><font color="gray">Cuenta de AWS para Elastic Beanstalk</font></i> <br><br>  Tenemos dos entornos con 1-3 instancias en cada uno: activo e inactivo, porque la implementaci√≥n de .NET Core en Docker en AWS lleva varios minutos, por lo que lo hacemos en un entorno inactivo y luego cambiamos los registros CNAME al recientemente implementado.  La implementaci√≥n lenta fue una de las razones por las que quer√≠a probar algo nuevo.  Tenemos varios servidores con aplicaciones node.js en Beanstalk, y se implementan en segundos.  Quer√≠a que fuera lo mismo para la API. <br><br><h4>  Cambiar a sin servidor </h4><br>  Estudi√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muy buen tutorial de</a> alojamiento de API web ASP.NET con el marco Serverless y descubr√≠ que solo necesita agregar un archivo de configuraci√≥n simple, una dependencia y una peque√±a clase de inicio a un proyecto API existente.  La implementaci√≥n tard√≥ unos veinte segundos, mucho mejor que en Beanstalk.  Creo que gracias al soporte incorporado para .NET Core en Lambda (sin embargo, solo 2.2), mientras que en Beanstalk solo es compatible si usa un docker independiente.  En cualquier caso, estaba feliz sin pensar en grupos de autoescalado, instancias m√°ximas y similares. <br><br><h4>  Pruebas de rendimiento </h4><br>  Sin servidor en AWS es Lambda, que realmente aloja sus funciones, y la API de Front Gateway, que le permite agregar cosas como l√≠mites de velocidad, claves API y m√°s.  Aloj√© las caracter√≠sticas de Lambda en la regi√≥n us-west-2, donde est√°n los servidores de Beanstalk.  Luego configur√© la instancia de CloudFront para enrutar las solicitudes de uno de nuestros juegos a la nueva configuraci√≥n sin servidor, y el otro a la configuraci√≥n anterior de Beanstalk.  Luego lanz√≥ una prueba simple en dos URL: una sin servidor y la otra Beanstalk.  Ambas URL invocaron la misma API, almacenando el mismo evento en la base de datos.  Ejecut√© 100 consultas para cada uno, aqu√≠ est√°n los resultados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/e34/859/3d7e34859e2a409510c6a5a85db837c1.png"></div><br>  <i><font color="gray">Comparaci√≥n de rendimiento</font></i> <br><br>  En varias ejecuciones, la configuraci√≥n sin servidor fue un <b>15% m√°s lenta</b> (en todo caso, la ejecut√© desde Islandia, de ah√≠ el gran ping).  La velocidad fue decepcionante, pero se mantuvo bastante alta: me di cuenta de que hay algo de sobrecarga para el frente de API Gateway frente a nuestra API: hay demasiadas funciones, incluso si no las usamos.  ¬°Entonces, triste, pero no cr√≠tico! <br><br><h1>  Precios </h1><br>  Honestamente, al principio no pens√© en los precios.  Simplemente decid√≠ que pagar por el uso real probablemente ser√≠a m√°s barato que pagar por las instancias 24/7.  Por lo tanto, permiti√≥ que la nueva instalaci√≥n sin servidor funcionara durante varios d√≠as y luego comenz√≥ a verificar las cuentas.  ¬°Uy!  ¬°La factura de Lambda + API Gateway ya super√≥ los cien d√≥lares!  Al principio, comenc√© a jugar con la configuraci√≥n de Lambda, asignando menos memoria para guardar, pero cuando mir√© lo que estaba sucediendo bien, se hizo evidente que el problema estaba en la puerta de enlace.  Estas son las tarifas de API Gateway: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df3/05c/3a5/df305c3a5d69a5ee4de51dbcaef9307b.png" width="550"></div><br>  <i><font color="gray">Tasas de API de puerta de enlace</font></i> <br><br>  Nuestra API acepta alrededor de 10 millones de solicitudes por d√≠a.  Esto es aproximadamente $ 35 por pasarela solo <b>cada d√≠a</b> .  Adem√°s, Lambda cuesta alrededor de $ 10 por d√≠a, aunque esto puede reducirse asignando menos memoria.  En conjunto, resultan alrededor de $ 45 por d√≠a, o <b>$ 1350 por mes</b> , frente a <b>$ 164 por mes</b> en Elastic Beanstalk.  <b>¬°Ocho veces m√°s caro</b> !  Me gustan las nuevas tecnolog√≠as y una implementaci√≥n r√°pida, pero no voy a pagar $ 1200 adicionales por mes por esto.  De vuelta a Beanstalk! <br><br><h4>  Conclusi√≥n </h4><br>  ¬°Probablemente, deber√≠a haberme familiarizado con los precios por adelantado y haber hecho algunos c√°lculos matem√°ticos!  Pero, por supuesto, ¬°tendr√≠a que hacer un trabajo real y no aprender valiosas habilidades t√©cnicas!  Estoy seguro de que, en algunas situaciones, las API de Gateway y Lambda son mejores que Elastic Beanstalk.  Simplemente no es nuestro caso.  Quiz√°s si usa claves API, l√≠mites de velocidad y otras caracter√≠sticas de API Gateway, entonces tiene sentido pagar $ 3.50 por mill√≥n de solicitudes.  Ser√≠a mejor simplemente poner un equilibrador de carga normal frente a Lambda.  Hasta donde s√©, esto no es posible; se requiere Gateway API para el acceso http a Lambda. <br><br>  Pero incluso si acab√°ramos de pagar por Lambda, a $ 10 por d√≠a habr√≠a resultado $ 300 por mes en lugar de $ 164.  Tenemos muchas consultas, pero cada consulta hace muy poco: b√°sicamente, una llamada a DB por consulta.  Quiz√°s las consultas m√°s pesadas que usan m√°s tiempo de computaci√≥n sean m√°s adecuadas para Lambda, donde paga 100 ms de tiempo de computaci√≥n.  A continuaci√≥n se muestra un informe para una solicitud.  Como puede ver, usamos 3.50 ms de tiempo de c√°lculo, pero la factura est√° configurada para 100 ms, esto no es un redondeo d√©bil. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d28/6d9/f84/d286d9f841b7aae30794ee34e2eab86e.png"></div><br>  <i><font color="gray">Informe Lambda para una solicitud</font></i> <br><br>  Finalmente, no critico las API de Gateway, Lambda o Serverless en absoluto.  Solo demostrando que para algunas cargas de trabajo son mucho m√°s caras que el viejo y aburrido EC2 y Elastic Beanstalk.  Sobre lo que nos quedaremos.  Tambi√©n es probable que haya una forma mucho mejor o m√°s eficiente de configurar el sistema, de ninguna manera soy un experto de AWS, por lo que si ve alg√∫n error flagrante, aseg√∫rese de indicarlo en los comentarios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468625/">https://habr.com/ru/post/468625/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468609/index.html">El rendimiento incomprensible de la programaci√≥n m√∫ltiple</a></li>
<li><a href="../468611/index.html">Multiproceso .NET: cuando falta rendimiento</a></li>
<li><a href="../468615/index.html">Los 10 idiomas principales para la localizaci√≥n de aplicaciones</a></li>
<li><a href="../468621/index.html">Traducimos la red dom√©stica a DoH u otro clic en el filtro de nariz</a></li>
<li><a href="../468623/index.html">Quiero comentarios sobre Habr</a></li>
<li><a href="../468627/index.html">M√≥dulos de E / S ADAM-6200</a></li>
<li><a href="../468629/index.html">C√≥mo cre√© un filtro que no corrompe la imagen incluso despu√©s de un mill√≥n de ejecuciones - parte 2</a></li>
<li><a href="../468635/index.html">Dichalcogenuros de metales de transici√≥n: descubriendo los secretos del crecimiento cristalino de WS2</a></li>
<li><a href="../468637/index.html">C√≥mo manejar grandes conjuntos de datos en pandas. Trabajamos con la base de datos FIAS usando Python y 8GB de memoria.</a></li>
<li><a href="../468639/index.html">Novedades de las consolas web 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>