<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèº üôÖüèº üéÖüèø Monitorando servidores Windows em puro MS SQL e como eu o implementei secretamente üë©üèø‚Äçüîß üò® üé¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Certa vez, em uma gal√°xia distante e distante, havia uma empresa que havia muito crescera desde uma startup, mas que ainda era bastante compacta e efi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monitorando servidores Windows em puro MS SQL e como eu o implementei secretamente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430662/"> Certa vez, em uma gal√°xia distante e distante, havia uma empresa que havia muito crescera desde uma startup, mas que ainda era bastante compacta e eficiente.  A empresa hospedava (em seu hardware) centenas de servidores Windows, e isso precisava ser monitorado.  Mesmo antes de eu chegar l√°, o NetIQ foi escolhido como a solu√ß√£o. <br><br>  Fui instru√≠do a configurar o NetIQ, e quem fez isso antes de mim n√£o disse uma √∫nica palavra sobre isso.  Impresso.  Eu logo percebi o porqu√™.  Steve Jobs provavelmente est√° girando no t√∫mulo, olhando para uma interface semelhante: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="imagem"></div><br>  Em uma linha, a l√≥gica dos "p√°ssaros" √© positiva (evento de eleva√ß√£o).  Em outro ponto negativo (N√£o aumentar evento).  Como "Somente criar eventos quando" funciona com um conjunto diferente de caixas de sele√ß√£o, geralmente entendi apenas experimentalmente (e j√° esqueci). <br><a name="habracut"></a><br>  No entanto, uma caracter√≠stica muito pior do NetIQ foi sua fragilidade.  O agente dela, instalado em cada servidor, era significativamente mais vulner√°vel que o pr√≥prio Windows.  Mem√≥ria insuficiente?  Agente voou para fora.  CPU 100%?  O agente n√£o est√° respondendo.  0 bytes restantes no disco - o que voc√™ acha?  Para enviar uma mensagem, o agente deve primeiro cri√°-la no disco, como um arquivo ... Bem, voc√™ entende. <br><br>  No entanto, eles de alguma forma viveram com ele at√© que a empresa foi comprada pela empresa ainda mais.  Quando um monstro come uma pequena empresa, ela se dissolve como uma gota no mar.  No nosso caso, n√≥s pr√≥prios, pelos padr√µes de TI, √©ramos apenas um pouco menos do que aqueles que nos compraram, e ficou imediatamente √≥bvio que o processo de fus√£o seria muito dif√≠cil.  T√£o complicado que por algum tempo n√£o fomos tocados e internamente todos os processos permaneceram os mesmos.  Esse estado era semelhante ao momento em que o Anel da Onipot√™ncia caiu sobre a lava, mas ainda n√£o come√ßou a derreter: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg"></div><br>  Enquanto isso, atualizei o NetIQ da vers√£o 7 para 8 e depois para 9, quando nossos problemas come√ßaram.  O NetIQ monitorou apenas algumas coisas: a disponibilidade do pr√≥prio servidor, mem√≥ria, CPU, disco e, o mais importante - servi√ßos.  Se nossos servi√ßos auto-escritos estivessem em Autom√°tico, eles deveriam ter funcionado.  Isso n√£o deve ser assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg"></div><br>  Esses eventos na maioria dos casos e pararam de monitorar o NetIQ.  Ap√≥s uma semana de experimentos e uma semana de trabalho com suporte, descobrimos que ‚Äúisso n√£o √© um bug, √© um recurso‚Äù e que um alerta √© gerado apenas com um determinado c√≥digo de sa√≠da.  E nossos servi√ßos √†s vezes ca√≠am com quaisquer c√≥digos. <br><br>  Muito tempo passou e era tarde demais para reverter.  Como voc√™ entende, tendo descoberto que nossa infraestrutura cr√≠tica n√£o est√° sendo monitorada, imediatamente ... uh ... nada fizemos.  Porque a essa altura, a ‚Äúdissolu√ß√£o‚Äù de nossa empresa em grande parte havia entrado na fase ativa, e parecia algo como isto: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg"></div><br>  Distantes trov√µes, gritos, raios chegaram at√© mim e parecia que o destino do mundo estava sendo decidido, e eu estava subindo com algum tipo de pequeno problema t√©cnico ... Mas n√£o consegui dormir em paz, sabendo que nosso monitoramento era meio cego. <br><br>  Percebendo que n√£o havia lugar para esperar por ajuda, decidi escrever rapidamente um scanner de servi√ßo que ignoraria todos os servidores e enviaria um e-mail se algo n√£o fosse o NetIQ.  Voc√™ provavelmente acha que eu usei o Powershell?  N√£o.  Se voc√™ tem um martelo nas m√£os, tudo est√° pronto, e se voc√™ estiver usando o DBA e trabalhando com o SQL desde a vers√£o 6.0, ent√£o ... Um pequeno trecho do c√≥digo para que voc√™ possa entender do que se trata: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png"></div><br>  Eu fiz isso em algumas horas.  Nos dias seguintes, houve uma auditoria de mensagens, par√¢metros e outros itens.  Depois de ler sobre o comando WMIC, n√£o consegui parar.  Depois, algumas semanas em um nevoeiro.  Acordei quando tudo o que usamos no NetIQ foi reescrito e funcionou com um estrondo. <br><br>  A funcionalidade n√£o foi apenas copiada - eu realizei todas as minhas fantasias, tudo o que eu gostaria desse sistema.  LOWDISK - voc√™ tamb√©m obt√©m um gr√°fico de como o espa√ßo livre no disco se comportou recentemente - se esse crescimento √© normal ou se algo deu errado.  N√£o h√° mem√≥ria suficiente - esse √© o cronograma, a lista de processos e quanto eles levam, e para o w3wp.exe concluiremos o nome do pool de aplicativos, lembretes inteligentes e muito mais.  A prop√≥sito, o sistema pode pegar a lista de servidores por conta pr√≥pria da VMware.  Uma r√°pida olhada em assuntos de alertas no telefone foi suficiente para entender o que estava acontecendo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png"></div><br>  Os programadores modernos est√£o t√£o acostumados a pensar abstratamente que n√£o podem escrever um sistema de monitoramento diferente de 'para o servidor, executamos um conjunto de scripts de monitoramento abstratos e n√£o nos importamos com o que est√° dentro', enquanto monitora cada estado - disco, mem√≥ria, CPU, servi√ßos - √† sua maneira s√£o √∫nicos.  Percebendo isso "abstratamente", voc√™ est√° se saindo mal para cada caso, e √© o que acontece: (Esta √© uma captura de tela do email do SCOM. Certamente feito estritamente de acordo com o ToR) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png"></div><br>  Uma grande vantagem do novo sistema foi o fato de ele n√£o ter agente, respectivamente, n√£o houve problemas com a instala√ß√£o do agente, suas falhas - simplesmente n√£o havia nada para cair por l√°.  O sistema era simples e confi√°vel como um martelo. <br><br>  Nos meses seguintes, vim trabalhar de manh√£, fiquei na frente da minha ideia, como um artista na frente de uma tela, e apliquei algumas pinceladas, tornando-a ainda mais ideal.  Como n√£o tinha prazos, a d√≠vida t√©cnica foi minimizada.  Em algum momento, eu ainda me forcei a parar. <br><br>  O NetIQ ainda funcionava, mas todo mundo gostava mais do novo tipo de alerta e, gradualmente, transferi todos para o novo sistema, sem desativar o antigo.  Enquanto isso, o processo de "fus√£o" entrou em seu est√°gio final: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg"></div><br>  Bem, o conto de fadas deveria terminar.  Eu pr√≥prio fiquei surpreso por me divertir tanto em uma grande empresa burocr√°tica.  Ap√≥s um m√™s de prepara√ß√£o, eles me disseram que, em uma semana, extinguimos o NetIQ e mudamos para o SCOM.  Desliguei o NetIQ (admito, odiei tanto que fiquei muito satisfeito) e comecei a esperar pelo SCOM.  Mas na hora marcada ele n√£o estava l√°.  N√£o depois de uma semana e depois de um m√™s. <br><br>  O SCOM apareceu apenas seis meses depois - algu√©m esqueceu quantos servidores temos e quantas licen√ßas precisamos para o SCOM.  Em seis meses, muitos sistemas come√ßaram a depender do meu sistema, que come√ßou a manter estoques, m√©tricas e muito mais, que silenciosamente continuavam em segundo lugar - n√£o-oficiais.  Para os auditores, existe o SCOM, e tudo realmente √∫til est√° no segundo sistema. <br><br>  √Äs vezes, gerentes de diferentes n√≠veis se perguntavam - de onde v√™m esses emails automatizados?  Recentemente, descrevi em detalhes para eles a hist√≥ria que expus neste artigo, e eles riram alegremente.  Embora √†s vezes ainda seja muito engra√ßado para mim, como em uma grande empresa burocr√°tica voc√™ pode "arrastar um olhar silencioso" muitas coisas.  Sim, e √© bom escrever o c√≥digo, como nos velhos tempos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430662/">https://habr.com/ru/post/pt430662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430650/index.html">O sexo √© um vendedor de jogos de arcade cl√°ssicos. E quem √© o comprador?</a></li>
<li><a href="../pt430654/index.html">devleads meetup: reunimos uma equipe eficaz, otimizamos o desenvolvimento, discutimos quest√µes atuais</a></li>
<li><a href="../pt430656/index.html">Programa SAFe¬Æ certificado</a></li>
<li><a href="../pt430658/index.html">Como come√ßou - o nascimento dos videogames</a></li>
<li><a href="../pt430660/index.html">Mudando para Androidx ou uma emocionante aventura de rake</a></li>
<li><a href="../pt430664/index.html">O papel do l√≠der da equipe no recrutamento</a></li>
<li><a href="../pt430666/index.html">Como avaliar o desempenho da equipe</a></li>
<li><a href="../pt430668/index.html">Sozinho no campo n√£o √© um guerreiro. O caminho para o trabalho em equipe eficaz</a></li>
<li><a href="../pt430670/index.html">Gerenciamento de arranjos</a></li>
<li><a href="../pt430672/index.html">Vers√£o em texto do relat√≥rio "Atores vs CSP x Tarefas ..." com C ++ CoreHard Outono de 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>