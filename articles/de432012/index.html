<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèº üìπ üë©üèæ‚Äçüéì So testen Sie intelligente Vertr√§ge üëì üë¶üèæ üíÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Bedingungen des Smart-Vertrags k√∂nnen nicht ge√§ndert werden. Wenn Sie einen intelligenten Vertrag erstellen, m√ºssen Sie daher sicherstellen, dass ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So testen Sie intelligente Vertr√§ge</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/432012/"><img src="https://habrastorage.org/webt/p5/xq/sj/p5xqsjbx3ydredj41fcohyg6jga.png" alt="Bild"><br><br>  Die Bedingungen des Smart-Vertrags k√∂nnen nicht ge√§ndert werden.  Wenn Sie einen intelligenten Vertrag erstellen, m√ºssen Sie daher sicherstellen, dass er ordnungsgem√§√ü funktioniert.  Testen ist eine sichere M√∂glichkeit, einen Vertrag in verschiedenen Situationen zu testen.  In diesem Tutorial erfahren Sie, welche Schritte Sie ausf√ºhren m√ºssen. <br><a name="habracut"></a><br>  Ich werde sagen: <br><br><ol><li>  So bereiten Sie eine Testumgebung vor. </li><li>  So schreiben Sie <b>JavaScript-</b> Tests und f√ºhren sie in <b>Truffle aus</b> . </li></ol><br>  Das Tutorial richtet sich an Anf√§nger, die gerade erst begonnen haben, sich mit der Entwicklung und dem Testen intelligenter Vertr√§ge auf Ethereum zu befassen.  Um dieses Tutorial zu verstehen, m√ºssen Sie mindestens Grundkenntnisse in <b>JavaScript</b> und <b>Solidity haben</b> . <br><br><h2>  1. So bereiten Sie eine Testumgebung vor </h2><br>  Es gibt viele M√∂glichkeiten, intelligente Vertr√§ge zu testen, aber <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Truffle</a></b> ist das beliebteste Testschreibwerkzeug mit <b>JavaScript</b> .  Auf <b>Truffle k√∂nnen</b> Sie Komponententests schreiben und vollst√§ndige Integrationstests mit realen Parametern aus der Produktionsumgebung durchf√ºhren. <br><br>  Zuerst m√ºssen Sie die neueste Version von Node.js von der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offiziellen Website</a> installieren. <br>  √ñffnen Sie dann ein Terminal und installieren Sie <b>Truffle</b> mit dem folgenden Befehl: <br><br><pre><code class="plaintext hljs">npm install -g truffle</code> </pre> <br>  Erstellen Sie nach der Installation von <b>Truffle</b> , ohne das Terminal zu schlie√üen, das <b>Finanzierungsverzeichnis</b> : <br><br><pre> <code class="plaintext hljs">mkdir Funding</code> </pre> <br>  Wechseln Sie als N√§chstes mit dem folgenden Befehl in das Verzeichnis: <br><br><pre> <code class="plaintext hljs">cd Funding</code> </pre> <br>  F√ºhren Sie den folgenden Befehl aus, um das Verzeichnis zu initialisieren: <br><br><pre> <code class="plaintext hljs">truffle init</code> </pre> <br>  Nach Ausf√ºhrung des Befehls werden die folgenden Ordner und Dateien im <b>Finanzierungsverzeichnis erstellt</b> : <br><br><img src="https://habrastorage.org/webt/lb/io/8k/lbio8kevpzbkkk45st2cj1xzmvw.png" alt="Bild"><br><br>  Weiter werden wir mit jedem Verzeichnis arbeiten.  In der Zwischenzeit bereiten wir die Testumgebung weiter vor. <br><br>  Zum Ausf√ºhren der Tests ben√∂tigen Sie Javascript-Bibliotheken. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mocha</a> ist eine Bibliothek, die allgemeine Funktionen zum Testen enth√§lt, einschlie√ülich <b>beschreiben</b> und <b>es</b> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Chai</a> ist eine Bibliothek, die eine Vielzahl von Funktionen f√ºr √úberpr√ºfungen unterst√ºtzt.  Es gibt verschiedene ‚ÄûStile‚Äú zum √úberpr√ºfen der Ergebnisse, und Chai bietet uns diese M√∂glichkeit.  Im Tutorial werden wir <b>Sollte verwenden</b> . <br><br>  Standardm√§√üig ist Mokka Teil von Truffle. Wir k√∂nnen die Bibliotheksfunktionen problemlos verwenden.  Chai muss manuell installiert werden.  Verwenden Sie dazu das Terminal und f√ºhren Sie im Stammverzeichnis des Projekts den folgenden Befehl aus: <br><br><pre> <code class="plaintext hljs">npm install chai</code> </pre> <br>  Ich habe auch die <b>Chai-Bignumber-Bibliothek</b> installiert, um Zahlen mit beliebiger Genauigkeit zu vergleichen: <br><br><pre> <code class="plaintext hljs">npm install --save-dev chai-bignumber</code> </pre> <br>  Die Testumgebung ist daf√ºr bereit.  Jetzt k√∂nnen Sie beginnen, einen intelligenten Vertrag zu entwickeln und ihn zu testen. <br><br><h2>  2. Wie schreibe ich JavaScript-Tests und f√ºhre sie in Truffle aus? </h2><br>  Um Tests zu entwickeln, ben√∂tigen Sie einen intelligenten Vertrag.  Wir werden einen Vertrag entwickeln, der es Ihnen erm√∂glicht, Spenden zu sammeln, einen bestimmten Betrag festzulegen, um die Sammlung zu erreichen, und Geld abzuheben.  Wenn jemand mehr spendet, wird ihm die Differenz zwischen dem angesammelten Betrag und dem Betrag, der eingezogen werden muss, zur√ºckerstattet. <br><br>  Gehen Sie zum Verzeichnis <b>Finanzierung -&gt; Vertr√§ge</b> .  Erstellen <b>Sie unter</b> <b>Finanzierung / Vertr√§ge</b> die Datei <b>Funding.sol</b> mit der Erweiterung <b>.sol.</b> Dies ist der intelligente <b>Testvertrag</b> . <br><br>  <b>F√ºgen Sie</b> in <b>Funding.sol</b> den folgenden Code hinzu: <br><br><pre> <code class="javascript hljs">pragma solidity <span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>; contract Funding { uint public raised; uint public goal; address public owner; event Donated(uint donation); event Withdrew(uint amount); modifier onlyOwner() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(owner == msg.sender); _; } modifier isFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(isFunded()); _; } modifier notFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!isFunded()); _; } <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span> (uint _goal) public { owner = msg.sender; goal = _goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFunded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> raised &gt;= goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">donate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notFinished</span></span></span><span class="hljs-function"> </span></span>{ uint refund; raised += msg.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (raised &gt; goal) { refund = raised - goal; raised -= refund; msg.sender.transfer(refund); } emit Donated(msg.value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withdraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFinished</span></span></span><span class="hljs-function"> </span></span>{ uint amount = address(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).balance; owner.transfer(amount); emit Withdrew(amount); } }</code> </pre><br>  Der Vertrag ist fertig.  Wir werden einen intelligenten Vertrag durch Migration bereitstellen. <br><br>  Migrationen sind <b>JavaScript-</b> Dateien, mit denen Sie Vertr√§ge im Ethereum-Netzwerk bereitstellen k√∂nnen.  Dies ist die Hauptmethode zum Bereitstellen von Vertr√§gen. <br><br>  <b>Wechseln</b> Sie in das Verzeichnis <b>Finanzierung -&gt; Migrationen,</b> erstellen Sie die Datei <b>2_funding.js</b> und f√ºgen Sie den folgenden Code hinzu: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"./Funding.sol"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GOAL = <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">deployer</span></span></span><span class="hljs-function">) </span></span>{ deployer.deploy(Funding, GOAL); };</code> </pre> <br>  Um die Tests auszuf√ºhren, m√ºssen Sie den Befehl <b>Tr√ºffeltest verwenden</b> .  Wechseln Sie im Terminal zum Stammverzeichnis des <b>Finanzierungsverzeichnisses</b> , das w√§hrend der Vorbereitung der Testumgebung erstellt wurde, und geben Sie Folgendes ein: <br><br><pre> <code class="plaintext hljs">truffle test</code> </pre> <br>  Wenn die folgende Ausgabe im Terminal angezeigt wird, ist alles korrekt ausgef√ºhrt: <br><br><img src="https://habrastorage.org/webt/yi/gn/wp/yignwpfhoay4uojgfxixff6twew.png" alt="Bild"><br><br>  Beginnen wir nun mit dem Schreiben von Tests. <br><br><h3>  Besitzer√ºberpr√ºfung </h3><br><br>  Gehen Sie zum Verzeichnis <b>Finanzierung -&gt; Test</b> und erstellen Sie eine Datei <b>test_funding.js</b> mit der Erweiterung <b>.js</b> .  Dies ist die Datei, in die die Tests geschrieben werden. <br><br>  F√ºgen Sie der Datei <b>test_funding.js</b> den folgenden Code <b>hinzu</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai"</span></span>).use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai-bignumber"</span></span>)(web3.BigNumber)).should(); contract(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[account, firstDonator, secondDonator]</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; it(<span class="hljs-string"><span class="hljs-string">"should check the owner is valid"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { fundingContract = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Funding.deployed(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> owner = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.owner.call() owner.should.be.bignumber.equal(account); });</code> </pre><br>  Im Test √ºberpr√ºfen wir, ob im <b>Finanzierungsvertrag</b> die Adresse des Eigent√ºmers gespeichert ist, der den Vertrag bereitgestellt hat.  In unserem Fall ist <b>account</b> das erste Element des Arrays.  <b>Mit Tr√ºffel</b> k√∂nnen Sie bis zu zehn Adressen verwenden. In Tests ben√∂tigen wir nur drei Adressen. <br><br><h3>  Annahme von Spenden und √úberpr√ºfung des Endes der Mittelbeschaffung </h3><br>  In diesem Abschnitt werden wir √ºberpr√ºfen: <br><br><ol><li>  Annahme und H√∂he der Spenden. </li><li>  Wurde ein bestimmter Spendenbetrag erreicht? </li><li>  Was passiert, wenn Sie mehr spenden, als Sie sammeln m√ºssen? </li><li>  Der Gesamtbetrag der Spende. </li><li>  Kann ich weiterhin Spenden sammeln, wenn der erforderliche Betrag eingezogen wurde? </li></ol><br>  Wir werden die Tests schreiben und analysieren: <br><br><pre> <code class="javascript hljs">. . . . . . . . . . . . . . . . . . . . . . const ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> txEvent; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">logs, eventName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> log <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> logs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.event === eventName) { result = log; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bFirstDonator= web3.eth.getBalance(firstDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bFirstDonator.sub(web3.eth.getBalance(firstDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); });</code> </pre><br>  Bevor ich den Test analysiere, m√∂chte ich 2 Punkte beachten: <br><br><ol><li>  Um nach Ereignissen (Ereignissen) zu suchen und deren Argumente zu √ºberpr√ºfen, wurde eine kleine Funktion <b>findEvent</b> geschrieben. </li><li>  Zur Vereinfachung von Tests und Berechnungen wurde der innere Wert f√ºr Gas eingestellt (Konstante GAS_PRICE). </li></ol><br>  Lassen Sie uns nun den Test analysieren.  Im Test haben wir √ºberpr√ºft: <br><br><ul><li>  dass wir Spenden annehmen k√∂nnen, indem wir die <b>donate ()</b> -Methode aufrufen; </li><li>  dass der uns gespendete Betrag korrekt angegeben ist; </li><li>  dass derjenige, der Geld gespendet hat, den Saldo um den gespendeten Betrag verringert hat. </li></ul><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if donation is not completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); isFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); });</code> </pre><br>  In diesem Test haben wir √ºberpr√ºft, ob die Spendenaktion noch nicht abgeschlossen ist. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should not allow to withdraw the fund until the required amount has been collected"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre> <br>  Im Test haben wir √ºberpr√ºft, dass wir kein Geld abheben k√∂nnen, bis der ben√∂tigte Betrag eingezogen ist. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bSecondDonator= web3.eth.getBalance(secondDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: secondDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bSecondDonator.sub(web3.eth.getBalance(secondDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">15</span></span> * ETHERS); });</code> </pre><br>  Im Test haben wir √ºberpr√ºft, ob die <b>donate ()</b> -Methode bei einer gro√üen <b>Spende</b> das Geld berechnet und an die Person zur√ºckgibt, die mehr als n√∂tig gespendet hat.  Dieser Betrag ist die Differenz zwischen dem angesammelten Betrag und dem Betrag, den Sie sammeln m√∂chten. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if the donation is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); notFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); it(<span class="hljs-string"><span class="hljs-string">"should check if donated amount of money is correct"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> raised = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call(); raised.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); }); it(<span class="hljs-string"><span class="hljs-string">"should not accept donations if the fundraising is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> * ETHERS }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre><br>  In diesen drei Tests haben wir Folgendes √ºberpr√ºft: <br><br><ul><li>  dass die Spendenaktion abgeschlossen ist; </li><li>  dass der Spendenbetrag korrekt ist; </li><li>  dass niemand sonst spenden kann, da die Spendenaktion abgeschlossen ist. </li></ul><br><h3>  Geld abheben </h3><br>  Im vorherigen Abschnitt des Tutorials haben wir den ben√∂tigten Betrag gesammelt. Jetzt kann er angezeigt werden: <br><br><pre> <code class="javascript hljs"> . . . . . . . . . . . . . . . . . . . . . . it(<span class="hljs-string"><span class="hljs-string">"should allow the owner to withdraw the fund"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bAccount = web3.eth.getBalance(account); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> withdraw = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(withdraw.logs, <span class="hljs-string"><span class="hljs-string">"Withdrew"</span></span>); txEvent.args.amount.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = web3.eth.getBalance(account).sub(bAccount); difference.should.be.bignumber.equal(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call() - withdraw.receipt.gasUsed * GAS_PRICE); });</code> </pre><br>  Durch Aufrufen der Funktion <b>draw ()</b> haben wir das Geld des Inhabers des Smart-Vertrags in unserem Fallkonto <b>abgehoben</b> .  Dann haben wir √ºberpr√ºft, ob wir den ben√∂tigten Betrag wirklich abgehoben haben.  <b>Schreiben Sie dazu die</b> Differenz in der Bilanz vor und nach dem Abheben von Geldern in die <b>Differenzkonstante</b> .  Das Ergebnis wird mit der H√∂he der Spenden abz√ºglich der Transaktionsgeb√ºhr verglichen.  Wie oben erw√§hnt, habe ich zur Vereinfachung von Tests und Berechnungen meinen eigenen Preis f√ºr <b>Gas festgelegt</b> . <br><br>  F√ºhren Sie die schriftlichen Tests mit dem Befehl <b>tr√ºffeltest aus</b> .  Wenn alles richtig gemacht wurde, sollte das Ergebnis wie folgt sein: <br><br><img src="https://habrastorage.org/webt/3n/jp/jr/3njpjroqs-jqwzfuejzkqu4neuk.png" alt="Bild"><br><br><h3>  Ergebnis </h3><br>  Ich habe versucht, die Schritte zum Testen intelligenter Vertr√§ge in einer einfachen und verst√§ndlichen Sprache zu beschreiben: von der Vorbereitung einer Testumgebung bis zum Schreiben der Tests selbst. <br><br>  Jetzt k√∂nnen Sie jeden intelligenten Vertrag testen und sicherstellen, dass er ordnungsgem√§√ü funktioniert. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de432012/">https://habr.com/ru/post/de432012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de431998/index.html">Treffen Sie Yandex.Phone - jetzt offiziell</a></li>
<li><a href="../de432002/index.html">Microsoft entwickelt einen auf Chromium basierenden Browser, der standardm√§√üig anstelle von Edge ausgeliefert wird</a></li>
<li><a href="../de432004/index.html">Einf√ºhrung in die reaktive Programmierung</a></li>
<li><a href="../de432006/index.html">Die Geschichte, wie ich zum Thema Frauengesundheit gekommen bin</a></li>
<li><a href="../de432008/index.html">Jagd nach Webstandards</a></li>
<li><a href="../de432014/index.html">Kali Linux f√ºr Anf√§nger</a></li>
<li><a href="../de432016/index.html">Wie Musik und Zeichnen mir das Programmieren beigebracht haben</a></li>
<li><a href="../de432020/index.html">Kettenreplikation: Aufbau eines effizienten KV-Repositorys (Teil 2/2)</a></li>
<li><a href="../de432022/index.html">Forkney it: 8 Gehen Sie Projekte, die interessant sind, um in den Quellcode zu graben</a></li>
<li><a href="../de432024/index.html">Gradle 5.0 - was ist neu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>