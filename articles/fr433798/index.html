<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∂ üëÉ üíì HomeKit et ioBroker Faisons des amis √† la maison üë®üèº‚Äçüî¨ üêøÔ∏è üñºÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sans aucun doute, Apple iOS reste l'un des syst√®mes d'exploitation mobiles les plus populaires, ce qui signifie que les syst√®mes d'automatisation mode...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HomeKit et ioBroker Faisons des amis √† la maison</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433798/"><p><img src="https://habrastorage.org/webt/r6/5c/kp/r65ckpg2b-xatrgqefbyo7lflxa.png"></p><br><p>  Sans aucun doute, Apple iOS reste l'un des syst√®mes d'exploitation mobiles les plus populaires, ce qui signifie que les syst√®mes d'automatisation modernes devraient pouvoir s'int√©grer dans cet √©cosyst√®me et assurer l'interop√©rabilit√©.  C'est exactement pour cela que le framework Homekit est con√ßu, ce qui vous permet de travailler avec des appareils intelligents √† partir de l'√©cran iPhone / iPad / iWatch, et plus r√©cemment, le Mac (macOS Mojave). </p><br><p>  La plupart des syst√®mes d'automatisation (je n'aime pas le nom marketing "maison intelligente") comportent depuis longtemps des modules pour s'int√©grer √† Homekit, mais m√™me un utilisateur form√© ne peut pas toujours simplement trouver comment rendre son appareil disponible dans l'application Home (ou Eve). </p><br><p>  Aujourd'hui, je vais vous dire comment faire ces manipulations dans le syst√®me ioBroker (c'est un syst√®me d'automatisation ouvert et gratuit).  Mais afin de ne pas donner b√™tement tous les nombreux exemples d'appareils, je veux expliquer certains principes et montrer les approches, sachant lesquels, vous pouvez facilement mettre en ≈ìuvre d'autres exemples. </p><br><p>  <em>"La connaissance de certains principes compense facilement l'ignorance de certains faits."</em> <em><br></em>  <em>Claude Adrian Helvetius</em> </p><a name="habracut"></a><br><h3 id="iobroker-drayvery-ustroystva-i-sostoyaniya">  ioBroker.  Pilotes, p√©riph√©riques et √©tats </h3><br><p>  Tout d'abord, je veux expliquer ce qu'est un appareil dans le syst√®me ioBroker et comment il est pr√©sent√©. </p><br><p>  Permettez-moi de vous rappeler que le syst√®me ioBroker est modulaire et que les modules d'extension sont appel√©s pilotes (ou adaptateurs).  Un pilote est un module d'int√©gration avec un p√©riph√©rique ou un groupe de p√©riph√©riques, uni par une fonctionnalit√©, un protocole ou un fabricant commun, et peut donc "faire glisser" un ou plusieurs p√©riph√©riques dans le syst√®me ioBroker.  Une autre caract√©ristique est la possibilit√© de cr√©er plusieurs instances du m√™me pilote, diff√©rents dans tous les param√®tres. </p><br><p>  Mais chaque appareil est unique et inimitable, poss√®de des caract√©ristiques et des capacit√©s diff√©rentes.  Sur cette base, ioBroker se concentre principalement non pas sur l'appareil lui-m√™me, mais sur ses caract√©ristiques, qui sont repr√©sent√©es par des √©tats.  <strong>Un √©tat</strong> est un objet ioBroker interne qui accepte et stocke une valeur.  Des synonymes de l'√©tat peuvent √™tre envisag√©s: signes, attributs, caract√©ristiques, propri√©t√©s, √©v√©nements.  Exemples de conditions: "temp√©rature", "niveau de luminosit√©", "niveau de batterie", "indicateur de mise sous tension", "indicateur d'erreur", "indicateur de pression", "indicateur de double pression", etc.  Ainsi, chaque appareil est repr√©sent√© par de nombreux √©tats diff√©rents. </p><br><p><img src="https://habrastorage.org/webt/oc/mn/q_/ocmnq_d-zdyhjj7bflfxaa3dxb8.png" alt="Structure d'objet" title="Structure d'objet"></p><br><p>  Les √©tats peuvent √™tre divis√©s en √©tats informatifs - ils affichent les informations de l'appareil et les √©tats mutables - ils peuvent √™tre modifi√©s par l'utilisateur ou le script et envoyer ces modifications √† l'appareil.  En cons√©quence, lorsque quelque chose change sur l'appareil - ces donn√©es sont affich√©es dans les √©tats, et lorsque l'√©tat change de ioBroker (par l'utilisateur ou par le script) - l'appareil re√ßoit un signal sur le changement et doit r√©pondre en cons√©quence (cela d√©pend de l'appareil lui-m√™me et du pilote qui l'accompagne) travaux). </p><br><p>  Tous les √©tats de p√©riph√©rique sont combin√©s dans une seule arborescence (registre) d'√©tats.  Ils sont d'abord regroup√©s par p√©riph√©rique (dans certains cas, la canalisation est toujours utilis√©e), puis par instances de pilote. </p><br><p>  Le concept de sujets de protocole MQTT s'int√®gre facilement dans un tel arbre d'√©tat.  De cette fa√ßon, vous pouvez connecter des √©quipements suppl√©mentaires ou des syst√®mes tiers prenant en charge le protocole MQTT.  Il suffit d'installer le pilote MQTT - la branche correspondante appara√Ætra dans l'arborescence d'√©tat. </p><br><p>  Et il existe toutes sortes de services en ligne qui peuvent fournir des informations utiles et / ou permettre de contr√¥ler d'autres √©quipements (alarmes de voiture par exemple).  Le r√©sultat de l'interaction avec ces services est √©galement repr√©sent√© comme un ensemble d'√©tats. </p><br><p><img src="https://habrastorage.org/webt/xi/qk/ay/xiqkay8bgotkcb7qjhouj5-zln4.png" alt="Arbre d'√©tat" title="Arbre d'√âtat"></p><br><p>  Au total, un appareil dans ioBroker est repr√©sent√© par un ensemble d'√©tats caract√©risant l'appareil et permettant d'interagir avec lui. </p><br><h3 id="homekit-aksessuary-servisy-i-harakteristiki">  Homekit  Accessoires, services et sp√©cifications </h3><br><p>  Maintenant, tournez-vous vers Homekit.  Ici, la classification des appareils, leur fonctionnalit√© et leurs caract√©ristiques est appliqu√©e. </p><br><p><img src="https://habrastorage.org/webt/xk/ch/8m/xkch8mdj6gv4zxw5g-kapazvuyy.png" alt="Cat√©gories d'appareils Homekit" title="Cat√©gories d'instruments Homekit"></p><br><p>  <strong>Les accessoires</strong> sont l'√©quivalent d'un appareil physique.  L'accessoire a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cat√©gorie</a> pour l'attribuer √† un groupe sp√©cifique. </p><br><p>  <strong>Les services</strong> sont l'√©quivalent des fonctionnalit√©s d'un accessoire.  Un accessoire peut avoir plusieurs services. </p><br><p>  Les services indiquent les capacit√©s de l'appareil: lampe, batterie, bouton, capteur de qualit√© de l'air, porte, filtre √† air, appareil photo .. </p><br><p>  C'est le service qui d√©termine l'affichage, le comportement de l'appareil et l'ensemble des caract√©ristiques. </p><br><p>  <strong>La caract√©ristique</strong> est l'√©quivalent des attributs / propri√©t√©s qui caract√©risent un service.  Ce sont les caract√©ristiques qui d√©terminent si l'appareil est allum√©, le niveau de luminosit√© de la lampe ou le nombre de pressions sur le bouton.  Un service unique peut avoir de nombreuses caract√©ristiques. </p><br><p><img src="https://habrastorage.org/webt/2f/rl/io/2frliotkqesh2zanlhpfiaskmaq.png" alt="Structure d'objet" title="Structure d'objet"></p><br><p>  Les applications qui fonctionnent avec Homekit lisent les services et les caract√©ristiques des accessoires, puis affichent et vous permettent de modifier les valeurs des caract√©ristiques via l'interface utilisateur.  Les valeurs modifi√©es sont envoy√©es aux appareils Homekit pour les appliquer, et √† partir des appareils Homekit, respectivement, les valeurs des caract√©ristiques sont √©galement envoy√©es avec quelques modifications du c√¥t√© de l'appareil. </p><br><p>  Au total, l'appareil dans HomeKit semble √™tre un accessoire avec un ensemble de services et de fonctionnalit√©s. </p><br><h3 id="yahka-stykuem-koncepcii">  Yahka.  Nous rejoignons le concept </h3><br><p>  Pour travailler avec Homekit, ioBroker utilise le pilote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yahka</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des modules suppl√©mentaires</a> doivent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">install√©s</a> avant l'installation) - un module compl√©mentaire √† une biblioth√®que bien connue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/KhaosT/HAP-NodeJS</a> , qui construit √©galement le populaire projet HomeBridge.  Cette biblioth√®que est con√ßue pour cr√©er une passerelle / passerelle virtuelle qui fournit un ensemble de p√©riph√©riques virtuels dans HomeKit.  En configurant les appareils virtuels et les services en cons√©quence, en d√©finissant les valeurs des caract√©ristiques, nous obtenons l'appareil fini dans Homekit et l'application Home, et nous pouvons √©galement demander √† Siri de le g√©rer. </p><br><p>  Le pilote Yahka est juste con√ßu pour configurer les accessoires, leur ajouter des services et indiquer la correspondance des caract√©ristiques (HomeKit) et des √©tats (ioBroker). </p><br><p>  Mais d'abord, apr√®s l'installation, vous devez configurer la passerelle et l'int√©grer dans l'application Home.  Apr√®s la configuration, tous les appareils ajout√©s √† la passerelle seront automatiquement ajout√©s au Home.  Pour ce faire, sp√©cifiez "Nom du p√©riph√©rique" (il est souhaitable de ne sp√©cifier que des lettres latines) et n'oubliez pas le code PIN (ou d√©finissez le v√¥tre). </p><br><p><img src="https://habrastorage.org/webt/mj/b9/lf/mjb9lfsfvknvbjjmec9x0nexnns.png" alt="Configuration de la passerelle" title="Configuration de la passerelle"></p><br><div class="spoiler">  <b class="spoiler_title">Nous allons √† l'application Home et ajoutons un nouvel accessoire.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5k/m1/hr/5km1hrkrxh6whzmb8dn5zcvqtm4.png"><br><img src="https://habrastorage.org/webt/fo/p-/oz/fop-oz-o99nnegmciq7drkxjdyu.png"></p></div></div><br><p>  Passons maintenant aux appareils.  Tout irait bien si l'ensemble des √©tats de l'appareil dans ioBroker correspondait clairement √† l'ensemble des services et fonctionnalit√©s de HomeKit.  Et ce serait encore mieux si les valeurs dans les √©tats √©taient adapt√©es aux valeurs des caract√©ristiques.  Mais souvent, ce n'est pas le cas, et vous devez trouver des moyens inhabituels d'accoster.  J'en parlerai ci-dessous, et vous devrez impl√©menter vous-m√™me toutes les autres options, "√† l'image et √† la ressemblance". </p><br><p>  Pour plus de commodit√©, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cr√©√© un document</a> avec la traduction des services et des types, ainsi que les valeurs possibles des caract√©ristiques.  Tous les types et services utilis√©s correspondent √† la <a href="">biblioth√®que HAP-NodeJS</a> . </p><br><h3 id="datchik-temperatury">  Capteur de temp√©rature </h3><br>  Ceci est l'exemple le plus simple - tout ce que vous avez √† faire est d'avoir un √©tat contenant la valeur num√©rique de la temp√©rature.  Il peut √™tre obtenu de n'importe o√π: √† partir de capteurs ou de services Internet (m√©t√©o). <br><p>  Vous devez ajouter un appareil de la cat√©gorie Capteur, ajouter le service TemperatureSensor √† l'appareil et donner un nom √† ce service.  Il existe 5 caract√©ristiques dans ce service, dont la plus importante pour nous est la temp√©rature actuelle. </p><br><p><img src="https://habrastorage.org/webt/xn/yr/k7/xnyrk7hwwcmtwhiy_kcbub-nlms.png" alt="Thermom√®tre accessoire" title="Thermom√®tre accessoire"></p><br><p><img src="https://habrastorage.org/webt/j4/bj/bn/j4bjbnuijam7qadtoq9r9eh16ns.png" alt="Service de capteur de temp√©rature" title="Service de capteur de temp√©rature"></p><br><p>  Il suffit d'indiquer le nom de l'√©tat correspondant √† la temp√©rature dans la caract√©ristique CurrentTemperature. </p><br><p>  Ajoutez √©galement le service d'humidit√© HumiditySensor, et une ic√¥ne d'accessoire s√©par√©e sera cr√©√©e dans Homekit. </p><br><p><img src="https://habrastorage.org/webt/ag/na/90/agna90qhvaz84v3qutrvu4dltei.png" alt="Service de capteur d'humidit√©" title="Service de capteur d'humidit√©"></p><br><p>  Enregistrez et vous avez termin√©.  Vous pouvez maintenant vous tourner vers Siri et lui poser des questions sur la temp√©rature et l'humidit√©. </p><br><p><img src="https://habrastorage.org/webt/s4/cx/kg/s4cxkg72-7ycfuaentktjrhpdjy.png"></p><br><div class="spoiler">  <b class="spoiler_title">Conversation avec Siri</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ff/p9/tt/ffp9ttfpcj3_wcbt4ztgisnwxzi.png"><br><img src="https://habrastorage.org/webt/ax/7z/1i/ax7z1ioiynurem96c3gof_2gnha.png"></p></div></div><br><h3 id="batareyka">  La batterie </h3><br><p>  Un autre service simple.  Son astuce est qu'il peut √™tre ajout√© √† presque tous les accessoires.  Ajoutez le service BatteryService et indiquez dans la caract√©ristique BatteryLevel un √©tat contenant le pourcentage de charge de la batterie.  Apr√®s cela, les donn√©es de charge appara√Ætront dans les donn√©es suppl√©mentaires sur l'appareil. </p><br><p><img src="https://habrastorage.org/webt/pd/4p/ib/pd4pibwilwjymthk2g30ldqneey.png" alt="BatteryService" title="Service de batterie"></p><br><p>  Vous pouvez imm√©diatement d√©finir le signe de ¬´faible charge¬ª (caract√©ristique StatusLowBattery), si la valeur de l'√©tat sp√©cifi√© est √©gale √† 1, l'ic√¥ne correspondante sera affich√©e sur l'image de l'appareil. </p><br><p>  Mais que se passe-t-il si vous ne disposez pas d'un tel √©tat, mais que vous souhaitez voir l'ic√¥ne de batterie faible?  Vous devez cr√©er cet √©tat manuellement ou √† l'aide d'un script et indiquer l'√©tat cr√©√© dans les caract√©ristiques. </p><br><p>  Maintenant, il ne reste plus qu'√† d√©finir correctement la valeur true dans cet √©tat.  Pour ce faire, nous utiliserons le script - il deviendra vrai lorsque la batterie atteindra 30%. </p><br><pre><code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">""</span></span>); on({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"zigbee.0.00158d0001f41725.battery"</span></span>, <span class="hljs-attr"><span class="hljs-attr">change</span></span>: <span class="hljs-string"><span class="hljs-string">"ne"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = obj.state.val; setState(<span class="hljs-string"><span class="hljs-string">"javascript.0."</span></span>, (value &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>)); });</code> </pre> <br><p>  Apr√®s la premi√®re ex√©cution, le script cr√©e un √©tat et peut √™tre s√©lectionn√© dans les caract√©ristiques. </p><br><p><img src="https://habrastorage.org/webt/tx/2z/6r/tx2z6r4deofbbram-k_muwaxut0.png"></p><br><p>  Ce signe sera affich√© sur les images d'accessoires </p><br><p><img src="https://habrastorage.org/webt/9o/nu/it/9onuitzmxs8exjofr7cfkwtwrqi.png"></p><br><div class="spoiler">  <b class="spoiler_title">et les d√©tails de l'appareil</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fx/jg/av/fxjgavhu-spu27lskbzkmvb_dh8.png"></p></div></div><br><h3 id="lampy">  Lampes </h3><br><p>  Les ampoules sont diff√©rentes - lumineuses, chaudes, rouges.  Il y a 4 cas: </p><br><ul><li>  Simple - contr√¥l√© par marche et arr√™t </li><li>  Dimmable - √©galement contr√¥l√© par le niveau de luminosit√© </li><li>  Avec la temp√©rature - il est possible de contr√¥ler la temp√©rature de la lueur </li><li>  Couleur - vous pouvez contr√¥ler la couleur de la lueur </li></ul><br><p>  Pour chacun de ces cas, il existe une caract√©ristique correspondante dans le service Ampoule: </p><br><ul><li>  On - on / off </li><li>  Luminosit√© - niveau de luminosit√© </li><li>  Teinte - ombre </li><li>  Saturation - Saturation </li><li>  ColorTemperature - temp√©rature de couleur </li></ul><br><p>  Dans le cas simple, dans la caract√©ristique "On", nous indiquons l'√©tat responsable de l'allumage et de l'extinction. </p><br><p><img src="https://habrastorage.org/webt/7p/2j/l2/7p2jl2cqi7q8rbw98d_ytedxwke.png"></p><br><p>  Si la lampe est dimmable, nous indiquons en outre l'√©tat avec le niveau de luminosit√©. </p><br><p><img src="https://habrastorage.org/webt/b6/da/n1/b6dan1fjltcn8sry8doex2hl6ck.png"></p><br><p>  En plus d'attribuer des √©tats corrects, il est important de respecter l'intervalle des valeurs acceptables! </p><br><p>  Exemple: dans certains cas, l'√©tat responsable de la luminosit√© de la lampe peut prendre des valeurs de 0 √† 255, mais dans Homekit ces valeurs sont limit√©es √† un intervalle de 0 √† 100. Pour ce cas, vous pouvez utiliser les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctions de conversion du</a> pilote Yahka.  La fonction "level255" convertit simplement l'intervalle de valeurs 0..255 en intervalle 0..100 (et vice versa). </p><br><p>  Les difficult√©s suivantes peuvent survenir si votre lampe est color√©e, mais la couleur utilis√©e est RVB.  Il peut s'agir de trois √©tats diff√©rents ou d'un nombre (ou cha√Æne).  Dans ce cas, vous devrez convertir d'un espace colorim√©trique RVB en un autre espace XYB (cet espace est utilis√© par HomeKit) ou en plan XY. </p><br><p>  Pour ce faire, vous devez cr√©er 2 nouveaux √©tats (Teinte et Saturation), dans lesquels nous convertirons les valeurs de l'√©tat RVB et vice versa. </p><br><div class="spoiler">  <b class="spoiler_title">Le script r√©sultant pour la couleur est</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       createState("Hue"); createState("Sat"); //      RGB- on({id: "Hue", ack: false, change: 'any'}, function (obj) {  var hue = parseInt(obj.state.val);  var sat = parseInt(getState('Sat').val);  var res = hsvToRgb(hue, sat, 100);  setRGB(parseInt(res[0]), parseInt(res[1]), parseInt(res[2])); }); //    RGB- function setRGB(r, g, b){  var val = ('00'+r.toString(16)).slice(-2)+('00'+g.toString(16)).slice(-2)+('00'+b.toString(16)).slice(-2);  // RGB-   setState('zigbee.0.00124b0014d016ab.color', val, false); } //   HSV   RGB function hsvToRgb(h, s, v) {  var r, g, b;  var i;  var f, p, q, t;   h = Math.max(0, Math.min(360, h));  s = Math.max(0, Math.min(100, s));  v = Math.max(0, Math.min(100, v));  s /= 100;  v /= 100;   if(s == 0) {      r = g = b = v;      return [          Math.round(r * 255),          Math.round(g * 255),          Math.round(b * 255)      ];  }   h /= 60;  i = Math.floor(h);  f = h - i;  p = v * (1 - s);  q = v * (1 - s * f);  t = v * (1 - s * (1 - f));   switch(i) {      case 0:          r = v;          g = t;          b = p;          break;       case 1:          r = q;          g = v;          b = p;          break;       case 2:          r = p;          g = v;          b = t;          break;       case 3:          r = p;          g = q;          b = v;          break;       case 4:          r = t;          g = p;          b = v;          break;       default: // case 5:          r = v;          g = p;          b = q;  }   return [      Math.round(r * 255),      Math.round(g * 255),      Math.round(b * 255)  ]; }</span></span></code> </pre> </div></div><br><p>  La temp√©rature de couleur peut √™tre plus facile - si la plage de valeurs disponibles pour votre lampe est connue, elle peut √™tre convertie en l'intervalle disponible pour HomeKit (via la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">scaleInt</a> ). </p><br><p><img src="https://habrastorage.org/webt/f0/vm/xh/f0vmxhpcndendf_efjf9xrmjxke.png" alt="Service d'ampoules" title="Service d'ampoules"></p><br><p><img src="https://habrastorage.org/webt/et/sp/fg/etspfg0idwn5v-cun2hh2y9xmm0.png"></p><br><div class="spoiler">  <b class="spoiler_title">Plus profond√©ment dans la lampe</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w_/q8/8p/w_q88pboeca8hl0fygtssrjegim.png"><br><img src="https://habrastorage.org/webt/bt/5c/bc/bt5cbc59jttu8ibjev1hfnnwkdm.png"></p></div></div><br><h3 id="termostat">  Thermostat </h3><br><p>  Thermostat - un appareil pour maintenir la temp√©rature r√©gl√©e (service de thermostat).  En cons√©quence, la principale caract√©ristique du thermostat est la temp√©rature souhait√©e (TargetTemperature).  En plus de la temp√©rature r√©gl√©e, la temp√©rature actuelle (CurrentTemperature) peut √™tre indiqu√©e, qui est de nature informative (puisque l'appareil ne la lit que depuis les capteurs). </p><br><p>  Depuis l'application Home, la temp√©rature cible est r√©gl√©e dans le thermostat et la temp√©rature actuelle est suivie.  Dans mon thermostat (Zont), il n'y avait que ces deux √©tats - ils √©taient disponibles via l'api du cloud de service. </p><br><p>  Pour la beaut√© de l'affichage de l'appareil dans HomeKit, j'ai d√ª ajouter quelques constantes: l'√©tat actuel du chauffage est actif (1), l'√©tat cible du chauffage est automatique (3). </p><br><p><img src="https://habrastorage.org/webt/vn/dd/ey/vnddeyypjlofn2jkxrqwe5ybwuw.png" alt="Service de thermostat" title="Service de thermostat"></p><br><p><img src="https://habrastorage.org/webt/pk/9u/k3/pk9uk3vfurepl1kfgow5lrp66dc.png"></p><br><div class="spoiler">  <b class="spoiler_title">S√©lection de la temp√©rature</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/_4/g8/co/_4g8coln1rlsodscr8sah8p_h9o.png"></p></div></div><br><h3 id="vorota">  Portes </h3><br><p>  Avec une porte de garage (service GarageDoorOpener), tout est plus d√©licat qu'avec un thermostat. </p><br><p>  Parmi les caract√©ristiques disponibles, la porte a un √©tat cible (TargetDoorState), ce qui indique notre d√©sir que la porte soit ¬´ouverte¬ª ou ¬´ferm√©e¬ª.  Mais vous devez √©galement afficher correctement l'√©tat actuel de la porte (CurrentDoorState): sont-ils ouverts ou ferm√©s, ou peuvent-ils s'ouvrir ou se fermer? </p><br><p>  Dans mon cas, les portes ont √©t√© ouvertes via mqtt dans ioBroker avec plusieurs √©tats d'information: </p><br><ul><li>  signe d'ouverture de porte (OB) </li><li>  signe de mouvement du portail (LW) </li></ul><br><p><img src="https://habrastorage.org/webt/aw/b3/ip/awb3ipo5vz8qrn8jawhcfunuouc.png" alt="√âtats de commande de porte de garage" title="√âtats de commande de porte de garage"></p><br><p>  Gr√¢ce √† ces √©tats, vous pouvez calculer l'√©tat actuel de la porte: </p><br><ul><li>  s'il n'y a pas d'OB ni de DV, alors les portes sont ferm√©es </li><li>  s'il n'y a pas d'OB et qu'il y a un DV, alors les portes s'ouvrent </li><li>  s'il y a un OB et pas de DV, alors les portes sont ouvertes </li><li>  s'il y a un OB et qu'il y a un DV, alors la porte se ferme </li></ul><br><p>  Pour envoyer un signal d'ouverture et de fermeture du portail, j'ai deux √©tats distincts (il serait possible de g√©rer avec un seul √©tat, mais j'en ai deux), qui envoient un message via mqtt au contr√¥leur de contr√¥le du portail: </p><br><ul><li>  signal d'ouverture </li><li>  signal de fermeture </li></ul><br><p>  Pour envoyer un signal, vous devez simuler un bouton "clic": d√©finissez la valeur sur true, et apr√®s un certain temps, r√©initialisez-la sur false.  √Ä cet √©gard, pour s'int√©grer √† HomeKit, il √©tait n√©cessaire de cr√©er un autre √©tat - ¬´l'√©tat cible de la porte¬ª, une fois modifi√©, le signal correspondant sera envoy√©. </p><br><p>  Le signe d'ouverture de la porte peut √™tre remplac√© par l'√©tat cible (c'est-√†-dire ce que l'objectif visera): </p><br><ul><li>  si l'AC est ¬´ferm√©e¬ª et qu'il n'y a pas de DV, alors la porte est ferm√©e </li><li>  si l'AC est ¬´ferm√©e¬ª et qu'il y a un DV, alors les portes s'ouvrent </li><li>  si l'AC est ¬´ouverte¬ª et qu'il n'y a pas de DV, alors la porte est ouverte </li><li>  si le CA est ¬´ouvert¬ª et qu'il y a un DV, alors la porte se ferme </li></ul><br><p>  Nous allons √©galement cr√©er un √©tat s√©par√© "√©tat actuel de la porte", et nous le remplirons dans le script en fonction de la valeur des signes et de l'√©tat cible. </p><br><div class="spoiler">  <b class="spoiler_title">Script de changement d'√©tat pour les portes de garage</b> <div class="spoiler_text"><pre> <code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">"gate_0.current"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   createState("gate_0.target"); //   //    0,   300 on({id: "mqtt.0.gate.gpio.13", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.13", 0,  300); }); on({id: "mqtt.0.gate.gpio.12", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.12", 0,  300); }); //     on({id: "mqtt.0.gate.is_open", ack: false, val: 1}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 0, true); }); on({id: "mqtt.0.gate.is_open", ack: false, val: 0}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 1, true); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 0}, function (obj) {  setState("mqtt.0.gate.gpio.12", 1); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 1}, function (obj) {  setState("mqtt.0.gate.gpio.13", 1); }); on({id: "mqtt.0.gate.in_progress", ack: true, change: 'any'}, function (obj) {  //    " ",      if (obj.state.val === 1) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 2, true);      } else {          // ""          setState("javascript.0.gate_0.current", 3, true);      }  }  //    " ",      if (obj.state.val === 0) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 0, true);      } else {          // ""          setState("javascript.0.gate_0.current", 1, true);      }  } });</span></span></code> </pre> </div></div><br><p>  Apr√®s avoir ex√©cut√© le script, vous pouvez configurer les caract√©ristiques du service de porte de garage: </p><br><p><img src="https://habrastorage.org/webt/lb/cm/t5/lbcmt51du7vnivrjbj2o_h_u28u.png" alt="Service GarageDoorOpener" title="Service GarageDoorOpener"></p><br><p><img src="https://habrastorage.org/webt/pg/rh/ey/pgrhey_qs-cxm8rg6yj_lufgmgs.png"></p><br><h3 id="kamera">  Appareil photo </h3><br><p>  Pour ajouter une cam√©ra √† HomeKit, la m√©thode "classique" sera utilis√©e.  La diffusion de l'image depuis la cam√©ra via le module ffmpeg est organis√©e.  Gr√¢ce √† lui, le flux d'entr√©e sera encod√©, crypt√© et donn√© √† Homekit. </p><br><p>  Tout d'abord, vous devez installer ffmpeg sur le serveur o√π se trouve ioBroker. </p><br><p>  Pour chaque plateforme, elle est install√©e de diff√©rentes mani√®res, vous pouvez l'assembler √† partir de la source, ou rechercher un assemblage fini, par exemple ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.johnvansickle.com/ffmpeg/</a> Doit avoir un encodeur libx264.  Vous pouvez v√©rifier l'encodeur apr√®s avoir install√© ffmpeg avec la commande: </p><br><pre> <code class="plaintext hljs">ffmpeg -codecs | grep 264</code> </pre> <br><p>  Les r√©sultats doivent contenir une ligne du formulaire </p><br><pre> <code class="plaintext hljs">DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_vdpau ) (encoders: libx264 libx264rgb h264_v4l2m2m )</code> </pre> <br><p>  Pour Raspberry Pi 3, vous pouvez utiliser l' <a href="">assemblage pr√™t √†</a> l' <a href="">emploi</a> , qui dispose d'un codec avec prise en charge du codage mat√©riel GPU (h264_omx, consomme moins de ressources).  Mettez-le comme ceci: </p><br><pre> <code class="plaintext hljs">wget https://github.com/legotheboss/YouTube-files/raw/master/ffmpeg_3.1.4-1_armhf.deb sudo dpkg -i ffmpeg_3.1.4-1_armhf.deb</code> </pre> <br><p>  Les deux codecs sont pr√©sents dans cet assemblage: libx264 et h264_omx </p><br><p>  Ensuite, vous devez obtenir l'adresse du flux de cam√©ra qui doit √™tre diffus√© (cette √©tape d√©passe le cadre de cet article).  Par exemple, vous pouvez prendre un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">flux public pr√™t √† l'emploi</a> . </p><br><p>  Ajoutez maintenant la cam√©ra √† Yahka, indiquez l'adresse du flux et si n√©cessaire modifiez les param√®tres du codec, la taille de l'image, la fr√©quence d'images. </p><br><p>  <strong>Important: les combinaisons de param√®tres sont tr√®s importantes pour l'affichage correct de la cam√©ra dans Homekit et d√©pendent de la cam√©ra et du flux.</strong>  <strong>Il affecte √©galement les performances du syst√®me, comme</strong>  <strong>Le processus en cours d'ex√©cution de ffmpeg consomme beaucoup de ressources.</strong> </p><br><p><img src="https://habrastorage.org/webt/zh/uj/6g/zhuj6gv7alolh2nfvmpyxgmnoju.png" alt="Ajout d'une cam√©ra" title="Ajout d'une cam√©ra"></p><br><p><img src="https://habrastorage.org/webt/w7/_z/pl/w7_zplfretbtbw0v66nb9ip9ira.png" alt="Configuration du flux" title="Configuration du flux"></p><br><div class="spoiler">  <b class="spoiler_title">Les cam√©ras sont ajout√©es en tant que p√©riph√©riques distincts en dehors de la passerelle, et elles doivent √™tre ajout√©es de la m√™me mani√®re que la passerelle</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ib/8v/s9/ib8vs9ksuw5mk4ese_-gg6rnrv4.png"></p></div></div><br><p><img src="https://habrastorage.org/webt/0d/hp/qd/0dhpqdbfe_hgez4u7x2edcu92za.png" alt="Vignette de la cam√©ra" title="Vignette de la cam√©ra"></p><br><p><img src="https://habrastorage.org/webt/ue/tj/o4/uetjo4rqvi-fsae2rlkt56cmaji.png" alt="Diffusion depuis la cam√©ra" title="Diffusion depuis la cam√©ra"></p><br><h3 id="bonus">  Bonus </h3><br><p>  En prime, je vais parler de l'utilisation inhabituelle de la diffusion par cam√©ra. </p><br><p>  En utilisant le m√™me ffmpeg, au lieu de l'appareil photo, vous pouvez essayer de diffuser l'image, n'importe quelle image.  Ces images peuvent √©galement √™tre combin√©es avec le flux vid√©o.  Vous pouvez afficher du texte, des graphiques et d'autres informations sur l'image. </p><br><p><img src="https://habrastorage.org/webt/sg/cl/f7/sgclf7ssws1pkm_rlf3qy_avmhi.png" alt="Superposition de texte Cast" title="Superposition de texte cast"></p><br><p>  En cons√©quence, vous pouvez obtenir un tableau de bord int√©ressant.  Et si vous mettez √† jour l'image p√©riodiquement, vous obtenez des donn√©es dynamiques. </p><br><p>  √Ä titre d'exemple, j'ai sorti un graphique des changements de certains indicateurs sous la forme d'une image (fichier sur disque).  Ce graphique est mis √† jour une fois par minute et √©crase l'image dans le fichier. </p><br><div class="spoiler">  <b class="spoiler_title">(Les fonctions createImage1, createImage2, la formation d'un graphique et l'imposition de texte sur une image d√©passent le cadre de cet article, mais je vais vous donner un indice).</b> <div class="spoiler_text"><p>  Je vais vous dire comment obtenir un graphique sous forme d'image. </p><br><p>  IoBroker a une fa√ßon standard de construire des graphiques - le pilote Flot.  Ce pilote est associ√© √† un pilote Web et affiche le r√©sultat dans un navigateur.  Mais pour obtenir le graphique cr√©√© sur le serveur (dans le script) en tant qu'image, un pilote PhantomJS suppl√©mentaire est n√©cessaire, qui prend une ¬´capture d'√©cran¬ª de la page (sur laquelle nous allons dessiner un graphique Flot). </p><br><p>  Mais je vais parler d'une autre fa√ßon de construire des graphiques sur le serveur dans un script. </p><br><p>  Il existe une telle biblioth√®que Chart.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.chartjs.org/</a> qui vous permet de dessiner de jolis graphiques dans le navigateur (exemples <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.chartjs.org/samples/latest/</a> ). </p><br><p>  Pour le dessin, il utilise le ¬´canvas¬ª (canvas, canvas) du navigateur.  Par cons√©quent, pour dessiner en utilisant cette biblioth√®que sur le serveur, vous devez utiliser la version ¬´serveur¬ª des objets ¬´canvas¬ª et DOM.  C'est ce que fait le package chartjs-node ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/vmpowerio/chartjs-node</a> ). </p><br><p>  La principale d√©pendance de ce package est le package canvas ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/Automattic/node-canvas</a> ), qui doit √™tre install√© globalement (ou dans le dossier iobroker).  Il est important d'installer toutes les d√©pendances de la plateforme sur laquelle vous mettez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/Automattic/node-canvas#compiling</a> . </p><br><p>  Apr√®s cela, vous pouvez ajouter chart.js, modules chartjs-node dans les param√®tres du pilote javascript.  Ils doivent s'installer correctement, sans erreurs.  Sinon, traitez les erreurs et r√©solvez-les. </p><br><p>  Et puis, vous pouvez √©crire un script. </p><br><p>  Voici un script pour un exemple, comme  il inclut l'utilisation du pilote d'historique et utilise des noms d'√©tat sp√©cifiques. </p><br><p>  Attention!  Le script a des constructions compliqu√©es pour les d√©butants - Promise.  C'est un moyen pratique de ne pas √©crire de fonctions avec rappel, mais de faire des cha√Ænes d'√©tapes.  Ainsi, par exemple, il est commode de le faire pour obtenir des donn√©es de l'historique des √©tats. </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ChartjsNode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chartjs-node'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *  sendTo  Promise,      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter, cmd, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendTo(adapter, cmd, params, (result) =&gt; { resolve(result); }); }); } <span class="hljs-comment"><span class="hljs-comment">//    const chartColors = { black: 'rgb(0, 0, 0)', red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)', grey: 'rgb(201, 203, 207)' }; /** *        * : * @param config -     * @param filename -     * : * @param Promise -    */ function doDraw(config, filename) { //     640x480  var chartNode = new ChartjsNode(640, 480); return chartNode.drawChart(config) .then(() =&gt; { //     return chartNode.writeImageToFile('image/png', filename); }); } /** *     ChartJS. * : * @param Promise -    */ function prepareDraw0(){ // ,    var ; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       ,      .then(()=&gt;{ //  ,   ,      = [ {"val":3,"ack":1,"ts":1539063874301}, {"val":5,"ack":1,"ts":1539063884299}, {"val":5.3,"ack":1,"ts":1539063894299}, {"val":3.39,"ack":1,"ts":1539063904301}, {"val":5.6,"ack":1,"ts":1539063914300}, {"val":-1.3,"ack":1,"ts":1539063924300}, {"val":-6.3,"ack":1,"ts":1539063934302}, {"val":1.23,"ack":1,"ts":1539063944301}, ]; }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //   label: '', //  backgroundColor: chartColors.black, borderColor: chartColors.black, //   pointRadius: 3, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, }] } } }; return chartJsOptions; }); } /** *     ChartJS. *         , *     . * * : * @param hours -  ,     * : * @param Promise -    */ function prepareDraw1(hours){ //   ,      const end = new Date().getTime(), start = end - 3600000*(hours || 1); // 1 =   //  ,       //   var , 2, 1, 2, 2; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       'mqtt.0.ESP_Easy..Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'mqtt.0.ESP_Easy..Temperature', options: { start: start, end: end, aggregate: 'onchange' } } ).then((result) =&gt; { //     ''  = result.result; }); }) //       'sonoff.0.chicken2.DS18B20_Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ //     '2' 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.sonoff_chicken_vent.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 1 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER1', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER2', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //           label: ' ('+[.length - 1].val+')', //  backgroundColor: chartColors.blue, borderColor: chartColors.blue, //  . 0 -   pointRadius: 0, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, //   Y yAxisID: 'y-axis-1', },{ label: ' 1 ('+1[1.length - 1].val+')', backgroundColor: chartColors.green, borderColor: chartColors.green, pointRadius: 0, borderWidth: 3, data: 1.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2 ('+2[2.length - 1].val+')', backgroundColor: chartColors.red, borderColor: chartColors.red, pointRadius: 0, borderWidth: 3, data: 2.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.yellow, borderColor: chartColors.yellow, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? 1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.grey, borderColor: chartColors.grey, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? -1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, //    () time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, //   -  position: 'left', //   id: 'y-axis-1', },{ type: 'linear', display: true, scaleLabel: { display: true, labelString: '  ' }, ticks: { min: -4, max: 2 }, //   -  position: 'right', id: 'y-axis-2', }] } } }; return chartJsOptions; }); } function createImage(filename, callback){ // filename -  ,       //    prepareDraw1(2) //     .then((result) =&gt; { //        return doDraw(result, filename); }) .then(()=&gt;{ if (callback) callback(); }) .catch((err)=&gt;{ console.error(err); }); }</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/webt/4c/d5/bs/4cd5bslfzniznrd16qfmqu0tuly.png" alt="Diffuser l'image au lieu du flux" title="Diffuseur l'image au lieu du flux"></p><br><p>  L'image miniature est mise √† jour environ une fois par minute, nous allons donc configurer l'image pour qu'elle soit mise √† jour toutes les 10 secondes: </p><br><pre> <code class="plaintext hljs">var fs = require('fs'); //  10    schedule("*/10 * * * * *", () =&gt; {  createImage1('/tmp/1_new.jpg', ()=&gt; {      fs.renameSync('/tmp/1_new.jpg', '/tmp/1.jpg');  });  createImage2('/tmp/2_new.jpg', ()=&gt; {      fs.renameSync('/tmp/2_new.jpg', '/tmp/2.jpg');  }); });</code> </pre> <br><p>  La particularit√© est que dans le processus de diffusion de l'image, il est n√©cessaire de remplacer l'image assez rapidement pour que ffmpeg ne se bloque pas :) Par cons√©quent, l'image est d'abord form√©e dans un fichier, puis le fichier est renomm√© en celui utilis√© pour la traduction. </p><br><p>  Maintenant, dans les param√®tres de la cam√©ra, sp√©cifiez le nom du fichier g√©n√©r√© au lieu de l'adresse du flux et ajoutez les param√®tres selon lesquels l'image est "mise √† jour" (param√®tre "-loop 1").  Ceci est configur√© dans les propri√©t√©s avanc√©es de la cam√©ra.  Ces propri√©t√©s ne sont rien de plus que des options de ligne de commande pour ex√©cuter ffmpeg.  Par cons√©quent, des combinaisons de param√®tres doivent √™tre trouv√©es dans la documentation et les exemples de ffmpeg. </p><br><p>  Les propri√©t√©s sont divis√©es en 2 types: pour recevoir un ¬´aper√ßu¬ª (une petite image de la cam√©ra) et pour la diffusion.  Par cons√©quent, vous pouvez sp√©cifier diff√©rents fichiers source d'image, par exemple avec des d√©tails diff√©rents. </p><br><p><img src="https://habrastorage.org/webt/zy/30/b4/zy30b4wc2zud54wr-px_ezovdgu.png" alt="Options de d√©marrage de Ffmpeg" title="Options de d√©marrage de Ffmpeg"></p><br><p><img src="https://habrastorage.org/webt/mk/l5/qi/mkl5qizqb41if_youa62qrgm9hc.png" alt="Image de diffusion en direct" title="Image de diffusion en direct"></p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>         ioBroker     .       ,       . ,   ,        . </p><br><p>  ,    Yahka       ,      Material.           ,            HomeKit. </p><br><p>       Yahka,    HomeKit     ‚Äî  Ham,     HomeBridge         .       . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433798/">https://habr.com/ru/post/fr433798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433786/index.html">Fintech Digest: la crypto-monnaie est la propri√©t√©, un nombre record de cartes de cr√©dit ont √©t√© √©mises en F√©d√©ration de Russie</a></li>
<li><a href="../fr433788/index.html">Offre s√©curis√©e et nouveaux avis ind√©pendants</a></li>
<li><a href="../fr433790/index.html">Mod√®les de construction avanc√©s en plusieurs √©tapes</a></li>
<li><a href="../fr433792/index.html">Scripts shell dans Ansible</a></li>
<li><a href="../fr433796/index.html">Comment Homo Sapiens a conquis le monde. Comp√©tences en communication et n√©gociation</a></li>
<li><a href="../fr433800/index.html">Utilisation des contr√¥leurs UDB PSoC de Cypress pour r√©duire les interruptions dans une imprimante 3D</a></li>
<li><a href="../fr433802/index.html">Comment et pourquoi nous avons remport√© la piste Big Data au Urban Tech Challenge Hackathon</a></li>
<li><a href="../fr433804/index.html">R√©seaux de densit√© de m√©lange</a></li>
<li><a href="../fr433806/index.html">Quand l'archive en ligne oublie</a></li>
<li><a href="../fr433808/index.html">5 erreurs les plus courantes commises par les programmeurs lors de l'entretien</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>