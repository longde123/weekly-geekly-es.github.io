<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™ŒğŸ» ğŸ‘ğŸ¿ ğŸ¥… åœ¨Androidä¸­ç¼“å­˜åˆ†é¡µ ğŸ¦‚ ğŸ‘’ ğŸ‘©ğŸ¼â€ğŸš’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å½“ç„¶ï¼Œæ¯ä¸ªAndroidå¼€å‘äººå‘˜éƒ½ä½¿ç”¨RecyclerViewå¤„ç†åˆ—è¡¨ã€‚ è€Œä¸”ï¼Œè®¸å¤šäººè®¾æ³•ä½¿ç”¨Android Architecture Componentsçš„Paging Libraryåœ¨åˆ—è¡¨ä¸­æŸ¥çœ‹å¦‚ä½•ç»„ç»‡åˆ†é¡µã€‚ 


 è¿™å¾ˆç®€å•ï¼šè®¾ç½®PositionalDataSourceï¼Œè®¾ç½®é…ç½®ï¼Œåˆ›å»ºPage...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Androidä¸­ç¼“å­˜åˆ†é¡µ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431212/"><p> å½“ç„¶ï¼Œæ¯ä¸ªAndroidå¼€å‘äººå‘˜éƒ½ä½¿ç”¨RecyclerViewå¤„ç†åˆ—è¡¨ã€‚ è€Œä¸”ï¼Œè®¸å¤šäººè®¾æ³•ä½¿ç”¨Android Architecture Componentsçš„Paging Libraryåœ¨åˆ—è¡¨ä¸­æŸ¥çœ‹å¦‚ä½•ç»„ç»‡åˆ†é¡µã€‚ </p><br><p> è¿™å¾ˆç®€å•ï¼šè®¾ç½®PositionalDataSourceï¼Œè®¾ç½®é…ç½®ï¼Œåˆ›å»ºPagedListå¹¶ä½¿ç”¨é€‚é…å™¨å’ŒDiffUtilCallbackå°†å…¶å…¨éƒ¨è¾“å…¥åˆ°æˆ‘ä»¬çš„RecyclerViewã€‚ </p><br><p> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å‡ ä¸ªæ•°æ®æºæ€ä¹ˆåŠï¼Ÿ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨Roomä¸­æ‹¥æœ‰ä¸€ä¸ªç¼“å­˜å¹¶ä»ç½‘ç»œæ¥æ”¶æ•°æ®ã€‚ </p><br><p> äº‹å®è¯æ˜ï¼Œè¿™ç§æƒ…å†µå¾ˆæ™®é€šï¼ŒInternetä¸Šæ²¡æœ‰å¤ªå¤šæœ‰å…³æ­¤ä¸»é¢˜çš„ä¿¡æ¯ã€‚ æˆ‘å°†å°è¯•ä¿®å¤å®ƒï¼Œå¹¶è¯´æ˜å¦‚ä½•è§£å†³è¿™ç§æƒ…å†µã€‚ </p><br><p><img src="https://habrastorage.org/webt/dr/rb/pt/drrbpt4z7xdhflrucv1wwhbi0ya.png" alt="å›¾ç‰‡"></p><a name="habracut"></a><br><p>å¦‚æœæ‚¨ä»ç„¶ä¸ç†Ÿæ‚‰ä½¿ç”¨å•ä¸ªæ•°æ®æºè¿›è¡Œåˆ†é¡µçš„å®ç°ï¼Œé‚£ä¹ˆå»ºè®®æ‚¨åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰å…ˆç†Ÿæ‚‰ä¸€ä¸‹å®ƒã€‚ </p><br><p> æ²¡æœ‰åˆ†é¡µçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><ul><li> è®¿é—®ç¼“å­˜ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼‰ </li><li> å¦‚æœç¼“å­˜ä¸ºç©º-å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ </li><li> æˆ‘ä»¬ä»æœåŠ¡å™¨æ¥æ”¶æ•°æ® </li><li> æˆ‘ä»¬å°†å®ƒä»¬æ˜¾ç¤ºåœ¨å·¥ä½œè¡¨ä¸­ </li><li> å†™å…¥ç¼“å­˜ </li><li> å¦‚æœæœ‰ç¼“å­˜-åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºå®ƒ </li><li> æˆ‘ä»¬ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ® </li><li> æˆ‘ä»¬å°†å®ƒä»¬æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­â—‹ </li><li> å†™å…¥ç¼“å­˜ </li></ul><br><p><img src="https://habrastorage.org/webt/xb/bf/rc/xbbfrcomnghx9krpgaylinmbfn0.png" alt="å›¾ç‰‡"></p><br><p> åˆ†é¡µè¿™æ ·æ–¹ä¾¿çš„äº‹æƒ…ï¼Œç®€åŒ–äº†ç”¨æˆ·çš„ç”Ÿæ´»ï¼Œè¿™ä½¿æˆ‘ä»¬å¤æ‚åŒ–ã€‚ è®©æˆ‘ä»¬å°è¯•æƒ³è±¡ä¸€ä¸‹åœ¨å®ç°å…·æœ‰å¤šä¸ªæ•°æ®æºçš„åˆ†é¡µåˆ—è¡¨æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚ </p><br><p> è¯¥ç®—æ³•å¤§è‡´å¦‚ä¸‹ï¼š </p><br><ul><li> è·å–ç¬¬ä¸€é¡µçš„ç¼“å­˜æ•°æ® </li><li> å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œåˆ™è·å–æœåŠ¡å™¨æ•°æ®ï¼Œå°†å…¶æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­å¹¶å†™å…¥æ•°æ®åº“ </li><li> å¦‚æœæœ‰ç¼“å­˜ï¼Œè¯·å°†å…¶åŠ è½½åˆ°åˆ—è¡¨ä¸­ </li><li> å¦‚æœæˆ‘ä»¬åˆ°è¾¾æ•°æ®åº“çš„æœ«å°¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œæ˜¾ç¤ºå®ƒä»¬ </li><li> åœ¨åˆ—è¡¨ä¸­å¹¶å†™å…¥æ•°æ®åº“ </li></ul><br><p> åœ¨è¿™ç§æ–¹æ³•çš„åŠŸèƒ½ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¦æ˜¾ç¤ºåˆ—è¡¨ï¼Œé¦–å…ˆè½®è¯¢ç¼“å­˜ï¼Œå¹¶ä¸”åŠ è½½æ–°æ•°æ®çš„ä¿¡å·æ˜¯ç¼“å­˜çš„ç»“å°¾ã€‚ </p><br><p><img src="https://habrastorage.org/webt/_p/wr/ox/_pwroxafp3jdf1gu3p_snotmkgg.png" alt="å›¾ç‰‡"></p><br><p>  Googleè€ƒè™‘äº†ä¸€ä¸‹ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªä»PagingLibraryæ¡†å‡ºæ¥çš„è§£å†³æ–¹æ¡ˆ-BoundaryCallbackã€‚ </p><br><p>  BoundaryCallbackæŠ¥å‘Šæœ¬åœ°æ•°æ®æºä½•æ—¶â€œç»“æŸâ€å¹¶é€šçŸ¥å­˜å‚¨åº“ä¸‹è½½æ–°æ•°æ®ã€‚ </p><br><p><img src="https://habrastorage.org/webt/jp/fz/pt/jpfzptfobfumr_ri8yl8fznkssc.png" alt="å›¾ç‰‡"></p><br><p> å®˜æ–¹çš„Android Devç½‘ç«™æä¾›äº†ä¸€ä¸ªåˆ°å¸¦æœ‰ç¤ºä¾‹é¡¹ç›®çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å­˜å‚¨åº“</a>çš„é“¾æ¥ï¼Œè¯¥ç¤ºä¾‹é¡¹ç›®ä½¿ç”¨å¸¦æœ‰ä¸¤ä¸ªæ•°æ®æºçš„åˆ†é¡µåˆ—è¡¨ï¼šç½‘ç»œï¼ˆæ”¹é€ 2ï¼‰+æ•°æ®åº“ï¼ˆæˆ¿é—´ï¼‰ã€‚ ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ç§ç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼Œè®©æˆ‘ä»¬å°è¯•åˆ†ææ­¤ç¤ºä¾‹å¹¶å°†å…¶ç®€åŒ–ä¸€ä¸‹ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»æ•°æ®å±‚å¼€å§‹ã€‚ åˆ›å»ºä¸¤ä¸ªæ•°æ®æºã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç•Œé¢RedditApi.kt</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Call <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.http.GET <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.http.Path <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.http.Query <span class="hljs-comment"><span class="hljs-comment">/** * API communication setup */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditApi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"/r/{subreddit}/hot.json"</span></span>) <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Path(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"subreddit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> subreddit: String, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"limit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> limit: Int): Call&lt;ListingResponse&gt; </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// for after/before param, either get from RedditDataResponse.after/before, // or pass RedditNewsDataResponse.name (though this is technically incorrect) @GET("/r/{subreddit}/hot.json") fun getTopAfter( @Path("subreddit") subreddit: String, @Query("after") after: String, @Query("limit") limit: Int): Call&lt;ListingResponse&gt; @GET("/r/{subreddit}/hot.json") fun getTopBefore( @Path("subreddit") subreddit: String, @Query("before") before: String, @Query("limit") limit: Int): Call&lt;ListingResponse&gt; class ListingResponse(val data: ListingData) class ListingData( val children: List&lt;RedditChildrenResponse&gt;, val after: String?, val before: String? ) data class RedditChildrenResponse(val data: RedditPost) }</span></span></span></span></code> </pre> </div></div><br><p> è¯¥æ¥å£æè¿°äº†å¯¹Reddit APIçš„è¯·æ±‚ä»¥åŠæ¨¡å‹å“åº”ï¼ˆListingResponseï¼ŒListingDataï¼ŒRedditChildrenResponseï¼‰ï¼ŒAPIå“åº”å°†è¢«æŠ˜å åˆ°å…¶ä¸­ã€‚ </p><br><p> å¹¶ç«‹å³ä¸ºæ”¹é€ å’Œæˆ¿é—´å»ºæ¨¡ </p><br><div class="spoiler">  <b class="spoiler_title">RedditPost.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.ColumnInfo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Entity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Index <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.PrimaryKey <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.gson.annotations.SerializedName <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(tableName = <span class="hljs-string"><span class="hljs-string">"posts"</span></span>, indices = [Index(value = [<span class="hljs-string"><span class="hljs-string">"subreddit"</span></span>], unique = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)]) <span class="hljs-function"><span class="hljs-function">data class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RedditPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @PrimaryKey @SerializedName(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> val name: String, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializedName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"title"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> val title: String, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializedName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"score"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> val score: Int, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializedName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"author"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> val author: String, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializedName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"subreddit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// this seems mutable but fine for a demo @ColumnInfo(collate = ColumnInfo.NOCASE) val subreddit: String, @SerializedName("num_comments") val num_comments: Int, @SerializedName("created_utc") val created: Long, val thumbnail: String?, val url: String?) { // to be consistent w/ changing backend order, we need to keep a data like this var indexInResponse: Int = -1 }</span></span></span></span></code> </pre> </div></div><br><p>  RedditDb.ktç±»å°†ç»§æ‰¿RoomDatabaseã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">Redditdb.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Database <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.RoomDatabase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-comment"><span class="hljs-comment">/** * Database schema used by the DbRedditPostRepository */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Database</span></span>( entities = [RedditPost::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">1</span></span>, exportSchema = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditDb</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomDatabase</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: RedditPostDao }</span></span></code> </pre> </div></div><br><p>  <em>è¯·è®°ä½ï¼Œæ¯æ¬¡åˆ›å»ºRoomDatabaseç±»æ¥æ‰§è¡Œå¯¹æ•°æ®åº“çš„æŸ¥è¯¢éƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œå› æ­¤ï¼Œå®é™…ä¸Šï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½åˆ›å»ºä¸€æ¬¡ï¼</em> </p><br><p> å’Œå¸¦æœ‰æ•°æ®åº“æŸ¥è¯¢çš„Daoç±»RedditPostDao.kt </p><br><div class="spoiler">  <b class="spoiler_title">RedditPostDao.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.DataSource <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Dao <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Insert <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.OnConflictStrategy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Query <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditPostDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span>(onConflict = OnConflictStrategy.REPLACE) <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(posts : List&lt;RedditPost&gt;)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"SELECT * FROM posts WHERE subreddit = :subreddit ORDER BY indexInResponse ASC"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postsBySubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subreddit : String)</span></span></span><span class="hljs-function"> : DataSource.Factory&lt;Int, RedditPost&gt; @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"DELETE FROM posts WHERE subreddit = :subreddit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteBySubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subreddit: String)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"SELECT MAX(indexInResponse) + 1 FROM posts WHERE subreddit = :subreddit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextIndexInSubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subreddit: String)</span></span></span><span class="hljs-function"> : Int }</span></span></code> </pre> </div></div><br><p> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°postsBySubredditå¸–å­æ£€ç´¢æ–¹æ³•è¿”å› <br>  DataSource.Factoryã€‚ è¿™å¯¹äºä½¿ç”¨åˆ›å»ºæˆ‘ä»¬çš„PagedListæ˜¯å¿…è¦çš„ <br>  LivePagedListBuilderï¼Œåœ¨åå°çº¿ç¨‹ä¸­ã€‚ æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­äº†è§£æ›´å¤šä¿¡æ¯ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯¾</a> ã€‚ </p><br><p> å¾ˆå¥½ï¼Œæ•°æ®å±‚å·²å‡†å¤‡å°±ç»ªã€‚ æˆ‘ä»¬è½¬å‘ä¸šåŠ¡é€»è¾‘å±‚ï¼Œä¸ºäº†å®ç°å­˜å‚¨åº“æ¨¡å¼ï¼Œä¹ æƒ¯ä¸Šæ˜¯å°†å­˜å‚¨åº“æ¥å£ä¸å…¶å®ç°åˆ†å¼€åˆ›å»ºã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ¥å£RedditPostRepository.kt </p><br><div class="spoiler">  <b class="spoiler_title">RedditPostRepository.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditPostRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postsOfSubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subReddit: String, pageSize: Int)</span></span></span><span class="hljs-function">: Listing&lt;RedditPost&gt; }</span></span></code> </pre> </div></div><br><p> æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼šä»€ä¹ˆæ ·çš„æ¸…å•ï¼Ÿ è¿™æ˜¯æ˜¾ç¤ºåˆ—è¡¨æ‰€éœ€çš„æ—¥æœŸç±»ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">Listing.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.LiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.PagedList <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.NetworkState <span class="hljs-comment"><span class="hljs-comment">/** * Data class that is necessary for a UI to show a listing and interact w/ the rest of the system */</span></span> data <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listing</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;( // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LiveData</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paged</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lists</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">observe</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pagedList</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LiveData</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PagedList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;&gt;, // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">represents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">networkState</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LiveData</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkState</span></span></span><span class="hljs-class">&gt;, // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">represents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refresh</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Separate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">networkState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">importantly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">only</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">when</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refresh</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requested</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refreshState</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LiveData</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkState</span></span></span><span class="hljs-class">&gt;, // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refreshes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whole</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetches</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">it</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scratch</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refresh</span></span></span><span class="hljs-class">: () -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class">, // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">retries</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">any</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requests</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">retry</span></span></span><span class="hljs-class">: () -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class">)</span></span></code> </pre> </div></div><br><p> åˆ›å»ºMainRepository.ktå­˜å‚¨åº“çš„å®ç° </p><br><div class="spoiler">  <b class="spoiler_title">MainRepository.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.MainThread <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.LiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.MutableLiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.Transformations <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.example.paging.pagingwithnetwork.reddit.api.RedditApi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Retrofit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.converter.gson.GsonConverterFactory <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.room.Room <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.example.paging.pagingwithnetwork.reddit.db.RedditDb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.example.paging.pagingwithnetwork.reddit.db.RedditPostDao <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Call <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Callback <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.Executors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.LivePagedListBuilder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.core.Listing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.boundary.SubredditBoundaryCallback <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.NetworkState <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.core.<span class="hljs-function"><span class="hljs-function">RedditPostRepository class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: Context)</span></span></span><span class="hljs-function"> : RedditPostRepository </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> retrofit: Retrofit = Retrofit.Builder() .baseUrl(<span class="hljs-string"><span class="hljs-string">"https://www.reddit.com/"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   .addConverterFactory(GsonConverterFactory.create()) //,    JSON'   .build() var db = Room.databaseBuilder(context, RedditDb::class.java, "database").build() private var redditApi: RedditApi private var dao: RedditPostDao val ioExecutor = Executors.newSingleThreadExecutor() init { redditApi = retrofit.create(RedditApi::class.java) // ,       dao = db.posts() } /** * Inserts the response into the database while also assigning position indices to items. */ private fun insertResultIntoDb(subredditName: String, body: RedditApi.ListingResponse?) { body!!.data.children.let { posts -&gt; db.runInTransaction { val start = db.posts().getNextIndexInSubreddit(subredditName) val items = posts.mapIndexed { index, child -&gt; child.data.indexInResponse = start + index child.data } db.posts().insert(items) } } } /** * When refresh is called, we simply run a fresh network request and when it arrives, clear * the database table and insert all new items in a transaction. * &lt;p&gt; * Since the PagedList already uses a database bound data source, it will automatically be * updated after the database transaction is finished. */ @MainThread private fun refresh(subredditName: String): LiveData&lt;NetworkState&gt; { val networkState = MutableLiveData&lt;NetworkState&gt;() networkState.value = NetworkState.LOADING redditApi.getTop(subredditName, 10).enqueue( object : Callback&lt;RedditApi.ListingResponse&gt; { override fun onFailure(call: Call&lt;RedditApi.ListingResponse&gt;, t: Throwable) { // retrofit calls this on main thread so safe to call set value networkState.value = NetworkState.error(t.message) } override fun onResponse(call: Call&lt;RedditApi.ListingResponse&gt;, response: Response&lt;RedditApi.ListingResponse&gt;) { ioExecutor.execute { db.runInTransaction { db.posts().deleteBySubreddit(subredditName) insertResultIntoDb(subredditName, response.body()) } // since we are in bg thread now, post the result. networkState.postValue(NetworkState.LOADED) } } } ) return networkState } /** * Returns a Listing for the given subreddit. */ override fun postsOfSubreddit(subReddit: String, pageSize: Int): Listing&lt;RedditPost&gt; { // create a boundary callback which will observe when the user reaches to the edges of // the list and update the database with extra data. val boundaryCallback = SubredditBoundaryCallback( webservice = redditApi, subredditName = subReddit, handleResponse = this::insertResultIntoDb, ioExecutor = ioExecutor, networkPageSize = pageSize) // we are using a mutable live data to trigger refresh requests which eventually calls // refresh method and gets a new live data. Each refresh request by the user becomes a newly // dispatched data in refreshTrigger val refreshTrigger = MutableLiveData&lt;Unit&gt;() val refreshState = Transformations.switchMap(refreshTrigger) { refresh(subReddit) } // We use toLiveData Kotlin extension function here, you could also use LivePagedListBuilder val livePagedList = LivePagedListBuilder(db.posts().postsBySubreddit(subReddit), pageSize) .setBoundaryCallback(boundaryCallback) .build() return Listing( pagedList = livePagedList, networkState = boundaryCallback.networkState, retry = { boundaryCallback.helper.retryAllFailed() }, refresh = { refreshTrigger.value = null }, refreshState = refreshState ) } }</span></span></code> </pre> </div></div><br><p> è®©æˆ‘ä»¬çœ‹çœ‹å­˜å‚¨åº“ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚ </p><br><p> åˆ›å»ºæˆ‘ä»¬çš„æ•°æ®æºå’Œæ•°æ®è®¿é—®æ¥å£çš„å®ä¾‹ã€‚ å¯¹äºæ•°æ®åº“ï¼š </p><br><p> ç”¨äºç½‘ç»œçš„RoomDatabaseå’ŒDaoï¼šç¿»æ–°å’Œapiæ¥å£ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°æ‰€éœ€çš„å­˜å‚¨åº“æ–¹æ³• </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postsOfSubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subReddit: String, pageSize: Int)</span></span></span><span class="hljs-function">: Listing&lt;RedditPost&gt;</span></span></code> </pre> <br><p> è®¾ç½®åˆ†é¡µï¼š </p><br><ul><li> åˆ›å»ºä¸€ä¸ªç»§æ‰¿PagedList.BoundaryCallback &lt;&gt;çš„SubRedditBoundaryCallback </li><li> æˆ‘ä»¬å°†æ„é€ å‡½æ•°ä¸å‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¼ é€’BoundaryCallbackå·¥ä½œæ‰€éœ€çš„ä¸€åˆ‡ </li><li> åˆ›å»ºrefreshTriggerè§¦å‘å™¨ä»¥é€šçŸ¥å­˜å‚¨åº“æœ‰å…³æ›´æ–°æ•°æ®çš„éœ€æ±‚ </li><li> åˆ›å»ºå¹¶è¿”å›æ¸…å•å¯¹è±¡ </li></ul><br><p> åœ¨æ¸…å•å¯¹è±¡ä¸­ï¼š </p><br><ul><li>  livePagedList </li><li>  networkState-ç½‘ç»œçŠ¶æ€ </li><li> é‡è¯•-å›è°ƒä»¥è°ƒç”¨ä»æœåŠ¡å™¨æ£€ç´¢æ•°æ® </li><li> åˆ·æ–°-è§¦å‘æ›´æ–°æ•°æ® </li><li>  refreshState-æ›´æ–°è¿‡ç¨‹çš„çŠ¶æ€ </li></ul><br><p> æˆ‘ä»¬å®æ–½è¾…åŠ©æ–¹æ³• </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertResultIntoDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subredditName: String, body: RedditApi.ListingResponse?)</span></span></span></span></code> </pre> <br><p> åœ¨æ•°æ®åº“ä¸­è®°å½•ç½‘ç»œå“åº”ã€‚ å½“æ‚¨éœ€è¦æ›´æ–°åˆ—è¡¨æˆ–å†™å…¥æ–°æ•°æ®æ—¶ï¼Œå°†ä½¿ç”¨å®ƒã€‚ </p><br><p> æˆ‘ä»¬å®æ–½è¾…åŠ©æ–¹æ³• </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subredditName: String)</span></span></span><span class="hljs-function">: LiveData&lt;NetworkState&gt;</span></span></code> </pre> <br><p> ç”¨äºæ•°æ®åˆ·æ–°è§¦å‘å™¨ã€‚ è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼šæˆ‘ä»¬ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œæ¸…ç†æ•°æ®åº“ï¼Œå°†æ–°æ•°æ®å†™å…¥æ•°æ®åº“ã€‚ </p><br><p> æˆ‘ä»¬æ‰¾å‡ºäº†å­˜å‚¨åº“ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹SubredditBoundaryCallbackã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">SubredditBoundaryCallback.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.PagedList <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.MainThread <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.android.example.paging.pagingwithnetwork.reddit.api.RedditApi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Call <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Callback <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> retrofit2.Response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.Executor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.createStatusLiveData <span class="hljs-comment"><span class="hljs-comment">/** * This boundary callback gets notified when user reaches to the edges of the list such that the * database cannot provide any more data. * &lt;p&gt; * The boundary callback might be called multiple times for the same direction so it does its own * rate limiting using the com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper class. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SubredditBoundaryCallback</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subredditName</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webservice</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditApi</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handleResponse</span></span></span><span class="hljs-class">: (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditApi</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingResponse</span></span></span><span class="hljs-class">?) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ioExecutor</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Executor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">networkPageSize</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class">) : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PagedList</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BoundaryCallback</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditPost</span></span></span><span class="hljs-class">&gt;() </span></span>{ val helper = PagingRequestHelper(ioExecutor) val networkState = helper.createStatusLiveData() <span class="hljs-comment"><span class="hljs-comment">/** * Database returned 0 items. We should query the backend for more items. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@MainThread</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onZeroItemsLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ helper.runIfNotRunning(PagingRequestHelper.RequestType.INITIAL) { webservice.getTop( subreddit = subredditName, limit = networkPageSize) .enqueue(createWebserviceCallback(it)) } } <span class="hljs-comment"><span class="hljs-comment">/** * User reached to the end of the list. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@MainThread</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemAtEndLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(itemAtEnd: RedditPost)</span></span></span><span class="hljs-function"> </span></span>{ helper.runIfNotRunning(PagingRequestHelper.RequestType.AFTER) { webservice.getTopAfter( subreddit = subredditName, after = itemAtEnd.name, limit = networkPageSize) .enqueue(createWebserviceCallback(it)) } } <span class="hljs-comment"><span class="hljs-comment">/** * every time it gets new items, boundary callback simply inserts them into the database and * paging library takes care of refreshing the list if necessary. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertItemsIntoDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( response: Response&lt;RedditApi.ListingResponse&gt;, it: PagingRequestHelper.Request.Callback)</span></span></span><span class="hljs-function"> </span></span>{ ioExecutor.execute { handleResponse(subredditName, response.body()) it.recordSuccess() } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemAtFrontLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(itemAtFront: RedditPost)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ignored, since we only ever append to what's in the DB } private fun createWebserviceCallback(it: PagingRequestHelper.Request.Callback) : Callback&lt;RedditApi.ListingResponse&gt; { return object : Callback&lt;RedditApi.ListingResponse&gt; { override fun onFailure(call: Call&lt;RedditApi.ListingResponse&gt;, t: Throwable) { it.recordFailure(t) } override fun onResponse( call: Call&lt;RedditApi.ListingResponse&gt;, response: Response&lt;RedditApi.ListingResponse&gt;) { insertItemsIntoDb(response, it) } } } }</span></span></code> </pre> </div></div><br><p> åœ¨ç±»ä¸­ç»§æ‰¿BoundaryCallbackçš„å‡ ç§å¿…éœ€æ–¹æ³•ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onZeroItemsLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre> <br><p> å½“æ•°æ®åº“ä¸ºç©ºæ—¶è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å¿…é¡»å‘æœåŠ¡å™¨æ‰§è¡Œè¯·æ±‚ä»¥è·å–ç¬¬ä¸€é¡µã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemAtEndLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(itemAtEnd: RedditPost)</span></span></span></span></code> </pre> <br><p> å½“â€œè¿­ä»£å™¨â€åˆ°è¾¾æ•°æ®åº“çš„â€œåº•éƒ¨â€æ—¶ï¼Œå°†è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å¿…é¡»æŸ¥è¯¢æœåŠ¡å™¨ä»¥è·å–ä¸‹ä¸€é¡µï¼Œå¹¶ä¼ é€’å¯†é’¥ï¼ŒæœåŠ¡å™¨å°†ä½¿ç”¨è¯¥å¯†é’¥åœ¨æœ¬åœ°å­˜å‚¨çš„æœ€åä¸€æ¡è®°å½•ä¹‹åç«‹å³è¾“å‡ºæ•°æ®ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onItemAtFrontLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(itemAtFront: RedditPost)</span></span></span></span></code> </pre> <br><p> å½“â€œè¿­ä»£å™¨â€åˆ°è¾¾å•†åº—çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå°†è°ƒç”¨è¯¥æ–¹æ³•ã€‚ è¦å®ç°æˆ‘ä»¬çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥æ­¤æ–¹æ³•çš„å®ç°ã€‚ </p><br><p> æ·»åŠ å›è°ƒä»¥æ¥æ”¶æ•°æ®å¹¶è¿›ä¸€æ­¥ä¼ è¾“ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createWebserviceCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(it: PagingRequestHelper.Request.Callback)</span></span></span><span class="hljs-function"> : Callback&lt;RedditApi.ListingResponse&gt;</span></span></code> </pre> <br><p> æˆ‘ä»¬æ·»åŠ äº†å°†æ¥æ”¶åˆ°çš„æ•°æ®è®°å½•åœ¨æ•°æ®åº“ä¸­çš„æ–¹æ³• </p><br><pre> <code class="java hljs">insertItemsIntoDb( response: Response&lt;RedditApi.ListingResponse&gt;, it: PagingRequestHelper.Request.Callback)</code> </pre> <br><p> ä»€ä¹ˆæ˜¯PagingRequestHelperåŠ©æ‰‹ï¼Ÿ è¿™æ˜¯Googleæä¾›ç»™æˆ‘ä»¬çš„HEALTHYç±»ï¼Œå¯ä»¥å°†å…¶æ”¾å…¥åº“ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬åªæ˜¯å°†å…¶å¤åˆ¶åˆ°é€»è¾‘å±‚åŒ…ä¸­ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">PagingRequestHelper.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.memebattle.pagingwithrepository.domain.util;<span class="hljs-comment"><span class="hljs-comment">/* * Copyright 2017 The Android Open Source Project * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.CopyOnWriteArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.Executor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.atomic.AtomicBoolean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.AnyThread; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.GuardedBy; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.NonNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.Nullable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.annotation.VisibleForTesting; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.DataSource; <span class="hljs-comment"><span class="hljs-comment">/** * A helper class for {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> androidx.paging.PagedList.BoundaryCallback BoundaryCallback}s and * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> DataSource}s to help with tracking network requests. * &lt;p&gt; * It is designed to support 3 types of requests, {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> RequestType#INITIAL INITIAL}, * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> RequestType#BEFORE BEFORE} and {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> RequestType#AFTER AFTER} and runs only 1 request * for each of them via {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> #runIfNotRunning(RequestType, Request)}. * &lt;p&gt; * It tracks a {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Status} and an {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@code</span></span></span><span class="hljs-comment"> error} for each {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> RequestType}. * &lt;p&gt; * A sample usage of this class to limit requests looks like this: * &lt;pre&gt; * class PagingBoundaryCallback extends PagedList.BoundaryCallback&amp;lt;MyItem&gt; { * // TODO replace with an executor from your application * Executor executor = Executors.newSingleThreadExecutor(); * com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper helper = new com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper(executor); * // imaginary API service, using Retrofit * MyApi api; * * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onItemAtFrontLoaded({</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}NonNull MyItem itemAtFront) { * helper.runIfNotRunning(com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.RequestType.BEFORE, * helperCallback -&gt; api.getTopBefore(itemAtFront.getName(), 10).enqueue( * new Callback&amp;lt;ApiResponse&gt;() { * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onResponse(Call&amp;lt;ApiResponse&gt; call, * Response&amp;lt;ApiResponse&gt; response) { * // TODO insert new records into database * helperCallback.recordSuccess(); * } * * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onFailure(Call&amp;lt;ApiResponse&gt; call, Throwable t) { * helperCallback.recordFailure(t); * } * })); * } * * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onItemAtEndLoaded({</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}NonNull MyItem itemAtEnd) { * helper.runIfNotRunning(com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.RequestType.AFTER, * helperCallback -&gt; api.getTopBefore(itemAtEnd.getName(), 10).enqueue( * new Callback&amp;lt;ApiResponse&gt;() { * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onResponse(Call&amp;lt;ApiResponse&gt; call, * Response&amp;lt;ApiResponse&gt; response) { * // TODO insert new records into database * helperCallback.recordSuccess(); * } * * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> @}Override * public void onFailure(Call&amp;lt;ApiResponse&gt; call, Throwable t) { * helperCallback.recordFailure(t); * } * })); * } * } * &lt;/pre&gt; * &lt;p&gt; * The helper provides an API to observe combined request status, which can be reported back to the * application based on your business rules. * &lt;pre&gt; * MutableLiveData&amp;lt;com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.Status&gt; combined = new MutableLiveData&amp;lt;&gt;(); * helper.addListener(status -&gt; { * // merge multiple states per request type into one, or dispatch separately depending on * // your application logic. * if (status.hasRunning()) { * combined.postValue(com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.Status.RUNNING); * } else if (status.hasError()) { * // can also obtain the error via {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> StatusReport#getErrorFor(RequestType)} * combined.postValue(com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.Status.FAILED); * } else { * combined.postValue(com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper.Status.SUCCESS); * } * }); * &lt;/pre&gt; */</span></span> <span class="hljs-comment"><span class="hljs-comment">// THIS class is likely to be moved into the library in a future release. Feel free to copy it // from this sample. public class PagingRequestHelper { private final Object mLock = new Object(); private final Executor mRetryService; @GuardedBy("mLock") private final RequestQueue[] mRequestQueues = new RequestQueue[] {new RequestQueue(RequestType.INITIAL), new RequestQueue(RequestType.BEFORE), new RequestQueue(RequestType.AFTER)}; @NonNull final CopyOnWriteArrayList&lt;Listener&gt; mListeners = new CopyOnWriteArrayList&lt;&gt;(); /** * Creates a new com.memebattle.pagingwithrepository.domain.util.PagingRequestHelper with the given {@link Executor} which is used to run * retry actions. * * @param retryService The {@link Executor} that can run the retry actions. */ public PagingRequestHelper(@NonNull Executor retryService) { mRetryService = retryService; } /** * Adds a new listener that will be notified when any request changes {@link Status state}. * * @param listener The listener that will be notified each time a request's status changes. * @return True if it is added, false otherwise (eg it already exists in the list). */ @AnyThread public boolean addListener(@NonNull Listener listener) { return mListeners.add(listener); } /** * Removes the given listener from the listeners list. * * @param listener The listener that will be removed. * @return True if the listener is removed, false otherwise (eg it never existed) */ public boolean removeListener(@NonNull Listener listener) { return mListeners.remove(listener); } /** * Runs the given {@link Request} if no other requests in the given request type is already * running. * &lt;p&gt; * If run, the request will be run in the current thread. * * @param type The type of the request. * @param request The request to run. * @return True if the request is run, false otherwise. */ @SuppressWarnings("WeakerAccess") @AnyThread public boolean runIfNotRunning(@NonNull RequestType type, @NonNull Request request) { boolean hasListeners = !mListeners.isEmpty(); StatusReport report = null; synchronized (mLock) { RequestQueue queue = mRequestQueues[type.ordinal()]; if (queue.mRunning != null) { return false; } queue.mRunning = request; queue.mStatus = Status.RUNNING; queue.mFailed = null; queue.mLastError = null; if (hasListeners) { report = prepareStatusReportLocked(); } } if (report != null) { dispatchReport(report); } final RequestWrapper wrapper = new RequestWrapper(request, this, type); wrapper.run(); return true; } @GuardedBy("mLock") private StatusReport prepareStatusReportLocked() { Throwable[] errors = new Throwable[]{ mRequestQueues[0].mLastError, mRequestQueues[1].mLastError, mRequestQueues[2].mLastError }; return new StatusReport( getStatusForLocked(RequestType.INITIAL), getStatusForLocked(RequestType.BEFORE), getStatusForLocked(RequestType.AFTER), errors ); } @GuardedBy("mLock") private Status getStatusForLocked(RequestType type) { return mRequestQueues[type.ordinal()].mStatus; } @AnyThread @VisibleForTesting void recordResult(@NonNull RequestWrapper wrapper, @Nullable Throwable throwable) { StatusReport report = null; final boolean success = throwable == null; boolean hasListeners = !mListeners.isEmpty(); synchronized (mLock) { RequestQueue queue = mRequestQueues[wrapper.mType.ordinal()]; queue.mRunning = null; queue.mLastError = throwable; if (success) { queue.mFailed = null; queue.mStatus = Status.SUCCESS; } else { queue.mFailed = wrapper; queue.mStatus = Status.FAILED; } if (hasListeners) { report = prepareStatusReportLocked(); } } if (report != null) { dispatchReport(report); } } private void dispatchReport(StatusReport report) { for (Listener listener : mListeners) { listener.onStatusChange(report); } } /** * Retries all failed requests. * * @return True if any request is retried, false otherwise. */ public boolean retryAllFailed() { final RequestWrapper[] toBeRetried = new RequestWrapper[RequestType.values().length]; boolean retried = false; synchronized (mLock) { for (int i = 0; i &lt; RequestType.values().length; i++) { toBeRetried[i] = mRequestQueues[i].mFailed; mRequestQueues[i].mFailed = null; } } for (RequestWrapper failed : toBeRetried) { if (failed != null) { failed.retry(mRetryService); retried = true; } } return retried; } static class RequestWrapper implements Runnable { @NonNull final Request mRequest; @NonNull final PagingRequestHelper mHelper; @NonNull final RequestType mType; RequestWrapper(@NonNull Request request, @NonNull PagingRequestHelper helper, @NonNull RequestType type) { mRequest = request; mHelper = helper; mType = type; } @Override public void run() { mRequest.run(new Request.Callback(this, mHelper)); } void retry(Executor service) { service.execute(new Runnable() { @Override public void run() { mHelper.runIfNotRunning(mType, mRequest); } }); } } /** * Runner class that runs a request tracked by the {@link PagingRequestHelper}. * &lt;p&gt; * When a request is invoked, it must call one of {@link Callback#recordFailure(Throwable)} * or {@link Callback#recordSuccess()} once and only once. This call * can be made any time. Until that method call is made, {@link PagingRequestHelper} will * consider the request is running. */ @FunctionalInterface public interface Request { /** * Should run the request and call the given {@link Callback} with the result of the * request. * * @param callback The callback that should be invoked with the result. */ void run(Callback callback); /** * Callback class provided to the {@link #run(Callback)} method to report the result. */ class Callback { private final AtomicBoolean mCalled = new AtomicBoolean(); private final RequestWrapper mWrapper; private final PagingRequestHelper mHelper; Callback(RequestWrapper wrapper, PagingRequestHelper helper) { mWrapper = wrapper; mHelper = helper; } /** * Call this method when the request succeeds and new data is fetched. */ @SuppressWarnings("unused") public final void recordSuccess() { if (mCalled.compareAndSet(false, true)) { mHelper.recordResult(mWrapper, null); } else { throw new IllegalStateException( "already called recordSuccess or recordFailure"); } } /** * Call this method with the failure message and the request can be retried via * {@link #retryAllFailed()}. * * @param throwable The error that occured while carrying out the request. */ @SuppressWarnings("unused") public final void recordFailure(@NonNull Throwable throwable) { //noinspection ConstantConditions if (throwable == null) { throw new IllegalArgumentException("You must provide a throwable describing" + " the error to record the failure"); } if (mCalled.compareAndSet(false, true)) { mHelper.recordResult(mWrapper, throwable); } else { throw new IllegalStateException( "already called recordSuccess or recordFailure"); } } } } /** * Data class that holds the information about the current status of the ongoing requests * using this helper. */ public static final class StatusReport { /** * Status of the latest request that were submitted with {@link RequestType#INITIAL}. */ @NonNull public final Status initial; /** * Status of the latest request that were submitted with {@link RequestType#BEFORE}. */ @NonNull public final Status before; /** * Status of the latest request that were submitted with {@link RequestType#AFTER}. */ @NonNull public final Status after; @NonNull private final Throwable[] mErrors; StatusReport(@NonNull Status initial, @NonNull Status before, @NonNull Status after, @NonNull Throwable[] errors) { this.initial = initial; this.before = before; this.after = after; this.mErrors = errors; } /** * Convenience method to check if there are any running requests. * * @return True if there are any running requests, false otherwise. */ public boolean hasRunning() { return initial == Status.RUNNING || before == Status.RUNNING || after == Status.RUNNING; } /** * Convenience method to check if there are any requests that resulted in an error. * * @return True if there are any requests that finished with error, false otherwise. */ public boolean hasError() { return initial == Status.FAILED || before == Status.FAILED || after == Status.FAILED; } /** * Returns the error for the given request type. * * @param type The request type for which the error should be returned. * @return The {@link Throwable} returned by the failing request with the given type or * {@code null} if the request for the given type did not fail. */ @Nullable public Throwable getErrorFor(@NonNull RequestType type) { return mErrors[type.ordinal()]; } @Override public String toString() { return "StatusReport{" + "initial=" + initial + ", before=" + before + ", after=" + after + ", mErrors=" + Arrays.toString(mErrors) + '}'; } @Override public boolean equals(Object o) { if (this == o) return true; if (o == null || getClass() != o.getClass()) return false; StatusReport that = (StatusReport) o; if (initial != that.initial) return false; if (before != that.before) return false; if (after != that.after) return false; // Probably incorrect - comparing Object[] arrays with Arrays.equals return Arrays.equals(mErrors, that.mErrors); } @Override public int hashCode() { int result = initial.hashCode(); result = 31 * result + before.hashCode(); result = 31 * result + after.hashCode(); result = 31 * result + Arrays.hashCode(mErrors); return result; } } /** * Listener interface to get notified by request status changes. */ public interface Listener { /** * Called when the status for any of the requests has changed. * * @param report The current status report that has all the information about the requests. */ void onStatusChange(@NonNull StatusReport report); } /** * Represents the status of a Request for each {@link RequestType}. */ public enum Status { /** * There is current a running request. */ RUNNING, /** * The last request has succeeded or no such requests have ever been run. */ SUCCESS, /** * The last request has failed. */ FAILED } /** * Available request types. */ public enum RequestType { /** * Corresponds to an initial request made to a {@link DataSource} or the empty state for * a {@link androidx.paging.PagedList.BoundaryCallback BoundaryCallback}. */ INITIAL, /** * Corresponds to the {@code loadBefore} calls in {@link DataSource} or * {@code onItemAtFrontLoaded} in * {@link androidx.paging.PagedList.BoundaryCallback BoundaryCallback}. */ BEFORE, /** * Corresponds to the {@code loadAfter} calls in {@link DataSource} or * {@code onItemAtEndLoaded} in * {@link androidx.paging.PagedList.BoundaryCallback BoundaryCallback}. */ AFTER } class RequestQueue { @NonNull final RequestType mRequestType; @Nullable RequestWrapper mFailed; @Nullable Request mRunning; @Nullable Throwable mLastError; @NonNull Status mStatus = Status.SUCCESS; RequestQueue(@NonNull RequestType requestType) { mRequestType = requestType; } } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PagingRequestHelperExt.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.LiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.MutableLiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.util.<span class="hljs-function"><span class="hljs-function">PagingRequestHelper </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getErrorMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(report: PagingRequestHelper.StatusReport)</span></span></span><span class="hljs-function">: String </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PagingRequestHelper.RequestType.values().mapNotNull { report.getErrorFor(it)?.message }.first() } fun PagingRequestHelper.createStatusLiveData(): LiveData&lt;NetworkState&gt; { val liveData = MutableLiveData&lt;NetworkState&gt;() addListener { report -&gt; when { report.hasRunning() -&gt; liveData.postValue(NetworkState.LOADING) report.hasError() -&gt; liveData.postValue( NetworkState.error(getErrorMessage(report))) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; liveData.postValue(NetworkState.LOADED) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> liveData }</code> </pre> </div></div><br><p>     ,     . <br>       MVVM  Google  ViewModel  LiveData. </p><br><div class="spoiler"> <b class="spoiler_title">MainActivity.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.KeyEvent <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.inputmethod.EditorInfo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.Observer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.ViewModel <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.ViewModelProvider <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.ViewModelProviders <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.PagedList <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.R <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.MainRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.NetworkState <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.presentation.recycler.PostsAdapter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kotlinx.android.synthetic.main.activity_main.* <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">() </span></span>{ companion object { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> val KEY_SUBREDDIT = <span class="hljs-string"><span class="hljs-string">"subreddit"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> val DEFAULT_SUBREDDIT = <span class="hljs-string"><span class="hljs-string">"androiddev"</span></span> } lateinit <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model: <span class="hljs-function"><span class="hljs-function">MainViewModel override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: Bundle?)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) setContentView(R.layout.activity_main) model = getViewModel() initAdapter() initSwipeToRefresh() initSearch() val subreddit = savedInstanceState?.getString(KEY_SUBREDDIT) ?: DEFAULT_SUBREDDIT model.showSubReddit(subreddit) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: MainViewModel </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ViewModelProviders.of(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, object : ViewModelProvider.Factory { override fun &lt;T : ViewModel?&gt; create(modelClass: Class&lt;T&gt;): T { val repo = MainRepository(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span><span class="hljs-meta"><span class="hljs-meta">@MainActivity</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Suppress</span></span>(<span class="hljs-string"><span class="hljs-string">"UNCHECKED_CAST"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MainViewModel(repo) as T } })[MainViewModel::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">] } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initAdapter</span></span></span><span class="hljs-class">() </span></span>{ val adapter = PostsAdapter { model.retry() } list.adapter = adapter model.posts.observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Observer&lt;PagedList&lt;RedditPost&gt;&gt; { adapter.submitList(it) }) model.networkState.observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Observer { adapter.setNetworkState(it) }) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initSwipeToRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ model.refreshState.observe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Observer { swipe_refresh.isRefreshing = it == NetworkState.LOADING }) swipe_refresh.setOnRefreshListener { model.refresh() } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSaveInstanceState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(outState: Bundle)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onSaveInstanceState(outState) outState.putString(KEY_SUBREDDIT, model.currentSubreddit()) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initSearch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ input.setOnEditorActionListener { _, actionId, _ -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (actionId == EditorInfo.IME_ACTION_GO) { updatedSubredditFromInput() <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> } } input.setOnKeyListener { _, keyCode, event -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.action == KeyEvent.ACTION_DOWN &amp;&amp; keyCode == KeyEvent.KEYCODE_ENTER) { updatedSubredditFromInput() <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatedSubredditFromInput</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ input.text.trim().toString().let { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.isNotEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (model.showSubReddit(it)) { list.scrollToPosition(<span class="hljs-number"><span class="hljs-number">0</span></span>) (list.adapter as? PostsAdapter)?.submitList(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) } } } } }</code> </pre> </div></div><br><p>   onCreate  ViewModel,  ,            . </p><br><p>       LiveData  ViewModel,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">MainViewModel.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.MutableLiveData <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.Transformations <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.lifecycle.ViewModel <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.core.<span class="hljs-function"><span class="hljs-function">RedditPostRepository class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">private</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val repository: RedditPostRepository)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val subredditName = MutableLiveData&lt;String&gt;() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val repoResult = Transformations.map(subredditName) { repository.postsOfSubreddit(it, <span class="hljs-number"><span class="hljs-number">10</span></span>) } val posts = Transformations.switchMap(repoResult) { it.pagedList }!! val networkState = Transformations.switchMap(repoResult) { it.networkState }!! val refreshState = Transformations.switchMap(repoResult) { it.refreshState }!! <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoResult.value?.refresh?.invoke() } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showSubReddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subreddit: String)</span></span></span><span class="hljs-function">: Boolean </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subredditName.value == subreddit) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> } subredditName.value = subreddit <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val listing = repoResult?.value listing?.retry?.invoke() } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentSubreddit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: String? </span></span>= subredditName.value }</code> </pre> </div></div><br><p>    ,     : retry  refesh. </p><br><p>     PagedListAdapter.            . </p><br><div class="spoiler"> <b class="spoiler_title">PostAdapter.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.paging.PagedListAdapter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.recyclerview.widget.DiffUtil <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.recyclerview.widget.RecyclerView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.ViewGroup <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.R <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.NetworkState <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.presentation.recycler.viewholder.NetworkStateItemViewHolder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.presentation.recycler.viewholder.RedditPostViewHolder <span class="hljs-comment"><span class="hljs-comment">/** * A simple adapter implementation that shows Reddit posts. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostsAdapter</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">retryCallback</span></span></span><span class="hljs-class">: () -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class">) : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PagedListAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditPost</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class">&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST_COMPARATOR</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> networkState: NetworkState? = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">null</span></span></span><span class="hljs-function"> override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBindViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(holder: RecyclerView.ViewHolder, position: Int)</span></span></span><span class="hljs-function"> </span></span>{ when (getItemViewType(position)) { R.layout.reddit_post_item -&gt; (holder as RedditPostViewHolder).bind(getItem(position)) R.layout.network_state_item -&gt; (holder as NetworkStateItemViewHolder).bindTo( networkState) } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBindViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( holder: RecyclerView.ViewHolder, position: Int, payloads: MutableList&lt;Any&gt;)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payloads.isNotEmpty()) { val item = getItem(position) (holder as RedditPostViewHolder).updateScore(item) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { onBindViewHolder(holder, position) } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: ViewGroup, viewType: Int)</span></span></span><span class="hljs-function">: RecyclerView.ViewHolder </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> when (viewType) { R.layout.reddit_post_item -&gt; RedditPostViewHolder.create(parent) R.layout.network_state_item -&gt; NetworkStateItemViewHolder.create(parent, retryCallback) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"unknown view type $viewType"</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasExtraRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= networkState != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; networkState != NetworkState.<span class="hljs-function"><span class="hljs-function">LOADED override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemViewType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(position: Int)</span></span></span><span class="hljs-function">: Int </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasExtraRow() &amp;&amp; position == itemCount - <span class="hljs-number"><span class="hljs-number">1</span></span>) { R.layout.network_state_item } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { R.layout.reddit_post_item } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: Int </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getItemCount() + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasExtraRow()) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNetworkState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(newNetworkState: NetworkState?)</span></span></span><span class="hljs-function"> </span></span>{ val previousState = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.networkState val hadExtraRow = hasExtraRow() <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.networkState = newNetworkState val hasExtraRow = hasExtraRow() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hadExtraRow != hasExtraRow) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hadExtraRow) { notifyItemRemoved(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getItemCount()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { notifyItemInserted(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getItemCount()) } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasExtraRow &amp;&amp; previousState != newNetworkState) { notifyItemChanged(itemCount - <span class="hljs-number"><span class="hljs-number">1</span></span>) } } companion object { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val PAYLOAD_SCORE = Any() val POST_COMPARATOR = object : DiffUtil.ItemCallback&lt;RedditPost&gt;() { <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">areContentsTheSame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldItem: RedditPost, newItem: RedditPost)</span></span></span><span class="hljs-function">: Boolean </span></span>= oldItem == <span class="hljs-function"><span class="hljs-function">newItem override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">areItemsTheSame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldItem: RedditPost, newItem: RedditPost)</span></span></span><span class="hljs-function">: Boolean </span></span>= oldItem.name == newItem.<span class="hljs-function"><span class="hljs-function">name override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChangePayload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldItem: RedditPost, newItem: RedditPost)</span></span></span><span class="hljs-function">: Any? </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sameExceptScore(oldItem, newItem)) { PAYLOAD_SCORE } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sameExceptScore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldItem: RedditPost, newItem: RedditPost)</span></span></span><span class="hljs-function">: Boolean </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// DON'T do this copy in a real app, it is just convenient here for the demo :) // because reddit randomizes scores, we want to pass it as a payload to minimize // UI updates between refreshes return oldItem.copy(score = newItem.score) == newItem } } }</span></span></code> </pre> </div></div><br><p>     ViewHolder           . </p><br><div class="spoiler"> <b class="spoiler_title">RedditPostViewHolder.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.net.Uri <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.recyclerview.widget.RecyclerView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.LayoutInflater <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.ViewGroup <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.ImageView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.TextView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.R <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.model.RedditPost <span class="hljs-comment"><span class="hljs-comment">/** * A RecyclerView ViewHolder that displays a reddit post. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedditPostViewHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class">) : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val title: TextView = view.findViewById(R.id.title) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val subtitle: TextView = view.findViewById(R.id.subtitle) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val score: TextView = view.findViewById(R.id.score) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> post : RedditPost? = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> init { view.setOnClickListener { post?.url?.let { url -&gt; val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url)) view.context.startActivity(intent) } } } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(post: RedditPost?)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.post = post title.text = post?.title ?: <span class="hljs-string"><span class="hljs-string">"loading"</span></span> subtitle.text = itemView.context.resources.getString(R.string.post_subtitle, post?.author ?: <span class="hljs-string"><span class="hljs-string">"unknown"</span></span>) score.text = <span class="hljs-string"><span class="hljs-string">"${post?.score ?: 0}"</span></span> } companion object { <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: ViewGroup)</span></span></span><span class="hljs-function">: RedditPostViewHolder </span></span>{ val view = LayoutInflater.from(parent.context) .inflate(R.layout.reddit_post_item, parent, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedditPostViewHolder(view) } } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateScore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(item: RedditPost?)</span></span></span><span class="hljs-function"> </span></span>{ post = item score.text = <span class="hljs-string"><span class="hljs-string">"${item?.score ?: 0}"</span></span> } }</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">NetworkStateItemViewHolder.kt</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> androidx.recyclerview.widget.RecyclerView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.LayoutInflater <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.ViewGroup <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Button <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.ProgressBar <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.TextView <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.R <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.NetworkState <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.memebattle.pagingwithrepository.domain.repository.network.Status <span class="hljs-comment"><span class="hljs-comment">/** * A View Holder that can display a loading or have click action. * It is used to show the network state of paging. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkStateItemViewHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">retryCallback</span></span></span><span class="hljs-class">: () -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class">) : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val progressBar = view.findViewById&lt;ProgressBar&gt;(R.id.progress_bar) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val retry = view.findViewById&lt;Button&gt;(R.id.retry_button) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val errorMsg = view.findViewById&lt;TextView&gt;(R.id.error_msg) init { retry.setOnClickListener { retryCallback() } } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(networkState: NetworkState?)</span></span></span><span class="hljs-function"> </span></span>{ progressBar.visibility = toVisibility(networkState?.status == Status.RUNNING) retry.visibility = toVisibility(networkState?.status == Status.FAILED) errorMsg.visibility = toVisibility(networkState?.msg != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) errorMsg.text = networkState?.msg } companion object { <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: ViewGroup, retryCallback: ()</span></span></span><span class="hljs-function"> -&gt; Unit): NetworkStateItemViewHolder </span></span>{ val view = LayoutInflater.from(parent.context) .inflate(R.layout.network_state_item, parent, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NetworkStateItemViewHolder(view, retryCallback) } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toVisibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(constraint : Boolean)</span></span></span><span class="hljs-function">: Int </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constraint) { View.VISIBLE } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { View.GONE } } } }</code> </pre> </div></div><br><p>    ,     ,      Reddit   androiddev.         ,           . </p><br><p><img src="https://habrastorage.org/webt/ga/nz/b7/ganzb7uatwk-s0foz9z-wbw5m_8.png" alt="å›¾ç‰‡"></p><br><p>  , ! </p><br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,        Google. </p><br><p> ä»…æ­¤è€Œå·²ã€‚       â€œâ€ ,     . </p><br><p>   ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431212/">https://habr.com/ru/post/zh-CN431212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431200/index.html">æˆˆå¤šï¼šå…³äºå®šæœŸä½¿ç”¨é™æ€ä»£ç åˆ†æå™¨çš„é—®é¢˜</a></li>
<li><a href="../zh-CN431202/index.html">Debianå’ŒDevuanè”æ‰‹sysvinit</a></li>
<li><a href="../zh-CN431204/index.html">åé—¨åœ¨EventStreamåº“çš„ä¾èµ–é¡¹ä¹‹ä¸€ä¸­</a></li>
<li><a href="../zh-CN431208/index.html">é€šè¿‡æ–°æ‰‹çœ¼ä¸­çš„Splunkï¼šæˆ‘ä»¬å¦‚ä½•è¿›è¡Œå­˜å‚¨åº“å­˜ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN431210/index.html">ç¬¬äºŒä¸ªMitapå†™æ–‡ä»¶è«æ–¯ç§‘ã€‚ ä¼—è®®é™¢æŠ€æœ¯æ’°ç¨¿äººï¼šä¸è¦å¿˜è®°æˆ‘ä»¬çš„å­˜åœ¨</a></li>
<li><a href="../zh-CN431216/index.html">Snom D345 IPç”µè¯è¯„è®º</a></li>
<li><a href="../zh-CN431218/index.html">æˆ‘æ˜¯å¦‚ä½•åˆ¶ä½œLovecraftæ¼«ç”»æ¸¸æˆçš„</a></li>
<li><a href="../zh-CN431220/index.html">ç”Ÿç‰©å­¦å®¶çœ‹æˆ‘ä»¬è¡°è€çš„æ ¹æº</a></li>
<li><a href="../zh-CN431222/index.html">ç½‘ç«™å­˜æ¡£</a></li>
<li><a href="../zh-CN431226/index.html">FPGA Cyclone IVçš„Snakeæ¸¸æˆï¼ˆå¸¦æœ‰VGAå’ŒSPIæ¸¸æˆæ†ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>