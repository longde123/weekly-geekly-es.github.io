<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë©üèª üêΩ üèóÔ∏è Criando uma m√°quina de arcade emulador. Parte 2 üêÜ üßóüèº ‚öΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A primeira parte est√° aqui . 

 Desmontador do processador 8080 
 Conhecimento 
 Vamos precisar de informa√ß√µes sobre os opcodes e seus respectivos com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Criando uma m√°quina de arcade emulador. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418683/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f48/668/8f8/f486688f8d67a372f8911558cc312204.jpg" alt="imagem"></div><br>  A primeira parte est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h1>  Desmontador do processador 8080 </h1><br><h2>  Conhecimento </h2><br>  Vamos precisar de informa√ß√µes sobre os opcodes e seus respectivos comandos.  Ao procurar informa√ß√µes na Internet, voc√™ notar√° que h√° muitas informa√ß√µes mistas sobre o 8080 e o Z80.  O Z80 seguiu o 8080 - ele executa todas as instru√ß√µes do 8080 com os mesmos c√≥digos hexadecimais, mas tamb√©m possui instru√ß√µes adicionais.  Eu acho que, enquanto voc√™ deve evitar informa√ß√µes sobre o Z80, para n√£o ficar confuso.  Eu criei uma tabela opcode para o nosso trabalho, √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Cada processador possui um guia de refer√™ncia escrito pelo fabricante.  Geralmente √© chamado de algo como "Manual do Ambiente do Programador".  O manual do 8080 √© chamado de Manual do usu√°rio dos sistemas de microcomputador Intel 8080.  Sempre foi chamado de "livro de dados", ent√£o tamb√©m o chamarei.  Consegui fazer o download da refer√™ncia 8080 em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.datasheetarchive.com/</a> .  Este PDF √© uma digitaliza√ß√£o de baixa qualidade; portanto, se voc√™ encontrar uma vers√£o melhor, use-a. <br><a name="habracut"></a><br>  Vamos come√ßar e dar uma olhada na ROM do Space Invaders.  (O arquivo ROM pode ser encontrado na Internet.) Eu trabalho no Mac OS X, ent√£o apenas uso o comando hexdump para visualizar seu conte√∫do.  Para mais trabalho, encontre o editor hexadecimal para sua plataforma.  Aqui est√£o os primeiros 128 bytes do arquivo invaders.h: <br><br><pre><code class="hljs dos">$ hexdump -v invaders.h <span class="hljs-number"><span class="hljs-number">0000000</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> c3 d4 <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f5 c5 d5 e5 c3 <span class="hljs-number"><span class="hljs-number">8</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0000010</span></span> f5 c5 d5 e5 <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> c0 <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">0000020</span></span> db <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>f da <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a ea <span class="hljs-number"><span class="hljs-number">20</span></span> a7 ca <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a eb <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0000030</span></span> fe <span class="hljs-number"><span class="hljs-number">99</span></span> ca <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> c6 <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> eb <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> af <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">0000040</span></span> ea <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a e9 <span class="hljs-number"><span class="hljs-number">20</span></span> a7 ca <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a ef <span class="hljs-number"><span class="hljs-number">20</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">6</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0000050</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a eb <span class="hljs-number"><span class="hljs-number">20</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">5</span></span>d <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> bf <span class="hljs-number"><span class="hljs-number">0</span></span>a c3 <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0000060</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> c3 <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> ea <span class="hljs-number"><span class="hljs-number">20</span></span> c3 <span class="hljs-number"><span class="hljs-number">3</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">0000070</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> ...</code> </pre> <br>  Este √© o in√≠cio do programa Space Invaders.  Cada n√∫mero hexadecimal √© um comando ou dados para o programa.  Podemos usar uma refer√™ncia ou outra informa√ß√£o de refer√™ncia para entender o que esses c√≥digos hexadecimais significam.  Vamos explorar um pouco mais o c√≥digo da imagem da ROM. <br><br>  O primeiro byte deste programa √© $ 00.  Olhando para a tabela, vemos que √© NOP, bem como os dois comandos a seguir.  (Mas n√£o desanime, os Space Invaders provavelmente usaram esses comandos como um atraso para deixar o sistema se acalmar um pouco depois de ligar a energia.) <br><br>  O quarto comando √© $ C3, ou seja, a julgar pela tabela, este √© o JMP.  A defini√ß√£o de um comando JMP indica que ele recebe um endere√ßo de dois bytes, ou seja, os pr√≥ximos dois bytes s√£o o endere√ßo de salto do JMP.  Ent√£o mais dois NOPs chegam ... ent√£o, voc√™ sabe o que?  Deixe-me assinar as primeiras instru√ß√µes pessoalmente ... <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0001</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0002</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0003</span></span> c3 d4 <span class="hljs-number"><span class="hljs-number">18</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$18</span></span>d4 <span class="hljs-number"><span class="hljs-number">0006</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0007</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0008</span></span> f5 PUSH PSW <span class="hljs-number"><span class="hljs-number">0009</span></span> c5 PUSH B <span class="hljs-number"><span class="hljs-number">000</span></span>a d5 PUSH D <span class="hljs-number"><span class="hljs-number">000</span></span>b e5 PUSH H <span class="hljs-number"><span class="hljs-number">000</span></span>c c3 <span class="hljs-number"><span class="hljs-number">8</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$008</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0010</span></span> f5 PUSH PSW <span class="hljs-number"><span class="hljs-number">0011</span></span> c5 PUSH B <span class="hljs-number"><span class="hljs-number">0012</span></span> d5 PUSH D <span class="hljs-number"><span class="hljs-number">0013</span></span> e5 PUSH H <span class="hljs-number"><span class="hljs-number">0014</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">80</span></span> MVI A,#<span class="hljs-number"><span class="hljs-number">0x80</span></span> <span class="hljs-number"><span class="hljs-number">0016</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$2072</span></span></code> </pre> <br>  Parece haver alguma maneira de automatizar esse processo ... <br><br><h2>  Desmontador, Parte 1 </h2><br>  Um desmontador √© um programa que simplesmente converte um fluxo de n√∫meros hexadecimais de volta para o c√≥digo-fonte na linguagem assembly.  Essa √© exatamente a tarefa que realizamos manualmente na se√ß√£o anterior - uma √≥tima oportunidade para automatizar este trabalho.  Ao escrever esse trecho de c√≥digo, nos familiarizamos com o processador e obtemos um trecho conveniente de c√≥digo de depura√ß√£o, que √© √∫til ao escrever um emulador de CPU. <br><br>  Aqui est√° o algoritmo de desmontagem do c√≥digo 8080: <br><br><ol><li>  Leia o c√≥digo no buffer </li><li>  Recebemos um ponteiro para o in√≠cio do buffer </li><li>  Use o byte no ponteiro para determinar o c√≥digo de opera√ß√£o. </li><li>  Exiba o nome do c√≥digo de opera√ß√£o, se necess√°rio, usando bytes ap√≥s o c√≥digo de opera√ß√£o como dados </li><li>  Mova o ponteiro para o n√∫mero de bytes usados ‚Äã‚Äãpor este comando (1, 2 ou 3 bytes) </li><li>  Se o buffer n√£o terminar, v√° para a etapa 3 </li></ol><br>  Para estabelecer a base do procedimento, adicionei algumas instru√ß√µes abaixo.  Vou descrever o procedimento completo para o download, mas recomendo que voc√™ tente escrev√™-lo.  N√£o demorar√° muito tempo e, em paralelo, voc√™ aprender√° o conjunto de instru√ß√µes do processador 8080. <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* *codebuffer -       8080 pc -          */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Disassemble8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *codebuffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *code = &amp;codebuffer[pc]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> (<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x01</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"LXI B,#$%02x%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">2</span></span>], code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes=<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x02</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"STAX B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"INX B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x04</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"INR B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x05</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"DCR B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x06</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"MVI B,#$%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes=<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x07</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"RLC"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x08</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x3e</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"MVI A,#0x%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc3</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"JMP $%02x%02x"</span></span>,code[<span class="hljs-number"><span class="hljs-number">2</span></span>],code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> opbytes; }</code> </pre><br>  No processo de escrever esse procedimento e estudar cada c√≥digo de opera√ß√£o, aprendi muito sobre o processador 8080. <br><br><ol><li>  Percebi que a maioria das equipes leva um byte, o restante dois ou tr√™s.  O c√≥digo acima pressup√µe que o comando tenha um byte de tamanho, mas as instru√ß√µes de dois e tr√™s bytes alteram o valor da vari√°vel ‚Äúopbytes‚Äù para que o tamanho correto do comando seja retornado. </li><li>  O 8080 possui registros com os nomes A, B, C, D, E, H e L. H√° tamb√©m um contador de programa (contador de programa, PC) e um ponteiro de pilha separado (ponteiro de pilha, SP). </li><li>  Algumas instru√ß√µes funcionam com registradores em pares: B e C s√£o um par, al√©m de DE e HL. </li><li>  A √© um registro especial, muitas instru√ß√µes funcionam com ele. </li><li>  HL tamb√©m √© um registro especial, √© usado como endere√ßo para cada leitura e grava√ß√£o de dados na mem√≥ria. </li><li>  Fiquei curioso sobre a equipe ‚ÄúRST‚Äù, ent√£o li o guia um pouco.  Notei que ele executa o c√≥digo em locais fixos e a refer√™ncia menciona o tratamento de interrup√ß√µes.  Ap√≥s uma leitura mais aprofundada, verificou-se que todo esse c√≥digo no in√≠cio da ROM era rotinas de servi√ßo de interrup√ß√£o (ISRs).  As interrup√ß√µes podem ser geradas programaticamente usando o comando RST ou geradas por fontes de terceiros (n√£o pelo processador 8080). </li></ol><br>  Para transformar tudo isso em um programa de trabalho, acabei de criar um procedimento que executa as seguintes etapas: <br><br><ol><li>  Abre um arquivo preenchido com o c√≥digo compilado 8080 </li><li>  L√™ no buffer de mem√≥ria </li><li>  Passa pelo buffer de mem√≥ria, causando Disassemble8080Op </li><li>  Aumenta o PC retornado por Disassemble8080Op </li><li>  Sa√≠das no final do buffer </li></ol><br>  Pode ser algo como isto: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">**argv)</span></span></span><span class="hljs-function"> </span></span>{ FILE *f= fopen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f==<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"error: Couldn't open %s\n"</span></span>, argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//         fseek(f, 0L, SEEK_END); int fsize = ftell(f); fseek(f, 0L, SEEK_SET); unsigned char *buffer=malloc(fsize); fread(buffer, fsize, 1, f); fclose(f); int pc = 0; while (pc &lt; fsize) { pc += Disassemble8080Op(buffer, pc); } return 0; }</span></span></code> </pre> <br>  Na segunda parte, examinaremos a sa√≠da obtida desmontando os ROM Space Invaders. <br><br><h2>  Aloca√ß√£o de mem√≥ria </h2><br>  Antes de come√ßarmos a escrever um emulador de processador, precisamos estudar outro aspecto.  Todas as CPUs t√™m a capacidade de se comunicar com um certo n√∫mero de endere√ßos.  Os processadores mais antigos tinham endere√ßos de 16, 24 ou 32 bits.  O 8080 possui 16 contatos de endere√ßo, portanto, os endere√ßos est√£o no intervalo de 0 a $ FFFF. <br><br>  Para entender a aloca√ß√£o de mem√≥ria do jogo, precisamos realizar uma pequena investiga√ß√£o.  Depois de coletar as informa√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , descobri que a ROM est√° localizada no endere√ßo 0 e o jogo tem 8 KB de RAM a partir de US $ 2000. <br><br>  O autor de uma das p√°ginas descobriu que o buffer de v√≠deo inicia na RAM com um endere√ßo de US $ 2.400 e tamb√©m nos contou como as portas de entrada e sa√≠da 8080 s√£o usadas para se comunicar com controles e equipamentos de √°udio.  √ìtimo! <br><br>  Dentro do arquivo ROM invaders.zip, que pode ser encontrado na Internet, existem quatro arquivos: invaders.e, .f, .g e .h.  Ap√≥s pesquisar no Google, deparei-me com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> informativo que explica como colocar esses arquivos na mem√≥ria: <br><br> <code>Space Invaders, (C) Taito 1978, Midway 1979 <br> <br> : Intel 8080, 2  (     Zilog Z80) <br> <br> : $cf (RST 8)   vblank, $d7 (RST $10)   vblank. <br> <br> : 256(x)*224(y), 60 ,  .   <br>      . <br>   :   7168 , 1    (32    ). <br> <br> : SN76477  . <br> <br>  : <br> ROM <br> $0000-$07ff: invaders.h <br> $0800-$0fff: invaders.g <br> $1000-$17ff: invaders.f <br> $1800-$1fff: invaders.e <br> <br> RAM <br> $2000-$23ff:   <br> $2400-$3fff:  <br> <br> $4000-:  </code> <br> <br>  Ainda h√° algumas informa√ß√µes √∫teis, mas ainda n√£o estamos prontos para us√°-las. <br><br><h2>  Detalhes sangrentos </h2><br>  Se voc√™ quiser saber qual o tamanho do espa√ßo de endere√ßo do processador, poder√° entender isso examinando suas caracter√≠sticas.  A especifica√ß√£o 8080 nos diz que o processador possui 16 contatos de endere√ßo, ou seja, usa endere√ßamento de 16 bits.  (Em vez de especifica√ß√µes, basta ler o manual, Wikipedia, google e assim por diante ...) <br><br>  Na Internet, existem muitas informa√ß√µes sobre o hardware do Space Invaders.  Se voc√™ n√£o conseguiu encontrar essas informa√ß√µes, pode obt√™-las de duas maneiras: <br><br><ul><li>  Assista o c√≥digo em execu√ß√£o no emulador e descubra o que ele faz.  Fa√ßa anota√ß√µes e observe com cuidado.  Deve ser simples o suficiente para entender, por exemplo, onde, na opini√£o do jogo, a RAM deve estar localizada.  Tamb√©m √© f√°cil determinar o local em que ela est√° procurando mem√≥ria de v√≠deo (passaremos algum tempo estudando isso). </li><li>  Encontre o diagrama de circuito da m√°quina de fliperama e acompanhe os sinais dos contatos de endere√ßo da CPU.  Veja para onde eles est√£o indo.  Por exemplo, A15 (endere√ßo mais antigo) s√≥ pode ir para a ROM.  A partir disso, podemos concluir que os endere√ßos da ROM come√ßam em US $ 8000. </li></ul><br>  Pode ser muito interessante e informativo descobrir voc√™ mesmo observando a execu√ß√£o do c√≥digo.  Algu√©m teve que lidar com tudo isso pela primeira vez. <br><br><h1>  Desenvolvimento da linha de comando </h1><br>  O objetivo deste tutorial n√£o √© ensin√°-lo a escrever c√≥digo para uma plataforma espec√≠fica, embora n√£o possamos evitar c√≥digo espec√≠fico da plataforma.  Espero que, antes do in√≠cio do projeto, voc√™ j√° saiba compilar para sua plataforma de destino. <br><br>  Quando voc√™ trabalha com c√≥digo independente, que simplesmente l√™ arquivos e exibe texto no console, n√£o √© necess√°rio usar algum sistema de desenvolvimento muito complicado.  De fato, isso apenas complica as coisas.  Tudo que voc√™ precisa √© de um editor de texto e terminal. <br><br>  Eu acho que quem quer programar em um n√≠vel baixo deve saber como criar programas simples a partir da linha de comando.  Voc√™ pode considerar que eu o provoco, mas suas habilidades de hackers de elite n√£o valem muito se voc√™ n√£o puder funcionar fora do Visual Studio. <br><br>  No Mac, voc√™ pode usar o TextEdit e o Terminal para compilar.  No Linux, voc√™ pode usar o gedit e o Konsole.  No Windows, voc√™ pode instalar o cygwin e ferramentas e, em seguida, usar o N ++ ou outro editor de texto.  Se voc√™ quer ser realmente legal, todas essas plataformas suportam vi e emacs para edi√ß√£o de texto. <br><br>  Compilar programas de um √∫nico arquivo usando a linha de comando √© uma tarefa trivial.  Suponha que voc√™ salvou seu programa em um arquivo chamado <code>8080dis.c</code> .  V√° para a pasta com este arquivo de texto e compile-o assim: <code>cc 8080dis.c</code> .  Se voc√™ n√£o especificar o nome do arquivo de sa√≠da, ele ser√° chamado de <code>a.out</code> e voc√™ poder√° execut√°-lo digitando <code>./a.out</code> . <br><br>  Isso, de fato, √© tudo. <br><br><h3>  Usando um depurador </h3><br>  Se voc√™ estiver trabalhando em um dos sistemas baseados em Unix, segue uma breve introdu√ß√£o √† depura√ß√£o de programas de linha de comando usando o GDB.  Voc√™ precisa compilar o programa assim: <code>cc -g -O0 8080dis.c</code> .  O par√¢metro <code>-g</code> gera informa√ß√µes de depura√ß√£o (ou seja, voc√™ pode executar a depura√ß√£o com base no texto de origem), e o par√¢metro <code>-O0</code> desativa as otimiza√ß√µes para que, ao percorrer o programa, o depurador possa rastrear com precis√£o o c√≥digo de acordo com o texto de origem. <br><br>  Aqui est√° o log anotado do in√≠cio de uma sess√£o de depura√ß√£o.  Meus coment√°rios est√£o em linhas marcadas com um sinal de libra (#). <br><br><pre> <code class="hljs vhdl"> $ gdb a.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> GNU gdb <span class="hljs-number"><span class="hljs-number">6.3</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>-<span class="hljs-number"><span class="hljs-number">20050815</span></span> (Apple version gdb-<span class="hljs-number"><span class="hljs-number">1708</span></span>) (Mon Aug <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span> UTC <span class="hljs-number"><span class="hljs-number">2011</span></span>) Copyright <span class="hljs-number"><span class="hljs-number">2004</span></span> Free Software Foundation, Inc. GDB <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> free software, covered by the GNU General Public License, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> you are welcome <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> change it <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> distribute copies <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> it under certain conditions. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">"show copying"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> see the conditions. There <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> absolutely no warranty <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> GDB. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">"show warranty"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This GDB was configured as <span class="hljs-string"><span class="hljs-string">"x86_64-apple-darwin"</span></span>...Reading symbols <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> libraries .. done #  ,       (gdb) b Disassemble8080Op Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span> at <span class="hljs-number"><span class="hljs-number">0</span></span>x1000012ef: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c, <span class="hljs-literal"><span class="hljs-literal">line</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>. #   <span class="hljs-string"><span class="hljs-string">"invaders.h"</span></span>    (gdb) run invaders.h Starting program: /Users/bob/Desktop/invaders/a.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> invaders.h Reading symbols <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> libraries +........................ done Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">0</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; #gdb  n  <span class="hljs-string"><span class="hljs-string">"next"</span></span>.    <span class="hljs-string"><span class="hljs-string">"next"</span></span> (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; #p -    <span class="hljs-string"><span class="hljs-string">"print"</span></span>,     *code (gdb) p *code $<span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> '\<span class="hljs-number"><span class="hljs-number">0</span></span>' (gdb) n <span class="hljs-number"><span class="hljs-number">9</span></span> printf(<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); #    <span class="hljs-string"><span class="hljs-string">""</span></span>, gdb     ,    <span class="hljs-string"><span class="hljs-string">"next"</span></span> (gdb) <span class="hljs-number"><span class="hljs-number">10</span></span> switch (*code) (gdb) n #   ,    <span class="hljs-string"><span class="hljs-string">"NOP"</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x00: printf(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); break; (gdb) n <span class="hljs-number"><span class="hljs-number">285</span></span> printf(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); #c -  <span class="hljs-string"><span class="hljs-string">"continue"</span></span>,        (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0000</span></span> NOP #     Disassemble8080Op.   *opcode, # ,      NOP,    . Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">1</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0001</span></span> NOP Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">2</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; (gdb) p *code $<span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> '\<span class="hljs-number"><span class="hljs-number">0</span></span>' #  NOP,   (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0002</span></span> NOP Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">3</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; #   ! (gdb) p *code $<span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-number"><span class="hljs-number">195</span></span> '?' # print     ,    /x    (gdb) p /x *code $<span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>xc3 (gdb) n <span class="hljs-number"><span class="hljs-number">9</span></span> printf(<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); (gdb) <span class="hljs-number"><span class="hljs-number">10</span></span> switch (*code) (gdb) # C3 -  JMP. . <span class="hljs-number"><span class="hljs-number">219</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xc3: printf(<span class="hljs-string"><span class="hljs-string">"JMP $%02x%02x"</span></span>,code[<span class="hljs-number"><span class="hljs-number">2</span></span>],code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">3</span></span>; break; (gdb) <span class="hljs-number"><span class="hljs-number">285</span></span> printf(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>);</code> </pre> <br><h1>  Desmontador, Parte 2 </h1><br>  Execute o desmontador para o arquivo ROM invaders.h e observe as informa√ß√µes exibidas. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0000</span></span> NOP <span class="hljs-number"><span class="hljs-number">0001</span></span> NOP <span class="hljs-number"><span class="hljs-number">0002</span></span> NOP <span class="hljs-number"><span class="hljs-number">0003</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$18</span></span>d4 <span class="hljs-number"><span class="hljs-number">0006</span></span> NOP <span class="hljs-number"><span class="hljs-number">0007</span></span> NOP <span class="hljs-number"><span class="hljs-number">0008</span></span> PUSH PSW <span class="hljs-number"><span class="hljs-number">0009</span></span> PUSH B <span class="hljs-number"><span class="hljs-number">000</span></span>a PUSH D <span class="hljs-number"><span class="hljs-number">000</span></span>b PUSH H <span class="hljs-number"><span class="hljs-number">000</span></span>c JMP <span class="hljs-meta"><span class="hljs-meta">$008</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f NOP <span class="hljs-number"><span class="hljs-number">0010</span></span> PUSH PSW <span class="hljs-number"><span class="hljs-number">0011</span></span> PUSH B <span class="hljs-number"><span class="hljs-number">0012</span></span> PUSH D <span class="hljs-number"><span class="hljs-number">0013</span></span> PUSH H <span class="hljs-number"><span class="hljs-number">0014</span></span> MVI A,#<span class="hljs-meta"><span class="hljs-meta">$80</span></span> <span class="hljs-number"><span class="hljs-number">0016</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$2072</span></span> <span class="hljs-number"><span class="hljs-number">0019</span></span> LXI H,#<span class="hljs-meta"><span class="hljs-meta">$20</span></span>c0 <span class="hljs-number"><span class="hljs-number">001</span></span>c DCR M <span class="hljs-number"><span class="hljs-number">001</span></span>d <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$17</span></span>cd <span class="hljs-number"><span class="hljs-number">0020</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> #<span class="hljs-meta"><span class="hljs-meta">$01</span></span> <span class="hljs-number"><span class="hljs-number">0022</span></span> RRC <span class="hljs-number"><span class="hljs-number">0023</span></span> JC <span class="hljs-meta"><span class="hljs-meta">$0067</span></span> <span class="hljs-number"><span class="hljs-number">0026</span></span> LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>ea <span class="hljs-number"><span class="hljs-number">0029</span></span> ANA A <span class="hljs-number"><span class="hljs-number">002</span></span>a JZ <span class="hljs-meta"><span class="hljs-meta">$0042</span></span> <span class="hljs-number"><span class="hljs-number">002</span></span>d LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>eb <span class="hljs-number"><span class="hljs-number">0030</span></span> CPI #<span class="hljs-meta"><span class="hljs-meta">$99</span></span> <span class="hljs-number"><span class="hljs-number">0032</span></span> JZ <span class="hljs-meta"><span class="hljs-meta">$003</span></span>e <span class="hljs-number"><span class="hljs-number">0035</span></span> ADI #<span class="hljs-meta"><span class="hljs-meta">$01</span></span> <span class="hljs-number"><span class="hljs-number">0037</span></span> DAA <span class="hljs-number"><span class="hljs-number">0038</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>eb <span class="hljs-number"><span class="hljs-number">003</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$1947</span></span> <span class="hljs-number"><span class="hljs-number">003</span></span>e SRA A <span class="hljs-number"><span class="hljs-number">003</span></span>f STA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>ea <span class="hljs-comment"><span class="hljs-comment">/* 0000000 00 00 00 c3 d4 18 00 00 f5 c5 d5 e5 c3 8c 00 00 0000010 f5 c5 d5 e5 3e 80 32 72 20 21 c0 20 35 cd cd 17 0000020 db 01 0f da 67 00 3a ea 20 a7 ca 42 00 3a eb 20 0000030 fe 99 ca 3e 00 c6 01 27 32 eb 20 cd 47 19 af 32 */</span></span></code> </pre> <br>  As primeiras instru√ß√µes correspondem √†quelas que escrevemos manualmente anteriormente.  Depois deles, h√° v√°rias novas instru√ß√µes.  Abaixo eu inseri dados hexadecimais para refer√™ncia.  Observe que se voc√™ comparar a mem√≥ria com os comandos, os endere√ßos ser√£o armazenados na mem√≥ria na ordem inversa.  Assim √©.  Isso √© chamado little endian - m√°quinas com pouco endian, como o 8080, armazenam os bytes menos significativos de n√∫meros primeiro.  (Mais informa√ß√µes sobre endian est√£o descritas abaixo.) <br><br>  Eu mencionei acima que esse c√≥digo √© o c√≥digo ISR para o jogo Space Invaders.  O c√≥digo para interrup√ß√µes 0, 1, 2, ... 7 come√ßa com o endere√ßo $ 0, $ 8, $ 20, ... $ 38.  Parece que o 8080 fornece apenas 8 bytes para cada ISR.  √Äs vezes, o programa Space Invaders ignora esse sistema simplesmente movendo-se para outro endere√ßo com mais espa√ßo.  (Isso acontece em US $ 000c). <br><br>  Al√©m disso, o ISR 2 parece ser maior que a mem√≥ria alocada para ele.  Seu c√≥digo vai para $ 0018 (este √© o local para ISR 3).  Eu acho que os Space Invaders n√£o esperam ver nada que use a interrup√ß√£o 3. <br><br>  O arquivo ROM do Space Invaders da Internet consiste em quatro partes.  Vou explicar isso abaixo, mas, por enquanto, para avan√ßar para a pr√≥xima se√ß√£o, precisamos mesclar esses quatro arquivos em um.  No Unix: <br><br><pre> <code class="hljs matlab"> <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.h &gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.g &gt;&gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.f &gt;&gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.e &gt;&gt; invaders</code> </pre> <br>  Agora execute o desmontador com o arquivo "invasores" resultante.  Quando um programa come√ßa em US $ 0000, a primeira coisa a fazer √© mudar para US $ 18d4.  Considerarei isso o in√≠cio do programa.  Vamos dar uma olhada r√°pida neste c√≥digo. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">18</span></span>d4 LXI SP,#<span class="hljs-meta"><span class="hljs-meta">$2400</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d7 MVI B,#<span class="hljs-meta"><span class="hljs-meta">$00</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d9 <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$01</span></span>e6</code> </pre> <br>  Portanto, ele executa duas opera√ß√µes e chama $ 01e6.  Vou inserir parte do c√≥digo com transi√ß√µes neste c√≥digo: <br><br><pre> <code class="hljs mel"> <span class="hljs-number"><span class="hljs-number">01e6</span></span> LXI D,#$1b00 <span class="hljs-number"><span class="hljs-number">01e9</span></span> LXI H,#$2000 <span class="hljs-number"><span class="hljs-number">01</span></span>ec JMP $1a32 ..... <span class="hljs-number"><span class="hljs-number">1</span></span>a32 LDAX D <span class="hljs-number"><span class="hljs-number">1</span></span>a33 MOV M,A <span class="hljs-number"><span class="hljs-number">1</span></span>a34 INX H <span class="hljs-number"><span class="hljs-number">1</span></span>a35 INX D <span class="hljs-number"><span class="hljs-number">1</span></span>a36 DCR B <span class="hljs-number"><span class="hljs-number">1</span></span>a37 JNZ $1a32 <span class="hljs-number"><span class="hljs-number">1</span></span>a3a RET</code> </pre> <br>  Como vimos na aloca√ß√£o de mem√≥ria dos Space Invaders, alguns desses endere√ßos s√£o interessantes.  $ 2000 √© o come√ßo de um programa de ‚ÄúRAM de trabalho‚Äù.  US $ 2.400 √© o come√ßo da mem√≥ria de v√≠deo. <br><br>  Vamos adicionar coment√°rios ao c√≥digo para explicar o que ele faz diretamente na inicializa√ß√£o: <br><br><pre> <code class="hljs mel"> <span class="hljs-number"><span class="hljs-number">18</span></span>d4 LXI SP,#$2400 ; SP=$2400 -      <span class="hljs-number"><span class="hljs-number">18</span></span>d7 MVI B,#$00 ; B=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d9 CALL $01e6 ..... <span class="hljs-number"><span class="hljs-number">01e6</span></span> LXI D,#$1b00 ; DE=$1B00 <span class="hljs-number"><span class="hljs-number">01e9</span></span> LXI H,#$2000 ; HL=$2000 <span class="hljs-number"><span class="hljs-number">01</span></span>ec JMP $1a32 ..... <span class="hljs-number"><span class="hljs-number">1</span></span>a32 LDAX D ; A = (DE),   ,       $1B00 <span class="hljs-number"><span class="hljs-number">1</span></span>a33 MOV M,A ;  A  (HL),     $2000 <span class="hljs-number"><span class="hljs-number">1</span></span>a34 INX H ; HL = HL + <span class="hljs-number"><span class="hljs-number">1</span></span> ( $2001) <span class="hljs-number"><span class="hljs-number">1</span></span>a35 INX D ; DE = DE + <span class="hljs-number"><span class="hljs-number">1</span></span> ( $1B01) <span class="hljs-number"><span class="hljs-number">1</span></span>a36 DCR B ; B = B - <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-number"><span class="hljs-number">0xff</span></span>,      <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>a37 JNZ $1a32 ; ,   ,     b=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>a3a RET</code> </pre> <br>  Parece que esse c√≥digo copiar√° 256 bytes de $ 1b00 a $ 2000.  Porque  Eu n√£o sei  Voc√™ pode estudar o programa com mais detalhes e refletir sobre o que ele faz. <br><br>  <strong>H√° um problema aqui.</strong>  Se tivermos um peda√ßo de mem√≥ria arbitr√°rio contendo c√≥digo, os dados provavelmente se alternar√£o com ele. <br><br>  Por exemplo, sprites para personagens do jogo podem ser misturados com o c√≥digo.  Quando um desmontador cai em um fragmento de mem√≥ria, ele pensa que isso √© c√≥digo e continua a "mastig√°-lo".  Se voc√™ tiver azar, qualquer c√≥digo desmontado ap√≥s esse dado pode estar incorreto. <br><br>  Embora dificilmente possamos fazer algo sobre isso.  Basta ter em mente que esse problema existe.  Se voc√™ vir algo assim: <br><br><ul><li>  transi√ß√£o de um c√≥digo exatamente bom para uma equipe que n√£o est√° na lista de desmontadores </li><li>  fluxo de c√≥digo sem sentido (por exemplo, POP B POP B POP B POP C XTHL XTHL XTHL) </li></ul><br>  aqui, provavelmente, existem dados que arruinaram parte do c√≥digo desmontado.  Se isso acontecer, voc√™ precisar√° iniciar novamente a partir do deslocamento. <br><br>  Acontece que os invasores do espa√ßo periodicamente encontram zeros.  Se nossa desmontagem parar, os zeros o for√ßar√£o a executar um reset. <br><br>  Uma an√°lise detalhada do c√≥digo dos Space Invaders pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h4>  Endian </h4><br>  Os bytes s√£o armazenados de maneira diferente em diferentes modelos de processadores, e o armazenamento depende do tamanho dos dados.  M√°quinas big-endian armazenam dados de mais velhos para mais jovens.  Little-endian mant√™-los do mais jovem para o mais velho.  Se um n√∫mero inteiro de 32 bits 0xAABBCCDD for gravado na mem√≥ria de cada m√°quina, ele ter√° a seguinte apar√™ncia: <br><br>  Em little-endian: $ DD $ CC $ BB $ AA <br><br>  Big endian: $ AA $ BB $ CC $ DD <br><br>  Comecei a programar em processadores Motorola que usavam big endian, ent√£o me pareceu mais "natural", mas depois me acostumei com o little endian. <br><br>  Meu desmontador e emulador evitam completamente o problema endian porque eles l√™em apenas um byte de cada vez.  Se voc√™ quiser, por exemplo, usar um leitor de 16 bits para ler o endere√ßo da ROM, observe que esse c√≥digo n√£o √© port√°til entre as arquiteturas da CPU. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418683/">https://habr.com/ru/post/pt418683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418673/index.html">Por que o mercado de ERP est√° crescendo: estat√≠sticas e tend√™ncias</a></li>
<li><a href="../pt418675/index.html">Como eu fui ao Droidcon Berlin</a></li>
<li><a href="../pt418677/index.html">Toda a verdade sobre o RTOS. Artigo 6. Outros servi√ßos RTOS</a></li>
<li><a href="../pt418679/index.html">Escrevemos um componente com bot√µes "materiais" para o Svelte</a></li>
<li><a href="../pt418681/index.html">Dia da Amizade - 50% de desconto em todos os IDEs do JetBrains para nossos amigos</a></li>
<li><a href="../pt418685/index.html">Gera√ß√£o de n√≠vel processual</a></li>
<li><a href="../pt418687/index.html">Revolu√ß√£o de 3,5 ": detalhes de um pequeno boom de disquetes com vapores</a></li>
<li><a href="../pt418689/index.html">Como criar bibliotecas de componentes no Figma, economizando um or√ßamento, usando o exemplo de um leil√£o online</a></li>
<li><a href="../pt418691/index.html">Rancheiro: Kubernetes em 5 minutos em bare metal</a></li>
<li><a href="../pt418693/index.html">Por que a felicidade √© t√£o dif√≠cil de detectar no c√©rebro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>