<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍️ ➗ 🚿 Je ne respecte pas l'encapsulation ou l'utilisation d'un autre type de table de méthodes pour appeler rapidement des méthodes privées 🧛 👩🏼‍🤝‍👨🏾 🤛🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. Je voudrais partager un exemple d'utilisation de StructLayout pour quelque chose de plus intéressant que des exemples d'octets, d'enti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Je ne respecte pas l'encapsulation ou l'utilisation d'un autre type de table de méthodes pour appeler rapidement des méthodes privées</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423657/"> Bonjour à tous.  Je voudrais partager un exemple d'utilisation de StructLayout pour quelque chose de plus intéressant que des exemples d'octets, d'entiers et d'autres nombres, dans lesquels tout se passe un peu plus que prévu. <br><a name="habracut"></a><br>  Avant de se lancer dans une violation d'encapsulation ultra-rapide, il convient de rappeler ce qu'est StructLayout.  À strictement parler, il s'agit même d'un StructLayoutAttribute, c'est-à-dire un attribut qui vous permet de créer des structures et des classes similaires à l'union en C ++.  Plus en détail, cet attribut vous permet de prendre le contrôle du placement des membres de la classe en mémoire.  En conséquence, il est placé au-dessus de la classe.  Habituellement, si une classe a 2 champs, nous nous attendons à ce qu'ils soient disposés séquentiellement, c'est-à-dire qu'ils seront indépendants les uns des autres (ne se chevauchent pas).  Cependant, StructLayout permet de spécifier que l'emplacement des champs sera déterminé non pas par l'environnement, mais par l'utilisateur.  Pour indiquer explicitement les décalages de champ, utilisez le paramètre LayoutKind.Explicit.  Pour indiquer à quel décalage par rapport au début de la classe / structure (ci-après dénommée la classe) nous voulons placer le champ, nous devons placer l'attribut FieldOffset au-dessus de lui, qui prend en paramètre le nombre d'octets - le retrait du début de la classe.  Une valeur négative ne peut pas être transmise, alors ne pensez même pas à ruiner les pointeurs vers la table de méthode ou l'index du bloc de synchronisation; <br><br>  Commençons à écrire le code.  Pour commencer, je suggère de commencer par un exemple simple.  Créez une classe du formulaire suivant: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"CUSTOM"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Field { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); }</code> </pre> <br>  Ensuite, nous utilisons le mécanisme ci-dessus pour définir explicitement les décalages de champ. <br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">StructLayout</span></span>(<span class="hljs-type"><span class="hljs-type">LayoutKind.Explicit</span></span>)] public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStructWithLayout</span></span></span></span> { [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public string Str; [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public CustomClass SomeInstance; }</code> </pre><br>  Pour l'instant, je vais reporter les explications et utiliser la classe écrite comme suit: <br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> { static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Main</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomStructWithLayout</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomStructWithLayout</span></span></span><span class="hljs-class">(); </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class"> = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CustomClass</span></span></span><span class="hljs-class">(); </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Str</span></span></span><span class="hljs-class"> = "4564"; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteLine</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetType</span></span></span><span class="hljs-class">()); //</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteLine</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SomeInstance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">()); //4564 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Read</span></span></span><span class="hljs-class">(); } }</span></span></code> </pre><br>  Total  L'appel à la méthode GetType () renvoie une chaîne, la méthode ToString () est coquine et nous donne la chaîne «4564». <br>  Décharge pour le cerveau: qu'est-ce qui sera affiché lorsque la propriété virtuelle CustomClass sera appelée? <br><br>  Comme vous l'avez peut-être deviné, nous avons initialisé CustomStructWithLayout, les deux liens sont nuls, puis nous initialisons un champ de notre type, puis nous attribuons une chaîne au champ Str.  En conséquence, il reste un peu plus de CustomClass que rien.  En plus, il y avait une ligne avec toute sa structure interne, y compris un tableau des méthodes et un index d'un bloc de synchronisation.  Mais le compilateur voit que le champ est toujours du type de notre classe. <br>  Pour preuve, je vais donner un petit extrait de WinDbg: <br><img src="https://habrastorage.org/webt/l5/rb/oo/l5rbooilguqctypvbhwoyfhyq5m.jpeg"><br>  Ici, vous pouvez voir des choses inhabituelles.  Le premier est que dans l'objet, les adresses sur les tables de méthodes ont des champs différents pour les champs de classe, comme prévu, mais l'adresse de la valeur de champ est un.  La seconde - vous pouvez voir que les deux champs sont situés à l'offset 4. Je pense que la plupart comprendront, mais juste au cas où, je vais expliquer, directement à l'adresse de l'objet, il y a un lien vers le tableau des méthodes.  Les champs commencent par un décalage de 4 octets (pour z 32 bits) et l'index du bloc de synchronisation est localisé avec un décalage de -4. <br><br>  Maintenant que vous avez compris ce qui se passe, vous pouvez essayer d'utiliser des décalages pour appeler quelque chose que vous ne devriez pas appeler. <br>  Pour ce faire, j'ai répété la structure de la classe string dans l'une de mes classes.  Certes, je n'ai répété que le début, car la classe de chaîne est très volumineuse. <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomClassLikeString</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeAlignConst = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeCharPtrAlignConst = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> FakeStringEmpty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FakeFirstChar; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeLength = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimBoth = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimHead = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FakeTrimTail = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomClassLikeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stub1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">800</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">801</span></span>; } }</code> </pre><br>  Eh bien, la structure avec Layout change un peu <br><pre> <code class="hljs powershell"> [<span class="hljs-type"><span class="hljs-type">StructLayout</span></span>(<span class="hljs-type"><span class="hljs-type">LayoutKind.Explicit</span></span>)] public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStructWithLayout</span></span></span></span> { [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public string Str; [<span class="hljs-type"><span class="hljs-type">FieldOffset</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)] public CustomClassLikeString SomeInstance; }</code> </pre><br>  De plus, lors de l'appel de FakeLength ou de la méthode CompareTo (), en raison du décalage identique de ces membres de classe par rapport à l'adresse de l'objet lui-même, la méthode de chaîne correspondante (dans ce cas) sera appelée.  Il a fallu un certain temps pour arriver à la première méthode privée de la ligne que je peux utiliser, alors j'ai opté pour la méthode publique.  Mais le terrain est privé, tout est juste.  Soit dit en passant, les méthodes sont rendues virtuelles pour se protéger contre toutes sortes d'optimisations, ce qui interfère avec le travail (par exemple, l'incorporation), et aussi pour que la méthode soit appelée par un décalage dans la table des méthodes. <br><br>  Donc, la performance.  C'est un fait qu'un concurrent direct dans la contestation de ce qu'il n'est pas nécessaire de provoquer et dans la violation de l'encapsulation est la réflexion.  Je pense qu'il est déjà clair que nous sommes plus rapides que cette chose, nous n'analysons pas tous les métadonnées.  Valeurs exactes: <br><table><tbody><tr><th>  La méthode </th><th>  Job </th><th>  Moyenne </th><th>  Erreur </th><th>  Stddev </th><th>  Médiane </th></tr><tr><td>  StructLayoutField </td><td>  Clr </td><td>  0,0597 ns </td><td>  0,0344 ns </td><td>  0,0396 ns </td><td>  0,0498 ns </td></tr><tr><td>  ReflectionField </td><td>  Clr </td><td>  197,1257 ns </td><td>  1,9148 ns </td><td>  1,7911 ns </td><td>  197,4787 ns </td></tr><tr><td>  StructLayoutMethod </td><td>  Clr </td><td>  3,5195 ns </td><td>  0,0382 ns </td><td>  0,0319 ns </td><td>  3,5285 ns </td></tr><tr><td>  ReflectionMethod </td><td>  Clr </td><td>  743,9793 ns </td><td>  13,7378 ns </td><td>  12.8504 ns </td><td>  743.8471 ns </td></tr></tbody></table>  Voici un long morceau de code avec la façon dont j'ai mesuré les performances (si quelqu'un en a besoin): <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">ClrJob</span></span>] [RPlotExporter, RankColumn] [InProcessAttribute] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Benchmarking</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CustomStructWithLayout instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> str; [GlobalSetup] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Setup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomStructWithLayout(); instance.SomeInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomClassLikeString(); instance.Str = <span class="hljs-string"><span class="hljs-string">"4564"</span></span>; str = <span class="hljs-string"><span class="hljs-string">"4564"</span></span>; } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StructLayoutField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance.SomeInstance.FakeLength; } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>).GetField(<span class="hljs-string"><span class="hljs-string">"m_stringLength"</span></span>, BindingFlags.Instance | BindingFlags.NonPublic).GetValue(str); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StructLayoutMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance.SomeInstance.CompareTo(<span class="hljs-string"><span class="hljs-string">"4564"</span></span>); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>).GetMethod(<span class="hljs-string"><span class="hljs-string">"CompareTo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) }).Invoke(str, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"4564"</span></span> }); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> summary = BenchmarkRunner.Run&lt;Benchmarking&gt;(); } }</code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423657/">https://habr.com/ru/post/fr423657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423645/index.html">Comment nous avons servi l'infrastructure informatique de Luzhniki pendant la Coupe du monde</a></li>
<li><a href="../fr423647/index.html">Créer un réseau neuronal simple</a></li>
<li><a href="../fr423649/index.html">"Kubernetes à tous les domaines!" - Entretien avec le comité de programme de la conférence DevOops</a></li>
<li><a href="../fr423651/index.html">Nous invitons tout le monde au hackathon SmartMail Hack: À propos de Bienvenue</a></li>
<li><a href="../fr423653/index.html">PsRealVehicle, ou plug-in Open Source Tank Physics dans Armored Warfare: Assault</a></li>
<li><a href="../fr423663/index.html">Nous écrivons un traducteur simple en Lisp - III</a></li>
<li><a href="../fr423667/index.html">L'histoire des premiers jeux vidéo à microprocesseur</a></li>
<li><a href="../fr423671/index.html">Les rivaux de Tesla reçoivent un investissement d'un milliard de dollars de l'Arabie saoudite</a></li>
<li><a href="../fr423673/index.html">Risques liés au développement de logiciels</a></li>
<li><a href="../fr423677/index.html">Pilotes Jetpack: Frankie West</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>