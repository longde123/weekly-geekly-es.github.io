<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïé üëõ üà∫ Pizza ala-semi-supervisionada üôãüèø üßìüèø üë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, gostaria de falar sobre algumas t√©cnicas para trabalhar com dados ao treinar um modelo. Em particular, como puxar a segmenta√ß√£o de objet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pizza ala-semi-supervisionada</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ods/blog/422873/">  Neste artigo, gostaria de falar sobre algumas t√©cnicas para trabalhar com dados ao treinar um modelo.  Em particular, como puxar a segmenta√ß√£o de objetos nas caixas, bem como treinar o modelo e obter a marca√ß√£o do conjunto de dados, marcando apenas algumas amostras. <br><img src="https://habrastorage.org/webt/wo/lz/ab/wolzab2hx3sxc7qnqrmrucfhynk.png"><br><a name="habracut"></a><br><h2>  Desafio </h2><br>  H√° um certo processo de fazer pizza e fotos a partir de seus v√°rios est√°gios (incluindo n√£o apenas pizza).  Sabe-se que, se a receita da massa estiver estragada, haver√° espinhas brancas na crosta.  H√° tamb√©m uma marca√ß√£o bin√°ria da qualidade do teste para cada inst√¢ncia de pizza, feita por especialistas.  √â necess√°rio desenvolver um algoritmo que determine a qualidade do teste de acordo com a fotografia. <br><br>  O conjunto de dados consiste em fotografias tiradas de diferentes telefones, em diferentes condi√ß√µes, diferentes √¢ngulos.  Inst√¢ncias de pizza - 17k.  Total de fotos - 60k. <br><br>  Na minha opini√£o, a tarefa √© bastante t√≠pica e adequada para mostrar diferentes abordagens ao tratamento de dados.  Para resolv√™-lo, voc√™ deve: <br><br>  1. Escolha fotos onde h√° uma crosta de pizza; <br>  2. Nas fotos selecionadas, realce o bolo; <br>  3. Treine a rede neural nas √°reas selecionadas. <br><br><h2>  Filtrando fotos </h2><br>  √Ä primeira vista, parece que a maneira mais f√°cil seria entregar essa tarefa aos escribas e depois treinar o conjunto de dados em dados limpos.  No entanto, decidi que era mais f√°cil para mim marcar uma pequena parte do que explicar com um escriba qual √¢ngulo estava correto.  Al√©m disso, eu n√£o tinha um crit√©rio r√≠gido para o √¢ngulo reto. <br><br>  Ent√£o aqui est√° o que eu fiz: <br><br>  1. Marcou 100 fotos de borda; <br><br><img src="https://habrastorage.org/webt/r3/_e/po/r3_epoxo9v9p_e0aljlsnqcdgge.png"><br><br>  2. Calculei os recursos ap√≥s a retirada global da grade resnet-152 com pesos do imagenet11k_places365; <br><br><img src="https://habrastorage.org/webt/im/my/0c/immy0cck12em7iyx24yrxyzubwy.png"><br><br>  3. Tomou a m√©dia das caracter√≠sticas de cada classe, recebendo duas √¢ncoras; <br><br>  4. Calculei a dist√¢ncia de cada √¢ncora a todos os recursos das 50 mil fotos restantes; <br><br>  5. Os 300 primeiros na proximidade de uma √¢ncora s√£o relevantes para a classe positiva; os 500 primeiros mais pr√≥ximos da outra √¢ncora s√£o negativos; <br><br><img src="https://habrastorage.org/webt/ga/wn/xn/gawnxnw_jio9rg8yboqzqb3rmac.png"><br><br>  6. Nestas amostras, treinei o LightGBM com os mesmos recursos (o XGboost √© indicado na imagem, porque possui um logotipo e √© mais reconhec√≠vel, mas o LightGBM n√£o possui um logotipo); <br><br>  7. Usando esse modelo, obtive a marca√ß√£o de todo o conjunto de dados. <br><br><img src="https://habrastorage.org/webt/bd/vb/rq/bdvbrqhqcf5crt3scgwhw5zttms.png"><br><br>  Eu usei aproximadamente a mesma abordagem nas competi√ß√µes do kaggle como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">linha de base</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Uma explica√ß√£o nos dedos porque essa abordagem funciona</b> <div class="spoiler_text">  Uma rede neural pode ser percebida como uma transforma√ß√£o fortemente n√£o linear de uma imagem.  No caso de classifica√ß√£o, a imagem √© convertida nas probabilidades das classes que estavam no conjunto de treinamento.  E essas probabilidades podem essencialmente ser usadas como recursos para o Light GBM.  No entanto, essa √© uma descri√ß√£o bastante pobre e, no caso da pizza, diremos que a classe do bolo √© condicionalmente 0,3 gatos e 0,7 c√£es, e o lixo √© o resto.  Em vez disso, voc√™ pode usar recursos menos esparsos ap√≥s o pool m√©dio global.  Eles possuem uma propriedade que gera recursos a partir das amostras do conjunto de treinamento, que devem ser separadas por uma transforma√ß√£o linear (uma camada totalmente conectada ao Softmax).  No entanto, devido ao fato de n√£o haver pizza expl√≠cita no trem imagenet, √© melhor fazer uma transforma√ß√£o n√£o linear na forma de √°rvores para separar as classes do novo conjunto de treinamento.  Em princ√≠pio, voc√™ pode ir ainda mais longe e obter recursos de algumas camadas intermedi√°rias da rede neural.  Eles ser√£o melhores, pois ainda n√£o perderam a localidade dos objetos.  Mas eles s√£o muito piores devido ao tamanho do vetor de recurso.  Al√©m disso, eles s√£o menos lineares do que na frente de uma camada totalmente conectada. <br></div></div><br><h2>  Uma ligeira digress√£o </h2><br>  A ODS reclamou recentemente que ningu√©m escreve sobre suas falhas.  Corrigindo a situa√ß√£o.  H√° cerca de um ano, participei do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">concurso Kaggle Sea Lions</a> com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Eugene Nizhibitsky</a> .  A tarefa era contar as focas nas imagens do zang√£o.  A marca√ß√£o foi simplesmente dada na forma de coordenadas de carca√ßa, mas em algum momento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vladimir Iglovikov as</a> marcou com caixas e generosamente compartilhou isso com a comunidade.  Naquela √©poca, eu me considerava pai da segmenta√ß√£o sem√¢ntica (depois de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kaggle Dstl</a> ) e decidi que a Unet facilitaria muito a tarefa de contar se eu aprendesse a distinguir classicamente os gatos. <br><br><div class="spoiler">  <b class="spoiler_title">Explica√ß√£o da segmenta√ß√£o sem√¢ntica</b> <div class="spoiler_text">  A segmenta√ß√£o sem√¢ntica √© essencialmente uma classifica√ß√£o pixel por pixel de uma imagem.  Ou seja, cada pixel de origem da imagem precisa estar associado a uma classe.  No caso de segmenta√ß√£o bin√°ria (caso do artigo), ser√° uma classe positiva ou negativa.  No caso de segmenta√ß√£o multiclasse, a cada pixel ser√° atribu√≠da uma classe do conjunto de treinamento (fundo, grama, gato, homem, etc.).  No caso da segmenta√ß√£o bin√°ria, a arquitetura da rede neural da rede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">U-net</a> funcionou bem naquele momento.  Essa rede neural √© semelhante em estrutura a um codificador-decodificador convencional, mas com recursos encaminhados da parte do codificador para o decodificador nos est√°gios de tamanho apropriado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cdf/52f/999/cdf52f99903a93bd403db1b073f19ba0.png"><br><br>  Na forma de baunilha, no entanto, ningu√©m mais usa, mas pelo menos eles adicionam a Norma de Lote.  Bem, como regra, eles pegam um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">codificador de gordura</a> e inflam o decodificador.  As arquiteturas do tipo U-net foram substitu√≠das por novas grades de segmenta√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FPN</a> , que mostram bom desempenho em algumas tarefas.  No entanto, arquiteturas do tipo Unet n√£o perderam sua relev√¢ncia at√© hoje.  Eles funcionam bem como uma linha de base, s√£o f√°ceis de treinar e √© muito simples variar a profundidade / tamanho da neuroci√™ncia alterando diferentes codificadores. <br></div></div><br>  Nesse sentido, comecei a ensinar segmenta√ß√£o, tendo como objetivo, no primeiro est√°gio, apenas gatos de boxe.  Ap√≥s a primeira etapa do treinamento, previ o trem e observei como as previs√µes s√£o.  Com a ajuda das heur√≠sticas, pode-se selecionar a confian√ßa abstrata da m√°scara e dividir condicionalmente as previs√µes em dois grupos: onde tudo √© bom e onde tudo √© ruim. <br><br><img src="https://habrastorage.org/webt/wx/84/jt/wx84jttvncmdiykyt25csspnyec.png"><br><br>  Previs√µes onde tudo est√° bem podem ser usadas para treinar a pr√≥xima itera√ß√£o do modelo.  As previs√µes, onde tudo est√° ruim, podem ser escolhidas com grandes √°reas sem selos, m√£os mascaradas e tamb√©m jogadas no trem.  E, iterativamente, Eugene e eu treinamos um modelo que at√© aprendeu a segmentar barbatanas de focas para indiv√≠duos grandes. <br><br><img src="https://habrastorage.org/webt/_a/g6/xz/_ag6xzccipgeizeek1qnncwxz4k.png"><br><br>  Mas foi um fracasso feroz: passamos muito tempo aprendendo a segmentar gatos legais e ... Quase n√£o ajudou no c√°lculo.  A suposi√ß√£o de que a densidade dos selos (o n√∫mero de indiv√≠duos por unidade de √°rea da m√°scara) √© constante n√£o funcionou, porque o drone voou em alturas diferentes e as imagens tinham escalas diferentes.  E, ao mesmo tempo, a segmenta√ß√£o ainda n√£o destacava indiv√≠duos individuais se eles estivessem firmes - o que acontecia com bastante frequ√™ncia.  E antes da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">abordagem inovadora para a separa√ß√£o dos objetos</a> da equipe Tocoder no DSB2018, ainda havia outro ano.  Como resultado, ficamos com nada al√©m de terminar em 40¬∫ lugar entre 600 equipes. <br><br>  No entanto, tirei duas conclus√µes: a segmenta√ß√£o sem√¢ntica √© uma abordagem conveniente para visualizar e analisar a opera√ß√£o do algoritmo, e as m√°scaras podem ser soldadas das caixas com algum esfor√ßo. <br><br>  Mas voltando √† pizza.  Para destacar o bolo nas fotos selecionadas e filtradas, a op√ß√£o mais correta seria entregar a tarefa aos escribas.  Naquela √©poca, j√° t√≠nhamos implementado as caixas e o algoritmo de consenso para elas.  Ent√£o, eu apenas dei alguns exemplos e dei √† marca√ß√£o.  Como resultado, obtive 500 amostras com uma √°rea de crosta selecionada com precis√£o. <br><br><img src="https://habrastorage.org/webt/pd/pr/nh/pdprnh1katpk2nl7gzq-edoy8cm.png"><br><br>  Ent√£o eu peguei meu c√≥digo dos selos e me aproximei mais formalmente do procedimento atual.  Ap√≥s a primeira itera√ß√£o do treinamento, tamb√©m ficou claramente vis√≠vel onde o modelo estava errado.  E a confian√ßa das previs√µes pode ser definida da seguinte forma: <br>  1 - (√°rea cinza) / (√°rea da m√°scara) # haver√° uma f√≥rmula, prometo <br><br><img src="https://habrastorage.org/webt/hz/eb/9d/hzeb9dqh2fazgyo0gpdclqbp1du.png"><br><br>  Agora, para fazer a pr√≥xima itera√ß√£o de puxar as caixas nas m√°scaras, um pequeno conjunto prever√° o trem TTA.  Isso pode ser considerado, at√© certo ponto, na destila√ß√£o do conhecimento WAAAAGH, mas √© mais correto chamar Pseudo Labeling. <br><br><img src="https://habrastorage.org/webt/qk/he/eo/qkheeobxrxzxbim3gk8s8gihoyu.png"><br><br>  Em seguida, voc√™ precisa escolher com seus olhos um certo limiar de confian√ßa, a partir do qual formamos um novo trem.  E, opcionalmente, voc√™ pode marcar as amostras mais complexas que o conjunto n√£o p√¥de manipular.  Decidi que seria √∫til e pintei cerca de 20 figuras em algum lugar enquanto digeria o almo√ßo. <br><br><img src="https://habrastorage.org/webt/13/4e/wz/134ewz9jgris1o-9jmss90qt7ew.png"><br><br>  E agora a parte final do pipeline: modelo de treinamento.  Para preparar as amostras, extra√≠ a √°rea da m√°scara do bolo.  Tamb√©m insuflei um pouco a m√°scara com dilata√ß√£o e a apliquei na imagem para remover o fundo, pois n√£o deveria haver informa√ß√µes sobre a qualidade do teste.  E ent√£o acabei de arquivar v√°rios modelos do Zool√≥gico Imagenet.  No total, eu fui capaz de coletar cerca de 12k amostras confi√°veis.  Portanto, eu n√£o ensinei toda a rede neural, mas apenas o √∫ltimo grupo de convolu√ß√µes, para que o modelo n√£o fosse treinado novamente. <br><br><div class="spoiler">  <b class="spoiler_title">Por que voc√™ precisa congelar camadas</b> <div class="spoiler_text">  H√° dois lucros com isso: 1. A rede aprende mais rapidamente, porque voc√™ n√£o precisa ler gradientes para camadas congeladas.  2. A rede n√£o √© treinada novamente, pois agora possui menos par√¢metros livres.  Argumenta-se que os primeiros grupos de convolu√ß√µes durante o treinamento na Imagenet geram sinais bastante comuns, como transi√ß√µes de cores n√≠tidas e texturas adequadas para uma classe muito ampla de objetos na fotografia.  Isso significa que voc√™ n√£o pode trein√°-los durante o Transer Learning. <br></div></div><br><img src="https://habrastorage.org/webt/_1/vq/-5/_1vq-5oea_ikx7b68me9v_hrjq0.png"><br><br>  O melhor modelo √∫nico foi o Inception-Resnet-v2 e, para ela, o ROC-AUC em uma dobra foi de 0,700.  Se voc√™ n√£o selecionar nada e enviar imagens n√£o processadas como est√£o, o ROC-AUC ser√° 0,58.  Enquanto eu desenvolvia a solu√ß√£o, o pr√≥ximo lote de dados foi cozido na pizza DODO, e foi poss√≠vel testar todo o pipeline de forma honesta.  Verificamos o pipeline inteiro e obtivemos ROC-AUC 0,83. <br><br>  Vejamos os erros agora: <br><br>  Top Falso Negativo <br><br><img src="https://habrastorage.org/webt/nc/as/lz/ncaslzpmdyudlv5joncem_h9gcy.png"><br><br>  Pode-se ver aqui que eles est√£o associados a um erro na marca√ß√£o do bolo, pois h√° claramente sinais de um teste estragado. <br><br>  Top falso positivo <br><br><img src="https://habrastorage.org/webt/bu/hn/cz/buhncz0hnwtl5mf2l5bhqbfuat0.png"><br><br>  Aqui, os erros est√£o relacionados ao fato de o primeiro modelo ter sido escolhido n√£o com um √¢ngulo muito bom, segundo o qual √© dif√≠cil encontrar sinais importantes da qualidade do teste. <br><br><h2>  Conclus√£o </h2><br>  √Äs vezes, os colegas me provocam dizendo que eu resolvo muitos problemas por segmenta√ß√£o usando a Unet.  No entanto, na minha opini√£o, esta √© uma abordagem bastante poderosa e conveniente.  Permite visualizar erros de modelo e a confian√ßa de suas previs√µes.  Al√©m disso, toda a linha de pagamento parece muito simples e agora existem v√°rios reposit√≥rios para qualquer estrutura. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422873/">https://habr.com/ru/post/pt422873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422863/index.html">Tribos, guildas, construir trem e sem TDD: como o desenvolvimento m√≥vel funciona no Uber, Spotify, Odnoklassniki e Avito</a></li>
<li><a href="../pt422865/index.html">Li√ß√£o aberta do Java Enterprise "CDI em a√ß√£o"</a></li>
<li><a href="../pt422867/index.html">Determina√ß√£o do n√∫mero de andares de uma casa a partir de sua fotografia sem aprendizado de m√°quina</a></li>
<li><a href="../pt422869/index.html">N√≥s dominamos novas linguagens de programa√ß√£o, contando com o j√° aprendido</a></li>
<li><a href="../pt422871/index.html">Identifique perfis significativos no VK</a></li>
<li><a href="../pt422875/index.html">Por que voc√™ n√£o deve alugar um VPS / VDS por 200 rublos ou como escolher o servidor virtual certo</a></li>
<li><a href="../pt422877/index.html">"Isso √© IoT?" - aprenda a n√£o ligar para a Internet das Coisas seguidas</a></li>
<li><a href="../pt422879/index.html">Semana 34 de seguran√ßa: por que os roteadores quebram</a></li>
<li><a href="../pt422881/index.html">Apresentando SOCI - Biblioteca de Acesso ao Banco de Dados C ++</a></li>
<li><a href="../pt422883/index.html">Seus direitos autorais s√£o p√©ssimos. Veja como corrigi-lo.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>