<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë• ‚ôøÔ∏è üöß OceanLotus: nueva puerta trasera, viejos esquemas üí≥ üë®‚Äç‚ù§Ô∏è‚Äçüë® üë¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El grupo OceanLotus (tambi√©n conocido como APT32 y APT-C-00) es conocido por sus ataques en el este de Asia. El a√±o pasado, se publicaron varios estud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: nueva puerta trasera, viejos esquemas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421779/">  El grupo OceanLotus (tambi√©n conocido como APT32 y APT-C-00) es conocido por sus ataques en el este de Asia.  El a√±o pasado, se publicaron varios estudios sobre el trabajo del grupo, incluidos los documentos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CyberReason</a> , una revisi√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FireEye</a> y una descripci√≥n del ataque a los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pozos</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agua</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Volexity</a> .  Como podemos ver, el grupo actualiza las puertas traseras, la infraestructura y los vectores de infecci√≥n. <br><br>  OceanLotus contin√∫a apuntando a empresas y agencias gubernamentales en el este de Asia.  Seg√∫n la telemetr√≠a de ESET, los objetivos prioritarios de OceanLotus est√°n en Vietnam, Laos, Camboya y Filipinas. <br><br>  Hace unos meses, descubrimos y analizamos una de sus √∫ltimas puertas traseras.  Implementa varias herramientas que dificultan el an√°lisis y evitan la detecci√≥n; las discutiremos en una publicaci√≥n. <br><br><img src="https://habrastorage.org/webt/4f/mf/dz/4fmfdzgqiqskqku5rz7eeprycti.jpeg"><br><br><a name="habracut"></a><h2>  Distribuci√≥n </h2><br>  Los atacantes usan diferentes m√©todos para convencer a la v√≠ctima de lanzar un cuentagotas malicioso. <br><br><h3>  Extensiones duales e iconos de aplicaciones falsas (Word, PDF, etc.) </h3><br>  Es probable que los goteros se propaguen a trav√©s de archivos adjuntos de correo electr√≥nico.  Observamos los siguientes nombres de archivo: <br>  - <code>Mi17 Technical issues - Phonesack Grp.exe</code> (Mi-17 - Modelo de helic√≥ptero ruso) <br>  - <code>Chi tiet don khieu nai gui saigontel.exe</code> (traducido del vietnamita - "detalles del reclamo enviados a Saigontel", Saigontel - compa√±√≠a de telecomunicaciones vietnamita) <br>  - <code>Updated AF MOD contract - Jan 2018.exe</code> <br>  - <code>remove_pw_Reschedule of CISD Regular Meeting.exe</code> <br>  - <code>Sorchornor_with_PM_-_Sep_2017.exe</code> <br>  - <code>20170905-Evaluation Table.xls.exe</code> <br>  - <code>CV_LeHoangThing.doc.exe</code> (tambi√©n se encontraron curr√≠culums falsos en Canad√°) <br><br>  Todos estos archivos tienen algo en com√∫n: lanzar un documento de cebo protegido con contrase√±a.  No est√° claro si la contrase√±a est√° contenida en alg√∫n lugar de los datos de la carta transmitida, o si el documento no debe abrirse. <br><br><h3>  Instaladores falsos </h3><br>  Varios instaladores falsos que se hacen pasar por instaladores o actualizaciones de software han sido vistos en campa√±as de abrevaderos.  Un ejemplo es el instalador de Firefox reempaquetado descrito por 360 Labs en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Freebuf</a> (en chino). <br><br>  Otra muestra que vimos se llamaba <code>RobototFontUpdate.exe</code> .  Probablemente se propag√≥ a trav√©s de sitios comprometidos, pero no tenemos evidencia suficiente de esto. <br><br>  Todos los archivos descritos, ya sea que se distribuyeron por correo o se descargaron al visitar un sitio comprometido, entregaron el mismo componente de puerta trasera.  En una publicaci√≥n, analizaremos una muestra de <code>RobototFontUpdate.exe</code> y mostraremos c√≥mo se las arregla para ejecutar una carga maliciosa en el sistema. <br><br><h2>  An√°lisis t√©cnico </h2><br>  El proceso de instalaci√≥n y ejecuci√≥n depende de la ofuscaci√≥n de m√∫ltiples capas, a saber, el cifrado de componentes, la reconstrucci√≥n de archivos PE, la carga de c√≥digo de shell y las t√©cnicas de carga lateral.  Este √∫ltimo se describi√≥ en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudio Korplug anterior de ESET</a> . <br><br><h3>  Revisi√≥n de progreso </h3><br>  El ataque consta de dos partes: un gotero y un veh√≠culo de lanzamiento.  Cada paso de cada parte del proceso se explicar√° en detalle en la secci√≥n correspondiente.  Los dos diagramas a continuaci√≥n dan una breve idea del progreso general del malware. <br><br><img src="https://habrastorage.org/webt/yn/wa/jd/ynwajd8empdclmahz0mzaarmpxk.png"><br>  <i>Figura 1. El progreso del cuentagotas</i> <br><br><img src="https://habrastorage.org/webt/gv/ba/jb/gvbajbzaqzd6tmrjpj95nkov-j8.png"><br>  <i>Figura 2. Progreso de la puerta trasera</i> <br><br>  Casi todos estos componentes est√°n ofuscados.  La ofuscaci√≥n se basa en comandos de transici√≥n de pares condicionales complementarios.  Para cada una de las formas: JZ / JNZ, JP / JNP, JO / JNO, etc., cada par realiza una transici√≥n hacia el mismo objetivo.  La secuencia se intercala con c√≥digo basura que usa el puntero de la pila pero no cambia el valor del indicador condicional.  Resulta que la transici√≥n ocurre dentro de la misma rama.  Esto lleva a problemas durante el proceso de descompilaci√≥n debido al uso de valores de puntero de pila positivos. <br><br><img src="https://habrastorage.org/webt/lh/y6/an/lhy6anvm_1feplhj7depx1udiiu.png"><br>  <i>Figura 3. Transici√≥n condicional complementaria</i> <br><br>  Adem√°s, algunos elementos b√°sicos del programa agregan una direcci√≥n a la pila, despu√©s de lo cual terminan en JMP / CALL, mientras que otros elementos b√°sicos agregan dos direcciones y terminan con el comando RET.  La segunda adici√≥n del elemento es la funci√≥n llamada, y la primera es la direcci√≥n del siguiente elemento b√°sico del programa donde se realizar√° la transici√≥n.  Por lo tanto, los elementos b√°sicos del programa se crean sin objetos primarios. <br><br><img src="https://habrastorage.org/webt/jc/5j/dw/jc5jdw3rbtwezkp4ylemfursggw.png"><br>  <i>Figura 4. T√©cnica PUSH / JMP</i> <br><br>  Como resultado de una combinaci√≥n de dos t√©cnicas de ofuscaci√≥n, se obtienen gr√°ficos "hermosos": <br><br><img src="https://habrastorage.org/webt/3l/pe/3x/3lpe3x_ccjdkh9rm0rpxyykztf0.png"><br>  <i>Figura 5. Ofuscando una secuencia de ejecuci√≥n</i> <br><br>  Notar c√≥digo basura es bastante simple.  Puede ignorarse en el an√°lisis de muestras, si conoce el esquema de la aplicaci√≥n. <br><br><h2>  Cuentagotas </h2><br><h3>  Paso 1. Documento de cebo </h3><br>  En los √∫ltimos meses, OceanLotus ha utilizado varios se√±uelos.  Uno de ellos es un software falso para actualizar la fuente TrueType <code>Roboto Slab regular</code> .  Elegir una fuente parece un poco extra√±o, ya que no admite muchos idiomas de Asia Oriental. <br><br><img src="https://habrastorage.org/webt/2p/p8/sm/2pp8sm8gjt15kzqakmyooah1pk8.jpeg"><br>  <i>Figura 6. Icono de actualizaci√≥n de fuente RobototFontUpdate</i> <br><br>  Cuando se ejecuta, el archivo binario descifra sus recursos (XOR, 128 bytes, clave codificada) y restaura los datos descifrados (LZMA).  Archivo leg√≠timo RobotoSlab-Regular.ttf <br><br>  (SHA1: <code>912895e6bb9e05af3a1e58a1da417e992a71a324</code> ) se escribe en la carpeta <code>%temp%</code> y se inicia utilizando la funci√≥n Win32 API <code>ShellExecute</code> . <br><br>  Se ejecuta el c√≥digo de shell descifrado de los recursos.  Despu√©s de la ejecuci√≥n, una actualizaci√≥n de fuente falsa implementa otra aplicaci√≥n cuyo √∫nico prop√≥sito es eliminar el cuentagotas.  Esta aplicaci√≥n de borrado se <code>%temp%\[0-9].tmp.exe</code> como <code>%temp%\[0-9].tmp.exe</code> . <br><br><h3>  Etapa 2. C√≥digo de shell </h3><br>  En cada etapa, se usa el mismo shellcode. <br><br>  El shellcode es un cargador PE personalizado.  Restaura el archivo ejecutable en la memoria: descifra todas las secciones y calcula los movimientos necesarios y otras sangr√≠as.  El <code>RtlMoveMemory</code> usa las tres funciones de la API de Windows: <code>VirtualAlloc</code> , <code>RtlMoveMemory</code> y <code>RtlZeroMemory</code> . <br><br>  La funci√≥n <code>RtlZeroMemory</code> usa para <code>RtlZeroMemory</code> campos en el encabezado PE.  Confiar en un volcado de memoria autom√°tico fallar√°, ya que los encabezados MZ / PE est√°n da√±ados. <br>  El c√≥digo de shell llama a la funci√≥n de inicio de sesi√≥n PE descifrada y luego a la <code>DLLEntry</code> exportaci√≥n <code>DLLEntry</code> . <br><br><h3>  Etapa 3. El verdadero gotero </h3><br> <code>{103004A5-829C-418E-ACE9-A7615D30E125}.dll</code> <br>  Este ejecutable descifra recursos utilizando el algoritmo AES en modo CBC a trav√©s de la API de Windows.  La clave codificada tiene un tama√±o de 256 bits.  Despu√©s del descifrado, los datos comprimidos se descomprimen (algoritmo LZMA). <br><br>  Si el proceso se inicia con derechos de administrador, el malware proporciona persistencia al crear un servicio.  De lo contrario, se usa la clave de registro Run cl√°sica ( <code>HKCU\SOFTWARE\Microsoft\ Windows\CurrentVersion\Run;DeviceAssociationService;rastlsc.exe</code> ). <br><br>  Si el c√≥digo del cuentagotas se ejecuta con derechos de administrador, intenta escribir los archivos enumerados a continuaci√≥n en la carpeta <code>C:\Program Files\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> , si no, los escribe en la <code>%APPDATA%\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> : <br><br>  - <code>rastlsc.exe</code> (SHA1: <code>2616da1697f7c764ee7fb558887a6a3279861fac</code> , copia de la aplicaci√≥n leg√≠tima Symantec Network Access Control, <code>dot1xtra.exe</code> ) <br>  - <code>SyLog.bin</code> (SHA1: <code>5689448b4b6260ec9c35f129df8b8f2622c66a45</code> , puerta trasera encriptada) <br>  - <code>rastls.dll</code> (SHA1: <code>82e579bd49d69845133c9aa8585f8bd26736437b</code> , un archivo DLL malicioso que <code>rastlsc.exe</code> ) <br><br>  La ruta var√≠a de una muestra a otra, pero el dise√±o es similar.  Dependiendo de los derechos, el malware volca los archivos en <code>%ProgramFiles%</code> o <code>%appdata%</code> .  Tambi√©n observamos: <br><br>  - <code>\Symantec\CNG Key Isolation\</code> <br>  - <code>\Symantec\Connected User Experiences and Telemetry\</code> <br>  - <code>\Symantec\DevQuery Background Discovery Broker Tasks\</code> <br><br>  Estas rutas son utilizadas por varios productos de Symantec. <br><br>  Despu√©s de lograr la persistencia e implementar el archivo ejecutable en un archivo leg√≠timo, <br>  <code>rastlsc.exe</code> , se ejecuta utilizando <code>CreateProcessW</code> . <br><br>  Tambi√©n observamos una versi√≥n ( <code>{BB7BDEC9-B59D-492E-A4AF-4C7B1C9E646B}.dll</code> ) que ejecuta <code>rastlsc.exe</code> con el par√°metro <code>krv</code> .  Discutiremos con m√°s detalle a continuaci√≥n. <br><br><h2>  Componente de puerta trasera: relleno de rastlsc.exe </h2><br>  El equipo de OceanLotus utiliza una t√©cnica antigua y conocida en uno de los ejecutables del producto Symantec.  La conclusi√≥n es utilizar el proceso de cargar una biblioteca de un archivo .exe leg√≠timo y firmado escribiendo una biblioteca maliciosa en la misma carpeta.  Esto har√° que el comportamiento malicioso parezca leg√≠timo ya que estas acciones se realizan mientras se ejecuta el ejecutable de confianza. <br><br>  Como se mencion√≥ anteriormente, el archivo leg√≠timo <code>rastlsc.exe</code> se restablece y ejecuta. <br>  Importa el archivo <code>rastls.dll</code> , que en este caso tiene contenido malicioso. <br><br><img src="https://habrastorage.org/webt/jy/ga/ax/jygaaxccovxfilcmjrol9rmoklu.jpeg"><br>  <i>Figura 7. rastlsc.exe firmado digitalmente de Symantec</i> <br><br>  Tambi√©n vimos un relleno usando otros ejecutables leg√≠timos y firmados, incluido <code>mcoemcpy.exe</code> de McAfee, que carga <code>McUtil.dll</code> .  Esta t√©cnica fue utilizada previamente por PlugX, que atrajo la atenci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vietnam CERT</a> (en vietnamita). <br><br><h3>  Etapa 1. Llenar la biblioteca, rastls.dll </h3><br>  El nombre interno del archivo dll es <code>{7032F494-0562-4422-9C39-14230E095C52}.dll</code> , pero hemos visto otras versiones, por ejemplo, <code>{5248F13C-85F0-42DF-860D-1723EEAA4F90}.dll</code> .  Todas las funciones exportadas conducen a la ejecuci√≥n de la misma funci√≥n. <br><br><img src="https://habrastorage.org/webt/hg/1h/qm/hg1hqmssbsek8-kl8e7dkbzsotq.jpeg"><br>  <i>Figura 8. Todas las exportaciones de rasltls.dll conducen a una √∫nica funci√≥n</i> <br><br>  Export intenta leer el archivo <code>SyLog.bin</code> ubicado en la misma carpeta.  Otras versiones han intentado abrir el archivo <code>OUTLFLTR.DAT</code> .  Si el archivo existe, se descifrar√° utilizando el algoritmo AES en modo CBC con una clave codificada de 256 bits, y luego los datos comprimidos recibidos se descomprimir√°n (compresi√≥n LZMA). <br><br>  La variante <code>McUtil.dll</code> utiliza una t√©cnica diferente.  A primera vista, la funci√≥n principal no hace nada malicioso, pero de hecho reemplaza la secci√≥n <code>.text</code> del archivo leg√≠timo <code>mcoemcpy.exe</code> , un archivo binario.  Genera un shellcode cuya tarea es llamar a una funci√≥n para leer el shellcode cifrado de la segunda etapa del archivo <code>mcscentr.adf</code> . <br><br>  El siguiente pseudoc√≥digo se usa para crear c√≥digo de shell: <br><br> <code>x = False i = 0 <br> buff = genRandom() <br> opc1 = [0x58,0x59,0x5a,0x5b] <br> opc2 = [0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57] <br> opc3 = [0x90,0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48, <br> 0x49,0x4a,0x4b] <br> while i &lt; len(buff): <br> currentChar = buff[i] if currentChar &lt; 0xc8: <br> buff[i] = opc1[currentChar % len(opc1)] <br> else: <br> if x: <br> buff[i] = opc2[currentChar % len(opc2)] <br> else: <br> buff[i] = opc3[currentChar % len(opc3)] x = x == False <br> i+=1</code> <br> <br>  A continuaci√≥n, en la figura, puede ver una lista del resultado del ensamblador: <br><br><img src="https://habrastorage.org/webt/i8/4y/gg/i84yggcraq46pahxx_g5gzha4_y.png"><br>  <i>Figura 9. Shellcode generado</i> <br><br><h3>  Pasos 2‚Äì4.  Shellcode, launcher y shellcode nuevamente </h3><br>  El <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> descifra y descarga la <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> .  La biblioteca carga recursos e intenta iniciar el servicio DeviceAssociationService.  La informaci√≥n descifrada tambi√©n contiene un c√≥digo shell.  Este √∫ltimo descifra la etapa final: una puerta trasera. <br><br>  La variante <code>{92BA1818-0119-4F79-874E-E3BF79C355B8}.dll</code> comprueba si <code>rastlsc.exe</code> ejecut√≥ con <code>krv</code> como primer par√°metro.  Si es as√≠, se crea una tarea y <code>rastlsc.exe</code> se ejecuta nuevamente, pero sin este par√°metro. <br><br><h3>  Etapa 5. Puerta trasera </h3><br> <code>{A96B020F-0000-466F-A96D-A91BBF8EAC96}.dll</code> <br> <br>  Primero, el malware intenta descargar sus recursos y descifrarlos usando el algoritmo RC4.  Los recursos resultantes contienen datos utilizados para configurar la puerta trasera.  El formato de configuraci√≥n no es dif√≠cil de encontrar.  Usando Kaitai struct y su estructura damper, obtenemos lo siguiente: <br><br><img src="https://habrastorage.org/webt/wv/sq/7r/wvsq7r5rn67px5msvrjogbnoelk.jpeg"><br>  <i>Figura 10. Estructura de configuraci√≥n</i> <br><br>  <b>Nota</b> : con la excepci√≥n de la l√≠nea domain_encoding_str y la biblioteca httpprov, los datos cambian de muestra a muestra.  Las claves de registro son casi las mismas, pero tienen un esquema similar: <code>\HKCU\SOFTWARE\Classes\AppX[a-f0-9]{32}</code> , nada notable. <br><br>  El programa malicioso recibe los primeros 10 bytes del nombre de usuario (UTF-16), los codifica con la cadena de tres letras <code>mutex_encoding_str</code> en UTF-16 y los codifica en hexadecimal.  El resultado se usa como el nombre del mutex.  Por ejemplo, para un usuario cuyo nombre comienza con <code>abc</code> y una clave en forma de <code>vwx</code> , el mutex ser√° <code>\Sessions\1\BaseNamedObjects\170015001b</code> . <br><br>  La puerta trasera incluye un cargador PE que carga la biblioteca <code>HTTPProv.dll</code> en la memoria, llama al punto de entrada y luego llama a la funci√≥n de exportaci√≥n <code>CreateInstance</code> . <br><br><h3>  Comunicaci√≥n </h3><br>  La puerta trasera utiliza el protocolo de comunicaci√≥n TCP est√°ndar a trav√©s del puerto <code>25123</code> .  Para obtener la direcci√≥n IP del servidor, la puerta trasera primero crea una consulta DNS espec√≠fica. <br><br>  El programa malicioso selecciona uno de los tres dominios de la configuraci√≥n y agrega un subdominio especial que se genera utilizando dos valores.  El primer valor es el nombre de la computadora con una longitud de 16 bytes.  El segundo es una ID de versi√≥n de cuatro bytes.  El siguiente c√≥digo de Python 2 es un algoritmo de codificaci√≥n: <br><br> <code>letters=domain_encoding_str # ‚Äúghijklmnop‚Äù hex_pc_name=pc_name.encode(‚ÄúUTF-16LE‚Äù).encode(‚Äúhex‚Äù) s='' <br> for c in hex_pc_name: <br> if 0x2f &lt; ord(c) &lt; 0x3a: <br> s+=letters[ord(c) - 0x30] <br> else: <br> s+=c</code> <br> <br>  Por ejemplo, si el nombre de la computadora es <code>random-pc</code> y la ID de la versi√≥n es 0x0a841523, se genera el siguiente dominio: <br> <code>niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.dwarduong[.]com</code> <br> <br>  La siguiente expresi√≥n regular se puede utilizar para etiquetar el servidor C&amp;C de esta puerta trasera: <br> <code>[ghijklmnopabcdef]{4-60}\.[ghijklmnopabcdef]{8}\.[az]+\.[az]+</code> <br> <br>  Si la direcci√≥n IP pertenece a un dominio espec√≠fico, el malware intenta establecer una conexi√≥n TCP a trav√©s del puerto <code>25123</code> .  Cada una de las muestras tiene tres nombres de dominio diferentes que se utilizan para encontrar el servidor de C&amp;C. <br><br>  El proceso de comunicaci√≥n se cifra mediante RC4 y se comprime con LZMA.  Es posible descifrar el tr√°fico, ya que la clave se agrega al comienzo de los paquetes.  El formato es el siguiente: <br> <code>[ RC4 (4 )][ ]</code> <br> <br>  Cada byte clave es generado por la funci√≥n <code>rand</code> .  Despu√©s de descifrar y desempaquetar el paquete, los datos tienen el siguiente formato: <br> <code>[dw:][dw:][dw: ][dw: ][dw:] [dw:]</code> <br> <br>  La primera vez que el cliente se conecta al servidor, se transmite el UUID, que se utiliza como identificador de sesi√≥n.  Este √∫ltimo se almacena en la clave de registro como datos binarios: <code>HKCU\SOFTWARE\Classes\ AppXc52346ec40fb4061ad96be0e6cb7d16a\DefaultIcon</code> <br><br>  Como dijimos anteriormente, la puerta trasera tambi√©n contiene una biblioteca llamada <code>HTTPprov</code> .  Se utiliza como una forma alternativa de comunicarse con el servidor.  El archivo DLL env√≠a una solicitud POST a trav√©s de HTTP.  Tambi√©n es compatible con HTTPS y proxies con SOCKS5, SOCKS4a y SOCKS4.  La biblioteca est√° est√°ticamente vinculada con <code>libcurl</code> . <br><br>  Despu√©s de la inicializaci√≥n, se crear√° una entrada en el registro: un comando para que la puerta trasera use m√°s HTTP para comunicarse con el servidor de comandos: <code>HKCU\SOFTWARE\Classes\ CLSID{E3517E26-8E93-458D-A6DF-8030BC80528B}</code> . <br><br>  Se utiliza la aplicaci√≥n cliente est√°ndar: <code>Mozilla/4.0 ( ; MSIE 8.0; Windows NT 6.0; Trident/4.0)</code> . <br><br>  La caracter√≠stica principal de esta biblioteca es un algoritmo de cifrado especial para un identificador universal de recursos.  La parte de recursos del URI se crea utilizando el siguiente pseudoc√≥digo: <br><br> <code>buffEnd = ((DWORD)genRand(4) % 20) + 10 + buff; while (buff &lt; buffEnd){ <br> b=genRand(16); <br> if (b[0] - 0x50 &gt; 0x50) <br> t=0; <br> else <br> *buf++= UPPER(vowels[b[1] % 5]); <br> v=consonants[b[1]%21]); if (!t) <br> v=UPPER(v); <br> *buff++= v; <br> if (v!='h' &amp;&amp; b[2] - 0x50 &lt; 0x50) <br> *buff++= 'h'; <br> *buff++= vowels[b[4] % 5]; <br> if (b[5] &lt; 0x60) <br> *buff++= vowels[b[6] % 5]; <br> *buff++= consonants[b[7] % 21]; <br> if (b[8] &lt; 0x50) <br> *buff++= vowels[b[9] % 5]; <br> *buff++= '-'; <br> }; <br> *buff='\0';</code> <br> <br>  <b>Nota</b> : para mayor claridad, la parte responsable de verificar la longitud de la cadena se ha eliminado del c√≥digo. <br><br>  Para obtener el identificador de la cadena generada, se agregan dos n√∫meros usando un algoritmo especial de verificaci√≥n de suma: <br><br> <code>checksum=crc32(buff) <br> num2=(checksum &gt;&gt; 16) + (checksum &amp; 0xffff) * 2 <br> num1=(num2 ^ 1) &amp; 0xf <br> URL=GENERATED_DOMAIN+ ‚Äú/‚Äù + num1 + ‚Äú/‚Äù + num2 + ‚Äú-‚Äù + buff</code> <br> <br>  Al agregar el generador de URI de la biblioteca <code>HTTPprov</code> , obtenemos la siguiente URL: <br> <code>hXXp://niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.aisicoin[.]com/ 13/139756-Ses-Ufali-L</code> <br> <br><h3>  Equipos </h3><br>  Despu√©s de recibir el identificador de sesi√≥n SESSIONID, la puerta trasera crea una huella digital del sistema.  El paquete se construye de la siguiente manera (sangr√≠a en el paquete - descripci√≥n): <br><br>  <i>0x000</i> - bytes: el valor cambia en cada versi√≥n <br>  <i>0x001</i> - 0x01: byte codificado <br>  <i>0x002</i> - bool: privilegios elevados <br>  <i>0x003</i> - dword: ID de versi√≥n <br>  <i>0x007</i> - cadena (UTF-16), nombre de la computadora (m√°x. 0x20) <br>  <i>0x027</i> - cadena (UTF-16), nombre de usuario <br>  <i>0x079</i> : el resultado de una consulta de registro en <code>HKLM\SOFTWARE\Microsoft\Windows NT\ CurrentVersion</code> valores: <code>ProductName</code> , <code>CSDVersion</code> , <code>CurrentVersion</code> , <code>ReleaseId</code> , <code>CurrentBuildNumber</code> y el resultado de llamar a <code>IsWow64Process (x86|x64)</code> <br>  <i>0x179</i> : el formato posterior de la cadena% s (% s);  reemplazado por ( <code>GetVolumeInformationW:VolumeNameBuffer</code> ), <code>VolumePathNames</code> <br>  <i>0x279</i> - Disco f√≠sico, control de E / S Dispositivo PhysicalDriveIOControl 0x2D1400 (IOCTL_STORAGE_QUERY_ PROPERTY) (VolSerialNumber) <br>  <i>0x379</i> - wmi <code>SELECT SerialNumber FROM Win32_BaseBoard</code> <br>  <i>0x3f9</i> : <i>obtenga</i> la fecha y hora actuales GetSystemTimeAsFileTime <br>  <i>0x400</i> - bool: desconocido <br>  <i>0x401</i> - dword: recibido despu√©s de descifrar el recurso <br><br>  Aqu√≠ hay un ejemplo de una huella digital del sistema: <br><br><img src="https://habrastorage.org/webt/s5/kg/rj/s5kgrj1nop52oeuj-xgop8c7zsa.jpeg"><br>  <i>Figura 11. Huella digital del sistema</i> <br><br>  Esta es una puerta trasera completa que proporciona a sus operadores una serie de caracter√≠sticas: manipulaci√≥n del archivo, registro y procesos, descarga de componentes adicionales, obtenci√≥n de una huella digital del sistema.  A continuaci√≥n se muestran los n√∫meros y las descripciones de los comandos compatibles: <br><br>  0 - huella digital <br>  1: establece la ID de sesi√≥n <br>  2 - creando un proceso y obteniendo un resultado (usando canales de programa) <br>  3 - establece el contador de intentos de conexi√≥n <br>  4 - pospone el tiempo de votaci√≥n <br>  5 - lee un archivo o clave de registro y considera MD5 <br>  6 - creando un proceso <br>  7 - crea un archivo, entrada de registro o transmisi√≥n en memoria <br>  8 - escribe en el registro <br>  9 - sondea el registro <br>  10 - busca archivos en el sistema <br>  11 - transfiere archivos a otro directorio <br>  12 - elimina archivos del disco <br>  13 - obtener una lista de discos marcados en el sistema usando la funci√≥n <br> <code>GetLogicalDriveStringW</code> <br>  14 - crea un directorio <br>  15 - elimina el directorio <br>  16 - lee el archivo desde el desplazamiento <br>  17 - llama al cargador PE (cambiar a comunicaci√≥n a trav√©s de <code>HTTPprov</code> ) <br>  18 - [desconocido] <br>  19-0: sondeo del valor en el registro;  1: implementaci√≥n e implementaci√≥n del programa <br>  20 - establece la variable de entorno <br>  21 - lanza shellcode en un nuevo hilo <br>  22 - devuelve la variable de entorno <br>  23 en la nueva versi√≥n: se reinicia si la variable de entorno APPL no existe <br><br><h2>  Conclusi√≥n </h2><br>  OceanLotus permanece altamente activo y contin√∫a actualizando el kit de herramientas. <br>  El grupo busca ocultar sus actividades, para esto los atacantes seleccionan cuidadosamente a las v√≠ctimas, limitan la propagaci√≥n de malware, usan varios servidores para no llamar la atenci√≥n sobre el mismo dominio o direcci√≥n IP.  El descifrado del componente que se est√° implementando y la t√©cnica de carga lateral, a pesar de su popularidad generalizada, hacen posible evitar la detecci√≥n, ya que el trabajo de los atacantes en este caso se disfraza como una aplicaci√≥n leg√≠tima. <br><br><h2>  Indicadores de compromiso (IoC) </h2><br><h3>  Muestras </h3><br><h4>  Tabla 1: cuentagotas </h4><br><img src="https://habrastorage.org/webt/4z/vz/kh/4zvzkhbbyci_fp6w6jyedbpn42i.png"><br><br><h4>  Tabla 2: Bibliotecas </h4><br><img src="https://habrastorage.org/webt/0g/9i/2r/0g9i2rys-bufj_lmi9xqb7orl3g.png"><br><br><h3>  Red </h3><br><h4>  Direcciones IP </h4><br> <code>46.183.220.81 <br> 46.183.220.82 <br> 46.183.222.82 <br> 46.183.222.83 <br> 46.183.222.84 <br> 46.183.223.106 <br> 46.183.223.107 <br> 74.121.190.130 <br> 74.121.190.150 <br> 79.143.87.230</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421779/">https://habr.com/ru/post/es421779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421765/index.html">¬øQu√© es una aplicaci√≥n web en producci√≥n?</a></li>
<li><a href="../es421767/index.html">A los mineros se les ofrece la condici√≥n de aut√≥nomos.</a></li>
<li><a href="../es421769/index.html">El libro "Aprendizaje profundo sobre R"</a></li>
<li><a href="../es421773/index.html">Cuando un equipo de t√©cnicos cre√≥ su compa√±√≠a, temporada 3 (¬°finalmente vol√≥!)</a></li>
<li><a href="../es421775/index.html">Red neuronal entrenada para reconocer la depresi√≥n mediante el discurso arbitrario de una persona sin contexto</a></li>
<li><a href="../es421783/index.html">Fun State Management Huex Framework</a></li>
<li><a href="../es421785/index.html">California est√° a punto de rechazar por completo el carbono en la producci√≥n de energ√≠a.</a></li>
<li><a href="../es421787/index.html">Desarrollo de arquitectura de proyectos, naves y JavaScript</a></li>
<li><a href="../es421789/index.html">Hacer frontend "backend" de nuevo</a></li>
<li><a href="../es421791/index.html">Cuestiones √©ticas de la inteligencia artificial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>