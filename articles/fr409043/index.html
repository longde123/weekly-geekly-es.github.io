<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê∫ üë©üèΩ‚Äçü§ù‚Äçüë®üèª üë®üèº‚Äç‚öñÔ∏è Nous nous effor√ßons au maximum: de l'ORM √† l'analyse de bytecode üõÄüèø üë®üèø‚Äç‚öïÔ∏è üôáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme vous le savez, un vrai programmeur devrait faire 3 choses dans sa vie: cr√©er son propre langage de programmation, √©crire son propre syst√®me d'ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous nous effor√ßons au maximum: de l'ORM √† l'analyse de bytecode</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409043/"><p>  Comme vous le savez, un vrai programmeur devrait faire 3 choses dans sa vie: cr√©er son propre langage de programmation, √©crire son propre syst√®me d'exploitation et cr√©er son propre ORM.  Et si j'ai √©crit la langue il y a longtemps (peut-√™tre que je vous le dirai une autre fois) et que le syst√®me d'exploitation est toujours en avance, alors je veux vous parler d'ORM en ce moment.  Pour √™tre plus pr√©cis, il ne s'agit m√™me pas d'ORM lui-m√™me, mais de la mise en ≈ìuvre d'une petite fonctionnalit√© locale et, semble-t-il, compl√®tement simple. </p><br><p> Ensemble, nous irons de la joie de trouver une solution simple √† l'amertume de la conscience de sa fragilit√© et de son inexactitude.  De l'utilisation d'une API exclusivement publique aux hacks sales.  De ¬´presque sans r√©flexion¬ª √† ¬´jusqu'aux genoux dans l'interpr√©teur de code octet¬ª. </p><br><p>  Qui se soucie d'analyser le bytecode, quelles difficult√©s il pr√©sente et quel r√©sultat incroyable vous pouvez obtenir √† la fin, bienvenue chez cat. </p><a name="habracut"></a><br><h3 id="soderzhanie">  Table des mati√®res </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1</a> - Comment tout a commenc√©. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2-4</a> - En route vers le bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5</a> - Qui est le bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6</a> - L'analyse elle-m√™me.  C'est pour le bien de ce chapitre que tout a √©t√© con√ßu et c'√©tait en lui-m√™me les tripes. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">7</a> - Quoi d'autre peut √™tre fini.  R√™ves, r√™ves ... <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Afterword</a> - Afterword. </p><br><p>  <em>UPD: Imm√©diatement apr√®s la publication, les parties 6-8 ont √©t√© perdues (pour le bien de quoi tout a commenc√©).</em>  <em>Fixe.</em> </p><br><a name="1"></a><br><h3 id="chast-pervaya-problema">  Premi√®re partie  Le probl√®me </h3><br><p>  Imaginez que nous ayons un sch√©ma simple.  Il y a un client, il a plusieurs comptes.  L'un d'eux est par d√©faut.  En outre, un client peut avoir plusieurs cartes SIM et chaque carte SIM peut √™tre d√©finie explicitement, ou un client par d√©faut peut √™tre utilis√©. </p><br><p><img src="https://habrastorage.org/webt/dh/io/ag/dhioagv6hwl7cmpls9cuh2a_dyq.png"></p><br><p>  Voici comment ce mod√®le est d√©crit dans notre code (en omettant les getters / setters / constructors / ...). </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"DEFAULTACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account defaultAccount; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long balance; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CARD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String msisdn; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; }</code> </pre> <br><p>  Dans ORM lui-m√™me, nous avons une exigence pour l'absence de procurations (nous devons cr√©er une instance de cette classe particuli√®re) et une seule demande.  En cons√©quence, voici ce que sql est envoy√© √† la base de donn√©es lorsque vous essayez d'obtenir une carte. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.id <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, CARD.msisdn msisdn, ACCOUNT_2.id ACCOUNT_2_id, ACCOUNT_2.balance ACCOUNT_2_balance, CLIENT_3.id CLIENT_3_id, CLIENT_3.name CLIENT_3_name, CLIENT_1.id CLIENT_1_id, CLIENT_1.name CLIENT_1_name, ACCOUNT_4.id ACCOUNT_4_id, ACCOUNT_4.balance ACCOUNT_4_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = CLIENT_1.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = ACCOUNT_2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ACCOUNT_2.CLIENT = CLIENT_3.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_4 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CLIENT_1.DEFAULTACCOUNT = ACCOUNT_4.id;</code> </pre> <br><p>  Oups.  Le client et la facture sont dupliqu√©s.  Certes, si vous y r√©fl√©chissez, cela est compr√©hensible - apr√®s tout, le cadre ne sait pas que le client de la carte et le client du compte de carte sont le m√™me client.  Une requ√™te doit √™tre g√©n√©r√©e statiquement et une seule (rappelez-vous la limitation de l'unicit√© de la demande?) </p><br><p>  Soit dit en passant, pour exactement la m√™me raison, il n'y a aucun <code>Card.account.client.defaultAccount</code> et <code>Card.client.defaultAccount.client</code> .  Nous savons seulement que <code>client</code> et <code>client.defaultAccount.client</code> correspondent toujours.  Et le cadre ne sait pas, pour lui, c'est un lien arbitraire.  Et que faire dans de tels cas n'est pas tr√®s clair.  Je connais 3 options: </p><br><ol><li>  D√©crivez explicitement les invariants dans les annotations. </li><li>  Faire des requ√™tes r√©cursives ( <code>with recursive</code> / se <code>connect by</code> ). </li><li>  Pour marquer. </li></ol><br><p>  Devinez quelle option nous avons choisie?  Oui.  Par cons√©quent, tous les champs r√©cursifs ne sont plus du tout remplis et il y a toujours null. </p><br><p>  Mais si vous regardez attentivement, vous pouvez voir le deuxi√®me probl√®me derri√®re la duplication, et c'est bien pire.  Que voulions-nous?  Num√©ro de carte et solde.  Qu'avez-vous obtenu?  4 jointures et 10 colonnes.  Et cette chose grandit de fa√ßon exponentielle!  Eh bien, c'est-√†-dire  nous avons vraiment une situation o√π, d'abord, pour des raisons de beaut√© et d'int√©grit√©, nous d√©crivons pleinement le mod√®le sur les annotations, puis, <strong>pour 5 champs</strong> , une demande de <strong>15 jointures et 150 colonnes</strong> est demand√©e.  Et en ce moment √ßa devient vraiment effrayant. </p><br><a name="2"></a><br><h3 id="chast-vtoraya-rabochee-no-neudobnoe-reshenie">  Deuxi√®me partie  Une solution fonctionnelle mais peu pratique </h3><br><p>  Une solution simple demande imm√©diatement.  Seuls les haut-parleurs qui seront utilis√©s doivent √™tre tra√Æn√©s!  Facile √† dire.  L'option la plus √©vidente (pour √©crire la s√©lection avec vos mains) nous abandonnera imm√©diatement.  Eh bien, pas √† ce moment-l√†, nous avons d√©crit le mod√®le afin de ne pas l'utiliser.  Il y a tr√®s longtemps, une m√©thode sp√©ciale a √©t√© <code>partialGet</code> - <code>partialGet</code> .  Contrairement √† <code>get</code> simple, il accepte <code>List&lt;String&gt;</code> - les noms des champs √† remplir.  Pour ce faire, vous devez d'abord enregistrer des alias dans les tableaux </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"a"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>  Et puis profitez du r√©sultat. </p><br><pre> <code class="java hljs">List&lt;String&gt; requiredColumns = asList(<span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); String query = cardMapper.getSelectSQL(requiredColumns, DatabaseType.ORACLE); System.out.println(query);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.msisdn msisdn, c_a.balance c_a_balance, a.balance a_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = a.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = c.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> c_a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.DEFAULTACCOUNT = c_a.id;</code> </pre> <br><p>  Et tout semble aller bien, mais, en fait, non.  Voici comment il sera utilis√© dans du vrai code. </p><br><pre> <code class="java hljs">Card card = cardDAO.partialGet(cardId, <span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); ... ... ...    ... ... ... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId = card.getClient().getId();<span class="hljs-comment"><span class="hljs-comment">//, NPE.  , id    ?!</span></span></code> </pre> <br><p>  Et il s'av√®re que vous ne pouvez d√©sormais utiliser partialGet que si la distance entre celui-ci et l'utilisation du r√©sultat n'est que de quelques lignes.  Mais si le r√©sultat va loin ou, Dieu nous en pr√©serve, est transmis √† l'int√©rieur d'une m√©thode, il est d√©j√† extr√™mement difficile de comprendre quels champs sont remplis et lesquels ne le sont pas.  De plus, si NPE s'est produit quelque part, alors vous devez toujours savoir s'il est vraiment revenu de la base de donn√©es null ou si nous n'avons tout simplement pas rempli ce champ.  Dans l'ensemble, tr√®s peu fiable. </p><br><p>  Vous pouvez, bien s√ªr, simplement √©crire un autre objet avec votre mappage sp√©cifiquement pour la demande, ou m√™me s√©lectionner compl√®tement le tout avec vos mains et l'assembler en un <code>Tuple</code> .  En fait, en r√©alit√©, dans la plupart des endroits, nous faisons exactement cela.  Mais je voudrais quand m√™me ne pas √©crire de s√©lections avec mes mains et ne pas dupliquer la cartographie. </p><br><a name="3"></a><br><h3 id="chast-tretya-udobnoe-no-nerabochee-reshenie">  Troisi√®me partie.  Une solution pratique mais inop√©rante. </h3><br><p>  Si vous r√©fl√©chissez un peu plus, la r√©ponse me vient assez rapidement - vous devez utiliser des interfaces.  D√©clarez ensuite </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MsisdnAndBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMsisdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Et utiliser </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, ...);</code> </pre> <br><p>  Et c'est tout.  N'appelez rien de plus.  De plus, avec la transition vers Kotlin / ten / lomb, m√™me ce type terrible peut √™tre √©limin√©.  Mais ici, le point le plus important est encore omis.  Quels arguments doivent √™tre transmis √† <code>partialGet</code> ?  Les tongs, comme avant, n'ont plus envie, car le risque est trop grand pour faire des erreurs et √©crire les mauvais champs.  Et je veux que vous puissiez en quelque sorte </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, MsisdnAndBalance.class);</code> </pre> <br><p>  Ou encore mieux sur Kotlin gr√¢ce aux g√©n√©riques r√©ifi√©s </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> card = cardDAO.paritalGet&lt;MsisdnAndBalance&gt;(cardId)</code> </pre> <br><p>  Ehh, une erreur.  En fait, toute l'histoire suppl√©mentaire est pr√©cis√©ment la mise en ≈ìuvre de cette option. </p><br><a name="4"></a><br><h3 id="chast-chetvertaya-na-puti-k-baytkodu">  Quatri√®me partie  En route vers le bytecode </h3><br><p>  Le probl√®me cl√© est que les m√©thodes proviennent de l'interface et que les annotations sont au-dessus des champs.  Et nous devons trouver ces m√™mes champs par des m√©thodes.  La premi√®re et la plus √©vidente pens√©e est d'utiliser la convention Java Bean standard.  Et pour les propri√©t√©s triviales, cela fonctionne m√™me.  Mais cela s'av√®re tr√®s instable.  Par exemple, il vaut la peine de renommer une m√©thode dans une interface (par refactorisation id√©ologique), car tout s'√©croule instantan√©ment.  L'id√©e est suffisamment intelligente pour renommer les m√©thodes dans les classes d'impl√©mentation, mais pas assez pour comprendre qu'il s'agissait d'un getter et que vous devez renommer le champ lui-m√™me.  Et une solution similaire conduit √† la duplication des champs.  Par exemple, si j'ai besoin de la m√©thode <code>getClientId()</code> dans mon interface, je ne peux pas l'impl√©menter de la seule mani√®re correcte </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Et je dois dupliquer les champs.  Et dans <code>Client</code> faites glisser <code>id</code> et <code>clientId</code> , et dans la carte √† c√¥t√© du client, explicitement <code>clientId</code> .  Et assurez-vous que tout cela ne part pas.  De plus, je veux aussi que les getters avec une logique non triviale fonctionnent, par exemple </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> account.getBalance(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getDefaultAccount().getBalance(); } }</code> </pre> <br><p>  Ainsi, l'option de recherche par nom n'est plus n√©cessaire, vous avez besoin de quelque chose de plus d√©licat. </p><br><p>  L'option suivante √©tait compl√®tement folle et ne vivait pas longtemps dans ma t√™te, mais dans un souci d'exhaustivit√© de l'histoire, je la d√©crirai √©galement.  Au stade de l'analyse, nous pouvons cr√©er une entit√© vide et simplement √©crire √† tour de r√¥le des valeurs dans les champs, et apr√®s cela nous obtenons les getters et regardons que cela a chang√© ce qu'ils retournent ou non.  Nous verrons donc qu'√† partir de l'enregistrement dans le champ de <code>name</code> , la valeur de <code>getClientId</code> ne change pas, mais √† partir de l' <code>id</code> enregistrement - il change.  De plus, la situation o√π des getters et des champs de diff√©rents types (tels que <code>isActive() = i_active != 0</code> ) est automatiquement prise en charge ici.  Mais il y a au moins trois probl√®mes graves (peut-√™tre plus, mais je n'ai pas r√©fl√©chi plus loin). </p><br><ol><li>  L'exigence √©vidente pour l'essence avec cet algorithme est de renvoyer la "m√™me" valeur du getter si le champ "correspondant" n'a pas chang√©.  "Une seule et m√™me chose" - du point de vue de l'op√©rateur de comparaison que nous avons choisi.  <code>==</code> cela ne peut √©videmment pas l'√™tre (sinon certains <code>getAsInt() = Integer.parseInt(strField))</code> cesseront de fonctionner <code>getAsInt() = Integer.parseInt(strField))</code> .  Reste √©gal.  Donc, si le getter retourne une sorte d'entit√© utilisateur g√©n√©r√©e par des champs √† chaque appel, il doit alors avoir un remplacement <code>equals</code> . </li><li>  Mappages de compression.  Comme dans l'exemple avec <code>int -&gt; boolean</code> ci-dessus.  Si nous v√©rifions les valeurs 0 et 1, nous verrons un changement.  Mais si √† 40 et 42, alors les deux fois nous devenons vrais. </li><li>  Il peut y avoir des convertisseurs complexes dans les getters qui d√©pendent de certains invariants dans les champs (par exemple, un format de cha√Æne sp√©cial).  Et sur nos donn√©es g√©n√©r√©es, ils l√®veront des exceptions. </li></ol><br><p>  Donc, en g√©n√©ral, l'option ne fonctionne pas non plus. </p><br><p>  En discutant de tout cela, j'ai d'abord prononc√© en plaisantant la phrase "eh bien, nafig, il est plus facile de voir le bytecode, tout y est √©crit."  √Ä ce moment-l√†, je ne savais m√™me pas que cette id√©e allait m'avaler et jusqu'o√π tout irait. </p><br><a name="5"></a><br><h3 id="chast-pyataya-chto-takoe-baytkod-i-kak-on-rabotaet">  Cinqui√®me partie  Qu'est-ce que le bytecode et comment √ßa marche </h3><br><p> <code>new #4, dup, invokespecial #5, areturn</code> <br>  Si vous comprenez ce qui est √©crit ici et ce que fait ce code, vous pouvez passer √† la partie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suivante</a> . </p><br><p>  <em>Clause de non-responsabilit√© 1.</em> Malheureusement, pour comprendre la suite de l'histoire, vous avez besoin d'au moins une compr√©hension de base de ce √† quoi ressemble le bytecode Java, je vais donc √©crire quelques paragraphes √† ce sujet.  Ne pr√©tendez en aucun cas √™tre complet. </p><br><p>  <em>Clause de non-responsabilit√© 2.</em> Il s'agira exclusivement du corps des m√©thodes.  Ni sur le pool constant, ni sur la structure de la classe dans son ensemble, ni m√™me sur les d√©clarations de m√©thode elles-m√™mes, je dirai un mot. </p><br><p>  La principale chose que vous devez comprendre au sujet du bytecode est l'assembleur de la machine virtuelle de la pile Java.  Cela signifie que les arguments des instructions sont extraits de la pile et que les valeurs de retour des instructions sont repouss√©es dans la pile.  De ce point de vue, on peut dire que le bytecode est √©crit en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">notation polonaise invers√©e</a> .  En plus de la pile, la m√©thode poss√®de √©galement un tableau de variables locales.  En entrant dans la m√©thode, <code>this</code> et tous les arguments de cette m√©thode y sont √©crits et les variables locales y sont stock√©es pendant l'ex√©cution.  Voici un exemple simple. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAndReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> baz, String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) baz; result += str.length(); bar = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p>  J'√©crirai des commentaires au format </p><br><pre> <code class="plaintext hljs"># [(&lt;local_variable_index&gt;:&lt;actual_value&gt;)*], [(&lt;value_on_stack&gt;)*]</code> </pre> <br><p>  Haut de la pile √† gauche. </p><br><pre> <code class="plaintext hljs">public int updateAndReturn(long, java.lang.String); Code: # [0:this, 1:long baz, 3:str], () 0: lload_1 # [0:this, 1:long baz, 3:str], (long baz) 1: l2i # [0:this, 1:long baz, 3:str], (int baz) 2: istore 4 # [0:this, 1:long baz, 3:str, 4:int baz], () 4: iload 4 # [0:this, 1:long baz, 3:str, 4:int baz], (int baz) 6: aload_3 # [0:this, 1:long baz, 3:str, 4:int baz], (str, int baz) 7: invokevirtual #2 // Method java/lang/String.length:()I # [0:this, 1:long baz, 3:str, 4:int baz], (length(str), int baz) 10: iadd # [0:this, 1:long baz, 3:str, 4:int baz], (length(str) + int baz) 11: istore 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], () 13: aload_0 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (this) 14: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz, this) 16: putfield #3 // Field bar:I # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (),     bar 19: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz) 21: ireturn #  int   ,      </code> </pre> <br><p>  Il y a beaucoup d'instructions.  La liste compl√®te doit √™tre consult√©e dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sixi√®me chapitre de JVMS</a> , sur Wikip√©dia, il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">bref r√©cit</a> .  Un grand nombre d'instructions se dupliquent pour diff√©rents types (par exemple, <code>iload</code> pour int et <code>lload</code> pour long).  De plus, pour travailler avec les 4 premi√®res variables locales, leurs instructions sont mises en √©vidence (par exemple, il y a <code>lload_1</code> et il n'accepte pas du tout d'arguments, mais il n'y a que <code>lload</code> , il prendra le num√©ro de la variable locale comme argument. Dans l'exemple ci-dessus, il y a un <code>iload</code> similaire). </p><br><p>  Globalement, nous serons int√©ress√©s par les groupes d'instructions suivants: </p><br><ol><li>  <code>*load*</code> , <code>*store*</code> - lire / √©crire une variable locale </li><li>  <code>*aload</code> , <code>*astore</code> - lecture / √©criture d'un √©l√©ment de tableau par index </li><li>  <code>getfield</code> , <code>putfield</code> - champ de lecture / √©criture </li><li>  <code>getstatic</code> , <code>putstatic</code> - champ statique en lecture / √©criture </li><li>  <code>checkcast</code> - cast entre les types d'objets.  Besoin car  les valeurs saisies se trouvent sur la pile et dans les variables locales.  Par exemple, ci-dessus √©tait l2i pour le casting long -&gt; int. </li><li>  <code>invoke*</code> - appel de m√©thode </li><li>  <code>*return</code> - retourne la valeur et quitte la m√©thode </li></ol><br><a name="6"></a><br><h3 id="chast-shestaya-glavnaya">  Sixi√®me partie  Accueil </h3><br><p>  Pour ceux qui ont rat√© une si longue introduction, ainsi que pour d√©tourner l'attention du probl√®me et de la raison d'origine en termes de biblioth√®que, nous formulons le probl√®me plus pr√©cis√©ment. </p><br><blockquote>  Il est n√©cessaire, ayant une instance <code>java.lang.reflect.Method</code> sous la main, d'obtenir une liste de tous les champs non statiques (√† la fois actuels et tous les objets imbriqu√©s) dont les lectures (directement ou transitivement) seront √† l'int√©rieur de cette m√©thode. </blockquote><p>  Par exemple, pour une telle m√©thode </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>  Vous devez obtenir une liste de deux champs: <code>account.balance</code> et <code>client.defaultAccount.balance</code> . </p><br><p>  J'√©crirai, si possible, une solution g√©n√©ralis√©e.  Mais dans quelques endroits, vous devrez utiliser la connaissance du probl√®me d'origine pour r√©soudre des probl√®mes insolubles, dans le cas g√©n√©ral. </p><br><p>  Vous devez d'abord obtenir le bytecode du corps de la m√©thode lui-m√™me, mais vous ne pouvez pas le faire directement via Java.  Mais depuis  √âtant donn√© que la m√©thode existe √† l'origine dans une classe, il est plus facile d'obtenir la classe elle-m√™me.  Globalement, je connais deux options: coincer dans le processus de chargement de classe et intercepter l' <code>byte[]</code> d√©j√† lu <code>byte[]</code> , ou simplement trouver le fichier <code>ClassName.class</code> sur le disque et le lire.  L'interception du chargement au niveau de la biblioth√®que habituelle ne peut pas √™tre effectu√©e.  Vous devez soit connecter javaagent, soit utiliser ClassLoader personnalis√©.  Dans tous les cas, des √©tapes suppl√©mentaires sont n√©cessaires pour configurer jvm / application, ce qui n'est pas pratique.  Vous pouvez le faire plus facilement.  Toutes les classes "ordinaires" sont toujours dans le m√™me fichier avec l'extension ".class", dont le chemin est le package de classe.  Oui, cela ne fonctionnera pas pour trouver des classes ajout√©es dynamiquement ou des classes charg√©es par un chargeur de classe personnalis√©, mais nous en avons besoin pour le mod√®le jdbc, donc nous pouvons dire avec confiance que toutes les classes seront empaquet√©es de la "mani√®re par d√©faut" dans des bocaux.  Total: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); }</code> </pre> <br><p>  Hourra, lisez le tableau d'octets.  Qu'allons-nous en faire ensuite?  En principe, il existe plusieurs biblioth√®ques en Java pour la lecture / √©criture de bytecode, mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ASM</a> est g√©n√©ralement utilis√© pour les travaux de bas niveau.  Parce que  il est affin√© pour des performances √©lev√©es et un fonctionnement √† la vol√©e, l'API visiteur est la principale - asm lit s√©quentiellement la classe et tire les m√©thodes appropri√©es </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, Object value)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{...} ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MethodVisitor mv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodVisitor mv)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mv = mv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, Label label)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mv != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mv.visitJumpInsn(opcode, label); } } ... }</code> </pre> <br><p>  L'utilisateur est invit√© √† red√©finir les m√©thodes qui l'int√©ressent et √† y √©crire sa propre logique d'analyse / transformation.  Par ailleurs, sur l'exemple de <code>MethodVisitor</code> , je voudrais attirer l'attention sur le fait que tous les visiteurs ont une impl√©mentation par d√©faut par d√©l√©gation. </p><br><p>  En plus de l'API principale, il existe √©galement une API Tree pr√™te √† l'emploi.  Si l'API Core est un analogue de l'analyseur SAX, alors l'API Tree est un analogue du DOM.  Nous obtenons un objet √† l'int√©rieur duquel toutes les informations sur la classe / m√©thode sont stock√©es et nous pouvons l'analyser comme nous voulons avec des sauts √† n'importe quel endroit.  En fait, cette API est une impl√©mentation <code>*Visitor</code> qui, √† l'int√©rieur des m√©thodes <code>visit*</code> , stocke simplement des informations.  Presque toutes les m√©thodes y ressemblent: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Label label)</span></span></span><span class="hljs-function"> </span></span>{ instructions.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JumpInsnNode(opcode, getLabelNode(label))); } ... }</code> </pre> <br><p>  Maintenant, nous pouvons enfin charger la m√©thode pour l'analyse. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!name.equals(getterName) || !desc.equals(getterDesc)) return null; return new AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } private class AnalyzerMethodVisitor extends MethodVisitor { public AnalyzerMethodVisitor(int access, String name, String desc, String signature, String[] exceptions) { super(ASM6, new MethodNode(ASM6, access, name, desc, signature, exceptions)); } @Override public void visitEnd() { //     ,     MethodVisitor    if (methodNode != null) throw new IllegalStateException(); methodNode = (MethodNode) mv; } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">M√©thode de lecture compl√®te du code.</b> <div class="spoiler_text"><p>  <code>MethodNode</code> pas retourn√© directement, mais un wrapper avec une paire d'ext.  champs parce que  nous en aurons √©galement besoin plus tard.  Le point d'entr√©e (et la seule m√©thode publique) est <code>readMethod(Method): MethodInfo</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalDeclaringClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> classAccess, MethodNode methodNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internalDeclaringClassName = internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classAccess = classAccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.methodNode = methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInternalDeclaringClassName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalDeclaringClassName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classAccess; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; clazz = method.getDeclaringClass(); String internalClassName = getInternalName(clazz); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = getClassFile(clazz)) { ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(is); AnalyzerClassVisitor cv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerClassVisitor(internalClassName, method); cr.accept(cv, SKIP_DEBUG | SKIP_FRAMES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodInfo(internalClassName, cv.getAccess(), cv.getMethodNode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String className; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalClassName, Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.className = internalClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(className)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.access = access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(getterName) || !desc.equals(getterDesc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodNode(ASM6, access, name, desc, signature, exceptions)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); methodNode = (MethodNode) mv; } } } }</code> </pre> </div></div><br><p>  Il est temps de faire l'analyse directement.  Comment le faire?  La premi√®re pens√©e est de regarder toutes les instructions <code>getfield</code> .  Chaque <code>getfield</code> indique statiquement de quel champ il s'agit et de quelle classe.  On peut consid√©rer comme n√©cessaire tous les domaines de notre classe auxquels il y avait acc√®s.  Mais, malheureusement, cela ne fonctionne pas.  Le premier probl√®me ici est que l'exc√©dent est captur√©. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> baz; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bar + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo().baz; } }</code> </pre> <br><p>  Avec cet algorithme, nous consid√©rons que le champ baz est n√©cessaire, bien qu'en fait non.  Mais ce probl√®me pourrait encore √™tre marqu√©.  Mais que faire des m√©thodes? </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasClientId obj = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.getClientId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><p>  Si nous recherchons des appels de m√©thode de la m√™me mani√®re que nous recherchons des champs de lecture, nous ne trouverons pas <code>getClientId</code> .  Car il n'y a pas d'appel √† <code>Client.getClientId</code> , mais seulement un appel √† <code>HasClientId.getClientId</code> .  Bien s√ªr, vous pouvez consid√©rer toutes les m√©thodes de la classe actuelle, toutes ses superclasses et toutes les interfaces √† utiliser, mais c'est d√©j√† trop.  Ainsi, vous pouvez accidentellement capturer <code>toString</code> , et il contient une liste de tous les champs en g√©n√©ral. </p><br><p>  De plus, nous voulons que les appels getter sur les objets imbriqu√©s fonctionnent aussi </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Et ici, l'appel √† la m√©thode <code>Client.getId</code> ne s'applique pas du tout √† la classe <code>Account</code> . </p><br><p>  Avec un fort d√©sir, vous pouvez toujours penser √† des hacks pour des cas sp√©ciaux pendant un certain temps, mais assez rapidement, il s'agit de comprendre que ¬´les choses ne se font pas comme √ßa¬ª et vous devez surveiller pleinement le flux d'ex√©cution et le mouvement des donn√©es.        <code>getfield</code> ,      <code>this</code> ,   -   <code>this</code> .  Voici un exemple: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.id + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Account().id; } }</code> </pre> <br><pre> <code class="plaintext hljs">class Account { public Client client; public long test(); Code: 0: aload_0 1: getfield #2 // Field client:LClient; 4: getfield #3 // Field Client.id:J 7: new #4 // class Account 10: dup 11: invokespecial #5 // Method "&lt;init&gt;":()V 14: getfield #6 // Field id:J 17: ladd 18: lreturn }</code> </pre> <br><ul><li> <code>1: getfield</code>              <code>this</code> ,    <code>aload_0</code> . </li><li> <code>4: getfield</code> ‚Äî       ,    <code>1: getfield</code> , , ,  <code>this</code> . </li><li> <code>14: getfield</code>   .  Parce que    ,       ( <code>Account</code> ),     <code>this</code> ,    ,       <code>7: new</code> . </li></ul><br><p> ,        <code>Account.client.id</code> ,  <code>Account.id</code> ‚Äî .     ,    ,       . </p><br><p>      ‚Äî    ,    ,   <code>aload_0</code>  <code>getfield</code>         <code>this</code>  , ,        . , .   .     ‚Äî    !   -,    .     <code>MethodNode</code> ,    (  ).     , ..    (//)        . </p><br><p>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Interpreter&lt;V&gt; interpreter)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Frame&lt;V&gt;[] analyze(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String owner, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode m) {...} }</code> </pre> <br><p> <code>Analyzer</code>      (  <code>Frame</code> ,    )   .      ,    ,   ,  ,       //etc. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interpreter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2, V value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends V&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value, V expected)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(V v, V w)</span></span></span></span>; }</code> </pre> <br><p>  <code>V</code> ‚Äî   ,      ,    . <code>Analyzer</code>          ,    ,           ,      . , <code>getfield</code>      ‚Äî ,    ,     . ,   <code>unaryOperation(AbstractInsnNode insn, V value): V</code> ,                 .     <code>1: getfield</code>   <code>Value</code> ,     "  <code>client</code> ,  <code>Client</code>        ",   <code>14: getfield</code>  " ‚Äî  -  ,         ". </p><br><p>       <code>merge(V v, V w): V</code> .      ,        ,    .  Par exemple: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>    <code>Account.getBalance()</code>     .  - .       .   ?         <code>merge</code> . </p><br><p>        ‚Äî  <code>SuperInterpreter extends Interpreter&lt;SuperValue&gt;</code> ? .    <code>SuperValue</code> .     ‚Äî       ,        .                ,           . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } }</code> </pre> <br><p>     <code>composite</code> .   ,     . ,  <code>String</code>   .         <code>String.length()</code> ,   ,       <code>name</code> ,   <code>name.value.length</code> . , <code>length</code> ‚Äî    ,   ,    <code>arraylength</code> .     ? !          ‚Äî         . ,       ,     ,      . ,  <code>Date</code> , <code>String</code> , <code>Long</code> ,          . ,     ,      .     </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persion</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span>(converter = CustomJsonConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PassportInfo passportInfo; }</code> </pre> <br><p>     <code>PassportInfo</code>    .     ,  .  ,  <code>composite</code>    .       . </p><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Field&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> composite; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Ref ref = (Ref) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(path, ref.path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;[this]&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + path.stream().map(Field::getName).collect(joining(<span class="hljs-string"><span class="hljs-string">"."</span></span>)) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Ref </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ref(emptyList(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ref parent, Field field, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parent.isComposite()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field))<span class="hljs-comment"><span class="hljs-comment">//    ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.add(field); return of(new Ref(path, configuration.isCompositeField(field))); } public static Optional&lt;Ref&gt; childRef(Ref parent, Ref child) { if (!parent.isComposite()) return empty(); if (child.path.stream().anyMatch(parent.path::contains))// ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.addAll(child.path); return of(new Ref(path, child.composite)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refs; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.equals(o)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Value value = (Value) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(refs, value.refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.hashCode(), refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"("</span></span> + refs.stream().map(Object::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">","</span></span>)) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typedValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Ref ref)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, singleton(ref)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, Value child)</span></span></span><span class="hljs-function"> </span></span>{ Type type = child.getType(); Set&lt;Ref&gt; fields = parent.refs.stream() .flatMap(p -&gt; child.refs.stream().map(c -&gt; childRef(p, c))) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, FieldInsnNode childInsn, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ Type type = Type.getType(childInsn.desc); Field child = resolveField(childInsn); Set&lt;Ref&gt; fields = parent.refs.stream() .map(p -&gt; childRef(p, child, configuration)) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;Value&gt; values)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Type&gt; types = values.stream().map(BasicValue::getType).distinct().collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { String typesAsString = types.stream().map(Type::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + typesAsString); } Set&lt;Ref&gt; fields = values.stream().flatMap(v -&gt; v.refs.stream()).distinct().collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(types.get(<span class="hljs-number"><span class="hljs-number">0</span></span>), fields); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value &amp;&amp; value.getType().getSort() == Type.OBJECT &amp;&amp; ((Value) value).refs.stream().anyMatch(Ref::isComposite); } }</code> </pre> </div></div><br><p>   ,    .  C'est parti! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldsInterpreter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicInterpreter</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br><p>       ,    <code>BasicInterpreter</code> .    <code>BasicValue</code> (    ,   <code>Value</code>  <code>extends BasicValue</code> )      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue UNINITIALIZED_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue INT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.INT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue FLOAT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.FLOAT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue LONG_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.LONG_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue DOUBLE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.DOUBLE_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue REFERENCE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.getObjectType(<span class="hljs-string"><span class="hljs-string">"java/lang/Object"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue RETURNADDRESS_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.VOID_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } }</code> </pre> <br><p>         ( <code>(Value)basicValue</code> )  ,          ,     ( " <code>iconst</code>  ")  . </p><br><p>   <code>newValue</code> .       ,       ,  " ".   , <code>this</code>     <code>catch</code> .  ,     ,     .    <code>BasicInterpreter</code>  <code>BasicValue(actualType)</code>   <code>BasicValue.REFERENCE_VALUE</code> .       . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; type.getSort() == OBJECT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newValue(type); }</code> </pre> <br><p>  entry point.      <code>this</code> . ,  - ,  ,   <code>this</code> ,     <code>BasicValue(actualType)</code> ,  <code>Value.typedValue(actualType, Ref.thisRef())</code> . ,     ,   <code>this</code>    <code>newValue</code> ,     .       , ..         ,   <code>this</code> .     <code>this</code>    . ,  . ,     <code>this</code>       0.       ,      .   ,            ,  .             . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wasUpdated || insn.getType() != VAR_INSN || ((VarInsnNode) insn).<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ALOAD: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typedValue(value.getType(), thisRef()); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ISTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ASTORE: wasUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); }</code> </pre> <br><p>  .    .    ,   ,    ,   ‚Äî ,   .   ,    . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue v, BasicValue w)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.equals(w)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value || w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.equals(v.getType(), w.getType())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == UNINITIALIZED_VALUE || w == UNINITIALIZED_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNINITIALIZED_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + v + <span class="hljs-string"><span class="hljs-string">" and "</span></span> + w); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value != w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(asList((Value) v, (Value) w)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.merge(v, w); }</code> </pre> <br><p>    .      ""?         ?  Pas vraiment.          .        , ..       . ,      3 (       ): <code>putfield</code> , <code>putstatic</code> , <code>aastore</code> .    .     <code>putstatic</code> (   )    .     ,          .    <code>putfield</code>  <code>aastore</code> .   ,           ,      .   (  )              .            ,             . ,    ‚Äî      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>    ,        ( <code>ofNullable</code>    <code>Optional</code>  <code>client</code>      <code>value</code> ),         . .     . ,         - <code>ofNullable(client)</code> ,    - <code>map(Client::getId)</code> ,    . </p><br><p>        <code>putfield</code> , <code>putstatic</code>  <code>aastore</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == PUTFIELD &amp;&amp; Value.isComposite(value2)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value2 + <span class="hljs-string"><span class="hljs-string">" over putfield"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.binaryOperation(insn, value1, value2); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2, BasicValue value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == AASTORE &amp;&amp; Value.isComposite(value3)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value3 + <span class="hljs-string"><span class="hljs-string">" over aastore"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.ternaryOperation(insn, value1, value2, value3); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PUTSTATIC: { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value + <span class="hljs-string"><span class="hljs-string">" over putstatic"</span></span>); } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>   .       <code>checkcast</code> .          :      .  ‚Äî    </p><br><pre> <code class="java hljs">Client client1 = ...; Object objClient = client1; Client client2 = (Client) objClient;</code> </pre> <br><p>         ,        .         ,   ,       <code>client1</code>  <code>objClient</code> ,   . ,   <code>checkcast</code>          . </p><br><p>     . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;?&gt; list; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trimToSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ((ArrayList&lt;?&gt;) list).trimToSize(); } }</code> </pre> <br><p>      .       ,      ,  ,     .  ,   ,         ,        ,    ,     .          ?  , !       .   ,          ,  ,              null/0/false.    .   ‚Äî   </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>    ,       , ORM      ,    .       <code>checkcast</code> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHECKCAST: { Class&lt;?&gt; original = reflectClass(value.getType()); Type targetType = getObjectType(((TypeInsnNode) insn).desc); Class&lt;?&gt; afterCast = reflectClass(targetType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (afterCast.isAssignableFrom(original)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"type specification not supported"</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>     ‚Äî <code>getfield</code> .      ‚Äî   ? </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Foo child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Foo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Foo loopedRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ThreadLocalRandom.current().nextBoolean()) { loopedRef = loopedRef.child; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loopedRef; } }</code> </pre> <br><p> ,        .     ? <code>child</code> , <code>child.child</code> , <code>child.child.child</code> ?  ? ,       .  ,        .       , </p><br><blockquote>           null. </blockquote><p>        child,       null, , ,     .        <code>Ref.childRef</code>  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty();</code> </pre> <br><p>    .       ,    . </p><br><p>       "  ".          .   ,           . ,   ,       ( <code>@JdbcJoinedObject</code> ,  <code>@JdbcColumn</code> ),      ,    . ORM        . </p><br><p> ,   <code>getfield</code>           ,     .     ,   ,     ,      .  ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GETFIELD: { Optional&lt;Value&gt; optionalFieldValue = childValue((Value) value, (FieldInsnNode) insn, configuration); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFieldValue.isPresent()) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Value fieldValue = optionalFieldValue.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.isInterestingField(resolveField((FieldInsnNode) insn))) { context.addUsedField(fieldValue); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(fieldValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>    .  ,    , .   ,    <code>invoke*</code> .         , ,   ,        .  , : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getClient().getId(); }</code> </pre> <br><p>  ,      ,     .           ,   .    .      ,          .    ?          .    .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  <code>Account.client</code>          .   ,      .        .    ‚Äî        ,     . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Value&gt; usedFields; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Value returnedCompositeValue; }</code> </pre> <br><p>    ?  ,   .          .  , ..      (  ,   ‚Äî  ),   ,       <code>areturn</code> , ,   ,    <code>*return</code> .  <code>MethodNode</code> ( ,     Tree API)       .     .  ‚Äî          . ,             ?      .         . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnedCompositeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frame&lt;BasicValue&gt;[] frames, AbstractInsnNode[] insns)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;Value&gt; resultValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; insns.length; i++) { AbstractInsnNode insn = insns[i]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ARETURN: BasicValue value = frames[i].getStack(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { resultValues.add((Value) value); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(resultValues); }</code> </pre> <br><p>    <code>analyzeField</code>   </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Modifier.isNative(method.getModifiers())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not analyze native method "</span></span> + method); MethodInfo methodInfo = readMethod(method); MethodNode mn = methodInfo.getMethodNode(); String internalClassName = methodInfo.getInternalDeclaringClassName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess = methodInfo.getClassAccess(); Context context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(method, classAccess); FieldsInterpreter interpreter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldsInterpreter(context, configuration); Analyzer&lt;BasicValue&gt; analyzer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;&gt;(interpreter); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { analyzer.analyze(internalClassName, mn); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AnalyzerException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } Frame&lt;BasicValue&gt;[] frames = analyzer.getFrames(); AbstractInsnNode[] insns = mn.instructions.toArray(); Value returnedCompositeValue = getReturnedCompositeValue(frames, insns); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(context.getUsedFields(), returnedCompositeValue); }</code> </pre> <br><p>   , -,     . <code>invoke*</code> .      5 : </p><br><ol><li> <code>invokespecial</code> ‚Äî      .    ,  ,   (     <code>super.call()</code> ). </li><li> <code>invokevirtual</code> ‚Äî     .          . ,        . </li><li> <code>invokeinterface</code> ‚Äî   ,   <code>invokevirtual</code> ,    ‚Äî      . </li><li> <code>invokestatic</code> ‚Äî    </li><li> <code>invokedynamic</code> ‚Äî  ,   7    JSR 292.          JVM,   <code>invokedynamic</code>       (     dynamic).   ,          (+  ),        .  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Invokedynamic:   ?</a>  . </li></ol><br><p>  ,      ,       ,      .  <code>invokedynamic</code>   ,   .  ,      ,       ,     (,       ),   <code>invokedynamic</code>  .   ,   ""  .  ,         <code>invokedynamic</code> ,      . </p><br><p>  . ,         .  ,        . ,      <code>this</code> ,     0? ,    - ,         <code>FieldsInterpreter</code>   <code>copyOperation</code>     .  ,    <code>MethodAnalyzer.analyzeFields</code>    "     <code>this</code> "  "      " ( <code>this</code> ‚Äî  ).     ,   .   ,   ,  .          ,               - .    ,         (- <code>Optional.ofNullable(client)</code> ).             . </p><br><p> , <code>invokestatic</code>   (..   ,  <code>this</code>   ).  <code>invokespecial</code> , <code>invokevirtual</code>  <code>invokeinterface</code> .  ,         .  ,      ,     jvm.  <code>invokespecial</code>  ,               ,     .    <code>invokevirtual</code>  <code>invokeinterface</code> .   ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.toString(); }</code> </pre> <br><pre> <code class="plaintext hljs">public static java.lang.String objectToString(java.lang.Object); Code: 0: aload_0 1: invokevirtual #104 // Method java/lang/Object.toString:()Ljava/lang/String; 4: areturn</code> </pre> <br><p> , ,    ( )  . ,       ,    .            ?        <em>  ORM</em> .  ORM   ,            ,     .      <code>invokevirtual</code>  <code>invokeinterface</code>   . </p><br><p>  Hourra!   .  Et ensuite?      ,        (         ,     <code>this</code>  ),     ( ,    )       .  ! </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends BasicValue&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Value methodThis = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESPECIAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEVIRTUAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEINTERFACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))) { MethodInsnNode methodNode = (MethodInsnNode) insn; Class&lt;?&gt; objectClass = reflectClass(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getType()); Method interfaceMethod = resolveInterfaceMethod(reflectClass(methodNode.owner), methodNode.name, getMethodType(methodNode.desc)); method = lookupInterfaceMethod(objectClass, interfaceMethod); methodThis = (Value) values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } List&lt;?&gt; badValues = values.stream().skip(<span class="hljs-number"><span class="hljs-number">1</span></span>).filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESTATIC: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEDYNAMIC: { List&lt;?&gt; badValues = values.stream().filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { MethodAnalyzer.Result methodResult = analyzeFields(method, configuration); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Value usedField : methodResult.getUsedFields()) { childValue(methodThis, usedField).ifPresent(context::addUsedField); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodResult.getReturnedCompositeValue() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Optional&lt;Value&gt; returnedValue = childValue(methodThis, methodResult.getReturnedCompositeValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnedValue.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnedValue.get(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.naryOperation(insn, values); }</code> </pre> <br><p>         .    ,      .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  JVMS</a>      1  1.            .   ‚Äî    .  ,   ,        .   ,     ..     ,   -    ,       2  ‚Äî   .         ,   ,       .   ,   ‚Äî .    ,   <a href="" rel="nofollow">ResolutionUtil</a>  <a href="" rel="nofollow">LookupUtil</a> . </p><br><p>  TOUT! </p><br><a name="7"></a><br><h3 id="chast-sedmaya-chto-esche-mozhno-dodelat">  .     </h3><br><p>  ,   80%   20%     20%   80% . ,     ,    ,   ? </p><br><ul><li><p>        .          . </p><br></li><li><p>       .    (..        ),        . ,    .        ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>     <code>Optional</code> ,   <code>ofNullable</code>     <code>getClientId</code>  ,  ,      <code>value</code>    .  ,        <code>returnedCompositeValue</code> ‚Äî  ,   ,     . , ,        (  )               ,  .        -.          ,    ,    ,  "  <code>value</code>  <code>Optional@1234</code>  <code>Client@5678</code> "   . </p><br></li><li><p>  <code>invokedynamic</code> ,     .    indy      ,      .    ,          . ,     .  ,         invokedynamic.     .    . ,           <code>java.lang.invoke.LambdaMetafactory.metafactory</code> .    ,  ,   ,      .    <code>java.lang.invoke.StringConcatFactory.makeConcat/makeConcatWithConstants</code> .     .          <code>toString()</code> . , ,  ,  ,  .    ,     ,   ,  /-     .            jvm,      .    ,  ,  .             .    .   ,  ,               .          indy .    ?     indy    ,     ‚Äî <code>CallSite</code> .           . , ,    <code>LambdaMetafactory.metafactory</code>       <code>getValue</code> ,         .       <code>getValue</code> .     (  )  .  , , ,   stateless. ,    !    -    ,      .  <code>CallSite</code>   <code>ConstantCallSite</code> , <code>MutableCallSite</code>  <code>VolatileCallSite</code> .    mutable  volatile   ,       ,   <code>ConstantCallSite</code>  .         "-   ". ,  ,    .    ,         VM,       . </p><br></li></ul><br><a name="8"></a><br><h3 id="posleslovie">  Postface </h3><br><p> - ,   .   -  <code>partialGet</code>     . ,    .   ,   ,       ,         ,   " "   . </p><br><p>  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr409043/">https://habr.com/ru/post/fr409043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr409033/index.html">Un superamas cach√© peut r√©soudre le myst√®re de la voie lact√©e</a></li>
<li><a href="../fr409035/index.html">Enfin, nous traitons des dipl√¥mes: la cause de l'accident de la fr√©gate</a></li>
<li><a href="../fr409037/index.html">Scanner 3D nouvelle g√©n√©ration EinScan-SE</a></li>
<li><a href="../fr409039/index.html">PocketBook-2017: rappelez-vous de l'ann√©e √©coul√©e et r√©sumez-la</a></li>
<li><a href="../fr409041/index.html">L'ex√©cution ne peut √™tre pardonn√©e: nous traitons la ponctuation en anglais</a></li>
<li><a href="../fr409045/index.html">La connexion secr√®te des math√©matiques pures et de la physique est r√©v√©l√©e</a></li>
<li><a href="../fr409047/index.html">Relance du premier √©tage utilis√© et de la capsule cargo vers l'ISS. √áa ne d√©range pas la NASA</a></li>
<li><a href="../fr409049/index.html">La FDA approuve la premi√®re th√©rapie g√©nique directe contre les maladies g√©n√©tiques</a></li>
<li><a href="../fr409051/index.html">Dmitry Muromtsev (ITMO) - sur la mod√©lisation ontologique et la formation de l'intelligence conversationnelle</a></li>
<li><a href="../fr409053/index.html">A lanc√© un h√©licopt√®re - a obtenu une amende</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>