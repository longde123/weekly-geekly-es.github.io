<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏻 🍈 🗒️ Stasiun cuaca di Arduino dari A hingga Z. Bagian 5 ☝🏾 👩‍🚀 🙌🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagian akhir. Bagian sebelumnya . 


 Daftar isi: 


- Bagian 1. Persyaratan. Pilihan besi. Skema umum 
- Bagian 2. Perangkat Lunak. Unit pusat, besi ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stasiun cuaca di Arduino dari A hingga Z. Bagian 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p>  Bagian akhir.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian sebelumnya</a> . </p><br><p>  Daftar isi: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1. Persyaratan.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pilihan besi.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Skema umum</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 2. Perangkat Lunak.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Unit pusat, besi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 3. Unit pusat, perangkat lunak</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 4. Sensor Jendela</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Sensor tempel.  Perangkat lunak </h1><br><p>  Bicara tentang perangkat lunak untuk sensor luar negeri.  Setelah itu, Anda akan mendapatkan sistem lengkap yang sudah dapat Anda coba. </p><br><p>  Biarkan saya mengingatkan Anda bahwa <em>server</em> adalah unit rumah pusat yang dapat berkomunikasi dengan Internet melalui WiFi, dan <em>klien</em> adalah sensor jarak jauh yang out-of-the-box yang mentransmisikan data ke server melalui udara. </p><br><p> Kode sumber untuk server dan klien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ada di sini</a> . <br>  Teks sumber dilengkapi dengan komentar terperinci. </p><br><p>  Hampir tidak ada yang perlu dikonfigurasi pada klien. </p><a name="habracut"></a><br><p>  Pemancar radio nRF24L01 +, lebih tepatnya perpustakaan RadioHead, membutuhkan alamat server dan klien untuk ditentukan.  Alamat disediakan jika Anda memiliki lebih dari satu server dan klien.  Sebuah alamat hanyalah sembarang bilangan bulat.  Ketika klien mengirim paket data ke server, itu menunjukkan server mana paket ini untuk.  Server, mengetahui alamatnya sendiri, pada gilirannya, menentukan apakah paket ini ditujukan untuknya. </p><br><p> Karenanya, <code>SERVER_ADDRESS</code> di server dan di klien harus sama, tetapi <code>CLIENT_ADDRESS</code> untuk klien yang berbeda harus berbeda.  Dengan kata lain, jika Anda menghubungkan sensor baru lain ke sistem kami di masa depan, maka <code>CLIENT_ADDRESS</code> perlu diubah untuk itu. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  <code>RF_CHANNEL</code> saluran radio <code>RF_CHANNEL</code> harus sama untuk semua orang.  Secara default adalah 2. Saya mengubah nomor default, Anda dapat memilih yang lain. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  Pengaturan voltmeter untuk mengukur tegangan pasokan baterai harus diubah: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  Untuk menghemat energi, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pustaka daya rendah Ringan untuk Arduino digunakan</a> . </p><br><p>  Berikut ini adalah pengukuran konsumsi aktual saya untuk Arduino Pro Mini dengan Lib ini: </p><br><ul><li>  biasanya 25mA </li><li>  ketika bekerja dengan DHT sama </li><li>  dengan transmisi radio 38 mA </li><li>  di LowPower.idle 15 mA </li><li>  di LowPower.powerdown 7,5 mA </li></ul><br><p>  Klien melakukan pengukuran suhu, kelembaban dan tegangan suplai, mengemas semua ini ke dalam struktur data, mengirimkan data ke server dan “tertidur”.  Jika kesalahan terjadi selama transfer, transfer segera diulang. </p><br><p>  Server (pusat, unit rumah), pada gilirannya, menerima data, mengonfirmasi penerimaan dan memprosesnya. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Database, MySQL, PHP, WWW-server </h1><br><p>  Setelah pekerjaan selesai, kami memiliki desain stasiun cuaca yang berfungsi penuh.  Tapi sekarang ada selusin sepeser pun stasiun cuaca seperti itu, kerajinan lokal tidak lagi modis.  Lagipula, kita punya internet. </p><br><p>  Oleh karena itu, kami akan berbicara tentang bagaimana akses ke Internet ini dilakukan, kami akan melampirkan database dan tampilan web ke stasiun cuaca kami. </p><br><p>  Pernyataan masalah untuk "webcam": </p><br><ul><li>  menerima dan menyimpan data stasiun cuaca: suhu, kelembaban, tekanan atmosfer, tegangan suplai </li><li>  tampilkan data ini </li><li>  membangun grafik. </li></ul><br><p>  Dalam hal ini, kita perlu hosting dengan dukungan untuk Apache, PHP dan MySQL dengan modul mysqli.  Dan kondisi ini dipenuhi oleh hampir semua hosting di planet Bumi.  Atau alih-alih hosting akan ada komputer Anda memainkan peran server yang terhubung ke router jaringan rumah dan memiliki akses Internet. </p><br><h2 id="sozdanie-bazy-dannyh">  Pembuatan basis data </h2><br><p>  Mari kita mulai dari awal, yaitu dengan desain dan pembuatan database. </p><br><p>  Basis data adalah dunia Anda dan Anda dapat mempelajarinya untuk waktu yang lama, jadi kami akan menyentuh secara singkat hanya hal-hal yang secara langsung kami butuhkan. </p><br><p>  Semua skrip SQL berada di direktori <code>weather-station/server/php-sql/</code> </p><br><p>  Di mana desain database dimulai?  Dengan representasi logis dan fisik. </p><br><p>  Tampilan logis atau skema basis data: </p><br><ul><li>  Tabel suhu dan kelembaban DHT </li><li>  tabel data tekanan dan suhu sensor BMP </li><li>  tabel yang ditunjukkan tidak memiliki hubungan satu sama lain, lebih tepatnya, tidak ada tautan yang diperlukan. </li></ul><br><p>  Skema fisik bergantung pada DBMS dan tipe data tertentu.  Lebih mudah dibongkar dengan contoh tertentu.  <code>make_tables.sql</code> SQL <code>make_tables.sql</code> skema logis dan fisik. </p><br><p>  Setiap tabel harus memiliki bidang tipe </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  Nama bidang mungkin berbeda di basis data yang berbeda, tetapi hanya ada satu pengertian - ini adalah pengidentifikasi unik, kunci rekaman.  Untuk masa depan, jika Anda melihat database dalam tabel yang tidak memiliki counter seperti itu, Anda harus tahu bahwa database ini dirancang oleh seseorang yang sangat jauh dari pemrograman, kemungkinan besar humaniora. </p><br><p>  Kami menyimpan data dari sensor dari tipe yang sama dalam satu tabel, untuk sensor dari tipe lain, kami membuat tabel lain.  Ini sedikit menyulitkan database dan PHP mengikatnya, tetapi menyederhanakan ekstensi atau modifikasi seluruh sistem di masa depan. </p><br><p>  Ada dua tabel di proyek kami.  Tabel <code>arduino_dht</code> menyimpan data dari sensor tipe DHT (suhu, kelembaban), tabel <code>arduino_bmp</code> menyimpan data dari sensor tipe BMP (suhu, tekanan).  Jika di masa depan Anda ingin memiliki, misalnya, sensor gas atau detektor gerakan, kemudian buat tabel tambahan, jangan malas.  Jika Anda menghubungkan sensor lain dari tipe DHT11 atau DHT22, maka Anda tidak perlu membuat tabel tambahan, gunakan tabel <code>arduino_dht</code> .  Saya harap prinsipnya jelas: entitas fisik yang terpisah adalah tabel yang terpisah. </p><br><p>  Jika data dari beberapa sensor dari jenis yang sama akan disimpan dalam sebuah tabel, lalu bagaimana mereka dapat dibedakan?  Untuk melakukan ini, masukkan bidang di setiap tabel </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  Sebenarnya, ini adalah <code>CLIENT_ADDRESS</code> yang kami daftarkan di file <code>client/client.ino</code> untuk setiap instance klien-klien jarak jauh dan di <code>server/server.ino</code> untuk sensor yang terhubung langsung ke server - unit pusat. </p><br><p>  Dalam sistem industri, harus ada tabel lain - korespondensi <code>idSensor</code> dan <code>idSensor</code> verbal yang dapat dibaca manusia.  Sebagai contoh, sensor dengan <code>idSensor</code> = 2 adalah <em>"Suhu, kelembaban di apartemen"</em> , dll.  Tetapi dalam proyek kami, kami tidak akan menyulitkan, hanya ingat bahwa: </p><br><ul><li>  sensor dengan <code>idSensor</code> , itu adalah <code>CLIENT_ADDRESS</code> , sama dengan 11 - ini adalah sensor rumah di server - unit pusat, </li><li>  sensor dengan <code>idSensor</code> , juga <code>CLIENT_ADDRESS</code> , sama dengan 20 - ini adalah yang pertama (di proyek kami dan satu-satunya) klien sensor luar negeri. </li></ul><br><p>  Selanjutnya  Tabel menyimpan data berikut: </p><br><ul><li>  ipRemote - alamat IP stasiun cuaca (server) dari mana data berasal, berguna untuk debugging dan pemantauan, </li><li>  dateCreate - tanggal saat catatan dibuat, </li><li>  milis - berguna untuk debugging, ini adalah waktu dalam milidetik sejak awal sketsa di Arduino, </li><li>  suhu - suhu </li><li>  kelembaban - kelembaban </li><li>  tegangan - tegangan suplai, </li><li>  tekanan - tekanan </li><li>  kesalahan - jumlah kesalahan (tidak digunakan).  Itu dimaksudkan untuk menyimpan jumlah kesalahan transmisi, dll., Sehingga Anda bisa mengevaluasi keadaan keseluruhan sistem dari jarak jauh. </li></ul><br><p>  Seperti yang Anda lihat, <code>arduino_bmp</code> dan <code>arduino_bmp</code> sangat mirip, perbedaannya hanya di bidang tekanan dan kelembaban, dan ada keinginan untuk membuang semuanya menjadi satu tumpukan (tabel).  Tetapi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bentuk normal pertama</a> tidak memerintahkan untuk melakukan ini, banyak programmer pemula mencoba untuk mengatasinya, tetapi tidak satupun dari mereka yang berhasil, dan kami tidak akan melakukannya.  Ini adalah bagaimana tidak memperhatikan hukum gravitasi universal, untuk saat ini mungkin akan berubah. </p><br><p>  Tabel <code>arduino_error_log</code> berguna untuk debugging - ini adalah log kesalahan dan pesan sistem lainnya. </p><br><p>  Membuat database dan penggunanya dengan hak dijelaskan di <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  Ini dilakukan sekali, nama database dan nama pengguna dapat muncul dengan Anda sendiri.  Dan apa yang sebenarnya perlu dilakukan adalah mengatur kata sandi Anda. </p><br><h2 id="php-i-veb-server">  PHP dan server web </h2><br><p>  Semua pengaturan antarmuka web disimpan dalam <code>config.php</code> .  Ubah sesuai dengan pengaturan basis data Anda. </p><br><p>  Tetapkan zona waktu Anda dalam format PHP </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Semua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">zona waktu yang</a> tersedia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dijelaskan di sini</a> . </p><br><p>  Tetapkan kunci rahasia Anda untuk akses (sebagai angka) yang harus cocok dengan <code>SOURCE_KEY</code> konstan dari sketsa <code>server.ino</code> </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  Di server web kami tidak ada otorisasi, entri kata sandi, ini akan menyulitkan seluruh desain.  Untuk prototipe, ini tidak perlu.  Oleh karena itu, semua perlindungan dibangun di atas file <code>robots.txt</code> , tidak adanya <code>index.php</code> dan kunci rahasia ini untuk diakses. </p><br><p>  Script PHP utama <code>weather.php</code> menerima permintaan HTTP GET sederhana dengan data dan menyimpannya dalam tabel database yang sesuai.  Jika kunci <code>$access_key</code> tidak cocok, maka permintaan akan ditolak. </p><br><p>  <code>weather-view.php</code> digunakan untuk melihat tabel data dan berisi hyperlink ke skrip antarmuka web lainnya.  Panggil dia seperti itu </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  Sebagai contoh </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> menampilkan label sederhana di mana Anda perlu mengingat bahwa: </p><br><ul><li>  sensor dengan id 11 adalah sensor rumah di server, </li><li>  Sensor dengan id 20 adalah sensor jendela. </li></ul><br><p>  Skrip <code>function.php</code> berisi fungsi-fungsi yang umum untuk semua skrip PHP. </p><br><p>  <code>chart-dht.php</code> bertanggung jawab untuk membuat chart menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Google Charts</a> .  Di sini, misalnya, adalah grafik dari tegangan suplai sensor luar negeri.  Tegangan naik pada hari yang cerah karena baterai surya, dan kemudian catu daya pada baterai secara bertahap habis. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Grafik"></p><br><p>  <code>export-dht.php</code> mengekspor data dari tabel database MySQL ke file CSV.  Untuk impor dan analisis lebih lanjut dalam spreadsheet. </p><br><p>  <code>export-voltage.php</code> mengekspor data pada tegangan suplai dari sensor jendela dari database MySQL ke file CSV.  Berguna untuk debugging. </p><br><p>  <code>truncate.php</code> menghapus semua tabel, mis.  menghapus semua data kami.  Berguna untuk debugging.  Tidak ada tautan ke skrip ini dari <code>weather-view.php</code> , jadi Anda perlu menyebutnya melalui tautan langsung di bilah alamat browser Anda dengan <code>$access_key</code> . </p><br><p>  Saat menerima data, fungsi <code>mysqli_real_escape_string()</code> umumnya digunakan untuk mencegah nilai yang salah dari memasuki database. </p><br><p>  Jangan lupa untuk meletakkan <code>robots.txt</code> di root situs Anda untuk mencegahnya masuk ke mesin pencari. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi dan transfer data </h1><br><p>  Dan sekarang kembali ke sketsa <code>server.ino</code> , ke bagian yang menghubungkan titik akses WiFi dan mengirimkan data ke server web. </p><br><p>  Seperti yang sudah saya tulis, saya tidak dapat menemukan perpustakaan normal untuk Arduino untuk mengontrol modul ESP8266 menggunakan perintah AT, saya harus "pertanian kolektif" sendiri.  Biarkan saya juga mengingatkan Anda bahwa Anda harus menginstal versi firmware tertentu di ESP8266-01.  Dan sekarang ketika semuanya sudah siap, mari kita lihat cara kerjanya. </p><br><p>  Untuk mengakses server web dalam sketsa <code>server.ino</code> , <code>server.ino</code> perlu mengubah konstanta ini </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p>  Di <code>server.ino</code> dalam fungsi <code>void setup()</code> , ESP8266 pertama kali beralih ke mode Station, mis.  itu mulai bekerja sebagai klien WiFi </p><br><pre> <code class="hljs lisp">espSendCmd(«AT+CWMODE_CUR=1», «OK», <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  dan kemudian terhubung ke titik akses </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Jika koneksi tidak terjadi, maka upaya diulangi (satu kali) </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Kemudian pilih mode koneksi tunggal TCP / IP </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Saat mengirim data dari sensor tipe DHT ke server web, fungsi digunakan yang menunjukkan <code>type=dht</code> data sebagai <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Saat mengirim data dari sensor BMP ke server web, fungsi yang sama digunakan dengan tipe data yang ditunjukkan sebagai <code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Fungsi <code>espSendData()</code> menerima string permintaan HTTP GET dan mengirimkannya ke server web sebagaimana dimaksud. </p><br><p>  Di dalam dirinya sendiri, <code>espSendData()</code> memeriksa ketersediaan modul ESP dengan mengirimkannya perintah "AT", lalu memeriksa koneksi WiFi dan menghubungkan kembali jika perlu.  Kemudian data dikirim dan koneksi TCP ditutup. </p><br><h1 id="android-prilozhenie">  Aplikasi Android </h1><br><p>  Saat ini, ketika semua orang bisa berkedip LED, Anda tidak akan mengejutkan siapa pun dengan stasiun cuaca.  Tetapi jika pesawat tahu bagaimana berkomunikasi dengan server melalui WiFi, memiliki wajah web dan aplikasi mobile, maka ini adalah sesuatu!  Dengan server di sini yang kami maksud tentu saja server aplikasi, mis.  dalam kasus kami, ini adalah pengikatan PHP dan DBMS MySQL.  Tidak ada ceri pada kue, yaitu aplikasi Android, yang akan kita tulis sekarang. </p><br><h2 id="arhitektura">  Arsitektur </h2><br><p>  Arsitektur seluruh platform perangkat lunak stasiun cuaca sederhana: </p><br><ul><li>  bagian server (unit pusat) stasiun cuaca mengumpulkan data dari klien sensor jarak jauh </li><li>  kemudian mentransfer data ke server web aplikasi, yang menyimpan data ini ke database </li><li>  Aplikasi Android (atau aplikasi jarak jauh lainnya: iOS, browser) meminta data dari server web dan menampilkannya di layar. </li></ul><br><p>  Pada layar perangkat Android, kami akan menampilkan pembacaan sensor terbaru saat ini. </p><br><h2 id="http-get-i-json">  HTTP DAPATKAN dan JSON </h2><br><p>  Pertanyaan yang perlu diselesaikan di tempat pertama adalah bagaimana data akan ditransfer dari server web ke aplikasi Android. </p><br><p>  Tidak perlu menemukan apa pun di sini, semuanya telah diciptakan untuk kita - ini adalah HTTP GET dan JSON. </p><br><p>  Dalam kasus kami, permintaan GET sederhana ke server web dapat dikompilasi dan didebug secara manual sementara aplikasi Android belum siap. </p><br><p>  Di Jawa dan Android, ada pustaka siap pakai untuk memproses data dalam format JSON.  JSON adalah format teks yang dapat dibaca manusia, yang berguna untuk debugging. </p><br><p>  Untuk menghasilkan data saat ini dari sensor stasiun cuaca, buat skrip PHP baru <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">data terakhir ke json.php</a> di server web. </p><br><p>  Panggilan skrip: </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  di mana <code>&lt;access_key&gt;</code> , seingat kami, adalah kunci akses basis data rahasia. </p><br><p>  Contoh respons dalam format JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  Harus diingat bahwa kita memiliki 3 sensor.  ID dan tipe mereka (DHT atau BMP) di-hardcode di seluruh kode stasiun cuaca.  Metode pengkodean hardcore ini secara ideologis salah, tetapi untuk prototipe berlutut (di mana solusi cepat dan mudah diperlukan) ini adalah kompromi yang masuk akal. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  <code>last-data-to-json.php</code> mengambil data terbaru dari sensor heterogen ini dari basis data dan mengemasnya dalam format JSON.  Pemilihan data dari database "dari akhir" berlangsung dengan cara ini: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Sekarang kami akan menulis aplikasi Android sederhana yang meminta, menerima, menerjemahkan data JSON dan menampilkan informasi di layar. </p><br><p>  Aplikasi Android kami akan sesederhana mungkin, hanya inti dari teknologinya.  Lebih jauh di sekitar "kerangka" ini sudah mungkin untuk menghasilkan berbagai "keindahan". </p><br><p>  Berikut adalah tangkapan layar dari apa yang harus dihasilkan </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  Seperti yang Anda lihat, UI hanya sederhana, berdasarkan LinearLayout, tidak lebih. </p><br><p>  Di bagian atas TextView menunjukkan ID sensor dan data cuaca mereka.  Tombol Refresh memulai permintaan kedua ke server web.  Berikutnya di EditText adalah satu-satunya pengaturan program - ini adalah URL permintaan dalam formulir </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  Apa yang harus diperhatikan? </p><br><p>  Dalam manifes, tambahkan baris yang memungkinkan Internet dan memeriksa status koneksi jaringan: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Bekerja dengan jaringan dan menerima data dari situs web adalah sebagai berikut. </p><br><p>  Kami menggunakan AsyncTask untuk membuat tugas latar belakang terpisah dari utas UI utama.  Tugas latar belakang ini mengambil URL permintaan dan menggunakannya untuk membuat <code>HttpURLConnection</code> . </p><br><p>  Setelah koneksi dibuat, AsyncTask memuat konten halaman web (JSON) sebagai InputStream.  Selanjutnya, InputStream dikonversi menjadi string, yang didekodekan menggunakan JSONObject dan ditampilkan di antarmuka pengguna menggunakan metode <code>onPostExecute()</code> . </p><br><p>  Di MainActivity.java, ubah URL ke: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  itu akan digunakan secara default saat pertama kali Anda menjalankan aplikasi Android. </p><br><h2 id="epilog">  Epilog </h2><br><p>  Ya, sesuatu sudah bekerja.  Kemudian Anda dapat mengoptimalkan sesuatu, mengganti sesuatu, Anda dapat membuang semuanya, tetapi juga meminjam sesuatu. </p><br><p>  Titik sakit besar yang terpisah adalah <strong>konsumsi energi</strong> .  Saya merekomendasikan membaca komentar pada posting di mana ada banyak tips praktis. </p><br><p>  <em>Hingga tak terbatas ... dan seterusnya.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id426019/">https://habr.com/ru/post/id426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id426001/index.html">Kursus MIT "Keamanan Sistem Komputer". Kuliah 11: Bahasa Pemrograman Web / Web, Bagian 3</a></li>
<li><a href="../id426009/index.html">Epic fail resistance 1 atau Fox sedang menyelinap tanpa diketahui. Menguji anonimitas dan keamanan + VPN untuk pengguna</a></li>
<li><a href="../id426013/index.html">Steroid Karier</a></li>
<li><a href="../id426015/index.html">Penggunaan drone sipil gergaji untuk fotografi udara geodesi profesional di daerah tersebut</a></li>
<li><a href="../id426017/index.html">Cara mengurangi jumlah percobaan pada hewan</a></li>
<li><a href="../id426021/index.html">libgdx dan perasaan</a></li>
<li><a href="../id426023/index.html">Buka pelajaran "Laboratorium Virtual di Vagrant"</a></li>
<li><a href="../id426025/index.html">Menggunakan metode ofensif untuk memperkaya Threat Intelligence</a></li>
<li><a href="../id426027/index.html">Layanan Cloud Amazon dan Analisis Portofolio Investasi</a></li>
<li><a href="../id426029/index.html">Apakah Anda menyerah dan ingin berhenti dari tugas itu? Seperti inilah pelatihan pengembang yang efektif</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>