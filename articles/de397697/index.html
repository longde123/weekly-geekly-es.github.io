<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüéì üñêüèø üíß Wie ich die USV-Anzeige prothetiert habe üí≠ üßòüèª üà≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In den sp√§ten 90ern bekam ich UPS. Wundersch√∂n, mit einer LED-Anzeige und einer Reihe von Tasten, hatte es zwei Batterien im Inneren und konnte die Le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich die USV-Anzeige prothetiert habe</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/397697/"><img src="https://habrastorage.org/files/4f0/b42/8eb/4f0b428ebdd6405db46834adaf3a9543.jpg" alt="w√§hrend des Debuggens"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den sp√§ten 90ern bekam ich UPS. Wundersch√∂n, mit einer LED-Anzeige und einer Reihe von Tasten, hatte es zwei Batterien im Inneren und konnte die Lebensdauer meines Computers zu diesem Zeitpunkt (zusammen mit dem Monitor!) Bis zu 15 Minuten lang unterst√ºtzen. Die Zeiten in Kamtschatka waren damals schwierig, die Lichter wurden regelm√§√üig ausgeschaltet, so dass dieses Ger√§t sehr praktisch war. Ich habe mit ihm die ganze Energiekrise durchgemacht, und mehr als einmal hat er meine Hausarbeiten vor dem pl√∂tzlichen Stromausfall bewahrt. Au√üerdem k√∂nnen Sie ein Tonbandger√§t daran anschlie√üen und im Kerzenlicht Radio oder Ihre Lieblingsb√§nder h√∂ren, um sich ein Abendessen auf einem tragbaren Gasherd vorzubereiten ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nat√ºrlich brach die USV. Das erste Mal brannte sein Transformator aus. Nicht derjenige, der gro√ü ist und sich im Wechselrichter befindet, sondern ein kleiner, wahrscheinlich zum Messen der Spannung im Netzwerk. Da ich nicht die gleiche Fabrik gefunden habe, habe ich eine selbstgemachte eingerichtet, und das Ger√§t hat noch einige Zeit funktioniert. Dann h√∂rte auf. Lange, sehr lange konnte ich den Grund nicht finden. Ich musste verschiedene Teile l√∂ten, auf Leistung pr√ºfen und zur√ºckl√∂ten. Das Problem wurde nicht gefunden. Das entkernte Ger√§t fiel ein paar Jahre lang unter das Bett, bis mir eines sch√∂nen Tages die Idee kam, 5 Volt direkt an die Steuerung anzulegen. Und siehe da: Es gab einen Piepton des eingebauten Lautsprechers und Zahlen erschienen auf der LED-Anzeige. Er war am Leben! Au√üerdem ist es eine Frage der Technologie: Ich ging mit einem Voltmeter √ºber den Stromversorgungskreis und stellte fest, dass eine Sicherung auf der Platine gel√∂tet war, die unversch√§mt wie ein Widerstand aussah!Die Sicherung (nat√ºrlich durchgebrannt) wurde ersetzt und die USV zum Leben erweckt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider sind meine Reparatur und zwei Jahre unter dem Bett nicht umsonst f√ºr das Ger√§t weggegangen. Auf unverst√§ndliche Weise brannte der Port in der Steuerung aus, was f√ºr das Leuchten der gr√ºnen ‚ÄûOnline‚Äú -LED und des niedrigsten Segments aller digitalen Segmentanzeigen verantwortlich war. Es gibt nichts zu tun - ich musste mich abfinden. Nach einiger Zeit verlie√ü ich Kamtschatka und unsere Wege gingen auseinander. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jahre vergingen und als ich zu meinen Eltern kam, fand ich in der hinteren Ecke meine ununterbrochene Lieblingsbatterie: verlassen, schmutzig, ohne Batterien und Gummibeine. Zu diesem Zeitpunkt hatte ich bereits meine eigene Wohnung in einer anderen Stadt erworben, daher wurde beschlossen, die Zuflucht f√ºr mich zu nehmen, ihre Effizienz wiederherzustellen und sie f√ºr den beabsichtigten Zweck zu nutzen. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Herausforderung</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst wurde die USV gewaschen und getrocknet. Dann wurden in einem bestimmten Radioteilelager geeignete Gummif√º√üe und neue Batterien gekauft. Zu meiner gro√üen √úberraschung wurde im selben Gesch√§ft ein geeigneter Transformator gefunden, als Gegenleistung f√ºr mein hausgemachtes Produkt. Ein paar Arbeitstage, und die gewaschene, aktualisierte, ununterbrochene Batterie quietschte gl√ºcklich und begann, ihre neuen Batterien aufzuladen. Alles war in Ordnung, aber die Anzeige funktionierte immer noch nicht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Idee, das Problem zu beheben, kam mir schon fr√ºher. Nachdem ich alle Zahlen (und einige Buchstaben) des Sieben-Segment-Indikators auf das Notizbuchblatt gezeichnet hatte, wurde mir klar, dass es m√∂glich ist, den Zustand des niedrigsten Segments durch den Zustand des Restes zu bestimmen. Die gr√ºne LED kann leuchten, wenn andere LEDs nicht leuchten. Es gab viele Gedanken dar√ºber, wie dies getan werden k√∂nnte: von einem einfachen ROM-Chip zu einem einfachen FPGA. Aber da ich Student war und in Kamtschatka lebte, hatte ich keine Gelegenheit, etwas Komplizierteres als kleinliche Logik zu erwerben. Das Fixieren des Indikators wurde verschoben.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0d1/175/f43/0d1175f43d72446383ebd4f0dcb687db.jpg" alt="Segmente zeichnen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Mal habe ich beschlossen, das Problem ernsthaft anzugehen. Nachdem ich in Beh√§ltern gest√∂bert hatte, fand ich bei mir weder ROM noch FPGA und keine CPLD. Aber Arduino Pro Mini, oder besser gesagt, sein billiger chinesischer Klon mit Ali Express, fiel in die H√§nde von. Ich habe Arduin gekauft, um einen Mini-Computer auf Basis einer WiFi-SD-Karte von Transcend herzustellen. Leider starb die Karte w√§hrend der Experimente und die Platine mit dem Mikrocontroller blieb im Leerlauf. Nichts, wir fanden sie eine neue Herausforderung! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeit</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Anzeigemodul ist eine dynamische Anzeige implementiert: Segmentsignale sind allen vier Anzeigen gemeinsam, so dass jeweils nur eine von ihnen leuchtet. Au√üerdem: Wie bei der f√ºnften Anzeige sind auch drei LEDs angeschlossen. Mit f√ºnf Auswahlsignalen k√∂nnen Sie festlegen, welche Anzeige (oder LED-Linie) gerade verwendet wird. Diese Auswahlsignale werden nacheinander mit einer ziemlich hohen Geschwindigkeit abgetastet, und aufgrund der Tr√§gheit des Sehens scheinen alle Anzeigen gleichzeitig zu leuchten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst wollte ich die einfachste L√∂sung umgehen: einen gew√∂hnlichen Zyklus, der Signale von sechs Arbeitssegmenten pr√ºft und den nicht funktionierenden siebten ein- oder ausschaltet. Tats√§chlich ist dies nur eine Emulation des ROM, √ºber die ich ganz am Anfang nachgedacht habe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu musste ich sechs Arbeitssegmente an den Eingang des Mikrocontrollers und ein nicht funktionierendes Segment an den Ausgang anschlie√üen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein kleines Array entworfen hatte, das die verschiedenen Zust√§nde der Eing√§nge mit dem Ausgang und der Schleife verglich, die dieses Array umgeht, lud ich alles in den Controller und bekam sofort ein Problem: Das untere Segment leuchtete immer. Erster Gedanke: die Neigung im Programm. Unabh√§ngig davon, wie oft ich mir den Code angesehen habe, wurden keine Fehler gefunden. Am Ende stellte sich heraus, dass mein Zyklus in keiner Weise mit dem Umschalten der Indikatoren synchronisiert war. Wenn wir den Status der Segmente am Ende des Zyklus der Auswahl eines Indikators lesen, ist es wahrscheinlich, dass wir das n√§chste Segment beim n√§chsten aufleuchten oder absenken. Das Durcheinander.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ohne nachzudenken, l√∂te ich f√ºnf Indikatorauswahlsignale an die verbleibenden freien Arduino-Eing√§nge, stellte sie so ein, dass sie einen Interrupt erzeugten, und begann, einen Interrupt-Handler anstelle einer Schleife zu verwenden. Es wurde besser, l√∂ste aber das Problem nicht. An den richtigen Stellen brannte das Segment so, wie es sollte, aber an den Stellen, an denen es gel√∂scht werden sollte, gab es kein helles Restlicht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich einige Zeit dar√ºber nachgedacht hatte, entschied ich, dass dieser Effekt auftreten kann, wenn der Suchzyklus im Array des gew√ºnschten Zustands f√ºr die Segmente l√§nger dauert als die Brenndauer des Indikators. In diesem Fall verlassen wir auch unsere Phase und verwalten das Segment des n√§chsten Indikators. Es ist notwendig, dass zwischen dem Zeitpunkt des Empfangs des Interrupts vom Auswahlsignal zum Segmentsteuerbefehl so wenig Zeit wie m√∂glich vergeht. Dies kann nur auf eine Weise erfolgen: Um den Code, der die Entscheidung √ºber den Status des Segments trifft, aus dem Interrupt-Handler zu entfernen, f√ºhren Sie ihn in der Hauptschleife mit minimaler Priorit√§t aus und speichern Sie das Ergebnis in einer Art globalem Puffer. Der Interrupt-Handler muss nur den Wert dieses globalen Puffers lesen und das Segment je nach Inhalt l√∂schen oder beleuchten. Im schlimmsten FallWir k√∂nnen nur mit der √Ñnderung des Zustands des Segments in einem bestimmten Indikator zu sp√§t kommen, aber wir werden nicht in den n√§chsten aufsteigen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das war die richtige Entscheidung. </font><font style="vertical-align: inherit;">Aber schlie√ülich funktionierte es erst, nachdem ich den Entscheidungszyklus mit Hilfe von Spin-Lock mit einem Interrupt synchronisiert und die Verarbeitung des Interrupts w√§hrend dieses Zyklus verboten hatte. </font><font style="vertical-align: inherit;">Und es hat nicht nur verdient, sondern auch verdient, wie es sollte!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab ein weiteres Problem mit den Indikatoren: Meistens zeigten sie nur Zahlen. </font><font style="vertical-align: inherit;">Nach dem Einschalten der USV wurde jedoch der Testprozess gestartet, bei dem zus√§tzlich zu den Zahlen zwei weitere W√∂rter angezeigt wurden: TEST und PASS. </font><font style="vertical-align: inherit;">Und wenn die Buchstaben T, E und P einfach zu dem Array g√ºltiger Zeichen hinzugef√ºgt werden k√∂nnten und S gleich 5s w√§re, dann w√§re der Buchstabe A aus Sicht meines Programms aus Sicht der acht nichts. </font><font style="vertical-align: inherit;">Der Entscheidungszyklus fand einfach das entsprechende Muster im Array und zeichnete das untere Segment. </font><font style="vertical-align: inherit;">Es war notwendig, sich etwas auszudenken, um dies zu vermeiden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und ich habe es mir ausgedacht. W√§hrend des Eintreffens eines Signals √ºber einen Indikatorwechsel muss bestimmt werden, zu welchem ‚Äã‚ÄãIndikator er geh√∂rt, und der Status seiner Segmente in einer speziell daf√ºr zugewiesenen Variablen gespeichert werden. Jetzt kann ich jederzeit den aktuellen Inhalt aller vier Indikatoren auf einmal ziemlich genau bestimmen. Und wenn die Symbole P, 5 und 5 auf dem ersten, dritten und vierten Symbol angezeigt werden, ist das zweite Symbol definitiv A, und Sie m√ºssen das untere Segment nicht beleuchten. F√ºr alle F√§lle habe ich auch die Verarbeitung des Wortes FAIL hinzugef√ºgt, die ich noch nie gesehen hatte, die ich aber erwartet hatte zu erscheinen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles, mit der Digitalanzeige vorbei. Es bleibt nur die gr√ºne Online-LED zu fixieren. Aber hier erwartete mich eine √úberraschung ... Die Idee war folgende: Die gr√ºne LED (Online) leuchtet immer alleine auf. Wenn die gelben (Batterie) oder roten (Batterie schwach) LEDs leuchten, sollte die gr√ºne nicht leuchten. Daher l√∂ten wir Dr√§hte von diesen LEDs an den Mikrocontroller, setzen ein einfaches if () mit einem logischen ‚ÄûODER‚Äú und alles sollte funktionieren. Es stellte sich jedoch heraus, dass die gelbe LED nicht st√§ndig leuchtet, sondern schnell blinkt, wenn sie leuchtet. Schnell, aber nicht genug, damit if () die gr√ºne LED √ºberspringt und nicht leuchtet. Es stellte sich heraus, dass die gr√ºne LED beim Arbeiten im Netzwerk bei voller Helligkeit aufleuchtet. Beim Umschalten auf den Akku brannte sie jedoch bei halber Helligkeit, brannte aber immer noch. Kein Problem, dachte ich, ich werde einen einfachen Tiefpassfilter einsetzen:Ich werde alle schnellen Blitze abschneiden, aber ich werde nur langsame Blitze hinterlassen, die dem √úbergang zur Batterie entsprechen und umgekehrt. Die Analyse der Blinkzeit der gelben LED brachte folgende √úberraschung: Die Periode der ihr zugef√ºhrten Impulse ist sehr instabil und kann recht gro√üe Werte erreichen. Es stellte sich heraus, dass der Filter Signale nicht h√∂her als 0,5-1 Hz durchlassen sollte. Dies ist nicht sehr gut, da wir eine ziemlich gro√üe Verz√∂gerung beim √Ñndern des Online-Signals bekommen, aber es ist ziemlich tolerierbar.da wir eine ziemlich gro√üe Verz√∂gerung beim √Ñndern des Online-Signals bekommen, ist es aber ziemlich ertr√§glich.da wir eine ziemlich gro√üe Verz√∂gerung beim √Ñndern des Online-Signals bekommen, ist es aber ziemlich ertr√§glich.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe beschlossen, den Filter sehr einfach zu machen. </font><font style="vertical-align: inherit;">Wir √ºberwachen 50 Mal in regelm√§√üigen Abst√§nden den Status der gelben und roten LEDs. </font><font style="vertical-align: inherit;">Wenn einer von ihnen brennt, erh√∂hen wir den Spezialz√§hler um eins. </font><font style="vertical-align: inherit;">Dann √ºberpr√ºfen wir den Wert des Z√§hlers. Wenn die Steuer-LEDs 50% der √ºberpr√ºften Zeit aufleuchten, glauben wir, dass er eingeschaltet ist, und wenn weniger, ist er ausgeschaltet. </font><font style="vertical-align: inherit;">Beim Debuggen musste ich diese Zahl auf 10% reduzieren. </font><font style="vertical-align: inherit;">Warum - habe es nicht herausgefunden. </font></font><br>
<br>
<img src="https://habrastorage.org/files/88e/bd5/51b/88ebd551ba62430ba32362657836bd94.jpg" alt="Endmontage"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und alles hat funktioniert! </font><font style="vertical-align: inherit;">Es blieb nur, das Arduino-Board mit doppelseitigem Klebeband und einer Klebepistole wundersch√∂n im USV-Geh√§use zu montieren.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Elb8pT4lWlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr Neugierige:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der resultierende Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span></span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AVG_TIME    50</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> THS_TIME    45</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_A    _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_B    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_C    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_D    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_E    _BV(4)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_F    _BV(5)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_G    _BV(6)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_RED  SD_SEG_A</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_YLW  SD_SEG_C</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_LED  _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_1    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_2    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_3    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_4    _BV(4)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SEL     (PINC &amp; 0x1f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_NONE (0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_0    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_1    (SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_2    (SD_SEG_A | SD_SEG_B | SD_SEG_D | SD_SEG_E | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_3    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_4    (SD_SEG_B | SD_SEG_C | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_5    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_6    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_7    (SD_SEG_A | SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_8    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_9    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_E    (SD_SEG_A | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_P    (SD_SEG_A | SD_SEG_B | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_T    (SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SYM     (~PIND &amp; 0x7f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BROKEN_SEG  (SD_SEG_D)</span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbols[] = {                 <span class="hljs-comment"><span class="hljs-comment">// list of known symbols</span></span><font></font>
    SD_SYM_NONE,<font></font>
    SD_SYM_0, SD_SYM_1, SD_SYM_2, SD_SYM_3, SD_SYM_4,<font></font>
    SD_SYM_5, SD_SYM_6, SD_SYM_7, SD_SYM_8, SD_SYM_9,<font></font>
    SD_SYM_E, SD_SYM_P, SD_SYM_T<font></font>
};<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sel, symbol;            <span class="hljs-comment"><span class="hljs-comment">// current input signals</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fb0, fb1, fb2, fb3, fb4;  <span class="hljs-comment"><span class="hljs-comment">// display frame buffer</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// display routine</span></span><font></font>
ISR(PCINT1_vect) {<font></font>
    sel = GET_SEL;<font></font>
    symbol = GET_SYM;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((sel &amp; LD_SEL_LED) &amp;&amp; fb0) ||<font></font>
            ((sel &amp; LD_SEL_1) &amp;&amp; fb1) ||<font></font>
            ((sel &amp; LD_SEL_2) &amp;&amp; fb2) ||<font></font>
            ((sel &amp; LD_SEL_3) &amp;&amp; fb3) ||<font></font>
            ((sel &amp; LD_SEL_4) &amp;&amp; fb4)){<font></font>
        PORTD &amp;= ~BROKEN_SEG;<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
        PORTD |= BROKEN_SEG;<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">// entry point</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cur_time;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> led_on_time;
    <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> last_symbol_1, last_symbol_2, last_symbol_3, last_symbol_4;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup GPIO ports</span></span>
    DDRC = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    DDRD = BROKEN_SEG;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup pin change interrupt</span></span><font></font>
    PCICR |= _BV(PCIE1);<font></font>
    PCMSK1 |= _BV(PCINT8) | _BV(PCINT9) | _BV(PCINT10) | _BV(PCINT11) | _BV(PCINT12);<font></font>
<font></font>
    cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    last_symbol_1 = last_symbol_2 = last_symbol_3 = last_symbol_4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    fb0 = fb1 = fb2 = fb3 = fb4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-comment"><span class="hljs-comment">// sync with display strobe</span></span><font></font>
        sei();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sel == <span class="hljs-number"><span class="hljs-number">0</span></span>) {}<font></font>
        cli();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select one of segment indicator</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; (LD_SEL_1 | LD_SEL_2 | LD_SEL_3 | LD_SEL_4)) {
            <span class="hljs-comment"><span class="hljs-comment">// looking for displayed symbol</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">14</span></span>; i++) {
                <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbol = sd_symbols[i];
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; ~BROKEN_SEG) == (sd_symbol &amp; ~BROKEN_SEG)) {
                    <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> val;
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd_symbol &amp; BROKEN_SEG) {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_1) {<font></font>
                        last_symbol_1 = sd_symbol;<font></font>
                        fb1 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_2) {<font></font>
                        last_symbol_2 = sd_symbol;<font></font>
                        fb2 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_3) {<font></font>
                        last_symbol_3 = sd_symbol;<font></font>
                        fb3 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_4) {<font></font>
                        last_symbol_4 = sd_symbol;<font></font>
                        fb4 = val;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// PASS workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_P) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_5) &amp;&amp; (last_symbol_4 == SD_SYM_5)) {<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// FAIL workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_E) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_1) &amp;&amp; (last_symbol_4 == SD_SYM_1)) {<font></font>
                        fb1 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb4 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select LED line</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_LED) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_time++ &gt; AVG_TIME) {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (led_on_time &lt; THS_TIME) {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                }<font></font>
                cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; (SD_LED_RED | SD_LED_YLW)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) {<font></font>
                    led_on_time++;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// reset sync flag</span></span>
        sel = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de397697/">https://habr.com/ru/post/de397697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de397687/index.html">Auf einigen Laptops mit Windows 10 k√∂nnen Sie Linux nicht ausliefern</a></li>
<li><a href="../de397689/index.html">Warum f√ºhlen wir uns immer besch√§ftigt?</a></li>
<li><a href="../de397691/index.html">Kaufen Sie als PRO, Bruder</a></li>
<li><a href="../de397693/index.html">Die Wissenschaftler haben zun√§chst ein 3D-Modell des Gehirns von Drosophila erstellt</a></li>
<li><a href="../de397695/index.html">Was sind Weichmacher und womit essen sie?</a></li>
<li><a href="../de397699/index.html">Die Vorteile der Kalligraphie und anderer p√§dagogischer Mythen</a></li>
<li><a href="../de397701/index.html">Grafikkarte nach mir benannt: wie man ein professioneller Overclocker wird</a></li>
<li><a href="../de397703/index.html">Preistr√§ger des Shnobel-Preises 2016</a></li>
<li><a href="../de397705/index.html">Lithium-Ionen- und Lithium-Polymer-Batterien: Marketing-Tricks und h√§ufige Fehler</a></li>
<li><a href="../de397707/index.html">Erstaunliches Kleinhirn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>