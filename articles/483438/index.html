<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¶ üå•Ô∏è üíÉüèª Juega "osu!", No te olvides de los errores ü§± üë©üèø‚Äçüíª üï¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Damos la bienvenida a todos los amantes de ex√≥ticos y no muy errores en el c√≥digo. Hoy en el banco de pruebas PVS-Studio es un invitado bastante raro:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Juega "osu!", No te olvides de los errores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483438/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Imagen 1" align="left"></p>  Damos la bienvenida a todos los amantes de ex√≥ticos y no muy errores en el c√≥digo.  Hoy en el banco de pruebas PVS-Studio es un invitado bastante raro: un juego en C #.  A saber, osu!  Como de costumbre: busca errores, piensa, juega. <br><a name="habracut"></a><br><h2>  El juego </h2><br>  Osu!  - Un juego de ritmo musical de c√≥digo abierto.  A juzgar por la informaci√≥n <a href="https://osu.ppy.sh/home">del sitio web del juego</a> , es bastante popular, ya que se reclaman m√°s de 15 millones de jugadores registrados.  El proyecto se caracteriza por una jugabilidad gratuita, un dise√±o colorido con la capacidad de personalizar tarjetas, caracter√≠sticas avanzadas para compilar un ranking en l√≠nea de jugadores, la presencia de multijugador, un gran conjunto de composiciones musicales.  No describir√© el juego en detalle, los interesados ‚Äã‚Äãencontrar√°n f√°cilmente toda la informaci√≥n en la red.  Por ejemplo, <a href="https://en.wikipedia.org/wiki/Osu!">aqu√≠</a> . <br><br>  Estoy m√°s interesado en el c√≥digo fuente del proyecto, que est√° disponible para descargar desde <a href="https://github.com/ppy/osu">GitHub</a> .  Un n√∫mero significativo de confirmaciones (m√°s de 24 mil) en el repositorio llama inmediatamente la atenci√≥n, lo que indica el desarrollo activo del proyecto, que contin√∫a hasta el d√≠a de hoy (el juego se lanz√≥ en 2007, pero el trabajo probablemente comenz√≥ antes).  Al mismo tiempo, no hay mucho c√≥digo fuente: 1813 archivos .cs que contienen 135 mil l√≠neas de c√≥digo, excluyendo las vac√≠as.  Este c√≥digo contiene pruebas que generalmente no tomo en cuenta en los cheques.  El c√≥digo de prueba est√° contenido en 306 archivos .cs y, en consecuencia, 25 mil l√≠neas de c√≥digo, excluyendo las vac√≠as.  Este es un proyecto peque√±o: a modo de comparaci√≥n, el n√∫cleo C # del analizador PVS-Studio contiene alrededor de 300 mil l√≠neas de c√≥digo. <br><br>  En total, para verificar el juego en busca de errores, utilic√© proyectos que no son de prueba que contienen 1507 archivos de c√≥digo fuente y 110 mil l√≠neas.  Sin embargo, el resultado me complaci√≥ parcialmente, ya que hubo varios errores interesantes de los que me apresur√© a contarte. <br><br><h2>  Errores </h2><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Hay <a href="https://www.viva64.com/ru/w/v3001/">subexpresiones</a> id√©nticas 'result == HitResult.Perfect' a la izquierda y a la derecha de '||'  operador  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Un buen ejemplo de programaci√≥n orientada a copiar y pegar.  Un t√©rmino c√≥mico que mi colega Valery Komarov us√≥ recientemente (present√≥) en su art√≠culo " <a href="https://www.viva64.com/ru/b/0699/">Los 10 errores principales en proyectos Java para 2019</a> ". <br><br>  Entonces, dos controles id√©nticos siguen uno tras otro.  Una de las comprobaciones probablemente deber√≠a contener otra <i>constante de</i> enumeraci√≥n <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  ¬øQu√© constante en particular necesitaba ser utilizada, o la segunda verificaci√≥n no es necesaria?  Preguntas que solo el desarrollador puede responder.  En cualquier caso, se ha cometido un error que distorsiona la l√≥gica del programa. <br><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Hay <a href="https://www.viva64.com/ru/w/v3001/">subexpresiones</a> id√©nticas 'family! = GetFamilyString (TournamentTypeface.Aquatico)' a la izquierda y a la derecha del operador '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Y de nuevo copiar y pegar.  Formate√© el c√≥digo, por lo que el error se nota f√°cilmente.  En la versi√≥n original, toda la condici√≥n se escribi√≥ en una l√≠nea.  Tambi√©n es dif√≠cil decir c√≥mo se puede arreglar el c√≥digo.  La enumeraci√≥n <i>TournamentTypeface</i> contiene una sola constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  La condici√≥n puede haber usado la variable <i>familiar</i> dos veces por error, pero esto no es exacto. <br><br>  <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] Es extra√±o que este m√©todo siempre devuelva el mismo valor de 'falso'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  El m√©todo siempre devolver√° <i>falso</i> .  Para tales errores, generalmente verifico el c√≥digo de llamada, ya que a menudo simplemente no usan el valor de retorno en ning√∫n lado, entonces no hay error (excepto el estilo de programaci√≥n feo).  En este caso, me encontr√© con el siguiente c√≥digo: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Como puede ver, se utiliza el resultado devuelto por el m√©todo <i>OnPressed</i> .  Y como siempre es <i>falso</i> , el resultado de llamar a <i>OnPressed</i> tambi√©n ser√° siempre <i>falso</i> .  Creo que deber√≠a volver a verificar este c√≥digo nuevamente, ya que hay una alta probabilidad de error. <br><br>  Otro error similar: <br><br><ul><li>  V3009 [CWE-393] Es extra√±o que este m√©todo siempre devuelva el mismo valor de 'falso'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  En la condici√≥n del operador <i>?:</i> , La variable <i>val.NewValue</i> no es segura.  El analizador lleg√≥ a esa conclusi√≥n, ya que en la rama de entonces, se utiliza una opci√≥n segura para acceder a la variable a trav√©s de la <i>declaraci√≥n de</i> acceso condicional <i>val.NewValue? .Substring (....)</i> . <br><br>  Otro error similar: <br><br><ul><li>  V3042 [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Posible NullReferenceException.  El '?.'  y '.'  Los operadores se utilizan para acceder a los miembros del objeto 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Este c√≥digo es menos claro, pero creo que el error sigue ah√≠.  Cree un objeto de tipo <i>ActionableInfo</i> .  El campo <i>Acci√≥n</i> se inicializa con una lambda, en cuyo cuerpo no es seguro trabajar con una <i>API de</i> referencia potencialmente nula.  El analizador consider√≥ que este patr√≥n era un error, ya que, al inicializar el par√°metro <i>Value</i> , la variable <i>api</i> funciona de manera segura.  Llam√© ambiguo al error, porque el c√≥digo lambda supone una ejecuci√≥n retrasada y luego, tal vez, el desarrollador de alguna manera garantiza un valor distinto de cero del enlace <i>api</i> .  Pero esto es solo una suposici√≥n, ya que el cuerpo lambda no contiene ning√∫n signo de trabajo seguro con el enlace (verificaciones preliminares, por ejemplo). <br><br>  <a href="https://www.viva64.com/ru/w/v3066/">V3066</a> [CWE-683] Posible orden incorrecto de argumentos pasados ‚Äã‚Äãal m√©todo 'Atan2': 'diff.X' y 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  El analizador sospechaba que cuando trabajaba con el m√©todo <i>Atan2</i> de la clase <i>Math</i> , el desarrollador confund√≠a el orden de los argumentos.  <i>Anuncio de Atan2</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Como puede ver, los valores se transfirieron en orden inverso.  No puedo juzgar si esto es un error, ya que el m√©todo <i>UpdateProgress</i> contiene muchos c√°lculos no triviales.  Solo tenga en cuenta el hecho de un posible problema en el c√≥digo. <br><br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> [CWE-476] Posible desreferencia nula.  Considere inspeccionar 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  El analizador se√±al√≥ el peligro de acceso a trav√©s del enlace nulo <i>Beatmap</i> .  Esto es lo que es: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Bueno, el analizador tiene raz√≥n. <br><br>  Para obtener m√°s informaci√≥n acerca de c√≥mo PVS-Studio encuentra dichos errores, as√≠ como sobre las innovaciones de C # 8.0 relacionadas con temas similares (trabajar con referencias potencialmente nulas), consulte el art√≠culo " <a href="https://www.viva64.com/ru/b/0631/">Tipos de referencia anulables en C # 8.0 y an√°lisis est√°tico</a> ". <br><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> [CWE-367] Invocaci√≥n insegura del evento 'ObjectConverted', NullReferenceException es posible.  Considere asignar un evento a una variable local antes de invocarlo.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Error no cr√≠tico y bastante com√∫n.  Entre la comprobaci√≥n del evento para <i>nulo</i> y su invocaci√≥n, pueden darse de baja del evento, lo que provocar√° el bloqueo del programa. <br>  Una de las soluciones: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> [CWE-476] El objeto 'columnas' se us√≥ antes de que se verificara como nulo.  L√≠neas de verificaci√≥n: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  No es seguro omitir la colecci√≥n de <i>columnas</i> en un bucle.  Al mismo tiempo, el desarrollador asumi√≥ que el enlace de las <i>columnas</i> podr√≠a ser nulo, ya que m√°s adelante en el c√≥digo, se utiliza un operador de acceso condicional para acceder a la colecci√≥n. <br><br>  <a href="https://www.viva64.com/ru/w/v3119/">V3119</a> Llamar al evento anulado 'OnNewResult' puede conducir a un comportamiento impredecible.  Considere implementar accesores de eventos expl√≠citamente o use una palabra clave 'sellada'.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  El analizador advierte sobre los peligros de usar un evento anulado o virtual.  ¬øCu√°l es exactamente el peligro? Sugiero leer la <a href="https://www.viva64.com/ru/w/v3119/">descripci√≥n</a> del diagn√≥stico.  Adem√°s, en un momento escrib√≠ un art√≠culo sobre este tema, " <a href="https://www.viva64.com/ru/b/0453/">Eventos virtuales en C #: Algo sali√≥ mal</a> ". <br><br>  Otra construcci√≥n insegura similar en el c√≥digo: <br><br><ul><li>  V3119 Llamar a un evento anulado puede conducir a un comportamiento impredecible.  Considere implementar accesores de eventos expl√≠citamente o use una palabra clave 'sellada'  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Quiz√°s el '??'  El operador funciona de una manera diferente a la esperada.  Su prioridad es inferior a la prioridad de otros operadores en su parte izquierda.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Para una mejor comprensi√≥n del problema, dar√© un ejemplo sint√©tico de c√≥mo funciona el c√≥digo ahora: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  El error se cometi√≥ debido al hecho de que el operador * tiene mayor prioridad que el operador ??.  Versi√≥n corregida del c√≥digo (corchetes agregados): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Otro error similar en el c√≥digo: <br><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Quiz√°s el '??'  El operador funciona de una manera diferente a la esperada.  Su prioridad es inferior a la prioridad de otros operadores en su parte izquierda.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Aqu√≠, como en el fragmento de c√≥digo anterior, no se tuvo en cuenta la prioridad de los operadores.  Ahora la expresi√≥n pasada al m√©todo <i>Math.Abs</i> se eval√∫a de la siguiente manera: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  C√≥digo corregido: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3142/">V3142</a> [CWE-561] C√≥digo inalcanzable detectado.  Es posible que haya un error presente.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  El analizador afirma que el <i>c√≥digo del</i> controlador <i>OnPressed</i> , que comienza con la segunda <i>instrucci√≥n if</i> , es inalcanzable.  Esto se deduce de la suposici√≥n de que la primera condici√≥n siempre es verdadera, es decir, la <i>base. El</i> m√©todo <i>OnPressed</i> siempre devolver√° <i>falso</i> .  <i>Eche un</i> vistazo a la <i>base.</i> M√©todo <i>presionado</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Procedemos al m√©todo <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Tenga en cuenta que la implementaci√≥n de la propiedad <i>Judged</i> no es importante aqu√≠, ya que la l√≥gica del m√©todo <i>UpdateResult</i> implica que la √∫ltima <i>declaraci√≥n de retorno es</i> equivalente a esto: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Por lo tanto, el m√©todo <i>UpdateResult</i> siempre devolver√° <i>falso</i> , lo que conducir√° a un error con c√≥digo inalcanzable en el c√≥digo sobre la pila. <br><br>  <a href="https://www.viva64.com/ru/w/v3146/">V3146</a> [CWE-476] Posible desreferencia nula del 'conjunto de reglas'.  'FirstOrDefault' puede devolver un valor nulo predeterminado.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  El analizador considera que la llamada al conjunto de <i>reglas.CreateInstance ()</i> no es segura.  La variable de <i>conjunto de reglas</i> obtiene previamente el valor como resultado de llamar a <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Como puede ver, la advertencia del analizador est√° justificada, ya que la cadena de llamadas contiene <i>FirstOrDefault</i> , que puede devolver <i>nulo</i> . <br><br><h2>  Conclusi√≥n </h2><br>  En general, el proyecto del juego "osu!" Satisfecho con un peque√±o n√∫mero de errores.  Sin embargo, recomiendo a los desarrolladores que presten atenci√≥n a los problemas detectados.  Y deja que el juego siga complaciendo a sus fan√°ticos. <br><br>  Y para aquellos a quienes les gusta profundizar en el c√≥digo, les recuerdo que el analizador PVS-Studio, que es f√°cil de <a href="https://www.viva64.com/ru/pvs-studio-download/">descargar</a> desde el sitio oficial, ser√° de gran ayuda.  Tambi√©n noto que las comprobaciones de proyectos √∫nicas, como las descritas anteriormente, no tienen nada que ver con el uso de un analizador est√°tico en el trabajo real.  La m√°xima eficiencia en la lucha contra los errores solo se puede lograr con el uso regular de la herramienta tanto en el servidor de compilaci√≥n como directamente en la computadora del desarrollador (an√°lisis incremental).  El objetivo m√°ximo es evitar que los errores ingresen al sistema de control de versiones, reparando defectos que ya est√°n en la etapa de escritura del c√≥digo. <br><br>  ¬°Buena suerte y √©xito! <br><br><h2>  Referencias </h2><br>  Esta es la primera publicaci√≥n en 2020.  Aprovechando esta oportunidad, proporcionar√© enlaces a art√≠culos sobre la verificaci√≥n de proyectos de C # el a√±o pasado: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0605/">Buscando errores en el SDK de Amazon Web Services para el c√≥digo fuente de .NET</a> </li><li>  <a href="https://www.viva64.com/ru/b/0622/">Comprobando el c√≥digo fuente de Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0631/">Tipos de referencia anulables en C # 8.0 y an√°lisis est√°tico</a> </li><li>  <a href="https://www.viva64.com/ru/b/0653/">WinForms: Errores, Holmes</a> </li><li>  <a href="https://www.viva64.com/ru/b/0654/">La historia de c√≥mo PVS-Studio encontr√≥ un error en la biblioteca utilizada en ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0656/">Verificaci√≥n del c√≥digo fuente de las bibliotecas .NET Core mediante el analizador est√°tico PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0664/">Comprobaci√≥n de los analizadores de Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0677/">Verifique la interfaz de usuario de Telerik para UWP para familiarizarse con PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0678/">Azure PowerShell: "en su mayor√≠a inofensivo"</a> </li><li>  <a href="https://www.viva64.com/ru/b/0681/">Buscamos y analizamos errores en el c√≥digo Orchard CMS</a> </li><li>  <a href="https://www.viva64.com/ru/b/0683/">Comprobaci√≥n del contenedor OpenCvSharp sobre OpenCV con PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0692/">Azure SDK para .NET: la historia de un buscador de errores dif√≠cil</a> </li><li>  <a href="https://www.viva64.com/ru/b/0694/">SDK de SARIF y sus errores</a> </li><li>  <a href="https://www.viva64.com/ru/b/0698/">Los 10 errores principales en proyectos de C # para 2019</a> </li></ul><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/483436/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si desea compartir este art√≠culo con una audiencia de habla inglesa, utilice el enlace a la traducci√≥n: Sergey Khrenov.  <a href="https://habr.com/en/company/pvs-studio/blog/483436/">Juega "osu!", Pero ten cuidado con los errores</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/483438/">https://habr.com/ru/post/483438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483418/index.html">Sistemas de tickets: ¬øc√≥mo obtuvo tres OTRS gratuitos pagados?</a></li>
<li><a href="../483424/index.html">DBA: transferencia de valores de SECUENCIA entre bases de datos PostgreSQL</a></li>
<li><a href="../483426/index.html">Encuesta de pesta√±a del viernes</a></li>
<li><a href="../483428/index.html">¬øCu√°l ser√° la gesti√≥n de documentos electr√≥nicos despu√©s de la entrada en vigor de las enmiendas a la ley de firma electr√≥nica?</a></li>
<li><a href="../483436/index.html">Juega "osu!", Pero ten cuidado con los errores</a></li>
<li><a href="../483440/index.html">√öltimos compiladores de D</a></li>
<li><a href="../483444/index.html">Informe DORA 2019: C√≥mo mejorar el rendimiento de DevOps</a></li>
<li><a href="../483446/index.html">Los cient√≠ficos han encontrado una nueva forma de reducir los niveles de hierro en el agua potable</a></li>
<li><a href="../483448/index.html">Disney: el mejor bidireccional de la historia humana</a></li>
<li><a href="../483454/index.html">Cambiar de Mercurial a GIT en Atlassian Bitbucket con guardar archivos en cir√≠lico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>