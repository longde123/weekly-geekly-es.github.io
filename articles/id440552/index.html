<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍💻 💈 📨 Hentikan penutupan dan suntikkan Ketergantungan Injeksi dalam JavaScript 🌓 🤶🏻 👊🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, kita akan melihat bagaimana menulis kode yang bersih dan mudah diuji dalam gaya fungsional menggunakan pola pemrograman Ketergantung...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hentikan penutupan dan suntikkan Ketergantungan Injeksi dalam JavaScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/devexpress/blog/440552/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/6k/ww/pf/6kwwpf7sh7uzpwbl2nszzmrzkfy.png" alt="gambar"></a> </p><br><p>  Pada artikel ini, kita akan melihat bagaimana menulis kode yang bersih dan mudah diuji dalam gaya fungsional menggunakan pola pemrograman Ketergantungan Injeksi.  Bonusnya adalah 100% cakupan tes unit. </p><a name="habracut"></a><br><h1 id="terminologiya-kotoraya-budet-ispolzovatsya-v-state">  Terminologi yang akan digunakan dalam artikel </h1><br><p>  Penulis artikel ini akan mengingat dengan tepat interpretasi dari istilah-istilah berikut, memahami bahwa ini bukan kebenaran tertinggi dan bahwa interpretasi lain dimungkinkan. </p><br><ul><li>  <strong>Ketergantungan injeksi</strong> <br>  Ini adalah pola pemrograman yang mengasumsikan bahwa dependensi eksternal untuk fungsi dan objek pabrik berasal dari luar dalam bentuk argumen untuk fungsi-fungsi ini.  Injeksi ketergantungan adalah alternatif untuk menggunakan dependensi dari konteks global. </li><li>  <strong>Fungsi bersih</strong> <br>  Ini adalah fungsi, yang hasilnya hanya bergantung pada argumennya.  Selain itu, fungsi ini seharusnya tidak memiliki efek samping. <br>  Saya ingin membuat reservasi segera bahwa fungsi yang kami pertimbangkan tidak memiliki efek samping, tetapi mereka masih dapat memiliki fungsi yang datang kepada kami melalui Injeksi Ketergantungan.  Jadi kemurnian fungsi yang kita miliki dengan reservasi besar. </li><li>  <strong>Tes unit</strong> <br>  Tes fungsi yang memeriksa bahwa semua garpu di dalam fungsi ini bekerja persis seperti yang diinginkan pembuat kode.  Dalam hal ini, alih-alih memanggil fungsi lain, panggilan ke moks digunakan. </li></ul><br><h1 id="razbiraemsya-na-praktike">  Kami mengerti dalam praktiknya </h1><br><p> Pertimbangkan sebuah contoh.  Pabrik penghitung yang menghitung <code>tick</code> .  Penghitung dapat dihentikan menggunakan metode <code>cancel</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createCounter = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ ticks, onTick }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> state = { <span class="hljs-attr"><span class="hljs-attr">currentTick</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">timer</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">canceled</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cancel = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.canceled) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'"Counter" already canceled'</span></span>) } clearInterval(state.timer) } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onInterval = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { onTick(state.currentTick++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.currentTick &gt; ticks) { cancel() } } state.timer = setInterval(onInterval, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> instance = { cancel } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createCounter</code> </pre> <br><p>  Kami melihat kode yang dapat dibaca manusia dan dimengerti.  Tetapi ada satu tangkapan - tes unit normal tidak dapat ditulis di atasnya.  Mari kita lihat apa yang menghalangi? </p><br><p>  1) Anda tidak dapat mencapai fungsi di dalam <code>cancel</code> , <code>onInterval</code> dan mengujinya secara terpisah. </p><br><p>  2) fungsi <code>onInterval</code> tidak dapat diuji secara terpisah dari fungsi <code>cancel</code> , karena  yang pertama memiliki tautan langsung ke yang kedua. </p><br><p>  3) dependensi eksternal <code>setInterval</code> , <code>clearInterval</code> . </p><br><p>  4) fungsi <code>createCounter</code> tidak dapat diuji secara terpisah dari fungsi lain, lagi karena tautan langsung. </p><br><p>  Mari kita selesaikan masalah 1) 2) - kita menghapus fungsi <code>cancel</code> , <code>onInterval</code> dari penutupan dan memutus hubungan langsung di antara mereka melalui objek <code>pool</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cancel = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pool</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pool.state.canceled) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'"Counter" already canceled'</span></span>) } clearInterval(pool.state.timer) } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onInterval = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pool</span></span></span><span class="hljs-function"> =&gt;</span></span> { pool.config.onTick(pool.state.currentTick++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pool.state.currentTick &gt; pool.config.ticks) { pool.cancel() } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createCounter = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pool = { config, <span class="hljs-attr"><span class="hljs-attr">state</span></span>: { <span class="hljs-attr"><span class="hljs-attr">currentTick</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">timer</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">canceled</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } pool.cancel = cancel.bind(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, pool) pool.onInterval = onInterval.bind(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, pool) pool.state.timer = setInterval(pool.onInterval, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> instance = { <span class="hljs-attr"><span class="hljs-attr">cancel</span></span>: pool.cancel } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createCounter</code> </pre> <br><p>  Kami memecahkan masalah 3).  Kami menggunakan pola Ketergantungan Injeksi pada <code>setInterval</code> , <code>clearInterval</code> dan juga mentransfernya ke objek <code>pool</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cancel = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pool</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { clearInterval } = pool <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pool.state.canceled) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'"Counter" already canceled'</span></span>) } clearInterval(pool.state.timer) } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onInterval = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pool</span></span></span><span class="hljs-function"> =&gt;</span></span> { pool.config.onTick(pool.state.currentTick++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pool.state.currentTick &gt; pool.config.ticks) { pool.cancel() } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createCounter = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dependencies, config</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pool = { ...dependencies, config, <span class="hljs-attr"><span class="hljs-attr">state</span></span>: { <span class="hljs-attr"><span class="hljs-attr">currentTick</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">timer</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">canceled</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } pool.cancel = cancel.bind(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, pool) pool.onInterval = onInterval.bind(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, pool) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { setInterval } = pool pool.state.timer = setInterval(pool.onInterval, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> instance = { <span class="hljs-attr"><span class="hljs-attr">cancel</span></span>: pool.cancel } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createCounter.bind(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, { setInterval, clearInterval })</code> </pre> <br><p>  Sekarang hampir semuanya baik-baik saja, tetapi masih ada masalah 4).  Pada langkah terakhir, kami menerapkan Dependency Injection ke masing-masing fungsi kami dan memutus koneksi yang tersisa di antara mereka melalui objek <code>pool</code> .  Pada saat yang sama, kami akan membagi satu file besar menjadi banyak file, sehingga nantinya akan lebih mudah untuk menulis unit test. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// index.js import { createCounter } from './create-counter' import { cancel } from './cancel' import { onInterval } from './on-interval' export default createCounter.bind(null, { cancel, onInterval, setInterval, clearInterval })</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// create-counter.js export const createCounter = (dependencies, config) =&gt; { const pool = { ...dependencies, config, state: { currentTick: 1, timer: null, canceled: false } } pool.cancel = dependencies.cancel.bind(null, pool) pool.onInterval = dependencies.onInterval.bind(null, pool) const { setInterval } = pool pool.state.timer = setInterval(pool.onInterval, 200) const instance = { cancel: pool.cancel } return instance }</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// on-interval.js export const onInterval = pool =&gt; { pool.config.onTick(pool.state.currentTick++) if (pool.state.currentTick &gt; pool.config.ticks) { pool.cancel() } }</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// cancel.js export const cancel = pool =&gt; { const { clearInterval } = pool if (pool.state.canceled) { throw new Error('"Counter" already canceled') } clearInterval(pool.state.timer) }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>  Apa yang kita miliki pada akhirnya?  Banyak file, yang masing-masing berisi satu fungsi bersih.  Kesederhanaan dan kelengkapan kode sedikit memburuk, tetapi ini lebih dari dikompensasi oleh gambar cakupan 100% dalam unit test. </p><br><p><img src="https://habrastorage.org/webt/sq/23/ck/sq23ckztnawh5m9bijlqsmbcd8u.png" alt="cakupan"></p><br><p>  Saya juga ingin mencatat bahwa untuk menulis unit test kita tidak perlu melakukan manipulasi apa pun dengan <code>require</code> dan mendapatkan sistem file Node.js. </p><br><div class="spoiler">  <b class="spoiler_title">Tes unit</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// cancel.test.js import { cancel } from '../src/cancel' describe('method "cancel"', () =&gt; { test('should stop the counter', () =&gt; { const state = { canceled: false, timer: 42 } const clearInterval = jest.fn() const pool = { state, clearInterval } cancel(pool) expect(clearInterval).toHaveBeenCalledWith(pool.state.timer) }) test('should throw error: "Counter" already canceled', () =&gt; { const state = { canceled: true, timer: 42 } const clearInterval = jest.fn() const pool = { state, clearInterval } expect(() =&gt; cancel(pool)).toThrow('"Counter" already canceled') expect(clearInterval).not.toHaveBeenCalled() }) })</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// create-counter.test.js import { createCounter } from '../src/create-counter' describe('method "createCounter"', () =&gt; { test('should create a counter', () =&gt; { const boundCancel = jest.fn() const boundOnInterval = jest.fn() const timer = 42 const cancel = { bind: jest.fn().mockReturnValue(boundCancel) } const onInterval = { bind: jest.fn().mockReturnValue(boundOnInterval) } const setInterval = jest.fn().mockReturnValue(timer) const dependencies = { cancel, onInterval, setInterval } const config = { ticks: 42 } const counter = createCounter(dependencies, config) expect(cancel.bind).toHaveBeenCalled() expect(onInterval.bind).toHaveBeenCalled() expect(setInterval).toHaveBeenCalledWith(boundOnInterval, 200) expect(counter).toHaveProperty('cancel') }) })</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// on-interval.test.js import { onInterval } from '../src/on-interval' describe('method "onInterval"', () =&gt; { test('should call "onTick"', () =&gt; { const onTick = jest.fn() const cancel = jest.fn() const state = { currentTick: 1 } const config = { ticks: 5, onTick } const pool = { onTick, cancel, state, config } onInterval(pool) expect(onTick).toHaveBeenCalledWith(1) expect(pool.state.currentTick).toEqual(2) expect(cancel).not.toHaveBeenCalled() }) test('should call "onTick" and "cancel"', () =&gt; { const onTick = jest.fn() const cancel = jest.fn() const state = { currentTick: 5 } const config = { ticks: 5, onTick } const pool = { onTick, cancel, state, config } onInterval(pool) expect(onTick).toHaveBeenCalledWith(5) expect(pool.state.currentTick).toEqual(6) expect(cancel).toHaveBeenCalledWith() }) })</span></span></code> </pre> </div></div><br><p>  Hanya dengan membuka semua fungsi sampai akhir, kita mendapatkan kebebasan. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440552/">https://habr.com/ru/post/id440552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440542/index.html">Vuex - penggunaan berlebihan getter dalam aplikasi. Kesalahan saat menguraikan</a></li>
<li><a href="../id440544/index.html">Rilis eksperimental Blazor 0.8.0 sekarang tersedia</a></li>
<li><a href="../id440546/index.html">Obrolan Terdistribusi di Node.JS dan Redis</a></li>
<li><a href="../id440548/index.html">"Anda tidak bisa hanya mengambil dan memaralelkan sumber tegangan"</a></li>
<li><a href="../id440550/index.html">Segitiga warna tidak memiliki dua, tetapi satu sudut</a></li>
<li><a href="../id440554/index.html">BEM yang nyaman</a></li>
<li><a href="../id440556/index.html">Mempelajari Desain Diagram Hubungan Entitas</a></li>
<li><a href="../id440558/index.html">Teknologi yang akan membawa jaringan kuantum lebih dekat</a></li>
<li><a href="../id440560/index.html">Alexander Belokrylov dan Dmitry Chuyko tentang Liberica JDK di jug.msk.ru</a></li>
<li><a href="../id440562/index.html">Windows Phone - SEMUANYA, Ini Lagi atau Lagi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>