<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õÑÔ∏è üßõüèΩ üë©üèª‚Äçü§ù‚Äçüë®üèº Os ABCs de seguran√ßa no Kubernetes: autentica√ß√£o, autoriza√ß√£o, auditoria ü¶ï üïí üßëüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cedo ou tarde, a opera√ß√£o de qualquer sistema levanta a quest√£o da seguran√ßa: garantir autentica√ß√£o, separa√ß√£o de direitos, auditoria e outras tarefas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Os ABCs de seguran√ßa no Kubernetes: autentica√ß√£o, autoriza√ß√£o, auditoria</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/468679/"><img src="https://habrastorage.org/webt/ao/pp/ke/aoppkeeufk5-tv1rmtmtw9oce7a.png"><br><br>  Cedo ou tarde, a opera√ß√£o de qualquer sistema levanta a quest√£o da seguran√ßa: garantir autentica√ß√£o, separa√ß√£o de direitos, auditoria e outras tarefas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Muitas solu√ß√µes</a> j√° foram criadas para o Kubernetes que podem alcan√ßar a conformidade com os padr√µes, mesmo em ambientes muito exigentes ... O mesmo material √© dedicado aos aspectos b√°sicos de seguran√ßa implementados na estrutura dos mecanismos internos do K8s.  Antes de tudo, ser√° √∫til para quem come√ßa a se familiarizar com o Kubernetes, como ponto de partida para o estudo de problemas de seguran√ßa. <a name="habracut"></a><br><br><h2>  Autentica√ß√£o </h2><br>  O Kubernetes possui dois tipos de usu√°rios: <br><br><ul><li>  <i>Contas de servi√ßo</i> - contas gerenciadas pela API Kubernetes; </li><li>  <i>Usu√°rios</i> - <i>usu√°rios</i> "normais" controlados por servi√ßos externos independentes. </li></ul><br>  A principal diferen√ßa entre esses tipos √© que, para Contas de Servi√ßo, existem objetos especiais na API do Kubernetes (chamados <code>ServiceAccounts</code> ) que est√£o vinculados ao espa√ßo para nome e ao conjunto de dados de autoriza√ß√£o armazenados no cluster em objetos do tipo Segredos.  Esses usu√°rios (contas de servi√ßo) destinam-se principalmente ao gerenciamento de direitos de acesso aos processos da API Kubernetes em execu√ß√£o em um cluster Kubernetes. <br><br>  Usu√°rios comuns n√£o t√™m entradas na API do Kubernetes: eles devem ser gerenciados por mecanismos externos.  Eles s√£o destinados a pessoas ou processos que vivem fora do cluster. <br><br>  Cada solicita√ß√£o para a API est√° vinculada √† conta de servi√ßo ou ao usu√°rio ou √© considerada an√¥nima. <br><br>  Os dados de autentica√ß√£o do usu√°rio incluem: <br><br><ul><li>  <i>Nome de usu√°rio</i> - nome de usu√°rio (diferencia mai√∫sculas de min√∫sculas!); </li><li>  <i>UID</i> √© uma cadeia de identifica√ß√£o de usu√°rio leg√≠vel por m√°quina que √© "mais consistente e exclusiva que o nome de usu√°rio"; </li><li>  <i>Grupos</i> - uma lista de grupos aos quais o usu√°rio pertence; </li><li>  Campos <i>extras</i> - adicionais que podem ser usados ‚Äã‚Äãpelo mecanismo de autoriza√ß√£o. </li></ul><br>  O Kubernetes pode usar um grande n√∫mero de mecanismos de autentica√ß√£o: certificados X509, tokens do portador, proxies de autentica√ß√£o, autentica√ß√£o b√°sica HTTP.  Usando esses mecanismos, um grande n√∫mero de esquemas de autoriza√ß√£o pode ser implementado: de um arquivo est√°tico com senhas ao OpenID OAuth2. <br><br>  Al√©m disso, v√°rios esquemas de autoriza√ß√£o s√£o permitidos ao mesmo tempo.  Por padr√£o, o cluster usa: <br><br><ul><li>  tokens de conta de servi√ßo - para contas de servi√ßo; </li><li>  X509 - para usu√°rios. </li></ul><br>  A pergunta sobre o gerenciamento de ServiceAccounts est√° al√©m do escopo deste artigo, mas recomendo come√ßar a aprender mais sobre esse problema na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">p√°gina de documenta√ß√£o oficial</a> .  Consideraremos mais detalhadamente a quest√£o do trabalho dos certificados X509. <br><br><h3>  Certificados para usu√°rios (X.509) </h3><br>  A maneira cl√°ssica de trabalhar com certificados envolve: <br><br><ul><li>  gera√ß√£o de chaves: <br><br><pre> <code class="bash hljs">mkdir -p ~/mynewuser/.certs/ openssl genrsa -out ~/.certs/mynewuser.key 2048</code> </pre> </li><li>  gera√ß√£o de solicita√ß√£o de certificado: <br><br><pre> <code class="bash hljs">openssl req -new -key ~/.certs/mynewuser.key -out ~/.certs/mynewuser.csr -subj <span class="hljs-string"><span class="hljs-string">"/CN=mynewuser/O=company"</span></span></code> </pre> </li><li>  processando a solicita√ß√£o de certificado usando chaves CA do cluster Kubernetes, obtendo um certificado de usu√°rio (para obter um certificado, voc√™ precisa usar uma conta que tenha acesso √† chave de autoridade de certifica√ß√£o do cluster Kubernetes, localizada em <code>/etc/kubernetes/pki/ca.key</code> por padr√£o): <br><br><pre> <code class="bash hljs">openssl x509 -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ~/.certs/mynewuser.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out ~/.certs/mynewuser.crt -days 500</code> </pre> </li><li>  criando um arquivo de configura√ß√£o: <br><ul><li>  descri√ß√£o do cluster (especifique o endere√ßo e o local do arquivo de certificado da CA da instala√ß√£o espec√≠fica do cluster): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.100.200:6443</code> </pre> </li><li>  ou - se <b>n√£o</b> for <b>a</b> op√ß√£o recomendada - voc√™ pode omitir o certificado raiz (o kubectl n√£o verificar√° a exatid√£o do cluster da api-server): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --insecure-skip-tls-verify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --server=https://192.168.100.200:6443</code> </pre> </li><li>  adicionando um usu√°rio ao arquivo de configura√ß√£o: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-credentials mynewuser --client-certificate=.certs/mynewuser.crt --client-key=.certs/mynewuser.key</code> </pre> </li><li>  adicionando contexto: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-context mynewuser-context --cluster=kubernetes --namespace=target-namespace --user=mynewuser</code> </pre> </li><li>  atribui√ß√£o de contexto padr√£o: <br><br><pre> <code class="bash hljs">kubectl config use-context mynewuser-context</code> </pre> </li></ul></li></ul><br>  Ap√≥s as manipula√ß√µes acima, uma configura√ß√£o do formul√°rio ser√° criada no arquivo <code>.kube/config</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: v1 clusters: - cluster: certificate-authority: /etc/kubernetes/pki/ca.crt server: https://192.168.100.200:6443 name: kubernetes contexts: - context: cluster: kubernetes namespace: target-namespace user: mynewuser name: mynewuser-context current-context: mynewuser-context kind: Config preferences: {} users: - name: mynewuser user: client-certificate: /home/mynewuser/.certs/mynewuser.crt client-key: /home/mynewuser/.certs/mynewuser.key</code> </pre> <br>  Para facilitar a transfer√™ncia da configura√ß√£o entre contas e servidores, √© √∫til editar os valores das seguintes chaves: <br><br><ul><li> <code>certificate-authority</code> </li> <li> <code>client-certificate</code> </li> <li> <code>client-key</code> </li> </ul><br>  Para fazer isso, voc√™ pode codificar os arquivos indicados neles usando base64 e registr√°-los na configura√ß√£o adicionando o sufixo <code>-data</code> ao nome das chaves, ou seja,  obtendo <code>certificate-authority-data</code> etc. <br><br><h3>  Certificados com kubeadm </h3><br>  Com o lan√ßamento do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes 1.15, o</a> trabalho com certificados tornou-se muito mais f√°cil, gra√ßas √† vers√£o alfa de seu suporte no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utilit√°rio kubeadm</a> .  Por exemplo, eis a apar√™ncia da gera√ß√£o de um arquivo de configura√ß√£o com chaves de usu√°rio agora: <br><br><pre> <code class="bash hljs">kubeadm alpha kubeconfig user --client-name=mynewuser --apiserver-advertise-address 192.168.100.200</code> </pre> <br>  <i><b>Nota</b> : O <i>endere√ßo de publicidade</i> necess√°rio pode ser visualizado na configura√ß√£o do servidor api, localizada em <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> por padr√£o.</i> <br><br>  A configura√ß√£o resultante ser√° impressa no stdout.  Ele deve ser salvo em <code>~/.kube/config</code> conta <code>~/.kube/config</code> usu√°rio ou no arquivo especificado na <code>KUBECONFIG</code> ambiente <code>KUBECONFIG</code> . <br><br><h3>  Aprofundar </h3><br>  Para aqueles que desejam entender completamente os problemas descritos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo separado</a> sobre como trabalhar com certificados na documenta√ß√£o oficial do Kubernetes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um bom artigo da Bitnami</a> , que trata da emiss√£o de certificados do ponto de vista pr√°tico. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o de</a> autentica√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">geral</a> no Kubernetes. </li></ul><br><h2>  Entrar </h2><br>  Uma conta autenticada n√£o tem permiss√£o para atuar em um cluster por padr√£o.  O Kubernetes possui um mecanismo de autoriza√ß√£o para conceder permiss√µes. <br><br>  Antes da vers√£o 1.6, o Kubernetes usava um tipo de autentica√ß√£o chamado <b>ABAC</b> (controle de acesso baseado em atributos).  Detalhes sobre isso podem ser encontrados na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> .  Atualmente, essa abordagem √© considerada herdada, mas voc√™ ainda pode us√°-la ao mesmo tempo que outros tipos de autoriza√ß√£o. <br><br>  A maneira real (e mais flex√≠vel) de dividir os direitos de acesso ao cluster √© chamada <b>RBAC</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">controle de acesso baseado em fun√ß√£o</a> ).  Foi declarado est√°vel desde o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes 1.8</a> .  O RBAC implementa um modelo de direitos que pro√≠be qualquer coisa que n√£o seja explicitamente permitida. <br>  <b>Para habilitar o RBAC</b> , voc√™ precisa executar o api-server do <code>--authorization-mode=RBAC</code> com a op√ß√£o <code>--authorization-mode=RBAC</code> .  Os par√¢metros s√£o definidos no manifesto com a configura√ß√£o da api-server, que por padr√£o est√° localizada no caminho <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> , na se√ß√£o de <code>command</code> .  No entanto, o RBAC j√° est√° ativado por padr√£o, portanto, voc√™ provavelmente n√£o deve se preocupar com isso: √© poss√≠vel verificar isso pelo valor do <code>authorization-mode</code> de <code>authorization-mode</code> (no j√° mencionado <code>kube-apiserver.yaml</code> ).  A prop√≥sito, entre seus valores, pode haver outros tipos de autoriza√ß√£o ( <code>node</code> , <code>webhook</code> , <code>always allow</code> ), mas vamos deix√°-los fora do escopo do material. <br><br>  A prop√≥sito, j√° publicamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo</a> com uma hist√≥ria bastante detalhada sobre os princ√≠pios e recursos do trabalho com o RBAC; portanto, vou me limitar ainda mais a uma breve lista dos princ√≠pios e exemplos. <br><br>  As seguintes entidades da API s√£o usadas para controlar o acesso ao Kubernetes via RBAC: <br><br><ul><li>  <code>Role</code> e <code>ClusterRole</code> s√£o fun√ß√µes que descrevem privil√©gios: </li><li>  <code>Role</code> permite descrever direitos dentro de um espa√ßo para nome; </li><li>  <code>ClusterRole</code> - dentro do cluster, incluindo objetos espec√≠ficos do cluster, como n√≥s, URLs sem recursos (ou seja, n√£o relacionados aos recursos do Kubernetes - por exemplo, <code>/version</code> , <code>/logs</code> , <code>/api*</code> ); </li><li>  <code>RoleBinding</code> e <code>ClusterRoleBinding</code> - serve para vincular <code>Role</code> e <code>ClusterRole</code> a um usu√°rio, grupo de usu√°rios ou ServiceAccount. </li></ul><br>  As entidades Role e RoleBinding s√£o limitadas pelo namespace, ou seja,  deve estar no mesmo espa√ßo para nome.  No entanto, RoleBinding pode se referir a ClusterRole, que permite criar um conjunto de permiss√µes padr√£o e controlar o acesso usando-as. <br><br>  As fun√ß√µes descrevem direitos usando conjuntos de regras que cont√™m: <br><br><ul><li>  Grupos de API - consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> do apiGroups e a sa√≠da do <code>kubectl api-resources</code> ; </li><li>  recursos ( <i>recursos</i> : <code>pod</code> , <code>namespace</code> , <code>deployment</code> etc.); </li><li>  verbos ( <i>verbos</i> : <code>set</code> , <code>update</code> , etc.). </li><li>  nomes de recursos ( <code>resourceNames</code> ) - para o caso em que voc√™ precisa fornecer acesso a um recurso espec√≠fico, e n√£o a todos os recursos desse tipo. </li></ul><br>  Uma discuss√£o mais detalhada da autoriza√ß√£o no Kubernetes pode ser encontrada na p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> .  Em vez disso (ou melhor, al√©m disso), darei exemplos que ilustram seu trabalho. <br><br><h3>  Exemplos de entidades RBAC </h3><br>  Uma <code>Role</code> simples que permite que voc√™ obtenha a lista e o status dos pods e monitore-os no <code>target-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: target-namespace name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Um exemplo de <code>ClusterRole</code> , que permite obter uma lista e status dos pods e monitor√°-los em todo o cluster: <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: #  "namespace" ,   ClusterRole    name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Exemplo <code>RoleBinding</code> , que permite ao usu√°rio <code>mynewuser</code> "ler" pods no <code>my-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: read-pods namespace: target-namespace subjects: - kind: User name: mynewuser #     ! apiGroup: rbac.authorization.k8s.io roleRef: kind: Role #    ‚ÄúRole‚Äù  ‚ÄúClusterRole‚Äù name: pod-reader #  Role,      namespace, #   ClusterRole,   #    apiGroup: rbac.authorization.k8s.io</code> </pre> <br><h2>  Auditoria de Eventos </h2><br>  Esquematicamente, a arquitetura do Kubernetes pode ser representada da seguinte maneira: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/617/793/499/6177934998b4bf1c5c8816c75beaef3f.png" alt="imagem"><br><br>  O principal componente do Kubernetes, respons√°vel pelo processamento de solicita√ß√µes, √© <b>um servidor de API</b> .  Todas as opera√ß√µes no cluster passam por ele.  Leia mais sobre esses mecanismos internos no artigo ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que acontece no Kubernetes quando o kubectl run √© iniciado?</a>  " <br><br>  A auditoria do sistema √© um recurso interessante no Kubernetes, que est√° desativado por padr√£o.  Ele permite que voc√™ registre todas as chamadas na API do Kubernetes.  Como voc√™ pode adivinhar facilmente, por meio dessa API, todas as a√ß√µes relacionadas ao monitoramento e altera√ß√£o do estado do cluster s√£o executadas.  Uma boa descri√ß√£o de seus recursos pode (como de costume) ser encontrada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial do</a> K8s.  Em seguida, tentarei apresentar o t√≥pico em um idioma mais simples. <br><br>  Portanto, <b>para habilitar a auditoria</b> , precisamos passar tr√™s par√¢metros necess√°rios para o cont√™iner no servidor de API, mais sobre o que est√° descrito abaixo: <br><br><ul><li> <code>--audit-policy-file=/etc/kubernetes/policies/audit-policy.yaml</code> </li> <li> <code>--audit-log-path=/var/log/kube-audit/audit.log</code> </li> <li> <code>--audit-log-format=json</code> </li> </ul><br>  Al√©m desses tr√™s par√¢metros necess√°rios, h√° muitas configura√ß√µes adicionais relacionadas √† auditoria: da rota√ß√£o do log √†s descri√ß√µes de webhook.  Par√¢metros de rota√ß√£o de log de exemplo: <br><br><ul><li> <code>--audit-log-maxbackup=10</code> </li> <li> <code>--audit-log-maxsize=100</code> </li> <li> <code>--audit-log-maxage=7</code> </li> </ul><br>  Mas n√£o vamos nos aprofundar neles com mais detalhes - voc√™ pode encontrar todos os detalhes na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o do kube-apiserver</a> . <br><br>  Como j√° mencionado, todos os par√¢metros s√£o definidos no manifesto com a configura√ß√£o da api-server (por padr√£o <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ), na se√ß√£o de <code>command</code> .  Vamos voltar aos 3 par√¢metros necess√°rios e analis√°-los: <br><br><ol><li>  <code>audit-policy-file</code> - caminho para o arquivo YAML com a descri√ß√£o da pol√≠tica de auditoria.  Voltaremos ao seu conte√∫do, mas por enquanto observo que o arquivo deve estar acess√≠vel para leitura pelo processo da api-server.  Portanto, √© necess√°rio mont√°-lo dentro do cont√™iner, para o qual voc√™ pode adicionar o seguinte c√≥digo √†s se√ß√µes apropriadas da configura√ß√£o: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /etc/kubernetes/policies name: policies readOnly: true volumes: - hostPath: path: /etc/kubernetes/policies type: DirectoryOrCreate name: policies</code> </pre> </li><li>  <code>audit-log-path</code> - caminho para o arquivo de log.  O caminho tamb√©m deve estar acess√≠vel ao processo api-server, portanto, descrevemos de maneira semelhante sua montagem: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /var/log/kube-audit name: logs readOnly: false volumes: - hostPath: path: /var/log/kube-audit type: DirectoryOrCreate name: logs</code> </pre> </li><li>  <code>audit-log-format</code> - formato do log de auditoria.  Por padr√£o, esse √© <code>json</code> , mas o formato de texto herdado tamb√©m est√° dispon√≠vel. </li></ol><br><h3>  Pol√≠tica de auditoria </h3><br>  Agora, sobre o arquivo mencionado, com a descri√ß√£o da pol√≠tica de log.  O primeiro conceito de pol√≠tica de auditoria √© <code>level</code> , o <b>n√≠vel de log</b> .  Eles s√£o os seguintes: <br><br><ul><li>  <code>None</code> - n√£o fa√ßa logon; </li><li>  <code>Metadata</code> - metadados de solicita√ß√£o de log: usu√°rio, hora da solicita√ß√£o, recurso de destino (pod, espa√ßo para nome, etc.), tipo de a√ß√£o (verbo), etc; </li><li>  <code>Request</code> - metadados de log e corpo da solicita√ß√£o; </li><li>  <code>RequestResponse</code> - <code>RequestResponse</code> metadados, corpo da solicita√ß√£o e corpo da resposta. </li></ul><br>  Os dois √∫ltimos n√≠veis ( <code>Request</code> e <code>RequestResponse</code> ) n√£o registram solicita√ß√µes que n√£o <code>RequestResponse</code> recursos (chamadas para os chamados URLs sem recursos). <br><br>  Al√©m disso, todos os pedidos passam por <b>v√°rios est√°gios</b> : <br><br><ul><li>  <code>RequestReceived</code> - o est√°gio em que a solicita√ß√£o √© recebida pelo manipulador e ainda n√£o foi transferida ao longo da cadeia de manipuladores; </li><li>  <code>ResponseStarted</code> - cabe√ßalhos de resposta enviados, mas antes de enviar o corpo da resposta.  Gerado para consultas longas (por exemplo, <code>watch</code> ); </li><li>  <code>ResponseComplete</code> - corpo da resposta enviado, mais informa√ß√µes n√£o ser√£o enviadas; </li><li>  <code>Panic</code> - eventos s√£o gerados quando uma emerg√™ncia √© detectada. </li></ul><br>  Voc√™ pode usar <code>omitStages</code> para ignorar qualquer est√°gio. <br><br>  No arquivo de pol√≠ticas, podemos descrever v√°rias se√ß√µes com diferentes n√≠veis de log.  A primeira regra correspondente encontrada na descri√ß√£o da pol√≠tica ser√° aplicada. <br><br>  O daemon kubelet monitora a altera√ß√£o do manifesto com a configura√ß√£o da api-server e, se houver alguma, √© detectada, reinicia o cont√™iner com a api-server.  Mas h√° um detalhe importante: <b>eles ignoram as altera√ß√µes no arquivo de pol√≠ticas</b> .  Depois de fazer altera√ß√µes no arquivo de pol√≠ticas, voc√™ precisar√° reiniciar o api-server manualmente.  Como o api-server est√° sendo executado como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pod est√°tico</a> , o comando <code>kubectl delete</code> n√£o o reinicia.  Voc√™ precisar√° manualmente <code>docker stop</code> nos kube-masters nos quais a pol√≠tica de auditoria foi alterada: <br><br><pre> <code class="bash hljs">docker stop $(docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>)</code> </pre> <br>  Quando voc√™ ativa a auditoria, √© importante lembrar que o <b>kube-apiserver tem uma carga maior</b> .  Em particular, o consumo de mem√≥ria para armazenar o contexto de solicita√ß√µes est√° aumentando.  O registro inicia somente ap√≥s o envio do cabe√ßalho de resposta.  Al√©m disso, a carga depende da configura√ß√£o da pol√≠tica de auditoria. <br><br><h3>  Exemplos de pol√≠tica </h3><br>  Vamos analisar a estrutura dos arquivos de pol√≠ticas usando exemplos. <br><br>  Aqui est√° um arquivo de <code>policy</code> simples para registrar tudo no n√≠vel de <code>Metadata</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: Metadata</code> </pre> <br>  Voc√™ pode especificar uma lista de usu√°rios ( <code>Users</code> e <code>ServiceAccounts</code> ) e grupos de usu√°rios na pol√≠tica.  Por exemplo, √© assim que ignoraremos os usu√°rios do sistema, mas registramos tudo o mais no n√≠vel de <code>Request</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: None userGroups: - "system:serviceaccounts" - "system:nodes" users: - "system:anonymous" - "system:apiserver" - "system:kube-controller-manager" - "system:kube-scheduler" - level: Request</code> </pre> <br>  Tamb√©m √© poss√≠vel descrever o destino: <br><br><ul><li>  <code>namespaces</code> </li><li>  verbos ( <i>verbos</i> : <code>get</code> , <code>update</code> , <code>delete</code> e outros); </li><li>  recursos ( <i>recursos</i> , nomeadamente: <code>pod</code> , <code>configmaps</code> , etc.) e grupos de recursos ( <code>apiGroups</code> ). </li></ul><br>  <b>Preste aten√ß√£o!</b>  Recursos e grupos de recursos (grupos de API, ou seja, apiGroups), bem como suas vers√µes instaladas no cluster, podem ser obtidos usando os comandos: <br><br><pre> <code class="bash hljs">kubectl api-resources kubectl api-versions</code> </pre> <br>  A pol√≠tica de auditoria a seguir √© fornecida como uma demonstra√ß√£o das melhores pr√°ticas na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Alibaba Cloud</a> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1beta1 kind: Policy #    RequestReceived omitStages: - "RequestReceived" rules: #   ,     : - level: None users: ["system:kube-proxy"] verbs: ["watch"] resources: - group: "" #  api group   ,    #   Kubernetes,  ‚Äúcore‚Äù resources: ["endpoints", "services"] - level: None users: ["system:unsecured"] namespaces: ["kube-system"] verbs: ["get"] resources: - group: "" # core resources: ["configmaps"] - level: None users: ["kubelet"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None userGroups: ["system:nodes"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None users: - system:kube-controller-manager - system:kube-scheduler - system:serviceaccount:kube-system:endpoint-controller verbs: ["get", "update"] namespaces: ["kube-system"] resources: - group: "" # core resources: ["endpoints"] - level: None users: ["system:apiserver"] verbs: ["get"] resources: - group: "" # core resources: ["namespaces"] #     read-only URLs: - level: None nonResourceURLs: - /healthz* - /version - /swagger* #   ,     ‚Äú‚Äù: - level: None resources: - group: "" # core resources: ["events"] #   Secret, ConfigMap  TokenReview    , #         - level: Metadata resources: - group: "" # core resources: ["secrets", "configmaps"] - group: authentication.k8s.io resources: ["tokenreviews"] #   get, list  watch   ;    - level: Request verbs: ["get", "list", "watch"] resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #        API - level: RequestResponse resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #         - level: Metadata</code> </pre> <br><br>  Outro bom exemplo de pol√≠tica de auditoria √© o <a href="">perfil usado no GCE</a> . <br><br>  Para uma resposta r√°pida a eventos de auditoria, √© poss√≠vel <b>descrever um webhook</b> .  Esse problema √© divulgado na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> , deixarei de fora do escopo deste artigo. <br><br><h2>  Sum√°rio </h2><br>  O artigo fornece uma vis√£o geral dos mecanismos b√°sicos de seguran√ßa nos clusters do Kubernetes que permitem criar contas de usu√°rio personalizadas, compartilhar seus direitos e registrar suas a√ß√µes.  Espero que seja √∫til para aqueles que enfrentam essas quest√µes na teoria ou na pr√°tica.  Tamb√©m recomendo que voc√™ analise a lista de outros materiais sobre o t√≥pico de seguran√ßa no Kubernetes, listados no "PS" - talvez entre eles voc√™ encontre os detalhes necess√°rios sobre quest√µes relevantes para voc√™. <br><br><h2>  PS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">33+ Ferramentas de seguran√ßa Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o √†s pol√≠ticas de rede Kubernetes para profissionais de seguran√ßa</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Entendendo o RBAC no Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">9 melhores pr√°ticas de seguran√ßa na Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">11 maneiras de (n√£o) se tornar uma v√≠tima do Kubernetes Hacking</a> .‚Äù </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468679/">https://habr.com/ru/post/pt468679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468653/index.html">Qual √© a resolu√ß√£o do olho humano (ou quantos megapixels vemos em um determinado momento)</a></li>
<li><a href="../pt468657/index.html">Dan√ßas com apoio: tipos e formas de apoio. Sistemas de suporte trabalhando em batalha</a></li>
<li><a href="../pt468663/index.html">End2 End Approach em tarefas de reconhecimento autom√°tico de fala</a></li>
<li><a href="../pt468665/index.html">Mas √© hora de comprar um irrigador?</a></li>
<li><a href="../pt468677/index.html">O an√∫ncio do smartphone Xiaomi Mi Mix Alpha</a></li>
<li><a href="../pt468683/index.html">Teoria e pr√°tica da padroniza√ß√£o de servi√ßos Docker</a></li>
<li><a href="../pt468687/index.html">Analisamos as novas iniciativas do Banco Central para regular o mercado de a√ß√µes: 3 grupos de investidores, restri√ß√µes para iniciantes</a></li>
<li><a href="../pt468689/index.html">Registrando seu neg√≥cio de TI em Cingapura: o que devo fazer?</a></li>
<li><a href="../pt468691/index.html">Drivers perigosos de terceiros em seu sistema ou LOLDrivers</a></li>
<li><a href="../pt468693/index.html">Como a automa√ß√£o destr√≥i os funcion√°rios do Walmart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>