<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤾🏽 🧘🏻 👏🏾 蝙蝠鱼 引言 😐 🙏🏾 🏐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="现代网络的问题之一是它们的脆弱性。 许多过滤规则，路由信息交换策略，动态路由协议使网络混乱并受人为因素的影响。 更改路由映射或ACL（ 一个 ， 两个 ）时，可能会无意中发生网络崩溃。 我们绝对缺少在更改生产之前使用新配置评估网络行为的工具。 我想确定是否可以过滤掉从提供商B收到的一些BGP公告，网...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>蝙蝠鱼 引言</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441532/"><img src="https://habrastorage.org/webt/tm/-b/yz/tm-byzhobce3it0kku80cuyttny.png" alt="图片"><br><br> 现代网络的问题之一是它们的脆弱性。 许多过滤规则，路由信息交换策略，动态路由协议使网络混乱并受人为因素的影响。 更改路由映射或ACL（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">两个</a> ）时，可能会无意中发生网络崩溃。 我们绝对缺少在更改生产之前使用新配置评估网络行为的工具。 我想确定是否可以过滤掉从提供商B收到的一些BGP公告，网络A是否对我可用？ 如果在其中一个传输链路上将IGP度量加倍，数据包将从网络C到达服务器D的路由是什么？  Batfish将帮助我们回答这些以及许多其他问题！ <br><a name="habracut"></a><br><h2> 蝙蝠鱼的评论 </h2><br>  Batfish是网络建模工具。 其主要目的是在将配置更改引入生产网络之前对其进行测试。  Batfish还可以用于分析和检查网络的当前状态。 网络世界中现有的CI / CD流程显然缺少测试新配置的工具。  Batfish解决了这个问题。 <br><br>  Batfish不需要直接直接访问现有的网络设备，Batfish根据设备配置文件中包含的数据对网络行为进行建模。 <br><br>  Batfish可以： <br><br><ul><li> 确定网络中动态路由协议（BGP，IS-IS，OSPF）的邻居状态 </li><li> 计算每个网元的RIB </li><li> 检查NTP，AAA，MTU设置 </li><li> 允许确定ACL是否阻止网络流量通过（Cisco ASA上的Packet-tracer模拟） </li><li> 检查网络内主机之间的端到端连接 </li><li> 显示通过网络的流量路径（虚拟跟踪） </li></ul><br><br> 支持平台： <br><br><ul><li> 阿里斯塔 </li><li> 阿鲁巴岛 </li><li>  AWS（VPC，网络ACL，VPN GW，NAT GW，Internet GW，安全组） </li><li> 思科（NX-OS，IOS，IOS-XE，IOS-XR和ASA） </li><li> 戴尔force10 </li><li> 铸造厂 </li><li>  iptables </li><li> 瞻博网络（MX，EX，QFX，SRX，T系列，PTX） </li><li>  v </li><li> 帕洛阿尔托网络 </li><li>  Quagga / FRR </li><li> 广达 </li><li> 维约斯 </li></ul><br><img src="https://habrastorage.org/webt/p_/ai/gt/p_aigtayir28gmvf6yxdhec7vkm.png" alt="图片"><br><br>  Batfish是Java应用程序。 为了方便使用，编写了Pybatfish-python SDK。 <br><br> 让我们继续练习。 我将通过示例向您展示蝙蝠鱼的可能性。 <br><br><h2> 例子 </h2><br> 我们管理两个自治系统：AS 41214和AS10631。作为IGP，AS-41214使用IS-IS，而AS-10631-OSPF。 在每个AS内，都使用IBGP-fullmesh。  LDN-CORE-01宣布其BGP邻居前缀135.65.0.0/19,MSK-CORE-01-140.0.0.0/24。 自治系统之间的路由信息​​交换发生在HKI-CORE-01-SPB-CORE-01的交界处。 <br><br>  <b>HKI-CORE-01，STH-CORE-01</b> -Junos路由器 <br>  <b>LDN-CORE-01，AMS-CORE-01，SPB-CORE-01，MSK-CORE-01</b> -Cisco IOS路由器 <br><br> <a href=""><img src="https://habrastorage.org/webt/oc/a6/xv/oca6xv1rrtbzkou8autoshzlfte.png"></a> <br><br> 使用Batfish和python SDK安装容器： <br><br><pre><code class="bash hljs">docker pull batfish/allinone docker run batfish/allinone docker container <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it &lt;container&gt; bash</code> </pre> <br> 通过python交互模式了解该库： <br><br><pre> <code class="bash hljs">root@ea9a1559d88e:/<span class="hljs-comment"><span class="hljs-comment"># python3 -------------------- &gt;&gt;&gt; from pybatfish.client.commands import bf_logger, bf_init_snapshot &gt;&gt;&gt; from pybatfish.question.question import load_questions &gt;&gt;&gt; from pybatfish.question import bfq &gt;&gt;&gt; import logging &gt;&gt;&gt; bf_logger.setLevel(logging.ERROR) &gt;&gt;&gt; load_questions() &gt;&gt;&gt; bf_init_snapshot('tmp/habr') 'ss_e8065858-a911-4f8a-b020-49c9b96d0381'</span></span></code> </pre> <br>  <b>bf_init_snapshot（'tmp / habr'）</b> -该函数将配置文件加载到Batfish中并准备进行分析。 <br><br>  <b>/ tmp / habr-</b>包含路由器配置文件的目录。 <br><br><pre> <code class="bash hljs">root@ea9a1559d88e:/tmp/habr<span class="hljs-comment"><span class="hljs-comment"># tree . `-- configs |-- AMS-CORE-01.cfg |-- HKI-CORE-01.cfg |-- LDN-CORE-01.cfg |-- MSK-CORE-01.cfg |-- SPB-CORE-01.cfg `-- STH-CORE-01.cfg 1 directory, 6 files</span></span></code> </pre> <br> 现在，让我们确定LDN-CORE-01路由器上BGP会话的状态： <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; bgp_peers = bfq.bgpSessionStatus(nodes=<span class="hljs-string"><span class="hljs-string">'LDN-CORE-01'</span></span>).answer().frame() &gt;&gt;&gt; bgp_peers Node VRF Local_AS Local_IP Remote_AS Remote_Node Remote_IP Session_Type Est_Status 0 ldn-core-01 default 41214 172.20.20.1 41214 sth-core-01 172.20.20.2 IBGP EST 1 ldn-core-01 default 41214 172.20.20.1 41214 ams-core-01 172.20.20.3 IBGP EST 2 ldn-core-01 default 41214 172.20.20.1 41214 hki-core-01 172.20.20.4 IBGP EST</code> </pre><br> 好吧？ 听起来像事实吗？ <br><br><pre> <code class="bash hljs">LDN-CORE-01<span class="hljs-comment"><span class="hljs-comment">#show ip bgp summary … Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd 172.20.20.2 4 41214 629 669 9 0 0 00:56:51 0 172.20.20.3 4 41214 826 827 9 0 0 01:10:18 0 172.20.20.4 4 41214 547 583 9 0 0 00:49:24 1</span></span></code> </pre><br> 现在，根据蝙蝠鱼，我们来看一下HKI-CORE-01路由器上RIB中的IS-IS路由： <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; isis_routes = bfq.routes(nodes=<span class="hljs-string"><span class="hljs-string">'HKI-CORE-01'</span></span>, protocols=<span class="hljs-string"><span class="hljs-string">'isis'</span></span>).answer().frame() &gt;&gt;&gt; isis_routes Node VRF Network Next_Hop Next_Hop_IP Protocol Admin_Distance Metric Tag 0 hki-core-01 default 172.20.20.3/32 ams-core-01 10.0.0.6 isisL2 18 20 None 1 hki-core-01 default 172.20.20.1/32 ams-core-01 10.0.0.6 isisL2 18 30 None 2 hki-core-01 default 172.20.20.2/32 sth-core-01 10.0.0.4 isisL2 18 10 None 3 hki-core-01 default 172.20.20.1/32 sth-core-01 10.0.0.4 isisL2 18 30 None 4 hki-core-01 default 10.0.0.0/31 sth-core-01 10.0.0.4 isisL2 18 20 None 5 hki-core-01 default 10.0.0.2/31 ams-core-01 10.0.0.6 isisL2 18 20 None</code> </pre><br> 在命令行中： <br><br><pre> <code class="bash hljs">showroute@HKI-CORE-01<span class="hljs-comment"><span class="hljs-comment"># run show route table inet.0 protocol isis inet.0: 18 destinations, 18 routes (18 active, 0 holddown, 0 hidden) + = Active Route, - = Last Active, * = Both 10.0.0.0/31 *[IS-IS/18] 00:51:25, metric 20 &gt; to 10.0.0.4 via ge-0/0/0.0 10.0.0.2/31 *[IS-IS/18] 00:51:45, metric 20 &gt; to 10.0.0.6 via ge-0/0/1.0 172.20.20.1/32 *[IS-IS/18] 00:51:25, metric 30 to 10.0.0.4 via ge-0/0/0.0 &gt; to 10.0.0.6 via ge-0/0/1.0 172.20.20.2/32 *[IS-IS/18] 00:51:25, metric 10 &gt; to 10.0.0.4 via ge-0/0/0.0 172.20.20.3/32 *[IS-IS/18] 00:51:45, metric 20 &gt; to 10.0.0.6 via ge-0/0/1.0</span></span></code> </pre><br> 太好了！ 我想您已经清楚有蝙蝠鱼了。 <br><br> 在本文的开头，我写道，Batfish可用于在使配置进入“战斗”网络之前检查配置更改。 现在，我建议考虑基于<b>RobotFramework</b>的网络测试过程。 为此，我编写了一个基于PyBatfish的小模块，该模块可让您执行以下检查： <br><br><ul><li> 确定网络上BGP会话的状态 </li><li> 确定IS-IS邻居状态 </li><li> 通过跟踪演示检查网络上节点之间的端到端连接性 </li><li> 确定路由器上特定动态路由协议的RIB大小 </li></ul><br><div class="spoiler">  <b class="spoiler_title">LibraryBatfish.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pybatfish.client.commands <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bf_logger, bf_init_snapshot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pybatfish.question.question <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_questions, list_questions <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pybatfish.question <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bfq <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pybatfish.datamodel.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HeaderConstraints, PathConstraints <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> robot.api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logger <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LibraryBatfish</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, snapshot)</span></span></span><span class="hljs-function">:</span></span> bf_logger.setLevel(logging.ERROR) load_questions() bf_init_snapshot(snapshot) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_bgp_peers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> not_established_peers = list() bgp_peers = bfq.bgpSessionStatus().answer() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> peer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bgp_peers.rows: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> peer.get(<span class="hljs-string"><span class="hljs-string">'Established_Status'</span></span>) != <span class="hljs-string"><span class="hljs-string">'ESTABLISHED'</span></span>: not_established_peers.append(dict.fromkeys(peer.get(<span class="hljs-string"><span class="hljs-string">'Local_IP'</span></span>).split(), peer.get(<span class="hljs-string"><span class="hljs-string">'Remote_IP'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'value'</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(not_established_peers) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: logger.warn(<span class="hljs-string"><span class="hljs-string">'BGP neighbors are not in an established state:'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> neighborship <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> not_established_peers: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> peer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> neighborship: logger.warn(<span class="hljs-string"><span class="hljs-string">'{} - {}'</span></span>.format(peer, neighborship.get(peer))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_routes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, node, protocol)</span></span></span><span class="hljs-function">:</span></span> routes = bfq.routes(nodes=node, protocols=protocol).answer() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len(routes.rows) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_isis_neighbors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, description)</span></span></span><span class="hljs-function">:</span></span> not_isis_enabled_links = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._get_isis_enabled_links(description): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._get_isis_neighbors(): not_isis_enabled_links.append(link) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(not_isis_enabled_links) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> not_isis_enabled_links: logger.warn(<span class="hljs-string"><span class="hljs-string">'{} {} has no IS-IS neighbor'</span></span>.format(link.get(<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>), link.get(<span class="hljs-string"><span class="hljs-string">'interface'</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ping</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, source_ip, destination_ip)</span></span></span><span class="hljs-function">:</span></span> ip_owners = bfq.ipOwners().answer() traceroute = self._get_traceroute_status(source_ip, destination_ip, ip_owners) reverse_traceroute = self._get_traceroute_status(destination_ip, source_ip, ip_owners) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> traceroute == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> reverse_traceroute == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: self._show_trace(source_ip, destination_ip, ip_owners) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: logger.warn(<span class="hljs-string"><span class="hljs-string">'Ping {} -&gt; {} failed'</span></span>.format(source_ip, destination_ip)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_traceroute_status</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, source_ip, destination_ip, addresses)</span></span></span><span class="hljs-function">:</span></span> tracert = self._unidirectional_virtual_traceroute(source_ip, destination_ip, addresses) isAccepted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tracert != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> trace <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tracert.rows[<span class="hljs-number"><span class="hljs-number">0</span></span>].get(<span class="hljs-string"><span class="hljs-string">'Traces'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> trace.get(<span class="hljs-string"><span class="hljs-string">'disposition'</span></span>) != <span class="hljs-string"><span class="hljs-string">'ACCEPTED'</span></span>: isAccepted = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isAccepted == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_paths</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, source_ip, destination_ip, addresses)</span></span></span><span class="hljs-function">:</span></span> tracert = self._unidirectional_virtual_traceroute(source_ip, destination_ip, addresses) traces = tracert.rows[<span class="hljs-number"><span class="hljs-number">0</span></span>].get(<span class="hljs-string"><span class="hljs-string">'Traces'</span></span>) paths = dict() path_number = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> trace <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> traces: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> trace.get(<span class="hljs-string"><span class="hljs-string">'disposition'</span></span>) == <span class="hljs-string"><span class="hljs-string">'ACCEPTED'</span></span>: path = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hop <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> trace.get(<span class="hljs-string"><span class="hljs-string">'hops'</span></span>): path.append(hop.get(<span class="hljs-string"><span class="hljs-string">'node'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>)) paths[path_number] = path path_number += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> paths <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_unidirectional_virtual_traceroute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, source_ip, destination_ip, addresses)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> address <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> addresses.rows: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address.get(<span class="hljs-string"><span class="hljs-string">'IP'</span></span>) == source_ip: node = address.get(<span class="hljs-string"><span class="hljs-string">'Node'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>) int = address.get(<span class="hljs-string"><span class="hljs-string">'Interface'</span></span>) headers = HeaderConstraints(srcIps=source_ip, dstIps=destination_ip, ipProtocols=[<span class="hljs-string"><span class="hljs-string">'ICMP'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: tracert = bfq.traceroute(startLocation=<span class="hljs-string"><span class="hljs-string">"{}[{}]"</span></span>.format(node,int), headers=headers).answer() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tracert <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: logger.warn(<span class="hljs-string"><span class="hljs-string">'{} address has not been found'</span></span>.format(source_ip)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_isis_enabled_links</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, description=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'core-link'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> isis_enabled_links = list() interfaces = bfq.interfaceProperties().answer() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> int <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> interfaces.rows: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int.get(<span class="hljs-string"><span class="hljs-string">'Description'</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> description <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> int.get(<span class="hljs-string"><span class="hljs-string">'Description'</span></span>): isis_enabled_links.append({<span class="hljs-string"><span class="hljs-string">'hostname'</span></span> : int.get(<span class="hljs-string"><span class="hljs-string">'Interface'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>), <span class="hljs-string"><span class="hljs-string">'interface'</span></span> : int.get(<span class="hljs-string"><span class="hljs-string">'Interface'</span></span>).get(<span class="hljs-string"><span class="hljs-string">'interface'</span></span>)}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isis_enabled_links <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_isis_neighbors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> isis_neighbors = list() isis_adjacencies = bfq.edges(edgeType=<span class="hljs-string"><span class="hljs-string">'isis'</span></span>).answer() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> neighbor <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> isis_adjacencies.rows: isis_neighbors.append(neighbor.get(<span class="hljs-string"><span class="hljs-string">'Interface'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isis_neighbors <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_show_trace</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, source_ip, destination_ip, addresses)</span></span></span><span class="hljs-function">:</span></span> logger.console(<span class="hljs-string"><span class="hljs-string">'\nTraceroute to {} from {}'</span></span>.format(destination_ip, source_ip)) paths = self._get_paths(source_ip, destination_ip, addresses) path_num = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> paths: n = <span class="hljs-number"><span class="hljs-number">1</span></span> logger.console(<span class="hljs-string"><span class="hljs-string">'\n Path N{}'</span></span>.format(path_num)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hop <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> paths.get(path): logger.console(<span class="hljs-string"><span class="hljs-string">' {} {}'</span></span>.format(n, hop)) n += <span class="hljs-number"><span class="hljs-number">1</span></span> path_num += <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">蝙蝠鱼测试机器人</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j8/fe/dt/j8fedtxnppjoyed3l4mkvgijmgw.png" alt="图片"><br></div></div><br><h2> 场景N1 </h2><br> <a href=""><img src="https://habrastorage.org/webt/oc/a6/xv/oca6xv1rrtbzkou8autoshzlfte.png"></a> <br><br> 在我的控制之下，仍然是同一个网络。 假设我需要对<b>AS 41214</b>和<b>AS 10631</b>的边界上的过滤器进行<b>排序</b> ，并阻塞包含BOGONS范围中的源或目标ip地址的结点数据包。 <br><br> 进行更改之前，请运行测试。 <br><br><img src="https://habrastorage.org/webt/83/7m/ev/837mevcx8y6uqg_ydag7giziw3y.png" alt="图片"><br><br> 测试通过。 <br><br> 我们将更改<b>HKI-CORE-01</b>路由器的测试配置-/tmp/habr/configs/ <b>HKI-CORE-</b> 01.cfg： <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 0.0.0.0/8 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 10.0.0.0/8 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 100.64.0.0/10 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 127.0.0.0/8 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 169.254.0.0/16 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 172.16.0.0/12 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 192.0.2.0/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 192.88.99.0/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 192.168.0.0/16 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 198.18.0.0/15 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 198.51.100.0/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 203.0.113.0/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 224.0.0.0/4 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 from address 240.0.0.0/4 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM010 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term PERMIT-IP-ANY-ANY <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> accept <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces ge-0/0/2.0 family inet filter input BOGONS <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces ge-0/0/2.0 family inet filter output BOGONS</code> </pre><br> 运行测试。 <br><br><img src="https://habrastorage.org/webt/ef/y_/gn/efy_gnibn9qy2sbfxyiq_iysft0.png"><br><br> 我非常接近，但是如测试输出所示，在进行BGP更改之后，邻居192.168.30.0-192.168.30.1不在“已建立”状态-&gt;结果是，点135.65.0.1 &lt;-&gt; 140.0.0.1之间的IP连接丢失了。 怎么了 我们仔细查看了<b>HKI-CORE-01</b>配置，并看到在专用地址上安装了eBGP对等连接： <br><br><pre> <code class="bash hljs">showroute@HKI-CORE-01<span class="hljs-comment"><span class="hljs-comment"># show interfaces ge-0/0/2 | display set set interfaces ge-0/0/2 description SPB-CORE-01 set interfaces ge-0/0/2 unit 0 family inet filter input BOGONS set interfaces ge-0/0/2 unit 0 family inet filter output BOGONS set interfaces ge-0/0/2 unit 0 family inet address 192.168.30.0/31</span></span></code> </pre><br> 结论：有必要更改结点的地址或将192.168.30.0/31子网添加到异常中。 <br><br> 我将在例外处的交界处添加一个网络，我将再次更新/tmp/habr/configs/HKI-CORE-01.cfg： <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM005 from address 192.168.0.0/31 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall family inet filter BOGONS term TERM005 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> accept</code> </pre><br> 运行测试。 <br><br><img src="https://habrastorage.org/webt/83/7m/ev/837mevcx8y6uqg_ydag7giziw3y.png"><br><br> 现在，不需要的流量将不再通过ebgp接口AS 41214-AS10631。您可以安全地进行更改，而不必担心后果。 <br><br><h2> 场景N2 </h2><br> <a href=""><img src="https://habrastorage.org/webt/zk/zy/aw/zkzyawxfphcnrmi2dsrd2xyz2ik.png"></a> <br><br> 在这里，我需要终止<b>MSK-CORE-01</b>路由器上的网络150.0.0.0/24，并确保点135.65.0.1和150.0.0.1之间的连接 <br><br> 我在MSK-CORE-01路由器的测试配置中添加了以下几行-tmp / habr / configs / MSK-CORE-01.cfg： <br><br><pre> <code class="bash hljs">interface Loopback2 ip address 150.0.0.1 255.255.255.255 ! ip route 150.0.0.0 255.255.255.0 Null0 ! router bgp 10631 ! address-family ipv4 network 150.0.0.0 mask 255.255.255.0 !</code> </pre><br> 我更改测试脚本并运行测试： <br><br><pre> <code class="bash hljs">git diff HEAD~ diff --git a/batfish-robot.robot b/batfish-robot.robot index 8d963c5..ce8cb6a 100644 --- a/batfish-robot.robot +++ b/batfish-robot.robot @@ -5,7 +5,7 @@ Library LibraryBatfish.py tmp/habr <span class="hljs-variable"><span class="hljs-variable">${ISIS-ENABLED-LINK-DESCRIPTION}</span></span> ISIS-LINK <span class="hljs-variable"><span class="hljs-variable">${NODE}</span></span> HKI-CORE-01 <span class="hljs-variable"><span class="hljs-variable">${PROTOCOL}</span></span> ebgp -<span class="hljs-variable"><span class="hljs-variable">${RIB-SIZE}</span></span> 1 +<span class="hljs-variable"><span class="hljs-variable">${RIB-SIZE}</span></span> 2 *** Test Cases *** ISIS @@ -27,3 +27,8 @@ Ping [Documentation] Test end-to-end ICMP connectivity &amp; show traceroute <span class="hljs-variable"><span class="hljs-variable">${result}</span></span>= Ping 135.65.0.1 140.0.0.1 Should Be Equal As Integers <span class="hljs-variable"><span class="hljs-variable">${result}</span></span> 1 + +Ping2 + [Documentation] Test end-to-end ICMP connectivity &amp; show traceroute + <span class="hljs-variable"><span class="hljs-variable">${result}</span></span>= Ping 135.65.0.1 150.0.0.1 + Should Be Equal As Integers <span class="hljs-variable"><span class="hljs-variable">${result}</span></span> 1</code> </pre><br>  <i>现在，我希望在HKI-CORE-01路由器上看到两条eBGP路由，添加了额外的连接检查</i> <br><br><img src="https://habrastorage.org/webt/0m/lo/1a/0mlo1aaedcfzwisajf7mz34mvai.png"><br><br>  135.65.0.1和150.0.0.1之间没有连接，而且<b>HKI-CORE-01</b>路由器只有一条eBGP路由，而不是两条。 <br><br> 在向<b>MSK-CORE-01</b>路由器添加新配置时，请检查<b>HKI-CORE-01</b>上RIB的内容： <br><br><pre> <code class="bash hljs">showroute@HKI-CORE-01<span class="hljs-comment"><span class="hljs-comment"># run show route table inet.0 protocol bgp inet.0: 20 destinations, 20 routes (19 active, 0 holddown, 1 hidden) + = Active Route, - = Last Active, * = Both 135.65.0.0/19 *[BGP/170] 02:25:38, MED 0, localpref 100, from 172.20.20.1 AS path: I, validation-state: unverified &gt; to 10.0.0.4 via ge-0/0/0.0 to 10.0.0.6 via ge-0/0/1.0 140.0.0.0/24 *[BGP/170] 01:38:02, localpref 100 AS path: 10631 I, validation-state: unverified &gt; to 192.168.30.1 via ge-0/0/2.0 showroute@HKI-CORE-01# run show route table inet.0 protocol bgp hidden detail inet.0: 20 destinations, 20 routes (19 active, 0 holddown, 1 hidden) 150.0.0.0/24 (1 entry, 0 announced) BGP /-101 Next hop type: Router, Next hop index: 563 Address: 0x940f43c Next-hop reference count: 4 Source: 192.168.30.1 Next hop: 192.168.30.1 via ge-0/0/2.0, selected Session Id: 0x9 State: &lt;Hidden Ext&gt; Local AS: 41214 Peer AS: 10631 Age: 1:42:03 Validation State: unverified Task: BGP_10631.192.168.30.1+179 AS path: 10631 I Localpref: 100 Router ID: 10.68.1.1 Hidden reason: rejected by import policy</span></span></code> </pre><br> 请注意从<b>SPB-CORE-01</b>收到的前缀的导入策略： <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols bgp group AS10631 import FROM-AS10631 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols bgp group AS10631 neighbor 192.168.30.1 description SPB-CORE-01 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols bgp group AS10631 neighbor 192.168.30.1 peer-as 10631 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement FROM-AS10631 term TERM010 from route-filter 140.0.0.0/24 exact <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement FROM-AS10631 term TERM010 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> accept <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement FROM-AS10631 term DENY <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> reject</code> </pre><br> 缺少150.0.0.0/24的规则。 将其添加到测试配置并运行测试： <br><br><pre> <code class="bash hljs">showroute@HKI-CORE-01<span class="hljs-comment"><span class="hljs-comment"># show | compare [edit policy-options policy-statement FROM-AS10631 term TERM010 from] route-filter 140.0.0.0/24 exact { ... } + route-filter 150.0.0.0/24 exact; [edit]</span></span></code> </pre><br><img src="https://habrastorage.org/webt/1j/yu/xk/1jyuxk-xbg4zvwcraua6o0p9hwm.png"><br><br> 太好了，网络之间存在连通性，所有测试都通过了！ 因此，您可以对“战斗”网络的工作进行这些更改。 <br><br><h2> 结论 </h2><br> 在我看来，Batfish是具有巨大潜力的强大工具。 试试看，自己看看。 <br><br> 如果您对这个主题感兴趣-加入闲聊，Batfish开发人员将很乐意回答任何问题并快速修复错误。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">batfish-org.slack.com</a> <br><br> 谢谢您的关注。 <br><br><h2> 参考文献 </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.batfish.org</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.youtube.com/channel/UCA-OUW_3IOt9U_s60KvmJYA</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/batfish/batfish</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">media.readthedocs.org/pdf/pybatfish/latest/pybatfish.pdf</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/showroute/batfish-habr</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441532/">https://habr.com/ru/post/zh-CN441532/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441522/index.html">287号移动开发人员的有趣材料摘要（2月18日至2月24日）</a></li>
<li><a href="../zh-CN441524/index.html">最新研究结果：骨髓移植可延缓衰老</a></li>
<li><a href="../zh-CN441526/index.html">比特币价值的因素</a></li>
<li><a href="../zh-CN441528/index.html">我的生活如何变成一本卡夫卡书</a></li>
<li><a href="../zh-CN441530/index.html">SDN将进入太空：为什么需要这样做</a></li>
<li><a href="../zh-CN441534/index.html">编排系统的负载均衡器</a></li>
<li><a href="../zh-CN441536/index.html">各种SIMD</a></li>
<li><a href="../zh-CN441538/index.html">数据仓库架构：传统和云</a></li>
<li><a href="../zh-CN441540/index.html">Vue mixins，显式方式（通过BEM修饰符插件示例）</a></li>
<li><a href="../zh-CN441546/index.html">“ Hayabusa-2”首次碰到小行星</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>