<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ≥Ô∏è üíß üçú .NET Core no Linux, DevOps a cavalo üöè üßñ ‚è©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Desenvolvemos o DevOps como pudemos. √âramos 8 e Vasya era o mais legal do Windows. De repente, Vasya saiu e eu tive a tarefa de lan√ßar um novo projeto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>.NET Core no Linux, DevOps a cavalo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/448496/">  Desenvolvemos o DevOps como pudemos.  √âramos 8 e Vasya era o mais legal do Windows.  De repente, Vasya saiu e eu tive a tarefa de lan√ßar um novo projeto que fornece desenvolvimento para Windows.  Quando joguei toda a pilha de desenvolvimento do Windows na mesa, percebi que a situa√ß√£o √© uma dor ... <br><br>  Assim come√ßa a hist√≥ria de <b>Alexander Sinchinov</b> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevOpsConf</a> .  Quando o principal especialista em Windows deixou a empresa, Alexander se perguntou o que fazer agora.  Mude para o Linux, √© claro!  Alexander contar√° como ele conseguiu definir um precedente e transferir parte do desenvolvimento do Windows para o Linux usando o exemplo de um projeto conclu√≠do para 100.000 usu√°rios finais. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/e76/321/dcde7632138481f5c01f851d9af8e2e2.png"><br><br>  Como entregar um projeto ao RPM com facilidade e sem esfor√ßo usando o TFS, Puppet, Linux .NET core?  Como manter o controle de vers√£o do banco de dados do projeto se o desenvolvimento ouvir primeiro as palavras Postgres e Flyway e o prazo depois de amanh√£?  Como se integrar ao Docker?  Como motivar os desenvolvedores .NET a abandonar o Windows e os smoothies em favor do Puppet e Linux?  Como resolver conflitos ideol√≥gicos, se n√£o h√° for√ßas, desejo ou recursos para servir o Windows em produ√ß√£o?  Sobre isso, bem como sobre o Web Deploy, testes, IC, sobre as pr√°ticas de uso do TFS em projetos existentes e, √© claro, sobre muletas quebradas e solu√ß√µes de trabalho, na decodifica√ß√£o do relat√≥rio de Alexander. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/tZH9Ro9j9KQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Ent√£o, Vasya saiu, a tarefa √© para mim, os desenvolvedores est√£o ansiosos <s>com um forcado</s> .  Quando finalmente percebi que Vasya n√£o podia ser devolvida, comecei a trabalhar.  Para come√ßar, estimei a porcentagem de Win VM em nosso parque.  A pontua√ß√£o n√£o foi a favor do Windows. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/3d8/061/fa73d80617e31117f8c2575cc747a17b.png"><br><br>  Como estamos desenvolvendo ativamente o DevOps, percebi que algo precisa ser mudado na abordagem de remover um novo aplicativo.  A solu√ß√£o foi uma - se poss√≠vel, transfira tudo para o Linux.  O Google me ajudou - naquela √©poca .Net j√° estava portado para Linux, e eu percebi que essa solu√ß√£o! <br><br><h2>  Por que o .NET core √© fornecido com o Linux? </h2><br>  Havia v√°rias raz√µes para isso.  Entre "pagar dinheiro" e "n√£o pagar", a maioria escolher√° o segundo - como eu.  Uma licen√ßa para MSDB custa cerca de US $ 1.000; a manuten√ß√£o de uma frota de m√°quinas virtuais Windows custa centenas de d√≥lares.  Para uma grande empresa, essa √© uma grande despesa.  Portanto, <b>salvar</b> √© o <b>primeiro motivo</b> .  N√£o √© o mais importante, mas um dos mais significativos. <br><br>  As m√°quinas virtuais Windows ocupam mais recursos do que seus irm√£os Linux - <b>elas s√£o pesadas</b> .  Dada a escala de uma grande empresa, escolhemos o Linux. <br><br>  <b>O sistema √© simplesmente integrado ao IC existente</b> .  N√≥s nos consideramos DevOps progressivos, usamos Bamboo, Jenkins e GitLab CI, portanto, a maior parte do nosso trabalho √© no Linux. <br><br>  O √∫ltimo motivo √© <b>uma escolta conveniente.</b>  Tivemos que diminuir o limite de entrada para "acompanhantes" - pessoas que entendem a parte t√©cnica, garantem servi√ßos ininterruptos de opera√ß√£o e servi√ßo a partir da segunda linha.  Eles j√° estavam familiarizados com a pilha do Linux, portanto, √© muito mais f√°cil para eles entender o novo produto, manter e manter, do que gastar recursos adicionais para lidar com a funcionalidade semelhante do software para a plataforma Windows. <br><br><h2>  Exig√™ncias </h2><br>  Em primeiro lugar, a <b>conveni√™ncia de uma nova solu√ß√£o para desenvolvedores</b> .  Nem todos estavam prontos para a mudan√ßa, especialmente ap√≥s a palavra falada Linux.  Os desenvolvedores querem o seu amado Visual Studio, TFS, com testes de constru√ß√£o e smoothies.  Como a entrega ocorre na produ√ß√£o - eles n√£o se importam.  Portanto, decidimos n√£o alterar o processo usual e deixar tudo inalterado para o desenvolvimento do Windows. <br><br>  O novo projeto precisa ser <b>incorporado no IC existente</b> .  Os trilhos j√° estavam l√° e todo o trabalho teve que ser feito levando em considera√ß√£o os par√¢metros do sistema de gerenciamento de configura√ß√£o, padr√µes de entrega aceitos e sistemas de monitoramento. <br><br>  <b>Simplicidade no suporte e opera√ß√£o</b> , como condi√ß√£o para um limite m√≠nimo de entrada para todos os novos participantes de diferentes departamentos e departamentos de suporte. <br><br>  <b>Prazo - ontem</b> . <br><br><h2>  Win Development Group </h2><br>  Com o que a equipe do Windows trabalhou ent√£o? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/527/4b9/5e9/5274b95e93a6d270259487b5c68ca600.png"><br><br>  Agora, posso dizer com seguran√ßa que o <b>IdentityServer4</b> √© uma alternativa gratuita gratuita ao ADFS com recursos semelhantes ou que o <b>Entity Framework Core</b> √© o para√≠so dos desenvolvedores, onde voc√™ n√£o pode se preocupar em escrever scripts SQL, mas descreve as consultas no banco de dados em termos OOP.  Mas ent√£o, ao discutir o plano de a√ß√£o, olhei para essa pilha como uma escrita cuneiforme sum√©ria, reconhecendo apenas o PostgreSQL e o Git. <br><br>  Naquela √©poca, usamos o <b>Puppet</b> ativamente como um sistema de gerenciamento de configura√ß√£o.  Na maioria dos nossos projetos, usamos <b>GitLab CI</b> , <b>Elastic</b> , servi√ßos altamente carregados e balanceados usando <b>HAProxy,</b> monitoramos tudo com o <b>Zabbix</b> , <b>v√°rios Grafana</b> e <b>Prometheus</b> , <b>Jaeger</b> , e tudo isso girava no hardware da <b>HP</b> com <b>ESXi</b> no <b>VMware</b> .  Todo mundo sabe - um cl√°ssico do g√™nero. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffb/768/38f/ffb76838f0538bd215bc5a54d5e005ad.png"><br><br>  Vamos ver e tentar entender o que aconteceu antes de iniciarmos todas essas interven√ß√µes. <br><br><h2>  O que foi </h2><br>  O TFS √© um sistema bastante poderoso que n√£o apenas fornece c√≥digo do desenvolvedor para a m√°quina de produ√ß√£o final, mas tamb√©m possui um conjunto de integra√ß√£o muito flex√≠vel com v√°rios servi√ßos - para fornecer CI no n√≠vel de plataforma cruzada. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9b7/9a3/146/9b79a3146abb65be1c4dad29ad50e406.png"><br>  Anteriormente, essas eram janelas s√≥lidas.  O TFS usou v√°rios agentes de Compila√ß√£o, que reuniram muitos projetos.  Cada agente possui de 3 a 4 trabalhadores-a para paralelizar tarefas e otimizar o processo.  Al√©m disso, de acordo com os planos de lan√ßamento, o TFS entregou o Build rec√©m-instalado no servidor de aplicativos do Windows. <br><br><h2>  O que quer√≠amos chegar </h2><br>  Para entrega e desenvolvimento, usamos o TFS e lan√ßamos o aplicativo no servidor de aplicativos Linux, e h√° algum tipo de m√°gica entre eles.  Esta <b>Caixa M√°gica</b> √© o sal do pr√≥ximo trabalho.  Antes de desmont√°-lo em partes, darei um passo para o lado e direi duas palavras sobre o aplicativo. <br><br><h2>  Projeto </h2><br>  O aplicativo fornece funcionalidade para lidar com cart√µes pr√©-pagos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c2/3be/4cc/4c23be4cce98ad3b48de986826817c19.png"><br><br><h3>  Cliente </h3><br>  Havia dois tipos de usu√°rios.  <b>O primeiro</b> obteve acesso efetuando login com o certificado SSL SHA-2.  O <b>segundo</b> teve acesso por login e senha. <br><br><h3>  HAProxy </h3><br>  Al√©m disso, a solicita√ß√£o do cliente caiu no HAProxy, que resolveu as seguintes tarefas: <br><br><ul><li>  autoriza√ß√£o prim√°ria; <br></li><li>  Termina√ß√£o SSL <br></li><li>  ajuste de solicita√ß√µes HTTP; <br></li><li>  solicita√ß√µes de transmiss√£o. <br></li></ul><br>  A verifica√ß√£o do certificado do cliente passou pela cadeia.  Somos <b>autoridade</b> e podemos pagar, pois emitimos certificados para atender os clientes. <br><br>  Preste aten√ß√£o ao terceiro ponto, um pouco mais tarde retornaremos a ele. <br><br><h3>  Backend </h3><br>  Eles planejavam fazer um back-end no Linux.  O back-end interage com o banco de dados, carrega a lista necess√°ria de privil√©gios e, dependendo de quais privil√©gios o usu√°rio autorizado possui, fornece acesso para assinar documentos financeiros e envi√°-los para execu√ß√£o ou gerar algum tipo de relat√≥rio. <br><br><h2>  Salvando com HAProxy </h2><br>  Al√©m dos dois contextos pelos quais cada cliente passava, havia tamb√©m um contexto de identidade.  <b>O IdentityServer4</b> apenas permite que voc√™ efetue login, √© um an√°logo gratuito e poderoso para o <b>ADFS</b> - <b>Servi√ßos de Federa√ß√£o do Active Directory</b> . <br><br>  A solicita√ß√£o na identidade foi processada em v√°rias etapas.  A primeira etapa - o <b>cliente</b> <b>caiu no back-end</b> , que trocou dados com este servidor e verificou a presen√ßa de um token para o cliente.  Se n√£o o encontrei, a solicita√ß√£o retornou ao contexto de origem, mas com um redirecionamento e com um redirecionamento foi para a identidade. <br><br>  A segunda etapa - a solicita√ß√£o foi <b>para a p√°gina de autentica√ß√£o no IdentityServer,</b> onde o cliente estava registrado, e o token muito aguardado apareceu no banco de dados do IdentityServer. <br><br>  A terceira etapa - o <b>cliente redirecionado de volta</b> ao contexto de onde ele veio. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/cc3/039/eadcc3039f4585956ccf9d25512a4370.png"><br><br>  IdentityServer4 tem uma peculiaridade: <b>retorna a resposta √† solicita√ß√£o de retorno via HTTP</b> .  N√£o importa o quanto lutamos com a configura√ß√£o do servidor, n√£o importamos o quanto ficamos esclarecidos com a documenta√ß√£o, cada vez que receb√≠amos uma solicita√ß√£o inicial do cliente com uma URL que via HTTPS, e o IdentityServer retornava o mesmo contexto, mas com HTTP.  N√≥s est√°vamos em choque!  E tudo isso foi transferido atrav√©s do contexto de identidade para o HAProxy, e nos cabe√ßalhos tivemos que modificar o protocolo HTTP para HTTPS. <br><br>  Qual √© a melhoria e onde eles salvaram? <br><br><blockquote>  Economizamos dinheiro usando uma solu√ß√£o gratuita para autorizar um grupo de usu√°rios, recursos, pois n√£o consideramos o IdentityServer4 como uma nota separada em um segmento separado, mas o usamos junto com um back-end no mesmo servidor em que o back-end do aplicativo est√° girando. </blockquote><br><h2>  Como deve funcionar </h2><br>  Ent√£o, como prometi - Magic Box.  J√° entendemos que temos a garantia de avan√ßar para o Linux.  Vamos formular tarefas espec√≠ficas que exigem solu√ß√µes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59b/f2c/bde/59bf2cbdeb581a1e53cea2dabfbd4aca.png"><br><br>  <b>Manifesta√ß√µes de marionetes.</b>  Para entregar e gerenciar a configura√ß√£o do servi√ßo e aplicativo, voc√™ precisava escrever receitas legais.  Um rolo de l√°pis mostra eloquentemente com que rapidez e efici√™ncia isso foi feito. <br><br>  <b>M√©todo de entrega.</b>  O padr√£o √© RPM.  Todo mundo entende que no Linux n√£o h√° como, mas o pr√≥prio projeto ap√≥s a montagem era um conjunto de arquivos DLL execut√°veis.  Havia cerca de 150 deles, o projeto √© bastante dif√≠cil.  A √∫nica solu√ß√£o harmoniosa √© empacotar esses bin√°rios no RPM e implantar o aplicativo a partir dele. <br><br>  <b>Versionamento</b>  Tivemos que lan√ßar com muita freq√º√™ncia e tivemos que decidir como formar o nome do pacote.  Essa √© uma quest√£o de n√≠vel de integra√ß√£o do TFS.  T√≠nhamos um agente de constru√ß√£o no Linux.  Quando o TFS envia a tarefa para o manipulador - trabalhador - para o agente Build, ele tamb√©m envia v√°rias vari√°veis ‚Äã‚Äãque se enquadram no ambiente do processo do manipulador.  Essas vari√°veis ‚Äã‚Äãde ambiente recebem o nome Build, o nome da vers√£o e outras vari√°veis.  Leia mais sobre isso na se√ß√£o ‚ÄúMontando um pacote RPM‚Äù. <br><br>  <b>A configura√ß√£o do TFS se resumiu</b> √† configura√ß√£o do Pipeline.  Anteriormente, coletamos todos os projetos do Windows nos agentes do Windows e agora existe um agente do Linux - um agente do Build que precisa ser inclu√≠do no grupo de montagem, enriquecido com alguns artefatos, informando que tipo de projetos ser√£o criados nesse agente do Build, e de alguma forma modificar o Pipeline. <br><br>  <b>IdentityServer.</b>  O ADFS n√£o √© o nosso caminho, n√≥s nos afogamos no C√≥digo Aberto. <br><br>  Vamos analisar os componentes. <br><br><h2>  Caixa m√°gica </h2><br>  Consiste em quatro partes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/737/6ef/bb5/7376efbb54d21a0dcc88f191b70dfe9f.png"><br><br>  <b>Agente de constru√ß√£o do Linux.</b>  O Linux, porque o compilamos, √© l√≥gico.  Esta parte foi realizada em tr√™s etapas. <br><br><ul><li>  <b>Configure trabalhadores</b> e mais de um, pois foi assumido trabalho distribu√≠do no projeto. <br></li><li>  <b>Instale o .NET Core 1.x.</b>  Por que 1.x quando o 2.0 j√° est√° dispon√≠vel no reposit√≥rio padr√£o?  Porque quando come√ßamos o desenvolvimento, a vers√£o est√°vel era 1.09, e foi decidido fazer o projeto para ele. <br></li><li>  <b>Git 2.x.</b> <br></li></ul><br>  <b>Reposit√≥rio RPM.</b>  Pacotes RPM precisavam ser armazenados em algum lugar.  Supunha-se que us√°ssemos o mesmo reposit√≥rio corporativo de RPM dispon√≠vel para todos os hosts Linux.  E assim eles fizeram.  Um <b>webhook √©</b> configurado no servidor de reposit√≥rio que baixou o pacote RPM necess√°rio do local especificado.  A vers√£o do pacote foi relatada ao webhook pelo agente Build. <br><br>  <b>Gitlab</b>  Aten√ß√£o!  O GitLab √© usado aqui n√£o pelos desenvolvedores, mas pelo departamento de opera√ß√µes para controlar vers√µes de aplicativos, vers√µes de pacotes, monitorar o status de todas as m√°quinas Linux e armazenar a receita - todos os manifestos do Puppet. <br><br>  <b>Puppet</b> - resolve todos os problemas controversos e fornece exatamente a configura√ß√£o que queremos do Gitlab. <br><br>  Come√ßamos a mergulhar.  Como a DLL √© entregue no RPM? <br><br><h3>  Entrega de DDL para RPM </h3><br>  Digamos que temos uma estrela do rock para o desenvolvimento .NET.  Ele usa o Visual Studio e cria uma ramifica√ß√£o de lan√ßamento.  Depois disso, ele √© carregado no Git, e o Git aqui √© uma entidade do TFS, ou seja, √© o reposit√≥rio de aplicativos com o qual o desenvolvedor trabalha. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1fd/fcd/8db/1fdfcd8dbe8f5395907ce2e5ec450539.png"><br><br>  Depois disso, o TFS v√™ que um novo commit chegou.  Qual aplicativo?  Nas configura√ß√µes do TFS, h√° um r√≥tulo sobre quais recursos um agente espec√≠fico do Build possui.  Nesse caso, ele v√™ que estamos construindo um projeto .NET Core e selecionando um agente de compila√ß√£o Linux no pool. <br><br>  O agente de constru√ß√£o recebe as fontes, baixa as <b>depend√™ncias</b> necess√°rias do .NET, reposit√≥rio npm, etc.  e depois de criar o pr√≥prio aplicativo e o empacotamento subsequente, ele envia o pacote RPM para o reposit√≥rio do RPM. <br><br>  Por outro lado, ocorre o seguinte.  O engenheiro de manuten√ß√£o est√° diretamente envolvido na implementa√ß√£o do projeto: ele altera a vers√£o dos pacotes no <b>Hiera</b> no reposit√≥rio em que a receita do aplicativo est√° armazenada, ap√≥s o que o Puppet aciona o <b>Yum</b> , pega o novo pacote no reposit√≥rio e a nova vers√£o do aplicativo est√° pronta para uso. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/135/3dd/9ae/1353dd9ae0bf83bd4527ceaa8f4db1ee.png"><br><br>  Em palavras, tudo √© simples, mas o que acontece no pr√≥prio agente Build? <br><br><h3>  DLL RPM de empacotamento </h3><br>  As fontes do projeto e a tarefa de constru√ß√£o do TFS foram recebidas.  O agente de <b>constru√ß√£o come√ßa a construir o projeto a partir da origem</b> .  O projeto montado est√° dispon√≠vel na forma de muitos <b>arquivos DLL</b> compactados em um arquivo zip para reduzir a carga no sistema de arquivos. <br><br>  O arquivo ZIP √© lan√ßado <b>no diret√≥rio de compila√ß√£o do pacote RPM.</b>  Em seguida, o script Bash inicializa as vari√°veis ‚Äã‚Äãde ambiente, localiza a vers√£o Build, a vers√£o do projeto, o caminho para o diret√≥rio de build e inicia o RPM-build.  No final do assembly, o pacote √© publicado no <b>reposit√≥rio local</b> , localizado no agente Build. <br><br>  Al√©m disso, uma <b>solicita√ß√£o JSON √© enviada</b> do agente Build para o servidor no reposit√≥rio RPM com o nome da vers√£o e build.  O Webhook, sobre o qual falei anteriormente, baixa esse mesmo pacote do reposit√≥rio local no agente Build e disponibiliza o novo assembly para instala√ß√£o. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44c/9a5/b5c/44c9a5b5c05b30293723eec126e0ff24.png"><br><br>  Por que esse esquema para entregar um pacote a um reposit√≥rio RPM?  Por que n√£o consigo enviar imediatamente o pacote montado para o reposit√≥rio?  O fato √© que essa √© uma condi√ß√£o para seguran√ßa.  Esse cen√°rio restringe a possibilidade de download n√£o autorizado de pacotes RPM por terceiros para um servidor acess√≠vel a todas as m√°quinas Linux. <br><br><h2>  Controle de vers√£o do banco de dados </h2><br>  Na consulta com o desenvolvimento, descobriu-se que os caras est√£o mais pr√≥ximos do MS SQL, mas na maioria dos projetos que n√£o s√£o Windows, j√° usamos o PostgreSQL com poder e principal.  Como j√° decidimos abandonar tudo pago, come√ßamos a usar o PostgreSQL aqui. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9c/e1a/815/a9ce1a81549ee0de97167823755f9b25.png"><br><br>  Nesta parte, quero falar sobre como implementamos a vers√£o do banco de dados e como escolher entre o Flyway e o Entity Framework Core.  Considere seus pr√≥s e contras. <br><br><h3>  Contras </h3><br>  Flyway segue apenas uma maneira, n√£o <b>podemos reverter</b> - esse √© um sinal de menos.  A compara√ß√£o com o Entity Framework Core pode ser feita de acordo com outros par√¢metros - do ponto de vista da conveni√™ncia do desenvolvedor.  Voc√™ se lembra de que colocamos isso em primeiro plano, e o principal crit√©rio n√£o foi alterar nada no desenvolvimento do Windows. <br><br>  Para o Flyway, <b>precis√°vamos de algum tipo de inv√≥lucro</b> para que os caras n√£o escrevessem <b>consultas SQL</b> .  Eles est√£o muito mais perto de operar em termos de POO.  Escrevemos instru√ß√µes para trabalhar com objetos de banco de dados, formamos uma consulta SQL e executamos.  A nova vers√£o do banco de dados est√° pronta, rolada - est√° tudo bem, tudo funciona. <br><br>  O Entity Framework Core tem menos - sob cargas pesadas, ele <b>cria consultas SQL n√£o ideais</b> , e o rebaixamento do banco de dados pode ser significativo.  Mas como n√£o temos um servi√ßo de alta carga, n√£o calculamos a carga com centenas de RPS, assumimos esses riscos e delegamos o problema para o futuro. <br><br><h3>  Pr√≥s </h3><br>  O Entity Framework Core <b>funciona</b> <b>imediatamente</b> <b>e √© f√°cil de desenvolver</b> , e o Flyway se <b>integra perfeitamente ao IC existente</b> .  Mas fazemos isso convenientemente para desenvolvedores :) <br><br><h3>  Procedimento de enrolamento </h3><br>  O Puppet v√™ que h√° uma altera√ß√£o na vers√£o dos pacotes, entre os quais o respons√°vel pela migra√ß√£o.  Primeiro, ele instala um pacote que cont√©m scripts de migra√ß√£o e funcionalidade vinculada ao banco de dados.  Depois disso, o aplicativo que funciona com o banco de dados √© reiniciado.  A seguir, √© a instala√ß√£o dos componentes restantes.  A ordem na qual os pacotes s√£o instalados e os aplicativos iniciados √© descrita no manifesto do Puppet. <br><br>  Os aplicativos usam dados confidenciais, como tokens, senhas para o banco de dados, tudo isso √© puxado para a configura√ß√£o com o Puppet master, onde s√£o armazenados em forma criptografada. <br><br><h2>  Problemas de TFS </h2><br>  Depois que decidimos e percebemos que tudo realmente funciona para n√≥s, decidi ver o que estava acontecendo com os assemblies no TFS como um todo para o departamento de desenvolvimento Win para outros projetos - rapidamente ou n√£o, est√°vamos indo / liberando e encontrei problemas significativos com a velocidade . <br><br>  Um dos principais projetos levar√° de 12 a 15 minutos - √© muito tempo, voc√™ n√£o pode viver assim.  Uma an√°lise r√°pida mostrou uma queda terr√≠vel na E / S, e isso est√° nas matrizes. <br><br>  Tendo analisado os componentes, identifiquei tr√™s focos.  O primeiro √© o <b>antiv√≠rus Kaspersky</b> , que verifica o c√≥digo-fonte em todos os agentes do Windows Build.  O segundo √© o <b>Windows</b> <b>Indexer.</b>  N√£o foi desconectado e, nos agentes Build em tempo real, tudo foi indexado durante o processo de implanta√ß√£o. <br><br>  O terceiro √© a <b>instala√ß√£o do Npm.</b>  Aconteceu que na maioria dos pipelines usamos esse cen√°rio espec√≠fico.  Por que ele √© ruim?  O procedimento de instala√ß√£o do Npm inicia quando a √°rvore de depend√™ncia √© formada em <b>package-lock.json</b> , onde as vers√µes dos pacotes que ser√£o usadas para construir o projeto s√£o corrigidas.  O ponto negativo √© que a instala√ß√£o do Npm extrai as vers√µes mais recentes dos pacotes da Internet todas as vezes, e esse √© um tempo consider√°vel no caso de um projeto grande. <br><br><blockquote>  √Äs vezes, os desenvolvedores experimentam na m√°quina local para testar a opera√ß√£o de uma pe√ßa ou projeto individual como um todo.  √Äs vezes, localmente, tudo era legal, mas montado, desenrolado - nada funcionava.  Come√ßamos a entender qual √© o problema - sim, diferentes vers√µes dos pacotes de depend√™ncia. </blockquote><br><h3>  Solu√ß√£o </h3><br><ul><li>  Fontes para exce√ß√µes de AV. <br></li><li>  Desabilitando a indexa√ß√£o. <br></li><li>  Mude para <b>npm ci</b> . <br></li></ul><br>  A vantagem do npm ci √© que <b>coletamos a √°rvore de depend√™ncia uma vez</b> e temos a oportunidade de fornecer ao desenvolvedor uma <b>lista atualizada de pacotes</b> com os quais ele pode experimentar localmente o quanto quiser.  Isso <b>economiza tempo para</b> desenvolvedores que escrevem c√≥digo. <br><br><h3>  Configura√ß√£o </h3><br>  Agora um pouco sobre a configura√ß√£o do reposit√≥rio.  Historicamente, usamos o <b>Nexus</b> para gerenciar reposit√≥rios, incluindo o <b>REPO interno</b> .  Todos os componentes que usamos para fins internos, por exemplo, monitoramento auto-escrito, s√£o entregues neste reposit√≥rio interno. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25d/4d9/204/25d4d920402193190f95e0783f31fc04.png"><br><br>  Tamb√©m usamos o <b>NuGet</b> , pois ele armazena em cache melhor que outros gerenciadores de pacotes. <br><br><h3>  Resultado </h3><br>  Depois de otimizar os agentes de compila√ß√£o, o tempo m√©dio de compila√ß√£o foi reduzido de 12 minutos para 7. <br><br><blockquote>    ,       Windows,    Linux   ,    $10 000.     ,     ‚Äî . </blockquote><br><h2>  </h2><br>           . <br><br> <b>   Docker-</b> . TFS ‚Äî     ,     Pipeline,   ,    , , Docker-.         <b>package-lock.json</b> .  -    ,      ‚Äî     Docker-.          .   ,        Kubernetes,           . <br><br><h2>  Sum√°rio </h2><br>    Windows,    ,      .   ,    Opensource- ‚Äî  <b>Linux-</b> .   <b>  </b> .   ,    Open Source  Linux   . <br><br> <i>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> GitHub</a> .</i> <br><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevOps Conf</a> ‚Äî      ,       .   ,    ?   ,        .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevOps Conf  ++</a> 27  28        .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .   ! </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt448496/">https://habr.com/ru/post/pt448496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt448484/index.html">Micr√≥bios radiculares</a></li>
<li><a href="../pt448486/index.html">"Em novembro de 2018, por engano, ca√≠mos em spam em todas as frentes." Como salvei correspond√™ncias de uma empresa com uma milion√©sima base</a></li>
<li><a href="../pt448488/index.html">Medo e √≥dio DevSecOps</a></li>
<li><a href="../pt448490/index.html">Como iniciar a transforma√ß√£o do DevOps</a></li>
<li><a href="../pt448492/index.html">O que √© DevOps</a></li>
<li><a href="../pt448498/index.html">"R√∫ssia 404": quanto de Internet gr√°tis resta para viver</a></li>
<li><a href="../pt448500/index.html">Resolvendo um Crackme simples para Sega Mega Drive</a></li>
<li><a href="../pt448504/index.html">Eles coletaram para todos "Habrom" o livro de refer√™ncia "Por quem foi emitido ..." para passaportes. Download para a sa√∫de</a></li>
<li><a href="../pt448506/index.html">Matrix tem 20 anos: como Wachowski criou o cyberpunk, que determinou a agenda de toda uma gera√ß√£o</a></li>
<li><a href="../pt448510/index.html">Acer em 2019: e se voc√™ remover todas as moscas dos laptops para jogos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>