<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕚 🚶🏾 😛 Verwendung strenger Module in großen Python-Projekten: Instagram-Erfahrung. Teil 2 🚵🏾 🎅🏻 🗂️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir machen Sie auf den zweiten Teil der Übersetzung aufmerksam, der sich mit den Funktionen der Arbeit mit Modulen in Instagram Python-Projekten befas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verwendung strenger Module in großen Python-Projekten: Instagram-Erfahrung. Teil 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/475242/">  Wir machen Sie auf den zweiten Teil der Übersetzung aufmerksam, der sich mit den Funktionen der Arbeit mit Modulen in Instagram Python-Projekten befasst.  Der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erste Teil der</a> Übersetzung gab einen Überblick über die Situation und zeigte zwei Probleme auf.  Eine davon betrifft den langsamen Start des Servers, die andere die Nebenwirkungen unsicherer Importbefehle.  Heute wird dieses Gespräch fortgesetzt.  Wir werden ein weiteres Problem betrachten und über Lösungsansätze für alle angesprochenen Probleme sprechen. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/nw/wv/sg/nwwvsgregexaj1ae6ds3gpfon-4.png"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Problem 3: Veränderlicher globaler Status</font> </h2><br>  Schauen Sie sich eine andere Kategorie häufiger Fehler an. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myview</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span>     SomeClass.id = request.GET.get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)</code> </pre> <br>  Hier befinden wir uns in der Präsentationsfunktion und hängen das Attribut an eine bestimmte Klasse an, basierend auf den Daten, die von der Anfrage empfangen wurden.  Wahrscheinlich haben Sie das Wesentliche des Problems bereits verstanden.  Tatsache ist, dass Klassen globale Singletones sind.  Und hier setzen wir den Staat je nach Wunsch in ein langlebiges Objekt.  In einem Webserver-Prozess, der lange Zeit in Anspruch nimmt, kann dies dazu führen, dass jede zukünftige Anforderung, die im Rahmen dieses Prozesses gestellt wird, beeinträchtigt wird. <br><br>  Dasselbe kann bei Tests leicht passieren.  Insbesondere in Fällen, in denen Programmierer versuchen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Affen-Patches zu verwenden</a> und nicht <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">den Kontext-Manager</a> wie <code>mock.patch</code> .  Dies kann nicht zu einer Verschmutzung der Anforderungen führen, sondern zu einer Verschmutzung aller Tests, die im selben Prozess durchgeführt werden.  Dies ist ein schwerwiegender Grund für das unzuverlässige Verhalten unseres Testsystems.  Dies ist ein erhebliches Problem, und es ist sehr schwierig, dies zu verhindern.  Infolgedessen haben wir das einheitliche Testsystem aufgegeben und auf ein Testisolierungsschema umgestellt, das als „ein Test pro Prozess“ beschrieben werden kann. <br><br>  Eigentlich ist dies unser drittes Problem.  Ein veränderlicher globaler Zustand ist ein Phänomen, das nicht nur in Python vorkommt.  Sie können es überall finden.  Es handelt sich um Klassen, Module, Listen oder Wörterbücher, die an Module oder Klassen angehängt sind, und um Singleton-Objekte, die auf Modulebene erstellt wurden.  Die Arbeit in einem solchen Umfeld erfordert Disziplin.  Um eine Verschmutzung des globalen Staates während des Programmablaufs zu verhindern, benötigen Sie sehr gute Python-Kenntnisse. <br><br><h2>  <font color="#3AC1EF">Einführung in strenge Module</font> </h2><br>  Eine der Hauptursachen für unsere Probleme kann sein, dass wir Python verwenden, um Probleme zu lösen, für die diese Sprache nicht entwickelt wurde.  Wenn Sie in kleinen Teams und kleinen Projekten die Regeln bei der Verwendung von Python befolgen, funktioniert diese Sprache einwandfrei.  Und wir sollten zu einer strengeren Sprache gehen. <br><br>  Unsere Codebasis ist jedoch bereits über die Größe hinausgewachsen, die es uns ermöglicht, zumindest darüber zu sprechen, wie wir sie in einer anderen Sprache umschreiben können.  Und was noch wichtiger ist, Python hat trotz aller Probleme viel damit zu tun.  Er gibt uns mehr gut als schlecht.  Unsere Entwickler mögen diese Sprache wirklich.  Folglich hängt es nur von uns ab, wie wir Python dazu bringen, auf unserer Skala zu arbeiten, und wie wir sicherstellen, dass wir an dem Projekt weiterarbeiten können, während es sich entwickelt. <br><br>  Das Finden von Lösungen für unsere Probleme führte uns zu einer Idee.  Es besteht aus strengen Modulen. <br><br>  Strict-Module sind Python-Module eines neuen Typs, an deren Anfang sich eine Konstruktion befindet. <code>__strict__ = True</code> .  Sie werden mithilfe vieler der Erweiterungsmechanismen auf niedriger Ebene implementiert, über die Python bereits verfügt.  Ein spezielles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Modulladeprogramm</a> analysiert den Code mit dem <code>ast</code> Modul, interpretiert den geladenen Code abstrakt, analysiert ihn, wendet verschiedene Transformationen auf den AST an und kompiliert den AST mit der integrierten <code>compile</code> wieder in Python-Bytecode. <br><br><h2>  <font color="#3AC1EF">Keine Importnebenwirkungen</font> </h2><br>  Strenge Module beschränken das, was auf Modulebene passieren kann.  Daher muss jeder Code auf Modulebene (einschließlich der auf Modulebene aufgerufenen Dekoratoren und Funktionen / Initialisierer) sauber sein, d. H. Code, der frei von Nebenwirkungen ist und keine E / A-Mechanismen verwendet.  Diese Bedingungen werden vom Abstract-Interpreter mithilfe der statischen Codeanalyse zur Kompilierungszeit überprüft. <br><br>  Dies bedeutet, dass die Verwendung strenger Module beim Importieren keine Nebenwirkungen verursacht.  Während des Modulimports ausgeführter Code kann keine unerwarteten Probleme mehr verursachen.  Da wir dies auf der Ebene der abstrakten Interpretation überprüfen und Tools verwenden, die eine große Teilmenge von Python verstehen, müssen wir die Ausdruckskraft von Python nicht übermäßig einschränken.  Viele Arten von dynamischem Code ohne Nebenwirkungen können sicher auf Modulebene verwendet werden.  Dies beinhaltet verschiedene Dekoratoren und die Definition von Konstanten auf Modulebene mithilfe von Listen oder Wörterbuchgeneratoren. <br><br>  Machen wir es klarer, betrachten wir ein Beispiel.  Hier ist das korrekt geschriebene strikte Modul: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Module docstring."""</span></span> __strict__ = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> utils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> log_to_network MY_LIST = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] MY_DICT = {x: x+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MY_LIST} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log_calls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_wrapped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        log_to_network(<span class="hljs-string"><span class="hljs-string">f"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{func.__name__}</span></span></span><span class="hljs-string"> called!"</span></span>)        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> func(*args, **kwargs)    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _wrapped @log_calls <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_world</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>    log_to_network(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>)</code> </pre> <br>  In diesem Modul können wir die üblichen Python-Konstrukte verwenden, einschließlich des dynamischen Codes, der zum Erstellen des Wörterbuchs verwendet wird, und des Dekors auf Modulebene.  Gleichzeitig ist der Zugriff auf Netzwerkressourcen in den Funktionen <code>_wrapped</code> oder <code>hello_world</code> völlig normal.  Tatsache ist, dass sie nicht auf Modulebene aufgerufen werden. <br><br>  Wenn wir jedoch den Aufruf <code>log_to_network</code> in die externe Funktion <code>log_calls</code> oder versuchen, einen Decorator zu verwenden, der Nebenwirkungen verursacht (wie <code>@route</code> aus dem vorherigen Beispiel), oder wenn wir den Aufruf <code>hello_world()</code> auf Modulebene verwenden, ist er nicht mehr streng -Modul. <br><br>  Wie kann man herausfinden, dass es nicht sicher ist, <code>log_to_network</code> oder <code>route</code> Funktionen auf Modulebene <code>log_to_network</code> ?  Wir gehen von der Annahme aus, dass alles, was aus Modulen importiert wird, die keine strengen Module sind, unsicher ist, mit Ausnahme einiger Funktionen aus der Standardbibliothek, die als sicher bekannt sind.  Wenn das <code>utils</code> Modul ein striktes Modul ist, können wir uns auf die Analyse unseres Moduls verlassen, um uns <code>log_to_network</code> , ob die <code>log_to_network</code> Funktion <code>log_to_network</code> . <br><br>  Importe, die keine Nebenwirkungen haben, verbessern nicht nur die Code-Zuverlässigkeit, sondern beseitigen auch ein ernstes Hindernis für das Sichern inkrementeller Code-Downloads.  Dies eröffnet weitere Möglichkeiten, um Möglichkeiten zur Beschleunigung von Importteams auszuloten.  Wenn der Code auf Modulebene frei von Nebenwirkungen ist, können wir auf Anfrage beim Zugriff auf die Modulattribute einzelne Modulanweisungen sicher im "Lazy" -Modus ausführen.  Dies ist viel besser, als dem "gierigen" Algorithmus zu folgen, in dessen Anwendung der gesamte Modulcode im Voraus ausgeführt wird.  Unter Berücksichtigung der Tatsache, dass die Form aller Klassen im Modul strict zum Zeitpunkt der Kompilierung vollständig bekannt ist, können wir in Zukunft sogar versuchen, die dauerhafte Speicherung der während der Codeausführung generierten Modulmetadaten (Klassen, Funktionen, Konstanten) zu organisieren.  Auf diese Weise können wir den schnellen Import von unveränderten Modulen organisieren, ohne dass der Bytecode der Modulebene wiederholt ausgeführt werden muss. <br><br><h2>  <font color="#3AC1EF">Immunität und __slots__ Attribut</font> </h2><br>  Strikte Module und Klassen, die in ihnen deklariert sind, sind nach ihrer Erstellung unveränderlich.  Module werden mit Hilfe der internen Transformation des Modulkörpers in eine Funktion unveränderlich gemacht, bei der der Zugriff auf alle globalen Variablen über Closure-Variablen organisiert wird.  Diese Änderungen haben die Möglichkeiten für eine zufällige Änderung des globalen Zustands erheblich verringert, obwohl der veränderbare globale Zustand immer noch berechnet werden kann, wenn entschieden wird, ihn durch veränderbare Container auf Modulebene zu verwenden. <br><br>  Mitglieder von Klassen, die in strengen Modulen deklariert sind, müssen auch in <code>__init__</code> deklariert <code>__init__</code> .  Sie werden automatisch in das Attribut <code>__slots__</code> geschrieben, während die AST-Umwandlung vom <code>__slots__</code> wird.  Infolgedessen können Sie später der Klasseninstanz keine weiteren Attribute mehr hinzufügen.  Hier ist eine ähnliche Klasse: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">:</span></span>    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, age)</span></span></span><span class="hljs-function">:</span></span>        self.name = name        self.age = age</code> </pre> <br>  Während der AST-Transformation, die während der Verarbeitung strenger Module ausgeführt wird, werden die in <code>__init__</code> Vorgänge zum Zuweisen von Werten zu den <code>name</code> und <code>__init__</code> erkannt und ein Attribut der Form <code>__slots__ = ('name', 'age')</code> an die Klasse angehängt.  Dadurch wird verhindert, dass der Klasseninstanz weitere Attribute hinzugefügt werden.  (Wenn Typanmerkungen verwendet werden, berücksichtigen wir Informationen zu den auf Klassenebene verfügbaren Typen, z. B. <code>name: str</code> , und fügen sie der Liste der Slots hinzu.) <br><br>  Die beschriebenen Einschränkungen machen den Code nicht nur zuverlässiger.  Sie beschleunigen die Codeausführung.  Die automatische Umwandlung von Klassen durch Hinzufügen des Attributs <code>__slots__</code> erhöht die Effizienz der Speichernutzung beim Arbeiten mit diesen Klassen.  Auf diese Weise können Sie bei der Arbeit mit einzelnen Instanzen von Klassen die Dictionary-Suche umgehen und den Zugriff auf Attribute beschleunigen.  Darüber hinaus können wir diese Muster während der Ausführung von Python-Code weiter optimieren, wodurch wir unser System weiter verbessern können. <br><br><h2>  <font color="#3AC1EF">Zusammenfassung</font> </h2><br>  Strikte Module sind immer noch experimentelle Technologie.  Wir haben einen funktionierenden Prototyp und befinden uns in einem frühen Stadium der Bereitstellung dieser Funktionen in der Produktion.  Wir hoffen, dass wir, nachdem wir genug Erfahrung im Umgang mit Strict-Modulen gesammelt haben, mehr über sie sprechen können. <br><br>  <b>Sehr geehrte Leser!</b>  Denken Sie, dass die Funktionen von strict-Modulen in Ihrem Python-Projekt nützlich sind? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de475242/">https://habr.com/ru/post/de475242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de475226/index.html">Praktikum bei der Haxe Foundation</a></li>
<li><a href="../de475228/index.html">Payroll Gabel. Du bist ein Programmierer für Mama</a></li>
<li><a href="../de475236/index.html">Ignoriere niemals wieder das Verstärkungstraining.</a></li>
<li><a href="../de475238/index.html">Blade Runner Timeline - November 2019. Hat sich die Prognose erfüllt?</a></li>
<li><a href="../de475240/index.html">Verwendung strenger Module in großen Python-Projekten: Instagram-Erfahrung. Teil 1</a></li>
<li><a href="../de475244/index.html">Erwartete neue JavaScript-Funktionen, die Sie kennen sollten</a></li>
<li><a href="../de475246/index.html">Asynchrone Python-Programmierung: Ein kurzer Überblick</a></li>
<li><a href="../de475248/index.html">Die Verwendung von Polyfills beim Schreiben browserübergreifender Anwendungen</a></li>
<li><a href="../de475250/index.html">Als Redash ein Problem bemerkte und behebte, das zu einer Verschlechterung der Python-Code-Leistung führte</a></li>
<li><a href="../de475254/index.html">AERODISK vAIR-Architektur oder Merkmale der nationalen Clusterbildung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>