<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÇ ü§¥üèæ üßôüèΩ Cliente de teste TON (Telegram Open Network) e o novo idioma Fift para contratos inteligentes üë©üèª‚Äçü§ù‚Äçüë®üèæ üï∫üèº üë©‚Äçüë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° mais de um ano, ficou conhecido o plano do messenger Telegram de lan√ßar sua pr√≥pria rede descentralizada Telegram Open Network . Ent√£o, um volumoso...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cliente de teste TON (Telegram Open Network) e o novo idioma Fift para contratos inteligentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453714/"><p>  H√° mais de um ano, ficou conhecido o plano do messenger Telegram de lan√ßar sua pr√≥pria rede descentralizada <strong>Telegram Open Network</strong> .  Ent√£o, um volumoso documento t√©cnico ficou dispon√≠vel, o qual, presumivelmente, foi escrito por Nikolai Durov e descreveu a estrutura da futura rede.  Para aqueles que perderam, recomendo que voc√™ leia minha recontagem deste documento ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2</a> ; a terceira parte, infelizmente, ainda est√° acumulando poeira nas c√≥pias de rascunho). </p><br><p> Desde ent√£o, n√£o havia not√≠cias significativas sobre o status de desenvolvimento da TON, at√© alguns dias atr√°s (em um dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canais n√£o oficiais</a> ) um link para a p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://test.ton.org/download.html apareceu</a> , onde est√£o: </p><br><p>  ‚ó¶ <a href="">ton-test-liteclient-full.tar.xz</a> - fontes de clientes leves para a rede de teste TON; <br>  ‚ó¶ <a href="">ton-lite-client-test1.config.json</a> - arquivo de configura√ß√£o para conectar-se a uma rede de teste; <br>  AD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">README</a> - informa√ß√µes sobre como construir e iniciar o cliente; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TO COMO FAZER</a> - instru√ß√µes passo a passo sobre como criar um contrato inteligente usando um cliente; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ton.pdf</a> - documento atualizado (2 de mar√ßo de 2019) com uma vis√£o geral t√©cnica da rede TON; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tvm.pdf</a> - descri√ß√£o t√©cnica do TVM (TON Virtual Machine, TON virtual machine); <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bl tblkch.pdf</a> - descri√ß√£o t√©cnica da blockchain TON; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiftbase.pdf</a> - uma descri√ß√£o da nova linguagem Fift, projetada para criar contratos inteligentes em TON. </p><br><p>  Repito, n√£o houve confirma√ß√£o oficial da p√°gina e de todos esses documentos pelo Telegram, mas o volume desses materiais os torna bastante plaus√≠veis.  Execute um cliente publicado <strong>por sua conta e risco</strong> . </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta">  Compila√ß√£o do cliente de teste </h2><br><p>  Primeiro, vamos tentar criar e executar um cliente de teste - felizmente, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">README</a> descreve esse processo simples em detalhes.  Farei isso no exemplo do macOS 10.14.5, n√£o posso garantir o sucesso da montagem em outros sistemas. </p><br><ol><li><p>  Baixe e descompacte o <a href="">arquivo com os c√≥digos-fonte</a> .  √â importante fazer o download da vers√£o mais recente, pois a compatibilidade com vers√µes anteriores n√£o √© garantida neste est√°gio. </p><br></li><li><p>  Garantimos que as vers√µes mais recentes do make, cmake (vers√£o 3.0.2 ou superior), OpenSSL (incluindo arquivos de cabe√ßalho C), g ++ ou clang estejam instaladas no sistema.  N√£o precisei reinstalar nada, tudo reunido imediatamente. </p><br></li><li><p> Suponha que as fontes sejam descompactadas na pasta <code>~/lite-client</code> .  Separadamente, criamos uma pasta vazia para o projeto montado (por exemplo, <code>~/liteclient-build</code> ) e a partir dela ( <code>cd ~/liteclient-build</code> ) chamamos os comandos: </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="Cria√ß√£o bem sucedida do cliente"><br><br>  Para criar o int√©rprete de linguagem Fift para contratos inteligentes (veja abaixo), tamb√©m chamamos </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p>  Fa√ßa o download do <a href="">arquivo de configura√ß√£o</a> atual para conectar-se √† rede de teste e coloque-o na pasta com o cliente montado. </p><br></li><li><p>  <strong>Feito</strong> , voc√™ pode iniciar o cliente: </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p>  Se tudo for feito corretamente, voc√™ dever√° ver algo assim: </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="Lan√ßamento do cliente"></p><br><p>  Como voc√™ pode ver, existem alguns comandos dispon√≠veis: </p><br><p>  ‚ó¶ <strong><code>help</code></strong> - exibe esta lista de comandos; <br>  <strong><code>quit</code></strong> - sair; <br>  ‚ó¶ <strong><code>time</code></strong> - mostra a hora atual no servidor; <br>  ‚ó¶ <strong><code>status</code></strong> - mostra o status da conex√£o e o banco de dados local; <br>  ‚ó¶ <strong><code>last</code></strong> - atualiza o estado da blockchain (carrega o √∫ltimo bloco).  √â importante executar este comando antes de qualquer solicita√ß√£o para garantir que voc√™ veja exatamente o estado atual da rede. <br>  ‚ó¶ <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> - carrega um arquivo local na rede TON.  Essa √© a intera√ß√£o com a rede - incluindo, por exemplo, a cria√ß√£o de novos contratos inteligentes e solicita√ß√µes de transfer√™ncia de fundos entre contas; <br>  ‚ó¶ <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> - mostra o status da conta atual (no momento em que o <strong><code>last</code></strong> comando foi executado) com o endere√ßo especificado; <br>  Key <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> - carrega a chave privada do arquivo local. </p><br><p>  Se, no lan√ßamento do cliente, voc√™ passa a pasta para ela usando a op√ß√£o <code>-D</code> , ela adiciona o √∫ltimo bloco da cadeia principal nele: </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p>  Agora podemos avan√ßar para coisas mais interessantes - aprender a linguagem Fift, tentar compilar um contrato inteligente (por exemplo, criar uma carteira de teste), carreg√°-la na rede e tentar transferir fundos entre contas. </p><br><h2 id="yazyk-fift">  Fift language </h2><br><p>  No documento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiftbase.pdf,</a> voc√™ pode descobrir que, para criar contratos inteligentes, a equipe do Telegram criou uma nova linguagem de pilha <strong>Fift</strong> (aparentemente, a partir do <em>quinto</em> do numeral, por analogia com a Forth - uma linguagem com a qual a Fift tem muito em comum). </p><br><p>  O documento √© bastante volumoso, com 87 p√°ginas, e n√£o vou recontar seu conte√∫do em detalhes na estrutura deste artigo (pelo menos porque eu mesmo n√£o terminei de l√™-lo :).  Vou abordar os pontos principais e dar alguns exemplos de c√≥digo nessa linguagem. </p><br><p>  Em um n√≠vel b√°sico, a sintaxe de Fift √© bastante simples: seu c√≥digo consiste em <em>palavras</em> , geralmente separadas por espa√ßos ou quebras de linha (caso especial: algumas palavras n√£o requerem um delimitador depois de si).  Qualquer <em>palavra</em> √© uma sequ√™ncia de caracteres que diferencia mai√∫sculas de min√∫sculas que corresponde a alguma <em>defini√ß√£o</em> (grosso modo, o que o int√©rprete deve fazer quando encontra essa palavra).  Se n√£o houver defini√ß√£o da palavra, o int√©rprete tenta analis√°-la como um n√∫mero e coloc√°-la na pilha.  A prop√≥sito, os n√∫meros aqui s√£o - de repente - n√∫meros inteiros de 257 bits, mas n√£o h√° n√∫meros fracion√°rios - mais precisamente, eles imediatamente se transformam em um par de n√∫meros inteiros, formando o numerador e o denominador de uma fra√ß√£o racional. </p><br><p>  As palavras normalmente interagem com os significados no topo da pilha.  Um tipo separado de palavras - <em>prefixo</em> - n√£o usa a pilha, mas os caracteres subseq√ºentes do arquivo de origem.  Por exemplo, literais de string s√£o implementados dessa maneira - o caractere "aspas" ( <code>"</code> ) √© uma palavra de prefixo que procura a pr√≥xima aspas (de fechamento) e coloca a string entre eles na pilha. As linhas simples ( <code>//</code> ) e as m√∫ltiplas linhas ( <code>/*</code> ) se comportam da mesma maneira. coment√°rios. </p><br><p>  Sobre isso, quase toda a estrutura interna da linguagem termina.  Todo o resto (incluindo estruturas de controle) √© definido como palavras (internas, como opera√ß√µes aritm√©ticas e a defini√ß√£o de novas palavras; ou definidas na "biblioteca padr√£o" <code>Fift.fif</code> , que fica na <code>crypto/fift</code> na fonte). </p><br><p>  Um exemplo simples de um programa Fift: </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p>  A primeira linha define a nova palavra <code>setxy</code> (observe o prefixo <code>{</code> , que cria o bloco antes do fechamento <code>}</code> e o prefixo <code>setxy</code> que realmente define a palavra).  <code>setxy</code> pega um n√∫mero no topo da pilha, define (ou redefine) como uma <em>constante</em> global <code>x</code> o quadrado desse n√∫mero como uma constante <code>y</code> (dado que os valores das constantes podem ser redefinidos, prefiro cham√°-los de vari√°veis, mas sigo a nomea√ß√£o no idioma). </p><br><p>  Nas pr√≥ximas duas linhas, um n√∫mero √© colocado na pilha, <code>setxy</code> √© <code>setxy</code> , em seguida, os valores das constantes <code>x</code> , <code>y</code> s√£o exibidos (a palavra √© usada para sa√≠da <code>.</code> ) <code>.</code> Ambas as constantes s√£o colocadas na pilha, somadas e o resultado tamb√©m √© exibido.  Como resultado, veremos: </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  (O int√©rprete imprime a linha "ok" quando termina de processar a linha atual no modo de entrada interativa) </p><br><p>  Bem, um exemplo de c√≥digo completo: </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p>  Este arquivo de apar√™ncia assustadora foi projetado para criar um contrato inteligente - ser√° colocado no <code>new-wallet-query.boc</code> ap√≥s a execu√ß√£o.  Observe que aqui √© usada outra linguagem de montagem para a m√°quina virtual TON (n√£o vou me deter nela em detalhes), cujas instru√ß√µes ser√£o colocadas na blockchain. </p><br><p>  Portanto, o assembler para TVM √© escrito em Fift - as fontes desse assembler est√£o no arquivo <code>crypto/fift/Asm.fif</code> e est√£o conectadas no in√≠cio do c√≥digo acima. </p><br><p>  O que posso dizer, aparentemente, Nikolai Durov adora criar novas linguagens de programa√ß√£o :) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton">  Criando um contrato inteligente e interagindo com o TON </h2><br><p>  Portanto, suponha que reunamos um cliente TON e um int√©rprete Fift, conforme descrito acima, e nos familiarizamos com o idioma.  Como criar um contrato inteligente agora?  Isso √© descrito no arquivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HOWTO</a> anexado √† fonte. </p><br><h3 id="akkaunty-v-ton">  Contas TON </h3><br><p>  Como descrevi na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">revis√£o TON</a> , essa rede cont√©m mais de um blockchain - h√° um comum, o chamado  ‚ÄúCadeia principal‚Äù, bem como um n√∫mero arbitr√°rio de ‚Äúcadeias de trabalho‚Äù adicionais identificadas por um n√∫mero de 32 bits.  A cadeia mestre possui um identificador -1, al√©m disso, tamb√©m pode ser usada uma cadeia de trabalho "b√°sica" com o identificador 0. Cada cadeia de trabalho pode ter sua pr√≥pria configura√ß√£o.  Internamente, cada grupo de trabalho √© dividido em shardchains, mas esse j√° √© um detalhe da implementa√ß√£o, que n√£o precisa ser lembrado. </p><br><p>  Muitas contas s√£o armazenadas em uma cadeia de trabalho, com seus pr√≥prios identificadores account_id.  Para a cadeia mestre e a cadeia de trabalho zero, eles t√™m um comprimento de 256 bits.  Assim, o identificador da conta √© escrito, por exemplo, assim: </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Este √© um formato "bruto": primeiro, o identificador da cadeia de trabalho, depois dois pontos e o identificador da conta em nota√ß√£o hexadecimal. </p><br><p>  Al√©m disso, h√° um formato reduzido - o n√∫mero da cadeia de trabalho e o endere√ßo da conta s√£o codificados em formato bin√°rio, uma soma de verifica√ß√£o √© adicionada a eles e tudo isso √© codificado em Base64: </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p>  Conhecendo esse formato de grava√ß√£o, podemos solicitar o status atual de uma conta atrav√©s de um cliente de teste usando o comando </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Temos uma resposta como esta: </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp: <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> por -1: 8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D com respeito a blocos (-1,8000000000000000,72355): F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296: 1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F e <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  Vemos a estrutura que √© armazenada no DHT da cadeia de trabalho especificada.  Por exemplo, no campo <code>storage.balance</code> √© o saldo da conta atual, em <code>storage.state.code</code> √© o c√≥digo do contrato inteligente e em <code>storage.state.data</code> s√£o seus dados atuais.  Observe que o armazenamento de dados TON - c√©lula, c√©lulas - √© uma √°rvore, cada c√©lula pode ter seus pr√≥prios dados, bem como c√©lulas filho.  Isso √© mostrado como recuo nas √∫ltimas linhas. </p><br><h3 id="sborka-smart-kontrakta">  Montagem de contrato inteligente </h3><br><p>  Agora vamos criar essa estrutura (ela √© chamada BOC - <em>saco de c√©lulas</em> ) usando a linguagem Fift.  Felizmente, voc√™ n√£o precisar√° escrever um contrato inteligente - na pasta de <code>crypto/block</code> do arquivo de origem, h√° um arquivo <code>new-wallet.fif</code> que nos ajudar√° a criar uma nova carteira.  Copie-o para a pasta com o cliente montado ( <code>~/liteclient-build</code> , se voc√™ <code>~/liteclient-build</code> instru√ß√µes acima).  Eu citei seu conte√∫do acima como um exemplo de c√≥digo no Fift. </p><br><p>  Executamos este arquivo da seguinte maneira: </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p>  Aqui, <code>&lt;source-directory&gt;</code> deve ser substitu√≠do pelo caminho para as fontes descompactadas (o s√≠mbolo "~" n√£o pode ser usado aqui, infelizmente, voc√™ precisa do caminho completo).  Em vez de usar a <code>-I</code> voc√™ pode definir a <code>FIFTPATH</code> ambiente <code>FIFTPATH</code> e colocar esse caminho nela. </p><br><p>  Desde que lan√ßamos o Fift com o nome de arquivo <code>new-wallet.fif</code> , ele ser√° executado e conclu√≠do.  Se voc√™ omitir o nome do arquivo, poder√° tocar com o int√©rprete no modo interativo. </p><br><p>  Ap√≥s a execu√ß√£o, algo como isto deve ser exibido no console: </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p>  Isso significa que a carteira com o identificador <code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> (ou, que √© a mesma coisa, <code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code> ).  O c√≥digo correspondente <code>new-wallet-query.boc</code> no <code>new-wallet-query.boc</code> , seu endere√ßo em <code>new-wallet.addr</code> e a chave privada em <code>new-wallet.pk</code> (cuidado: reiniciar o script substituir√° esses arquivos). </p><br><p>  Obviamente, a rede TON ainda n√£o conhece essa carteira, ela √© armazenada apenas na forma desses arquivos.  Agora voc√™ precisa envi√°-lo para a rede.  √â verdade que o problema √© que, para criar um contrato inteligente, voc√™ precisa pagar uma comiss√£o e o saldo da sua conta ainda √© zero. </p><br><p>  No modo de trabalho, esse problema ser√° resolvido comprando gramas na bolsa (ou transferindo de outra carteira).  Bem, no modo de teste atual, foi institu√≠do um contrato inteligente especial, no qual voc√™ pode solicitar at√© 20 gramas assim. </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu">  Forma√ß√£o de uma solicita√ß√£o para o contrato inteligente de outra pessoa </h3><br><p>  Solicite um contrato inteligente, distribuindo gramas √† esquerda e √† direita, fa√ßa-o.  Na mesma pasta de <code>crypto/block</code> , encontramos o arquivo <code>testgiver.fif</code> : </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p>  Tamb√©m o salvamos na pasta com o cliente montado, mas <code>constant dest_addr</code> a quinta linha - antes da linha " <code>constant dest_addr</code> ".  Substitua-o pelo endere√ßo da carteira que voc√™ criou anteriormente (cheio, n√£o abreviado).  "-1:" voc√™ n√£o precisa escrever no in√≠cio; em vez disso, coloque "0x" no in√≠cio. </p><br><p>  Voc√™ tamb√©m pode alterar a linha <code>6.666 Gram*/ constant amount</code> - esta √© a quantidade em gramas que voc√™ solicita (n√£o mais que 20).  Mesmo se voc√™ especificar um n√∫mero inteiro, deixe o ponto decimal. </p><br><p>  Finalmente, voc√™ precisa corrigir a linha <code>0x00000011 constant seqno</code> .  O primeiro n√∫mero aqui √© o n√∫mero de sequ√™ncia atual, que √© armazenado na conta que emite os gramas.  De onde obt√™-lo?  Como mencionado acima, inicie o cliente e execute: </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  No final, os dados do contrato inteligente ser√£o </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  O n√∫mero 0000000D (voc√™ ter√° mais) √© o n√∫mero da sequ√™ncia, que deve ser substitu√≠do em <code>testgiver.fif</code> . </p><br><p>  √â isso, salve o arquivo e execute ( <code>./crypto/fift testgiver.fif</code> ).  A sa√≠da ser√° o <code>wallet-query.boc</code> .  Esta √© a <em>mensagem</em> formada para o contrato inteligente de outra pessoa - a solicita√ß√£o √© "transferir tantos gramas para tal e tal conta". </p><br><p>  Usando o cliente, fazemos o upload para a rede: </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p>  Se agora ligarmos por <code>last</code> e depois solicitar novamente o status da conta da qual solicitamos gramas, veremos que o n√∫mero de sequ√™ncia aumentou em um - isso significa que ele enviou dinheiro para nossa conta. </p><br><p>  O √∫ltimo passo permanece - carregamos o c√≥digo da nossa carteira (seu saldo j√° foi reabastecido, mas sem o c√≥digo do contrato inteligente, n√£o poderemos gerenci√°-lo).  <code>sendfile new-wallet-query.boc</code> - e √© isso, voc√™ tem sua pr√≥pria carteira na rede TON (embora por enquanto apenas uma de teste). </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy">  Criar transa√ß√µes de sa√≠da </h3><br><p>  Para transferir dinheiro do saldo da conta criada, existe um <code>crypto/block/wallet.fif</code> , que tamb√©m precisa ser colocado na pasta com o cliente coletado. </p><br><p>  Semelhante √†s etapas anteriores, voc√™ precisa ajustar o valor que transfere, o endere√ßo do destinat√°rio (dest_addr) e o n√∫mero da sua carteira (√© 1 ap√≥s a inicializa√ß√£o da carteira e aumenta em 1 ap√≥s cada transa√ß√£o de sa√≠da - voc√™ pode v√™-la solicitando o status da sua conta) .  Para testes, voc√™ pode usar, por exemplo, minha carteira - <code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> . </p><br><p>  Quando voc√™ executa ( <code>./crypto/fift wallet.fif</code> ), o script pega o endere√ßo da sua carteira (de onde voc√™ a transfere) e sua chave privada dos arquivos <code>new-wallet.addr</code> e <code>new-wallet.pk</code> e grava a mensagem recebida em <code>new-wallet-query.boc</code> . </p><br><p>  Como antes, para executar a transa√ß√£o diretamente, chamamos <code>sendfile new-wallet-query.boc</code> no cliente.  Depois disso, n√£o se esque√ßa de atualizar o estado da blockchain ( <code>last</code> ) e verifique se o saldo e o seqno da nossa carteira mudaram ( <code>getaccount &lt;account_id&gt;</code> ). </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="Descri√ß√£o da conta"></p><br><p>  Isso √© tudo, agora podemos criar contratos inteligentes em TON e enviar solicita√ß√µes a eles.  Como voc√™ pode ver, a funcionalidade atual j√° √© suficiente para, por exemplo, criar uma carteira mais amig√°vel com uma interface gr√°fica (no entanto, espera-se que ela fique dispon√≠vel como parte do messenger). </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453714/">https://habr.com/ru/post/pt453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453700/index.html">Li√ß√µes sobre SDL 2: Li√ß√£o 1 - Ol√°, SDL 2</a></li>
<li><a href="../pt453706/index.html">Como passei no exame de certifica√ß√£o do Google Cloud Professional Data Engineer</a></li>
<li><a href="../pt453708/index.html">SO em tempo real AQUA RTOS para MK AVR em ambiente BASCOM AVR</a></li>
<li><a href="../pt453710/index.html">Pr√°tica de desenvolvimento em grandes projetos: mitp SberPractice iOS # 1</a></li>
<li><a href="../pt453712/index.html">Como o eBay criou um scanner de c√≥digo de barras no WebAssembly</a></li>
<li><a href="../pt453716/index.html">Coworking no pa√≠s para o pessoal de TI da fam√≠lia - existe algu√©m?</a></li>
<li><a href="../pt453720/index.html">Sutilezas de express√µes lambda em c #</a></li>
<li><a href="../pt453722/index.html">Sobre pesquisa de processos n√£o estacion√°rios</a></li>
<li><a href="../pt453728/index.html">Batalha dos Hyperstars</a></li>
<li><a href="../pt453730/index.html">Odontologia moderna: implanta√ß√£o dent√°ria simult√¢nea e extens√£o do osso maxilar atrav√©s dos olhos do diretor t√©cnico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>