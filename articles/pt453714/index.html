<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📂 🤴🏾 🧙🏽 Cliente de teste TON (Telegram Open Network) e o novo idioma Fift para contratos inteligentes 👩🏻‍🤝‍👨🏾 🕺🏼 👩‍👩‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Há mais de um ano, ficou conhecido o plano do messenger Telegram de lançar sua própria rede descentralizada Telegram Open Network . Então, um volumoso...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cliente de teste TON (Telegram Open Network) e o novo idioma Fift para contratos inteligentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453714/"><p>  Há mais de um ano, ficou conhecido o plano do messenger Telegram de lançar sua própria rede descentralizada <strong>Telegram Open Network</strong> .  Então, um volumoso documento técnico ficou disponível, o qual, presumivelmente, foi escrito por Nikolai Durov e descreveu a estrutura da futura rede.  Para aqueles que perderam, recomendo que você leia minha recontagem deste documento ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2</a> ; a terceira parte, infelizmente, ainda está acumulando poeira nas cópias de rascunho). </p><br><p> Desde então, não havia notícias significativas sobre o status de desenvolvimento da TON, até alguns dias atrás (em um dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canais não oficiais</a> ) um link para a página <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://test.ton.org/download.html apareceu</a> , onde estão: </p><br><p>  ◦ <a href="">ton-test-liteclient-full.tar.xz</a> - fontes de clientes leves para a rede de teste TON; <br>  ◦ <a href="">ton-lite-client-test1.config.json</a> - arquivo de configuração para conectar-se a uma rede de teste; <br>  AD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">README</a> - informações sobre como construir e iniciar o cliente; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TO COMO FAZER</a> - instruções passo a passo sobre como criar um contrato inteligente usando um cliente; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ton.pdf</a> - documento atualizado (2 de março de 2019) com uma visão geral técnica da rede TON; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tvm.pdf</a> - descrição técnica do TVM (TON Virtual Machine, TON virtual machine); <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bl tblkch.pdf</a> - descrição técnica da blockchain TON; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiftbase.pdf</a> - uma descrição da nova linguagem Fift, projetada para criar contratos inteligentes em TON. </p><br><p>  Repito, não houve confirmação oficial da página e de todos esses documentos pelo Telegram, mas o volume desses materiais os torna bastante plausíveis.  Execute um cliente publicado <strong>por sua conta e risco</strong> . </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta">  Compilação do cliente de teste </h2><br><p>  Primeiro, vamos tentar criar e executar um cliente de teste - felizmente, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">README</a> descreve esse processo simples em detalhes.  Farei isso no exemplo do macOS 10.14.5, não posso garantir o sucesso da montagem em outros sistemas. </p><br><ol><li><p>  Baixe e descompacte o <a href="">arquivo com os códigos-fonte</a> .  É importante fazer o download da versão mais recente, pois a compatibilidade com versões anteriores não é garantida neste estágio. </p><br></li><li><p>  Garantimos que as versões mais recentes do make, cmake (versão 3.0.2 ou superior), OpenSSL (incluindo arquivos de cabeçalho C), g ++ ou clang estejam instaladas no sistema.  Não precisei reinstalar nada, tudo reunido imediatamente. </p><br></li><li><p> Suponha que as fontes sejam descompactadas na pasta <code>~/lite-client</code> .  Separadamente, criamos uma pasta vazia para o projeto montado (por exemplo, <code>~/liteclient-build</code> ) e a partir dela ( <code>cd ~/liteclient-build</code> ) chamamos os comandos: </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="Criação bem sucedida do cliente"><br><br>  Para criar o intérprete de linguagem Fift para contratos inteligentes (veja abaixo), também chamamos </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p>  Faça o download do <a href="">arquivo de configuração</a> atual para conectar-se à rede de teste e coloque-o na pasta com o cliente montado. </p><br></li><li><p>  <strong>Feito</strong> , você pode iniciar o cliente: </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p>  Se tudo for feito corretamente, você deverá ver algo assim: </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="Lançamento do cliente"></p><br><p>  Como você pode ver, existem alguns comandos disponíveis: </p><br><p>  ◦ <strong><code>help</code></strong> - exibe esta lista de comandos; <br>  <strong><code>quit</code></strong> - sair; <br>  ◦ <strong><code>time</code></strong> - mostra a hora atual no servidor; <br>  ◦ <strong><code>status</code></strong> - mostra o status da conexão e o banco de dados local; <br>  ◦ <strong><code>last</code></strong> - atualiza o estado da blockchain (carrega o último bloco).  É importante executar este comando antes de qualquer solicitação para garantir que você veja exatamente o estado atual da rede. <br>  ◦ <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> - carrega um arquivo local na rede TON.  Essa é a interação com a rede - incluindo, por exemplo, a criação de novos contratos inteligentes e solicitações de transferência de fundos entre contas; <br>  ◦ <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> - mostra o status da conta atual (no momento em que o <strong><code>last</code></strong> comando foi executado) com o endereço especificado; <br>  Key <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> - carrega a chave privada do arquivo local. </p><br><p>  Se, no lançamento do cliente, você passa a pasta para ela usando a opção <code>-D</code> , ela adiciona o último bloco da cadeia principal nele: </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p>  Agora podemos avançar para coisas mais interessantes - aprender a linguagem Fift, tentar compilar um contrato inteligente (por exemplo, criar uma carteira de teste), carregá-la na rede e tentar transferir fundos entre contas. </p><br><h2 id="yazyk-fift">  Fift language </h2><br><p>  No documento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiftbase.pdf,</a> você pode descobrir que, para criar contratos inteligentes, a equipe do Telegram criou uma nova linguagem de pilha <strong>Fift</strong> (aparentemente, a partir do <em>quinto</em> do numeral, por analogia com a Forth - uma linguagem com a qual a Fift tem muito em comum). </p><br><p>  O documento é bastante volumoso, com 87 páginas, e não vou recontar seu conteúdo em detalhes na estrutura deste artigo (pelo menos porque eu mesmo não terminei de lê-lo :).  Vou abordar os pontos principais e dar alguns exemplos de código nessa linguagem. </p><br><p>  Em um nível básico, a sintaxe de Fift é bastante simples: seu código consiste em <em>palavras</em> , geralmente separadas por espaços ou quebras de linha (caso especial: algumas palavras não requerem um delimitador depois de si).  Qualquer <em>palavra</em> é uma sequência de caracteres que diferencia maiúsculas de minúsculas que corresponde a alguma <em>definição</em> (grosso modo, o que o intérprete deve fazer quando encontra essa palavra).  Se não houver definição da palavra, o intérprete tenta analisá-la como um número e colocá-la na pilha.  A propósito, os números aqui são - de repente - números inteiros de 257 bits, mas não há números fracionários - mais precisamente, eles imediatamente se transformam em um par de números inteiros, formando o numerador e o denominador de uma fração racional. </p><br><p>  As palavras normalmente interagem com os significados no topo da pilha.  Um tipo separado de palavras - <em>prefixo</em> - não usa a pilha, mas os caracteres subseqüentes do arquivo de origem.  Por exemplo, literais de string são implementados dessa maneira - o caractere "aspas" ( <code>"</code> ) é uma palavra de prefixo que procura a próxima aspas (de fechamento) e coloca a string entre eles na pilha. As linhas simples ( <code>//</code> ) e as múltiplas linhas ( <code>/*</code> ) se comportam da mesma maneira. comentários. </p><br><p>  Sobre isso, quase toda a estrutura interna da linguagem termina.  Todo o resto (incluindo estruturas de controle) é definido como palavras (internas, como operações aritméticas e a definição de novas palavras; ou definidas na "biblioteca padrão" <code>Fift.fif</code> , que fica na <code>crypto/fift</code> na fonte). </p><br><p>  Um exemplo simples de um programa Fift: </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p>  A primeira linha define a nova palavra <code>setxy</code> (observe o prefixo <code>{</code> , que cria o bloco antes do fechamento <code>}</code> e o prefixo <code>setxy</code> que realmente define a palavra).  <code>setxy</code> pega um número no topo da pilha, define (ou redefine) como uma <em>constante</em> global <code>x</code> o quadrado desse número como uma constante <code>y</code> (dado que os valores das constantes podem ser redefinidos, prefiro chamá-los de variáveis, mas sigo a nomeação no idioma). </p><br><p>  Nas próximas duas linhas, um número é colocado na pilha, <code>setxy</code> é <code>setxy</code> , em seguida, os valores das constantes <code>x</code> , <code>y</code> são exibidos (a palavra é usada para saída <code>.</code> ) <code>.</code> Ambas as constantes são colocadas na pilha, somadas e o resultado também é exibido.  Como resultado, veremos: </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  (O intérprete imprime a linha "ok" quando termina de processar a linha atual no modo de entrada interativa) </p><br><p>  Bem, um exemplo de código completo: </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p>  Este arquivo de aparência assustadora foi projetado para criar um contrato inteligente - será colocado no <code>new-wallet-query.boc</code> após a execução.  Observe que aqui é usada outra linguagem de montagem para a máquina virtual TON (não vou me deter nela em detalhes), cujas instruções serão colocadas na blockchain. </p><br><p>  Portanto, o assembler para TVM é escrito em Fift - as fontes desse assembler estão no arquivo <code>crypto/fift/Asm.fif</code> e estão conectadas no início do código acima. </p><br><p>  O que posso dizer, aparentemente, Nikolai Durov adora criar novas linguagens de programação :) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton">  Criando um contrato inteligente e interagindo com o TON </h2><br><p>  Portanto, suponha que reunamos um cliente TON e um intérprete Fift, conforme descrito acima, e nos familiarizamos com o idioma.  Como criar um contrato inteligente agora?  Isso é descrito no arquivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HOWTO</a> anexado à fonte. </p><br><h3 id="akkaunty-v-ton">  Contas TON </h3><br><p>  Como descrevi na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">revisão TON</a> , essa rede contém mais de um blockchain - há um comum, o chamado  “Cadeia principal”, bem como um número arbitrário de “cadeias de trabalho” adicionais identificadas por um número de 32 bits.  A cadeia mestre possui um identificador -1, além disso, também pode ser usada uma cadeia de trabalho "básica" com o identificador 0. Cada cadeia de trabalho pode ter sua própria configuração.  Internamente, cada grupo de trabalho é dividido em shardchains, mas esse já é um detalhe da implementação, que não precisa ser lembrado. </p><br><p>  Muitas contas são armazenadas em uma cadeia de trabalho, com seus próprios identificadores account_id.  Para a cadeia mestre e a cadeia de trabalho zero, eles têm um comprimento de 256 bits.  Assim, o identificador da conta é escrito, por exemplo, assim: </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Este é um formato "bruto": primeiro, o identificador da cadeia de trabalho, depois dois pontos e o identificador da conta em notação hexadecimal. </p><br><p>  Além disso, há um formato reduzido - o número da cadeia de trabalho e o endereço da conta são codificados em formato binário, uma soma de verificação é adicionada a eles e tudo isso é codificado em Base64: </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p>  Conhecendo esse formato de gravação, podemos solicitar o status atual de uma conta através de um cliente de teste usando o comando </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Temos uma resposta como esta: </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp: <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> por -1: 8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D com respeito a blocos (-1,8000000000000000,72355): F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296: 1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F e <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  Vemos a estrutura que é armazenada no DHT da cadeia de trabalho especificada.  Por exemplo, no campo <code>storage.balance</code> é o saldo da conta atual, em <code>storage.state.code</code> é o código do contrato inteligente e em <code>storage.state.data</code> são seus dados atuais.  Observe que o armazenamento de dados TON - célula, células - é uma árvore, cada célula pode ter seus próprios dados, bem como células filho.  Isso é mostrado como recuo nas últimas linhas. </p><br><h3 id="sborka-smart-kontrakta">  Montagem de contrato inteligente </h3><br><p>  Agora vamos criar essa estrutura (ela é chamada BOC - <em>saco de células</em> ) usando a linguagem Fift.  Felizmente, você não precisará escrever um contrato inteligente - na pasta de <code>crypto/block</code> do arquivo de origem, há um arquivo <code>new-wallet.fif</code> que nos ajudará a criar uma nova carteira.  Copie-o para a pasta com o cliente montado ( <code>~/liteclient-build</code> , se você <code>~/liteclient-build</code> instruções acima).  Eu citei seu conteúdo acima como um exemplo de código no Fift. </p><br><p>  Executamos este arquivo da seguinte maneira: </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p>  Aqui, <code>&lt;source-directory&gt;</code> deve ser substituído pelo caminho para as fontes descompactadas (o símbolo "~" não pode ser usado aqui, infelizmente, você precisa do caminho completo).  Em vez de usar a <code>-I</code> você pode definir a <code>FIFTPATH</code> ambiente <code>FIFTPATH</code> e colocar esse caminho nela. </p><br><p>  Desde que lançamos o Fift com o nome de arquivo <code>new-wallet.fif</code> , ele será executado e concluído.  Se você omitir o nome do arquivo, poderá tocar com o intérprete no modo interativo. </p><br><p>  Após a execução, algo como isto deve ser exibido no console: </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p>  Isso significa que a carteira com o identificador <code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> (ou, que é a mesma coisa, <code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code> ).  O código correspondente <code>new-wallet-query.boc</code> no <code>new-wallet-query.boc</code> , seu endereço em <code>new-wallet.addr</code> e a chave privada em <code>new-wallet.pk</code> (cuidado: reiniciar o script substituirá esses arquivos). </p><br><p>  Obviamente, a rede TON ainda não conhece essa carteira, ela é armazenada apenas na forma desses arquivos.  Agora você precisa enviá-lo para a rede.  É verdade que o problema é que, para criar um contrato inteligente, você precisa pagar uma comissão e o saldo da sua conta ainda é zero. </p><br><p>  No modo de trabalho, esse problema será resolvido comprando gramas na bolsa (ou transferindo de outra carteira).  Bem, no modo de teste atual, foi instituído um contrato inteligente especial, no qual você pode solicitar até 20 gramas assim. </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu">  Formação de uma solicitação para o contrato inteligente de outra pessoa </h3><br><p>  Solicite um contrato inteligente, distribuindo gramas à esquerda e à direita, faça-o.  Na mesma pasta de <code>crypto/block</code> , encontramos o arquivo <code>testgiver.fif</code> : </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p>  Também o salvamos na pasta com o cliente montado, mas <code>constant dest_addr</code> a quinta linha - antes da linha " <code>constant dest_addr</code> ".  Substitua-o pelo endereço da carteira que você criou anteriormente (cheio, não abreviado).  "-1:" você não precisa escrever no início; em vez disso, coloque "0x" no início. </p><br><p>  Você também pode alterar a linha <code>6.666 Gram*/ constant amount</code> - esta é a quantidade em gramas que você solicita (não mais que 20).  Mesmo se você especificar um número inteiro, deixe o ponto decimal. </p><br><p>  Finalmente, você precisa corrigir a linha <code>0x00000011 constant seqno</code> .  O primeiro número aqui é o número de sequência atual, que é armazenado na conta que emite os gramas.  De onde obtê-lo?  Como mencionado acima, inicie o cliente e execute: </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  No final, os dados do contrato inteligente serão </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  O número 0000000D (você terá mais) é o número da sequência, que deve ser substituído em <code>testgiver.fif</code> . </p><br><p>  É isso, salve o arquivo e execute ( <code>./crypto/fift testgiver.fif</code> ).  A saída será o <code>wallet-query.boc</code> .  Esta é a <em>mensagem</em> formada para o contrato inteligente de outra pessoa - a solicitação é "transferir tantos gramas para tal e tal conta". </p><br><p>  Usando o cliente, fazemos o upload para a rede: </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p>  Se agora ligarmos por <code>last</code> e depois solicitar novamente o status da conta da qual solicitamos gramas, veremos que o número de sequência aumentou em um - isso significa que ele enviou dinheiro para nossa conta. </p><br><p>  O último passo permanece - carregamos o código da nossa carteira (seu saldo já foi reabastecido, mas sem o código do contrato inteligente, não poderemos gerenciá-lo).  <code>sendfile new-wallet-query.boc</code> - e é isso, você tem sua própria carteira na rede TON (embora por enquanto apenas uma de teste). </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy">  Criar transações de saída </h3><br><p>  Para transferir dinheiro do saldo da conta criada, existe um <code>crypto/block/wallet.fif</code> , que também precisa ser colocado na pasta com o cliente coletado. </p><br><p>  Semelhante às etapas anteriores, você precisa ajustar o valor que transfere, o endereço do destinatário (dest_addr) e o número da sua carteira (é 1 após a inicialização da carteira e aumenta em 1 após cada transação de saída - você pode vê-la solicitando o status da sua conta) .  Para testes, você pode usar, por exemplo, minha carteira - <code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> . </p><br><p>  Quando você executa ( <code>./crypto/fift wallet.fif</code> ), o script pega o endereço da sua carteira (de onde você a transfere) e sua chave privada dos arquivos <code>new-wallet.addr</code> e <code>new-wallet.pk</code> e grava a mensagem recebida em <code>new-wallet-query.boc</code> . </p><br><p>  Como antes, para executar a transação diretamente, chamamos <code>sendfile new-wallet-query.boc</code> no cliente.  Depois disso, não se esqueça de atualizar o estado da blockchain ( <code>last</code> ) e verifique se o saldo e o seqno da nossa carteira mudaram ( <code>getaccount &lt;account_id&gt;</code> ). </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="Descrição da conta"></p><br><p>  Isso é tudo, agora podemos criar contratos inteligentes em TON e enviar solicitações a eles.  Como você pode ver, a funcionalidade atual já é suficiente para, por exemplo, criar uma carteira mais amigável com uma interface gráfica (no entanto, espera-se que ela fique disponível como parte do messenger). </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453714/">https://habr.com/ru/post/pt453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453700/index.html">Lições sobre SDL 2: Lição 1 - Olá, SDL 2</a></li>
<li><a href="../pt453706/index.html">Como passei no exame de certificação do Google Cloud Professional Data Engineer</a></li>
<li><a href="../pt453708/index.html">SO em tempo real AQUA RTOS para MK AVR em ambiente BASCOM AVR</a></li>
<li><a href="../pt453710/index.html">Prática de desenvolvimento em grandes projetos: mitp SberPractice iOS # 1</a></li>
<li><a href="../pt453712/index.html">Como o eBay criou um scanner de código de barras no WebAssembly</a></li>
<li><a href="../pt453716/index.html">Coworking no país para o pessoal de TI da família - existe alguém?</a></li>
<li><a href="../pt453720/index.html">Sutilezas de expressões lambda em c #</a></li>
<li><a href="../pt453722/index.html">Sobre pesquisa de processos não estacionários</a></li>
<li><a href="../pt453728/index.html">Batalha dos Hyperstars</a></li>
<li><a href="../pt453730/index.html">Odontologia moderna: implantação dentária simultânea e extensão do osso maxilar através dos olhos do diretor técnico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>