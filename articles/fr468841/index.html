<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï† üìß üì± Livraison continue pour votre biblioth√®que Kotlin Multiplatform üßôüèø üë≤üèª ‚è´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Je m'appelle Yuri Vlad, je suis d√©veloppeur Android chez Badoo et participe √† la cr√©ation de la biblioth√®que Reaktive - Reactive Extensions sur ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Livraison continue pour votre biblioth√®que Kotlin Multiplatform</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/468841/"><p><img src="https://habrastorage.org/webt/eo/oi/r6/eooir6an-e6waiaephqkshtswjm.jpeg" alt="Le logo"></p><br><p>  Salut  Je m'appelle Yuri Vlad, je suis d√©veloppeur Android chez Badoo et participe √† la cr√©ation de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Reaktive</a> - Reactive Extensions sur Kotlin pur. </p><br><p>  Dans le processus, nous sommes confront√©s au fait que dans le cas de l'int√©gration continue et de la livraison continue de Kotlin Multiplatform, une configuration suppl√©mentaire est n√©cessaire.  Il est n√©cessaire d'avoir plusieurs machines virtuelles sur diff√©rents syst√®mes d'exploitation afin d'assembler compl√®tement la biblioth√®que.  Dans cet article, je vais vous montrer comment configurer la livraison continue pour votre biblioth√®que Kotlin Multiplatform. </p><a name="habracut"></a><br><h2 id="continuous-integration-i-continuous-delivery-dlya-open-source-bibliotek">  Int√©gration et livraison continues pour les biblioth√®ques open source </h2><br><p>  L'int√©gration continue et la livraison continue font depuis longtemps partie de la communaut√© open source gr√¢ce √† divers services.  Beaucoup d'entre eux fournissent gratuitement leurs services √† des projets open source: Travis CI, JitPack, CircleCI, Microsoft Azure Pipelines, les actions GitHub r√©cemment lanc√©es. </p><br><p>  Dans les projets open source de Badoo pour Android, nous utilisons Travis CI pour une int√©gration continue et JitPack pour une livraison continue. </p><br><p>  Apr√®s avoir impl√©ment√© le support iOS dans notre biblioth√®que multi-plateforme, j'ai constat√© que nous ne pouvons pas construire la biblioth√®que √† l'aide de JitPack, car il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne fournit pas</a> de machines virtuelles sur macOS (iOS ne peut √™tre construit que sur macOS). </p><br><p> Par cons√©quent, pour une publication ult√©rieure de la biblioth√®que, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bintray</a> , plus familier √† tout le monde, a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">choisi</a> .  Il prend en charge un r√©glage plus fin des artefacts publi√©s, contrairement √† JitPack, qui a simplement pris tous les r√©sultats de l'appel <code>publishToMavenLocal</code> . </p><br><p>  Pour la publication, il est recommand√© d'utiliser le plugin Gradle Bintray, que j'ai ensuite personnalis√© selon nos besoins.  Et pour construire le projet, j'ai continu√© √† utiliser Travis CI pour plusieurs raisons: premi√®rement, je le connaissais d√©j√† et je l'ai utilis√© dans presque tous mes projets pour animaux de compagnie;  deuxi√®mement, il fournit les machines virtuelles macOS n√©cessaires pour construire sur iOS. </p><br><h2 id="parallelnaya-sborka-multiplatformennoy-biblioteki">  Assemblage parall√®le d'une biblioth√®que multi-plateforme </h2><br><p>  Si vous plongez dans les entrailles de la documentation Kotlin, vous pouvez trouver une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">section</a> sur la publication de biblioth√®ques multi-plateformes. </p><br><p>  Les d√©veloppeurs de Kotlin Multiplatform sont conscients des probl√®mes d'assemblage multiplateforme (tout ne peut pas √™tre construit sur n'importe quel syst√®me d'exploitation) et proposent de construire la biblioth√®que s√©par√©ment sur diff√©rents syst√®mes d'exploitation. </p><br><pre> <code class="plaintext hljs">kotlin { jvm() js() mingwX64() linuxX64() // Note that the Kotlin metadata is here, too. // The mingwx64() target is automatically skipped as incompatible in Linux builds. configure([targets["metadata"], jvm(), js()]) { mavenPublication { targetPublication -&gt; tasks.withType(AbstractPublishToMaven) .matching { it.publication == targetPublication } .all { onlyIf { findProperty("isLinux") == "true" } } } } }</code> </pre> <br><p>  Comme vous pouvez le voir dans le code ci-dessus, selon la propri√©t√© <code>isLinux</code> pass√©e √† Gradle, nous <code>isLinux</code> publication de certaines cibles.  Sous les objectifs √† l'avenir, je parlerai de l'assemblage d'une plate-forme sp√©cifique.  Sous Windows, seule la cible Windows sera collect√©e, tandis que sur d'autres syst√®mes d'exploitation, les m√©tadonn√©es et les autres cibles seront collect√©es. </p><br><p>  Une solution tr√®s belle et concise qui ne fonctionne que pour <code>publishToMavenLocal</code> ou <code>publish</code> partir du plugin <code>maven-publish</code> , qui ne nous convient pas en raison de l'utilisation du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin Gradle Bintray</a> . </p><br><p>  J'ai d√©cid√© d'utiliser la variable d'environnement pour s√©lectionner la cible, car ce code a √©t√© pr√©c√©demment √©crit en Groovy, se trouve dans un script Groovy Gradle distinct et l'acc√®s aux variables d'environnement se fait √† partir d'un contexte statique. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Target</span></span></span><span class="hljs-class"> </span></span>{ ALL, COMMON, IOS, META; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> common: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"isCommon"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == ALL || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == COMMON <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ios: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"isIos"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == ALL || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == IOS <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> meta: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"isMeta"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == ALL || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == META <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-meta"><span class="hljs-meta">@JvmStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentTarget</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Target { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> value = System.getProperty(<span class="hljs-string"><span class="hljs-string">"MP_TARGET"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values().find { it.name.equals(value, ignoreCase = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } ?: ALL } } }</code> </pre> <br><p>  Dans le cadre de notre projet, j'ai identifi√© quatre groupes de cibles: </p><br><ol><li>  ALL - toutes les cibles sont connect√©es et collect√©es, utilis√©es pour le d√©veloppement et comme valeur par d√©faut. </li><li>  COMMUN - seules les cibles compatibles Linux sont connect√©es et collect√©es.  Dans notre cas, il s'agit de JavaScript, JVM, JVM Android, Linux x64 et Linux ARM x32. </li><li>  IOS - seules les cibles iOS sont connect√©es et collect√©es; elles sont utilis√©es pour l'assemblage sur macOS. </li><li>  META - toutes les cibles sont connect√©es, mais seul le module contenant les m√©ta-informations pour les m√©tadonn√©es Gradle est assembl√©. </li></ol><br><p>  Avec cet ensemble de groupes cibles, nous pouvons parall√©liser l'assemblage du projet en trois machines virtuelles diff√©rentes (COMMUN - Linux, IOS - macOS, META - Linux). </p><br><p>  Pour le moment, vous pouvez tout construire sur macOS, mais ma solution pr√©sente deux avantages.  Premi√®rement, si nous d√©cidons de mettre en ≈ìuvre la prise en charge de Windows, nous avons juste besoin d'ajouter un nouveau groupe cible et une nouvelle machine virtuelle sur Windows pour le construire.  Deuxi√®mement, il n'est pas n√©cessaire de d√©penser des ressources de machine virtuelle sur macOS sur ce que vous pouvez construire sur Linux.  Le temps CPU sur ces machines virtuelles est g√©n√©ralement deux fois plus cher. </p><br><h2 id="gradle-metadata">  M√©tadonn√©es Gradle </h2><br><p>  Que sont les m√©tadonn√©es Gradle et √† quoi servent-elles? </p><br><p>  Maven utilise actuellement POM (Project Object Model) pour r√©soudre les d√©pendances. </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.jakewharton.rxbinding2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>rxbinding-leanback-v17-kotlin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.2.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span>aar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>RxBinding Kotlin (leanback-v17)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>RxJava binding APIs for Android's UI widgets.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://github.com/JakeWharton/RxBinding/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">licenses</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">license</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>The Apache Software License, Version 2.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">distribution</span></span></span><span class="hljs-tag">&gt;</span></span>repo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">distribution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">license</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">licenses</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>jakewharton<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>Jake Wharton<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scm</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connection</span></span></span><span class="hljs-tag">&gt;</span></span>scm:git:git://github.com/JakeWharton/RxBinding.git<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connection</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developerConnection</span></span></span><span class="hljs-tag">&gt;</span></span>scm:git:ssh://git@github.com/JakeWharton/RxBinding.git<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">developerConnection</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://github.com/JakeWharton/RxBinding/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scm</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.android.support<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>support-annotations<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>28.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>compile<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Le fichier POM contient des informations sur la version de la biblioth√®que, son cr√©ateur et les d√©pendances n√©cessaires. </p><br><p>  Mais que se passe-t-il si nous voulons avoir deux versions de la biblioth√®que pour diff√©rents JDK?  Par exemple, <code>kotlin-stdlib</code> a deux versions: <code>kotlin-stdlib-jdk8</code> et <code>kotlin-stdlib-jdk7</code> .  Les utilisateurs doivent connecter la version souhait√©e. </p><br><p>  Lors de la mise √† niveau de la version JDK, il est facile d'oublier les d√©pendances externes.  C'est pour r√©soudre ce probl√®me que Gradle Metadata a √©t√© cr√©√©, ce qui vous permet d'ajouter des conditions suppl√©mentaires pour connecter une biblioth√®que particuli√®re. </p><br><p>  Un des attributs de m√©tadonn√©es Gradle pris en charge est <code>org.gradle.jvm.version</code> , qui indique la version du JDK.  Par cons√©quent, pour <code>kotlin-stdlib</code> une forme simplifi√©e d'un fichier de m√©tadonn√©es pourrait ressembler √† ceci: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"formatVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"component"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"kotlin-stdlib"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.3.0"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"variants"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"apiElements"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"org.gradle.jvm.version"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"available-at"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"../../kotlin-stdlib-jdk8/1.3.0/kotlin-stdlib-jdk8.module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"kotlin-stdlib-jdk8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.3.0"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"apiElements"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"org.gradle.jvm.version"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"available-at"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"../../kotlin-stdlib-jdk7/1.3.0/kotlin-stdlib-jdk7.module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"kotlin-stdlib-jdk7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.3.0"</span></span> } } ] }</code> </pre> <br><p>  Plus pr√©cis√©ment, dans notre cas, <code>reaktive-1.0.0-rc1.module</code> sous une forme simplifi√©e ressemble √† ceci: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"formatVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"component"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"com.badoo.reaktive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"reaktive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-rc1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"org.gradle.status"</span></span>: <span class="hljs-string"><span class="hljs-string">"release"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"createdBy"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"gradle"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.4.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"buildId"</span></span>: <span class="hljs-string"><span class="hljs-string">"tv44qntk2zhitm23bbnqdngjam"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"variants"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"android-releaseRuntimeElements"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"com.android.build.api.attributes.BuildTypeAttr"</span></span>: <span class="hljs-string"><span class="hljs-string">"release"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"com.android.build.api.attributes.VariantAttr"</span></span>: <span class="hljs-string"><span class="hljs-string">"release"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"com.android.build.gradle.internal.dependency.AndroidTypeAttr"</span></span>: <span class="hljs-string"><span class="hljs-string">"Aar"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.gradle.usage"</span></span>: <span class="hljs-string"><span class="hljs-string">"java-runtime"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.jetbrains.kotlin.platform.type"</span></span>: <span class="hljs-string"><span class="hljs-string">"androidJvm"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"available-at"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"../../reaktive-android/1.0.0-rc1/reaktive-android-1.0.0-rc1.module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"com.badoo.reaktive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"reaktive-android"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-rc1"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ios64-api"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"org.gradle.usage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kotlin-api"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.jetbrains.kotlin.native.target"</span></span>: <span class="hljs-string"><span class="hljs-string">"ios_arm64"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.jetbrains.kotlin.platform.type"</span></span>: <span class="hljs-string"><span class="hljs-string">"native"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"available-at"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"../../reaktive-ios64/1.0.0-rc1/reaktive-ios64-1.0.0-rc1.module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"com.badoo.reaktive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"reaktive-ios64"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-rc1"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"linuxX64-api"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"attributes"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"org.gradle.usage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kotlin-api"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.jetbrains.kotlin.native.target"</span></span>: <span class="hljs-string"><span class="hljs-string">"linux_x64"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org.jetbrains.kotlin.platform.type"</span></span>: <span class="hljs-string"><span class="hljs-string">"native"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"available-at"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"../../reaktive-linuxx64/1.0.0-rc1/reaktive-linuxx64-1.0.0-rc1.module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"com.badoo.reaktive"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"module"</span></span>: <span class="hljs-string"><span class="hljs-string">"reaktive-linuxx64"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-rc1"</span></span> } }, ] }</code> </pre> <br><p>  Gr√¢ce aux attributs <code>org.jetbrains.kotlin</code> Gradle comprend dans quel cas quelle d√©pendance tirer dans l'ensemble source souhait√©. </p><br><p>  Vous pouvez activer les m√©tadonn√©es en utilisant: </p><br><pre> <code class="kotlin hljs">enableFeaturePreview(<span class="hljs-string"><span class="hljs-string">"GRADLE_METADATA"</span></span>)</code> </pre> <br><p>  Vous pouvez trouver des informations d√©taill√©es dans la <a href="">documentation</a> . </p><br><h2 id="nastroyka-publikacii">  Param√®tre de publication </h2><br><p>  Apr√®s avoir d√©termin√© les cibles et la parall√©lisation de l'assemblage, nous devons configurer quoi exactement et comment nous publierons. </p><br><p>  Pour la publication, nous utilisons le plugin Gradle Bintray, donc la premi√®re chose √† faire est de se tourner vers son <a href="">fichier README</a> et de configurer les informations sur notre r√©f√©rentiel et les informations d'identification pour la publication. </p><br><p>  Nous effectuerons la configuration compl√®te dans notre propre plugin dans le dossier <code>buildSrc</code> . <br>  L'utilisation de <code>buildSrc</code> offre plusieurs avantages, y compris une saisie semi-automatique toujours fonctionnelle (dans le cas des scripts Kotlin, elle ne fonctionne toujours pas toujours et n√©cessite souvent un appel pour appliquer les d√©pendances), la possibilit√© de r√©utiliser les classes d√©clar√©es et d'y acc√©der √† partir des scripts Groovy et Kotlin.  Vous pouvez voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple d'utilisation de</a> <code>buildSrc</code> partir des derni√®res E / S de Google (section Gradle). </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupBintrayPublishingInformation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(target: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Project</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  Bintray Plugin   target.plugins.apply(BintrayPlugin::class) //    target.extensions.getByType(BintrayExtension::class).apply { user = target.findProperty("bintray_user")?.toString() key = target.findProperty("bintray_key")?.toString() pkg.apply { repo = "maven" name = "reaktive" userOrg = "badoo" vcsUrl = "https://github.com/badoo/Reaktive.git" setLicenses("Apache-2.0") version.name = target.property("reaktive_version")?.toString() } } }</span></span></code> </pre> <br><p>  J'utilise trois propri√©t√©s dynamiques du projet: <code>bintray_user</code> et <code>bintray_key</code> , qui peuvent √™tre obtenues √† partir des param√®tres de profil personnels sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bintray</a> , et <code>reaktive_version</code> , qui est d√©fini dans le fichier racine <code>build.gradle</code> . </p><br><p>  Pour chaque cible, le plugin Kotlin Multiplatform cr√©e une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MavenPublication</a> , qui est disponible dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PublishingExtension</a> . </p><br><p>  En utilisant l'exemple de code de la documentation Kotlin que j'ai fourni ci-dessus, nous pouvons cr√©er cette configuration: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfigurationMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Map&lt;String, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mppTarget = Target.currentTarget() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapOf( <span class="hljs-string"><span class="hljs-string">"kotlinMultiplatform"</span></span> to mppTarget.meta, KotlinMultiplatformPlugin.METADATA_TARGET_NAME to mppTarget.meta, <span class="hljs-string"><span class="hljs-string">"jvm"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"js"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"androidDebug"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"androidRelease"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"linuxX64"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"linuxArm32Hfp"</span></span> to mppTarget.common, <span class="hljs-string"><span class="hljs-string">"iosArm32"</span></span> to mppTarget.ios, <span class="hljs-string"><span class="hljs-string">"iosArm64"</span></span> to mppTarget.ios, <span class="hljs-string"><span class="hljs-string">"iosX64"</span></span> to mppTarget.ios ) }</code> </pre> <br><p>  Dans cette carte simple, nous d√©crivons quelles publications doivent √™tre publi√©es sur une machine virtuelle particuli√®re.  Le nom de la publication est le nom de la cible.  Cette configuration est parfaitement coh√©rente avec la description des groupes cibles que j'ai cit√©e ci-dessus. </p><br><p>  Configurons la publication dans Bintray.  Le plugin Bintray cr√©e une <code>BintrayUploadTask</code> , que nous personnaliserons selon nos besoins. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupBintrayPublishing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( target: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Project</span></span></span></span><span class="hljs-function"><span class="hljs-params">, taskConfigurationMap: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; )</span></span></span></span> { target.tasks.named(BintrayUploadTask.getTASK_NAME(), BintrayUploadTask::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">) </span></span>{ doFirst { <span class="hljs-comment"><span class="hljs-comment">//   } } }</span></span></code> </pre> <br><p>  Tous ceux qui commencent √† travailler avec le plugin Bintray d√©couvrent rapidement que son r√©f√©rentiel est recouvert de mousse depuis longtemps (la derni√®re mise √† jour remonte √† environ six mois) et que tous les probl√®mes sont r√©solus par toutes sortes de hacks et de b√©quilles dans l'onglet Probl√®mes.  La prise en charge d'une nouvelle technologie telle que Gradle Metadata n'a pas √©t√© impl√©ment√©e, mais dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me</a> correspondant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> vous pouvez trouver une solution que nous utilisons. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> publishing = project.extensions.getByType(PublishingExtension::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">publishing</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">publications</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filterIsInstance</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MavenPublication</span></span></span><span class="hljs-class">&gt;</span></span>() .forEach { publication -&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> moduleFile = project.buildDir.resolve(<span class="hljs-string"><span class="hljs-string">"publications/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${publication.name}</span></span></span><span class="hljs-string">/module.json"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (moduleFile.exists()) { publication.artifact(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : FileBasedMavenArtifact(moduleFile) { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultExtension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = <span class="hljs-string"><span class="hljs-string">"module"</span></span> }) } }</code> </pre> <br><p>  √Ä l'aide de ce code, nous ajoutons le fichier <code>module.json</code> √† la liste des artefacts √† publier, gr√¢ce auquel Gradle Metadata fonctionne. </p><br><p>  Mais nos probl√®mes ne s'arr√™tent pas l√†.  Lorsque vous essayez d'ex√©cuter <code>bintrayPublish</code> rien ne se produit. </p><br><p>  Dans le cas des biblioth√®ques Java et Kotlin classiques, Bintray extrait automatiquement les publications disponibles et les publie.  Cependant, dans le cas de Kotlin Multiplatform, lors de l'extraction automatique de publications, le plugin se bloque simplement avec une erreur.  Et oui, il y a aussi un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me sur GitHub</a> pour cela.  Et nous utiliserons √† nouveau la solution √† partir de l√†, uniquement en filtrant les publications dont nous avons besoin. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> publications = publishing.publications .filterIsInstance&lt;MavenPublication&gt;() .filter { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = taskConfigurationMap[it.name] == <span class="hljs-literal"><span class="hljs-literal">true</span></span> logger.warn(<span class="hljs-string"><span class="hljs-string">"Artifact '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.groupId}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.artifactId}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.version}</span></span></span><span class="hljs-string">' from publication '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.name}</span></span></span><span class="hljs-string">' should be published: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$res</span></span></span><span class="hljs-string">"</span></span>) res } .map { logger.warn(<span class="hljs-string"><span class="hljs-string">"Uploading artifact '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.groupId}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.artifactId}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.version}</span></span></span><span class="hljs-string">' from publication '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it.name}</span></span></span><span class="hljs-string">'"</span></span>) it.name } .toTypedArray() setPublications(*publications)</code> </pre> <br><p>  Mais ce code ne fonctionne pas non plus! </p><br><p>  En effet, <code>bintrayUpload</code> n'a pas de t√¢che dans les d√©pendances qui assemblerait le projet et cr√©erait les fichiers n√©cessaires √† la publication.  La solution la plus √©vidente est de d√©finir <code>publishToMavenLocal</code> comme une d√©pendance <code>publishToMavenLocal</code> , mais pas si simple. </p><br><p>  Lors de la collecte des m√©tadonn√©es, nous connectons toutes les cibles au projet, ce qui signifie que <code>publishToMavenLocal</code> compilera toutes les cibles, car les d√©pendances pour cette t√¢che incluent <code>publishToMavenLocalAndroidDebug</code> , <code>publishToMavenLocalAndroiRelase</code> , <code>publishToMavenLocalJvm</code> , etc. </p><br><p>  Par cons√©quent, nous allons cr√©er une t√¢che proxy distincte, en fonction de laquelle nous mettons uniquement les <code>publishToMavenLocalX</code> dont nous avons besoin, et nous mettrons cette t√¢che elle-m√™me dans la d√©pendance <code>bintrayPublish</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupLocalPublishing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( target: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Project</span></span></span></span><span class="hljs-function"><span class="hljs-params">, taskConfigurationMap: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; )</span></span></span></span> { target.project.tasks.withType(AbstractPublishToMaven::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configureEach</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> configuration = publication?.name ?: run { <span class="hljs-comment"><span class="hljs-comment">// Android-       PublishToMaven,        val configuration = taskConfigurationMap.keys.find { name.contains(it, ignoreCase = true) } logger.warn("Found $configuration for $name") configuration } //          enabled = taskConfigurationMap[configuration] == true } } private fun createFilteredPublishToMavenLocalTask(target: Project) { //  -         publishToMavenLocal target.tasks.register(TASK_FILTERED_PUBLISH_TO_MAVEN_LOCAL) { dependsOn(project.tasks.matching { it is AbstractPublishToMaven &amp;&amp; it.enabled }) } }</span></span></code> </pre> <br><p>  Il ne reste plus qu'√† rassembler tout le code et √† appliquer le plug-in r√©sultant √† un projet dans lequel la publication est requise. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PublishPlugin</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Plugin</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Project</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(target: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Project</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> taskConfigurationMap = createConfigurationMap() createFilteredPublishToMavenLocalTask(target) setupLocalPublishing(target, taskConfigurationMap) setupBintrayPublishingInformation(target) setupBintrayPublishing(target, taskConfigurationMap) }</code> </pre> <br><pre> <code class="plaintext hljs">apply plugin: PublishPlugin</code> </pre> <br><p>  Le code complet de <code>PublishPlugin</code> peut √™tre trouv√© dans notre r√©f√©rentiel <a href="">ici</a> . </p><br><h2 id="nastroyka-travis-ci">  Configurer Travis CI </h2><br><p>  La partie la plus difficile est termin√©e.  Il reste √† configurer Travis CI afin qu'il parall√©lise l'assembly et publie des artefacts sur Bintray lorsqu'une nouvelle version est publi√©e. </p><br><p>  Nous d√©signerons la sortie de la nouvelle version en cr√©ant un tag sur le commit. </p><br><pre> <code class="plaintext hljs">#    ( ) matrix: include: #  Linux  Android  Chrome    JS, JVM, Android JVM  Linux - os: linux dist: trusty addons: chrome: stable language: android android: components: - build-tools-28.0.3 - android-28 #  MP_TARGET,        env: MP_TARGET=COMMON #     install ‚Äî Gradle     install: true #    JVM       RxJava2 script: ./gradlew reaktive:check reaktive-test:check rxjava2-interop:check -DMP_TARGET=$MP_TARGET #  macOS   iOS- - os: osx osx_image: xcode10.2 language: java env: MP_TARGET=IOS install: true script: ./gradlew reaktive:check reaktive-test:check -DMP_TARGET=$MP_TARGET #  Linux    - os: linux language: android android: components: - build-tools-28.0.3 - android-28 env: MP_TARGET=META #     -  install: true script: true #    Gradle (           ) before_cache: - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock - rm -fr $HOME/.gradle/caches/*/plugin-resolution/ cache: directories: - $HOME/.gradle/caches/ - $HOME/.gradle/wrapper/ #  ,   Kotlin/Native    - $HOME/.konan/ #     Bintray    ,           deploy: skip_cleanup: true provider: script script: ./gradlew bintrayUpload -DMP_TARGET=$MP_TARGET -Pbintray_user=$BINTRAY_USER -Pbintray_key=$BINTRAY_KEY on: tags: true</code> </pre> <br><p>  Si, pour une raison quelconque, l'assembly sur l'une des machines virtuelles a √©chou√©, les m√©tadonn√©es et autres cibles seront toujours t√©l√©charg√©es sur le serveur Bintray.  C'est pourquoi nous n'ajoutons pas de bloc avec lib√©ration automatique de la biblioth√®que sur Bintray via leur API. </p><br><p>  Lors de la publication de la version, vous devez vous assurer que tout est en ordre et cliquer sur le bouton pour publier la nouvelle version sur le site, car tous les artefacts sont d√©j√† t√©l√©charg√©s. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Nous avons donc mis en place une int√©gration et une livraison continues dans notre projet Kotlin Multiplatform. </p><br><p>  Ayant parall√©lis√© les t√¢ches d'assemblage, d'ex√©cution de tests et de publication d'artefacts, nous utilisons efficacement les ressources qui nous sont fournies gratuitement. </p><br><p>  Et si vous utilisez Linux (comme Arkady Ivanov <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">arkivanov</a> , auteur de la biblioth√®que Reaktive), vous n'avez plus besoin de demander √† la personne utilisant macOS (moi) de publier la biblioth√®que chaque fois qu'une nouvelle version est publi√©e. </p><br><p>  J'esp√®re qu'apr√®s la publication de cet article, d'autres projets commenceront √† utiliser cette approche pour automatiser les activit√©s de routine. </p><br><p>  Merci de votre attention! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468841/">https://habr.com/ru/post/fr468841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468825/index.html">Arr√™tez de penser que le SLA vous sauvera. Il faut calmer et cr√©er un faux sentiment de s√©curit√©.</a></li>
<li><a href="../fr468827/index.html">Gadgets pour dormir</a></li>
<li><a href="../fr468833/index.html">Algorithmes de recherche de nombres premiers</a></li>
<li><a href="../fr468835/index.html">Temps "perdu": qu'est-ce qui soudoie une montre m√©canique aujourd'hui?</a></li>
<li><a href="../fr468837/index.html">Comment mener un entretien technique: un plan d'action pour les d√©butants</a></li>
<li><a href="../fr468843/index.html">Avez-vous peur de mettre en place un syst√®me CRM? Votre entreprise est peut-√™tre malade</a></li>
<li><a href="../fr468845/index.html">Un court cours de physiologie de la ville, ou parties du corps</a></li>
<li><a href="../fr468847/index.html">March√©s publics dans d'autres pays: pourquoi les lois ont besoin de cadres</a></li>
<li><a href="../fr468849/index.html">R√©tro-ing√©nierie de processeur inconnu dans un seul programme</a></li>
<li><a href="../fr468851/index.html">Impl√©mentation d'animation dans React Native</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>