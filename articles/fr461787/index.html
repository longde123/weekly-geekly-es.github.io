<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∂üèª üßöüèæ üéé Affichage de texte Android üë©üèø‚Äçüè´ üëäüèø üë©üèª‚Äçü§ù‚Äçüë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'affichage d'informations textuelles est probablement la partie la plus fondamentale et la plus importante de nombreuses applications Android. Cet ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Affichage de texte Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/461787/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/2_/_o/mc2__o7rq1m6ex9alol6ivz5vey.png"></div><br><p>  L'affichage d'informations textuelles est probablement la partie la plus fondamentale et la plus importante de nombreuses applications Android.  Cet article parlera de TextView.  Chaque d√©veloppeur, √† commencer par ¬´Hello World¬ª, est constamment confront√© √† cet √©l√©ment d'interface utilisateur.  De temps en temps, lorsque vous travaillez avec du texte, vous devez penser √† impl√©menter diverses solutions de conception ou √† am√©liorer les performances lors du rendu de l'√©cran. </p><br><p>  Je vais parler du p√©riph√©rique TextView et de certaines subtilit√©s de son utilisation.  Des conseils cl√©s ont √©t√© tir√©s de rapports sur les anciennes E / S Google </p><a name="habracut"></a><br><h1 id="textview-pod-kapotom">  TextView sous le capot </h1><br><p>  Pour le rendu de texte dans Android, une pile enti√®re de biblioth√®ques diff√©rentes est utilis√©e sous le capot.  Ils peuvent √™tre divis√©s en deux parties principales - le code java et le code natif: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hb/p0/gg/hbp0ggycnpeisn8v8hwyqkkmvfq.png" width="800"></div><br><p>  Le code Java fait essentiellement partie du SDK Android disponible pour les d√©veloppeurs d'applications et ses nouvelles fonctionnalit√©s peuvent √™tre port√©es vers la biblioth√®que de support. </p><br><p>  Le noyau TextView lui-m√™me est √©crit en C ++, ce qui limite le portage √† la biblioth√®que de support des nouvelles fonctionnalit√©s impl√©ment√©es √† partir de nouvelles versions du syst√®me d'exploitation.  Le noyau est constitu√© des biblioth√®ques suivantes: </p><br><ul><li>  Minikin est utilis√© pour mesurer la longueur du texte, des sauts de ligne et des mots par syllabes. </li><li>  ICU fournit un support Unicode. </li><li>  HarfBuzz trouve pour les caract√®res Unicode les √©l√©ments graphiques (glyphes) correspondants dans les polices. </li><li>  FreeType cr√©e des bitmaps de glyphes. </li><li>  Skia est un moteur pour dessiner des graphiques 2D. </li></ul><br><h2 id="izmerenie-dliny-teksta-i-perenos-strok">  Mesurer la longueur du texte et les sauts de ligne </h2><br><p>  Si vous passez la ligne √† la biblioth√®que Minikin, qui est utilis√©e √† l'int√©rieur de TextView, la premi√®re chose qu'elle d√©termine est de savoir quels glyphes la ligne se compose: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/1o/uk/qt1ouktu4gn9x0wncbgiy2a7qkg.png" width="800"></div><br>
<p> Comme vous pouvez le voir dans cet exemple, faire correspondre les caract√®res Unicode avec les glyphes ne sera pas toujours un √† un: ici, 3 caract√®res √† la fois correspondront √† un glyphe ffi.  De plus, il convient de noter que les glyphes n√©cessaires peuvent √™tre trouv√©s dans diff√©rentes polices syst√®me. </p><br><p>  Trouver des glyphes uniquement dans les polices syst√®me peut entra√Æner des difficult√©s, en particulier si les ic√¥nes ou les emojis sont affich√©s √† travers les caract√®res, et il est cens√© combiner les caract√®res de diff√©rentes polices sur une seule ligne.  Par cons√©quent, √† partir d' <strong>Android Q (29)</strong> , il est devenu possible de cr√©er votre propre liste de polices fournies avec l'application.  Cette liste sera utilis√©e pour rechercher des glyphes: </p><br><pre> <code class="kotlin hljs">textView.typeface = TypeFace.CustomFallbackBuilder( FontFamily.Builder( Font.Builder(assets, ‚Äúlato.ttf‚Äù).build() ).build() ).addCustomFallback( FontFamily.Builder( Font.Builder(assets, ‚Äúkosugi.ttf‚Äù).build() ).build() ).build()</code> </pre> <br><p>  D√©sormais, √† l'aide de <code>CustomFallbackBuilder</code> lors de la mise en correspondance de caract√®res avec des glyphes, le SDK <code>CustomFallbackBuilder</code> la famille de polices sp√©cifi√©e dans l'ordre, et s'il est introuvable, la recherche se poursuit dans les polices syst√®me (et gr√¢ce √† la m√©thode <code>setSystemFallback()</code> , vous pouvez sp√©cifier la famille de polices syst√®me pr√©f√©r√©e).  <code>CustomFallbackBuilder</code> a une limite sur le nombre de familles de polices - vous ne pouvez pas ajouter plus de 64 polices. </p><br><p>  La biblioth√®que Minikin divise les cha√Ænes en mots et mesure les mots individuels.  Pour acc√©l√©rer le travail, en commen√ßant par <strong>Lollipop (21)</strong> , un cache syst√®me <abbr title="moins r√©cemment utilis√©">LRU</abbr> de mots est utilis√©.  Un tel cache donne un √©norme gain de performances: un appel √† <code>Paint.measureText()</code> pour un mot mis en cache prendra en moyenne 3% du temps lors du premier calcul de sa taille. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d2/f1/om/d2f1omfjlqmmfqalip3whmes-1o.png" width="800"></div><br><p>  Si le texte ne correspond pas √† la largeur sp√©cifi√©e, Minikin organise les sauts de ligne et les mots dans le texte.  √Ä partir de <strong>Marshmallow (23),</strong> vous pouvez contr√¥ler son comportement en sp√©cifiant les attributs sp√©ciaux <code>breakStrategy</code> et <code>hyphenationFrequency</code> pour TextView. </p><br><p>  Avec la valeur <code>breakStrategy=simple</code> biblioth√®que arrangera simplement les tirets s√©quentiellement, en passant par le texte: d√®s que la ligne cesse de tenir, la c√©sure est plac√©e avant le dernier mot. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/im/lc/cr/imlccruuhjr59qzrtpwjmrf6hhk.png" width="600"></div><br><p>  Dans la valeur <code>balanced</code> biblioth√®que essaiera de faire des sauts de ligne afin que les lignes soient align√©es en largeur. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v5/ys/kc/v5yskcuiwypdyponmrdqep7zaq8.png" width="600"></div><br><p>  <code>high_quality</code> a presque le m√™me comportement que <code>balanced</code> , √† l'exception de quelques diff√©rences (l'une d'entre elles: sur l'avant-derni√®re ligne, la c√©sure peut √™tre non seulement des mots s√©par√©s, mais aussi des mots par syllabes). </p><br><p>  L'attribut <code>hyphenationFrequency</code> permet de contr√¥ler la strat√©gie d'habillage des mots par syllabes.  Une valeur <code>none</code> ne fera pas de c√©sure automatique, <code>normal</code> fera une petite fr√©quence de c√©sure et <code>full</code> , en cons√©quence, utilisera le nombre maximum de mots. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ng/cr/hs/ngcrhsphklaxxe842klpnx8mhnw.png" width="600"></div><br><p>  Performances de rendu du texte en fonction des indicateurs s√©lectionn√©s (mesur√©es sur <strong>Android P (28)</strong> ): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tx/5r/33/tx5r339s93s1nq6go8hieqhv6fq.png" width="600"></div><br><p>  Compte tenu d'une performance assez forte, les d√©veloppeurs de Google, √† partir de la version <strong>Q (29)</strong> et d' <strong>AppCompat 1.1.0</strong> , ont d√©cid√© de d√©sactiver la c√©sure par d√©faut.  Si l'habillage de mots est important dans l'application, vous devez maintenant l'activer explicitement. </p><br><p>  Lors de l'utilisation de l'habillage de mots, il faut tenir compte du fait que la langue actuellement s√©lectionn√©e dans le syst√®me d'exploitation affectera le fonctionnement de la biblioth√®que.  Selon la langue, le syst√®me s√©lectionnera des dictionnaires sp√©ciaux avec des r√®gles de transfert. </p><br><h1 id="stili-teksta">  Styles de texte </h1><br><p>  Il existe plusieurs fa√ßons de styliser du texte dans Android: </p><br><ul><li>  <strong>Un style unique</strong> qui s'applique √† l'ensemble de l'√©l√©ment TextView. </li><li>  <strong>Multi-style (multi style)</strong> - plusieurs styles √† la fois, qui peuvent √™tre appliqu√©s au texte, au niveau du paragraphe ou des caract√®res individuels.  Il existe plusieurs fa√ßons de proc√©der: <br><ul><li>  dessin de texte sur toile </li><li>  balises html </li><li>  √©l√©ments de balisage sp√©ciaux - √©tendues </li></ul></li></ul><br><p>  Un style unique implique l'utilisation de styles XML ou d'attributs XML dans le balisage TextView.  Dans ce cas, le syst√®me appliquera les valeurs des ressources dans l'ordre suivant: Apparence du texte, th√®me (Th√®me), style par d√©faut (Style par d√©faut), style de l'application, et la priorit√© la plus √©lev√©e est les valeurs des attributs View. </p><br><p>  L'utilisation des ressources est une solution assez simple, mais, malheureusement, elle ne vous permet pas d'appliquer du style √† certaines parties du texte. </p><br><p>  Les balises HTML sont une autre solution simple qui fournit des fonctionnalit√©s telles que la mise en gras de mots individuels, l'italique ou m√™me la mise en √©vidence de listes avec des points dans le texte.  Tout ce dont le d√©veloppeur a besoin est d'appeler la m√©thode <code>Html.fromHtml()</code> , qui transformera le texte balis√© en texte balis√© par des √©tendues.  Mais cette solution a des capacit√©s limit√©es, car elle ne reconna√Æt qu'une partie des balises html et ne prend pas en charge les styles CSS. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> text = <span class="hljs-string"><span class="hljs-string">"My text &lt;ul&gt;&lt;li&gt;bullet one&lt;/li&gt;&lt;li&gt;bullet two&lt;/li&gt;&lt;/ul&gt;"</span></span> myTextView.text = Html.fromHtml(text)</code> </pre> <br><p>  Diff√©rentes m√©thodes de style TextView peuvent √™tre combin√©es, mais il convient de se rappeler la priorit√© d'une m√©thode particuli√®re, qui affectera le r√©sultat final: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/hr/hl/zmhrhluqvvcv77s1b85gkxbtcww.png" width="400"></div><br><p>  Une autre fa√ßon - dessiner du texte sur la toile - donne au d√©veloppeur un contr√¥le total sur la sortie de texte: par exemple, vous pouvez dessiner du texte le long d'une ligne courbe.  Mais une telle solution, selon les exigences, peut √™tre assez difficile √† mettre en ≈ìuvre et d√©passe le cadre de cet article. </p><br><h1 id="spans">  Port√©es </h1><br><p>  TextView utilise des √©tendues pour affiner les styles.  En utilisant des √©tendues, vous pouvez changer la couleur d'une plage de caract√®res, faire une partie du texte sous forme de liens, changer la taille du texte, dessiner un point devant un paragraphe, etc. </p><br><p>  On peut distinguer les cat√©gories de port√©es suivantes: </p><br><ul><li>  <strong>Port√©es de caract√®res</strong> - appliqu√©es au niveau des caract√®res d'une cha√Æne. <br><ul><li>  <strong>Apparence affectant</strong> - ne modifiez pas la taille du texte. </li><li>  <strong>Affectation m√©trique</strong> - redimensionner le texte. </li></ul></li><li>  <strong>Port√©es de paragraphe</strong> - appliqu√©es au niveau du paragraphe. </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zy/os/x2/zyosx2ovroe15y3bd94qridaaou.png"></div><br><p>  Le framework Android a des interfaces et des classes abstraites avec des m√©thodes qui sont appel√©es pendant <code>onMeasure()</code> et le rendu de TextView, ces m√©thodes permettent aux trav√©es d'acc√©der √† des objets de niveau inf√©rieur comme <code>TextPaint</code> et <code>Canvas</code> .  En utilisant l'√©tendue, le framework Android v√©rifie quelles interfaces cet objet impl√©mente pour appeler les m√©thodes n√©cessaires. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fv/do/er/fvdoerpx8zxykjxvt9ru4kigica.png" width="600"></div><br><p>  Le cadre Android d√©finit environ 20+ port√©es, donc avant de cr√©er le v√¥tre, il est pr√©f√©rable de v√©rifier si le SDK convient. </p><br><h3 id="appearance-vs-metric-affecting-spans">  Apparence vs m√©trique affectant les port√©es </h3><br><p>  La premi√®re cat√©gorie de plages affecte l'apparence des caract√®res de la cha√Æne: couleur des caract√®res, couleur d'arri√®re-plan, caract√®res soulign√©s ou barr√©s, etc.  Ces <code>UpdateAppearance</code> impl√©mentent l'interface <code>UpdateAppearance</code> et h√©ritent de la classe <code>CharacterStyle</code> , qui permet d'acc√©der √† l'objet <code>TextPaint</code> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/or/8f/zl/or8fzltp5mvoyhvdey8tz1uoqhg.png"></div><br><p>  Les mesures affectant la dur√©e affectent la taille du texte et de la mise en page.Par cons√©quent, l'utilisation d'une telle dur√©e n√©cessite non seulement de redessiner le TextView, mais √©galement l'appel de <code>onMeasure()</code> / <code>onLayout()</code> .  Ces plages sont g√©n√©ralement h√©rit√©es de la classe <code>MetricAffectingSpan</code> , qui h√©rite du <code>CharacterStyle</code> mentionn√© ci-dessus. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_h/hs/hd/_hhshd0pcadvdievngojmtsqzlu.png"></div><br><h2 id="character-vs-paragraph-affecting-spans">  Caract√®re vs paragraphe affectant les port√©es </h2><br><p>  La port√©e du paragraphe affecte un bloc de texte entier: il peut modifier l'alignement, le retrait ou m√™me ins√©rer un point au d√©but d'un paragraphe.  Ces plages doivent √™tre h√©rit√©es de la classe <code>ParagraphStyle</code> et ins√©r√©es dans le texte exactement du d√©but du paragraphe jusqu'√† sa fin.  Si la plage est incorrecte, la plage ne fonctionnera pas. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/76/_n/uj/76_nujhr8rrwz-mne8bgq8p2pfu.png"></div><br><p>  Sur Android, les paragraphes sont consid√©r√©s comme la partie du texte s√©par√©e par des retours √† la ligne ( <code>\n</code> ). </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/p1/kq/s1p1kq9esdaakdpwh_rkxdvdygw.png"></div><br><h2 id="napisanie-svoih-spanov">  √âcrire vos √©chelles </h2><br><p>  Lors de l'√©criture de vos propres plages, vous devez d√©cider de ce que la plage affectera afin de choisir de quelle classe h√©riter: </p><br><ul><li>  Affecte le texte au niveau du caract√®re -&gt; <code>CharacterStyle</code> </li><li>  Affecte le texte au niveau du paragraphe -&gt; <code>ParagraphStyle</code> </li><li>  Affecte l'affichage du texte ‚Üí <code>UpdateAppearance</code> </li><li>  Affecte la taille du texte - <code>UpdateLayout</code> </li></ul><br><p>  Voici un exemple de dur√©e pour changer la police: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomTypefaceSpan</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> font: Typeface?) : MetricAffectingSpan() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateMeasureState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textPaint: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TextPaint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = update(textPaint) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateDrawState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textPaint: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TextPaint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = update(textPaint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textPaint: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TextPaint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { textPaint.apply { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> old = typeface <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> oldStyle = old?.style ?: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> font = Typeface.create(font, oldStyle) typeface = font <span class="hljs-comment"><span class="hljs-comment">//    } } }</span></span></code> </pre> <br><p>  Imaginez que nous voulons cr√©er notre propre √©tendue pour mettre en √©vidence des blocs de code, pour cela, nous modifierons notre √©tendue pr√©c√©dente - apr√®s avoir ajout√© la police, nous ajouterons √©galement un changement dans la couleur d'arri√®re-plan du texte: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CodeBlockSpan</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> font: Typeface?) : MetricAffectingSpan() { ‚Ä¶ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textPaint: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TextPaint</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { textPaint.apply { <span class="hljs-comment"><span class="hljs-comment">//    ‚Ä¶ bgColor = lightGray //    } } }</span></span></code> </pre> <br><p>  Appliquez span au texte: </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">//    span spannable.setSpan(CodeBlockSpan(typeface), ...)</span></span></code> </pre> <br><p>  Mais vous pouvez obtenir exactement le m√™me r√©sultat en combinant deux <code>CustomTypefaceSpan</code> : prenez nos pr√©c√©dents <code>CustomTypefaceSpan</code> et <code>BackgroundColorSpan</code> du framework Android: </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">//    spannable.setSpan(BackgroundColorSpan(lightGray), ...) //   spannable.setSpan(CustomTypefaceSpan(typeface), ...)</span></span></code> </pre> <br><p>  Ces deux solutions auront une diff√©rence.  Le fait est que les plages auto-√©crites ne peuvent pas impl√©menter l'interface <code>Parcelable</code> , contrairement √† celles du syst√®me. </p><br><p>  Lors de la transmission d'une ligne stylis√©e via Intent ou le presse-papiers en cas de plage de balisage auto-√©crite ne sera pas enregistr√©e.  Lorsque vous utilisez des √©tendues du framework, le balisage reste. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/is/nw/uu/isnwuux9cosllp6h0kgawifcepo.png" width="600"></div><br><h2 id="ispolzovanie-spanov-v-tekste">  Utilisation de port√©es dans le texte </h2><br><p>  Il existe deux interfaces pour le texte stylis√© dans le cadre: <code>Spanned</code> et <code>Spannable</code> (avec un balisage inchang√© et mutable, respectivement) et trois impl√©mentations: <code>SpannedString</code> (texte inchang√©), <code>SpannableString</code> (texte inchang√©) et <code>SpannableStringBuilder</code> (texte mutable). </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Texte mutable </th><th>  Balisage variable </th></tr></thead><tbody><tr><td>  Cha√Æne <strong>√©tendue</strong> </td><td>  non </td><td>  non </td></tr><tr><td>  Cha√Æne <strong>extensible</strong> </td><td>  non </td><td>  oui </td></tr><tr><td>  <strong>Constructeur Spannablestring</strong> </td><td>  oui </td><td>  oui </td></tr></tbody></table></div><br><p>  <code>SpannableStringBuilder</code> , par exemple, est utilis√© dans un <code>EditText</code> qui doit changer de texte. </p><br><p>  Vous pouvez ajouter une nouvelle √©tendue √† une ligne en utilisant la m√©thode: </p><br><p> <code>setSpan(Object what, int start, int end, int flags)</code> </p> <br><p>  La plage est pass√©e par le premier param√®tre, puis la plage d'indices dans le texte est indiqu√©e.  Et le dernier param√®tre peut √™tre contr√¥l√©, quel sera le comportement de la plage lors de l'insertion de nouveau texte: si la plage s'√©tendra au texte ins√©r√© au d√©but ou √† la fin (si vous ins√©rez un nouveau texte au milieu, la plage s'y appliquera automatiquement, quelles que soient les valeurs d'indicateur) . </p><br><p>  Les classes r√©pertori√©es ci-dessus diff√®rent non seulement sur le plan s√©mantique, mais √©galement sur la fa√ßon dont elles sont organis√©es en interne: <code>SpannedString</code> et <code>SpannableString</code> utilisent des tableaux pour stocker des plages, et <code>SpannableStringBuilder</code> utilise une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arborescence d'intervalles</a> . </p><br><p>  Si vous effectuez des tests pour la vitesse de rendu du texte en fonction du nombre de plages, vous obtiendrez les r√©sultats suivants: lorsque vous utilisez jusqu'√† ~ 250 plages cons√©cutives, <code>SpannableString</code> et <code>SpannableStringBuilder</code> fonctionnent approximativement √† la m√™me vitesse, mais si les √©l√©ments de balisage d√©passent 250, <code>SpannableString</code> d√©marre √† perdre.  Ainsi, si la t√¢che consiste √† appliquer un style √† du texte, alors lors du choix d'une classe, il faut √™tre guid√© par des exigences s√©mantiques: si la ligne et les styles seront modifiables.  Mais si le balisage n√©cessite plus de 250 √©tendues, vous devez toujours donner la <code>SpannableStringBuilder</code> √† <code>SpannableStringBuilder</code> . </p><br><h2 id="proverka-na-nalichie-spana-v-tekste">  V√©rifier la dur√©e dans le texte </h2><br><p>  La t√¢che se produit p√©riodiquement pour v√©rifier si une ligne √©tendue a une √©tendue sp√©cifique.  Et sur Stackoverflow, vous pouvez trouver ce code: </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasSpan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(spanned: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Spanned</span></span></span></span><span class="hljs-function"><span class="hljs-params">, clazz: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Class</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> spans: Array&lt;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> T&gt; = spanned.getSpans(<span class="hljs-number"><span class="hljs-number">0</span></span>, spanned.length, clazz) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> spans.isNotEmpty() }</code> </pre> <br><p>  Une telle solution fonctionnera, mais elle est inefficace: vous devez parcourir toutes les √©tendues, v√©rifier si chacune d'entre elles appartient au type pass√©, collecter le r√©sultat dans un tableau et, √† la fin, v√©rifier simplement que le tableau n'est pas vide. </p><br><p>  Une solution plus efficace serait d'utiliser la m√©thode <code>nextSpanTransition()</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasSpan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(spanned: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Spanned</span></span></span></span><span class="hljs-function"><span class="hljs-params">, clazz: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Class</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> limit = spanned.length <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> spanned.nextSpanTransition(<span class="hljs-number"><span class="hljs-number">0</span></span>, limit, clazz) &lt; limit }</code> </pre> <br><h2 id="razmetka-teksta-v-razlichnyh-yazykovyh-resursah">  Balisage de texte dans diverses ressources linguistiques </h2><br><p>  Une telle t√¢che peut se produire lorsque vous souhaitez mettre en √©vidence un mot sp√©cifique √† l'aide du balisage dans diverses ressources de cha√Æne.  Par exemple, nous devons mettre en √©vidence le mot <em>¬´text¬ª</em> dans la version anglaise et <em>¬´texto¬ª</em> dans l'espagnol: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- values-en/strings.xml --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag">&gt;</span></span>Best practices for text in Android<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- values-es/strings.xml --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span>Texto en Android: mejores pr√°cticas<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Si vous avez besoin de quelque chose de simple, par exemple, pour surligner le mot en gras, vous pouvez utiliser les balises html habituelles ( <code>&lt;b&gt;</code> ).  Dans l'interface utilisateur, il vous suffit de d√©finir la ressource de cha√Æne dans TextView: </p><br><pre> <code class="kotlin hljs">textView.setText(R.string.title)</code> </pre> <br><p>  Mais si vous avez besoin de quelque chose de plus complexe, par exemple, changer la police, alors le HTML ne peut plus √™tre utilis√©.  La solution consiste √† utiliser la <code>&lt;annotation&gt;</code> sp√©ciale.  Cette balise vous permet de d√©finir n'importe quelle paire cl√©-valeur dans un fichier xml.  Lorsque nous tirons une cha√Æne des ressources, ces balises sont automatiquement converties en plages d' <code>Annotation</code> , organis√©es dans le texte avec les cl√©s et les valeurs correspondantes.  Apr√®s cela, vous pouvez analyser la liste des annotations dans le texte et appliquer les √©tendues n√©cessaires. </p><br><p>  Supposons que nous devons changer la police √† l'aide de <code>CustomTypefaceSpan</code> . </p><br><p>  Ajoutez une balise et d√©finissez une cl√© de <em>¬´police¬ª</em> et une valeur - le type de police que nous voulons utiliser est <em>¬´title_emphasis¬ª</em> : <br></p><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- values-en/strings.xml --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag">&gt;</span></span>Best practices for <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">annotation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">font</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle_emphasis‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span>text<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">annotation</span></span></span><span class="hljs-tag">&gt;</span></span> in Android<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- values-es/strings.xml --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">annotation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">font</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtitle_emphasis‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span>Texto<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">annotation</span></span></span><span class="hljs-tag">&gt;</span></span> en Android: mejores pr√°cticas<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Tirez la cha√Æne des ressources, trouvez les annotations avec la touche <em>¬´police¬ª</em> et organisez les port√©es: </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">//      SpannedString,     span' val titleText = getText(R.string.title) as SpannedString //    val annotations = titleText.getSpans(0, titleText.length, Annotation::class.java) //     SpannableString //      val spannableString = SpannableString(titleText) //     for (annotation in annotations) { //     "font" if (annotation.key == "font") { val fontName = annotation.value //   ,     if (fontName == "title_emphasis") { val typeface = getFontCompat(R.font.permanent_marker) //  span    ,    spannableString.setSpan( CustomTypefaceSpan(typeface), titleText.getSpanStart(annotation), titleText.getSpanEnd(annotation), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE ) } } } styledText.text = spannableString</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yq/62/mm/yq62mmgvajffkxkzk3qntsnxhw4.png" width="600"></div><br><p>  Il a √©t√© mentionn√© ci-dessus que les <code>Parcelable</code> ext√©rieures au cadre Android ne peuvent pas impl√©menter <code>Parcelable</code> et sont transmises via Intent.  Mais cela ne s'applique pas aux annotations qui impl√©mentent <code>Parcelable</code> .  Vous pouvez donc passer la cha√Æne annot√©e via Intent et analyser exactement de la m√™me mani√®re en organisant vos √©tendues. </p><br><h1 id="kak-tekst-raspolagaetsya-v-textview">  Comment le texte est plac√© dans un TextView </h1><br><p>  TextView peut afficher non seulement du texte, mais aussi des images.  Vous pouvez √©galement d√©finir diff√©rents retraits devant le texte.  Sous le capot, cela fonctionne pour que TextView cr√©e une classe enfant, Layout, qui est directement responsable de l'affichage du texte.  Il s'agit d'une classe abstraite qui comporte trois impl√©mentations; g√©n√©ralement, vous n'avez pas √† travailler directement avec elles, sauf si vous √©crivez votre propre contr√¥le: </p><br><ul><li>  <strong>BoringLayout est</strong> utilis√© pour les textes simples, ne prend pas en charge les <strong>sauts de</strong> ligne, RTL et autres, mais il est le plus l√©ger.  TextView l'utilise si le texte respecte toutes les restrictions. </li><li>  <strong>StaticLayout est</strong> utilis√© dans TextView pour d'autres cas. </li><li>  <strong>DynamicLayout est</strong> utilis√© pour le texte modifiable dans un EditText. </li></ul><br><p>  La mise en page a de nombreuses m√©thodes qui vous permettent de conna√Ætre les diff√©rents param√®tres du texte affich√©: les coordonn√©es des lignes, la ligne de base, les coordonn√©es du d√©but et de la fin du texte dans la ligne, etc.  (plus de d√©tails peuvent √™tre trouv√©s dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> ) </p><br><p>  Ces m√©thodes peuvent √™tre tr√®s utiles.  Par exemple, certains d√©veloppeurs sont confront√©s √† la t√¢che d'extraire une partie du texte en rectangles arrondis et d'essayer de trouver sa solution √† travers des √©tendues qui ne sont pas applicables pour r√©soudre ce probl√®me. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/-2/df/8b-2df4-wo4ghk8tkwss6l48bfy.png" width="300"></div><br><p>  Mais les m√©thodes de la classe Layout peuvent venir √† la rescousse.  Voici un exemple de solution: </p><br><p>  √Ä l'aide d'annotations, nous s√©lectionnons les mots qui doivent √™tre encercl√©s dans des rectangles. </p><br><p>  Cr√©ez ensuite 4 ressources dessinables pour tous les cas d'habillage de texte, qui doivent √™tre entour√©es de rectangles: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q4/ry/oj/q4ryojq_lsj3sdyyehvprallpl8.png" width="600"></div><br><p>  Ensuite, nous trouvons les annotations dont nous avons besoin dans le texte, comme d√©crit ci-dessus.  Nous avons maintenant les index du d√©but et de la fin d'une telle annotation.  Gr√¢ce aux m√©thodes de mise en page, vous pouvez conna√Ætre le num√©ro de la ligne sur laquelle le texte annot√© commence et se termine: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> startLine = layout.getLineForOffset(spanStartIndex) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> endLine = layout.getLineForOffset(spanEndIndex)</code> </pre> <br><p>  Ensuite, vous devez dessiner un ou plusieurs rectangles.  Prenons le cas simple o√π la partie annot√©e du texte est apparue sur une seule ligne, alors nous n'avons besoin que d'un rectangle avec quatre coins arrondis.  D√©finissez ses coordonn√©es et dessinez: </p><br><pre> <code class="kotlin hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (startLine == endLine) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lineTop = layout.getLineTop(startLine) <span class="hljs-comment"><span class="hljs-comment">//    val lineBottom = layout.getLineBottom(startLine) //    val startCoor = layout.getPrimaryHorizontal(spanStartIndex).toInt() //    val endCoor = layout.getPrimaryHorizontal(spanEndIndex).toInt() //    //   drawable.setBounds(startCoor, lineTop, endCoor, lineBottom) drawable.draw(canvas) ...</span></span></code> </pre><br><p>  Comme vous pouvez le voir dans cet exemple, Layout stocke de nombreuses informations utiles sur le texte affich√©, ce qui peut aider √† la mise en ≈ìuvre de diverses t√¢ches non standard. </p><br><h1 id="proizvoditelnost-textview">  Performances de TextView </h1><br><p>  TextView, comme toute vue, passe par trois phases lorsqu'il est affich√©: <code>onMeasure()</code> , <code>onLayout()</code> et <code>onDraw()</code> .  En m√™me temps, <code>onMeasure()</code> prend le plus de temps, contrairement aux deux autres m√©thodes: √† ce moment, la classe Layout est recr√©√©e et la taille du texte est calcul√©e.  Changer la taille du texte (par exemple, changer la police) demande donc beaucoup de travail.  Changer la couleur du texte sera plus l√©ger car il ne n√©cessite que d'appeler <code>onDraw()</code> .  Comme mentionn√© ci-dessus, le syst√®me dispose d'un cache de mots global avec des tailles calcul√©es.  Si le mot est d√©j√† dans le cache, appeler √† nouveau <code>onMeasure()</code> pour cela prendra 11-16% du temps qui aurait √©t√© n√©cessaire pour un calcul complet. </p><br><h2 id="uskorenie-pokaza-teksta">  Acc√©l√©ration du texte </h2><br><p>  En 2015, les d√©veloppeurs Instagram ont acc√©l√©r√© l'affichage des commentaires sur les photos en utilisant le cache global.  L'id√©e √©tait de dessiner virtuellement le texte avant de l'afficher √† l'√©cran, ¬´r√©chauffant¬ª ainsi le cache du syst√®me.  Lorsqu'il √©tait temps d'afficher le texte, l'utilisateur le voyait beaucoup plus rapidement, car le texte √©tait d√©j√† mesur√© et √©tait dans le cache. </p><br><p>  √Ä partir d' <strong>Android P (28)</strong> , les d√©veloppeurs de Google ont ajout√© √† l'API la possibilit√© d'effectuer la phase de mesure de la taille du texte √† l'avance dans le thread d'arri√®re-plan - <code>PrecomputedText</code> (et le backport pour l'API commen√ßant par <strong>Android I (14)</strong> - <code>PrecomputedTextCompat</code> ).  En utilisant la nouvelle API, 90% du travail sera effectu√© dans le thread d'arri√®re-plan. </p><br><p>  Un exemple: </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">// UI thread val params: PrecomputedText.Params = textView.getTextMetricsParams() val ref = WeakReference(textView) executor.execute { // background thread val text = PrecomputedText.create("Hello", params) val textView = ref.get() textView?.post { // UI thread val textView = ref.get() textView?.text = text } }</span></span></code> </pre> <br><h2 id="pokaz-bolshogo-teksta">  Afficher le texte en grand </h2><br><p>  Si vous devez afficher un texte volumineux, ne le transf√©rez pas imm√©diatement vers un TextView.  Sinon, l'application peut cesser de fonctionner en douceur ou se figer compl√®tement, car elle fera beaucoup de travail sur le thread principal pour afficher un texte √©norme que l'utilisateur peut m√™me ne pas faire d√©filer jusqu'√† la fin.  La solution consiste √† diviser le texte en parties (par exemple, des paragraphes) et √† afficher les parties individuelles dans RecyclerView.  Pour une acc√©l√©ration encore plus grande, vous pouvez pr√©-calculer la taille des blocs de texte √† l'aide de PrecomputedText. </p><br><p>  Pour faciliter l'incorporation de PrecomputedText dans RecyclerView, les d√©veloppeurs Google ont cr√©√© des m√©thodes sp√©ciales <code>PrecomputedTextCompat.getTextFuture()</code> et <code>AppCompatTextView.setTextFuture()</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBindViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vh: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewHolder</span></span></span></span><span class="hljs-function"><span class="hljs-params">, position: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> = getData(position) vh.textView.setTextSize(...) vh.textView.setFontVariationSettings(...) <span class="hljs-comment"><span class="hljs-comment">//    val future = PrecomputedTextCompat.getTextFuture( data.text, vh.textView.getTextMetricsParamsCompat(), myExecutor ) //  future  TextView,      onMeasure() vh.textView.setTextFuture(future) }</span></span></code> </pre> <br><p>   RecyclerView      ,     ,              ,     . </p><br><p>  ,     <code>getTextFuture()</code>     (,   ),     ,   ,    <code>getTextFuture()</code> ,     ,    TextView. </p><br><h2 id="chto-nuzhno-znat-kogda-ustanavlivaesh-tekst-v-textview">   ,     TextView </h2><br><p>    <code>TextView.setText()</code>       : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == SPANNABLE || movementMethod != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { text = spannableFactory.newSpannable(spannable) <span class="hljs-comment"><span class="hljs-comment">//  } else { text = new SpannedString(spannable) //  }</span></span></code> </pre> <br><p>       span'  TextView,       <code>setText()</code> ,      . </p><br><p>    ,      .  TextView    ,  -,   .    ,      .    ,    ,     TextView   <code>spannableFactory</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MySpannableFactory</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Spannable.Factory</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newSpannable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CharSequence</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Spannable { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? Spannable ?: <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newSpannable(source) } } textView.spannableFactory = MySpannableFactory()</code> </pre> <br><p>         <code>textView.setText(spannable, BufferType.SPANNABLE)</code> ,      . </p><br><p>  Google         span'  RecyclerView,      . </p><br><p>      TextView,     span,        <code>setText()</code> .      TextView      span. TextView   spannable-    span',  : </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> spannable = textView.getText() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Spannable <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> span = CustomTypefaceSpan(span) spannable.setSpan(span, ...)</code> </pre> <br><p>      span,      TextView,         TextView .       ,   <code>invalidate()</code> ,    ‚Äì <code>requestLayout()</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> spannable = textView.getText() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Spannable <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> span = CustomTypefaceSpan(span) spannable.setSpan(span, ...) span.setTypeface(anotherTypeface) textView.requestLayout() <span class="hljs-comment"><span class="hljs-comment">// re-measure and re-draw // or textView.invalidate() // re-draw</span></span></code> </pre> <br><h2 id="ispolzovanie-autolink">  autoLink </h2><br><p>  TextView     .         <code>autoLink</code> .   <code>autoLink=‚Äùweb‚Äù</code> TextView          URL          <code>URLSpan</code> .   ,     SDK   <code>setText()</code> : </p><br><pre> <code class="java hljs">spannable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpannableString(string); Matcher m = pattern.matcher(text); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (...) { <span class="hljs-comment"><span class="hljs-comment">//      String utl = ‚Ä¶ URLSpan span = new URLSpan(url); spannable.setSpan(span, ...); }</span></span></code> </pre> <br><p>      UI ,     <code>autoLink=‚Äùweb‚Äù</code>   RecyclerView.          .        <code>LinkifyCompat</code> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,       background thread val spannable = SpannableString(string) LinkifyCompat.addLinks(spannable, Linkify.WEB_URLS) //   RecyclerView override fun onBindViewHolder(holder: ViewHolder, position: Int) { holder.textView.setText(spannable, BufferType.SPANNABLE) // ... }</span></span></code> </pre> <br><p>  <code>autoLink</code>      <code>map</code> ‚Äì    (      <code>all</code> ).       .   ,        WebView,      !    SDK   <code>Linkify.gatherMapLinks()</code>    ,      : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((address = WebView.findAddress(string)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ... }</code> </pre> <br><p>   WebView  TODO   SDK: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Rewrite this in Java so it is not needed to start up chromium // Could also be deprecated return getFactory().getStatics().findAddress(addr); }</span></span></code> </pre> <br><p>     ?     Smart Linkify,       <strong>Android P (28)</strong> ,          ,      .    : </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">// UI thread val text: Spannable = ‚Ä¶ val request = TextLinks.Request.Builder(text) val ref = WeakReference(textView) executor.execute { // background thread TextClassifier.generateLinks(request).apply(text) val textView = ref.get() textView?.post { // UI thread val textView = ref.get() textView?.text = text } }</span></span></code> </pre> <br><p>    Linkify,      .        toolbar   ,     Google . </p><br><p>  Smart Linkify    :  ,    . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/nc/qb/9tncqbkanp8avsnmisd-ax0z7ae.gif" width="300"></div><br><h1 id="magnifier"> Magnifier </h1><br><p>   <strong>Android P (28)</strong> ,     ‚Äì Magnifier,       .           . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fi/nn/or/finnor2svtuttfn1v-lxwkblgwm.gif" width="400"></div><br><p>      TextView, EditText  WebView,            :  API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>          Android   ,   , : </p><br><ul><li>         </li><li>    </li><li>   ,   TextView (, EditText) </li></ul><br><p>  -     ,      Google I/O'19 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚ÄúBest Practices for Using Text in Android‚Äù</a> . </p><br><a name="links"></a><br><h1 id="poleznye-ssylki">  Liens utiles </h1><br><h2 id="stati">  Les articles </h2><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Florina Muntenescu. "Spantastic text styling with Spans"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Florina Muntenescu. "Underspanding spans"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Florina Muntenescu. "Styling internationalized text in Android"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Instagram Engineering. "Improving Comment Rendering on Android"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Daniel Lee. "Text rendering on Android"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mariusz DƒÖbrowski. "What is new in Android P ‚Äî PrecomputedText"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chet Haase. "RecyclerView Prefetch"</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chris Craik. "Prefetch Text Layout in RecyclerView"</a> </li></ul><br><h2 id="doklady">  Rapports </h2><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Best practices for text on Android (Google I/O '18)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Use Android Text Like a Pro (Android Dev Summit '18)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Best Practices for Using Text in Android (Google I/O'19)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461787/">https://habr.com/ru/post/fr461787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461773/index.html">Airtest IDE - une nouvelle fa√ßon de tester l'automatisation des jeux mobiles?</a></li>
<li><a href="../fr461775/index.html">3 cas pour utiliser Celery dans une application Django</a></li>
<li><a href="../fr461779/index.html">80% des donn√©es de votre entreprise ne vous sont pas accessibles. Que faire √† ce sujet?</a></li>
<li><a href="../fr461781/index.html">"Ycombinator Startup School 2019." Vid√©o des trois premi√®res semaines</a></li>
<li><a href="../fr461785/index.html">Inconv√©nients de RISC-V</a></li>
<li><a href="../fr461793/index.html">Ivan Ponomarev √† propos de l'API Kafka Streams lors de la r√©union jug.msk.ru</a></li>
<li><a href="../fr461797/index.html">Contes de service. Un article frivole sur le travail s√©rieux</a></li>
<li><a href="../fr461801/index.html">DisplayPort-LVDS</a></li>
<li><a href="../fr461803/index.html">DVC (Data Version Control): versionnage des donn√©es et reproductibilit√© de l'exp√©rience</a></li>
<li><a href="../fr461805/index.html">Application d'int√©gration Monte Carlo dans le rendu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>