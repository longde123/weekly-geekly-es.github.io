<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèø üëÉüèª üì∏ Modbus pada mikrokontroler Rusia K1986BE92QI üöÑ ü§∑üèº ü¶Ç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya jatuh ke tangan mikrokontroler Rusia K1986BE92QI yang diproduksi oleh PKK Milander JSC dengan core RISC 32-bit ARM Cortex-M3 128kB Flash dan 32kB...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modbus pada mikrokontroler Rusia K1986BE92QI</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438534/"><p>  Saya jatuh ke tangan mikrokontroler Rusia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">K1986BE92QI yang</a> diproduksi oleh PKK Milander JSC dengan core RISC 32-bit ARM Cortex-M3 128kB Flash dan 32kB RAM, saya segera ingin belajar dan mengujinya dalam aksi. </p><br><p>  Mikrokontroler datang dalam sebuah paket yang membuat iri orang Cina dengan AliExpress.  Chip itu terletak di kaset aluminium foil tebal, yang dibungkus kertas foil, diletakkan dengan karet busa, dan seluruh "sandwich" ini dalam kotak kardus dengan dinding bagian dalam ditutupi dengan foil.  Secara umum, perlindungan terhadap listrik statis pada ketinggian. </p><br><p><img src="https://habrastorage.org/webt/0q/uf/jp/0qufjpcjdcgtbhvw-0fnxyrmass.jpeg"></p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/ef/yp/2b/efyp2bwavnh5hqejpdqiatxogz8.jpeg"></p><br><p>  Untuk mikrokontroler adalah label dan protokol pemilihan produk, yang sangat bagus. </p><br><p><img src="https://habrastorage.org/webt/xi/_f/ui/xi_fui1ln8ovx9k0laosvk76pdm.jpeg"></p><br><p>  Untuk memulainya, perlu mengembangkan diagram sirkuit papan debug dan menentukan komponen.  Ia berhenti pada komponen minimum: stabilizer 3.3v untuk daya dari port USB, resonator kuarsa 8MHz, konektor miniUSB, tombol reset, resistor pull-up dan konektor sip.  Saya pikir untuk percobaan awal dengan mikrokontroler sudah cukup.  Atur juga sakelar smd untuk memilih mode bootloader bawaan.  Mikrokontroler memungkinkan Anda untuk memilih metode mengunduh program menggunakan salah satu dari dua antarmuka serial UART atau JTAG / SWD, sementara JTAG memungkinkan Anda untuk men-debug program di mikrokontroler.  Pilihan metode pemuatan program ditentukan oleh level logika pada output PF4, PF5, PF6.  Semua opsi yang mungkin disajikan dalam tabel: </p><br><p><img src="https://habrastorage.org/webt/ky/my/en/kymyenw4iasc8nygqi79xliwgby.png"></p><br><p>  Mikrokontroler adalah chip yang dibuat dalam wadah plastik LQFP64 dengan pin 0,3 mm dan 0,2 mm di antaranya, yang menunjukkan ketidakmungkinan membuat papan sirkuit tercetak dengan kualitas yang dapat diterima menggunakan teknologi LUT, tetapi pengalaman telah mengkonfirmasi sebaliknya.  Dalam beberapa jam, gambar PCB dibuat dalam Sprint Layout, dicetak pada kertas kepadatan tinggi Lamond dan dipindahkan ke fiberglass.  Etching terjadi dalam larutan peroksida dan asam sitrat oleh mata dan memakan waktu sekitar satu jam, secara mengejutkan kualitas konduktor dapat diterima pertama kali, yang menyenangkan. </p><br><p><img src="https://habrastorage.org/webt/hy/zb/vt/hyzbvtnawxs-d5kfdff0swzqx_w.jpeg"></p><br><p>  Dan begitu papan dibuat, semua komponen disolder, tetap diprogram.  Kami akan menggunakan lingkungan pengembangan dari Keil - MDK ARM uVision 5.0, <a href="">paket perangkat lunak</a> <a href="">Standard Peripherals Library</a> + didistribusikan kepadanya oleh pabrikan mikrokontroler.  Saya tidak ingin memprogram di UART, jadi saya memutuskan untuk menggunakan programmer / debugger di-sirkuit ST-Link v2, atau lebih tepatnya, klonnya dari produsen Cina yang tidak dikenal.  Keil mendukungnya di luar kotak, tetapi mikrokontroler, meskipun dokumentasi mengatakan bahwa ia mendukung antarmuka SWD, lupa bagaimana dan di mana menghubungkannya.  Setelah mencari di internet untuk: "JTAG - SWD adapter", ditemukan bahwa jalur SWDIO terhubung ke JTAG-TMS, dan SWCLK ke JTAG-TCK dan "Oh miracle!"  Setelah semuanya berhasil, program uji dimasukkan ke dalam mikrokontroler. </p><br><p><img src="https://habrastorage.org/webt/3p/ca/qm/3pcaqm5rotui8hxuc8gi1svzrdi.jpeg"></p><br><p>  Ini adalah akhir dari kegembiraan, karena setelah firmware mikrokontroler, meskipun berfungsi, tampaknya telah berhenti bekerja dengan debugger.  Rupanya, setelah flashing, garis port JTAG-A didefinisikan ulang untuk tujuan fungsional lain, meskipun dalam program port B di mana JTAG-A berada bahkan tidak diinisialisasi.  Saya tidak ingin mengerti ini, karena ada juga JTAG-B.  Ketika terhubung ke antarmuka JTAG alternatif, semuanya bekerja seperti jam.  Di masa depan, kami akan menggunakannya untuk pemrograman dan debugging. </p><br><p>  Tugas pertama yang saya buat adalah menyambungkan pengontrol ke sistem SCADA menggunakan protokol Modbus.  Agar tidak menemukan kembali roda, ambil <a href="">freemodbus freemodbus</a> cross-platform perpustakaan dan <a href="">port</a> ke mikrokontroler kami. </p><br><p>  Untuk membuat proyek di Keil pada mikrokontroler dari Milander, Anda harus menginstal paket perangkat lunak terlebih dahulu.  Ini dilakukan dengan mengklik dua kali pada file.  Selanjutnya Keil akan melakukan semuanya sendiri. </p><br><p>  Jadi kami membuat proyek baru.  Kami memilih komponen mikrokontroler dan perpustakaan yang kami butuhkan: </p><br><p><img src="https://habrastorage.org/webt/gj/vj/5h/gjvj5hrhozennt2gtoebvuexdlw.jpeg"></p><br><p>  Di pohon proyek, buat grup Modbus Slave dan tambahkan file berikut dari perpustakaan Freemodbus di sana: </p><br><p><img src="https://habrastorage.org/webt/nl/rt/v4/nlrtv4psj1ta43rupd9t_hco590.jpeg"></p><br><p>  Dan jangan lupa dalam opsi proyek untuk menunjukkan ke kompiler jalur berikut ke direktori perpustakaan. </p><br><p><img src="https://habrastorage.org/webt/im/xu/bx/imxubxvmei8hr9zsqbpneut0bzk.jpeg"></p><br><p>  Sekarang Anda dapat mulai secara khusus mem-port perpustakaan Freemodbus ke mikrokontroler kami menggunakan Perpustakaan Periferal Standar.  Untuk melakukan ini, dalam file portserial.c, tulis fungsi inisialisasi port UART xMBPortSerialInit </p><br><pre><code class="plaintext hljs">BOOL xMBPortSerialInit( UCHAR ucPORT, ULONG ulBaudRate, UCHAR ucDataBits, eMBParity eParity ) { //    F RST_CLK_PCLKcmd(RST_CLK_PCLK_PORTF, ENABLE); //      PORT_InitTypeDef uart2_port_set; //   F   UART //     PORT_StructInit(&amp;uart2_port_set); //    uart2_port_set.PORT_FUNC = PORT_FUNC_OVERRID; //    uart2_port_set.PORT_SPEED = PORT_SPEED_MAXFAST; //     uart2_port_set.PORT_MODE = PORT_MODE_DIGITAL; //   PF1  UART_TX () uart2_port_set.PORT_Pin = PORT_Pin_1; uart2_port_set.PORT_OE = PORT_OE_OUT; PORT_Init(MDR_PORTF, &amp;uart2_port_set); //   PF0  UART_RX () uart2_port_set.PORT_Pin = PORT_Pin_0; uart2_port_set.PORT_OE = PORT_OE_IN; //    UART //   UART2 RST_CLK_PCLKcmd(RST_CLK_PCLK_UART2, ENABLE); //      UART UART_InitTypeDef UART_InitStructure; //    UART = 1 UART_BRGInit(MDR_UART2,UART_HCLKdiv1); //  UART //    ‚Äì 115200  UART_InitStructure.UART_BaudRate = ulBaudRate; //     ‚Äì 8 UART_InitStructure.UART_WordLength = UART_WordLength8b; //  - UART_InitStructure.UART_StopBits = UART_StopBits1; //    UART_InitStructure.UART_Parity = UART_Parity_No; //    FIFO   , // ..      UART_InitStructure.UART_FIFOMode = UART_FIFO_OFF; //      UART_InitStructure.UART_HardwareFlowControl = UART_HardwareFlowControl_RXE | UART_HardwareFlowControl_TXE; //  UART2    UART_Init(MDR_UART2, &amp;UART_InitStructure); //   UART UART_Cmd(MDR_UART2, ENABLE); return TRUE; }</code> </pre> <br><p>  fungsi tulis dan baca: </p><br><pre> <code class="plaintext hljs">BOOL xMBPortSerialPutByte( CHAR ucByte ) { //  UART_SendData(MDR_UART2,ucByte); return TRUE; } BOOL xMBPortSerialGetByte( CHAR * pucByte ) { //  *pucByte = (uint8_t) UART_ReceiveData(MDR_UART2); return TRUE; }</code> </pre><br><p>  Penangan interupsi UART </p><br><pre> <code class="plaintext hljs"> void USART2_IRQHandler(void) { /*     ---------------------------------------------------*/ if((UART_GetITStatus(MDR_UART2,UART_IT_RX)) != RESET) { prvvUARTRxISR( ); } /*     ------------------------------------------------*/ if((UART_GetITStatus(MDR_UART2,UART_IT_TX)) !=RESET) { prvvUARTTxReadyISR( ); } }</code> </pre><br><p>  Setelah ini, kami mengedit file portimer.c di mana timer dikonfigurasi yang menghasilkan laporan sementara untuk melacak akhir paket protokol modbus. </p><br><pre> <code class="plaintext hljs">BOOL xMBPortTimersInit( USHORT usTim1Timerout50us ) { MDR_RST_CLK-&gt;PER_CLOCK |= (1&lt;&lt;14); //   TIM1 MDR_RST_CLK-&gt;TIM_CLOCK = 0x0; MDR_RST_CLK-&gt;TIM_CLOCK |= (1&lt;&lt;24); // TIM1_CLK_EN MDR_RST_CLK-&gt;TIM_CLOCK |= 0x07; // HCLK/8   MDR_TIMER1-&gt;CNTRL = 0x00000002; //   MDR_TIMER1-&gt;CNT = 0x00000000; //  MDR_TIMER1-&gt;PSG = 0x2; //f/1   while((MDR_TIMER1-&gt;CNTRL &amp; 0x004) != 0) {__NOP();} //    MDR_TIMER1-&gt;ARR = usTim1Timerout50us; //     while((MDR_TIMER1-&gt;CNTRL &amp; 0x004) != 0) {__NOP();} //     MDR_TIMER1-&gt;IE = 0x00000002; //(CNT==ARR)-&gt;IE      NVIC-&gt;ISER[0] = (1&lt;&lt;14); // Global EN for IRQ14   MDR_TIMER1-&gt;CNTRL |= (1&lt;&lt;0); //Timer1 ON   return TRUE; } inline void vMBPortTimersEnable( ) { /*    */ MDR_TIMER1-&gt;CNTRL |= (1&lt;&lt;0); //Timer1 ON } inline void vMBPortTimersDisable( ) { /*    */ MDR_TIMER1-&gt;CNTRL &amp;= ~(1&lt;&lt;0); //Timer1 OFF } static void prvvTIMERExpiredISR( void ) { ( void )pxMBPortCBTimerExpired( ); } void Timer1_IRQHandler(void) { //   MDR_TIMER1-&gt;STATUS &amp;= ~0x002; //IE FLAG=0 prvvTIMERExpiredISR( ); }</code> </pre> <br><p>  Di main.c kita akan menambahkan fungsi pemrosesan register modbus, kita akan meredam register yang tidak digunakan dengan bertopik </p><br><pre> <code class="plaintext hljs">/* ----------------------- Defines ------------------------------------------*/ #define REG_INPUT_START 1000 #define REG_INPUT_NREGS 4 /* ----------------------- Static variables ---------------------------------*/ static USHORT usRegInputStart = REG_INPUT_START; static USHORT usRegInputBuf[REG_INPUT_NREGS]; eMBErrorCode eMBRegInputCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNRegs ) { eMBErrorCode eStatus = MB_ENOERR; int iRegIndex; if( ( usAddress &gt;= REG_INPUT_START ) &amp;&amp; ( usAddress + usNRegs &lt;= REG_INPUT_START + REG_INPUT_NREGS ) ) { iRegIndex = ( int )( usAddress - usRegInputStart ); while( usNRegs &gt; 0 ) { *pucRegBuffer++ = ( unsigned char )( usRegInputBuf[iRegIndex] &gt;&gt; 8 ); *pucRegBuffer++ = ( unsigned char )( usRegInputBuf[iRegIndex] &amp; 0xFF ); iRegIndex++; usNRegs--; } } else { eStatus = MB_ENOREG; } return eStatus; } eMBErrorCode eMBRegHoldingCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNRegs, eMBRegisterMode eMode ) { return MB_ENOREG; } eMBErrorCode eMBRegCoilsCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNCoils, eMBRegisterMode eMode ) { return MB_ENOREG; } eMBErrorCode eMBRegDiscreteCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNDiscrete ) { return MB_ENOREG; }</code> </pre> <br><p>  Ini adalah akhir dari porting, tetap hanya dalam fungsi int utama (void) untuk menginisialisasi perpustakaan dan memanggil eMBPoll () dalam satu lingkaran; </p><br><pre> <code class="plaintext hljs">int main (void) { eMBErrorCode eStatus; // UART    ,   portserial.c  xMBPortSerialInit    eStatus = eMBInit( MB_RTU, 0x0A, 0, 19200, MB_PAR_NONE ); /* Enable the Modbus Protocol Stack. */ eStatus = eMBEnable( ); while(1) { eStatus = eMBPoll( ); //  if (eStatus!= MB_ENOREG){}; /* Here we simply count the number of poll cycles. */ usRegInputBuf[0]++; } }</code> </pre><br><p>  Kami mengkompilasi semuanya tanpa kesalahan, tetapi tidak ada yang berhasil.  Dalam mode debug, kami mengetahui bahwa paket sedang diproses dan program hang pada inisialisasi transmisi.  Ketika interupsi dihidupkan dari pemancar UART, interupsi tidak dipanggil, dan program masuk ke loop tak terbatas.  Setelah mempelajari bagian "Deskripsi UART" spesifikasi pada mikrokontroler menemukan Catatan: </p><br><blockquote>  Gangguan pemancar bekerja di tepi, bukan di level sinyal.  Jika modul dan interupsi diizinkan sebelum data ditulis ke buffer FIFO pemancar, interupsi tidak terjadi.  Interupsi hanya terjadi ketika buffer FIFO kosong. </blockquote><p>  Yah, itu tidak masalah, kami mencari di mana transfer dimulai, di file mbrtu.c kami menemukan baris kode </p><br><pre> <code class="plaintext hljs">/* Activate the transmitter. */ eSndState = STATE_TX_XMIT; vMBPortSerialEnable( FALSE, TRUE );</code> </pre> <br><p>  dan secara paksa mengirim byte ke pemancar UART, untuk ini kami menambahkan baris: "xMBRTUTransmitFSM ();"  dan semuanya mulai berfungsi dengan baik, paket berjalan, register dibaca, dan kemudian itu masalah teknologi. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438534/">https://habr.com/ru/post/id438534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438518/index.html">Membuat jsfiddle Anda, bagian 2</a></li>
<li><a href="../id438522/index.html">Equaliser strategis</a></li>
<li><a href="../id438524/index.html">Arsitektur aplikasi flutter 101: Vanilla, Scoped Model, BLoC</a></li>
<li><a href="../id438526/index.html">Jaringan saraf tiruan menumbuhkan sel-sel navigasi seperti di otak</a></li>
<li><a href="../id438530/index.html">Podcast Hipster # 1</a></li>
<li><a href="../id438536/index.html">Di bawah kap chatbot: apa yang dapat dilakukan oleh RocketBot dan cara kerjanya</a></li>
<li><a href="../id438538/index.html">Teamlead Conf 2019 Msk: tentang format komunikasi lain</a></li>
<li><a href="../id438540/index.html">Tren dalam manajemen dokumen dan penyimpanan data untuk 2019</a></li>
<li><a href="../id438542/index.html">Bagaimana kami menciptakan layanan rekomendasi untuk pemilihan pakaian di jaringan saraf</a></li>
<li><a href="../id438544/index.html">Kami menonton film di rumah: 10 materi tentang membangun teater rumah dan memilih peralatan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>