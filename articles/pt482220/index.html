<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèº üèë ‚≠ïÔ∏è Localiza√ß√£o de marcadores Aruco üë©üèª üè´ üïç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No √∫ltimo post, falamos sobre como ir do ponto A ao ponto B sem atingir nada. Mas, para contornar algo, voc√™ precisa entender onde estamos e onde exis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Localiza√ß√£o de marcadores Aruco</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482220/">  <a href="https://habr.com/ru/post/479636/">No √∫ltimo post,</a> falamos sobre como ir do ponto A ao ponto B sem atingir nada.  Mas, para contornar algo, voc√™ precisa entender onde estamos e onde existem obst√°culos din√¢micos (nossos oponentes e n√£o apenas). <br><br>  Uma pessoa tem olhos, ouvidos e software estabelecidos pela natureza e pela experi√™ncia pessoal, para que possa se mover e navegar facilmente no espa√ßo.  O sistema de localiza√ß√£o √© quase o ponto de vista dos rob√¥s.  √â necess√°rio para que o rob√¥ possa navegar no espa√ßo e, ajustando-se ao ambiente, mova-se nele. <br><br>  Hoje falaremos sobre como resolvemos o problema de determinar a posi√ß√£o dos rob√¥s no campo Eurobot, como fazer tudo isso, iniciar e configurar por si mesmo. <br><br><img src="https://habrastorage.org/webt/wd/ob/7l/wdob7lxsj1x5z0ubs94tyz5hf08.png"><br><a name="habracut"></a><br><h2>  Condi√ß√µes de destino do sistema de localiza√ß√£o </h2><br>  Um dos princ√≠pios do Eurobot Open √© a autonomia.  Autonomia de tudo o que est√° por tr√°s do campo de jogo.  Todos os c√°lculos, tomada de decis√£o e localiza√ß√£o devem ser feitos em \ em rob√¥s ou em locais especiais em campo. <br><br>  O tamanho do campo √© de 2x3 metros, e o erro no tamanho e na posi√ß√£o dos elementos de campo para campo geralmente √© de 3-5 mm. <br><br>  Na imagem abaixo, est√° um diagrama do campo Eurobot 2019 com zonas marcadas nas quais podemos colocar algo diferente de rob√¥s. <br><br><img src="https://habrastorage.org/webt/ed/sn/nr/edsnnr36r2ksmv9sr7pzjz1khhk.png"><br><br><ul><li>  6 - Zona de Experi√™ncia (uma das tarefas adicionais) </li><li>  10 - Zonas de farol </li><li>  11 - Uma torre especial para a instala√ß√£o de um dispositivo de rastreamento central (a seguir denominado CCC).  Localizado acima do campo, a uma altura de 1 metro </li><li>  Tamb√©m nos pr√≥prios rob√¥s podemos instalar beacons. </li></ul><br>  Para todas essas √°reas e as dimens√µes dos pr√≥prios rob√¥s, h√° restri√ß√µes estritas de peso e tamanho, por causa das quais √© imposs√≠vel criar um grande supermodulo produtivo no qual tudo se encaixa.  E tamb√©m h√° um limite de 3 minutos na prepara√ß√£o para o lan√ßamento.  Durante esse per√≠odo, uma ou duas pessoas da equipe devem retirar os rob√¥s e tudo relacionado a eles, organizar, configurar e preparar o lan√ßamento.  Obviamente, quanto menos lixo voc√™ precisar definir e ajustar, menor a probabilidade de cometer um erro ou ser multado antes do in√≠cio da batalha. <br><br><img src="https://habrastorage.org/webt/73/ic/e7/73ice79-lmosmu6rt-gi5gdz744.jpeg"><br>  <i>e outro segundo caixa cheia</i> <br><br><h3>  Analisamos op√ß√µes </h3><br>  Com a consci√™ncia de nossas capacidades e o desejo de obter precis√£o de posicionamento de pelo menos alguns mil√≠metros, vamos ver o que geralmente podemos usar para resolver esse problema: <br><br><ul><li>  <b>A odometria da roda</b> usando codificadores localizados diretamente no acionamento ou medidores adicionais permite ler a dist√¢ncia percorrida pelo rob√¥ e determinar sua posi√ß√£o em rela√ß√£o ao ponto inicial.  Muitas equipes da Eurobot o usam como m√©todo principal de localiza√ß√£o.  Essa √© uma das fontes mais r√°pidas de informa√ß√µes de movimento do rob√¥.  No entanto, na pr√°tica, especialmente ao dirigir com rodas on-line (uma √°rea de contato menor que as rodas cl√°ssicas, folga nos rolos e erros maiores de fabrica√ß√£o), a odometria √© suscet√≠vel ao problema de acumular erros, que deve ser corrigido de alguma forma.  Voc√™ pode alinhar com a superf√≠cie com coordenadas conhecidas ou pode complexar com um sistema adicional.  Al√©m disso, se voc√™ usar codificadores nas rodas motrizes, haver√° o problema de derrapagem das rodas durante manobras afiadas e em colis√µes do rob√¥.  As rodas de medi√ß√£o podem se livrar desse problema, mas s√£o dif√≠ceis de colocar em um pequeno rob√¥. <br><br><img src="https://habrastorage.org/webt/v0/8u/bd/v08ubdzodh5zpr8kr7ee3fhbo5y.png"><br>  <i>roda omni de medi√ß√£o fabricada com suspens√£o independente e com codificador magn√©tico, que usamos em 2018</i> <br></li><li>  <b>Os lidares</b> t√™m vantagens significativas: temos uma vis√£o quase circular e dist√¢ncias de obst√°culos.  Das desvantagens, vale destacar o alto pre√ßo, a dificuldade em tentar distinguir pequenos objetos distantes do lixo e um algoritmo de localiza√ß√£o relativamente complicado.  Os lidares baratos (como o rplidar) t√™m uma taxa de atualiza√ß√£o e resolu√ß√£o angular razoavelmente baixos e tamb√©m est√£o sujeitos √† luz de outros lidares, rangefinders etc. Nos rob√¥s, √© dif√≠cil encontrar um lidar no n√≠vel lateral para usar os algoritmos cl√°ssicos do SLAM, mas com base nos dados fornecidos. As regras de eleva√ß√£o para sistemas de localiza√ß√£o t√™m poucos objetos est√°ticos para liga√ß√£o.  No entanto, a equipe Skoltech patina com sucesso h√° v√°rios anos usando o hokuyo ust-10lx e no ano passado ficou em segundo lugar na final europ√©ia da competi√ß√£o Eurobot na Fran√ßa. </li><li>  Tamb√©m consideramos <b>sistemas inerciais</b> , mas no nosso caso eles n√£o se encaixavam bem.  O aceler√¥metro √© barulhento, o girosc√≥pio est√° flutuando, voc√™ pode esquecer de usar a b√∫ssola em ambientes fechados.  Mesmo o uso de um filtro Kalman n√£o atinge a precis√£o desejada.  Acontece que o IMU s√≥ pode ser usado efetivamente para corre√ß√£o em um per√≠odo muito curto de tempo.  O m√°ximo de informa√ß√µes √∫teis que conseguimos obter com o pixhawk2 √© o √¢ngulo durante uma curva acentuada (de uma colis√£o, por exemplo). </li><li>  <b>O GPS</b> n√£o funciona em ambientes fechados, e a precis√£o sem o RTK √© de metros. </li><li>  <b>Localiza√ß√£o ultra-s√¥nica</b> .  Uma das implementa√ß√µes pode ser encontrada aqui: <a href="https://m.habr.com/ru/post/451408/">m.habr.com/en/post/451408</a> .  Infelizmente, a precis√£o de nossas tarefas n√£o √© muito alta (+ -2 cm), a diafonia afeta fortemente ou, se voc√™ usar sensores com prote√ß√£o contra isso, √© obtida uma baixa frequ√™ncia de polling.  Uma das equipes na R√∫ssia usa essa solu√ß√£o com sucesso vari√°vel, e a equipe alem√£ Turag utiliza com sucesso uma tecnologia semelhante desenvolvida dentro do laborat√≥rio. </li><li>  <b>A odometria visual</b> n√£o fornece informa√ß√µes sobre a posi√ß√£o dos oponentes devido ao fato de que n√£o h√° muitos pontos no campo para os quais ser√° poss√≠vel se apegar com seguran√ßa. </li><li>  <b>\ Duas c√¢meras est√©reo</b> possuem um √¢ngulo estreito, o que n√£o permite cobrir o campo quando localizado no dispositivo de rastreamento central ou obter uma vis√£o circular ou pelo menos aceit√°vel quando instalado em um rob√¥. </li><li>  <b>Os marcadores fiduci√°rios</b> que escolhemos e que examinaremos em mais detalhes. </li></ul><br><h3>  Marcadores fiduci√°rios </h3><br>  A navega√ß√£o por marcadores existe h√° muito tempo.  Puramente teoricamente, o chamado marcador pode ser qualquer objeto.  Mas h√° muitos problemas ao usar: <br><br><ul><li>  restri√ß√µes devido √† resolu√ß√£o da c√¢mera; </li><li>  falta de confiabilidade da detec√ß√£o ao usar a cor como principal fonte de informa√ß√£o; </li><li>  a necessidade de determinar a orienta√ß√£o do marcador; </li><li>  marcas de baixo contraste funcionam bem apenas sob boa luz; </li><li>  √© necess√°rio um alto poder de processamento do equipamento (processamento em tempo real dos quadros recebidos). </li></ul><br>  Para contornar os problemas acima, voc√™ geralmente precisa usar algo simples e inequ√≠voco para reconhecimento, por exemplo, um c√≠rculo colorido ou um quadrado (e eu gostaria de um pato amarelo). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/636/59e/f61/63659ef613cf69454b7b3b9d788d934e.png" alt="imagem"><br>  <i>diferentes tipos de marcadores</i> <br><br>  De fato, al√©m de determinar a posi√ß√£o de um marcador, muitas vezes √© necess√°rio determinar sua singularidade, por exemplo, para detectar v√°rios objetos ao mesmo tempo.  Para fazer isso, voc√™ pode alterar a cor ou a forma, mas enfrentaremos rapidamente uma diminui√ß√£o na confiabilidade da detec√ß√£o. <br>  Esse problema √© bastante comum e existem muitos padr√µes de marcadores.  O mais famoso deles √© o c√≥digo qr, mas raramente √© usado para problemas de localiza√ß√£o devido √† redund√¢ncia e √† necessidade de alta resolu√ß√£o.  Como regra, todos os marcadores s√£o de duas cores (geralmente preto e branco), de forma simples (geralmente um quadrado) e de alguma forma codificam o identificador em si mesmos.  Os marcadores mais famosos para localiza√ß√£o s√£o Aruco, April Tag, ARToolKit. <br><br>  Qualquer pessoa interessada em aprender mais sobre eles √© um <a href="https://www.researchgate.net/publication/303752217_An_evaluation_of_artificial_fiducial_markers_in_underwater_environments">artigo</a> interessante que tamb√©m compara a confiabilidade de sua detec√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Marcadores de fractal</b> <div class="spoiler_text">  H√° momentos em que precisamos detectar um objeto de longe e de branco para ele.  O uso de v√°rios marcadores de tamanhos diferentes √© uma maneira, mas voc√™ pode faz√™-lo de maneira mais esperta e usar marcadores "fractal", cujas partes diferentes funcionam em diferentes escalas da imagem. <br><br>  <a href="https://docs.google.com/document/u/1/d/1SdsOTjGdu5o8gy2Ot2FDqYDS9ALgyhOBJcJHOZBR7B4/mobilebasic">docs.google.com/document/u/1/d/1SdsOTjGdu5o8gy2Ot2FDqYDS9ALgyhOBJcJHOZBR7B4/mobilebasic</a> <br></div></div><br>  No nosso caso, temos muitos aspectos positivos do uso de marcadores: <br><br><ul><li>  com a possibilidade de instalar uma c√¢mera est√°tica com um bom √¢ngulo de vis√£o e marca√ß√£o, isso n√£o requer equipamentos dif√≠ceis de encontrar e potencialmente n√£o √© muito dif√≠cil de implementar; </li><li>  a c√¢mera remota pode avaliar a posi√ß√£o de todos os objetos nos quais podemos colocar marcadores; </li><li>  os c√°lculos s√£o realizados n√£o no dispositivo de bordo do rob√¥, mas em um computador separado (mas h√° um problema com a confiabilidade e atrasos na transfer√™ncia de dados); </li><li>  a capacidade de resolver qualquer outro problema associado √† vis√£o. </li></ul><br>  Depois de analisar os sistemas acima, decidimos pela detec√ß√£o de marcadores.  Isso nos permitiu n√£o apenas liberar nossos odroides nos rob√¥s, mas tamb√©m permitir que eles vissem toda a situa√ß√£o no campo do ponto de vista de um p√°ssaro. <br><br><h3>  Como funciona fora da caixa </h3><br>  A "confiabilidade" da detec√ß√£o de marcadores √© um termo relativo.  Tarefas diferentes requerem diferentes n√≠veis de precis√£o e estabilidade.  A inclus√£o desses par√¢metros depende do sensor de v√≠deo, lentes, condi√ß√µes de ilumina√ß√£o etc. <br><br><img src="https://habrastorage.org/webt/yi/xs/5m/yixs5m5g6pv5xya8axbd-zqov-4.png"><br>  No nosso caso, com um tamanho de campo de 2x3 metros e uma c√¢mera a apenas um metro acima, √© necess√°rio usar uma √≥ptica de grande angular com um campo de vis√£o de pelo menos 120-140 graus para garantir a visibilidade de todo o espa√ßo de jogo, o que afeta negativamente a detec√ß√£o (e sua precis√£o) de pequenos marcadores ao longe canto do campo de jogo e sob condi√ß√µes de ilumina√ß√£o arbitr√°rias tornam essa tarefa ainda mais dif√≠cil. <br>  Como a pr√°tica demonstrou, mesmo sob condi√ß√µes normais, completamente naturais e iluminadas, podem ocorrer defini√ß√µes err√¥neas da posi√ß√£o do marcador. <br><br><img src="https://habrastorage.org/webt/km/-n/cl/km-nclpq-m4g3jcgvwxls4eixb0.png"><br><br>  Portanto, as imagens a seguir mostram dois quadros consecutivos com resultados de detec√ß√£o de marcador: a dire√ß√£o do eixo Z (azul) √© alterada em 180 graus. <br><br><img src="https://habrastorage.org/webt/sd/a5/ha/sda5haouwemxqiobswwckpb8dhw.png"><br><br><img src="https://habrastorage.org/webt/tu/gj/ii/tugjiiiol9ts2m4laiexh7nwnue.png"><br>  <i><a href="https://www.youtube.com/watch%3Fv%3DxzG2jQfxLlY">www.youtube.com/watch?v=xzG2jQfxLlY</a></i> <br><br><h3>  Trazendo a um estado competitivo </h3><br><h4>  Mude o algoritmo </h4><br>  Para determinar com precis√£o a localiza√ß√£o do rob√¥ no campo, voc√™ precisa conhecer a posi√ß√£o angular da c√¢mera, a transforma√ß√£o geral do sistema de coordenadas e a posi√ß√£o da c√¢mera em rela√ß√£o √† posi√ß√£o do campo.  Para fazer essa convers√£o, desenvolvemos nosso pr√≥prio algoritmo.  Como uma pessoa desliga o centro de controle central manualmente, al√©m de os campos serem ligeiramente diferentes um do outro, n√£o √© poss√≠vel sempre obter a mesma posi√ß√£o da c√¢mera.  O deslocamento angular da c√¢mera em rela√ß√£o ao campo tem um efeito muito negativo na detec√ß√£o da posi√ß√£o dos rob√¥s.  A solu√ß√£o fundamental √© determinar v√°rios marcadores est√°ticos que podemos definir antes da partida para a calibra√ß√£o. <br><br>  A biblioteca Aruco em opencv fornece a capacidade de determinar a posi√ß√£o do marcador 6dof em rela√ß√£o √† c√¢mera.  No come√ßo, tentamos us√°-lo, mas ficou muito inst√°vel e impreciso.  No nosso caso, quando a posi√ß√£o da c√¢mera √© conhecida, √© fixa e os rob√¥s (e marcadores associados) se movem em um plano que n√£o passa pelo ponto de conex√£o da c√¢mera, √© racional nos limitarmos √† tarefa de detectar a posi√ß√£o 3dof (z-const, x-y, + rota√ß√£o ao redor um eixo z) atrav√©s da triangula√ß√£o de um ponto em um plano em um √¢ngulo vis√≠vel. <br><br>  Espera-se que uma diminui√ß√£o na dimens√£o e um aumento na base da triangula√ß√£o (o tamanho do marcador versus a dist√¢ncia do plano dos marcadores √† c√¢mera) do problema resolvido reduz o n√≠vel de incerteza e ru√≠do dos resultados da detec√ß√£o. <br>  Para fazer isso, em vez da fun√ß√£o padr√£o <br><br><pre><code class="cpp hljs">cv::aruco::estimatePoseSingleMarkers(markerCorners, <span class="hljs-number"><span class="hljs-number">0.05</span></span>, cameraMatrix, distCoeffs, rvecs, tvecs);</code> </pre> <br><br>  que, com base nos cantos encontrados dos marcadores, determina a 6dof posi√ß√£o do marcador, escrevemos nosso estimador de posi√ß√£o, trabalhando de acordo com os seguintes princ√≠pios: <br><br><ul><li>  A posi√ß√£o da c√¢mera 3D √© conhecida antecipadamente; </li><li>  a altura do marcador √© conhecida antecipadamente; </li><li>  como resultado da detec√ß√£o, s√£o conhecidos pixels (v, u) dos 4 cantos dos marcadores; </li><li>  como resultado da calibra√ß√£o da c√¢mera, uma matriz de c√¢mera 4x4 √© definida; </li><li>  conhecendo a 'matriz da c√¢mera', a posi√ß√£o e a orienta√ß√£o da c√¢mera, a posi√ß√£o dos √¢ngulos de pixel do marcador, √© poss√≠vel obter a proje√ß√£o da posi√ß√£o dos √¢ngulos no espa√ßo 3D no plano z no qual os v√©rtices do marcador est√£o localizados (a altura do marcador √© determinada pelo seu n√∫mero); </li><li>  executando a etapa anterior para todos os quatro cantos dos marcadores e calculando a m√©dia dos dados obtidos, √© poss√≠vel obter coordenadas 3D dos v√©rtices dos marcadores no sistema de coordenadas da c√¢mera; </li><li>  aplicando a transforma√ß√£o da c√¢mera SK no SK do campo de jogo, s√£o obtidas as coordenadas do marcador no campo SK. </li></ul><br><h4>  Solu√ß√£o de problemas de ilumina√ß√£o e desempenho </h4><br>  A estabilidade e a velocidade de detec√ß√£o dos marcadores dependem fortemente das condi√ß√µes de ilumina√ß√£o ambiental e da estrutura do plano de fundo, quanto mais objetos diferentes no quadro, mais tempo demora o processamento.  Uma vez que as regras da ilumina√ß√£o e do fundo do Eurobot n√£o s√£o regulamentadas de forma alguma, elas podem mudar bastante de tempos em tempos; pode haver outros campos, pessoas no fundo.  Em particular, podem ser esperadas exposi√ß√µes adicionais de rob√¥s inimigos, flashes da c√¢mera ou holofotes que caem no campo de vis√£o da c√¢mera. <br><br>  Para reduzir a influ√™ncia da ilumina√ß√£o ambiental na estabilidade da detec√ß√£o de marcadores, foi desenvolvido um "design" especial no qual marcadores aruco invertidos foram usados.  A parte escura √© substitu√≠da por um filme retrorrefletivo e uma luz de fundo de LED ativa √© instalada diretamente na c√¢mera.  O processamento da imagem √© realizado em negativo, enquanto o contraste do fundo √© muito menor que o contraste dos seus pr√≥prios marcadores. <br><br>  Aumentar o contraste do marcador permite selecionar efetivamente regi√µes de interesse no quadro e procurar marcadores apenas neles, e n√£o em todo o quadro, o que melhora significativamente a produtividade. <br><br><img src="https://habrastorage.org/webt/fz/p0/4n/fzp04n01ugkpz4b8yuqrasmv2qy.png"><br>  <i>Compara√ß√£o das diferen√ßas de contraste entre um marcador padr√£o e um marcador com uma superf√≠cie reflexiva</i> <br><br><h3>  N√≥s selecionamos ferro </h3><br>  Como as condi√ß√µes de ilumina√ß√£o n√£o est√£o definidas e a velocidade dos rob√¥s pode ser bastante grande, desde o in√≠cio procur√°vamos uma c√¢mera com obturador global, e n√£o com obturador de rolamento.  A diferen√ßa √© que o global coleta informa√ß√µes sobre o brilho dos pixels ao mesmo tempo e rolando linha por linha, pelo que pode haver distor√ß√µes na forma geom√©trica dos objetos em movimento. <br>  A c√¢mera mais acess√≠vel √© a oCam-1mgn, usada por 2 anos.  No entanto, √© preto e branco e possui uma resolu√ß√£o de apenas 1Mpx, localizada na borda inferior de uma resolu√ß√£o aceit√°vel (o n√∫mero de pixels na imagem, por 1 "pixel" do marcador). <br>  Inicialmente, o detector era considerado na mesma placa √∫nica que os pr√≥prios rob√¥s - odroid xu4, e a velocidade de trabalho era de cerca de 20 fps, no entanto, o desejo de pendurar funcionalidades adicionais no centro de controle central e o entendimento de que era necess√°ria uma c√¢mera melhor levaram a substituir o PC por um processador Intel mais vigoroso. Nuc e a c√¢mera ... a c√¢mera que ainda estamos pegando para a nova temporada. <br><br><h3>  Come√ßamos o projeto </h3><br>  Sup√µe-se ainda que voc√™ j√° tenha o ROS Kinetic ou Melodic configurado. <br><br>  A primeira coisa a fazer √© baixar e instalar o OpenCV 3, Eigen3 e o projeto <a href="https://bitbucket.org/eurobot1718/ocam_usb_cam">https://bitbucket.org/eurobot1718/ocam_usb_cam</a> (para a c√¢mera Ocam) ou usar outro projeto com estrutura semelhante √† publica√ß√£o de dados em t√≥picos. <br><br>  Clonamos o reposit√≥rio com o projeto detector de arude: <a href="https://gitlab.com/eurobot2019/aruco_detector">https://gitlab.com/eurobot2019/aruco_detector</a> e gui para ele <a href="https://github.com/alexpostnikov/aruco-gui">https://github.com/alexpostnikov/aruco-gui</a> <br>  Depois de instalar os projetos, voc√™ precisa calibrar a c√¢mera e obter a matriz de dispers√£o e a matriz de distor√ß√£o da c√¢mera e, em seguida, agrupar tudo no arquivo yaml ‚Äúcamera_params.yml‚Äù.  Um exemplo simples √© o uso de um tabuleiro de xadrez.  <a href="https://github.com/sourishg/fisheye-stereo-calibration">Link</a> para a implementa√ß√£o em C ++, onde voc√™ s√≥ precisa coletar e especificar os par√¢metros da placa e da c√¢mera, bem como o nome do arquivo de sa√≠da. <br><br>  As principais configura√ß√µes est√£o no arquivo aruco_detector_params.yml: <br><br><ul><li>  <b>len_of_cube_markers</b> e <b>width_marker o</b> comprimento e a largura dos marcadores em metros; </li><li>  <b>markers_height</b> - compara√ß√£o do marcador e sua altura; </li><li>  <b>marcadores</b> - uma matriz que descreve se um determinado marcador pertence a um rob√¥ espec√≠fico.  Indica os marcadores no sentido hor√°rio.  E no caso dos oponentes, como a dire√ß√£o deles n√£o √© importante para n√≥s, a ordem dos marcadores na configura√ß√£o tamb√©m n√£o √© importante.  Voc√™ s√≥ precisa especificar o c√≥digo do marcador.  Tamb√©m temos marcadores na capa, seus n√∫meros s√£o destacados separadamente; </li><li>  <b>static_markers_ids</b> - marcadores pesquisados ‚Äã‚Äãdurante o processo de calibra√ß√£o; </li><li>  <b>markers_position</b> - um dicion√°rio com o deslocamento e a rota√ß√£o de cada marcador em rela√ß√£o ao centro do rob√¥; </li><li>  <b>brightness_threshold</b> n√£o pode ser tocado - isso √© usado na calibra√ß√£o autom√°tica inicial da luz; </li><li>  <b>camera_position_yellow</b> e um par√¢metro semelhante servem como configura√ß√µes padr√£o no caso de falha na calibra√ß√£o. </li></ul><br>  A matriz de transforma√ß√£o do sistema de coordenadas da c√¢mera para o sistema de coordenadas do campo est√° no arquivo transform_from_cam_to_map.xml <br><br>  Depois de todas as configura√ß√µes, voc√™ finalmente precisa execut√°-lo.  Os caminhos para o arquivo com os par√¢metros, o lado padr√£o e o caminho para o dispositivo de v√≠deo s√£o definidos em aruco_detector_debug.launch, que iniciaremos.  Por√©m, para um lan√ßamento completo, √© melhor usar o script bash aruco.bash, que, al√©m do detector, lan√ßa o gui (127.0.0.1‚ñ∫000).  Aqui podemos escolher o lado, iniciar a calibra√ß√£o e controlar o sistema.  Na segunda janela, zonas de interesse e marcadores encontrados s√£o vis√≠veis. <br><br><img src="https://habrastorage.org/webt/qe/ch/qf/qechqfeowcgq9xevhj8fplpmjqc.gif"><br><br>  Agora nos t√≥picos: "/ enemy_robot1 / aruco", "/ enemy_robot2 / aruco", "/ big_robot / aruco", "/ small_robot / aruco", a posi√ß√£o dos rob√¥s encontrados ser√° publicada. <br><br>  Viva!  Fomos capazes de obter as coordenadas dos rob√¥s.  Isso √© apenas, como voc√™ pode ver, eles est√£o errados.  Isso ocorre porque, antes do uso, √© necess√°rio calibrar a posi√ß√£o da c√¢mera em rela√ß√£o ao campo.  Para isso √© necess√°rio <br><br><ul><li>  defina os cubos nos cantos do campo, enquanto √© importante que eles sejam girados pelos lados especificados na configura√ß√£o </li><li>  ajuste a inclina√ß√£o da c√¢mera para que todo o espa√ßo necess√°rio caia no quadro </li><li>  ajuste o brilho da luz de fundo at√© a detec√ß√£o confi√°vel de marcadores </li><li>  no gui, selecione o lado desejado e clique em "calibrar" </li><li>  o estado de "pesquisar cubos est√°ticos" deve mudar para "pesquisar cubos" </li></ul><br><h2>  Fazemos marcadores e TsUS </h2><br>  De acordo com as regras, podemos colorir nossos rob√¥s como quisermos e, al√©m disso, usar um lugar especial nos nossos e de outras pessoas, no qual voc√™ pode colocar algo com tamanho de at√© 10x10x8cm.  Um local especial est√° localizado na tampa do rob√¥, tem uma altura fixa e melhor visibilidade para o centro de controle central, exceto quando o rob√¥ est√° sob a c√¢mera. <br><br><img src="https://habrastorage.org/webt/mm/_a/zu/mm_azulfvnfcqxm869zluovaq9e.png"><br>  <i>altura e dimens√µes dos far√≥is no rob√¥</i> <br><br>  Portanto, como principais marcadores para nossos rob√¥s, usamos paralelep√≠pedos de 10x10x108 cm colados nos 4 lados do aruco, al√©m de marcadores adicionais na parte superior de nossos rob√¥s para localiza√ß√£o em uma √°rea complexa sob a c√¢mera. <br><br>  Como n√£o podemos prender nada na tampa do inimigo, decidimos fazer marcadores na forma de uma pir√¢mide truncada para expandir o alcance da visibilidade.  E como voc√™ pode ver - o marcador tornou-se vis√≠vel muito melhor. <br><br><img src="https://habrastorage.org/webt/9_/xo/re/9_xoreh7phv_pp5ci_u7utyw5cm.png"><br><br>  Imprimimos a base da pir√¢mide c√∫bica em uma impressora 3D para que ela seja suficientemente forte e tenha uma montagem conveniente e confi√°vel. <br><br><img src="https://habrastorage.org/webt/r9/-l/ek/r9-lekwcd5xkzs_lys0hkrkjw4m.png"><br><br>  Modelos para imprimir um cubo, uma pir√¢mide e uma montagem correspondente est√£o localizados <a href="https://yadi.sk/d/swUJUwxTnTVYFw">aqui.</a> <br><br>  Este cubo √© colado com um refletor (usamos branco AVERY <br>  DENNISON V6700B com 50 mm de largura, embora seja mais caro, funciona muitas vezes melhor que o chin√™s barato), e os marcadores em si s√£o colados sobre ele.  A maneira mais f√°cil de fazer isso √© cortar os marcadores na plotadora, embora voc√™ possa cort√°-los em papel ou filme em algumas horas pac√≠ficas (um conjunto consiste em 16 marcadores). <br><br>  <a href="https://yadi.sk/d/0E5ajh4pumiahA">Aqui est√°</a> o kit do nosso ano passado. <br><br><img src="https://habrastorage.org/webt/2h/1b/9w/2h1b9wwkizem2k9ptbwmwc64spm.png"><br>  <i>v√°rias "gera√ß√µes" de nossos marcadores</i> <br><br>  Eles tamb√©m podem ser usados ‚Äã‚Äãcomo marcadores est√°ticos para calibra√ß√£o.  Para fazer isso, coloque-os nos cantos distantes do campo e clique em calibrar. <br><br><h3>  Montagem de um dispositivo de rastreamento central </h3><br><h4>  O que √© necess√°rio: </h4><br>  <b>Computador de placa √∫nica.</b>  Esses desenhos foram feitos para a localiza√ß√£o da Intel NUC, mas voc√™ pode pensar em colocar no gabinete, por exemplo, odroid xu4 ou raspberry pi4. <br><br>  <b>oCam</b> .  Na verdade, a c√¢mera, para a qual tudo est√° indo.  Alteramos a lente padr√£o para <a href="https://air-hobby.ru/katalog/product/2262-linza-runcam-rc25g-fpv-lens-25mm-fov140-wide-angle.html">2,5 mm</a> para um amplo √¢ngulo de vis√£o <br>  <b>Display (LCD de compartilhamento de onda de 7 polegadas HDMI (B))</b> Com a ajuda, a calibra√ß√£o e v√°rias outras opera√ß√µes s√£o realizadas. <br><br>  <b>Tira de LED.</b>  Usado para iluminar a superf√≠cie reflexiva dos marcadores.  √â melhor usar o mais brilhante dispon√≠vel. <br><br>  <b>Bateria 16,8V LiPo.</b>  N√≥s usamos 4s5200mAh.  S√£o as mesmas baterias do rob√¥, pois s√£o convenientes e duram muito tempo. <br><br>  <b>Conversor dc-dc abaixador.</b>  Para alimentar a faixa de LED.  Nuc e o roteador s√£o alimentados diretamente pela bateria, porque todos os chicotes de energia j√° est√£o neles. <br><br>  Pe√ßas impressas.  Isso, em particular, um suporte de c√¢mera, uma tela e cantos para a montagem do gabinete: <a href="https://yadi.sk/d/swUJUwxTnTVYFw">https://yadi.sk/d/swUJUwxTnTVYFw</a> <br><br>  <b>Detalhes da habita√ß√£o.</b>  No nosso caso, era uma folha de carbono de 2 mm.  Mas essa n√£o √© a melhor op√ß√£o, como condutora de carbono, dif√≠cil de processar e n√£o t√£o leve quanto, por exemplo, o plexiglass - talvez a op√ß√£o mais simples.  Embora muito mais dif√≠cil.  Encontre o link acima. <br><br>  <b>Roteador (Zyxel keenetic extra).</b>  Tivemos que remov√™-lo do estojo para caber em tamanho e peso.  Mas, no caso geral, n√£o recomendamos isso. <br>  Muitas pequenas coisas.  Parafusos M3 * 8 ~ 40pcs, racks para placas de circuito impresso 3x10 ~ 12pcs, fios, chaves de fenda, wago, etc. <br><br><h4>  Assembl√©ia </h4><br>  Primeiro voc√™ precisa preparar os cantos impressos, pressionando as porcas neles.  Pode ser que haja poucos encaixes de press√£o e eles precisem ser levemente colados ou usar <a href="http://www.dart.moscow/index.php%3Fproductcode%3D160923">porcas fundidas</a> <br>  Em seguida, voc√™ precisa instalar esta parte na base.  Ele fornece um posicionamento claro do centro de controle central em seu lugar. <br><br><img src="https://habrastorage.org/webt/cv/0u/vr/cv0uvrzekp09qx2typzni7gzmm4.png"><br><br>  Agora montamos o suporte da c√¢mera, inserimos oCam l√°, colamos a luz de fundo da faixa de LED o mais pr√≥ximo poss√≠vel da lente e prendemos o m√≥dulo na base. <br><br><img src="https://habrastorage.org/webt/x8/c5/sz/x8c5szf7llbkchzglqbbrz22yas.png"><br><br><img src="https://habrastorage.org/webt/k1/oj/w5/k1ojw5cbuwtnireb0axfynlffrk.png"><br><br>  Depois disso, voc√™ pode instalar todas as paredes laterais, fixando-as nos cantos descritos anteriormente.  Os furos para eles s√£o melhores para serem combatidos com anteced√™ncia. <br><br><img src="https://habrastorage.org/webt/ne/mo/v0/nemov0qtrzitlompmpymxhm9npw.png"><br><br>  Colocamos um computador de placa √∫nica e um roteador.  No nosso caso, esses s√£o extra-apetitosos NUC e Zyxel. <br><br><img src="https://habrastorage.org/webt/7l/vc/85/7lvc85rwy0gzifdg9w7a9-n0k8a.png"><br><br><img src="https://habrastorage.org/webt/er/t9/8t/ert98t1wicsogrkpabregc60o2e.png"><br><br><img src="https://habrastorage.org/webt/7y/hk/rc/7yhkrcmukr6oyrgqqyeoiwwz_io.png"><br>  <i>E temos o sistema de rastreamento montado.</i>  <i>Resta apenas ajustar a inclina√ß√£o da c√¢mera.</i> <br><br><img src="https://habrastorage.org/webt/zm/lp/zr/zmlpzrgcfrd68o_xnoaw69sdgeg.png"><br>  <i>depura√ß√£o de localiza√ß√£o em 2018</i> <br><br><h3>  Qual √© o resultado </h3><br>  Ent√£o, contamos todos os segredos que nos permitem repetir nosso sistema com nossas pr√≥prias m√£os.  Utilizando-o, voc√™ pode rapidamente e sem altera√ß√µes fazer o seu sistema para localizar o rob√¥ no campo Eurobot.  E com altera√ß√µes m√≠nimas, crie um sistema de rastreamento bastante universal e confi√°vel para algo.  No entanto, vale considerar que, ao usar o aruco 8x8, um tamanho de marcador de 10x8cm e uma c√¢mera em 1Mpx, n√£o √© particularmente poss√≠vel aumentar o raio de detec√ß√£o, no entanto, se tivermos limita√ß√µes estritas de tamanho e desempenho, geralmente usaremos equipamentos mais interessantes. <br><br>  Este ano, as regras mencionaram o uso do aruco 4x4, bem como suas faixas sem interse√ß√£o para cada lado do campo.  Num futuro pr√≥ximo, planejamos integrar isso √† nossa solu√ß√£o, para que no futuro n√£o tenhamos medo da interse√ß√£o dos n√∫meros dos marcadores.  Outro item obrigat√≥rio, mas o que ainda n√£o foi feito √© a calibra√ß√£o manual em campo. <br>  No pr√≥ximo artigo, falaremos sobre o n√≠vel mais baixo de rob√¥s, como a cinem√°tica dos rob√¥s √© considerada, como controlamos servidores, motores e cones ao trabalhar com freertos. <br><br>  Quero agradecer: <br><br>  <a href="https://github.com/alexpostnikov/aruco-gui">Alexey Postnikov</a> (em nome de quem provavelmente valeu a pena publicar tudo) - em geral, todo o c√≥digo deste artigo e ajuda diretamente na reda√ß√£o do artigo. <br>  <a href="https://habr.com/ru/users/eppy/">Egor Alexandrov</a> - para todos os desenhos e modelos, assist√™ncia na reda√ß√£o do artigo e 34 v√≠rgulas. <br>  <a href="https://habr.com/ru/users/toma_sin/">Tamara Sinelnikova</a> - pela ajuda na reda√ß√£o do artigo. <br><br>  E o resto da equipe! <br><br>  Faltam menos de quatro meses para o in√≠cio da competi√ß√£o, mas a equipe Sberbank Eurobot ainda est√° aberta a novos participantes.  Nosso telegrama: <a href="https://t.me/SetUpSber">https://t.me/SetUpSber</a> <br><br>  Artigos anteriores: <br><br>  <a href="https://habr.com/ru/post/478836/">O que √© comum entre um rev√≥lver, anilhas e um rob√¥ aut√¥nomo</a> <br>  <a href="https://habr.com/ru/post/479636/">Pilha de navega√ß√£o pr√≥pria.</a>  <a href="https://habr.com/ru/post/479636/">Melhor que ROS?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482220/">https://habr.com/ru/post/pt482220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482208/index.html">Presentes que fazem voc√™ sentir falta do Ano Novo</a></li>
<li><a href="../pt482210/index.html">Bot para Tetris e anima√ß√£o de engenharia reversa. An√°lise da pista m√≥vel do segundo campeonato de programa√ß√£o</a></li>
<li><a href="../pt482212/index.html">Falar sobre ... queijo?</a></li>
<li><a href="../pt482216/index.html">23 respostas √† depress√£o de um psiquiatra profissional Maxim Malyavin (dpmmax)</a></li>
<li><a href="../pt482218/index.html">Java Digest para 27 de dezembro</a></li>
<li><a href="../pt482222/index.html">Aplicativo da Web no Kotlin + Spring Boot + Vue.js (complemento)</a></li>
<li><a href="../pt482224/index.html">Quando um designer precisa ser um pouco programador</a></li>
<li><a href="../pt482226/index.html">Os 20 principais aplicativos que um profissional de sa√∫de n√£o pode perder</a></li>
<li><a href="../pt482228/index.html">N√≥s escrevemos uma "calculadora" em C #. Parte I. C√°lculo do valor, derivada, simplifica√ß√£o e outros gansos</a></li>
<li><a href="../pt482230/index.html">A batalha dos servidores WEB. Parte 2 - cen√°rio HTTPS realista:</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>