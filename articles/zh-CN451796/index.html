<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ¤ ğŸ—ï¸ ğŸ‘ğŸ¾ ç¼–å†™å®‰å…¨çš„æµè§ˆå™¨æ‰©å±• ğŸ„ ğŸšµğŸ½ ğŸ†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸å¸¸è§çš„â€œå®¢æˆ·ç«¯-æœåŠ¡å™¨â€æ¶æ„ç›¸åï¼Œåˆ†æ•£å¼åº”ç”¨ç¨‹åºçš„ç‰¹å¾åœ¨äºï¼š 


- æ— éœ€ä½¿ç”¨ç”¨æˆ·ç™»å½•åå’Œå¯†ç å­˜å‚¨æ•°æ®åº“ã€‚ è®¿é—®ä¿¡æ¯ä»…ç”±ç”¨æˆ·è‡ªå·±å­˜å‚¨ï¼Œå…¶çœŸå®æ€§çš„ç¡®è®¤åœ¨åè®®çº§åˆ«è¿›è¡Œã€‚ 
- æ— éœ€ä½¿ç”¨æœåŠ¡å™¨ã€‚ åº”ç”¨ç¨‹åºé€»è¾‘å¯ä»¥åœ¨å¯ä»¥å­˜å‚¨æ‰€éœ€æ•°æ®é‡çš„åŒºå—é“¾ç½‘ç»œä¸Šæ‰§è¡Œã€‚ 


 æœ‰2ä¸ªç›¸å¯¹å®‰å…¨çš„ç”¨æˆ·å¯†é’¥å­˜å‚¨åº“-ç¡¬ä»¶é’±åŒ…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç¼–å†™å®‰å…¨çš„æµè§ˆå™¨æ‰©å±•</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/waves/blog/451796/"><p><img src="https://habrastorage.org/webt/nt/7v/c8/nt7vc8scuypj0o2ngtj1n6fqjlw.png"></p><br><p> ä¸å¸¸è§çš„â€œå®¢æˆ·ç«¯-æœåŠ¡å™¨â€æ¶æ„ç›¸åï¼Œåˆ†æ•£å¼åº”ç”¨ç¨‹åºçš„ç‰¹å¾åœ¨äºï¼š </p><br><ul><li> æ— éœ€ä½¿ç”¨ç”¨æˆ·ç™»å½•åå’Œå¯†ç å­˜å‚¨æ•°æ®åº“ã€‚ è®¿é—®ä¿¡æ¯ä»…ç”±ç”¨æˆ·è‡ªå·±å­˜å‚¨ï¼Œå…¶çœŸå®æ€§çš„ç¡®è®¤åœ¨åè®®çº§åˆ«è¿›è¡Œã€‚ </li><li> æ— éœ€ä½¿ç”¨æœåŠ¡å™¨ã€‚ åº”ç”¨ç¨‹åºé€»è¾‘å¯ä»¥åœ¨å¯ä»¥å­˜å‚¨æ‰€éœ€æ•°æ®é‡çš„åŒºå—é“¾ç½‘ç»œä¸Šæ‰§è¡Œã€‚ </li></ul><br><p> æœ‰2ä¸ªç›¸å¯¹å®‰å…¨çš„ç”¨æˆ·å¯†é’¥å­˜å‚¨åº“-ç¡¬ä»¶é’±åŒ…å’Œæµè§ˆå™¨æ‰©å±•ã€‚ å¤§å¤šæ•°ç¡¬ä»¶é’±åŒ…éƒ½å°½å¯èƒ½åœ°å®‰å…¨ï¼Œä½†æ˜¯å¾ˆéš¾ä½¿ç”¨å¹¶ä¸”è¿œéå…è´¹ï¼Œä½†æ˜¯æµè§ˆå™¨æ‰©å±•æ˜¯å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§çš„å®Œç¾ç»“åˆï¼Œå¹¶ä¸”å¯¹äºæœ€ç»ˆç”¨æˆ·ä¹Ÿå¯ä»¥å®Œå…¨å…è´¹ã€‚ </p><br><p> è€ƒè™‘åˆ°æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬å¸Œæœ›è¿›è¡Œæœ€å®‰å…¨çš„æ‰©å±•ï¼Œä»¥ç®€åŒ–åˆ†æ•£å¼åº”ç”¨ç¨‹åºçš„å¼€å‘ï¼Œå¹¶æä¾›ç”¨äºå¤„ç†äº‹åŠ¡å’Œç­¾åçš„ç®€å•APIã€‚ <br> æˆ‘ä»¬å°†åœ¨ä¸‹é¢å‘Šè¯‰æ‚¨æœ‰å…³æ­¤ä½“éªŒçš„ä¿¡æ¯ã€‚ </p><br><p>  <strong>æœ¬æ–‡å°†æä¾›æœ‰å…³å¦‚ä½•ç¼–å†™æµè§ˆå™¨æ‰©å±•çš„åˆ†æ­¥è¯´æ˜ï¼Œä»¥åŠä»£ç ç¤ºä¾‹å’Œå±å¹•æˆªå›¾ã€‚</strong> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å­˜å‚¨åº“ä¸­</a>æ‰¾åˆ°æ‰€æœ‰ä»£ç ã€‚ æ¯ä¸ªæäº¤åœ¨é€»è¾‘ä¸Šå¯¹åº”äºæœ¬æ–‡çš„ä¸€éƒ¨åˆ†ã€‚ </p><a name="habracut"></a><br><h2 id="kratkaya-istoriya-brauzernyh-rasshireniy"> æµè§ˆå™¨æ‰©å±•çš„ç®€è¦å†å² </h2><br><p> æµè§ˆå™¨æ‰©å±•å·²ç»å­˜åœ¨äº†ä¸€æ®µæ—¶é—´ã€‚ åœ¨Internet Explorerä¸­ï¼Œå®ƒä»¬åˆ†åˆ«äº1999å¹´å’ŒFirefoxä¸­ï¼ˆ2004å¹´ï¼‰å‡ºç°ã€‚ ä½†æ˜¯ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œæ²¡æœ‰å•ä¸€çš„æ‰©å±•æ ‡å‡†ã€‚ </p><br><p> å¯ä»¥è¯´ï¼Œå®ƒä¸æ‰©å±•ç¨‹åºä¸€èµ·å‡ºç°åœ¨ç¬¬å››ç‰ˆçš„Google Chromeæµè§ˆå™¨ä¸­ã€‚ å½“ç„¶ï¼Œå½“æ—¶è¿˜æ²¡æœ‰è§„èŒƒï¼Œä½†æ­£æ˜¯Chrome APIæˆä¸ºå…¶åŸºç¡€ï¼šChromeå é¢†äº†æµè§ˆå™¨å¸‚åœºçš„å¾ˆå¤§ä¸€éƒ¨åˆ†å¹¶æ‹¥æœ‰å†…ç½®çš„åº”ç”¨ç¨‹åºå•†åº—ï¼Œå®é™…ä¸Šä¸ºæµè§ˆå™¨æ‰©å±•è®¾å®šäº†æ ‡å‡†ã€‚ </p><br><p>  Mozillaæ‹¥æœ‰è‡ªå·±çš„æ ‡å‡†ï¼Œä½†æ˜¯ï¼Œé‰´äºChromeæ‰©å±•ç¨‹åºçš„æ™®åŠï¼Œè¯¥å…¬å¸å†³å®šåˆ¶ä½œå…¼å®¹çš„APIã€‚  2015å¹´ï¼Œåœ¨Mozillaçš„å€¡è®®ä¸‹ï¼Œä¸‡ç»´ç½‘è”ç›Ÿï¼ˆW3Cï¼‰æˆç«‹äº†ä¸€ä¸ªç‰¹åˆ«å°ç»„ï¼Œè´Ÿè´£è·¨æµè§ˆå™¨æ‰©å±•çš„è§„èŒƒã€‚ </p><br><p>åŸºäºChromeçš„ç°æœ‰APIæ‰©å±•ã€‚ è¿™é¡¹å·¥ä½œå¾—åˆ°äº†Microsoftçš„æ”¯æŒï¼ˆGoogleæ‹’ç»å‚ä¸è¯¥æ ‡å‡†çš„å¼€å‘ï¼‰ï¼Œå› æ­¤ï¼Œå‡ºç°äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§„èŒƒ</a>è‰æ¡ˆã€‚ </p><br><p> æ­£å¼è€Œè¨€ï¼ŒEdgeï¼ŒFirefoxå’ŒOperaæ”¯æŒè¯¥è§„èŒƒï¼ˆè¯·æ³¨æ„ï¼ŒChromeä¸åœ¨æ­¤åˆ—è¡¨ä¸­ï¼‰ã€‚ ä½†å®é™…ä¸Šï¼Œè¯¥æ ‡å‡†å®é™…ä¸Šä¸Chromeå…¼å®¹ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯åŸºäºæ‰©å±•åç¼–å†™çš„ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³WebExtensions APIçš„æ›´å¤šä¿¡æ¯ã€‚ </p><br><h2 id="struktura-rasshireniya"> æ‰©å±•ç»“æ„ </h2><br><p> æ‰©å±•åæ‰€éœ€çš„å”¯ä¸€æ–‡ä»¶æ˜¯æ¸…å•ï¼ˆmanifest.jsonï¼‰ã€‚ ä»–æ˜¯æ‰©å±•çš„â€œå…¥å£ç‚¹â€ã€‚ </p><br><h3 id="manifest"> æ¸…å• </h3><br><p> æ ¹æ®è§„èŒƒï¼Œæ¸…å•æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶ã€‚ æ¸…å•å¯†é’¥çš„å®Œæ•´è¯´æ˜ï¼Œä»¥åŠæœ‰å…³åœ¨å“ªç§æµè§ˆå™¨ä¸­æ”¯æŒå“ªäº›å¯†é’¥çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨<a href="">æ­¤å¤„</a>æ‰¾åˆ°ã€‚ </p><br><p> å¯ä»¥å¿½ç•¥è§„èŒƒä¸­æœªåŒ…å«çš„é”®ï¼ˆChromeå’ŒFirefoxå‡æŠ¥å‘Šé”™è¯¯ï¼Œä½†æ‰©å±•åä»å¯ä½¿ç”¨ï¼‰ã€‚ </p><br><p> æˆ‘æƒ³æè¯·æ³¨æ„å‡ ç‚¹ã€‚ </p><br><ol><li>  <strong>èƒŒæ™¯</strong> -ä¸€ä¸ªåŒ…å«ä»¥ä¸‹å­—æ®µçš„å¯¹è±¡ï¼š <br><ol><li>  <strong>è„šæœ¬</strong> -å°†åœ¨åå°ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„è„šæœ¬æ•°ç»„ï¼ˆæˆ‘ä»¬ç¨åå†è®¨è®ºï¼‰ï¼› </li><li>  <strong>é¡µé¢</strong> -æ‚¨å¯ä»¥æŒ‡å®šå¸¦æœ‰å†…å®¹çš„htmlï¼Œè€Œä¸æ˜¯å°†åœ¨ç©ºç™½é¡µé¢ä¸Šæ‰§è¡Œçš„è„šæœ¬ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè„šæœ¬å­—æ®µå°†è¢«å¿½ç•¥ï¼Œå¹¶ä¸”è„šæœ¬éœ€è¦ä¸å†…å®¹ä¸€èµ·æ’å…¥åˆ°é¡µé¢ä¸­ã€‚ </li><li>  <strong>æŒä¹…</strong> -äºŒè¿›åˆ¶æ ‡å¿—ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰ï¼Œå½“æµè§ˆå™¨è®¤ä¸ºè‡ªå·±æ²¡æœ‰æ‰§è¡Œä»»ä½•æ“ä½œæ—¶ï¼Œå°†â€œæ€æ­»â€åå°è¿›ç¨‹ï¼Œå¹¶åœ¨å¿…è¦æ—¶é‡æ–°å¯åŠ¨ã€‚ å¦åˆ™ï¼Œä»…å½“å…³é—­æµè§ˆå™¨æ—¶ï¼Œé¡µé¢æ‰ä¼šè¢«å¸è½½ã€‚  Firefoxä¸æ”¯æŒã€‚ </li></ol></li><li>  <strong>content_scripts-</strong>å¯¹è±¡æ•°ç»„ï¼Œå…è®¸æ‚¨å°†ä¸åŒçš„è„šæœ¬åŠ è½½åˆ°ä¸åŒçš„ç½‘é¡µã€‚ æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä»¥ä¸‹é‡è¦å­—æ®µï¼š <br><ol><li>  <strong>åŒ¹é…</strong> -ç¡®å®šæ˜¯å¦å°†åŒ…å«ç‰¹å®šå†…å®¹è„šæœ¬çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">urlæ¨¡å¼</a> ã€‚ </li><li>  <strong>js-</strong>å°†è¢«åŠ è½½åˆ°è¯¥åŒ¹é…ä¸­çš„è„šæœ¬åˆ—è¡¨ï¼› </li><li> <strong>exclude_matches-</strong>ä»<code>match</code>å­—æ®µä¸­æ’é™¤<code>match</code>è¯¥å­—æ®µ<code>match</code> URLã€‚ </li></ol></li><li>  <strong>page_action-</strong>å®é™…ä¸Šï¼Œç”±å¯¹è±¡è´Ÿè´£æµè§ˆå™¨ä¸­åœ°å€æ æ—è¾¹æ˜¾ç¤ºçš„å›¾æ ‡åŠå…¶äº¤äº’ã€‚ å®ƒè¿˜å…è®¸æ‚¨æ˜¾ç¤ºå¼¹å‡ºçª—å£ï¼Œè¯¥çª—å£ä½¿ç”¨å…¶HTMLï¼ŒCSSå’ŒJSè¿›è¡Œè®¾ç½®ã€‚ <br><ol><li>  <strong>default_popup-</strong>å…·æœ‰å¼¹å‡ºç•Œé¢çš„HTMLæ–‡ä»¶çš„è·¯å¾„ï¼Œå¯èƒ½åŒ…å«CSSå’ŒJSã€‚ </li></ol></li><li>  <strong>æƒé™</strong> -ç”¨äºç®¡ç†æ‰©å±•ç¨‹åº<strong>æƒé™</strong>çš„æ•°ç»„ã€‚ è¿™é‡Œå°†è¯¦ç»†ä»‹ç»3ç§ç±»å‹çš„æƒåˆ©<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a> </li><li>  <strong>web_accessible_resources-</strong>ç½‘é¡µå¯ä»¥è¯·æ±‚çš„æ‰©å±•èµ„æºï¼Œä¾‹å¦‚å›¾åƒï¼ŒJSï¼ŒCSSï¼ŒHTMLæ–‡ä»¶ã€‚ </li><li>  <strong>externally_connectable-</strong>åœ¨è¿™é‡Œæ‚¨å¯ä»¥æ˜¾å¼æŒ‡å®šå…¶ä»–æ‰©å±•åçš„IDä»¥åŠå¯ä»¥è¿æ¥çš„ç½‘é¡µåŸŸã€‚ åŸŸå¯ä»¥æ˜¯ç¬¬äºŒçº§æˆ–æ›´é«˜çº§åˆ«ã€‚ åœ¨Firefoxä¸­ä¸èµ·ä½œç”¨ã€‚ </li></ol><br><h2 id="kontekst-vypolneniya"> æ‰§è¡Œä¸Šä¸‹æ–‡ </h2><br><p> è¯¥æ‰©å±•å…·æœ‰ä¸‰ä¸ªä»£ç æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå³ï¼Œè¯¥åº”ç”¨ç¨‹åºç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œè¿™äº›éƒ¨åˆ†å…·æœ‰å¯¹æµè§ˆå™¨APIçš„ä¸åŒè®¿é—®çº§åˆ«ã€‚ </p><br><h3 id="extension-context"> æ‰©å±•ä¸Šä¸‹æ–‡ </h3><br><p> æ­¤å¤„æä¾›äº†å¤§å¤šæ•°APIã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œå®æ—¶â€ï¼š </p><br><ol><li>  <strong>åå°é¡µé¢</strong> -æ‰©å±•çš„â€œåç«¯â€éƒ¨åˆ†ã€‚ è¯¥æ–‡ä»¶åœ¨æ¸…å•ä¸­é€šè¿‡â€œèƒŒæ™¯â€é”®æŒ‡ç¤ºã€‚ </li><li>  <strong>å¼¹å‡ºé¡µé¢</strong> -å•å‡»æ‰©å±•å›¾æ ‡æ—¶å‡ºç°çš„<strong>å¼¹å‡ºé¡µé¢</strong> ã€‚ åœ¨æ¸…å•ä¸­ï¼Œ <code>browser_action</code> &gt; <code>default_popup</code> ã€‚ </li><li>  <strong>è‡ªå®šä¹‰é¡µé¢</strong> -æ‰©å±•é¡µé¢ï¼Œâ€œå±…ä½â€åœ¨<code>chrome-extension://&lt;id_&gt;/customPage.html</code>å½¢å¼çš„å•ç‹¬æ ‡ç­¾ä¸­<code>chrome-extension://&lt;id_&gt;/customPage.html</code> ã€‚ </li></ol><br><p> æ­¤ä¸Šä¸‹æ–‡ç‹¬ç«‹äºæµè§ˆå™¨çª—å£å’Œé€‰é¡¹å¡è€Œå­˜åœ¨ã€‚ åå°<strong>é¡µé¢</strong>å­˜åœ¨äºå•ä¸ªå‰¯æœ¬ä¸­ï¼Œå¹¶ä¸”å§‹ç»ˆæœ‰æ•ˆï¼ˆäº‹ä»¶é¡µé¢æ˜¯ä¾‹å¤–ï¼Œäº‹ä»¶é¡µé¢æ˜¯åœ¨äº‹ä»¶ä¸Šå¯åŠ¨åå°è„šæœ¬å¹¶åœ¨æ‰§è¡Œåæ­»æ‰çš„ï¼‰ã€‚ å¼¹å‡º<strong>é¡µé¢</strong>åœ¨æ‰“å¼€å¼¹å‡ºçª—å£æ—¶å­˜åœ¨ï¼Œè€Œâ€œ <strong>è‡ªå®šä¹‰â€é¡µé¢</strong> -å½“å¸¦æœ‰å®ƒçš„é€‰é¡¹å¡æ‰“å¼€æ—¶å­˜åœ¨ã€‚ åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­æ— æ³•è®¿é—®å…¶ä»–é€‰é¡¹å¡åŠå…¶å†…å®¹ã€‚ </p><br><h3 id="content-script-context"> å†…å®¹è„šæœ¬ä¸Šä¸‹æ–‡ </h3><br><p> å†…å®¹è„šæœ¬æ–‡ä»¶ä¸æ¯ä¸ªæµè§ˆå™¨é€‰é¡¹å¡ä¸€èµ·å¯åŠ¨ã€‚ ä»–æœ‰æƒè®¿é—®æ‰©å±•APIçš„ä¸€éƒ¨åˆ†ä»¥åŠç½‘é¡µçš„DOMæ ‘ã€‚ å†…å®¹è„šæœ¬è´Ÿè´£ä¸é¡µé¢è¿›è¡Œäº¤äº’ã€‚ æ“ä½œDOMæ ‘çš„æ‰©å±•å¯ä»¥åœ¨å†…å®¹è„šæœ¬ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä¾‹å¦‚ï¼Œå¹¿å‘Šé˜»æ­¢ç¨‹åºæˆ–ç¿»è¯‘ç¨‹åºã€‚ åŒæ ·ï¼Œå†…å®¹è„šæœ¬å¯ä»¥é€šè¿‡æ ‡å‡†<code>postMessage</code>ä¸é¡µé¢è¿›è¡Œé€šä¿¡ã€‚ </p><br><h3 id="web-page-context"> ç½‘é¡µä¸Šä¸‹æ–‡ </h3><br><p> è¿™å®é™…ä¸Šæ˜¯ç½‘é¡µæœ¬èº«ã€‚ é™¤éæ‰©å±•æ¸…å•ä¸­æœªæ˜ç¡®æŒ‡å®šæ­¤é¡µé¢çš„åŸŸï¼Œå¦åˆ™å®ƒä¸æ‰©å±•æ— å…³ï¼Œå¹¶ä¸”åœ¨é‚£é‡Œæ— æ³•è®¿é—®ã€‚ </p><br><h2 id="obmen-soobscheniyami"> è®¯æ¯ä¼ é€’ </h2><br><p> åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¿…é¡»å½¼æ­¤äº¤æ¢æ¶ˆæ¯ã€‚ ä¸ºæ­¤ï¼Œæœ‰ä¸€ä¸ª<code>runtime.sendMessage</code> APIç”¨äºå‘é€<code>background</code>æ¶ˆæ¯ï¼Œè€Œ<code>tabs.sendMessage</code>ç”¨äºå‘é¡µé¢ï¼ˆå†…å®¹è„šæœ¬ï¼Œå¼¹å‡ºçª—å£æˆ–ç½‘é¡µï¼Œå¦‚æœå­˜åœ¨<code>externally_connectable</code> ï¼‰å‘é€æ¶ˆæ¯ã€‚ ä»¥ä¸‹æ˜¯è®¿é—®Chrome APIçš„ç¤ºä¾‹ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     JSON   const msg = {a: 'foo', b: 'bar'}; // extensionId   ,      ''  ( ui   ) chrome.runtime.sendMessage(extensionId, msg); //    chrome.runtime.onMessage.addListener((msg) =&gt; console.log(msg)) //       id chrome.tabs.sendMessage(tabId, msg) //      id , ,   chrome.tabs.query( {currentWindow: true, active : true}, function(tabArray){ tabArray.forEach(tab =&gt; console.log(tab.id)) } )</span></span></code> </pre> <br><p> ä¸ºäº†è¿›è¡Œå®Œæ•´çš„é€šä¿¡ï¼Œå¯ä»¥é€šè¿‡<code>runtime.connect</code>åˆ›å»ºè¿æ¥ã€‚ ä½œä¸ºå“åº”ï¼Œæˆ‘ä»¬è·å¾—<code>runtime.Port</code> ï¼Œå½“å®ƒæ‰“å¼€æ—¶ï¼Œæ‚¨å¯ä»¥å‘å…¶ä¸­å‘é€ä»»æ„æ•°é‡çš„æ¶ˆæ¯ã€‚ åœ¨å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚<code>contentscript</code> ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   extensionId        .    const port = chrome.runtime.connect({name: "knockknock"}); port.postMessage({joke: "Knock knock"}); port.onMessage.addListener(function(msg) { if (msg.question === "Who's there?") port.postMessage({answer: "Madame"}); else if (msg.question === "Madame who?") port.postMessage({answer: "Madame... Bovary"});</span></span></code> </pre><br><p> æœåŠ¡å™¨æˆ–åå°ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    '' .  , popup    chrome.runtime.onConnect.addListener(function(port) { console.assert(port.name === "knockknock"); port.onMessage.addListener(function(msg) { if (msg.joke === "Knock knock") port.postMessage({question: "Who's there?"}); else if (msg.answer === "Madame") port.postMessage({question: "Madame who?"}); else if (msg.answer === "Madame... Bovary") port.postMessage({question: "I don't get it."}); }); }); //     .     ,      chrome.runtime.onConnectExternal.addListener(function(port) { ... });</span></span></code> </pre> <br><p> è¿˜æœ‰ä¸€ä¸ª<code>onDisconnect</code>äº‹ä»¶å’Œä¸€ä¸ª<code>disconnect</code>æ–¹æ³•ã€‚ </p><br><h2 id="shema-prilozheniya"> åº”ç”¨æ¦‚è¿° </h2><br><p> è®©æˆ‘ä»¬åšä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ï¼Œå®ƒå­˜å‚¨ç§é’¥ï¼Œæä¾›å¯¹å…¬å…±ä¿¡æ¯çš„è®¿é—®ï¼ˆåœ°å€ï¼Œå…¬é’¥ä¸é¡µé¢è¿›è¡Œé€šä¿¡ï¼Œå¹¶å…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºè¯·æ±‚äº‹åŠ¡ç­¾åã€‚ </p><br><h2 id="razrabotka-prilozheniya"> åº”ç”¨å¼€å‘ </h2><br><p> æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåº”ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼Œå¹¶æä¾›ç”¨äºè°ƒç”¨æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œç”¨äºç­¾ç½²äº¤æ˜“ï¼‰çš„APIé¡µé¢ã€‚ å®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨<code>contentscript</code> ï¼Œå› ä¸ºå®ƒåªèƒ½è®¿é—®DOMï¼Œè€Œä¸èƒ½è®¿é—®JSé¡µé¢ã€‚ æˆ‘ä»¬æ— æ³•é€šè¿‡<code>runtime.connect</code>è¿æ¥ï¼Œå› ä¸ºæ‰€æœ‰åŸŸéƒ½éœ€è¦APIï¼Œå¹¶ä¸”æ¸…å•ä¸­åªèƒ½æŒ‡å®šç‰¹å®šåŸŸã€‚ ç»“æœï¼Œè¯¥æ–¹æ¡ˆå°†å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/fa/b3/gx/fab3gxq823kwybj9yk_kv8wlogy.png"></p><br><p> è¿˜æœ‰å¦ä¸€ä¸ªè„šæœ¬<code>inpage</code> ï¼Œæˆ‘ä»¬å°†å…¶æ³¨å…¥åˆ°é¡µé¢ä¸­ã€‚ å®ƒå°†åœ¨å…¶ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå¹¶æä¾›ç”¨äºæ‰©å±•çš„APIã€‚ </p><br><h3 id="nachalo"> å¼€å§‹ </h3><br><p> æ‰€æœ‰æµè§ˆå™¨æ‰©å±•ä»£ç å‡å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHubä¸Šè·å¾—</a> ã€‚ åœ¨æè¿°è¿‡ç¨‹ä¸­ï¼Œå°†æœ‰æŒ‡å‘æäº¤çš„é“¾æ¥ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»æ¸…å•å¼€å§‹ï¼š </p><br><pre> <code class="javascript hljs">{ <span class="hljs-comment"><span class="hljs-comment">//   , .        chrome://extensions/?id=&lt;id &gt; "name": "Signer", "description": "Extension demo", "version": "0.0.1", "manifest_version": 2, // ,     background,     "background": { "scripts": ["background.js"] }, //  html   popup "browser_action": { "default_title": "My Extension", "default_popup": "popup.html" }, //  . //    :   url   http  https   // contenscript context   contentscript.js.         "content_scripts": [ { "matches": [ "http://*/*", "https://*/*" ], "js": [ "contentscript.js" ], "run_at": "document_start", "all_frames": true } ], //    localStorage  idle api "permissions": [ "storage", // "unlimitedStorage", //"clipboardWrite", "idle" //"activeTab", //"webRequest", //"notifications", //"tabs" ], //   ,       .      fetche'   xhr "web_accessible_resources": ["inpage.js"] }</span></span></code> </pre> <br><p> åˆ›å»ºç©ºçš„background.jsï¼Œpopup.jsï¼Œinpage.jså’Œcontentscript.jsã€‚ æ·»åŠ popup.html-æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²ç»å¯ä»¥ä¸‹è½½åˆ°Google Chromeä¸­ï¼Œå¹¶ç¡®ä¿å®ƒå¯ä»¥è¿è¡Œã€‚ </p><br><p> ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»æ­¤å¤„</a>è·å–ä»£ç ã€‚ é™¤äº†æˆ‘ä»¬æ‰€åšçš„ä»¥å¤–ï¼Œè¿˜é…ç½®äº†é“¾æ¥ä»¥ä½¿ç”¨webpackæ„å»ºé¡¹ç›®ã€‚ è¦å°†åº”ç”¨ç¨‹åºæ·»åŠ åˆ°æµè§ˆå™¨ä¸­ï¼Œè¯·ä½¿ç”¨chromeï¼š//æ‰©å±•åï¼Œæ‚¨éœ€è¦é€‰æ‹©load unpackedä»¥åŠå…·æœ‰ç›¸åº”æ‰©å±•åçš„æ–‡ä»¶å¤¹-åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸ºdistã€‚ </p><br><p><img src="https://habrastorage.org/webt/ws/ng/qz/wsngqza3qdcjtxycbcwk4awpfqm.png"></p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ‰©å±•ç¨‹åºå·²å®‰è£…å¹¶è¿è¡Œã€‚ æ‚¨å¯ä»¥ä¸ºä¸åŒçš„ä¸Šä¸‹æ–‡è¿è¡Œå¼€å‘è€…å·¥å…·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p> å¼¹å‡º-&gt; </p><br><p><img src="https://habrastorage.org/webt/m3/pr/9d/m3pr9dww991nvn9jsfwj8mvndqq.png"></p><br><p> é€šè¿‡å¯åŠ¨å†…å®¹è„šæœ¬çš„é¡µé¢æœ¬èº«çš„æ§åˆ¶å°ï¼Œå¯ä»¥è®¿é—®å†…å®¹è„šæœ¬çš„æ§åˆ¶å°ã€‚ <img src="https://habrastorage.org/webt/3t/gn/6v/3tgn6vao3ilxdwyz9zxraegz9vo.png"></p><br><p>  <strong>è®¯æ¯ä¼ é€’</strong> </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸¤ä¸ªé€šä¿¡æ¸ é“ï¼šinpage &lt;-&gt;èƒŒæ™¯å’Œå¼¹å‡º&lt;-&gt;èƒŒæ™¯ã€‚ å½“ç„¶ï¼Œæ‚¨å¯ä»¥åªå‘ç«¯å£å‘é€æ¶ˆæ¯å¹¶å‘æ˜æ‚¨çš„åè®®ï¼Œä½†æ˜¯æˆ‘æ›´å–œæ¬¢åœ¨å¼€æºmetamaské¡¹ç›®ä¸­ä¾¦å¬çš„æ–¹æ³•ã€‚ </p><br><p> è¿™æ˜¯ä¸€ä¸ªç”¨äºä»¥å¤ªåŠç½‘ç»œçš„æµè§ˆå™¨æ‰©å±•ã€‚ åœ¨å…¶ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä½¿ç”¨dnodeåº“é€šè¿‡RPCè¿›è¡Œé€šä¿¡ã€‚ å¦‚æœæ‚¨å°†nodejsæµä½œä¸ºä¼ è¾“æä¾›ï¼ˆæ„å‘³ç€å®ç°ç›¸åŒæ¥å£çš„å¯¹è±¡ï¼‰ï¼Œå®ƒå¯ä»¥è®©æ‚¨å¿«é€Ÿæ–¹ä¾¿åœ°ç»„ç»‡äº¤æ¢ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dnode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"dnode/browser"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//           ,         // C // API,     const dnode = Dnode({ hello: (cb) =&gt; cb(null, "world") }) // ,     dnode.  nodejs .     'readable-stream' connectionStream.pipe(dnode).pipe(connectionStream) //  const dnodeClient = Dnode() //         API    //    world dnodeClient.once('remote', remote =&gt; { remote.hello(((err, value) =&gt; console.log(value))) })</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºç±»ã€‚ å®ƒå°†ä¸ºå¼¹å‡ºçª—å£å’Œç½‘é¡µåˆ›å»ºAPIå¯¹è±¡ï¼Œå¹¶ä¸ºå®ƒä»¬åˆ›å»ºdnodeï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dnode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dnode/browser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   API  ui popupApi(){ return { hello: cb =&gt; cb(null, 'world') } } //   API   pageApi(){ return { hello: cb =&gt; cb(null, 'world') } } //  popup ui connectPopup(connectionStream){ const api = this.popupApi(); const dnode = Dnode(api); connectionStream.pipe(dnode).pipe(connectionStream); dnode.on('remote', (remote) =&gt; { console.log(remote) }) } //   connectPage(connectionStream, origin){ const api = this.popupApi(); const dnode = Dnode(api); connectionStream.pipe(dnode).pipe(connectionStream); dnode.on('remote', (remote) =&gt; { console.log(origin); console.log(remote) }) } }</span></span></code> </pre> <br><p> åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨extentionApiä»£æ›¿äº†å…¨å±€çš„Chromeå¯¹è±¡ï¼Œå®ƒæ˜¯æŒ‡Googleçš„æµè§ˆå™¨ä¸­çš„Chromeå’Œå…¶ä»–æµè§ˆå™¨ä¸­çš„Chromeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†å®ç°è·¨æµè§ˆå™¨çš„å…¼å®¹æ€§ï¼Œä½†æ˜¯åœ¨æœ¬æ–‡çš„æ¡†æ¶ä¸­å¯ä»¥ä»…ä½¿ç”¨chrome.runtime.connectã€‚ </p><br><p> åœ¨åå°è„šæœ¬ä¸­åˆ›å»ºåº”ç”¨ç¨‹åºå®ä¾‹ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {SignerApp} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./SignerApp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignerApp(); <span class="hljs-comment"><span class="hljs-comment">// onConnect    '' (contentscript, popup,   ) extensionApi.runtime.onConnect.addListener(connectRemote); function connectRemote(remotePort) { const processName = remotePort.name; const portStream = new PortStream(remotePort); //      ,          ,   ui if (processName === 'contentscript'){ const origin = remotePort.sender.url app.connectPage(portStream, origin) }else{ app.connectPopup(portStream) } }</span></span></code> </pre> <br><p> ç”±äºdnodeå¯ç”¨äºæµï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥è·å–ç«¯å£ï¼Œå› æ­¤éœ€è¦é€‚é…å™¨ç±»ã€‚ å®ƒæ˜¯ä½¿ç”¨å¯è¯»æµåº“åˆ¶ä½œçš„ï¼Œè¯¥åº“åœ¨æµè§ˆå™¨ä¸­å®ç°äº†nodejsæµï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Duplex} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'readable-stream'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortStream</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Duplex</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(port){ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({<span class="hljs-attr"><span class="hljs-attr">objectMode</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._port = port; port.onMessage.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onMessage.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); port.onDisconnect.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onDisconnect.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) } _onMessage(msg) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Buffer.isBuffer(msg)) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> msg._isBuffer; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buffer(msg); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(data) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(msg) } } _onDisconnect() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.destroy() } _read(){} _write(msg, encoding, cb) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Buffer.isBuffer(msg)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = msg.toJSON(); data._isBuffer = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._port.postMessage(data) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._port.postMessage(msg) } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cb(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'PortStream - disconnected'</span></span>)) } cb() } }</code> </pre> <br><p> ç°åœ¨åœ¨UIä¸­åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dnode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dnode/browser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span>; setupUi().catch(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupUi</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,       ,   stream,  dnode const backgroundPort = extensionApi.runtime.connect({name: 'popup'}); const connectionStream = new PortStream(backgroundPort); const dnode = Dnode(); connectionStream.pipe(dnode).pipe(connectionStream); const background = await new Promise(resolve =&gt; { dnode.once('remote', api =&gt; { resolve(api) }) }); //   API    if (DEV_MODE){ global.background = background; } }</span></span></code> </pre> <br><p> ç„¶åï¼Œæˆ‘ä»¬åœ¨å†…å®¹è„šæœ¬ä¸­åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PostMessageStream <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'post-message-stream'</span></span>; setupConnection(); injectScript(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> backgroundPort = extensionApi.runtime.connect({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'contentscript'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> backgroundStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortStream(backgroundPort); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pageStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PostMessageStream({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'content'</span></span>, <span class="hljs-attr"><span class="hljs-attr">target</span></span>: <span class="hljs-string"><span class="hljs-string">'page'</span></span>, }); pageStream.pipe(backgroundStream).pipe(pageStream); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectScript</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// inject in-page script let script = document.createElement('script'); script.src = extensionApi.extension.getURL('inpage.js'); const container = document.head || document.documentElement; container.insertBefore(script, container.children[0]); script.onload = () =&gt; script.remove(); } catch (e) { console.error('Injection failed.', e); } }</span></span></code> </pre> <br><p> ç”±äºæˆ‘ä»¬ä¸éœ€è¦å†…å®¹è„šæœ¬ä¸­çš„APIï¼Œè€Œæ˜¯ç›´æ¥åœ¨é¡µé¢ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬åšä¸¤ä»¶äº‹ï¼š </p><br><ol><li> æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæµã€‚ ä¸€ç§æ˜¯åœ¨postMessageé¡¶éƒ¨çš„é¡µé¢ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨metamaskçš„åˆ›å»ºè€…æä¾›çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤ç¨‹åºåŒ…</a> ã€‚ ç¬¬äºŒä¸ªæµåœ¨ä»<code>runtime.connect</code>æ¥æ”¶åˆ°çš„ç«¯å£çš„é¡¶éƒ¨åˆ°è¾¾åå°ã€‚ ç‚¹ä»–ä»¬ã€‚ ç°åœ¨ï¼Œè¯¥é¡µé¢å°†æµå‘åå°ã€‚ </li><li> å°†è„šæœ¬æ³¨å…¥DOMã€‚ æˆ‘ä»¬æŠ½å‡ºè„šæœ¬ï¼ˆæ¸…å•ä¸­å…è®¸è®¿é—®è„šæœ¬ï¼‰å¹¶åˆ›å»ºä¸€ä¸ª<code>script</code>æ ‡ç­¾ï¼Œå…¶å†…å®¹ä½äºå…¶ä¸­ï¼š </li></ol><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PostMessageStream <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'post-message-stream'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; setupConnection(); injectScript(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    const backgroundPort = extensionApi.runtime.connect({name: 'contentscript'}); const backgroundStream = new PortStream(backgroundPort); //    const pageStream = new PostMessageStream({ name: 'content', target: 'page', }); pageStream.pipe(backgroundStream).pipe(pageStream); } function injectScript(){ try { // inject in-page script let script = document.createElement('script'); script.src = extensionApi.extension.getURL('inpage.js'); const container = document.head || document.documentElement; container.insertBefore(script, container.children[0]); script.onload = () =&gt; script.remove(); } catch (e) { console.error('Injection failed.', e); } }</span></span></code> </pre> <br><p> ç°åœ¨åœ¨inpageä¸­åˆ›å»ºä¸€ä¸ªapiå¯¹è±¡ï¼Œç„¶åå…¨å±€å¯åŠ¨å®ƒï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PostMessageStream <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'post-message-stream'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dnode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dnode/browser'</span></span>; setupInpageApi().catch(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupInpageApi</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    const connectionStream = new PostMessageStream({ name: 'page', target: 'content', }); const dnode = Dnode(); connectionStream.pipe(dnode).pipe(connectionStream); //   API const pageApi = await new Promise(resolve =&gt; { dnode.once('remote', api =&gt; { resolve(api) }) }); //   window global.SignerApp = pageApi; }</span></span></code> </pre> <br><p> æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨å•ç‹¬çš„é¡µé¢å’ŒUI API</a>è¿›è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰</a> ã€‚ å°†æ–°é¡µé¢è¿æ¥åˆ°åå°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š </p><br><p><img src="https://habrastorage.org/webt/cy/r_/pm/cyr_pmgm-u5hes5lefaf85gk91m.png"></p><br><p> ç©ºçš„APIå’Œæ¥æºã€‚ åœ¨é¡µé¢ä¸€ä¾§ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è°ƒç”¨helloå‡½æ•°ï¼š </p><br><p><img src="https://habrastorage.org/webt/3p/fd/tv/3pfdtv17ejnjzh94uajezgz0lce.png"></p><br><p> åœ¨ç°ä»£JSä¸­ä½¿ç”¨å›è°ƒå‡½æ•°ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªå°çš„å¸®åŠ©ç¨‹åºæ¥åˆ›å»ºdnodeï¼Œè¯¥dnodeå…è®¸æ‚¨å°†APIä¼ é€’ç»™å¯¹è±¡ä¸­çš„utilsã€‚ </p><br><p>  APIå¯¹è±¡ç°åœ¨å°†å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ popupApi() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; <span class="hljs-string"><span class="hljs-string">"world"</span></span> } } ... }</code> </pre> <br><p> ä»è¿œç¨‹è·å–å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {cbToPromise, transformMethods} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../../src/utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pageApi = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { dnode.once(<span class="hljs-string"><span class="hljs-string">'remote'</span></span>, remoteApi =&gt; { <span class="hljs-comment"><span class="hljs-comment">//      callback  promise resolve(transformMethods(cbToPromise, remoteApi)) }) });</span></span></code> </pre> <br><p> å‡½æ•°è°ƒç”¨è¿”å›ä¸€ä¸ªpromiseï¼š </p><br><p><img src="https://habrastorage.org/webt/g7/qq/og/g7qqogo60hrjqm5pre7f5miehs0.png"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>æä¾›å…·æœ‰å¼‚æ­¥åŠŸèƒ½çš„ç‰ˆæœ¬ã€‚ </p><br><p> é€šå¸¸ï¼Œä½¿ç”¨RPCå’Œæµçš„æ–¹æ³•ä¼¼ä¹éå¸¸çµæ´»ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è’¸æ±½å¤šè·¯å¤ç”¨å¹¶ä¸ºä¸åŒçš„ä»»åŠ¡åˆ›å»ºå‡ ä¸ªä¸åŒçš„APIã€‚ åŸåˆ™ä¸Šï¼Œdnodeå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œä¸»è¦æ˜¯å°†ä¼ è¾“åŒ…è£…ä¸ºnodejsæµçš„å½¢å¼ã€‚ </p><br><p>  JSONæ ¼å¼æ˜¯ä¸€ç§æ›¿ä»£æ–¹æ³•ï¼Œå®ƒå®ç°äº†JSON RPC 2åè®®ï¼Œä½†æ˜¯å®ƒå¯ç”¨äºç‰¹å®šçš„ä¼ è¾“æ–¹å¼ï¼ˆTCPå’ŒHTTPï¼ˆSï¼‰ï¼‰ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ä¸é€‚ç”¨ã€‚ </p><br><h3 id="vnutrenniy-steyt-i-localstorage"> å†…éƒ¨çŠ¶æ€å’Œæœ¬åœ°å­˜å‚¨ </h3><br><p> æˆ‘ä»¬å°†éœ€è¦å­˜å‚¨åº”ç”¨ç¨‹åºçš„å†…éƒ¨çŠ¶æ€-è‡³å°‘è¦å­˜å‚¨ç”¨äºç­¾åçš„å¯†é’¥ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨å¼¹å‡ºå¼APIä¸­è½»æ¾åœ°å°†çŠ¶æ€æ·»åŠ åˆ°åº”ç”¨ç¨‹åºå’Œæ›´æ”¹çŠ¶æ€çš„æ–¹æ³•ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setupDnode} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store = { <span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [], }; } addKey(key){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store.keys.push(key) } removeKey(index){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store.keys.splice(index,<span class="hljs-number"><span class="hljs-number">1</span></span>) } popupApi(){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">addKey</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (key) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addKey(key), <span class="hljs-attr"><span class="hljs-attr">removeKey</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (index) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.removeKey(index) } } ... }</code> </pre> <br><p> åœ¨åå°ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œç„¶åå°†åº”ç”¨ç¨‹åºå¯¹è±¡å†™å…¥windowï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä»æ§åˆ¶å°ä½¿ç”¨å®ƒï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {SignerApp} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./SignerApp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span>; setupApp(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupApp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignerApp(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DEV_MODE) { global.app = app; } extensionApi.runtime.onConnect.addListener(connectRemote); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectRemote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">remotePort</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> processName = remotePort.name; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> portStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PortStream(remotePort); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (processName === <span class="hljs-string"><span class="hljs-string">'contentscript'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> origin = remotePort.sender.url; app.connectPage(portStream, origin) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { app.connectPopup(portStream) } } }</code> </pre> <br><p> ä»UIæ§åˆ¶å°æ·»åŠ ä¸€äº›é”®ï¼Œç„¶åæŸ¥çœ‹çŠ¶æ€å‘ç”Ÿäº†ä»€ä¹ˆï¼š </p><br><p><img src="https://habrastorage.org/webt/n7/xr/eb/n7xrebxybxbquxx8z8uozgwpfqm.png"></p><br><p> è¯¥çŠ¶æ€å¿…é¡»æ˜¯æŒä¹…çš„ï¼Œä»¥ä¾¿åœ¨é‡æ–°å¯åŠ¨æ—¶ä¸ä¼šä¸¢å¤±å¯†é’¥ã€‚ </p><br><p> æˆ‘ä»¬ä¼šå°†å…¶å­˜å‚¨åœ¨localStorageä¸­ï¼Œå¹¶éšæ¯æ¬¡æ›´æ”¹è¦†ç›–ã€‚ éšåï¼Œç”¨æˆ·ç•Œé¢ä¹Ÿå°†éœ€è¦è®¿é—®å®ƒï¼Œæˆ‘ä¹Ÿæƒ³è®¢é˜…æ‰€åšçš„æ›´æ”¹ã€‚ åŸºäºæ­¤ï¼Œè¿›è¡Œå¯è§‚å¯Ÿçš„å­˜å‚¨å¹¶è®¢é˜…å…¶æ›´æ”¹å°†å¾ˆæ–¹ä¾¿ã€‚ </p><br><p> æˆ‘ä»¬å°†ä½¿ç”¨mobxåº“ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/mobxjs/mobx</a> ï¼‰ã€‚ å› ä¸ºæˆ‘ä¸å¿…å’Œå¥¹ä¸€èµ·å·¥ä½œï¼Œæ‰€ä»¥é€‰æ‹©æƒå°±è½åœ¨äº†å¥¹èº«ä¸Šï¼Œä½†æ˜¯æˆ‘çœŸçš„å¾ˆæƒ³ç ”ç©¶å¥¹ã€‚ </p><br><p> æ·»åŠ åˆå§‹çŠ¶æ€çš„åˆå§‹åŒ–å¹¶ä½¿å­˜å‚¨å¯è§‚å¯Ÿï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {observable, action} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setupDnode} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(initState = {}) { <span class="hljs-comment"><span class="hljs-comment">//  store      ,       proxy,      this.store = observable.object({ keys: initState.keys || [], }); } // ,   observable    @action addKey(key) { this.store.keys.push(key) } @action removeKey(index) { this.store.keys.splice(index, 1) } ... }</span></span></code> </pre> <br><p>  mobxç”¨â€œä»£ç†â€ä»£æ›¿äº†æ‰€æœ‰å•†åº—å­—æ®µï¼Œå¹¶æ‹¦æˆªäº†å¯¹å®ƒä»¬çš„æ‰€æœ‰è°ƒç”¨ã€‚ æ‚¨å¯ä»¥è®¢é˜…è¿™äº›ä¸Šè¯‰ã€‚ </p><br><p> æ­¤å¤–ï¼Œå°½ç®¡è¿™å¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œä½†æˆ‘ç»å¸¸ä¼šä½¿ç”¨â€œæ ¹æ®å˜åŒ–â€ä¸€è¯ã€‚  Mobxè·Ÿè¸ªå¯¹å­—æ®µçš„è®¿é—®ã€‚ ä½¿ç”¨åº“åˆ›å»ºçš„ä»£ç†å¯¹è±¡çš„getterå’Œsetterã€‚ </p><br><p> åŠ¨ä½œè£…é¥°å™¨æœ‰ä¸¤ä¸ªä½œç”¨ï¼š </p><br><ol><li> åœ¨å¸¦æœ‰æ ‡å¿—forceforceActionsçš„ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œmobxç¦æ­¢ç›´æ¥æ›´æ”¹çŠ¶æ€ã€‚ åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹å·¥ä½œè¢«è®¤ä¸ºæ˜¯ä¸€ç§å¥½ä¹ æƒ¯ã€‚ </li><li> å³ä½¿å‡½æ•°å¤šæ¬¡æ›´æ”¹çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†å¤šä¸ªå­—æ®µæ›´æ”¹ä¸ºå‡ è¡Œä»£ç ï¼‰ï¼Œä¹Ÿåªæœ‰åœ¨å®Œæˆæ—¶æ‰é€šçŸ¥è§‚å¯Ÿè€…ã€‚ è¿™å¯¹äºå‰ç«¯å°¤å…¶é‡è¦ï¼Œå› ä¸ºä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°ä¼šå¯¼è‡´ä¸å¿…è¦çš„å…ƒç´ å‘ˆç°ã€‚ å°±æˆ‘ä»¬è€Œè¨€ï¼Œç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªéƒ½æ²¡æœ‰ç‰¹åˆ«çš„å…³ç³»ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å°†éµå¾ªæœ€ä½³å®è·µã€‚ è£…é¥°è€…å†³å®šä¿ç•™æ‰€æœ‰å¯æ›´æ”¹è§‚å¯Ÿå­—æ®µçŠ¶æ€çš„åŠŸèƒ½ã€‚ </li></ol><br><p> åœ¨åå°ï¼Œæ·»åŠ åˆå§‹åŒ–å¹¶å°†çŠ¶æ€ä¿å­˜åœ¨localStorageä¸­ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {reaction, toJS} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {SignerApp} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./SignerApp"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  . /  / localStorage  JSON    'store' import {loadState, saveState} from "./utils/localStorage"; const DEV_MODE = process.env.NODE_ENV !== 'production'; setupApp(); function setupApp() { const initState = loadState(); const app = new SignerApp(initState); if (DEV_MODE) { global.app = app; } // Setup state persistence //  reaction  ,     .    ,    const localStorageReaction = reaction( () =&gt; toJS(app.store), // -  saveState // ,      ,    ); extensionApi.runtime.onConnect.addListener(connectRemote); function connectRemote(remotePort) { const processName = remotePort.name; const portStream = new PortStream(remotePort); if (processName === 'contentscript') { const origin = remotePort.sender.url app.connectPage(portStream, origin) } else { app.connectPopup(portStream) } } }</span></span></code> </pre> <br><p> è¿™é‡Œçš„ååº”åŠŸèƒ½å¾ˆæœ‰è¶£ã€‚ å¥¹æœ‰ä¸¤ä¸ªè®ºç‚¹ï¼š </p><br><ol><li> æ•°æ®é€‰æ‹©å™¨ã€‚ </li><li> æ¯æ¬¡æ›´æ”¹æ—¶éƒ½ä¼šç”¨æ­¤æ•°æ®è°ƒç”¨çš„å¤„ç†ç¨‹åºã€‚ </li></ol><br><p> ä¸reduxä¸åŒï¼Œåœ¨reduxä¸­ï¼Œæˆ‘ä»¬æ˜ç¡®åœ°å°†çŠ¶æ€ä½œä¸ºå‚æ•°ï¼Œmobxä¼šè®°ä½é€‰æ‹©å™¨å†…éƒ¨æ‰€å¼•ç”¨çš„å¯è§‚å¯Ÿå¯¹è±¡ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ›´æ”¹å®ƒä»¬æ—¶æ‰è°ƒç”¨å¤„ç†ç¨‹åºã€‚ </p><br><p> å‡†ç¡®äº†è§£mobxå¦‚ä½•ç¡®å®šæˆ‘ä»¬è¦è®¢é˜…çš„å¯è§‚å¯Ÿæ€§éå¸¸é‡è¦ã€‚ å¦‚æœæˆ‘åœ¨ç±»ä¼¼<code>() =&gt; app.store</code>çš„ä»£ç ä¸­ç¼–å†™äº†ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé‚£ä¹ˆè¯¥ååº”å°†æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºå­˜å‚¨åº“æœ¬èº«æ˜¯ä¸å¯è§‚å¯Ÿçš„ï¼Œåªæœ‰å®ƒçš„å­—æ®µæ˜¯è¿™æ ·ã€‚ </p><br><p> å¦‚æœæˆ‘è¿™æ ·å†™<code>() =&gt; app.store.keys</code> ï¼Œé‚£ä¹ˆä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºæ·»åŠ /åˆ é™¤æ•°ç»„çš„å…ƒç´ æ—¶ï¼ŒæŒ‡å‘å®ƒçš„é“¾æ¥ä¸ä¼šæ”¹å˜ã€‚ </p><br><p>  Mobxé¦–æ¬¡æ‰§è¡Œé€‰æ‹©å™¨çš„åŠŸèƒ½ï¼Œå¹¶ä¸”ä»…ç›‘è§†æˆ‘ä»¬æœ‰æƒè®¿é—®çš„å¯è§‚å¯Ÿè€…ã€‚ è¿™æ˜¯é€šè¿‡ä»£ç†è·å–å™¨å®Œæˆçš„ã€‚      <code>toJS</code> .    ,        .         â€“ ,  . </p><br><p>   popup    .         localStorage: </p><br><p><img src="https://habrastorage.org/webt/fr/dh/6t/frdh6tc_bt_v3zywmgjrnptngcw.png"></p><br><p>   background-    . </p><br><p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h2 id="bezopasnoe-hranenie-privatnyh-klyuchey">     </h2><br><p>       :    ,   ,        .   localStorage        . </p><br><p>       locked,        .        locked  . </p><br><p> Mobx      ,       .  â€”   computed properties.     view   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {observable, action} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setupDnode} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     .  crypto-js import {encrypt, decrypt} from "./utils/cryptoUtils"; export class SignerApp { constructor(initState = {}) { this.store = observable.object({ //     .   null -  locked password: null, vault: initState.vault, //    .     view  . get locked(){ return this.password == null }, get keys(){ return this.locked ? undefined : SignerApp._decryptVault(this.vault, this.password) }, get initialized(){ return this.vault !== undefined } }) } //      @action initVault(password){ this.store.vault = SignerApp._encryptVault([], password) } @action lock() { this.store.password = null } @action unlock(password) { this._checkPassword(password); this.store.password = password } @action addKey(key) { this._checkLocked(); this.store.vault = SignerApp._encryptVault(this.store.keys.concat(key), this.store.password) } @action removeKey(index) { this._checkLocked(); this.store.vault = SignerApp._encryptVault([ ...this.store.keys.slice(0, index), ...this.store.keys.slice(index + 1) ], this.store.password ) } ... //    api // private _checkPassword(password) { SignerApp._decryptVault(this.store.vault, password); } _checkLocked() { if (this.store.locked){ throw new Error('App is locked') } } //   /  static _encryptVault(obj, pass){ const jsonString = JSON.stringify(obj) return encrypt(jsonString, pass) } static _decryptVault(str, pass){ if (str === undefined){ throw new Error('Vault not initialized') } try { const jsonString = decrypt(str, pass) return JSON.parse(jsonString) }catch (e) { throw new Error('Wrong password') } } }</span></span></code> </pre> <br><p>        .   .    locked        .   API     . </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   rypto-js</a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CryptoJS <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'crypto-js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//      .        5000  function strengthenPassword(pass, rounds = 5000) { while (rounds-- &gt; 0){ pass = CryptoJS.SHA256(pass).toString() } return pass } export function encrypt(str, pass){ const strongPass = strengthenPassword(pass); return CryptoJS.AES.encrypt(str, strongPass).toString() } export function decrypt(str, pass){ const strongPass = strengthenPassword(pass) const decrypted = CryptoJS.AES.decrypt(str, strongPass); return decrypted.toString(CryptoJS.enc.Utf8) }</span></span></code> </pre> <br><p>    idle API,       â€”  . , ,   <code>idle</code> , <code>active</code>  <code>locked</code> .  idle   ,  locked ,    .        localStorage: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {reaction, toJS} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {SignerApp} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./SignerApp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {loadState, saveState} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/localStorage"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IDLE_INTERVAL = <span class="hljs-number"><span class="hljs-number">30</span></span>; setupApp(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupApp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initState = loadState(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignerApp(initState); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DEV_MODE) { global.app = app; } <span class="hljs-comment"><span class="hljs-comment">//     ,    , reaction   reaction( () =&gt; ({ vault: app.store.vault }), saveState ); //  ,    extensionApi.idle.setDetectionInterval(IDLE_INTERVAL); //             extensionApi.idle.onStateChanged.addListener(state =&gt; { if (['locked', 'idle'].indexOf(state) &gt; -1) { app.lock() } }); // Connect to other contexts extensionApi.runtime.onConnect.addListener(connectRemote); function connectRemote(remotePort) { const processName = remotePort.name; const portStream = new PortStream(remotePort); if (processName === 'contentscript') { const origin = remotePort.sender.url app.connectPage(portStream, origin) } else { app.connectPopup(portStream) } } }</span></span></code> </pre> <br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h3 id="tranzakcii"> äº¤æ˜“æ¬¡æ•° </h3><br><p> ,     :      .     WAVES   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">waves-transactions</a> . </p><br><p>       ,   ,  â€”    ,    : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {action, observable, reaction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'uuid/v4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {signTx} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-transactions'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setupDnode} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {decrypt, encrypt} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/cryptoUtils"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ ... @action newMessage(data, origin) { <span class="hljs-comment"><span class="hljs-comment">//       id, ,    . const message = observable.object({ id: uuid(), // ,  uuid origin, // Origin      data, // status: 'new', //   : new, signed, rejected  failed timestamp: Date.now() }); console.log(`new message: ${JSON.stringify(message, null, 2)}`); this.store.messages.push(message); //     mobx   .        return new Promise((resolve, reject) =&gt; { reaction( () =&gt; message.status, //    (status, reaction) =&gt; { //       reaction,        switch (status) { case 'signed': resolve(message.data); break; case 'rejected': reject(new Error('User rejected message')); break; case 'failed': reject(new Error(message.err.message)); break; default: return } reaction.dispose() } ) }) } @action approve(id, keyIndex = 0) { const message = this.store.messages.find(msg =&gt; msg.id === id); if (message == null) throw new Error(`No msg with id:${id}`); try { message.data = signTx(message.data, this.store.keys[keyIndex]); message.status = 'signed' } catch (e) { message.err = { stack: e.stack, message: e.message }; message.status = 'failed' throw e } } @action reject(id) { const message = this.store.messages.find(msg =&gt; msg.id === id); if (message == null) throw new Error(`No msg with id:${id}`); message.status = 'rejected' } ... }</span></span></code> </pre> <br><p>         ,  <code>observable</code>    <code>store.messages</code> . </p><br><p>    <code>observable</code> ,  mobx        messages.     ,       ,      . </p><br><p>    ,      .    reaction,    ""   . </p><br><p>   <code>approve</code>  <code>reject</code>  :     ,   ,  . </p><br><p> Approve  reject    API UI, newMessage â€”  API : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ ... popupApi() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">addKey</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (key) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addKey(key), <span class="hljs-attr"><span class="hljs-attr">removeKey</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (index) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.removeKey(index), <span class="hljs-attr"><span class="hljs-attr">lock</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lock(), <span class="hljs-attr"><span class="hljs-attr">unlock</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (password) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unlock(password), <span class="hljs-attr"><span class="hljs-attr">initVault</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (password) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.initVault(password), <span class="hljs-attr"><span class="hljs-attr">approve</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (id, keyIndex) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.approve(id, keyIndex), <span class="hljs-attr"><span class="hljs-attr">reject</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (id) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.reject(id) } } pageApi(origin) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">signTransaction</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (txParams) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.newMessage(txParams, origin) } } ... }</code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/webt/jt/bp/nu/jtbpnu9tbhryijukstktnti3wbu.png"></p><br><p>    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  UI</a> . </p><br><h2 id="ui"> UI </h2><br><p>      .   UI   <code>observable</code>     API ,     .  <code>observable</code>   API,   background: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {observable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {extensionApi} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/extensionApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PortStream} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/PortStream"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {cbToPromise, setupDnode, transformMethods} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {initApp} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./ui/index"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span>; setupUi().catch(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupUi</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,     const backgroundPort = extensionApi.runtime.connect({name: 'popup'}); const connectionStream = new PortStream(backgroundPort); //   observable   background'a let backgroundState = observable.object({}); const api = { //  ,    observable updateState: async state =&gt; { Object.assign(backgroundState, state) } }; //  RPC  const dnode = setupDnode(connectionStream, api); const background = await new Promise(resolve =&gt; { dnode.once('remote', remoteApi =&gt; { resolve(transformMethods(cbToPromise, remoteApi)) }) }); //   background observable   background.state = backgroundState; if (DEV_MODE) { global.background = background; } //   await initApp(background) }</span></span></code> </pre><br><p>       .  react-. Background-     props. , ,       store  ,       : </p><br><pre> <code class="plaintext hljs">import {render} from 'react-dom' import App from './App' import React from "react"; //    background     props export async function initApp(background){ render( &lt;App background={background}/&gt;, document.getElementById('app-content') ); }</code> </pre><br><p>   mobx       .     observer   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">mobx-react</a>  ,         observable,    .    mapStateToProps  connect,   redux.    " ": </p><br><pre> <code class="plaintext hljs">import React, {Component, Fragment} from 'react' import {observer} from "mobx-react"; import Init from './components/Initialize' import Keys from './components/Keys' import Sign from './components/Sign' import Unlock from './components/Unlock' @observer //          render,    observable     export default class App extends Component { //              , //   observable   background    ,    render() { const {keys, messages, initialized, locked} = this.props.background.state; const {lock, unlock, addKey, removeKey, initVault, deleteVault, approve, reject} = this.props.background; return &lt;Fragment&gt; {!initialized ? &lt;Init onInit={initVault}/&gt; : locked ? &lt;Unlock onUnlock={unlock}/&gt; : messages.length &gt; 0 ? &lt;Sign keys={keys} message={messages[messages.length - 1]} onApprove={approve} onReject={reject}/&gt; : &lt;Keys keys={keys} onAdd={addKey} onRemove={removeKey}/&gt; } &lt;div&gt; {!locked &amp;&amp; &lt;button onClick={() =&gt; lock()}&gt;Lock App&lt;/button&gt;} {initialized &amp;&amp; &lt;button onClick={() =&gt; deleteVault()}&gt;Delete all keys and init&lt;/button&gt;} &lt;/div&gt; &lt;/Fragment&gt; } }</code> </pre> <br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  UI</a> . </p><br><p>          UI      UI.     <code>getState</code>  <code>reaction</code> ,  <code>remote.updateState</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {action, observable, reaction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'uuid/v4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {signTx} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-transactions'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {setupDnode} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/setupDnode"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {decrypt, encrypt} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./utils/cryptoUtils"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignerApp</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">// public getState() { return { keys: this.store.keys, messages: this.store.newMessages, initialized: this.store.initialized, locked: this.store.locked } } ... // connectPopup(connectionStream) { const api = this.popupApi(); const dnode = setupDnode(connectionStream, api); dnode.once('remote', (remote) =&gt; { //  reaction   ,          ui  const updateStateReaction = reaction( () =&gt; this.getState(), (state) =&gt; remote.updateState(state), //     . fireImmediatly   reaction    . //  ,    . Delay   debounce {fireImmediately: true, delay: 500} ); //      dnode.once('end', () =&gt; updateStateReaction.dispose()) }) } ... }</span></span></code> </pre> <br><p>    <code>remote</code>  <code>reaction</code>   ,      UI. </p><br><p>   â€”       : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupApp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">// Reaction    . reaction( () =&gt; app.store.newMessages.length &gt; 0 ? app.store.newMessages.length.toString() : '', text =&gt; extensionApi.browserAction.setBadgeText({text}), {fireImmediately: true} ); ... }</span></span></code> </pre> <br><p> ,  . -    : </p><br><p><img src="https://habrastorage.org/webt/yo/cz/9b/yocz9bncoevwxrict_3dl_vphek.png"></p><br><p><img src="https://habrastorage.org/webt/ee/8e/uj/ee8eujkmg5iwgfholkyxneqsim4.png"></p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><p>  <strong>ç»“è®º</strong> </p><br><p>      ,     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  </a> .         . </p><br><p>        ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><p> <strong>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">siemarell</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451796/">https://habr.com/ru/post/zh-CN451796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451784/index.html">ç”¨äºä¼ä¸šå­˜å‚¨çš„æ··åˆé©±åŠ¨å™¨ã€‚ ä½“éªŒä½¿ç”¨Seagate EXOS</a></li>
<li><a href="../zh-CN451786/index.html">åœ¨Firebaseæµ‹è¯•å®éªŒå®¤ä¸­è¿è¡Œä»ªå™¨æµ‹è¯•ã€‚ ç¬¬1éƒ¨åˆ†ï¼šiOSé¡¹ç›®</a></li>
<li><a href="../zh-CN451790/index.html">æ¸¸æˆä¸­æ•°æ®æ”¶é›†çš„å±é™©</a></li>
<li><a href="../zh-CN451792/index.html">å››ä¸ªJavaScriptå—…æ¢å™¨ä¼šåœ¨åœ¨çº¿å•†åº—ä¸­è¯±éª—æ‚¨</a></li>
<li><a href="../zh-CN451794/index.html">çº¹ç†ç¼©è¿›åƒç´ </a></li>
<li><a href="../zh-CN451798/index.html">ä½¿ç”¨mongoDBå’ŒSpring Bootè¿›è¡Œæ•°æ®è¿ç§»</a></li>
<li><a href="../zh-CN451800/index.html">åˆ¶ä½œä¸€ä¸ªç®€å•çš„å£°çº³è°ƒåˆ¶è§£è°ƒå™¨</a></li>
<li><a href="../zh-CN451802/index.html">Raiffeisenbank.Netç¤¾åŒºé‚€è¯·å‚åŠ UPD mitapå¹¿æ’­</a></li>
<li><a href="../zh-CN451806/index.html">iOSæ‘˜è¦5ï¼ˆ4æœˆ27æ—¥-5æœˆ16æ—¥ï¼‰</a></li>
<li><a href="../zh-CN451812/index.html">ç°åœ¨ï¼Œå¥½çš„å¼€å‘è€…æ˜¯ç”±è§†å›¾å’Œè®¢é˜…è€…æ¥è¡¡é‡çš„-è¿™å¾ˆç³Ÿç³•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>