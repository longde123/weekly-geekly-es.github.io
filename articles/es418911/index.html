<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÄ üëåüèΩ üí£ [DotNetBook] Span: Nuevo tipo de datos .NET üå∏ üîÆ üêû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Con este art√≠culo, contin√∫o publicando una serie de art√≠culos, cuyo resultado ser√° un libro sobre el trabajo de .NET CLR y .NET en general (aproximada...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[DotNetBook] Span: Nuevo tipo de datos .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/clrium/blog/418911/"><p><img width="350" src="https://habrastorage.org/webt/vh/7j/tq/vh7jtqhzbne4h3rjhprca2pruhu.png" align="left">  Con este art√≠culo, contin√∫o publicando una serie de art√≠culos, cuyo resultado ser√° un libro sobre el trabajo de .NET CLR y .NET en general (aproximadamente 200 p√°ginas del libro ya est√°n listas, as√≠ que bienvenidos al final del art√≠culo para enlaces). </p><br><p>  Tanto el lenguaje como la plataforma han existido durante muchos a√±os: y todo este tiempo ha habido muchas herramientas para trabajar con c√≥digo no administrado.  Entonces, ¬øpor qu√© ahora sale la pr√≥xima API para trabajar con c√≥digo no administrado si de hecho ha existido durante muchos, muchos a√±os?  Para responder a esta pregunta, es suficiente entender lo que faltaba antes. </p><br><p> Los desarrolladores de la plataforma han tratado de ayudarnos a alegrar la vida cotidiana del desarrollo utilizando recursos no administrados: estos son envoltorios autom√°ticos para m√©todos importados.  Y la clasificaci√≥n, que en la mayor√≠a de los casos funciona autom√°ticamente.  Esta tambi√©n es una instrucci√≥n <code>stackallloc</code> , que se trata en el cap√≠tulo sobre la pila de subprocesos.  Sin embargo, en cuanto a m√≠, si los primeros desarrolladores que usan C # vinieron del mundo de C ++ (como lo hice yo), ahora provienen de lenguajes de nivel superior (por ejemplo, conozco un desarrollador que vino de JavaScript).  ¬øQu√© significa esto?  Esto significa que las personas sospechan cada vez m√°s de los recursos no administrados y las construcciones que son similares en esp√≠ritu a C / C ++ y a√∫n m√°s a Assembler. </p><br><blockquote><h3>  Nota </h3><br>  El cap√≠tulo publicado en Habr√© no est√° actualizado y, probablemente, est√° un poco desactualizado.  Y, por lo tanto, consulte el original para obtener un texto m√°s reciente: <br><br><ul><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  Libro CLR: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub, tabla de contenido</a> </li><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  Libro CLR: <a href="">GitHub, cap√≠tulo</a> </li><li><img src="https://habrastorage.org/webt/eo/6g/eo/eo6geog0tg5ernqmv2lcmufefta.png">  Libros de la versi√≥n 0.5.2, PDF: <a href="">versi√≥n de GitHub</a> </li></ul><br></blockquote><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/97f/1d3/cf0/97f1d3cf0e2a6bf007066eb60a789c31.png"></a> </p><a name="habracut"></a><br><p>  Como resultado de tal actitud, cada vez hay menos contenido de c√≥digo inseguro en los proyectos y cada vez m√°s confianza en la API de la plataforma misma.  Esto se verifica f√°cilmente observando el uso de la construcci√≥n <code>stackalloc</code> en los repositorios abiertos: es insignificante.  Pero si toma alg√∫n c√≥digo que lo use: </p><br><p>  <strong>Interoperabilidad de clase.</strong> <br>  <a href="">/src/mscorlib/shared/Interop/Unix/System.Native/Interop.ReadDir.cs</a> </p><br><pre> <code class="plaintext hljs">unsafe { // s_readBufferSize is zero when the native implementation does not support reading into a buffer. byte* buffer = stackalloc byte[s_readBufferSize]; InternalDirectoryEntry temp; int ret = ReadDirR(dir.DangerousGetHandle(), buffer, s_readBufferSize, out temp); // We copy data into DirectoryEntry to ensure there are no dangling references. outputEntry = ret == 0 ? new DirectoryEntry() { InodeName = GetDirectoryEntryName(temp), InodeType = temp.InodeType } : default(DirectoryEntry); return ret; }</code> </pre> <br><p>  Queda claro el motivo de la impopularidad.  Mire sin leer el c√≥digo y responda una pregunta: ¬øconf√≠a en √©l?  Puedo suponer que la respuesta es no.  Luego responde al otro: ¬øpor qu√©?  La respuesta ser√° obvia: adem√°s de ver la palabra <code>Dangerous</code> , que de alguna manera insin√∫a que algo podr√≠a salir mal, el segundo factor que afecta nuestra actitud es el <code>byte* buffer = stackalloc byte[s_readBufferSize];</code> l√≠nea <code>byte* buffer = stackalloc byte[s_readBufferSize];</code>  , y m√°s espec√≠ficamente, <code>byte*</code> .  Este registro es un disparador para cualquiera, de modo que el pensamiento aparece en mi cabeza: "¬øqu√©, no se podr√≠a hacer de manera diferente o qu√©?".  Entonces echemos un vistazo m√°s al psicoan√°lisis: ¬øpor qu√© podr√≠a surgir tal pensamiento?  Por un lado, usamos construcciones de lenguaje y la sintaxis propuesta aqu√≠ est√° lejos de, por ejemplo, C ++ / CLI, lo que le permite hacer cualquier cosa (incluidas las inserciones en Assembler puro), y por otro, parece inusual. </p><br><p>  Entonces, ¬øcu√°l es la pregunta?  ¬øC√≥mo devolver a los desarrolladores al seno del c√≥digo no administrado?  Es necesario darles una sensaci√≥n de calma de que no pueden cometer un error por accidente, por ignorancia.  Entonces, ¬øpor qu√© se introducen los <code> Span&lt;T&gt;</code> y <code>Memory&lt;T&gt;</code> ? </p><br><h2 id="spant-readonlyspant">  Span [T], ReadOnlySpan [T] </h2><br><p>  El tipo <code>Span</code> representa una parte de una determinada matriz de datos, un subrango de sus valores.  Al mismo tiempo, permite, como en el caso de una matriz, trabajar con elementos de este rango tanto para escribir como para leer.  Sin embargo, para el overclocking y la comprensi√≥n general, comparemos los tipos de datos para los que se realiza una implementaci√≥n del tipo <code>Span</code> y veamos los posibles prop√≥sitos de su introducci√≥n. </p><br><p>  El primer tipo de datos del que desea hablar es una matriz regular.  Para las matrices, trabajar con Span se ver√° as√≠: </p><br><pre> <code class="plaintext hljs"> var array = new [] {1,2,3,4,5,6}; var span = new Span&lt;int&gt;(array, 1, 3); var position = span.BinarySearch(3); Console.WriteLine(span[position]); // -&gt; 3</code> </pre> <br><p>  Como vemos en este ejemplo, para empezar creamos una determinada matriz de datos.  Despu√©s de eso, creamos un <code>Span</code> (o un subconjunto) que, refiri√©ndose a la matriz en s√≠, permite que su c√≥digo use solo el rango de valores que se especific√≥ durante la inicializaci√≥n. </p><br><p>  Aqu√≠ vemos la primera propiedad de este tipo de datos: crea algo de contexto.  Desarrollemos nuestra idea con contextos: </p><br><pre> <code class="plaintext hljs">void Main() { var array = new [] {'1','2','3','4','5','6'}; var span = new Span&lt;char&gt;(array, 1, 3); if(TryParseInt32(span, out var res)) { Console.WriteLine(res); } else { Console.WriteLine("Failed to parse"); } } public bool TryParseInt32(Span&lt;char&gt; input, out int result) { result = 0; for (int i = 0; i &lt; input.Length; i++) { if(input[i] &lt; '0' || input[i] &gt; '9') return false; result = result * 10 + ((int)input[i] - '0'); } return true; } ----- 234</code> </pre> <br><p>  Como podemos ver, <code>Span&lt;T&gt;</code> introduce una abstracci√≥n de acceso a una determinada pieza de memoria, tanto para leer como para escribir.  ¬øQu√© nos da esto?  Si recordamos qu√© m√°s se puede hacer con base en <code>Span</code> , entonces recordamos tanto los recursos no administrados como las l√≠neas: </p><br><pre> <code class="plaintext hljs">// Managed array var array = new[] { '1', '2', '3', '4', '5', '6' }; var arrSpan = new Span&lt;char&gt;(array, 1, 3); if (TryParseInt32(arrSpan, out var res1)) { Console.WriteLine(res1); } // String var srcString = "123456"; var strSpan = srcString.AsSpan().Slice(1, 3); if (TryParseInt32(strSpan, out var res2)) { Console.WriteLine(res2); } // void * Span&lt;char&gt; buf = stackalloc char[6]; buf[0] = '1'; buf[1] = '2'; buf[2] = '3'; buf[3] = '4'; buf[4] = '5'; buf[5] = '6'; if (TryParseInt32(buf.Slice(1, 3), out var res3)) { Console.WriteLine(res3); } ----- 234 234 234</code> </pre> <br><p>  Es decir, <code>Span&lt;T&gt;</code> es una herramienta de unificaci√≥n para trabajar con memoria: administrada y no administrada, que garantiza la seguridad en el trabajo con este tipo de datos durante la recolecci√≥n de basura: si las √°reas de memoria con matrices administradas comienzan a moverse, entonces Ser√° seguro para nosotros. </p><br><p>  Sin embargo, ¬øvale la pena alegrarse tanto?  ¬øSe podr√≠a haber logrado todo esto antes?  Por ejemplo, si hablamos de matrices administradas, entonces no hay duda alguna: simplemente envuelva la matriz en otra clase, proporcionando una interfaz similar y listo.  Adem√°s, se puede hacer una operaci√≥n similar con cadenas: tienen los m√©todos necesarios.  Nuevamente, simplemente envuelva la cadena exactamente del mismo tipo y proporcione m√©todos para trabajar con ella.  Otra cosa es que para almacenar una cadena, un b√∫fer o una matriz en un tipo, tendr√° que jugar mucho almacenando enlaces a cada una de las opciones posibles en una sola instancia (por supuesto, solo una estar√° activa): </p><br><pre> <code class="plaintext hljs">public readonly ref struct OurSpan&lt;T&gt; { private T[] _array; private string _str; private T * _buffer; // ... }</code> </pre> <br><p>  O, si comienza desde la arquitectura, haga tres tipos que hereden una sola interfaz.  Resulta que para hacer de la herramienta una interfaz unificada entre estos tipos de datos <code>managed</code> , manteniendo el m√°ximo rendimiento, no hay otra forma que <code>Span&lt;T&gt;</code> . </p><br><p>  Adem√°s, para continuar la discusi√≥n, ¬øqu√© es una <code>ref struct</code> en t√©rminos de <code>Span</code> ?  Estas son precisamente las "estructuras, solo est√°n en la pila", de las que tan a menudo escuchamos en las entrevistas.  Y esto significa que este tipo de datos solo puede pasar por la pila y no tiene derecho a ir al mont√≥n.  Y, por lo tanto, <code>Span</code> , al ser una estructura de referencia, es un tipo de datos de contexto que proporciona m√©todos, pero no objetos en la memoria.  De esto, para su comprensi√≥n, debemos proceder. </p><br><p>  Desde aqu√≠ podemos formular una definici√≥n del tipo Span y el tipo readonly ReadOnlySpan asociado con √©l: </p><br><blockquote>  Span es un tipo de datos que proporciona una interfaz √∫nica para trabajar con tipos heterog√©neos de matrices de datos, as√≠ como la capacidad de transferir un subconjunto de esta matriz a otro m√©todo para que, independientemente de la profundidad de contexto, la velocidad de acceso a la matriz original sea constante y lo m√°s alta posible. </blockquote><p>  Y realmente: si tenemos algo como este c√≥digo: </p><br><pre> <code class="plaintext hljs">public void Method1(Span&lt;byte&gt; buffer) { buffer[0] = 0; Method2(buffer.Slice(1,2)); } Method2(Span&lt;byte&gt; buffer) { buffer[0] = 0; Method3(buffer.Slice(1,1)); } Method3(Span&lt;byte&gt; buffer) { buffer[0] = 0; }</code> </pre> <br><p>  entonces la velocidad de acceso al b√∫fer de origen ser√° lo m√°s alta posible: no est√° trabajando con un objeto administrado, sino con un puntero administrado.  Es decir  no con un tipo administrado .NET, sino con un tipo inseguro envuelto en un shell administrado. </p><br><h3 id="spant-na-primerah">  Span [T] por ejemplos </h3><br><p>  Una persona est√° tan dispuesta que, a menudo, hasta que recibe una cierta experiencia, a menudo no llega una comprensi√≥n final de por qu√© se necesita una herramienta.  Y por lo tanto, dado que necesitamos algo de experiencia, pasemos a los ejemplos. </p><br><h4 id="valuestringbuilder">  ValueStringBuilder </h4><br><p>  Uno de los ejemplos m√°s algor√≠tmicamente interesantes es el tipo <code>ValueStringBuilder</code> , que est√° enterrado en alg√∫n lugar de las entra√±as de <code>mscorlib</code> y, por alguna raz√≥n, como muchos otros tipos de datos interesantes, est√° marcado con el modificador <code>internal</code> , lo que significa que si no fuera por el estudio del c√≥digo fuente de mscorlib, hablaremos de un m√©todo de optimizaci√≥n tan maravilloso Nunca lo sabr√≠a. </p><br><p>  ¬øCu√°l es el principal inconveniente del tipo de sistema StringBuilder?  Esto, por supuesto, es su esencia: tanto √©l mismo como en qu√© se basa (y esto es una serie de caracteres <code>char[]</code> ) son tipos de referencia.  Y eso significa al menos dos cosas: todav√≠a (aunque un poco) cargamos un mont√≥n y el segundo: aumentamos la posibilidad de fallar en los cach√©s del procesador. </p><br><p>  Otra pregunta que tuve para StringBuilder fue la formaci√≥n de peque√±as cadenas.  Es decir  cuando la l√≠nea de resultado "dar diente" ser√° corta: por ejemplo, menos de 100 caracteres.  Cuando tenemos un formato bastante corto, surgen problemas de rendimiento: </p><br><pre> <code class="plaintext hljs"> $"{x} is in range [{min};{max}]"</code> </pre> <br><p>  ¬øCu√°nto peor es este registro que la generaci√≥n manual a trav√©s de StringBuilder?  La respuesta est√° lejos de ser siempre obvia: todo depende del lugar de formaci√≥n: con qu√© frecuencia se llamar√° a este m√©todo.  Despu√©s de todo, primero <code>string.Format</code> asigna memoria para el <code>StringBuilder</code> interno, que crear√° una matriz de caracteres (SourceString.Length + args.Length * 8) y si durante la formaci√≥n de la matriz resulta que no se adivin√≥ la longitud, se crear√° otro <code>StringBuilder</code> para formar la continuaci√≥n, formando as√≠ una lista simplemente conectada.  Y como resultado, ser√° necesario devolver la l√≠nea generada: y esta es otra copia.  Derroche y despilfarro.  Ahora, si nos libr√°ramos de colocar la primera matriz de la cadena que se est√° formando en el mont√≥n, ser√≠a maravilloso: definitivamente nos librar√≠amos de un problema. </p><br><p>  Eche un vistazo al tipo de las entra√±as de <code>mscorlib</code> : </p><br><p>  <strong>Clase ValueStringBuilder</strong> <br>  <a href="">/ src / mscorlib / shared / System / Text / ValueStringBuilder</a> </p><br><pre> <code class="plaintext hljs"> internal ref struct ValueStringBuilder { //           private char[] _arrayToReturnToPool; //     private Span&lt;char&gt; _chars; private int _pos; //    ,       public ValueStringBuilder(Span&lt;char&gt; initialBuffer) { _arrayToReturnToPool = null; _chars = initialBuffer; _pos = 0; } public int Length { get =&gt; _pos; set { int delta = value - _pos; if (delta &gt; 0) { Append('\0', delta); } else { _pos = value; } } } //   -       public override string ToString() { var s = new string(_chars.Slice(0, _pos)); Clear(); return s; } //       //     :   public void Insert(int index, char value, int count) { if (_pos &gt; _chars.Length - count) { Grow(count); } int remaining = _pos - index; _chars.Slice(index, remaining).CopyTo(_chars.Slice(index + count)); _chars.Slice(index, count).Fill(value); _pos += count; } [MethodImpl(MethodImplOptions.AggressiveInlining)] public void Append(char c) { int pos = _pos; if (pos &lt; _chars.Length) { _chars[pos] = c; _pos = pos + 1; } else { GrowAndAppend(c); } } [MethodImpl(MethodImplOptions.NoInlining)] private void GrowAndAppend(char c) { Grow(1); Append(c); } //   ,     //         //            //           [MethodImpl(MethodImplOptions.NoInlining)] private void Grow(int requiredAdditionalCapacity) { Debug.Assert(requiredAdditionalCapacity &gt; _chars.Length - _pos); char[] poolArray = ArrayPool&lt;char&gt;.Shared.Rent(Math.Max(_pos + requiredAdditionalCapacity, _chars.Length * 2)); _chars.CopyTo(poolArray); char[] toReturn = _arrayToReturnToPool; _chars = _arrayToReturnToPool = poolArray; if (toReturn != null) { ArrayPool&lt;char&gt;.Shared.Return(toReturn); } } [MethodImpl(MethodImplOptions.AggressiveInlining)] private void Clear() { char[] toReturn = _arrayToReturnToPool; this = default; // for safety, to avoid using pooled array if this instance is erroneously appended to again if (toReturn != null) { ArrayPool&lt;char&gt;.Shared.Return(toReturn); } } //  :       private void AppendSlow(string s); public bool TryCopyTo(Span&lt;char&gt; destination, out int charsWritten); public void Append(string s); public void Append(char c, int count); public unsafe void Append(char* value, int length); public Span&lt;char&gt; AppendSpan(int length); }</code> </pre> <br><p>  Esta clase es similar en funcionalidad a su hermano mayor <code>StringBuilder</code> , pero tiene una caracter√≠stica interesante y muy importante: es un tipo significativo.  Es decir  almacenado y transmitido completamente por valor.  Y el √∫ltimo modificador de tipo de <code>ref</code> , que se asigna a la firma de la declaraci√≥n de tipo, nos dice que este tipo tiene una restricci√≥n adicional: tiene derecho a estar solo en la pila.  Es decir  La salida de sus instancias a los campos de clase dar√° como resultado un error.  ¬øPor qu√© todas estas sentadillas?  Para responder a esta pregunta, solo mira la clase <code>StringBuilder</code> , cuya esencia acabamos de describir: </p><br><p>  <strong>Class StringBuilder</strong> <a href="">/src/mscorlib/src/System/Text/StringBuilder.cs</a> </p><br><pre> <code class="plaintext hljs">public sealed class StringBuilder : ISerializable { // A StringBuilder is internally represented as a linked list of blocks each of which holds // a chunk of the string. It turns out string as a whole can also be represented as just a chunk, // so that is what we do. internal char[] m_ChunkChars; // The characters in this block internal StringBuilder m_ChunkPrevious; // Link to the block logically before this block internal int m_ChunkLength; // The index in m_ChunkChars that represent the end of the block internal int m_ChunkOffset; // The logical offset (sum of all characters in previous blocks) internal int m_MaxCapacity = 0; // ... internal const int DefaultCapacity = 16;</code> </pre> <br><p>  StringBuilder es una clase dentro de la cual hay un enlace a una matriz de caracteres.  Es decir  cuando lo crea, de hecho, se crean al menos dos objetos: el propio StringBuilder y una matriz de caracteres de al menos 16 caracteres (por cierto, es por eso que es tan importante especificar la longitud estimada de la cadena: su construcci√≥n pasar√° por la generaci√≥n de una lista de matrices de 16 caracteres conectadas individualmente). )  ¬øQu√© significa esto en el contexto de nuestra conversaci√≥n sobre el tipo ValueStringBuilder: la capacidad est√° ausente de forma predeterminada, porque  toma memoria del exterior, adem√°s es un tipo significativo y obliga al usuario a asignar un b√∫fer para los caracteres en la pila.  Como resultado, toda la instancia de tipo se inserta en la pila junto con su contenido, y el problema de optimizaci√≥n aqu√≠ se resuelve.  ¬øNo hay asignaci√≥n de memoria en el mont√≥n?  No hay problema con la ca√≠da del rendimiento en el mont√≥n.  Pero usted me dice: ¬øpor qu√© no usar ValueStringBuilder (o su versi√≥n autoescrita: es interna y no accesible para nosotros) siempre?  La respuesta es: debe mirar el problema que est√° resolviendo.  ¬øLa cadena resultante ser√° de tama√±o conocido?  ¬øTendr√° un cierto m√°ximo conocido de longitud?  Si la respuesta es s√≠ y si el tama√±o de la cadena no supera algunos l√≠mites razonables, puede usar una versi√≥n significativa de StringBuilder.  De lo contrario, si esperamos largas colas, cambiamos a usar la versi√≥n normal. </p><br><h4 id="valuelistbuilder">  ValueListBuilder </h4><br><p>  El segundo tipo de datos que quiero destacar especialmente es el tipo <code>ValueListBuilder</code> .  Fue creado para situaciones en las que es necesario crear una colecci√≥n de elementos por un corto tiempo e inmediatamente darle alg√∫n algoritmo para su procesamiento. </p><br><p>  De acuerdo: la tarea es muy similar a la tarea <code>ValueStringBuilder</code> .  S√≠, y se resolvi√≥ de manera muy similar: </p><br><p>  <strong>Archivo <a href="">ValueListBuilder.cs</a></strong> </p><br><p>  Para decirlo sin rodeos, tales situaciones son bastante comunes.  Sin embargo, antes de resolver esta pregunta de otra manera: creamos una <code>List</code> , la poblamos con datos y perdimos el enlace.  Si se llama al m√©todo con la frecuencia suficiente, surge una situaci√≥n triste: muchas instancias de la clase <code>List</code> cuelgan en el mont√≥n, y con ellas las matrices asociadas con ellas se cuelgan en el mont√≥n.  Ahora este problema se ha resuelto: no se crear√°n objetos adicionales.  Sin embargo, como en el caso de <code>ValueStringBuilder</code> , se resolvi√≥ solo para programadores de Microsoft: la clase tiene un modificador <code>internal</code> . </p><br><h3 id="pravila-i-praktika-ispolzovaniya">  T√©rminos y condiciones de uso </h3><br><p>  Para finalmente comprender la esencia del nuevo tipo de datos, debe "jugar" con √©l escribiendo un par de cosas, o mejor, m√°s m√©todos para usarlo.  Sin embargo, las reglas b√°sicas se pueden aprender ahora: </p><br><ul><li>  Si su m√©todo procesar√° algunos conjuntos de datos entrantes sin cambiar su tama√±o, puede intentar detenerse en el tipo <code>Span</code> .  Si no hay modificaci√≥n de este b√∫fer, entonces en el tipo <code>ReadOnlySpan</code> ; </li><li>  Si su m√©todo funcionar√° con cadenas, calculando algunas estad√≠sticas o analizando una cadena, entonces su m√©todo <em>debe</em> aceptar <code>ReadOnlySpan&lt;char&gt;</code> .  Est√° obligado: esta es una nueva regla.  Despu√©s de todo, si acepta una cadena, obliga a alguien a hacer una subcadena por usted </li><li>  Si necesita hacer una matriz bastante corta con datos (por ejemplo, 10 KB como m√°ximo) como parte del trabajo del m√©todo, puede organizar f√°cilmente dicha matriz usando <code>Span&lt;TType&gt; buf = stackalloc TType[size]</code> .  Sin embargo, por supuesto, TType solo debe ser un tipo significativo, ya que  <code>stackalloc</code> solo funciona con tipos significativos. </li></ul><br><p>  En otros casos, vale la pena echar un vistazo m√°s de cerca a la <code>Memory</code> o al uso de tipos de datos cl√°sicos. </p><br><h3 id="kak-rabotaet-span">  C√≥mo funciona el palmo </h3><br><p>  Adem√°s, me gustar√≠a hablar sobre c√≥mo funciona Span y qu√© es tan notable al respecto.  Y hay algo de qu√© hablar: el tipo de datos en s√≠ se divide en dos versiones: para .NET Core 2.0+ y para todos los dem√°s. </p><br><p>  <strong><a href="">Span.Fast.cs,</a> archivo <a href="">.NET Core 2.0</a></strong> </p><br><pre> <code class="plaintext hljs">public readonly ref partial struct Span&lt;T&gt; { ///    .NET    internal readonly ByReference&lt;T&gt; _pointer; ///      private readonly int _length; // ... }</code> </pre> <br><p>  <strong>Archivo ???</strong>  <strong>[descompilado]</strong> </p><br><pre> <code class="plaintext hljs">public ref readonly struct Span&lt;T&gt; { private readonly System.Pinnable&lt;T&gt; _pinnable; private readonly IntPtr _byteOffset; private readonly int _length; // ... }</code> </pre> <br><p>  La cuesti√≥n es que .NET Framework y .NET Core 1. * no tienen un recolector de basura especialmente modificado (en contraste con la versi√≥n de .NET Core 2.0+) y, por lo tanto, se ven obligados a arrastrar un puntero adicional: al comienzo del b√∫fer con el que trabajo  Es decir, resulta que <code>Span</code> trabaja internamente con objetos administrados de la plataforma .NET como no administrados.  Eche un vistazo al interior de la segunda versi√≥n de la estructura: hay tres campos.  El primer campo es una referencia al objeto gestionado.  El segundo es el desplazamiento desde el comienzo de este objeto en bytes para obtener el comienzo del b√∫fer de datos (en l√≠neas es un b√∫fer con caracteres <code>char</code> , en las matrices es un b√∫fer con datos de la matriz).  Y finalmente, el tercer campo es el n√∫mero de elementos de este b√∫fer apilados uno tras otro. </p><br><p>  Por ejemplo, tome el trabajo <code>Span</code> para cadenas: </p><br><p>  <strong>Archivo <a href="">coreclr :: src / System.Private.CoreLib / shared / System / MemoryExtensions.Fast.cs</a></strong> </p><br><pre> <code class="plaintext hljs">public static ReadOnlySpan&lt;char&gt; AsSpan(this string text) { if (text == null) return default; return new ReadOnlySpan&lt;char&gt;(ref text.GetRawStringData(), text.Length); }</code> </pre> <br><p>  Donde <code>string.GetRawStringData()</code> siguiente: </p><br><p>  <strong>Archivo de definici√≥n de campo <a href="">coreclr :: src / System.Private.CoreLib / src / System / String.CoreCLR.cs</a></strong> </p><br><p>  <strong>Archivo de definici√≥n GetRawStringData <a href="">coreclr :: src / System.Private.CoreLib / shared / System / String.cs</a></strong> </p><br><pre> <code class="plaintext hljs">public sealed partial class String : IComparable, IEnumerable, IConvertible, IEnumerable&lt;char&gt;, IComparable&lt;string&gt;, IEquatable&lt;string&gt;, ICloneable { // // These fields map directly onto the fields in an EE StringObject. See object.h for the layout. // [NonSerialized] private int _stringLength; // For empty strings, this will be '\0' since // strings are both null-terminated and length prefixed [NonSerialized] private char _firstChar; internal ref char GetRawStringData() =&gt; ref _firstChar; }</code> </pre> <br><p>  Es decir  Resulta que el m√©todo va directamente dentro de la l√≠nea, y la especificaci√≥n de <code>ref char</code> permite rastrear el enlace no administrado del GC dentro de la l√≠nea, movi√©ndolo junto con la l√≠nea durante la operaci√≥n del GC. </p><br><p>  La misma historia sucede con las matrices: cuando se crea <code>Span</code> , alg√∫n c√≥digo dentro del JIT calcula el desplazamiento del comienzo de los datos de la matriz e inicializa el <code>Span</code> este desplazamiento.  Y c√≥mo calcular las compensaciones para cadenas y matrices, aprendimos en el cap√≠tulo sobre la estructura de los objetos en la memoria. </p><br><h3 id="spant-kak-vozvraschaemoe-znachenie">  Span [T] como valor de retorno </h3><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pesar de todo el idilio asociado </font></font><code>Span</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, existen restricciones l√≥gicas pero inesperadas en su devoluci√≥n del m√©todo. </font><font style="vertical-align: inherit;">Si nos fijamos en el siguiente c√≥digo:</font></font></p><br><pre> <code class="plaintext hljs">unsafe void Main() { var x = GetSpan(); } public Span&lt;byte&gt; GetSpan() { Span&lt;byte&gt; reff = new byte[100]; return reff; }</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entonces todo parece extremadamente l√≥gico y bueno. </font><font style="vertical-align: inherit;">Sin embargo, vale la pena reemplazar una instrucci√≥n con otra:</font></font></p><br><pre> <code class="plaintext hljs">unsafe void Main() { var x = GetSpan(); } public Span&lt;byte&gt; GetSpan() { Span&lt;byte&gt; reff = stackalloc byte[100]; return reff; }</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥mo el compilador prohibir√° una instrucci√≥n de este tipo. </font><font style="vertical-align: inherit;">Pero antes de escribir por qu√©, le pido que adivine por s√≠ mismo qu√© problemas implicar√° tal dise√±o.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, espero que hayas pensado, construido conjeturas y suposiciones, y tal vez incluso hayas entendido la raz√≥n. </font><font style="vertical-align: inherit;">Si es as√≠, no pint√© el cap√≠tulo sobre la pila de hilos en los dientes en vano. </font><font style="vertical-align: inherit;">Despu√©s de todo, despu√©s de haber dado un enlace a los par√°metros locales de un m√©todo que ha terminado el trabajo, puede llamar a otro m√©todo, esperar a que termine y leer sus variables locales a trav√©s de x [0.99].</font></font></p><br><p> ,  ,        ,     ,  : <code>CS8352 Cannot use local 'reff' in this context because it may expose referenced variables outside of their declaration scope</code>   :     ,   , ,                  . </p><br><h2 id="esli-poyavilis-voprosy">    </h2><br><p>   <code>Span&lt;T&gt;</code>  ,  .         ,    use cases    . </p><br><blockquote><h3>  Enlace a todo el libro </h3><br><ul><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  Libro CLR: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> </li><li><img src="https://habrastorage.org/webt/eo/6g/eo/eo6geog0tg5ernqmv2lcmufefta.png">  Libros de la versi√≥n 0.5.0, PDF: <a href="">versi√≥n de GitHub</a> </li></ul><br></blockquote><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/97f/1d3/cf0/97f1d3cf0e2a6bf007066eb60a789c31.png"></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418911/">https://habr.com/ru/post/es418911/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418901/index.html">Los rusos ganaron la mayor√≠a de las medallas de oro en la Olimpiada Europea de Inform√°tica eJOI 2018</a></li>
<li><a href="../es418903/index.html">Cient√≠ficos: no hay suficiente CO‚ÇÇ en Marte para calentar la atm√≥sfera. La explosi√≥n del poste no ayudar√°</a></li>
<li><a href="../es418905/index.html">InlineKeyboard en Telegram Bots</a></li>
<li><a href="../es418907/index.html">C√≥mo ense√±arle a Zabbix a enviar notificaciones de problemas directamente al escritorio</a></li>
<li><a href="../es418909/index.html">Python Leads: qui√©n y por qu√© lo usa</a></li>
<li><a href="../es418913/index.html">UE4 | Inventario para multijugador # 1 | Data Warehouse en DataAsset</a></li>
<li><a href="../es418915/index.html">Equilibrar el tr√°fico entre servidores web utilizando IP CEF en equipos de red</a></li>
<li><a href="../es418917/index.html">La seguridad comienza con un enrutador dom√©stico</a></li>
<li><a href="../es418919/index.html">Sobre el crecimiento profesional del dise√±ador y el trabajo con estr√©s. Y c√≥mo encontrar fuerza en los momentos m√°s dif√≠ciles.</a></li>
<li><a href="../es418921/index.html">4 bibliotecas que hacen la vida m√°s f√°cil para un desarrollador de React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>