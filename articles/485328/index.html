<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé∞ üôåüèº üë©‚Äçüè´ Especificaciones sobre esteroides üÜî ‚òÑÔ∏è ü¶ó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El tema de las abstracciones y todo tipo de patrones encantadores es un buen terreno para el desarrollo de holivars y disputas eternas: por un lado, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Especificaciones sobre esteroides</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/singularis/blog/485328/">  El tema de las abstracciones y todo tipo de patrones encantadores es un buen terreno para el desarrollo de holivars y disputas eternas: por un lado, seguimos la corriente principal, todo tipo de palabras de moda y c√≥digo limpio, por otro lado, tenemos pr√°ctica y realidad que siempre dictan sus propias reglas. <br><br>  Qu√© hacer si las abstracciones comienzan a ‚Äúfiltrarse‚Äù, c√≥mo usar chips de lenguaje y qu√© puede extraer del patr√≥n de ‚Äúespecificaci√≥n‚Äù - vea debajo del corte. <br><a name="habracut"></a><br>  Entonces, vamos al grano.  El art√≠culo contendr√° las siguientes secciones: para empezar, examinaremos cu√°l es el patr√≥n de "especificaci√≥n" y por qu√© su aplicaci√≥n a muestras de bases de datos puras causa dificultades. <br><br>  A continuaci√≥n, pasamos a los √°rboles de expresi√≥n, que son una herramienta muy poderosa, y vemos c√≥mo nos pueden ayudar. <br><br>  al final, demostrar√© mi implementaci√≥n de la "especificaci√≥n" en esteroides. <br><br>  Comencemos con las cosas b√°sicas.  Creo que todos han escuchado sobre el patr√≥n de "especificaci√≥n", pero para aquellos que no lo han escuchado, aqu√≠ est√° su definici√≥n de <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B5%25D1%2586%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Wikipedia</a> : <br><br><blockquote>  Una "especificaci√≥n" en programaci√≥n es un patr√≥n de dise√±o mediante el cual la representaci√≥n de las reglas de l√≥gica de negocios se puede transformar en una cadena de objetos conectados por operaciones l√≥gicas booleanas. <br><br>  Esta plantilla resalta tales especificaciones (reglas) en la l√≥gica de negocios que son adecuadas para "acoplarse" con otros.  Un objeto de l√≥gica de negocios hereda su funcionalidad de la clase agregada abstracta CompositeSpecification, que contiene solo un m√©todo IsSatisfiedBy que devuelve un valor booleano.  Despu√©s de la instanciaci√≥n, el objeto se encadena junto con otros objetos.  Como resultado, sin perder flexibilidad en la configuraci√≥n de la l√≥gica empresarial, podemos agregar f√°cilmente nuevas reglas. </blockquote><br>  En otras palabras, una especificaci√≥n es un objeto que implementa la siguiente interfaz (descartando m√©todos para construir cadenas): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  Aqu√≠ todo es simple y claro.  Pero ahora veamos un ejemplo del mundo real en el que, adem√°s del dominio, hay una infraestructura que tambi√©n es una persona despiadada: pasemos al caso del uso de ORM, un DBMS y especificaciones para filtrar datos en una base de datos. <br><br>  Para no ser infundado y no se√±alar con el dedo, tomamos como ejemplo el siguiente tema: supongamos que estamos desarrollando MMORPG, tenemos usuarios, cada usuario tiene 1 o m√°s caracteres, y cada personaje tiene un conjunto de elementos ( asumimos que los √≠tems son √∫nicos para cada usuario), y para cada uno de los √≠tems, a su vez, se pueden aplicar runas de mejora.  En total, en forma de diagrama (consideraremos la clase ReadCharacter un poco m√°s tarde cuando hablemos de consultas anidadas): <br><br><img src="https://habrastorage.org/webt/k5/bx/iw/k5bxiwkvgl5vghoog71-9w6vqdo.png" alt="imagen"><br><br>  Este modelo est√° conectado libremente con el mundo real, y tambi√©n contiene campos que reflejan cierta conexi√≥n con el ORM utilizado, pero esto ser√° suficiente para que podamos demostrar el trabajo. <br><br>  Supongamos que queremos filtrar todos los caracteres creados despu√©s de la fecha especificada. <br>  Para hacer esto, escribimos una especificaci√≥n de la siguiente forma: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _target; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { _target = target; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> character = candidate <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Character; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(character == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> character.CreatedAt &gt; target; } }</code> </pre><br>  Bueno, entonces, para aplicar esta especificaci√≥n, hacemos lo siguiente (en adelante considerar√© el c√≥digo basado en NHibernate): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> characters = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> session.Query&lt;Character&gt;().ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newCharacters = characters.Where(x =&gt; filter.IsSatisfiedBy(x)).ToArray();</code> </pre><br>  Mientras nuestra base sea peque√±a, todo funcionar√° de manera hermosa y r√°pida, pero si nuestro juego se vuelve m√°s o menos popular y gana un par de decenas de miles de usuarios, todo este encanto consumir√° memoria, tiempo y dinero, y es mejor disparar a esta bestia de inmediato. porque  No es un inquilino.  En esta triste nota, pospondremos la especificaci√≥n y volveremos un poco a mi pr√°ctica. <br><br>  √ârase una vez, en un proyecto muy, muy distante, ten√≠a clases en mi c√≥digo que conten√≠an l√≥gica para recuperar datos de la base de datos.  Se ve√≠an algo as√≠: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ICharacterDal</span></span> { <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBetween</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, DateTime to</span></span></span><span class="hljs-function">)</span></span>; ... }</code> </pre><br>  y su uso: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CharacterDal(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdCharacters = dal.GetCharactersCreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre><br>  Dentro de las clases estaba la l√≥gica para trabajar con el DBMS (en ese momento era ADO.NET). <br><br>  Todo parec√≠a estar bien, pero con la expansi√≥n del proyecto, estas clases tambi√©n crecieron, convirti√©ndose en objetos dif√≠ciles de mantener.  Adem√°s, hubo un regusto desagradable: parece ser una regla comercial, pero se almacenaron en el nivel de infraestructura, porque estaban vinculados a una implementaci√≥n espec√≠fica. <br><br>  Este enfoque fue reemplazado por el repositorio <i>IQueryable &lt;T&gt;</i> , que permiti√≥ llevar todas las reglas directamente a la capa de dominio. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IQueryable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  que se us√≥ algo como esto: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Repository(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdUsers = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> repository.List().Where(x =&gt; x.CreatedAd &gt; targetDate).ToListAsync();</code> </pre><br>  Un poco mejor, pero el problema es que las reglas se arrastran a lo largo del c√≥digo, y la misma verificaci√≥n puede ocurrir en cientos de lugares, y es f√°cil imaginar lo que puede resultar en cambios en los requisitos. <br><br>  Este enfoque oculta otro problema: si no materializa la consulta, es decir, la posibilidad de completar varias consultas a la base de datos, en lugar de una, que, por supuesto, afecta negativamente el rendimiento del sistema. <br><br>  Y aqu√≠, en uno de los proyectos, un colega sugiri√≥ usar una <a href="https://github.com/rjperes/DevelopmentWithADot.NHibernateSpecifications">biblioteca</a> que sugiriera la implementaci√≥n del patr√≥n de "especificaci√≥n" basado en √°rboles de expresi√≥n. <br><br>  En resumen, sobre la base de esta biblioteca, filmamos especificaciones que nos permitieron crear filtros para entidades y construir filtros m√°s complejos basados ‚Äã‚Äãen concatenaciones de reglas simples.  Por ejemplo, tenemos una especificaci√≥n para los caracteres creados despu√©s del a√±o nuevo y hay una especificaci√≥n para elegir caracteres con un determinado elemento; luego, combinando estas reglas, podemos crear una solicitud de una lista de caracteres creados despu√©s del nuevo a√±o y tener el elemento especificado.  Y si en el futuro cambiaremos la regla para determinar nuevos caracteres (por ejemplo, usaremos la fecha del a√±o nuevo chino), entonces lo corregiremos solo en la especificaci√≥n misma y no hay necesidad de buscar todos los usos de esta l√≥gica por c√≥digo. <br><br>  Este proyecto se complet√≥ con √©xito, y la experiencia de utilizar este enfoque ha sido muy exitosa.  Pero no quer√≠a quedarme quieto, y hubo algunos problemas en la implementaci√≥n, a saber: <br><br><ul><li>  el operador de pegado OR no funcion√≥; </li><li>  la uni√≥n solo funciona para consultas que contienen filtros de tipo Where, pero quer√≠a reglas m√°s completas (consultas anidadas, omitir / tomar, obtener proyecciones); <br></li><li>  el c√≥digo de especificaci√≥n depend√≠a del ORM seleccionado; </li><li>  no fue posible utilizar las funciones ORM, ya que  Esto condujo a la inclusi√≥n de dependencias en la capa de l√≥gica de negocios (por ejemplo, era imposible hacer la recuperaci√≥n). <br></li></ul><br>  El resultado de resolver estos problemas fue el mini-marco <i>Singularis.Secification</i> , que consta de varios ensamblajes: <br><br><ul><li>  Singularis.Specification.Definition: define el objeto de especificaci√≥n y tambi√©n contiene la interfaz IQuery con la que se forma la regla. </li><li>  Singularis.Specification.Executor. *: Implementa un repositorio y un objeto para ejecutar especificaciones para ORM espec√≠ficos (actualmente soportado por ef.core y NHibernate, como parte de los experimentos tambi√©n hice una implementaci√≥n para mongodb, pero este c√≥digo no entr√≥ en producci√≥n). </li></ul><br>  Echemos un vistazo m√°s de cerca a la implementaci√≥n. <br><br>  La interfaz de especificaci√≥n define la propiedad p√∫blica que contiene la regla de especificaci√≥n: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { IQuery Query { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } Type ResultType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpefication</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { }</code> </pre><br>  Adem√°s, la interfaz contiene la propiedad <i>ResultType</i> , que devuelve el tipo de entidad obtenida como resultado de la consulta. <br><br>  Su implementaci√≥n est√° contenida en la clase <i>Especificaci√≥n &lt;T&gt;</i> , que implementa la propiedad <i>ResultType</i> , calculando en funci√≥n de la regla almacenada en la consulta, as√≠ como dos m√©todos: <i>Source ()</i> y <i>Source &lt;TSource&gt; ()</i> .  Estos m√©todos sirven para formar la fuente de la regla.  <i>Source ()</i> crea una regla con un tipo que coincide con el argumento de la clase de especificaci√≥n, y <i>Source &lt;TSource&gt; () le</i> permite crear una regla para una clase arbitraria (utilizada al generar consultas anidadas). <br><br>  Adem√°s, tambi√©n existe la clase <i>SpecificationExtension</i> , que contiene m√©todos de extensi√≥n para encadenar solicitudes. <br><br>  Se admiten dos tipos de uni√≥n: concatenaci√≥n (puede considerarse como uni√≥n por la condici√≥n "Y") y uni√≥n por la condici√≥n "O". <br><br>  Volvamos a nuestro ejemplo e implementemos nuestras dos reglas: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &gt; target); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedBefore</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &lt; target); } }</code> </pre><br>  y encuentre todos los usuarios que cumplan ambas reglas: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2019</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Combine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification);</code> </pre><br>  La combinaci√≥n con el m√©todo <i>Combinar</i> admite reglas arbitrarias.  Lo principal es que el tipo resultante del lado izquierdo coincide con el tipo de entrada del lado derecho.  Por lo tanto, puede crear reglas que contengan proyecciones, omitir / tomar para paginaci√≥n, ordenar reglas, buscar, etc. <br><br>  La regla Or es m√°s restrictiva: solo admite cadenas que contienen condiciones de filtrado Where.  Considere el uso de un ejemplo: encontramos todos los caracteres creados antes de 2000 o despu√©s de 2020: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Or(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification );</code> </pre><br>  La interfaz <i>IQuery</i> repite en gran medida la interfaz <i>IQueryable</i> , por lo que no deber√≠a haber preguntas especiales.  Deteng√°monos solo en m√©todos espec√≠ficos: <br><br>  <i>Fetch / ThenFetch</i> : le permite incluir datos relacionados en la consulta generada para fines de optimizaci√≥n.  Por supuesto, esto es un poco torcido cuando tenemos caracter√≠sticas de implementaci√≥n de infraestructura que afectan las reglas de negocios, pero, como dije, la realidad es una abstracci√≥n dura y pura: esto es algo bastante te√≥rico. <br><br>  <i>Donde</i> : <i>IQuery</i> declara dos sobrecargas de este m√©todo, una toma solo una expresi√≥n lambda para filtrar en forma de <i>Expression &lt;Func &lt;T, bool &gt;&gt;</i> , y la segunda tambi√©n toma par√°metros adicionales <i>IQueryContext</i> , que le permite ejecutar subconsultas anidadas.  Veamos un ejemplo. <br><br>  Tenemos la clase ReadCharacter en el modelo: suponga que nuestro modelo se presenta como una parte de lectura que contiene datos desnormalizados y sirve para comentarios r√°pidos, y una parte de escritura que contiene enlaces, datos normalizados, etc.  Queremos mostrar todos los caracteres para los que el usuario tiene correo en un dominio espec√≠fico. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ReadCharacter</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> domain</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usersQuery = Source&lt;User&gt;(x =&gt; x.Email.Contains(domain)).Projection(x =&gt; x.Id); Query = Source().Where((x, ctx) =&gt; ctx.GetQueryResult&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(usersQuery).Contains(x.Id)); } }</code> </pre><br>  Como resultado de la ejecuci√≥n, se generar√° la siguiente consulta SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> readcharac0_.id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id1_3_, readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> userid2_3_, readcharac0_.Name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> name3_3_ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ReadCharacters readcharac0_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> user1_.Id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Users</span></span> user1_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> user1_.Email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> (<span class="hljs-string"><span class="hljs-string">'%'</span></span>+@p0+<span class="hljs-string"><span class="hljs-string">'%'</span></span>) ); @p0 = '@inmagna.ca' [Type: String (4000:0:0)]</code> </pre><br>  Para cumplir con todas estas maravillosas reglas, se <i>define la</i> interfaz <i>IRepository</i> , que le permite recibir art√≠culos por identificador, recibir uno (el primero adecuado) o una lista de objetos de acuerdo con la especificaci√≥n, y tambi√©n guardar y eliminar art√≠culos de la tienda. <br>  Con la definici√≥n de consultas, descubrimos, ahora queda por ense√±ar a nuestro ORM a entender esto. <br>  Para hacer esto, analizaremos el ensamblaje de <i>Singularis.Infrastructure.NHibernate</i> (para ef.core todo se ve igual, solo con los detalles de ef.core). <br><br>  El punto de acceso a datos es el objeto Repository, que implementa la interfaz <i>IRepository</i> .  En caso de recibir un objeto por identificador, as√≠ como para modificar el almacenamiento (guardar / eliminar), esta clase concluye una sesi√≥n y oculta una implementaci√≥n espec√≠fica de la capa empresarial.  En el caso de trabajar con especificaciones, forma un objeto <i>IQueryable</i> que refleja nuestra consulta en t√©rminos de <i>IQuery</i> y luego lo ejecuta en el objeto de sesi√≥n. <br><br>  La magia principal y el c√≥digo m√°s feo reside en la clase responsable de convertir <i>IQuery</i> a <i>IQueryable</i> - SpecificationExecutor.  Esta clase contiene mucha reflexi√≥n, que llama m√©todos Queryable o m√©todos de extensi√≥n de un ORM espec√≠fico (EagerFetchingExtensionsMethods para NHiberante). <br><br>  Esta biblioteca se usa activamente en nuestros proyectos (para ser honesto, una biblioteca ya actualizada se usa para nuestros proyectos, pero gradualmente todos estos cambios se establecer√°n en el dominio p√∫blico) est√° en constante cambio.  Hace solo un par de semanas, se lanz√≥ la pr√≥xima versi√≥n, que cambi√≥ a m√©todos asincr√≥nicos, se corrigieron errores en el ejecutor para ef.core, se agregaron pruebas y muestras.  Es probable que la biblioteca contenga errores y un centenar de lugares para la optimizaci√≥n: naci√≥ como un proyecto paralelo en el marco del trabajo en los proyectos principales, por lo que me complacer√° sugerir sugerencias para mejorar.  Adem√°s, no debe apresurarse a usarlo; es probable que en su caso particular esto sea innecesario o inaplicable. <br><br>  ¬øCu√°ndo vale la pena usar la soluci√≥n descrita?  Probablemente sea m√°s f√°cil comenzar con la pregunta "cu√°ndo no deber√≠a": <br><br><ul><li>  Highload: si necesita un alto rendimiento, el uso de ORM en s√≠ mismo plantea una pregunta.  Aunque, por supuesto, nadie proh√≠be implementar un ejecutor que traduzca las consultas a SQL y las ejecute ... </li><li>  proyectos muy peque√±os: esto es muy subjetivo, pero debes admitir que tirar del ORM y todo el zool√≥gico que lo acompa√±a al proyecto de la "lista de tareas pendientes" parece disparar gorriones desde un ca√±√≥n. </li></ul><br>  En cualquier caso, qui√©n domin√≥ la lectura hasta el final, gracias por su tiempo.  ¬°Espero comentarios para el desarrollo futuro! <br><br>  Casi se me olvida: el c√≥digo del proyecto est√° disponible en GitHub'e: <a href="https://github.com/SingularisLab/singularis.specification">https://github.com/SingularisLab/singularis.specification</a> <br><br><div class="spoiler">  <b class="spoiler_title">Los ensamblajes est√°n disponibles para descargar a trav√©s de nuget</b> <div class="spoiler_text"><ul><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Definition/">https://www.nuget.org/packages/Singularis.Specification.Definition/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/">https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Common/">https://www.nuget.org/packages/Singularis.Specification.Executor.Common/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/">https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/</a> </li></ul></div></div></div></div><p>Source: <a href="https://habr.com/ru/post/485328/">https://habr.com/ru/post/485328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485316/index.html">Todos los SERP de Google ahora parecen anuncios</a></li>
<li><a href="../485318/index.html">Agregando belleza e interactividad a los cuadernos Jupyter</a></li>
<li><a href="../485322/index.html">Hable acerca de PostgreSQL. Entrevista con Alexei Lesovsky en el podcast Zinc Prod. Primera parte</a></li>
<li><a href="../485324/index.html">Multithreading en Qt Widgets</a></li>
<li><a href="../485326/index.html">Crear micro frontends usando elementos angulares: una gu√≠a para principiantes</a></li>
<li><a href="../485330/index.html">C√≥mo vencer al azar sin alma en los juegos de roguelike</a></li>
<li><a href="../485334/index.html">Encuesta de sesi√≥n</a></li>
<li><a href="../485336/index.html">Qu√© hay en la Universidad ITMO: conferencias, talleres, concursos y entretenimiento</a></li>
<li><a href="../485338/index.html">C√≥mo superar el miedo y comenzar a usar Azure Machine Learning</a></li>
<li><a href="../485342/index.html">¬øC√≥mo fue 2019 en el campo de las matem√°ticas y la inform√°tica?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>