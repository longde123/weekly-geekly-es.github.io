<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕧 👱 👩🏽‍🤝‍👨🏿 Einfache und leicht zu implementierende Anwendungen auf Tarantool Cartridge (Teil 2) 🦁 🚒 👩🏻‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In jüngerer Zeit haben wir darüber gesprochen, wie in Tarantool Cartridge geschriebene Anwendungen bereitgestellt werden . Der Vorgang endet jedoch ni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Einfache und leicht zu implementierende Anwendungen auf Tarantool Cartridge (Teil 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/"><p><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p>  In jüngerer Zeit haben wir <a href="https://habr.com/ru/company/mailru/blog/478710/">darüber gesprochen,</a> wie in <a href="https://habr.com/ru/company/mailru/blog/465503/">Tarantool Cartridge</a> geschriebene Anwendungen <a href="https://habr.com/ru/company/mailru/blog/465503/">bereitgestellt werden</a> .  Der Vorgang endet jedoch nicht mit der Bereitstellung. Daher werden wir heute unsere Anwendung aktualisieren und verstehen, wie die Topologie, das Sharding und die Autorisierung verwaltet sowie die Konfiguration von Rollen geändert werden. </p><br><p>  Neugierig bitte schneiden! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis">  Wo haben wir aufgehört? </h2><br><p>  Beim letzten Mal haben wir die folgende Topologie konfiguriert: </p><br><p><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p> <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">Das</a> Beispiel- <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">Repository</a> konnte ein wenig geändert werden, neue Dateien wurden dort <code>getting-started-app-2.0.0-0.rpm</code> <code>hosts.updated.2.yml</code> <code>getting-started-app-2.0.0-0.rpm</code> und <code>hosts.updated.2.yml</code> .  Sie müssen die neue Version nicht herunterladen, <code>hosts.updated.2.yml</code> können das Paket einfach über den <a href="">Link</a> herunterladen. <code>hosts.updated.2.yml</code> nur benötigt, damit Sie bei Problemen mit der Änderung des aktuellen Inventars einen Blick dorthin <code>hosts.updated.2.yml</code> können. </p><br><p>  Wenn Sie alle Schritte des vorherigen Teils dieses Lernprogramms ausgeführt haben, befindet sich jetzt in Ihrer hosts.yml- <code>hosts.yml</code> eine Clusterkonfiguration mit zwei <code>storage</code> (im Repository ist dies <code>hosts.updated.yml</code> ). </p><br><p>  Erhöhen Sie unsere virtuellen Maschinen: </p><br><pre> <code class="bash hljs">$ vagrant up</code> </pre> <br><p>  Installieren Sie die neue Version der Ansible-Rollen-Tarantool-Kassette (die sich natürlich zum Besseren geändert hat): </p><br><pre> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p>  Also, die aktuelle Cluster-Konfiguration: </p><br><pre> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p>  Gehen Sie zu <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> und vergewissern Sie sich, dass sich Ihr Cluster im richtigen Zustand befindet. </p><br><p>  Alles ist wie beim letzten Mal: ​​Wir werden diese Datei schrittweise ändern und beobachten, wie sich der Cluster ändert.  Sie können sich die endgültige Version immer in <code>hosts.updated.2.yml</code> </p><br><p>  Also los geht's! </p><br><h2 id="obnovlyaem-prilozhenie">  Aktualisieren der Anwendung </h2><br><p>  Lassen Sie uns zunächst unsere Anwendung aktualisieren.  <code>getting-started-app-2.0.0-0.rpm</code> Sie sicher, dass sich die Datei <code>getting-started-app-2.0.0-0.rpm</code> im aktuellen Verzeichnis befindet (falls nicht, <a href="">laden Sie</a> sie aus dem Repository <a href="">herunter</a> ). </p><br><p>  Geben Sie den Pfad zur neuen Version des Pakets an: </p><br><pre> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p>  Wir haben <code>cartridge_enable_tarantool_repo: false</code> damit die Rolle das Repository nicht mit dem Tarantool-Paket verbindet, das wir bereits das letzte Mal installiert haben.  Dies beschleunigt den Bereitstellungsprozess geringfügig, ist jedoch absolut nicht erforderlich. </p><br><p>  Starten Sie das Playbook mit dem <code>cartridge-instances</code> Tag: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p>  Und wir prüfen, ob das Paket aktualisiert wurde: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p>  Überprüfen Sie, ob die Version <code>2.0.0</code> : </p><br><pre> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p>  Jetzt können Sie sicher mit der neuen Version der Anwendung experimentieren. </p><br><h2 id="vklyuchaem-shardirovanie">  Scherben einschalten </h2><br><p>  Lassen Sie uns das Sharding aktivieren, damit wir später die Kontrolle über <code>storage</code> übernehmen können.  Das geht ganz einfach.  Fügen Sie die Variable <code>cartridge_bootstrap_vshard</code> Abschnitt <code>all.vars</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Wir starten: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Beachten Sie, dass wir das <code>cartridge-config</code> Tag angegeben haben, um nur Aufgaben auszuführen, die an der Cluster-Konfiguration beteiligt sind. </p><br><p>  Öffnen Sie die Web-Benutzeroberfläche <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard,</a> und stellen Sie sicher, dass unsere Buckets in einem Verhältnis von <code>2:3</code> auf die Speicherreplikatsätze verteilt sind. </p><br><p><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover">  Aktivieren Sie das automatische Failover </h2><br><p>  Und jetzt schalten wir den automatischen Failover-Modus ein, damit wir später herausfinden können, was es ist und wie es funktioniert. </p><br><p>  Fügen Sie der Konfiguration das <code>cartridge_failover</code> Flag hinzu: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Wir starten erneut die Cluster-Management-Aufgaben: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Nachdem Sie das Playbook erfolgreich abgeschlossen haben, können Sie zur Web-Benutzeroberfläche wechseln und sicherstellen, dass der <code>Failover</code> Schalter in der oberen rechten Ecke <code>Failover</code> ist.  Um den automatischen Failover-Modus zu deaktivieren, ändern Sie einfach den Wert von <code>cartridge_failover</code> in <code>false</code> und führen Sie das Playbook erneut aus. </p><br><p>  Es ist Zeit herauszufinden, um was für ein Regime es sich handelt und warum wir es aktiviert haben. </p><br><h2 id="razbiraemsya-s-failover-om">  Wir beschäftigen uns mit Failover </h2><br><p>  Wahrscheinlich haben Sie die <code>failover_priority</code> bemerkt, die wir für jedes Replikatset angegeben haben.  Mal sehen, was es ist. </p><br><p>  Tarantool Cartridge bietet einen automatischen Failover-Modus.  Jedes Replikatset verfügt über eine Führungslinie - die Instanz, in der es aufgezeichnet wird.  Wenn dem Anführer etwas passiert, wird einer der Kommentare seine Rolle übernehmen.  Welches?  Sehen wir uns das <code>storage-2</code> Replikatset genauer an: </p><br><pre> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p>  Die <code>storage-2</code> Instanz haben wir zuerst in <code>failover_priority</code> .  In der Web-Benutzeroberfläche wird es zuerst in der Liste der Replicaset-Instanzen angezeigt und mit einer grünen Krone markiert.  Dies ist der Leader - die erste in <code>failover_priority</code> angegebene Instanz: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Nun wollen wir sehen, was passiert, wenn dem Leiter des Replikatsets etwas passiert.  Wir gehen in die virtuelle Maschine und stoppen die <code>storage-2</code> Instanz: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p>  Zurück zur Web-Benutzeroberfläche: </p><br><p><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p>  Die Krone bei der <code>storage-2</code> Instanz wurde rot - dies bedeutet, dass der designierte Anführer nicht mehr gesund ist.  Aber das <code>storage-2-replica</code> eine grüne Krone - diese Instanz hat die Führungsverantwortung übernommen, bis <code>storage-2</code> wieder in Betrieb genommen wird.  Dies ist ein automatisches Failover in Aktion. </p><br><p>  Lassen Sie uns <code>storage-2</code> wiederbeleben: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p>  Alles kehrte auf den ersten Platz zurück: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Lassen Sie uns die Reihenfolge der Instanzen in der Priorität des Failovers ändern.  Wir machen die <code>storage-2-replica</code> Instanz zu einer führenden Instanz und entfernen <code>storage-2</code> im Allgemeinen aus der Liste: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p>  Führen Sie <code>cartridge-replicasets</code> für Instanzen aus der Gruppe <code>replicaset_storage_2</code> aus: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Wir gehen zu <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> und stellen fest, dass sich der Anführer geändert hat: </p><br><p><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p>  Aber wir haben die <code>storage-2</code> Instanz aus der Konfiguration entfernt. Warum ist sie immer noch hier?  Fakt ist, dass Cartridge, die den neuen Wert " <code>failover_priority</code> erhält <code>failover_priority</code> die Instanzen wie folgt organisiert: Die erste Instanz aus der Liste wird zum Leader, die übrigen angegebenen Instanzen folgen.  Instanzen, die in <code>failover_priority</code> nicht erwähnt werden, werden von der UUID sortiert und an das Ende angehängt. </p><br><h2 id="izgnanie-instansa">  Exil-Instanz </h2><br><p>  Was aber, wenn wir die Instanz von der Topologie ausschließen wollen?  Alles ist sehr einfach: Sie müssen die <code>expelled</code> Flagge übergeben.  Lassen Sie uns die <code>storage-2-replica</code> Instanz ausschließen.  Er ist jetzt der Anführer, also wird Cartridge uns das nicht erlauben.  Aber wir haben keine Angst vor Schwierigkeiten und versuchen immer noch: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p>  Wir geben das <code>cartridge-replicasets</code> , da das Austreiben einer Instanz eine Topologieänderung darstellt: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Führen Sie das Playbook aus und sehen Sie den Fehler: </p><br><p><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p>  Wie wir gerade gesehen haben, ist es mit Cartridge nicht gerechtfertigt, den aktuellen Replicaset-Leader aus der Topologie zu werfen.  Dies ist sehr logisch, da die Replikation asynchron ist und der Ausschluss eines Leaders wahrscheinlich zu Datenverlust führt.  Wir müssen einen anderen Anführer angeben und erst danach die Instanz ausschließen.  Die Rolle wendet zuerst die neue Replicaset-Konfiguration an und behandelt dann die Ausnahme.  Aus diesem Grund ändern wir die <code>failover_priority</code> und führen das Playbook erneut aus: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Voila, die <code>storage-2-replica</code> Instanz ist aus der Topologie verschwunden! </p><br><p><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p>  Beachten Sie, dass das Instanzexil wirklich endgültig und unwiderruflich ist.  Nach dem Entfernen der Instanz aus der Topologie stoppt unsere ansible Rolle den systemd-Dienst und löscht alle Dateien dieser Instanz. </p><br><p><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p>  Wenn Sie plötzlich Ihre Meinung ändern und feststellen, dass das <code>storage-2</code> Replikatset noch eine zweite Instanz benötigt, können Sie es nicht wiederherstellen.  Cartridge merkt sich die UUID aller Instanzen, die die Topologie verlassen haben, und lässt nicht zu, dass das Exil zurückkehrt.  Sie können eine neue Instanz mit demselben Namen und derselben Konfiguration auslösen, diese hat jedoch offensichtlich eine andere UUID, sodass Cartridge die Verknüpfung zulässt. </p><br><h2 id="udalenie-replikaseta">  Replicaset wird entfernt </h2><br><p>  Wir haben bereits herausgefunden, dass wir den Anführer des Replikatsets nicht ausweisen dürfen.  Aber was ist, wenn wir das <code>storage-2</code> Replikat dauerhaft entfernen möchten?  Es gibt natürlich einen Ausweg. </p><br><p>  Um keine Daten zu verlieren, müssen wir zuerst alle Buckets in <code>storage-1</code> . Dazu setzen wir das Gewicht des <code>storage-2</code> Replikats auf <code>0</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p>  Starten Sie die Topologieverwaltung: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Öffnen Sie die Web-Benutzeroberfläche <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> und beobachten Sie, wie alle Buckets in <code>storage-1</code> fließen: </p><br><p><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p>  Wir setzen den <code>storage-2</code> Anführer auf die ausgeschlossene Flagge und verabschieden uns von diesem Replikatsatz: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p>  Bitte beachten Sie, dass wir diesmal die <code>limit</code> Option nicht angegeben haben, da mindestens eine Instanz von allen, für die wir das Playbook gestartet haben, nicht als <code>expelled</code> markiert werden sollte. </p><br><p>  Also kehrten wir zur ursprünglichen Topologie zurück: </p><br><p><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya">  Einloggen </h2><br><p>  Ich möchte von der Verwaltung von Replikatsätzen ablenken und über Sicherheit nachdenken.  Jetzt kann jeder nicht autorisierte Benutzer den Cluster über die Web-Benutzeroberfläche verwalten.  Stimmen Sie zu, es sieht so lala aus. </p><br><p>  Cartridge bietet die Möglichkeit, Ihr eigenes Autorisierungsmodul wie LDAP (oder was auch immer Sie dort haben) anzuschließen und es zu verwenden, um Benutzer und deren Zugriff auf die Anwendung zu verwalten.  Wir werden jedoch das integrierte Autorisierungsmodul verwenden, das Cartridge standardmäßig verwendet.  Mit diesem Modul können Sie grundlegende Vorgänge mit Benutzern ausführen (Löschen, Hinzufügen, Bearbeiten) und die Kennwortüberprüfungsfunktion implementieren. <br>  Bitte beachten Sie, dass unsere ansible Rolle das Berechtigungs-Backend benötigt, um alle diese Funktionen zu implementieren. </p><br><p>  Wir gehen also von der Theorie zur Praxis über.  Machen Sie zunächst die Autorisierung obligatorisch, legen Sie die Sitzungsparameter fest und fügen Sie einen neuen Benutzer hinzu: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p>  Die Berechtigungsverwaltung wird im Rahmen der <code>cartridge-config</code> . Wir geben dieses Tag an: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Unter <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> erwartet uns <a href="http://localhost:8181/admin/cluster/dashboard">eine</a> Überraschung: </p><br><p><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p>  Sie können sich mit dem <code>username</code> und dem <code>password</code> unseres neuen Benutzers anmelden oder sich als <code>admin</code> - der Standardbenutzer - anmelden.  Sein Passwort ist Cluster-Cookie, wir haben diesen Wert in der Variablen <code>cartridge_cluster_cookie</code> (dies ist ein <code>app-default-cookie</code> , den Sie nicht einsehen können). </p><br><p>  Öffnen Sie nach einer erfolgreichen Anmeldung die Registerkarte <code>Users</code> , um sicherzustellen, dass alles gut gelaufen ist: </p><br><p><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p>  Experimentieren Sie mit dem Hinzufügen neuer Benutzer und dem Ändern ihrer Einstellungen.  Um einen Benutzer zu löschen, geben Sie das <code>deleted: true</code> Flag für ihn an.  Die Werte für <code>email</code> <code>fullname</code> und <code>fullname</code> werden von Cartridge in keiner Weise verwendet, Sie können sie jedoch zur Vereinfachung angeben. </p><br><h2 id="konfiguraciya-prilozheniya">  Anwendungskonfiguration </h2><br><p>  Erinnern wir uns, wie alles begann. </p><br><p>  Wir haben eine kleine Anwendung bereitgestellt, die Daten über Kunden und deren Bankkonten speichert.  Wie Sie sich erinnern, hat diese Anwendung zwei Rollen: <code>api</code> und <code>storage</code> .  Die <code>storage</code> die Datenspeicherung und implementiert das Sharding mithilfe der integrierten <code>vshard-storage</code> Rolle.  Die zweite Rolle, <code>api</code> , implementiert einen HTTP-Server mit einer API für die Datenverwaltung. <code>vshard-router</code> ist eine weitere Standardrolle, <code>vshard-router</code> , angeschlossen, die das <code>vshard-router</code> steuert. </p><br><p>  Daher stellen wir die erste Anfrage an die Anwendungs-API.  Neuen Kunden hinzufügen: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p>  Als Antwort erhalten wir so etwas: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p>  Bitte beachten Sie, dass wir in der URL den <code>8082</code> <code>app-1</code> , <code>8082</code> , da dieser diese API implementiert. </p><br><p>  Jetzt aktualisieren wir den Kontostand unseres neuen Benutzers: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  In der Antwort sehen wir den aktualisierten Saldo: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p>  Super, alles funktioniert!  Die API ist implementiert, Cartridge beschäftigt sich mit Daten-Sharding, wir haben bereits eine Failover-Priorität für Notfälle eingerichtet und sogar die Autorisierung aktiviert.  Es ist Zeit, die Konfiguration der Anwendung vorzunehmen. </p><br><p>  Die aktuelle Cluster-Konfiguration wird in einer verteilten Konfigurationsdatei gespeichert.  Jede Instanz speichert eine Kopie dieser Datei, und Cartridge stellt die Synchronisation zwischen allen Knoten des Clusters sicher.  In dieser Datei können wir die Konfiguration der Rollen unserer Anwendung festlegen. Cartridge übernimmt die Verteilung der neuen Konfiguration auf alle Instanzen. </p><br><p>  Schauen wir uns den aktuellen Inhalt dieser Datei an.  Gehen Sie zur Registerkarte <code>Cofiguration files</code> und klicken Sie auf die Schaltfläche <code>Download</code> : </p><br><p><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p>  In der heruntergeladenen <code>config.yml</code> config.yml finden wir eine leere Tabelle.  Kein Wunder, denn wir haben noch keine Parameter angegeben: </p><br><pre> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p>  Tatsächlich ist die Konfigurationsdatei unseres Clusters nicht leer, sondern speichert die aktuelle Topologie, die Autorisierungseinstellungen und die Sharding-Einstellungen.  Cartridge wird es jedoch nicht so einfach sein, diese Informationen weiterzugeben, sie sind für den internen Gebrauch bestimmt und werden daher in verborgenen Systembereichen gespeichert, die wir nicht bearbeiten können. </p><br><p>  Jede Anwendungsrolle kann einen oder mehrere Konfigurationsabschnitte verwenden.  Das Herunterladen einer neuen Konfiguration erfolgt in zwei Schritten: Zunächst überprüfen alle Rollen, ob sie bereit sind, neue Parameter zu akzeptieren.  Wenn keine Einwände erhoben werden, werden die Änderungen übernommen. Wenn jemand dagegen ist, erfolgt ein Rollback. </p><br><p>  Kehren wir zu unserer Bewerbung zurück.  Die <code>api</code> Rolle verwendet den Abschnitt "Maximaler <code>max-balance</code> ", in dem der maximal zulässige Kontostand auf einem Kundenkonto gespeichert wird.  Lassen Sie uns diesen Abschnitt konfigurieren, aber natürlich nicht manuell, sondern mithilfe unserer Ansible-Rolle. </p><br><p>  Jetzt ist die Anwendungskonfiguration (oder vielmehr ein Teil davon, der uns zur Verfügung steht) eine leere Tabelle.  Fügen Sie einen <code>max-balance</code> Abschnitt mit einem Wert von <code>100000</code> .  Wir schreiben die Variable <code>cartridge_app_config</code> in unsere Inventardatei: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p>  Wir haben den Abschnittsnamen, <code>max-balance</code> und dessen Inhalt <code>body</code> .  Der Inhalt eines Abschnitts kann nicht nur eine Zahl, sondern auch eine Tabelle oder eine Zeile sein, je nachdem, wie die Rolle geschrieben ist und welche Art von Wert Sie verwenden möchten. </p><br><p>  Wir starten: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Und wir prüfen, ob sich das maximal zulässige Guthaben wirklich geändert hat: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Als Antwort erhalten wir einen Fehler, wie wir wollten: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p>  Sie können die Konfigurationsdatei auf der Registerkarte Konfigurationsdateien erneut herunterladen, um sicherzustellen, dass dort ein neuer Abschnitt angezeigt wird: </p><br><pre> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p>  Versuchen Sie, der Anwendungskonfiguration neue Abschnitte hinzuzufügen, deren Inhalt zu ändern oder sie vollständig zu löschen (dazu müssen Sie das Flag <code>deleted: true</code> in dem Abschnitt setzen). </p><br><p>  Informationen zur Verwendung einer verteilten Konfiguration in Rollen finden Sie in der <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">Dokumentation zu</a> Tarantool Cartridge. </p><br><p>  Denken Sie daran, <code>vagrant halt</code> aufzurufen, um die <code>vagrant halt</code> anzuhalten <code>vagrant halt</code> wenn Sie mit der Arbeit fertig sind. </p><br><h2 id="v-zaklyuchenie">  Abschließend </h2><br><p>  Beim letzten Mal haben wir gelernt, wie verteilte Tarantool Cartridge-Anwendungen mithilfe einer speziellen Ansible-Rolle bereitgestellt werden.  Heute haben wir die Anwendung aktualisiert und auch die Verwaltung von Topologie, Sharding, Autorisierung und Konfiguration der Anwendung gemeistert. </p><br><p>  Hören Sie nicht damit auf, lernen Sie <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">verschiedene Ansätze</a> zum Schreiben von Ansible-Spielbüchern und verwenden Sie Ihre Anwendungen mit maximalem Komfort. </p><br><p>  Wenn etwas für Sie nicht funktioniert oder wenn Sie Ideen zur Verbesserung unserer anonymen Rolle haben, können Sie gerne ein <a href="https://github.com/tarantool/ansible-cartridge/issues/new">Ticket</a> starten.  Wir helfen Ihnen immer bei der Lösung Ihres Problems und freuen uns über interessante Angebote! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de484192/">https://habr.com/ru/post/de484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de484178/index.html">Intelligenter Ethernet-Switch für Planet Earth</a></li>
<li><a href="../de484180/index.html">Virtuelle Telefonanlage von Rostelecom: Was und wie kann über die API geschehen?</a></li>
<li><a href="../de484182/index.html">Xenobots: Lebende Nanoroboter aus Froschzellen</a></li>
<li><a href="../de484186/index.html">LDAP - "Authentifizierung" ist ein Antipattern</a></li>
<li><a href="../de484188/index.html">Standards für das Datenbankdesign</a></li>
<li><a href="../de484194/index.html">Kubernetes übersetzt in Kinder</a></li>
<li><a href="../de484196/index.html">Aufnahme von JS-Ton über ein Mikrofon oder Sprachkommentare</a></li>
<li><a href="../de484198/index.html">Rückseite der Medaille: Wer hat beim Wachstum der Tesla-Aktien gewonnen und verloren?</a></li>
<li><a href="../de484200/index.html">Wie man Ziele setzt, um sie zu erreichen</a></li>
<li><a href="../de484202/index.html">Maschinelles Lernen in der statischen Analyse von Programmquellcode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>