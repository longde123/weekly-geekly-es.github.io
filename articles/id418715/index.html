<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚣🏼 💃🏾 😽 Seberapa efisien sistem file virtual procfs dan mungkinkah mengoptimalkannya 🐰 😮 🙋🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sistem file proc (selanjutnya hanya procfs) adalah sistem file virtual yang menyediakan informasi tentang proses. Dia adalah contoh "baik" dari antarm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seberapa efisien sistem file virtual procfs dan mungkinkah mengoptimalkannya</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/virtuozzo/blog/418715/"><p>  Sistem file proc (selanjutnya hanya procfs) adalah sistem file virtual yang menyediakan informasi tentang proses.  Dia adalah contoh "baik" dari antarmuka mengikuti paradigma "semuanya adalah file".  Procfs dikembangkan sejak lama: pada saat server melayani rata-rata lusinan proses, saat membuka file dan membaca informasi proses bukanlah masalah.  Namun, waktu tidak berhenti, dan sekarang server melayani ratusan ribu, atau bahkan lebih banyak proses pada saat yang bersamaan.  Dalam konteks ini, gagasan "membuka file untuk setiap proses untuk mengurangi data yang menarik" tidak lagi terlihat begitu menarik, dan hal pertama yang terlintas dalam pikiran untuk mempercepat pembacaan adalah untuk memperoleh informasi tentang sekelompok proses dalam satu iterasi.  Pada artikel ini, kami akan mencoba menemukan elemen procfs yang dapat dioptimalkan. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7c7/55c/f6b/7c755cf6b80f5b20ab194e548c3c99be.jpg" alt="gambar"></p><a name="habracut"></a><br><p>  Gagasan untuk meningkatkan procf muncul ketika kami menemukan bahwa CRIU menghabiskan banyak waktu hanya membaca file procfs.  Kami melihat bagaimana masalah yang sama diselesaikan untuk soket, dan memutuskan untuk melakukan sesuatu yang mirip dengan antarmuka sock-diag, tetapi hanya untuk procfs.  Tentu saja, kami berasumsi betapa sulitnya untuk mengubah antarmuka yang sudah lama dan mapan di kernel, untuk meyakinkan masyarakat bahwa game ini sepadan dengan lilin ... dan kami sangat terkejut dengan jumlah orang yang mendukung pembuatan antarmuka baru.  Sebenarnya, tidak ada yang tahu seperti apa tampilan antarmuka baru, tetapi tidak ada keraguan bahwa procfs tidak memenuhi persyaratan kinerja saat ini.  Sebagai contoh, skenario ini: server merespon permintaan terlalu lama, vmstat menunjukkan bahwa memori telah beralih, dan "ps ax" dimulai dari 10 detik atau lebih, top tidak menunjukkan apa-apa sama sekali.  Pada artikel ini kami tidak akan mempertimbangkan antarmuka baru yang spesifik, melainkan, kami akan mencoba menjelaskan masalah dan solusinya. </p><br><p> Setiap proses eksekusi procfs diwakili oleh direktori / proc / <code>&lt;pid&gt;</code> . <br>  Di setiap direktori tersebut ada banyak file dan subdirektori yang menyediakan akses ke informasi tertentu tentang proses.  Subdirektori mengelompokkan data berdasarkan fitur.  Misalnya ( <code>$$</code> adalah variabel shell khusus yang diperluas dalam pid - pengidentifikasi proses saat ini): </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-operator"><span class="hljs-operator">-F</span></span> /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> attr/ exe<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mounts projid_map status autogroup fd/ mountstats root<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> syscall auxv fdinfo/ net/ sched task/ cgroup gid_map ns/ schedstat timers clear_refs io numa_maps sessionid timerslack_ns cmdline limits oom_adj setgroups uid_map comm loginuid oom_score smaps wchan coredump_filter map_files/ oom_score_adj smaps_rollup cpuset maps pagemap stack cwd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mem patch_state stat environ mountinfo personality statm</code> </pre> <br><p>  Semua file ini menghasilkan data dalam berbagai format.  Sebagian besar dalam format teks ASCII yang mudah dirasakan oleh manusia.  Yah, hampir mudah: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/stat <span class="hljs-number"><span class="hljs-number">24293</span></span> (bash) S <span class="hljs-number"><span class="hljs-number">21811</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">34854</span></span> <span class="hljs-number"><span class="hljs-number">24876</span></span> <span class="hljs-number"><span class="hljs-number">4210688</span></span> <span class="hljs-number"><span class="hljs-number">6325</span></span> <span class="hljs-number"><span class="hljs-number">19702</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">47892016</span></span> <span class="hljs-number"><span class="hljs-number">135487488</span></span> <span class="hljs-number"><span class="hljs-number">3388</span></span> <span class="hljs-number"><span class="hljs-number">18446744073709551615</span></span> <span class="hljs-number"><span class="hljs-number">94447405350912</span></span> <span class="hljs-number"><span class="hljs-number">94447406416132</span></span> <span class="hljs-number"><span class="hljs-number">140729719486816</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-number"><span class="hljs-number">3670020</span></span> <span class="hljs-number"><span class="hljs-number">1266777851</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">94447408516528</span></span> <span class="hljs-number"><span class="hljs-number">94447408563556</span></span> <span class="hljs-number"><span class="hljs-number">94447429677056</span></span> <span class="hljs-number"><span class="hljs-number">140729719494655</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719496686</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Untuk memahami apa arti setiap elemen dari set ini, pembaca harus membuka man proc (5), atau dokumentasi kernel.  Sebagai contoh, elemen kedua adalah nama file yang dapat dieksekusi di dalam tanda kurung, dan elemen ke sembilan belas adalah nilai saat ini dari prioritas eksekusi (bagus). </p><br><p>  Beberapa file cukup dapat dibaca sendiri: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/status | head <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> Name: bash Umask: <span class="hljs-number"><span class="hljs-number">0002</span></span> State: S (sleeping) Tgid: <span class="hljs-number"><span class="hljs-number">24293</span></span> Ngid: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Tetapi seberapa sering pengguna membaca informasi langsung dari file procfs?  Berapa lama kernel perlu mengkonversi data biner ke format teks?  Berapa overhead dari proksi?  Seberapa nyaman antarmuka ini untuk program monitor status, dan berapa banyak waktu yang dihabiskan untuk memproses data teks ini?  Seberapa kritis implementasi yang begitu lambat dalam situasi darurat? </p><br><p>  Kemungkinan besar, itu tidak akan menjadi kesalahan untuk mengatakan bahwa pengguna lebih suka program seperti top atau ps, daripada membaca data dari procfs secara langsung. </p><br><p>  Untuk menjawab pertanyaan yang tersisa, kami akan melakukan beberapa percobaan.  Pertama, temukan di mana kernel menghabiskan waktu untuk menghasilkan file procfs. </p><br><p>  Untuk mendapatkan informasi tertentu dari semua proses dalam sistem, kita harus melalui direktori / proc / dan memilih semua subdirektori yang namanya direpresentasikan oleh angka desimal.  Kemudian, di masing-masing dari mereka, kita perlu membuka file, membacanya dan menutupnya. </p><br><p>  Secara total, kami akan melakukan tiga panggilan sistem, salah satunya akan membuat file descriptor (di kernel, file deskriptor dikaitkan dengan satu set objek internal yang dialokasikan memori tambahan).  Sistem panggilan terbuka () dan tutup () tidak memberikan informasi apa pun kepada kami, sehingga mereka dapat dikaitkan dengan overhead antarmuka procfs. </p><br><p>  Mari kita coba untuk membuka () dan menutup () untuk setiap proses dalam sistem, tetapi kami tidak akan membaca isi file: </p><br><pre> <code class="hljs go">$ time ./task_proc_all --noread stat tasks: <span class="hljs-number"><span class="hljs-number">50290</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.177s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.012s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.162s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all --noread loginuid tasks: <span class="hljs-number"><span class="hljs-number">50289</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.176s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.026s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.145</span></span></code> </pre> <br><p>  <em>task-proc-all - sebuah utilitas kecil, kode yang dapat ditemukan di tautan di bawah ini</em> </p><br><p>  Tidak masalah file mana yang dibuka, karena data nyata dihasilkan hanya pada saat dibaca (). </p><br><p>  Sekarang lihat output dari profiler inti perf: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 92<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 64<span class="hljs-selector-class"><span class="hljs-selector-class">.01</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.71</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_sys_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 48<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_filp_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">path_openat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 19<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">link_path_walk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 14<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">walk_component</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.87</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.55</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">pid_revalidate</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_pid_task</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.58</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_task_to_inode</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_dump_owner</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup_rcu</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_inode_permission</span></span> + 14<span class="hljs-selector-class"><span class="hljs-selector-class">.76</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pident_lookup</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.39</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_alloc_parallel</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.93</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_empty_filp</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_dentry_open</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.07</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.97</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">kmem_cache_alloc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 16<span class="hljs-selector-class"><span class="hljs-selector-class">.45</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 15<span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_getdents</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iterate_dir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_readdir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_fill_cache</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.59</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">filldir</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">snprintf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 9<span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.85</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span></code> </pre> <br><p>  Kernel menghabiskan hampir 75% dari waktu hanya untuk membuat dan menghapus file descriptor, dan sekitar 16% untuk membuat daftar proses. </p><br><p>  Meskipun kami tahu berapa lama untuk panggilan terbuka () dan tutup () untuk setiap proses, kami masih tidak dapat memperkirakan seberapa signifikannya.  Kita perlu membandingkan nilai yang diperoleh dengan sesuatu.  Mari kita coba melakukan hal yang sama dengan file paling terkenal.  Biasanya, ketika Anda perlu membuat daftar proses, ps atau utilitas atas digunakan.  Keduanya membaca / proc / <code>&lt;pid&gt;</code> / stat dan / proc / <code>&lt;pid&gt;</code> / status untuk setiap proses pada sistem. </p><br><p>  Mari kita mulai dengan / proc / <code>&lt;pid&gt;</code> / status - ini adalah file besar dengan jumlah bidang tetap: </p><br><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50283</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.455s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.033s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.417s</span></span></code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 93<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0000000000008000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 61<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 53<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.80</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.22</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_single_show</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.38</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 11<span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_mem</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.99</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.77</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.94</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strlen</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_to_str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpuset_task_status_allowed</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.37</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_cap_t</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.25</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_sigset_t</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_putc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">lock_task_sighand</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">hugetlb_report_usage</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">copy_to_user</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">number</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.05</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vsnprintf</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.79</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">format_decode</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.52</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000003201b</span></span> + 20<span class="hljs-selector-class"><span class="hljs-selector-class">.95</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.44</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span></code> </pre> <br><p>  Dapat dilihat bahwa hanya sekitar 60% dari waktu yang dihabiskan di dalam panggilan sistem read ().  Jika Anda melihat profil lebih dekat, ternyata 45% dari waktu digunakan di dalam fungsi kernel seq_printf, seq_put_decimal_ull.  Jadi, mengkonversi dari format biner ke teks cukup mahal.  Yang menimbulkan pertanyaan mendasar: apakah kita benar-benar membutuhkan antarmuka teks untuk menarik data dari kernel?  Seberapa sering pengguna ingin bekerja dengan data mentah?  Dan mengapa utilitas top dan ps harus mengubah data teks ini kembali ke biner? </p><br><p>  Mungkin menarik untuk mengetahui seberapa cepat output akan terjadi jika data biner digunakan secara langsung, dan jika tiga panggilan sistem tidak diperlukan. </p><br><p>  Sudah ada upaya untuk membuat antarmuka seperti itu.  Pada 2004 kami mencoba menggunakan mesin netlink. </p><br><pre> <code class="hljs markdown">[<span class="hljs-string"><span class="hljs-string">0/2</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">ANNOUNCE</span></span>] nproc: netlink access to /proc information (https://lwn.net/Articles/99600/) nproc is an attempt to address the current problems with /proc. In short, it exposes the same information via netlink (implemented for a small subset).</code> </pre> <br><p>  Sayangnya, komunitas belum menunjukkan minat pada pekerjaan ini.  Salah satu upaya terakhir untuk memperbaiki situasi terjadi dua tahun lalu. </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">PATCH 0/15</span></span>] task_diag: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> a new </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">interface</span></span></span><span class="hljs-function"> to </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">get</span></span></span><span class="hljs-function"> information about </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processes</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">https://lwn.net/Articles/</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">683371</span></span></span></span><span class="hljs-function"><span class="hljs-params">/</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p>  Antarmuka task-diag didasarkan pada prinsip-prinsip berikut: </p><br><ul><li>  Transaksi: mengirim permintaan, menerima respons; </li><li>  Format pesan adalah dalam bentuk netlink (sama dengan antarmuka sock_diag: binary and extensible); </li><li>  Kemampuan untuk meminta informasi tentang banyak proses dalam satu panggilan; </li><li>  Pengelompokan atribut yang dioptimalkan (atribut apa pun dalam grup tidak boleh menambah waktu respons). </li></ul><br><p>  Antarmuka ini telah disajikan di beberapa konferensi.  Itu diintegrasikan ke pstools, utilitas CRIU, dan David Ahern mengintegrasikan task_diag ke dalam perf sebagai percobaan. </p><br><p>  Komunitas pengembangan kernel telah tertarik pada antarmuka task_diag.  Subjek utama diskusi adalah pilihan transportasi antara kernel dan ruang pengguna.  Gagasan awal menggunakan soket netlink ditolak.  Sebagian karena masalah yang belum terselesaikan dalam kode mesin netlink itu sendiri, dan sebagian karena banyak orang berpikir bahwa antarmuka netlink dirancang khusus untuk subsistem jaringan.  Kemudian diusulkan untuk menggunakan file transaksional di dalam procfs, yaitu, pengguna membuka file, menulis permintaan ke dalamnya, dan kemudian hanya membaca jawabannya.  Seperti biasa, ada lawan dari pendekatan ini.  Solusi yang diinginkan semua orang hingga ditemukan. </p><br><p>  Mari kita bandingkan kinerja task_diag dengan procfs. </p><br><p>  Mesin task_diag memiliki utilitas pengujian yang cocok untuk eksperimen kami.  Misalkan kita ingin meminta pengidentifikasi proses dan hak-hak mereka.  Di bawah ini adalah output untuk satu proses: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ./task_diag_all one <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-literal"><span class="hljs-literal">-p</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> pid <span class="hljs-number"><span class="hljs-number">2305</span></span> tgid <span class="hljs-number"><span class="hljs-number">2305</span></span> ppid <span class="hljs-number"><span class="hljs-number">2299</span></span> sid <span class="hljs-number"><span class="hljs-number">2305</span></span> pgid <span class="hljs-number"><span class="hljs-number">2305</span></span> comm bash uid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> gid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> CapInh: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapPrm: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapEff: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapBnd: <span class="hljs-number"><span class="hljs-number">0000003</span></span>fffffffff</code> </pre> <br><p>  Dan sekarang untuk semua proses dalam sistem, yaitu, hal yang sama yang kami lakukan untuk percobaan procfs ketika kami membaca file / proc / pid / status: </p><br><pre> <code class="hljs pgsql">$ <span class="hljs-type"><span class="hljs-type">time</span></span> ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c <span class="hljs-type"><span class="hljs-type">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.048</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.001</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.046</span></span>s</code> </pre> <br><p>  Hanya butuh 0,05 detik untuk mendapatkan data untuk membangun pohon proses.  Dan dengan procfs, hanya butuh 0,177 detik hanya untuk membuka satu file untuk setiap proses, dan tanpa membaca data. </p><br><p>  Output perf untuk antarmuka task_diag: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 82<span class="hljs-selector-class"><span class="hljs-selector-class">.24</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[kernel.vmlinux]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 81<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_reg_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">taskdiag_dumpit</span></span> + 33<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptrace_may_access</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kuid_munged</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.19</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_task_comm</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.90</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.29</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">raw_spin_lock</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">skb_copy_datagram_iter</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.21</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kgid_munged</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span></code> </pre> <br><p>  Tidak ada yang menarik dalam daftar itu sendiri kecuali kenyataan bahwa tidak ada fungsi yang jelas yang cocok untuk optimasi. </p><br><p>  Mari kita lihat output perf ketika membaca informasi tentang semua proses dalam sistem: </p><br><pre> <code class="hljs pgsql"> $ perf trace -s ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c -q <span class="hljs-keyword"><span class="hljs-keyword">Summary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> events: task_diag_all (<span class="hljs-number"><span class="hljs-number">54326</span></span>), <span class="hljs-number"><span class="hljs-number">185</span></span> events, <span class="hljs-number"><span class="hljs-number">95.4</span></span>% syscall calls total min avg max stddev (msec) (msec) (msec) (msec) (%) <span class="hljs-comment"><span class="hljs-comment">--------------- -------- --------- --------- --------- --------- ------ read 49 40.209 0.002 0.821 4.126 9.50% mmap 11 0.051 0.003 0.005 0.007 9.94% mprotect 8 0.047 0.003 0.006 0.009 10.42% openat 5 0.042 0.005 0.008 0.020 34.86% munmap 1 0.014 0.014 0.014 0.014 0.00% fstat 4 0.006 0.001 0.002 0.002 10.47% access 1 0.006 0.006 0.006 0.006 0.00% close 4 0.004 0.001 0.001 0.001 2.11% write 1 0.003 0.003 0.003 0.003 0.00% rt_sigaction 2 0.003 0.001 0.001 0.002 15.43% brk 1 0.002 0.002 0.002 0.002 0.00% prlimit64 1 0.001 0.001 0.001 0.001 0.00% arch_prctl 1 0.001 0.001 0.001 0.001 0.00% rt_sigprocmask 1 0.001 0.001 0.001 0.001 0.00% set_robust_list 1 0.001 0.001 0.001 0.001 0.00% set_tid_address 1 0.001 0.001 0.001 0.001 0.00%</span></span></code> </pre> <br><p>  Untuk procfs, kita perlu melakukan lebih dari 150.000 panggilan sistem untuk mendapatkan informasi tentang semua proses, dan untuk task_diag - sedikit lebih dari 50. </p><br><p>  Mari kita lihat situasi kehidupan nyata.  Sebagai contoh, kami ingin menampilkan pohon proses bersama dengan argumen baris perintah untuk masing-masing.  Untuk melakukan ini, kita perlu mengeluarkan pid dari proses, pid dari orang tuanya, dan argumen baris perintah sendiri. </p><br><p>  Untuk antarmuka task_diag, program mengirim satu permintaan untuk mendapatkan semua parameter sekaligus: </p><br><pre> <code class="hljs go">$ time ./task_diag_all all --cmdline -q <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.096s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.006s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.090s</span></span></code> </pre> <br><p>  Untuk procfs asli, kita perlu membaca / proc // status dan / proc // cmdline untuk setiap proses: <br></p><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50278</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.463s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.030s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.427s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all cmdline tasks: <span class="hljs-number"><span class="hljs-number">50281</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.270s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.028s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.237s</span></span></code> </pre> <br><p>  Sangat mudah untuk melihat bahwa task_diag adalah 7 kali lebih cepat daripada procfs (0,096 melawan 0,27 + 0,46).  Biasanya, peningkatan kinerja beberapa persen sudah merupakan hasil yang baik, tetapi di sini kecepatannya telah meningkat hampir sebesar urutan besarnya. </p><br><p>  Perlu disebutkan juga bahwa pembuatan objek kernel internal juga sangat memengaruhi kinerja.  Terutama ketika subsistem memori berada di bawah beban berat.  Bandingkan jumlah objek yang dibuat untuk procfs dan task_diag: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_proc_all status <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">58184</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_diag_all all <span class="hljs-literal"><span class="hljs-literal">-q</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">188</span></span></code> </pre> <br><p>  Dan juga Anda perlu mencari tahu berapa banyak objek yang dibuat ketika memulai proses sederhana, misalnya, utilitas sebenarnya: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> true <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">94</span></span></code> </pre> <br><p>  Procfs menciptakan objek 600 kali lebih banyak daripada task_diag.  Ini adalah salah satu alasan mengapa procfs bekerja sangat buruk ketika beban memori berat.  Setidaknya karena itu perlu mengoptimalkannya. </p><br><p>  Kami berharap artikel ini akan menarik lebih banyak pengembang untuk mengoptimalkan status procfs dari subsistem kernel. </p><br><p>  Terima kasih banyak kepada David Ahern, Andy Lutomirski, Stephen Hemming, Oleg Nesterov, W. Trevor King, Arnd Bergmann, Eric W. Biederman dan banyak lainnya yang telah membantu mengembangkan dan meningkatkan antarmuka task_diag. </p><br><p>  Terima kasih kepada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">cromer</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">k001</a> dan Stanislav Kinsbursky untuk bantuan dalam menulis artikel ini. </p><br><h1 id="ssylki">  Referensi </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/avagin/linux-task-diag/tree/v4.16-task-diag-20180427/tools/testing/selftests/task_diag</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://lwn.net/Articles/685791/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.slideshare.net/KirKolyshkin/time-to-rethink-proc</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.slideshare.net/kolyshkin/speeding-up-ps-and-top</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://blog.linuxplumbersconf.org/2016/ocw/system/presentations/4599/original/Netlink-issues.pdf</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id418715/">https://habr.com/ru/post/id418715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id418705/index.html">Dasar-dasar Futex</a></li>
<li><a href="../id418707/index.html">KDispatcher - eventbus yang ringan dan nyaman untuk penggunaan sehari-hari</a></li>
<li><a href="../id418709/index.html">Perlu memaksa diri Anda: driver dan hambatan antarmuka</a></li>
<li><a href="../id418711/index.html">Register Terkelola Token 1.0</a></li>
<li><a href="../id418713/index.html">Game untuk meningkatkan kualitas Wikipedia</a></li>
<li><a href="../id418717/index.html">Hantu Unicode</a></li>
<li><a href="../id418721/index.html">Legenda rekayasa virus: awal perang</a></li>
<li><a href="../id418723/index.html">Patch AndroidX</a></li>
<li><a href="../id418725/index.html">Konstanta ajaib</a></li>
<li><a href="../id418727/index.html">Di mana dan bagaimana masuk ke embeddings grafik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>