<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÜ üë®üèº‚Äçüíº üå≤ Patch de code Java sur la production sans anesth√©sie üë©‚Äçüé§ ü§úüèø üëÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ici, je vais parler du dispositif de l'un des nombreux outils qui aident au d√©veloppement de divers services pour le projet Odnoklassniki. Au sein de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Patch de code Java sur la production sans anesth√©sie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/429040/"><img src="https://habrastorage.org/webt/di/gh/wc/dighwcvw92d2zysgdcdref8_ptg.png" alt="image"><br><br>  Ici, je vais parler du dispositif de l'un des nombreux outils qui aident au d√©veloppement de divers services pour le projet Odnoklassniki.  Au sein de l'entreprise, nous l'appelons ¬´Hot Code Replace¬ª (HCR), et cet outil est con√ßu pour corriger les bogues critiques et simples dans l'ex√©cution des services de production sans les arr√™ter.  C'est une fonctionnalit√© extr√™mement importante, car elle vous permet d'√©viter le processus plut√¥t ennuyeux et long de disposer d'une nouvelle version corrig√©e du service ind√©sirable, d'√©viter la pause suffisamment longue de l'accompagnateur dans la disponibilit√© de chaque h√¥te et d'√©viter de vider les caches. <br><br>  En g√©n√©ral, cela fait gagner beaucoup de temps et r√©duit l'intervalle entre le moment o√π l'erreur est d√©tect√©e et la correction d'heures en minutes.  Le plus souvent, comme pr√©vu, des erreurs mineures dans le code sont corrig√©es, par exemple, le programmeur a oubli√© de v√©rifier la nullit√© et pour certains utilisateurs certaines actions sur le site entra√Ænent une erreur.  C'est-√†-dire lorsque la correction est effectu√©e en changeant plusieurs lignes dans la m√©thode.  Et pour des changements aussi mineurs, vous n'avez plus besoin de distraire vos coll√®gues et d'attendre des heures pour la production. <br><a name="habracut"></a><br>  Par exemple: <br><br><img src="https://habrastorage.org/webt/ra/dh/vz/radhvzc9u4d1q6dc8r4v6uhlekq.png" alt="image"><br>  Vous pouvez facilement le r√©parer sur: <br><br><img src="https://habrastorage.org/webt/rp/9i/ta/rp9itax-od_0ahz3yg8dxdxvf7u.png" alt="image"><br>  Bien s√ªr, vous pouvez apporter beaucoup plus de modifications, en m√™me temps ajouter de nouvelles classes, apporter rapidement des modifications que le gestionnaire demande en m√™me temps, sans attendre la prochaine mise √† jour.  Mais c'est d√©j√† le cas, si Monsieur en sait beaucoup sur les perversions. <br><br>  De plus, il est possible de mettre des "patchs" les uns sur les autres et √† l'infini. <br><br>  Mais cet outil n'est pas omnipotent et est bas√© sur la fonctionnalit√© standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">offerte par</a> la classe Java: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">java.lang.instrument.Instrumentation et sa m√©thode void redefineClasses (ClassDefinition ... d√©finitions)</a> . <br><br>  Instrumentation.redefineClasses remplace les classes pr√©c√©demment charg√©es par un nouveau code d'octet.  Vous pouvez surcharger plusieurs classes avec diff√©rentes d√©pendances en m√™me temps.  La surcharge ne modifie pas les instances de classe existantes, ne modifie pas l'h√©ritage et ne touche pas les champs d'instance ou de classe.  Vous ne pouvez modifier que le corps de la m√©thode, le pool de constantes et d'attributs.  Vous pouvez ajouter de nouvelles classes ou sous-classes.  Les signatures de m√©thode, les champs d'instance et les champs de classe ne peuvent pas √™tre modifi√©s.  Si vous essayez d'apporter des modifications incompatibles, redefineClasses ne fonctionnera en principe pas et g√©n√©rera une erreur.  Il faut se rappeler que lorsque les classes sont surcharg√©es, l'ex√©cution de la section de code surcharg√©e n'est pas interrompue, le nouveau bytecode sera utilis√© la prochaine fois que la m√™me m√©thode sera appel√©e.  Et par cons√©quent, si vous essayez de corriger le code d'une m√©thode qui contient un cycle infiniment long, le remplacement r√©el n'aura lieu qu'apr√®s la fin de ce cycle. <br><br>  Si tout simplement: vous ne pouvez changer le code qu'√† l'int√©rieur des m√©thodes et du point. <br><br>  Et voici un exemple de boucle while, qui jusqu'√† la fin de la m√©thode, ne sera pas corrig√©e. <br><br><img src="https://habrastorage.org/webt/p7/rv/1a/p7rv1agfvd0f7phg4otdxedkohk.png" alt="image"><br><br>  La principale difficult√© a √©t√© de cr√©er un outil qui fonctionne dans l'√©cosyst√®me Odnoklassniki, un outil qui s'int√®gre dans tous les processus de travail √©tablis.  Qui interagira de mani√®re coh√©rente et transparente avec tous les services sur des centaines d'h√¥tes, tout en √©tant flexible et facile √† utiliser.  Cet outil devrait faire face √† des dizaines d'exp√©riences, de travaux et de mises √† jour qui se produisent en continu sur la production. <br><br>  √Ä quoi ressemble le processus d'installation d'un correctif du point de vue d√©veloppeur / administrateur essayant de corriger un bogue en production, mais pour qu'il puisse √™tre fait en utilisant une proc√©dure standard et fiable sur des dizaines de serveurs.  Nous omettons le processus de recherche et de correction des erreurs dans le code. <br><br>  1. Un brunch s√©par√© est cr√©√© dans GIT pour les corrections de code.  L'utilisation de la gestion des versions est tr√®s importante non seulement pour des raisons de commodit√©, mais aussi pour d'√©ventuelles investigations ult√©rieures. <br><br>  2. TeamCity lance le processus de construction du patch.  Tout d'abord, un assemblage de projet est cr√©√© √† partir du brunch sp√©cifi√©, puis le nouvel assemblage est compar√© √† celui install√© sur la production.  Pour ce faire, j'ai √©crit un plug-in pour l'outil de construction, qui extrait tous les fichiers des archives, compare les √©carts et s√©lectionne uniquement les fichiers qui ont √©t√© modifi√©s ou ajout√©s.  Dans ce cas, la version du compilateur Java dans les deux assemblys doit √™tre la m√™me, car  une autre version du compilateur cr√©era des fichiers diff√©rents et presque tous les fichiers de projet seront inclus dans le patch.  Il est tr√®s important de cr√©er juste une petite archive, dans laquelle seuls les fichiers n√©cessaires seront r√©cup√©r√©s, car  Cela acc√©l√©rera consid√©rablement le processus de livraison du correctif √† des dizaines de serveurs.  Le processus de g√©n√©ration convient non seulement au correctif du code du projet, mais vous pouvez √©galement remplacer la biblioth√®que corrig√©e dans le projet.  Lors de la comparaison du contenu de deux assemblys, des diff√©rences seront trouv√©es dans les biblioth√®ques (fichiers jar). <br><br>  3. En cas d'assemblage r√©ussi, le correctif est envoy√© vers un r√©f√©rentiel sp√©cial et dans la fen√™tre de r√©sultat, une cl√© (ou un hachage) est √©mise, ce qui est n√©cessaire pour identifier le correctif de mani√®re unique et garantir que ce code parviendra √† la production. <br><br><img src="https://habrastorage.org/webt/7v/c5/es/7vc5esvpyls4kbc-djqnyxp5owq.png" alt="image"><br><br>  Eh bien, et encore - vous pouvez patcher un nombre illimit√© de fois et les builds avec le m√™me num√©ro de version diff√©reront d'un hachage. <br><br>  4. Ensuite, toutes les activit√©s sont transf√©r√©es vers le service de configuration, o√π dans l'interface utilisateur habituelle, vous pouvez sp√©cifier pour quel service, sur quels h√¥tes et quelles versions d'applications vous devez patcher. <br><br><img src="https://habrastorage.org/webt/pd/qf/um/pdqfummd7yqcqr0igjjbdshtnqk.png" alt="image"><br><br>  Une telle abondance de param√®tres donne le niveau n√©cessaire de flexibilit√© des param√®tres, ce qui est tr√®s important dans un grand zoo √† partir de nombreux serveurs.  Disons que sur une partie des serveurs, le num√©ro de version de l'application est diff√©rent, et vous n'avez pas du tout besoin de patcher ce code.  Ou, pour v√©rification, Hot Code Rreplace est d'abord lanc√© sur un serveur ou sur un groupe de serveurs, puis distribu√© sur toutes les instances de l'application. <br><br>  5. Gr√¢ce √† une modification de configuration, les services s√©lectionn√©s re√ßoivent des informations sur ce que le correctif doit √™tre install√©, sa version et le hachage de v√©rification.  L'id√©e est que tous les services re√ßoivent la commande ¬´installer le patch¬ª et agissent ensuite ind√©pendamment.  Ils comparent ind√©pendamment leur propre version et uniquement si la version correspond et que le hachage du correctif est manquant ou diff√©rent, ils t√©l√©chargent ind√©pendamment l'assembly du correctif √† partir du r√©f√©rentiel.  Le processus de t√©l√©chargement lui-m√™me a lieu via HTTP et vous pouvez modifier rapidement l'adresse du r√©f√©rentiel, le nombre de tentatives de t√©l√©chargement et la p√©riode d'attente entre les tentatives. <br><br>  6. Chaque application v√©rifie localement le hachage de l'assembly et le d√©compresse.  Dans ce cas, chaque fichier est v√©rifi√© pour sa pr√©sence dans le tableau parmi ceux renvoy√©s par Instrumentation.getAllLoadedClasses (), toutes les nouvelles classes et tous les nouveaux fichiers sont √©crits dans un nouveau - un chemin de classe temporaire, et ce chemin de classe est ajout√© via Instrumentation.appendToSystemClassLoaderSearch (), et les classes existantes sont lues en m√©moire et passer par la m√©thode redefineClasses. <br><br>  7. L'ensemble du processus: l'arriv√©e d'un signal sur la n√©cessit√© de patcher l'application, son t√©l√©chargement, sa v√©rification, son d√©ballage et son application sont enregistr√©s en d√©tail, √† la fois dans le journal g√©n√©ral avec l'application et dans le sien, afin que vous puissiez rapidement et sans gestes inutiles surveiller le processus. <br><br>  8. Une fois le correctif appliqu√©, le processus se termine en rempla√ßant la version de l'application par celle corrig√©e en ajoutant une ligne sp√©cialement compos√©e comprenant le hachage du correctif.  Dans le cas o√π pour certains h√¥tes la version n'a pas chang√© pour la version attendue, nous allons dans le journal de remplacement de code √† chaud pour cet h√¥te et voyons ce qui s'y est pass√©.  S'il s'agissait de probl√®mes de communication, vous pouvez r√©p√©ter la commande de patch en toute s√©curit√© et l'h√¥te souhait√© r√©essaiera. <br><br>  Quels probl√®mes possibles peuvent emp√™cher l'application de patcher?  Il y en a pas mal, et parmi eux la fonctionnalit√© de la classe Instrumentation que je mettrais en dernier lieu.  Jusqu'√† pr√©sent, le code tordu qui ne remplit pas les conditions strictes de redefineClasses a toujours √©t√© flash√© par la JVM sans aucune cons√©quence pour l'application.  Lors de l'application de la m√©thode redefineClasses, la JVM arr√™te compl√®tement l'application, mais ce processus prend une fraction de seconde.  Parce que ce n'est pas du tout effrayant. <br><br>  Le moment le plus risqu√© est la livraison du correctif au serveur, qui a √©t√© d√©cid√©e par des recyclages suppl√©mentaires.  Mais si les retrays ne vous aident pas, vous pouvez r√©p√©ter la commande pour appeler le correctif et chacun des h√¥tes essaiera de r√©p√©ter le processus, mais installez le correctif uniquement si n√©cessaire, c'est-√†-dire  le correctif n'a pas √©t√© install√© pr√©c√©demment ou si la cl√© de hachage a chang√©. <br><br>  Un autre probl√®me potentiel est lorsque le correctif corrige une erreur et en ajoute une nouvelle.  Pour minimiser ce risque, nous t√©l√©chargeons d'abord le correctif sur un nombre limit√© de serveurs, examinons les journaux, les graphiques et surveillons le r√©sultat.  Et seulement alors, nous d√©ployons des corrections vers d'autres h√¥tes. <br><br>  Que faire avec le red√©marrage d'une application ou d'un serveur?  Ceci est d√©j√† int√©gr√© dans la logique de toutes les applications de camarade de classe: l'un des premiers dans n'importe quelle application est le module HCR.  Et si lors de l'initialisation des informations sur la n√©cessit√© de patcher l'application sont remarqu√©es, le patch sera appliqu√© en premier. <br><br>  Et maintenant, en quoi consiste le remplacement de code √† chaud. <br><br><ol><li>  Notre JavaAgent.  JavaAgent, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">si quelqu'un l'a oubli√©</a> , il s'agit d'une archive * .jar distincte et sp√©cialement form√©e qui est r√©cup√©r√©e par la JVM lorsque l'application commence √† utiliser un param√®tre suppl√©mentaire, par exemple: -javaagent: /path/to/lib/my-agent.jar Gr√¢ce aux fonctionnalit√©s suppl√©mentaires de Javaagent- et il est possible d'utiliser la magie de remplacement de code.  C'est dans l'agent que la classe java.lang.instrument.Instrumentation est disponible.  Mais, je ne l'ai pas obstru√© (l'agent) avec du code suppl√©mentaire, car  La mise √† jour de l'agent est une t√¢che non triviale, mais a simplement d√©plac√© l'instance de la classe Instrumentation dans le champ statique de la classe utilitaire.  Ainsi, toutes les manipulations peuvent √™tre lanc√©es depuis n'importe o√π dans l'application. </li><li>  Service de configuration - est responsable de la configuration de l'une de nos applications et est donc initialis√© dans chaque application en premier.  C'est l√† que la fonctionnalit√© principale de Hot Code Replace est cach√©e.  Au d√©marrage de l'application ou lors de la modification de la configuration HCR pour une application particuli√®re, la compatibilit√© des versions est v√©rifi√©e et toutes les manipulations ci-dessus sont effectu√©es. </li><li>  TeamCity et cr√©er des scripts - pour cr√©er facilement des ¬´correctifs¬ª et n'y enregistrer que les classes et ressources modifi√©es ou ajout√©es. </li></ol><br>  Quels sont les avantages que nous avons de cet outil?  Le premier est la vitesse de correction des erreurs critiques dans le prod.  D'apr√®s les journaux, je constate que les coll√®gues ont progressivement commenc√© √† utiliser HCR de plus en plus souvent, au lieu d'attendre les versions.  Vient ensuite la vitesse d'application.  Il n'est pas n√©cessaire d'arr√™ter l'application, la JVM ne se fige qu'une fraction de seconde et tous vos objets restent √† leur place et continuent de fonctionner. <br><br>  Et nos d√©veloppeurs ont gu√©ri librement et joyeusement et ont corrig√© leurs erreurs imm√©diatement et ind√©pendamment directement en production sans tenir compte du nombre de serveurs et de la charge. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr429040/">https://habr.com/ru/post/fr429040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr429028/index.html">Korolev. M√©decine pour le web</a></li>
<li><a href="../fr429030/index.html">Logomachine cr√©e des logos gratuits par commentaire</a></li>
<li><a href="../fr429032/index.html">Splunk Essentials pour l'application Financial Services Industry, ou comment Splunk entre sur le march√© de l'analyse financi√®re</a></li>
<li><a href="../fr429034/index.html">Quelques histoires sur les programmeurs underground</a></li>
<li><a href="../fr429038/index.html">Rust News # 2 (octobre 2018)</a></li>
<li><a href="../fr429042/index.html">Nous testons SharxBase, une plate-forme de virtualisation logicielle et mat√©rielle du fournisseur russe SharxDC</a></li>
<li><a href="../fr429044/index.html">Les actions Apple ont connu la pire chute depuis 2014. Les grands investisseurs ont perdu des milliards</a></li>
<li><a href="../fr429046/index.html">Quatre ans de d√©veloppement de SObjectizer-5.5. Comment SObjectizer a-t-il chang√© pendant cette p√©riode?</a></li>
<li><a href="../fr429048/index.html">Conseils pour un h√©bergeur novice</a></li>
<li><a href="../fr429050/index.html">Attaque d'√©change de crypto-monnaie Gate.io enregistr√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>