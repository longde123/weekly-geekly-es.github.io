<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¥ üëåüèª ü§úüèø Domaine frontal bas√© sur TLS 1.3 üõ£Ô∏è üôãüèº üë®‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 

 Les syst√®mes modernes de filtrage de contenu d'entreprise de fabricants √©minents tels que Cisco, BlueCoat, FireEye ont beaucoup en com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Domaine frontal bas√© sur TLS 1.3</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475372/"><h3>  Pr√©sentation </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bn/0p/mv/bn0pmvrdjnyzw-hr4glj5lekpmk.png"></div><br>  Les syst√®mes modernes de filtrage de contenu d'entreprise de fabricants √©minents tels que Cisco, BlueCoat, FireEye ont beaucoup en commun avec leurs homologues plus puissants - les syst√®mes DPI qui sont intens√©ment mis en ≈ìuvre au niveau national.  L'essence du travail des deux est de rechercher le trafic Internet entrant et sortant et, sur la base de listes noires / blanches, de d√©cider d'interdire la connexion Internet.  Et comme les deux s'appuient sur des principes similaires dans les principes fondamentaux de leur travail, les moyens de les contourner auront √©galement beaucoup en commun. <br><br>  L'une des technologies qui permet de contourner efficacement les syst√®mes DPI et d'entreprise est la technologie orient√©e domaine.  Son essence r√©side dans le fait que nous allons vers une ressource bloqu√©e, cach√©e derri√®re une autre, domaine public, avec une bonne r√©putation, qui ne sera √©videmment bloqu√©e par aucun syst√®me, par exemple google.com. <br><br>  De nombreux articles ont d√©j√† √©t√© √©crits sur cette technologie et de nombreux exemples ont √©t√© donn√©s.  Cependant, les technologies DNS sur HTTPS et SNI chiffr√©, ainsi que les technologies r√©cemment discut√©es, ainsi que la nouvelle version du protocole TLS 1.3, offrent la possibilit√© d'envisager une autre variante de la gestion frontale de domaine. <br><a name="habracut"></a><br><h3>  Nous traitons avec la technologie </h3><br>  Tout d'abord, d√©cidons un peu des concepts de base pour que tout le monde comprenne qui est qui et pourquoi tout cela est n√©cessaire.  Nous avons mentionn√© le m√©canisme eSNI, dont le travail sera discut√© plus tard.  Le m√©canisme eSNI (encrypted Server Name Indication) est une version s√©curis√©e de SNI, disponible uniquement pour le protocole TLS 1.3.  Le point principal est de crypter, y compris les informations sur le domaine auquel la demande est envoy√©e. <br><br>  Voyons maintenant comment le m√©canisme eSNI fonctionne dans la pratique. <br><br>  Supposons que nous ayons une ressource Internet qui est bloqu√©e par une solution DPI moderne (prenez, par exemple, le c√©l√®bre tracker torrent - rutracker.nl).  Lorsque nous essayons d'acc√©der au site du tracker torrent, nous voyons le talon standard du fournisseur que la ressource est bloqu√©e: <br><br><img src="https://habrastorage.org/webt/hj/rt/kd/hjrtkdnlahnohjgs-tq-jzfctnu.png"><br><br>  Sur le site ILV, ce domaine est en effet r√©pertori√© dans les listes d'arr√™t: <br><br><img src="https://habrastorage.org/webt/4g/2m/k0/4g2mk0d4ks6xzbvmvv0za-vt16y.png"><br><br>  Lorsque vous demandez whois, vous pouvez voir que le domaine lui-m√™me est ¬´cach√©¬ª derri√®re le fournisseur de cloud Cloudflare. <br><br><img src="https://habrastorage.org/webt/my/wa/ki/mywakijkqem9a32jtmwyb0tcwfs.png"><br><br>  Mais contrairement aux ¬´sp√©cialistes¬ª d'ILV, les employ√©s les plus techniquement avertis de la ligne de conduite (ou enseign√©s par l'am√®re exp√©rience de notre c√©l√®bre r√©gulateur) n'ont pas b√™tement interdit le site par adresse IP, mais ont entr√© le nom de domaine dans la liste d'arr√™t.  C'est facile √† v√©rifier si vous regardez quels autres domaines se cachent derri√®re la m√™me adresse IP, visitez l'un d'eux et voyez que l'acc√®s n'est pas bloqu√©: <br><br><img src="https://habrastorage.org/webt/dk/j2/gk/dkj2gkveuqcbwkbumlrebfznt8u.png"><br><br>  Mais comment √ßa se passe?  Comment le fournisseur DPI d√©tecte-t-il les domaines vers lesquels mon navigateur se rend, car toutes les communications ont lieu via le protocole https, et nous ne semblons pas encore remarquer la substitution des certificats https de la ligne de bord?  Est-il clairvoyant ou est-il suivi par moi? <br><br>  Essayons de r√©pondre √† cette question en examinant le trafic via Wirehark <br><br><img src="https://habrastorage.org/webt/c1/k2/9e/c1k29ehqnytwfvw8udk-m6mkv6q.png"><br><br>  La capture d'√©cran montre que le navigateur re√ßoit d'abord l'adresse IP du serveur via DNS, puis il y a une n√©gociation TCP standard avec le serveur de destination, puis le navigateur tente d'√©tablir une connexion SSL avec le serveur.  Pour ce faire, il envoie le paquet SSL Client Hello, qui contient le nom de domaine source en texte clair.  Ce champ est requis par le serveur frontal cloudflare afin de router correctement la connexion.  C'est l√† que le fournisseur DPI nous attrape, rompant notre connexion.  Dans le m√™me temps, nous ne recevons aucun talon du fournisseur, et nous voyons une erreur de navigateur standard comme si le site √©tait d√©connect√© ou ne fonctionnait tout simplement pas: <br><br><img src="https://habrastorage.org/webt/tn/8h/fa/tn8hfavie40wl2qqiogrdqrxptw.png"><br><br>  Maintenant, activons le m√©canisme eSNI dans le navigateur, comme d√©crit dans les instructions pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://miketabor.com/enable-dns-over-">Firefox</a> : <br>  Pour ce faire, nous ouvrons la page de configuration de Firefox <b>sur: config</b> et activons les param√®tres suivants: <br><br><pre><code class="plaintext hljs">network.trr.mode = 2; network.trr.uri = https://mozilla.cloudflare-dns.com/dns-query network.security.esni.enabled = true</code> </pre> <br>  Apr√®s cela, nous v√©rifierons l'exactitude des param√®tres sur le site Web cloudflare en utilisant le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> et r√©essayerons le focus avec notre tracker torrent. <br><br><img src="https://habrastorage.org/webt/p6/o3/o-/p6o3o-zt1k8yqi4ht_rcrxugyfg.png"><br><br>  Voila.  Notre tracker pr√©f√©r√© s'est ouvert sans VPN ni proxy.  Regardons maintenant le vidage de trafic dans Wireshark, ce qui s'est pass√©. <br><br><img src="https://habrastorage.org/webt/ll/az/gj/llazgjig0xbha6ndnlvj0nqvziw.png"><br><br>  Cette fois, le package hello du client ssl ne contient pas explicitement le domaine de destination, mais un nouveau champ est apparu dans le package - encrypted_server_name - c'est l√† que la valeur de rutracker.nl est contenue, et seul le serveur cloudflare frontal peut d√©crypter ce champ.  Et si c'est le cas, le fournisseur DPI n'a d'autre choix que de se laver les mains et d'autoriser un tel trafic.  Mais il n'y a pas d'autres options de cryptage. <br><br>  Donc, comment la technologie fonctionne dans le navigateur - nous avons regard√©.  Essayons maintenant de l'appliquer pour des choses plus sp√©cifiques et int√©ressantes.  Et pour commencer, nous enseignerons la m√™me boucle pour utiliser eSNI pour travailler avec TLS 1.3, et en m√™me temps, nous verrons comment le domaine frontal bas√© sur eSNI lui-m√™me fonctionne. <br><br><h3>  Frontend de domaine avec eSNI </h3><br>  √âtant donn√© que curl utilise la biblioth√®que openssl standard pour se connecter via https, nous devons tout d'abord y fournir un support eSNI.  Il n'y a pas encore de support pour eSNI dans les branches master openssl, nous devons donc t√©l√©charger la branche openssl sp√©ciale, la compiler et l'installer. <br><br>  Nous clonons le d√©p√¥t depuis le github et compilons comme d'habitude: <br><br><pre> <code class="plaintext hljs">$ git clone https://github.com/sftcd/openssl $ cd openssl $ ./config $ make $ cd esnistuff $ make</code> </pre><br>  Ensuite, nous clonons le r√©f√©rentiel avec curl et configurons sa compilation √† l'aide de notre biblioth√®que openssl assembl√©e: <br><br><pre> <code class="plaintext hljs">$ cd $HOME/code $ git clone https://github.com/niallor/curl.git curl-esni $ cd curl-esni $ export LD_LIBRARY_PATH=/opt/openssl $ ./buildconf $ LDFLAGS="-L/opt/openssl" ./configure --with-ssl=/opt/openssl --enable-esni --enable-debug</code> </pre><br>  Ici, il est important d'indiquer correctement tous les r√©pertoires o√π se trouve openssl (dans notre cas, c'est / opt / openssl /) et assurez-vous que le processus de configuration se passe sans erreur. <br><br>  En cas de configuration r√©ussie, nous verrons la ligne: <br><br>  <b>AVERTISSEMENT: esni ESNI activ√© mais marqu√© EXP√âRIMENTAL.</b>  <b>√Ä utiliser avec prudence!</b> <br><br><pre> <code class="plaintext hljs">$ make</code> </pre> <br>  Apr√®s avoir construit le package avec succ√®s, nous utiliserons un fichier bash openssl sp√©cial pour configurer et ex√©cuter curl.  Copiez-le dans le r√©pertoire avec curl pour plus de commodit√©: <br><br><pre> <code class="plaintext hljs">cp /opt/openssl/esnistuff/curl-esni</code> </pre> <br>  et ex√©cutez une demande de test https sur le serveur cloudflare, tout en √©crivant simultan√©ment des paquets DNS et TLS dans Wireshark. <br><br><pre> <code class="plaintext hljs">$ ESNI_COVER="www.hello-rkn.ru" ./curl-esni https://cloudflare.com/</code> </pre> <br>  Dans la r√©ponse du serveur, en plus des nombreuses informations de d√©bogage d'OpenSL et de Curl, nous obtenons une r√©ponse HTTP avec le code 301 de Cloudflare. <br><br><pre> <code class="plaintext hljs">HTTP/1.1 301 Moved Permanently &lt; Date: Sun, 03 Nov 2019 13:12:55 GMT &lt; Transfer-Encoding: chunked &lt; Connection: keep-alive &lt; Cache-Control: max-age=3600 &lt; Expires: Sun, 03 Nov 2019 14:12:55 GMT &lt; Location: https://www.cloudflare.com/</code> </pre><br>  ce qui indique que notre demande a √©t√© envoy√©e avec succ√®s au serveur de destination, entendue et trait√©e. <br><br>  Maintenant, regardons le vidage du trafic dans Wireshark, c'est-√†-dire  ce que le fournisseur DPI a vu dans ce cas. <br><br><img src="https://habrastorage.org/webt/sp/va/-o/spva-ogjvtwlfyiea9vg4n8qbla.png"><br><br>  On peut voir que la premi√®re boucle s'est tourn√©e vers le serveur DNS pour une cl√© eSNI publique pour le serveur cloudflare - demande DNS TXT √† _esni.cloudflare.com (package n ¬∞ 13).  Ensuite, √† l'aide de la biblioth√®que openssl, curl a envoy√© une requ√™te TLS 1.3 au serveur cloudflare dans lequel le champ SNI a √©t√© chiffr√© avec la cl√© publique obtenue √† l'√©tape pr√©c√©dente (package n ¬∞ 22).  <b>Mais, en plus du champ eSNI, dans le cadre du package SSL-hello, un champ a √©galement √©t√© ins√©r√© avec l'habituel - SNI ouvert, que nous pouvons sp√©cifier dans n'importe quel ordre (dans ce cas - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.hello-rkn.ru</a> ).</b> <br><br>  Ce champ de la SNI ouverte n'a pas √©t√© pris en compte lors du traitement par les serveurs cloudflare et n'√©tait qu'un d√©guisement pour le fournisseur DPI.  Le serveur cloudflare a re√ßu notre paquet ssl-hello, a d√©chiffr√© l'eSNI, en a extrait le SNI d'origine et l'a trait√© comme si de rien n'√©tait (il a tout fait exactement comme pr√©vu lors du d√©veloppement d'eSNI). <br><br>  La seule chose dans ce cas, vous pouvez vous accrocher en termes de DPI - la requ√™te DNS principale sur _esni.cloudflare.com.  Mais nous avons ouvert la requ√™te DNS uniquement pour montrer comment ce m√©canisme fonctionne de l'int√©rieur. <br><br>  Pour enfin √©liminer le sol sous le DPI, nous utilisons le m√©canisme DNS-over-HTTPS d√©j√† mentionn√©.  Une petite explication - DOH - un protocole qui vous permet de vous prot√©ger d'un homme dans l'attaque du milieu en envoyant une requ√™te DNS via HTTPS. <br><br>  Nous ex√©cuterons √† nouveau la demande, mais cette fois, nous obtiendrons les cl√©s publiques eSNI en utilisant le protocole https, pas le DNS: <br><br><pre> <code class="plaintext hljs">ESNI_COVER="www.hello-rkn.ru" DOH_URL=https://mozilla.cloudflare-dns.com/dns-query ./curl-esni https://cloudflare.com/</code> </pre> <br>  Le vidage du trafic de demande est pr√©sent√© dans la capture d'√©cran ci-dessous: <br><br><img src="https://habrastorage.org/webt/qz/0m/ky/qz0mky5bwnmguhwleqennudeupc.png"><br><br>  On voit que la premi√®re boucle acc√®de au serveur mozilla.cloudflare-dns.com en utilisant le protocole DoH (connexion https au serveur 104.16.249.249) pour obtenir d'eux des valeurs de cl√© publique pour le cryptage SNI, puis au serveur de destination, se cachant sous le domaine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.hello-rkn.ru</a> . <br><br>  En plus du r√©solveur DoH de mozilla.cloudflare-dns.com sp√©cifi√© ci-dessus, nous pouvons utiliser d'autres services DoH populaires, par exemple, de la c√©l√®bre evil corporation. <br>  Nous ex√©cutons la demande suivante: <br><br><pre> <code class="plaintext hljs">ESNI_COVER="www.kremlin.ru" DOH_URL=https://dns.google/dns-query ./curl-esni https://rutracker.nl/</code> </pre> <br>  Et nous obtenons la r√©ponse: <br><br><pre> <code class="plaintext hljs">&lt; HTTP/1.1 301 Moved Permanently &lt; Date: Sun, 03 Nov 2019 14:10:22 GMT &lt; Content-Type: text/html &lt; Transfer-Encoding: chunked &lt; Connection: keep-alive &lt; Set-Cookie: __cfduid=da0144d982437e77b0b37af7d00438b1a1572790222; expires=Mon, 02-Nov-20 14:10:22 GMT; path=/; domain=.rutracker.nl; HttpOnly; Secure &lt; Location: https://rutracker.nl/forum/index.php &lt; CF-Cache-Status: DYNAMIC &lt; Expect-CT: max-age=604800, report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct" &lt; Server: cloudflare &lt; CF-RAY: 52feee696f42d891-CPH</code> </pre><br><img src="https://habrastorage.org/webt/dk/xk/b-/dkxkb-cudflzhgaxaebb1xhd9bw.png"><br><br>  Dans ce cas, nous nous sommes tourn√©s vers le serveur bloqu√© rutracker.nl, en utilisant le r√©solveur dns.google DoH (il n'y a pas de faute de frappe, maintenant la c√©l√®bre soci√©t√© a son propre domaine de premier niveau) et nous nous sommes couverts avec un autre domaine, qui est strictement interdit par tous les DPI pour bloquer par crainte de la peine de mort.  Selon la r√©ponse, vous pouvez comprendre que notre demande a √©t√© trait√©e avec succ√®s. <br><br>  Comme v√©rification suppl√©mentaire que le fournisseur DPI r√©pond √† une SNI ouverte, que nous transmettons comme couverture - nous pouvons ex√©cuter une demande √† rutracker.nl derri√®re une autre ressource interdite, par exemple, un autre "bon" tracker de torrent: <br><br><pre> <code class="plaintext hljs">$ ESNI_COVER="rutor.info" DOH_URL=https://dns.google/dns-query ./curl-esni https://rutracker.nl/</code> </pre> <br>  Nous ne recevrons pas de r√©ponse du serveur, car  notre demande sera bloqu√©e par le syst√®me DPI. <br><br><h3>  Une petite conclusion √† la premi√®re partie </h3><br>  Nous avons donc pu montrer la sant√© d'eSNI en utilisant openssl et curl et tester le fonctionnement du front-end bas√© sur un domaine bas√© sur eSNI.  De la m√™me mani√®re, nous pouvons adapter nos outils pr√©f√©r√©s √† l'aide de la biblioth√®que openssl pour travailler ¬´sous couvert¬ª d'autres domaines.  Plus d'informations √† ce sujet dans nos prochains articles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475372/">https://habr.com/ru/post/fr475372/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475354/index.html">Bonne journ√©e des sp√©cialistes de la s√©curit√©</a></li>
<li><a href="../fr475358/index.html">Analyse des salaires dans le secteur informatique de l'Arm√©nie plus les postes vacants dans les TOP10 entreprises informatiques</a></li>
<li><a href="../fr475366/index.html">Droidcon London 2019: nouvelles tendances et rapports les plus int√©ressants</a></li>
<li><a href="../fr475368/index.html">Comment calculer l'efficacit√© de la publicit√©</a></li>
<li><a href="../fr475370/index.html">Algorithme de Kahan: comment obtenir la diff√©rence exacte des produits</a></li>
<li><a href="../fr475378/index.html">¬´Nous ne pouvons pas laisser le droit aux donn√©es personnelles aux grandes entreprises¬ª - ancien r√©dacteur en chef de Wired UK sur l'avenir de la technologie</a></li>
<li><a href="../fr475384/index.html">Quoi de neuf dans Spring Boot 2.2?</a></li>
<li><a href="../fr475386/index.html">Attention, SAF: comment ne pas enfreindre la loi sur la publicit√©. M√©mo de l'annonceur</a></li>
<li><a href="../fr475390/index.html">Comment cr√©er votre premi√®re application Web √† l'aide de Go</a></li>
<li><a href="../fr475392/index.html">Pourquoi utiliser python -m pip</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>