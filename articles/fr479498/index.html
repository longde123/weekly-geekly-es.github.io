<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîî üë®‚ÄçüöÄ üëì Comment le temps lin√©aire se transforme en Windows en O (n¬≤) ‚ô®Ô∏è üî§ üßïüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'ai r√©cemment rencontr√© des retards de plusieurs minutes sur mon poste de travail. Apr√®s l'enqu√™te, il s'est av√©r√© que la cause du probl√®me √©tait une...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment le temps lin√©aire se transforme en Windows en O (n¬≤)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479498/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41c/2e8/f34/41c2e8f34752be4805fac21fec9b9ae0.png" alt="image"></div><br>  J'ai r√©cemment rencontr√© des retards de plusieurs minutes sur mon poste de travail.  Apr√®s l'enqu√™te, il s'est av√©r√© que la cause du probl√®me √©tait une serrure, qui pouvait durer cinq minutes, pendant laquelle la source de la serrure tournait essentiellement en un cycle de neuf instructions. <br><br>  Il est tr√®s important pour moi de s√©lectionner de bonnes rubriques pour mes messages, mais je me suis tout de suite souvenu que le nom appropri√© "48 c≈ìurs sont bloqu√©s par neuf instructions" avait <a href="https://randomascii.wordpress.com/2019/10/20/63-cores-blocked-by-seven-instructions/" rel="nofollow">d√©j√†</a> √©t√© <a href="https://randomascii.wordpress.com/2019/10/20/63-cores-blocked-by-seven-instructions/" rel="nofollow">repris</a> par un post √©crit il y a moins d'un mois.  Le nombre de processeurs bloqu√©s est diff√©rent et le cycle est un peu plus long, mais en fait, tout cela vous fait ressentir le d√©j√†-vu.  Par cons√©quent, pendant que j'explique le nouveau probl√®me trouv√©, je voulais r√©fl√©chir √† la <em>raison</em> pour <em>laquelle cela se produit tout le temps</em> . <br><br><h2>  Pourquoi cela se produit-il? </h2><br>  Grosso modo, de tels probl√®mes surviennent √† la suite d'une observation que j'appellerai <em>la premi√®re loi de Dawson sur l'informatique:</em> <a href="https://twitter.com/BruceDawson0xB/status/1120381406700429312" rel="nofollow">O (n <sup>2</sup> ) est un aimant pour les algorithmes qui ne s'adaptent pas bien</a> : ils sont assez rapides pour entrer en production, mais assez lents pour tout g√¢cher, quand ils y arrivent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bea/017/fb8/bea017fb89b90af6566d8ad77298efb9.png"></div><br>  <i>O (n <sup>2</sup> ) en action - donn√©es extraites de mon cas</i> <br><a name="habracut"></a><br>  Que se passe-t-il?  Le d√©veloppeur √©crit le code et utilise l'algorithme O (n <sup>2</sup> ).  Peut-√™tre qu'il ne s'en rend pas compte, ou que l'algorithme devient O (n <sup>2</sup> ) √† <a href="https://randomascii.wordpress.com/2019/04/21/on2-in-createprocess/" rel="nofollow">cause d'un bug</a> , ou que le d√©veloppeur sait qu'il est O (n <sup>2</sup> ), mais il pense que cela ne sera jamais important.  Dans des conditions de laboratoire, la vitesse du code est acceptable, et acceptable pour la plupart des utilisateurs dans le monde r√©el, mais quelqu'un cr√©e alors <a href="https://randomascii.wordpress.com/2018/10/15/making-windows-slower-part-2-process-creation/" rel="nofollow">7 000 processus</a> avec App Verifier activ√© ou cr√©e un <a href="https://randomascii.wordpress.com/2019/04/21/on2-in-createprocess/" rel="nofollow">fichier binaire avec 180 000 √©l√©ments CFG</a> , ou collecte une DLL si volumineuse qu'elle est <a href="https://connect.microsoft.com/VisualStudio/feedback/details/1064219/ltcg-linking-of-chromes-pdf-dll-spends-60-of-time-in-c2-dll-ssrfree" rel="nofollow">constamment une liste √† liaison unique est analys√©e</a> , ce qui prend tout le processeur.  En travaillant sur l'heure de lancement du moteur Valve Source 2, j'ai trouv√© de <em>nombreux</em> algorithmes O (n <sup>2</sup> ), chacun ajoutant environ 30 secondes √† l'heure de lancement du moteur, c'est-√†-dire que ce probl√®me se produit avec des d√©veloppeurs tr√®s diff√©rents. <br><br>  <em>O (n <sup>2</sup> ) est un aimant pour les algorithmes qui ne s'adaptent pas bien: ils sont assez rapides pour entrer en production, mais assez lents pour tout g√¢cher lorsqu'ils y arrivent.</em> <br><br>  Exactement. <br><br>  Par exemple, la <a href="https://randomascii.wordpress.com/2018/10/15/making-windows-slower-part-2-process-creation/" rel="nofollow">cr√©ation de noms de fichiers journaux App Verifier est effectu√©e en temps lin√©aire</a> pour chaque processus en cours d'ex√©cution, ce qui est normal jusqu'√† ce que vous r√©alisiez que cela conduit √† O (n <sup>2</sup> ) si de nombreux processus sont en cours d'ex√©cution.  Parfois, il n'est m√™me pas √©vident qu'il existe des boucles imbriqu√©es, ou <em>formellement,</em> ce n'est pas O (n <sup>2</sup> ), ou il n'est pas √©vident que les boucles puissent fonctionner si longtemps qu'elles peuvent affecter de mani√®re significative la vitesse ... <br><br>  Consid√©rez donc cette opportunit√©, pensez-y lors de l'√©criture de code, surveillez la fa√ßon dont les performances sont mises √† l'√©chelle sous de lourdes charges et examinez les sections suspectes de code lors du profilage de telles charges.  Ou laissez-le-moi afin que je puisse les rechercher et √©crire des articles sur mon blog. <br><br><h2>  Revenons √† nos plaintes habituelles </h2><br>  Comme d'habitude, j'ai travaill√© sur mon poste de travail obsol√®te mais toujours puissant avec 48 processeurs logiques et 96 Go de RAM.  J'ai introduit le <em>chrome ninja</em> pour construire Chrome, mais ... rien ne s'est pass√©.  J'ai regard√© et j'ai attendu vingt secondes, mais l'assemblage n'a jamais commenc√©.  Alors, bien s√ªr, je suis pass√© √† <a href="https://randomascii.wordpress.com/2015/09/01/xperf-basics-recording-a-trace-the-ultimate-easy-way/" rel="nofollow"><em>UIforETW</em></a> pour enregistrer la trace <a href="https://randomascii.wordpress.com/2015/09/24/etw-central/" rel="nofollow"><em>ETW</em></a> .  Plus pr√©cis√©ment, j'ai essay√© de le faire.  En essayant de d√©marrer l'enregistrement de trace, <em>UIforETW se bloque</em> .  Pour la premi√®re fois dans ma pratique, un bug a utilis√© des mesures de protection pour m'emp√™cher de l'explorer! <br><br>  Apr√®s une ou deux minutes, l'assemblage de Chromium a commenc√© et <em>UIforETW a</em> commenc√© la trace, mais il a commenc√© trop tard et je n'avais pas la moindre information sur ce qui s'√©tait pass√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/485/76e/b86/48576eb86c46f3254d1b891d180cc25e.png"></div><br>  <i>Options UIforETW avec suivi de tampon circulaire s√©lectionn√©</i> <br><br>  Lorsque la m√™me chose s'est produite quelques jours plus tard, <em>UIforETW n'a de</em> nouveau pu rien faire.  Cette fois, j'ai laiss√© la trace fonctionner dans des tampons de m√©moire circulaires, pour √™tre pr√©par√© au fait que le blocage se produirait pour la troisi√®me fois.  Cependant, cela a consid√©rablement r√©duit la vitesse de mes outils de construction, donc apr√®s quelques heures, j'ai abandonn√©. <br><br>  Puis cette situation s'est r√©p√©t√©e √† <em>nouveau</em> .  Cette fois, j'ai ex√©cut√© l'outil de <a href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-recorder" rel="nofollow"><em>journalisation de</em></a> trace ETW cr√©√© par Microsoft - <a href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-recorder" rel="nofollow"><em>wprui</em></a> , et j'ai pu commencer l'enregistrement.  Environ 40 secondes plus tard, l'assemblage a commenc√© √† fonctionner et j'ai eu une trace! <br><br><h2>  Puis-je commencer l'enqu√™te maintenant? </h2><br>  Plus t√¥t, j'ai remarqu√© dans le "Gestionnaire des t√¢ches" que <em>WinMgmt.exe s'ex√©cutait</em> pendant ces <em>blocages</em> .  Apr√®s avoir examin√© les donn√©es d'utilisation pr√©cise du processeur dans WPA, j'√©tais convaincu qu'apr√®s plus de quarante secondes, pendant lesquelles <em>WinMgmt.exe</em> √©tait presque le seul processus de travail, ma machine a pris vie apr√®s l' <em>arr√™t de WinMgmt.exe</em> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/02a/cd4/35d/02acd435d1b3dec571ae9ebb5b56b67a.png"></div><br>  <i>Nous attendons l'√©veil des processus une fois WinMgmt.exe termin√©</i> <br><br>  Tout cela est plut√¥t suspect, mais mes sages lecteurs savent que ¬´apr√®s¬ª ne signifie pas ¬´en raison de¬ª et n√©cessiteront des preuves. <br><br>  Comme la <a href="https://randomascii.wordpress.com/2019/10/20/63-cores-blocked-by-seven-instructions/" rel="nofollow">derni√®re fois</a> , j'ai approxim√© le moment du d√©verrouillage sur le graphique, en triant les commutateurs de contexte par <em>Switch-In Time</em> et en recherchant le premier commutateur avec une longue dur√©e <em>depuis la derni√®re</em> valeur (indiquant la dur√©e pendant laquelle le thread n'a pas √©t√© ex√©cut√©).  Apr√®s avoir rat√© une douzaine de threads qui n'√©taient que des temps d'arr√™t courts, j'ai trouv√© le premier de nombreux qui a attendu 41,57 secondes.  Le thread endormi n'a pas r√©veill√© <em>WinMgmt.exe</em> , mais j'ai rapidement d√©couvert qu'il s'est r√©veill√© avec le thread qui a r√©veill√© <em>WinMgmt.exe</em> une fraction de milliseconde auparavant. <br><br><blockquote>  Pour une explication des graphiques d'utilisation du processeur (pr√©cis) et des concepts de thread de pr√©paration / nouveau thread, consultez <a href="https://randomascii.wordpress.com/2012/05/05/xperf-wait-analysisfinding-idle-time/" rel="nofollow">ce didacticiel</a> ou <a href="https://randomascii.wordpress.com/2012/05/11/the-lost-xperf-documentationcpu-scheduling/" rel="nofollow">cette documentation</a> . </blockquote><br>  Dans la capture d'√©cran avec les donn√©es de changement de contenu, la ligne 17 contient le flux <em>72 748 (WinMgmt.exe)</em> , qui active le flux <em>74 156 (svchost.exe).</em>  Ensuite, √† la ligne 19, le thread <em>74 156 (svchost.exe)</em> active le thread <em>58 704 (svchost.exe)</em> , qui attendait 41,57 secondes.  C'est le premier fil qui se r√©veille apr√®s un long sommeil et de l√† continue la cha√Æne d'activation des flux.  Les threads qui viennent d'√™tre activ√©s peuvent √™tre vus dans la colonne <em>New Thread Id</em> , puis descendre quelques lignes et les voir dans la colonne <em>Readying Thread Id</em> , en activant un autre thread.  Les noms et les ID de processus vous aident √† comprendre le contexte.  La ligne 17 est associ√©e aux lignes 18 et 19, la ligne 19 est associ√©e √† 20, qui est associ√©e √† la ligne 23, qui est associ√©e √† la ligne 27, et ainsi de suite;  chaque fil est activ√© par le fil pr√©c√©dent de la cha√Æne: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41c/2e8/f34/41c2e8f34752be4805fac21fec9b9ae0.png"></div><br>  <i>Le monstre se r√©veille - de longs fils inactifs prennent vie</i> <br><br>  41.57 est long √† bloquer un thread, mais en r√©alit√© des centaines de threads ont √©t√© bloqu√©s, et ils ont √©t√© bloqu√©s <em>beaucoup</em> plus longtemps.  La seule raison pour laquelle leur valeur <em>Time Since Last</em> est d'environ 41,5 secondes est que la longueur de la trace avant le blocage est r√©solue. <br><br>  Il semble que les r√©sultats soient conformes √† la th√©orie selon laquelle le probl√®me se situe dans <em>WinMgmt.exe</em> , mais ils ne le prouvent pas.  Ma confiance a augment√© lorsque j'ai regard√© <em>svchost.exe (3024)</em> dans <em>Trace-&gt; Configuration syst√®me-&gt; Services</em> et d√©couvert qu'il s'agit d'un service <em>Winmgmt</em> , mais j'avais encore besoin de plus de certitude. <br><br>  Apr√®s avoir fouill√© un peu plus (errant en avant et en arri√®re dans le temps), j'ai d√©cid√© que les interactions √©taient trop compliqu√©es pour les analyser en d√©tail, en particulier sans les <a href="https://randomascii.wordpress.com/2015/10/26/thread-naming-in-windows-time-for-something-better/" rel="nofollow">noms de flux</a> qui pourraient nous indiquer ce que font 25 threads diff√©rents dans <em>svchost.exe (3024)</em> . <br><br><h2>  Preuve! </h2><br>  J'ai alors d√©cid√© d'approcher <em>diff√©remment la preuve de</em> culpabilit√© de <em>WinMgmt.exe</em> .  Cela valait peut-√™tre la peine de commencer par cela, mais ce serait trop simple.  J'ai pris la ligne de commande <em>WinMgmt.exe</em> de la table <em>Processus</em> dans WPA et l'ai d√©marr√©e manuellement.  La commande a la forme: <br><br><blockquote>  winmgmt.exe / verifyrepository </blockquote><br>  et il a fallu environ cinq minutes pour terminer.  Pendant que cela fonctionnait (et j'avais beaucoup de temps), j'ai d√©couvert que je ne pouvais pas d√©marrer la trace ETW √† partir d' <em>UIforETW</em> .  Une telle preuve √©tait meilleure que toute analyse complexe que je pouvais faire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a0/c6f/d64/1a0c6fd64820226eddd120b5e9ab2ab7.png"></div><br>  <i>Configuration pour afficher uniquement les threads dormants depuis longtemps</i> <br><br>  Ensuite, j'ai ex√©cut√© √† nouveau la repro avec la trace d√©j√† en cours d'ex√©cution;  Apr√®s analyse de la trace, j'ai d√©couvert plus d'une <em>centaine de</em> processus dont les threads ont √©t√© bloqu√©s pendant plus de <em>cinq minutes!</em> <br><br><h2>  Et encore une fois au point ... </h2><br>  Par habitude, j'ai regard√© √† nouveau les donn√©es d'utilisation du processeur (√©chantillonn√©es) pour voir sur quoi <em>WinMgmt.exe</em> perdait du temps.  J'ai rapidement d√©couvert que 96,5% des √©chantillons se trouvaient dans <em>repdrvfs.dll! CPageCache :: Read ()</em> , appel√© sur quatre piles diff√©rentes: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/544/7d9/5f1/5447d95f1b431681cdd83ad42df7e731.png"></div><br>  <i>Quatre chemins qui m'ont conduit √† CPageCache :: Lire</i> <br><br>  Un arbre de piles compl√®tes pour cette fonction est affich√© ici, principalement pour les personnes de Microsoft qui souhaitent rechercher ce probl√®me: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e6/6b3/519/0e66b35191db016e98ded6eb08445569.png"></div><br>  <i>Piles compl√®tes menant √† CPageCache :: Lire de trois fa√ßons</i> <br><br>  J'ai ajout√© une colonne d'adresse et j'ai d√©couvert que 95,3% des √©chantillons √©taient dans un cycle de neuf instructions (les √©chantillons tombaient toujours dans seulement sept des neuf instructions (si vous voulez savoir pourquoi, voir <a href="https://travisdowns.github.io/blog/2019/08/20/interrupts.html" rel="nofollow">ici</a> ), mais le d√©bogueur a montr√© la taille compl√®te du cycle) : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ecf/8e6/04a/ecf8e604adbd110fdfaf77bb87dd378a.png"></div><br>  <i>√âchantillons par adresse - sept adresses tr√®s ¬´hot¬ª</i> <br><br>  Ensuite, j'ai commenc√© manuellement <em>winmgmt.exe / verifyrepository</em> , et en <em>m√™me temps,</em> j'ai <a href="https://randomascii.wordpress.com/2016/11/27/cpu-performance-counters-on-windows/" rel="nofollow">collect√© des donn√©es de compteur CPU sur les instructions de branche qui √©taient en cours d'ex√©cution</a> .  √Ä partir de cela, je pouvais √† peu pr√®s comprendre combien de fois la boucle a fonctionn√©.  Ce n'√©tait probablement pas n√©cessaire, mais je voulais m'assurer que la boucle a √©t√© ex√©cut√©e plusieurs fois et n'a pas √©t√© ex√©cut√©e lentement (pour une raison quelconque).  Je pensais que c'√©tait tr√®s cool de pouvoir le faire simplement, il suffit d'apporter une <a href="" rel="nofollow">petite modification</a> au fichier batch.  J'ai d√©couvert que <em>WinMgmt.exe</em> ex√©cutait environ une instruction de branchement par cycle, c'est-√†-dire que le cycle (qui, comme je le savais d√©j√†, consommait la majeure partie du temps CPU) √©tait extr√™mement rapide, et le ralentissement √©tait d√ª au fait qu'il fonctionnait √† des centaines de millions fois. <br><br><h2>  D√©lai Xperf </h2><br>  Juste pour des raisons de m√©ticulosit√©, j'ai d√©cid√© de voir pourquoi <em>UIforETW</em> ne pouvait pas commencer le tra√ßage pendant cet incident.  Il <em>s'est</em> av√©r√© que <em>UIforETW</em> ex√©cutait <em>xperf</em> , mais <em>xperf √©tait</em> inactif pendant 41,5 secondes (en fait plus) dans cette pile d'appels: <br><br><blockquote>  xperf.exe! wmain <br>  xperf.exe! CStopTrace :: Execute <br>  perfctrl.dll! LoggingSession :: EnumLoggers <br>  perfctrl.dll! LoggingSession :: LoggingSession <br>  perfctrl.dll! LoggingSession :: CreateProviderList <br>  perfctrl.dll! GetProviderInfoCache <br>  perfctrl.dll! CProviderInfoCache :: CProviderInfoCache <br>  tdh.dll! TdhfEnumerateProviders <br>  tdh.dll! TdhpWbemConnect <br>  wbemprox.dll! CLocator :: ConnectServer <br>  wbemprox.dll! CDCOMTrans :: DoActualConnection </blockquote><br>  En bref, <em>xperf</em> est appel√© par <em>Wbem</em> et est donc bloqu√© par ce probl√®me.  <em>xperf</em> essaie d'arr√™ter la trace avant de la d√©marrer, car j'ai ajout√© ce comportement pour rendre le <a href="https://github.com/google/UIforETW/commit/092fa4d3c30137eca658a86d58fc8230ced56c7c" rel="nofollow">d√©but de la trace plus tol√©rant aux pannes</a> .  Je soup√ßonne qu'un blocage se produirait toujours, mais je n'en suis pas s√ªr. <br><br><h2>  Nous cr√©ons des graphiques de complexit√© informatique </h2><br>  J'ai remarqu√© que <em>WinMgmt.exe</em> scanne le <em>r√©pertoire</em> <em>c: \ windows \ System32 \ wbem \ Repository</em> , qui fait 1,9 Go sur ma machine, j'ai donc demand√© au travail et sur Twitter de dire combien ce r√©pertoire prend pour obtenir des points de donn√©es.  J'ai √©galement demand√© aux gens de corriger le temps d'ex√©cution de <em>winmgmt.exe / verifyrepository</em> et <em>j'ai</em> commenc√© √† planifier.  M√™me si ces tests ont √©t√© effectu√©s sur des machines compl√®tement diff√©rentes avec des vitesses de processeur diff√©rentes, le graphique s'est av√©r√© assez clair: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/539/dd8/23d/539dd823d7fb9b33df39dc61f9e183dd.png"></div><br>  <i>La relation entre la racine carr√©e du temps et la taille du r√©f√©rentiel</i> <br><br>  Ce graphique du rapport sqrt (temps) √† la taille du r√©f√©rentiel est incroyablement id√©al pour les donn√©es re√ßues de six machines diff√©rentes, et n√©anmoins, il est r√©el.  De toute √©vidence, la fonction <em>VerifyRepository</em> a des performances O (n <sup>2</sup> ).  Si n est la taille du r√©pertoire du r√©f√©rentiel en <a href="https://randomascii.wordpress.com/2016/02/13/base-ten-for-almost-everything/" rel="nofollow">Go</a> , alors <em>VerifyRepository</em> prend environ 1,6 * n <sup>2</sup> minutes.  Il s'agit d'une bonne estimation approximative pour toutes les valeurs - d'une fraction de seconde √† dix minutes. <br><br><h2>  Pertinence </h2><br>  Soit j'ai de la chance, soit je suis juste observateur, car pendant quelques semaines, personne n'a plus rencontr√© ce probl√®me - je pensais que des choses √©tranges se passaient avec ma voiture.  Mais soudain, j'ai commenc√© √† entendre des plaintes √©trangement similaires de coll√®gues.  L'un d'eux avait un r√©f√©rentiel de 2,6 Go, ce qui prenait dix minutes √† v√©rifier.  Le probl√®me a affect√© certains de nos d√©veloppeurs de <a href="https://en.wikipedia.org/wiki/Continuous_integration" rel="nofollow">CI</a> , et √† diff√©rents degr√©s, diff√©rentes autres personnes.  Mes coll√®gues savent g√©n√©ralement qu'en cas de probl√®mes avec les performances des machines Windows, je dois me le dire, cependant, de nombreux autres employ√©s de Google travaillant sous Windows sont emp√™ch√©s par ce bogue, mais ils ne le r√©alisent pas. <br><br>  Heureusement, j'ai d√©j√† commenc√© √† travailler avec notre service informatique.  J'ai trouv√© le script qui a lanc√© <em>WinMgmt</em> et <em>j'ai</em> d√©couvert qu'il s'ex√©cute toutes les heures.  Cela signifiait que ma machine <em>ex√©cutait WinMgmt.exe / verifyrepository</em> 10% du temps, et certains de mes coll√®gues avaient plus de 16% du temps.  Il y a une probabilit√© assez √©lev√©e d'obtenir un d√©lai de dix minutes avant l'assemblage. <br><br>  Au moment o√π les rapports ont commenc√© √† arriver, le correctif √©tait d√©j√† en cours de production.  Le script √©tait facultatif et ne valait certainement pas les probl√®mes qu'il causait, donc le correctif consistait √† d√©sactiver son appel. <br><br><h2>  R√©sum√© </h2><br>  <em>winmgmt.exe / verifyrepository</em> contient un cycle de neuf instructions, dont le nombre d'it√©rations d'ex√©cution est proportionnel au carr√© de la taille du <em>r√©f√©rentiel wbem</em> .  Pour cette raison, l'ex√©cution de la commande peut prendre jusqu'√† dix minutes, bien qu'en r√©alit√©, elle devrait √™tre ex√©cut√©e en quelques secondes.  C'est mauvais en soi. <br><br>  Mais pire encore, l'√©quipe effectue un verrouillage WMI ( <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page" rel="nofollow">Windows Management Instrumentation</a> ) pendant son fonctionnement, de sorte que tout processus qui effectue des op√©rations WMI se fige. <br><br><h2>  √ânigmes incroyables </h2><br>  Le script qui <em>ex√©cutait winmgmt.exe / verifyrepository</em> toutes les heures le faisait depuis de nombreuses ann√©es, mais un comportement probl√©matique a commenc√© √† appara√Ætre il y a seulement un √† deux mois.  Vraisemblablement, cela signifie que le r√©f√©rentiel wbem est r√©cemment devenu beaucoup plus grand.  Les retards √† 0,5 Go sont facilement ignor√©s, mais √† partir de 1,0 Go et plus, ils peuvent d√©j√† se fatiguer.  Comme <a href="https://twitter.com/itoleck/status/1192647636085592069" rel="nofollow">sugg√©r√© sur Twitter,</a> j'ai ex√©cut√© <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/strings" rel="nofollow">strings.exe</a> pour le fichier objects.data.  Beaucoup de cha√Ænes les plus courantes contiennent polmkr dans le nom, mais je ne sais pas ce que cela signifie. <br><br>  J'ai <a href="https://twitter.com/BruceDawson0xB/status/1189979046135750657" rel="nofollow">publi√© un rapport de bogue sur Twitter</a> , et au d√©but, cela a provoqu√© un <a href="https://twitter.com/djammmer/status/1192634563421495297" rel="nofollow">certain mouvement de la part de l'√©quipe WMI</a> , mais j'ai ensuite cess√© de recevoir des r√©ponses, donc je ne sais pas quelle est la situation actuellement. <br><br>  Je voudrais voir un correctif pour le probl√®me de performances, et je voudrais que notre service informatique puisse trouver et r√©soudre le probl√®me qui rend nos r√©f√©rentiels wbem si gros.  Mais pour l'instant, le service informatique a promis de ne pas ex√©cuter la commande / verifyrepository toutes les heures de plus, ce qui devrait nous aider √† √©viter les pires sympt√¥mes. <br><br><h2>  Les r√©f√©rences </h2><br><ul><li>  Une liste g√©n√©rale des didacticiels, des enqu√™tes et de la documentation ETW est disponible ici: <a href="https://tinyurl.com/etwcentral" rel="nofollow">https://tinyurl.com/etwcentral</a> </li><li>  Le tutoriel d'utilisation du processeur (√©chantillonn√©) (pour savoir sur quoi le temps du processeur est d√©pens√©) est <a href="https://randomascii.wordpress.com/2013/04/23/xperf-for-excess-cpu-consumption-wpa-edition/" rel="nofollow">ici</a> et la documentation est <a href="https://randomascii.wordpress.com/2012/05/08/the-lost-xperf-documentationcpu-sampling/" rel="nofollow">ici.</a> </li><li>  Le didacticiel d'utilisation du processeur (pr√©cis) (pour trouver les raisons pour lesquelles les threads ne peuvent pas s'ex√©cuter) est <a href="https://randomascii.wordpress.com/2012/05/05/xperf-wait-analysisfinding-idle-time/" rel="nofollow">ici</a> et la documentation est <a href="https://randomascii.wordpress.com/2012/05/11/the-lost-xperf-documentationcpu-scheduling/" rel="nofollow">ici.</a> </li><li>  Des liens vers des articles individuels sont donn√©s dans le corps de l'article, vous pouvez √©galement les trouver dans ma cat√©gorie <a href="https://randomascii.wordpress.com/category/investigative-reporting/" rel="nofollow">Investigate Reporting</a> </li><li>  D'autres histoires sur les algorithmes O (n <sup>2</sup> ) peuvent √™tre lues sur <a href="https://accidentallyquadratic.tumblr.com/" rel="nofollow">Accidentally Quadratic</a> </li></ul><br>  Une discussion de l'article sur Reddit est <a href="https://www.reddit.com/r/programming/comments/e87dpb/on2_again_now_in_wmi/" rel="nofollow">ici</a> , une discussion sur les nouvelles des hackers est <a href="https://news.ycombinator.com/item%3Fid%3D21743424" rel="nofollow">ici</a> , un fil sur Twitter est <a href="https://twitter.com/BruceDawson0xB/status/1203905010716643328" rel="nofollow">ici,</a> et peut-√™tre <a href="https://twitter.com/BruceDawson0xB/status/1203922370957721600" rel="nofollow">ici</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479498/">https://habr.com/ru/post/fr479498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479482/index.html">SDK SARIF et ses erreurs</a></li>
<li><a href="../fr479486/index.html">Programmation h√©t√©rog√®ne et oneAPI Toolkit. Une conf√©rence improvis√©e d'experts Intel r√©pond √† vos questions</a></li>
<li><a href="../fr479488/index.html">D'un ordinateur portable - un serveur domestique avec alimentation redondante au routeur Mikrotik</a></li>
<li><a href="../fr479492/index.html">Informatique sans serveur bas√©e sur OpenWhisk, partie 3</a></li>
<li><a href="../fr479496/index.html">Analyse des t√¢ches WTF en JavaScript</a></li>
<li><a href="../fr479502/index.html">Comment survivre √† la p√©riode glaciaire la plus s√©v√®re de l'histoire de la Terre?</a></li>
<li><a href="../fr479504/index.html">Cr√©er un client l√©ger RDP bas√© sur Raspberry Pi</a></li>
<li><a href="../fr479508/index.html">PostgreSQL Antipatterns: JOIN et OR nuisibles</a></li>
<li><a href="../fr479510/index.html">PocketBook X Review - un √©norme lecteur de 10,3 pouces avec un √©cran E Ink Carta Mobius et un bo√Ætier m√©tallique</a></li>
<li><a href="../fr479512/index.html">MVCC dans PostgreSQL-4. Instantan√©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>