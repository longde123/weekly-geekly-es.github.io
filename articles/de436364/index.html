<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèª üëåüèº üì∫ Liveprof zeigt an, wann und warum sich die Leistung Ihrer PHP-Anwendung ge√§ndert hat üéí üïô üë®üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Mein Name ist Timur Shagiakhmetov, ich bin ein PHP-Entwickler bei Badoo . 

 Die Anwendungsleistung ist eines der wichtigsten Kriterien f√º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Liveprof zeigt an, wann und warum sich die Leistung Ihrer PHP-Anwendung ge√§ndert hat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/436364/"><img src="https://habrastorage.org/webt/sm/5p/or/sm5porzvybv5m_8ngvmgicgmeui.jpeg"><br><br>  Hallo Habr!  Mein Name ist Timur Shagiakhmetov, ich bin ein PHP-Entwickler bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Badoo</a> . <br><br>  Die Anwendungsleistung ist eines der wichtigsten Kriterien f√ºr die Qualit√§t der Arbeit eines Programmierers.  Bei der Optimierung von PHP-Anwendungen ist der Assistent der Profiler. <br><br>  K√ºrzlich haben wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dar√ºber gesprochen,</a> welche Tools wir f√ºr die Profilerstellung verwenden.  Ich m√∂chte Sie daran erinnern: Eines der Tools f√ºr die Leistungsanalyse, bei dem nicht klar ist, welche Teile des Codes die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verl√§ngerung</a> der Antwortgenerierungszeit beeinflusst haben, ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">XHProf</a> .  Dies ist eine Erweiterung f√ºr PHP, mit der Sie Code auf einem Kampfserver profilieren und anschlie√üend verbessern k√∂nnen. <br><br>  Ich h√§tte aber auch gerne eine Vorgeschichte von Produktivit√§ts√§nderungen, damit Sie nachverfolgen k√∂nnen, was und wann sich die Verschlechterung ausgewirkt hat, oder?  Zu diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zweck</a> haben wir vor etwa einem Jahr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Liveprof</a> entwickelt, ein Tool zum automatischen Profiling aller Anforderungen mit einer Schnittstelle zur Analyse von √Ñnderungen der Anwendungsleistung. <br><br>  Mit unserem Tool k√∂nnen Sie die Leistungs√§nderung eines Teils des Codes analysieren und die Stellen finden, an denen er am meisten gefallen ist.  Gleichzeitig muss es nicht speziell aktiviert werden und darauf warten, dass sich Statistiken ansammeln. Es ist immer aktiv und sammelt Daten f√ºr einen bestimmten Bruchteil aller Anforderungen. <br><br>  In diesem Artikel werde ich √ºber Implementierungsdetails und Funktionen der Verwendung dieses Tools sprechen. <br><a name="habracut"></a><br><h2>  Ein bisschen √ºber XHProf </h2><br>  Zun√§chst einige Worte zu den Funktionen von XHProf.  Dies ist ein Profiler f√ºr PHP, der als Erweiterung in C geschrieben wurde.  Es wurde auf Facebook entwickelt und gemeinfrei ver√∂ffentlicht.  Es verf√ºgt √ºber mehrere Gabeln ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Uprofiler</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tideways</a> ), die auf der Ebene des Ausgabedatenformats vollst√§ndig kompatibel sind. <br><br>  XHProf setzt Timer f√ºr alle Funktions- / Methodenaufrufe.  Die Verwendung ist mit einem gewissen Aufwand verbunden.  Aber sie sind nicht so gro√ü und erlauben es, sie in der Produktion zu verwenden. <br><br>  Das Ergebnis von XHProf ist ein Array von Elementen im folgenden Format: <br><br><pre><code class="php hljs">$data = [ <span class="hljs-string"><span class="hljs-string">'parentMethodName==&gt;childMethodName'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'ct'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'wt'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-string"><span class="hljs-string">'cpu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-string"><span class="hljs-string">'mu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">528</span></span> <span class="hljs-string"><span class="hljs-string">'pmu'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ] ];</code> </pre> <br>  wo <br><br>  <code><b>parentMethodName</b></code> und <code><b>childMethodName</b></code> sind die √ºbergeordneten bzw. <code><b>childMethodName</b></code> Methoden. <br>  <code><b>ct</b></code> - die Anzahl der Anrufe im Kontext der Anfrage; <br>  <code><b>wt</b></code> - Ausf√ºhrungszeit der Anforderung (besteht aus der vom Prozessor aufgewendeten Zeit und der Wartezeit auf E / A oder die Antwort eines anderen Dienstes); <br>  <code><b>cpu</b></code> - Zeit, die der Prozessor f√ºr die Verarbeitung der Anforderung aufgewendet hat; <br>  <code><b>mu</b></code> - √Ñnderung des Speicherverbrauchs nach einem Methodenaufruf; <br>  <code><b>pmu</b></code> - √Ñnderung des <code><b>pmu</b></code> Speicherverbrauchs nach einem Methodenaufruf. <br><br>  Einige andere Optionen sind ebenfalls m√∂glich. <br><br>  XHProf enth√§lt auch Tools zur Visualisierung der so erzielten Ergebnisse.  F√ºr jede Profilierungsoperation erhalten wir eine Tabelle mit einer Reihe von Parametern f√ºr jede Methode. <br><br>  Zum Beispiel <br><br><div class="spoiler">  <b class="spoiler_title">Blasensortierungsergebnis</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ $array = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $count; $i++) { $array[] = rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $array; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BubbleSorter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$array)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $len = count($array); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $len ; $i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = <span class="hljs-number"><span class="hljs-number">0</span></span>; $j &lt; $len - $i - <span class="hljs-number"><span class="hljs-number">1</span></span>; $j++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array[$j] &gt; $array[$j + <span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;swap($array[$j], $array[$j + <span class="hljs-number"><span class="hljs-number">1</span></span>]); } } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$a, &amp;$b)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $tmp = $a; $a = $b; $b = $tmp; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isSorted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $array)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{ $len = count($array); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $len - <span class="hljs-number"><span class="hljs-number">1</span></span>; $i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array[$i] &gt; $array[$i + <span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayPrinter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $array, string $delimiter = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' '</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> implode($delimiter, $array) . PHP_EOL; } } xhprof_enable(); $n = <span class="hljs-number"><span class="hljs-number">10</span></span>; $arrayGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ArrayGenerator(); $array = $arrayGenerator-&gt;getRandomArray($n); $sorter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BubbleSorter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$sorter-&gt;isSorted($array)) { $sorter-&gt;sort($array); } $printer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ArrayPrinter(); $printer-&gt;print($array); $xhprof_data = xhprof_disable();</code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/ip/cw/vi/ipcwviocimg7kjon1memwwziho8.png"><br><br>  Sie k√∂nnen in jede Methode gehen, um herauszufinden, welche Methoden wie viele Ressourcen verbraucht haben. <br><br>  Sie k√∂nnen sich auch das Anrufdiagramm ansehen und die ressourcenintensivsten Methoden hervorheben: <br><br><img src="https://habrastorage.org/webt/zq/yw/pl/zqywplc0eibbdxdotsr3f0bed_o.png"><br><br>  XHProf ist n√ºtzlich, um die Leistung jeder Anforderung manuell zu analysieren.  Es ist uns aber auch wichtig, das gro√üe Ganze zu sehen.  Sie m√ºssen verstehen, wie sich die Leistung im Laufe der Zeit ver√§ndert hat.  Zu diesem Zweck wurde ein Tool entwickelt, mit dem Abfragen im automatischen Modus profiliert und in der Weboberfl√§che analysiert werden k√∂nnen. <br><br><h2>  Liveprof: Ergebnisse aggregieren und Verlauf behalten </h2><br>  Wie erhalte ich einen Profilverlauf? <br><br>  Zuerst m√ºssen Sie den automatischen Start des Profilers konfigurieren und die Ergebnisse speichern.  Die Leistung ist nicht konstant und schwankt von Start zu Start.  Um den Einfluss solcher Schwankungen zu vermeiden, verwenden wir die gemittelten Daten mehrerer Abfragen.  Als Ergebnis erhalten wir aggregierte Ergebnisse f√ºr jede Abfrage, z. B. Minimum, Maximum, Durchschnitt und 95. Perzentil.  Dies hilft, schwierige Dinge zu finden, die m√∂glicherweise nicht bei jeder Anfrage aufgerufen werden. <br><br>  Unser Tool hat sowohl Vorteile als auch einige Einschr√§nkungen. <br><br><h3>  Was der Aggregator tun kann: </h3><br><ol><li>  Automatische Profilerstellung f√ºr jede N-te Anforderung. <br></li><li>  T√§gliche Zusammenfassung der gesammelten Profile. <br></li><li>  Die M√∂glichkeit, Diagramme der √Ñnderungen in jedem vom Profiler gemessenen Parameter anzuzeigen.  Zum Beispiel wt, cpu, mu, pmu, wie oben beschrieben. <br></li><li>  Zeigen Sie die Leistungs√§nderung einer Methode f√ºr ein bestimmtes Intervall an. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Flammendiagramm</a> basierend auf den neuesten aggregierten Daten. <br></li><li>  Suchen Sie nach Abfragen, die eine bestimmte Methode aufrufen <br></li></ol><br><h3>  Einschr√§nkungen: </h3><br><ol><li>  Da es sich bei unserem Tool um ein aggregiertes Tool handelt, k√∂nnen Sie die Leistung einer Abfrage (z. B. der langsamsten) nicht ermitteln. Die Ergebnisse werden √ºber den letzten Tag gemittelt.  Dies reicht jedoch aus, um die allgemeine Leistungsdynamik zu bewerten.  Wenn eine Anforderung in der Ausf√ºhrungsgeschwindigkeit abrutscht, √§ndern sich der Durchschnittswert, das 95. Perzentil und die maximale Ausf√ºhrungszeit. <br></li><li>  Sie k√∂nnen den vollst√§ndigen Aufrufstapel nicht eindeutig wiederherstellen, da XHProf nur eindeutige Eltern-Kind-Paare mit der Summe der Werte der verbrauchten Ressourcen zur√ºckgibt. <br></li><li>  Laufzeitfehler im Zusammenhang mit XHProf-Overhead anfordern.  Der Unterschied ist nicht so gro√ü, muss aber bei der Messung der Ausf√ºhrungszeit der Abfrage ber√ºcksichtigt werden. <br></li></ol><br><h3>  So verwenden Sie den Profiler </h3><br><ol><li>  Zun√§chst muss der Profiler mit der Site oder dem Skript verbunden werden.  Die bequemste M√∂glichkeit, das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tool</a> zu verwenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, besteht darin, den Profiler automatisch zu starten</a> : <br><br><pre> <code class="plaintext hljs">php composer.phar require badoo/liveprof # Run a script to configure database LIVE_PROFILER_CONNECTION_URL=mysql://db_user:db_password@db_mysql:3306/Profiler?charset=utf8 php vendor/badoo/liveprof/bin/install.php</code> </pre><br>  Es unterst√ºtzt Versionen von PHP ab 5.4 und ist mit minimalem Overhead behaftet, sodass Sie es in einer Kampfumgebung verwenden k√∂nnen.  Das Tool erkennt automatisch die verwendete Profiler-Erweiterung: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">XHProf</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Uprofiler</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tideways</a> .  Beim Start m√ºssen Sie Parameter f√ºr die Verbindung zur Datenbank und die Profileinstellungen angeben. <br><br>  Beispiel f√ºr die Verwendung in Code mit Standardeinstellungen: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; \Badoo\LiveProfiler\LiveProfiler::getInstance()-&gt;start(); <span class="hljs-comment"><span class="hljs-comment">// Code is here</span></span></code> </pre> <br>  Profilerstellungsergebnisse werden in der Datenbank gespeichert.  Einmal am Tag findet ein Aggregationsprozess statt.  W√§hlen Sie dazu alle Datens√§tze f√ºr eine bestimmte Anforderung pro Tag aus und berechnen Sie die aggregierten Funktionen f√ºr jeden der Parameter.  Aggregationsfunktionen k√∂nnen erweitert oder neu definiert werden. <br><br>  Folgendes ist jetzt verf√ºgbar: <br><br><ul><li>  mindestens pro Tag; </li><li>  Maximum pro Tag; </li><li>  Tagesdurchschnitt </li><li>  95. Perzentil des Tages. </li></ul><br></li><li>  Der Aggregator <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">-Webclient wird</a> verwendet, um die Aggregation zu konfigurieren und die Ergebnisse anzuzeigen.  Der einfachste Weg, es in einem Docker-Container zu installieren: <br><br><pre> <code class="php hljs">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//github.com/badoo/liveprof-ui.git cd liveprof-ui docker-compose up web</span></span></code> </pre> </li><li>  Vor dem ersten Start m√ºssen Sie die Datenbankverbindungsparameter, eine Liste der Felder und die verwendeten Aggregatfunktionen in der Konfigurationsdatei src / config / services.yaml konfigurieren.  F√ºhren Sie dann das Installationsskript aus: <br><br><pre> <code class="php hljs">docker-compose exec web bash install.sh</code> </pre> </li><li>  Es ist notwendig, automatisch ausgef√ºhrte Skripte zur Aggregation und Bereinigung alter Daten in Kronen zu registrieren: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># script aggregates all profiles for previous day, add it if you don't use a queue for aggregation jobs (parameter aggregator.use_jobs_in_aggregation=false) 0 2 * * * docker-compose -f %PATH_TO_PROJECT%/docker-compose.yml run --rm --entrypoint '/usr/local/bin/php /app/bin/cli.php cron:aggregate-all-profiles' web # script removes old aggregated data, by default &gt; 200 days 0 1 * * * docker-compose -f %PATH_TO_PROJECT%/docker-compose.yml run --rm --entrypoint '/usr/local/bin/php /app/bin/cli.php cron:remove-old-profiles' web 200</span></span></code> </pre> <br></li><li>  Um mit Testdaten zu f√ºllen, k√∂nnen Sie das Skript ausf√ºhren: <br><br><pre> <code class="php hljs">docker-compose exec web php /app/bin/cli.php example:a-week-degradation</code> </pre> </li></ol><br><h2>  Schnittstellenbeschreibung </h2><br>  Das Webinterface ist verf√ºgbar unter: 127.0.0.1:8000. <br><br>  Standardm√§√üig wird eine Seite mit einer Liste aggregierter Abfragen ge√∂ffnet.  Es macht es einfach, eine interessierende Abfrage zu finden, alle Abfragen nach einem der Parameter zu sortieren und eine bestimmte Abfrage neu zu aggregieren, um die neuesten Ergebnisse anzuzeigen: <br><br><img src="https://habrastorage.org/webt/qj/-d/6b/qj-d6bj1095huwhvqmzdwim1g6k.png"><br><br>  Bei der Arbeit mit dem Tool wird am h√§ufigsten eine Seite mit einer Liste von Methoden und Diagrammen mit Leistungs√§nderungen verwendet.  Sie k√∂nnen den Aufrufstapel durchgehen, den Verbrauch der einzelnen Parameter sowie Diagramme der Leistungs√§nderungen f√ºr ein bestimmtes Intervall beobachten: <br><br><img src="https://habrastorage.org/webt/-6/ag/u4/-6agu45zuu1qs77tckpkngabjwq.png"><br><br>  <i>Auf einer Seite mit einer vollst√§ndigen Liste der aufgerufenen Methoden k√∂nnen Sie die gew√ºnschte Methode schnell finden und die Diagramme anzeigen, indem Sie zur Diagrammseite gehen:</i> <br><br><img src="https://habrastorage.org/webt/nj/g-/f_/njg-f_48jsuo8mcmlxuq1ukxj_4.png"><br>  <i>Auf der Seite mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Flammengraphen der</a> letzten aggregierten Abfrage k√∂nnen Sie die schwersten Teile visuell identifizieren.</i> <br><br>  Die Verwendung von XHProf schr√§nkt die Genauigkeit des Ergebnisses ein.  Dies liegt daran, dass der Profiler keinen vollst√§ndigen Aufrufbaum zur√ºckgibt, sondern nur die Eltern-Kind-Paare.  Wenn au√üerdem ein Methodenpaar von verschiedenen Stellen der Anwendung aufgerufen wurde, erhalten wir als Ergebnis die aufgewendete Zeit.  F√ºr ein Flammendiagramm ben√∂tigen Sie einen vollst√§ndigen Aufrufbaum.  Bei der Wiederherstellung eines solchen Baums werden die Parameterwerte unter Ber√ºcksichtigung der von den Eltern aufgewendeten Zeit normalisiert. <br><br><img src="https://habrastorage.org/webt/vp/lp/xr/vplpxry-gjd-lq774gg3ji9cooo.png"><br>  <i>Eine Seite mit einer Liste von Methoden, die w√§hrend des ausgew√§hlten Intervalls langsamer geworden sind.</i> <br><br>  Au√üerdem k√∂nnen Sie f√ºr jede Methode sehen, welcher der untergeordneten Aufrufe die Leistung am meisten beeinflusst hat.  Im folgenden Screenshot sehen Sie beispielsweise, dass die <code>ServiceApi::getAvailableServices()</code> -Methode 116 ms langsamer ausgef√ºhrt wurde.  Der Grund daf√ºr war das Hinzuf√ºgen eines Aufrufs von <code>ServiceApi::getGifts()</code> (√Ñnderung um 56 ms) und eine Erh√∂hung der Anzahl der Aufrufe der <code>ServiceApi::getConfigForList()</code> -Methode von 1 auf 5 (weitere 50 ms): <br><br> <a href=""><img src="https://habrastorage.org/webt/rv/mc/dd/rvmcddru-ay4x9cb45xsvey_tka.png"></a> <br><br>  Wenn im Voraus nicht bekannt ist, bei welcher Abfrage sich die Leistung am deutlichsten ge√§ndert hat, hilft eine Seite mit einer Liste von Methoden, die ohne Verweis auf eine bestimmte Abfrage langsamer geworden sind: <br><br><img src="https://habrastorage.org/webt/-6/0b/3s/-60b3svwq_rg9z7wbzmzmpriapc.png"><br>  <i>Eine Seite, die nach Abfragen sucht, die eine bestimmte Methode aufrufen.</i> <br><br>  Sie k√∂nnen die Ausf√ºhrungszeit in verschiedenen Anforderungen vergleichen.  Auch n√ºtzlich, um nicht verwendeten Code zu finden: <br><br><img src="https://habrastorage.org/webt/hq/du/lv/hqdulvav1asbj9nczgowuk1mvak.png"><br><br><h3>  Anpassungsfunktionen </h3><br>  Das Tool bietet zahlreiche Anpassungsm√∂glichkeiten: <br><br><ul><li>  Sie k√∂nnen Ihre eigenen Aggregatfunktionen hinzuf√ºgen, die einen bestimmten Wert basierend auf dem √ºbergebenen Array von Parameterwerten berechnen. <br></li><li>  Sie k√∂nnen die Datenbank zum Speichern von Profilen und aggregierten Ergebnissen √§ndern (SQLite, MySQL und PostgreSQL werden jetzt unterst√ºtzt, Sie k√∂nnen jedoch andere aus der f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Doctrine DBAL</a> verf√ºgbaren Liste verwenden). <br></li><li>  Sie k√∂nnen sowohl den Datenbankverbindungsmanager √ºberschreiben als auch Ihre Methoden zum Abrufen von Daten implementieren. <br></li><li>  Sie k√∂nnen die Weboberfl√§che sowohl als eigenst√§ndiges Projekt als auch in einem beliebigen Framework (z. B. einem Site-Kontrollfeld) verwenden.  Ein Beispiel: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">profileListAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{      &lt;i&gt;<span class="hljs-comment"><span class="hljs-comment">//Some custom logic before&lt;/i&gt;   $this-&gt;checkPermissions();   $App = new \Badoo\LiveProfilerUI\LiveProfilerUI();   $Page = $App-&gt;getPage('profile_method_list_page');   return $Page-&gt;setData($data)-&gt;render(); }</span></span></code> </pre> </li></ul><br><h2>  Fazit </h2><br>  Ich hoffe, unser Tool wird anderen Entwicklern n√ºtzlich sein.  Auf diese Weise k√∂nnen Sie die Leistungs√§nderung eines Teils des Codes ohne Verwendung zus√§tzlicher Timer √ºberpr√ºfen.  Dies erleichtert auch den Optimierungsprozess, da Sie jetzt sehen k√∂nnen, welche Auswirkungen die Verschlechterung der Anwendungsleistung im Laufe der Zeit hatte. <br><br>  Es ist auf GitHub verf√ºgbar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/badoo/liveprof</a> , die Weboberfl√§che lautet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/badoo/liveprof-ui</a> . <br><br>  Das Tool befindet sich in der aktiven Entwicklung und kann einige Fehler enthalten.  Hoffentlich wird es mit der Beteiligung der Community noch besser.  Die Pl√§ne sehen vor, neben XHProf auch andere Profiler zu unterst√ºtzen und die Liste der unterst√ºtzten Datenbanken zu erweitern. <br><br>  Senden Sie uns Feedback und Fragen zur Verwendung in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegrammen</a> , Fehlern und Pull-Anfragen - direkt an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> .  Wir freuen uns √ºber Kommentare und Vorschl√§ge! <br><br>  Besonderer Dank geht an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gregory</a> f√ºr die Idee und die erste Umsetzung. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de436364/">https://habr.com/ru/post/de436364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de436352/index.html">PostgreSQL News Digest. Ausgabe Nr. 14</a></li>
<li><a href="../de436354/index.html">Das US-Milit√§r vernachl√§ssigt Fragen der Cybersicherheit</a></li>
<li><a href="../de436356/index.html">[Interessant hinter dem H√ºgel] Wie stoppen wir die technologische Abh√§ngigkeit?</a></li>
<li><a href="../de436358/index.html">Warum unterrichten √§ltere Entwickler Sch√ºler?</a></li>
<li><a href="../de436360/index.html">Ich muss schnell gehen: Auf Geschwindigkeit in iOS bauen. Teil 1</a></li>
<li><a href="../de436370/index.html">Infrastruktur f√ºr √∂ffentliche Schl√ºssel X509 v.3 Stammzertifikatskette</a></li>
<li><a href="../de436372/index.html">Isometrisches Plugin f√ºr Unity3D</a></li>
<li><a href="../de436374/index.html">Designtrends f√ºr UI und UX 2019</a></li>
<li><a href="../de436376/index.html">√úbersicht √ºber den Gel√§nderoboter EZ-Robot Roli Rover</a></li>
<li><a href="../de436378/index.html">bobaos.pub - KNX TP / UART, Raspberry Pi und Redis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>