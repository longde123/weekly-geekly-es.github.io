<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí• üèñÔ∏è üßú Comment ai-je annul√© le syst√®me il y a un mois et r√©cup√©r√© tout? Exp√©rience avec ESXi. Ou comment ne pas le faire üöá üêæ üë©üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous. Cela peut sembler √† quelqu'un une histoire instructive de la fa√ßon dont vous ne devriez pas le faire et pourquoi certains travaux tech...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment ai-je annul√© le syst√®me il y a un mois et r√©cup√©r√© tout? Exp√©rience avec ESXi. Ou comment ne pas le faire</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418049/"><p>  Bonjour √† tous.  Cela peut sembler √† quelqu'un une histoire instructive de la fa√ßon dont vous ne devriez pas le faire et pourquoi certains travaux techniques importants √† une heure du matin (dans un syst√®me dans lequel vous ne comprenez pas grand-chose) peuvent entra√Æner un effondrement et des temps d'arr√™t √©normes pendant deux jours. </p><br><p><img src="https://habrastorage.org/webt/o7/p8/ft/o7p8ftn8suvvumhpdsjsp8zhyri.png" alt="image"></p><br><p> Une courte note est l'histoire d'un administrateur syst√®me amateur qui commence tout juste √† plonger dans le monde de la virtualisation.  L'histoire de la fa√ßon dont les instantan√©s n'ont pas aid√©, mais ont interf√©r√© et ont fait un retour en arri√®re du syst√®me pendant un mois, puis avec un temps d'arr√™t en 2 jours, j'en ai retir√© tous les fichiers et j'ai renvoy√© le syst√®me. </p><a name="habracut"></a><br><h3 id="predystoriya">  Contexte </h3><br><p>  Apr√®s deux ann√©es pass√©es sur des syst√®mes <em>nix</em> , et en particulier sur le serveur ubuntu (16.04 LTS), j'ai d√©cid√© d'essayer la virtualisation.  Un ami a conseill√© ESXi comme une solution gratuite pour les petits serveurs (mon cas: 1 processeur + seulement 8 Go de RAM).  Le processus de d√©placement a √©t√© compliqu√© par le fait que vous deviez d'abord soulever la station de travail vmware avec le convertisseur vmware sur l'ordinateur Windows, y transf√©rer le syst√®me fini, puis le soulever sur le serveur esxi et apr√®s le convertisseur familier transf√©rer le syst√®me vers esxi.  C'est un voyage si long et douloureux.  La principale erreur lors du transfert, que j'ai faite et qui appara√Æt toujours sur moi, est que j'ai utilis√© un disque mince.  Autrement dit, √©tant sur un serveur Ubuntu propre avec un disque format√© en exfat-4, j'avais quelque part 223,8 Go d'espace sur SSD.  Passer √† esxi et formater le disque dans un format incompr√©hensible pour rien, je n'ai perdu que 300 Mo, mais c'est √† cause d'eux que je ne pouvais pas faire un disque √©pais, dont j'avais (plus tard, il s'est av√©r√©) tellement besoin. </p><br><h3 id="nachalo">  Commencer </h3><br><p>  J'avais l'habitude de casser du bois de chauffage avec un serveur Ubuntu (quand je l'ai juste ¬´√©tudi√©¬ª), de reculer et de r√©installer le syst√®me une fois par mois ou deux.  Maintenant, je casse du bois de chauffage avec ESXi.  Je pense qu'il n'est pas n√©cessaire de d√©crire le probl√®me des disques minces (en bref, apr√®s avoir √©largi leur espace, ils ne le ¬´r√©tr√©cissent¬ª pas dans le sens oppos√©. Ils peuvent √©galement d√©passer la quantit√© physique de m√©moire sur le disque).  Tout d'abord, j'ai utilis√© swap sur le m√™me lecteur ssd sans le configurer correctement dans ESXi.  Il y mangeait de la m√©moire, y √©crivait des fichiers temporaires et, en attendant, maigrissait. <br>  Deuxi√®mement, pour une raison quelconque, j'ai fait des instantan√©s.  √Ä ce moment-l√†, j'ai √©t√© guid√© par le fait que "eh bien, c'est pratique, rapide et tout √ßa".  Je ne soup√ßonne toujours pas quel genre de merde et quelle bombe lente ils ont plant√© pour moi.  Troisi√®mement, je n'ai pas suivi la quantit√© de m√©moire qui diminue rapidement sur le disque. </p><br><p><img src="https://habrastorage.org/webt/5q/yf/-p/5qyf-px8lztr4ckxnqtnnye0jsc.png" alt="image"></p><br><h3 id="zavyazka">  Cravate </h3><br><p>  La premi√®re cloche a √©t√© l'arr√™t de la voiture principale le 17 juillet.  Une notification est arriv√©e par la poste de la chute de l'h√¥te.  Entrant dans esxi pour le ramasser (enfin, tout √† coup quelque chose pourrait arriver), la fille virtuelle m'a donn√© une bonne nouvelle (il n'y a malheureusement pas de capture d'√©cran).  Une nouvelle version gratuite d'une fen√™tre contextuelle ressemblait √† ¬´D√©sol√©, l'espace disque est √©puis√©.  Votre machine virtuelle est arr√™t√©e.  Nettoyez l'endroit et vous pouvez continuer √† utiliser la machine virtuelle.  R√©p√©tez Annuler.  √Ä cette √©poque, le probl√®me a √©t√© r√©solu en supprimant la deuxi√®me machine virtuelle, ce qui prenait environ 16 Go.  Mais c'√©tait une solution temporaire, car chaque jour, 5 Go disparaissaient toujours quelque part, bien que le syst√®me n'ait pas augment√© ces fichiers. </p><br><p>  En cons√©quence, le 19 juillet au soir, un jeudi frais, j'ai d'abord √©crit sur le grille-pain √† propos de ce probl√®me.  Il n'y avait pas de r√©ponse.  Je pense que cela est d√ª √† la balise esxi impopulaire.  Apr√®s google √©chou√©, apr√®s - la suppression des instantan√©s.  √Ä ce moment, 5 gigaoctets ont disparu, l'espace libre est devenu plus grand, mais pas au point d'oublier ce probl√®me. </p><br><p><img src="https://habrastorage.org/webt/gm/lu/od/gmluodpkazvb9spxzievfzr1khm.png" alt="image"></p><br><p>  Apr√®s, avec un petit cerveau, j'ai commenc√© √† √©tudier la hi√©rarchie des instantan√©s.  Le dernier, 000003, occupait √† l'√©poque 12 Go d'espace.  Dans les param√®tres de la machine virtuelle, il √©tait r√©pertori√© comme le fichier de disque actif √† partir duquel la machine avait d√©marr√©.  Sans y r√©fl√©chir √† deux fois, j'ai supprim√© le fichier disque du disque dur 1 avec le disque instantan√© actif et ins√©r√© le disque parent de la machine virtuelle enti√®re √† sa place. </p><br><p><img src="https://habrastorage.org/webt/5l/rp/jo/5lrpjobrvmfbglufsa0ilmbtvgk.png" alt="image"></p><br><p>  Le syst√®me a d√©marr√© (acclamations), et avec lui les fichiers du 30 juin.  Date de derni√®re modification de tous les fichiers sur le disque parent.  Je soup√ßonne que c'est ce jour-l√† que j'ai cr√©√© le premier instantan√©.  Logiquement, il n'y avait plus d'endroits.  Dans l'espace libre, il reste environ 5 Go et les fichiers ont disparu. </p><br><p>  Les premi√®res r√©flexions sont logiques: ce que j'ai fait, tous les fichiers se sont √©vapor√©s jusqu'au 19 juillet.  Ensuite, j'ai vu que les fichiers d'instantan√©s n'√©taient pas supprim√©s.  Cependant, lorsque j'ai essay√© de les charger en tant que disque principal, ESXi a jur√© sur le disque parent modifi√©, qui ne devrait pas √™tre ¬´Le disque virtuel parent a √©t√© modifi√© depuis la cr√©ation de l'enfant¬ª Mon erreur √©ternelle au cours des deux prochains jours. </p><br><h3 id="guglenie">  Googler </h3><br><p>  Le temps approchait √† deux heures du matin, et j'ai abandonn√© toutes les vaines tentatives pour obtenir au moins quelques informations de ces malheureux fichiers * -0000? -. Vmdk. </p><br><p>  Vendredi matin, a commenc√© avec un google actif, tr√®s actif comme ¬´comment obtenir des fichiers de vmdk¬ª.  Des articles, un lecteur Linux (programme Windows) et tout ce qui a √©t√© rencontr√© tr√®s souvent.  J'ai transf√©r√© ces 223 gigaoctets du serveur √† l'ordinateur portable Windows sur le canal 100Mbit, ce qui √©tait tr√®s douloureux.  J'ai essay√© de monter un disque ssd de format vmware sur un syst√®me linux, j'ai roul√© des outils vmware dessus, elle a jur√© une incompatibilit√© de versions (la derni√®re prise en charge √©tait 5, mais j'en avais 6,5).  Les tentatives d'ouverture par les fen√™tres et Java ont √©galement √©t√© vaines. </p><br><p>  Et m√™me apr√®s avoir pu acc√©der (en utilisant le programme de lecture Linux sur Windows) au fichier * -flat.vmdk, je n'ai re√ßu les fichiers que jusqu'au 30 juin.  Toutes les autres tentatives de montage de fichiers d'instantan√©s n'ont rien donn√©, le programme a maudit un disque invalide et a refus√© de continuer √† fonctionner. </p><br><h3 id="vyhod-nayden">  Sortie trouv√©e </h3><br><p>  Vendredi est fini, j'√©tais √©puis√©, et aussi boulevers√© que les fichiers ne puissent pas √™tre retourn√©s.  Mais samedi a commenc√© avec succ√®s.  Sur les erreurs google (pourquoi je ne l'ai pas fait tout de suite est inconnue) "Le disque virtuel parent a √©t√© modifi√© depuis la cr√©ation de l'enfant" sur la premi√®re ligne de Google a donn√© un lien vers la page vmware.  Un tas de personnages effrayants, des lignes rouges et tout ce qui a imm√©diatement √©t√© effray√©.  J'ai ouvert le lien et l'ai laiss√© dans l'espoir de trouver quelque chose de plus compr√©hensible. </p><br><p>  Et il a √©t√© retrouv√©.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://communities.vmware.com/thread/323730 Le</a> forum VmWare en russe et un probl√®me similaire m'ont rencontr√© sur Internet.  Ce n'est probablement pas le m√™me cas que le mien, mais apr√®s avoir d√©fil√© et lu les commentaires, j'ai essay√© de le faire. </p><br><p>  Dans un √©diteur de texte, en me connectant √† esxi via sftp, j'ai ouvert le fichier avec les param√®tres du disque parent.  <em>.vmdk (pas</em> -flat.vmdk) J'ai reconnu le CID du disque, puis j'ai grimp√© dans * -00001.vmdk, en faisant comme d√©crit par la personne avec le surnom <strong>apavlyuchenko</strong> dans le forum. </p><br><p>  Dans le premier instantan√©, les champs CID et parentCID doivent indiquer le CID du disque parent.  Et puis dans le fichier <em>.vmx dans les champs</em> <em><br></em>  <em>scsi0: 1.present = "false"</em> <em><br></em>  <em>scsi0: 1.fileName = "</em> .vmdk" <br>  scsi0: 1.deviceType = "scsi-hardDisk" <br>  changez le param√®tre FALSE en TRUE et <em>.vmdk en</em> -00001.vmdk. </p><br><p>  Et en effet, apr√®s cela, la voiture a d√©marr√© et n'a pas jur√© sur l'erreur.  Et voil√†!  Les fichiers sont apparus avant de cr√©er un deuxi√®me instantan√©! </p><br><p>  Sur le forum, un ami a d√©crit un moyen de r√©cup√©rer des fichiers √† partir d'un seul instantan√©.  Mais mon cas est difficile (apparemment, √† cause de ma maladie, qui s'appelle "piquez tout avec vos mains sur une machine qui fonctionne").  Et je n'ai pas eu un instantan√©, mais trois.  Ce qui est logique, il fallait continuer √† changer les fichiers. </p><br><p>  Donc, mes actions. </p><br><p>  Ouvrez le disque parent.  D√©couvrez son CID.  Ensuite, copiez le CID du disque parent sur la ligne parentCID du disque <em>-00001.vmdk (premier instantan√©).</em>  <em>L√†, nous regardons le CID de cet instantan√© et le copions dans la ligne parentCID du lecteur</em> -00002.vmdk (deuxi√®me instantan√©).  L√†, nous regardons le CID de cet instantan√© et le copions dans la ligne parentCID du lecteur <em>-00003.vmdk (troisi√®me instantan√©), eh bien, apr√®s cela, nous montons dans</em> .vmx et sp√©cifions le nom du fichier d'instantan√© dans la ligne fileName (dans mon cas * -0003.vmdk) </p><br><p>  Le r√©sultat est le suivant. </p><br><p>  * <strong>.vmdk</strong> <br>  CID = 387edddf <br>  parentCID = ffffffff </p><br><p>  * <strong>-00001.vmdk</strong> <br>  CID = 0284jf712 (j'ai pris tous les CID en gras) <br>  parentCID = 387edddf </p><br><p>  * <strong>-00002.vmdk</strong> <br>  CID = 732fhhtud <br>  parentCID = 0284jf712 </p><br><p>  * <strong>-00003.vmdk</strong> <br>  CID = 3747jfj4ff <br>  parentCID = 732fhhtud </p><br><p>  <em><strong>.vmx</strong></em> <em><br></em>  <em>scsi0: 1.present = "true"</em> <em><br></em>  <em>scsi0: 1.fileName = "</em> -00003.vmdk" <br>  scsi0: 1.deviceType = "scsi-hardDisk" </p><br><p>  J'allume la VM, je vois que les donn√©es sont restaur√©es.  Cela semble l√¢cher prise.  Je copie tout sur un autre serveur, arr√™te la machine (il crie d√©j√† sur les dysfonctionnements du disque et certains autres probl√®mes critiques), renvoie les param√®tres * .vmx et copie les fichiers sur la machine en marche.  Hourra. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Cette histoire m'a appris plusieurs v√©rit√©s d'or qui ne pouvaient pas √™tre comprises auparavant. </p><br><p>  Tout d'abord, sauvegardez tout et toujours et pas sur le disque √† l'int√©rieur de la machine virtuelle, comme je l'ai fait auparavant.  Il est n√©cessaire d'avoir un, voire deux lecteurs de sauvegarde, afin qu'il n'y ait pas un tel temps d'arr√™t de deux jours.  (les fichiers ont-ils disparu? Nous reculons, copions les fichiers de la sauvegarde et le simple - pas 48 heures, mais 2 heures de la force) Deuxi√®mement, ne faites rien sur ma t√™te lourde √† une heure du matin (si je me couchais, je viendrais avec une t√™te propre vendredi) √† une autre sortie, mais n'a pas cass√© de bois de chauffage dans la deuxi√®me heure de la nuit) Troisi√®mement, n'apportez pas de modifications importantes aux machines de travail.  D√©connectez-vous de la deuxi√®me machine virtuelle, faites-en un instantan√©, puis faites du lecteur parent le principal et voyez ce qui se passe apr√®s cela - c'est ainsi que cela a √©t√© fait.  Et quatri√®mement, effectuez encore plus de sauvegardes.  Pas seulement VM, mais esxi lui-m√™me dans son ensemble. </p><br><h3 id="ps-resursy-kotorye-v-konce-koncov-mne-pomogli">  Ressources PS qui m'ont finalement aid√©: </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le m√™me forum avec apavlyuchenko incroyable (nous ne sommes pas familiers, si cela)</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Page sur la base de connaissances de vmvara avec une description de mon probl√®me et des moyens de le r√©soudre</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'image que j'ai utilis√©e</a> </p><br><p>  si quelqu'un est int√©ress√©, dans les commentaires je peux laisser ces ressources dont les articles ne m'ont pas aid√© </p><br><h3 id="pss">  Pss </h3><br><p>  Malheureusement, le probl√®me de la disparition du lieu est toujours d'actualit√©.  Si vous avez des id√©es ou souhaitez m'aider √† y faire face, veuillez commenter.  On peut en parler l√†-bas.  Ou si vous connaissez une autre fa√ßon de r√©cup√©rer des fichiers √† partir de disques d'instantan√©s et que vous souhaitez √©galement les partager, je serai int√©ress√© de le lire.  Je vous remercie </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418049/">https://habr.com/ru/post/fr418049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418037/index.html">Testeur mobile pr√©parez-vous. Bienvenue dans le Meetup Avito Mobile Testing</a></li>
<li><a href="../fr418041/index.html">Environ 500 millions d'appareils IoT sont susceptibles d'attaquer par usurpation DNS</a></li>
<li><a href="../fr418043/index.html">Comment je ne suis pas parti aux √âtats-Unis et suis devenu pr√©sident en Russie</a></li>
<li><a href="../fr418045/index.html">Utilisation de fonctions JavaScript pour cr√©er des mod√®les 3D</a></li>
<li><a href="../fr418047/index.html">Les meilleurs employeurs en informatique: les premiers r√©sultats du service de notation chez My Circle</a></li>
<li><a href="../fr418051/index.html">Comment r√©parer un bureau ouvert: r√®gles de biblioth√®que</a></li>
<li><a href="../fr418053/index.html">Livrez en une demi-heure</a></li>
<li><a href="../fr418055/index.html">L'interface du jeu et ce qu'il mange</a></li>
<li><a href="../fr418057/index.html">¬´Apprendre, √©tudier et √©tudier √† nouveau¬ª: les meilleures conf√©rences de cet automne pour les d√©veloppeurs mobiles</a></li>
<li><a href="../fr418059/index.html">OpenSource APM Pinpoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>