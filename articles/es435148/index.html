<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçΩÔ∏è üë®üèæ‚Äçüé® üßëüèº Servidor DHCP nativo con bash üèº üåâ üòî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me encanta automatizar el proceso y escribir mis propias bicicletas para estudiar este o aquel material. Mi nuevo objetivo era un servidor DHCP, que e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor DHCP nativo con bash</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435148/"><img src="https://habrastorage.org/webt/cy/g3/b8/cyg3b8lmcpgxrj7j7_1jbfkxfta.png" align="left">  Me encanta automatizar el proceso y escribir mis propias bicicletas para estudiar este o aquel material.  Mi nuevo objetivo era un servidor DHCP, que emitir√° una direcci√≥n en redes peque√±as para que se pueda realizar la configuraci√≥n inicial del equipo. <br><br>  En este art√≠culo hablar√© un poco sobre el protocolo DHCP y algunas sutilezas de bash. <br><a name="habracut"></a><br><br><br><h1>  Resultado final </h1><br>  Comencemos desde el final, para que quede claro por qu√© luchamos. <br><br>  Demostraci√≥n de trabajo: <br><br><img src="https://habrastorage.org/webt/co/za/6j/coza6jzioblfbafujqfcanrffco.gif"><br><br>  Repositorio con script: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">firemoon777 / bash-dhcp-server</a> <br><br><h1>  Problema inicial </h1><br>  La configuraci√≥n que necesito se realiza de esta manera: nos conectamos directamente mediante un cable de par trenzado al equipo, emitimos una direcci√≥n temporal a trav√©s de DHCP y lo configuramos con un script ya creado.  Y as√≠, de diez a veinte veces seguidas. <br><br>  Para muchos, el conocido servidor isc-dhcp hace su trabajo perfectamente, pero, por desgracia, no notifica a mi script que se emite la direcci√≥n, por lo que debe bloquear de alguna manera la ejecuci√≥n hasta que se emita la direcci√≥n. <br><br>  Parece que la soluci√≥n est√° en la superficie: haga ping hasta que quede azul en la cara, hasta que el equipo responda: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ! ping -c1 -W1 <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">"</span></span> | grep -q <span class="hljs-string"><span class="hljs-string">"time="</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Waiting for </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Pero esta decisi√≥n definitivamente carece de aventurerismo. <br><br><h1>  Parte te√≥rica </h1><br><h3>  Obtener una direcci√≥n con un √∫nico servidor DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1t/5q/u9/1t5qu9ltl-tjqlkmc7egjfgjvpe.png"></div><br>  El protocolo DHCP funciona a trav√©s de UDP en los puertos 67 y 68. El servidor siempre funciona solo en 67 y el cliente solo en 68. Dado que el cliente no tiene una direcci√≥n (tiene la direcci√≥n 0.0.0.0), los paquetes DHCP se transmiten.  Es decir  el cliente siempre env√≠a paquetes a la direcci√≥n 255.255.255.255:67 desde la direcci√≥n 0.0.0.0:68, y el servidor env√≠a desde su direcci√≥n: 67 a la direcci√≥n 255.255.255.255:68. <br><br>  El cliente <b>recibe la</b> direcci√≥n en cuatro paquetes ( <b>DORA</b> ): <br><br><ol><li>  El cliente descubre d√≥nde est√° el servidor DHCP ( <b>D</b> iscover) </li><li>  El servidor responde y ofrece su direcci√≥n ( <b>O</b> ffer) </li><li>  El cliente solicita la direcci√≥n propuesta de un servidor espec√≠fico (Solicitud) </li><li>  El servidor acepta y emite la direcci√≥n ( <b>A</b> ck) </li></ol><br>  Visualmente, el esquema se puede representar de la siguiente manera: <br><br><img src="https://habrastorage.org/webt/j5/ug/zy/j5ugzyefd8qvd-wrcsjtdahmnbs.png"><br><br><h3>  Obtener una direcci√≥n con m√∫ltiples servidores DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/28/uo/fc/28uofcx-gthwmwhs8sgz0jrdysk.png"></div><br>  Cuando el cliente env√≠a Discover, todos los servidores que pueden escuchar env√≠an su oferta al cliente.  Pero el cliente debe elegir uno.  La selecci√≥n del cliente se anuncia en el mensaje Solicitud con la opci√≥n 54 (servidor DHCP), que contiene la direcci√≥n IP del servidor DHCP preferido.  Aunque la Solicitud tambi√©n se env√≠a a todos en la red, solo responder√° el servidor DHCP cuya IP se especifica en la opci√≥n 54. <br><br><img src="https://habrastorage.org/webt/ke/xi/rv/kexirvjfnljlm3pdhcpfqglh02a.png"><br><br><h3>  Contenido del paquete DHCP </h3><br>  Un paquete DHCP consta de dos partes: una constante, 236 bytes de tama√±o y una variable que lleva opciones (Opci√≥n DHCP). <br><br><div class="spoiler">  <b class="spoiler_title">Tabla con todos los campos del paquete DHCP de Wikipedia</b> <div class="spoiler_text"><table><tbody><tr><th>  El campo </th><th>  Descripci√≥n </th><th>  Longitud (en bytes) </th></tr><tr><td>  <b>op</b> <br></td><td>  Tipo de mensaje  Por ejemplo, puede tomar valores: BOOTREQUEST (0x01, solicitud del cliente al servidor) y BOOTREPLY (0x02, respuesta del servidor al cliente). <br></td><td>  1 <br></td></tr><tr><td>  <b>htype</b> <br></td><td>  Tipo de direcci√≥n de hardware.  Los valores v√°lidos para este campo se definen en los n√∫meros asignados RFC 1700.  Por ejemplo, para una direcci√≥n MAC de Ethernet, este campo se establece en 0x01. <br></td><td>  1 <br></td></tr><tr><td>  <b>hlen</b> <br></td><td>  La longitud de la direcci√≥n de hardware en bytes.  La direcci√≥n MAC de Ethernet es 0x06. <br></td><td>  1 <br></td></tr><tr><td>  <b>l√∫pulo</b> <br></td><td>  El n√∫mero de enrutadores intermedios (los llamados <i>agentes de retransmisi√≥n DHCP</i> ) a trav√©s de los cuales pas√≥ el mensaje.  El cliente establece este campo en 0x00. <br></td><td>  1 <br></td></tr><tr><td>  <b>xid</b> <br></td><td>  Un identificador de transacci√≥n √∫nico de 4 bytes generado por el cliente al comienzo del proceso de obtenci√≥n de la direcci√≥n. <br></td><td>  4 4 <br></td></tr><tr><td>  <b>segundos</b> <br></td><td>  El tiempo en segundos desde el inicio del proceso de obtenci√≥n de la direcci√≥n.  No se puede usar (en este caso se establece en 0x0000). <br></td><td>  2 <br></td></tr><tr><td>  <b>banderas</b> <br></td><td>  El campo para banderas es par√°metros especiales del protocolo DHCP. <br></td><td>  2 <br></td></tr><tr><td>  <b>ciaddr</b> <br></td><td>  Direcci√≥n IP del cliente.  Se completa solo si el cliente ya tiene su propia direcci√≥n IP y puede responder a las solicitudes ARP (esto es posible si el cliente realiza el procedimiento para actualizar la direcci√≥n despu√©s de que expire el contrato de arrendamiento). <br></td><td>  4 4 <br></td></tr><tr><td>  <b>yiaddr</b> <br></td><td>  La nueva direcci√≥n IP del cliente propuesta por el servidor. <br></td><td>  4 4 <br></td></tr><tr><td>  <b>siaddr</b> <br></td><td>  Direcci√≥n IP del servidor.  Devuelto en la cl√°usula DHCP (ver m√°s abajo). <br></td><td>  4 4 <br></td></tr><tr><td>  <b>giaddr</b> <br></td><td>  La direcci√≥n IP del agente de retransmisi√≥n, si uno estuvo involucrado en el proceso de entregar el mensaje DHCP al servidor. <br></td><td>  4 4 <br></td></tr><tr><td>  <b>chaddr</b> <br></td><td>  La direcci√≥n de hardware (generalmente la direcci√≥n MAC) del cliente. <br></td><td>  16 <br></td></tr><tr><td>  <b>nombre</b> <br></td><td>  Nombre del servidor opcional como una cadena terminada en nulo. <br></td><td>  64 <br></td></tr><tr><td>  <b>archivo</b> <br></td><td>  Un nombre de archivo de servidor opcional utilizado por estaciones de trabajo sin disco al descargar de forma remota.  Al igual que <b>sname</b> , se representa como una cadena terminada en nulo. <br></td><td>  128 <br></td></tr><tr><td>  <b>opciones</b> <br></td><td>  Campo de <i>opciones de DHCP</i> .  Aqu√≠ se indican varias opciones de configuraci√≥n adicionales.  Al comienzo de este campo, se indican cuatro bytes especiales con valores 99, 130, 83, 99 ("n√∫meros m√°gicos"), lo que permite al servidor determinar la presencia de este campo.  El campo tiene una longitud variable, pero el cliente DHCP debe estar listo para recibir un mensaje DHCP de 576 bytes (en este mensaje, el campo de <b>opciones</b> tiene una longitud de 340 bytes). <br></td><td>  variable <br></td></tr></tbody></table><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lista de todas las opciones de DHCP en RFC 2132</a> <br><br>  Las opciones de DHCP se codifican de la siguiente manera: <br><table><tbody><tr><td>  Numero </td><td>  Longitud </td><td>  Datos </td></tr></tbody></table><br>  Por ejemplo, el par√°metro 3 (puerta de enlace propuesta) con un valor de 10.0.0.1: <br><table><tbody><tr><td>  3 </td><td>  4 4 </td><td>  10 </td><td>  0 0 </td><td>  0 0 </td><td>  1 </td></tr></tbody></table><br>  En caso de que necesite pasar varios par√°metros, la longitud del par√°metro aumenta. <br>  Por ejemplo, en el par√°metro 6 (servidor DNS) transmitiremos dos direcciones (1.1.1.1 y 8.8.4.4): <br><table><tbody><tr><td>  6 6 </td><td>  8 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  8 </td><td>  8 </td><td>  4 4 </td><td>  4 4 </td></tr></tbody></table><br>  Una se√±al del final del campo de opci√≥n es un par√°metro con el n√∫mero 255 (0xFF) y una longitud de 0. <br><br>  Muy a menudo, el cliente coloca el par√°metro 55 (una lista de par√°metros que quiere recibir en respuesta) en DHCP Discover, sin embargo, tenemos el derecho de darle no todo lo que solicit√≥. <br><br><h1>  Parte pr√°ctica </h1><br>  Originalmente se plane√≥ escribir el servidor en un lenguaje m√°s adecuado (C) para esto, sin embargo, ser√≠a mundano y simple.  Se trata de escribir un script que se har√° cargo de las funciones del servidor dhcp. <br><br><h3>  Simplificaci√≥n </h3><br>  Como se supon√≠a que el servidor que se estaba desarrollando se utilizar√≠a en redes de dos nodos conectados por un parche, se adoptaron las siguientes simplificaciones: <br><br><ul><li>  garantizado que un cliente en la red; </li><li>  se garantiza que no hay m√°s servidores dhcp en la red </li><li>  el iniciador decide qu√© direcci√≥n emitir </li><li>  La versi√≥n de DHCP y la disminuci√≥n de DHCP se ignoran </li></ul><br><h3>  Oyente </h3><br>  En primer lugar, debe aprender a recibir paquetes.  Esto requiere un oyente <strike>comprensivo certificado</strike> , por ejemplo, nc.  Pero no todos los nc son adecuados para estos fines.  OpenBSD netcat 1.130 de Debian es adecuado, pero 1.105 con Ubuntu se ha ido.  Ejecute nc para escuchar todos los paquetes UDP que lleguen al puerto 67. <br><br><pre> <code class="bash hljs">nc -l 0.0.0.0 -up 67 -w0</code> </pre><br>  OpenBSD netcat tambi√©n es necesario debido al modificador -w con un valor de 0. Despu√©s de recibir un paquete (UDP Broadcast), el nc tradicional no recibe m√°s paquetes, pero no termina. <br><br><h3>  Manejo de bytes sin procesar </h3><br>  En el shell, es muy dif√≠cil trabajar con caracteres no imprimibles, como un car√°cter nulo: simplemente lo ignora.  Un paquete DHCP contiene muchos bytes 0x00 (por ejemplo, el campo del archivo).  La soluci√≥n al problema viene en forma de volcado hexadecimal: <br><br><pre> <code class="bash hljs"> nc -l 0.0.0.0 -up 67 -w0 | stdbuf -o0 od -v -w1 -t x1 -An</code> </pre><br>  Un byte por l√≠nea, sin generar la direcci√≥n, sin omitir bytes duplicados.  Tambi√©n puede darle vida a stdbuf -o0 para que la salida no est√© almacenada. <br><br><h3>  Recepci√≥n, almacenamiento y procesamiento de paquetes. </h3><br>  Desde el comando od stdout, el comando de lectura toma los bytes y los agrega a una matriz. <br><br><pre> <code class="bash hljs">msg=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {0..235}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -r tmp msg[<span class="hljs-variable"><span class="hljs-variable">$i</span></span>]=<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Aunque todos los valores se transmiten en notaci√≥n hexadecimal, el n√∫mero de opci√≥n DHCP y la longitud de la opci√≥n se muestran mejor en la pantalla / en los registros en la forma decimal habitual.  Para hacer esto, puede usar una entrada corta bash'a: <br><br><pre> <code class="bash hljs">$ op=AC $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $((16<span class="hljs-comment"><span class="hljs-comment">#$op)) 172</span></span></code> </pre><br>  El paquete recibido se edita seg√∫n el tipo de solicitud (Descubrir o Solicitar) y se devuelve. <br><br><h3>  Respuesta </h3><br>  Sin embargo, enviar un paquete no es una tarea tan f√°cil.  Primero necesita convertir bytes del volcado a bytes sin procesar y enviar todo de una vez con un paquete. <br><br>  La conversi√≥n se puede hacer con la utilidad printf usando secuencias de escape.  Y para que no se pierda nada, escriba bytes inmediatamente en un archivo. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   &gt;/tmp/dhcp.payload #     for i in ${msg[*]}; do printf "\x$i" &gt;&gt; /tmp/dhcp.payload done</span></span></code> </pre><br>  OpenBSD netcat tambi√©n se utiliza para enviar.  Sin embargo, si la versi√≥n 1.105 con Ubuntu es adecuada como escucha, no es adecuada para transmitir mensajes UDP: obtenemos el error de protocolo no disponible. <br><br><pre> <code class="bash hljs">cat /tmp/dhcp.payload | nc -ub 255.255.255.255 68 -s <span class="hljs-variable"><span class="hljs-variable">$SERVER</span></span> -p 67 -w0</code> </pre><br>  El modificador -b permite enviar mensajes de difusi√≥n, y esta es la segunda raz√≥n por la cual el servidor debe ejecutarse desde debajo del superusuario. <br><br><h1>  ¬øCu√°les son las limitaciones? </h1><br>  Este servidor DHCP fue dise√±ado con simplificaciones como un solo cliente en la red.  Sin embargo, funcionar√° con varios clientes.  Solo obt√©n la direcci√≥n m√°s r√°pida. <br><br><img src="https://habrastorage.org/webt/yq/45/5f/yq455faeeblrxvyhtp9zeffiktg.png"><br><br><h1>  Conclusi√≥n </h1><br>  Aunque los scripts de bash dif√≠cilmente pueden llamarse un lenguaje de programaci√≥n completo, sin embargo, con el debido deseo, incluso puede resolver problemas como emitir una direcci√≥n IP en la red sin usar un software especialmente dise√±ado para esto.  Y resolver problemas espec√≠ficos no solo trae alegr√≠a, sino tambi√©n nuevos conocimientos que se abrieron en el momento de la soluci√≥n. <br><br><h1>  Fuentes </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DHCP - Wikipedia</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Par√°metros DHCP y BOOTP - IANA</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435148/">https://habr.com/ru/post/es435148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435134/index.html">Simplifique el trabajo con bases de datos en Qt con QSqlRelationalTableModel</a></li>
<li><a href="../es435136/index.html">Sergey y el m√©todo cient√≠fico</a></li>
<li><a href="../es435138/index.html">C√≥mo tomar el control de su infraestructura de red. Cap√≠tulo tres Seguridad de red. Primera parte</a></li>
<li><a href="../es435142/index.html">Rastreo de aprendizaje utilizando eBPF: una gu√≠a y ejemplos</a></li>
<li><a href="../es435144/index.html">Introducci√≥n a Spring Boot: creaci√≥n de una API REST simple en Java</a></li>
<li><a href="../es435150/index.html">Ensayos cl√≠nicos en la puerta - Entrevista con Aubrey de Gray</a></li>
<li><a href="../es435152/index.html">La disputa de patentes entre Apple y Qualcomm llev√≥ a detener las ventas de iPhone 7 y 8 en Alemania</a></li>
<li><a href="../es435154/index.html">Memorias de un robot infrahumano, cap√≠tulos 9-12</a></li>
<li><a href="../es435156/index.html">Necesita m√°s c√°maras: Nokia 9 tiene 5 de ellas de inmediato</a></li>
<li><a href="../es435164/index.html">¬øPueden los Big Data y la IA resolver la crisis mundial del agua?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>