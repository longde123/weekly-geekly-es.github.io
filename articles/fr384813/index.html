<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòØ üÖ∞Ô∏è üë©üèª‚Äçüíª Adaptateur PPM vers USB sur STM32F3Discovery, ou Nous connectons la console du mod√®le d'avion √† l'ordinateur en tant que joystick HID avec STM32Cube üî´ üëÇüèª üìø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais vous expliquer comment:
 

- Cr√©ez un projet dans STM32CubeMX et configurez des minuteries pour capturer les signaux externe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adaptateur PPM vers USB sur STM32F3Discovery, ou Nous connectons la console du mod√®le d'avion √† l'ordinateur en tant que joystick HID avec STM32Cube</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384813/"><img src="https://habrastorage.org/files/42a/e17/45b/42ae1745bcc442529f2839504fdf51f4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je vais vous expliquer comment:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un projet dans STM32CubeMX et configurez des minuteries pour capturer les signaux externes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©codez un signal PPM √† partir d'une console de mod√®le d'avion. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un p√©riph√©rique d'interface humaine sur STM32 et √©crivez votre descripteur de rapport HID. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volez dans un simulateur sur un quadricopt√®re de course. </font><font style="vertical-align: inherit;">:)</font></font></li>
</ul><a name="habracut"></a><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©face</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©cemment, les courses FPV sur des quadrocopt√®res de la 250e classe (FPV - First Person View) gagnent de plus en plus en popularit√©. </font><font style="vertical-align: inherit;">Le nombre 250 signifie la distance entre les axes des moteurs en diagonale, typique des petits copters maniables. </font><font style="vertical-align: inherit;">Ces appareils sont construits sur des cadres en carbone durables qui r√©sistent aux chutes et aux collisions. </font><font style="vertical-align: inherit;">Les h√©lices d'un diam√®tre de 5-6 pouces avec un grand pas (angle d'inclinaison des pales) sont plac√©es sur des moteurs puissants pour le vol le plus dynamique. </font><font style="vertical-align: inherit;">L'image du cam√©scope √† capuchon analogique est transmise √† une fr√©quence de 5,8 GHz au moniteur ou aux lunettes vid√©o du pilote. </font><font style="vertical-align: inherit;">√âtant donn√© que la transmission num√©rique via WiFi cr√©e un long d√©lai (200-300 ms), la vid√©o est toujours diffus√©e sur un canal analogique. </font><font style="vertical-align: inherit;">Pour enregistrer des clips spectaculaires, des cam√©ras d'action sont embarqu√©es (GoPro, Mobius, SJcam, Xiaomi Yi, etc.).</font></font><br>
<br>
<div style="text-align:center;"><img width="40%" src="https://habrastorage.org/files/727/722/0e5/7277220e5a8c4b749415d16d28091648.jpg"></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici quelques vid√©os passionnantes sur les h√©licopt√®res FPV:</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/NsxyV-kgfio%3Ffeature%3Doembed&amp;usg=ALkJrhhpLKDgxU7mVvMKysSuob--oiIDlA" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/1MBW8zoZUR4%3Ffeature%3Doembed&amp;usg=ALkJrhhL-Xqe7jF-UlDh63qe6sLwd-G4pw" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/70pusNNunMA%3Ffeature%3Doembed&amp;usg=ALkJrhhq3D3nkbdZXbQ-gPZ4FZz7Q9nDiA" frameborder="0" allowfullscreen=""></iframe></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de construire mon propre quadricopt√®re, je voulais voler dans un simulateur et voir si je serais int√©ress√© par les courses FPV. Pour la formation, le simulateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPV FreeRider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est bien adapt√© </font><font style="vertical-align: inherit;">. Il est peu co√ªteux, dispose d'une version de d√©monstration gratuite et, selon des pilotes exp√©riment√©s, imite tr√®s pr√©cis√©ment la vraie m√©canique du vol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez contr√¥ler l'avion dans le simulateur √† partir du clavier ou du joystick. Le clavier est mal adapt√© au pilotage, car les boutons ne peuvent transmettre qu'une valeur discr√®te (le bouton est enfonc√© / non enfonc√©) et il est impossible de transmettre des valeurs interm√©diaires variant en douceur. Les joysticks des consoles de jeu avec des sticks analogiques sont bien meilleurs, mais ils ont un tr√®s petit stick, ce qui ne vous permet pas de contr√¥ler l'appareil avec suffisamment de pr√©cision. Une option id√©ale pour un simulateur est une console de mod√®le d'avion connect√©e √† un ordinateur via un adaptateur sp√©cial, gr√¢ce √† laquelle le syst√®me d'exploitation le voit comme un joystick.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais d√©j√† un quadricopt√®re, assembl√© pour les vols tranquilles et la photographie, mais trop grand et lourd pour la course. En cons√©quence, il y avait une t√©l√©commande - Turnigy 9X (dans la premi√®re illustration). √Ä l'arri√®re, il poss√®de un connecteur pour connecter un adaptateur auquel un signal PPM est √©mis. Ce signal est une impulsion courte avec des intervalles de 1 √† 2 millisecondes, dont la dur√©e correspond √† la position des commandes (plus √† ce sujet dans la section sur le d√©codage).</font></font><br>
<br>
<div style="text-align:center;"><img width="33%" src="https://habrastorage.org/files/68b/cc1/4f0/68bcc14f02164d51a17401da82253df4.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dois dire que les adaptateurs pour connecter la t√©l√©commande de PPM √† USB ont √©t√© lib√©r√©s depuis longtemps et sont vendus avec puissance et principal. </font><font style="vertical-align: inherit;">Un adaptateur similaire dans le facteur de forme du lecteur flash peut √™tre achet√© pour 5 $ en Chine ou un peu plus cher dans les magasins russes. </font><font style="vertical-align: inherit;">Il existe √©galement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des projets d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adaptateur </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">open source</font></a><font style="vertical-align: inherit;"> sur les contr√¥leurs AVR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais un vif d√©sir de voler m'est imm√©diatement venu tard dans la soir√©e, alors que tous les magasins de maquettes d'avions de Moscou √©taient d√©j√† ferm√©s. </font><font style="vertical-align: inherit;">Je ne voulais pas attendre le matin, il n'y avait pas de temps pour empoisonner et souder la carte avec ATmega, j'ai donc d√©cid√© de faire un adaptateur PPM-USB sur la carte STM32F3Discovery, qui √©tait depuis longtemps inactive et √† port√©e de main.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qui est requis</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour fabriquer un adaptateur, vous aurez besoin de:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">STM32F3Discovery</a>.     STM32,     USB,   . </li>
<li>  c - 3,5     ( Turnigy)   BLS-,   ,   ( Discovery).</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">STM32CubeMX</a>. </li>
<li>IDE    ARM.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Keil uVision 5</a>.          32 ,      .</li>
<li> Turnigy 9X     PPM-.       FlySky FS-i6.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes de d√©bogage de d√©couverte sont assez ch√®res. </font><font style="vertical-align: inherit;">Le F3 d√©crit co√ªte environ 20 $ et ses capacit√©s sont redondantes pour un projet aussi simple. </font><font style="vertical-align: inherit;">Je l'ai utilis√© car au moment de l'√©criture, c'√©tait la seule carte avec un mat√©riel USB que j'ai trouv√©e √† la maison. </font><font style="vertical-align: inherit;">Pour ceux qui ne l'ont pas encore achet√©, je peux vous conseiller de faire attention aux cartes miniatures avec le contr√¥leur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 d'AliExpress pour 3 $</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le programmeur ST-Link √† partir de l√†. </font><font style="vertical-align: inherit;">Le processus ne diff√®re pas de celui d√©crit dans l'article. </font><font style="vertical-align: inherit;">√Ä moins qu'il ne soit n√©cessaire de choisir un autre contr√¥leur au d√©but, indiquez la pr√©sence d'un r√©sonateur √† quartz et utilisez un brochage l√©g√®rement diff√©rent.</font></font><br>
<br>
<div style="text-align:center;"><img width="30%" src="https://habrastorage.org/files/cf1/88d/0a1/cf188d0a1da94acfb233350ff94830ae.jpg"></div><br>
<br>
<a name="cube"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation d'un projet dans STM32CubeMX</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32Cube est un package d√©velopp√© par STMicroelectronics afin de faciliter la vie des d√©veloppeurs d'appareils STM32. Il se compose de l'utilitaire graphique CubeMX, des pilotes HAL et des composants middleware. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CubeMX</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil pour cr√©er des projets et initialiser des p√©riph√©riques. Pour commencer, s√©lectionnez simplement le contr√¥leur, cochez les cases des modules requis, s√©lectionnez les modes requis dans le menu et entrez les valeurs souhait√©es dans plusieurs champs. CubeMX va g√©n√©rer le projet et y connecter les biblioth√®ques n√©cessaires. Le d√©veloppeur de l'appareil √©crira uniquement la logique de l'application. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilotes HAL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Hardware Abstraction Layer) est une API pour travailler avec les modules et les p√©riph√©riques du microcontr√¥leur. HAL vous permet de s√©parer la couche sup√©rieure de l'application cr√©√©e par le d√©veloppeur de l'utilisation des registres et de rendre le code du programme aussi portable que possible entre les familles de contr√¥leurs STM32. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou composants interm√©diaires, incluent le syst√®me d'exploitation FreeRTOS, une biblioth√®que pour travailler avec le syst√®me de fichiers, les biblioth√®ques USB, TCP / IP, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait qu'il soit d√©sormais possible de "programmer avec la souris" au lieu d'√©crire manuellement des bits dans les registres. </font><font style="vertical-align: inherit;">Mais la simplicit√© et la commodit√© n'annulent pas le fait que vous devez √©tudier la documentation, en particulier dans les cas o√π vous devez r√©duire la vitesse maximale, la consommation d'√©nergie minimale ou utiliser des p√©riph√©riques dans des modes non standard. </font><font style="vertical-align: inherit;">STM32Cube ne couvre pas encore 100% de toutes les capacit√©s du microcontr√¥leur, mais il approche. </font><font style="vertical-align: inherit;">STMicroelectronics met √† jour Cube de temps √† autre, √©tend les fonctions et corrige les bogues. </font><font style="vertical-align: inherit;">Par cons√©quent, si vous avez d√©j√† install√© Cube, v√©rifiez qu'il s'agit de la derni√®re version.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Param√®tres initiaux</font></font></b></h5><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/acf/6b2/4fc/acf6b24fc6c449f58c2be3b9ce9d1c1e.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le travail avec le projet commence par le choix du contr√¥leur. Lancez STM32CubeMX, cliquez sur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouveau projet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lecteur MCU</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">vous pouvez s√©lectionner le contr√¥leur souhait√© dans les filtres. Puisque nous avons une carte de d√©bogage termin√©e, dans l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lecteur de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carte </font><font style="vertical-align: inherit;">, nous trouvons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F3Discovery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Apr√®s avoir choisi une carte, une image du contr√¥leur avec des broches en surbrillance et sign√©es appara√Ætra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quatre grands onglets dans la partie sup√©rieure de la fen√™tre: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brochage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour configurer les fonctions de broche et les modules de pr√©r√©glage. Nous y sommes pour le moment. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> horloge - r√©glage de l'horloge, PLL, diviseurs. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">configuration</font></i><font style="vertical-align: inherit;"> plus d√©taill√©e des p√©riph√©riques et middleware.</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculateur de consommation d'√©nergie</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - calcul de la puissance consomm√©e par le microcontr√¥leur. </font></font><br>
<br>
<img src="https://habrastorage.org/files/d02/a54/3a7/d02a543a7fe148d99d67ae83ad6a8fc9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le menu de gauche de l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brochage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">vous</font></i><font style="vertical-align: inherit;"> pouvez utiliser les p√©riph√©riques souhait√©s et, sur le circuit du contr√¥leur, s√©lectionner une fonction pour l'une des sorties du microcontr√¥leur. Certains √©l√©ments √† gauche sont des ic√¥nes d'avertissement. Cela signifie que les modules (dans ce cas ADC, DAC, OPAMP2, RTC) peuvent d√©sormais √™tre utilis√©s de mani√®re incompl√®te, car certaines de leurs sorties sont d√©j√† occup√©es par d'autres fonctions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les broches configur√©es sont surlign√©es en vert sur le circuit du contr√¥leur. </font><font style="vertical-align: inherit;">Puisque nous n'avons pas choisi un contr√¥leur nu sans cerclage, mais une carte de d√©bogage F3-Discovery pr√™te √† l'emploi, certaines des sorties sont d√©j√† configur√©es, par exemple, un bouton bleu est connect√© √† PA0 et des LED √† PE8 ... 15. </font><font style="vertical-align: inherit;">Les broches auxquelles certains p√©riph√©riques externes sont connect√©s sur Discovery sont surlign√©es en orange, mais leurs modules p√©riph√©riques n'ont pas encore √©t√© configur√©s. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir, ce sont des broches pour USB, des r√©sonateurs √† quartz, SPI et I2C pour gyroscope et boussole, DP et DM pour USB. </font><font style="vertical-align: inherit;">Les conclusions grises ne sont pas utilis√©es actuellement, nous ne pouvons en appliquer aucune √† nos fins.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lection d'entr√©e</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons capturer la dur√©e des impulsions, donc l'entr√©e doit √™tre connect√©e √† l'un des canaux de n'importe quelle minuterie. </font><font style="vertical-align: inherit;">De plus, le niveau du signal avec Turnigy 9X n'est pas de 3,3 V, comme la tension d'alimentation du STM32, mais de 5 V. </font><font style="vertical-align: inherit;">Nous sommes trop paresseux pour souder le diviseur de tension, vous devez donc choisir une entr√©e pouvant r√©sister √† 5V (ces entr√©es sont appel√©es tol√©rantes √† 5V). </font><font style="vertical-align: inherit;">Les broches appropri√©es peuvent √™tre trouv√©es dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fiche technique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur STM32F303VCT6 dans la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brochage et description des broches</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il existe de nombreux temporisateurs dans le STM32F3, ils sont dispers√©s sur presque toutes les broches. </font><font style="vertical-align: inherit;">Une option pratique est PC6. </font><font style="vertical-align: inherit;">Il peut supporter 5 volts et est situ√© dans le coin inf√©rieur gauche de la carte, √† c√¥t√© de GND. </font><font style="vertical-align: inherit;">Affectez le 1er canal du 3√®me temporisateur TIM3_CH1 √† cette broche.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb7/4b2/67e/eb74b267e70140b9842408158de617e8.png"></div><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©glage de l'horloge</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que l'USB fonctionne, le microcontr√¥leur doit √™tre cadenc√© √† une fr√©quence tr√®s stable, c'est pourquoi presque tous les p√©riph√©riques USB ont des r√©sonateurs √† quartz. La stabilit√© de fr√©quence du g√©n√©rateur RC int√©gr√© n'est pas suffisante pour l'USB. Mais sur la carte STM32F3 Discovery, les d√©veloppeurs pour une raison quelconque √©taient gourmands et ne mettaient pas de quartz. Cependant, si vous √©tudiez attentivement le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">circuit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous pouvez voir que le </font><font style="vertical-align: inherit;">signal </font><i><font style="vertical-align: inherit;">MCO</font></i><font style="vertical-align: inherit;"> est connect√© </font><font style="vertical-align: inherit;">√† l'entr√©e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PF0-OSC_IN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π le quartz doit √™tre connect√© </font><font style="vertical-align: inherit;">. Il provient du programmateur ST-Link sur la m√™me carte dans laquelle il y a du quartz. Le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">manuel</font></a><font style="vertical-align: inherit;"> de l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">utilisateur</font></a><font style="vertical-align: inherit;"> pour la d√©couverte F3 (UM1570) dans la section </font><i><font style="vertical-align: inherit;">Horloge OSC</font></i><font style="vertical-align: inherit;"> indique que 8 MHz sont </font><font style="vertical-align: inherit;">envoy√©s </font><font style="vertical-align: inherit;">√† cette ligne.</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img width="30%" src="https://habrastorage.org/files/b5c/234/80f/b5c23480ffca498d8e52e6fef4c0892f.png"><img width="65%" src="https://habrastorage.org/files/c00/160/fb8/c00160fb809b4c7190390d8a8ccd3ac6.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le microcontr√¥leur est cadenc√© √† partir d'une source externe. Ce mode est appel√© contournement. Dans le menu des param√®tres p√©riph√©riques de la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RCC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">pour synchroniser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> horloge </font><i><font style="vertical-align: inherit;">haute vitesse,</font></i><font style="vertical-align: inherit;"> s√©lectionnez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BYPASS Clock Source</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/934/7e5/17e/9347e517e21540a88c922d35d881c009.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de proc√©der √† un r√©glage d'horloge plus d√©taill√©, nous notons dans le menu p√©riph√©rique que le microcontr√¥leur agira comme un p√©riph√©rique USB. </font></font><br>
<br>
<img src="https://habrastorage.org/files/597/c20/ddb/597c20ddbe2e4c2898c90db97110e454.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant acc√©der au grand onglet suivant - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de l'horloge</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ici, nous allons voir un √©norme diagramme, qui montre quels signaux d'horloge sont pr√©sents dans le microcontr√¥leur, d'o√π ils viennent, comment ils se ramifient, se multiplient et se divisent. En jaune, j'ai mis en √©vidence les param√®tres √† noter. </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a5/9a8/596/1a59a8596d434c1f8d09ee5e8335adee.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifiez que la fr√©quence d'entr√©e</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fr√©quence d'entr√©e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de 8 MHz. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons r√©gl√© le commutateur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL Source Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High Speed ‚Äã‚ÄãExternal) pour l'horloge √† partir d'une source externe plut√¥t que d'une source interne. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Boucle √† verrouillage de phase, ou PLL - Boucle √† verrouillage de phase, sert √† multiplier la fr√©quence externe plusieurs fois. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©glez le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> multiplicateur </font><i><font style="vertical-align: inherit;">PLLMul</font></i><font style="vertical-align: inherit;"> sur 9. Ensuite, nous atteindrons la fr√©quence maximale possible pour le STM32F303 - 72 MHz. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le System Clock Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit √™tre en position </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLLCLK pour</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que la fr√©quence d'horloge soit multipli√©e par la PLL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le module USB, 48 MHz sont n√©cessaires, alors mettez un diviseur 1,5 devant USB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites attention √† la fr√©quence</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Horloge APB1 horloges</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le c√¥t√© gauche du circuit. </font><font style="vertical-align: inherit;">Il va aux minuteries et nous sera utile √† l'avenir. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une fr√©quence est mal configur√©e, d√©passe la valeur maximale possible ou si les commutateurs sont dans une position invalide, CubeMX mettra en √©vidence cet endroit en rouge.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©glage de la minuterie</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour mesurer la dur√©e d'impulsion, nous allons d√©marrer le temporisateur TIM3 en mode Capture d'entr√©e. Dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuel de r√©f√©rence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sous la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minuteries √† usage g√©n√©ral (TIM2 / TIM3 / TIM4),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un sch√©ma illustre le fonctionnement des minuteries. Avec les couleurs, j'ai mis en √©vidence les signaux et les registres utilis√©s en mode capture d'entr√©e. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e76/54c/ea5/e7654cea52cb46c891e5a73e91068b71.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le signal d'horloge surlign√© en vert entre en permanence dans le registre du compteur CNT et incr√©mente sa valeur de 1 √† chaque cycle d'horloge. Dans le diviseur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler PSC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la </font><font style="vertical-align: inherit;">fr√©quence d'horloge peut diminuer pour un comptage plus lent. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un </font><font style="vertical-align: inherit;">signal externe est </font><font style="vertical-align: inherit;">entr√© dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMx_CH1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©tecteur de bord</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il reconna√Æt les fronts du signal d'entr√©e - transitions de 0 √† 1 ou de 1 √† 0. Lors de l'enregistrement d'un front, il donne deux commandes surlign√©es en jaune: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- une commande pour √©crire la valeur du compteur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registre de capture / comparaison 1 (CCR1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et appeler l'interruption </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC1I</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- une commande pour le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contr√¥leur de mode esclave</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , par laquelle la valeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><font style="vertical-align: inherit;">remise √† 0 et le compte √† rebours recommence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici une illustration du processus dans une chronologie:</font></font><br>
<br>
<img width="50%" src="https://habrastorage.org/files/3b5/80b/ab0/3b580bab0b894981b8d28eadd9f444b2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une interruption se produit, nous effectuerons des actions avec la valeur captur√©e. Si les impulsions d'entr√©e surviennent trop souvent et que les actions qui se produisent dans le gestionnaire d'interruption sont trop longues, la valeur de CCR1 peut √™tre √©cras√©e avant de lire la pr√©c√©dente. Dans ce cas, vous devez v√©rifier le drapeau Overcapture ou appliquer DMA (Direct Memory Access) lorsque les donn√©es de CCR1 remplissent automatiquement le tableau pr√©par√© en m√©moire. Dans notre cas, l'impulsion la plus courte a une dur√©e de 1 milliseconde, et le gestionnaire d'interruption sera simple et court, alors ne vous inqui√©tez pas de l'√©crasement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Revenez √† l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brochage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et r√©glez la minuterie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le menu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P√©riph√©riques</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/437/703/50b/43770350badf4efcb4d02a11ea2f9db0.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mode esclave: mode de r√©initialisation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- signifie qu'√† un certain √©v√©nement, le temporisateur sera r√©initialis√© √† 0. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source de d√©clenchement: TI1FP1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'√©v√©nement utilis√© pour r√©initialiser et d√©marrer le temporisateur est le front de signal captur√© √† partir de l'entr√©e TI1. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClockSource: horloge interne</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la minuterie est synchronis√©e √† partir du g√©n√©rateur interne du microcontr√¥leur. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Channel 1: Input Capture direct mode</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - capture les intervalles du premier canal dans le registre CCR1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le prochain grand onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous </font><font style="vertical-align: inherit;">allons faire des param√®tres de minuterie suppl√©mentaires.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/db8/b67/8d8/db8b678d8f7846c9af081a0bfdb0d7b1.png"></div><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/63b/6ac/c06/63b6acc06716451399d01566635d2f87.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un diviseur de minuterie. S'il est √©gal √† 0, la fr√©quence est prise directement √† partir de l'horloge du bus d'horloge APB - 72 MHz. Si le pr√©-√©chelle est 1, la fr√©quence est divis√©e par 2 et devient 36 MHz. R√©glez le diviseur sur 71 pour que la fr√©quence soit divis√©e par 72. Ensuite, la fr√©quence du minuteur sera de 1 MHz et les intervalles seront mesur√©s avec une r√©solution de 1 microseconde. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Counter Period</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d√©finissez la valeur maximale possible de 16 bits 0xFFFF. La p√©riode est importante pour g√©n√©rer des tranches de temps, par exemple, pour PWM. Mais la p√©riode n'est pas importante pour capturer des signaux; nous la ferons conna√Ætre comme √©tant grande pour toutes les impulsions d'entr√©e. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lection de la polarit√©:</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> front descendant - les valeurs de la minuterie seront captur√©es sur le front descendant du signal d'entr√©e. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Param√®tres NVIC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">mettez un daw</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interruption globale TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de sorte que les √©v√©nements li√©s au 3e temporisateur g√©n√®rent une interruption.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration du p√©riph√©rique USB</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons d√©j√† not√© que le contr√¥leur sera un p√©riph√©rique USB. </font><font style="vertical-align: inherit;">Comme le joystick appartient √† la classe des appareils HID, dans le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menu Middlewares -&gt; USB_DEVICE,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√©lectionnez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe pour FS IP: HID (Human Interface Device Class)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ensuite, CubeMX connectera les biblioth√®ques du p√©riph√©rique HID au projet. </font></font><br>
<br>
<img src="https://habrastorage.org/files/3fe/080/472/3fe0804729bd4b2f995c5f32a9173d47.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons aux param√®tres </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB_DEVICE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/574/ba7/dde/574ba7dde3794ce4911f955e628f7ce7.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'ID du fournisseur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l' </font><i><font style="vertical-align: inherit;">ID du </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont deux identifiants 16 bits uniques √† chaque mod√®le de p√©riph√©rique USB. Le VID correspond au fabricant de l'appareil, et chaque fabricant attribue un PID, guid√© par ses propres consid√©rations. Je n'ai pas pu trouver la liste officielle des VID et PID, je n'ai trouv√© que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base d'identifiants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> support√©e par les passionn√©s. Pour obtenir votre propre ID de fournisseur, vous devez vous rendre sur le forum des impl√©menteurs USB sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usb.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et payer quelques milliers de dollars. Les petites entreprises ou les d√©veloppeurs open source qui ne peuvent pas se permettre leur VID peuvent demander un fabricant de puces USB et recevoir officiellement une paire VID / PID pour leur projet. Un tel service est propos√©, par exemple, par FTDI ou Silicon Laboratories.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous connectez deux appareils avec le m√™me VID / PID, mais d'un type diff√©rent (par exemple, l'un est un appareil HID et l'autre est le stockage de masse), le syst√®me d'exploitation essaiera d'installer le m√™me pilote pour eux, et au moins l'un d'entre eux ne fonctionnera pas. C'est pourquoi les paires VID / PID pour diff√©rents mod√®les d'appareils doivent √™tre uniques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous ne fabriquons pas d'appareil pour nous-m√™mes, nous n'allons pas le vendre et le distribuer, nous quitterons le VID 0x0483, correspondant √† STMicroelectronics, et nous proposerons notre propre PID. Par d√©faut, CubeMX propose le PID 0x5710 pour le p√©riph√©rique HID. Remplacez-le, par exemple, par 0x57FF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remplacez la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cha√Æne de produit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adaptateur STM32 PPM-USB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ce nom appara√Ætra dans la liste des appareils dans le Panneau de configuration de Windows. Nous ne changerons pas encore le num√©ro de s√©rie (S \ N). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque Windows le d√©tecte, il d√©tecte un p√©riph√©rique avec une combinaison de VID, PID et S \ N qu'il n'a jamais vu auparavant, le syst√®me installe le pilote appropri√©. Si la combinaison de VID, PID et S \ N a d√©j√† √©t√© utilis√©e, Windows remplace automatiquement le pilote utilis√© pr√©c√©demment. Vous pouvez le voir, par exemple, lorsque vous connectez le lecteur flash √† USB. La premi√®re connexion et l'installation prennent du temps. Lors des connexions suivantes, le lecteur commence √† fonctionner presque instantan√©ment. Cependant, si vous connectez une autre instance du lecteur Flash du m√™me mod√®le, mais avec un num√©ro de s√©rie diff√©rent, le syst√®me installera un nouveau pilote pour lui, m√™me s'il a le m√™me VID et PID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais expliquer pourquoi c'est important. </font><font style="vertical-align: inherit;">Si vous avez cr√©√© une souris USB sur votre STM32 avec votre VID, PID et S \ N, que vous l'avez connect√©e √† l'ordinateur, puis que vous avez cr√©√© un joystick USB sans changer le VID, PID et S \ N, Windows percevra le nouveau p√©riph√©rique comme une souris qui a d√©j√† utilis√© dans le syst√®me et n'installe pas le pilote du joystick. </font><font style="vertical-align: inherit;">Par cons√©quent, le joystick ne fonctionnera pas. </font><font style="vertical-align: inherit;">Par cons√©quent, si vous souhaitez changer le type de votre appareil, en laissant le VID / PID inchang√©, assurez-vous de changer son num√©ro de s√©rie.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©ration de projets pour IDE</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les derniers param√®tres que vous devez d√©finir sont les param√®tres de g√©n√©ration de projet. Cela se fait via </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projet -&gt; Param√®tres</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... L√†, nous allons d√©finir le nom, le dossier de destination et l'IDE souhait√©, sous lequel CubeMX cr√©era le projet. J'ai choisi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MDK-ARM V5</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car j'utilise Keil uVision 5. Dans l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rateur de code</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">vous pouvez cocher la </font><font style="vertical-align: inherit;">case </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copier uniquement les fichiers de biblioth√®que n√©cessaires</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin de </font><font style="vertical-align: inherit;">ne pas encombrer le projet avec des fichiers inutiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appuyez sur le bouton </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projet -&gt; G√©n√©rer du code</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . CubeMX cr√©era un projet avec du code qui peut √™tre ouvert dans Keil uVision et compil√© et flash√© sans param√®tres suppl√©mentaires. Dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principale (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des fonctions ont d√©j√† √©t√© ins√©r√©es pour initialiser l'horloge, les ports, la minuterie et l'USB. Dans ces modules, les modules du microcontr√¥leur sont configur√©s conform√©ment aux modes que nous d√©finissons dans CubeMX. </font></font><br>
<br>
<img src="https://habrastorage.org/files/fb6/a32/393/fb6a323933734c7cb3ac4e11550d7420.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le code, on trouve souvent des constructions de ce type:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span><font></font>
(...)<font></font>
<span class="hljs-comment">/* USER CODE END 0 */</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est suppos√© que l'utilisateur incorporera son code dans ces sections. Si l'option </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conserver le code utilisateur lors</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la r√©g√©n√©ration est activ√©e dans les param√®tres du projet CubeMX </font><font style="vertical-align: inherit;">, le code entre ces lignes ne sera pas √©cras√© lors de la g√©n√©ration secondaire d'un projet existant. Malheureusement, seules les sections cr√©√©es par CubeMX sont enregistr√©es. Les sections </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ * CODE UTILISATEUR * /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cr√©√©es par l'utilisateur seront perdues. Par cons√©quent, si apr√®s avoir √©crit le code dans l'EDI vous souhaitez revenir √† CubeMX et g√©n√©rer √† nouveau le projet avec les nouveaux param√®tres, je vous recommande de faire une copie de sauvegarde du projet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les param√®tres du firmware dans uVision ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Configurer les outils Flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), je vous conseille d'activer l'option </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©initialiser apr√®s flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de sorte que le microcontr√¥leur d√©marre imm√©diatement apr√®s le clignotement. </font><font style="vertical-align: inherit;">Par d√©faut, il est d√©sactiv√©, et apr√®s chaque clignotement, vous devez appuyer sur le bouton Reset de la carte.</font></font><br>
<br>
<img src="https://habrastorage.org/files/1e1/a3d/20d/1e1a3d20dd994c1787f8a8758fcd200e.png"><br>
<br>
<a name="ppm"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©codage PPM</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPM - Pulse Position Modulation - une m√©thode de codage des signaux transmis, tr√®s r√©pandue dans l'√©lectronique de mod√®le d'avion. </font><font style="vertical-align: inherit;">Il s'agit d'une s√©quence d'impulsions dont les intervalles de temps correspondent aux valeurs num√©riques transmises.</font></font><br>
<br>
<div style="text-align:center;"><img width="80%" src="https://habrastorage.org/files/905/3ec/257/9053ec2573f8438b9a3053f2ef408739.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon ce protocole, la console envoie des informations au module radio √©metteur, qui est ins√©r√© dans la console √† l'arri√®re. De nombreux r√©cepteurs plac√©s √† bord de l'h√©licopt√®re peuvent transmettre des signaux de commande au contr√¥leur de vol via PPM. De plus, presque toutes les consoles ont des connecteurs pour connecter une deuxi√®me console en mode formateur-√©l√®ve et pour connecter la console √† un simulateur, qui utilise g√©n√©ralement PPM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©crivons un signal √† partir de la sortie du simulateur de Turnigy 9X avec un analyseur logique:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/53e/da5/319/53eda5319a6d45b59ee6e265de445992.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque s√©quence encode l'√©tat actuel des commandes de la t√©l√©commande. Habituellement, les quatre premi√®res valeurs (√©galement appel√©es canaux) correspondent √† la position des sticks analogiques et les suivantes √† la position des interrupteurs √† bascule ou potentiom√®tres. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La position minimale du contr√¥le correspond √† l'intervalle 1000 Œºs, le maximum - 2000 Œºs, la position moyenne - 1500 Œºs. Les rafales d'impulsions, ou trames, sont s√©par√©es par des intervalles sensiblement plus longs et suivent avec une p√©riode de 20‚Äì25 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons de plus pr√®s le signal:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/703/86d/84e/70386d84efe24577a958767f8c5b7ae9.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, trois b√¢tons sont en position neutre (1, 3, 4) et un en position extr√™me (2). </font><font style="vertical-align: inherit;">Trois interrupteurs √† bascule sont d√©sactiv√©s (5, 6, 7) et le dernier est activ√© (8). </font><font style="vertical-align: inherit;">Le microcontr√¥leur, agissant comme un adaptateur, doit capturer une telle s√©quence, ajouter les valeurs √† une matrice et l'envoyer via USB en tant que commande √† partir du joystick. </font><font style="vertical-align: inherit;">√âcrivons un d√©codeur de s√©quence d'impulsions.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capture d'interruption</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s l'initialisation dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boucle while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principale </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> d√©marrez le temporisateur TIM3 en mode de capture Input Capture √† partir du canal 1, avec la g√©n√©ration d'interruptions de capture. </font><font style="vertical-align: inherit;">Pour ce faire, utilisez la fonction correspondante de HAL:</font></font><br>
<br>
<pre><code class="cpp hljs">HAL_TIM_IC_Start_IT(&amp;htim3, TIM_CHANNEL_1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">htim3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©clar√©e dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le gestionnaire de temporisation TIM3, qui contient toutes les structures et variables associ√©es √† la temporisation: param√®tres d'initialisation, pointeurs vers tous les registres de temporisation (valeur de compteur, diviseur, tous les param√®tres, drapeaux d'interruption), pointeur sur un gestionnaire DMA qui fonctionne avec cette minuterie, etc. Le d√©veloppeur n'a pas besoin de rechercher quels bits dans quel registre sont responsables de quoi et de les d√©finir et de les r√©initialiser manuellement. Il suffit de passer le gestionnaire √† la fonction HAL. Les biblioth√®ques HAL feront le reste elles-m√™mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les principes de structure HAL sont d√©crits plus en d√©tail dans le document </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Description des pilotes HAL STM32F3xx</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UM1786). Il convient de noter que les biblioth√®ques HAL elles-m√™mes sont bien document√©es. Pour comprendre comment le HAL fonctionne pour le minuteur et comment l'utiliser, vous pouvez lire les commentaires dans les </font><i><font style="vertical-align: inherit;">fichiers </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour chaque interruption g√©n√©r√©e par le temporisateur TIM3, le gestionnaire </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><i><font style="vertical-align: inherit;">appel√©</font></i><font style="vertical-align: inherit;"> . Il se trouve dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_it.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dans lequel le </font><i><font style="vertical-align: inherit;">gestionnaire HAL_TIM_IRQHandler</font></i><font style="vertical-align: inherit;"> , standard pour tous les temporisateurs, y est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appel√©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et un pointeur vers la structure htim3 lui est transmis.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM3_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 0 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 0 */</span><font></font>
  HAL_TIM_IRQHandler(&amp;htim3);<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 1 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 1 */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous regardons √† l'int√©rieur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IRQHandler stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous voyons un √©norme gestionnaire qui v√©rifie les drapeaux d'interruption pour que le temporisateur provoque la fonction de rappel et efface le drapeau apr√®s l'ex√©cution. </font><font style="vertical-align: inherit;">Si un √©v√©nement de capture </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se produit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il appelle la fonction </font><i><font style="vertical-align: inherit;">HAL_TIM_IC_CaptureCallback</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cela ressemble √† ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">__weak <span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
<span class="hljs-comment">/* NOTE : This function Should not be modified, when the callback is needed, the __HAL_TIM_IC_CaptureCallback could be implemented in the user file</span><font></font><span class="hljs-comment">
*/</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que nous pouvons passer outre cette fonction dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par cons√©quent, ins√©rez </font><font style="vertical-align: inherit;">ce rappel </font><font style="vertical-align: inherit;">avant la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int main (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voudrais voir comment l'interruption est effectu√©e. </font><font style="vertical-align: inherit;">Ajoutez-y un rapide rappel de l'une des conclusions:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_SET);<font></font>
  __nop();__nop();__nop();__nop();__nop();__nop();<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_RESET);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La broche PE8 a d√©j√† √©t√© initialis√©e en sortie. </font><font style="vertical-align: inherit;">Entre l'activation et la d√©sactivation, des instructions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__nop ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont ins√©r√©es </font><font style="vertical-align: inherit;">, ce qui forme un retard de 1 cycle d'horloge. </font><font style="vertical-align: inherit;">Ceci est fait pour que mon analyseur logique chinois √† 8 $ fonctionnant √† 24 MHz ne manque pas une impulsion trop courte d'un microcontr√¥leur 72 MHz. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilez</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> maintenant le projet </font><i><font style="vertical-align: inherit;">Project -&gt; Build target</font></i><font style="vertical-align: inherit;"> et demandez au contr√¥leur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Download</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous allons connecter le PPM de la t√©l√©commande au PC6 et voir ce qui se passe sur le PC6 et le PE8 avec l'analyseur.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/abf/64c/e2c/abf64ce2c6874057933df9edb58dff8f.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le rappel est vraiment appel√© au bon moment - juste apr√®s la transition du signal d'entr√©e de 1 √† 0. Donc, tout a √©t√© fait correctement.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capturez et traitez les donn√©es captur√©es</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons modifier le rappel afin qu'il ajoute chaque valeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">captur√©e au</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tampon </font><font style="vertical-align: inherit;">captur√©_valeur inchang√©. Si le temporisateur capture une tr√®s grande valeur (plus de 5000 Œºs), cela signifie qu'une pause a √©t√© enregistr√©e, le paquet a √©t√© re√ßu dans son int√©gralit√© et il peut √™tre trait√©. Les valeurs trait√©es sont ajout√©es au tableau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 5 √©l√©ments. Dans les quatre premiers, les positions du manche sont r√©duites √† la plage [0; 1000], dans le cinqui√®me, les bits individuels sont d√©finis conform√©ment aux interrupteurs √† bascule, qui seront interpr√©t√©s comme une pression sur les boutons de la manette de jeu.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> captured_value[<span class="hljs-number">8</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint16_t</span> rc_data[<span class="hljs-number">5</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint8_t</span> pointer = <span class="hljs-number">0</span>;<font></font>
<span class="hljs-keyword">uint8_t</span> data_ready = <span class="hljs-number">0</span>;<font></font>
<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
    <span class="hljs-keyword">uint8_t</span> i;<font></font>
    <span class="hljs-keyword">uint16_t</span> temp;<font></font>
    <span class="hljs-comment">//     </span><font></font>
    temp = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);<font></font>
    <span class="hljs-comment">//    , ,  </span><font></font>
    <span class="hljs-keyword">if</span> ((temp &gt; <span class="hljs-number">5000</span>) &amp;&amp; (!data_ready))<font></font>
    {<font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-comment">//        [0;1000]</span><font></font>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (captured_value[i] &lt; <span class="hljs-number">1000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">1000</span>;<font></font>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (captured_value[i] &gt; <span class="hljs-number">2000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">2000</span>;<font></font>
            rc_data[i] = captured_value[i]<span class="hljs-number">-1000</span>;<font></font>
        };<font></font>
        <span class="hljs-comment">//     </span><font></font>
        rc_data[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">4</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">5</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">6</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">7</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>);<font></font>
        data_ready = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-comment">//      </span><font></font>
    {<font></font>
        captured_value[pointer] = temp;<font></font>
        pointer++;<font></font>
    };<font></font>
    <span class="hljs-keyword">if</span> (pointer == <span class="hljs-number">8</span>) <span class="hljs-comment">//   </span><font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettez-moi d'expliquer pourquoi j'ai plac√© les bits correspondant aux boutons non pas dans les 4 bits inf√©rieurs, mais dans les cinqui√®me √† huiti√®me bits. Dans le simulateur, il est cens√© connecter une manette de jeu √† partir de la Xbox, o√π les boutons LB, RB, D√©marrer et Retour sont utilis√©s, et ils ont des nombres de 5 √† 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la boucle principale, le drapeau data_ready sera tourn√© en continu, par lequel les donn√©es seront envoy√©es √† l'ordinateur.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    <span class="hljs-comment">//      </span><font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour v√©rifier comment cela fonctionne, connectez la t√©l√©commande, compilez-la et flashez-la √† nouveau, puis d√©marrez le d√©bogage </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©bogage -&gt; D√©marrer / Arr√™ter la session de d√©bogage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrez la fen√™tre pour les </font><font style="vertical-align: inherit;">variables de </font><font style="vertical-align: inherit;">suivi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affichage -&gt; Voir Windows -&gt; Regarder 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ajouter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">captured_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RC_DATA l√†</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commen√ßons le d√©bogage avec la commande </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Run</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et en temps r√©el, sans m√™me ajouter de points d'arr√™t, nous verrons comment les nombres changent apr√®s les sticks.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/5cf/7da/c9c/5cf7dac9c152498e89ea3948a8549efb.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez envoyer des donn√©es √† l'ordinateur sous la forme d'une commande par joystick.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurer le p√©riph√©rique HID et cr√©er un descripteur de rapport HID</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USB HID (Human Interface Device) est une classe d'appareils pour l'interaction homme-ordinateur. Il s'agit notamment de claviers, souris, joysticks, manettes de jeu, panneaux tactiles. Le principal avantage des appareils HID est qu'ils ne n√©cessitent aucun pilote sp√©cial dans aucun syst√®me d'exploitation: Windows, OS X, Android et m√™me iOS (via l'adaptateur USB-Lightning). Une description d√©taill√©e peut √™tre trouv√©e dans le document </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finition de classe de p√©riph√©rique pour HID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La principale chose que nous devons savoir pour cr√©er un adaptateur PPM-USB est ce que sont le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapport </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le </font><i><font style="vertical-align: inherit;">descripteur de rapport HID</font></i><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le p√©riph√©rique HID envoie des paquets d'octets √† l'ordinateur dans un format pr√©d√©fini. Chacun de ces packages est un rapport HID. L'appareil informe l'ordinateur du format des donn√©es lorsqu'il se connecte, en envoyant un descripteur de rapport HID, une description du paquet qui indique le nombre d'octets que contient le paquet et le but de chaque octet et bit du paquet. Par exemple, le rapport HID d'une simple souris se compose de quatre octets: le premier octet contient des informations sur les boutons enfonc√©s, les deuxi√®me et troisi√®me octets contiennent le mouvement relatif du curseur le long de X et Y, et le quatri√®me octet contient la rotation de la molette de d√©filement. Le descripteur de rapport est stock√© dans la m√©moire du contr√¥leur de p√©riph√©rique sous la forme d'un tableau d'octets.</font></font><br>
<br>
<div style="text-align:center;"><img width="35%" src="https://habrastorage.org/files/22f/dd2/aa6/22fdd2aa67154365a6f89f6a2f7f2798.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de cr√©er un descripteur, je voudrais m'attarder s√©par√©ment sur la terminologie. Deux termes sont courants dans l'environnement de langue anglaise - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le mot </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©n√©ralement appel√© un manipulateur qui est tenu d'une main et inclin√© dans diff√©rentes directions, et la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manette de jeu</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un appareil avec des boutons et des b√¢tons qui est tenu √† deux mains. Les utilisateurs russophones appellent g√©n√©ralement le joystick √† la fois cela et un autre. Dans la description de l'appareil HID, il y a une diff√©rence entre le joystick et la manette de jeu. La console de mod√®le d'avion est plus similaire dans son but fonctionnel √† une manette de jeu, donc √† l'avenir, j'utiliserai parfois le terme ¬´manette de jeu¬ª.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons g√©n√©r√© un projet, indiquant que l'appareil agira comme un appareil d'interface humaine. </font><font style="vertical-align: inherit;">Cela signifie qu'une biblioth√®que USB HID est connect√©e au projet et qu'un descripteur de p√©riph√©rique a d√©j√† √©t√© g√©n√©r√©. </font><font style="vertical-align: inherit;">Il se trouve dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , d√©crit le rapport de la souris et ressemble √† ceci:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_Mouse_Report_Descriptor</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> HID_MOUSE_ReportDesc[HID_MOUSE_REPORT_DESC_SIZE]  __ALIGN_END =<font></font>
{<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x19</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x29</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x30</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x31</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x38</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x81</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x7F</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x08</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x06</span>,
  <span class="hljs-number">0xC0</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x3c</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0xff</span>,   <span class="hljs-number">0x09</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x15</span>,
  <span class="hljs-number">0x00</span>,   <span class="hljs-number">0x25</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x95</span>,<font></font>
<font></font>
  <span class="hljs-number">0x02</span>,   <span class="hljs-number">0xb1</span>,
  <span class="hljs-number">0x22</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x06</span>,   <span class="hljs-number">0x95</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xb1</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xc0</span><font></font>
};<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cr√©ation manuelle d'un descripteur de rapport HID prend beaucoup de temps. </font><font style="vertical-align: inherit;">Pour faciliter la t√¢che, il existe un outil appel√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Descriptor Tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (DT). </font><font style="vertical-align: inherit;">Ce programme peut cr√©er un descripteur pour votre appareil. </font><font style="vertical-align: inherit;">Dans l'archive avec elle, vous pouvez trouver plusieurs exemples de descripteurs pour diff√©rents appareils.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/a3c/6fd/07c/a3c6fd07c997415ab94ba603edda628d.png"></div><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tr√®s bon article sur la cr√©ation de votre propre descripteur HID pour souris et clavier (en anglais). Je vais vous dire en russe comment faire une poign√©e pour une manette de jeu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le rapport HID envoy√© par la console doit contenir quatre valeurs 16 bits pour deux axes de sticks analogiques et 16 valeurs un bit pour les boutons. Total 10 octets. Sa poign√©e cr√©√©e dans DT ressemblera √† ceci:</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// USAGE_PAGE (Generic Desktop)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x05</span>,                    <span class="hljs-comment">// USAGE (Game Pad)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// COLLECTION (Application)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE (Pointer)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x30</span>,                    <span class="hljs-comment">//     USAGE (X)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x31</span>,                    <span class="hljs-comment">//     USAGE (Y)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x33</span>,                    <span class="hljs-comment">//     USAGE (Rx)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x34</span>,                    <span class="hljs-comment">//     USAGE (Ry)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x09</span>,                    <span class="hljs-comment">//   USAGE_PAGE (Button)</span><font></font>
    <span class="hljs-number">0x19</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE_MINIMUM (Button 1)</span><font></font>
    <span class="hljs-number">0x29</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   USAGE_MAXIMUM (Button 16)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x25</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   LOGICAL_MAXIMUM (1)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   REPORT_SIZE (1)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   REPORT_COUNT (16)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//   INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>                           <span class="hljs-comment">// END_COLLECTION</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne semble pas moins intimidant qu'un descripteur de souris. </font><font style="vertical-align: inherit;">Mais si vous comprenez ce que signifie chaque ligne, tout se r√©v√®le tout √† fait compr√©hensible et logique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE montre comment le syst√®me doit interpr√©ter les donn√©es qui vont plus loin. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreux types d'utilisation, ils sont class√©s en groupes - Pages d'utilisation. </font><font style="vertical-align: inherit;">Par cons√©quent, pour s√©lectionner une utilisation sp√©cifique, vous devez d'abord vous r√©f√©rer √† la USAGE_PAGE correspondante. </font><font style="vertical-align: inherit;">√Ä propos de l'utilisation que vous pouvez trouver dans le document </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hid Usage Tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Au tout d√©but du descripteur, nous indiquons que le joystick sera d√©crit:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Generic Desktop) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Game Pad)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
COLLECTION combine plusieurs jeux de donn√©es associ√©s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La collecte physique est utilis√©e pour les donn√©es li√©es √† un point g√©om√©trique sp√©cifique, par exemple, un stick analogique. </font><font style="vertical-align: inherit;">La collection d'applications est utilis√©e pour combiner diff√©rentes fonctions dans un seul appareil. </font><font style="vertical-align: inherit;">Par exemple, un clavier avec trackpad int√©gr√© peut avoir deux applications Collection. </font><font style="vertical-align: inherit;">Nous d√©crivons uniquement le joystick, ce qui signifie que la collection sera une:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (Application) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, vous devez sp√©cifier que les √©l√©ments qui transmettent les coordonn√©es seront d√©crits. </font><font style="vertical-align: inherit;">Le pointeur d'utilisation est utilis√© pour d√©crire les souris, les manettes de jeu, les manettes de jeu, les num√©riseurs:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTILISATION (pointeur)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les descriptions des cl√©s analogiques combin√©es dans une collection:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (physique)</font></font><br>
 <blockquote>USAGE (X)<br>
 USAGE (Y)<br>
 LOGICAL_MINIMUM (0)<br>
 LOGICAL_MAXIMUM (1000)<br>
 REPORT_SIZE (16)<br>
 REPORT_COUNT (2)<br>
 INPUT (Data,Var,Abs)</blockquote>END_COLLECTION</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE indique ici que les valeurs d'√©cart le long des deux axes, X et Y, sont </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
utilis√©es </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">LOGICAL_MINIMUM et LOGICAL_MAXIMUM sp√©cifient la mesure dans laquelle la valeur transmise peut varier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
REPORT_COUNT et REPORT_SIZE d√©finissent, respectivement, combien de nombres et quelle taille nous allons transf√©rer, √† savoir deux nombres de 16 bits. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INPUT (Data, Var, Abs) signifie que les donn√©es proviennent de l'appareil vers l'ordinateur, et ces donn√©es peuvent changer. Les valeurs dans notre cas sont absolues. Par exemple, les valeurs relatives proviennent de la souris pour d√©placer le curseur. Parfois, les donn√©es sont d√©crites comme Const, pas Var. Cela est n√©cessaire pour transmettre des bits non significatifs. Par exemple, dans un rapport de souris avec trois boutons, 3 bits de Var pour les boutons et 5 bits de Const sont transf√©r√©s pour compl√©ter la taille de transfert √† un octet.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, les descriptions des axes X et Y sont regroup√©es. </font><font style="vertical-align: inherit;">Ils ont la m√™me taille, les m√™mes limites. </font><font style="vertical-align: inherit;">Le m√™me stick analogique pourrait √™tre d√©crit comme suit, d√©crivant chaque axe individuellement. </font><font style="vertical-align: inherit;">Un tel descripteur fonctionnera de mani√®re similaire au pr√©c√©dent:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (physique)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (X) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (Y) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s le premier stick, le deuxi√®me stick analogique est d√©crit. </font><font style="vertical-align: inherit;">Ses axes ont une utilisation diff√©rente afin que vous puissiez les distinguer du premier b√¢ton - Rx et Ry:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (physique)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (Rx) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 USAGE (Ry) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Data, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant d√©crire quelques boutons de la manette de jeu. </font><font style="vertical-align: inherit;">Cela peut √™tre fait comme suit:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (bouton) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bouton 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bouton 2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bouton 3) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bouton 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'enregistrement encombrant de boutons du m√™me type peut √™tre r√©duit en utilisant la plage d'utilisation:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (bouton) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MINIMUM (bouton 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MAXIMUM (bouton 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es transmises par les boutons sont 16 valeurs mono-bit, variant de 0 √† 1:</font></font><br>
<blockquote>LOGICAL_MINIMUM (0)<br>
LOGICAL_MAXIMUM (1)<br>
REPORT_SIZE (1)<br>
REPORT_COUNT (16)<br>
INPUT (Data,Var,Abs)</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ordre des lignes dans le descripteur n'est pas strict. Par exemple, Logical_Minimum et Logical_Maximum peuvent √™tre √©crits avant Usage (Button), ou les lignes Report_Size et Report_Count peuvent √™tre √©chang√©es. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important que la commande Input ait tous les param√®tres n√©cessaires pour le transfert de donn√©es (Usage, Mimimum, Maximum, Size, Count). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le descripteur est form√©, il peut √™tre v√©rifi√© avec la commande </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parse Descriptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour les erreurs. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est en ordre, exportez-le avec l'extension h. Dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> remplacez le descripteur par un nouveau et ajustez dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> taille du descripteur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_MOUSE_REPORT_DESC_SIZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 74 √† 61. Les </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rapports sont envoy√©s √† l'aide de l'indicateur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_ready</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pour cela</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c nous</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inclurons le fichier d'en-t√™te </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et dans la boucle principale nous appellerons la fonction d'envoi de rapport. </font><font style="vertical-align: inherit;">Le tableau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type uint16, donc le pointeur vers celui-ci doit √™tre converti en type 8 bits et passer en taille 10 au lieu de 5.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"usbd_hid.h"</span></span><font></font>
...<font></font>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    USBD_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword">uint8_t</span>*)rc_data, <span class="hljs-number">10</span>);<font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  };<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous compilons le projet et le flasher √† nouveau.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connexion et utilisation</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rebranchez le c√¢ble USB du connecteur USB ST-LINK au connecteur USB UTILISATEUR. </font><font style="vertical-align: inherit;">Windows d√©tectera le nouveau p√©riph√©rique et installera automatiquement le pilote. </font><font style="vertical-align: inherit;">Allons dans le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panneau de configuration -&gt; P√©riph√©riques et imprimantes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et voyons notre p√©riph√©rique adaptateur USB-PPM STM32 avec une ic√¥ne de manette de jeu.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/1ee/5ad/846/1ee5ad84654545dfbcec807073ef8207.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les param√®tres de l'appareil, vous pouvez voir comment la croix se d√©place sur le terrain et les colonnes se d√©placent apr√®s le d√©placement des b√¢tons, et les symboles des boutons s'allument √† partir de l'interrupteur √† bascule. </font><font style="vertical-align: inherit;">L'√©talonnage n'est pas n√©cessaire car les valeurs minimales et maximales ont d√©j√† √©t√© d√©finies dans le descripteur.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/52c/4b0/9db/52c4b09db3074871b917aa74b3375de6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä partir de FPV FreeRider, nous verrons comment, sur l'√©cran principal de la manette virtuelle dessin√©e, les b√¢tons se d√©placent conform√©ment √† notre t√©l√©commande. </font><font style="vertical-align: inherit;">Si les axes ne sont pas attribu√©s correctement pour une raison quelconque, vous pouvez les reconfigurer dans la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calibrer le contr√¥leur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les interrupteurs √† bascule correspondant aux boutons de la t√©l√©commande sont utilis√©s pour changer de mode de vol (acrobatique / stabilis√©), changer la vue de la cam√©ra (du bord / du sol), d√©marrer un vol depuis le d√©but ou allumer la course pendant un certain temps.</font></font><br>
<br>
<div style="text-align:center;"><img width="70%" src="https://habrastorage.org/files/153/bc2/3a8/153bc23a87bd4fedad1dd9b04c2aae22.png"></div><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vol√©!</font></font></b></h3><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/ilMeTba4EOE%3Ffeature%3Doembed&amp;usg=ALkJrhh5YFlfSUScga7Un6IcP2Qw5HN8kQ" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la vid√©o - le r√©sultat de plusieurs jours de ma formation. Pendant que je vole avec le nivellement automatique, et non en mode acrobatique, comme le font tous les ma√Ætres de la course FPV. En mode acro, si vous rel√¢chez les baguettes, l'h√©licopt√®re ne revient pas automatiquement en position horizontale, mais continue de voler sous le m√™me angle qu'il a vol√©. La gestion en mode acro est beaucoup plus difficile, mais vous pouvez atteindre une vitesse, une maniabilit√© plus grandes, faire des bouleversements dans les airs et m√™me voler √† l'envers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aux </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charpu Masters</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je suis encore tr√®s loin, mais je continue √† m'entra√Æner et je peux dire avec certitude que l'id√©e d'un mini-h√©licopt√®re de course m'a encore plus int√©ress√©. </font><font style="vertical-align: inherit;">Et bient√¥t, je serai d√©finitivement engag√© dans sa construction et ses vols non plus dans le simulateur, mais dans la dure r√©alit√©, avec de vrais crashs, des h√©lices cass√©es, des moteurs cass√©s et des batteries br√ªl√©es. </font><font style="vertical-align: inherit;">Mais c'est un sujet pour d'autres articles :)</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le projet pour Keil uVision 5 et STM32CubeMX est sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr384813/">https://habr.com/ru/post/fr384813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr384801/index.html">Dernier jour de Pomp√©i: des scientifiques italiens ont scann√© les restes des victimes de la catastrophe</a></li>
<li><a href="../fr384803/index.html">Paul Graham: des id√©es pour une startup bio</a></li>
<li><a href="../fr384805/index.html">Les sp√©cialistes d'IFixit d√©truisent AppleTV et Apple d√©sinstalle l'application iFixit d'AppStore</a></li>
<li><a href="../fr384809/index.html">Papier ou "num√©ro"? Les deux: examen du stylo intelligent NeoLAB Convergence Neo smartpen N2</a></li>
<li><a href="../fr384811/index.html">Opinion d'expert: Mat√©riaux semi-conducteurs en √©lectronique</a></li>
<li><a href="../fr384815/index.html">Des t√©l√©phones pour la s√©curit√© des enfants et la tranquillit√© de leurs parents: une revue du nouveau bb-mobile</a></li>
<li><a href="../fr384817/index.html">Des milliers de photos d'Apollo t√©l√©charg√©es sur Flickr</a></li>
<li><a href="../fr384819/index.html">Au lieu de "ne pas √™tre m√©chant", "Google" fait maintenant "la bonne chose"</a></li>
<li><a href="../fr384821/index.html">L'√©l√®ve a pr√©sent√© un gant qui permettra aux personnes souffrant de troubles de la parole de communiquer</a></li>
<li><a href="../fr384823/index.html">Des moyens non standard pour promouvoir les jeux mobiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>