<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧙🏼 🎯 🧒🏻 Kakak sedang menonton ... dirinya sendiri atau peta dengan sejarah gerakan di HomeAssistant 👪 🐬 #⃣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entri 
 Untuk otomatisasi rumah saya, saya telah menggunakan HomeAssistant untuk waktu yang lama. Begitu seorang teman bertanya kepada saya, mereka be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kakak sedang menonton ... dirinya sendiri atau peta dengan sejarah gerakan di HomeAssistant</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448656/"><h3>  Entri </h3><br>  Untuk otomatisasi rumah saya, saya telah menggunakan HomeAssistant untuk waktu yang lama.  Begitu seorang teman bertanya kepada saya, mereka berkata, mengapa HomeAssistant memiliki kemampuan untuk menunjukkan hanya posisi pelacak saat ini di peta, tetapi tidak mungkin untuk menampilkan seluruh rute?  Sejak itu, ide ini telah menangkap saya.  Dan begitu saya menyadari bahwa saya benar-benar ingin memiliki fungsi ini sekarang.  Semua orang yang tertarik dengan apa yang terjadi, selamat datang di kucing… <br><a name="habracut"></a><br><h3>  Kecerdasan </h3><br>  Sebenarnya, untuk menampilkan rute, Anda harus memiliki satu set titik dengan koordinat, jadi langkah pertama adalah mencari tahu di mana HomeAssistant menyimpan data yang diperlukan (jika ada) dan bagaimana cara mengeluarkannya dari sana.  Sebuah studi singkat tentang sumber utama segera mengarah ke solusi: Anda memerlukan modul perekam yang disertakan untuk merekam status sensor yang diperlukan dalam database di berbagai titik waktu, serta modul sejarah, yang memungkinkan Anda untuk mendapatkan data dari database dengan cara yang indah.  Modul history memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">API REST yang</a> terdokumentasi dengan baik.  Apa yang kamu butuhkan! <br><br>  Selanjutnya, Anda harus entah bagaimana menampilkan data yang diterima di peta.  Ada banyak layanan berbeda yang memungkinkan Anda menampilkan riwayat pergerakan.  Saya mungkin mencoba jauh dari mereka semua, tetapi saya akan membiarkan diri saya beberapa kata tentang yang saya periksa: <br>  <b>A.</b>  yandex dan google.  Sebenarnya untuk kebutuhan saya ada segalanya dan bahkan lebih, tetapi karena layanan berbayar dan pembatasan kuat dari versi gratis, mereka tidak cocok untuk saya segera.  Yandex, misalnya, memungkinkan penggunaan gratis hanya untuk proyek terbuka (yaitu, siapa pun harus dapat membuka sumber daya Anda kapan saja dan memanfaatkan kemampuannya), belum lagi pembatasan lain pada jumlah permintaan.  Hanya pemalas yang tidak menulis tentang perubahan kebijakan Google terkait api.  Saat ini, seperti yang saya mengerti, setiap permintaan untuk memetakan api atau arah api dibayar, semakin banyak permintaan - semakin murah.  Namun, setiap pengguna dengan kartu bank yang terhubung ke akunnya diberikan batas gratis $ 200 per bulan.  Segala sesuatu di atas segera dibayarkan dari kartu Anda.  Menautkan kartu ke akun bukanlah cara kami. <br><br>  Benar jika saya membuat kesalahan di suatu tempat tentang google dan / atau yandex. <br><br>  <b>B.</b>  Sekelompok peta OpenRouteService dan OpenRouteService.  Pada prinsipnya, kemampuannya tidak jauh berbeda dengan google atau yandex (dalam hal apa pun, saya tidak memperhatikan).  Benar-benar gratis (ada batasan jumlah permintaan per hari dan per menit, jika terlampaui, disarankan untuk menghubungi dukungan ... tidak ada uraian tentang tarif yang dibayar sama sekali).  Namun, penggunaan sumber daya peta OpenRouteService ternyata tidak nyaman (pemuatan aplikasi yang lama dan menu lebar yang mengganggu di sebelah kiri, yang terbuka secara default dan tidak dinonaktifkan oleh API, apalagi, layanan tidak terbuka dengan benar dari perangkat seluler).  Dalam keadilan, peta OpenRouteService dapat diletakkan di server Anda dan sangat mungkin bahwa di sana Anda dapat mengkonfigurasi semuanya untuk Anda sendiri. <br><br>  <b>B.</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kodebb</a>  Saya menemukan implementasi kartu yang menarik dalam format sederhana.  Pada prinsipnya, proyek ini sangat cocok untuk tugas saya, namun, dari artikel ini saya belajar tentang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Leaflet</a> dan memutuskan untuk beralih ke sumbernya.  Pada akhirnya, dia berhenti di situ ... <br><br>  <b>G.</b>  Leaflet.  Pustaka js open-source yang sangat bagus untuk peta, mudah dipelajari dan didokumentasikan dengan baik.  Dari chip: memungkinkan Anda menggunakan ubin dari banyak layanan (openstreetmaps, yandex, google, mapbox, microsoft, dll., Dll.).  Selain itu, saya menggunakan plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">leaflet.polylineDecorator</a> untuk menunjukkan arah gerakan di peta. <br><br>  Perlu disebutkan bahwa dua sumber daya terakhir yang dipertimbangkan tidak mendukung "rute", yaitu, mereka tidak tahu bagaimana menghubungkan titik di sepanjang jalan dan / atau trotoar yang ada, tetapi hanya menghubungkan titik-titik dengan garis lurus.  Bagi saya pribadi, ini bukan masalah, tetapi langkah sadar.  Jika Anda membutuhkan navigasi di jalan, maka Anda perlu melihat ke arah google dibayar, yandex atau layanan openroutes gratis. <br><br><h3>  Implementasi </h3><br>  Permintaan ke modul histori melalui REST-API cukup sederhana (selanjutnya kode akan menggunakan bahasa HomeAssistant, yaitu python) dan memungkinkan Anda untuk mendapatkan jawaban dalam bentuk JSON sederhana untuk memahami: <br><br><pre><code class="python hljs">response = requests.get(self._haddr + <span class="hljs-string"><span class="hljs-string">'/api/history/period/'</span></span> + dayBegin + <span class="hljs-string"><span class="hljs-string">'?filter_entity_id='</span></span> + self._myid, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer '</span></span> + self._token, <span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) data = response.json()[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  di sini self._haddr adalah alamat HA Anda sama seperti yang ditentukan dalam pengaturan frontend, self._myid adalah id perangkat dari device_tracker, yang rute yang akan kami bangun, dayBegin adalah awal periode untuk menampilkan rute, saya memilih awal hari saat ini secara default, self._token adalah token yang tahan lama untuk mengakses api, yang dapat diperoleh di antarmuka HomeAssistant. <br><br>  Ketika objek yang sejarahnya ingin kita tampilkan di peta diam untuk waktu yang lama atau bergerak sangat lambat, kita akan mendapatkan banyak titik yang letaknya dekat dan menyumbat peta.  Untuk memperbaiki situasi, biarkan array koordinat yang dihasilkan melewati filter: jika jarak antara titik sebelumnya dan berikutnya kurang dari 100 meter, maka jangan tampilkan titik pada peta.  Untuk menghitung jarak antara dua titik tetangga, kami menggunakan rumus yang disederhanakan dengan pendekatan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ekuuler</a> .  Perkiraan ini berlaku ketika jarak antara titik-titik tetangga tidak melebihi beberapa km: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, latA, lonA, latB, lonB)</span></span></span><span class="hljs-function">:</span></span> dst = <span class="hljs-number"><span class="hljs-number">0</span></span> latRadA = math.radians(latA) lonRadA = math.radians(lonA) latRadB = math.radians(latB) lonRadB = math.radians(lonB) x = latRadB - latRadA y = (lonRadB-lonRadA)*math.cos((latRadB+latRadA)*<span class="hljs-number"><span class="hljs-number">0.5</span></span>) dst = <span class="hljs-number"><span class="hljs-number">6371</span></span>*math.sqrt(x*x+y*y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dst</code> </pre> <br>  Di sini dst adalah jarak dalam km. <br><br>  Jelaskan Leaflet API di sini tidak melihat intinya.  Untuk ini - di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">situs web resmi</a> .  Modul ini bekerja sebagai berikut: Setiap n detik (saya telah menetapkannya ke 300) permintaan dibuat untuk sejarah hari ini dari objek yang menarik bagi saya.  Array koordinat yang dihasilkan dijalankan melalui filter jarak, mengurangi jumlah titik.  Selanjutnya, dalam folder dengan konfigurasi HomeAssistant di folder www, 2 file terbentuk: index.html dan route.html.  File route.html berisi semua logika untuk membuat peta.  Dan file index.html adalah hack seumur hidup untuk mencegah caching halaman.  Secara default, HomeAssistant melakukan cache semua yang mungkin, dan hanya mengatur ulang cache membantu memperbarui data pada kartu, yang, tentu saja, tidak dapat diterima.  Dalam file index.html, isi route.html dipanggil, namun dengan parameter acak yang dihasilkan secara dinamis, yang memungkinkan Anda untuk selalu meminta versi route.html saat ini dari server: <br><br><pre> <code class="xml hljs">src = 'route.html?datetime=' + (new Date()).getTime() + Math.floor(Math.random() * 1000000)</code> </pre> <br><h3>  Sedikit tentang keamanan </h3><br>  HomeAssistant dirancang agar semua file di dalam direktori www bersifat publik, yaitu file apa pun di dalam direktori www dapat dibuka di browser apa pun tanpa izin apa pun, mengetahui tautan langsung.  Dalam hal modul saya, tautan ini adalah ini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Jika ini tidak penting untuk Anda, maka Anda dapat melewati bagian ini.  Saya melangkah lebih jauh dan memutar otorisasi ke halaman dengan rute.  Untuk ini, saya menggunakan nginx (Anda dapat memilih server web lain dengan dukungan proxy terbalik) sebagai server proxy.  Situs web HomeAssistant memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">instruksi</a> resmi untuk mengatur konfigurasi ini.  Setelah mengatur proxy dan memeriksa operasi, Anda perlu menambahkan otorisasi ke halaman yang diperlukan dalam konfigurasi nginx: <br><br><pre> <code class="plaintext hljs">location /local/route/route.html { proxy_pass http://localhost:8123/local/route/route.html; proxy_set_header Host $host; proxy_redirect http:// https://; proxy_http_version 1.1; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; auth_basic "Unauthorized"; auth_basic_user_file /etc/nginx/.htpasswd; }</code> </pre> <br>  Kemudian buat file "/etc/nginx/.htpasswd" dan jalankan perintah berikut di konsol: <br><br><pre> <code class="bash hljs">sh -c <span class="hljs-string"><span class="hljs-string">"echo -n 'admin:' &gt;&gt; /etc/nginx/.htpasswd"</span></span> sh -c <span class="hljs-string"><span class="hljs-string">"openssl passwd -apr1 &gt;&gt; /etc/nginx/.htpasswd"</span></span></code> </pre> <br>  admin - ganti dengan login yang diinginkan. <br><br>  Setelah itu, mulai ulang nginx dan periksa: ketika mencoba membuka halaman dengan rute, browser harus meminta nama pengguna dan kata sandi.  Saya perhatikan bahwa ini adalah otorisasi terpisah yang tidak ada hubungannya dengan otorisasi HomeAssistant itu sendiri. <br><br><h3>  Kesimpulan </h3><br>  Mungkin semua yang bisa dikatakan tentang modul ini. <br>  Yang tertarik, di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini ada tautan</a> ke modul.  Tempatkan file di sepanjang jalan: config_folder_homeassistant / custom_components / route / sensor.py, jangan lupa tentang haknya. <br><br>  Jika tidak ada, buat folder config_folder_homeassistant / www dan berikan hak yang sesuai. <br><br>  Di file konfigurasi, konfigurasi.yaml, tulis baris berikut: <br><br><pre> <code class="plaintext hljs">sensor: - platform: route name: route entityid: your_device_tracker_entity_id haddr: your_address_homeassistant token: your_long_life_token</code> </pre> <br>  di sini your_device_tracker_entity_id adalah ID dari device_tracker perangkat Anda, your_address_homeassistant adalah alamat eksternal HomeAssistant Anda, your_long_life_token adalah token akses yang sebelumnya diterima di antarmuka HomeAssistant untuk menggunakan API REST. <br><br>  Setelah itu, restart HomeAssistant dan nikmati.  Peta akan tersedia melalui tautan langsung: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Jika diinginkan, Anda dapat menambahkannya ke menu HA menggunakan panel_iframe atau ke jendela HA apa saja melalui kartu lovelace “iframe”. <br>  Sekian, terima kasih atas perhatiannya. <br><br>  <b>UPD:</b> <br>  Menambahkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ke GitHub.  Memodifikasi beberapa tempat (dihapus dari konfigurasi haddr, secara otomatis mendapatkan config_dir, menambahkan kemampuan untuk mengatur zona waktu saya) <br><br><div class="spoiler">  <b class="spoiler_title">Dan bagaimana semuanya terlihat?</b>  <b class="spoiler_title">Perhatian, Bluer!</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/_v/2_/tw_v2_gufir0tcuzo02dt1e-zig.jpeg" alt="gambar"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id448656/">https://habr.com/ru/post/id448656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id448642/index.html">Wajib Model Distribusi Hak di FreeBSD</a></li>
<li><a href="../id448644/index.html">Ekspresi reguler yang berlaku sebagai functor alternatif gratis</a></li>
<li><a href="../id448648/index.html">Bagaimana mendudukkan semua orang dalam sains dan tidak mengubah kantor menjadi sarang kebencian</a></li>
<li><a href="../id448652/index.html">Mozilla WebThings di Raspberry Pi - memulai</a></li>
<li><a href="../id448654/index.html">Mozilla WebThings - Pengaturan Gateway</a></li>
<li><a href="../id448658/index.html">Apa yang bisa dilakukan melalui konektor OBD di mobil</a></li>
<li><a href="../id448662/index.html">"Russia 404": opsi bukan untuk pertunjukan</a></li>
<li><a href="../id448664/index.html">Membuat Kartu Seperti Tinder di Swift</a></li>
<li><a href="../id448666/index.html">Bagaimana kami memilih layanan untuk manajemen dokumen elektronik dengan pelanggan</a></li>
<li><a href="../id448668/index.html">Agile: masalah ideologis terbesar di TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>