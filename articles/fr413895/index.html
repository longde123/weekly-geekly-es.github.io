<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí° üíõ üõï Pirater un bracelet de fitness pas cher üë≤üèº ‚ôäÔ∏è üëçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ceci est une traduction. Article publi√© le 27 mai 2018 


 Tracker de fitness avant et apr√®s d√©montage 

 Lorsque je suis arriv√©e dans l'entreprise ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pirater un bracelet de fitness pas cher</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413895/">  <font color="gray">Ceci est une traduction.</font>  <font color="gray"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article</a> publi√© le 27 mai 2018</font> <br><br><img src="https://habrastorage.org/webt/4n/-9/ah/4n-9ah3fvyxx23aobpo2tvx0jg4.jpeg"><br>  <i><font color="gray">Tracker de fitness avant et apr√®s d√©montage</font></i> <br><br>  Lorsque je suis arriv√©e dans l'entreprise actuelle, le premier jour, on m'a gentiment offert un ensemble de cadeaux.  Parmi eux se trouvait ce bracelet avec un tracker de fitness.  Quel que soit votre amour de l'exercice, c'est un gadget incroyablement cool d'un point de vue purement technique: <br><br><ul><li>  un tr√®s petit facteur de forme (environ 15 √ó 40 mm); </li><li>  Bluetooth basse √©nergie (BLE); </li><li>  √âcran OLED (96 √ó 32 pixels); </li><li>  batterie </li><li>  Charge USB </li><li>  acc√©l√©rom√®tre; </li><li>  moteur de vibration; </li><li>  le prix est d'environ 10 $ (!). </li></ul><a name="habracut"></a><br>  A l'ext√©rieur, le seul identifiant sur le panneau arri√®re est l'autocollant ¬´FCC ID: 2AHFTID115¬ª.  Si vous le recherchez sur Google, il semble correspondre √† l'appareil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ID115</a> et vous pouvez m√™me trouver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs photos de</a> son int√©rieur.  En regardant l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une de ces photographies</a> , si vous essayez dur, vous pouvez voir le nom du plus grand circuit int√©gr√© (IC): N51822.  Cela sugg√®re qu'il pourrait y avoir un microcontr√¥leur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nordique</a> (MCU) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nRF51822</a> , un processeur ARM M0 32 bits avec prise en charge BLE int√©gr√©e, qui est th√©oriquement assez facile √† programmer pour d'autres choses qu'un bracelet devrait faire. <br><br>  Avant de d√©monter le gadget, je suis all√© un peu plus sur Google et j'ai d√©couvert que dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certains bracelets similaires,</a> la m√™me puce est install√©e et que les gens l'ont programm√©e avec succ√®s. <br><br>  L'ouverture du bo√Ætier n'a pas √©t√© si facile.  Le couvercle en plastique noir est coll√© au fond gris.  J'ai essay√© un s√®che-cheveux pour adoucir la colle et je l'ai patiemment coup√© avec un petit couteau, en essayant de ne pas trop endommager le plastique.  Apr√®s ouverture, je me suis assur√© qu'il y avait bien du nRF51822.  Plus tard, j'ai achet√© un bracelet MCU presque identique √† Texas Instrument.  Gardez √† l'esprit qu'il existe des options. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2e6/0af/a75/2e60afa757e9f5859408e49d7f76e54f.jpg"></a> <br>  <i><font color="gray">nRF51822 et stylo √† bille pour √©chelle</font></i> <br><br><h1>  Trouver un moyen de communiquer </h1><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> indique que la puce peut √™tre programm√©e / d√©bogu√©e √† l'aide de l'interface √† deux broches SWD (ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Serial Wire Debug</a> ).  Si nous voulons √©tablir un canal de communication avec une puce, cela signifie deux choses: <br><br><ul><li>  Nous avons besoin d'un programmeur SWD (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Segger J-Link</a> ). </li><li>  Nous aurons besoin d'acc√©der aux deux broches SWD du microcontr√¥leur, √† savoir SWDIO (donn√©es) et SWDCLK (impulsions d'horloge). </li></ul><br>  Heureusement, plusieurs cartes sont disponibles sur la carte.  Bien que leur existence soit clairement expliqu√©e par le besoin de d√©bogage, de test et de v√©rification, je pr√©f√®re penser qu'un ing√©nieur cool les a laiss√©s l√† comme de petits cadeaux pour des gens comme nous.  Tous ne sont pas correctement √©tiquet√©s, je sugg√®re donc les codes suivants: <br><br><img src="https://habrastorage.org/webt/fc/gd/y9/fcgdy9fj-73b3cdtcsbgdqdjovw.jpeg"><br><br><img src="https://habrastorage.org/webt/et/-t/_4/et-t_46am8apprgxc3mtkyyg0gq.jpeg"><br>  <i><font color="gray">Face avant et arri√®re de la carte de circuit imprim√©.</font></i>  <i><font color="gray">Stylo √† bille pour les noms d'√©chelle et semi-arbitraires pour les pads ouverts</font></i> <br><br>  En utilisant le m√™me <a href="">microscope USB</a> bon march√© <a href="">,</a> j'ai pris plusieurs photos des c√¥t√©s avant et arri√®re de la carte et j'ai essay√© de suivre les pistes du microcontr√¥leur aux pads. <br><br><img src="https://habrastorage.org/webt/pc/oe/-h/pcoe-ha9fus65p5oenznunhxx30.jpeg"><br><br><img src="https://habrastorage.org/webt/nk/hy/ed/nkhyedqu2al7dvuxmbqs8ns9g9u.jpeg"><br>  <i><font color="gray">Pistes vers les broches SWDIO et SWDCLK √† l'avant et √† l'arri√®re de la carte</font></i> <br><br>  Veuillez noter qu'il s'agit d'une carte de circuit imprim√© multicouche avec des trous traversants, vous devez donc v√©rifier les pistes des deux c√¥t√©s de la carte.  A partir de ces photos, vous pouvez suivre les traces des contacts SWDIO et SWDCLK sur la puce jusqu'aux pads IO et CLK.  Nous allons donc nous assurer que la marque CLK sur la carte correspond √† SWDCLK sur le MCU et que le contact sans √©tiquette est la broche SWDIO.  Vous pouvez maintenant pr√©parer notre premi√®re table de mappage: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Aire de jeux </th><th>  La description </th></tr><tr><td>  SWDIO </td><td>  IO </td><td>  Sortie de donn√©es pour la programmation de SWD </td></tr><tr><td>  SWDCLK </td><td>  CLK </td><td>  Sortie d'horloge pour la programmation SWD </td></tr></tbody></table><br><h1>  Chirurgie post mortem </h1><br>  Ayant acc√©d√© √† deux plots SWD, je leur ai soud√© des fils tr√®s fins et √† tous les autres contacts disponibles. <br><br> <a href=""><img src="https://habrastorage.org/webt/hf/cm/6j/hfcm6jaswn6gf08oxc8ypaehmtu.jpeg"></a> <br><br><h1>  Clignote un peu </h1><br>  La t√¢che suivante consiste √† essayer de programmer le p√©riph√©rique pour une t√¢che.  Pour ex√©cuter le programme le plus simple, nous devons nous assurer des √©l√©ments suivants: <br><br><ul><li>  Nous avons correctement suivi les contacts de SWDIO / SWDCLK. </li><li>  Le programmeur SWD est en cours d'ex√©cution et l'ordinateur peut √©mettre des commandes. </li><li>  Nous pouvons compiler le programme Arm et utiliser correctement le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nordic SDK</a> . </li><li>  Nous pouvons flasher le programme compil√© dans la puce. </li><li>  La puce fonctionne correctement et charge notre programme. </li></ul><br>  Dans ce cas, ¬´bonjour, monde¬ª peut √™tre un programme qui allume et √©teint la LED.  Et m√™me cela n'est pas √©l√©mentaire, car il n'y a pas de LED int√©gr√©e sur la carte, et si vous en ajoutez une externe, vous devez toujours savoir √† quoi la connecter.  Cela ajoute une autre dimension au mod√®le spatial du probl√®me.  En raison du manque de th√©or√®me du fromage gratuit, je viens de connecter deux LED aux broches <code>P1</code> et <code>P2</code> dans l'espoir que nous puissions acc√©der √† ces pads avec le MCU. <br><br> <a href=""><img src="https://habrastorage.org/webt/vj/t0/ab/vjt0abxchpbfjiyq87acqsyq4n4.jpeg"></a> <br>  <i><font color="gray">Mauvaise journ√©e</font></i> <br><br>  Les pilotes et les programmes de ligne de commande pour le programmeur SWD J-Link se trouvent sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le site Web de Segger</a> .  Si vous utilisez macOS et utilisez Homebrew, recherchez la formule Cask dans <code>caskroom/drivers/segger-jlink</code> .  La communication avec le programmeur SWD est √©tablie √† partir de l' <code>JLinkExe</code> ligne de commande <code>JLinkExe</code> . <br><br>  J'ai ensuite t√©l√©charg√© le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nordic nRF5 SDK</a> (j'utilise la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version 12.3.0</a> ).  D'apr√®s les exemples du SDK, il est clair que nous avons besoin d'un compilateur capable de compiler des programmes Arm.  J'ai donc install√© <code>gcc-arm-embedded</code> (√©galement disponible sur Homebrew). <br><br>  Apr√®s avoir examin√© la documentation du SDK et les forums de d√©veloppeurs nordiques, j'ai d√©couvert que leurs SDK sont le plus souvent utilis√©s avec des cartes de d√©veloppement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comme celle-ci</a> .  Le SDK est pr√©configur√© pour plusieurs variantes de ces cartes.  Puisque nous sommes en contact direct avec le contr√¥leur, vous devrez configurer certains param√®tres du SDK. <br><br>  J'ai pass√© <i>beaucoup de</i> temps √† comprendre l'√©cosyst√®me nRF5, mais au final j'ai quand m√™me pu ex√©cuter le programme sur une puce!  La <a href="">vid√©o</a> montre deux LED clignotantes.  √Ä ce stade, j'ai cr√©√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un r√©f√©rentiel Github</a> et jet√© un programme avec un <code>Makefile</code> fonctionnel <code>Makefile</code> .  L'un des principaux secrets √©tait qu'il existe en fait plusieurs options pour le nRF51822, et dans le mien, il n'y a que 16 Ko de m√©moire.  Je devais donc encore <a href="">corriger le script de l'√©diteur de liens</a> . <br><br><h1>  Entr√©e / sortie num√©rique </h1><br>  Comme je l'ai d√©j√† dit, la t√¢che avec les LED clignotantes a fourni quelques espoirs et une m√©thode de pouss√©e, qui des contacts MCU conduisent √† <code>P1</code> et <code>P2</code> , o√π les LED sont connect√©es.  La strat√©gie la plus simple est de connecter toutes les sorties √† tour de r√¥le et d'appliquer tour √† tour les hautes et basses tensions.  √Ä ma grande surprise, les deux LEDs se sont allum√©es!  J'ai √©t√© encore plus surpris lorsque le vibromoteur a commenc√© √† fonctionner! <br><br>  Ainsi, la m√©thode poke ajout√©e au tableau: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Aire de jeux </th><th>  La description </th></tr><tr><td>  P0.30 </td><td>  P1 </td><td>  GPIO num√©rique </td></tr><tr><td>  P0.00 </td><td>  P2 </td><td>  GPIO num√©rique </td></tr><tr><td>  P0.01 </td><td>  - </td><td>  Moteur de vibration </td></tr></tbody></table><br><h1>  printf </h1><br>  La possibilit√© de transf√©rer des donn√©es vers un ordinateur est indispensable pour le d√©bogage.  Le programmateur J-Link prend en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la transmission en temps r√©el (RTT)</a> pour l'envoi et la r√©ception de donn√©es √† partir de la puce.  Pour utiliser RTT, vous devez <code>#include "SEGGER_RTT.h"</code> et appeler <code>SEGGER_RTT_WriteString()</code> .  Pour recevoir des donn√©es sur un ordinateur, appelez l' <code>jlinkrttlogger</code> ligne de commande <code>jlinkrttlogger</code> , fournie avec J-Link. <br><br><h1>  OLED </h1><br>  Un autre d√©fi consiste √† faire fonctionner l'OLED.  L'OLED le plus courant sur le march√© ex√©cute le pilote / contr√¥leur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ssd1306</a> , et g√©n√©ralement la communication avec le MCU se fait via une interface s√©rie utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SPI</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">I¬≤C</a> .  Voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple d'Adafruit</a> . <br><br>  Je n'ai trouv√© un tel affichage dans aucun des magasins ordinaires.  Et la taille de 96 √ó 32 n'est pas standard.  Une recherche par identifiant QT1316P01A sur l'affichage donne des sites chinois comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Aliexpress</a> , mais il n'y a pas de documentation sauf pour les noms des conclusions: <br><br><img src="https://habrastorage.org/webt/jh/we/dj/jhwedjuvdabshgmklscu3wk6edi.png"><br>  <i><font color="gray">Nommage des broches OLED avec Aliexpress</font></i> <br><br>  Si la liste ne se trouve pas, alors les contacts <code>SCL</code> , <code>SDA</code> et <code>RES#</code> nous indiquent qu'il s'agit d'une option I¬≤C.  S'il y a des pistes entre les trois broches du nRF51822 et ces trois broches de l'OLED, alors nous ferons un pas en avant.  Revenons au microscope. <br><br><img src="https://habrastorage.org/webt/vw/dg/9d/vwdg9dxuopykb2umzrjt1zskvv4.jpeg"><br><br><img src="https://habrastorage.org/webt/zq/zl/ym/zqzlymrnmspwkcroh4argcj_udo.jpeg"><br>  <i><font color="gray">Pistes de contact de donn√©es OLED</font></i> <br><br>  Nous mettons √† jour la table de correspondance: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Aire de jeux </th><th>  La description </th></tr><tr><td>  P0.21 </td><td>  - </td><td>  Sortie OLED SDA </td></tr><tr><td>  P0.22 </td><td>  - </td><td>  Broche OLED SCL </td></tr><tr><td>  P0.24 </td><td>  - </td><td>  Sortie OLED RES # </td></tr></tbody></table><br>  Le protocole I¬≤C est beaucoup plus avanc√© que n'importe quel protocole s√©rie simple comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UART</a> .  L'un des avantages est qu'il prend en charge plusieurs p√©riph√©riques ma√Ætre et esclave sur le m√™me bus.  Cela complique un peu les choses: au moins, vous devez indiquer au MCU pour quelles commandes esclaves sont √©mises.  Ainsi √† un niveau √©lev√©, outre les contacts physiques, il existe √©galement une adresse ¬´logique¬ª de l'√©cran OLED. <br><br>  Heureusement, un exemple dans le SDK nRF5 est le scanner I¬≤C.  Il interroge √† partir de toutes les adresses logiques possibles et signale si quelque chose y est install√©.  Ma version modifi√©e est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Il produit le journal suivant: <br><br> <code>$ make <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> TWI scanner. <br> TWI device detected at 0x3c.</code> <br> <br>  Bonne nouvelle!  Nous avons de bonnes raisons de croire que l'affichage est correctement identifi√© et qu'il s'agit bien d'une variante I¬≤C.  Une recherche <code>0x3c</code> indique que <code>0x3c</code> est une adresse typique pour ces appareils. <br><br>  Nous sommes maintenant pr√™ts √† envoyer quelques pixels √† l'√©cran.  A ce niveau, il n'y a pas d'abstraction via la biblioth√®que.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voir la</a> documentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ssd1306</a> pour un moyen de bas niveau de transf√©rer des donn√©es.  Le processus consiste en une s√©quence de commandes de configuration qui d√©finissent l'orientation de l'affichage, le mode d'enregistrement, la taille, etc.  Ensuite, une s√©quence d'octets affich√©s √† l'√©cran est envoy√©e √† la m√©moire d'affichage graphique (GDDRAM). <br><br>  Pour la configuration correcte, j'ai √©tudi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la biblioth√®que ssd1306 d'Adafruit</a> et essay√© d'√©muler des commandes similaires.  C'est ce qu'a pris la part du lion dans ce projet.  D√©couvrir tous les d√©tails s'est av√©r√© √™tre une t√¢che tr√®s longue, et je ne peux toujours pas expliquer certaines choses.  Mais √ßa marche! <br><br> <a href=""><img src="https://habrastorage.org/webt/lr/ix/r7/lrixr7dxh_7j9098jx677drocxm.jpeg"></a> <br>  <i><font color="gray">Afficher une image bitmap cod√©e en dur</font></i> <br><br>  Le code de cet exemple est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Avec ces param√®tres, l'affichage est divis√© en 4 lignes (pages) et 96 colonnes.  Les pages mesurent donc 8 pixels.  Le premier octet envoy√© sera situ√© "verticalement" dans la premi√®re colonne de la premi√®re page.  Le deuxi√®me octet occupera la deuxi√®me colonne, puis la troisi√®me et ainsi de suite, jusqu'√† la 96e colonne, quand il <i>reviendra</i> et commencera √† partir de la premi√®re colonne de la deuxi√®me page. <br><br>  C'est le comportement <i>attendu</i> .  Comme le <a href="">montre la vid√©o</a> , le comportement <i>observ√©</i> est diff√©rent: d'abord les colonnes impaires sont remplies, puis les paires, et ensuite seulement, il revient √† la deuxi√®me page. <br><br>  J'ai pass√© beaucoup de temps √† comprendre la raison d'un tel comportement d'affichage stupide, puis un peu plus de temps pour le configurer pour le r√©parer.  Au final, j'ai raval√© ma fiert√© et j'ai quand m√™me impl√©ment√© une logique de rendu aussi √©trange dans le programme pour le terminer. <br><br><h1>  Voyage √† Arduino </h1><br>  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fouillant</a> dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la biblioth√®que Adafruit ssd1306</a> pour Arduino, j'ai toujours pens√© qu'il serait bien d'avoir un moyen de "simuler" des bits Arduino sp√©cifiques pour les tester sur nRF51822.  Il s'av√®re que des gens beaucoup plus exp√©riment√©s ont √©galement pens√© √† ce sujet - c'est ce que fait l'incroyable projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sandeepmistry / arduino-nRF5</a> .  Il impl√©mente les principales biblioth√®ques Arduino en utilisant le SDK nRF5. <br><br>  Avec ce projet, nous pouvons ouvrir l'IDE Arduino, s√©lectionner la carte nRF5 et utiliser le riche √©cosyst√®me Arduino.  J'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bifurqu√© le projet</a> et ajout√© le support pour la planche de notre bracelet.  Vous pouvez le s√©lectionner dans le menu d√©roulant <code>Tools &gt; Board &gt; ID115 Fitness Bracelet (nRF51822)</code> . <br><br> <a href=""><img src="https://habrastorage.org/webt/jx/ts/2h/jxts2hki_rpefinf1cjd2ms7k1w.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/50/gn/dm/50gndm8tzezp_frgdrile7la5hs.jpeg"></a> <br>  <i><font color="gray">Biblioth√®que Adafruit ssd1306 dans sa forme originale (ci-dessus) et avec un patch (ci-dessous)</font></i> <br><br>  Cela signifie √©galement que nous pouvons d√©sormais utiliser la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que OLED d'Adafruit</a> .  √Ä ma grande surprise et soulagement, le m√™me comportement √©trange s'est produit en remplissant d'abord les colonnes OLED impaires et m√™me paires!  J'ai heureusement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bifurqu√© la</a> biblioth√®que et impl√©ment√© le m√™me hack.  Par rapport √† l'approche de bas niveau, nous avons maintenant acc√®s √† une vari√©t√© d'abstractions int√©ressantes, telles que la sortie de texte: <br><br> <a href=""><img src="https://habrastorage.org/webt/gd/62/xf/gd62xfqutmoq_szmosnzvpbdu1i.jpeg"></a> <br>  <i><font color="gray">Le plus familier "Bonjour, monde!"</font></i> <br><br><h1>  Entr√©e / sortie analogique </h1><br>  En plus des signaux num√©riques marche / arr√™t, le nRF51822 poss√®de 10 broches pour l'entr√©e analogique.  Ceci est utile, par exemple, pour lire la charge actuelle de la batterie.  √Ä en juger par la documentation, la lecture des contacts analogiques produit une valeur de 10 bits.  Par cons√©quent, s'il y a <code>0V</code> √† l'entr√©e, alors nous lirons <code>0</code> , et s'il y a <code>VCC</code> , nous lirons <code>1023</code> avec des valeurs interm√©diaires entre elles. <br><br>  J'ai lu p√©riodiquement les valeurs des entr√©es analogiques et trac√© les signaux les plus int√©ressants: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/483/446/36c/48344636cddd789c9c1f86c15ffca411.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3c/3ab/38c/b3c3ab38ce708082b19a67ed9cdb30ae.png"><br>  <i><font color="gray">L'effet de secouer la carte et de charger la batterie en fonction des donn√©es des entr√©es analogiques</font></i> <br><br>  Je suis convaincu que le contact <code>P0.05</code> fait r√©f√©rence √† la charge de la batterie, car la valeur augmente et diminue √† mesure qu'elle se charge et se d√©charge.  Je soup√ßonne que la broche <code>P0.26</code> connect√©e √† l'une des sorties de l'acc√©l√©rom√®tre, car elle devient folle lorsque vous secouez la carte.  Les contacts <code>P0.03</code> et <code>P0.04</code> <i>peuvent</i> √©galement √™tre connect√©s √† diff√©rentes sorties de l'acc√©l√©rom√®tre, mais ici un certain effet de second ordre est tr√®s probablement superpos√© au signal de l'entr√©e.  Par exemple, dans le premier graphique, notez comment le niveau de la batterie (broche 5) change lorsque l'acc√©l√©rom√®tre a besoin de plus d'√©nergie.  Ceci est un exemple d'un effet de second ordre. <br><br>  Le code peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans ce croquis</a> .  Les donn√©es source et le script graphique sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Nous pouvons maintenant ajouter plusieurs lignes √† notre table de correspondance: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Aire de jeux </th><th>  La description </th></tr><tr><td>  P0.05 </td><td>  - </td><td>  Entr√©e analogique - connect√©e √† la batterie </td></tr><tr><td>  P0.26 </td><td>  - </td><td>  Entr√©e analogique - Acc√©l√©rom√®tre √† un axe </td></tr><tr><td>  P0.03 </td><td>  - </td><td>  Entr√©e analogique - un axe de l'acc√©l√©rom√®tre (probable) </td></tr><tr><td>  P0.04 </td><td>  - </td><td>  Entr√©e analogique - un axe de l'acc√©l√©rom√®tre (probable) </td></tr></tbody></table><br><h1>  Bouton </h1><br>  Dans le firmware d'origine, toucher le bracelet √† un certain moment allume l'√©cran.  Tenir ce point d√©marre le chronom√®tre, si je me souviens bien.  Ce n'est pas un bouton physique, mais une sorte de tactile capacitif qui fonctionne √©tonnamment bien.  En utilisant la m√™me approche que pour la recherche de sorties num√©riques, j'ai <a href="">trouv√© un endroit pour</a> me <a href="">connecter au MCU (vid√©o)</a> . <br><br>  Le code est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Aire de jeux </th><th>  La description </th></tr><tr><td>  P0.10 </td><td>  - </td><td>  Entr√©e num√©rique - bouton int√©gr√© </td></tr></tbody></table><br><h1>  Bluetooth basse √©nergie (BLE) </h1><br>  La fonctionnalit√© BLE sur les puces nRF5 est impl√©ment√©e via quelque chose appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SoftDevice</a> .  Il s'agit d'un binaire pr√©compil√© avec une pile BLE.  Il est cousu quelle que soit l'application.  Il existe de nombreuses versions de SoftDevice, selon la version du SDK et la version de la puce. <br><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> fournit une certaine matrice de d√©pendances (malheureusement, vous ne pouvez pas y mettre de lien direct).  Il montre avec quel SDK les diff√©rentes versions de la puce sont livr√©es - et de quelle version de SoftDevice il s'agit.  Dans notre cas, la puce est marqu√©e QFAAH0, cette puce poss√®de 256 Ko de m√©moire flash, 16 Ko de RAM et la compatibilit√© avec SoftDevice s130 est d√©clar√©e. <br><br>  Mon SDK version 12.3 contient d√©j√† quelques exemples d'utilisation de SoftDevice s130.  Par rapport aux programmes pr√©c√©dents qui sont directement c√¢bl√©s dans des puces √©lectroniques √† partir de l'adresse <code>0x0</code> , vous devez maintenant flasher SoftDevice √† partir de l'adresse <code>0x0</code> et le programme lui-m√™me √† partir de l'adresse <code>0x1b000</code> .  Apr√®s chargement et initialisation, le fichier binaire SoftDevice ira √† cette adresse et transf√©rera le contr√¥le √† notre programme.  Pour illustrer, j'ai pris le m√™me exemple avec des LED clignotantes, mais je l'ai chang√© pour le firmware SoftDevice ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code</a> ).  Le comportement observ√© n'a pas chang√©, sauf que vous devez pr√©-flasher SoftDevice: <br><br> <code>$ make <br> # ... <br> $ make flash-softdevice <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> Hello, world!</code> <br> <br>  L'application la plus simple pour Bluetooth est peut-√™tre de transformer l'appareil en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">balise</a> .  L'appareil diffuse uniquement sa pr√©sence.  Un tel exemple est dans le SDK appel√© <code>ble_app_beacon</code> .  Il suppose que SoftDevice <code>s130</code> d√©j√† flash√©. <br><br>  Ici aussi, la communication de bas niveau avec la puce complique tout par rapport √† la programmation via le SDK.  En plus d'ajuster la taille de la RAM (cette connaissance √©tait difficile pour moi dans l'exemple avec les LED), un autre probl√®me difficile √† suivre a √©t√© r√©v√©l√©.  Il s'est av√©r√© que la pile BLE utilise un g√©n√©rateur d'horloge pour effectuer des t√¢ches urgentes.  Dans les exemples du SDK, un oscillateur √† cristal externe est suppos√©.  Quand j'ai r√©alis√© cela apr√®s des milliers de tentatives de <code>printf</code> , j'ai chang√© l'indicateur de configuration pour utiliser un g√©n√©rateur d'horloge synth√©tique, et le probl√®me a √©t√© r√©solu.  Le code source de la balise est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h1>  BLE + Arduino </h1><br>  Lorsque l'exemple BLE a fonctionn√© avec le SDK nRF5, connaissant les pi√®ges avec RAM et un g√©n√©rateur, j'ai de nouveau regard√© l'environnement Arduino.  Et encore une fois, il y avait le glorieux projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sandeepmistry / arduino-BLEPeripheral</a> (du m√™me gars que arduino-nRF5!), Qui fournit d'excellentes abstractions en plus des param√®tres BLE internes. <br><br>  √Ä ma grande surprise, je n'ai m√™me pas eu √† bifurquer la biblioth√®que.  L'auteur du projet arduino-nrf5 a pass√© du temps et ajout√© la configuration de toutes les cartes et param√®tres, donc maintenant choisir le bon g√©n√©rateur d'horloge pour SoftDevice se r√©sume √† un choix simple dans le menu d√©roulant <code>Tools &gt; Low Frequency Clock &gt; Synthesized</code> .  G√©nial.  J'ai rapidement √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple</a> avec la LED verte allum√©e via Bluetooth (avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette application</a> ).  Son travail est <a href="">montr√© dans la vid√©o</a> . <br><br><h1>  Plans suppl√©mentaires </h1><br>  Apr√®s avoir agit√© cette planche pendant d'innombrables heures, mes mains me d√©mangent pendant plusieurs semaines pour la coller plus loin dans la machine √† laver et l'oublier pendant un certain temps. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413895/">https://habr.com/ru/post/fr413895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413881/index.html">Image Docker de 5,94 m√®tres avec Telegram MTProxy</a></li>
<li><a href="../fr413885/index.html">√âvaluation de Cavium ThunderX2: le r√™ve du serveur Arm se r√©alise (Partie 1, Introduction)</a></li>
<li><a href="../fr413889/index.html">D√©lai non respect√©, ou pourquoi plus de la moiti√© des entreprises n'√©taient pas pr√™tes pour le RGPD</a></li>
<li><a href="../fr413891/index.html">Organisation du registre d'√âtat unifi√© des entit√©s juridiques - un registre d'√âtat unifi√© des entit√©s juridiques</a></li>
<li><a href="../fr413893/index.html">Un trou comme outil de s√©curit√© - 2, ou comment attraper des app√¢ts vivants APT</a></li>
<li><a href="../fr413897/index.html">Unity3D ECS et Job System</a></li>
<li><a href="../fr413899/index.html">Donn√©es personnelles biom√©triques des Russes</a></li>
<li><a href="../fr413901/index.html">Contr√¥le du robot auto-√©quilibr√© EduMip √† l'aide du joystick PS4 Dualshock 4 via ROS</a></li>
<li><a href="../fr413903/index.html">Comment Cambridge Analytica transforme les clics en voix</a></li>
<li><a href="../fr413907/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 256 (4 juin - 12 juin)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>