<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê® üêæ üë®üèº‚Äçüíª C√≥mo funciona Microsoft Excel con alturas de fila üöº üë©üèæ‚Äçüöí üç£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A veces me aburro y, armado con un depurador, empiezo a investigar diferentes programas. Esta vez, mi elecci√≥n recay√≥ en Excel y quer√≠a averiguar c√≥mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo funciona Microsoft Excel con alturas de fila</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435426/"><p> A veces me aburro y, armado con un depurador, empiezo a investigar diferentes programas.  Esta vez, mi elecci√≥n recay√≥ en Excel y quer√≠a averiguar c√≥mo maneja las alturas de las filas, qu√© almacena, c√≥mo considera la altura del rango de celdas, etc.  Analic√© Excel 2010 (excel.exe, 32 bits, versi√≥n 14.0.4756.1000, SHA1 a805cf60a5542f21001b0ea5d142d1cd0ee00b28). </p><a name="habracut"></a><br><h2 id="nachnyom-s-teorii">  Comencemos con la teor√≠a. </h2><br><p>  Si recurre a la documentaci√≥n de VBA para Microsoft Office, puede ver que la altura de la fila se puede obtener de una forma u otra a trav√©s de dos propiedades: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" title="Rowheight">RowHeight</a> : devuelve o establece la altura de la primera fila en el rango especificado, medido en puntos.  Leer / escribir doble; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" title="Altura">Altura</a> : devuelve un valor Doble que representa la altura, en puntos, del rango.  Solo lectura </li></ul><br><p>  Y si miras tambi√©n aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" title="Especificaciones y l√≠mites de Excel">especificaciones y l√≠mites de Excel</a> .  Puede encontrar que la altura m√°xima de la fila es de 409 puntos.  Esto, desafortunadamente, est√° lejos de ser el √∫nico caso cuando los documentos oficiales de Microsoft son un poco enga√±osos.  De hecho, en el c√≥digo de Excel, la altura m√°xima de la fila se establece en 2047 p√≠xeles, que ser√° 1535.25 en puntos.  Y el tama√±o m√°ximo de fuente es 409.55 puntos.  Es imposible obtener una fila de una altura tan grande simplemente asign√°ndola en VBA / Interop, pero puede tomar una fila, establecer la fuente Cambria Math en su primera celda y establecer el tama√±o de la fuente en 409.55 puntos.  Luego, Excel con su algoritmo astuto calcular√° la altura de la fila en funci√≥n del formato de la celda, obtendr√° un n√∫mero que supere los 2047 p√≠xeles (crea la palabra) y establecer√° la fila en la altura m√°xima posible.  Si pregunta la altura de esta serie a trav√©s de la interfaz de usuario, Excel mentir√° que la altura es de 409.5 puntos, pero si solicita la altura de la serie a trav√©s de VBA, obtendr√° 1535.25 puntos honestos, lo que equivale a 2047 p√≠xeles.  Es cierto que despu√©s de guardar el documento, la altura seguir√° bajando a 409.5 puntos.  Esta manipulaci√≥n se puede observar aqu√≠ en este video: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://recordit.co/ivnFEsELLI</a> </p><br><p>  Mencion√© los p√≠xeles en el p√°rrafo anterior por una raz√≥n.  Excel en realidad almacena y calcula el tama√±o de las celdas en enteros (generalmente hace todo lo posible en enteros).  Muy a menudo, estos son p√≠xeles multiplicados por alg√∫n factor.  Curiosamente, Excel almacena la escala de apariencia en forma de fracci√≥n ordinaria, por ejemplo, una escala del 75% se almacenar√° como dos n√∫meros 3 y 4. Y cuando sea necesario mostrar la fila, Excel tomar√° la altura de la fila como un n√∫mero entero de p√≠xeles, multiplique por 3 y divida por 4. Pero √©l realizar√° esta operaci√≥n ya al final, a partir de esto se crea el efecto de que todo se considera en n√∫meros fraccionarios.  Para verificar esto, escriba el siguiente c√≥digo en VBA: </p><br><pre><code class="vbscript hljs">w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).RowHeight = <span class="hljs-number"><span class="hljs-number">75.375</span></span> Debug.Print w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).Height</code> </pre> <br><p>  VBA dar√° 75 porque  75.375 p√≠xeles ser√°n 100.5 p√≠xeles, y Excel no puede permit√≠rselo y dejar√° caer la parte fraccional hasta 100 p√≠xeles.  Cuando VBA solicita la altura de la fila en puntos, Excel traduce honestamente 100 p√≠xeles en puntos y devuelve 75. </p><br><p>  En principio, ya hemos llegado a escribir una clase en C # que describir√° informaci√≥n sobre la altura de la fila: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowHeightInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    ,   4. public ushort Flags { get; set; } //  }</span></span></code> </pre> <br><p>  Deber√° tomar mi palabra por ahora, pero en Excel, la altura de la fila se almacena de esa manera.  Es decir, si se especifica que la altura de la fila es de 75 puntos, ser√° de 100 en p√≠xeles, luego se almacenar√° 400 en Valor. No he entendido completamente lo que significan todos los bits en Banderas (es dif√≠cil y largo calcular los valores de las banderas), pero s√© que 0x4000 se establece para filas cuya altura se establece manualmente, y 0x2000 - se establece para filas ocultas.  En general, para las filas visibles con una altura establecida manualmente, Flags suele ser igual a 0x4005, y para las filas en las que la altura se calcula seg√∫n el formato de Banderas, es 0xA o 0x800E. </p><br><h2 id="sprashivaem-vysotu-ryada">  Preguntamos la altura de la fila </h2><br><p>  Ahora, en principio, puede echar un vistazo al m√©todo de excel.exe, que devuelve la altura de la fila por su √≠ndice (gracias a HexRays por el hermoso c√≥digo): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge GetRowHeight@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowIndex@&lt;edx&gt;, SheetLayoutInfo *sheetLayoutInfo@&lt;esi&gt;, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag) { RowHeightInfo *rowHeightInfo; <span class="hljs-comment"><span class="hljs-comment">// eax int result; // ecx if ( sheetLayoutInfo-&gt;dword1A0 ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); if ( !rowHeightInfo ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); result = 0; if ( flag || !(rowHeightInfo-&gt;Flags &amp; 0x2000) ) result = rowHeightInfo-&gt;Value; if ( !(rowHeightInfo-&gt;Flags &amp; 0x4000) ) result |= 0x8000u; return result; }</span></span></code> </pre> <br><p>  Qu√© es dword1A0, todav√≠a no lo he descubierto.  no se pudo encontrar un lugar donde se establezca esta bandera :( <br>  Lo que es defaultRowDelta2 para m√≠ tambi√©n sigue siendo un misterio.  Cuando Excel calcula la altura de la fila en funci√≥n del formato, la representa como la suma de dos n√∫meros.  defaultRowDelta2 es el segundo n√∫mero de esta suma para la altura de fila est√°ndar.  El valor del par√°metro indicador tambi√©n es misterioso, porque  donde vi una llamada a este m√©todo en flag pas√≥ falso. <br>  La clase SheetLayoutInfo tambi√©n aparece en este m√©todo.  Lo llam√© as√≠, porque almacena una gran cantidad de todo tipo de informaci√≥n sobre el aspecto de la hoja.  En SheetLayoutInfo hay campos como: </p><br><ul><li>  DefaultFullRowHeightMul4: altura de fila est√°ndar; </li><li>  MinRowIndexNonDefault: el √≠ndice de la primera fila, en el que la altura difiere del est√°ndar; </li><li>  MaxRowIndexNonDefault: √≠ndice de la serie que sigue a la √∫ltima, en la que la altura difiere del est√°ndar; </li><li>  DefaultRowDelta2 es la misma parte de la suma de la altura de fila est√°ndar. </li><li>  GroupIndexDelta - m√°s sobre esto m√°s adelante </li></ul><br><p>  En principio, la l√≥gica de este m√©todo es comprensible: </p><br><ol><li>  Si el √≠ndice de la serie es menor que el primero con una altura no est√°ndar, devuelva el est√°ndar; </li><li>  Si el √≠ndice de la serie es mayor que el anterior con una altura no est√°ndar, devuelva el est√°ndar; </li><li>  De lo contrario, obtenemos el objeto rowHeightInfo para la serie del m√©todo GetRowHeightCore; </li><li>  Si rowHeightInfo == nulo devuelve el alto de fila est√°ndar; </li><li>  Hay magia con banderas, pero en general, devolvemos lo que est√° en rowHeightInfo.Value y establecemos el bit 16 en la respuesta si la altura de la fila no se configur√≥ manualmente. </li></ol><br><p>  Si reescribe este c√≥digo en C #, obtienes algo como lo siguiente: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> HiddenRowMask = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> CustomHeightMask = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> DefaultHeightMask = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ushort</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> defaultHeight = (<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>) (sheetLayoutInfo.DefaultFullRowHeightMul4 | (~(sheetLayoutInfo.DefaultRowDelta2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) &amp; DefaultHeightMask)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; RowHeightInfo rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; HiddenRowMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result = rowHeightInfo.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result |= DefaultHeightMask; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  Ahora puede echar un vistazo a lo que sucede dentro de GetRowHeightCore: </p><br><pre> <code class="cpp hljs">RowHeightInfo *__<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SheetLayoutInfo *sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex)</span></span></span><span class="hljs-function"> </span></span>{ RowHeightInfo *result; <span class="hljs-comment"><span class="hljs-comment">// eax RowsGroupInfo *rowsGroupInfo; // ecx int rowInfoIndex; // edx result = 0; if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return result; rowsGroupInfo = sheetLayoutInfo-&gt;RowsGroups[sheetLayoutInfo-GroupIndexDelta + (rowIndex &gt;&gt; 4)]; result = 0; if ( !rowsGroupInfo ) return result; rowInfoIndex = rowsGroupInfo-&gt;Indices[rowIndex &amp; 0xF]; if ( rowInfoIndex ) result = (rowsGroupInfo + 8 * (rowInfoIndex + rowsGroupInfo-&gt;wordBA + rowsGroupInfo-&gt;wordBC - rowsGroupInfo-&gt;wordB8)); return result; }</span></span></code> </pre> <br><ol><li>  Nuevamente, al principio, Excel verifica si el √≠ndice de la serie se encuentra entre las filas con una altura modificada y, si no, devuelve nulo. </li><li>  Encuentra el grupo deseado de filas; si no existe dicho grupo, devuelve nulo. </li><li>  Obtiene el √≠ndice de la serie en el grupo. </li><li>  Adem√°s, por el √≠ndice de la serie, encuentra el objeto deseado de la clase RowHeightInfo.  wordBA, wordBC, wordB8: algunas constantes.  Cambian solo con la historia.  En principio, no afectan la comprensi√≥n del algoritmo. </li></ol><br><p>  Aqu√≠ vale la pena desviarse del tema y contar m√°s sobre RowsGroupInfo.  Excel almacena RowHeightInfo en grupos de 16 piezas, donde el grupo i-√©simo, representado por la clase RowsGroupInfo, almacenar√° informaci√≥n sobre filas de i √ó 16 a i √ó 16 + 15 inclusive. </p><br><p>  Pero la informaci√≥n de altura de fila en RowsGroupInfo se almacena de una manera algo inusual.  Muy probablemente debido a la necesidad de mantener el historial en Excel. </p><br><p>  Hay tres campos importantes en RowsGroupInfo: Indices, HeightInfos y RowsCount, el segundo no es visible en el c√≥digo anterior (deber√≠a estar en esta l√≠nea: (rowsGroupInfo + 8 √ó (...)), porque rowInfoIndex puede tomar valores muy diferentes , He visto incluso m√°s de 1000 y no tengo ni idea de c√≥mo establecer dicha estructura en la IDA. El campo RowsCount no aparece en el c√≥digo anterior, pero esta es la cantidad de filas realmente no est√°ndar que se almacenan en el grupo. <br>  Adem√°s, en SheetLayoutInfo hay GroupIndexDelta, la diferencia entre el √≠ndice real del grupo y el √≠ndice del primer grupo con una altura de fila modificada. </p><br><p>  El campo √çndices almacena las compensaciones RowHeightInfo para cada √≠ndice de la serie dentro del grupo.  Se almacenan all√≠ en orden, pero en HeightInfos RowHeightInfo ya est√°n almacenados en el orden de cambio. </p><br><p>  Supongamos que tenemos una nueva hoja en blanco y de alguna manera cambiamos la altura de la fila n√∫mero 23. Esta fila se encuentra en el segundo grupo de 16 filas, luego: </p><br><ol><li>  Excel determinar√° el √≠ndice de grupo para esta serie.  En el caso actual, el √≠ndice ser√° 1 y cambiar√° GroupIndexDelta = -1. </li><li>  Crea un objeto de la clase RowsGroupInfo para una serie de filas y lo coloca en sheetLayoutInfo-&gt; RowsGroups bajo el √≠ndice 0 (sheetLayoutInfo-&gt; GroupIndexDelta + 1); </li><li>  En RowsGroupInfo Excel asignar√° memoria para 16 √≠ndices de 4 bytes, para RowsCount, wordBA, wordBC y wordB8, etc. </li><li>  Luego, Excel calcula el √≠ndice de la serie en el grupo a trav√©s de la operaci√≥n AND a nivel de bits (esto es mucho m√°s r√°pido que tomar el resto de la divisi√≥n): rowIndex &amp; 0xF.  El √≠ndice deseado en el grupo ser√°: 23 ‚Äã‚Äã&amp; 0xF = 7; </li><li>  Despu√©s de eso, Excel obtiene el desplazamiento para el √≠ndice 7: desplazamiento = √çndices [7].  Si offset = 0, Excel asigna 8 bytes al final de RowsGroupInto, aumenta RowsCount en uno y escribe el nuevo offset en Indices [7].  En cualquier caso, al final, Excel escribe informaci√≥n sobre la nueva altura de fila y las marcas en el desplazamiento en RowsGroupInfo. </li></ol><br><p>  La clase RowsGroupInfo en C # se ver√≠a as√≠: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowsGroupInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] Indices { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;RowHeightInfo&gt; HeightInfos { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RowsGroupInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Indices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[SheetLayoutInfo.MaxRowsCountInGroup]; HeightInfos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;RowHeightInfo&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; SheetLayoutInfo.MaxRowsCountInGroup; i++) { Indices[i] = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } }</code> </pre> <br><p>  El m√©todo GetRowHeightCore se ver√≠a as√≠: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RowHeightInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + (rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rowInfoIndex != <span class="hljs-number"><span class="hljs-number">-1</span></span> ? rowsGroupInfo.HeightInfos[rowInfoIndex] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><p>  Y as√≠ es como se ver√≠a SetRowHeight (no enumer√© su c√≥digo de excel.exe): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newRowHeight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Max(sheetLayoutInfo.MaxRowIndexNonDefault, rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>); sheetLayoutInfo.MinRowIndexNonDefault = Math.Min(sheetLayoutInfo.MinRowIndexNonDefault, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.RowsGroups.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sheetLayoutInfo.RowsGroups.Add(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = -(sheetLayoutInfo.GroupIndexDelta + realGroupIndex); sheetLayoutInfo.RowsGroups.InsertRange(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &gt;= sheetLayoutInfo.RowsGroups.Count) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = sheetLayoutInfo.GroupIndexDelta + realGroupIndex - sheetLayoutInfo.RowsGroups.Count + <span class="hljs-number"><span class="hljs-number">1</span></span>; sheetLayoutInfo.RowsGroups.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); } RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; RowHeightInfo rowHeightInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { rowHeightInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowHeightInfo(); rowsGroupInfo.HeightInfos.Add(rowHeightInfo); rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rowHeightInfo = rowsGroupInfo.HeightInfos[rowInfoIndex]; } rowHeightInfo.Value = newRowHeight; rowHeightInfo.Flags = flags; }</code> </pre> <br><h2 id="nemnogo-praktiki">  Un poco de practica </h2><br><p>  Despu√©s del ejemplo anterior, con un cambio en la altura de la fila 23, Excel se ver√° as√≠ (configuro la fila 23 a una altura de 75 puntos): </p><br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 23 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  AlturaInfos Count = 1 <br><ul><li>  [0] RowHeightInfo </li><li>  Banderas = 0x4005 </li><li>  Valor = 100 </li></ul></li><li>  √çndices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = -1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br>  Aqu√≠ y en el siguiente ejemplo, presentar√© una representaci√≥n esquem√°tica de c√≥mo se ven los datos en la memoria de Excel, realizados en Visual Studio desde clases autoescritas, porque un volcado directo desde la memoria no es muy informativo. <br>  Ahora intentemos ocultar la fila 23. Para hacer esto, establezca el bit 0x2000 de Banderas.  Cambiaremos la memoria para vivir.  El resultado se puede ver en este video: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://recordit.co/79vYIbwbzB</a> . <br>  Cada vez que oculta filas, Excel hace lo mismo. <br>  Ahora establezcamos el alto de fila no expl√≠citamente, sino a trav√©s del formato de celda.  Deje que la fuente en la celda A20 se convierta en una altura de 40 puntos, luego la altura de la celda en puntos ser√° de 45.75 y en la memoria de Excel ser√° algo como esto: <br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 20 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  AlturaInfos Count = 2 <br><ul><li>  [0] RowHeightInfo </li><li>  Banderas = 0x4005 </li><li>  Valor = 100 </li><li>  [1] RowHeightInfo </li><li>  Banderas = 0x800E </li><li>  Valor = 244 </li></ul></li><li>  √çndices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = 1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br><p>  Puede observar que Excel siempre almacena el alto de fila si no es est√°ndar.  Incluso si la altura no se establece expl√≠citamente, sino que se calcula en funci√≥n del contenido de las celdas o el formato, Excel a√∫n la calcular√° una vez y colocar√° el resultado en el grupo apropiado. </p><br><h2 id="razbiraemsya-so-vstavkoyudaleniem-ryadov">  Nos ocupamos de la inserci√≥n / eliminaci√≥n de filas </h2><br><p>  Ser√≠a interesante analizar lo que sucede al insertar / eliminar filas.  El c√≥digo correspondiente en excel.exe no es dif√≠cil de encontrar, pero no hab√≠a ning√∫n deseo de desmontarlo, puede echarle un vistazo a una parte: </p><br><div class="spoiler">  <b class="spoiler_title">sub_305EC930</b> <div class="spoiler_text"><p>  El indicador a5 determina qu√© operaci√≥n se est√° llevando a cabo actualmente. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge sub_305EC930@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1@&lt;eax&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a2@&lt;edx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a3@&lt;ecx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a4, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a5, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a6) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6; <span class="hljs-comment"><span class="hljs-comment">// esi int v7; // ebx int v8; // edi int v9; // edx int v10; // ecx size_t v11; // eax _WORD *v12; // ebp size_t v13; // eax size_t v14; // eax int v15; // eax unsigned __int16 *v16; // ecx _WORD *v17; // eax _WORD *v18; // ecx int v19; // edx __int16 v20; // bx int v21; // eax _WORD *v22; // ecx int v24; // edx int v25; // eax int v26; // esi int v27; // ebx size_t v28; // eax int v29; // ebp size_t v30; // eax int v31; // esi size_t v32; // eax int v33; // eax unsigned __int16 *v34; // ecx int v35; // eax _WORD *v36; // edx _WORD *v37; // ecx int v38; // eax __int16 v39; // bx int v40; // eax _WORD *v41; // ecx int v42; // [esp+10h] [ebp-48h] int v43; // [esp+10h] [ebp-48h] int v44; // [esp+14h] [ebp-44h] char v45; // [esp+14h] [ebp-44h] int Dst[16]; // [esp+18h] [ebp-40h] int v47; // [esp+5Ch] [ebp+4h] int v48; // [esp+60h] [ebp+8h] v6 = a1; v7 = a1 &amp; 0xF; v8 = a2; if ( !a5 ) { v24 = a4 - a1; v25 = a1 - a3; v43 = a4 - v6; if ( v7 &gt;= v25 ) v7 = v25; v47 = a4 - v7; v26 = v6 - v7; v27 = v7 + 1; v48 = v27; if ( !v8 ) return v27; v28 = 4 * v24; if ( (4 * v24) &gt; 0x40 ) v28 = 64; v45 = v27 + v26; v29 = (v27 + v26) &amp; 0xF; memmove(Dst, (v8 + 4 * v29), v28); v30 = 4 * v27; if ( (4 * v27) &gt; 0x40 ) v30 = 64; v31 = v26 &amp; 0xF; memmove((v8 + 4 * (v47 &amp; 0xF)), (v8 + 4 * v31), v30); v32 = 4 * v43; if ( (4 * v43) &gt; 0x40 ) v32 = 64; memmove((v8 + 4 * v31), Dst, v32); if ( !a6 ) return v48; v33 = v29; if ( v29 &lt; v29 + v43 ) { v34 = (v8 + 4 * v29 + 214); do { Dst[v33++] = *v34 &gt;&gt; 15; v34 += 2; } while ( v33 &lt; v29 + v43 ); } v35 = (v45 - 1) &amp; 0xF; if ( v35 &gt;= v31 ) { v36 = (v8 + 4 * ((v27 + v47 - 1) &amp; 0xF) + 214); v37 = (v8 + 4 * ((v45 - 1) &amp; 0xF) + 214); v38 = v35 - v31 + 1; do { v39 = *v37 ^ (*v37 ^ *v36) &amp; 0x7FFF; v37 -= 2; *v36 = v39; v36 -= 2; --v38; } while ( v38 ); v27 = v48; } v40 = v31; if ( v31 &gt;= v31 + v43 ) return v27; v41 = (v8 + 4 * v31 + 214); do { *v41 = *v41 &amp; 0x7FFF | (LOWORD(Dst[v40++]) &lt;&lt; 15); v41 += 2; } while ( v40 &lt; v31 + v43 ); return v27; } v9 = a1 - a4; v10 = a3 - a1; v42 = a1 - a4; v48 = 16 - v7; if ( 16 - v7 &gt;= v10 ) v48 = v10; if ( !v8 ) return v48; v11 = 4 * v9; if ( (4 * v9) &gt; 0x40 ) v11 = 64; v12 = (v8 + 4 * (a4 &amp; 0xF)); v44 = a4 &amp; 0xF; memmove(Dst, v12, v11); v13 = 4 * v48; if ( (4 * v48) &gt; 0x40 ) v13 = 64; memmove(v12, (v8 + 4 * v7), v13); v14 = 4 * v42; if ( (4 * v42) &gt; 0x40 ) v14 = 64; memmove((v8 + 4 * ((a4 + v48) &amp; 0xF)), Dst, v14); if ( !a6 ) return v48; v15 = a4 &amp; 0xF; if ( v44 &lt; v44 + v42 ) { v16 = (v8 + 4 * v44 + 214); do { Dst[v15++] = *v16 &gt;&gt; 15; v16 += 2; } while ( v15 &lt; v44 + v42 ); } if ( v7 &lt; v48 + v7 ) { v17 = (v8 + 4 * v7 + 214); v18 = v12 + 107; v19 = v48; do { v20 = *v17 ^ (*v17 ^ *v18) &amp; 0x7FFF; v17 += 2; *v18 = v20; v18 += 2; --v19; } while ( v19 ); } v21 = a4 &amp; 0xF; if ( v44 &gt;= v44 + v42 ) return v48; v22 = (v8 + 4 * (v44 + v48) + 214); do { *v22 = *v22 &amp; 0x7FFF | (LOWORD(Dst[v21++]) &lt;&lt; 15); v22 += 2; } while ( v21 &lt; v44 + v42 ); return v48; }</span></span></code> </pre> </div></div><br><p>  Adem√°s, en apariencia, puede comprender aproximadamente lo que est√° sucediendo all√≠, y el resto para terminar con signos indirectos. <br>  Intentamos identificar estas caracter√≠sticas indirectas.  Primero, establezca la altura para las filas 16 a 64 inclusive en orden aleatorio.  Luego, frente a la fila debajo del √≠ndice 39, inserte una nueva fila.  La nueva fila copiar√° el alto de la fila 38. <br>  Veamos la informaci√≥n en los grupos de series antes y despu√©s de agregar una serie, destaqu√© las diferencias audaces: </p><br><table><thead><tr><th>  Antes de agregar una fila </th><th>  Despu√©s de agregar una fila </th></tr></thead><tbody><tr><td>  Desplazamientos en el primer grupo: </td><td>  Desplazamientos en el primer grupo: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td></tr><tr><td>  Los valores de las alturas de las filas en el primer grupo: </td><td>  Los valores de las alturas de las filas en el primer grupo: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td></tr><tr><td>  Desplazamientos en el segundo grupo: </td><td>  Desplazamientos en el segundo grupo: </td></tr><tr><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D, 05</strong> </td><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 05, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D</strong> </td></tr><tr><td>  Los valores de las alturas de las filas en el segundo grupo: </td><td>  Los valores de las alturas de las filas en el segundo grupo: </td></tr><tr><td>  10, 15, 20, 25, 30, <strong>75</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, <strong>F0</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Desplazamientos en el tercer grupo: </td><td>  Desplazamientos en el tercer grupo: </td></tr><tr><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td></tr><tr><td>  Los valores de las alturas de las filas en el tercer grupo: </td><td>  Los valores de las alturas de las filas en el tercer grupo: </td></tr><tr><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Compensaciones en el cuarto grupo: </td><td>  Compensaciones en el cuarto grupo: </td></tr><tr><td>  _ _ </td><td>  <strong>00</strong> </td></tr><tr><td>  Los valores de las alturas de las filas en el cuarto grupo: </td><td>  Los valores de las alturas de las filas en el cuarto grupo: </td></tr><tr><td>  _ _ </td><td>  <strong>40</strong> </td></tr></tbody></table><br><p>  Esto es lo que se esperaba: Excel inserta en el segundo grupo una nueva fila con el √≠ndice 7 (39 y 0xF), cuyo desplazamiento es 0x05, copia la altura de la fila en el √≠ndice 6, mientras que la √∫ltima fila, que fue el desplazamiento 05, se desplaza a la siguiente grupo, y desde all√≠ la √∫ltima fila se empuja hacia la cuarta, etc. </p><br><p>  Ahora veamos qu√© sucede si elimina la fila 29. </p><br><table><thead><tr><th>  Antes de eliminar una fila </th><th>  Despu√©s de quitar la fila </th></tr></thead><tbody><tr><td>  Desplazamientos en el primer grupo: </td><td>  Desplazamientos en el primer grupo: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0B, 0C, 02</strong> </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0C, 02, 0B</strong> </td></tr><tr><td>  Los valores de las alturas de las filas en el primer grupo: </td><td>  Los valores de las alturas de las filas en el primer grupo: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>AB</strong> , B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>85</strong> , B0, B5, E0, 100 </td></tr><tr><td>  Desplazamientos en el segundo grupo: </td><td>  Desplazamientos en el segundo grupo: </td></tr><tr><td>  <strong>06</strong> , 02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D </td><td>  02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D, <strong>06</strong> </td></tr><tr><td>  Los valores de las alturas de las filas en el segundo grupo: </td><td>  Los valores de las alturas de las filas en el segundo grupo: </td></tr><tr><td>  10, 15, 20, 25, 30, F0, <strong>85</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, F0, <strong>75</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Desplazamientos en el tercer grupo: </td><td>  Desplazamientos en el tercer grupo: </td></tr><tr><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td></tr><tr><td>  Los valores de las alturas de las filas en el tercer grupo: </td><td>  Los valores de las alturas de las filas en el tercer grupo: </td></tr><tr><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Compensaciones en el cuarto grupo: </td><td>  Compensaciones en el cuarto grupo: </td></tr><tr><td>  00 </td><td>  00 </td></tr><tr><td>  Los valores de las alturas de las filas en el cuarto grupo: </td><td>  Los valores de las alturas de las filas en el cuarto grupo: </td></tr><tr><td>  <strong>40</strong> </td><td>  <strong>50</strong> </td></tr></tbody></table><br><p>  En principio, cuando se elimina una fila, se producen operaciones inversas.  En este caso, el cuarto grupo contin√∫a existiendo y el valor de la altura de la fila all√≠ se llena con la altura est√°ndar con la bandera correspondiente - 0x8005. </p><br><p>  Estos datos son suficientes para reproducir este algoritmo en C #: </p><br><div class="spoiler">  <b class="spoiler_title">Insertrow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; RowHeightInfo etalonRowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); RowHeightInfo newRowHeightInfo = etalonRowHeightInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? etalonRowHeightInfo.Clone() : CreateDefaultRowHeight(sheetLayoutInfo); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; RowHeightInfo lastRowHeightInGroup; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span> || rowsGroupInfo.HeightInfos.Count &lt; SheetLayoutInfo.MaxRowsCountInGroup) { lastRowHeightInGroup = GetRowHeightCore(sheetLayoutInfo, ((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>); Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[newRowInGroupIndex] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastIndex = rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>]; lastRowHeightInGroup = rowsGroupInfo.HeightInfos[lastIndex]; Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos[lastIndex] = newRowHeightInfo; rowsGroupInfo.Indices[newRowInGroupIndex] = lastIndex; } newRowHeightInfo = lastRowHeightInGroup ?? CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; groupIndex != SheetLayoutInfo.MaxGroupsCount) { SetRowHeight(((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + newRowInGroupIndex, newRowHeightInfo.Value, newRowHeightInfo.Flags, sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Min(sheetLayoutInfo.MaxRowIndexNonDefault + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCount); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Removerow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { sheetLayoutInfo.RowsGroups.Insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta++; groupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newRowHeightInfo = groupIndex == SheetLayoutInfo.MaxGroupsCount - <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : GetRowHeightCore(sheetLayoutInfo, (groupIndex - sheetLayoutInfo.GroupIndexDelta + <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { newRowHeightInfo = CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.Indices[rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowInfoIndex; rowsGroupInfo.HeightInfos[rowInfoIndex] = newRowHeightInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rowIndex &lt;= sheetLayoutInfo.MinRowIndexNonDefault) { sheetLayoutInfo.MinRowIndexNonDefault = Math.Max(sheetLayoutInfo.MinRowIndexNonDefault - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><strong>Puedes encontrar todo el c√≥digo anterior en GitHub</strong></a> </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  Esta no es la primera vez que el c√≥digo Excel se sorprende con trucos interesantes.  Esta vez descubr√≠ c√≥mo almacena informaci√≥n sobre las alturas de las filas.  Si la comunidad est√° interesada, en el pr√≥ximo art√≠culo mostrar√© c√≥mo Excel considera la altura del rango de celdas (spoiler: hay algo similar a la descomposici√≥n SQRT, pero por alguna raz√≥n sin almacenar en cach√© las sumas), all√≠ puede ver c√≥mo se aplica la escala en enteros . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435426/">https://habr.com/ru/post/es435426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435416/index.html">T√©cnica de proyecto de bricolaje. Parte introductoria</a></li>
<li><a href="../es435418/index.html">Usando SQLite en Flutter</a></li>
<li><a href="../es435420/index.html">El futuro de la lucha contra el crimen es el estudio de los √°rboles geneal√≥gicos.</a></li>
<li><a href="../es435422/index.html">La experiencia de las personas en Silicon Valley</a></li>
<li><a href="../es435424/index.html">Parse y Android: recomendaciones para desarrolladores novatos</a></li>
<li><a href="../es435428/index.html">Control remoto del emulador Fceux usando Python</a></li>
<li><a href="../es435430/index.html">Las mejores noticias CES 2019</a></li>
<li><a href="../es435432/index.html">A√±o nuevo, GitHub nuevo: repositorios privados gratuitos ilimitados</a></li>
<li><a href="../es435436/index.html">5 tendencias en infraestructura de TI: pron√≥stico para 2019</a></li>
<li><a href="../es435438/index.html">PHP: estructura de base de datos cambiante en el desarrollo de equipos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>