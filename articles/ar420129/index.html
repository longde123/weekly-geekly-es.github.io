<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘š ğŸ‘ŒğŸ¾ ğŸ£ Ø£Ù†Ù…Ø§Ø· Asyncio coroutine: Ø®Ø§Ø±Ø¬ Ø§Ù†ØªØ¸Ø§Ø± ğŸ”’ ğŸš¶ğŸ¾ ğŸ”¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ±Ø¬Ù…: 
 Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ø®Ø·Ùˆ Ø¹Ù„Ù‰ Ø£Ø´Ø¹Ù„ Ø§Ù„Ù†Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ python asyncio ØŒ Ø°Ù‡Ø¨Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´ÙŠØ¡ Ø£ÙƒØ«Ø± Ù…ØªØ¹Ø© Ù…Ù† Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø¬Ø§ÙØ©. Ù„Ù‚Ø¯ Ù‚Ø±Ø£Øª Ù…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ø£Ù†Ù…Ø§Ø· Asyncio coroutine: Ø®Ø§Ø±Ø¬ Ø§Ù†ØªØ¸Ø§Ø±</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420129/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <em>Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ±Ø¬Ù…:</em> <em><br></em>  <em>Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ø®Ø·Ùˆ Ø¹Ù„Ù‰ Ø£Ø´Ø¹Ù„ Ø§Ù„Ù†Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ python asyncio ØŒ Ø°Ù‡Ø¨Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´ÙŠØ¡ Ø£ÙƒØ«Ø± Ù…ØªØ¹Ø© Ù…Ù† Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø¬Ø§ÙØ©.</em>  <em>Ù„Ù‚Ø¯ Ù‚Ø±Ø£Øª Ù…Ù‚Ø§Ù„Ù‹Ø§ Ø¨Ù‚Ù„Ù… <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Yeray Diaz Ø¨Ø¹Ù†ÙˆØ§Ù† "Ø£Ù†Ù…Ø§Ø· Asyncio Coroutine: Beyond Ø§Ù†ØªØ¸Ø§Ø±"</a> ØŒ Ø­ÙŠØ« ÙŠÙ†Ø¸Ø± Ø§Ù„Ù…Ø¤Ù„Ù Ø¨Ø´ÙƒÙ„ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù… ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Asyncio ÙˆÙŠØ´Ø§Ø±Ùƒ Ø¨Ø¹Ø¶ Ø§Ù„Ø­ÙŠÙ„.</em>  <em>Ù†Ø¸Ø±Ù‹Ø§ Ù„Ø£Ù†Ù†ÙŠ Ù„Ù… Ø£Ø¬Ø¯ Ø£ÙŠ Ø´ÙŠØ¡ Ù…ÙƒØªÙ…Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø±ÙˆØ³ÙŠØ© ØŒ ÙÙ‚Ø¯ Ù‚Ø±Ø±Øª ØªØ±Ø¬Ù…ØªÙ‡.</em> </p><br><p style=";text-align:right;direction:rtl">  Asyncio Ù‡Ùˆ Ø­Ù„Ù… ØªÙ†Ø§ÙØ³ÙŠ Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø¨Ø§ÙŠØ«ÙˆÙ†: ØªÙƒØªØ¨ Ø±Ù…Ø²Ù‹Ø§ Ù…ØªØ²Ø§Ù…Ù†Ù‹Ø§ Ø¹Ù„Ù‰ Ù†Ø­Ùˆ Ù…ØªØ²Ø§Ù…Ù† ÙˆØªØªØ±Ùƒ Python ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ.  Ù‡Ø°Ø§ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¢Ø®Ø± Ù„Ù…ÙƒØªØ¨Ø© Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©</a> </p><br><p style=";text-align:right;direction:rtl">  ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ØŒ Ù‡Ø°Ø§ Ù„ÙŠØ³ ØµØ­ÙŠØ­Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ ØŒ ÙØ§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© Ù‡ÙŠ Ø¹Ù…Ù„ Ø´Ø§Ù‚ ØŒ ÙˆØ¨ÙŠÙ†Ù…Ø§ ØªØ³Ù…Ø­ Ù„Ù†Ø§ coroutines Ø¨ØªØ¬Ù†Ø¨ Ø±Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø­ÙŠÙ… ØŒ ÙˆØ§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ£Ø®Ø°Ùƒ Ø¨Ø¹ÙŠØ¯Ù‹Ø§ Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ÙƒÙØ§ÙŠØ© ØŒ Ù…Ø§ Ø²Ù„Øª Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… ØŒ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØŒ ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª Ø¨Ø£Ù†Ø§Ù‚Ø©.  Ø¥Ù†Ù‡ Ø£Ù…Ø± Ù…Ø­Ø²Ù†. </p><br><p style=";text-align:right;direction:rtl">  Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø³Ø§Ø± Ù‡Ùˆ Ø£Ù† ÙƒÙ„ Ù‡Ø°Ø§ Ù…Ù…ÙƒÙ† ÙÙŠ asyncio.  Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø³ÙŠØ¦Ø© Ù‡ÙŠ Ø£Ù†Ù‡ Ù„ÙŠØ³ Ù…Ù† Ø§Ù„ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø®Ø·Ø£ ÙˆÙƒÙŠÙÙŠØ© Ø¥ØµÙ„Ø§Ø­Ù‡.  ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªÙŠ Ø§ÙƒØªØ´ÙØªÙ‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Asyncio. </p><a name="habracut"></a><br><br><p style=";text-align:right;direction:rtl">  Ù‚Ø¨Ù„ Ø£Ù† Ù†Ø¨Ø¯Ø£: </p><br><p style=";text-align:right;direction:rtl">  Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù…ÙƒØªØ¨Ø© aiohttp Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¯ÙŠ Ù„ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ø§Øª HTTP ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Hacker News Ù„Ø£Ù†Ù‡Ø§ Ù…ÙˆÙ‚Ø¹ Ø¨Ø³ÙŠØ· ÙˆÙ…Ø¹Ø±ÙˆÙ ÙŠØªØ¨Ø¹ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø£Ù„ÙˆÙ.  Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ù‚Ø§Ù„ØªÙŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a> ØŒ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø£ÙŠØ¶Ù‹Ø§ Ø¨Ù†Ø§Ø¡ Ø¬Ù…Ù„Ø© async / ÙŠÙ†ØªØ¸Ø± ÙÙŠ Python 3.5.  Ø§ÙØªØ±Ø¶Øª Ø£Ù† Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø¯Ø±Ø§ÙŠØ© Ø¨Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ù‡Ù†Ø§.  ÙˆÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØŒ ØªØªÙˆÙØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø«Ù„Ø© ÙÙŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù…Ø³ØªÙˆØ¯Ø¹ GitHub Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©</a> . </p><br><p style=";text-align:right;direction:rtl">  Ø­Ø³Ù†Ù‹Ø§ ØŒ ÙÙ„Ù†Ø¨Ø¯Ø£! </p><br><h2 id="rekursivnye-korutiny" style=";text-align:right;direction:rtl">  Coroutines Ø§Ù„Ø¹ÙˆØ¯ÙŠØ© </h2><br><p style=";text-align:right;direction:rtl">  ÙŠØ¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØªØ´ØºÙŠÙ„Ù‡Ø§ Ø£Ù…Ø±Ù‹Ø§ ØªØ§ÙÙ‡Ù‹Ø§ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†.  Ù„Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ø§Ù… ØŒ ÙŠØªØ¶Ù…Ù† API Ø¹Ø¯Ø© Ø·Ø±Ù‚ ÙÙŠ ÙØ¦Ø© AbstractEventLoop ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ÙˆØ¸Ø§Ø¦Ù ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©.  ÙˆÙ„ÙƒÙ† Ø¹Ø§Ø¯Ø© Ù…Ø§ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹ Ø¨ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø§ ØŒ ÙˆÙŠØ¹Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø«Ø§Ù„Ù‹Ø§ Ø±Ø§Ø¦Ø¹Ù‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø®Ø·Ø· ØŒ ÙˆÙŠÙˆØ¶Ø­ Ø£ÙŠØ¶Ù‹Ø§ Ø¨Ø³Ø§Ø·Ø© coroutine Ø¨Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰. </p><br><p style=";text-align:right;direction:rtl">  Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… asyncio Ø¥Ù†Ø´Ø§Ø¡ Ù†ÙˆØ¹ Ù…Ù† Ø²Ø§Ø­Ù Ø§Ù„ÙˆÙŠØ¨.  ØªØ®ÙŠÙ„ Ø£Ù†Ù†Ø§ Ù…Ø´ØºÙˆÙ„ÙˆÙ† Ù„Ù„ØºØ§ÙŠØ© Ø¨Ø­ÙŠØ« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† HackerNews ØŒ Ø£Ùˆ Ø±Ø¨Ù…Ø§ ØªØ±ÙŠØ¯ ÙÙ‚Ø· holivar Ø¬ÙŠØ¯ ØŒ Ù„Ø°Ù„Ùƒ ØªØ±ÙŠØ¯ ØªÙ†ÙÙŠØ° Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ±Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù…Ù†Ø´ÙˆØ± HN Ù…Ø¹ÙŠÙ† ØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ØŒ ÙŠØ®Ø·Ø±Ùƒ.  Ù„Ù‚Ø¯ ØºÙˆØºÙ„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆÙˆØ¬Ø¯Øª ÙˆØ«Ø§Ø¦Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª HN ØŒ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ ØªÙ…Ø§Ù…Ù‹Ø§ ØŒ Ù„ÙƒÙ†Ùƒ Ù„Ø§Ø­Ø¸Øª Ù…Ø§ ÙŠÙ„ÙŠ ÙÙŠ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚: </p><br><blockquote style=";text-align:right;direction:rtl">  Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ù„Ø§ØªØŸ  Ø¥Ø°Ù‡Ø¨ Ø­ÙˆÙ„ Ø§Ù„Ø´Ø¬Ø±Ø© ÙˆØ¹Ø¯Ù‡Ù…. </blockquote><p style=";text-align:right;direction:rtl">  ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©! </p><br><pre style=";text-align:right;direction:rtl"><code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""          ,       ,      . ,         Hacker News      """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlparse, parse_qs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the comments of a Hacker News post.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--id'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">8863</span></span>, help=<span class="hljs-string"><span class="hljs-string">'ID of the post in HN, defaults to 8863'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--url'</span></span>, type=str, help=<span class="hljs-string"><span class="hljs-string">'URL of a post in HN'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments def id_from_HN_url(url): """   `id` URL       None. """ parse_result = urlparse(url) try: return parse_qs(parse_result.query)['id'][0] except (KeyError, IndexError): return None if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) loop.close()</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  <em>Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù†ØµÙŠ Ø¨Ø¹Ù„Ø§Ù…Ø© "-verbose" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø®Ø±Ø§Ø¬ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹.</em> </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs css"> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  Ø¯Ø¹Ù†Ø§ Ù†ØªØ®Ø·Ù‰ ÙƒÙˆØ¯ Ø§Ù„ØµÙÙŠØ­Ø© ÙˆÙ†Ø°Ù‡Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„Ø¹ÙˆØ¯ÙŠ.  Ù„Ø§Ø­Ø¸ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ÙƒÙ…Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ø§Ù„ Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©. </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #          number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments</span></span></code> </pre> <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ JSON Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø±. </li><li style=";text-align:right;direction:rtl">  ÙƒØ±Ø± ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©. </li><li style=";text-align:right;direction:rtl">  ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØŒ Ø³Ù†ØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆÙ†Ø¹ÙˆØ¯ ØµÙØ± ØŒ <br>  Ø¹Ù†Ø¯Ù…Ø§ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ø§Øª. </li><li style=";text-align:right;direction:rtl">  Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØŒ Ø£Ø¶Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ <br>  Ø¨Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© </li></ol><br><p style=";text-align:right;direction:rtl">  Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ø±Ø§Ø¦Ø¹ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠØµÙÙ‡ Ø¨Ø±ÙŠØª Ø³Ù„Ø§ØªÙƒÙŠÙ† Ø¨Ø£Ù†Ù‡ " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù…Ø¹Ø¬Ø¨ ÙÙŠ</a> Ø§Ù„Ø¯Ø§Ø®Ù„ ÙˆØ®Ø§Ø±Ø¬Ù‡ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"</a> ØŒ Ù†Ø­Ù† Ù…ØªÙØ±ØºÙˆÙ† Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø© ØŒ ÙˆÙŠÙ„Ø®Øµ Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª </p><br><p style=";text-align:right;direction:rtl">  Ù‡Ù†Ø§Ùƒ Ø·Ø±ÙŠÙ‚ØªØ§Ù† ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª asyncio Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù‡Ø°Ù‡.  Ù‡Ù†Ø§ Ø£Ø³ØªØ®Ø¯Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ØŒ ÙˆØ§Ù„ØªÙŠ ØªØªÙˆÙ‚Ø¹ Ø¨Ø´ÙƒÙ„ ÙØ¹Ø§Ù„ Ø£Ù† ØªÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ù†ØªØ§Ø¦Ø¬Ù‡Ø§ ÙˆØªØ¹ÙŠØ¯Ù‡Ø§. </p><br><p style=";text-align:right;direction:rtl">  Ø¯Ø¹ÙˆÙ†Ø§ Ù†Ù†ØªØ¨Ù‡ Ø¥Ù„Ù‰ ÙƒÙŠÙÙŠØ© ØªÙˆØ§ÙÙ‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… coroutine Ø£ÙŠØ¶Ù‹Ø§ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø¹ÙˆØ¯ÙŠØ© Ù…Ø¹ Ø£ÙŠ Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆØ¬Ø¯ ÙÙŠÙ‡Ø§ Ø£ÙŠ Ø¹Ø¯Ø¯ Ù…Ù† coroutine ØŒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§ØªÙ‡Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆØ§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ / Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬.  Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù†Ø§ Ø¨Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø¹Ù† Ø³Ù„ÙˆÙƒ Ù…Ø¹Ù‚Ø¯ Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§ ÙÙŠ ÙƒÙˆØ±ÙˆØªÙŠÙ† ÙˆØ§Ø­Ø¯ Ø£Ù†ÙŠÙ‚ Ùˆ (Ø³Ù‡Ù„) Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©. </p><br><p style=";text-align:right;direction:rtl">  ØªÙ‚ÙˆÙ„ "Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§"ØŸ  Ø­Ø³Ù†Ù‹Ø§ ØŒ Ù„Ù†Ø°Ù‡Ø¨ Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©. </p><br><h2 id="vystrelil-i-zabyl" style=";text-align:right;direction:rtl">  Ù‚ØªÙ„ ÙˆÙ†Ø³ÙŠ </h2><br><p style=";text-align:right;direction:rtl">  ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ±Ø³Ù„ Ù„Ù†ÙØ³Ùƒ Ø±Ø³Ø§Ù„Ø© Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£ÙƒØ«Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© Ù…Ø¹ÙŠÙ†Ø© ØŒ ÙˆØªØ±ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙŠ Ù‚Ù…Ù†Ø§ Ø¨Ù‡Ø§ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.  ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø© if ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯ÙŠØ© Ù„ØªØ­Ù‚ÙŠÙ‚ Ø°Ù„Ùƒ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: await log_post(response) return number_of_comments async def log_post(post): """   . """ await asyncio.sleep(random() * 3) log.info("Post logged")</span></span></code> </pre><br><p style=";text-align:right;direction:rtl">  <em>Ù†Ø¹Ù… ØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª asyncio.sleep.</em>  <em>Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©.</em>  <em>Ø£Ø¹Ø¯Ùƒ.</em> </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:02]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:04]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 6<span class="hljs-selector-class"><span class="hljs-selector-class">.35</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  Ù‡Ø°Ø§ Ø£Ø¨Ø·Ø£ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø°ÙŠ Ù‚Ø¨Ù„! <br>  ÙˆØ§Ù„Ø³Ø¨Ø¨ Ù‡Ùˆ ØŒ ÙƒÙ…Ø§ Ù†Ø§Ù‚Ø´Ù†Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ØŒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° coroutine Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØŒ ÙˆÙ„ÙƒÙ† Ù†Ø¸Ø±Ù‹Ø§ Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØŒ ÙÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¨Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ. </p><br><p style=";text-align:right;direction:rtl">  Ù†Ø­Ù† Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ "Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± ÙˆØ§Ù„Ù†Ø³ÙŠØ§Ù†" Ù…Ø¹ coroutine Ù„Ø¯ÙŠÙ†Ø§ ØŒ ÙˆØ¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ØŒ ÙÙ†Ø­Ù† Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ coroutine Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±.  Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª asyncio Ø³ØªØ¹Ø«Ø± Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">include_future</a> Ø§Ù„ØªÙŠ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø¬Ø¯ÙˆÙ„Ø© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Coroutine Ù„Ù„ØªØ´ØºÙŠÙ„</a> ØŒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ÙˆÙ„ÙÙ‡Ø§</a> ÙÙŠ ÙƒØ§Ø¦Ù† Task ØŒ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§.  ØªØ°ÙƒØ± Ø£Ù†Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù€ coroutine ØŒ Ø³ØªØªØ­ÙƒÙ… Ø¯ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙŠ Ù†ØªÙŠØ¬Ø© coroutine ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ù…Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØŒ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† coroutine Ø¢Ø®Ø± ÙÙŠ Ø­Ø§Ù„Ø© ØªÙˆÙ‚Ø¹. </p><br><p style=";text-align:right;direction:rtl">  Ø±Ø§Ø¦Ø¹ ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªØ¨Ø¯Ù„ log_post Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø­Ùˆ Ø§Ù„ØªØ§Ù„ÙŠ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: asyncio.ensure_future(log_post(response)) return number_of_comments</span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">1.69</span></span> seconds and <span class="hljs-number"><span class="hljs-number">73</span></span> fetches [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] -- Post <span class="hljs-number"><span class="hljs-number">8863</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x1109197f8</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919948</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919978</span></span>&gt;()]&gt;&gt;</code> </pre> <br><p style=";text-align:right;direction:rtl">  Ù…Ù‡Ù… ØŒ <abbr title="Ù„Ù‚Ø¯ ØªÙ… ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø© ØŒ ÙˆÙ„ÙƒÙ† ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù†Ù‡Ø§!">ØªÙ… ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©</abbr> Ø§Ù„Ø±Ø§Ø¦Ø¹Ø© <abbr title="Ù„Ù‚Ø¯ ØªÙ… ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø© ØŒ ÙˆÙ„ÙƒÙ† ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù†Ù‡Ø§!">ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ù…Ø¹Ù„Ù‚Ø©!</abbr>  ÙŠØ·Ø§Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù….  Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø³Ø§Ø± Ù‡Ùˆ Ø£Ù†Ù†Ø§ Ø¹Ø¯Ù†Ø§ Ø¥Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø°ÙŠ ØªÙ„Ù‚ÙŠÙ†Ø§Ù‡ ÙÙŠ ÙˆÙ‚Øª Ø³Ø§Ø¨Ù‚ (1.69 Øµ) ØŒ ÙˆØ§Ù„Ø®Ø¨Ø± Ø§Ù„Ø³ÙŠØ¦ Ù‡Ùˆ Ø£Ù† asyncio Ù„Ø§ ÙŠØ­Ø¨ ØªØ¬Ø§ÙˆØ² Ù†Ø·Ø§Ù‚ Ø§Ù„Ù„Ù‚Ø·Ø© ÙˆØ§Ù„Ù†Ø³ÙŠØ§Ù†. </p><br><p style=";text-align:right;direction:rtl">  ØªÙƒÙ…Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø£Ù†Ù†Ø§ Ø£ØºÙ„Ù‚Ù†Ø§ Ø­Ù„Ù‚Ø© Ø§Ù„Ø­Ø¯Ø« Ø¨Ù‚ÙˆØ© Ø¨Ø¹Ø¯ Ø£Ù† Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø§Ø¦Ø­Ø© post_number_of_comments ØŒ Ø¯ÙˆÙ† ØªØ±Ùƒ ÙˆÙ‚Øª <em>log_post Ø§Ù„Ø®Ø§Øµ</em> Ø¨Ù†Ø§ <em>Ù„Ø¥ÙƒÙ…Ø§Ù„Ù‡</em> . </p><br><p style=";text-align:right;direction:rtl">  Ù„Ø¯ÙŠÙ†Ø§ Ø®ÙŠØ§Ø±Ø§Ù†: <br>  Ø¥Ù…Ø§ Ø£Ù† Ù†Ø¯Ø¹ Ø­Ù„Ù‚Ø© Ø§Ù„Ø­Ø¯Ø« ØªØ¹Ù…Ù„ Ø¥Ù„Ù‰ Ù…Ø§ Ù„Ø§ Ù†Ù‡Ø§ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">run_forever ÙˆÙ†Ù†Ù‡ÙŠ</a> Ø§Ù„Ù†Øµ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§ ØŒ Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">all_tasks</a> Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª. </p><br><p style=";text-align:right;direction:rtl">  Ø¯Ø¹Ù†Ø§ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ù Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¥Ø¬Ø±Ø§Ø¡ ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø³Ø±Ø¹Ø© Ø¨Ø¹Ø¯ <em>Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù†Ø§</em> Ø¥Ù„Ù‰ <em>post_number_of_comments</em> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: args = <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.parse_args() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.setLevel(logging.<span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span>) post_id = id_from_HN_url(args.url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.url <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> args.id <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> = asyncio.get_event_loop() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>: now = datetime.now() comments = <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete( post_number_of_comments(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, post_id)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [ task <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> asyncio.Task.all_tasks() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> task.done()] <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete(asyncio.gather(*pending_tasks)) <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>()</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.72</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> â€” <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:30]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:31]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  Ù†Ø­Ù† Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ ÙŠÙ‚ÙŠÙ† Ù…Ù† Ø£Ù† Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„Øª. <br>  ÙŠÙØ¹Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ Ø¨Ø£Ù† Ø·Ø±ÙŠÙ‚Ø© <em>all_tasks ØªØ¹Ù…Ù„</em> Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙƒØ±Ø© Ø±Ø§Ø¦Ø¹Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨ ÙÙŠ Ø­Ù„Ù‚Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø¯ÙŠÙ†Ø§ ØŒ ÙˆÙ„ÙƒÙ† ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡Ø§ ØŒ ÙˆØ§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµØ¯Ø±Ù‡Ø§ Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§ . </p><br><p style=";text-align:right;direction:rtl">  Ù†Ù‡Ø¬ Ø¢Ø®Ø± Ù‡Ùˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ Ø£Ù† Ù†Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© Ø§Ù„ØªÙŠ Ø®Ø·Ø·Ù†Ø§ Ù„Ø¥Ø·Ù„Ø§Ù‚Ù‡Ø§ ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ†ÙÙŠØ°Ù‡Ø§ ØŒ ÙˆØ§Ù„ØªÙŠ ØªÙ… ØªØ£Ø¬ÙŠÙ„Ù‡Ø§ ÙÙŠ ÙˆÙ‚Øª Ø³Ø§Ø¨Ù‚ ØŒ <br>  Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¹Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.  ÙƒÙ…Ø§ ØªØ¹Ù„Ù…ÙˆÙ† ØŒ ØªÙØ±Ø¬Ø¹ Ø§Ù„Ø¯Ø§Ù„Ø© <em>include_future</em> ÙƒØ§Ø¦Ù† <em>Ù…Ù‡Ù…Ø©</em> . ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‡Ø§Ù…Ù†Ø§ Ø¨Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©.  Ø¯Ø¹Ù†Ø§ ÙÙ‚Ø· Ù†Ø­Ø¯Ø¯ Ù‚Ø§Ø¦Ù…Ø© <em>Ø§Ù„Ù…Ù‡Ø§Ù…_Ø§Ù„Ø³Ø¬Ù„ÙŠØ©</em> ÙˆÙ†Ø®Ø²Ù† Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¢Ø¬Ù„Ø© ÙÙŠÙ‡Ø§: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Retrieve data for current post and recursively for all comments. """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 # calculate this post's comments as number of comments number_of_comments = len(response['kids']) # create recursive tasks for all comments tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] # schedule the tasks and retrieve results results = await asyncio.gather(*tasks) # reduce the descendents comments and add it to this post's number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) # Log if number of comments is over a threshold if number_of_comments &gt; MIN_COMMENTS: # Add the future to the registry task_registry.append(asyncio.ensure_future(log_post(response))) return number_of_comments # (... ommitted code ...) # if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() task_registry = [] # define our task registry with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [task for task in task_registry if not task.done()] loop.run_until_complete(asyncio.gather(*pending_tasks)) loop.close()</span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> â€” <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:48]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:49]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  Ù†ØªØ¹Ù„Ù… Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ - Ù„Ø§ ÙŠÙ†Ø¨ØºÙŠ <em>Ø§Ø¹ØªØ¨Ø§Ø± Asyncio ÙƒÙ‚Ø§Ø¦Ù…Ø©</em> Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù‡Ù…Ø© Ù…ÙˆØ²Ø¹Ø© Ù…Ø«Ù„ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><em>Ø§Ù„ÙƒØ±ÙØ³</em></a> .  ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… ÙÙŠ Ø³Ù„Ø³Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆÙŠØ¬Ø¨ Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆÙÙ‚Ù‹Ø§ Ù„Ø°Ù„Ùƒ ØŒ Ù…Ù…Ø§ ÙŠØªÙŠØ­ Ù„Ùƒ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆÙ‚Øª Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…. </p><br><p style=";text-align:right;direction:rtl">  Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ù†Ù…Ø· Ø¢Ø®Ø± Ù…Ù‚Ø¨ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…: </p><br><h2 id="periodicheski-zapuskaemye-korutiny" style=";text-align:right;direction:rtl">  Ø£Ø«Ø§Ø± corÙˆØªÙŠÙ†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ </h2><br><p style=";text-align:right;direction:rtl">  Ø§Ø³ØªÙ…Ø±Ø§Ø±Ù‹Ø§ Ø¨Ù…Ø«Ø§Ù„Ù†Ø§ Ø­ÙˆÙ„ HN (ÙˆÙ‚Ù…Ù†Ø§ Ø¨Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹ ÙÙŠ ÙˆÙ‚Øª Ø³Ø§Ø¨Ù‚) ØŒ Ù‚Ø±Ø±Ù†Ø§ <br>  ÙˆÙ‡Ùˆ Ø£Ù…Ø± Ø­Ø§Ø³Ù… Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ± HN Ø¨Ù…Ø¬Ø±Ø¯ Ø£Ù† ØªØµØ¨Ø­ Ù…ØªØ§Ø­Ø© ÙˆØ£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯Ù‡Ù… ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© 5 Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©. </p><br><p style=";text-align:right;direction:rtl">  Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ HN API ØªÙØ¸Ù‡Ø± Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© ØªÙØ±Ø¬Ø¹ Ø¢Ø®Ø± 500 Ø³Ø¬Ù„.  Ø±Ø§Ø¦Ø¹ ØŒ Ù„Ø°Ù„Ùƒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‡Ø°Ù‡ Ù„ØªÙ„Ù‚ÙŠ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„ÙŠÙ‡Ø§ ØŒ ÙƒÙ„ Ø®Ù…Ø³ Ø«ÙˆØ§Ù†Ù Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„. </p><br><p style=";text-align:right;direction:rtl">  Ø­Ø³Ù†Ù‹Ø§ ØŒ Ù†Ø¸Ø±Ù‹Ø§ Ù„Ø£Ù†Ù†Ø§ Ù†Ù†ØªÙ‚Ù„ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹ Ø§Ù„Ø¯ÙˆØ±ÙŠ ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„Ø§Ù…ØªÙ†Ø§Ù‡ÙŠ <em>Ø£Ø«Ù†Ø§Ø¡</em> Ø§Ù„ØªÙƒØ±Ø§Ø± ØŒ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ù…Ù‡Ù…Ø© Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ ( <em>Ù†Ù†ØªØ¸Ø±</em> Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©) ØŒ <em>ÙˆÙ†ØºÙÙˆ</em> ( <em>Ù†ÙˆÙ…</em> Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©) <em>Ù„Ù„Ù…Ø¯Ø©</em> Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„ÙˆÙ‚Øª.  Ù„Ù‚Ø¯ Ø£Ø¬Ø±ÙŠØª Ø¨Ø¹Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø·ÙÙŠÙØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†ÙˆØ§Ù† URL Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©. </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" An example of periodically scheduling coroutines using an infinite loop of awaiting and sleeping. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>,help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """     HN. """ response = await fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments(loop, session, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format(post_id, num_comments, iteration)) async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ global fetch_counter iteration = 1 while True: now = datetime.now() log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) await get_comments_of_top_stories(loop, session, limit, iteration) log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("Waiting for {} seconds...".format(period)) iteration += 1 fetch_counter = 0 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.96</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦ [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.04</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦</code> </pre> <br><p style=";text-align:right;direction:rtl">  Ø±Ø§Ø¦Ø¹ ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø³ÙŠØ·Ø©: Ø¥Ø°Ø§ Ø§Ù†ØªØ¨Ù‡Øª Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ ØŒ <br>  Ø«Ù… Ù„Ø§ ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø´ÙƒÙ„ ØµØ§Ø±Ù… ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù ØŒ ÙˆØªØ¨Ø¯Ø£ <strong><em>Ø¨Ø¹Ø¯</em></strong> 5 Ø«ÙˆØ§Ù†Ù Ù…Ù† <strong><em>Ø¥ÙƒÙ…Ø§Ù„ get_comments_of_top_stories</em></strong> .  Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹ÙˆØ§Ù‚Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… <em>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</em> ÙˆØ§Ù„Ø­Ø¸Ø± Ø­ØªÙ‰ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬Ù†Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. <br>  Ù„Ø§ ØªØ·Ø±Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù…Ø´ÙƒÙ„Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ø®Ù…Ø³ Ø«ÙˆØ§Ù†Ù.  Ø£ÙŠØ¶Ø§ ØŒ ÙŠØ¨Ø¯Ùˆ Ù…Ù† Ø§Ù„Ø®Ø·Ø£ Ø§Ø³ØªØ®Ø¯Ø§Ù… _run_until <em>ÙƒØ§Ù…Ù„Ø©</em> Ø¹Ù†Ø¯Ù…Ø§ ØªÙ… ØªØµÙ…ÙŠÙ… coroutine Ù„ÙŠÙƒÙˆÙ† Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ. </p><br><p style=";text-align:right;direction:rtl">  Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø³Ø§Ø± Ù‡Ùˆ Ø£Ù†Ù†Ø§ Ø§Ù„Ø¢Ù† Ø®Ø¨Ø±Ø§Ø¡ ÙÙŠ <em>Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</em> ØŒ ÙˆÙŠÙ…ÙƒÙ†Ù†Ø§ ÙÙ‚Ø· Ø¯ÙØ¹Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ <em>Ø§Ù†ØªØ¸Ø§Ø±</em> ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: now = datetime.now() log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">0</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦ [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">260</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦ [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">  Ù…Ù‡Ù… ... Ø­Ø³Ù†Ù‹Ø§ ØŒ Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø³Ø§Ø± Ù‡Ùˆ Ø£Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙŠÙ‚Ø¹ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø¨Ø¹Ø¯ Ø®Ù…Ø³ Ø«ÙˆØ§Ù†Ù Ø¨Ø§Ù„Ø¶Ø¨Ø· ØŒ ÙˆÙ„ÙƒÙ† Ù…Ø§Ø°Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ 0.00 Ø«Ø§Ù†ÙŠØ© ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø¹ÙŠÙ†Ø§Øª ØŒ Ø«Ù… ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ ØµÙØ± Ø«Ø§Ù†ÙŠØ© Ùˆ 260 Ø¹ÙŠÙ†Ø©ØŸ </p><br><p style=";text-align:right;direction:rtl">  Ù‡Ø°Ù‡ Ø¥Ø­Ø¯Ù‰ Ø¹ÙˆØ§Ù‚Ø¨ ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ØŒ ÙˆØ§Ù„Ø¢Ù† Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­Ø¸Ø± coroutine ÙˆÙ†Ù†ØªÙ‚Ù„ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ ØŒ Ø§Ù„Ø°ÙŠ ÙŠØ·Ø¨Ø¹ ØµÙØ± Ø«Ø§Ù†ÙŠØ© ØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£ÙŠØ© Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.  Ù‡Ø°Ù‡ Ù…Ù‡Ø§Ù… ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ ØŒ Ø­ÙŠØ« ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„Ø¹ÙŠØ´ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ ØŒ ÙˆÙ„ÙƒÙ† Ù…Ø§Ø°Ø§ Ù„Ùˆ ÙƒÙ†Ø§ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù‡Ø§Ù…ØŸ </p><br><p style=";text-align:right;direction:rtl">  Ø«Ù… ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ Ù†Ø­ØªØ§Ø¬ Ø£Ù† Ù†Ù„Ø¬Ø£ Ø¥Ù„Ù‰ ... Ø±Ø¯ (((() </p><br><p style=";text-align:right;direction:rtl">  Ø£Ø¹Ù„Ù… ØŒ Ø£Ø¹Ù„Ù… ØŒ Ø£Ù† Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† coroutine Ù‡Ùˆ ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ø§Øª ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ø°Ø§ Ù„Ø£Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø¯Ø±Ø§Ù…ÙŠ Ù„Ù„Ù…Ù‚Ø§Ù„ Ù‡Ùˆ "Ø®Ø§Ø±Ø¬ Ø§Ù†ØªØ¸Ø§Ø±".  Ù„Ù… Ù†Ø¹Ø¯ ÙÙŠ <em>Ø§Ù†ØªØ¸Ø§Ø±</em> Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ØŒ Ù„Ø¯ÙŠÙ†Ø§ Ù…ØºØ§Ù…Ø±Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ù‡Ø§Ù… ØŒ Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§.  Ù…Ø§Ø°Ø§ ÙŠÙ…Ù†Ø­Ùƒ Ù‡Ø°Ø§ØŸ  <abbr title="Ù„ÙŠØ³ Ø³ÙŠØ¦Ø§ Ù„Ù„ØºØ§ÙŠØ©">Ø§Ù„Ù…ÙØ³Ø¯</abbr> </p><br><p style=";text-align:right;direction:rtl">  ÙƒÙ…Ø§ Ù†Ø§Ù‚Ø´Ù†Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ØŒ <em>ØªØ¶Ù…Ù† include_future</em> ÙƒØ§Ø¦Ù†Ù‹Ø§ <em>Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ‹Ø§</em> ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… _add_done <em>callback</em> . </p><br><p style=";text-align:right;direction:rtl">  Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ ØŒ ÙˆÙ…Ù† Ø£Ø¬Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„ØµØ­ÙŠØ­ ØŒ Ù†ØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙŠ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„ØªØºÙ„ÙŠÙ <em>ÙƒÙˆØ±ÙˆØªÙŠÙ†</em> Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙŠ ÙØ¦Ø© <em>URLFetcher</em> .  ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø© Ø¨Ø­ÙŠØ« ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ†Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø¹ÙŠÙ†Ø§Øª.  Ù†Ø²ÙŠÙ„ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø®Ø·Ø£ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""               ensure_future   sleep.      future,    ensure_future,         ,    URLFetcher   . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, fetcher, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetcher.fetch(session, url) <span class="hljs-comment"><span class="hljs-comment">#  .  . if response is None or 'kids' not in response: return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, fetcher, kid_id) for kid_id in response['kids']] # s     results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """    HN. """ fetcher = URLFetcher() # create a new fetcher for this task response = await fetcher.fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments( loop, session, fetcher, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format( post_id, num_comments, iteration)) return fetcher.fetch_counter # return the fetch count async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ iteration = 1 while True: log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) future = asyncio.ensure_future(get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() def callback(fut): fetch_count = fut.result() log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info("Waiting for {} seconds...".format(period)) iteration += 1 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.17</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.47</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">3</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds...</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,  ,      callback: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><p style=";text-align:right;direction:rtl">    ,  <em>callback</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">    ,      future.</a>     (fetch)   <em>URLFetcher</em>   _get_comments_of_top <em>stories</em>       future. </p><br><p style=";text-align:right;direction:rtl">  ØªØ±Ù‰ØŸ   ,    ,     <em>await</em> . </p><br><p style=";text-align:right;direction:rtl">    callback-,      API asyncio       <em>AbstractBaseLoop</em>   _call <em>later</em>  _call <em>at</em> , <br>    -     .    ,   ,       <em>poll_top_stories_for_comments</em> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit, iteration=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     get_comments_of_top_stories. """</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> loop.call_later( period, partial( <span class="hljs-comment"><span class="hljs-comment"># or call_at(loop.time() + period) poll_top_stories_for_comments, loop, session, period, limit, iteration ) ) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: poll_top_stories_for_comments( loop, session, args.period, args.limit) loop.run_forever() loop.close()</span></span></code> </pre><br><p style=";text-align:right;direction:rtl">    .     : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">              ,     <em>ensure_future</em>     . <br> ( :   ) </li><li style=";text-align:right;direction:rtl">  _poll_top_stories_for <em>comments</em>       ,     ,      _run <em>forever</em>  ,     . </li></ul><br><p style=";text-align:right;direction:rtl"> ,      , ,     â€”      ?      ?           URL: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">MAXIMUM_FETCHES = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.fetch_counter &gt; MAXIMUM_FETCHES: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json()</code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦ [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finisheâ€¦ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span> handle: &lt;Handle poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finisheâ€¦ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span>&gt; Traceback (most recent <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> last): File â€œ/Users/yeray/.pyenv/versions/<span class="hljs-number"><span class="hljs-number">3.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/lib/python3<span class="hljs-number"><span class="hljs-number">.6</span></span>/asyncio/events.pyâ€, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _run self._callback(*self._args) File â€œ<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.pyâ€, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback fetch_count = fut.result() File â€œ<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.pyâ€, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> get_comments_of_top_stories results = await asyncio.gather(*tasks) File â€œ<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.pyâ€, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> post_number_of_comments response = await fetcher.<span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, url) File â€œ<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.pyâ€, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: BOOM! [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> secondsâ€¦</code> </pre> <br><p style=";text-align:right;direction:rtl">   , ? </p><br><p style=";text-align:right;direction:rtl">  Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„      ,    ,          : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> asyncio :   </a> </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar420129/">https://habr.com/ru/post/ar420129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar420117/index.html">Ø¯Ù„ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ Mikrotik</a></li>
<li><a href="../ar420119/index.html">10 Ø£Ø·Ø± ÙˆÙŠØ¨ Python ØªØ³ØªØ­Ù‚ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙŠ 2018</a></li>
<li><a href="../ar420121/index.html">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚ÙˆØ©: Ø§Ù„Ù†Ù…Ù„ Ø§Ù„Ø£Ø¨ÙŠØ¶ LT450 ØŒ LXI</a></li>
<li><a href="../ar420123/index.html">Ù…Ø§ Ù‡Ùˆ Node.js Ø­Ù‚Ù‹Ø§ØŸ</a></li>
<li><a href="../ar420125/index.html">Ø§Ù„Ø£ØªÙ…ØªØ© ÙÙŠ Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª</a></li>
<li><a href="../ar420131/index.html">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠ Ù„Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†</a></li>
<li><a href="../ar420133/index.html">Ù†Ù…Ø°Ø¬Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©: ÙƒÙŠÙ ÙŠØªØ­Ø±Ùƒ Ø§Ù„Ù‚Ù…Ø±ØŸ</a></li>
<li><a href="../ar420135/index.html">Ù‡Ø°Ø§ Ø£ÙŠØ¶Ù‹Ø§ Toshiba: Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù„Ù„Ø´Ø±ÙƒØ© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ÙŠØ©</a></li>
<li><a href="../ar420139/index.html">ÙƒØªØ§Ø¨ "Ù‡Ù†Ø¯Ø³Ø© Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Google Â»</a></li>
<li><a href="../ar420141/index.html">Ù…Ù† MPP DBMS Ø§Ù„Ù…Ø­Ù…Ù„ - Ø¨Ø­ÙŠØ±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØ¹Ù… Ø¨Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª ØªØ­Ù„ÙŠÙ„ÙŠØ©: Ø´Ø§Ø±Ùƒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>