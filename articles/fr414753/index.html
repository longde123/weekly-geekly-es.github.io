<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¸ ğŸ‘©ğŸ¼â€ğŸ’¼ ğŸ” Bus PCIe: les limitations physiques affectent-elles le taux de transfert? ğŸ’ªğŸ» ğŸ‘¨ğŸ¾â€ğŸ’¼ â™¨ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je pars de loin. L'hiver dernier, il m'est arrivÃ© de fabriquer un pÃ©riphÃ©rique USB avec un noyau hÃ©bergÃ© dans le FPGA. Bien sÃ»r, je voulais vraiment v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bus PCIe: les limitations physiques affectent-elles le taux de transfert?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414753/">  Je pars de loin.  L'hiver dernier, il m'est arrivÃ© de fabriquer un pÃ©riphÃ©rique USB avec un noyau hÃ©bergÃ© dans le FPGA.  Bien sÃ»r, je voulais vraiment vÃ©rifier la bande passante rÃ©elle de ce bus.  AprÃ¨s tout, dans le contrÃ´leur - il y a trop Ã  faire.  Vous pouvez toujours dire qu'il y a un retard, ou lÃ -bas.  Dans le cas des FPGA, je vois un bloc de donnÃ©es de pompage, alors il m'a dit qu'il y avait des donnÃ©es dedans.  Mais j'ai dÃ©fini que tout a Ã©tÃ© traitÃ© et je suis prÃªt Ã  accepter une nouvelle portion (en mÃªme temps, il reÃ§oit dÃ©jÃ  des donnÃ©es dans le deuxiÃ¨me tampon du mÃªme point de terminaison).  TrÃ¨s bien, dÃ©finissez la prÃ©paration dÃ¨s la toute premiÃ¨re mesure et voyez ce qui se passe lorsque l'USB peut Â«martelerÂ» sans s'arrÃªter. <br><br><img src="https://habrastorage.org/webt/ab/ft/n3/abftn3olrakrhdj3zztrcksut5k.jpeg"><br><a name="habracut"></a><br>  Mais cela s'avÃ¨re une chose incroyable.  Si le pÃ©riphÃ©rique USB 2.0 est coincÃ© dans le connecteur Â«bleuÂ» (qui est USB 3.0), la vitesse est de un.  Si en "noir" - un autre.  Voici mon graphique de la vitesse d'enregistrement USB en fonction de la longueur des donnÃ©es.  USB3 et USB2 sont le type de connecteur; l'appareil est toujours USB 2.0 HS. <br><br><img src="https://habrastorage.org/webt/ea/sg/ja/easgjasaj1jbzovcsgbiymhploa.png"><br><br>  J'ai essayÃ© sur diffÃ©rentes machines.  Le rÃ©sultat est proche.  Personne ne pouvait m'expliquer ce phÃ©nomÃ¨ne.  Plus tard, j'ai trouvÃ© la raison la plus probable.  Et la raison est trÃ¨s simple.  Voici les propriÃ©tÃ©s du contrÃ´leur USB 2.0: <br><br><img src="https://habrastorage.org/webt/2y/ek/xl/2yekxlpcnthq8p06z8wpxxasjgo.png"><br><br>  Les contrÃ´leurs contrÃ´lant le connecteur Â«bleuÂ» ne le font pas.  Et la diffÃ©rence n'est que d'environ 20%. <br><br>  Nous en concluons que les limitations de bande passante ne sont pas toujours dÃ©terminÃ©es par les propriÃ©tÃ©s physiques du bus.  Parfois, d'autres choses se superposent.  Nous passons avec cette connaissance ces jours-ci. <br><br><h2>  ExpÃ©rience primaire </h2><br>  Alors.  Tout a commencÃ© assez banal.  Il y avait une vÃ©rification d'un programme.  Le processus d'Ã©criture simultanÃ©e des donnÃ©es sur plusieurs disques a Ã©tÃ© vÃ©rifiÃ©.  Le matÃ©riel est simple: il y a une carte mÃ¨re avec quatre slots PCIe.  Des cartes absolument identiques avec des contrÃ´leurs AHCI sont insÃ©rÃ©es dans tous les emplacements, chacun prenant en charge exclusivement PCIe x1. <br><br><img src="https://habrastorage.org/webt/4k/il/lz/4killzfbtb9r6evuybrs68e6xl0.jpeg"><br><br>  Chaque carte sert 4 disques. <br>  Et puis l'effet suivant est rÃ©vÃ©lÃ©.  Nous prenons un disque et commenÃ§ons Ã  y Ã©crire des donnÃ©es.  Nous obtenons une vitesse de 180 Ã  220 mÃ©gaoctets par seconde (ci-aprÃ¨s, les mÃ©gaoctets sont 1024 * 1024 octets): <br><br><img src="https://habrastorage.org/webt/we/cu/uy/wecuuyqewi743lh6kcxiqgpkk5i.png"><br><br>  Nous prenons le deuxiÃ¨me disque.  La vitesse d'Ã©criture est de 170 Ã  190 Mo / s: <br><br><img src="https://habrastorage.org/webt/cs/0o/g7/cs0og7k2kztps5h2vgvw7yfsrno.png"><br><br>  Nous Ã©crivons immÃ©diatement aux deux - nous obtenons un ralentissement de la vitesse: <br><br><img src="https://habrastorage.org/webt/xz/at/nk/xzatnk1bt2sog8qsvkjaryf34j0.png"><br><br>  La vitesse totale est d'environ 290 Mo / s.  Mais ce qui est Ã©tonnant, c'est que nous avons dÃ©boguÃ© (donc il s'est avÃ©rÃ©) ce programme sur les mÃªmes disques, mais sur d'autres canaux.  Et tout allait bien lÃ -bas.  Nous transfÃ©rons rapidement vers ces canaux (ils passeront par une autre carte), nous obtenons un excellent travail: <br><br><img src="https://habrastorage.org/webt/xd/jj/qo/xdjjqomypz-hhmaq6yt73wtoai4.png"><br><br><h2>  Je vais acheter une fente dans un bon quartier </h2><br>  Je dois dire tout de suite que cela ne vaut pas la peine de tout blÃ¢mer sur les composants de quelqu'un d'autre.  Tout ici est Ã©crit par nous, Ã  partir du programme lui-mÃªme, se terminant par les pilotes.  Ainsi, l'ensemble du chemin de donnÃ©es peut Ãªtre surveillÃ©.  L'inconnu ne vient que lorsque la demande a Ã©tÃ© envoyÃ©e au matÃ©riel. <br><br>  AprÃ¨s l'analyse initiale, il s'est avÃ©rÃ© que la vitesse n'est pas limitÃ©e dans les Â«longsÂ» emplacements PCIe et est limitÃ©e dans les Â«courtsÂ».  Les longues sont oÃ¹ vous pouvez insÃ©rer des cartes x16 (bien que l'une d'entre elles fonctionne en mode non supÃ©rieur Ã  x4), et les courtes sont uniquement pour les cartes x1. <br><br><img src="https://habrastorage.org/webt/38/kt/jt/38ktjtqf38knqdotsc3gxacmqos.jpeg"><br><br>  Tout irait bien, mais les contrÃ´leurs des cartes actuelles ne peuvent en principe pas fonctionner dans un mode autre que PCIex1.  Autrement dit, tous les contrÃ´leurs doivent Ãªtre dans des conditions absolument identiques, quelle que soit la longueur de l'emplacement!  Mais non.  Qui vit dans le "long" - travaille vite, qui dans le "court" - lentement.  Bon.  Et rapide - Ã  quelle vitesse?  Ajoutez un troisiÃ¨me lecteur, Ã©crivez sur les trois. <br><br>  Dans les crÃ©neaux "courts", la limite est toujours aux alentours de 290 Mo / s: <br><br><img src="https://habrastorage.org/webt/i-/ti/jr/i-tijrldg-h9izkdypn5iyzir8k.png"><br><br>  Dans le "long" - dans la rÃ©gion de 400 Mo / s: <br><br><img src="https://habrastorage.org/webt/qh/gn/w_/qhgnw_p59bewkzpoj8o0i8jexns.png"><br><br><img src="https://habrastorage.org/webt/oh/yz/gt/ohyzgt_cbix1f8uufh8-s5dnazk.png"><br><br>  J'ai fouillÃ© tout Internet.  PremiÃ¨rement, aprÃ¨s un certain temps, j'ai dÃ©jÃ  ri d'articles qui disent que le dÃ©bit de PCIe gen 1 et gen 2 pour x1 est de 250 et 500 Mo / s.  Ce sont des mÃ©gaoctets bruts.  En raison de la surcharge (j'utilise ce mot non russe pour dÃ©signer un Ã©change de services qui va dans le mÃªme sens que les donnÃ©es principales) pour la gÃ©nÃ©ration 2, nous obtenons exactement 400 mÃ©gaoctets par seconde de flux utile.  DeuxiÃ¨mement, je ne pouvais obstinÃ©ment rien trouver sur le nombre magique 290 (regarder vers lâ€™avenir - je ne lâ€™ai toujours pas trouvÃ©). <br><br>  Super.  Essayer de regarder la topologie de l'inclusion de nos contrÃ´leurs.  Le voici (013-015 - ce sont les suffixes de nom de pÃ©riphÃ©rique par lesquels je les ai comparÃ©s afin de les distinguer).  Le vert est rapide, le rouge est lent. <br><br><img src="https://habrastorage.org/webt/ae/xo/3o/aexo3oqtd-c7caogtc-bthelriq.png"><br><br>  Le contrÃ´leur "015" nous ne considÃ©rons mÃªme pas.  Il vit dans une fente privilÃ©giÃ©e conÃ§ue pour une carte vidÃ©o.  Mais le 013rd est connectÃ© au mÃªme commutateur que le 012nd Ã  partir du 014th.  En quoi est-il diffÃ©rent? <br><br>  Certains articles disent que diffÃ©rentes cartes peuvent diffÃ©rer dans les paramÃ¨tres de Max Payload.  J'ai Ã©tudiÃ© l'espace de configuration de toutes les cartes - ce paramÃ¨tre est pour tout le monde dans la mÃªme valeur minimale possible.  De plus, la documentation du chipset de cette carte mÃ¨re indique qu'il ne peut y avoir d'autre sens. <br><br><img src="https://habrastorage.org/webt/ch/tg/iv/chtgivqtyksowq7blomsrtpmija.png"><br><br>  En gÃ©nÃ©ral, j'ai fouillÃ© tout dans l'espace de configuration - tout est configurÃ© de maniÃ¨re identique.  Et la vitesse est diffÃ©rente!  Relisez Ã  plusieurs reprises la documentation du chipset - pas de paramÃ¨tres de bande passante.  PrioritÃ©s - oui, quelque chose a Ã©tÃ© Ã©crit Ã  leur sujet, mais les tests sont effectuÃ©s en l'absence totale de charge sur d'autres canaux!  Autrement dit, ce n'est pas en eux. <br><br>  Au cas oÃ¹, j'aurais mÃªme dÃ©sactivÃ© le programme d'interruption.  La charge du processeur a augmentÃ© Ã  des niveaux insensÃ©s, car maintenant, il lit constamment stupidement le bit de prÃ©paration, mais les lectures de vitesse n'ont pas changÃ©.  Il est donc impossible de blÃ¢mer ce sous-systÃ¨me pour des problÃ¨mes. <br><br><h2>  Et les autres planches? </h2><br>  Nous avons essayÃ© de changer exactement la mÃªme carte mÃ¨re.  Pas de changement.  Ils ont essayÃ© de remplacer le processeur (il y avait des raisons de croire qu'il s'agissait d'un dÃ©tournement).  De plus, aucun changement de vitesse (mais l'ancien processeur est vraiment indÃ©sirable).  Nous avons installÃ© une carte mÃ¨re de nouvelle gÃ©nÃ©ration - tout vole simplement sur tous les emplacements.  De plus, la vitesse maximale n'est plus de 400, mais 418 mÃ©gaoctets par seconde, mÃªme dans des crÃ©neaux Â«longsÂ», voire Â«courtsÂ»: <br><br><img src="https://habrastorage.org/webt/kk/ct/yp/kkctypau1u3bn-klc-4bxzrgptk.png"><br><br>  Mais ici - pas de miracles.  Avec le mouvement habituel de la main (dÃ©jÃ  utilisÃ© de nos jours), nous lisons l'espace de configuration et voyons que le paramÃ¨tre Max Payload est dÃ©fini non pas sur 128, mais sur 256 octets. <br><br>  Plus grande taille de paquets - moins de paquets.  Moins de surcharge pour les envoyer - des donnÃ©es plus utiles parviennent Ã  s'exÃ©cuter en mÃªme temps.  C'est vrai. <br><br><h2>  Alors, qui est Ã  blÃ¢mer? </h2><br>  Je ne donnerai pas de rÃ©ponse exacte Ã  la question du titre, en rÃ©fÃ©rence aux documents.  Mais ma pensÃ©e a suivi le chemin suivant: disons que la restriction de flux est dÃ©finie Ã  l'intÃ©rieur du chipset.  Il ne peut pas Ãªtre programmÃ©, il est bien rÃ©glÃ©, mais il l'est.  Par exemple, il est Ã©gal Ã  290 mÃ©gaoctets par seconde pour chaque diff.  un couple.  Plus - il est dÃ©jÃ  coupÃ© quelque part Ã  l'intÃ©rieur du chipset sur ses mÃ©canismes internes.  Par consÃ©quent, dans la fente "longue" (oÃ¹ vous pouvez coller des cartes jusqu'Ã  x4), rien n'est coupÃ© pour notre carte Ã  l'intÃ©rieur du chipset, et nous nous appuyons sur la limite physique du bus x1.  Dans le connecteur Â«courtÂ», nous rencontrons cette limitation. <br><br>  En fait, vÃ©rifier cela n'est pas facile, mais trÃ¨s simple.  Nous restons dans le 013e emplacement non pas AHCI, mais le contrÃ´leur SAS, qui dessert 8 disques Ã  la fois et peut fonctionner en modes PCIe jusqu'Ã  x4.  Nous y connectons 4 disques SSD intelligents.  Nous regardons la vitesse d'enregistrement - autant que l'Ã¢me se rÃ©jouit: <br><br><img src="https://habrastorage.org/webt/zo/hr/tv/zohrtvdgopxxvrgoavusiehb4mq.png"><br><br>  Maintenant, nous ajoutons ces 4 disques qui sont apparus lors des premiers tests.  Les performances du SSD ont diminuÃ© de faÃ§on prÃ©visible: <br><br><img src="https://habrastorage.org/webt/28/wp/hg/28wphgyghw6aaea9y3ddilidzc0.png"><br><br>  Nous calculons la vitesse totale passant par le contrÃ´leur SAS, nous obtenons 1175 mÃ©gaoctets par seconde.  Divisez par 4 (tant de lignes vont Ã  la fente "longue"), nous obtenons ... Roulement de tambour ... 293 mÃ©gaoctets par seconde.  Quelque part, j'ai dÃ©jÃ  vu ce numÃ©ro! <br><br>  Ainsi, dans le cadre de ce projet, il a Ã©tÃ© prouvÃ© que le problÃ¨me ne vient pas de notre programme ou pilote, mais des Ã©tranges limitations du chipset, qui sont probablement "cÃ¢blÃ©es" Ã©troitement.  La mÃ©thodologie de sÃ©lection des cartes mÃ¨res pouvant Ãªtre utilisÃ©es dans le projet a Ã©tÃ© dÃ©veloppÃ©e.  Mais en gÃ©nÃ©ral, nous tirons les conclusions suivantes. <br><br><h2>  Conclusion </h2><br><ul><li>  Souvent dans la vie rÃ©elle, l'Ã©quipement a moins de performances que thÃ©oriquement possible.  Des restrictions peuvent mÃªme Ãªtre imposÃ©es par les pilotes, comme illustrÃ© dans le cas de l'USB.  Parfois, il est possible de rÃ©cupÃ©rer du matÃ©riel qui (ou dont les conducteurs) ne sont pas soumis Ã  de telles restrictions. </li><li>  Les limitations peuvent mÃªme Ãªtre non documentÃ©es, mais clairement exprimÃ©es. </li><li>  Beaucoup d'articles qui disent qu'une paire diffÃ©rentielle de gen PCIe.  1 et gen 2 donne environ 250 et 500 mÃ©gaoctets par seconde, sont erronÃ©s.  Ils copient la mÃªme erreur les uns des autres - un mÃ©gaoctet de donnÃ©es brutes par seconde.  Les frais gÃ©nÃ©raux s'accumulent Ã  plusieurs niveaux de l'interface.  Avec une charge utile maximale de 128 octets, PCIe gen2 obtient environ 400 mÃ©gaoctets par seconde.  Dans les nouvelles gÃ©nÃ©rations PCIe, tout devrait Ãªtre un peu mieux, car l'encodage physique n'est pas 8b / 10b, mais plus Ã©conomique, mais jusqu'Ã  prÃ©sent, aucun contrÃ´leur de disque n'a Ã©tÃ© trouvÃ© sur lequel tester cela en pratique. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414753/">https://habr.com/ru/post/fr414753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414743/index.html">Localisation: Case Slack</a></li>
<li><a href="../fr414745/index.html">#BigGun. Le chronographe "frame" le plus simple sur Arduino (mesure de la vitesse des balles)</a></li>
<li><a href="../fr414747/index.html">CNS, drogue et rock and roll: l'histoire d'un appareil qui nous a fait boire, pas dormir, ni cligner des yeux</a></li>
<li><a href="../fr414749/index.html">Gentleman sysadmin set</a></li>
<li><a href="../fr414751/index.html">Apprivoiser WSUS avec Ansible et plus</a></li>
<li><a href="../fr414755/index.html">Hackathon est la solution au problÃ¨me</a></li>
<li><a href="../fr414757/index.html">Format de prÃ©sentation moderne</a></li>
<li><a href="../fr414759/index.html">Concours Servlet</a></li>
<li><a href="../fr414761/index.html">5 sites d'actualitÃ©s crÃ©atives en anglais</a></li>
<li><a href="../fr414763/index.html">Quatre types d'erreurs de chef de produit qui peuvent (et devraient) Ãªtre Ã©vitÃ©es</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>