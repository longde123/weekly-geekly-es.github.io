<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐸 👩🏼‍💼 🍔 Bus PCIe: les limitations physiques affectent-elles le taux de transfert? 💪🏻 👨🏾‍💼 ♨️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je pars de loin. L'hiver dernier, il m'est arrivé de fabriquer un périphérique USB avec un noyau hébergé dans le FPGA. Bien sûr, je voulais vraiment v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bus PCIe: les limitations physiques affectent-elles le taux de transfert?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414753/">  Je pars de loin.  L'hiver dernier, il m'est arrivé de fabriquer un périphérique USB avec un noyau hébergé dans le FPGA.  Bien sûr, je voulais vraiment vérifier la bande passante réelle de ce bus.  Après tout, dans le contrôleur - il y a trop à faire.  Vous pouvez toujours dire qu'il y a un retard, ou là-bas.  Dans le cas des FPGA, je vois un bloc de données de pompage, alors il m'a dit qu'il y avait des données dedans.  Mais j'ai défini que tout a été traité et je suis prêt à accepter une nouvelle portion (en même temps, il reçoit déjà des données dans le deuxième tampon du même point de terminaison).  Très bien, définissez la préparation dès la toute première mesure et voyez ce qui se passe lorsque l'USB peut «marteler» sans s'arrêter. <br><br><img src="https://habrastorage.org/webt/ab/ft/n3/abftn3olrakrhdj3zztrcksut5k.jpeg"><br><a name="habracut"></a><br>  Mais cela s'avère une chose incroyable.  Si le périphérique USB 2.0 est coincé dans le connecteur «bleu» (qui est USB 3.0), la vitesse est de un.  Si en "noir" - un autre.  Voici mon graphique de la vitesse d'enregistrement USB en fonction de la longueur des données.  USB3 et USB2 sont le type de connecteur; l'appareil est toujours USB 2.0 HS. <br><br><img src="https://habrastorage.org/webt/ea/sg/ja/easgjasaj1jbzovcsgbiymhploa.png"><br><br>  J'ai essayé sur différentes machines.  Le résultat est proche.  Personne ne pouvait m'expliquer ce phénomène.  Plus tard, j'ai trouvé la raison la plus probable.  Et la raison est très simple.  Voici les propriétés du contrôleur USB 2.0: <br><br><img src="https://habrastorage.org/webt/2y/ek/xl/2yekxlpcnthq8p06z8wpxxasjgo.png"><br><br>  Les contrôleurs contrôlant le connecteur «bleu» ne le font pas.  Et la différence n'est que d'environ 20%. <br><br>  Nous en concluons que les limitations de bande passante ne sont pas toujours déterminées par les propriétés physiques du bus.  Parfois, d'autres choses se superposent.  Nous passons avec cette connaissance ces jours-ci. <br><br><h2>  Expérience primaire </h2><br>  Alors.  Tout a commencé assez banal.  Il y avait une vérification d'un programme.  Le processus d'écriture simultanée des données sur plusieurs disques a été vérifié.  Le matériel est simple: il y a une carte mère avec quatre slots PCIe.  Des cartes absolument identiques avec des contrôleurs AHCI sont insérées dans tous les emplacements, chacun prenant en charge exclusivement PCIe x1. <br><br><img src="https://habrastorage.org/webt/4k/il/lz/4killzfbtb9r6evuybrs68e6xl0.jpeg"><br><br>  Chaque carte sert 4 disques. <br>  Et puis l'effet suivant est révélé.  Nous prenons un disque et commençons à y écrire des données.  Nous obtenons une vitesse de 180 à 220 mégaoctets par seconde (ci-après, les mégaoctets sont 1024 * 1024 octets): <br><br><img src="https://habrastorage.org/webt/we/cu/uy/wecuuyqewi743lh6kcxiqgpkk5i.png"><br><br>  Nous prenons le deuxième disque.  La vitesse d'écriture est de 170 à 190 Mo / s: <br><br><img src="https://habrastorage.org/webt/cs/0o/g7/cs0og7k2kztps5h2vgvw7yfsrno.png"><br><br>  Nous écrivons immédiatement aux deux - nous obtenons un ralentissement de la vitesse: <br><br><img src="https://habrastorage.org/webt/xz/at/nk/xzatnk1bt2sog8qsvkjaryf34j0.png"><br><br>  La vitesse totale est d'environ 290 Mo / s.  Mais ce qui est étonnant, c'est que nous avons débogué (donc il s'est avéré) ce programme sur les mêmes disques, mais sur d'autres canaux.  Et tout allait bien là-bas.  Nous transférons rapidement vers ces canaux (ils passeront par une autre carte), nous obtenons un excellent travail: <br><br><img src="https://habrastorage.org/webt/xd/jj/qo/xdjjqomypz-hhmaq6yt73wtoai4.png"><br><br><h2>  Je vais acheter une fente dans un bon quartier </h2><br>  Je dois dire tout de suite que cela ne vaut pas la peine de tout blâmer sur les composants de quelqu'un d'autre.  Tout ici est écrit par nous, à partir du programme lui-même, se terminant par les pilotes.  Ainsi, l'ensemble du chemin de données peut être surveillé.  L'inconnu ne vient que lorsque la demande a été envoyée au matériel. <br><br>  Après l'analyse initiale, il s'est avéré que la vitesse n'est pas limitée dans les «longs» emplacements PCIe et est limitée dans les «courts».  Les longues sont où vous pouvez insérer des cartes x16 (bien que l'une d'entre elles fonctionne en mode non supérieur à x4), et les courtes sont uniquement pour les cartes x1. <br><br><img src="https://habrastorage.org/webt/38/kt/jt/38ktjtqf38knqdotsc3gxacmqos.jpeg"><br><br>  Tout irait bien, mais les contrôleurs des cartes actuelles ne peuvent en principe pas fonctionner dans un mode autre que PCIex1.  Autrement dit, tous les contrôleurs doivent être dans des conditions absolument identiques, quelle que soit la longueur de l'emplacement!  Mais non.  Qui vit dans le "long" - travaille vite, qui dans le "court" - lentement.  Bon.  Et rapide - à quelle vitesse?  Ajoutez un troisième lecteur, écrivez sur les trois. <br><br>  Dans les créneaux "courts", la limite est toujours aux alentours de 290 Mo / s: <br><br><img src="https://habrastorage.org/webt/i-/ti/jr/i-tijrldg-h9izkdypn5iyzir8k.png"><br><br>  Dans le "long" - dans la région de 400 Mo / s: <br><br><img src="https://habrastorage.org/webt/qh/gn/w_/qhgnw_p59bewkzpoj8o0i8jexns.png"><br><br><img src="https://habrastorage.org/webt/oh/yz/gt/ohyzgt_cbix1f8uufh8-s5dnazk.png"><br><br>  J'ai fouillé tout Internet.  Premièrement, après un certain temps, j'ai déjà ri d'articles qui disent que le débit de PCIe gen 1 et gen 2 pour x1 est de 250 et 500 Mo / s.  Ce sont des mégaoctets bruts.  En raison de la surcharge (j'utilise ce mot non russe pour désigner un échange de services qui va dans le même sens que les données principales) pour la génération 2, nous obtenons exactement 400 mégaoctets par seconde de flux utile.  Deuxièmement, je ne pouvais obstinément rien trouver sur le nombre magique 290 (regarder vers l’avenir - je ne l’ai toujours pas trouvé). <br><br>  Super.  Essayer de regarder la topologie de l'inclusion de nos contrôleurs.  Le voici (013-015 - ce sont les suffixes de nom de périphérique par lesquels je les ai comparés afin de les distinguer).  Le vert est rapide, le rouge est lent. <br><br><img src="https://habrastorage.org/webt/ae/xo/3o/aexo3oqtd-c7caogtc-bthelriq.png"><br><br>  Le contrôleur "015" nous ne considérons même pas.  Il vit dans une fente privilégiée conçue pour une carte vidéo.  Mais le 013rd est connecté au même commutateur que le 012nd à partir du 014th.  En quoi est-il différent? <br><br>  Certains articles disent que différentes cartes peuvent différer dans les paramètres de Max Payload.  J'ai étudié l'espace de configuration de toutes les cartes - ce paramètre est pour tout le monde dans la même valeur minimale possible.  De plus, la documentation du chipset de cette carte mère indique qu'il ne peut y avoir d'autre sens. <br><br><img src="https://habrastorage.org/webt/ch/tg/iv/chtgivqtyksowq7blomsrtpmija.png"><br><br>  En général, j'ai fouillé tout dans l'espace de configuration - tout est configuré de manière identique.  Et la vitesse est différente!  Relisez à plusieurs reprises la documentation du chipset - pas de paramètres de bande passante.  Priorités - oui, quelque chose a été écrit à leur sujet, mais les tests sont effectués en l'absence totale de charge sur d'autres canaux!  Autrement dit, ce n'est pas en eux. <br><br>  Au cas où, j'aurais même désactivé le programme d'interruption.  La charge du processeur a augmenté à des niveaux insensés, car maintenant, il lit constamment stupidement le bit de préparation, mais les lectures de vitesse n'ont pas changé.  Il est donc impossible de blâmer ce sous-système pour des problèmes. <br><br><h2>  Et les autres planches? </h2><br>  Nous avons essayé de changer exactement la même carte mère.  Pas de changement.  Ils ont essayé de remplacer le processeur (il y avait des raisons de croire qu'il s'agissait d'un détournement).  De plus, aucun changement de vitesse (mais l'ancien processeur est vraiment indésirable).  Nous avons installé une carte mère de nouvelle génération - tout vole simplement sur tous les emplacements.  De plus, la vitesse maximale n'est plus de 400, mais 418 mégaoctets par seconde, même dans des créneaux «longs», voire «courts»: <br><br><img src="https://habrastorage.org/webt/kk/ct/yp/kkctypau1u3bn-klc-4bxzrgptk.png"><br><br>  Mais ici - pas de miracles.  Avec le mouvement habituel de la main (déjà utilisé de nos jours), nous lisons l'espace de configuration et voyons que le paramètre Max Payload est défini non pas sur 128, mais sur 256 octets. <br><br>  Plus grande taille de paquets - moins de paquets.  Moins de surcharge pour les envoyer - des données plus utiles parviennent à s'exécuter en même temps.  C'est vrai. <br><br><h2>  Alors, qui est à blâmer? </h2><br>  Je ne donnerai pas de réponse exacte à la question du titre, en référence aux documents.  Mais ma pensée a suivi le chemin suivant: disons que la restriction de flux est définie à l'intérieur du chipset.  Il ne peut pas être programmé, il est bien réglé, mais il l'est.  Par exemple, il est égal à 290 mégaoctets par seconde pour chaque diff.  un couple.  Plus - il est déjà coupé quelque part à l'intérieur du chipset sur ses mécanismes internes.  Par conséquent, dans la fente "longue" (où vous pouvez coller des cartes jusqu'à x4), rien n'est coupé pour notre carte à l'intérieur du chipset, et nous nous appuyons sur la limite physique du bus x1.  Dans le connecteur «court», nous rencontrons cette limitation. <br><br>  En fait, vérifier cela n'est pas facile, mais très simple.  Nous restons dans le 013e emplacement non pas AHCI, mais le contrôleur SAS, qui dessert 8 disques à la fois et peut fonctionner en modes PCIe jusqu'à x4.  Nous y connectons 4 disques SSD intelligents.  Nous regardons la vitesse d'enregistrement - autant que l'âme se réjouit: <br><br><img src="https://habrastorage.org/webt/zo/hr/tv/zohrtvdgopxxvrgoavusiehb4mq.png"><br><br>  Maintenant, nous ajoutons ces 4 disques qui sont apparus lors des premiers tests.  Les performances du SSD ont diminué de façon prévisible: <br><br><img src="https://habrastorage.org/webt/28/wp/hg/28wphgyghw6aaea9y3ddilidzc0.png"><br><br>  Nous calculons la vitesse totale passant par le contrôleur SAS, nous obtenons 1175 mégaoctets par seconde.  Divisez par 4 (tant de lignes vont à la fente "longue"), nous obtenons ... Roulement de tambour ... 293 mégaoctets par seconde.  Quelque part, j'ai déjà vu ce numéro! <br><br>  Ainsi, dans le cadre de ce projet, il a été prouvé que le problème ne vient pas de notre programme ou pilote, mais des étranges limitations du chipset, qui sont probablement "câblées" étroitement.  La méthodologie de sélection des cartes mères pouvant être utilisées dans le projet a été développée.  Mais en général, nous tirons les conclusions suivantes. <br><br><h2>  Conclusion </h2><br><ul><li>  Souvent dans la vie réelle, l'équipement a moins de performances que théoriquement possible.  Des restrictions peuvent même être imposées par les pilotes, comme illustré dans le cas de l'USB.  Parfois, il est possible de récupérer du matériel qui (ou dont les conducteurs) ne sont pas soumis à de telles restrictions. </li><li>  Les limitations peuvent même être non documentées, mais clairement exprimées. </li><li>  Beaucoup d'articles qui disent qu'une paire différentielle de gen PCIe.  1 et gen 2 donne environ 250 et 500 mégaoctets par seconde, sont erronés.  Ils copient la même erreur les uns des autres - un mégaoctet de données brutes par seconde.  Les frais généraux s'accumulent à plusieurs niveaux de l'interface.  Avec une charge utile maximale de 128 octets, PCIe gen2 obtient environ 400 mégaoctets par seconde.  Dans les nouvelles générations PCIe, tout devrait être un peu mieux, car l'encodage physique n'est pas 8b / 10b, mais plus économique, mais jusqu'à présent, aucun contrôleur de disque n'a été trouvé sur lequel tester cela en pratique. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414753/">https://habr.com/ru/post/fr414753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414743/index.html">Localisation: Case Slack</a></li>
<li><a href="../fr414745/index.html">#BigGun. Le chronographe "frame" le plus simple sur Arduino (mesure de la vitesse des balles)</a></li>
<li><a href="../fr414747/index.html">CNS, drogue et rock and roll: l'histoire d'un appareil qui nous a fait boire, pas dormir, ni cligner des yeux</a></li>
<li><a href="../fr414749/index.html">Gentleman sysadmin set</a></li>
<li><a href="../fr414751/index.html">Apprivoiser WSUS avec Ansible et plus</a></li>
<li><a href="../fr414755/index.html">Hackathon est la solution au problème</a></li>
<li><a href="../fr414757/index.html">Format de présentation moderne</a></li>
<li><a href="../fr414759/index.html">Concours Servlet</a></li>
<li><a href="../fr414761/index.html">5 sites d'actualités créatives en anglais</a></li>
<li><a href="../fr414763/index.html">Quatre types d'erreurs de chef de produit qui peuvent (et devraient) être évitées</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>