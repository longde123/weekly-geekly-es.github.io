<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§± üöï üë≥üèø SQL zu CSV mit DBMS_SQL üöµüèΩ ‚úäüèΩ üë®‚Äçüë©‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der L√∂sung von Systemintegrationsproblemen ist es h√§ufig erforderlich, eine bestimmte Datenmenge in dem einen oder anderen Format darzustellen. Gl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL zu CSV mit DBMS_SQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448774/">  Bei der L√∂sung von Systemintegrationsproblemen ist es h√§ufig erforderlich, eine bestimmte Datenmenge in dem einen oder anderen Format darzustellen.  Gleichzeitig kann jeder ein Datenkonsument sein, aber die Quelle ist fast immer eine Unternehmensdatenbank.  Beispielsweise kann ein Hersteller vom Lieferanten verlangen, regelm√§√üig √ºber die Bewegung seiner Waren im XLSX- oder XML-Format usw. zu berichten. <br><br>  Es gibt viele Tools zum Konvertieren von Daten in verschiedene Formate, und die M√∂glichkeit ihrer Verwendung h√§ngt vom im Unternehmen verwendeten technologischen Stack und der Softwarearchitektur ab.  Gleichzeitig m√∂chten Sie immer, dass die Kette, die aus verschiedenen Bibliotheken, Frameworks und Systemschichten besteht, die zum Konvertieren der Quelldaten verwendet werden, so kurz wie m√∂glich ist.  Dies w√ºrde den Zeitaufwand f√ºr die Entwicklung der L√∂sung verringern und ihre Produktivit√§t steigern. <br><br>  Wenn wir annehmen, dass die SQL-Abfrage tats√§chlich die Wurzel des Datenauswahlprozesses ist, w√§re im Idealfall die Transformationskette w√ºnschenswert, um dies zu sehen: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup><mo>=</mo><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.035ex" height="2.78ex" viewBox="0 -883.9 6903.8 1197.1" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-66" x="2153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-28" x="2703" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-53" x="3093" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-51" x="3738" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-4C" x="4530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-28" x="5211" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-64" x="5601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-29" x="6124" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-29" x="6514" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>d</mi><mo>‚Ä≤</mo></msup><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d '= f (SQL (d)) </script></p><br>  wo <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.057ex" viewBox="0 -780.1 523.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-64" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> d </script>  - Ausgangsdaten, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.946ex" height="2.66ex" viewBox="0 -832 3421 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-51" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-4C" x="1437" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-28" x="2118" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-64" x="2508" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-29" x="3031" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> SQL (d) </script>  - SQL-Abfrage zum Abrufen von Daten, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.419ex" viewBox="0 -780.1 550.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-66" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> f </script>  - eine Funktion, die die Auswahl in das gew√ºnschte Format konvertiert, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhiTz5UNEBOUFSVidJmOwhRRQ2ZTqQ#MJMAIN-2032" x="741" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>d</mi><mo>‚Ä≤</mo></msup></math></span></span><script type="math/tex" id="MathJax-Element-5"> d '</script>  - Daten im gew√ºnschten Format. <br><br>  F√ºr Oracle PL / SQL gibt es eine Reihe integrierter Pakete und Pakete von Drittanbietern, die diese Funktionalit√§t implementieren.  Dies sind DBMS_XMLGEN, DBMS_XMLQUERY, AS_XLSX, PL / JSON und andere. <br><br>  Als sich jedoch die Frage nach der Konvertierung von Daten in das CSV-Format stellte, gab es aus irgendeinem Grund keine vorgefertigten L√∂sungen.  Ich musste es selbst machen, dann wird gezeigt wie. <a name="habracut"></a><br><br>  Erkl√§rung des Problems <br><br>  Erstellen Sie ein Tool (PL / SQL-Paket), das eine beliebige SELECT-Abfrage als Zeichenfolge oder als Cursor-Variable an der Eingabe empf√§ngt und ein Objekt vom Typ CLOB zur√ºckgibt, das Daten im CSV-Format an der Ausgabe kapselt.  Im Fehlerfall sollte NULL zur√ºckgegeben werden.  Das CSV-Format selbst muss nicht dargestellt werden - dies sind Zeichenfolgen, deren Elemente durch ein Zeichen getrennt sind, meistens ";", aber im allgemeinen Fall kann ein beliebiges Zeichen als Trennzeichen fungieren.  Angenommen, die Zeichen 0x0D + 0x0A werden zum Trennen der Zeichenfolgen verwendet.  Die erste Zeile in der CSV-Datei ist normalerweise die Kopfzeile und definiert die Spaltennamen. <br><br>  Definieren Sie die Paketschnittstelle <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Es gibt zwei √ºberladene Prozeduren. Der Unterschied besteht darin, dass eine von ihnen die Anforderung als Zeichenfolge und die andere als Verkn√ºpfung zum Cursor empf√§ngt.  Der zweite Parameter ist die Ausgabe, dies ist das gew√ºnschte Ergebnis im CLOB-Objekt.  Schlie√ülich ist der dritte Parameter das CSV-Trennzeichen. <br><br>  Bei der Implementierung dieser Prozeduren hilft uns das integrierte DBMS_SQL-Paket, mit dem wir mit dynamischen Cursorn arbeiten k√∂nnen, wenn im Voraus (in der Kompilierungsphase) nicht genau bekannt ist, wie viele Spalten an der Auswahl beteiligt sind. <br><br>  Mit den DBMS_SQL-Funktionen k√∂nnen Sie beliebige Abfragen dynamisch analysieren und ausf√ºhren.  Bei einer Prozedur, die eine Anforderung als Zeichenfolge akzeptiert, geschieht dies folgenderma√üen: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br>  F√ºr eine Prozedur, die eine Cursor-Variable verwendet, ist alles einfacher - ab der 11. Version von Oracle ist die Konvertierung "Cursor-Variable ‚Üí SQL-Cursornummer" verf√ºgbar. <br><br>  Die Funktion DBMS_SQL.TO_CURSOR_NUMBER konvertiert die Variable REFCURSOR (stark oder schwach typisiert) in die SQL-Cursornummer, die dann an DBMS_SQL-Routinen √ºbergeben werden kann.  In diesem Fall muss die Cursor-Variable ge√∂ffnet sein, bevor sie an die Funktion DBMS_SQL.TO_CURSOR_NUMBER √ºbergeben wird. <br><br><pre> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br>  In beiden Versionen des Aufrufs ging es darum, die <i>Nummer des</i> dynamischen Cursors und den zugeh√∂rigen Datensatz zu ermitteln.  Der n√§chste Schritt besteht darin, Informationen √ºber die Spalten dieses Satzes zu erhalten und die Daten selbst zu extrahieren. <br><br>  Mit dem DMBS_SQL-Paket k√∂nnen Sie die Spalten eines dynamischen Cursors beschreiben und Informationen zu jeder Spalte in einem assoziativen Array von Datens√§tzen zur√ºckgeben. <br><br>  Dazu m√ºssen Sie die PL / SQL-Auflistung basierend auf dem Auflistungstyp DBMS_SQL.DESC_TAB deklarieren (oder DESC_TAB2, wenn die Abfrage Spaltennamen zur√ºckgeben kann, die l√§nger als 30 Zeichen sind).  Danach k√∂nnen Sie Erfassungsmethoden verwenden, um die Tabelle zu durchlaufen und Cursorinformationen abzurufen. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br>  Als n√§chstes muss das DBMS_SQL-Paket √ºber den Typ jeder Spalte informiert werden, die mithilfe der dynamischen Abfrage ausgew√§hlt wurde.  Dies erfolgt durch Aufrufen von DEFINE_COLUMN. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br>  Im zweiten Argument DEFINE_COLUMN wird eine Zahl √ºbergeben - die sequentielle Position der Spalte in der Liste.  Das dritte Argument legt den Datentyp der Cursorspalte fest.  Es wird ein Ausdruck des entsprechenden Typs √ºbergeben.  Mit anderen Worten, DBMS_SQL.DEFINE_COLUMN wird keine Zeichenfolge mit einem Typnamen (z. B. "VARCHAR2") √ºbergeben, sondern eine mit dem Typ VARCHAR2 definierte Variable. <br><br>  Wenn Sie im vierten Argument eine Spalte vom Typ Zeichen definieren, m√ºssen Sie die maximale L√§nge der Werte angeben, die in den Cursor geladen werden k√∂nnen. <br><br>  Die vorbereitenden Vorg√§nge sind abgeschlossen. Jetzt k√∂nnen Sie eine Kopfzeile erstellen und mit dem Extrahieren von Daten beginnen. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br>  Daten werden zeilenweise mit DBMS_SQL.FETCH_ROWS und nachfolgenden Aufrufen von DBMS_SQL.COLUMN_VALUE abgerufen, um die Werte der einzelnen Spalten abzurufen. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br>  Dann bleibt nur noch die resultierende CSV zu sammeln <br><br><pre> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br>  Fehler behandeln <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br>  Und schlie√üen Sie den Cursor <br><br><pre> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br>  Paketverwendungsoptionen <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Das ist in der Tat alles, der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quellcode ist beigef√ºgt</a> . <br><br>  Das Buch half bei der Entwicklung <br>  Feuerstein S., angekommen B. - Oracle PL / SQL.  F√ºr Profis. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de448774/">https://habr.com/ru/post/de448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de448762/index.html">Aufstand auf der Picaba. Benutzer gehen massiv zu Reddit</a></li>
<li><a href="../de448764/index.html">Uhren auf ATtiny13</a></li>
<li><a href="../de448766/index.html">Erstellen Sie ein Monorepository mit Lernbereichen f√ºr Herna und Garn</a></li>
<li><a href="../de448768/index.html">Mehrebenen-Lichtsteuerung: Ausfallsicherheit von L√∂sungen und Produkten</a></li>
<li><a href="../de448770/index.html">Aktualisierte Razor-Unterst√ºtzung in Visual Studio Code. Jetzt mit Blazor</a></li>
<li><a href="../de448776/index.html">RxVMS - Eine praktische Architektur f√ºr Flatteranwendungen</a></li>
<li><a href="../de448778/index.html">Einf√ºhrung in das Zeitreise-Debugging f√ºr Visual Studio Enterprise 2019</a></li>
<li><a href="../de448780/index.html">Was gibt Software f√ºr die Rekrutierung in Geld</a></li>
<li><a href="../de448784/index.html">Neue Funktionen f√ºr Erweiterungsautoren in Visual Studio 2019 Version 16.1</a></li>
<li><a href="../de448786/index.html">Python-Test mit Pytest. KAPITEL 3 Pytest-Vorrichtungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>