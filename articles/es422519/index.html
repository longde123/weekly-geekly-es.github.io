<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèæ üö´ üêâ Distribuci√≥n Freebie: Subprocesos sin frenos en Java. Telar del proyecto üß• üöÜ ‚ÅâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øDesea en los hilos de Java que no comen memoria como si no estuvieran en s√≠ mismos y no se ralentizan? Buen cr√©dito, y este problema responde a esta ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distribuci√≥n Freebie: Subprocesos sin frenos en Java. Telar del proyecto</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/422519/"><p>  ¬øDesea en los hilos de Java que no comen memoria como si no estuvieran en s√≠ mismos y no se ralentizan?  Buen cr√©dito, y este problema responde a esta pregunta. </p><br><p>  ¬°Explicamos el trabajo de Project Loom en cajas de pizza!  Vamos! </p><br><p>  Todo esto se elimina y se escribe <b>espec√≠ficamente para Habr</b> . </p><br><br><p><br clear="all"></p><a name="habracut"></a><br><h1 id="pozyvnye">  Se√±ales de llamada </h1><br><p>  ¬øCon qu√© frecuencia ve esta imagen en su servicio web: al principio todo estaba bien, luego vino a usted un mill√≥n de chinos, el servicio hizo un mill√≥n de hilos y se ahog√≥ en el infierno? </p><br><p><img src="https://habrastorage.org/webt/ym/_-/3r/ym_-3rq8a8g56hsmrvjhprnih8y.png"><br><br></p><br><p>  ¬øQuieres una foto tan bonita? </p><br><p><img src="https://habrastorage.org/webt/38/s-/04/38s-04z5nak6trs_p2lei9chjku.png"><br><br></p><br><p>  En otras palabras, ¬øquiere en los hilos de Java que no comen memoria pero no est√°n en s√≠ mismos y no se ralentizan?  Buen cr√©dito, y este problema responde a esta pregunta. </p><br><p>  Estaremos comprometidos, de hecho, <em>desempacando el nuevo marco</em> .  ¬øRecuerdas c√≥mo Wylsacom desempac√≥ iPhones?  Algunos ya no recuerdan a los cr√≠ticos anteriores, pero ¬øpor qu√©?  Debido a que Habr es una fortaleza dominante, y los vidos pagados son, lo siento, los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rayos de la diarrea</a> .  En este post trataremos exclusivamente con el hardcore t√©cnico. </p><br><p>  Primero, dos minutos para los globos oculares, descargo de responsabilidad y otra basura, que hay que decir.  Puedes omitirlo si eres demasiado vago. </p><br><p>  En primer lugar, todo lo que se dice en el video son mis pensamientos personales, y no tienen nada que ver con el empleador o la gloriosa corporaci√≥n Oracle, el gobierno mundial de lagartos y una maldita cosa en un mortero.  Incluso escribo esto a las tres de la ma√±ana para que quede claro que es mi iniciativa personal, mi basura personal.  <em>Todos los partidos son puramente aleatorios.</em> </p><br><p>  Pero hay otro objetivo extra.  Hablamos constantemente de corutinas en Kotlin.  Recientemente hubo entrevistas con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Roma Elizarov</a> , el dios de Corutin, y con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pasha Finkelstein</a> , quien les escribir√° backends.  Pronto habr√° una entrevista con Andrei Breslav, quien es el padre de Kotlin.  Y en todas partes el proyecto Loom se menciona de una forma u otra, porque es un an√°logo de la rutina.  Y si no sabe qu√© es Loom, puede quedarse at√≥nito al leer estas entrevistas.  Hay algunos tipos geniales, discuten cosas geniales.  Y ah√≠ est√°s, y no est√°s con ellos, idiota.  Esto es muy estupido. </p><br><p>  No hagas esto, lee lo que es Loom en este art√≠culo, o mira este video m√°s, explicar√© todo. </p><br><p>  Entonces, ¬øcu√°l es la complicaci√≥n?  Hay un tipo as√≠, Ron Presler. </p><br><br><p><img src="https://habrastorage.org/webt/w-/tq/ut/w-tqutfyx33olnhdavtq_asdv9u.png"><br><br></p><br><p>  El a√±o pasado, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fue a la lista de correo</a> , dijo que los hilos en Java apestan y sugiri√≥ que ejecute el tiempo de ejecuci√≥n y lo arregle.  Y todos se reir√≠an de √©l y le arrojar√≠an piedras, mierda, si no fuera por el hecho de que escribi√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Quasar</a> antes, y esto es realmente genial.  Puedes maldecir en Quasar durante mucho tiempo, pero parece estar all√≠ y funciona, y en el panorama general de todo esto es m√°s probable que sea un logro. </p><br><p>  Hay un mont√≥n de govnokodery que no hacen nada, solo dicen.  Bueno, hazlo bien, soy igual.  O hay personas que parecen ser ingenieros geniales, pero en general en el inconsciente, dicen lo siguiente: "En Java, necesitas mejorar los hilos".  ¬øQu√© mejorar?  ¬øQu√© son los hilos? </p><br><p>  La gente generalmente es demasiado perezosa para pensar. </p><br><p>  Como en una broma: <br>  Petka y Vasily Ivanovich vuelan en un avi√≥n. <br>  Vasily Ivanovich pregunta: - Petka, ¬ødispositivos? <br>  Petka responde: - 200! <br>  Vasily Ivanovich: - ¬øY qu√© hay de 200? <br>  Petka: - ¬øQu√© pasa con los electrodom√©sticos? </p><br><p>  Te contar√© una historia.  Estuve en Ucrania esta primavera, volamos desde Bielorrusia (entiendes por qu√© es imposible directamente desde San Petersburgo).  Y en la aduana nos quedamos sentados unas dos horas, nada menos.  Los funcionarios de aduanas son muy amables, con toda seriedad preguntaron si Java es una tecnolog√≠a obsoleta.  Cerca se sentaron personas que vuelan al mismo konf.  Y soy un tipo de orador, tengo que hacer una pausa, pararme y, como era de esperar, hablar descaradamente de cosas que no uso en absoluto.  Y en el camino habl√≥ sobre la distribuci√≥n JDK llamada Liberica, este es un JDK para Raspberry Pi. </p><br><p>  Y que piensas  Ni siquiera pasan seis meses antes de que la gente golpee mi carrito y diga que, miren, hemos puesto una soluci√≥n en Liber en el producto, y ya tengo un informe sobre esto en la Bielorrusia jfuture.by konf.  Este es el enfoque.  Este no es un p√©simo evangelista, sino un tipo, un ingeniero normal. </p><br><blockquote>  Por cierto, pronto tendremos una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conferencia Joker 2018</a> , que incluir√° tanto a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Andrei Breslav</a> (obviamente hurgando en las rutinas) como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pasha Finkelshtein</a> , y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Josh Long</a> se les puede preguntar sobre el apoyo de Spring para Loom.  Bueno, y un mont√≥n de expertos destacados, ¬°vamos! </blockquote><p>  Y ahora, volviendo a los hilos.  Las personas intentan dibujar un pensamiento a trav√©s de sus dos neuronas que se han degradado, se enroscan en el pu√±o y murmuran: "Los hilos no son as√≠ en Java, los hilos no son as√≠ en Java".  Dispositivos!  Que electrodom√©sticos  Esto es generalmente el infierno. </p><br><p>  Y aqu√≠ viene Presler, un tipo normal, no degradado, y al principio hace una descripci√≥n sensata.  Un a√±o despu√©s, aserrando una demo de trabajo.  Dije todo esto para que comprenda que una descripci√≥n normal de los problemas, la documentaci√≥n normal es un hero√≠smo de un tipo especial.  Y la demostraci√≥n es generalmente espacio.  Esta es la primera persona que realmente ha hecho algo en esta direcci√≥n.  El m√°s lo necesita. </p><br><p>  Junto con la demostraci√≥n, Presler habl√≥ en la conferencia y lanz√≥ este video: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J31o0ZMQEnI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  De hecho, todo este art√≠culo es una revisi√≥n de lo que se dijo all√≠.  No pretendo en absoluto la singularidad de este material, todo lo que est√° en este art√≠culo fue inventado por Ron. </p><br><p>  La discusi√≥n trata sobre tres temas dolorosos: </p><br><ul><li>  Continuaciones </li><li>  Fibras </li><li>  La cola llama </li></ul><br><p>  Probablemente, estaba tan asqueado al aserrar a Quasar y pelear con sus fallas que no hay fuerza: debes empujarlo al tiempo de ejecuci√≥n. </p><br><p>  Fue hace un a√±o, y desde entonces han estado aserrando un prototipo.  Algunos ya han perdido la esperanza de que alg√∫n d√≠a veremos una demostraci√≥n, pero hace un mes la dieron a luz y mostraron lo que se ve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este tweet</a> . </p><br><br><p><img src="https://habrastorage.org/webt/ck/hp/mc/ckhpmcchdv2k6_4vfbw733evg6c.png"><br><br></p><br><p>  Los tres temas dolorosos en esta demostraci√≥n est√°n directamente en el c√≥digo, o al menos moralmente presentes.  Bueno, s√≠, todav√≠a no han dominado las llamadas de cola, pero quieren hacerlo. </p><br><h1 id="problematika">  Problema </h1><br><p>  Los usuarios descontentos, los desarrolladores de aplicaciones, cuando hacen una API, se ven obligados a elegir entre dos sillas.  Los picos est√°n integrados en una silla, las flores crecen en la otra.  Y ni uno ni el otro nos conviene. </p><br><br><p><img src="https://habrastorage.org/webt/tn/nx/k-/tnnxk-iwzuj7sybfwllour9qozq.png"><br><br></p><br><p>  Por ejemplo, si escribe un servicio que funciona sincr√≥nicamente, funciona muy bien con c√≥digo heredado, es f√°cil de depurar y monitorear el rendimiento.  Surgir√°n problemas con el ancho de banda y la escalabilidad.  Solo porque la cantidad de subprocesos que ahora puede ejecutar en una pieza simple de hardware, en hardware b√°sico, bueno, digamos, dos mil.  Esto es mucho menor que la cantidad de conexiones que podr√≠an abrirse a este servidor.  Lo que desde el punto de vista del netcode puede ser casi interminable. </p><br><p>  (Bueno, s√≠, tiene algo que ver con el hecho de que los sockets en Java est√°n organizados de forma tonta, pero este es un tema para otra conversaci√≥n) </p><br><p>  Imagina que est√°s escribiendo alg√∫n tipo de MMO. </p><br><br><p><img src="https://habrastorage.org/webt/ye/mg/pm/yemgpm6on0pidozkhmco3epwapa.png"><br><br></p><br><p>  Por ejemplo, durante la Guerra del Norte en EVE Online, dos mil cuatrocientos pilotos se reunieron en un punto en el espacio, cada uno de ellos, condicionalmente, si estuviera escrito en Java, no ser√≠a un hilo, sino varios.  Y el piloto, por supuesto, es una l√≥gica empresarial compleja, y no la emisi√≥n de ning√∫n HTML que pueda descartarse a mano en una lupa. </p><br><p>  El tiempo de respuesta en esa batalla fue tan largo que el jugador tuvo que esperar unos minutos para esperar el tiro.  Hasta donde s√©, el PCCh espec√≠ficamente para esa batalla arroj√≥ los enormes recursos de hardware de su cl√∫ster. </p><br><p>  Aunque, probablemente estoy citando a EVE como un ejemplo en vano, porque, por lo que entiendo, todo est√° escrito en Python, y en Python con subprocesos m√∫ltiples es a√∫n peor que el nuestro, y podemos considerar una pobre competencia de caracter√≠sticas del lenguaje.  Pero entonces el ejemplo es claro y con im√°genes. </p><br><p>  Si est√° interesado en el tema de la OMI en general y en la historia de la "Guerra del Norte" en particular, recientemente apareci√≥ un video muy bueno sobre este tema en el canal Bulzhat (lo que sea que ese nombre signifique), mire desde mi marca de tiempo. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AkAtiTNvjz8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Volvemos al tema. </p><br><p>  Por otro lado, puede usar alg√∫n tipo de marco asincr√≥nico.  Es escalable  Pero inmediatamente caeremos en una depuraci√≥n muy dif√≠cil, un perfil complicado del rendimiento, no podremos integrarlo a la perfecci√≥n con el legado, tendr√° que reescribir muchas cosas, envolverlas en envoltorios abominables y, en general, sentir que fuimos violados.  Varias veces seguidas.  Durante d√≠as, de hecho, todo el tiempo que escribamos esto, tendr√° que sentirse as√≠. </p><br><p>  Le pregunt√© al experto, el famoso acad√©mico Escobar, qu√© piensa sobre esto: </p><br><br><p><img width="300" src="https://habrastorage.org/webt/7g/hf/mg/7ghfmg3x8aqhdl0jcyrbpairqsc.png"><br><br></p><br><p>  Que hacer  Los llamados faybers corren al rescate. </p><br><p>  En el caso general, las fibras son hilos tan livianos que tambi√©n hurgan en el espacio de direcciones (porque los milagros no suceden).  Pero a diferencia de los hilos comunes, no utilizan la multitarea preventiva, sino la multitarea cooperativa.  Leer m√°s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Wikipedia</a> . </p><br><p>  Fiber puede darse cuenta de las ventajas de la programaci√≥n s√≠ncrona y as√≠ncrona.  Como resultado, la utilizaci√≥n de hierro aumenta y utilizamos menos servidores en el cl√∫ster para la misma tarea.  Bueno, en nuestro bolsillo por esto obtenemos lavanda.  Babos  Lave  Dinero  Bueno, entiendes el punto.  Para el servidor guardado. </p><br><h1 id="na-raspute">  En la encrucijada </h1><br><p>  Lo primero que quiero discutir.  La gente no entiende la diferencia entre las continuaciones y la fibra. <br>  ¬°Ahora habr√° una iluminaci√≥n de culto! </p><br><p>  Anunciaremos el hecho: Continuaci√≥n y Fibra son dos cosas diferentes. </p><br><h1 id="continuations">  Continuaciones </h1><br><p>  Las fibras se construyen sobre una mec√°nica llamada Continuaciones. </p><br><p>  Las continuaciones (m√°s precisamente, continuaciones delimitadas) es un tipo de c√°lculo, ejecuci√≥n, una parte de un programa que puede quedarse dormido, luego despertarse y continuar la ejecuci√≥n desde el lugar donde se qued√≥ dormido.  A veces incluso se puede clonar o serializar, incluso mientras est√° durmiendo. </p><br><p>  Usar√© la palabra "continuaci√≥n", y no "continuaci√≥n" (como est√° escrito en Wikipedia), porque todos nos comunicamos en <em>ingl√©s</em> .  Usando la terminolog√≠a rusa normal, uno puede llegar f√°cilmente a una situaci√≥n en la que la diferencia entre el t√©rmino ruso e ingl√©s se vuelve demasiado grande y nadie m√°s entiende el significado de lo que se dijo. </p><br><p>  A veces tambi√©n usar√© la palabra ‚Äúdesplazar‚Äù en lugar de la versi√≥n en ingl√©s de ‚Äúceder‚Äù.  Solo la palabra "ceder": es algo realmente desagradable.  Por lo tanto, habr√° "desplazamiento". </p><br><p>  Entonces aqu√≠.  Es muy importante que no haya competencia dentro del continuo.  Es en s√≠ mismo la primitiva m√≠nima de este proceso. </p><br><p> Puede pensar en la continuaci√≥n como un <code>Runnable</code> , dentro del cual puede llamar al m√©todo <code>pause()</code> .  Est√° dentro y directamente, porque nuestra multitarea es cooperativa.  Y luego puede ejecutarlo nuevamente, y en lugar de volver a calcular todo, continuar√° desde donde lo dej√≥.  Ese tipo de magia.  Volveremos a la magia. </p><br><p>  D√≥nde obtener una demostraci√≥n con continuaciones de trabajo: discutiremos al final.  Ahora hablemos de lo que hay all√≠. </p><br><p>  La clase de continuaci√≥n en s√≠ se encuentra en java.base, todos los enlaces estar√°n en la descripci√≥n.  ( <code>src/java.base/share/classes/java/lang/Continuation.java</code> ).  Pero esta clase es muy grande, voluminosa, por lo que tiene sentido mirar solo alg√∫n tipo de compresi√≥n. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Continuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope, Runnable body)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContinuationScope scope)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPinned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reason reason)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Pinned: "</span></span> + reason); } }</code> </pre> <br><p>  Tenga en cuenta que, de hecho, este archivo cambia constantemente.  Por ejemplo, a partir del d√≠a anterior, la continuaci√≥n no implement√≥ la interfaz <code>Runnable</code> .  Trata esto como una especie de bosquejo. </p><br><p>  Echa un vistazo al constructor.  <code>body</code> (este es el c√≥digo que est√° intentando ejecutar y el <code>scope</code> ) es un tipo de skop que le permite anidar continuaciones en continuaciones. </p><br><p>  En consecuencia, puede preprogramar este c√≥digo hasta el final con el m√©todo de <code>run</code> , o suplantarlo con una matriz espec√≠fica utilizando el m√©todo de <code>yield</code> (la matriz se necesita aqu√≠ para algo como reenviar acciones a controladores anidados, pero no nos importan los usuarios).  Puede preguntar utilizando el m√©todo <code>isDone</code> si todo se completa hasta el final. </p><br><p>  Y por razones dictadas √∫nicamente por las necesidades de la implementaci√≥n actual (pero muy probablemente, tambi√©n se incluir√° en el lanzamiento), no siempre es posible obtener <code>yield</code> .  Por ejemplo, si dentro de la continuaci√≥n tuvimos una transici√≥n al c√≥digo nativo y apareci√≥ un marco nativo en la pila, entonces es imposible quedarse atascado.  Esto tambi√©n suceder√° si intenta exprimirse mientras se toma un monitor nativo, como un m√©todo sincronizado, dentro del cuerpo del continuo.  Por defecto, cuando intentas fingir esto, se produce una excepci√≥n ... pero las fibras construidas sobre las continuaciones sobrecargan este m√©todo y hacen otra cosa.  Esto ser√° un poco m√°s tarde. </p><br><p>  Puede usar esto aproximadamente de la siguiente manera: </p><br><pre> <code class="java hljs">Continuation cont = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation(SCOPE, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>); Continuation.yield(SCOPE); System.out.println(<span class="hljs-string"><span class="hljs-string">"after"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cont.isDone()) { cont.run(); }</code> </pre> <br><p>  Este es un ejemplo de la presentaci√≥n de Presler.  Nuevamente, este no es un c√≥digo "trivial", es alg√∫n tipo de bosquejo. </p><br><p>  Este es un bosquejo de lo que estamos haciendo continuaci√≥n, en el medio de esta continuaci√≥n estamos desplazados y luego, en un ciclo interminable, preguntamos si la continuaci√≥n funcion√≥ hasta el final y si deber√≠a continuarse. </p><br><p>  Pero, en general, no se pretende que los programadores de aplicaciones comunes se relacionen con esta API.  Est√° destinado a los creadores de marcos de sistemas.  Los marcos formadores de sistemas como Spring Framework adoptar√°n de inmediato esta caracter√≠stica tan pronto como salga.  Ya veras.  Considera esto como una predicci√≥n.  Una predicci√≥n tan ligera, porque todo es bastante obvio aqu√≠.  Todos los datos para la predicci√≥n son.  Esta caracter√≠stica es demasiado importante para no adaptarse.  Por lo tanto, no hay necesidad de preocuparse de antemano de que alguien lo torturar√° con la codificaci√≥n de esta forma.  Bueno, si eres un desarrollador de Spring, entonces sab√≠as lo que estabas haciendo. </p><br><p>  Y ahora, adem√°s de las continuaciones, se construyen fibras. </p><br><h1 id="fibers">  Fibras </h1><br><p>  Entonces, lo que en nuestro caso significa fibra. <br><br>  Este es un tipo de abstracci√≥n, que es: </p><br><ul><li>  Subprocesos ligeros procesados ‚Äã‚Äãen la propia JVM y no en el sistema operativo; </li><li>  Con gastos generales extremadamente bajos para crear, mantener la vida, cambiar tareas; </li><li>  Que se puede ejecutar millones de veces. </li></ul><br><p>  Muchas tecnolog√≠as est√°n tratando de fabricar fibra de una forma u otra.  Por ejemplo, en Kotlin hay corutinas implementadas en la generaci√≥n de bytecode muy inteligente.  <em>MUY INTELIGENTE</em>  Pero el tiempo de ejecuci√≥n es un mejor lugar para implementar tales cosas. </p><br><p>  Como m√≠nimo, la JVM ya sabe c√≥mo manejar bien los subprocesos, y todo lo que necesitamos hacer es optimizar el proceso de codificaci√≥n para subprocesos m√∫ltiples.  Puede usar API asincr√≥nicas, pero esto dif√≠cilmente se puede llamar "simplificaci√≥n": incluso usar cosas como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Reactor</a> , Spring Project Reactor, que permiten escribir c√≥digo aparentemente lineal, no ayudar√° mucho si necesita depurar problemas complejos. </p><br><p>  Entonces fibra. </p><br><p>  La fibra consta de dos componentes.  Esto es: </p><br><ul><li>  Continuaci√≥n </li><li>  Programador </li></ul><br><p>  Eso es: </p><br><ul><li>  Continuaci√≥n </li><li>  Planificador </li></ul><br><br><p><img src="https://habrastorage.org/webt/ga/wc/yk/gawcykupqgqwqjwfxcpccyltenu.jpeg"><br><br></p><br><p>  Puedes decidir qui√©n es el planificador aqu√≠.  Creo que el planificador aqu√≠ es Jay. </p><br><ul><li>  Fiber envuelve el c√≥digo que desea ejecutar en una continuaci√≥n </li><li>  El programador los lanza en un grupo de hilos portadores </li></ul><br><p>  <em>Los llamar√© hilos de soporte.</em> </p><br><br><br><p><img src="https://habrastorage.org/webt/j4/hc/gw/j4hcgwglzzsi6qe-cxczwcewohy.jpeg"><br><br></p><br><p>  El prototipo actual usa <code>java.util.concurrent.Executor</code> , y el programador <code>ForkJoinPool</code> .  Lo tenemos todo  En el futuro, algo m√°s inteligente puede aparecer all√≠, pero por ahora, as√≠. </p><br><p>  ¬øC√≥mo se comporta la continuaci√≥n? </p><br><ul><li>  Se desplaza (rendimiento) cuando se produce un bloqueo (por ejemplo, en IO); </li><li>  Contin√∫a cuando est√° listo para continuar (por ejemplo, la operaci√≥n de E / S se ha completado y puede continuar). </li></ul><br><p>  Estado actual de las obras: </p><br><ul><li>  El foco principal en filosof√≠a, conceptos; </li><li>  La API no est√° arreglada, es "para mostrar".  Este es un prototipo de investigaci√≥n; </li><li>  Hay un prototipo de trabajo codificado listo para usar de la clase <code>java.lang.Fiber</code> . </li></ul><br><p>  Ser√° discutido </p><br><p>  Lo que ya se ha aserrado en la fibra: </p><br><ul><li>  Ejecuta un inicio de tarea; </li><li>  Estacionamiento de veh√≠culos sin estacionamiento en un transportista; </li><li>  A la espera de la finalizaci√≥n de la fibra. </li></ul><br><h1 id="principialnaya-shema">  Diagrama de circuito </h1><br><pre> <code class="java hljs">mount(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { cont.run(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> () { unmount(); }</code> </pre> <br><ul><li>  Podemos montar una fibra en un portador de hilo; </li><li>  Luego ejecuta la continuaci√≥n; </li><li>  Y espere hasta que ella sea desplazada o honestamente se detenga; </li><li>  Al final, siempre dejamos el hilo. </li></ul><br><p>  Este pseudoc√≥digo se ejecutar√° en el <code>ForkJoinPool</code> o en alg√∫n otro (que eventualmente estar√° en la versi√≥n final). </p><br><h1 id="ispolzovanie-v-realnosti">  Uso en la realidad </h1><br><pre> <code class="java hljs">Fiber f = Fiber.execute( () -&gt; { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Morning!"</span></span>); readLock.lock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Afternoon"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { readLock.unlock(); } System.out.println(<span class="hljs-string"><span class="hljs-string">"Good Night"</span></span>); });</code> </pre> <br><p>  Mira, estamos creando una fibra en la que: </p><br><ul><li>  bienvenidos a todos; </li><li>  estamos bloqueando el loke reentrante; </li><li>  a su regreso, felicidades por su almuerzo; </li><li>  finalmente suelte la cerradura; </li><li>  y decir adios. </li></ul><br><p>  Todo es muy sencillo. </p><br><p>  No causamos hacinamiento directamente.  Project Loom mismo sabe que cuando se <code>readLock.lock();</code>  √©l deber√≠a intervenir e impl√≠citamente hacer represi√≥n.  El usuario no ve esto, pero sucede all√≠. </p><br><h1 id="steki-povsyudu-steki">  ¬°Pilas, pilas por todas partes! </h1><br><p>  Vamos a demostrar lo que est√° sucediendo usando la pila de pizza como ejemplo. </p><br><p>  Al principio, el subproceso de la portadora est√° en estado de espera y no sucede nada. </p><br><p><img src="https://habrastorage.org/webt/8y/gw/mr/8ygwmr7dc_owazfdj-wa4trrs4g.png"><br><br></p><br><p>  Arriba de la pila en la parte superior, recordar. </p><br><p>  Luego se program√≥ la ejecuci√≥n de la fibra y la tarea de fibra comenz√≥ a ejecutarse. </p><br><p><img src="https://habrastorage.org/webt/pd/ya/mn/pdyamn0chhcnelgtphtxeg6eniq.png"><br><br></p><br><p>  Dentro de s√≠ mismo, obviamente lanza una continuaci√≥n, en la que el c√≥digo real ya est√° ubicado. </p><br><p><img src="https://habrastorage.org/webt/33/nw/fb/33nwfb3dz0klj1oiog21iegsbuy.png"><br><br></p><br><p>  Desde el punto de vista del usuario, todav√≠a no hemos lanzado nada aqu√≠. </p><br><p>  Ese es solo el primer fotograma del c√≥digo de usuario que apareci√≥ en la pila, y est√° marcado en p√∫rpura. </p><br><p>  Adem√°s, el c√≥digo se ejecuta, se ejecuta, en alg√∫n momento la tarea est√° tratando de capturar el bloqueo y bloquearlo, lo que conduce a un desplazamiento autom√°tico. </p><br><p><img src="https://habrastorage.org/webt/vv/lk/ah/vvlkahftvyuefpupb4fyidb5gdq.png"><br><br></p><br><p>  Todo lo que est√° en la pila de continuaci√≥n se almacena en un cierto lugar m√°gico.  Y desaparece </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  Como puede ver, la secuencia vuelve a la fibra, a las instrucciones que siguen a <code>Continuation.run</code> .  Y este es el final del c√≥digo de fibra. </p><br><p>  La tarea de fibra finaliza, el soporte de medios est√° esperando un nuevo trabajo. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  La fibra est√° estacionada, en alg√∫n lugar se encuentra, el continuo est√° completamente desplazado. </p><br><p>  Tarde o temprano, llega el momento en que el propietario de la cerradura la libera. <br>  Esto lleva al hecho de que la fibra, que estaba esperando el desbloqueo, est√° desempacada.  La tarea de esta fibra comienza de nuevo. </p><br><ul><li>  Reentrantlock.unlock </li><li>  Locksupport.unpark </li><li>  Fiber.unpark </li><li>  ForkJoinPool.execute </li></ul><br><p>  Y r√°pidamente volvemos a la pila, que era recientemente. </p><br><p><img src="https://habrastorage.org/webt/hz/oq/6n/hzoq6nmzmezadhp8-ntn6_qerxk.png"><br><br></p><br><p>  Adem√°s, el hilo portador puede ser completamente diferente.  ¬°Y eso tiene sentido! </p><br><p>  Ejecute la continuaci√≥n nuevamente. </p><br><p><img src="https://habrastorage.org/webt/ll/c-/mx/llc-mxgfttlpleiqtprwm6igcju.png"><br><br></p><br><p>  ¬°Y aqu√≠ viene la MAGIA!  La pila se restaura y la ejecuci√≥n contin√∫a con las instrucciones despu√©s de <code>Continuation.yield</code> . </p><br><p><img src="https://habrastorage.org/webt/la/4t/pp/la4tppjy2spiy4_auvwdikgm8nu.png"><br><br></p><br><p>  Salimos del bloqueo reci√©n estacionado y comenzamos a ejecutar todo el c√≥digo restante en la continuaci√≥n: </p><br><p><img src="https://habrastorage.org/webt/yt/ce/ht/ytcehtff1fomwn5cehnzkegzpts.png"><br><br></p><br><p>  La tarea del usuario finaliza y el control vuelve a la tarea de fibra inmediatamente despu√©s de la instrucci√≥n de continuaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/sz/m8/cc/szm8ccxgwntcgjzwqcl_gcernqg.png"><br><br></p><br><p>  Al mismo tiempo, finaliza la ejecuci√≥n de la fibra, y nuevamente nos encontramos en modo de espera. </p><br><p><img src="https://habrastorage.org/webt/l4/nt/k9/l4ntk9qfl8dpcamol4ufahy8sa0.png"><br><br></p><br><p>  El pr√≥ximo lanzamiento de la fibra nuevamente inicia todo el ciclo de renacimientos descrito anteriormente. </p><br><p><img src="https://habrastorage.org/webt/c7/z9/wm/c7z9wmktfbsithnlvyuea4mtqki.jpeg"><br><br></p><br><h1 id="zhivye-primery">  Ejemplos en vivo </h1><br><p>  ¬øY qui√©n dijo que todo esto funciona?  ¬øSe trata de un par de microbenchmarks escritos durante la noche? </p><br><p>  Como ejemplo de la operaci√≥n de los petardos, los Oraklovites escribieron un peque√±o servidor web y lo alimentaron con solicitudes para que se ahogara.  Luego se transfirieron a fibra.  El servidor dej√≥ de atragantarse, y de esto concluimos que las fibras funcionan. </p><br><p>  No tengo el c√≥digo exacto para este servidor, pero si esta publicaci√≥n recibe suficientes me gusta y comentarios, intentar√© escribir un ejemplo yo mismo y crear gr√°ficos reales. </p><br><h1 id="problemy">  Los problemas </h1><br><p>  ¬øHay alg√∫n problema aqu√≠?  Si por supuesto!  Toda la historia con faybers es una historia sobre problemas continuos y compensaciones. </p><br><h2 id="filosofskie-problemy">  Problemas filos√≥ficos </h2><br><ul><li>  ¬øNecesitamos reinventar hilos? </li><li>  ¬øDeber√≠a <em>todo el</em> c√≥digo existente funcionar correctamente dentro de la fibra? </li></ul><br><p>  El prototipo actual funciona con limitaciones.  Lo que puede salir al mercado, aunque no quisiera.  A√∫n as√≠, OpenJDK es una cosa que respeta la compatibilidad infinita. </p><br><p>  ¬øCu√°les son las limitaciones t√©cnicas?  Las limitaciones m√°s obvias son 2 piezas. </p><br><h2 id="problema-raz--nelzya-vytesnit-nativnye-freymy">  El problema es una vez: no puede suplantar marcos nativos </h2><br><pre> <code class="java hljs">PrivilegedAction&lt;Void&gt; pa = () -&gt; { readLock.lock(); <span class="hljs-comment"><span class="hljs-comment">// may park/yield try { // } finally { readLock.unlock(); } return null; } AccessController.doPrivileged(pa); //native method</span></span></code> </pre> <br><p>  Aqu√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">doPrivileged</a> llama al m√©todo nativo. </p><br><p>  Llama a <code>doPrivileged</code> , salta de la VM, aparece un marco nativo en su pila, despu√©s de lo cual intenta estacionar en la <code>readLock.lock()</code> .  Y en ese momento, el hilo portador se manchar√° hasta que se desbloquee.  Es decir, el hilo desaparece.  En este caso, los hilos portadores pueden terminar y, en general, esto rompe toda la idea de la fibra. </p><br><p>  La forma de resolver esto ya se conoce, y hay discusiones en curso sobre esto. </p><br><h2 id="problema-dva---synchronized-bloki">  Problema dos: bloques sincronizados </h2><br><p>  Esto es basura mucho m√°s seria </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park object.wait(); //may park }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//may park socket.getInputStream().read(); //may park }</span></span></code> </pre> <br><p>  En caso de captura de monitor en la fibra, los hilos portadores tambi√©n patean. </p><br><p>  Est√° claro que en un c√≥digo completamente nuevo puede cambiar los monitores a bloqueos directos, en lugar de esperar + notificar que puede usar objetos de condici√≥n, pero ¬øqu√© hacer con el legado?  Esto es un problema </p><br><h1 id="thread-api-threadcurrentthread-thread-locals">  Hilo API?  Thread.currentThread ()?  Hilo locales? </h1><br><p>  En el prototipo actual, <code>Thread</code> and <code>Fiber</code> han creado una superclase com√∫n llamada <code>Strand</code> . </p><br><p>  Esto le permite transferir la API de la manera m√°s m√≠nima. <br>  Qu√© hacer a continuaci√≥n, como siempre en este proyecto, es una pregunta. </p><br><p>  ¬øQu√© est√° sucediendo con Thread API ahora? </p><br><ul><li>  El primer uso de <code>Thread.currentThread()</code> en una fibra crea una especie de hilo de sombra, Shadow Thread; </li><li>  desde el punto de vista del sistema, este es un hilo "in√©dito" y no contiene metainformaci√≥n de VM; </li><li>  ST intenta emular todo lo que puede; </li><li>  pero tienes que entender que la antigua API tiene mucha basura; </li><li>  m√°s espec√≠ficamente, Shadow Thread implementa la API Thread para todo, excepto <code>stop</code> , <code>suspend</code> , <code>resume</code> y manejar excepciones no detectadas. </li></ul><br><p>  ¬øQu√© hacer con los hilos locales? </p><br><ul><li>  ahora los locales de subprocesos simplemente se convierten en locales de fibra; </li><li>  Hay muchos problemas con esto, todo esto se est√° discutiendo; </li><li>  se discute especialmente un conjunto de usos; </li><li>  Los hilos se han usado hist√≥ricamente de manera correcta e incorrecta (los que usan incorrectamente todav√≠a esperan algo, y no pueden decepcionarlos por completo); </li><li>  en general, esto crea una amplia gama de aplicaciones: <br><ul><li>  Alto nivel: cach√© de conexiones o contrase√±as en el contenedor; </li><li>  Bajo nivel: procesador en bibliotecas del sistema. </li></ul></li></ul><br><h1 id="skolko-vse-eto-zhret">  ¬øCu√°nto come todo? </h1><br><p><img src="https://habrastorage.org/webt/pl/7-/pi/pl7-pidz-d2o3l98qx2srbmezxi.png"><br><br></p><br><p>  Hilo: </p><br><ul><li>  Pila: 1 MB y 16 KB en estructuras de datos del n√∫cleo; </li><li>  Por instancia de subproceso: 2300 bytes, incluida la metainformaci√≥n de VM. </li></ul><br><p>  Fibra: </p><br><ul><li>  Pila de continuaci√≥n: de cientos de bytes a kilobytes; </li><li>  Por instancia de fibra: 200-240 bytes. </li></ul><br><p>  ¬°La diferencia es enorme! <br>  Y eso es exactamente lo que permite que millones de personas se enciendan. </p><br><h1 id="chto-mozhet-parkovatsya">  ¬øQu√© puede aparcar? </h1><br><p>  Est√° claro que lo m√°s m√°gico es el estacionamiento autom√°tico cuando ocurren algunos eventos.  ¬øQu√© se admite actualmente? </p><br><ul><li>  Thread.sleep, √∫nete; </li><li>  java.util.concurrent y LockSupport.lock; </li><li>  IO: red en sockets (lectura, escritura, conexi√≥n, aceptaci√≥n), archivos, tuber√≠as; </li><li>  Todo esto est√° inacabado, pero la luz en el t√∫nel es visible. </li></ul><br><h1 id="kommunikaciya-mezhdu-fayberami">  Comunicaci√≥n entre fibra </h1><br><p>  Otra pregunta que todos hacen es: c√≥mo intercambiar informaci√≥n de manera competitiva entre las fibras. </p><br><ul><li>  El prototipo actual inicia tareas en <code>Runnable</code> , se puede convertir a <code>CompletableFuture</code> , si por alguna raz√≥n lo necesita; </li><li>  java.util.concurrent "simplemente funciona".  Puedes buscar todo de forma est√°ndar; </li><li>  puede haber nuevas API para subprocesos m√∫ltiples, pero esto no es exacto; </li><li>  un mont√≥n de peque√±as preguntas como "¬ødeber√≠an las fibras devolver valores?";  todo se discute, no est√°n en el prototipo. </li></ul><br><h1 id="kak-realizovany-kontinuacii-v-prototipe">  ¬øC√≥mo se implementan las continuaciones en el prototipo? </h1><br><p>  Los requisitos obvios se imponen en la continuaci√≥n: debe usar la menor cantidad de RAM posible y debe cambiar entre ellos lo m√°s r√°pido posible.  De lo contrario, no funcionar√° mantenerlos en millones.  La tarea principal aqu√≠ es de alguna manera no hacer una copia completa de la pila para cada parque de estacionamiento.  ¬°Y hay tal esquema!  Tratemos de explicar esto en las fotos. </p><br><p>  La mejor manera ser√≠a, por supuesto, simplemente poner todas las pilas en una cadera de Java y usarlas directamente.  Pero no est√° claro c√≥mo codificar ahora, por lo que el prototipo usa la copia.  Pero copiando con un peque√±o pero importante truco. </p><br><p>  Tenemos dos sillas ... quiero decir, dos pilas.  Dos matrices de Java en la cadera.  Uno es una matriz de objetos, donde almacenaremos referencias a objetos.  El segundo es primitivo (por ejemplo, √≠ntimo), que se encargar√° de todo lo dem√°s. </p><br><p><img src="https://habrastorage.org/webt/33/tf/cj/33tfcj897awloqfisxfwwl-4ypy.png"><br><br></p><br><p>  Ahora estamos en un estado donde la continuaci√≥n est√° por realizarse por primera vez. </p><br><p>  <code>run</code> llama a un m√©todo interno llamado <code>enter</code> : </p><br><p><img src="https://habrastorage.org/webt/j6/d5/ki/j6d5kioz8ygupanxditl3iaslbi.png"><br><br></p><br><p>  Y luego se ejecuta el c√≥digo de usuario, hasta el primer desplazamiento. </p><br><p><img src="https://habrastorage.org/webt/ab/on/6c/abon6cdsoepe-ts69pkmm9sk35i.png"><br><br></p><br><p>  En este punto, se realiza una llamada de VM, que se <code>freeze</code> .  En este prototipo, esto se hace directamente f√≠sicamente, usando una copia. </p><br><p><img src="https://habrastorage.org/webt/iu/or/jv/iuorjvmb6xrjnycvx3nxbdcqxxc.png"><br><br></p><br><p>  Comenzamos el proceso de copiar secuencialmente fotogramas de la pila nativa a java hip. </p><br><p><img src="https://habrastorage.org/webt/ln/nu/sm/lnnusmrix2hsqpwxmzkeemd_or0.png"><br><br></p><br><p>  Es necesario verificar si los monitores se mantienen all√≠ o si se usa el c√≥digo nativo, o algo m√°s que realmente no nos permitir√° seguir trabajando. </p><br><p><img src="https://habrastorage.org/webt/vl/5c/k0/vl5ck0i3jtouapded9snnl9brvy.png"><br><br></p><br><p>  Y si todo est√° bien, copiamos primero en una matriz primitiva: </p><br><p><img src="https://habrastorage.org/webt/ka/z_/gl/kaz_glkmthfyd1x8rzdprn3v8ym.png"><br><br></p><br><p>  Luego aislamos las referencias a los objetos y los guardamos en la matriz de objetos: </p><br><p><img src="https://habrastorage.org/webt/xc/2q/nb/xc2qnbafy_2eybwzif-3s3vmaym.png"><br><br></p><br><p>  En realidad, ¬°dos t√©s para todos los que leen a este lugar! </p><br><p>  Adem√°s, continuamos este procedimiento para todos los dem√°s elementos de la pila nativa. </p><br><p><img src="https://habrastorage.org/webt/6e/sp/-0/6esp-07i4dyasxj5esb9qu6fh5i.png"><br><br></p><br><p>  ¬°Hurra!  Copiamos todo al nido en la cadera.  Puede saltar con seguridad al lugar de la llamada sin temor a que hayamos perdido algo.  Todo est√° a la moda. </p><br><p><img src="https://habrastorage.org/webt/bq/sz/ju/bqszjuffw-s4f14audafvzbmqzc.png"><br><br></p><br><p>  Ahora, tarde o temprano, el c√≥digo de llamada volver√° a llamar a nuestra continuaci√≥n.  Y ella debe continuar desde el lugar donde la dejaron la √∫ltima vez.  Esta es nuestra tarea. </p><br><p><img src="https://habrastorage.org/webt/8i/bg/x9/8ibgx9r_26wedxrahar1vfqdifi.png"><br><br></p><br><p>  Verificando si la continuaci√≥n se estaba ejecutando, dice que s√≠, se estaba ejecutando.  Por lo tanto, debe llamar a VM, limpiar un poco de espacio en la pila y llamar a la funci√≥n interna de <code>thaw</code> VM.  "Descongelar" se traduce al ruso como "descongelar", "descongelar", lo que suena bastante l√≥gico.  Es necesario descongelar fotogramas de la pila de continuaci√≥n en nuestra pila nativa principal. </p><br><p>  No estoy seguro de que el t√© descongelado sea bastante claro.  La mala abstracci√≥n es como un gatito con una puerta.  Pero esto har√° por nosotros. </p><br><p><img src="https://habrastorage.org/webt/ra/sv/5v/rasv5v_5w8_dpegomn_omgtdiza.png"><br><br></p><br><p>  Hacemos copias bastante obvias. </p><br><p>  Primero con una matriz primitiva: </p><br><p><img src="https://habrastorage.org/webt/wc/he/vg/wchevg-fsflrnicy0itprkp0q2e.png"><br><br></p><br><p>  Luego desde el enlace: </p><br><p><img src="https://habrastorage.org/webt/o_/o2/6s/o_o26sakm0n5hyq9wisbo7vouge.png"><br><br></p><br><p>  Necesita parchear un poco la copia para obtener la pila correcta: </p><br><p><img src="https://habrastorage.org/webt/sm/h7/0n/smh70naepp3kshxaa78zxv1g2du.png"><br><br></p><br><p>  Repita la obscenidad para todos los cuadros: </p><br><p><img src="https://habrastorage.org/webt/cg/dv/61/cgdv617uqeriqmuqcyc2jkjpnbe.png"><br><br></p><br><p>  Ahora puede volver a <code>yield</code> y continuar como si nada hubiera pasado. </p><br><p><img src="https://habrastorage.org/webt/gn/dd/xw/gnddxwqqsrwuidc9ev2nxwmiwqc.png"><br><br></p><br><p>  El problema es que una copia completa de la pila no es lo que nos gustar√≠a tener.  Es muy inhibitorio.  Todo esto es el aislamiento de enlaces, verifica la fijaci√≥n, no es r√°pido.  Y lo m√°s importante: ¬°todo esto depende linealmente del tama√±o de la pila!  En una palabra, infierno.  No hay necesidad de hacer esto. </p><br><p>  En cambio, tenemos otra idea: copia perezosa. </p><br><p>  Volvamos al lugar donde ya tenemos una continuaci√≥n congelada. </p><br><p><img src="https://habrastorage.org/webt/5b/hw/tg/5bhwtgg8cfg-agcwu_kdtrqlify.png"><br><br></p><br><p>  Continuamos el proceso como antes: </p><br><p><img src="https://habrastorage.org/webt/rj/ac/f9/rjacf9tmfekskko8jwojuocxixm.png"><br><br></p><br><p>  De la misma manera que antes, limpiamos el lugar en la pila nativa: </p><br><p><img src="https://habrastorage.org/webt/nm/ol/ow/nmolowac-dkmdefuobd-kaijyeq.png"><br><br></p><br><p>  Pero no estamos copiando todo en una fila, sino solo uno o un par de cuadros: </p><br><p><img src="https://habrastorage.org/webt/3a/ca/1x/3aca1xglgfbq8yzwxkjypelxpqy.png"><br><br></p><br><p>  Ahora el hack.  Debe parchear la direcci√≥n de retorno del m√©todo <code>C</code> para que apunte a una cierta barrera de retorno: </p><br><p><img src="https://habrastorage.org/webt/zs/si/3z/zssi3zgaadvvsrg883agxsmq3pc.png"><br><br></p><br><p>  Ahora puede volver a <code>yield</code> con seguridad: </p><br><p><img src="https://habrastorage.org/webt/e1/f_/2s/e1f_2snf4bh-ggjcv5lrgabqkwk.png"><br><br></p><br><p>  Lo que a su vez conducir√° a una llamada al c√≥digo de usuario en el m√©todo <code>C</code> : </p><br><p><img src="https://habrastorage.org/webt/y2/nl/rm/y2nlrmn9lczwhcaa3f41ii69nq0.png"><br><br></p><br><p>  Ahora imagine que <code>C</code> quiere volver al c√≥digo que lo llam√≥.  ¬°Pero su invocador es <code>B</code> , y no est√° en la pila!  Por lo tanto, cuando intenta regresar, ir√° a la direcci√≥n de retorno, y esta direcci√≥n es ahora la barrera de retorno.  Y, ya sabes, esto nuevamente generar√° una llamada de <code>thaw</code> : </p><br><p><img src="https://habrastorage.org/webt/hb/6g/8d/hb6g8dfw35ujqntvi-y7lzyskis.png"><br><br></p><br><p>  Y <code>thaw</code> descongelar√° el siguiente cuadro en la pila de continuaci√≥n, y esto es <code>B</code> : </p><br><p><img src="https://habrastorage.org/webt/cp/mp/ao/cpmpao3_arvnvgykenc9r4fgwsk.png"><br><br></p><br><p>  De hecho, lo copiamos perezosamente, a pedido. </p><br><p>  Luego, soltamos <code>B</code> de la pila de continuaci√≥n y establecemos la barrera nuevamente (la barrera debe establecerse porque queda algo en la pila de continuaci√≥n).  Y as√≠ sucesivamente. </p><br><p><img src="https://habrastorage.org/webt/gv/yo/0u/gvyo0u4iwzunuqovy1yv_-jbutq.png"><br><br></p><br><p>  Pero suponga que <code>B</code> no va a volver al c√≥digo de llamada, sino que primero llama a otro m√©todo <code>D</code>  Y este nuevo m√©todo tambi√©n quiere ser desplazado. </p><br><p><img src="https://habrastorage.org/webt/f9/1i/t9/f91it9xn705zsxuzvvbqh5gdoqi.png"><br><br></p><br><p>  En este caso, cuando llegue el momento de <code>freeze</code> , necesitaremos copiar solo la parte superior de la pila nativa en la pila de continuaci√≥n: </p><br><p><img src="https://habrastorage.org/webt/pt/8b/ul/pt8buljt77lsp-wj-rswobc4v_y.png"><br><br></p><br><p>  Por lo tanto, la cantidad de trabajo realizado no depende linealmente del tama√±o de la pila.  Depende linealmente solo del n√∫mero de cuadros que realmente usamos en el trabajo. </p><br><h1 id="chto-ostalos">  Lo que queda </h1><br><p>  Los desarrolladores tienen en cuenta algunas caracter√≠sticas, pero no entraron en el prototipo. </p><br><ul><li>  Serializaci√≥n y clonaci√≥n.  La capacidad de continuar en otra m√°quina, en otro momento, etc. </li><li>  JVM TI y depuraci√≥n, como si fueran hilos normales.  Si est√° bloqueado al leer el z√≥calo, entonces no ver√° un salto hermoso del rendimiento, en el prototipo, el hilo simplemente se bloquear√°, como cualquier otro hilo ordinario. </li><li>  La recursi√≥n de la cola ni siquiera fue tocada. </li></ul><br><p>  Pr√≥ximos pasos: </p><br><ul><li>  Hacer una API humana; </li><li>  Agregue todas las caracter√≠sticas que faltan; </li><li>  Mejora el rendimiento. </li></ul><br><h1 id="gde-vzyat">  Donde conseguir </h1><br><p>  El prototipo se realiza como un brunch en el repositorio de OpenJDK.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Puede descargar el prototipo aqu√≠</a> cambiando a las <code>fibers</code> brunch. </p><br><p>  Se hace as√≠: </p><br><pre> <code class="bash hljs">$ hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/loom/loom $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> loom $ hg update -r fibers $ sh configure $ make images</code> </pre> <br><p>   ,       OpenJDK. , -,       - ,    . </p><br><p><img src="https://habrastorage.org/webt/gk/qz/3-/gkqz3-f8gmkcwkynnnrp4opp1rg.png"><br><br></p><br><p> -,       C++   GNU .  ,        Windows. ,    VirtualBox    Ubuntu       ,          Cygwin  msys64.   ,  msys   ,  Cygwin. </p><br><p>  , ,  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  </a> . </p><br><p>   -   ,   mercurial extension   fsmonitor. ,   ,   <code>hg help -e fsmonitor</code> . <br>      ~/.hgrc  : </p><br><pre> <code class="plaintext hljs">[fsmonitor] mode = on</code> </pre> <br><p>  -           .             -, <code>cp -R ./loom ./loom-backup</code> . </p><br><p>  ,          . ,   Java-    ,       . </p><br><p> <code>sh configure</code>    - . ,     Ubuntu,     Autoconf ( <code>sudo apt-get install autoconf</code> ).  ‚Äî     OpenJDK   Ubuntu,     ,  .  Windows      ,   . </p><br><p> ,     ,   <code>hg diff --stat -r default:fibers</code> . </p><br><p>  ,          ,   ,     . </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>      ¬´, ¬ª.   ¬´¬ª, . ¬´Loom¬ª ‚Äî  ¬´ ¬ª.  Project Loom         . </p><br><p>          ,        . ,      ¬´¬ª  ,  ,      ‚Äî  , ,  , ‚Äî  . </p><br><p> ,   ,          XIX    ,        . </p><br><br><img src="https://habrastorage.org/getpro/habr/post_images/305/64e/143/30564e14316852dd18d4235b3850e134.jpg"><br><p>      . -,  . </p><br><p> ,                 .        IDE   . </p><br><p>          ,       ,   ,    ¬´ ¬ª, ¬´¬ª, ¬´ ¬ª   . </p><br><p>       ?   .   . </p><br><p>  Gracias </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es422519/">https://habr.com/ru/post/es422519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es422509/index.html">Resumen del libro "Nunca comas solo"</a></li>
<li><a href="../es422511/index.html">Cargando datos en Splunk: Universal Forwarder vs Heavy Forwarder. Cual es la diferencia</a></li>
<li><a href="../es422513/index.html">7 consejos sobre c√≥mo no enfurecer a un colega probador en sus vacaciones</a></li>
<li><a href="../es422515/index.html">Dos seminarios web Apaita Ignite y computaci√≥n en memoria en septiembre</a></li>
<li><a href="../es422517/index.html">TelegramBot en la nube de Wolfram</a></li>
<li><a href="../es422521/index.html">Presagio de lo inevitable</a></li>
<li><a href="../es422525/index.html">"La matriz de la amistad". El gr√°fico social m√°s antiguo para los m√°s peque√±os.</a></li>
<li><a href="../es422527/index.html">Resumen de noticias de PostgreSQL. N√∫mero 10</a></li>
<li><a href="../es422529/index.html">Curso especial del grupo IB: "Seguridad de aplicaciones m√≥viles"</a></li>
<li><a href="../es422531/index.html">Optimizaci√≥n web: lo m√°s importante</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>