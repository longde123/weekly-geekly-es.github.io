<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👗 🍰 🎹 DB Cursors dalam Doctrine 🥑 🕙 🍾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dengan menggunakan kursor, Anda dapat menerima dari batch database dan memproses sejumlah besar data tanpa membuang-buang memori aplikasi. Saya yakin ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DB Cursors dalam Doctrine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/455571/"><p><img src="https://habrastorage.org/webt/a_/l9/rc/a_l9rcqm9ubhpc_gstic1u-rxtq.jpeg" alt="gambar"></p><br><p>  Dengan menggunakan kursor, Anda dapat menerima dari batch database dan memproses sejumlah besar data tanpa membuang-buang memori aplikasi.  Saya yakin bahwa setiap pengembang web menghadapi tugas serupa setidaknya sekali, dan tidak hanya sekali sebelum saya.  Dalam artikel ini saya akan memberi tahu Anda apa tugas kursor dapat berguna, dan saya akan memberikan kode yang sudah jadi untuk bekerja dengannya dari PHP + Doktrin menggunakan contoh PostrgeSQL. </p><a name="habracut"></a><br><h3 id="problema">  Masalah </h3><br><p>  Bayangkan saja kita punya proyek PHP, besar dan berat.  Tentunya, itu ditulis dengan bantuan beberapa kerangka kerja.  Misalnya, Symfony.  Ini juga menggunakan database, misalnya, PostgreSQL, dan database memiliki plat untuk 2.000.000 catatan dengan informasi tentang pesanan.  Dan proyek itu sendiri adalah antarmuka untuk pesanan ini, yang dapat menampilkan dan memfilternya.  Dan, izinkan saya mengatakan, ini cukup baik. </p><br><p>  Sekarang kami ditanya (apakah Anda belum ditanyai? Mereka pasti akan diminta) untuk mengunggah hasil pemfilteran pesanan ke file Excel.  Mari kita menyiapkan tombol dengan ikon tabel, yang akan memuntahkan file dengan perintah kepada pengguna. </p><br><h3 id="kak-obychno-reshayut-i-chem-eto-ploho">  Bagaimana biasanya diputuskan, dan mengapa itu buruk? </h3><br><p>  Bagaimana seorang programmer yang belum mengalami tugas seperti itu?  Dia membuat SELECT dalam database, membaca hasil kueri, mengubah respons menjadi file Excel dan memberikannya ke browser pengguna.  Tugas berhasil, pengujian selesai, tetapi masalah mulai dalam produksi. </p><br><p> Tentunya, kami telah menetapkan batas memori untuk PHP di beberapa yang wajar (bisa dibilang) 1 GB per proses, dan begitu 2 juta baris ini tidak lagi sesuai dengan gigabyte ini, semuanya rusak.  PHP macet dengan kesalahan "kehabisan memori", dan pengguna mengeluh bahwa file tersebut tidak diunggah.  Ini terjadi karena kami memilih cara yang agak naif untuk membongkar data dari database - semuanya pertama-tama ditransfer dari memori basis data (dan disk di bawahnya) ke RAM proses PHP, kemudian mereka diproses dan diunggah ke browser. </p><br><p>  Agar data selalu ditempatkan dalam memori, Anda perlu mengambilnya dari basis data menjadi beberapa bagian.  Misalnya, 10.000 catatan dibaca, diproses, ditulis ke file, dan berkali-kali. </p><br><p>  Nah, pikir programmer yang memenuhi tugas kita untuk pertama kalinya.  Kemudian saya akan melakukan loop dan mengempiskan hasil query dalam potongan-potongan, yang menunjukkan LIMIT dan OFFSET.  Ini berfungsi, tetapi ini adalah operasi yang sangat mahal untuk database, dan karenanya mengunggah laporan tidak mulai memakan waktu 30 detik, tetapi 30 menit (tidak terlalu buruk!).  By the way, jika terlepas dari OFFSET pada saat ini tidak ada lagi yang terlintas dalam pikiran programmer, maka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">masih ada banyak cara untuk mencapai</a> hal yang sama tanpa memperkosa basis data. </p><br><p>  Pada saat yang sama, database itu sendiri memiliki kemampuan bawaan untuk membaca data darinya - kursor. </p><br><h3 id="kursory">  Kursor </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kursor</a> adalah penunjuk ke baris dalam hasil kueri yang hidup di database.  Saat menggunakannya, kita dapat melakukan SELECT tidak dalam mode segera mengunduh data, tetapi buka kursor dengan pilihan ini.  Selanjutnya, kita mulai menerima aliran data dari database ketika kursor bergerak maju.  Ini memberi kita hasil yang sama: kita membaca data secara bagian, tetapi database tidak melakukan pekerjaan yang sama untuk menemukan baris yang harus dimulai, seperti halnya dengan OFFSET. </p><br><p>  Kursor dibuka hanya di dalam transaksi dan hidup sampai transaksi itu hidup (ada pengecualian, lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DENGAN TAHAN</a> ).  Ini berarti bahwa jika kita perlahan membaca banyak data dari basis data, maka kita akan memiliki transaksi yang panjang.  Ini <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">terkadang buruk</a> , Anda perlu memahami dan menerima risiko ini. </p><br><h3 id="kursory-v-doctrine">  Kursor dalam Ajaran </h3><br><p>  Mari kita coba terapkan pekerjaan dengan kursor dalam Ajaran.  Pertama, seperti apa permintaan untuk membuka kursor? </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> mycursor1 <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> huge_table );</code> </pre> <br><p>  DECLARE membuat dan membuka kursor untuk kueri SELECT yang ditentukan.  Setelah membuat kursor, Anda dapat mulai membaca data darinya: </p><br><pre> <code class="sql hljs">FETCH FORWARD 10000 FROM mycursor1; &lt; 10 000 &gt; FETCH FORWARD 10000 FROM mycursor1; &lt;  10 000 &gt; ...</code> </pre> <br><p>  Dan seterusnya, hingga FETCH mengembalikan daftar kosong.  Ini berarti bahwa mereka menggulir hingga akhir. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre> <br><p>  Kami menguraikan kelas yang kompatibel dengan Doctrine yang akan merangkum pekerjaan dengan kursor.  Dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">untuk memecahkan 80% masalah dalam 20% dari waktu</a> , itu hanya akan berfungsi dengan Native Queries.  Jadi mari kita sebut saja, PgSqlNativeQueryCursor. </p><br><p>  Konstruktor: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeQuery $query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query = $query; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection = $query-&gt;getEntityManager()-&gt;getConnection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName = uniqid(<span class="hljs-string"><span class="hljs-string">'cursor_'</span></span>); assert(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getDriver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PDOPgSqlDriver); }</code> </pre> <br><p>  Di sini saya menghasilkan nama untuk kursor masa depan. </p><br><p>  Karena kelas memiliki kode SQL khusus PostgreSQL di kelas, lebih baik untuk memeriksa bahwa driver kami adalah PG. </p><br><p>  Dari kelas kita membutuhkan tiga hal: </p><br><ol><li>  Dapat membuka kursor. </li><li>  Mampu mengembalikan data kepada kami. </li><li>  Mampu menutup kursor. </li></ol><br><p>  <strong>Buka kursor:</strong> </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openCursor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getTransactionNestingLevel() === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \BadMethodCallException(<span class="hljs-string"><span class="hljs-string">'Cursor must be used inside a transaction'</span></span>); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'DECLARE %s CURSOR FOR (%s)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getSQL() )); $query-&gt;execute(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getParameters()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br><p>  Seperti yang saya katakan, kursor terbuka dalam transaksi.  Oleh karena itu, di sini saya memeriksa bahwa kami tidak lupa menelepon ke metode ini di dalam transaksi yang sudah terbuka.  (Alhamdulillah, waktu telah berlalu ketika saya akan ditarik untuk membuka transaksi di sini!) </p><br><p>  Untuk menyederhanakan tugas membuat dan menginisialisasi NativeQuery baru, saya hanya mengkloning yang dimasukkan ke dalam konstruktor dan membungkusnya dalam DECLARE ... CURSOR FOR (here_original_query).  Saya melakukannya. </p><br><p>  <strong>Mari kita membuat metode getFetchQuery.</strong>  Ini tidak akan mengembalikan data, tetapi permintaan lain yang dapat digunakan sesuka Anda untuk mendapatkan data yang diinginkan dalam kumpulan yang diberikan.  Ini memberi kode panggilan lebih banyak kebebasan. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH FORWARD %d FROM %s'</span></span>, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  Metode ini memiliki satu parameter - ini adalah ukuran bundel, yang akan menjadi bagian dari permintaan yang dikembalikan oleh metode ini.  Saya menerapkan trik yang sama dengan kloning permintaan, menimpa parameter di dalamnya dan mengganti SQL dengan FETCH ... FROM ...; </p><br><p>  Agar tidak lupa untuk membuka kursor sebelum panggilan pertama ke getFetchQuery () (tiba-tiba saya tidak akan cukup tidur), saya akan membuat pembukaan implisit langsung di metode getFetchQuery (): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } …</code> </pre> <br><p>  Dan metode openCursor () itu sendiri akan dibuat pribadi.  Saya tidak melihat kasus sama sekali ketika saya perlu menyebutnya secara eksplisit. </p><br><p>  Di dalam getFetchQuery (), saya hard-coded FORWARD untuk menggerakkan kursor ke depan sejumlah baris.  Tetapi mode panggilan FETCH banyak berbeda.  Mari kita tambahkan juga? </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_NEXT = <span class="hljs-string"><span class="hljs-string">'NEXT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_PRIOR = <span class="hljs-string"><span class="hljs-string">'PRIOR'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_FIRST = <span class="hljs-string"><span class="hljs-string">'FIRST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_LAST = <span class="hljs-string"><span class="hljs-string">'LAST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_ABSOLUTE = <span class="hljs-string"><span class="hljs-string">'ABSOLUTE'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// with count const DIRECTION_RELATIVE = 'RELATIVE'; // with count const DIRECTION_FORWARD = 'FORWARD'; // with count const DIRECTION_FORWARD_ALL = 'FORWARD ALL'; const DIRECTION_BACKWARD = 'BACKWARD'; // with count const DIRECTION_BACKWARD_ALL = 'BACKWARD ALL';</span></span></code> </pre> <br><p>  Setengah dari mereka menerima jumlah baris dalam parameter, dan setengahnya lagi tidak.  Inilah yang saya dapat: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, string $direction = self::DIRECTION_FORWARD)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_ABSOLUTE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_RELATIVE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_FORWARD || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_BACKWARD ) { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s %d FROM %s'</span></span>, $direction, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s FROM %s'</span></span>, $direction, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p>  <strong>Tutup kursor</strong> dengan TUTUP, tidak perlu menunggu transaksi selesai: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;exec(<span class="hljs-string"><span class="hljs-string">'CLOSE '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><p>  Destructor: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); } }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Inilah keseluruhan kelas secara keseluruhan</a> .  Mari kita coba beraksi? </p><br><p>  Saya membuka beberapa Penulis bersyarat di beberapa XLSX bersyarat. </p><br><pre> <code class="php hljs">$writer-&gt;openToFile($targetFile);</code> </pre> <br><p>  Di sini saya mendapatkan NativeQuery untuk menarik daftar pesanan dari database. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> NativeQuery $query */</span></span> $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOrdersRepository($em) -&gt;getOrdersFiltered($dateFrom, $dateTo, $filters);</code> </pre> <br><p>  Berdasarkan permintaan ini, saya menyatakan kursor. </p><br><pre> <code class="php hljs">$cursor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PgSqlNativeQueryCursor($query);</code> </pre> <br><p>  Dan untuknya saya mendapatkan permintaan untuk menerima data dalam batch 10.000 baris. </p><br><pre> <code class="php hljs">$fetchQuery = $cursor-&gt;getFetchQuery(<span class="hljs-number"><span class="hljs-number">10000</span></span>);</code> </pre> <br><p>  Saya beralih sampai saya mendapatkan hasil kosong.  Di setiap iterasi, saya melakukan FETCH, memproses hasilnya, dan menulis ke file. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $result = $fetchQuery-&gt;getArrayResult(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $writer-&gt;addRow(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toXlsxRow($row)); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($result);</code> </pre> <br><p>  Saya menutup kursor dan Penulis. </p><br><pre> <code class="php hljs">$cursor-&gt;close(); $writer-&gt;close();</code> </pre> <br><p>  Saya menulis file ke disk di direktori untuk file sementara, dan setelah rekaman selesai saya kirim ke browser untuk menghindari, lagi, buffering di memori. </p><br><p>  LAPORAN SIAP!  Kami menggunakan jumlah memori yang konstan dari PHP untuk memproses semua data dan tidak menyiksa database dengan serangkaian pertanyaan berat.  Dan pembongkaran itu sendiri memakan waktu sedikit lebih banyak daripada yang dibutuhkan pangkalan untuk memenuhi permintaan. </p><br><p>  Lihat apakah ada tempat di proyek Anda yang dapat mempercepat / menghemat memori dengan kursor? </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id455571/">https://habr.com/ru/post/id455571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id455555/index.html">Sepotong untuk manajer mekanik</a></li>
<li><a href="../id455559/index.html">Bagaimana komputer kuantum dapat menembus sistem enkripsi modern dan menurunkan biaya produksi amoniak?</a></li>
<li><a href="../id455563/index.html">Bisnis Kecil: Otomatis atau Tidak?</a></li>
<li><a href="../id455565/index.html">Bisakah pikiran memalsukan alam semesta?</a></li>
<li><a href="../id455569/index.html">Kami mengundang Anda ke Konferensi Tarantool pada 17 Juni</a></li>
<li><a href="../id455575/index.html">Pencocokan Saraf Tiruan: Cara menyesuaikan konten dengan realitas Google</a></li>
<li><a href="../id455577/index.html">SDL 2 Pelajaran: Pelajaran 3 - Acara</a></li>
<li><a href="../id455579/index.html">Tupperware: Facebook killer Kubernetes?</a></li>
<li><a href="../id455580/index.html">Animasi Aplikasi Mobile yang Harus Dimiliki</a></li>
<li><a href="../id455582/index.html">Navigasi di toko: melalui augmented reality ke rak yang diinginkan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>