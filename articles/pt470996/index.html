<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôÇÔ∏è üêã üöí Como uma simples tag <img> se torna um alto risco para uma empresa? ü§¶üèæ ü•ò üê≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A seguran√ßa com exemplos reais √© sempre interessante. 
 
 Hoje falaremos sobre o ataque SSRF, quando voc√™ pode for√ßar o servidor a fazer solicita√ß√µes ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como uma simples tag <img> se torna um alto risco para uma empresa?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470996/">  <i>A seguran√ßa com exemplos reais √© sempre interessante.</i> <i><br></i> <br>  Hoje falaremos sobre o ataque SSRF, quando voc√™ pode for√ßar o servidor a fazer solicita√ß√µes arbitr√°rias √† Internet por meio da tag img. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c1a/e7e/e3d/c1ae7ee3d053f0809e9d22c320924a18.jpg" alt="imagem"><br><br>  Ent√£o, estive recentemente envolvido em testes de penetra√ß√£o em dois projetos simultaneamente, em dois deles essa vulnerabilidade foi revelada.  As capturas de tela s√£o tiradas diretamente dos relat√≥rios, portanto, todas as informa√ß√µes desnecess√°rias s√£o manchadas. <br><br><h3>  Descri√ß√£o do ataque </h3><br><a name="habracut"></a><br>  <b>Nome do ataque: o</b> servidor faz solicita√ß√µes arbitr√°rias √† Internet durante a gera√ß√£o de um documento PDF. <br><br>  <b>Descri√ß√£o: o</b> PDF √© gerado no lado do servidor a partir de uma p√°gina html totalmente renderizada com todos os recursos externos.  Os documentos continham dados inseridos pelo usu√°rio.  Sem filtragem adequada, voc√™ pode substituir seus recursos externos na renderiza√ß√£o do servidor.  Nesse caso, seja o arquivo <a href="">it-band.by/10gb.blob</a> (tamanho supostamente de 10 Gb). <br><br>  <b>Pior cen√°rio:</b> <br><br><ol><li>  Os Ddos atacam por dentro, quando o sistema precisa baixar 100 gigabytes de dados para renderiza√ß√£o, a fim de renderizar v√°rios documentos PDF ao mesmo tempo.  Como resultado, isso leva √† falta de recursos de rede ou mem√≥ria, o que, por sua vez, pode levar √† inatividade do sistema. </li><li>  Um usu√°rio mal-intencionado pode usar o servidor como plataforma para atacar outros recursos. </li><li>  Um usu√°rio mal-intencionado obt√©m os endere√ßos IP externos dos servidores internos para ataques diretos, ignorando os firewalls de aplicativos da Web (WAF) e os balanceadores. </li></ol><br>  <b>Avalia√ß√£o de risco (Probabilidade * Impacto):</b> M√©dio (5) * Alto (7) = Alto (35) (em ambos os sistemas, o risco foi classificado como alto, embora com propor√ß√µes diferentes) <br><br>  <b>O que √© interessante:</b> <br><br><ol><li>  Um sistema usou o wkhtmltopdf para renderizar o html2pdf, o segundo rodou o Firefox, carregou a p√°gina e tirou uma captura de tela.  De qualquer forma, ambos os sistemas renderizam as duas p√°ginas imediatamente, executam todo o c√≥digo existente e somente ent√£o fazem PDF a partir disso. </li><li> A prote√ß√£o do servidor XSS foi instalada nos dois sistemas, mas, em vez de usar o escape de dados de entrada, os dois sistemas usaram a purifica√ß√£o de html, que limpava todos os iframes, scripts, css, formul√°rios e assim por diante.  Mas a purifica√ß√£o de html em ambos os sistemas √© considerada c√≥digo html seguro <code>img src="https://it-band.by/10Gb.blob?t=12345.1"/</code> safe. </li></ol><br><h3>  Agora siga as etapas e capturas de tela </h3><br>  1) Crie esse arquivo localmente, na tentativa de preench√™-lo posteriormente, no todo ou em parte. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8e/526/93f/b8e52693f2ad426797e6782d1ab8e157.jpg" alt="imagem"><br><br>  2) No come√ßo, voc√™ precisa encontrar campos de usu√°rio vulner√°veis. <br><br>  <i>Sistema 1. Falha ao inserir apenas uma tag img</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22e/ca3/6df/22eca36dfe17b1291627cca7f1192f5d.jpg" alt="imagem"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/226/53e/ccc/22653eccc53b3ea8ed3940c6b9ef7309.jpg" alt="imagem"><br><br>  <i>Sistema 2. Consegui inserir cerca de 20 tags imediatamente</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c1d/fbf/5fb/c1dfbf5fb9f33837714bb2c9521000fc.jpg" alt="imagem"><br><br>  3) Em seguida, geramos o documento PDF. <br><br>  <i>Sistema 1. PDF Gerado</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54a/f8f/ad9/54af8fad96135721b3989753d39c44ff.jpg" alt="imagem"><br><br>  <i>Sistema 2. PDF Gerado</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a00/76f/ded/a0076fded6ad1a8688d856ffa751544b.jpg" alt="imagem"><br><br>  4) E agora subimos no servidor para ver se havia solicita√ß√µes para o nosso grande arquivo 10Gb.blob. <br><br>  <i>Sistema 1. Obtemos o endere√ßo IP e o software do servidor, com a ajuda da qual o documento PDF foi gerado, o nmap mostrou outra porta aberta, que ningu√©m havia visto antes, pelo endere√ßo IP encontrado.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df7/0ee/24b/df70ee24b6efad45cbe9553b8bdf392b.jpg" alt="imagem"><br><br>  <i>Sistema 2. Pode ser visto que o servidor tentou baixar 20 arquivos de 10 gigabytes.</i>  <i>Tamb√©m obtemos o endere√ßo de um dos servidores e a vers√£o do Firefox usada.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e6/c80/aa0/3e6c80aa0358911d5c9bd00e79209901.jpg" alt="imagem"><br><br>  <b>O resultado.</b>  Nos dois sistemas, os erros j√° foram corrigidos.  No primeiro sistema, em vez de purificar html, a fuga √© feita durante o processamento de dados do usu√°rio e durante a gera√ß√£o de um documento PDF;  no segundo sistema, quaisquer links absolutos para recursos externos s√£o cortados durante o processamento de dados do usu√°rio. <br><br>  <i>Atualizado.</i> <i><br><br></i>  <i>Enquanto cheguei √† publica√ß√£o do artigo, foram adicionados casos de mais 2 sistemas.</i> <br><br>  Outro sistema (vamos chamar de Sistema 3) n√£o passou na verifica√ß√£o desse tipo de vulnerabilidade em dois locais ao mesmo tempo: atrav√©s da inje√ß√£o de HTML e inje√ß√£o de CSS. <br><br>  <i>Sistema 3. Inje√ß√£o de HTML com download 20 vezes de uma imagem ao vivo 13 Mb (no total 260Mb)</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fca/8f2/5bd/fca8f25bd0092de64280c0d0cc6d6020.jpg" alt="imagem"><br><br>  <i>Sistema 3. Inje√ß√£o de CSS</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df2/cfb/584/df2cfb584b9ed09f2d1250c63a70086a.jpg" alt="imagem"><br><br>  <i>Sistema 3. O que vemos no servidor atacante ao renderizar um PDF (todos os 20 downloads de uma imagem de 13 Mb s√£o bem-sucedidos)</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a80/ed7/18b/a80ed718b82bb5c5862c0c7ea343942b.jpg" alt="imagem"><br><br>  <b>Qual foi a sa√≠da do Sistema 3:</b> <br><br>  1) Obteve os endere√ßos dos servidores que renderizam e o que eles usam para renderizar.  Nesse caso, HeadlessChrome. <br><br>  2) A gera√ß√£o de um documento PDF levou cerca de 5 minutos, depois o cromo simplesmente caiu.  Imagine, se voc√™ executar 10 mil dessas solicita√ß√µes, por um tempo os servidores de gera√ß√£o, em princ√≠pio, deixar√£o de responder √†s solicita√ß√µes de outros usu√°rios. <br><br>  <i>Sistema 4. O</i> ataque SSRF aqui foi realizado n√£o atrav√©s da tag img, mas atrav√©s do XSS, quando minha carga √∫til favorita foi executada no servidor durante a renderiza√ß√£o e o servidor lan√ßou o c√≥digo Javascript arbitr√°rio ao gerar o documento PDF.  Comparado aos casos anteriores, √© poss√≠vel realizar ataques mais complexos em outros sistemas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/28a/5ac/d5b/28a5acd5ba920b65add4b1b51819a0a2.jpg" alt="imagem"><br><br>  <i>Sistema 4. PDF renderizado com c√≥digo JS arbitr√°rio executado no lado do servidor</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/55f/f3c/8b2/55ff3c8b29a5d6cd83e1c5736bd0a480.jpg" alt="imagem"><br><br>  Premissa 1. Os sistemas exigem o desenvolvimento n√£o apenas das regras do firewall recebido, mas tamb√©m do de sa√≠da, ou do desenvolvimento de infraestrutura com segmentos ou servidores de rede separados, dos quais n√£o h√° acesso externo. <br><br>  Premissa 2. Ao encontrar at√© a menor vulnerabilidade, voc√™ deve sempre procurar os piores cen√°rios de uso e impacto nos neg√≥cios.  Os neg√≥cios s√≥ podem trabalhar com riscos, o lado t√©cnico, infelizmente, √© de pouco interesse para eles. <br><br>  As informa√ß√µes acima s√£o fornecidas apenas para fins educacionais e educacionais, n√£o √© necess√°rio executar seus sistemas. <br><br>  Denis Koloshko, CISSP, Testador de penetra√ß√£o </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470996/">https://habr.com/ru/post/pt470996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470982/index.html">An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</a></li>
<li><a href="../pt470984/index.html">An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</a></li>
<li><a href="../pt470988/index.html">As inscri√ß√µes est√£o abertas para o Slerm DevOps em Moscou</a></li>
<li><a href="../pt470990/index.html">Kit de ferramentas de marketing on-line: 3 aplicativos para aumentar a comunica√ß√£o visual</a></li>
<li><a href="../pt470994/index.html">Heran√ßa JavaScript do ponto de vista de um nerd entediado: f√°brica de construtores</a></li>
<li><a href="../pt470998/index.html">Brinquedos de madeira, parte dez - 1996</a></li>
<li><a href="../pt471000/index.html">Brinquedos de madeira, a √∫ltima parte - 1997</a></li>
<li><a href="../pt471004/index.html">Brinquedos de madeira - um ep√≠logo que permanece pregado no teto</a></li>
<li><a href="../pt471006/index.html">US $ 500 por m√™s: em que os benefici√°rios da renda b√°sica incondicional gastam seu dinheiro?</a></li>
<li><a href="../pt471008/index.html">Vamos falar sobre monitoramento: grava√ß√£o ao vivo do podcast Devops Deflope com a New Relic na reuni√£o de 23 de outubro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>