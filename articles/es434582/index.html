<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游땰 游녣游 游댭 Soluciones arquitect칩nicas para un juego m칩vil. Parte 1: modelo 游낕 游녿游 游깲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ep칤grafe: 
 - 쮺칩mo evaluar칠 si no sabes qu칠 hacer? 
 - Bueno, habr치 pantallas y botones. 
 - Dima, 춰ahora has descrito toda mi vida en tres palabras!...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soluciones arquitect칩nicas para un juego m칩vil. Parte 1: modelo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434582/">  <i>Ep칤grafe:</i> <i><br></i>  <i>- 쮺칩mo evaluar칠 si no sabes qu칠 hacer?</i> <i><br></i>  <i>- Bueno, habr치 pantallas y botones.</i> <i><br></i>  <i>- Dima, 춰ahora has descrito toda mi vida en tres palabras!</i> <i><br></i>  <i>(c) Di치logo real en un mitin en una empresa de juegos</i> <br><br><img src="https://habrastorage.org/webt/zp/ab/js/zpabjszvfb5gcancgd76i5trlz8.jpeg"><br><br>  El conjunto de necesidades y las soluciones que las satisfacen, que analizar칠 en este art칤culo, se formaron durante mi participaci칩n en aproximadamente una docena de grandes proyectos, primero en Flash y luego en Unity.  El mayor de los proyectos ten칤a m치s de 200,000 DAU y complement칩 mi hucha con nuevos desaf칤os originales.  Por otro lado, se confirm칩 la relevancia y la necesidad de hallazgos anteriores. <br><br>  En nuestra dura realidad, todos los que han dise침ado al menos una vez un gran proyecto, al menos en sus pensamientos, tienen sus propias ideas sobre c칩mo hacerlo, y a menudo est치n listos para defender sus ideas hasta la 칰ltima gota de sangre.  Para otros, me hace sonre칤r, y la gerencia a menudo ve todo esto como una gran caja negra que no ha descansado contra nadie.  Pero, 쯤u칠 sucede si le digo que las soluciones correctas ayudar치n a reducir la creaci칩n de nuevas funcionalidades en 2-3 veces, la b칰squeda de errores en las antiguas 5-10 veces y le permitir치n hacer muchas cosas nuevas e importantes que antes no estaban disponibles?  춰Es suficiente dejar que la arquitectura entre en tu coraz칩n! <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect칩nicas para un juego m칩vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2: Comando y sus colas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect칩nicas para un juego m칩vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3: Ver en el empuje del jet</a> <br><a name="habracut"></a><br><br><h2>  Modelo </h2><br><h3>  Acceso a los campos </h3><br>  La mayor칤a de los programadores reconocen la importancia de usar algo como MVC.  Pocas personas usan MVC puro del libro de una pandilla de cuatro, pero todas las decisiones de las oficinas normales son de alguna manera similares a este patr칩n en esp칤ritu.  Hoy hablaremos sobre la primera de las letras en esta abreviatura.  Debido a que una gran parte del trabajo de los programadores en un juego m칩vil son nuevas caracter칤sticas en el metajuego, implementadas como manipulaciones con el modelo, y atornillando miles de interfaces en estas caracter칤sticas.  Y la conveniencia del modelo juega un papel clave en esta lecci칩n. <br><br>  No proporciono el c칩digo completo, porque es un poco tonto, y en general no se trata de 칠l.  Ilustrar칠 mi razonamiento con un ejemplo simple: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory; <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } }</code> </pre> <br>  Esta opci칩n no nos conviene en absoluto, porque el modelo no env칤a eventos sobre los cambios que ocurren en 칠l.  Si la informaci칩n sobre qu칠 campos se vieron afectados por los cambios, y cu치les no, y cu치les necesitan ser redibujados y cu치les no, el programador lo indicar치 manualmente de una forma u otra, esta se convertir치 en la principal fuente de errores y tiempo invertido.  Y simplemente no tengo que mirar con sorpresa: en la mayor칤a de las grandes oficinas en las que trabaj칠, el programador envi칩 todo tipo de InventoryUpdatedEvent y, en algunos casos, tambi칠n los llen칩 manualmente.  Algunas de estas oficinas han hecho millones, 쯖rees que, gracias o a pesar de eso? <br><br>  Usaremos nuestra propia clase ReactiveProperty &lt;T&gt; que ocultar치 debajo del cap칩 todas las manipulaciones para enviar mensajes que necesitamos.  Se ver치 m치s o menos as칤: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;InventoryModel&gt; inventory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;InventoryModel&gt;(); <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money.Value = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.Value.capacity.Value++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ money.SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta es la primera versi칩n del modelo.  Esta opci칩n ya es un sue침o para muchos programadores, pero todav칤a no me gusta.  Lo primero que no me gusta es que acceder a los valores es complicado.  Me las arregl칠 para confundirme mientras escrib칤a este ejemplo, olvidando Value en un lugar, y son precisamente estas manipulaciones de datos las que constituyen la mayor parte de todo lo que se hace y se confunde con el modelo.  Si est치 utilizando la versi칩n de idioma 4.x, puede hacer esto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;();</code> </pre> <br>  Pero esto no resuelve todos los problemas.  Me gustar칤a escribir simplemente: Inventory.capacity ++;.  Supongamos que intentamos obtener para cada campo modelo;  conjunto  Pero para suscribirse a eventos, tambi칠n necesitamos acceso a ReactiveProperty.  Claro inconveniente y fuente de confusi칩n.  A pesar de que solo necesitamos indicar qu칠 campo vamos a monitorear.  Y aqu칤 se me ocurri칩 una maniobra complicada que me gust칩. <br><br>  A ver si te gusta. <br><br>  No se inserta ReactiveProperty en el modelo concreto con el que est치 tratando el programador, se inserta, pero su descriptor est치tico PValue, el heredero de la propiedad m치s general, identifica el campo, y dentro del cap칩 del constructor del modelo se oculta la creaci칩n y el almacenamiento de la ReactiveProperty del tipo deseado.  No es el mejor nombre, pero sucedi칩, luego cambi칩 de nombre. <br><br>  En c칩digo, se ve as칤: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; MONEY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MONEY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { MONEY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Get(MONEY).SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta es la segunda opci칩n.  El antepasado general del Modelo, por supuesto, fue complicado a expensas de crear y extraer una Propiedad Reactiva real de acuerdo con su descriptor, pero esto se puede hacer muy r치pidamente y sin reflexi칩n, o m치s bien, aplicando la reflexi칩n solo una vez en la etapa de inicializaci칩n de la clase.  Y este es el trabajo que realiza una vez el creador del motor, y luego ser치 utilizado por todos.  Adem치s, este dise침o evita intentos accidentales de manipular ReactiveProperty en lugar de los valores almacenados en 칠l.  La creaci칩n del campo est치 abarrotada, pero en todos los casos es exactamente la misma y se puede crear con una plantilla. <br><br>  Al final del art칤culo hay una encuesta que opci칩n le gusta m치s. <br>  Todo lo que se describe a continuaci칩n se puede implementar en ambas versiones. <br><br><h3>  Transacciones </h3><br>  Quiero que los programadores puedan cambiar los campos del modelo solo cuando las restricciones adoptadas en el motor lo permitan, es decir, dentro del equipo, y nunca m치s.  Para hacer esto, el configurador debe ir a alg칰n lado y verificar si el comando de transacci칩n est치 actualmente abierto, y solo entonces permitir que la informaci칩n se edite en el modelo.  Esto es muy necesario, porque los usuarios del motor regularmente intentan hacer algo extra침o para evitar un proceso t칤pico, rompiendo la l칩gica del motor y causando errores sutiles.  Vi esto m치s de una o dos veces. <br><br>  Existe la creencia de que si crea una interfaz separada para leer datos del modelo y para escribir, de alguna manera ser치 칰til.  En realidad, el modelo est치 cubierto de archivos adicionales y tediosas operaciones adicionales.  Estas restricciones son finales. Los programadores se ven obligados, en primer lugar, a conocerlos y pensar constantemente sobre ellos: "lo que cada funci칩n espec칤fica, modelo o interfaz debe dar", y en segundo lugar, las situaciones tambi칠n surgen cuando estas restricciones deben ser sorteadas, a la salida tenemos a D'Artagnan, quien se le ocurri칩 todo esto en blanco, y muchos usuarios de su motor, que son malos guardianes del Project Manager, y a pesar de los constantes abusos, nada funciona seg칰n lo previsto.  Por lo tanto, prefiero bloquear estrictamente la posibilidad de tal error.  Reduzca la dosis de convenciones, por as칤 decirlo. <br><br>  El configurador ReactiveProperty debe tener un enlace al lugar donde se debe verificar el estado actual de la transacci칩n.  Digamos que este lugar es classCModelRoot.  La opci칩n m치s f치cil es pasarlo expl칤citamente al constructor del modelo.  La segunda versi칩n del c칩digo al llamar a RProperty recibe un enlace a esto expl칤citamente, y puede obtener toda la informaci칩n necesaria desde all칤.  Para la primera versi칩n del c칩digo, tendr치 que correr alrededor de los campos del tipo ReactiveProperty en el constructor con una reflexi칩n y darles un enlace a este para futuras manipulaciones.  Un peque침o inconveniente es la necesidad de crear un constructor expl칤cito con un par치metro en cada modelo, algo como esto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot gamestate)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gamestate)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  Pero para otras caracter칤sticas de los modelos, es muy 칰til que el modelo tenga un enlace con el modelo padre, formando una construcci칩n bicon칠cta.  En nuestro ejemplo, este ser치 player.inventory.Parent == player.  Y entonces este constructor puede ser evitado.  Cualquier modelo podr치 obtener y almacenar en cach칠 un enlace a un lugar m치gico de su padre, y ese de su padre, y as칤 sucesivamente hasta que el pr칩ximo padre resulte ser ese lugar m치gico.  Como resultado, a nivel de declaraciones, todo esto se ver치 as칤: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Model Parent { get; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ModelRoot Root { get; } }</code> </pre> <br>  Toda esta belleza se llenar치 autom치ticamente cuando la modelo entre al 치rbol del estado del juego.  S칤, el modelo reci칠n creado, que a칰n no ha llegado all칤, no podr치 aprender sobre la transacci칩n y bloquear las manipulaciones consigo mismo, pero si el estado de la transacci칩n est치 prohibido, no podr치 ingresar al estado despu칠s de eso, el configurador del futuro padre no lo permitir치, por lo que la integridad del estado del juego no se ver치 afectada.  S칤, esto requerir치 un trabajo adicional en la etapa de programaci칩n del motor, pero por otro lado, un programador que usa el motor eliminar치 por completo la necesidad de saberlo y pensarlo hasta que intente hacer algo mal y lo ponga en sus manos. <br><br>  Dado que la conversaci칩n sobre la actividad ha comenzado, los mensajes sobre los cambios no deben procesarse inmediatamente despu칠s de realizar el cambio, sino solo cuando se completan todas las manipulaciones con el modelo dentro del comando actual.  Hay dos razones para esto, la primera es la coherencia de los datos. No todos los estados de datos son coherentes internamente. Quiz치s no pueda intentar renderizarlos.  O si est치 impaciente, por ejemplo, para ordenar una matriz o cambiar alguna variable de modelo en un bucle.  No debe recibir cientos de mensajes de cambio. <br><br>  Hay dos formas de hacer esto.  El primero es suscribirse a las actualizaciones de una variable y usar una funci칩n complicada que agrega una secuencia de terminaciones de transacciones a la secuencia de cambios en la variable y solo despu칠s saltar치 los mensajes.  Esto es bastante f치cil de hacer si est치 utilizando UniRX, por ejemplo.  Pero esta opci칩n tiene muchas deficiencias, en particular genera muchos movimientos innecesarios.  Personalmente, me gusta la otra opci칩n. <br><br>  Cada propiedad reactiva recordar치 su estado antes del inicio de la transacci칩n y su estado actual.  Solo se enviar치 un mensaje sobre el cambio y la fijaci칩n de los cambios al final de la transacci칩n.  En el caso de que el objeto del cambio fuera alg칰n tipo de recopilaci칩n, esto permitir치 incluir expl칤citamente informaci칩n sobre los cambios que ocurrieron en el mensaje enviado, por ejemplo, se agregaron esos dos elementos en la lista y se eliminaron.  En lugar de decir simplemente que algo ha cambiado y obligar al destinatario a analizar una lista de mil elementos de longitud en busca de informaci칩n que necesita ser redibujada. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatchChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command transaction)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RevertChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br>  La opci칩n lleva m치s tiempo en la etapa de creaci칩n del motor, pero el costo de uso es m치s bajo.  Y lo m치s importante, abre la posibilidad de la pr칩xima mejora. <br><br><h3>  Informaci칩n sobre los cambios realizados en el modelo. </h3><br>  Quiero m치s del modelo.  En cualquier momento quiero ver f치cil y convenientemente qu칠 ha cambiado en el estado del modelo como resultado de mis acciones.  Por ejemplo, de esta forma: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>}}}</code> </pre> <br>  Muy a menudo, es 칰til para el programador ver la diferencia entre el estado del modelo antes del inicio del comando y despu칠s de su finalizaci칩n, o en alg칰n punto dentro del comando.  Algunos para este clon de todo el estado del juego antes del inicio del equipo, y luego comparar.  Esto resuelve parcialmente el problema en la etapa de depuraci칩n, pero es absolutamente imposible ejecutar esto en el producto.  Esa clonaci칩n estatal, que calcular la diferencia insignificante entre las dos listas, es una operaci칩n monstruosamente costosa de hacer con cualquier estornudo. <br><br>  Por lo tanto, ReactiveProperty debe almacenar no solo su estado actual, sino tambi칠n el anterior.  Esto da lugar a todo un grupo de oportunidades extremadamente 칰tiles.  En primer lugar, la extracci칩n de la diferencia en tal situaci칩n es r치pida, y podemos volcarlo tranquilamente en la comida.  En segundo lugar, no puede obtener un diferencial voluminoso, sino un peque침o hash compacto de los cambios, y compararlo con un hash de cambios en otro mismo estado de juego.  Si no est치 de acuerdo, tienes problemas.  En tercer lugar, si la ejecuci칩n del comando cay칩 con la ejecuci칩n, siempre puede cancelar los cambios y averiguar sobre el estado intacto en el momento en que comenz칩 la transacci칩n.  Junto con el equipo aplicado al estado, esta informaci칩n es invaluable porque puede reproducir f치cilmente la situaci칩n con precisi칩n.  Por supuesto, para esto necesitas tener una funcionalidad preparada para una serializaci칩n y deserializaci칩n conveniente del estado del juego, pero la necesitar치s de todos modos. <br><br><h3>  Serializaci칩n de cambios de modelo </h3><br>  El motor proporciona serializaci칩n y binario, y en json, y esto no es accidental.  Por supuesto, la serializaci칩n binaria ocupa mucho menos espacio y funciona mucho m치s r치pido, lo cual es importante, especialmente durante el arranque inicial.  Pero este no es un formato legible por humanos, y aqu칤 oramos por la conveniencia de la depuraci칩n.  Adem치s, hay otra trampa.  Cuando su juego vaya a producci칩n, deber치 cambiar constantemente de una versi칩n a otra.  Si sus programadores siguen algunas precauciones simples y no eliminan nada del estado del juego innecesariamente, no sentir치n esta transici칩n.  Y en el formato binario, no hay nombres de cadena de campo por razones obvias, y si las versiones no coinciden, tendr치 que leer el binario con la versi칩n anterior del estado, exportarlo a algo m치s informativo, por ejemplo, el mismo json, luego importarlo a un nuevo estado, exportarlo al binario, anote, y solo despu칠s de todo este trabajo, como de costumbre.  Como resultado, en algunos proyectos, las configuraciones se escriben en los archivos binarios en vista de sus tama침os cicl칩peos, y ya prefieren arrastrar el estado hacia adelante y hacia atr치s en forma de json.  Evaluar gastos generales y elegirlo. <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    ,    } /**    */ public partial class Model { public bool GetHashCode(ExportMode mode, out int code); public bool Import(BinaryReader binarySerialization); public bool Import(JSONReader json); public void ExportAll(ExportMode mode, BinaryWriter binarySerialization); public void ExportAll(ExportMode mode, JSONWriter json); public bool Export(ExportMode mode, out Dictionary&lt;string, object&gt; data); }</span></span></code> </pre> <br>  La firma del m칠todo Exportar (modo ExportMode, fuera de los datos del Diccionario &lt;cadena, objeto&gt;) es algo alarmante.  Y la cuesti칩n es esta: cuando serializa todo el 치rbol, puede escribir directamente en la secuencia, o en nuestro caso, en JSONWriter, que es un complemento simple para StringWriter.  Pero cuando exporta cambios, no es tan simple, porque cuando se adentra en un 치rbol y se adentra en una de las ramas, todav칤a no sabe si exportar algo de 칠l.  Por lo tanto, en esta etapa se me ocurrieron dos soluciones, una m치s simple, la segunda m치s complicada y econ칩mica.  Una m치s simple es que al exportar solo cambios, convierte todos los cambios en un 치rbol desde Diccionario &lt;cadena, objeto&gt; y Lista &lt;objeto&gt;.  Y luego, qu칠 pas칩, alimente a su serializador favorito.  Este es un enfoque simple que no requiere bailar con una pandereta.  Pero su inconveniente es que en el proceso de exportaci칩n de cambios al mont칩n, se asignar치 un lugar para las colecciones 칰nicas.  De hecho, no hay mucho espacio, porque esta exportaci칩n completa da un gran 치rbol, y el comando t칤pico deja muy pocos cambios en el 치rbol. <br><br>  Sin embargo, muchas personas creen que alimentar al recolector de basura como ese troll no es necesario sin una necesidad extrema.  Para ellos, y para calmar mi conciencia, prepar칠 una soluci칩n m치s compleja: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newModel = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Stack&lt;Model&gt; ierarchyChanged = null)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, Queue&lt;Model&gt; ierarchyChanges = null)</span></span></span></span>; }</code> </pre> <br>  La esencia de este m칠todo es caminar dos veces por el 치rbol.  Por primera vez, vea todos los modelos que se han modificado a s칤 mismos, o que tienen cambios en los modelos secundarios, y escr칤balos todos en Cola &lt;Modelo&gt; ierarchyChanges exactamente en el orden en que aparecen en el 치rbol en su estado actual.  No hay muchos cambios, la cola no ser치 larga.  Adem치s, nada impide mantener Stack &lt;Model&gt; y Queue &lt;Model&gt; entre llamadas y luego habr치 muy pocas asignaciones durante la llamada. <br><br>  Y ya pasando la segunda vez a trav칠s del 치rbol, ser치 posible mirar la parte superior de la cola cada vez y comprender si es necesario entrar en esta rama del 치rbol o seguir de inmediato.  Esto permite que JSONWriter escriba inmediatamente sin devolver ning칰n otro resultado intermedio. <br><br>  Es muy probable que esta complicaci칩n no sea realmente necesaria, porque m치s adelante ver치 que exportar los cambios al 치rbol que necesita solo para la depuraci칩n o cuando se bloquea con Exception.  Durante el funcionamiento normal, todo se limita a GetHashCode (modo ExportMode, out int code) al que todas estas delicias son profundamente ajenas. <br><br>  Antes de continuar complicando nuestro modelo, hablemos de esto. <br><br><h2>  쯇or qu칠 es tan importante? </h2><br>  Todos los programadores dicen que esto es terriblemente importante, pero generalmente nadie les cree.  Por qu칠 <br><br>  En primer lugar, porque todos los programadores dicen que debes tirar lo viejo y escribir lo nuevo.  Eso es todo, independientemente de las calificaciones.  No existe una forma administrativa de averiguar si esto es cierto o no, y los experimentos suelen ser demasiado caros.  El gerente se ver치 obligado a elegir un programador y confiar en su juicio.  El problema es que ese asesor suele ser aquel con quien la gerencia ha estado trabajando durante mucho tiempo y lo eval칰a en funci칩n de si fue capaz de realizar sus ideas, y todas sus mejores ideas ya est치n plasmadas en la realidad.  Por lo tanto, esta tampoco es una forma ideal de descubrir qu칠 tan buenas son las ideas ajenas y diferentes. <br><br>  En segundo lugar, el 80% de todos los juegos m칩viles traen menos de $ 500 en toda su vida.  Por lo tanto, al comienzo del proyecto, la administraci칩n tiene otros problemas, m치s importante la arquitectura.  Pero las decisiones tomadas al comienzo del proyecto toman a la gente como rehenes y no la dejan pasar de seis meses a tres a침os.  El proceso de refactorizaci칩n y cambio a otras ideas en un proyecto que ya funciona, que tambi칠n tiene clientes, es un negocio muy dif칤cil, costoso y arriesgado.  Si para un proyecto desde el principio, invertir tres meses-hombre en una arquitectura normal parece un lujo inadmisible, entonces, 쯤u칠 puede decir sobre el costo de retrasar la actualizaci칩n con nuevas caracter칤sticas durante un par de meses? <br><br>  En tercer lugar, incluso si la idea de "c칩mo deber칤a ser" en s칤 misma es buena e ideal, no se sabe cu치nto tiempo llevar치 su implementaci칩n.  La dependencia del tiempo dedicado a la frescura del programador es muy no lineal.  El se침or har치 una tarea simple no mucho m치s r치pida que la junior.  Una vez y media, tal vez.  Pero cada programador tiene su propio "l칤mite de complejidad", m치s all치 del cual su efectividad cae dram치ticamente.  Tuve un caso en mi vida en el que necesitaba realizar una tarea arquitect칩nica bastante complicada, e incluso concentrarme completamente en el problema de apagar Internet en la casa y pedir comidas preparadas por un mes no ayud칩, pero dos a침os despu칠s, despu칠s de leer libros interesantes y resolver tareas relacionadas Resolv칤 este problema en tres d칤as.  Estoy seguro de que todos recordar치n algo as칤 en su carrera.  Y aqu칤 est치 el truco!  El hecho es que si se le ocurri칩 una idea ingeniosa como deber칤a ser, entonces lo m치s probable es que esta nueva idea est칠 en alg칰n lugar de su l칤mite personal de complejidad, y tal vez incluso un poco detr치s.  La gerencia, que se ha quemado en repetidas ocasiones sobre eso, comienza a soplar cualquier idea nueva.  Y si haces el juego por ti mismo, el resultado puede ser a칰n peor, porque no habr치 nadie que te detenga. <br><br>  Pero, 쯖칩mo, entonces, alguien logra usar buenas soluciones?  Hay varias formas <br><br>  En primer lugar, cada compa침칤a quiere contratar a una persona preparada que ya haya hecho esto con un empleador anterior.  Esta es la forma m치s com칰n de transferir la carga de la experimentaci칩n a otra persona. <br><br>  En segundo lugar, las empresas o personas que hicieron su primer juego exitoso, sorbieron y comenzaron el pr칩ximo proyecto est치n listos para los cambios. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tercer lugar, honestamente adm칤tete a ti mismo que a veces haces algo no por el salario, sino por el placer del proceso. Lo principal es encontrar tiempo para esto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarto, es un conjunto de soluciones y bibliotecas comprobadas, junto con personas, que constituyen los fondos principales de la compa침칤a de juegos, y esto es lo 칰nico que permanecer치 en 칠l cuando alguna persona clave se vaya y se mude a Australia.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La 칰ltima, aunque no la raz칩n m치s obvia: porque es terriblemente beneficiosa. </font><font style="vertical-align: inherit;">Las buenas soluciones conducen a una reducci칩n m칰ltiple en el tiempo para escribir nuevas funciones, depurarlas y detectar errores. </font><font style="vertical-align: inherit;">Perm칤tanme darles un ejemplo: hace dos d칤as, el cliente tuvo una ejecuci칩n en una nueva caracter칤stica, cuya probabilidad es 1 de 1000, es decir, el control de calidad ser치 torturado para reproducirse, y cuando lo da, son 200 mensajes de error por d칤a. </font><font style="vertical-align: inherit;">쮺u치nto tiempo le llevar치 reproducir la situaci칩n y atrapar al cliente en el punto de interrupci칩n una l칤nea antes de que todo colapse? </font><font style="vertical-align: inherit;">Por ejemplo, tengo 10 minutos.</font></font><br><br><h2>  Modelo </h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 츼rbol modelo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modelo consta de muchos objetos. Los diferentes programadores deciden de manera diferente c칩mo conectarlos. La primera forma es cuando el modelo se identifica por el lugar donde se encuentra. Esto es muy conveniente y simple cuando la referencia al modelo pertenece a un solo lugar en ModelRoot. Quiz치s incluso se pueda cambiar de un lugar a otro, pero dos enlaces de diferentes lugares nunca conducen a 칠l. Haremos esto introduciendo una nueva versi칩n del descriptor ModelProperty que tratar치 los enlaces de un modelo a otros modelos ubicados en 칠l. En el c칩digo, se ver치 as칤:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PModel</span></span></span><span class="hljs-class">&lt;T&gt; :</span></span> Property&lt;T&gt; where T:Model {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cual es la diferencia </font><font style="vertical-align: inherit;">Cuando se agrega un nuevo modelo a este campo, el modelo en el que se agreg칩 se escribe en su campo Principal, y cuando se elimina, el campo Principal se restablece. </font><font style="vertical-align: inherit;">En teor칤a, todo est치 bien, pero hay muchas dificultades. </font><font style="vertical-align: inherit;">El primero, los programadores que lo usar치n, pueden estar equivocados. </font><font style="vertical-align: inherit;">Para evitar esto, imponemos controles ocultos en este proceso, desde diferentes 치ngulos:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arreglaremos PValue para que verifique el tipo de su valor y los expertos lo juren cuando intenten almacenar una referencia al modelo en 칠l, lo que indica que para esto es necesario usar una construcci칩n diferente, solo para no confundirse. </font><font style="vertical-align: inherit;">Esto, por supuesto, es una verificaci칩n de tiempo de ejecuci칩n, pero jura al primer intento de inicio, por lo que lo har치.</font></font></li><li>   PModel       Parent  -  ,       .     .        ,  . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un efecto secundario surge de esto, si necesita cambiar dicho modelo de un lugar a otro, primero debe eliminarlo del primer lugar y solo luego agregarlo al segundo; de lo contrario, los cheques lo rega침ar치n. Pero esto realmente sucede muy raramente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que el modelo se encuentra en un lugar estrictamente definido y tiene una referencia a su padre, podemos agregarle un nuevo m칠todo: puede decir en qu칠 direcci칩n se encuentra en el 치rbol ModelRoot. Esto es extremadamente conveniente para la depuraci칩n, pero tambi칠n es necesario para que pueda identificarse de manera 칰nica. Por ejemplo, busque otro exactamente el mismo modelo en otro mismo estado de juego, o indique en el comando transmitido al servidor un enlace al modelo que contiene el comando. Se parece a esto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelPath</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Property[] properties; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object[] indexes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Model </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelPath path)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">쯏 por qu칠, de hecho, es imposible tener un objeto enraizado en un lugar y referirse a 칠l desde otro? Pero porque imagina que est치 deserializando un objeto de JSON, y aqu칤 encontrar치 un enlace a un objeto enraizado en un lugar completamente diferente. Y todav칤a no hay lugar para eso, solo se crear치 a trav칠s del piso de deserializaci칩n. Ups No ofrezca ninguna deserializaci칩n de varios pasos. Esta es la limitaci칩n de este m칠todo. Por lo tanto, presentaremos un segundo m칠todo:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los modelos creados por el segundo m칠todo se crean en un lugar m치gico, y en todos los dem치s lugares del estado del juego solo se insertan enlaces en ellos. Durante la deserializaci칩n, si hay varias referencias al objeto, la primera vez que accede al lugar m치gico, se crea el objeto y se devuelven todas las referencias posteriores al mismo objeto. Para implementar otras caracter칤sticas, suponemos que el juego puede tener varios estados de juego, por lo que el lugar m치gico no deber칤a ser uno com칰n, sino que deber칤a ubicarse, por ejemplo, en el estado del juego. Para referencias a tales modelos, usamos otra variaci칩n del descriptor persistente PP. El modelo en s칤 ser치 hecho m치s especial por Persistent: Model. En c칩digo, se ver치 m치s o menos as칤:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persistent</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextFreePersistentId { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NEXT_FREE_PERSISTENT_ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { NEXT_FREE_PERSISTENT_ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; NEXT_FREE_PERSISTENT_ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt; PERSISTENT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt;      Id-. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;(int localId) where PersistentT : Persistent, new(); /// &lt;summary&gt; C    Id. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;() where PersistentT : Persistent, new(); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco engorroso, pero se puede usar. </font><font style="vertical-align: inherit;">Para colocar pajillas, Persistent puede sujetar el constructor con el par치metro ModelRoot, lo que generar치 una alarma si intentan crear este modelo no a trav칠s de los m칠todos de este ModelRoot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengo ambas opciones en mi c칩digo, y la pregunta es, 쯣or qu칠 usar la primera opci칩n si la segunda cubre todos los casos posibles? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La respuesta es que el estado del juego debe ser, en primer lugar, legible por las personas. </font><font style="vertical-align: inherit;">쯈u칠 aspecto tiene si, si es posible, se utiliza la primera opci칩n?</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{}, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y ahora, 쯖칩mo ser칤a si solo se usara la segunda opci칩n? </font></font><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para depurar personalmente, prefiero la primera opci칩n. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Acceder a las propiedades del modelo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El acceso a las instalaciones de almacenamiento reactivo para las propiedades al final result칩 estar oculto bajo el cap칩 del modelo. No es demasiado obvio c칩mo hacer que funcione para que funcione r치pidamente, sin demasiado c칩digo en los modelos finales y sin demasiada reflexi칩n. Echemos un vistazo m치s de cerca.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo primero que es 칰til saber sobre el diccionario es que leerlo no toma tanto tiempo constante, independientemente del tama침o del diccionario. Crearemos un diccionario est치tico privado en Model en el que a cada tipo de modelo se le asigne una descripci칩n de los campos que contiene y accederemos a 칠l una vez al construir el modelo. En el constructor de tipos, buscamos para ver si hay una descripci칩n para nuestro tipo, de lo contrario, la creamos, si es as칤, tomamos la terminada. Por lo tanto, la descripci칩n se crear치 solo una vez para cada clase. Al crear una descripci칩n, colocamos en cada propiedad est치tica (descripci칩n del campo) los datos extra칤dos mediante reflexi칩n: el nombre del campo y el 칤ndice bajo el cual el almac칠n de datos para este campo estar치 en la matriz. De esta maneracuando se accede a trav칠s de la descripci칩n del campo, su almacenamiento se eliminar치 de la matriz en un 칤ndice previamente conocido, es decir, r치pidamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el c칩digo, se ver치 as칤: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> :</span></span> IModelInternals { <span class="hljs-meta"><span class="hljs-meta">#region Properties protected static Dictionary</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Type, Property[]&gt; propertiesDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected static Dictionary&lt;Type, Property[]&gt; propertiesForBinarySerializationDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected Property[] _properties, _propertiesForBinarySerialization; protected BaseStorage[] _storages; public Model() { Type targetType = GetType(); if (!propertiesDictionary.ContainsKey(targetType)) RegisterModelsProperties(targetType, new List&lt;Property&gt;(), new List&lt;Property&gt;()); _properties = propertiesDictionary[targetType]; _storages = new BaseStorage[_properties.Length]; for (var i = 0; i &lt; _storages.Length; i++) _storages[i] = _properties[i].CreateStorage(); } private void RegisterModelsProperties(Type target, List&lt;Property&gt; registered, List&lt;Property&gt; registeredForBinary) { if (!propertiesDictionary.ContainsKey(target)) { if (target.BaseType != typeof(Model) &amp;&amp; typeof(Model).IsAssignableFrom(target.BaseType)) RegisterModelsProperties(target.BaseType, registered, registeredForBinary); var fields = target.GetFields(BindingFlags.Public | BindingFlags.Static); // | BindingFlags.DeclaredOnly List&lt;Property&gt; alphabeticSorted = new List&lt;Property&gt;(); for (int i = 0; i &lt; fields.Length; i++) { var field = fields[i]; if (typeof(Property).IsAssignableFrom(field.FieldType)) { var prop = field.GetValue(this) as Property; prop.Name = field.Name; prop.Parent = target; prop.storageIndex = registered.Count; registered.Add(prop); alphabeticSorted.Add(prop); } } alphabeticSorted.Sort((p1, p2) =&gt; String.Compare(p1.Name, p2.Name)); registeredForBinary.AddRange(alphabeticSorted); Property[] properties = new Property[registered.Count]; for (int i = 0; i &lt; registered.Count; i++) properties[i] = registered[i]; propertiesDictionary.Add(target, properties); properties = new Property[registered.Count]; for (int i = 0; i &lt; registeredForBinary.Count; i++) properties[i] = registeredForBinary[i]; propertiesForBinarySerializationDictionary.Add(target, properties); } else { registered.AddRange(propertiesDictionary[target]); registeredForBinary.AddRange(propertiesForBinarySerializationDictionary[target]); } } CastType IModelInternals.GetStorage&lt;CastType&gt;(Property property) { try { return (CastType)_storages[property.storageIndex]; } catch { UnityEngine.Debug.LogError(string.Format("{0}.GetStorage&lt;{1}&gt;({2})",GetType().Name, typeof(CastType).Name, property.ToString())); return null; } } #endregion }</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El dise침o es un poco simple, porque los descriptores de propiedades est치ticas declarados en los antepasados 귻e este modelo ya pueden tener 칤ndices de almacenamiento registrados, y el orden de devoluci칩n de propiedades de Type.GetFields () no est치 garantizado. Para el orden y para que las propiedades no se reinicialicen en dos veces, necesitas controlarte a ti mismo. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Propiedades de colecci칩n </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la secci칩n del 치rbol modelo, se puede observar una construcci칩n que no se mencion칩 anteriormente: PDictionaryModel &lt;int, Persistent&gt;: un descriptor para un campo que contiene una colecci칩n. Est치 claro que tendremos que crear nuestro propio repositorio de colecciones, que almacena informaci칩n sobre c칩mo se ve칤a la colecci칩n antes del inicio de la transacci칩n y c칩mo se ve ahora. El guijarro bajo el agua aqu칤 es del tama침o de una Piedra del Trueno debajo de Peter I. Consiste en el hecho de que, teniendo dos largos diccionarios a mano, es una tarea infernalmente costosa calcular la diferencia entre ellos. Supongo que tales modelos deber칤an usarse para todas las tareas relacionadas con meta, lo que significa que deber칤an funcionar r치pidamente. En lugar de almacenar dos estados, clonarlos y luego compararlos costosamente, hago un enlace complicado: solo el estado actual del diccionario se almacena en la tienda. Otros dos diccionarios son valores eliminados,y valores antiguos de elementos reemplazados. Finalmente, se almacena un conjunto de claves nuevas agregadas al diccionario. Esta informaci칩n se completa f치cil y r치pidamente. Es f치cil generar todas las diferencias necesarias con ella y es suficiente para restaurar el estado anterior si es necesario. En c칩digo, se ve as칤:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictionaryStorage</span></span></span><span class="hljs-class">&lt;TKey, TValues&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; removed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; changedValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HashSet&lt;TKey&gt; newKeys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;TKey&gt;(); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No logr칠 encontrar el mismo dep칩sito maravilloso para la Lista, o no tengo suficiente tiempo, guardo dos copias. Se necesita un complemento adicional para tratar de minimizar el tama침o de la diferencia.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListStorage</span></span></span><span class="hljs-class">&lt;TValue&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; previouse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-comment"><span class="hljs-comment">//        public List&lt;int&gt; order = new List&lt;int&gt;(); //       . }</span></span></code> </pre> <br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si sabe claramente lo que quiere recibir y c칩mo, puede escribir todo esto en unas pocas semanas. La velocidad de desarrollo del juego al mismo tiempo cambia tan dram치ticamente que cuando lo prob칠, ni siquiera comenc칠 mis propios juegos de creaci칩n de juegos sin tener un buen motor. Solo porque en el primer mes la inversi칩n en 칠l para m칤 obviamente vali칩 la pena. Por supuesto, esto solo se aplica al meta. La jugabilidad debe hacerse a la antigua usanza. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la siguiente parte del art칤culo, hablar칠 sobre comandos, redes y predicci칩n de respuestas del servidor. Y tambi칠n tengo algunas preguntas para ti que son muy importantes para m칤. Si sus respuestas difieren de las que figuran entre par칠ntesis, con gusto las leer칠 en los comentarios o tal vez incluso escriba un art칤culo. Gracias de antemano por las respuestas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PD Una propuesta de cooperaci칩n e instrucciones sobre numerosos errores de sintaxis, por favor en PM. </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434582/">https://habr.com/ru/post/es434582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434570/index.html">Simulador minimalista en l칤nea de circuitos lineales de CC y CA</a></li>
<li><a href="../es434574/index.html">Animaci칩n de subrayado de enlace CSS puro</a></li>
<li><a href="../es434576/index.html">Trabajar con la API de KOMPAS-3D  Lecci칩n 14  Texto multil칤nea</a></li>
<li><a href="../es434578/index.html">Higiene digital: las reglas del juego</a></li>
<li><a href="../es434580/index.html">Estad칤sticas de tostadoras 2018</a></li>
<li><a href="../es434584/index.html">Los datos son divertidos (y aqu칤 hay algunos ejemplos)</a></li>
<li><a href="../es434586/index.html">Aviones personales. Comprende y espera</a></li>
<li><a href="../es434588/index.html">Resumiendo el a침o 2018 en My Circle</a></li>
<li><a href="../es434590/index.html">$ ls -l / home / avitotech / new_year</a></li>
<li><a href="../es434592/index.html">Elon Musk promete cubrir Europa con la red Tesla Supercharger el pr칩ximo a침o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>