<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò© üëàüèø üî≥ Soluciones arquitect√≥nicas para un juego m√≥vil. Parte 1: modelo üèª üë®üèø üåã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ep√≠grafe: 
 - ¬øC√≥mo evaluar√© si no sabes qu√© hacer? 
 - Bueno, habr√° pantallas y botones. 
 - Dima, ¬°ahora has descrito toda mi vida en tres palabras!...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soluciones arquitect√≥nicas para un juego m√≥vil. Parte 1: modelo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434582/">  <i>Ep√≠grafe:</i> <i><br></i>  <i>- ¬øC√≥mo evaluar√© si no sabes qu√© hacer?</i> <i><br></i>  <i>- Bueno, habr√° pantallas y botones.</i> <i><br></i>  <i>- Dima, ¬°ahora has descrito toda mi vida en tres palabras!</i> <i><br></i>  <i>(c) Di√°logo real en un mitin en una empresa de juegos</i> <br><br><img src="https://habrastorage.org/webt/zp/ab/js/zpabjszvfb5gcancgd76i5trlz8.jpeg"><br><br>  El conjunto de necesidades y las soluciones que las satisfacen, que analizar√© en este art√≠culo, se formaron durante mi participaci√≥n en aproximadamente una docena de grandes proyectos, primero en Flash y luego en Unity.  El mayor de los proyectos ten√≠a m√°s de 200,000 DAU y complement√≥ mi hucha con nuevos desaf√≠os originales.  Por otro lado, se confirm√≥ la relevancia y la necesidad de hallazgos anteriores. <br><br>  En nuestra dura realidad, todos los que han dise√±ado al menos una vez un gran proyecto, al menos en sus pensamientos, tienen sus propias ideas sobre c√≥mo hacerlo, y a menudo est√°n listos para defender sus ideas hasta la √∫ltima gota de sangre.  Para otros, me hace sonre√≠r, y la gerencia a menudo ve todo esto como una gran caja negra que no ha descansado contra nadie.  Pero, ¬øqu√© sucede si le digo que las soluciones correctas ayudar√°n a reducir la creaci√≥n de nuevas funcionalidades en 2-3 veces, la b√∫squeda de errores en las antiguas 5-10 veces y le permitir√°n hacer muchas cosas nuevas e importantes que antes no estaban disponibles?  ¬°Es suficiente dejar que la arquitectura entre en tu coraz√≥n! <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect√≥nicas para un juego m√≥vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2: Comando y sus colas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect√≥nicas para un juego m√≥vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3: Ver en el empuje del jet</a> <br><a name="habracut"></a><br><br><h2>  Modelo </h2><br><h3>  Acceso a los campos </h3><br>  La mayor√≠a de los programadores reconocen la importancia de usar algo como MVC.  Pocas personas usan MVC puro del libro de una pandilla de cuatro, pero todas las decisiones de las oficinas normales son de alguna manera similares a este patr√≥n en esp√≠ritu.  Hoy hablaremos sobre la primera de las letras en esta abreviatura.  Debido a que una gran parte del trabajo de los programadores en un juego m√≥vil son nuevas caracter√≠sticas en el metajuego, implementadas como manipulaciones con el modelo, y atornillando miles de interfaces en estas caracter√≠sticas.  Y la conveniencia del modelo juega un papel clave en esta lecci√≥n. <br><br>  No proporciono el c√≥digo completo, porque es un poco tonto, y en general no se trata de √©l.  Ilustrar√© mi razonamiento con un ejemplo simple: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory; <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } }</code> </pre> <br>  Esta opci√≥n no nos conviene en absoluto, porque el modelo no env√≠a eventos sobre los cambios que ocurren en √©l.  Si la informaci√≥n sobre qu√© campos se vieron afectados por los cambios, y cu√°les no, y cu√°les necesitan ser redibujados y cu√°les no, el programador lo indicar√° manualmente de una forma u otra, esta se convertir√° en la principal fuente de errores y tiempo invertido.  Y simplemente no tengo que mirar con sorpresa: en la mayor√≠a de las grandes oficinas en las que trabaj√©, el programador envi√≥ todo tipo de InventoryUpdatedEvent y, en algunos casos, tambi√©n los llen√≥ manualmente.  Algunas de estas oficinas han hecho millones, ¬øcrees que, gracias o a pesar de eso? <br><br>  Usaremos nuestra propia clase ReactiveProperty &lt;T&gt; que ocultar√° debajo del cap√≥ todas las manipulaciones para enviar mensajes que necesitamos.  Se ver√° m√°s o menos as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;InventoryModel&gt; inventory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;InventoryModel&gt;(); <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money.Value = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.Value.capacity.Value++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ money.SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta es la primera versi√≥n del modelo.  Esta opci√≥n ya es un sue√±o para muchos programadores, pero todav√≠a no me gusta.  Lo primero que no me gusta es que acceder a los valores es complicado.  Me las arregl√© para confundirme mientras escrib√≠a este ejemplo, olvidando Value en un lugar, y son precisamente estas manipulaciones de datos las que constituyen la mayor parte de todo lo que se hace y se confunde con el modelo.  Si est√° utilizando la versi√≥n de idioma 4.x, puede hacer esto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;();</code> </pre> <br>  Pero esto no resuelve todos los problemas.  Me gustar√≠a escribir simplemente: Inventory.capacity ++;.  Supongamos que intentamos obtener para cada campo modelo;  conjunto  Pero para suscribirse a eventos, tambi√©n necesitamos acceso a ReactiveProperty.  Claro inconveniente y fuente de confusi√≥n.  A pesar de que solo necesitamos indicar qu√© campo vamos a monitorear.  Y aqu√≠ se me ocurri√≥ una maniobra complicada que me gust√≥. <br><br>  A ver si te gusta. <br><br>  No se inserta ReactiveProperty en el modelo concreto con el que est√° tratando el programador, se inserta, pero su descriptor est√°tico PValue, el heredero de la propiedad m√°s general, identifica el campo, y dentro del cap√≥ del constructor del modelo se oculta la creaci√≥n y el almacenamiento de la ReactiveProperty del tipo deseado.  No es el mejor nombre, pero sucedi√≥, luego cambi√≥ de nombre. <br><br>  En c√≥digo, se ve as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; MONEY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MONEY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { MONEY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Get(MONEY).SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta es la segunda opci√≥n.  El antepasado general del Modelo, por supuesto, fue complicado a expensas de crear y extraer una Propiedad Reactiva real de acuerdo con su descriptor, pero esto se puede hacer muy r√°pidamente y sin reflexi√≥n, o m√°s bien, aplicando la reflexi√≥n solo una vez en la etapa de inicializaci√≥n de la clase.  Y este es el trabajo que realiza una vez el creador del motor, y luego ser√° utilizado por todos.  Adem√°s, este dise√±o evita intentos accidentales de manipular ReactiveProperty en lugar de los valores almacenados en √©l.  La creaci√≥n del campo est√° abarrotada, pero en todos los casos es exactamente la misma y se puede crear con una plantilla. <br><br>  Al final del art√≠culo hay una encuesta que opci√≥n le gusta m√°s. <br>  Todo lo que se describe a continuaci√≥n se puede implementar en ambas versiones. <br><br><h3>  Transacciones </h3><br>  Quiero que los programadores puedan cambiar los campos del modelo solo cuando las restricciones adoptadas en el motor lo permitan, es decir, dentro del equipo, y nunca m√°s.  Para hacer esto, el configurador debe ir a alg√∫n lado y verificar si el comando de transacci√≥n est√° actualmente abierto, y solo entonces permitir que la informaci√≥n se edite en el modelo.  Esto es muy necesario, porque los usuarios del motor regularmente intentan hacer algo extra√±o para evitar un proceso t√≠pico, rompiendo la l√≥gica del motor y causando errores sutiles.  Vi esto m√°s de una o dos veces. <br><br>  Existe la creencia de que si crea una interfaz separada para leer datos del modelo y para escribir, de alguna manera ser√° √∫til.  En realidad, el modelo est√° cubierto de archivos adicionales y tediosas operaciones adicionales.  Estas restricciones son finales. Los programadores se ven obligados, en primer lugar, a conocerlos y pensar constantemente sobre ellos: "lo que cada funci√≥n espec√≠fica, modelo o interfaz debe dar", y en segundo lugar, las situaciones tambi√©n surgen cuando estas restricciones deben ser sorteadas, a la salida tenemos a D'Artagnan, quien se le ocurri√≥ todo esto en blanco, y muchos usuarios de su motor, que son malos guardianes del Project Manager, y a pesar de los constantes abusos, nada funciona seg√∫n lo previsto.  Por lo tanto, prefiero bloquear estrictamente la posibilidad de tal error.  Reduzca la dosis de convenciones, por as√≠ decirlo. <br><br>  El configurador ReactiveProperty debe tener un enlace al lugar donde se debe verificar el estado actual de la transacci√≥n.  Digamos que este lugar es classCModelRoot.  La opci√≥n m√°s f√°cil es pasarlo expl√≠citamente al constructor del modelo.  La segunda versi√≥n del c√≥digo al llamar a RProperty recibe un enlace a esto expl√≠citamente, y puede obtener toda la informaci√≥n necesaria desde all√≠.  Para la primera versi√≥n del c√≥digo, tendr√° que correr alrededor de los campos del tipo ReactiveProperty en el constructor con una reflexi√≥n y darles un enlace a este para futuras manipulaciones.  Un peque√±o inconveniente es la necesidad de crear un constructor expl√≠cito con un par√°metro en cada modelo, algo como esto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot gamestate)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gamestate)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  Pero para otras caracter√≠sticas de los modelos, es muy √∫til que el modelo tenga un enlace con el modelo padre, formando una construcci√≥n bicon√©cta.  En nuestro ejemplo, este ser√° player.inventory.Parent == player.  Y entonces este constructor puede ser evitado.  Cualquier modelo podr√° obtener y almacenar en cach√© un enlace a un lugar m√°gico de su padre, y ese de su padre, y as√≠ sucesivamente hasta que el pr√≥ximo padre resulte ser ese lugar m√°gico.  Como resultado, a nivel de declaraciones, todo esto se ver√° as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Model Parent { get; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ModelRoot Root { get; } }</code> </pre> <br>  Toda esta belleza se llenar√° autom√°ticamente cuando la modelo entre al √°rbol del estado del juego.  S√≠, el modelo reci√©n creado, que a√∫n no ha llegado all√≠, no podr√° aprender sobre la transacci√≥n y bloquear las manipulaciones consigo mismo, pero si el estado de la transacci√≥n est√° prohibido, no podr√° ingresar al estado despu√©s de eso, el configurador del futuro padre no lo permitir√°, por lo que la integridad del estado del juego no se ver√° afectada.  S√≠, esto requerir√° un trabajo adicional en la etapa de programaci√≥n del motor, pero por otro lado, un programador que usa el motor eliminar√° por completo la necesidad de saberlo y pensarlo hasta que intente hacer algo mal y lo ponga en sus manos. <br><br>  Dado que la conversaci√≥n sobre la actividad ha comenzado, los mensajes sobre los cambios no deben procesarse inmediatamente despu√©s de realizar el cambio, sino solo cuando se completan todas las manipulaciones con el modelo dentro del comando actual.  Hay dos razones para esto, la primera es la coherencia de los datos. No todos los estados de datos son coherentes internamente. Quiz√°s no pueda intentar renderizarlos.  O si est√° impaciente, por ejemplo, para ordenar una matriz o cambiar alguna variable de modelo en un bucle.  No debe recibir cientos de mensajes de cambio. <br><br>  Hay dos formas de hacer esto.  El primero es suscribirse a las actualizaciones de una variable y usar una funci√≥n complicada que agrega una secuencia de terminaciones de transacciones a la secuencia de cambios en la variable y solo despu√©s saltar√° los mensajes.  Esto es bastante f√°cil de hacer si est√° utilizando UniRX, por ejemplo.  Pero esta opci√≥n tiene muchas deficiencias, en particular genera muchos movimientos innecesarios.  Personalmente, me gusta la otra opci√≥n. <br><br>  Cada propiedad reactiva recordar√° su estado antes del inicio de la transacci√≥n y su estado actual.  Solo se enviar√° un mensaje sobre el cambio y la fijaci√≥n de los cambios al final de la transacci√≥n.  En el caso de que el objeto del cambio fuera alg√∫n tipo de recopilaci√≥n, esto permitir√° incluir expl√≠citamente informaci√≥n sobre los cambios que ocurrieron en el mensaje enviado, por ejemplo, se agregaron esos dos elementos en la lista y se eliminaron.  En lugar de decir simplemente que algo ha cambiado y obligar al destinatario a analizar una lista de mil elementos de longitud en busca de informaci√≥n que necesita ser redibujada. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatchChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command transaction)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RevertChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br>  La opci√≥n lleva m√°s tiempo en la etapa de creaci√≥n del motor, pero el costo de uso es m√°s bajo.  Y lo m√°s importante, abre la posibilidad de la pr√≥xima mejora. <br><br><h3>  Informaci√≥n sobre los cambios realizados en el modelo. </h3><br>  Quiero m√°s del modelo.  En cualquier momento quiero ver f√°cil y convenientemente qu√© ha cambiado en el estado del modelo como resultado de mis acciones.  Por ejemplo, de esta forma: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>}}}</code> </pre> <br>  Muy a menudo, es √∫til para el programador ver la diferencia entre el estado del modelo antes del inicio del comando y despu√©s de su finalizaci√≥n, o en alg√∫n punto dentro del comando.  Algunos para este clon de todo el estado del juego antes del inicio del equipo, y luego comparar.  Esto resuelve parcialmente el problema en la etapa de depuraci√≥n, pero es absolutamente imposible ejecutar esto en el producto.  Esa clonaci√≥n estatal, que calcular la diferencia insignificante entre las dos listas, es una operaci√≥n monstruosamente costosa de hacer con cualquier estornudo. <br><br>  Por lo tanto, ReactiveProperty debe almacenar no solo su estado actual, sino tambi√©n el anterior.  Esto da lugar a todo un grupo de oportunidades extremadamente √∫tiles.  En primer lugar, la extracci√≥n de la diferencia en tal situaci√≥n es r√°pida, y podemos volcarlo tranquilamente en la comida.  En segundo lugar, no puede obtener un diferencial voluminoso, sino un peque√±o hash compacto de los cambios, y compararlo con un hash de cambios en otro mismo estado de juego.  Si no est√° de acuerdo, tienes problemas.  En tercer lugar, si la ejecuci√≥n del comando cay√≥ con la ejecuci√≥n, siempre puede cancelar los cambios y averiguar sobre el estado intacto en el momento en que comenz√≥ la transacci√≥n.  Junto con el equipo aplicado al estado, esta informaci√≥n es invaluable porque puede reproducir f√°cilmente la situaci√≥n con precisi√≥n.  Por supuesto, para esto necesitas tener una funcionalidad preparada para una serializaci√≥n y deserializaci√≥n conveniente del estado del juego, pero la necesitar√°s de todos modos. <br><br><h3>  Serializaci√≥n de cambios de modelo </h3><br>  El motor proporciona serializaci√≥n y binario, y en json, y esto no es accidental.  Por supuesto, la serializaci√≥n binaria ocupa mucho menos espacio y funciona mucho m√°s r√°pido, lo cual es importante, especialmente durante el arranque inicial.  Pero este no es un formato legible por humanos, y aqu√≠ oramos por la conveniencia de la depuraci√≥n.  Adem√°s, hay otra trampa.  Cuando su juego vaya a producci√≥n, deber√° cambiar constantemente de una versi√≥n a otra.  Si sus programadores siguen algunas precauciones simples y no eliminan nada del estado del juego innecesariamente, no sentir√°n esta transici√≥n.  Y en el formato binario, no hay nombres de cadena de campo por razones obvias, y si las versiones no coinciden, tendr√° que leer el binario con la versi√≥n anterior del estado, exportarlo a algo m√°s informativo, por ejemplo, el mismo json, luego importarlo a un nuevo estado, exportarlo al binario, anote, y solo despu√©s de todo este trabajo, como de costumbre.  Como resultado, en algunos proyectos, las configuraciones se escriben en los archivos binarios en vista de sus tama√±os cicl√≥peos, y ya prefieren arrastrar el estado hacia adelante y hacia atr√°s en forma de json.  Evaluar gastos generales y elegirlo. <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    ,    } /**    */ public partial class Model { public bool GetHashCode(ExportMode mode, out int code); public bool Import(BinaryReader binarySerialization); public bool Import(JSONReader json); public void ExportAll(ExportMode mode, BinaryWriter binarySerialization); public void ExportAll(ExportMode mode, JSONWriter json); public bool Export(ExportMode mode, out Dictionary&lt;string, object&gt; data); }</span></span></code> </pre> <br>  La firma del m√©todo Exportar (modo ExportMode, fuera de los datos del Diccionario &lt;cadena, objeto&gt;) es algo alarmante.  Y la cuesti√≥n es esta: cuando serializa todo el √°rbol, puede escribir directamente en la secuencia, o en nuestro caso, en JSONWriter, que es un complemento simple para StringWriter.  Pero cuando exporta cambios, no es tan simple, porque cuando se adentra en un √°rbol y se adentra en una de las ramas, todav√≠a no sabe si exportar algo de √©l.  Por lo tanto, en esta etapa se me ocurrieron dos soluciones, una m√°s simple, la segunda m√°s complicada y econ√≥mica.  Una m√°s simple es que al exportar solo cambios, convierte todos los cambios en un √°rbol desde Diccionario &lt;cadena, objeto&gt; y Lista &lt;objeto&gt;.  Y luego, qu√© pas√≥, alimente a su serializador favorito.  Este es un enfoque simple que no requiere bailar con una pandereta.  Pero su inconveniente es que en el proceso de exportaci√≥n de cambios al mont√≥n, se asignar√° un lugar para las colecciones √∫nicas.  De hecho, no hay mucho espacio, porque esta exportaci√≥n completa da un gran √°rbol, y el comando t√≠pico deja muy pocos cambios en el √°rbol. <br><br>  Sin embargo, muchas personas creen que alimentar al recolector de basura como ese troll no es necesario sin una necesidad extrema.  Para ellos, y para calmar mi conciencia, prepar√© una soluci√≥n m√°s compleja: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newModel = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Stack&lt;Model&gt; ierarchyChanged = null)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, Queue&lt;Model&gt; ierarchyChanges = null)</span></span></span></span>; }</code> </pre> <br>  La esencia de este m√©todo es caminar dos veces por el √°rbol.  Por primera vez, vea todos los modelos que se han modificado a s√≠ mismos, o que tienen cambios en los modelos secundarios, y escr√≠balos todos en Cola &lt;Modelo&gt; ierarchyChanges exactamente en el orden en que aparecen en el √°rbol en su estado actual.  No hay muchos cambios, la cola no ser√° larga.  Adem√°s, nada impide mantener Stack &lt;Model&gt; y Queue &lt;Model&gt; entre llamadas y luego habr√° muy pocas asignaciones durante la llamada. <br><br>  Y ya pasando la segunda vez a trav√©s del √°rbol, ser√° posible mirar la parte superior de la cola cada vez y comprender si es necesario entrar en esta rama del √°rbol o seguir de inmediato.  Esto permite que JSONWriter escriba inmediatamente sin devolver ning√∫n otro resultado intermedio. <br><br>  Es muy probable que esta complicaci√≥n no sea realmente necesaria, porque m√°s adelante ver√° que exportar los cambios al √°rbol que necesita solo para la depuraci√≥n o cuando se bloquea con Exception.  Durante el funcionamiento normal, todo se limita a GetHashCode (modo ExportMode, out int code) al que todas estas delicias son profundamente ajenas. <br><br>  Antes de continuar complicando nuestro modelo, hablemos de esto. <br><br><h2>  ¬øPor qu√© es tan importante? </h2><br>  Todos los programadores dicen que esto es terriblemente importante, pero generalmente nadie les cree.  Por qu√© <br><br>  En primer lugar, porque todos los programadores dicen que debes tirar lo viejo y escribir lo nuevo.  Eso es todo, independientemente de las calificaciones.  No existe una forma administrativa de averiguar si esto es cierto o no, y los experimentos suelen ser demasiado caros.  El gerente se ver√° obligado a elegir un programador y confiar en su juicio.  El problema es que ese asesor suele ser aquel con quien la gerencia ha estado trabajando durante mucho tiempo y lo eval√∫a en funci√≥n de si fue capaz de realizar sus ideas, y todas sus mejores ideas ya est√°n plasmadas en la realidad.  Por lo tanto, esta tampoco es una forma ideal de descubrir qu√© tan buenas son las ideas ajenas y diferentes. <br><br>  En segundo lugar, el 80% de todos los juegos m√≥viles traen menos de $ 500 en toda su vida.  Por lo tanto, al comienzo del proyecto, la administraci√≥n tiene otros problemas, m√°s importante la arquitectura.  Pero las decisiones tomadas al comienzo del proyecto toman a la gente como rehenes y no la dejan pasar de seis meses a tres a√±os.  El proceso de refactorizaci√≥n y cambio a otras ideas en un proyecto que ya funciona, que tambi√©n tiene clientes, es un negocio muy dif√≠cil, costoso y arriesgado.  Si para un proyecto desde el principio, invertir tres meses-hombre en una arquitectura normal parece un lujo inadmisible, entonces, ¬øqu√© puede decir sobre el costo de retrasar la actualizaci√≥n con nuevas caracter√≠sticas durante un par de meses? <br><br>  En tercer lugar, incluso si la idea de "c√≥mo deber√≠a ser" en s√≠ misma es buena e ideal, no se sabe cu√°nto tiempo llevar√° su implementaci√≥n.  La dependencia del tiempo dedicado a la frescura del programador es muy no lineal.  El se√±or har√° una tarea simple no mucho m√°s r√°pida que la junior.  Una vez y media, tal vez.  Pero cada programador tiene su propio "l√≠mite de complejidad", m√°s all√° del cual su efectividad cae dram√°ticamente.  Tuve un caso en mi vida en el que necesitaba realizar una tarea arquitect√≥nica bastante complicada, e incluso concentrarme completamente en el problema de apagar Internet en la casa y pedir comidas preparadas por un mes no ayud√≥, pero dos a√±os despu√©s, despu√©s de leer libros interesantes y resolver tareas relacionadas Resolv√≠ este problema en tres d√≠as.  Estoy seguro de que todos recordar√°n algo as√≠ en su carrera.  Y aqu√≠ est√° el truco!  El hecho es que si se le ocurri√≥ una idea ingeniosa como deber√≠a ser, entonces lo m√°s probable es que esta nueva idea est√© en alg√∫n lugar de su l√≠mite personal de complejidad, y tal vez incluso un poco detr√°s.  La gerencia, que se ha quemado en repetidas ocasiones sobre eso, comienza a soplar cualquier idea nueva.  Y si haces el juego por ti mismo, el resultado puede ser a√∫n peor, porque no habr√° nadie que te detenga. <br><br>  Pero, ¬øc√≥mo, entonces, alguien logra usar buenas soluciones?  Hay varias formas <br><br>  En primer lugar, cada compa√±√≠a quiere contratar a una persona preparada que ya haya hecho esto con un empleador anterior.  Esta es la forma m√°s com√∫n de transferir la carga de la experimentaci√≥n a otra persona. <br><br>  En segundo lugar, las empresas o personas que hicieron su primer juego exitoso, sorbieron y comenzaron el pr√≥ximo proyecto est√°n listos para los cambios. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tercer lugar, honestamente adm√≠tete a ti mismo que a veces haces algo no por el salario, sino por el placer del proceso. Lo principal es encontrar tiempo para esto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarto, es un conjunto de soluciones y bibliotecas comprobadas, junto con personas, que constituyen los fondos principales de la compa√±√≠a de juegos, y esto es lo √∫nico que permanecer√° en √©l cuando alguna persona clave se vaya y se mude a Australia.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La √∫ltima, aunque no la raz√≥n m√°s obvia: porque es terriblemente beneficiosa. </font><font style="vertical-align: inherit;">Las buenas soluciones conducen a una reducci√≥n m√∫ltiple en el tiempo para escribir nuevas funciones, depurarlas y detectar errores. </font><font style="vertical-align: inherit;">Perm√≠tanme darles un ejemplo: hace dos d√≠as, el cliente tuvo una ejecuci√≥n en una nueva caracter√≠stica, cuya probabilidad es 1 de 1000, es decir, el control de calidad ser√° torturado para reproducirse, y cuando lo da, son 200 mensajes de error por d√≠a. </font><font style="vertical-align: inherit;">¬øCu√°nto tiempo le llevar√° reproducir la situaci√≥n y atrapar al cliente en el punto de interrupci√≥n una l√≠nea antes de que todo colapse? </font><font style="vertical-align: inherit;">Por ejemplo, tengo 10 minutos.</font></font><br><br><h2>  Modelo </h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √Årbol modelo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modelo consta de muchos objetos. Los diferentes programadores deciden de manera diferente c√≥mo conectarlos. La primera forma es cuando el modelo se identifica por el lugar donde se encuentra. Esto es muy conveniente y simple cuando la referencia al modelo pertenece a un solo lugar en ModelRoot. Quiz√°s incluso se pueda cambiar de un lugar a otro, pero dos enlaces de diferentes lugares nunca conducen a √©l. Haremos esto introduciendo una nueva versi√≥n del descriptor ModelProperty que tratar√° los enlaces de un modelo a otros modelos ubicados en √©l. En el c√≥digo, se ver√° as√≠:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PModel</span></span></span><span class="hljs-class">&lt;T&gt; :</span></span> Property&lt;T&gt; where T:Model {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cual es la diferencia </font><font style="vertical-align: inherit;">Cuando se agrega un nuevo modelo a este campo, el modelo en el que se agreg√≥ se escribe en su campo Principal, y cuando se elimina, el campo Principal se restablece. </font><font style="vertical-align: inherit;">En teor√≠a, todo est√° bien, pero hay muchas dificultades. </font><font style="vertical-align: inherit;">El primero, los programadores que lo usar√°n, pueden estar equivocados. </font><font style="vertical-align: inherit;">Para evitar esto, imponemos controles ocultos en este proceso, desde diferentes √°ngulos:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arreglaremos PValue para que verifique el tipo de su valor y los expertos lo juren cuando intenten almacenar una referencia al modelo en √©l, lo que indica que para esto es necesario usar una construcci√≥n diferente, solo para no confundirse. </font><font style="vertical-align: inherit;">Esto, por supuesto, es una verificaci√≥n de tiempo de ejecuci√≥n, pero jura al primer intento de inicio, por lo que lo har√°.</font></font></li><li>   PModel       Parent  -  ,       .     .        ,  . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un efecto secundario surge de esto, si necesita cambiar dicho modelo de un lugar a otro, primero debe eliminarlo del primer lugar y solo luego agregarlo al segundo; de lo contrario, los cheques lo rega√±ar√°n. Pero esto realmente sucede muy raramente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que el modelo se encuentra en un lugar estrictamente definido y tiene una referencia a su padre, podemos agregarle un nuevo m√©todo: puede decir en qu√© direcci√≥n se encuentra en el √°rbol ModelRoot. Esto es extremadamente conveniente para la depuraci√≥n, pero tambi√©n es necesario para que pueda identificarse de manera √∫nica. Por ejemplo, busque otro exactamente el mismo modelo en otro mismo estado de juego, o indique en el comando transmitido al servidor un enlace al modelo que contiene el comando. Se parece a esto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelPath</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Property[] properties; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object[] indexes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Model </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelPath path)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY por qu√©, de hecho, es imposible tener un objeto enraizado en un lugar y referirse a √©l desde otro? Pero porque imagina que est√° deserializando un objeto de JSON, y aqu√≠ encontrar√° un enlace a un objeto enraizado en un lugar completamente diferente. Y todav√≠a no hay lugar para eso, solo se crear√° a trav√©s del piso de deserializaci√≥n. Ups No ofrezca ninguna deserializaci√≥n de varios pasos. Esta es la limitaci√≥n de este m√©todo. Por lo tanto, presentaremos un segundo m√©todo:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los modelos creados por el segundo m√©todo se crean en un lugar m√°gico, y en todos los dem√°s lugares del estado del juego solo se insertan enlaces en ellos. Durante la deserializaci√≥n, si hay varias referencias al objeto, la primera vez que accede al lugar m√°gico, se crea el objeto y se devuelven todas las referencias posteriores al mismo objeto. Para implementar otras caracter√≠sticas, suponemos que el juego puede tener varios estados de juego, por lo que el lugar m√°gico no deber√≠a ser uno com√∫n, sino que deber√≠a ubicarse, por ejemplo, en el estado del juego. Para referencias a tales modelos, usamos otra variaci√≥n del descriptor persistente PP. El modelo en s√≠ ser√° hecho m√°s especial por Persistent: Model. En c√≥digo, se ver√° m√°s o menos as√≠:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persistent</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextFreePersistentId { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NEXT_FREE_PERSISTENT_ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { NEXT_FREE_PERSISTENT_ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; NEXT_FREE_PERSISTENT_ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt; PERSISTENT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt;      Id-. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;(int localId) where PersistentT : Persistent, new(); /// &lt;summary&gt; C    Id. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;() where PersistentT : Persistent, new(); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco engorroso, pero se puede usar. </font><font style="vertical-align: inherit;">Para colocar pajillas, Persistent puede sujetar el constructor con el par√°metro ModelRoot, lo que generar√° una alarma si intentan crear este modelo no a trav√©s de los m√©todos de este ModelRoot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengo ambas opciones en mi c√≥digo, y la pregunta es, ¬øpor qu√© usar la primera opci√≥n si la segunda cubre todos los casos posibles? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La respuesta es que el estado del juego debe ser, en primer lugar, legible por las personas. </font><font style="vertical-align: inherit;">¬øQu√© aspecto tiene si, si es posible, se utiliza la primera opci√≥n?</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{}, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y ahora, ¬øc√≥mo ser√≠a si solo se usara la segunda opci√≥n? </font></font><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para depurar personalmente, prefiero la primera opci√≥n. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Acceder a las propiedades del modelo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El acceso a las instalaciones de almacenamiento reactivo para las propiedades al final result√≥ estar oculto bajo el cap√≥ del modelo. No es demasiado obvio c√≥mo hacer que funcione para que funcione r√°pidamente, sin demasiado c√≥digo en los modelos finales y sin demasiada reflexi√≥n. Echemos un vistazo m√°s de cerca.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo primero que es √∫til saber sobre el diccionario es que leerlo no toma tanto tiempo constante, independientemente del tama√±o del diccionario. Crearemos un diccionario est√°tico privado en Model en el que a cada tipo de modelo se le asigne una descripci√≥n de los campos que contiene y accederemos a √©l una vez al construir el modelo. En el constructor de tipos, buscamos para ver si hay una descripci√≥n para nuestro tipo, de lo contrario, la creamos, si es as√≠, tomamos la terminada. Por lo tanto, la descripci√≥n se crear√° solo una vez para cada clase. Al crear una descripci√≥n, colocamos en cada propiedad est√°tica (descripci√≥n del campo) los datos extra√≠dos mediante reflexi√≥n: el nombre del campo y el √≠ndice bajo el cual el almac√©n de datos para este campo estar√° en la matriz. De esta maneracuando se accede a trav√©s de la descripci√≥n del campo, su almacenamiento se eliminar√° de la matriz en un √≠ndice previamente conocido, es decir, r√°pidamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el c√≥digo, se ver√° as√≠: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> :</span></span> IModelInternals { <span class="hljs-meta"><span class="hljs-meta">#region Properties protected static Dictionary</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Type, Property[]&gt; propertiesDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected static Dictionary&lt;Type, Property[]&gt; propertiesForBinarySerializationDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected Property[] _properties, _propertiesForBinarySerialization; protected BaseStorage[] _storages; public Model() { Type targetType = GetType(); if (!propertiesDictionary.ContainsKey(targetType)) RegisterModelsProperties(targetType, new List&lt;Property&gt;(), new List&lt;Property&gt;()); _properties = propertiesDictionary[targetType]; _storages = new BaseStorage[_properties.Length]; for (var i = 0; i &lt; _storages.Length; i++) _storages[i] = _properties[i].CreateStorage(); } private void RegisterModelsProperties(Type target, List&lt;Property&gt; registered, List&lt;Property&gt; registeredForBinary) { if (!propertiesDictionary.ContainsKey(target)) { if (target.BaseType != typeof(Model) &amp;&amp; typeof(Model).IsAssignableFrom(target.BaseType)) RegisterModelsProperties(target.BaseType, registered, registeredForBinary); var fields = target.GetFields(BindingFlags.Public | BindingFlags.Static); // | BindingFlags.DeclaredOnly List&lt;Property&gt; alphabeticSorted = new List&lt;Property&gt;(); for (int i = 0; i &lt; fields.Length; i++) { var field = fields[i]; if (typeof(Property).IsAssignableFrom(field.FieldType)) { var prop = field.GetValue(this) as Property; prop.Name = field.Name; prop.Parent = target; prop.storageIndex = registered.Count; registered.Add(prop); alphabeticSorted.Add(prop); } } alphabeticSorted.Sort((p1, p2) =&gt; String.Compare(p1.Name, p2.Name)); registeredForBinary.AddRange(alphabeticSorted); Property[] properties = new Property[registered.Count]; for (int i = 0; i &lt; registered.Count; i++) properties[i] = registered[i]; propertiesDictionary.Add(target, properties); properties = new Property[registered.Count]; for (int i = 0; i &lt; registeredForBinary.Count; i++) properties[i] = registeredForBinary[i]; propertiesForBinarySerializationDictionary.Add(target, properties); } else { registered.AddRange(propertiesDictionary[target]); registeredForBinary.AddRange(propertiesForBinarySerializationDictionary[target]); } } CastType IModelInternals.GetStorage&lt;CastType&gt;(Property property) { try { return (CastType)_storages[property.storageIndex]; } catch { UnityEngine.Debug.LogError(string.Format("{0}.GetStorage&lt;{1}&gt;({2})",GetType().Name, typeof(CastType).Name, property.ToString())); return null; } } #endregion }</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El dise√±o es un poco simple, porque los descriptores de propiedades est√°ticas declarados en los antepasados ‚Äã‚Äãde este modelo ya pueden tener √≠ndices de almacenamiento registrados, y el orden de devoluci√≥n de propiedades de Type.GetFields () no est√° garantizado. Para el orden y para que las propiedades no se reinicialicen en dos veces, necesitas controlarte a ti mismo. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Propiedades de colecci√≥n </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la secci√≥n del √°rbol modelo, se puede observar una construcci√≥n que no se mencion√≥ anteriormente: PDictionaryModel &lt;int, Persistent&gt;: un descriptor para un campo que contiene una colecci√≥n. Est√° claro que tendremos que crear nuestro propio repositorio de colecciones, que almacena informaci√≥n sobre c√≥mo se ve√≠a la colecci√≥n antes del inicio de la transacci√≥n y c√≥mo se ve ahora. El guijarro bajo el agua aqu√≠ es del tama√±o de una Piedra del Trueno debajo de Peter I. Consiste en el hecho de que, teniendo dos largos diccionarios a mano, es una tarea infernalmente costosa calcular la diferencia entre ellos. Supongo que tales modelos deber√≠an usarse para todas las tareas relacionadas con meta, lo que significa que deber√≠an funcionar r√°pidamente. En lugar de almacenar dos estados, clonarlos y luego compararlos costosamente, hago un enlace complicado: solo el estado actual del diccionario se almacena en la tienda. Otros dos diccionarios son valores eliminados,y valores antiguos de elementos reemplazados. Finalmente, se almacena un conjunto de claves nuevas agregadas al diccionario. Esta informaci√≥n se completa f√°cil y r√°pidamente. Es f√°cil generar todas las diferencias necesarias con ella y es suficiente para restaurar el estado anterior si es necesario. En c√≥digo, se ve as√≠:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictionaryStorage</span></span></span><span class="hljs-class">&lt;TKey, TValues&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; removed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; changedValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HashSet&lt;TKey&gt; newKeys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;TKey&gt;(); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No logr√© encontrar el mismo dep√≥sito maravilloso para la Lista, o no tengo suficiente tiempo, guardo dos copias. Se necesita un complemento adicional para tratar de minimizar el tama√±o de la diferencia.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListStorage</span></span></span><span class="hljs-class">&lt;TValue&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; previouse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-comment"><span class="hljs-comment">//        public List&lt;int&gt; order = new List&lt;int&gt;(); //       . }</span></span></code> </pre> <br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si sabe claramente lo que quiere recibir y c√≥mo, puede escribir todo esto en unas pocas semanas. La velocidad de desarrollo del juego al mismo tiempo cambia tan dram√°ticamente que cuando lo prob√©, ni siquiera comenc√© mis propios juegos de creaci√≥n de juegos sin tener un buen motor. Solo porque en el primer mes la inversi√≥n en √©l para m√≠ obviamente vali√≥ la pena. Por supuesto, esto solo se aplica al meta. La jugabilidad debe hacerse a la antigua usanza. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la siguiente parte del art√≠culo, hablar√© sobre comandos, redes y predicci√≥n de respuestas del servidor. Y tambi√©n tengo algunas preguntas para ti que son muy importantes para m√≠. Si sus respuestas difieren de las que figuran entre par√©ntesis, con gusto las leer√© en los comentarios o tal vez incluso escriba un art√≠culo. Gracias de antemano por las respuestas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PD Una propuesta de cooperaci√≥n e instrucciones sobre numerosos errores de sintaxis, por favor en PM. </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434582/">https://habr.com/ru/post/es434582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434570/index.html">Simulador minimalista en l√≠nea de circuitos lineales de CC y CA</a></li>
<li><a href="../es434574/index.html">Animaci√≥n de subrayado de enlace CSS puro</a></li>
<li><a href="../es434576/index.html">Trabajar con la API de KOMPAS-3D ‚Üí Lecci√≥n 14 ‚Üí Texto multil√≠nea</a></li>
<li><a href="../es434578/index.html">Higiene digital: las reglas del juego</a></li>
<li><a href="../es434580/index.html">Estad√≠sticas de tostadoras 2018</a></li>
<li><a href="../es434584/index.html">Los datos son divertidos (y aqu√≠ hay algunos ejemplos)</a></li>
<li><a href="../es434586/index.html">Aviones personales. Comprende y espera</a></li>
<li><a href="../es434588/index.html">Resumiendo el a√±o 2018 en My Circle</a></li>
<li><a href="../es434590/index.html">$ ls -l / home / avitotech / new_year</a></li>
<li><a href="../es434592/index.html">Elon Musk promete cubrir Europa con la red Tesla Supercharger el pr√≥ximo a√±o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>