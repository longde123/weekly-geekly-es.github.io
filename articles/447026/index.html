<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèº üå©Ô∏è „äôÔ∏è Escribimos el cargador OTA para ATmega128RFA1 (como parte del dispositivo Smart Response XE) üëåüèø üêº üç£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todo comenz√≥ con la adquisici√≥n por parte del autor en el mercado secundario de un dispositivo interesante: Smart Response XE ( breve descripci√≥n ). E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escribimos el cargador OTA para ATmega128RFA1 (como parte del dispositivo Smart Response XE)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447026/"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  Todo comenz√≥ con la adquisici√≥n por parte del autor en el mercado secundario de un dispositivo interesante: Smart Response XE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">breve descripci√≥n</a> ).  Est√° destinado a las escuelas: cada alumno de la clase recibe un dispositivo similar a un cuaderno electr√≥nico o traductor de los a√±os noventa, el profesor hace una pregunta y los alumnos escriben en los teclados de los dispositivos las respuestas recibidas a trav√©s del canal de radio (802.15.4) al receptor conectado a la PC del profesor. <br><br>  El soporte para estos dispositivos se suspendi√≥ hace varios a√±os, y el hecho de que las escuelas compraron a $ 100-200 cada uno, ahora aparece en eBay por 10 o menos.  El hierro all√≠ es muy adecuado para experimentos geek: <br><br><ul><li>  Teclado de 60 teclas </li><li>  pantalla con una resoluci√≥n de 384x136, 2 bits por p√≠xel, similar a BK, CGA, pero 4 no son colores, sino gradaciones de brillo </li><li>  Microcontrolador ATmega128RFA1 (memoria flash de 128 kB, ROM de 4 kB, RAM de 16 kB, transceptor est√°ndar 802.15.4) </li><li>  Memoria flash externa (con respecto al microcontrolador y no a todo el dispositivo) de 1 megabyte (128 kilobytes) con SPI </li><li>  Compartimento para 4 elementos AAA. </li></ul><br>  Por el nombre del microcontrolador, est√° claro que pertenece a la familia AVR, lo que significa que hacer un dispositivo compatible con Arduino es una tarea m√°s que trivial ... <a name="habracut"></a><br><br>  A partir de las noticias sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hackaday, el</a> autor descubri√≥ que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ya lo hab√≠an hecho</a> (el mismo enlace dice a qu√© conectarse), teniendo la oportunidad de ejecutar juegos para Arduboy: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Pero el autor est√° m√°s interesado en la oportunidad de no jugar en el dispositivo, sino de estudiar: <br><br><ul><li>  flash serie SPI </li><li>  descargadores para AVR </li><li>  est√°ndar 802.15.4 </li></ul><br>  El autor comenz√≥ escribiendo una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca</a> (GPL v3) que le permite inicializar la pantalla, mostrar texto y rect√°ngulos, y tambi√©n acceder a la memoria flash con la interfaz SPI.  Luego comenz√≥ a proponer ideas para el uso pr√°ctico del dispositivo: un terminal de bolsillo compatible con VT-100, juegos para m√∫ltiples jugadores.  Habiendo rehecho los tres dispositivos, decidi√≥ "ense√±arles" c√≥mo obtener bocetos "por el aire".  Lo que no solo ser√≠a interesante, sino tambi√©n muy conveniente: es dif√≠cil abrir la carcasa del dispositivo cada vez, y debajo de la cubierta de la bater√≠a solo hay agujeros que le permiten conectar un programador JTAG a la placa. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  Esto es suficiente para llenar el gestor de arranque Arduino, pero no es un boceto: el puerto serie no se emite all√≠, a√∫n no puede hacerlo sin abrir la carcasa.  Adem√°s, las l√≠neas TX0 y RX0 del primer puerto serie est√°n alineadas con las l√≠neas de sondeo de la matriz del teclado, es decir, aquellas a lo largo de las cuales se sondean las teclas de funci√≥n a los lados de la pantalla.  Pero qu√© hacer: el autor construy√≥ esto: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  All√≠ sac√≥ las l√≠neas JTAG, y ahora no es necesario abrir el compartimento de la bater√≠a.  Y para poder completar los bocetos, traje ambos puertos seriales al mismo conector, agregando tambi√©n un interruptor, porque cuando las bater√≠as est√°n instaladas, el dispositivo no puede apagarse f√≠sicamente de manera diferente. <br><br>  Me llev√≥ bastante tiempo trabajar con un soldador, un cuchillo de oficina y una pistola de pegamento.  En general, los bocetos de vertido "por aire" son mucho m√°s convenientes, es urgente inventar algo para esto. <br><br>  Arduino IDE usa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">avrdude</a> para completar bocetos.  Interact√∫a con el microcontrolador a trav√©s del protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">STK500</a> , que le permite transferir archivos en ambas direcciones.  Es poco compatible con los canales donde son posibles retrasos variables, distorsi√≥n y p√©rdida de datos.  Si algo se dispara o cruje en el canal serie, puede volverse loco en busca de una causa.  Una vez, el autor atorment√≥ durante medio d√≠a hasta que se dio cuenta de que el problema estaba en el cable defectuoso, as√≠ como en el convertidor caprichoso de la interfaz CP2102.  Incluso un microcontrolador con un convertidor de interfaz incorporado, por ejemplo, ATmega32u4, a veces puede ser tan travieso.  Cada usuario de Arduino ha notado que los errores al cargar bocetos no son tan raros.  A veces, la grabaci√≥n funciona bien y se detecta un error durante la lectura de verificaci√≥n.  Esto no significa que hubo un error al escribir, el error fue al leer.  Ahora imagine que cuando trabaja "por aire" suceder√° lo mismo, pero con mucha m√°s frecuencia. <br><br>  Despu√©s de haber intentado diferentes formas de superar este problema, el autor propuso lo siguiente.  El dispositivo tiene una memoria flash de 128 kilobytes con interfaz SPI: recibimos datos a trav√©s de cables (recuerde que el autor ya tiene un dispositivo con un conector en el lateral), usamos esta memoria como un b√∫fer y enviamos datos a otro dispositivo a trav√©s de un canal de radio.  Un saludo de Cybiko. <br><br>  Despu√©s de escribir el c√≥digo para trabajar con el canal de radio, as√≠ como la fuente, el gestor de arranque se hizo m√°s largo que 4 kilobytes.  Por lo tanto, el valor HFUSE tuvo que cambiarse de 0xDA a 0xD8.  Ahora el gestor de arranque puede tener hasta 8 kilobytes de longitud, y la direcci√≥n inicial se ha convertido en 0x1E000.  Esto se refleja en el Makefile, pero debe tenerse en cuenta al llenar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gestor de arranque</a> con avrdude. <br><br>  El transceptor est√°ndar 802.15.4 en el ATmega128RFA1 fue originalmente dise√±ado para operar en el protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZigBee</a> , lo cual es bastante complicado, por lo que el autor decidi√≥ simplemente transmitir paquetes.  Este es un hardware implementado en el ATmega128RFA1, por lo que se requiere un poco de c√≥digo.  Adem√°s, por simplicidad, el autor decidi√≥ usar un canal fijo, evitando que lo eligiera incluso manualmente.  El est√°ndar 802.15.4 admite 16 canales con n√∫meros del 11 al 26. Est√°n bastante obstruidos, algunos tambi√©n se superponen a los canales WiFi (rojo indica canales ZigBee, azul, verde y amarillo - WiFi). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  Result√≥ que los canales 15 y 26 son los menos susceptibles a la interferencia de WiFi. El autor eligi√≥ el segundo de ellos.  Descargo de responsabilidad: el traductor no sabe si ZigBee est√° tan simplificado.  ¬øQuiz√°s valga un poco m√°s de programaci√≥n y su implementaci√≥n completa? <br><br>  En el primero de los dispositivos, es necesario implementar una m√°quina de estado que transmita datos utilizando el protocolo STK500.  En su mayor parte, los mensajes enviados y recibidos son autosuficientes, pero algunos est√°n vinculados a los que han pasado por el canal anteriormente.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> se da una descripci√≥n del di√°logo. <br><br>  Un componente importante de este di√°logo es la transferencia de paquetes destinados a la escritura en la memoria flash del dispositivo de destino.  Los microcontroladores simples de la familia AVR tienen un tama√±o de p√°gina de 128 bytes, pero ATmega128RFA1 tiene un tama√±o de 256. Y la memoria flash que se conecta a trav√©s del protocolo SPI tiene el mismo tama√±o.  El programa en el primer dispositivo al verter el boceto no lo transfiere inmediatamente al segundo, sino que lo escribe en esta memoria.  Cuando el IDE de Arduino verifica la correcci√≥n de la grabaci√≥n, le env√≠an lo que est√° escrito all√≠.  Ahora debe transferir los datos recibidos por aire al segundo dispositivo.  Al mismo tiempo, el cambio de recepci√≥n a transmisi√≥n y viceversa ocurre con bastante frecuencia.  El protocolo STK500 es indiferente a los retrasos, pero no tolera la p√©rdida de datos (extra√±o, pero se dice anteriormente que los retrasos en la transmisi√≥n de datos tambi√©n afectan).  Y las p√©rdidas en la transmisi√≥n inal√°mbrica son inevitables.  ATmega128RFA1 tiene una implementaci√≥n de hardware incorporada de solicitudes repetidas con dudas sobre la transmisi√≥n correcta, pero el autor decidi√≥ implementar la misma mediante programaci√≥n por su cuenta.  Desarroll√≥ un protocolo en el que pasan muchos m√°s datos en una direcci√≥n que en la otra. <br><br>  Es imperfecto, pero todo funciona.  Una p√°gina de 256 bytes se divide en cuatro segmentos, cada uno de los cuales se transmite por el aire como un paquete.  Un paquete contiene hasta 125 bytes de datos m√°s un byte de longitud y dos CRC.  Entonces, los fragmentos de 64 bytes de longitud junto con los n√∫meros de p√°gina y segmento (de 0 a 3) se colocan all√≠.  En el dispositivo receptor, se proporciona una variable que le permite rastrear cu√°ntos segmentos se reciben, y cuando llegan los cuatro, se env√≠a una confirmaci√≥n al dispositivo emisor de que se ha recibido toda la p√°gina.  Sin confirmaci√≥n (CRC no coincide): env√≠e de nuevo toda la p√°gina.  La velocidad al mismo tiempo resulta incluso m√°s que cuando se transmite por cable.  Ver: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Pero en realidad, ser√≠a necesario proporcionar una forma conveniente de conectar el cable a los dispositivos para cargar bocetos y en √©l.  Por ejemplo, coloque dentro de dicho convertidor de interfaz en CP2102, como en la foto, y p√©guelo a la placa para que pueda soportar la fuerza al conectar y desconectar el cable Micro USB. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  Tambi√©n tiene un estabilizador de 3.3 voltios (y c√≥mo usarlo en un dispositivo con fuente de alimentaci√≥n de 6 voltios, si solo hay el mismo estabilizador, y puede agregar dos diodos para elegir autom√°ticamente desde cu√°l se alimentar√° el dispositivo).  Los tres LED deben retirarse de la placa del convertidor de interfaz, de lo contrario cargar√°n adicionalmente las bater√≠as cuando trabajen desde ellos, y tambi√©n interferir√°n con el sondeo del teclado y trabajar√°n con la memoria flash con la interfaz SPI. <br><br>  La consecuci√≥n del objetivo result√≥ ser a√∫n m√°s interesante que su logro (y no necesitas esa broma sobre el autob√∫s).  El autor aprendi√≥ mucho sobre cargadores de arranque para AVR, memoria flash con SPI, protocolo STK500 y est√°ndar 802.15.4. <br><br>  El resto del c√≥digo adem√°s de la biblioteca descrita anteriormente est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> , y tambi√©n est√° bajo GPL v3.  El twitter del autor est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447026/">https://habr.com/ru/post/447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447016/index.html">25 a√±os despu√©s: una entrevista con Linus Torvalds</a></li>
<li><a href="../447018/index.html">Enriquecimiento cu√°ntico en una interpretaci√≥n multimundo</a></li>
<li><a href="../447020/index.html">La productividad no se trata de la gesti√≥n del tiempo, sino de la gesti√≥n de la atenci√≥n.</a></li>
<li><a href="../447022/index.html">No obligue a los oyentes a reflexionar</a></li>
<li><a href="../447024/index.html">¬øC√≥mo combinar las ventajas de una computadora port√°til y una computadora de escritorio? An√°lisis del problema y soluciones.</a></li>
<li><a href="../447028/index.html">Archivos pasados ‚Äã‚Äãde esteganograf√≠a: ocultamos datos directamente en sectores</a></li>
<li><a href="../447034/index.html">Nuevo error en Telegram Desktop le permite leer el √∫ltimo mensaje</a></li>
<li><a href="../447036/index.html">Un c√≥ctel para una dieta saludable: est√° hecho por una startup del acelerador de la Universidad ITMO</a></li>
<li><a href="../447038/index.html">En la lista de amenazas: "Juego de tronos", una de las portadas m√°s populares para los cibercriminales</a></li>
<li><a href="../447040/index.html">Investigaci√≥n: el costo promedio de los interruptores se reduce; entendemos por qu√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>