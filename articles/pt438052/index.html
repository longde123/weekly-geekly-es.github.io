<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¨ üîØ üò• Interator, Padr√£o de Opera√ß√£o üì™ üíáüèø üí©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este texto √© uma adapta√ß√£o de parte do manual da estrutura Hanami para a estrutura Laravel. O que causou o interesse nesse material em particular? Ele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interator, Padr√£o de Opera√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438052/"><p>  Este texto √© uma adapta√ß√£o de parte do manual da estrutura Hanami para a estrutura Laravel.  O que causou o interesse nesse material em particular?  Ele fornece uma descri√ß√£o passo a passo com uma demonstra√ß√£o de coisas comuns para linguagens e estruturas de programa√ß√£o como: </p><br><ul><li>  Usando o padr√£o Interatores. </li><li>  Demonstra√ß√£o de TDD \ BDD. </li></ul><br><p>  Deve-se notar imediatamente que essas n√£o s√£o apenas estruturas diferentes com ideologias diferentes (em particular, com rela√ß√£o ao ORM), mas tamb√©m linguagens de programa√ß√£o diferentes, cada uma com sua pr√≥pria cultura espec√≠fica e "pr√°ticas recomendadas" estabelecidas por raz√µes hist√≥ricas.  Diferentes linguagens de programa√ß√£o e estruturas tendem a emprestar as solu√ß√µes mais bem-sucedidas, portanto, apesar das diferen√ßas nos detalhes, as coisas fundamentais n√£o diferem, a menos que, √© claro, tomemos PL com um paradigma inicialmente diferente.  √â interessante o suficiente comparar como um e o mesmo problema √© resolvido em diferentes ecossistemas. </p><br><p>  Portanto, inicialmente temos o framework Hanami (ruby) - um framework relativamente novo que gravita ideologicamente mais para o Symfony, com o ORM "nos reposit√≥rios".  E a estrutura de destino Laravel \ Lumen (php) com o Active Record. </p><a name="habracut"></a><br><p>  No processo de adapta√ß√£o, os √¢ngulos mais agudos foram cortados: </p><br><ul><li>  A primeira parte do guia foi omitida com a inicializa√ß√£o do projeto, uma descri√ß√£o dos recursos da estrutura e coisas espec√≠ficas semelhantes. </li><li>  O ORM Eloquent √© puxado para o mundo e tamb√©m serve como reposit√≥rio. </li><li>  Etapas para gerar c√≥digo e modelos para o envio de email. </li></ul><br><p>  Salvo e enfatizado em: </p><br><ul><li>  Interatores - uma implementa√ß√£o minimamente apropriada foi feita na interface. </li><li>  Testes, desenvolvimento passo a passo atrav√©s do TDD. </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A primeira parte do tutorial original do Hanami, que ser√° referenciada no texto abaixo.</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Texto interativo original do tutorial</a> <br>  Link para o reposit√≥rio com c√≥digo php adaptado no final do texto. </p><br><h3 id="interaktory">  Interactors </h3><br><h4 id="novaya-ficha-uvedomleniya-po-elektronnoy-pochte">  Novo recurso: Notifica√ß√µes por email </h4><br><p>  Cen√°rio de recursos: como administrador, quando adiciono um livro, desejo receber notifica√ß√µes por email. </p><br><p>  Como o aplicativo n√£o possui autentica√ß√£o, qualquer pessoa pode adicionar um novo livro.  N√≥s especificaremos o endere√ßo de email do administrador atrav√©s de vari√°veis ‚Äã‚Äãde ambiente. </p><br><p>  Este √© apenas um exemplo mostrando quando usar interatores e, em particular, como usar o interator Hanami. </p><br><p>  <em>Este exemplo pode servir de base para outras fun√ß√µes, como confirma√ß√£o do administrador de novos livros antes de serem publicados.</em>  <em>Ou dando aos usu√°rios a capacidade de especificar um endere√ßo de e-mail para editar o livro por meio de um link especial.</em> </p><br><p>  Na pr√°tica, voc√™ pode usar interatores para implementar qualquer l√≥gica comercial abstra√≠da da camada de rede.  Isso √© especialmente √∫til quando voc√™ deseja combinar v√°rias coisas para controlar a complexidade da base de c√≥digo. </p><br><p>  Eles s√£o usados ‚Äã‚Äãpara isolar a l√≥gica de neg√≥cios n√£o trivial, seguindo o Princ√≠pio de Responsabilidade √önica. </p><br><p>  Em aplicativos da web, eles geralmente s√£o usados ‚Äã‚Äãem a√ß√µes do controlador.  Dessa forma, voc√™ separa tarefas, objetos de l√≥gica comercial e interatores; eles n√£o sabem nada sobre a camada de rede do aplicativo. </p><br><h4 id="kolbeki-oni-nam-ne-nuzhny">  Retornos de chamada?  N√≥s n√£o precisamos deles! </h4><br><p>  A maneira mais f√°cil de implementar uma notifica√ß√£o por email √© adicionar um retorno de chamada. </p><br><p>  Ou seja, depois de criar uma nova entrada de livro no banco de dados, um email √© enviado. </p><br><p>  Arquitetonicamente, Hanami n√£o fornece esse mecanismo.  Isso ocorre porque consideramos os retornos de chamada do modelo um antipadr√£o.  Eles violam o princ√≠pio da responsabilidade exclusiva.  No nosso caso, eles misturam incorretamente a camada de persist√™ncia com notifica√ß√µes por email. </p><br><p>  Durante o teste (e provavelmente em alguns outros casos), voc√™ deve pular o retorno de chamada.  Isso √© rapidamente confuso, pois v√°rios retornos de chamada para um √∫nico evento podem ser acionados em uma ordem espec√≠fica.  Al√©m disso, voc√™ pode pular alguns retornos de chamada.  Os retornos de chamada tornam o c√≥digo fr√°gil e dif√≠cil de entender. </p><br><p>  Em vez disso, recomendamos expl√≠cito, em vez de impl√≠cito. </p><br><p>  Um interator √© um objeto que representa um caso de uso espec√≠fico. </p><br><p>  Eles permitem que cada classe tenha uma √∫nica responsabilidade.  A √∫nica responsabilidade do interator √© combinar os objetos e as chamadas de m√©todo para obter um resultado espec√≠fico. </p><br><h4 id="ideya">  Id√©ia </h4><br><p>  A id√©ia principal dos interatores √© que voc√™ extraia as partes isoladas da funcionalidade em uma nova classe. </p><br><p> Voc√™ deve escrever apenas dois m√©todos p√∫blicos: <code>__construct</code> e <code>call</code> . <br>  <em>Na implementa√ß√£o php do interator, o m√©todo de chamada possui o modificador protegido e √© chamado via <code>__invoke</code> .</em> </p><br><p>  Isso significa que esses objetos s√£o f√°ceis de interpretar, pois existe apenas um m√©todo dispon√≠vel para us√°-los. </p><br><p>  O comportamento de encapsular em um objeto facilita o teste.  Tamb√©m facilita o entendimento da sua base de c√≥digo e n√£o apenas deixa a complexidade oculta implicitamente. </p><br><h4 id="podgotovka">  Prepara√ß√£o </h4><br><p>  Suponha que tenhamos nosso aplicativo Estante de livros " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o</a> " e desejemos adicionar o recurso "notifica√ß√£o por email para o livro adicionado". </p><br><h4 id="pishem-interaktor">  Escrevendo um Interator </h4><br><p>  Vamos criar uma pasta para nossos interatores e uma pasta para seus testes: </p><br><pre> <code class="plaintext hljs">$ mkdir lib/bookshelf/interactors $ mkdir tests/bookshelf/interactors</code> </pre> <br><p>  N√≥s os colocamos na <code>lib/bookshelf</code> porque eles n√£o est√£o relacionados ao aplicativo da web.  Voc√™ pode adicionar livros posteriormente atrav√©s do portal de administra√ß√£o, API ou at√© mesmo um utilit√°rio de linha de comando. </p><br><p>  Adicione o <code>AddBook</code> e escreva um novo teste <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># tests/bookshelf/interactors/AddBookTest.php &lt;?php use Lib\Bookshelf\Interactors\AddBook; class AddBookTest extends TestCase { private function interactor() { return $this-&gt;app-&gt;make(AddBook::class); } private function bookAttributes() { return [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; } private function subjectCall() { return $this-&gt;interactor()($this-&gt;bookAttributes()); } public function testSucceeds() { $result = $this-&gt;subjectCall(); $this-&gt;assertTrue($result-&gt;successful()); } }</span></span></code> </pre><br><p>  A execu√ß√£o de um conjunto de testes gerar√° um erro <code>Class does not exist</code> porque n√£o h√° classe <code>AddBook</code> .  Vamos criar esta classe no arquivo <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Existem apenas dois m√©todos que essa classe deve conter: <code>__construct</code> para definir dados e <code>call</code> para implementar o script. </p><br><p>  Esses m√©todos, especialmente os <code>call</code> , devem chamar m√©todos particulares que voc√™ escreve. </p><br><p>  Por padr√£o, o resultado √© considerado bem-sucedido, pois n√£o indicamos explicitamente que a opera√ß√£o falhou. </p><br><p>  Vamos executar o teste: </p><br><pre> <code class="plaintext hljs">$ phpunit</code> </pre> <br><p>  Todos os testes devem passar! </p><br><p>  Agora, vamos fazer nosso <code>AddBook</code> realmente fazer alguma coisa! </p><br><h3 id="sozdanie-knigi">  Cria√ß√£o de livros </h3><br><p>  Altere <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreateBook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"The Fire Next Time"</span></span>, $result-&gt;book-&gt;title); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"James Baldwin"</span></span>, $result-&gt;book-&gt;author); }</code> </pre> <br><p>  Se voc√™ executar testes do <code>phpunit</code> , ver√° um erro: </p><br><pre> <code class="plaintext hljs">Exception: Undefined property Lib\Interactor\InteractorResult::$book</code> </pre> <br><p>  Vamos preencher nosso interator e depois explicar o que fizemos: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Book</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $expose = [<span class="hljs-string"><span class="hljs-string">"book"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $book = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book($bookAttributes); } }</code> </pre> <br><p>  Duas coisas importantes a serem observadas aqui: </p><br><p>  <code>protected static $expose = ["book"];</code> string <code>protected static $expose = ["book"];</code>  Adiciona a propriedade <code>book</code> ao objeto de resultado que ser√° retornado quando o interator for chamado. </p><br><p>  O m√©todo de <code>call</code> atribui o modelo <code>Book</code> √† propriedade <code>book</code> , que estar√° dispon√≠vel como resultado. </p><br><p>  Agora os testes devem passar. </p><br><p>  Inicializamos o modelo <code>Book</code> , mas ele n√£o √© armazenado no banco de dados. </p><br><h4 id="sohranenie-knigi">  Salvando Livro </h4><br><p>  Temos um novo livro, obtido a partir do t√≠tulo e do autor, mas ainda n√£o est√° no banco de dados. </p><br><p>  Precisamos usar nosso <code>BookRepository</code> para salv√°-lo. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $result = $this-&gt;subjectCall(); $this-&gt;assertNotNull($result-&gt;book-&gt;id); }</span></span></code> </pre> <br><p>  Se voc√™ executar os testes, ver√° um novo erro com a mensagem <code>Failed asserting that null is not null</code> . </p><br><p>  Isso ocorre porque o livro que criamos n√£o possui um identificador, porque ele ser√° recebido apenas quando for salvo. </p><br><p>  Para que o teste seja aprovado, precisamos criar um livro salvo.  Outra maneira, n√£o menos correta, √© salvar o livro que j√° temos. </p><br><p>  Edite o m√©todo de <code>call</code> no <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = Book::create($bookAttributes); }</code> </pre> <br><p>  Em vez de chamar o <code>new Book</code> , fazemos <code>Book::create</code> com os atributos do livro. </p><br><p>  O m√©todo ainda retorna o livro e tamb√©m salva esse registro no banco de dados. </p><br><p>  Se voc√™ executar os testes agora, ver√° que todos os testes passam. </p><br><h4 id="vnedrenie-zavisimostey-dependency-injection">  Inje√ß√£o de Depend√™ncia </h4><br><p>  Vamos refatorar para usar inje√ß√£o de depend√™ncia. </p><br><p>  Os testes ainda funcionam, mas dependem dos recursos de salvamento no banco de dados (a propriedade id √© determinada ap√≥s o salvamento bem-sucedido).  Este √© um detalhe de implementa√ß√£o de como a conserva√ß√£o funciona.  Por exemplo, se voc√™ deseja criar um UUID antes de salv√°-lo e indicar que a grava√ß√£o foi bem-sucedida de alguma outra maneira, al√©m de preencher a coluna de identifica√ß√£o, ser√° necess√°rio alterar este teste. </p><br><p>  Podemos modificar nosso teste e o interator para torn√°-lo mais confi√°vel: ser√° menos propenso a falhas devido a altera√ß√µes fora de seu arquivo. </p><br><p>  Veja como podemos usar a inje√ß√£o de depend√™ncia no interator: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lib/bookshelf/interactors/AddBook.php public function __construct(Book $repository) { $this-&gt;repository = $repository; } protected function call($bookAttributes) { $this-&gt;book = $this-&gt;repository-&gt;create($bookAttributes); }</span></span></code> </pre> <br><p>  Essencialmente, √© o mesmo, com um pouco mais de c√≥digo, para criar uma propriedade de <code>repository</code> . </p><br><p>  No momento, o teste verifica o comportamento do m√©todo <code>create</code> para garantir que seu identificador seja preenchido com <code>$this-&gt;assertNotNull($result-&gt;book-&gt;id)</code> . </p><br><p>  Este √© um detalhe de implementa√ß√£o. </p><br><p>  Em vez disso, podemos modificar o teste para garantir apenas que o m√©todo <code>create</code> foi chamado no reposit√≥rio e confiar que o reposit√≥rio salvar√° o objeto (j√° que essa √© sua responsabilidade). </p><br><p>  Vamos mudar o teste <code>testPersistsBook</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $repository = Mockery::mock(Book::class); $this-&gt;app-&gt;instance(Book::class, $repository); $attributes = [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; $repository-&gt;expects()-&gt;create($attributes); $this-&gt;subjectCall($attributes); }</span></span></code> </pre> <br><p>  Agora, nosso teste n√£o viola os limites de sua zona. </p><br><p>  Tudo o que fizemos foi adicionar a depend√™ncia do interator no reposit√≥rio. </p><br><h4 id="uvedomlenie-na-elektronnuyu-pochtu">  Notifica√ß√£o por email </h4><br><p>  Vamos adicionar uma notifica√ß√£o por email! </p><br><p>  <em>Voc√™ tamb√©m pode fazer qualquer coisa aqui, por exemplo, enviar um SMS, enviar uma mensagem de bate-papo ou ativar um gancho da Web.</em> </p><br><p>  Deixaremos o corpo da mensagem vazio, mas no campo de assunto indicamos "Livro adicionado!". </p><br><p>  Crie um teste de notifica√ß√£o <code>tests/bookshelf/mail/BookAddedNotificationTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">BookAddedNotification</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Support</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotificationTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::setUp(); Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAddedNotification(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCorrectAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;build(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;from[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;to[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;subject); } }</code> </pre> <br><p>  Adicione a classe de notifica√ß√£o <code>lib/Bookshelf/Mail/BookAddedNotification.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">Mailable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotification</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mailable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;from(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>) -&gt;to(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>) -&gt;subject(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'emails.book_added_notification'</span></span>); } }</code> </pre> <br><p>  Agora todos os nossos testes passam! </p><br><p>  Mas a notifica√ß√£o ainda n√£o foi enviada.  Precisamos ligar para o envio do nosso <code>AddBook</code> . </p><br><p>  <code>AddBook</code> teste <code>AddBook</code> para garantir que a mala direta ser√° chamada: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); Mail::assertSent(BookAddedNotification::class, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p>  Se executarmos os testes, obteremos o erro: <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code>  . </p><br><p>  Agora integramos o envio da notifica√ß√£o ao interator. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Book $repository, BookAddedNotification $mail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository = $repository; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = $mail; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository-&gt;create($bookAttributes); Mail::send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail); }</code> </pre> <br><p>  Como resultado, o interator enviar√° uma notifica√ß√£o sobre a adi√ß√£o do livro ao email. </p><br><h4 id="integraciya-s-kontrollerom">  Integra√ß√£o do controlador </h4><br><p>  Finalmente, precisamos chamar o interator da a√ß√£o. </p><br><p>  Edite o arquivo de a√ß√£o <code>app/Http/Controllers/BooksCreateController.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Create a new controller instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AddBook $addBook)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook = $addBook; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $input = $request-&gt;all(); (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook)($input); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>)); } }</code> </pre> <br><p>  Nossos testes s√£o aprovados, mas h√° um pequeno problema. </p><br><p>  Testamos o c√≥digo de cria√ß√£o de livros duas vezes. </p><br><p>  Geralmente, essa √© uma pr√°tica ruim, e podemos corrigi-la ilustrando outra vantagem dos interatores. </p><br><p>  <code>BookRepository</code> a men√ß√£o no <code>BookRepository</code> nos testes e usaremos a simula√ß√£o para o nosso <code>AddBook</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCallsInteractor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $attributes = [<span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1984'</span></span>, <span class="hljs-string"><span class="hljs-string">'author'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'George Orwell'</span></span>]; $addBook = Mockery::mock(AddBook::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;instance(AddBook::class, $addBook); $addBook-&gt;expects()-&gt;__invoke($attributes); $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;call(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/books'</span></span>, $attributes); } }</code> </pre> <br><p>  Agora nossos testes s√£o aprovados e s√£o muito mais confi√°veis! </p><br><p>  A a√ß√£o recebe entrada (dos par√¢metros da solicita√ß√£o http) e chama o interator para fazer seu trabalho.  A √∫nica responsabilidade da a√ß√£o √© trabalhar com a rede.  E o interator trabalha com nossa l√≥gica real de neg√≥cios. </p><br><p>  Isso simplifica bastante as a√ß√µes e seus testes. </p><br><p>  As a√ß√µes s√£o praticamente isentas da l√≥gica de neg√≥cios. </p><br><p>  Quando modificamos o interator, n√£o precisamos mais alterar a a√ß√£o ou seu teste. </p><br><p>  <em>Observe que em um aplicativo real, voc√™ provavelmente deseja fazer mais do que a l√≥gica acima, por exemplo, para garantir que o resultado seja bem-sucedido.</em>  <em>E se ocorrer uma falha, voc√™ desejar√° retornar erros do interator.</em> </p><br><p>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Reposit√≥rio com c√≥digo</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438052/">https://habr.com/ru/post/pt438052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438028/index.html">Voc√™ n√£o precisa de blockchain: 8 casos de usu√°rios populares e por que eles n√£o funcionam</a></li>
<li><a href="../pt438034/index.html">Android, Rx e Kotlin, ou como fazer uma garra de Lego encolher. Parte 1</a></li>
<li><a href="../pt438036/index.html">3blue1brown e MIT em russo</a></li>
<li><a href="../pt438044/index.html">Hello World Analysis</a></li>
<li><a href="../pt438048/index.html">Removemos recursos e produtos desnecess√°rios para melhorar os neg√≥cios.</a></li>
<li><a href="../pt438058/index.html">"An√°lise de dados em Python" em duas partes</a></li>
<li><a href="../pt438060/index.html">Estimativa da orienta√ß√£o espacial ou Como n√£o ter medo dos filtros Mahoney e Majwik</a></li>
<li><a href="../pt438062/index.html">Meu endere√ßo n√£o √© uma casa ou rua, meu endere√ßo √© a Uni√£o Sovi√©tica?</a></li>
<li><a href="../pt438064/index.html">Lista de verifica√ß√£o: o que precisava ser feito antes de iniciar os microsservi√ßos no prod</a></li>
<li><a href="../pt438066/index.html">10 canais educacionais do YouTube em ingl√™s dos quais voc√™ nunca ouviu falar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>