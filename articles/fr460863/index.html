<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∑ üë®üèæ‚Äçüíª ‚öóÔ∏è D√©tails du crash de Cloudflare 2 juillet 2019 ü•ò üë©üèΩ‚Äçü§ù‚Äçüë®üèæ ü§πüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a presque 9 ans, Cloudflare √©tait une toute petite entreprise, mais je n'y travaillais pas, j'√©tais juste un client. Un mois apr√®s le lancement d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©tails du crash de Cloudflare 2 juillet 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p>  Il y a presque 9 ans, Cloudflare √©tait une toute petite entreprise, mais je n'y travaillais pas, j'√©tais juste un client.  Un mois apr√®s le lancement de Cloudflare, j'ai re√ßu une notification indiquant que DNS ne semble pas fonctionner sur mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site Web</a> jgc.org.  Cloudflare a modifi√© les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tampons de protocole</a> et il y a eu un DNS cass√©. </p><a name="habracut"></a><br><p>  J'ai imm√©diatement √©crit √† Matthew Prince, en t√™te de la lettre "O√π est mon DNS?", Et il a envoy√© une longue r√©ponse, pleine de d√©tails techniques ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lire toute la correspondance ici</a> ), √† laquelle j'ai r√©pondu: </p><br><blockquote>  De: John Graham Cumming <br>  Date: 7 octobre 2010 9:14 <br>  Objet: Re: O√π est mon DNS? <br>  √Ä: Matthew Prince <br><br>  Rapport sympa, merci.  J'appellerai certainement s'il y a des probl√®mes.  Cela vaut probablement la peine d'√©crire un article √† ce sujet lorsque vous collectez toutes les informations techniques.  Je pense que les gens aimeront une histoire ouverte et honn√™te.  Surtout si vous y joignez des graphiques pour montrer comment le trafic a augment√© apr√®s le lancement. <br><br>  J'ai une bonne surveillance sur le site, et je re√ßois un SMS sur chaque panne.  La surveillance montre que l'√©chec s'est produit entre 13 h 03 min 07 s et 14 h 04 min 12 s.  Les tests sont effectu√©s toutes les cinq minutes. <br><br>  Je suis s√ªr que vous le comprendrez.  Vous n'avez certainement pas besoin de votre propre personne en Europe?  :-) </blockquote><p>  Et il a r√©pondu: </p><br><blockquote>  De: Matthew Prince <br>  Date: 7 octobre 2010, 9:57 <br>  Objet: Re: O√π est mon DNS? <br>  √Ä: John Graham Cumming <br><br>  Je vous remercie  Nous avons r√©pondu √† tous ceux qui ont √©crit.  Je vais au bureau maintenant, et nous √©crirons quelque chose sur le blog ou publierons un message officiel sur notre babillard.  Je suis enti√®rement d'accord, l'honn√™tet√© est notre tout. </blockquote><p>  Maintenant, Cloudflare est une tr√®s grande entreprise, j'y travaille, et maintenant je dois √©crire ouvertement sur notre erreur, ses cons√©quences et nos actions. </p><br><h3 id="sobytiya-2-iyulya">  √âv√©nements du 2 juillet </h3><br><p>  Le 2 juillet, nous avons d√©ploy√© une nouvelle r√®gle dans les r√®gles g√©r√©es pour WAF, en raison des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ressources processeur √©puis√©es</a> sur chaque c≈ìur de processeur qui traite le trafic HTTP / HTTPS sur le r√©seau Cloudflare √† travers le monde.  Nous am√©liorons constamment les r√®gles g√©r√©es pour WAF en r√©ponse aux nouvelles vuln√©rabilit√©s et menaces.  En mai, par exemple, nous nous sommes pr√©cipit√©s pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajouter une r√®gle</a> pour nous prot√©ger d'une grave vuln√©rabilit√© dans SharePoint.  L'int√©r√™t de notre WAF est la capacit√© de d√©ployer rapidement et globalement des r√®gles. </p><br><p>  Malheureusement, la mise √† jour de jeudi dernier contenait une expression r√©guli√®re qui a d√©pens√© pour revenir en arri√®re sur trop de ressources processeur allou√©es pour HTTP / HTTPS.  Cela a affect√© nos fonctionnalit√©s principales de proxy, CDN et WAF.  Le graphique montre que les ressources du processeur pour servir le trafic HTTP / HTTPS atteignent presque 100% sur les serveurs de notre r√©seau. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>Utilisation des ressources du processeur √† l'un des points de pr√©sence lors d'un incident</em> </p><br><p>  En cons√©quence, nos clients (et les clients de nos clients) sont tomb√©s sur une page avec une erreur 502 dans les domaines Cloudflare.  502 erreurs ont √©t√© g√©n√©r√©es par les serveurs Web frontaux Cloudflare, qui avaient toujours des noyaux gratuits, mais ils n'ont pas pu contacter les processus qui traitent le trafic HTTP / HTTPS. </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p>  Nous savons combien d'inconv√©nients cela a caus√© √† nos clients.  Nous avons terriblement honte.  Et cet √©chec nous a emp√™ch√©s de traiter efficacement l'incident. </p><br><p> Si vous √©tiez l'un de ces clients, cela vous a probablement effray√©, irrit√© et boulevers√©.  De plus, nous n'avons pas connu d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©checs mondiaux</a> depuis 6 ans.  La consommation √©lev√©e de CPU √©tait due √† une r√®gle WAF avec une expression r√©guli√®re mal formul√©e, ce qui a conduit √† un retour en arri√®re excessif.  Voici l'expression coupable: <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p>  Bien qu'il soit int√©ressant en soi (et je vais vous en dire plus ci-dessous), le service Cloudflare a √©t√© interrompu pendant 27 minutes, non seulement en raison d'une expression r√©guli√®re impropre.  Il nous a fallu un certain temps pour d√©crire la s√©quence des √©v√©nements qui ont conduit √† l'√©chec, nous n'avons donc pas r√©agi rapidement.  √Ä la fin de l'article, je d√©crirai le retour en arri√®re dans l'expression r√©guli√®re et vous dirai quoi faire √† ce sujet. </p><br><h3 id="chto-sluchilos">  Qu'est-il arriv√©? </h3><br><p>  Commen√ßons dans l'ordre.  Tout le temps est indiqu√© ici en UTC. </p><br><p>  √Ä 13h42, un ing√©nieur de l'√©quipe du pare-feu a apport√© une petite modification aux r√®gles de d√©tection de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XSS √† l'</a> aide d'un processus automatique.  Par cons√©quent, un ticket de demande de changement a √©t√© cr√©√©.  Nous g√©rons ces billets via Jira (capture d'√©cran ci-dessous). </p><br><p>  Apr√®s 3 minutes, la premi√®re page PagerDuty est apparue, signalant un probl√®me avec WAF.  Il s'agissait d'un test synth√©tique qui v√©rifie la fonctionnalit√© de WAF (nous en avons des centaines) en dehors de Cloudflare afin de surveiller le fonctionnement normal.  Puis, imm√©diatement, il y a eu des pages avec des notifications d'√©checs d'autres tests de bout en bout des services Cloudflare, des probl√®mes de trafic mondial, des erreurs 502 g√©n√©ralis√©es et un tas de rapports de nos points de pr√©sence (PoP) dans des villes du monde entier qui indiquaient un manque de ressources processeur. </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p>  J'ai re√ßu plusieurs de ces notifications, je suis tomb√© de la r√©union et marchais d√©j√† vers la table lorsque le chef de notre service de d√©veloppement de solutions a d√©clar√© que nous avions perdu 80% du trafic.  J'ai couru vers nos ing√©nieurs SRE qui travaillaient d√©j√† sur le probl√®me.  Au d√©but, nous pensions que c'√©tait une sorte d'attaque inconnue. </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Les ing√©nieurs Cloudflare SRE sont dispers√©s dans le monde et surveillent la situation 24h / 24.  En r√®gle g√©n√©rale, ces alertes vous informent de probl√®mes locaux sp√©cifiques de port√©e limit√©e, sont suivies sur des tableaux de bord internes et sont r√©solues plusieurs fois par jour.  Mais ces pages et notifications indiquaient quelque chose de vraiment s√©rieux, et les ing√©nieurs SRE ont imm√©diatement annonc√© le niveau de gravit√© P0 et se sont tourn√©s vers les ing√©nieurs de gestion et de syst√®me. </p><br><p>  √Ä ce moment-l√†, nos ing√©nieurs londoniens √©coutaient une conf√©rence dans le hall principal.  La conf√©rence a d√ª √™tre interrompue, tout le monde s'est r√©uni dans une grande salle de conf√©rence et d'autres experts ont √©t√© invit√©s.  Ce n'√©tait pas un probl√®me commun que SRE pouvait comprendre par lui-m√™me.  Il √©tait urgent de mettre en relation les bons sp√©cialistes. </p><br><p>  √Ä 14h00, nous avons d√©termin√© qu'il y avait un probl√®me avec WAF et qu'il n'y avait pas d'attaque.  Le service des performances a r√©cup√©r√© les donn√©es du processeur et il est devenu √©vident que WAF √©tait √† bl√¢mer.  Un autre collaborateur a confirm√© cette th√©orie avec force.  Quelqu'un d'autre a vu dans les journaux que le probl√®me avec WAF.  √Ä 14h02, toute l'√©quipe est venue vers moi quand il a √©t√© propos√© d'utiliser la suppression globale - un m√©canisme int√©gr√© √† Cloudflare qui d√©sactive un composant dans le monde. </p><br><p>  La fa√ßon dont nous avons tu√© Global pour WAF est une autre histoire.  Ce n'est pas si simple.  Nous utilisons nos propres produits, et puisque notre service d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">acc√®s</a> n'a pas fonctionn√©, nous n'avons pas pu authentifier et entrer dans le panneau de contr√¥le interne (lorsque tout a √©t√© r√©par√©, nous avons appris que certains membres de l'√©quipe ont perdu l'acc√®s en raison d'une fonction de s√©curit√© qui d√©sactive les informations d'identification si n'utilisez pas le panneau de commande interne pendant une longue p√©riode). </p><br><p>  Et nous n'avons pas pu acc√©der √† nos services internes, comme Jira ou le syst√®me de build.  Nous avions besoin d'une solution de contournement, que nous utilisions rarement (cela devrait √©galement √™tre √©labor√©).  Enfin, un ing√©nieur a pu couper le WAF √† 14h07 et √† 14h09, le niveau de trafic et le processeur partout sont revenus √† la normale.  Le reste des m√©canismes de d√©fense de Cloudflare a fonctionn√© comme pr√©vu. </p><br><p>  Ensuite, nous avons commenc√© √† restaurer WAF.  La situation sortait de l'ordinaire, nous avons donc effectu√© des tests n√©gatifs (en nous demandant si le probl√®me √©tait vraiment ce changement) et positifs (en veillant √† ce que le retour en arri√®re fonctionne) dans une ville en utilisant un trafic s√©par√©, en transf√©rant des clients pay√©s √† partir de l√†. </p><br><p>  √Ä 14 h 52, nous √©tions convaincus que nous avions compris la raison et apport√© une correction, puis allum√© √† nouveau le WAF. </p><br><h3 id="kak-rabotaet-cloudflare">  Comment fonctionne Cloudflare </h3><br><p>  Cloudflare dispose d'une √©quipe d'ing√©nieurs qui g√®re les r√®gles g√©r√©es pour WAF.  Ils essaient d'augmenter le taux de d√©tection, de r√©duire le nombre de faux positifs et de r√©pondre rapidement aux nouvelles menaces √† mesure qu'elles surviennent.  Au cours des 60 derniers jours, 476 demandes de modification des r√®gles g√©r√©es WAF ont √©t√© trait√©es (en moyenne, une toutes les 3 heures). </p><br><p>  Ce changement particulier devait √™tre d√©ploy√© en mode simulation, o√π le trafic client r√©el passe par la r√®gle, mais rien n'est bloqu√©.  Nous utilisons ce mode pour v√©rifier l'efficacit√© des r√®gles et mesurer la proportion de faux positifs et de faux n√©gatifs.  Mais m√™me en mode simulation, les r√®gles doivent effectivement √™tre ex√©cut√©es, et dans ce cas, la r√®gle contenait une expression r√©guli√®re qui consommait trop de ressources processeur. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p>  Comme vous pouvez le voir dans la demande de changement ci-dessus, nous avons un plan de d√©ploiement, un plan de restauration et un lien vers la proc√©dure d'exploitation standard interne (SOP) pour ce type de d√©ploiement.  SOP pour changer la r√®gle vous permet de la publier globalement.  En fait, dans Cloudflare, tout est organis√© compl√®tement diff√©remment, et SOP exige d'abord d'envoyer le logiciel pour les tests et l'utilisation interne √† un point de pr√©sence interne (PoP) (que nos employ√©s utilisent), puis √† un petit nombre de clients dans un endroit isol√©, puis √† un grand nombre de clients, et seulement ensuite au monde entier. </p><br><p>  Voici √† quoi √ßa ressemble.  Nous utilisons git dans le syst√®me interne via BitBucket.  Les ing√©nieurs du changement envoient le code qu'ils cr√©ent √† TeamCity, et lorsque la construction r√©ussit, des r√©viseurs sont affect√©s.  Lorsque la demande de pool est approuv√©e, le code est collect√© et une s√©rie de tests est effectu√©e (√† nouveau). </p><br><p>  Si l'assemblage et les tests r√©ussissent, une demande de modification est cr√©√©e dans Jira et la modification doit √™tre approuv√©e par le superviseur ou le sp√©cialiste principal appropri√©.  Apr√®s approbation, il est d√©ploy√© dans la soi-disant ¬´m√©nagerie PoP¬ª: DOG, PIG et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Canary</a> (chien, oreillons et canari). </p><br><p>  DOG PoP est Cloudflare PoP (comme n'importe quelle autre de nos villes), qui est utilis√© uniquement par les employ√©s de Cloudflare.  Le PoP √† usage interne vous permet de d√©tecter les probl√®mes avant m√™me que la solution ne commence √† recevoir du trafic client.  Chose utile. </p><br><p>  Si le test DOG r√©ussit, le code passe au stade PIG (cobaye).  Il s'agit de Cloudflare PoP, o√π une petite quantit√© de trafic client gratuit circule via le nouveau code. <br>  Si tout va bien, le code va aux Canaries.  Nous avons trois PoP Canaries dans diff√©rentes parties du monde.  Le trafic des clients payants et gratuits passe par le nouveau code en eux, et c'est la derni√®re v√©rification d'erreur. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Processus de sortie du logiciel Cloudflare</em> </p><br><p>  Si le code est correct aux Canaries, nous le publions.  Passer par toutes les √©tapes - CHIEN, PORC, Canaries, le monde entier - prend plusieurs heures ou jours, selon le changement de code.  En raison de la diversit√© du r√©seau et des clients de Cloudflare, nous testons soigneusement le code avant une version mondiale pour tous les clients.  Mais WAF ne suit pas sp√©cifiquement ce processus car les menaces doivent √™tre trait√©es rapidement. </p><br><p>  Menaces WAF <br>  Au cours des derni√®res ann√©es, il y a eu beaucoup plus de menaces dans les applications conventionnelles.  Cela est d√ª √† la plus grande disponibilit√© des outils de test logiciel.  Par exemple, nous avons r√©cemment √©crit sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fuzzing</a> ). </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>Source: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Tr√®s souvent, une confirmation du concept est cr√©√©e et imm√©diatement publi√©e sur Github afin que les √©quipes au service de l'application puissent la tester rapidement et s'assurer qu'elle est bien prot√©g√©e.  Par cons√©quent, Cloudflare doit pouvoir r√©pondre aux nouvelles attaques le plus rapidement possible afin que les clients aient la possibilit√© de r√©parer leur logiciel. </p><br><p>  Un bon exemple de la r√©ponse rapide de Cloudflare est le d√©ploiement de la protection contre les vuln√©rabilit√©s de SharePoint en mai ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lire ici</a> ).  Presque imm√©diatement apr√®s la publication des annonces, nous avons constat√© un grand nombre de tentatives d'exploitation de la vuln√©rabilit√© dans les installations SharePoint de nos clients.  Nos gars surveillent constamment les nouvelles menaces et √©crivent des r√®gles pour prot√©ger nos clients. </p><br><p>  La r√®gle qui a provoqu√© le probl√®me jeudi √©tait de se prot√©ger contre les scripts intersites (XSS).  Il y a √©galement eu beaucoup plus d'attaques de ce type ces derni√®res ann√©es. </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>Source: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  La proc√©dure standard de modification d'une r√®gle g√©r√©e pour WAF n√©cessite des tests d'int√©gration continue (CI) avant le d√©ploiement global.  Jeudi dernier, nous l'avons fait et avons √©largi les r√®gles.  √Ä 13 h 31, un ing√©nieur a envoy√© une demande de pool approuv√©e avec une modification. </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p>  √Ä 13:37, TeamCity a rassembl√© les r√®gles, a effectu√© les tests et a donn√© le feu vert.  La suite de tests WAF teste la fonctionnalit√© de base WAF et se compose d'un grand nombre de tests unitaires pour des fonctions individuelles.  Apr√®s des tests unitaires, nous avons v√©rifi√© les r√®gles pour WAF avec un grand nombre de requ√™tes HTTP.  Les requ√™tes HTTP v√©rifient quelles requ√™tes doivent √™tre bloqu√©es par WAF (afin d'intercepter l'attaque) et lesquelles peuvent √™tre ignor√©es (afin de ne pas tout bloquer et d'√©viter les faux positifs).  Mais nous n'avons pas effectu√© de tests pour une utilisation excessive des ressources du processeur, et l'√©tude des journaux des assemblys WAF pr√©c√©dents montre que le temps d'ex√©cution des tests avec la r√®gle n'a pas augment√©, et il √©tait difficile de soup√ßonner qu'il n'y avait pas suffisamment de ressources. </p><br><p>  Les tests ont √©t√© r√©ussis et TeamCity a commenc√© √† d√©ployer automatiquement le changement √† 13h42. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver">  Quicksilver </h3><br><p>  Les r√®gles WAF traitent de l'√©limination urgente des menaces, nous les d√©ployons donc √† l'aide des paires cl√©-valeur distribu√©es Quicksilver, qui distribuent les modifications √† l'√©chelle mondiale en quelques secondes.  Tous nos clients utilisent cette technologie lorsqu'ils modifient la configuration sur le tableau de bord ou via l'API, et c'est gr√¢ce √† elle que nous r√©pondons aux changements avec une vitesse fulgurante. </p><br><p>  Nous avons parl√© un peu de Quicksilver.  Nous avions l'habitude d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kyoto Tycoon</a> comme r√©f√©rentiel mondialement r√©parti de paires cl√©-valeur, mais il y avait des probl√®mes op√©rationnels et nous avons √©crit notre r√©f√©rentiel r√©pliqu√© dans plus de 180 villes.  D√©sormais, avec Quicksilver, nous envoyons les modifications de configuration client, mettons √† jour les r√®gles WAF et distribuons le code JavaScript √©crit par les clients dans Cloudflare Workers. </p><br><p>  Il suffit de quelques secondes √† une configuration pour faire le tour du monde, de la pression d'un bouton sur un tableau de bord ou de l'appel d'une API √† la modification de la configuration.  Les clients adorent ce r√©glage de vitesse.  Et Workers leur offre un d√©ploiement logiciel mondial presque instantan√©.  En moyenne, Quicksilver distribue environ 350 changements par seconde. </p><br><p>  Et Quicksilver est tr√®s rapide.  En moyenne, nous avons atteint le 99e centile de 2,29 pour propager les modifications sur tous les ordinateurs du monde.  La vitesse est g√©n√©ralement bonne.  Apr√®s tout, lorsque vous activez une fonction ou videz le cache, cela se produit presque instantan√©ment et partout.  L'envoi de code via Cloudflare Workers s'effectue √† la m√™me vitesse.  Cloudflare promet √† ses clients des mises √† jour rapides au bon moment. </p><br><p>  Mais dans ce cas, la vitesse nous a jou√© un tour et les r√®gles ont chang√© partout en quelques secondes.  Vous avez probablement remarqu√© que le code WAF utilise Lua.  Cloudflare utilise largement Lua dans l'environnement de production et nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avons d√©j√† discut√© des</a> d√©tails de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua dans WAF</a> .  Lua WAF utilise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PCRE en</a> interne et applique un suivi arri√®re pour la correspondance.  Il n'a aucun m√©canisme de d√©fense contre les expressions qui sont hors de contr√¥le.  Ci-dessous, je vais en parler davantage et ce que nous en faisons. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p>  Avant le d√©ploiement des r√®gles, tout s'est bien pass√©: la demande de pool a √©t√© cr√©√©e et approuv√©e, le pipeline CI / CD a compil√© et test√© le code, la demande de modification a √©t√© envoy√©e conform√©ment au SOP, qui r√©git le d√©ploiement et la restauration, et le d√©ploiement a √©t√© achev√©. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>Processus de d√©ploiement CloudFare WAF</em> </p><br><p>  Qu'est-ce qui a mal tourn√© <br>  Comme je l'ai d√©j√† dit, nous d√©ployons des dizaines de nouvelles r√®gles WAF chaque semaine, et nous avons de nombreux syst√®mes de protection contre les cons√©quences n√©gatives d'un tel d√©ploiement.  Et quand quelque chose se passe mal, c'est g√©n√©ralement une combinaison de plusieurs circonstances.  Si vous ne trouvez qu'une seule raison, cela est bien s√ªr apaisant, mais pas toujours vrai.  Voici les raisons qui, ensemble, ont conduit √† l'√©chec de notre service HTTP / HTTPS. </p><br><ol><li>  L'ing√©nieur a √©crit une expression r√©guli√®re qui pourrait entra√Æner un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">retour en arri√®re</a> excessif. </li><li>  Un outil qui pouvait emp√™cher une utilisation excessive des ressources processeur utilis√©es par l'expression r√©guli√®re a √©t√© supprim√© par erreur lors du refactoring WAF quelques semaines auparavant - un refactoring √©tait n√©cessaire pour que le WAF consomme moins de ressources. </li><li>  Le moteur regex n'avait aucune garantie de complexit√©. </li><li>  La suite de tests n'a pas pu r√©v√©ler une consommation excessive de CPU. </li><li>  La proc√©dure SOP permet le d√©ploiement global de modifications de r√®gles non urgentes sans processus en plusieurs √©tapes. </li><li>  Le plan de restauration a n√©cessit√© un assemblage WAF complet √† deux reprises, ce qui a pris beaucoup de temps. </li><li>  La premi√®re alerte mondiale d'alerte de trafic a fonctionn√© trop tard. </li><li>  Nous avons retard√© la mise √† jour de la page d'√©tat. </li><li>  Nous avons eu des probl√®mes d'acc√®s aux syst√®mes en raison d'un crash, et la solution de contournement n'a pas √©t√© suffisamment bien r√©solue. </li><li>  Les ing√©nieurs SRE ont perdu l'acc√®s √† certains syst√®mes car leurs informations d'identification ont expir√© pour des raisons de s√©curit√©. </li><li>  Nos clients n'avaient pas acc√®s au tableau de bord ou √† l'API Cloudflare car ils traversent la r√©gion Cloudflare. </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga">  Ce qui a chang√© depuis jeudi dernier </h3><br><p>  Tout d'abord, nous avons compl√®tement arr√™t√© tout travail sur les versions de WAF et proc√©dez comme suit: </p><br><ol><li>  R√©introduction de la protection contre les ressources processeur excessives que nous avons supprim√©es.  (Termin√©) </li><li>  V√©rifiez manuellement toutes les r√®gles 3868 dans les r√®gles g√©r√©es pour que WAF trouve et corrige d'autres cas potentiels de retour en arri√®re excessif.  (V√©rification termin√©e) </li><li>  Nous incluons le profilage des performances pour toutes les r√®gles dans la suite de tests.  (Pr√©vu: 19 juillet) </li><li>  Nous passons au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">moteur re2</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rust</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">regex</a> - les deux offrent des garanties pendant l'ex√©cution.  (Pr√©vu: 31 juillet) </li><li>  Nous r√©√©crivons SOP afin de d√©ployer les r√®gles par √©tapes, comme les autres logiciels de Cloudflare, mais en m√™me temps, nous avons la possibilit√© de d√©ployer un d√©ploiement global d'urgence si les attaques ont d√©j√† commenc√©. </li><li>  Nous d√©veloppons la possibilit√© d'un retrait urgent du tableau de bord et de l'API Cloudflare de la r√©gion Cloudflare. </li><li>  Nous automatisons la mise √† jour de la page d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tat de Cloudflare</a> . </li></ol><br><p>  √Ä long terme, nous abandonnons Lua WAF, que j'ai √©crit il y a plusieurs ann√©es.  Nous migrons WAF vers le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouveau syst√®me de pare-feu</a> .  Le WAF sera donc plus rapide et b√©n√©ficiera d'un niveau de protection suppl√©mentaire. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Cet √©chec a caus√© des probl√®mes √† nous et √† nos clients.  Nous avons rapidement r√©agi pour corriger la situation, et maintenant nous travaillons sur les failles dans les processus qui ont caus√© l'√©chec, et nous creusons encore plus pour nous prot√©ger des probl√®mes potentiels avec les expressions r√©guli√®res √† l'avenir en passant √† une nouvelle technologie. </p><br><p>  Nous avons tr√®s honte de cet √©chec et nous nous excusons aupr√®s de nos clients.  Nous esp√©rons que ces changements feront en sorte que cela ne se reproduise plus. </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy">  Application.  Retour arri√®re d'expression r√©guli√®re </h3><br><p>  Pour comprendre comment l'expression: </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p>  mang√© toutes les ressources du processeur, vous devez savoir un peu comment fonctionne le moteur regex standard.  Le probl√®me ici est le mod√®le <code>.*(?:.*=.*)</code> .  <code>(?:</code> et celui correspondant <code>)</code> n'est pas un groupe passionnant (c'est-√†-dire que l'expression entre parenth√®ses est regroup√©e en une seule expression). </p><br><p>  Dans le contexte d'une consommation excessive de ressources processeur, ce mod√®le peut √™tre d√©sign√© par <code>.*.*=.*</code> .  En tant que tel, le motif semble inutilement complexe.  Mais plus important encore, dans le monde r√©el, de telles expressions (similaires √† des expressions complexes dans les r√®gles WAF) qui demandent au moteur de faire correspondre un fragment suivi d'un autre fragment peuvent entra√Æner un retour en arri√®re catastrophique.  Et voici pourquoi. </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p>  En expression r√©guli√®re <code>.</code>  signifie que vous devez faire correspondre un caract√®re,. <code>.*</code> - faire correspondre z√©ro ou plusieurs caract√®res "avec avidit√©", c'est-√†-dire capturer un maximum de caract√®res, donc <code>.*.*=.*</code> signifie faire correspondre z√©ro ou plusieurs caract√®res, puis faire correspondre z√©ro ou plusieurs caract√®res, trouver caract√®re litt√©ral =, correspond √† z√©ro ou plusieurs caract√®res. </p><br><p>  Prenez la ligne de test <code>x=x</code> .  Il correspond √† l'expression <code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code> jusqu'au signe √©gal correspond au premier <code>x</code> (l'un des groupes <code>.*</code> correspond √† <code>x</code> et le second √† z√©ro).  <code>.*</code> after = correspond au dernier <code>x</code> . </p><br><p>  Pour une telle comparaison, 23 √©tapes sont n√©cessaires.  Le premier groupe <code>.*</code> <code>.*.*=.*</code> Agit "avec avidit√©" et correspond √† la ligne enti√®re <code>x=x</code> .  Le moteur passe au groupe suivant <code>.*</code> .  Nous n'avons plus de caract√®res √† faire correspondre, donc le deuxi√®me groupe <code>.*</code> Correspond √† z√©ro caract√®re (cela est autoris√©).  Ensuite, le moteur passe au signe <code>=</code> .  Il n'y a plus de caract√®res (le premier groupe <code>.*</code> Utilis√© l'expression enti√®re <code>x=x</code> ), aucune correspondance ne se produit. </p><br><p>  Et ici, le moteur d'expression r√©guli√®re revient au d√©but.  Il va dans le premier groupe <code>.*</code> Et le compare <code> x=</code> (au lieu de <code>x=x</code> ), puis prend le deuxi√®me groupe <code>.*</code> .  Le deuxi√®me groupe <code>.*</code> Mappe vers le deuxi√®me <code>x</code> , et encore une fois, nous n'avons plus de caract√®res.  Et lorsque le moteur atteint <code>=</code> v <code>.*.*=.*</code> Encore une fois, rien ne se passe.  Et il revient en arri√®re. </p><br><p>  Cette fois, le groupe <code>.*</code> Correspond toujours √† <code>x=</code> , mais au deuxi√®me groupe <code>.*</code> plus <code>x</code> , mais z√©ro caract√®re.  Le moteur essaie de trouver le symbole litt√©ral <code>=</code> dans le motif <code>.*.*=.*</code> , Mais ne sort pas (apr√®s tout, le premier groupe l'a d√©j√† occup√© <code>.*</code> ).  Et il revient en arri√®re. </p><br><p>  Cette fois, le premier groupe <code>.*</code> Ne prend que le premier x.  Mais le deuxi√®me groupe <code>.*</code> "Greedily" capture <code>=x</code> .  D√©j√† devin√© ce qui va se passer?  Le moteur essaie de faire correspondre litt√©ral <code>=</code> , √©choue et effectue le retour en arri√®re suivant. </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> ‚Äî   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  . </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   ¬´¬ª,   ¬´¬ª ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  ¬´¬ª      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> ‚Äî 5353. </p><br><p> ,    (      ) ‚Äî         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Programming Techniques: Regular expression search algorithm</a> (¬´ :    ¬ª).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     ‚Äî                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   ‚Äî   ,       .       ¬´¬∑¬ª    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    ‚äï      . <br>   1          .      ‚Äî a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  Dans la fig. 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    .  1. </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2. </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  Dans la fig. 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3. </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460863/">https://habr.com/ru/post/fr460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460851/index.html">SamsPcbGuide, Partie 10: Technologie - Soudage de composants sans plomb</a></li>
<li><a href="../fr460855/index.html">Comment utiliser PHP pour impl√©menter des microservices?</a></li>
<li><a href="../fr460857/index.html">Comment Namecoin Blockchain Research a pr√©dit les cyber-attaques RTM</a></li>
<li><a href="../fr460859/index.html">Conf√©rence IThink # 3 √† Kharkov - bas√©e sur la WWDC 2019</a></li>
<li><a href="../fr460861/index.html">Port√©e lexicale JavaScript et fermeture</a></li>
<li><a href="../fr460865/index.html">Les gens sur la lune. Les sources</a></li>
<li><a href="../fr460867/index.html">Sourcery pour convertir automatiquement en structures d'objets Realm</a></li>
<li><a href="../fr460869/index.html">Reconnaissance d'objets en temps r√©el sur iOS √† l'aide de YOLOv3</a></li>
<li><a href="../fr460873/index.html">Pourquoi Turok: Dinosaur Hunter pour N64 a des ann√©es d'avance sur son temps</a></li>
<li><a href="../fr460875/index.html">Comment nous, chez QIWI, sommes arriv√©s √† un style commun d'interaction entre View et ViewModel au sein de MVVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>