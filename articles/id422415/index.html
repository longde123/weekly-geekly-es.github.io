<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👨🏻 🤟🏻 🧜🏿 Python: metaprogramming dalam produksi. Bagian dua 🤦🏻 🧘🏾 🕣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kami terus berbicara tentang metaprogramming dengan Python. Ketika digunakan dengan benar, ini memungkinkan Anda untuk dengan cepat dan elegan menerap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: metaprogramming dalam produksi. Bagian dua</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/binarydistrict/blog/422415/"><p>  Kami terus berbicara tentang metaprogramming dengan Python.  Ketika digunakan dengan benar, ini memungkinkan Anda untuk dengan cepat dan elegan menerapkan pola desain yang rumit.  Di bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">terakhir</a> artikel ini, kami menunjukkan bagaimana metaclasses dapat digunakan untuk mengubah atribut instance dan kelas. </p><br><p><img src="https://habrastorage.org/webt/ls/ty/gh/lstyghddpotgif7f6jg8cl6kcbi.jpeg"></p><br><p> Sekarang mari kita lihat bagaimana Anda dapat mengubah panggilan metode.  Anda dapat mempelajari lebih lanjut tentang opsi metaprogramming di kursus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Advanced Python</a> . </p><a name="habracut"></a><br><h2 id="otladka-i-treysing-vyzovov">  Men-debug dan melacak panggilan </h2><br><p>  Seperti yang sudah Anda pahami, menggunakan metaclass, kelas apa pun dapat ditransformasikan melampaui pengakuan.  Misalnya, ganti semua metode kelas dengan yang lain atau terapkan dekorator yang sewenang-wenang untuk setiap metode.  Anda dapat menggunakan ide ini untuk men-debug kinerja aplikasi. </p><br><p>  Metaclass berikut ini mengukur waktu eksekusi setiap metode di kelas dan instansnya, serta waktu pembuatan instance itu sendiri: </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> contextlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> contextmanager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wrapt @contextmanager <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timing_context</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(operation_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       """</span></span> start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: logging.info(<span class="hljs-string"><span class="hljs-string">'Operation "%s" completed in %0.2f seconds'</span></span>, operation_name, time.time() - start_time) @wrapt.decorator <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func, instance, args, kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       .     https://wrapt.readthedocs.io/en/latest/         """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> timing_context(func.__name__): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> func(*args, **kwargs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DebugMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, method <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> attr.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>): <span class="hljs-comment"><span class="hljs-comment">#     attrs[attr] = timing(method) return super().__new__(mcs, name, bases, attrs) def __call__(cls, *args, **kwargs): with timing_context(f'{cls.__name__} instance creation'): #      return super().__call__(*args, **kwargs)</span></span></code> </pre> <br><p>  Mari kita lihat tindakan debugging: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=DebugMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name time.sleep(<span class="hljs-number"><span class="hljs-number">.7</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">.5</span></span>) user = User(<span class="hljs-string"><span class="hljs-string">'Michael'</span></span>) user.login() user.logout() user.create() <span class="hljs-comment"><span class="hljs-comment">#   INFO:__main__:Operation "User instance creation" completed in 0.70 seconds INFO:__main__:Operation "login" completed in 1.00 seconds INFO:__main__:Operation "logout" completed in 2.00 seconds INFO:__main__:Operation "create" completed in 0.50 seconds</span></span></code> </pre> <br><p>  Coba <code>DebugMeta</code> dan logging tanda tangan dari metode dan stack-trace mereka. </p><br><h2 id="pattern-odinochka-i-zapret-nasledovaniya">  Pola penyendiri dan larangan pewarisan </h2><br><p>  Dan sekarang mari kita beralih ke kasus eksotis menggunakan metaclasses dalam proyek Python. </p><br><p>  Tentunya banyak dari Anda menggunakan modul Python biasa untuk menerapkan pola desain sendiri (alias Singleton), karena jauh lebih nyaman dan lebih cepat daripada menulis metaclass yang sesuai.  Namun, mari kita tulis salah satu implementasinya demi kepentingan akademis: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> instance = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cls.instance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: cls.instance = super().__call__(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls.instance <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=Singleton)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">f'&lt;User: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">&gt;'</span></span> u1 = User(<span class="hljs-string"><span class="hljs-string">'Pavel'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#         u2 = User('Stepan') &gt;&gt;&gt; id(u1) == id(u2) True &gt;&gt;&gt; u2 &lt;User: Pavel&gt; &gt;&gt;&gt; User.instance &lt;User: Pavel&gt; #   , ? &gt;&gt;&gt; u1.instance.instance.instance.instance &lt;User: Pavel&gt;</span></span></code> </pre> <br><p>  Implementasi ini memiliki nuansa yang menarik - karena konstruktor kelas tidak dipanggil untuk yang kedua kalinya, Anda dapat membuat kesalahan dan tidak melewatkan parameter yang diperlukan di sana, dan tidak ada yang akan terjadi saat runtime jika instance sudah dibuat.  Sebagai contoh: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>User(<span class="hljs-string"><span class="hljs-string">'Roman'</span></span>) &lt;User: Roman&gt; &gt;&gt;&gt; User(<span class="hljs-string"><span class="hljs-string">'Alexey'</span></span>, <span class="hljs-string"><span class="hljs-string">'Petrovich'</span></span>, <span class="hljs-number"><span class="hljs-number">66</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     ! &lt;User: Roman&gt; #     User       #    TypeError!</span></span></code> </pre> <br><p>  Sekarang mari kita lihat opsi yang lebih eksotis: larangan warisan dari kelas tertentu. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FinalMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cls <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bases: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(cls, FinalMeta): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> TypeError(<span class="hljs-string"><span class="hljs-string">f"Can't inherit </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{name}</span></span></span><span class="hljs-string"> class from final </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cls.__name__}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(mcs, name, bases, attrs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FinalMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   !"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(A)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment"># TypeError: Can't inherit B class from final A #    !</span></span></code> </pre> <br><h2 id="parametrizaciya-metaklassov">  Parameterisasi Metaclass </h2><br><p>  Dalam contoh sebelumnya, kami menggunakan metaclasses untuk menyesuaikan pembuatan kelas, tetapi Anda dapat melangkah lebih jauh dan mulai mengukur parameter perilaku metaclasses. </p><br><p>  Misalnya, Anda bisa meneruskan fungsi ke parameter metaclass saat mendeklarasikan kelas dan mengembalikan instance berbeda dari metaclasses tergantung pada beberapa kondisi, misalnya: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_meta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SOME_SETTING: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MetaClass1(name, bases, attrs) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MetaClass2(name, bases, attrs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=get_meta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Tetapi contoh yang lebih menarik adalah penggunaan parameter <code>extra_kwargs</code> ketika mendeklarasikan kelas.  Misalkan Anda ingin menggunakan metaclass untuk mengubah perilaku metode tertentu dalam suatu kelas, dan setiap kelas mungkin memiliki nama yang berbeda untuk metode ini.  Apa yang harus dilakukan  Dan inilah yang terjadi </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   `DebugMeta`     class DebugMetaParametrized(type): def __new__(mcs, name, bases, attrs, **extra_kwargs): debug_methods = extra_kwargs.get('debug_methods', ()) for attr, value in attrs.items(): #      ,   #    `debug_methods`: if attr in debug_methods: attrs[attr] = timing(value) return super().__new__(mcs, name, bases, attrs) class User(metaclass=DebugMetaParametrized, debug_methods=('login', 'create')): ... user = User('Oleg') user.login() #  "logout"   . user.logout() user.create()</span></span></code> </pre> <br><p>  Menurut saya, ternyata sangat elegan!  Anda dapat menemukan banyak pola untuk menggunakan parameterisasi ini, tetapi ingat aturan utamanya - semuanya baik-baik saja. </p><br><h2 id="primery-ispolzovaniya-metoda-__prepare__">  <code>__prepare__</code> Metode </h2><br><p>  Akhirnya, saya akan berbicara tentang kemungkinan penggunaan metode <code>__prepare__</code> .  Seperti disebutkan di atas, metode ini harus mengembalikan objek kamus, yang <code>__prepare__</code> oleh penerjemah pada saat menguraikan badan kelas, misalnya, jika <code>__prepare__</code> mengembalikan objek <code>d = dict()</code> , maka ketika membaca kelas berikut: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">:</span></span> x = <span class="hljs-number"><span class="hljs-number">12</span></span> y = <span class="hljs-string"><span class="hljs-string">'abc'</span></span> z = {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Penerjemah akan melakukan operasi berikut: </p><br><pre> <code class="python hljs">d[<span class="hljs-string"><span class="hljs-string">'x'</span></span>] = <span class="hljs-number"><span class="hljs-number">12</span></span> d[<span class="hljs-string"><span class="hljs-string">'y'</span></span>] = <span class="hljs-string"><span class="hljs-string">'abc'</span></span> d[<span class="hljs-string"><span class="hljs-string">'z'</span></span>] = {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Ada beberapa kemungkinan penggunaan untuk fitur ini.  Mereka semua memiliki berbagai tingkat utilitas, jadi: </p><br><ol><li>  Dalam versi Python = &lt;3.5, jika kita perlu menjaga urutan metode mendeklarasikan di dalam kelas, kita bisa mengembalikan <code>collections.OrderedDict</code> . <code>__prepare__</code> metode <code>__prepare__</code> , dalam versi yang lebih lama, kamus built-in sudah mempertahankan urutan penambahan kunci, jadi <code>OrderedDict</code> tidak lagi diperlukan. </li><li>  Modul perpustakaan standar <code>enum</code> menggunakan objek seperti dict khusus untuk menentukan kapan atribut kelas diduplikasi pada deklarasi.  Kode dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </li><li>  Sama sekali bukan kode siap produksi, tetapi contoh yang sangat bagus adalah dukungan untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">polimorfisme parametrik</a> . </li></ol><br><p>  Sebagai contoh, pertimbangkan kelas berikut dengan tiga implementasi metode polimorfik tunggal: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Terminator</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: int)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating INTEGER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: str)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating STRING </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: dict)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating DICTIONARY </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) t1000 = Terminator() t1000.terminate(<span class="hljs-number"><span class="hljs-number">10</span></span>) t1000.terminate(<span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>) t1000.terminate({<span class="hljs-string"><span class="hljs-string">'hello'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}) <span class="hljs-comment"><span class="hljs-comment">#  Terminating DICTIONARY 10 Terminating DICTIONARY Hello, world! Terminating DICTIONARY {'hello': 'world'}</span></span></code> </pre> <br><p>  Jelas, metode <code>terminate</code> terakhir dinyatakan menimpa implementasi dari dua yang pertama, dan kita perlu metode yang akan dipilih tergantung pada jenis argumen yang diteruskan.  Untuk mencapai ini, kami memprogram beberapa objek pembungkus tambahan: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyDict</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(dict)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" ,               PolyMethod. """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__setitem__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key: str, func)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> key.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self: super().__setitem__(key, PolyMethod()) self[key].add_implementation(func) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__setitem__(key, func) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyMethod</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,            .       ,       : instance method, staticmethod, classmethod. """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.implementations = {} self.instance = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.cls = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, instance, cls)</span></span></span><span class="hljs-function">:</span></span> self.instance = instance self.cls = cls <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_callable_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, impl)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ""  classmethod/staticmethod return getattr(impl, '__func__', impl) def __call__(self, arg): impl = self.implementations[type(arg)] callable_func = self._get_callable_func(impl) if isinstance(impl, staticmethod): return callable_func(arg) elif self.cls and isinstance(impl, classmethod): return callable_func(self.cls, arg) else: return callable_func(self.instance, arg) def add_implementation(self, func): callable_func = self._get_callable_func(func) #   ,     1  arg_name, arg_type = list(callable_func.__annotations__.items())[0] self.implementations[arg_type] = func</span></span></code> </pre> <br><p>  Hal yang paling menarik dalam kode di atas adalah objek <code>PolyMethod</code> , yang menyimpan registri dengan implementasi metode yang sama, tergantung pada jenis argumen yang diteruskan ke metode ini.  Kami akan mengembalikan objek <code>PolyDict</code> dari metode <code>__prepare__</code> dan dengan demikian menyimpan implementasi metode yang berbeda dengan nama yang sama <code>terminate</code> .  Poin penting - ketika membaca tubuh kelas dan ketika membuat objek <code>attrs</code> , penerjemah menempatkan apa yang disebut fungsi <code>unbound</code> sana, fungsi-fungsi ini belum tahu kelas atau contoh mana mereka akan dipanggil.  Kami harus mengimplementasikan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">protokol deskriptor</a> untuk mendefinisikan konteks selama pemanggilan fungsi dan meneruskan <code>self</code> atau <code>cls</code> sebagai parameter pertama, atau tidak memberikan apa-apa jika <code>staticmethod</code> dipanggil. </p><br><p>  Sebagai hasilnya, kita akan melihat keajaiban berikut: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__prepare__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PolyDict() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Terminator</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=PolyMeta)</span></span></span><span class="hljs-class">:</span></span> ... t1000 = Terminator() t1000.terminate(<span class="hljs-number"><span class="hljs-number">10</span></span>) t1000.terminate(<span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>) t1000.terminate({<span class="hljs-string"><span class="hljs-string">'hello'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}) <span class="hljs-comment"><span class="hljs-comment">#  Terminating INTEGER 10 Terminating STRING Hello, world! Terminating DICTIONARY {'hello': 'world'} &gt;&gt;&gt; t1000.terminate &lt;__main__.PolyMethod object at 0xdeadcafe&gt;</span></span></code> </pre> <br><p>  Jika Anda tahu ada kegunaan lain dari metode <code>__prepare__</code> , silakan tulis di komentar. </p><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>  Metaprogramming adalah salah satu dari banyak topik yang saya bicarakan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Advanced Python</a> .  Sebagai bagian dari kursus, saya juga akan memberi tahu Anda cara menggunakan prinsip-prinsip SOLID dan GRASP secara efektif dalam pengembangan proyek-proyek Python besar, merancang arsitektur aplikasi dan menulis kode kinerja tinggi dan berkualitas tinggi.  Saya akan senang melihat Anda di dinding Distrik Biner! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id422415/">https://habr.com/ru/post/id422415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id422403/index.html">20 September, Moskow - pertemuan untuk para analis</a></li>
<li><a href="../id422407/index.html">Temukan dan urutkan teks terkait</a></li>
<li><a href="../id422409/index.html">Python: metaprogramming dalam produksi. Bagian satu</a></li>
<li><a href="../id422411/index.html">Peran baru dalam perusahaan di era servitisasi</a></li>
<li><a href="../id422413/index.html">Aplikasi Arm Mbed OS. Penyetelan yang bagus</a></li>
<li><a href="../id422417/index.html">Slavik dan GMT + 3 atau manfaatkan untuk orang</a></li>
<li><a href="../id422419/index.html">Bukan tanpa panik di Go</a></li>
<li><a href="../id422421/index.html">Microsoft akan secara radikal meningkatkan Skype</a></li>
<li><a href="../id422423/index.html">Python dan DataScience: Menjelajahi Kekuatan Perpustakaan Universal Numpy</a></li>
<li><a href="../id422425/index.html">Tinjauan umum metode pasca-pemrosesan untuk model cetak 3D FDM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>