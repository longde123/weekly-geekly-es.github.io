<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçë üïâÔ∏è üçî Mon compilateur pour Lisp üå≤ ü§úüèª üåΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je suis tr√®s heureux d'annoncer la fin de mon premier compilateur pour un langage de programmation! Malcc est un compilateur incr√©mental Lisp AOT √©cri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mon compilateur pour Lisp</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446808/">  Je suis tr√®s heureux d'annoncer la fin de mon premier compilateur pour un langage de programmation!  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Malcc</a> est un compilateur incr√©mental Lisp <abbr title="En avance sur le temps">AOT</abbr> √©crit en C.</b> <br><br>  Je parlerai bri√®vement de ses nombreuses ann√©es de d√©veloppement et de ce que j'ai appris au cours du processus.  Titre alternatif de l'article: "Comment √©crire un compilateur en dix ans ou moins." <br><br>  (√Ä la fin, il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TL; DR</a> si vous ne vous souciez pas du fond). <br><a name="habracut"></a><br><h1>  D√©mo du compilateur </h1><br><pre><code class="plaintext hljs">tim ~/pp/malcc master 0 ‚Üí ./malcc Mal [malcc] user&gt; (println "hello world") hello world nil user&gt; (+ 1 2) 3 user&gt; (def! fib2 (fn* (n) (let* (f (fn* (n1 n2 c) (if (= cn) n2 (f n2 (+ n1 n2) (+ c 1))))) (f 0 1 1)))) &lt;lambda&gt; user&gt; (fib2 25) 75025 user&gt; ^D% tim ~/pp/malcc master 0 ‚Üí ./malcc examples/hello.mal hello world tim ~/pp/malcc master 0 ‚Üí ./malcc --compile examples/hello.mal hello gcc -g -I ./tinycc -I . -o hello hello.c ./reader.c ./printer.c ./hashmap.c ./types.c ./util.c ./env.c ./core.c ./tinycc/libtcc.a -ledit -lgc -lpcre -ldl tim ~/pp/malcc master 0 ‚Üí ./hello hello world tim ~/pp/malcc master 0 ‚Üí</code> </pre> <br><h1>  √âchecs r√©ussis </h1><br>  Pendant pr√®s de dix ans, j'ai r√™v√© d'√©crire un compilateur.  J'ai toujours √©t√© fascin√© par le travail des langages de programmation, en particulier les compilateurs.  Bien que j'imaginais le compilateur comme de la magie noire et comprenais qu'il √©tait impossible pour un simple mortel comme moi de le faire √† partir de z√©ro. <br><br>  Mais j'ai quand m√™me essay√© et √©tudi√© en cours de route! <br><br><h1>  Tout d'abord, l'interpr√®te </h1><br>  En 2011, j'ai commenc√© √† travailler sur un simple interpr√®te pour la langue fictive Airball (airball peut √™tre traduit par ¬´manchon¬ª).  Par son nom, vous pouvez √©valuer le degr√© d'incertitude que cela fonctionnera.  C'√©tait un programme Ruby assez simple qui analysait le code et parcourait un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arbre de syntaxe abstraite</a> (AST).  Lorsque l'interpr√®te fonctionnait toujours, je l'ai renomm√© en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lydia</a> et r√©√©crit en C pour le rendre plus rapide. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b4/902/4ee/6b49024ee04e02ae1b56776aa5ed05bc.png"><br><br>  Je me souviens que la syntaxe de Lydia me semblait tr√®s intelligente!  J'appr√©cie toujours sa simplicit√©. <br><br>  Bien que Lydia soit loin d'√™tre un compilateur parfait, cela m'a inspir√© pour continuer √† exp√©rimenter.  Cependant, j'√©tais encore tourment√© par des questions, comment faire fonctionner le compilateur: dans <i>quoi compiler?</i>  <i>dois-je apprendre l'assembleur?</i> <br><br><h1>  Deuxi√®mement, le compilateur et l'interpr√©teur de bytecode </h1><br>  Dans une prochaine √©tape, en 2014, j'ai commenc√© √† travailler sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schem-vm</a> , une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">machine virtuelle</a> pour Scheme √©crite en Ruby.  Je pensais qu'une machine virtuelle avec sa propre pile et son propre bytecode serait une √©tape de transition d'un interpr√®te avec des passes AST et un compilateur √† part enti√®re.  Et puisque Scheme est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">formellement d√©fini</a> , il n'est pas n√©cessaire d'inventer quoi que ce soit. <br><br>  Cela fait plus de trois ans que je joue avec le sch√©ma-vm et j'ai beaucoup appris sur la compilation.  Finalement, j'ai r√©alis√© que je ne pouvais pas terminer ce projet.  Le code s'est transform√© en v√©ritable chaos, mais il n'y avait pas de fin en vue.  Sans mentor ni exp√©rience, je semblait errer dans le noir.  Il s'est av√©r√© que <i>la sp√©cification de la</i> langue n'est pas la m√™me que celle du <i>manuel</i> .  Le√ßon apprise! <br><br>  √Ä la fin de 2017, j'ai report√© le sch√©ma-vm √† la recherche de quelque chose de mieux. <br><br><h1>  Rencontre avec Mal </h1><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/386/7e7/183/3867e7183f1ec919f168fcfefc2ec6b3.png"></a> <br><br>  En 2018, je suis tomb√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Mal</a> , un interpr√®te Lisp de style Clojure. <br><br>  Le mal a √©t√© invent√© par Joel Martin comme outil de formation.  Depuis lors, plus de 75 impl√©mentations dans diff√©rents langages ont √©t√© d√©velopp√©es!  Quand j'ai regard√© ces impl√©mentations, j'ai r√©alis√© qu'elles aidaient beaucoup: si je suis bloqu√©, alors je peux aller chercher des astuces dans la version Ruby ou Python.  Enfin, au moins quelqu'un parle ma langue! <br><br>  J'ai aussi pens√© que si je pouvais √©crire un interpr√®te pour Mal, je pourrais r√©p√©ter les m√™mes √©tapes - et faire un compilateur pour Mal. <br><br><h1>  Interpr√®te mal sur Rust </h1><br>  Tout d'abord, j'ai commenc√© √† d√©velopper l'interpr√®te selon la <a href="">proc√©dure pas √† pas</a> .  √Ä cette √©poque, j'√©tudiais activement Rust (je vais le laisser pour un autre article), j'ai donc √©crit ma propre impl√©mentation de Mal in Rust: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mal-rust</a> .  Voir ici pour en savoir plus sur cette exp√©rience. <br><br>  <b>Ce fut un plaisir parfait!</b>  Je ne sais pas comment remercier ou f√©liciter Joel pour avoir cr√©√© un excellent guide de Mal.  Chaque √©tape est d√©crite <i>en d√©tail</i> , il y a des organigrammes, des pseudo-codes et des <b>tests</b> !  Tout ce dont un d√©veloppeur a besoin pour cr√©er un langage de programmation du d√©but √† la fin. <br><br>  Vers la fin du tutoriel, j'ai r√©ussi √† ex√©cuter mon impl√©mentation Mal pour Mal, √©crite en mal, en plus de mon impl√©mentation Rust.  (deux niveaux de profondeur, wow).  Quand elle a travaill√© pour la premi√®re fois, j'ai saut√© sur une chaise avec enthousiasme! <br><br><h1>  Compiler Mal C </h1><br>  D√®s que j'ai prouv√© la viabilit√© du mal-rust, j'ai imm√©diatement commenc√© √† rechercher comment √©crire un compilateur.  Compiler vers l'assembleur?  Puis-je compiler le code machine directement? <br><br>  J'ai vu l'assembleur x86 √©crit en Ruby.  Il m'a intrigu√©, mais l'id√©e de travailler avec l'assembleur m'a fait arr√™ter. <br><br>  √Ä un moment donn√©, je suis tomb√© sur ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commentaire sur Hacker News</a> , qui faisait r√©f√©rence au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compilateur Tiny C</a> comme un ¬´backend de compilation¬ª.  Cela semblait √™tre une excellente id√©e! <br><br>  TinyCC a un fichier de test montrant <a href="">comment utiliser libtcc</a> pour compiler du code C √† partir d'un programme C. C'est le point de d√©part de ¬´hello world¬ª. <br><br>  Revenant √† nouveau √† la proc√©dure pas √† pas de Mal, rappelant ma connaissance de C, dans quelques mois de soir√©es et de week-ends gratuits, j'ai pu √©crire le compilateur Mal.  Ce fut un vrai plaisir. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/187/2e2/99e/1872e299effaaea82a3716cd48cdf27a.png"></a> <br><br>  Si vous avez l'habitude de d√©velopper par le biais de tests, √©valuez la disponibilit√© d'un ensemble pr√©liminaire de tests.  Les tests conduisent √† une impl√©mentation fonctionnelle. <br><br>  Je ne peux pas dire grand-chose sur ce processus, sauf si je le r√©p√®te: le manuel Mal est un vrai tr√©sor.  √Ä chaque √©tape, je savais exactement quoi faire! <br><br><h1>  Des difficult√©s </h1><br>  Avec le recul, voici quelques difficult√©s lors de l'√©criture du compilateur Mal, o√π j'ai d√ª bricoler: <br><br><ol><li>  Les macros doivent √™tre compil√©es √† la vol√©e et √™tre pr√™tes √† √™tre ex√©cut√©es au moment de la compilation.  C'est un peu d√©routant. <br></li><li>  Il est n√©cessaire de fournir un ¬´environnement¬ª (un arbre de hachages / tableaux associatifs / dictionnaires avec des variables et leurs valeurs) √† la fois pour le code du compilateur et pour le code final du programme compil√©.  Cela vous permet de d√©finir des macros au moment de la compilation. <br></li><li>  √âtant donn√© que l'environnement est disponible au moment de la compilation, Malcc a initialement d√©tect√© des erreurs <i>non d√©finies</i> lors de la compilation (acc√®s √† une variable qui n'√©tait pas d√©finie), et √† quelques endroits, cela a viol√© les attentes de la suite de tests.  Au final, pour r√©ussir les tests, j'ai d√©sactiv√© cette fonctionnalit√©.  Ce serait formidable de l'ajouter en tant que drapeau suppl√©mentaire du compilateur, car de cette fa√ßon, vous pouvez attraper beaucoup d'erreurs √† l'avance. </li><li>  J'ai compil√© du code C en √©crivant sur trois lignes de la structure: <ul><li>  <code>top</code> : code de niveau sup√©rieur - voici les fonctions </li><li>  <code>decl</code> : d√©claration et initialisation des variables utilis√©es dans le corps </li><li>  <code>body</code> : corps o√π le travail principal est effectu√© </li></ul></li><li>  Toute la journ√©e, je me suis demand√© si je pouvais √©crire mon propre ramasse-miettes, mais j'ai d√©cid√© de quitter cet exercice pour plus tard.  La biblioth√®que de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">collecte de d√©chets Boehm-Demers-Weiser</a> est facile √† connecter et disponible sur de nombreuses plates-formes. <br></li><li>  Il est important de regarder le code que votre compilateur √©crit.  Chaque fois que le compilateur rencontrait une variable d'environnement <code>DEBUG</code> , il renvoyait du code C compil√© o√π les erreurs pouvaient √™tre affich√©es. </li></ol><br><h1>  Que ferais-je sinon </h1><br><ol><li>  √âcrire du code C et essayer de garder l'indentation n'√©tait pas facile, alors je ne refuserais pas l'automatisation.  Il me semble que certains compilateurs √©crivent du code laid, puis une biblioth√®que sp√©ciale le "d√©core" avant de le publier.  Il faut l'√©tudier! <br></li><li>  L'ajout de lignes lors de la g√©n√©ration de code est un peu compliqu√©.  Vous pouvez envisager de cr√©er un AST, puis de le convertir √† la derni√®re ligne de code C. Cela devrait mettre le code en ordre et donner l'harmonie. </li></ol><br><a name="1"></a><h1>  Maintenant des conseils </h1><br>  J'aime que cela ait pris pr√®s d'une d√©cennie pour le compilateur.  Non vraiment.  Chaque √©tape sur le chemin est un agr√©able souvenir de la fa√ßon dont je suis progressivement devenu un meilleur programmeur. <br><br>  Mais cela ne veut pas dire que j'ai "fini".  Il existe encore des centaines de m√©thodes et d'outils que vous devez apprendre √† vous sentir comme un v√©ritable auteur de compilateur.  Mais je peux dire en toute confiance: "Je l'ai fait." <br><br>  Voici l'ensemble du processus sous une forme concise, comment cr√©er votre propre compilateur Lisp: <br><br><ol><li>  Choisissez la langue dans laquelle vous vous sentez √† l'aise.  Vous ne voulez pas apprendre simultan√©ment une nouvelle langue et comment √©crire une autre nouvelle langue. <br></li><li>  En suivant <a href="">le manuel de Mal,</a> √©crivez un interpr√®te. <br></li><li>  R√©jouis-toi! <br></li><li>  Suivez √† nouveau les instructions, mais au lieu d'ex√©cuter le code, √©crivez le code qui ex√©cute le code.  (Pas seulement ¬´refactoring¬ª de l'interpr√©teur existant. Vous devez recommencer √† z√©ro, bien que le copier-coller ne soit pas interdit). </li></ol><br>  Je crois que cette m√©thode peut √™tre utilis√©e avec n'importe quel langage de programmation qui se compile dans un fichier ex√©cutable.  Par exemple, vous pouvez: <br><br><ol><li>  √âcrivez l'interpr√®te de Mal sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Go</a> . </li><li>  Modifiez votre code pour: <br><ul><li>  cr√©er une ligne de code Go et l'√©crire dans un fichier; </li><li>  compiler ce fichier r√©sultant avec <code>go build</code> . </li></ul></li></ol><br>  Id√©alement, il vaut mieux contr√¥ler le compilateur Go en tant que biblioth√®que, mais c'est aussi un moyen de faire un compilateur! <br><br>  Avec l'aide du guide de Mal et votre ing√©niosit√©, vous pouvez faire tout cela.  Si m√™me je le pouvais, alors vous le pouvez! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446808/">https://habr.com/ru/post/fr446808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446794/index.html">Nous travaillons correctement avec Wordstat. Guide complet</a></li>
<li><a href="../fr446796/index.html">Circuit non standard: indicateur √† sept segments sur ATtiny13</a></li>
<li><a href="../fr446798/index.html">Le d√©part d'un ing√©nieur √©lectronique d'Apple a fait sensation parmi les sp√©culateurs boursiers. Comment devenir comme lui?</a></li>
<li><a href="../fr446802/index.html">Recharge de cartouches Dot - c'est int√©ressant</a></li>
<li><a href="../fr446806/index.html">Contexte: "Runet autonome" - qu'est-ce que c'est et qui en a besoin</a></li>
<li><a href="../fr446810/index.html">Si vous avez un paquet de cigarettes dans votre poche ...</a></li>
<li><a href="../fr446812/index.html">Mobilit√© et respect de l'environnement: comment les trolleybus modernes peuvent rouler sans chariots</a></li>
<li><a href="../fr446816/index.html">OOP, la "Sainte Trinit√©" et SOLIDE: quelques connaissances minimales √† leur sujet</a></li>
<li><a href="../fr446818/index.html">V√©nus, la Lune, ci-apr√®s partout: une entrevue avec Pavel Shubin</a></li>
<li><a href="../fr446820/index.html">Webinaire - Authentification et ES dans les environnements VDI √† l'aide de clients l√©gers Dell et de dongles JaCarta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>