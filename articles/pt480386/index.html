<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úÇÔ∏è üçÅ üé≥ Backups autom√°ticos de equipamentos de rede e seu armazenamento no sistema de controle de vers√£o üï∫ üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ üë®üèº‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esclarecimento: a solu√ß√£o est√° configurada para D-Link DFL, cisco 29xx e WatchGuard Firebox, mas √© adequada para tudo o que pode fazer backup ao conec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Backups autom√°ticos de equipamentos de rede e seu armazenamento no sistema de controle de vers√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480386/">  Esclarecimento: a solu√ß√£o est√° configurada para D-Link DFL, cisco 29xx e WatchGuard Firebox, mas √© adequada para tudo o que pode fazer backup ao conectar via ssh e / ou carreg√°-los em um agendamento / evento para o servidor ftp / tftp. <br><br>  Tudo come√ßou com o fato de meu amigo programador perguntar: "Por que voc√™ n√£o armazena configura√ß√µes de rede no sistema de controle de vers√£o?"  E a verdade - pensei - por qu√™?  A maioria dos arquivos de configura√ß√£o pode ser baixada em formato de texto (bem, esses s√£o bin√°rios, √© claro, mas as informa√ß√µes leg√≠veis s√£o abertas e exibidas em um editor de texto). <br><a name="habracut"></a><br>  Na rede, temos cerca de 30 DFLs D-Link diferentes, uma d√∫zia de Cisco 29xx e duas WatchGuard Firebox.  Para cada dispositivo, os funcion√°rios de n√≠vel de administrador da filial de TI, onde est√°, al√©m da TI da matriz, t√™m acesso no n√≠vel de administrador.  Isso envolve problemas como "eu n√£o fiz backup por seis meses e quebrei tudo, voc√™ tem o nosso backup?" E "o equipamento queimou o √∫ltimo backup fez o administrador anterior, n√£o sei onde, nos configurar como estava".  E se o Cisco j√° redefine automaticamente o running-config para ftp toda vez que √© salvo, esse n√£o √© o caso do D-Link.  E o sistema de controle de vers√£o ajudaria a rastrear problemas como "N√£o lembro o que e quando mudei, mas temos algo que √© usado uma vez que um m√™s est√° quebrado".  O regulamento de backup n√£o salva voc√™ do fator humano e n√£o faz backup para voc√™; portanto, √© melhor advertir do que desembara√ßar. <br><br>  Eu admito sinceramente, antes de me sentar para escrever um post, eu n√£o sabia sobre ran√ßo e oxida√ß√£o.  Mas os dois n√£o sabem o que eu preciso por completo.  O primeiro √© voltado para cisco e n√£o funciona muito bem com ex√≥ticos, o segundo n√£o possui autoriza√ß√£o do usu√°rio (embora isso possa ser feito com simples manipula√ß√µes com o servidor da web) e, o mais importante, ambos exigem um login e senha para o sistema redundante.  Todos os DFLs de link D suportam login ssh.  A Cisco mescla os pr√≥prios backups e geralmente n√£o requer conex√£o com ele.  Portanto, por que manter as senhas alteradas periodicamente, al√©m disso, se voc√™ pode fazer login usando a chave. <br><br>  Foi decidido fazer algo que me conv√©m por conta pr√≥pria. <br><br>  Na verdade, os backups autom√°ticos imploram por um longo tempo.  Mas o sistema de controle de vers√£o - era novo. <br><br>  <i>Portanto, a tarefa: coletar todas as configura√ß√µes significativas do equipamento de rede em um local com suporte para arquivos de vers√£o, atualiz√°-las regularmente automaticamente l√°, para permitir que administradores em outro fuso hor√°rio as baixem de uma maneira simples, sem me ligar √†s 3 da manh√£.</i>  <i>Tudo isso, √© claro, √© gratuito.</i> <br><br>  Para todos os DFLs, o arquivo de configura√ß√£o √© chamado de mesmo, portanto, era necess√°rio nome√°-los claramente ao copiar.  Eu tamb√©m n√£o queria reconfigurar o sistema de preenchimento de configura√ß√£o em execu√ß√£o existente para ftp com cisco. <br><br><h4>  Primeiro, configure um sistema de controle de vers√£o </h4><br>  Eu peguei svn, tk.  svn √© o √∫nico popular que armazena bin√°rios diff, nem todos os arquivos do hist√≥rico.  N√£o que isso fosse importante em pequenos volumes, mas agrad√°vel.  Em geral, levo em considera√ß√£o a pequena quantidade de arquivos de configura√ß√£o que o sistema de controle de vers√£o deve levar - sem diferen√ßa. <br><br>  O servidor Visual SVN √© instalado no <a href="https://www.visualsvn.com/server/getting-started/">site oficial</a> usando o m√©todo pronto para uso.  Coloquei-o em um servidor no Windows, para facilitar a administra√ß√£o dos colegas (criar usu√°rios, distribuir direitos).  Em seguida, um reposit√≥rio √© criado, as se√ß√µes necess√°rias s√£o criadas nele e o √∫nico usu√°rio com direitos totais ao reposit√≥rio √© criado (por enquanto).  No Windows, as a√ß√µes s√£o conclu√≠das. <br><br>  Os backups autom√°ticos s√£o feitos por mim a partir de uma √∫nica m√°quina Linux (no Debian). <br><br>  Primeiro, configuramos o svn para termos um cliente: <br><br><pre><code class="bash hljs">sudo apt-get install svn</code> </pre> <br>  Agora, uma c√≥pia do projeto √© criada manualmente (criada no diret√≥rio atual): <br><br><pre> <code class="bash hljs">svn checkout https://servername.mydomain.ru/svn/DFL_BACKUPS/ DFL_BACKUPS --username go</code> </pre> <br>  Agora eu tenho tr√™s se√ß√µes no reposit√≥rio: <br><br><ul><li>  Current_backup, onde as configura√ß√µes DFL da D-Link s√£o armazenadas e substitu√≠das. </li><li>  Old_versions, em que configura√ß√µes com uma data atribu√≠da s√£o armazenadas para facilitar o download pelos administradores da filial. </li><li>  Cisco, onde as configura√ß√µes de Cisco e WatchGuard Firebox s√£o armazenadas (bem, aconteceu). </li></ul><br><h4>  Vamos come√ßar com os backups autom√°ticos do DFL e configurar o pr√≥prio DFL </h4><br>  A conex√£o continua no ssh.  Para n√£o exibir senhas de forma aberta, √© usado um par de chaves p√∫blico-privado.  Privado √© armazenado no servidor em / usr / dfl_scripts / sshkeys / dfl_key. <br><br>  Geramos um par de chaves p√∫blico-privadas no servidor de backup autom√°tico: <br><br><pre> <code class="bash hljs">ssh-keygen ‚Äìt rsa</code> </pre> <br>  o aberto √© derramado em todas as DFLs e a regra de acesso ssh √© feita: <br><br><img src="https://habrastorage.org/webt/xd/n5/8b/xdn58ban40oax7jrapthgpok6jy.png"><br><br><img src="https://habrastorage.org/webt/qf/ll/3y/qfll3y-dxfmrpyd5l9samttd2xq.png"><br><br>  Bem, o gerenciamento remoto correspondente √© permitido.  A porta do padr√£o pode ser alterada para, por exemplo, 2222, embora o acesso seja poss√≠vel apenas a partir de determinados endere√ßos. <br><br><img src="https://habrastorage.org/webt/up/ej/6t/upej6ttpsxpj0w6-mdwsgwi_psc.png"><br><br>  O arquivo com a configura√ß√£o atual do D-Link DFL est√° na raiz e √© chamado config.bak; voc√™ pode simplesmente copi√°-lo para si mesmo usando scp. <br><br>  Ent√£o, o script (cortei a lista de ramos para que n√£o houvesse folha): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash rm /usr/dfl_scripts/dflbackup/* #    dfls=( "amur:10.28.10.254" #  "arhangelsk:10.29.10.254" "buratia:10.3.10.254" "volgograd:10.34.10.254" "voronezh:10.36.10.254" "irkutsk_210:10.38.20.253" "irkutsk_260:10.38.20.254" "yaroslavl:10.76.10.254" ) rm /usr/dfl_scripts/log.txt # - for dfl in "${dfls[@]}" ; do #   - filial="${dfl%%:*}" #delete the longest substr :* search from the end of string ip_addr="${dfl##*:}" #delete the longest substr *: search from the head of string echo $filial $ip_addr &gt;&gt; /usr/dfl_scripts/log.txt #     scp -P 2222 -i /usr/dfl_scripts/sshkeys/dfl_key admin@$ip_addr:config.bak /usr/dfl_scripts/dflbackup/$filial.bak 2&gt;&gt;/usr/dfl_scripts/log.txt #   ,      done FILES=$(ls /usr/dfl_scripts/dflbackup) #     now=$(date +"%d_%m_%Y") #     for f in $FILES ; do #      (    ) cp /usr/dfl_scripts/dflbackup/$f /usr/dfl_scripts/DFL_BACKUPS/current_backup/$f #       cp /usr/dfl_scripts/dflbackup/$f /usr/dfl_scripts/DFL_BACKUPS/old_versions/${f%.bak}_$now.bak #        done cd /usr/dfl_scripts/DFL_BACKUPS #   svn  svn add * --force -q &gt;&gt; /usr/dfl_scripts/log.txt #  .    . svn commit -m "added backups $now" &gt;&gt; /usr/dfl_scripts/log.txt #     /usr/bin/mail it@mydomain.ru &lt; /usr/dfl_scripts/log.txt -s "   DFL" #    -  </span></span></code> </pre> <br>  O script √© compactado no cron e √© executado √†s 8:30 da manh√£ diariamente.  √â assim que o crontab se parece: <br><pre> <code class="bash hljs">30 08 * * * /usr/dfl_scripts/autobackup.sh 30 06 * * * /usr/dfl_scripts/ciscobackup.sh 00 06 * * 1 /usr/dfl_scripts/fireboxbackup.sh</code> </pre> <br><h4>  Agora sobre cisco </h4><br>  Nos pr√≥prios dispositivos, algo como isto est√° configurado: <br><br><pre> <code class="plaintext hljs">archive log config logging enable logging size 500 hidekeys path ftp://ftp.mydomain.ru/in/autolog/$H-$T write-memory ip ftp username user ip ftp password mypass ip scp server enable</code> </pre> <br>  Como resultado, o comando write-memory redefine a configura√ß√£o atual para ftp.  Meu ftp est√° em um servidor diferente de um monte de backups autom√°ticos.  Existem duas maneiras: fazer uma c√≥pia do reposit√≥rio nesse servidor e adicionar configura√ß√µes l√° ou copiar configura√ß√µes para um servidor vizinho.  Basicamente, toda a diferen√ßa √© se deve fazer cp ou scp. <br><br>  No diret√≥rio em que as configura√ß√µes com Cisco caem, coloquei o incron para monitorar a apar√™ncia dos arquivos.  Pela apar√™ncia do arquivo, eu o renomeio como deveria e copio-o para o servidor coletor de backup autom√°tico em um diret√≥rio tempor√°rio.  Ao recortar, os arquivos do diret√≥rio tempor√°rio s√£o carregados no svn.  No total, eu tenho no sistema de controle de vers√£o uma configura√ß√£o atualizada por um certo tempo, uma vez por dia.  Na minha opini√£o, isso √© suficiente, mas o sistema pode ser modificado sem problemas para qualquer lista de desejos. <br><br>  A configura√ß√£o do incrontab √© assim: <br><br><pre> <code class="bash hljs">/var/ftp/cisco/<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>/autolog/ IN_CREATE /usr/ftp_scripts/incron_cisco.sh <span class="hljs-variable"><span class="hljs-variable">$#</span></span> $%</code> </pre> <br>  O script em si: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [[ $2 == "IN_MOVED_TO" || $2 == "IN_CREATE" ]]; then sleep 10 filial="${1%%-*}" #delete the longest substr -* search from the end of string.        scp -P 2222 -i /usr/ftp_scripts/ssh_key_private /var/ftp/cisco/in/autolog/$1 go@10.10.10.220:/usr/dfl_scripts/ciscobackup/$filial.conf fi</span></span></code> </pre> <br>  O script agendado √© iniciado no servidor de backup autom√°tico de acordo com o agendamento: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash logfile=/usr/dfl_scripts/log_cisco.txt rm $logfile now=$(date +"%d_%m_%Y") cd /usr/dfl_scripts/DFL_BACKUPS cp /usr/dfl_scripts/ciscobackup/* /usr/dfl_scripts/DFL_BACKUPS/cisco/ svn add * --force ‚Äìq &gt;&gt; $logfile svn commit -m "added cisco backups $now" &gt;&gt; $logfile /usr/bin/mail it@mydomain.ru &lt; $logfile -s "   cisco  watchguard"</span></span></code> </pre> <br>  Como voc√™ pode ver, aqui tamb√©m estamos falando sobre o WatchGuard Firebox.  Eu estava francamente com pregui√ßa de criar um diret√≥rio separado para eles.  Portanto, os backups caem no ftp no mesmo local que o Cisco.  Os backups do WatchGuard em um script separado meia hora antes e geralmente uma vez por semana.  Observe que a sintaxe foi alterada da vers√£o de firmware 12.  Anteriormente, isso podia ser feito com uma imagem de backup no comando ftp e agora a exporta√ß√£o foi adicionada.  Nele, n√£o consegui configurar o login via ssh por chave, portanto, as senhas s√£o usadas. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash watchguards=( "10.10.10.20:password1" "10.97.10.20:password2" ) now=$(date +"%Y_%m_%d") for wg in "${watchguards[@]}" ; do ip_addr="${wg%%:*}" pass="${wg##*:}" sshpass -p $pass ssh backupuser@$ip_addr -p 4118 &lt;&lt; ENDME backup image WG_$now.fxi export image WG_$now.fxi 123456qQ to ftp://user:mypass@ftp.mydomain.ru/in/autolog/WG_$ip_addr-$now.fxi ENDME Done</span></span></code> </pre> <br>  Os bin√°rios do WatchGuard s√£o exportados apenas criptografados, portanto, com uma apar√™ncia de texto e uma diferen√ßa, n√£o funcionar√° muito bem.  Preste aten√ß√£o √† chave de criptografia: letras mai√∫sculas e min√∫sculas obrigat√≥rias e n√∫meros, no m√≠nimo 8 caracteres.  Em caso de n√£o conformidade, o comando simplesmente n√£o √© executado, n√£o √© indicado especificamente onde est√° o erro. <br><br>  Ent√£o, tudo foi feito.  Agora, colocamos o cliente em nosso computador de trabalho no Windows.  Voc√™ pode simplesmente visualizar arquivos e diferen√ßas no navegador, mas baixe a vers√£o de uma revis√£o espec√≠fica apenas do cliente.  Colocamos o TorToSiteSVN <a href="https://tortoisesvn.net/">no site oficial</a> . <br><br>  No servidor, crie um usu√°rio com os direitos necess√°rios (leitura) para as ramifica√ß√µes. <br><br>  Ent√£o voc√™ precisa inserir o cliente atrav√©s do menu de contexto em qualquer arquivo e conectar-se ao reposit√≥rio.  N√£o √© necess√°rio criar uma c√≥pia do reposit√≥rio se voc√™ n√£o planeja fazer altera√ß√µes nos arquivos.  Bem, tenha cuidado com isso, voc√™ precisar√° trabalhar com a c√≥pia atrav√©s do sistema de controle de vers√£o, e n√£o apenas com uma parte do sistema de arquivos. <br><br><img src="https://habrastorage.org/webt/ad/em/rh/ademrhhknkvi238fsidrcopdz7k.png"><br><br><img src="https://habrastorage.org/webt/y0/rw/6u/y0rw6udsymqsvwkx6ogqf4l6vyq.png"><br><br>  Para fazer diferen√ßas nos arquivos tex n√£o padr√£o, voc√™ precisa garantir que o SVN considere esses arquivos n√£o bin√°rios, mas texto.  Assim: <br><br><pre> <code class="bash hljs">svn propset svn:mime-type text/plain current_backup/*.bak</code> </pre> <br>  Execute este comando, por exemplo, no linux e fa√ßa commit. <br><br>  Bem, aqui est√£o as mudan√ßas, olhe atrav√©s dos olhos.  Vemos que as regras do firewall foram alteradas: <br><br><img src="https://habrastorage.org/webt/ud/ie/jo/udiejoi7fpnr_ygvyccifwrkbig.png"><br><br><img src="https://habrastorage.org/webt/zj/4m/kd/zj4mkdel7tj349yu7hfg1hrbpjm.png"><br><br>  √â mais conveniente assistir em um navegador. <br><br><img src="https://habrastorage.org/webt/tv/ik/8m/tvik8ma1udofihed0kogho38qwq.png"><br><br>  Se algo aconteceu, o administrador pode baixar o backup desejado sem gestos desnecess√°rios na data desejada. <br><br><img src="https://habrastorage.org/webt/z3/pn/q5/z3pnq5ofkfenlthrkdkjs4qyzcs.png"><br><br>  Embora, geralmente, o mais recente seja suficiente. <br><br>  De certa forma, a inven√ß√£o da bicicleta surgiu.  Mas ele trabalha no DFL da D-link h√° quase um ano, exatamente como eu preciso, e √†s vezes isso ajuda muito. <br><br>  Espero que algu√©m venha a calhar. <br><br>  Refer√™ncias: <br><br>  <a href="https://habr.com/ru/post/96101/">Sobre ran√ßo</a> <br>  <a href="https://www.watchguard.com/help/docs/fireware/12/en-US/CLI/index.html">Manual da WatchGuard Firebox CLI</a> <br>  <a href="http://www.bubnovd.net/2017/10/oxidized.html">Pro oxidado</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480386/">https://habr.com/ru/post/pt480386/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480368/index.html">Captura de vazamentos de mem√≥ria em C / C ++</a></li>
<li><a href="../pt480370/index.html">Confer√™ncia DEFCON 19. Os chefes adoram o Excel, os hackers tamb√©m</a></li>
<li><a href="../pt480374/index.html">Reagir √† DogBot da Robotics: Revolu√ß√£o na Ind√∫stria da Constru√ß√£o</a></li>
<li><a href="../pt480376/index.html">De jogos de computador a mensagens secretas: discuta ovos de P√°scoa em lan√ßamentos de vinil</a></li>
<li><a href="../pt480378/index.html">14 projetos de c√≥digo aberto para aprimorar as habilidades de ci√™ncia de dados (f√°cil, normal, dif√≠cil)</a></li>
<li><a href="../pt480388/index.html">Confer√™ncia HACKTIVITY 2012. A teoria do Big Bang: A evolu√ß√£o do pentesting na seguran√ßa aprimorada. Parte 1</a></li>
<li><a href="../pt480390/index.html">ONYX BOOX Livingstone - um leitor de um formato popular em um design incomum</a></li>
<li><a href="../pt480392/index.html">Confer√™ncia HACKTIVITY 2012. A teoria do Big Bang: A evolu√ß√£o do pentesting na seguran√ßa aprimorada. Parte 2</a></li>
<li><a href="../pt480394/index.html">Entrada cont√°bil duplicada em um banco de dados relacional</a></li>
<li><a href="../pt480396/index.html">Criamos um aplicativo de desktop nativo de plataforma cruzada no Angular</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>