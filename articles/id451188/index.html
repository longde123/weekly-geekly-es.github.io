<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚆 🚧 ⏹️ Sberbank atau di sana dan kembali 😇 👨🏻‍🚒 🧜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="BAB 1. Tamu yang tidak terduga 
 Semuanya berawal pada pagi yang naas itu ketika Manajer Proyek mengumumkan bahwa tenggat waktu pelaksanaan proyek har...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sberbank atau di sana dan kembali</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451188/"><img src="https://habrastorage.org/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg"><br><br><h2>  BAB 1. Tamu yang tidak terduga </h2><br>  Semuanya berawal pada pagi yang naas itu ketika Manajer Proyek mengumumkan bahwa tenggat waktu pelaksanaan proyek harus dikurangi dengan cepat dan pasti satu bulan.  Lebih tepatnya, proyek harus siap dalam 4 hari.  Tidak, PO kami bukan binatang buas, dan sama sekali tidak terlihat seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">burung hantu</a> (mungkin hanya sedikit seperti burung gagak), itu terjadi begitu saja.  Ya, jika perlu, itu perlu, terutama karena tim (dan saya adalah pengembang terkemuka tim "C") dijanjikan sesuatu yang enak.  Jam dan kalender adalah Kamis, 11:00, pada hari Senin, proyek harus siap. <br><br>  Sebagai permulaan, apa yang kita lakukan sama sekali.  Kami bergerak di bidang otomasi bioskop - pengontrolan peralatan otomatis dan jarak jauh, otomasi pemutaran film, pemantauan, panel video, dan sekarang juga terminal untuk penjualan tiket dan bar.  Secara khusus, paragraf terakhir dikhususkan untuk artikel ini. <br><a name="habracut"></a><br>  Proyek itu sendiri, yang harus diselesaikan sebelum Senin, adalah semacam lapisan antara server utama di Scala dan terminal pembayaran besi VeriFone VX 820 (pada kenyataannya, ada lebih banyak terminal, tetapi anggap saja sebagai contoh).  Jelas bahwa tidak ada yang akan memberi kita transaksi melalui itu begitu saja, oleh karena itu utilitas dan perpustakaan Sberbank / Arcus dan UCS digunakan.  Dengan demikian, skema kerja sebagai hasilnya harus sebagai berikut: <br><br><img src="https://habrastorage.org/webt/ak/k4/do/akk4do9scie61w_tobeuwpk6liu.png"><br><br>  Secara lahiriah, ini terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg"><br><br>  Juga, subsistem ini harus digunakan pada register kas standar yang semua orang lihat di bioskop mana pun di kasir. <br><br>  Menurut tradisi internal, kami menyebut setiap proyek tim kami nama dari mitologi Nordik Lama, untuk subsistem ini nama Gefjon dipilih - nama dewi kesuburan dan kesuburan (nama yang baik untuk server pembayaran, bukan? Nah, legenda tentang banteng yang memotong pulau idealnya sesuai dengan arsitektur saat ini, memutuskan pekerjaan dengan peralatan dari bahasa tingkat tinggi). <br><br>  Format pesan masuk dan keluar adalah server HTTP dengan beban JSON.  Ini adalah kompromi optimal antara Scala, yang sulit untuk mengisolasi data biner dari aliran soket dan C, yang sulit untuk bangun untuk mentransfer objek melalui jaringan.  Tidak banyak operasi yang mungkin perlu dilakukan pada: pembayaran, pembatalan, pengembalian, berbagai jenis laporan, membuka menu layanan dan ping.  Tidak terlihat rumit.  Karena ada tiga sistem perbankan (dan diharapkan penambahan keluarga), diputuskan untuk membagi proyek menjadi beberapa komponen: <br><br><img src="https://habrastorage.org/webt/rk/vm/sc/rkvmscw9ret9atfnts-nezxtaqg.png"><br><br>  Blok hijau adalah blok yang harus kita buat, blok biru adalah blok yang tidak bisa diubah dan yang disediakan bank. <br><br>  Karena masalah utama muncul hanya dengan perangkat lunak dari Sberbank, artikel secara keseluruhan akan dikhususkan untuk perangkap, yang kami hitung dengan kapal kami. <br><br><h2>  BAB 2. Domba panggang </h2><br><img src="https://habrastorage.org/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg"><br>  (foto: heaclub.ru) <br><br>  ... terlihat seperti ini.  Kode prototipe itu, yang ditulis beberapa bulan lalu untuk memperjelas semua orang di tingkat yang lebih tinggi bahwa kita dapat bekerja dengan aplikasi perbankan, tampak sama. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_KB * <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * null; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * grep; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT char * ptr; null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nul"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"findstr"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/dev/null"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"grep"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> sprintf(buf, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"= %sops.ini &gt;%s 2&gt;%s || "</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"echo %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=9,6,PINPAD_TEST &gt;&gt; %sops.ini"</span></span></span><span class="hljs-meta">, grep, TERM_ARCUS_TEST_PINPAD, TERM_PATH, null, null, TERM_ARCUS_TEST_PINPAD, TERM_PATH); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT ptr = buf; while (*ptr) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (*ptr == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'/'</span></span></span><span class="hljs-meta">) *ptr = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\\'</span></span></span><span class="hljs-meta">; ptr++; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Jelas bahwa ini tidak cocok untuk versi Produksi, jadi pada dasarnya perlu untuk menulis semuanya lagi. <br><br>  Setiap bank yang menyediakan perpustakaan untuk bekerja dengan terminal biasanya menyediakan dua opsi koneksi: melalui fungsi perpustakaan (.so / .dll) atau melalui utilitas siap pakai yang hanya perlu memberikan dua nilai - jenis operasi dan jumlah (bila diperlukan).  Secara teori, tidak ada yang rumit, hanya sesuatu <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%d %d"</span></span>, atoi(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]), atoi(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>])); system(buffer);</code> </pre> <br>  Hasil operasi akan ditempatkan di file "e", dan slip-cek di file "p".  Kirimkan saja file-file ini ke stdout dengan konversi ke JSON, sehingga server HTTP hanya mengirimkannya sebagai muatan tanpa memikirkan apa yang ada di sana. <br><br>  Tetapi artikel ini tidak akan diterbitkan jika semuanya begitu sederhana. <br><br><h2>  BAB 4. Melintasi gunung dan di bawah gunung </h2><br>  Versi awal implementasi adalah panggilan aplikasi sederhana - server HTTP disebut pembungkus yang diperlukan dengan parameter terpadu (misalnya, laporan-X adalah 4), dan utilitas, misalnya gfj_pilot, meluncurkan sb_pilot dengan parameter yang diperlukan untuk operasi ini (misalnya, laporan-X adalah 9) .  Kemudian utilitas pembungkus membaca hasil operasi dari e-file (misalnya, 2000 - "pembayaran ditolak, ulangi operasi") dan mengubahnya menjadi kesalahan universal (misalnya 3 - "Kesalahan membaca atau memproses kartu / akun, ulangi operasi").  Setelah itu, file "p" dikonversi ke base64 untuk menghindari pemformatan yang rusak dan dikirim bersama hasilnya ke stdout sebagai JSON. <br><br>  Semua ini bekerja dengan sempurna sampai pada suatu saat kami diberitahu bahwa ... <br><br>  ... ini tidak berfungsi di Windows. <br><br><img src="https://habrastorage.org/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg"><br><br>  Yah, lebih tepatnya, Windows itu sendiri tidak memiliki masalah (kecuali bahwa slip dihasilkan dalam pengkodean Cp-1251, dan konsol bekerja di CP866).  File "e" sama sekali tidak dibuat.  Meluncurkan utilitas perbankan secara langsung: <br><br><pre> <code class="plaintext hljs">C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 01.02.2019 16:51 91 646 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 20  5 659 718  2  37 567 004 672   #    (1)  10  (1000 ) C:\banks\sber\sb_pilot&gt;loadparm.exe 1 1000 C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 04.02.2019 12:28 216 commerr.log 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 01.02.2019 18:51 1 349 p 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 04.02.2019 12:28 92 218 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 19  5 659 029  2  37 567 008 768   C:\banks\sber\sb_pilot&gt;</code> </pre> <br>  Memang, tidak ada file "e".  Batu menuju Sberbank # 1.  Kami sedang menulis surat kepada Sberbank (kami kemudian menerima jawaban bahwa seharusnya demikian), dan karena tidak ada waktu untuk korespondensi dan kami harus mulai sekarang, kami sedang mencari solusi untuk mendapatkan hasilnya. <br><br><pre> <code class="plaintext hljs">04.02 12:28:55 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Result = 0 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2' 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 LOADPARM: Unloading GATE.DLL... 04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded 04.02 12:28:56 LOADPARM: GATE.DLL unloaded</code> </pre> <br>  Ya, hasilnya dapat diperoleh dari log sbkernel.log.  Nyaman, ditambah tidak ada hash peta untuk kemudian mengacaukan "Terima kasih" dari Sberbank.  Tidak bagus <br><br>  Anda harus terhubung ke perpustakaan pilot_nt.dll dan mengimpor fungsi-fungsi darinya.  Semuanya akan baik-baik saja, tapi ... Sebuah batu menuju Sberbank # 2: tidak ada perpustakaan seperti di Linux, Anda harus membuat dua aplikasi yang berbeda untuk platform yang berbeda - untuk linux, panggil utilitas sb_pilot (mirip dengan loadparm.exe, dengan cara batu # 3 untuk nama utilitas berbeda di bawah platform yang berbeda ), di bawah windows terhubung ke perpustakaan pilot_nt.dll. <br><br><h2>  BAB 5. Teka-teki dalam gelap </h2><br>  Pukul 19.00. <br><br>  Sberbank adalah perusahaan besar, sebagian besar solusi perangkat lunak diproduksi sesuai dengan GOST dan dokumen formal.  Kami masuk ke katalog yang disediakan Sberbank dengan perpustakaan: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs  30160 drwx------ 2 alex alex 4096  17 19:31 FAQ -rw-rw-r-- 1 alex alex 3398465  9 2018   UPOS    ().docx -rw-rw-r-- 1 alex alex 1182078  9 2018   UPOS  .docx -rw-rw-r-- 1 alex alex 853504  9 2018   .doc drwx------ 3 alex alex 4096  31 17:11     -rw-rw-r-- 1 alex alex 5280787  9 2018    POS-.docx -rw-rw-r-- 1 alex alex 1149640  9 2018  .docx drwx------ 2 alex alex 4096  28 2018  UPOS drwx------ 2 alex alex 4096  28 2018    -rw-rw-r-- 1 alex alex 3451601  9 2018     ().docx -rw-rw-r-- 1 alex alex 1956196  9 2018   .docx -rw-rw-r-- 1 alex alex 1043161  9 2018       ()_().docx -rw-rw-r-- 1 alex alex 4348157  9 2018  POS-.docx -rw-rw-r-- 1 alex alex 3970267  9 2018   .docx drwx------ 3 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 2644702  9 2018    POS-.docx drwx------ 2 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 1558211  9 2018   .png</code> </pre> <br>  Banyak hal bagus, tetapi kami hanya tertarik pada direktori untuk pengembang: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs/\ \ \ /  8704 -rw-rw-r-- 1 alex alex 47105  9 2018 1C.docx -rw-rw-r-- 1 alex alex 1824  9 2018 cardtype.h -rw-rw-r-- 1 alex alex 2590378  9 2018 cr_ttk_protocol_ru.rtf -rw-rw-r-- 1 alex alex 208  9 2018 deprtmnt.h -rw-rw-r-- 1 alex alex 16681  9 2018 errors.h drwx------ 6 alex alex 4096  28 2018 examples -rw-rw-r-- 1 alex alex 58575  9 2018 gate.h -rw-rw-r-- 1 alex alex 4218  9 2018 paramsln.h -rw-rw-r-- 1 alex alex 61693  9 2018 pilot_nt.h -rw-rw-r-- 1 alex alex 28160  9 2018 ReadTrack2.doc -rw-rw-r-- 1 alex alex 7417  9 2018 sbkernel.h -rw-rw-r-- 1 alex alex 144896  9 2018 sb_pilot.doc -rw-rw-r-- 1 alex alex 3525323  9 2018     ole- sbrf.dll.rtf -rw-rw-r-- 1 alex alex 46683  9 2018      gate.dll.chi -rw-rw-r-- 1 alex alex 255414  9 2018      gate.dll.chm -rw-rw-r-- 1 alex alex 814653  9 2018      gate.dll.pdf -rw-rw-r-- 1 alex alex 41618  9 2018      pilot_nt.chi -rw-rw-r-- 1 alex alex 241716  9 2018      pilot_nt.chm -rw-rw-r-- 1 alex alex 968753  9 2018      pilot_nt.pdf -rw-rw-r-- 1 alex alex 81  9 2018  .txt</code> </pre> <br>  Banyak kertas bekas, untuk jaga-jaga, baca kembali pilot_nt, dari mana kita mempelajari yang berikut: <br><blockquote>  Tabel 1. OS sb_pilot yang didukung. <br><div class="scrollable-table"><table><tbody><tr><th>  OS </th><th>  Kapasitas </th><th>  Nama modul </th></tr><tr><td>  Windows </td><td>  32 </td><td>  sb_pilot.exe </td></tr><tr><td>  Linux </td><td>  32 </td><td>  sb_pilot </td></tr><tr><td>  Dos </td><td>  16 </td><td>  sb_pilot.exe </td></tr></tbody></table></div></blockquote><br>  Ternyata utilitas untuk windows masih harus disebut sb_pilot.  Nah, batu menuju Sberbank # 4 untuk inkonsistensi dokumentasi sendiri. <br><blockquote>  Transfer hasil program. <br><br>  Di akhir program, dua file teks terbentuk - file pertukaran dan file cek. <br><br>  Yang pertama bernama e dan dimaksudkan untuk memberikan parameter operasi yang sempurna ke program panggilan.  Baris pertama dalam file ini berisi kode hasil operasi, dan teks yang dipisahkan koma yang menjelaskan pesan teks.  Kode 0 berarti pembayaran yang berhasil, nilai apa pun - penolakan atau ketidakmampuan untuk melakukan pembayaran. </blockquote><br><br><img src="https://habrastorage.org/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg"><br><br>  Dengan malas kami melempar satu batu lagi dan mulai mempelajari dokumentasi untuk menghubungkan perpustakaan secara langsung. <br><blockquote>  <b>Prosedur untuk memanggil fungsi perpustakaan</b> <br><br>  Ketika membayar (mengembalikan) pembelian dengan kartu kredit, program tunai harus memanggil fungsi card_authorize () dari perpustakaan Sberbank dengan mengisi bidang TType dan Jumlah dan menentukan nilai nol di bidang yang tersisa.  Di akhir fungsi, Anda perlu menganalisis bidang RCode.  Jika berisi nilai "0" atau "00", otorisasi dianggap berhasil diselesaikan, atau ditolak.  Selain itu, Anda harus memeriksa nilai bidang Periksa. <br><br>  Jika bukan NULL, itu harus dikirim untuk mencetak (dalam mode non-fiskal) dan kemudian <br>  hapus dengan memanggil fungsi GlobalFree ().  Saat menutup shift, program kas harus memanggil fungsi close_day () dari perpustakaan Sberbank dengan mengisi bidang TType = 7 dan menentukan nilai nol di bidang yang tersisa.  Di akhir fungsi, periksa nilai bidang Periksa. <br><br>  Jika bidang Periksa bukan NULL, itu harus dikirim untuk mencetak (dalam mode non-fiskal) dan kemudian dihapus dengan memanggil fungsi GlobaFree (). </blockquote>  Kedengarannya mudah, bahkan file header disediakan.  Nah, pasang, kompilasi dan ... <br><br><pre> <code class="cpp hljs">$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pilot_nt.h"</span></span></span><span class="hljs-meta"> int main(void) { return 0; } In file included from main.c:1:0: pilot_nt.h:525:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:544:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:567:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:590:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:627:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:668:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span></span></code> </pre> <br>  Ummm ... apa?  Buka pilot_nt.h: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta">{ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;...&gt; /** *    * ,         . */ struct auth_answer{ int TType; /**&lt; [in]  .  ::OpetationTypes */ unsigned long Amount; /**&lt; [in]    */ char RCode[3]; /**&lt; [out]    */ char AMessage[16]; /**&lt; [out]    */ int CType; /**&lt; [in,out]   */ char* Check; /**&lt; [out]  ,   GlobalFree    */ }; &lt;...&gt; struct auth_answer7{ auth_answer auth_answ; /**&lt; [in, out]   . . ::auth_answer */ &lt;---- THIS char AuthCode[MAX_AUTHCODE]; /**&lt; [out]  . 7 . */ char CardID [CARD_ID_LEN]; /**&lt; [out]  . 25 . */ int SberOwnCard; /**&lt; [out]     */ };</span></span></span></span></code> </pre> <br>  Segera, tanpa melihat batu untuk komentar dalam bahasa Rusia di CP1251 coding. <br><br>  Nah, batu paling serius: pengembang C ++ tersayang.  Jika Anda menulis extern "C", ini berarti bahwa kode di dalam blok harus dikompilasi oleh kompiler C.  Jika Anda TIDAK membuat `typedef` dari suatu struktur, maka setiap kali Anda menyebutkannya sebagai referensi jenis, Anda harus menulis kata kunci` struct`. <br><br>  Tambal file untuk pengembang, gantikan kata `struct` di mana pun dibutuhkan.  Menautkan ke perpustakaan `pilot_nt.dll`.  Kemenangan, bukan?  Kami meluncurkan aplikasi kami. <br><br><h2>  BAB 6. Dari Api ke Api </h2><br>  Nah, Anda mengerti, kan?  Aplikasi hanya macet.  Sampai ke utama.  Renungkan, tambahkan analog NIH dari fungsi errno untuk windows: GetLastError (batu # 3 menuju Microsoft, dua yang pertama adalah untuk penyandian). <br><br><pre> <code class="plaintext hljs">C:\banks\sber\WIN&gt;sb_pilot.exe 1 1000 E: !g_sblibrary (0xc0000096)</code> </pre> <br>  0xc0000096?  Tidakkah GetLastError mengembalikan kode kesalahan yang memadai? <br><blockquote>  Untuk daftar kode kesalahan lengkap yang disediakan oleh sistem operasi, lihat Kode Kesalahan Sistem. </blockquote>  Ya, buka artikel di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> : <br><blockquote>  Topik-topik berikut menyediakan daftar kode kesalahan sistem.  Nilai-nilai ini didefinisikan dalam file header WinError.h. <br><br><ul><li>  Kode Kesalahan Sistem (0-499) (0x0-0x1f3) </li><li>  Kode Kesalahan Sistem (500-999) (0x1f4-0x3e7) </li><li>  Kode Kesalahan Sistem (1000-1299) (0x3e8-0x513) </li><li>  Kode Kesalahan Sistem (1300-1699) (0x514-0x6a3) </li><li>  Kode Kesalahan Sistem (1700-3999) (0x6a4-0xf9f) </li><li>  Kode Kesalahan Sistem (4000-5999) (0xfa0-0x176f) </li><li>  Kode Kesalahan Sistem (6000-8199) (0x1770-0x2007) </li><li>  Kode Kesalahan Sistem (8200-8999) (0x2008-0x2327) </li><li>  Kode Kesalahan Sistem (9000-11999) (0x2328-0x2edf) </li><li>  Kode Kesalahan Sistem (12000-15999) (0x2ee0-0x3e7f) </li></ul></blockquote>  Oke, kami mendapat kesalahan tidak berdokumen, kami melempar batu dan membuka google mahatahu: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bbs.csdn.net/topics/80078275</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm</a> </li></ul><br>  Inti dari kesalahan adalah bahwa beberapa subrutin menggunakan salah satu instruksi <br><br><ul><li>  _inp () </li><li>  _inpw () </li><li>  _inpd () </li><li>  _outp () </li><li>  _outpw () </li><li>  _outpd () </li></ul><br>  Penggunaan yang dilarang di bawah inti NT, karena mereka mencoba untuk bekerja dengan port paralel secara langsung.  Rupanya, kode ini disebut di initializer perpustakaan, yaitu  perpustakaan saat startup ingin polling port untuk perangkat, tetapi kernel NT membutuhkan kerja melalui driver. <br><br>  Situasi tanpa harapan? <br><br><h2>  BAB 8. Laba-laba dan lalat </h2><br>  10 malam  Untuk berjaga-jaga, muncul ide untuk memverifikasi bahwa ini bukan karena kami menggunakan cross-compiling dengan Linux menggunakan mingw.  Pada saat yang sama, kami memahami bahwa Sberbank hanya memberikan aplikasi 32-bit, jadi itu tidak akan berfungsi dengan aplikasi 64-bit, oke, tapi tetap kami akan meluncurkan batu ke arah Sberbank untuk versi 32-satunya pada tahun 2019. <br><br>  <b>Diberikan</b> : diinstal di virtualbox windows 7; <br>  <b>Diperlukan</b> : Instal Visual Studio dan salin MVP. <br><br>  Kami pergi ke situs web Microsoft, mengunduh Visual Studio 2017. Kami mengambil lisensi komunitas, karena kami mengambilnya untuk verifikasi, untuk bisnis lisensi akan dibeli jika lepas landas. <br>  Unduh beberapa ratus megabyte dan ... <br><br>  Kami melihat bahwa versi OS kami (Windows 7) tidak didukung. <br><br>  Ok, kita pergi ke semua jenis situs cabul, kami mencari Visual Studio 2008, unduh beberapa ratus megabyte lagi dan ... <br><br>  Kami mendapatkan file iso. <br><br>  Oke, mari kita coba menginstal Daemon Tools 10 (karena ini adalah versi yang ditawarkan situs) untuk memasukkan disk virtual ini. <br><br>  Jalankan binar yang diunduh.  Misfire, membutuhkan .NET Framework 4.5, unduh, instal. <br>  Kami mulai binar yang diunduh, instalasi telah dimulai, bootloader mengatakan bahwa ia perlu 4.5.2, unduh, instal. <br>  Kami mulai binar yang diunduh, instalasi telah dimulai, bootloader mengatakan bahwa itu tidak akan pergi ke mana pun sampai kami menginstal pembaruan keamanan KB3033929, unduh, instal. <br><br>  Dan kami mendapat tamparan di wajah dari Microsoft sebagai pesan: <br><br><img src="https://habrastorage.org/webt/r6/qe/de/r6qedenl5w3dez4ysscvod8rmjw.png"><br><br>  Kami dengan keras melemparkan batu yang sangat tajam ke Microsoft, mengunduh Daemon Tools tua dari torrents, berhasil membongkar Visual Studio, menginstal, akhirnya (00:00) mengkompilasi MVP, kami mendapatkan kesalahan yang sama.  Ya, ada versi yang bagus, tetapi tidak tumbuh bersama. <br><br><h2>  BAB 11. Di ambang pintu </h2><br>  Kami sedang menulis kepada programmer kedua, yang saat ini dengan mendesak menyelesaikan server dan prosedur pendaftaran.  Dia ingat ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori</a> git yang menghubungkan ke perpustakaan ini di NT dan bekerja dengannya. <br><br>  Mencurigai melihat repositori, mengunduhnya, kompilasi dan menjalankannya.  Itu bekerja. <br><br><img src="https://habrastorage.org/webt/mt/gl/q-/mtglq-c68eyegv74wjnzjvpmddi.png"><br><br>  Kami melihat kode lebih curiga.  Kode identik, kecuali ditulis dalam C ++ dan bukan C. <br>  Kami memahami bahwa bahasa tidak ada hubungannya dengan itu.  Kami melihat perpustakaan Sberbank, yang menarik kode. <br>  Kami melihat komit terakhir. <br><br>  Dan di sini kita menunggu kejutan lain. <br><br>  Ternyata versi pustaka Sberbank mungkin berbeda.  Komit terakhir meningkatkan versi dari 23 menjadi 27.  Salin versi dari gita ke komputer uji Anda - BEKERJA! <br><br>  Kami memeriksa semua arsip yang dikirim oleh Sberbank, membandingkan versi dan membangun tablet: <br><div class="scrollable-table"><table><tbody><tr><th>  Versi </th><th>  Bekerja </th></tr><tr><td>  26.0.15 - Dasar </td><td>  tidak </td></tr><tr><td>  27.4.12 - Dari repositori </td><td>  iya </td></tr><tr><td>  23.0.13 - Dari repositori </td><td>  iya </td></tr><tr><td>  29.0.9 - Terbaru dari Sat </td><td>  iya </td></tr><tr><td>  23.0.13 - Dengan tambalan untuk sistem Cryptor </td><td>  iya </td></tr></tbody></table></div><br>  Hebat, sekarang mari kita sembuh.  Pada sistem yang harganya 26, tingkatkan ke 29 atau 27 dan semuanya akan berjalan. <br>  Kami melempar batu # 9 ke arah Sberbank karena melanggar perilaku pada sistem NT. <br><br><h2>  BAB 12. Apa yang menanti mereka di dalam </h2><br>  File e tidak cukup?  Tidak masalah, kami mengambil judul yang ditambal, tautan dinamis ke perpustakaan untuk mengembalikan kesalahan dengan benar, menulis kode yang hanya menulis kode pengembalian dari fungsi ke file "e", sebut saja biner sb_pilot.exe dan ... <br><br>  Untuk bekerja, itu berfungsi. <br><br>  Itu hanya versi untuk sistem "Cryptor" tidak membuat file "p". <br><br>  <i>Kami melihat dengan sedih darah yang menetes di buku-buku jari dan lekuk di dinding.</i> <br><br>  Sebagai permulaan, apa itu sistem Cryptor. <br><br>  Cryptera adalah perusahaan Denmark yang memproduksi peralatan enkripsi / peralatan keamanan / kunci, dll. Saya pikir Anda semua melihat salah satu salinan dari produk mereka: <br><br><img src="https://habrastorage.org/webt/pb/dz/85/pbdz85atzxiscdkdkq0z97ahhsm.png"><br><br>  Jadi, Sberbank menggunakan modul crypto mereka untuk pinpads dan merilis pustaka "tambalan" khusus, di mana, seperti yang sudah kita pahami, file "p" tidak dibuat.  Kami menulis kepada Sberbank tentang ini dan dalam beberapa hari kami akan mendapatkan jawaban bahwa "di bawah sistem asli, file" p "akan dibuat, tetapi di bawah ditambal ke Cryptor - no.  Kami akan memberi mereka batu nomor 10 dalam beberapa hari, karena Anda harus bekerja sekarang. <br><br>  Untungnya atau sayangnya, fungsi yang kami gunakan untuk melakukan operasi mengembalikan struktur yang telah disebutkan: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br>  Oh, baiklah, cek sudah ada di sana, kita dapat menyimpannya sendiri atau segera mencetaknya di JSON ... <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, answer.Check);</code> </pre> <br>  Dan kami mendapatkan aplikasi mogok karena akses ke pointer tidak valid. <br><br><h2>  BAB 14. Api dan air </h2><br>  Jam 4 pagi  Kami melakukan Seth Bandha Sarvangasana untuk menenangkan diri, dan dengan cermat membaca manual: <br><blockquote>  Gambar cek, harus dibebaskan oleh GlobalFree di program panggilan </blockquote>  Apa yang ini berikan pada kita?  Banyak.  Pertama, karena pointer perlu dibersihkan menggunakan GlobalFree, itu di-salocated menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GlobalAlloc</a> .  Oleh karena itu, ia tidak mengeluarkan pointer ke memori, seperti pada versi 16-bit, tetapi nomor objek dengan tipe HGLOBAL yang dideklarasi semantik, yang dapat dimasukkan dalam fungsi GlobalSize untuk mendapatkan ukuran blok yang dialokasikan dan GlobalLock untuk memblokir sepotong memori, tetapi mendapatkan pointer asli.  By the way, batu # 6 menuju Microsoft untuk NIH malloc dan gratis, yang ada di perpustakaan standar. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, GlobalLock(answer.Check));</code> </pre> <br>  Dan masih mendapatkan setetes.  Oke, apa yang ditampilkan GlobalSize?  Nol?  Entah bagaimana aneh. <br><br>  Kami memeriksa fungsi lain yang juga harus memberikan slip - kami melihat gambar yang sama. <br><br>  Hanya sampai di kepala saya bahwa saya dapat membuat slip sendiri berdasarkan data yang dapat diberikan fungsi pembayaran paling keren (ya, Sberbank memiliki fungsi yang disebut card_authorize2..14, saya tidak akan melempar batu untuk itu): <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer14</span></span></span><span class="hljs-class"> {</span></span> auth_answer ans; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]   . . ::auth_answer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AuthCode[MAX_AUTHCODE]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 7 . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardID[CARD_ID_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 25 .     ,   6   4,    '*'.*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ErrorCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> TransDate[TRANSDATE_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TransNumber; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    . , .    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SberOwnCard; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Hash[CARD_HASH_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]  SHA1   ,   ASCII     . 40 .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Track3[CARD_TRACK3_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]   */</span></span> DWORD RequestID; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   .  PCI DSS .*/</span></span> DWORD Department; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     0  14-, .      0xFFFFFFFF,          .        ,      4191. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RRN[MAX_REFNUM]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   ,  .    ,     .   12-  .       (   pilot_nt.dll),     –  (     ;     ,   ).*/</span></span> DWORD CurrencyCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    (810, 643, 840, 978  ..) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardEntryMode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    ('D'-., 'M'- , 'C'-, 'E'- EMV, 'R'- magstripe, 'F'-fallback)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardName[MAX_CARD_NAME_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AID[MAX_AID_ASCII_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out] Application ID   (   ASCIIZ-)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FullErrorText[MAX_FULL_ERROR_TEXT]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> DWORD GoodsPrice; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    ,  (34.99-&gt;3499)*/</span></span> DWORD GoodsVolume; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  ,  .  (30.234-&gt;30234)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsCode[MAX_GOODS_CODE+<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsName[MAX_GOODS_NAME]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     . !   auth_answer14         gate.dll TGoodsData.     */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/** @brief     * @param[in] track2      .  NULL,     . * @param[in,out] auth_answer . ::auth_answer14 * @param[in,out] payinfo     * @return int  . */</span></span> <span class="hljs-function"><span class="hljs-function">PILOT_NT_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card_authorize14</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *track2, struct auth_answer14 *auth_answer, struct payment_info_item *payinfo )</span></span></span></span>;</code> </pre> <br>   … ,        —     .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> : <br><blockquote> :  ,      ,        ;  ;   ;  ;  ;     ;   . </blockquote> ,       ,      . <br><br>     . <br><br>  ,      «examples» <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Authorization completion finished with code '"</span></span> &lt;&lt; result &lt;&lt; <span class="hljs-string"><span class="hljs-string">"'"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">ofstream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CHEQUE_FILENAME)</span></span></span></span>; file &lt;&lt; argument.auth_answ.Check; file.close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argument.auth_answ.Check) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Cheque saved to file "</span></span> &lt;&lt; CHEQUE_FILENAME &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-comment"><span class="hljs-comment">//GlobaFree(argument.auth_answ.Check); }</span></span></code> </pre> <br>   ,   .     ,     …        .    `file &lt;&lt; argument.auth_answ.Check;`,  , ,   #11   . <br><br> 7:00.      ,        Delphi.  ,     .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github</a> : <br><br><pre> <code class="cpp hljs">TAuthAnswer = packed record TType: integer; Amount: UINT; <span class="hljs-comment"><span class="hljs-comment">// IN     Rcode: array [0 .. 2] of AnsiChar; AMessage: array [0 .. 15] of AnsiChar; CType: integer; Check: PAnsiChar; end; Result := Func(nil, @FAuthAnswer); FLastError := Result; FCheque := PAnsiChar(FAuthAnswer.Check);</span></span></code> </pre> <br>       -  . <br><br>    . <br><br><h2>  17.   </h2><br>     ,   . PO       . <br><br>    .      #14           .    ,   <br><blockquote>  Perhatian!   auth_answer14         gate.dll TGoodsData.      </blockquote>      … <br><br>      .    <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br> … <br><br>   . <br><br>    Size = 0,    Lock = NULL. <br><br> . <br><br> . <br><br>       , ,   .   -           .     ,   ? <br><br><pre> <code class="cpp hljs"> u32 i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(answ); i++) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%02x "</span></span>, *((u8 *)&amp;answ + i)); } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); C:\banks\sber\sb_pilot&gt;sb_pilot.exe <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ce e4 ee e1 f0 e5 ed ee <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f8 <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">7</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br> `30 00 00 ce` —   ,      Packed .         .    ,          —    -   1 .       ! <br><br>        . 4 + 4 + 3 + 16 + 4 + 4 = 35.   36 , . <br><br>   36 ,      .   RCode  AMessage     .  ?    `__packed__`! <br><br><h2>  18.   </h2><br>  ,        2012 : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=52991</a> .     GCC 8 (  6  !),      .    workaround: <br><br><pre> <code class="cpp hljs">-mno-ms-bitfields</code> </pre> <br>        ,    : <br><br><img src="https://habrastorage.org/webt/ve/tr/d4/vetrd4m4rsdhmkyxkgrvxbkepko.png"><br><br> ! !    ,     - ,      . <br><br>  , ,  ,  ,  GlobalSize/Lock     . <br><br><h2>  19.   </h2><br>     ifdef'    sb_pilot    ,    linux- sb_pilot.      #1 ,    : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BXI_OS_GLX) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> defined(BXI_OS_WIN) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot.exe"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/webt/wo/eu/2g/woeu2gk8m1mvtibiepfxwiijrbo.png"><br><br>  : <br><br><ul><li> : 12  </li><li> : 7  </li><li> GCC: 1  </li></ul><br> -    : <br><br><img src="https://habrastorage.org/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id451188/">https://habr.com/ru/post/id451188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id451178/index.html">Tes Kecelakaan Pendaratan Parasut Kru Naga</a></li>
<li><a href="../id451180/index.html">PCB menggantikan dua motor linier</a></li>
<li><a href="../id451182/index.html">Bagaimana ukuran array C menjadi bagian dari antarmuka biner perpustakaan</a></li>
<li><a href="../id451184/index.html">Proyek Blue Moon Blue Moon: Orang-orang di Bulan pada tahun 2024</a></li>
<li><a href="../id451186/index.html">Repositori LINSTOR dan integrasinya dengan OpenNebula</a></li>
<li><a href="../id451196/index.html">Pemisahan profil pelanggan dan freelancer</a></li>
<li><a href="../id451198/index.html">Peran Augmented Reality Dan Virtual Reality Di NBA</a></li>
<li><a href="../id451200/index.html">Secara otomatis memperoleh sertifikat SSL oleh Let's Encrypt menggunakan tantangan DNS-01 dan AWS</a></li>
<li><a href="../id451204/index.html">Editor teks gratis untuk kolaborasi</a></li>
<li><a href="../id451206/index.html">Apa yang terjadi dengan repositori RDF sekarang?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>