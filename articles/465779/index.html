<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🎨 🎯 📮 Yealink T19 Autoaprovisionamiento + Libreta de direcciones dinámica 🧛🏼 👨‍✈️ 🏌️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando llegué a trabajar en esta empresa, ya tenía una base en dispositivos IP, varios servidores con asterisco y un chapoteo en forma de FreeBPX. Ade...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yealink T19 Autoaprovisionamiento + Libreta de direcciones dinámica</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465779/">  Cuando llegué a trabajar en esta empresa, ya tenía una base en dispositivos IP, varios servidores con asterisco y un chapoteo en forma de FreeBPX.  Además, la central telefónica analógica Samsung IDCS500 funcionaba en paralelo y, en general, era el principal sistema de comunicación de la empresa, la telefonía IP solo funcionaba para el departamento de ventas.  Y todo habría seguido hirviendo, pero un buen día se dictó el decreto para transferir a todos a la telefonía IP, se acordaron las fechas, se compró el equipo y comenzó a implementarse un plan para transferir la empresa al siglo XXI. <br>  Lo primero que comienza a molestar en esta situación es el número cada vez mayor de teléfonos que necesitan ser manejados de alguna manera, y lo segundo que fue muy preocupante fue la guía telefónica.  Si Endpoint Manager (que, por cierto, se eliminó de las últimas versiones de FreePBX) podría ayudarnos con la primera, entonces surgieron algunas preguntas con el libro: <br><br><ul><li>  En primer lugar, ¿cómo garantizar su precisión con un cambio constante de la dislocación / rotación de los usuarios? </li><li>  En segundo lugar, cómo despersonalizar completamente los teléfonos.  ¿Y no completa el nombre del contacto cada vez? </li></ul><br>  La tarea fue interesante, la solución no se hizo esperar.  Ahora daré una lista completa, y luego analizaremos en orden. <br><a name="habracut"></a><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scapy.all <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sniff <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scapy.layers.inet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IP <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mysql.connector <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ldap <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tftpy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> replace <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_ldap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(login)</span></span></span><span class="hljs-function">:</span></span> ad = ldap.initialize(<span class="hljs-string"><span class="hljs-string">'ldap://***.local'</span></span>) ad.simple_bind_s(<span class="hljs-string"><span class="hljs-string">'voip@***.local'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) basedn = <span class="hljs-string"><span class="hljs-string">'OU=IT,DC=***,DC=LOCAL'</span></span> basedn_user = <span class="hljs-string"><span class="hljs-string">'OU=***,OU=***,DC=***,DC=LOCAL'</span></span> scope = ldap.SCOPE_SUBTREE filterexp = <span class="hljs-string"><span class="hljs-string">"(&amp;(sAMAccountName="</span></span> + login + <span class="hljs-string"><span class="hljs-string">")(ObjectClass=person))"</span></span> filterexp2 = <span class="hljs-string"><span class="hljs-string">"(&amp;(ObjectClass=organizationUnit))"</span></span> attrlist = [<span class="hljs-string"><span class="hljs-string">'cn'</span></span>] attrlist2 = [<span class="hljs-string"><span class="hljs-string">'OU'</span></span>] search = ad.search_s(basedn, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname == <span class="hljs-string"><span class="hljs-string">' '</span></span>: search = ad.search_s(basedn_user, scope, filterexp2, attrlist2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(search)+<span class="hljs-number"><span class="hljs-number">1</span></span>): group = search[i][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'ou'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] basedn_user2 = <span class="hljs-string"><span class="hljs-string">'OU='</span></span>+group+<span class="hljs-string"><span class="hljs-string">','</span></span>+basedn_user search = ad.search_s(basedn_user2, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname != <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) ad.unbind_s() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tftp_file_change</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config,place,adname,current_account,current_account_password)</span></span></span><span class="hljs-function">:</span></span> client = tftpy.TftpClient(<span class="hljs-string"><span class="hljs-string">"192.168.0.3"</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span>) client.download(<span class="hljs-string"><span class="hljs-string">'template.cfg'</span></span>, place) fileread = open(place, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) line = fileread.readlines() fileread.close() line[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.label = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + adname.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.auth_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.display_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.password = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account_password[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) filewrite = open(place, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> line: filewrite.write(i) filewrite.close() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> place <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> config client.upload(config,place) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_phone_inform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ipaddr)</span></span></span><span class="hljs-function">:</span></span> fileconf = requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/servlet?phonecfg=get[&amp;accounts=1]'</span></span>) conf = fileconf.text.split(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) current_account = conf[<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_account <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sniff_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> pcapf = sniff(count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(pcapf) == <span class="hljs-number"><span class="hljs-number">0</span></span>: exit() frame = pcapf[<span class="hljs-number"><span class="hljs-number">0</span></span>] macaddr = frame.src <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] != <span class="hljs-string"><span class="hljs-string">'80:5e:c0'</span></span>: exit() ipaddr = frame[<span class="hljs-number"><span class="hljs-number">0</span></span>][IP].src <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> macaddr, ipaddr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_mysql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query,fquery,macaddr,qwery2)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'voip'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() cursor.execute(fquery) state = cursor.fetchall() state = bool(state[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cursor.execute(qwery2) connect.commit() connect.close() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.execute(query) connect.commit() connect.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_account</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current_account)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'asterisk'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() qwery = <span class="hljs-string"><span class="hljs-string">'select data from sip where id='</span></span> + current_account + <span class="hljs-string"><span class="hljs-string">' and keyword="secret";'</span></span> cursor.execute(qwery) password = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> password == <span class="hljs-string"><span class="hljs-string">' '</span></span>: exit() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: macaddr, ipaddr = sniff_frame() current_account = get_phone_inform(ipaddr) current_account_password = check_account(current_account) macaddr = macaddr.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ipaddr = ipaddr.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) adname = conn_ldap(getpass.getuser()) query = <span class="hljs-string"><span class="hljs-string">'INSERT INTO station (mac, ip, name, number) VALUES ('</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + ipaddr + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + adname + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + get_phone_inform(ipaddr) + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">')'</span></span> qwery2 = <span class="hljs-string"><span class="hljs-string">'UPDATE station SET ip='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + ipaddr + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">', name='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + adname + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">', number='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + get_phone_inform(ipaddr) + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">' WHERE mac='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'"'</span></span> fquery = <span class="hljs-string"><span class="hljs-string">'SELECT EXISTS(SELECT mac FROM voip.station WHERE mac='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'")'</span></span> query = query.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) fquery = fquery.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) config = macaddr + <span class="hljs-string"><span class="hljs-string">'.cfg'</span></span> place = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">"~"</span></span>) + <span class="hljs-string"><span class="hljs-string">"\\"</span></span> + <span class="hljs-string"><span class="hljs-string">"AppData\\Local\\"</span></span> + config conn_mysql(query,fquery,macaddr,qwery2) tftp_file_change(config,place,adname,current_account,current_account_password) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=AutoP'</span></span>) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=Reboot'</span></span>)</code> </pre> <br>  El programa se ejecuta en la computadora del usuario y funciona bajo la condición de que la computadora esté conectada a la red a través del teléfono, ya que el Yealink T19 no puede funcionar como una puerta de enlace. <br><br>  Primero tenemos que entender si está conectado?  y qué mac e ip tiene nuestro teléfono. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sniff_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> pcapf = sniff(count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(pcapf) == <span class="hljs-number"><span class="hljs-number">0</span></span>: exit() frame = pcapf[<span class="hljs-number"><span class="hljs-number">0</span></span>] macaddr = frame.src <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] != <span class="hljs-string"><span class="hljs-string">'80:5e:c0'</span></span>: exit() ipaddr = frame[<span class="hljs-number"><span class="hljs-number">0</span></span>][IP].src <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> macaddr, ipaddr</code> </pre><br>  Aquí usamos la función sniff del marco de trabajo scapy, usándola obtenemos un paquete udp predefinido, esperamos 70 segundos y si no atrapamos nada, salimos. <br><br><pre> <code class="python hljs">count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span></code> </pre> <br>  A continuación, nos aseguramos de que el dispositivo sea realmente Yealink y devolvemos los valores necesarios (ip y mac). <br><br>  Mediante una solicitud especial, descubrimos la cuenta corriente en el teléfono.  Para hacer esto, la configuración actual se descarga desde el teléfono y se analiza. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_phone_inform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ipaddr)</span></span></span><span class="hljs-function">:</span></span> fileconf = requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/servlet?phonecfg=get[&amp;accounts=1]'</span></span>) conf = fileconf.text.split(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) current_account = conf[<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_account</code> </pre> <br>  Descubrimos la contraseña de esta cuenta.  Para hacer esto, pasamos a la tabla asterisk.sip y en ella al campo de datos. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_account</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current_account)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'asterisk'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() qwery = <span class="hljs-string"><span class="hljs-string">'select data from sip where id='</span></span> + current_account + <span class="hljs-string"><span class="hljs-string">' and keyword="secret";'</span></span> cursor.execute(qwery) password = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> password == <span class="hljs-string"><span class="hljs-string">' '</span></span>: exit() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password</code> </pre> <br>  Bueno, para la etapa final, nos conectamos a ldap AD y usamos sAMAccountName obtenido a través de la función <i>getpass.getuser ()</i> para tomar el cn del usuario actual (que generalmente contiene el nombre del usuario). <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_ldap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(login)</span></span></span><span class="hljs-function">:</span></span> ad = ldap.initialize(<span class="hljs-string"><span class="hljs-string">'ldap://***.local'</span></span>) ad.simple_bind_s(<span class="hljs-string"><span class="hljs-string">'voip@***.local'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) basedn = <span class="hljs-string"><span class="hljs-string">'OU=***,DC=***,DC=LOCAL'</span></span> basedn_user = <span class="hljs-string"><span class="hljs-string">'OU=***,OU=***,DC=***,DC=LOCAL'</span></span> scope = ldap.SCOPE_SUBTREE filterexp = <span class="hljs-string"><span class="hljs-string">"(&amp;(sAMAccountName="</span></span> + login + <span class="hljs-string"><span class="hljs-string">")(ObjectClass=person))"</span></span> filterexp2 = <span class="hljs-string"><span class="hljs-string">"(&amp;(ObjectClass=organizationUnit))"</span></span> attrlist = [<span class="hljs-string"><span class="hljs-string">'cn'</span></span>] attrlist2 = [<span class="hljs-string"><span class="hljs-string">'OU'</span></span>] search = ad.search_s(basedn, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname == <span class="hljs-string"><span class="hljs-string">' '</span></span>: search = ad.search_s(basedn_user, scope, filterexp2, attrlist2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(search)+<span class="hljs-number"><span class="hljs-number">1</span></span>): group = search[i][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'ou'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] basedn_user2 = <span class="hljs-string"><span class="hljs-string">'OU='</span></span>+group+<span class="hljs-string"><span class="hljs-string">','</span></span>+basedn_user search = ad.search_s(basedn_user2, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname != <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) ad.unbind_s() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname</code> </pre> <br>  Nos conectamos a la tabla creada previamente en la base de datos (la creé en el mismo lugar) y agregamos todo lo que aprendimos, a saber: ip, mac, nombre de usuario. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_mysql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query,fquery,macaddr,qwery2)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'voip'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() cursor.execute(fquery) state = cursor.fetchall() state = bool(state[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cursor.execute(qwery2) connect.commit() connect.close() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.execute(query) connect.commit() connect.close()</code> </pre> <br>  Podríamos detenernos en esto, porque ya hemos creado una libreta de direcciones dinámica, pregunta, pero fui más allá y atornillé los dispositivos de autoprovisión aquí. <br><br>  Para hacer esto, se descarga una configuración de plantilla desde un servidor tftp preconfigurado, en el que hacemos nuestros cambios y los guardamos con mac.cfg.  Es decir, para Yealink hay dos tipos de configuración, una global y la segunda aplicada a un teléfono específico y debe tener la forma mac_phone.cfg <br><br>  Después de todos los cambios en el archivo y guardarlo nuevamente en el servidor tftp, le damos el comando al teléfono para aprovisionar y reiniciar el dispositivo. <br><br><pre> <code class="pgsql hljs">def tftp_file_change(config,place,adname,current_account,current_account_password): client = tftpy.TftpClient("192.168.0.3", <span class="hljs-number"><span class="hljs-number">69</span></span>) client.download(<span class="hljs-string"><span class="hljs-string">'template.cfg'</span></span>, place) fileread = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(place, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span> = fileread.readlines() fileread.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.label = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + adname.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.auth_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.display_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.password = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account_password[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) filewrite = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(place, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span>: filewrite.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(i) filewrite.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() print place print config client.upload(config,place)</code> </pre> <br><pre> <code class="python hljs">requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=AutoP'</span></span>) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=Reboot'</span></span>)</code> </pre> <br>  Después de reiniciar el dispositivo, obtenemos un nombre completo en la pantalla del teléfono + siempre rellenamos correctamente la libreta de direcciones frente a la base de datos, luego solo necesitamos atornillar XML y un poco de PHP para mostrar el contenido dinámicamente.  Hay muchos ejemplos de este tipo, incluso el propio YEALINK tiene. <br><br>  PD: para una mayor escalabilidad, puede mover la configuración principal (variables) a un archivo separado. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465779/">https://habr.com/ru/post/465779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465763/index.html">Presentación Solicitud Presentación</a></li>
<li><a href="../465765/index.html">El resumen de materiales interesantes para el desarrollador móvil # 313 (26 de agosto - 1 de septiembre)</a></li>
<li><a href="../465767/index.html">Experiencia personal y conclusiones después de cambiar profesiones de diseñador a programador</a></li>
<li><a href="../465773/index.html">Actualización de una computadora portátil con Windows 10 1903: desde el ladrillo hasta la pérdida de todos los datos. ¿Por qué una actualización puede ser más que un usuario?</a></li>
<li><a href="../465775/index.html">Servidor LTSP basado en CentOS7</a></li>
<li><a href="../465781/index.html">Cómo hice un interruptor Okhttp personalizado a través de las rutinas de Kotlin</a></li>
<li><a href="../465783/index.html">Desarrollador de juegos ruso, sin sentido y despiadado</a></li>
<li><a href="../465787/index.html">Ama la cabra</a></li>
<li><a href="../465789/index.html">Entrenamiento Cisco 200-125 CCNA v3.0. Día 29. PAT y NAT</a></li>
<li><a href="../465791/index.html">Vulnerabilidades de los minoristas: tres casos en los que se pudo obtener OTP en la solicitud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>