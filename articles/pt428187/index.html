<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèø üíü üîÜ Como escrever uma extens√£o para o Shell do GNOME: Modo N√£o perturbe üçë ‚¨õÔ∏è üèÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tudo come√ßou com a mudan√ßa para uma nova vers√£o de uma distribui√ß√£o Linux, e l√° - o famoso GNOME Shell (GH, abreviado), em Javascript. Bem, ok, no JS ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como escrever uma extens√£o para o Shell do GNOME: Modo N√£o perturbe</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428187/"><p>  Tudo come√ßou com a mudan√ßa para uma nova vers√£o de uma distribui√ß√£o Linux, e l√° - o <em>famoso</em> GNOME Shell (GH, abreviado), em Javascript.  Bem, ok, no JS e no JS, funciona - e tudo bem. </p><br><p> Ao mesmo tempo, o ritmo do meu trabalho h√° muito tempo exige encontrar uma mala direta, em vez das toneladas de megabytes de travagem e consumo <code>outlook.office.com</code> guia <code>outlook.office.com</code> no navegador.  E agora descobri que, em nosso tempo, existem v√°rios candidatos quase excelentes, um problema - a mala direta come√ßou a me receber notifica√ß√µes de novas cartas - e som e inscri√ß√µes pop-up. </p><br><p>  O que fazer  A decis√£o de escrever a extens√£o N√£o perturbe n√£o veio imediatamente, eu realmente n√£o queria escrever uma bicicleta e / ou ficar atolado no desenvolvimento / c√≥digo / toneladas de erros, mas decidi e agora quero compartilhar minha experi√™ncia com Habr.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a></sup> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/737/175/2b5/7371752b5fb33b8858bff75857fbfa83.jpg"></p><a name="habracut"></a><br><h2 id="tehnicheskie-trebovaniya">  Requisitos t√©cnicos </h2><br><p>  Eu quero ter <del>  um grande </del>  para desativar as notifica√ß√µes e sons para o hor√°rio de sua escolha: 20 minutos, 40 minutos, 1 hora, 2 horas, 4, 8 e 24 horas.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2</a></sup> Sim, cronometrando como no Slack. </p><br><p>  Nas extens√µes de extensions.gnome.org, havia uma extens√£o "N√£o perturbe o bot√£o", que serviu de modelo para escrever sua extens√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">N√£o perturbe o tempo</a> . </p><br><h2 id="konechnyy-rezultat-do-not-disturb-timehttpsextensionsgnomeorgextension1484do-not-disturb-time">  Resultado final: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o perturbe o tempo</a> </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/104/41d/479/10441d479062c7540a2743c6fb0b852d.png" alt="N√£o perturbe o tempo"></p><br><p>  Instale a partir de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">extensions.gnome.org</a> . <br>  Fontes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> : coloque estrelas, garfo, ofere√ßa melhorias. </p><br><h3 id="kak-ustanovit-rasshirenie-gh-instrukciya">  Como instalar a extens√£o GH: instru√ß√µes </h3><br><ol><li>  Instale o pacote <em>chrome-gnome-shell</em> , um conector do navegador, usando o Ubuntu como exemplo: <br> <code>sudo apt install chrome-gnome-shell</code> </li> <li>  Usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link,</a> instale a extens√£o do navegador: <br><ul><li>  siga o link <em>Clique aqui para instalar a extens√£o do navegador</em> </li><li>  no Ubuntu 18.04, funcionou para mim no navegador Chrome / Chromium, no Fedora 28/29 - no Firefox e no Chromium </li></ul></li><li>  Estamos procurando a extens√£o desejada na lista <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://extensions.gnome.org</a> : ativar, desativar, alterar as configura√ß√µes de extens√£o. </li><li>  LUCRO! </li></ol><br><h2 id="nachalo">  Iniciar </h2><br><p>  Crie uma extens√£o do zero: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> gnome<span class="hljs-literal"><span class="hljs-literal">-shell</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span><span class="hljs-literal"><span class="hljs-literal">-tool</span></span> -<span class="hljs-literal"><span class="hljs-literal">-create</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span> Name: <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> Not Disturb Time Description: Disables notifications and sound <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a period Uuid: dnd@catbo.net Created extension <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'~/.local/share/gnome-shell/extensions/dnd@catbo.net'</span></span> <span class="hljs-comment"><span class="hljs-comment">#  gnome-shell Alt+F2, r, Enter #    https://extensions.gnome.org/local/      #   Gnome Shell - , gnome-shell   systemd,   journalctl -f /usr/bin/gnome-shell #    ,       gnome-shell journalctl -f /usr/bin/gnome-shell | grep -E 'dnd|$'</span></span></code> </pre> <br><p>  O arquivo <code>extension.js</code> no diret√≥rio correspondente √© o ponto de entrada em nosso aplicativo, em uma vers√£o m√≠nima semelhante a esta: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} <span class="hljs-comment"><span class="hljs-comment">//   ;    function disable() {} // --||-- ;     enable()</span></span></code> </pre> <br><h3 id="pervyy-kod">  Primeiro c√≥digo </h3><br><p>  Primeiro, queremos adicionar um bot√£o ao <code>Status Menu</code> canto superior direito, como na imagem acima. </p><br><p>  Ent√£o por onde come√ßar?  Oh, vamos come√ßar com a documenta√ß√£o.  Temos documenta√ß√£o oficial, tudo.  Mas n√£o, a documenta√ß√£o oficial √© muito pequena e fragmentada, mas gra√ßas a <code>julio641742</code> e sua documenta√ß√£o n√£o oficial, conseguimos o que precisamos: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">// 1 -    (1 - , 0 - , 0.5 -  ) // true,     let dndButton = new PanelMenu.Button(1, "DoNotDisturb", false); // `right` -      (left/center/right) Main.panel.addToStatusArea("DoNotDisturbRole", dndButton, 0, "right"); let box = new St.BoxLayout(); dndButton.actor.add_child(box); let icon = new St.Icon({ style_class: "system-status-icon" }); icon.set_gicon(Gio.icon_new_for_string("/tmp/bell_normal.svg")); box.add(icon);</span></span></code> </pre> <br><p>  Esse c√≥digo cria o objeto de chave <code>dndButton</code> classe <code>dndButton</code> - este √© um bot√£o especialmente projetado para o painel Menu Status.  E n√≥s o inserimos neste painel usando a fun√ß√£o Main.panel.addToStatusArea ().  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3</a></sup> </p><br><p>  Insira itens de menu com manipuladores aparafusados ‚Äã‚Äãa eles, exemplo: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> menuItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PopupMenu.PopupMenuItem(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); menuItem.connect(<span class="hljs-string"><span class="hljs-string">"activate"</span></span>, (menuItem, event) =&gt; { log(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); }); dndButton.menu.addMenuItem(menuItem);</code> </pre> <br><p>  Obrigado, julio641742, pela documenta√ß√£o!  Link: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/julio641742/gnome-shell-extension-reference</a> </p><br><p>  O c√≥digo final de trabalho est√° <a href="">aqui</a> . </p><br><h2 id="osobennosti-raboty-gnome-shell-i-javascript">  Recursos de shell e Javascript do GNOME </h2><br><p>  Fora √© o final de 2018 e o Node.js / V8 √© a principal ferramenta para executar o c√≥digo Javascript.  Todo o desenvolvimento web moderno se baseia em um "n√≥". </p><br><p>  Mas o Shell do GNOME e toda a infraestrutura ao seu redor usam um mecanismo Javascript diferente, o SpiderMonkey da Mozilla, e isso traz muitas diferen√ßas importantes no desempenho. </p><br><h3 id="import-moduley">  M√≥dulos de importa√ß√£o </h3><br><p>  Diferentemente do Node.js, n√£o h√° require () aqui e tamb√©m nenhuma importa√ß√£o ES6.  Em vez disso, existe um objeto de importa√ß√£o especial, acessando os atributos que levam ao carregamento do m√≥dulo: </p><br><pre> <code class="hljs julia"> //<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = require(<span class="hljs-string"><span class="hljs-string">"ui/panelMenu"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = imports.ui.panelMenu;</code> </pre> <br><p>  Nesse caso, baixamos o m√≥dulo js / ui / panelMenu.js da biblioteca de pacotes GNOME Shell, que implementa a funcionalidade de um bot√£o com um menu pop-up. </p><br><p>  Sim, todos os bot√µes no painel de uma √°rea de trabalho moderna do Linux usando o GNOME s√£o baseados no panelMenu.js.  Incluindo: o mesmo bot√£o direito com indicadores de bateria, Wi-fi, volume de som;  interruptor de idioma de entrada en-ru. </p><br><p>  Em seguida, existe um atributo especial <code>imports.searchPath</code> - esta √© uma lista de caminhos (linhas) nas quais nossos m√≥dulos JS ser√£o pesquisados.  Por exemplo, alocamos uma fun√ß√£o de timer para um m√≥dulo timeUtils.js separado e a colocamos perto do ponto de entrada da nossa extens√£o extension.js.  Importe timeUtils.js da seguinte maneira: </p><br><pre> <code class="hljs pgsql">//     , -  ~/.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/gnome-shell/extensions/&lt;your-<span class="hljs-keyword"><span class="hljs-keyword">extension</span></span>&gt;/ const Me = imports.misc.extensionUtils.getCurrentExtension(); //       imports.searchPath.unshift(Me.path); //   const timeUtils = imports.timeUtils;</code> </pre> <br><h3 id="logirovanie-otladka-javascript">  Registrando, Depurando Javascript </h3><br><p>  Bem, como n√£o temos o Node.js, temos nosso pr√≥prio log.  Em vez de console.log (), v√°rias fun√ß√µes de registro est√£o dispon√≠veis no c√≥digo, consulte gjs /../ global.cpp, static_funcs: </p><br><ul><li>  "log" = g_message ("JS LOG:" + message) - efetuando login no stderr, exemplo: </li></ul><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat helloWorld.js log(<span class="hljs-string"><span class="hljs-string">"hello, world"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$</span></span> gjs helloWorld.js Gjs<span class="hljs-literal"><span class="hljs-literal">-Message</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">21.048</span></span>: JS LOG: hello, world</code> </pre> <br><ul><li>  "logError" - registra a pilha de exce√ß√µes: <br><ul><li>  o primeiro argumento necess√°rio √© uma exce√ß√£o e, em seguida, uma v√≠rgula separa o que voc√™ deseja </li><li>  Por exemplo, se voc√™ precisar imprimir a pilha no lugar certo: </li></ul></li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'bum!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { logError(e, <span class="hljs-string"><span class="hljs-string">"what a fuck"</span></span>); }</code> </pre> <br><p>  e isso vai chamar stderr em grande estilo: </p><br><pre> <code class="hljs powershell">(gjs:<span class="hljs-number"><span class="hljs-number">28674</span></span>): Gjs<span class="hljs-literal"><span class="hljs-literal">-WARNING</span></span> **: <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">46.951</span></span>: JS ERROR: what a fuck: Error: bum! ggg<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ddd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><ul><li>  "print" = g_print ("% s \ n", txt);  - somente texto + "\ n" no stdout, sem prefixos e cores, diferente do log () </li><li>  "printerr" = g_printerr ("% s \ n", txt) - a diferen√ßa da impress√£o √© a do stderr </li></ul><br><p>  Mas n√£o h√° depurador para o SpiderMonkey pronto para uso (n√£o foi em v√£o que eu escrevi meticulosamente acima de todas as ferramentas dispon√≠veis para registro, use-o!).  Se desejar, voc√™ pode tentar JSRDbg: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dois</a> . </p><br><h2 id="a-est-li-zhizn-dlya-js-koda-vne-gnome-shell">  Existe vida para o c√≥digo JS fora do GNOME Shell? </h2><br><p>  Existe.  Aplicativos completos, incluindo uma interface gr√°fica do usu√°rio (GUI), podem ser escritos em Javascript!  Voc√™ precisa execut√°-los usando o binar gjs, o iniciador de c√≥digo JS-GTK, um exemplo de cria√ß√£o de uma janela da GUI: </p><br><pre> <code class="hljs vala">$ which gjs /usr/bin/gjs $ dpkg --search /usr/bin/gjs gjs: /usr/bin/gjs $ cat gtk.js <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span> = imports.gi.<span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.init(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); let win = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.Window(); win.connect(<span class="hljs-string"><span class="hljs-string">"delete-event"</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main_quit(); }); win.show_all(); <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main(); $ gjs gtk.js</code> </pre> <br><p>  Mencionei acima a divis√£o do c√≥digo em m√≥dulos e o carregamento do Javascript.  A quest√£o surge, mas como √© o pr√≥prio m√≥dulo para determinar se √© lan√ßado como um m√≥dulo "principal" ou carregado a partir de outro m√≥dulo? </p><br><p>  Python tem uma constru√ß√£o aut√™ntica: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: main()</code> </pre> <br><p>  No Node.js - da mesma forma: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.main === <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>) { main(); }</code> </pre> <br><p>  N√£o encontrei uma resposta oficial para esta pergunta para Gjs / GH, mas criei uma t√©cnica que me apressei a compartilhar com o leitor (por que algu√©m leu ‚Äúdosyudova‚Äù? Respeito!). </p><br><p>  Portanto, o truque complicado √© baseado na an√°lise da pilha de chamadas atual, se consiste em 2 ou mais linhas, ent√£o n√£o estamos no m√≥dulo main (): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>().stack.split(<span class="hljs-regexp"><span class="hljs-regexp">/\r\n|\r|\n/g</span></span>).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> line.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .length == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { main(); }</code> </pre> <br><h2 id="uborka-za-soboy">  Servi√ßo de limpeza </h2><br><p>  Cada extens√£o do Shell do GNOME tem acesso a todos os objetos em todo o Shell do GNOME.  Por exemplo, para exibir o n√∫mero de notifica√ß√µes ainda n√£o lidas, chegamos ao cont√™iner na <code>Notification Area</code> , localizada no centro acima, n√∫mero 4 na imagem (clique na inscri√ß√£o com a hora atual, √© clic√°vel na vida real, n√£o aqui): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91e/eec/acc/91eeecaccdc67202335ce4d51d8d90d3.png" alt="N√£o perturbe o tempo"></p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unseenlist = Main.panel.statusArea.dateMenu._messageList._notificationSection._list;</code> </pre> <br><p>  Voc√™ pode descobrir quantas notifica√ß√µes n√£o lidas se inscreve em eventos de adi√ß√£o e exclus√£o de notifica√ß√µes: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> number = unseenlist.get_n_children(); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-removed"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"removed!"</span></span>); });</code> </pre> <br><p>  Isso √© bom, mas √†s vezes o usu√°rio pode decidir que n√£o precisa mais da extens√£o X e clicar no bot√£o para desativar a extens√£o.  Para uma extens√£o, isso equivale a chamar a fun√ß√£o disable (), e todos os esfor√ßos devem ser feitos para que a extens√£o desativada n√£o quebre o GH de trabalho: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); }</code> </pre> <br><p>  Nesse caso, al√©m de excluir o bot√£o em si, √© necess√°rio cancelar a inscri√ß√£o nos eventos "ator adicionado" / "ator removido", por exemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> signal = unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); unseenlist.disconnect(signal); }</code> </pre> <br><p>  Se isso n√£o for feito, o c√≥digo dos manipuladores continuar√° sendo chamado no evento correspondente, tente atualizar o estado do bot√£o de menu que ainda n√£o existe e ... O GNOME Shell come√ßar√° a falhar.  Bem, sim, faremos isso, os usu√°rios jurar√£o, as pedras voar√£o para os desenvolvedores do GNOME Shell e o GNOME em geral.  A imagem real, Th. </p><br><p>  Portanto, o GNOME Shell / Gjs √© uma simbiose de dois sistemas, Glib / GTK e Javascript, e eles t√™m uma abordagem diferente para o gerenciamento de recursos.  Glib / GTK requer a libera√ß√£o expl√≠cita de seus recursos (bot√µes, temporizadores, etc.).  Se o objeto foi criado pelo mecanismo Javascript, agimos como de costume (n√£o libere nada). </p><br><p>  Como resultado, assim que nossa extens√£o estiver pronta e n√£o "fluir", voc√™ poder√° public√°-la com seguran√ßa em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://extensions.gnome.org</a> . </p><br><h2 id="rezhim-gnomesessionpresencestatusbusy-i-dbus">  Modo GnomeSession.PresenceStatus.BUSY e DBus. </h2><br><p>  Se voc√™ n√£o se esqueceu, estamos fazendo a extens√£o "N√£o perturbe", que desliga a exibi√ß√£o de notifica√ß√µes para o usu√°rio. </p><br><p>  O GNOME j√° possui uma bandeira respons√°vel por esse estado.  Ap√≥s o login do usu√°rio, √© criado o processo gnome-session, no qual esse sinalizador est√° localizado: este √© o atributo GsmPresencePrivate.status, consulte as fontes do gnome-session, gnome-session / gsm-presence.c.  Temos acesso a esse sinalizador atrav√©s da interface DBus (como comunica√ß√£o entre processos). </p><br><p>  N√£o apenas n√≥s, mas o pr√≥prio GH precisa de informa√ß√µes nessa bandeira para n√£o mostrar notifica√ß√µes.  Isso √© f√°cil de encontrar na fonte GH: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._presence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GnomeSession.Presence(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proxy, error</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(proxy.status); }); ... this._presence.connectSignal(<span class="hljs-string"><span class="hljs-string">'StatusChanged'</span></span>, (proxy, senderName, [status]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(status); });</code> </pre> <br><p>  Nesse caso, o m√©todo _onStatusChanged √© um manipulador que responde a uma altera√ß√£o de estado.  Copiamos esse c√≥digo para n√≥s mesmos, adaptamos - descobrimos <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">quatro</a></sup> notifica√ß√µes, houve um som. </p><br><h2 id="vyklyuchenievklyuchenie-zvuka">  Sem som / sem som </h2><br><p>  A maioria dos desktops Linux modernos s√£o controlados pelo PulseAudio, <del>  trabalho not√≥rio </del>  autor do programa do not√≥rio Lennart Poettering.  At√© agora, eu n√£o tinha conseguido escrever o c√≥digo PulseAudio e fiquei feliz por ter a oportunidade de entender o PulseAudio em algum n√≠vel. </p><br><p>  Como resultado, verificou-se que, para mudo / n√£o mudo, um utilit√°rio <code>pactl</code> √© <code>pactl</code> , ou melhor, tr√™s comandos baseados nele: </p><br><ul><li>  "pactl info": encontre o <code>default sink</code> - qual sa√≠da de som, se houver v√°rias, √© o som padr√£o </li><li>  "pactl list sinks": encontre o status mudo / n√£o mudo do dispositivo correspondente </li><li>  "pactl set-sink-mute% (defaultSink) s% (isMute) s": para ativar / desativar o som </li></ul><br><p>  Portanto, nossa tarefa √© executar comandos / processos, ler sua sa√≠da stdout e procurar os valores desejados regularmente.  Em suma, uma tarefa padr√£o. </p><br><p>  No GNOME, a biblioteca principal glib √© respons√°vel pela cria√ß√£o de processos e existe uma excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> .  E √© claro que ela est√° em C. E n√≥s temos JS.  Sabe-se que o pacote Gjs criou uma camada inteligente e "intuitiva" entre a C-API e o Javascript.  Mas voc√™ ainda entende que precisa de exemplos e n√£o pode ficar sem pesquisar no Google. </p><br><p>  Como resultado, gra√ßas √† excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ess√™ncia,</a> obtemos o c√≥digo de trabalho: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resList = GLib.spawn_command_line_sync(cmd); <span class="hljs-comment"><span class="hljs-comment">// res = true/false, /   // status = int,    // out/err = ,  stdout/stderr  let [res, out, err, status] = resList; if (res != true || status != 0) { print("not ok!"); } else { // do something useful }</span></span></code> </pre> <br><h2 id="sohranenie-nastroek-v-reestre">  Salvando configura√ß√µes <del>  no registro </del></h2><br><p>  Obviamente, n√£o h√° registro no Linux.  Aqui voc√™ n√£o √© o Windows.  Existe uma melhor, chamada GSettings (esta √© a API), v√°rias op√ß√µes de implementa√ß√£o est√£o ocultas por tr√°s dela, por padr√£o o GNOME usa o Dconf.  √â assim que a estrutura da GUI se parece: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0fe/03c/eca/0fe03ceca6c7fc9338377fc5d0909024.png" alt="dconf-editor"></p><br><p>  - O que √© melhor do que armazenar configura√ß√µes em arquivos de texto sem formata√ß√£o?  - Pergunte aos usu√°rios antigos e barbudos do Linux.  O principal recurso do GSettings √© que voc√™ pode assinar facilmente altera√ß√µes nas configura√ß√µes, por exemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Gio = imports.gi.Gio; settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gio.Settings({ <span class="hljs-attr"><span class="hljs-attr">settings_schema</span></span>: schemaObj }); settings.connect(<span class="hljs-string"><span class="hljs-string">"changed::mute-audio"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log(<span class="hljs-string"><span class="hljs-string">"I see, you changed it!"</span></span>); });</code> </pre> <br><p>  A √∫nica configura√ß√£o at√© o momento em "N√£o perturbe" √© a op√ß√£o "√°udio mudo", que permite ao usu√°rio desligar ou n√£o o som durante a "hora silenciosa" a pedido do usu√°rio. </p><br><h2 id="i-nemnogo-klassiki-gui-na-gtk">  E um pouco cl√°ssico, GTK GUI </h2><br><p>  Para mostrar lindamente ao usu√°rio as configura√ß√µes de nossa extens√£o (e n√£o entrar no registro com patas sujas), o GH nos oferece a grava√ß√£o de um c√≥digo da GUI e a inser√ß√£o na fun√ß√£o buildPrefsWidget () do arquivo prefs.js.  Nesse caso, em frente √† nossa extens√£o na lista de "Extens√µes instaladas" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , veremos um bot√£o adicional "Configurar esta extens√£o", clicando no qual a nossa beleza aparecer√°. </p><br><p>  Vamos criar uma guia Sobre separada, porque sabe-se que sem o Ebout, desculpe, o programa n√£o est√° completo. </p><br><p>  De um modo geral, para criar uma interface gr√°fica cl√°ssica, o GTK possui toda uma gama de componentes b√°sicos, <code></code> , os quais voc√™ pode conferir a quantidade e a qualidade <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Usaremos apenas alguns deles: </p><br><ul><li>  Gtk.Notebook √© uma guia, como em um navegador </li><li>  Gtk.VBox √© um cont√™iner para estruturar verticalmente uma lista de widgets </li><li>  Gtk.Label √© um elemento b√°sico, uma inscri√ß√£o, com a capacidade de formatar HTML </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildPrefsWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Gtk.Notebook    GUI let notebook = new Gtk.Notebook(); ... //  About,    VBox c   10 , //   margin/padding   let aboutBox = new Gtk.VBox({ border_width: 10 }); //     About notebook.append_page( aboutBox, new Gtk.Label({label: "About"}), ); //        , //      ,    (expand) aboutBox.pack_start( new Gtk.Label({ label: "&lt;b&gt;Do Not Disturb Time&lt;/b&gt;", use_markup: true, }), true, // expand true, // fill 0, ); ... notebook.show_all(); return notebook; }</span></span></code> </pre> <br><p>  Captura de tela final: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f87/554/787/f8755478763d159cbb9dfc1518881e60.png"></p><br><h2 id="dopolnitelno">  Opcional </h2><br><div class="spoiler">  <b class="spoiler_title">1. Modos de opera√ß√£o: suporte e opera√ß√£o</b> <div class="spoiler_text"><p>  O trabalho do programador envolve 2 modos no meu caso: <br>  1) no modo de suporte, quando voc√™ precisar responder rapidamente a eventos - correio, Slack, Skype e mais <br>  2) no modo operacional, quando √© vital reduzir as notifica√ß√µes por pelo menos 20 minutos, caso contr√°rio, o foco √© perdido e a produtividade final do trabalho √© insignificante.  Para isso, o modo N√£o perturbe √© √∫til. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">2. Como desligar o som</b> <div class="spoiler_text"><p>  Pode parecer que um mudo completo, mudo, √© demais.  De fato, idealmente, voc√™ gostaria que o Slack / Skype fosse ouvido no modo N√£o perturbe, mas o restante dos sons (notifica√ß√µes reais) n√£o √©.  Mas para isso eles precisam ser distinguidos de alguma forma.  Obviamente, √© poss√≠vel criar uma API de som espec√≠fica para notifica√ß√µes (e isso j√° existe), mas sempre existe um programa / programador que n√£o usa essa funcionalidade.  Um exemplo √© o mailer do Mailspring: ele simplesmente reproduz sons atrav√©s da tag de <code>audio</code> e eles n√£o podem ser distinguidos de forma alguma, digamos, da fala em uma chamada do Slack. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">3. PanelMenu.Button</b> <div class="spoiler_text"><p>  PanelMenu.Button - este √© o bot√£o real no painel + menu pop-up, e voc√™ pode descobrir por si mesmo e cri√°-lo do zero, os dois ser√£o apreciados pelos <em>caras que est√£o feridos</em> !  Eu estava buscando um resultado r√°pido e, portanto, copiei o c√≥digo da documenta√ß√£o n√£o oficial. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">4. SetStatusRemote ()</b> <div class="spoiler_text"><p>  Realmente inicie uma altera√ß√£o de modo usando SetStatusRemote (). </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt428187/">https://habr.com/ru/post/pt428187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt428175/index.html">Implementa√ß√£o de √°rvore C de prefixo astuto</a></li>
<li><a href="../pt428177/index.html">Ent√£o, o que h√° de errado com a procura de emprego / trabalhadores em TI?</a></li>
<li><a href="../pt428179/index.html">Em um leil√£o japon√™s, um prot√≥tipo do Wii-Controller, desenvolvido para o GameCube</a></li>
<li><a href="../pt428181/index.html">M√°quina moral: impiedosa ou sem sentido?</a></li>
<li><a href="../pt428183/index.html">Implementa√ß√£o do algoritmo Levenberg-Marquardt para otimizar redes neurais no TensorFlow</a></li>
<li><a href="../pt428189/index.html">Quem √© um paladino?</a></li>
<li><a href="../pt428191/index.html">O que devemos organizar um hackathon ou Como conduzimos um hackathon interno</a></li>
<li><a href="../pt428193/index.html">Sobre fazer passeios</a></li>
<li><a href="../pt428197/index.html">Finan√ßas pessoais eficazes. N√≠vel 1</a></li>
<li><a href="../pt428201/index.html">Buracos de toupeira em JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>