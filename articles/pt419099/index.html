<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ñ™Ô∏è üë©‚Äçüöí üîù WebSockets em Angular. Parte 2. Solu√ß√µes de produtos üìß ü•§ üëàüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em um artigo anterior, falamos sobre uma solu√ß√£o geral para soquetes da Web no Angular, onde constru√≠mos um barramento com reconex√£o e servi√ßo para us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>WebSockets em Angular. Parte 2. Solu√ß√µes de produtos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419099/"><img src="https://habrastorage.org/webt/hf/xh/dl/hfxhdlv7katnrbytwzqmhjy3xom.png" alt="imagem"><br><br>  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior,</a> falamos sobre uma solu√ß√£o geral para soquetes da Web no Angular, onde constru√≠mos um barramento com reconex√£o e servi√ßo para uso em componentes baseados no WebSocketSubject.  Essa implementa√ß√£o √© adequada para os casos mais simples, por exemplo, recebimento e envio de mensagens de bate-papo etc., mas seus recursos podem n√£o ser suficientes quando voc√™ precisa criar algo mais flex√≠vel e controlado.  Neste artigo, revelarei alguns recursos ao trabalhar com soquetes da Web e falarei sobre os requisitos que voc√™ mesmo encontrou e, possivelmente, encontrar√°. <br><a name="habracut"></a><br>  Freq√ºentemente, em grandes projetos com alta participa√ß√£o, o front-end enfrenta tarefas que, em outras circunst√¢ncias, s√£o mais comuns no back-end.  Em condi√ß√µes de austeridade dos recursos do servidor, parte dos problemas migra para o territ√≥rio de front-end; por esse motivo, um m√°ximo de extensibilidade e controle √© estabelecido no projeto. <br><br>  Aqui est√° uma lista dos requisitos b√°sicos para um cliente de soquete da web que ser√£o abordados neste artigo: <br><br><ul><li>  Reconex√£o autom√°tica ‚Äúinteligente‚Äù; </li><li>  Modo de depura√ß√£o; </li><li>  Sistema de assinatura de eventos baseado em RxJs; </li><li>  Recep√ß√£o e an√°lise de dados bin√°rios; </li><li>  Proje√ß√£o (mapeamento) das informa√ß√µes recebidas no modelo; </li><li>  Controle sobre as altera√ß√µes do modelo quando novos eventos chegam; </li><li>  Ignore eventos arbitr√°rios e cancele ignorar. </li></ul><br>  Considere cada item com mais detalhes. <br><br><h2>  Reconectar / Debag </h2><br>  Eu escrevi sobre reconectar em um artigo anterior, ent√£o apenas cito parte do texto: <br><br><blockquote>  A reconex√£o ou a organiza√ß√£o da reconex√£o com o servidor √© um fator primordial ao trabalhar com soquetes da Web, pois  quebras de rede, falhas no servidor ou outros erros que causem uma falha na conex√£o podem causar falhas no aplicativo. <br>  √â importante observar que as tentativas de reconex√£o n√£o devem ser muito frequentes e n√£o devem continuar indefinidamente, pois  esse comportamento pode suspender o cliente. </blockquote><br>  O soquete da web em si n√£o sabe reconectar quando desconectado.  Portanto, se o servidor reiniciou ou o servidor travou ou o usu√°rio reconectou a Internet, para continuar trabalhando, voc√™ tamb√©m precisa reconectar o soquete da web. <br><br>  Neste artigo, para reconectar e depurar, usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Reconnecting WebSocket</a> , que cont√©m a funcionalidade necess√°ria e outras op√ß√µes, como alterar o URL do soquete da Web entre reconex√µes, escolher um construtor arbitr√°rio do WebSocket etc.  Outras alternativas tamb√©m s√£o adequadas.  Reconectar do artigo anterior n√£o √© adequado, porque  Est√° escrito em WebSocketSubject, que desta vez n√£o se aplica. <br><br><h2>  Sistema de Assinatura de Eventos RxJs </h2><br>  Para usar soquetes da Web em componentes, √© necess√°rio assinar eventos e cancelar a assinatura deles quando necess√°rio.  Para fazer isso, use o popular padr√£o de design <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pub / Sub</a> . <br><blockquote>  "Publisher-subscriber (eng. Publisher-subscriber ou eng. Pub / sub) - um modelo de design comportamental para a transmiss√£o de mensagens em que remetentes de mensagens, chamados editores (eng. Publishers), n√£o est√£o diretamente vinculados ao c√≥digo do programa para enviar mensagens aos assinantes (eng. Assinantes )  Em vez disso, as mensagens s√£o divididas em classes e n√£o cont√™m informa√ß√µes sobre seus assinantes, se houver.  Da mesma forma, os assinantes lidam com uma ou mais classes de mensagens, abstraindo de editores espec√≠ficos. ‚Äù </blockquote><br>  O assinante n√£o entra em contato diretamente com o editor, mas atrav√©s do barramento intermedi√°rio - o servi√ßo do site.  Tamb√©m deve ser poss√≠vel se inscrever em v√°rios eventos com o mesmo tipo de retorno.  Cada assinatura cria seu pr√≥prio Assunto, que √© adicionado ao objeto ouvintes, o que permite endere√ßar eventos de soquete da Web √†s assinaturas necess√°rias.  Ao trabalhar com o Assunto RxJs, h√° algumas dificuldades em cancelar a inscri√ß√£o, portanto, criaremos um coletor de lixo simples que remover√° os objetos do objeto ouvintes quando eles n√£o tiverem observadores. <br><br><h2>  Recep√ß√£o e an√°lise de dados bin√°rios </h2><br>  O WebSocket suporta a transfer√™ncia de dados bin√°rios, arquivos ou fluxos, que geralmente s√£o usados ‚Äã‚Äãem grandes projetos.  Parece algo como isto: <br><blockquote>  0x80, &lt;comprimento - um ou mais bytes&gt;, &lt;corpo da mensagem&gt; </blockquote><br>  Para n√£o criar restri√ß√µes no comprimento da mensagem transmitida e ao mesmo tempo n√£o gastar bytes irracionalmente, os desenvolvedores do protocolo usaram o seguinte algoritmo.  Cada byte na indica√ß√£o de comprimento √© considerado separadamente: o mais alto indica se √© o √∫ltimo byte (0) ou os outros (1) que o seguem e os 7 bits inferiores cont√™m os dados transmitidos.  Portanto, quando o sinal do quadro de dados bin√°rios 0x80 aparecer, o pr√≥ximo byte ser√° capturado e armazenado em um "cofrinho" separado.  Em seguida, o pr√≥ximo byte, se tiver o conjunto de bits mais significativo, tamb√©m √© transferido para o ‚Äúmealheiro‚Äù e assim sucessivamente at√© que o byte com o bit mais significativo seja encontrado.  Este byte √© o √∫ltimo no indicador de comprimento e tamb√©m √© adicionado ao "mealheiro".  Agora, os bits altos s√£o removidos dos bytes no mealheiro e o restante √© combinado.  Esse ser√° o comprimento do corpo da mensagem - n√∫meros de 7 bits sem o bit mais significativo. <br><br>  O mecanismo de an√°lise de front-end e fluxo bin√°rio √© complexo e est√° associado ao mapeamento de dados no modelo.  Um artigo separado pode ser dedicado a isso.  Desta vez, analisaremos uma op√ß√£o simples e deixaremos casos dif√≠ceis para as seguintes publica√ß√µes, se houver interesse no t√≥pico. <br><br><h2>  Proje√ß√£o (mapeamento) das informa√ß√µes recebidas no modelo </h2><br>  Independentemente do tipo de transmiss√£o recebida, voc√™ deve l√™-la e modific√°-la com seguran√ßa.  N√£o h√° consenso sobre como fazer isso melhor, eu aderir √† teoria de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um modelo de dados</a> , pois considero l√≥gico e confi√°vel para a programa√ß√£o no estilo OOP. <br><blockquote>  ‚ÄúUm modelo de dados √© uma defini√ß√£o abstrata, auto-suficiente e l√≥gica de objetos, operadores e outros elementos que juntos constituem uma m√°quina abstrata de acesso a dados com a qual o usu√°rio interage.  "Esses objetos permitem modelar a estrutura de dados e os operadores - o comportamento dos dados." </blockquote><br>  Todos os tipos de pneus populares que n√£o d√£o a id√©ia de um objeto como uma classe na qual o comportamento, a estrutura etc. s√£o definidos criam confus√£o, s√£o menos bem controlados e, √†s vezes, cobertos por algo que n√£o √© t√≠pico para eles.  Por exemplo, uma classe de c√£es deve descrever um c√£o sob quaisquer condi√ß√µes.  Se o c√£o for percebido como um conjunto de campos: cauda, ‚Äã‚Äãcor, rosto, etc., o c√£o poder√° crescer uma pata extra e outro c√£o aparecer√° em vez da cabe√ßa. <br><br><img src="https://habrastorage.org/webt/sq/fa/xu/sqfaxulbeyaffws-46gxho3-dcg.jpeg" alt="imagem"><br><br><h2>  Controle sobre mudan√ßas de modelo √† medida que novos eventos chegam </h2><br>  Neste par√°grafo, descreverei o problema que encontrei ao trabalhar na interface da Web do aplicativo m√≥vel de apostas esportivas.  A API do aplicativo funcionou atrav√©s de soquetes da Web pelos quais eles receberam: atualiza√ß√£o de probabilidades, adi√ß√£o e remo√ß√£o de novos tipos de apostas, notifica√ß√µes sobre o in√≠cio ou o fim de uma partida, etc.  - totalizam cerca de trezentos eventos do soquete da web.  Durante a partida, as apostas e as informa√ß√µes s√£o atualizadas constantemente, √†s vezes 2 a 3 vezes por segundo, ent√£o o problema era que depois delas a interface era atualizada sem controle intermedi√°rio. <br><br>  Quando o usu√°rio monitorou o lance em um dispositivo m√≥vel e, ao mesmo tempo, as listas foram atualizadas em sua exibi√ß√£o, o lance desapareceu do campo de vis√£o; portanto, o usu√°rio precisou procurar o lance rastreado novamente.  Esse comportamento foi repetido para cada atualiza√ß√£o. <br><br><img src="https://habrastorage.org/webt/tq/5p/e8/tq5pe8qxiepdjj7dx5-jry10bjs.gif" alt="imagem"><br><br>  A solu√ß√£o exigia imutabilidade para os objetos que eram exibidos na tela, mas, ao mesmo tempo, os coeficientes de apostas precisavam mudar, os lances irrelevantes para se tornarem inativos e os novos n√£o eram adicionados at√© o usu√°rio rolar a tela.  As op√ß√µes desatualizadas n√£o foram armazenadas no back-end; portanto, essas linhas tiveram que ser lembradas e marcadas com o sinalizador "exclu√≠do", para o qual um armazenamento intermedi√°rio de dados foi criado entre o site e a assinatura, o que garantiu o controle sobre as altera√ß√µes. <br><br>  No novo servi√ßo, tamb√©m criaremos uma camada substituta e, desta vez, usaremos o <a href="">Dexie.js</a> - um wrapper sobre a API IndexedDB, mas qualquer outro banco de dados virtual ou de navegador o far√°.  Redux √© aceit√°vel. <br><br><h2>  Ignorar eventos arbitr√°rios e cancelar ignorar </h2><br>  Na mesma empresa, geralmente existem v√°rios projetos do mesmo tipo ao mesmo tempo: vers√µes para celular e Web, vers√µes com configura√ß√µes diferentes para diferentes grupos de usu√°rios, vers√µes avan√ßadas e truncadas do mesmo aplicativo. <br><br>  Geralmente, todos eles usam uma √∫nica base de c√≥digo; portanto, √†s vezes, √© necess√°rio desativar eventos desnecess√°rios em tempo de execu√ß√£o ou durante o DI sem excluir a assinatura e ativ√°-la novamente, ou seja,  ignore alguns deles, para n√£o processar eventos desnecess√°rios.  Esse √© um recurso simples, mas √∫til, que adiciona flexibilidade ao barramento Pub / Sub. <br><br>  Vamos come√ßar com uma descri√ß√£o das interfaces: <br><br><pre><code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWebsocketService { //    addEventListener&lt;T&gt;(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[], id?: number): Observable&lt;T&gt;; runtimeIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; runtimeRemoveIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; sendMessage(event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, data: any): void; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WebSocketConfig { //   DI url: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; ignore?: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; garbageCollectInterval?: number; options?: Options; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface ITopic&lt;T&gt; { //   Pub/Sub [hash: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: MessageSubject&lt;T&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IListeners { //    [topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: ITopic&lt;any&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IBuffer { //    ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> type: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; data: number[]; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWsMessage { // ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; buffer: IBuffer; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { //   id: number; text: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type ITopicDataType = IMessage[] | number | <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; //  callMessage  </code> </pre> <br>  Herdaremos o Subject para criar um coletor de lixo: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageSubject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( private listeners: IListeners, //    private topic: string, //   private id: string // id  ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-comment"><span class="hljs-comment">/* *   next, *       , *   garbageCollect */</span></span> public next(value?: T): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.closed) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectUnsubscribedError(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isStopped) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {observers} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> len = observers.length; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> copy = observers.slice(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { copy[i].next(value); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!len) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); <span class="hljs-comment"><span class="hljs-comment">//   } } } /* * garbage collector * */ private garbageCollect(): void { delete this.listeners[this.topic][this.id]; //  Subject if (!Object.keys(this.listeners[this.topic]).length) { //    delete this.listeners[this.topic]; } } }</span></span></code> </pre> <br>  Diferente da implementa√ß√£o anterior, websocket.events.ts far√° parte do m√≥dulo de soquete da web <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WS_API = { <span class="hljs-attr"><span class="hljs-attr">EVENTS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">MESSAGES</span></span>: <span class="hljs-string"><span class="hljs-string">'messages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">COUNTER</span></span>: <span class="hljs-string"><span class="hljs-string">'counter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">UPDATE_TEXTS</span></span>: <span class="hljs-string"><span class="hljs-string">'update-texts'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">COMMANDS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">SEND_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'set-text'</span></span>, <span class="hljs-attr"><span class="hljs-attr">REMOVE_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'remove-text'</span></span> } };</code> </pre> <br>  Para configurar ao conectar o m√≥dulo, crie websocket.config: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { InjectionToken } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config: InjectionToken&lt;string&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InjectionToken(<span class="hljs-string"><span class="hljs-string">'websocket'</span></span>);</code> </pre> <br>  Crie um modelo para Proxy: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dexie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dexie'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { IMessage, IWsMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { WS_API } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.events'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MessagesDatabase extends Dexie { //    Dexie  typescript <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> messages!: Dexie.<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>&lt;IMessage, number&gt;; // id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> constructor() { super(<span class="hljs-string"><span class="hljs-string">'MessagesDatabase'</span></span>); //   this.version(<span class="hljs-number"><span class="hljs-number">1</span></span>).stores({ //   messages: <span class="hljs-string"><span class="hljs-string">'++id,text'</span></span> }); } }</code> </pre> <br>  Um analisador de modelo simples, em condi√ß√µes reais, √© melhor dividi-lo em v√°rios arquivos: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">export</span></span> const modelParser = (message: <span class="hljs-type"><span class="hljs-type">IWsMessage</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message &amp;&amp; message.buffer) { /*  */ const encodeUint8Array = <span class="hljs-type"><span class="hljs-type">String</span></span>.fromCharCode .apply(<span class="hljs-type"><span class="hljs-type">String</span></span>, new <span class="hljs-type"><span class="hljs-type">Uint8Array</span></span>(message.buffer.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">)); const parseData = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encodeUint8Array</span></span></span><span class="hljs-class">); let </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IndexedDB</span></span></span><span class="hljs-class"> if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MESSAGES</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">(); } parseData.forEach((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">) =&gt; { /*   */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transaction</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rw'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">async</span></span></span><span class="hljs-class"> () =&gt; { /* ,    */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}).count()) === 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">}); console.log(`</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Addded</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ${</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}`); } }).catch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class"> =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">); }); }); return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.messages.toArray(); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">COUNTER</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">)); //    } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPDATE_TEXTS</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class"> = []; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forEach</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">); }); return new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">)); //     } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log</span></span></span><span class="hljs-class">(`[${</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Date</span></span></span><span class="hljs-class">()}] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> is "undefined"`); } };</span></span></code> </pre> <br>  WebsocketModule: <br><br><pre> <code class="hljs powershell">@NgModule({ imports: [ <span class="hljs-type"><span class="hljs-type">CommonModule</span></span> ] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebsocketModule</span></span></span></span> { public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> config(wsConfig: WebSocketConfig): ModuleWithProviders { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ngModule: WebsocketModule, providers: [{<span class="hljs-type"><span class="hljs-type">provide</span></span>: <span class="hljs-type"><span class="hljs-type">config</span></span>, <span class="hljs-type"><span class="hljs-type">useValue</span></span>: <span class="hljs-type"><span class="hljs-type">wsConfig</span></span>}] }; } }</code> </pre> <br>  Vamos come√ßar a criar um servi√ßo: <br><br><pre> <code class="hljs ruby">private <span class="hljs-symbol"><span class="hljs-symbol">listeners:</span></span> IListeners; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   private <span class="hljs-symbol"><span class="hljs-symbol">uniqueId:</span></span> number; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   id  private <span class="hljs-symbol"><span class="hljs-symbol">websocket:</span></span> ReconnectingWebSocket; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   constructor(@Inject(config) private <span class="hljs-symbol"><span class="hljs-symbol">wsConfig:</span></span> WebSocketConfig) { this.uniqueId = -<span class="hljs-number"><span class="hljs-number">1</span></span>; this.listeners = {}; this.wsConfig.ignore = wsConfig.ignore ? wsConfig.ignore : []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  this.connect(); } ngOnDestroy() { this.websocket.close(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     }</code> </pre> <br>  M√©todo de conex√£o: <br><br><pre> <code class="hljs coffeescript">private connect(): void { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ReconnectingWebSocket config const options = { connectionTimeout: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    maxRetries: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    ...<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.options }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconnectingWebSocket(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.url, [], options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: Event)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket connected!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: CloseEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket close!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: ErrorEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket error!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: MessageEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onMessage(event); }); setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); }, (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.garbageCollectInterval || <span class="hljs-number"><span class="hljs-number">10000</span></span>)); }</code> </pre> <br>  Duplique o coletor de lixo e verificar√° as assinaturas por tempo limite: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">garbageCollect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> subject = topic[key]; <span class="hljs-comment"><span class="hljs-comment">//  Subject    if (!subject.observers.length) { delete topic[key]; } } }  ,   if (!Object.keys(topic).length) { delete this.listeners[event]; } } } }</span></span></code> </pre> <br>  Examinamos qual assinatura enviar o evento: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> onMessage(event: MessageEvent): void { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = JSON.parse(event.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(name) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.ignore.includes(name)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[name]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> keys = name.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      const isMessage = keys.includes(message.event); const model = modelParser(message); //     if (isMessage &amp;&amp; typeof model !== 'undefined') { model.then((data: ITopicDataType) =&gt; { //   Subject this.callMessage&lt;ITopicDataType&gt;(topic, data); }); } } } }</span></span></code> </pre> <br>  Evento Helmet no Assunto: <br><br><pre> <code class="hljs powershell">private callMessage&lt;T&gt;(topic: ITopic&lt;T&gt;, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T): void { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (const key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { const subject = topic[<span class="hljs-type"><span class="hljs-type">key</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subject) { //   subject.next(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{Date()}] Topic Subject is <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>`); } } } }</code> </pre> <br>  Criar Pub / Subt√≥pico: <br><br><pre> <code class="hljs markdown">private addTopic<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(topic: string, id?: number): MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> { const token = (++this.uniqueId).toString(); const key = id ? token + id : token; //  id   const hash = sha256.hex(key); // SHA256-   id  if (!this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>]) { this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>] = <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">any</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>{}; } return this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">hash</span></span>] = new MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(this.listeners, topic, hash); }</code> </pre> <br>  Inscrevendo-se em um ou mais eventos: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> addEventListener&lt;T&gt;(topics: string | string[], id?: number): Observable&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics) { //       const topicsKey = typeof topics === <span class="hljs-string"><span class="hljs-string">'string'</span></span> ? topics : topics.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.addTopic&lt;T&gt;(topicsKey, id).asObservable(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[${<span class="hljs-type"><span class="hljs-type">Date</span></span>()}] Can<span class="hljs-string"><span class="hljs-string">'t add EventListener. Type of event is "undefined".`); } }</span></span></code> </pre> <br>  Tudo aqui √© intencionalmente simplificado, mas pode ser convertido em entidades bin√°rias, como √© o caso do servidor.  Enviando comandos para o servidor: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sendMessage(event: string, data: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> = {}): <span class="hljs-type"><span class="hljs-type">void</span></span> { //   ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event &amp;&amp; this.websocket.readyState === <span class="hljs-number"><span class="hljs-number">1</span></span>) { this.websocket.send(<span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({event, data})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(<span class="hljs-string"><span class="hljs-string">'Send error!'</span></span>); } }</code> </pre> <br>  Adicione eventos ao ignorlist em tempo de execu√ß√£o: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { <span class="hljs-comment"><span class="hljs-comment">//    this.wsConfig.ignore.push(...topics); } }</span></span></code> </pre> <br>  Exclua eventos da lista de ignorados: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeRemoveIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { topics.forEach((topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//      const topicIndex = this.wsConfig.ignore.findIndex(t =&gt; t === topic); if (topicIndex &gt; -1) { //    this.wsConfig.ignore.splice(topicIndex, 1); } }); } }</span></span></code> </pre> <br>  Conectamos o m√≥dulo de soquetes da web: <br><br><pre> <code class="hljs powershell">@NgModule({ declarations: [ <span class="hljs-type"><span class="hljs-type">AppComponent</span></span> ], imports: [ <span class="hljs-type"><span class="hljs-type">BrowserModule</span></span>, <span class="hljs-type"><span class="hljs-type">ReactiveFormsModule</span></span>, <span class="hljs-type"><span class="hljs-type">WebsocketModule.config</span></span>({ <span class="hljs-type"><span class="hljs-type">url</span></span>: <span class="hljs-type"><span class="hljs-type">environment.ws</span></span>, //  <span class="hljs-string"><span class="hljs-string">"ws://mywebsocketurl"</span></span> //    <span class="hljs-type"><span class="hljs-type">ignore</span></span>: [<span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_1</span></span>, <span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_2</span></span>], <span class="hljs-type"><span class="hljs-type">garbageCollectInterval</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, //    <span class="hljs-type"><span class="hljs-type">options</span></span>: { <span class="hljs-type"><span class="hljs-type">connectionTimeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, //   <span class="hljs-type"><span class="hljs-type">maxRetries</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> //   } }) ], providers: [], bootstrap: [<span class="hljs-type"><span class="hljs-type">AppComponent</span></span>] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span></span> { }</code> </pre> <br>  N√≥s usamos nos componentes: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-root'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.css'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnDestroy { private messages$: Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messagesMulti</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">number</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">string[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormGroup; constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fb: FormBuilder, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> wsService: WebsocketService) { } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.form = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fb.group({ text: [<span class="hljs-literal"><span class="hljs-literal">null</span></span>, [ Validators.required ]] }); <span class="hljs-comment"><span class="hljs-comment">// get messages this.messages$ = this.wsService .addEventListener&lt;IMessage[]&gt;(WS_API.EVENTS.MESSAGES); // get messages multi this.messagesMulti$ = this.wsService .addEventListener&lt;IMessage[]&gt;([ WS_API.EVENTS.MESSAGES, WS_API.EVENTS.MESSAGES_1 ]); // get counter this.counter$ = this.wsService .addEventListener&lt;number&gt;(WS_API.EVENTS.COUNTER); // get texts this.texts$ = this.wsService .addEventListener&lt;string[]&gt;(WS_API.EVENTS.UPDATE_TEXTS); } ngOnDestroy() { } public sendText(): void { if (this.form.valid) { this.wsService .sendMessage(WS_API.COMMANDS.SEND_TEXT, this.form.value.text); this.form.reset(); } } public removeText(index: number): void { this.wsService.sendMessage(WS_API.COMMANDS.REMOVE_TEXT, index); } }</span></span></code> </pre> <br>  O servi√ßo est√° pronto para uso. <br><br><hr><br>  Embora o exemplo do artigo n√£o seja uma solu√ß√£o universal para cada projeto, ele demonstra uma das abordagens para trabalhar com soquetes da Web em aplicativos grandes e complexos.  Voc√™ pode coloc√°-lo em servi√ßo e modific√°-lo, dependendo das tarefas atuais. <br><br>  A vers√£o completa do servi√ßo pode ser encontrada no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . <br><br>  Para todas as perguntas, voc√™ pode entrar em contato nos coment√°rios, pelo Telegram ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pelo canal Angular de</a> l√°. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419099/">https://habr.com/ru/post/pt419099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419087/index.html">Compreender a mente de outra pessoa √© um mito</a></li>
<li><a href="../pt419089/index.html">Como trapacear ao jogar dados - dicas de especialistas em jogos</a></li>
<li><a href="../pt419091/index.html">Objetos radioativos entre n√≥s</a></li>
<li><a href="../pt419095/index.html">Escrevemos CSS melhor e mais bonito</a></li>
<li><a href="../pt419097/index.html">Mambot - um bot no Telegram para mulheres gr√°vidas</a></li>
<li><a href="../pt419101/index.html">Criar jogo durante o hackathon noturno</a></li>
<li><a href="../pt419103/index.html">Escrevendo um tradutor simples em Lisp - I</a></li>
<li><a href="../pt419105/index.html">Link para a transmiss√£o Slurm (Kubernetes Intensivo)</a></li>
<li><a href="../pt419107/index.html">Exemplos de vis√£o geral e configura√ß√£o de pe√ßas de arquivo do Dell EMC Unity</a></li>
<li><a href="../pt419109/index.html">Explique a franja no Android P. O que fazer com o Android Cutout?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>