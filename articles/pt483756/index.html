<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§º üë®üèΩ‚Äçüîß üôåüèΩ Fazemos solicita√ß√µes HTTP, degradamos normalmente (e n√£o uma √∫nica lacuna) üç≤ üëÅ‚Äçüó® üîò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje, poucas pessoas lembram que os aplicativos da Web podem ser executados sem uma √∫nica solicita√ß√£o XHR. O AJAX (Javascript ass√≠ncrono e XML) fornec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fazemos solicita√ß√µes HTTP, degradamos normalmente (e n√£o uma √∫nica lacuna)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/483756/"><img src="https://habrastorage.org/webt/q7/e_/an/q7e_an5o_ojnkjr4lmhiih9bula.png" alt="imagem"><br><br>  Hoje, poucas pessoas lembram que os aplicativos da Web podem ser executados sem uma √∫nica solicita√ß√£o XHR.  O AJAX (Javascript ass√≠ncrono e XML) fornece um recurso interessante - carregamento de dados sem recarregar a p√°gina.  Este conceito √© subjacente √† maioria dos SPA modernos. <br><br>  Mas nada √© dado assim, voc√™ tem que pagar por tudo.  O conceito AJAX parece extremamente simples, mas mesmo no n√≠vel de solicita√ß√£o de dados do servidor, voc√™ pode encontrar muitos problemas. <br><a name="habracut"></a><br>  Para come√ßar, vamos escrever o aplicativo SPA mais simples com o AJAX: <br><br><pre><code class="javascript hljs">initApp(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initApp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.innerHTML = <span class="hljs-string"><span class="hljs-string">` &lt;h3&gt;Employees list&lt;/h3&gt; &lt;ul id="employees-list"&gt;&lt;/ul&gt; &lt;button id="load-employees"&gt;Load employee&lt;/button&gt; `</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'load-employees'</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, loadEmployee); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadEmployee</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ fetch(<span class="hljs-string"><span class="hljs-string">'http://dummy.restapiexample.com/api/v1/employee/1'</span></span>) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> res.json()).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{employee_name}</span></span></span><span class="hljs-function">) =&gt;</span></span> addEmployee(employee_name)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addEmployee</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">employeeName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> employeeElement = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'li'</span></span>); employeeElement.innerText = employeeName; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'employees-list'</span></span>).appendChild(employeeElement); }</code> </pre> <br>  Tudo √© extremamente simples: quando voc√™ clica no bot√£o, solicitamos dados do servidor e, quando recebidos, adicionamos o item √† lista. <br><br>  Como eu disse, nesta fase, muita coisa pode dar errado e, para expandir o t√≥pico mais profundamente, primeiro analisaremos um pouco de teoria. <br><br><h2>  Duas filosofia de constru√ß√£o de interfaces tolerantes a falhas </h2><br><img src="https://habrastorage.org/webt/gd/dn/xk/gddnxk3fna-p7gcpynnnmjstybw.png" alt="imagem"><br><br><h3>  Degrada√ß√£o graciosa </h3><br>  Essa √© a filosofia de design de interface na qual o usu√°rio recebe inicialmente o maior n√∫mero poss√≠vel de fun√ß√µes.  E somente no caso de falha de qualquer parte do sistema, as fun√ß√µes dependentes dele ser√£o desativadas.  Parece complicado, mas a seguir vamos analis√°-lo com um exemplo - ser√° muito mais claro. <br><br><h3>  Aprimoramento progressivo </h3><br>  Existe uma filosofia alternativa / paralela - aprimoramento progressivo.  Nele, o movimento √© contr√°rio: inicialmente, o usu√°rio recebe um conjunto m√≠nimo (ou m√©dio) de funcionalidades.  E para inicializar o restante, primeiro √© verificado o suporte das partes do sistema necess√°rias para o trabalho delas. <br><br>  Geralmente, quando se fala em <b>degrada√ß√£o</b> simples <b>e aprimoramento progressivo</b> no contexto de aplicativos baseados em navegador, eles significam compatibilidade ou adaptabilidade entre navegadores.  H√° um exemplo popular explicando esses conceitos.  Suponha que seu aplicativo tenha uma fun√ß√£o de impress√£o de p√°gina e se voc√™ fizer isso: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript:window.print()"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"print-btn"</span></span></span><span class="hljs-tag">&gt;</span></span>Print<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">const</span></span></span><span class="javascript"> printButton = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'print-btn'</span></span></span><span class="javascript">); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (printButton &amp;&amp; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">typeof</span></span></span><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.print !== </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'function'</span></span></span><span class="javascript">) { printButton.parentNode.appendChild(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.createTextNode(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'  '</span></span></span><span class="javascript">)); printButton.parentNode.removeChild(printButton); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  isso √© <b>degrada√ß√£o normal</b> , porque voc√™ mostra imediatamente o bot√£o de impress√£o, mas quando percebe que a impress√£o n√£o √© suportada pelo navegador, voc√™ remove a funcionalidade. <br><br>  PS: No exemplo original, a tag noscript foi usada para demonstrar <b>degrada√ß√£o graciosa</b> , mas parece-me muito desatualizada. <br><br>  Se voc√™ fizer isso: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.print === <span class="hljs-string"><span class="hljs-string">'function'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> printButton = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); printButton.innerText = <span class="hljs-string"><span class="hljs-string">'Print'</span></span>; printButton.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, () =&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.print()); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(printButton); }</code> </pre><br>  esse √© um <b>aprimoramento progressivo</b> , porque primeiro voc√™ verifica o suporte para a API necess√°ria e depois adiciona a fun√ß√£o. <br><br>  Os exemplos demonstram a aplica√ß√£o mais primitiva das filosofias de design de interface de toler√¢ncia a falhas. <br><br>  Voltar para <b>solicita√ß√µes</b> <b>AJAX</b> e <b>HTTP</b> . <br><br><h2>  O que poderia dar errado com o AJAX? </h2><br><h3>  C√≥digo de status HTTP inesperado </h3><br><img src="https://habrastorage.org/webt/uy/el/zt/uyelztasfngdzvaizjhtd4qdxss.png" alt="imagem"><br><br>  O caso mais simples ser√° se o servidor retornar o c√≥digo de status errado que voc√™ esperava, digamos 500. Esse √© um cen√°rio comum e voc√™ provavelmente possui algumas ferramentas para process√°-lo.  Por exemplo, mostre ao usu√°rio uma notifica√ß√£o "Ocorreu um erro no servidor".  Isso √© claramente degrada√ß√£o, mas como √© gracioso?  √â poss√≠vel aplicar aprimoramento progressivo aqui?  N√£o, esse definitivamente n√£o √© o lugar para aprimoramentos progressivos - a funcionalidade j√° est√° degradada.  Voc√™ s√≥ pode superar esse problema lindamente: <br><br><ol><li>  Descobrir que essa situa√ß√£o geralmente ocorreu no cliente para evit√°-la no futuro.  Para isso, geralmente s√£o usados ‚Äã‚Äãregistradores de erros, por exemplo <a href="https://sentry.io/">sentry.io</a> . <br></li><li>  Coloque em cache os dados recebidos, se poss√≠vel.  Legal se j√° houve uma chamada para uma solicita√ß√£o semelhante e voc√™ armazenou os dados em cache.  Nesse caso, mesmo se voc√™ receber um c√≥digo de status inesperado do servidor, poder√° exibir a interface, embora n√£o com os dados mais atuais. </li><li>  Tente repetir a solicita√ß√£o mais tarde.  Talvez seja um travamento tempor√°rio do servidor e ap√≥s alguns segundos ele ser√° "liberado".  Voc√™ pode fazer uma segunda solicita√ß√£o automaticamente ou fornecer essa op√ß√£o ao usu√°rio. <br></li><li>  N√£o bloqueie o restante do aplicativo.  Se voc√™ mostrar um bot√£o girat√≥rio ou esqueleto antes de chamar a solicita√ß√£o HTTP, n√£o esque√ßa de ocult√°-lo em qualquer conclus√£o da solicita√ß√£o, com √™xito ou n√£o.  Isso pode parecer √≥bvio, mas eu j√° me deparei com isso com bastante frequ√™ncia. </li><li>  Em geral, pode haver muitos c√≥digos de status inesperados, por exemplo, quando uma sess√£o do usu√°rio expirou e o servidor respondeu com o c√≥digo 403. Para esse erro, √© necess√°rio um manipulador separado que emita novamente o token da sess√£o ou envia o usu√°rio para autoriza√ß√£o.  O aplicativo de failover deve ter manipuladores para todas as respostas poss√≠veis do servidor. </li></ol><br><h3>  Resposta inv√°lida </h3><br><img src="https://habrastorage.org/webt/v0/qx/pk/v0qxpkivrql4ftzj-ansb5-b3ag.png" alt="imagem"><br><br>  Nunca confie no back-end!  O servidor pode responder com o c√≥digo 200, mas no corpo da resposta ele retornar√° os dados incorretos que voc√™ precisa.  Nessa situa√ß√£o, voc√™ pode fazer o mesmo que com um c√≥digo de status inesperado, mas a dificuldade est√° em determinar que a resposta √© realmente inv√°lida. <br><br>  Se voc√™ escreve em texto datilografado, existe para voc√™ uma ferramenta interessante - <a href="https://github.com/YousefED/typescript-json-schema">typescript-json-schema</a> .  Com ele, voc√™ pode gerar esquemas json a partir de interfaces datilografadas e us√°-los para validar dados em tempo de execu√ß√£o. <br><br><h3>  Resposta longa </h3><br><img src="https://habrastorage.org/webt/vs/j1/5z/vsj15z3zrwlf73aipc7mf7gimwi.png" alt="imagem"><br><br>  Este √© o golpe que poucos esperam.  Se nos lembramos de erros ou mesmo de dados de resposta inv√°lidos, raramente nos lembramos de tempos limites.  O culpado pode n√£o ser apenas o aplicativo do servidor, mas tamb√©m o provedor da Internet ou o dispositivo do cliente. <br><br>  N√£o se esque√ßa, √© melhor notificar o usu√°rio que a solicita√ß√£o √© mais longa do que o normal do que deix√°-lo sozinho com um c√≠rculo girat√≥rio na tela.  Quando o tempo alocado para a execu√ß√£o da solicita√ß√£o expirar, voc√™ poder√° passar por um cen√°rio semelhante ao das duas situa√ß√µes anteriores. <br><br><h3>  Falta de internet </h3><br><img src="https://habrastorage.org/webt/pu/v4/fy/puv4fye-opxgmqqnvlh99h4d9bg.png" alt="imagem"><br><br>  Fiquei muito impressionado ao saber que o Google Documents tem um modo offline.  Isso me ajudou muito quando decidi terminar de escrever um artigo em um avi√£o onde n√£o havia internet. <br><br>  Obviamente, os aplicativos s√£o diferentes e muitos deles s√£o praticamente in√∫teis sem a Internet.  Mas mesmo nesses aplicativos, voc√™ pode lidar com o caso com a falta de conex√£o e mostrar uma mensagem informativa (embora eu tamb√©m goste de tocar o tiranossauro no "Chrome"). <br><br>  Al√©m disso, voc√™ pode ouvir <a href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorOnLine/Online_and_offline_events">eventos conectando / desconectando a conex√£o com a Internet</a> .  E, por exemplo, recarregue automaticamente os dados durante o evento online na janela. <br><br><h2>  Interface tolerante a falhas - n√£o √© f√°cil </h2><br>  No total, a lista de a√ß√µes que devem ser implementadas ao chamar a solicita√ß√£o HTTP: <br><br><ol><li>  Erros de log. </li><li>  Cache de dados e us√°-lo. </li><li>  Repita solicita√ß√µes sem √™xito. </li><li>  N√£o bloqueie a interface. </li><li>  Manipule todas as respostas poss√≠veis do servidor. </li><li>  Valide as respostas do servidor. </li><li>  Definir tempos limite. </li><li>  Modo offline (falta de internet). </li></ol><br>  O que parecia trivial a princ√≠pio se transformou em uma filosofia inteira com muitos problemas.  Claro, isso n√£o √© um cabe√ßalho.  Mas se seu aplicativo alcan√ßou um alto n√≠vel de maturidade e voc√™ deseja criar uma interface realmente de alta qualidade, ent√£o √© nessa dire√ß√£o que vale a pena desenvolver. <br><br>  O objetivo deste artigo √© falar sobre poss√≠veis problemas ao trabalhar com solicita√ß√µes HTTP, mas n√£o sobre solu√ß√µes espec√≠ficas.  Atualmente, h√° um grande n√∫mero de bibliotecas e estruturas destinadas a solucionar esses problemas, por exemplo, interceptores HTTP no Angular. <br>  Sabendo dos poss√≠veis problemas, ser√° muito mais f√°cil encontrar uma solu√ß√£o para eles na Internet. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483756/">https://habr.com/ru/post/pt483756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483746/index.html">Esta√ß√£o de entrada: passagem para a linha lunar, acesso √† esta√ß√£o marciana</a></li>
<li><a href="../pt483748/index.html">O descuido dos usu√°rios do PayPal, permitindo que eles roubem sua conta e dinheiro [Fixo]</a></li>
<li><a href="../pt483750/index.html">Tradu√ß√£o do livro de Andrew Un, Passion for Machine Learning, Cap√≠tulos 30 - 32</a></li>
<li><a href="../pt483752/index.html">Onde ir: os pr√≥ximos eventos gratuitos para especialistas em TI em Moscou (14 a 18 de janeiro)</a></li>
<li><a href="../pt483754/index.html">Como medir a melhoria da equipe?</a></li>
<li><a href="../pt483758/index.html">As 10 principais empresas iniciantes de desenvolvimento de aplicativos m√≥veis podem se associar em 2020</a></li>
<li><a href="../pt483762/index.html">Lan√ßamento do GitLab 12.6 com classifica√ß√µes de seguran√ßa do projeto e materiais de lan√ßamento</a></li>
<li><a href="../pt483766/index.html">Tribunais como uma ferramenta de hackers sociais ou um pouco sobre a confiabilidade das informa√ß√µes nas bases de dados WHOIS</a></li>
<li><a href="../pt483768/index.html">MVCC no PostgreSQL-5. Aspira√ß√£o na p√°gina e atualiza√ß√µes HOT</a></li>
<li><a href="../pt483770/index.html">Rumo √† automa√ß√£o SSL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>