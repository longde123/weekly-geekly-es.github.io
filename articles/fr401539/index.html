<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèΩ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ üìÖ Test d'effort NVidia GPU sur le transcodage en direct üòó üê¨ üõ¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous trouverez ci-dessous une histoire d√©taill√©e sur la fa√ßon dont nous avons charg√© la carte de NVidia avec les t√¢ches de transcodage de la vid√©o pou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test d'effort NVidia GPU sur le transcodage en direct</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401539/">  <i>Vous trouverez ci-dessous une histoire d√©taill√©e sur la fa√ßon dont nous avons charg√© la carte de NVidia avec les t√¢ches de transcodage de la vid√©o pour sa diffusion.</i>  <i>Montrons que nous avons essay√© ce qui s'est pass√© et comment utiliser au mieux les cartes vid√©o pour la diffusion en ligne.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/7ef/cc6/50b/7efcc650b901459bbb5addc4fe8d6bd3.png"></div><a name="habracut"></a>  Depuis plusieurs ann√©es, notre √©quipe d√©veloppe des produits pour le traitement et la distribution de contenu multim√©dia en ligne.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cet article a</a> r√©cemment <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expliqu√©</a> pourquoi les propri√©taires de contenu pourraient avoir besoin de telles solutions √† l'√®re de YouTube. <br><br>  L'un de nos produits est le serveur multim√©dia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nimble Streamer</a> , qui est un logiciel serveur qui prend les flux en direct et les fichiers √† l'entr√©e et les rend accessibles √† un grand nombre de t√©l√©spectateurs, tout en lui permettant simultan√©ment de mon√©tiser le contenu.  Il s'agit d'une application native √©crite en C ++ et port√©e sur tous les syst√®mes d'exploitation (Linux, Windows, MacOS) et plates-formes populaires (x64, ARM).  D√®s le d√©but, une faible consommation de ressources et une productivit√© √©lev√©e √©taient les principales exigences, et nous parvenons √† obtenir de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bons r√©sultats</a> dans ce domaine. <br><br>  L'ann√©e derni√®re, nous avons publi√© le module compl√©mentaire Nimble Streamer - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">transcodeur de diffusion en direct</a> .  Cette application vous permet de prendre le flux d'entr√©e vid√©o et / ou audio dans diff√©rents formats et d'effectuer diverses conversions avec eux en temps r√©el.  La fonctionnalit√© comprend le d√©codage (logiciel et mat√©riel), la conversion vid√©o et audio √† l'aide de filtres (redimensionnement, superposition, etc.) et l'encodage (codage) - logiciel et mat√©riel. <br><br>  Le transcodeur est contr√¥l√© via le service Web WMSPanel, les scripts de transcodage sont cr√©√©s via l'interface glisser-d√©poser, ce qui vous permet de voir visuellement le processus.  Diff√©rents sc√©narios peuvent √™tre ex√©cut√©s ensemble - avec cette approche, il est pratique d'ex√©cuter des combinaisons de tests, en chargeant le serveur dans toutes les variantes. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dans ces vid√©os,</a> vous pouvez voir des exemples de fonctionnement de l'interface. <br><br>  Le d√©codage de chaque flux n'est effectu√© qu'une seule fois avant toutes les autres conversions ... Cela vous permet d'√©conomiser des ressources sur une op√©ration de d√©codage co√ªteuse, cela sera clairement visible plus loin au cours des tests. <br><br>  L'un des m√©canismes de conversion qui peuvent √™tre utilis√©s dans notre transcodeur est le d√©codage mat√©riel et l'encodage vid√©o √† l'aide du GPU de NVidia.  Les cartes graphiques des derni√®res g√©n√©rations vous permettent d'assumer certaines des t√¢ches typiques, ce qui supprime la charge du processeur.  Notre transcodeur est capable de fonctionner avec ce mat√©riel, qui est activement utilis√© par nos clients. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/460/a36/96e/460a3696ed2e4f1e8d7491ecc4e7c2ca.png"></div><br>  Au cours de la communication avec les repr√©sentants du bureau russe de NVidia, on nous a demand√© d'essayer d'organiser des tests de r√©sistance conjoints de notre transcodeur et du GPU NVidia afin de comprendre quel sera l'effet √©conomique d'un tel tandem par rapport √† un transcodage exclusivement logiciel, sans acc√©l√©ration mat√©rielle.  De plus, je voulais comprendre comment utiliser de mani√®re optimale le GPU, et si possible donner de bonnes recettes. <br><br>  Nous devions obtenir rapidement le fer appropri√© et y avoir acc√®s, pour le cycle de nos exp√©riences.  Nous avions pr√©vu de nous rencontrer quelques semaines.  Reste √† savoir o√π se procurer le mat√©riel.  La meilleure option serait de les trouver dans le cloud et d'acc√©der √† distance.  Apr√®s avoir recherch√© les options, il s'est av√©r√© qu'AWS n'a pas encore de machine virtuelle avec un GPU de g√©n√©ration Maxwell, et dans le cloud Azure, il est seulement pr√©vu de commencer √† les fournir bient√¥t. <br><br><h2>  1. Repasser √† partir de NVidia dans le cloud Softlayer, configuration de Nimble Streamer </h2><br>  Avec l'aide de NVidia, IBM nous a fourni un acc√®s √† son cloud, IBM Bluemix Cloud Platform (anciennement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Softlayer</a> ).  Il s'agit d'un vaste r√©seau de centres de donn√©es modernes (environ 50 au moment de la publication) dans le monde, connect√©s par un r√©seau priv√© commun et fournissant une large s√©lection de services d'infrastructure cloud.  Tous les centres de donn√©es sont unifi√©s et vous permettent de louer de un √† des centaines de serveurs virtuels ou physiques de la configuration requise pendant plusieurs heures, ainsi que des √©quilibreurs, des syst√®mes de stockage, des pare-feu - en g√©n√©ral, tout ce qui est n√©cessaire pour construire une infrastructure informatique fiable pour le service informatique d√©ploy√©. <br><br>  Le bureau de repr√©sentation russe d'IBM nous a donn√© un acc√®s complet au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">portail en libre-service</a> pour la gestion des services cloud et √† la configuration de serveur n√©cessaire, o√π nous avons pu travailler avec diff√©rents flux d'entr√©e et param√®tres de notre transcodeur. <br><br><h3>  Le fer </h3><br>  Tout d'abord, nous avons re√ßu un serveur physique (bare-metal) avec 128 Go de RAM et 2xGPU NVidia Tesla M60 et OS pr√©install√© Ubuntu 14.04.  Tous les param√®tres du serveur, mots de passe, versions du micrologiciel, sa commutation, IP d√©di√©e, l'√©tat des composants mat√©riels, √©taient visibles directement dans votre compte personnel, vous permettant de faire les manipulations requises avec le mat√©riel lou√©, ce qui minimisait le besoin d'interaction avec le support IBM.  Au cours du test, il s'est av√©r√© que nous n'avons pas pu charger de mani√®re optimale cette configuration, en raison d'un certain nombre de limitations dans la g√©n√©ration des contextes. <br><br>  Nous voulions r√©duire la configuration.  Depuis que nous avons utilis√© la plate-forme cloud, elle √©tait requise via le portail libre-service pour demander des modifications de configuration.  Apr√®s approbation, cette op√©ration a pris environ 2 heures jusqu'√† la fen√™tre de service approuv√©e.  Pendant ce temps, le personnel technique du centre de donn√©es d'Amsterdam a retir√© des composants suppl√©mentaires (emplacements RAM et 1xGPU) du serveur qui nous avait √©t√© fourni plus t√¥t et l'a remis en service.  Il convient de noter que pour les d√©veloppeurs, cette option est tr√®s pratique, car il n'est pas n√©cessaire de traiter les param√®tres mat√©riels, de les r√©parer ou m√™me de passer du temps √† installer le syst√®me d'exploitation.  Permettez-moi de vous rappeler que dans ce cas, l'hyperviseur n'est pas utilis√© car nous devons tirer le maximum des ressources mat√©rielles. <br><br>  Sur la base des r√©sultats de nos recherches, nous avons opt√© pour la configuration de serveur suivante: <br><blockquote>  Double Intel Xeon E5-2690 v3 (2,60 GHz) <br>  24 coeurs <br>  64 Go de RAM <br>  1TB SATA <br></blockquote><br>  Nous avons 2 processeurs avec 12 c≈ìurs chacun, et gr√¢ce √† l'hyper threading, nous en obtenons deux fois plus, c'est-√†-dire  pratiquement 48 c≈ìurs. <br><br>  Dans les sc√©narios avec un acc√©l√©rateur graphique, une carte bas√©e sur la puce GM204 - Tesla M60 a √©t√© utilis√©e: <br><blockquote>  NVIDIA Tesla M60 <br>  1xGPU: 2 x Maxwell GM204 <br>  M√©moire: 16 Go GDDR5 <br>  Fr√©quence d'horloge: 2,5 GHz <br>  Noyaux NVIDIA CUDA: 2 x 2048 <br>  Bande passante m√©moire: 2 x 160 Go / sec </blockquote><br>  J'attire votre attention sur le fait qu'aucune affinit√©, r√©glage de puce, overclocking ou autre magie n'a √©t√© effectu√© sur le mat√©riel r√©duit - uniquement des CPU et GPU non overclock√©s, et pour le GPU, seul le pilote officiel tir√© du site Web NVidia a √©t√© utilis√©.  Si quelqu'un a une exp√©rience similaire - partagez les commentaires. <br><br>  Nous avons donc eu acc√®s.  Une connaissance rapide de l'interface Web du panneau de contr√¥le (tout est simple et clair l√†-bas), puis l'acc√®s au serveur via SSH - et nous voici dans la ligne de commande Ubuntu habituelle, mettez Nimble Streamer, enregistrez une nouvelle licence de transcodeur et faites une petite configuration. <br><br><h3>  Transcodeur de streamer agile </h3><br>  Nimble Streamer a √©t√© configur√© pour pr√©-cr√©er le cache de contexte GPU.  Cela est d√ª au fait que le GPU a une limite sur le nombre maximum de contextes de d√©codage et d'encodage cr√©√©s, et en outre, la cr√©ation de contextes √† la vol√©e peut prendre trop de temps. <br>  Plus de d√©tails sur le probl√®me de la cr√©ation de contextes peuvent √™tre trouv√©s dans la section correspondante ci-dessous. <br><br>  Param√®tres Nimbl sur l'exemple de la premi√®re s√©rie de tests: <br><blockquote>  nvenc_context_cache_enable = true <br>  nvenc_context_create_lock = true <br>  nvenc_context_cache_init = 0: 30: 15.1: 30: 15 <br>  nvenc_context_reuse_enable = true </blockquote><br>  Plus de d√©tails sur ces param√®tres sont √©crits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans notre article</a> . <br><br>  Avant de d√©marrer chaque s√©rie de tests, le cache √©tait configur√© s√©par√©ment, en tenant compte des sp√©cificit√©s de chaque t√¢che. <br><br><h3>  Cr√©er des scripts de transcodage </h3><br>  D'autres travaux se sont poursuivis dans notre service WMSPanel, o√π les scripts du transcodeur sont configur√©s. <br><br>  Comme d√©j√† mentionn√©, le travail passe par l'interface web, tout est extr√™mement clair et pratique.  Nous avons cr√©√© un certain nombre de sc√©narios combinant diff√©rentes options de transcodage (CPU / GPU), diff√©rentes options de r√©solution et diff√©rents param√®tres d'encodage (CPU / GPU, profil, d√©bit binaire, etc.) <br><br>  Des ensembles de sc√©narios peuvent √™tre ex√©cut√©s simultan√©ment, ce qui permet d'introduire diff√©rentes combinaisons de tests, d'augmenter la charge dans un ordre diff√©rent et de la modifier en fonction de la situation.  S√©lectionnez simplement les sc√©narios n√©cessaires et arr√™tez-les ou reprenez-les. <br><br>  Voici un ensemble de sc√©narios: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cd6/197/b77/cd6197b77e6b4c0697f43f8d1cfaaf07.png"></div><br>  Voici un exemple de l'un des sc√©narios: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e47/1ff/924/e471ff9244f240edb2c092f42d5cf721.png"></div><br>  Le d√©codeur GPU ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/382/0f8/2fd/3820f82fd74e4e0ea106534962e1ba28.png"></div><br>  Nous appliquons le filtre de taille d'image: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9d3/bd0/eab/9d3bd0eab2ac47d4b3183aca91db0d6f.png"></div><br>  Et voici l'encodeur pour la variante GPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/212/d34/e2e/212d34e2e3cf425a9f94d03194f7c62d.png"></div><br><br>  En g√©n√©ral, le fonctionnement de l'interface du transcodeur peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vu dans ces vid√©os</a> . <br><br><h2>  2. Transcodage de flux FullHD 1080p </h2><br>  Pour commencer, nous avons test√© le sc√©nario avec les charges les plus √©lev√©es afin de d√©couvrir les limites des capacit√©s en fer.  √Ä l'heure actuelle, la ¬´plus lourde¬ª des r√©solutions utilis√©es dans la pratique est FullHD 1080p. <br><br>  Pour g√©n√©rer les flux en direct d'origine, un fichier a √©t√© pris en <b>FullHD</b> (1920 * 1080) en <b>profil haut H.264</b> .  Le contenu lui-m√™me est une visite vid√©o de la ville, c'est-√†-dire  Il s'agit d'une vid√©o avec un taux de changement d'image moyen.  Il n'y a pas de trames statiques monochromes qui pourraient faciliter le travail du transcodeur, mais il n'y a pas de changement trop rapide de types et de couleurs.  En un mot - une charge assez typique. <br><br>  <b>36 flux identiques</b> ont √©t√© introduits dans l'entr√©e Nimble Streamer, qui ont ensuite √©t√© utilis√©s dans le transcodeur dans diff√©rents sc√©narios. <br><br>  Le sc√©nario de transcodage est utilis√© de mani√®re typique - le flux entrant est un profil haut <b>1080p</b> , <b>720p, 480p, un profil principal 360p en</b> est cr√©√© <b>,</b> puis les flux de <b>profil de base: 240p, 160p</b> .  Au total, il y a 1 flux √† l'entr√©e et 5 √† la sortie. Habituellement, une transmission (transfert sans modifications) du flux d'origine est √©galement effectu√©e afin que le spectateur puisse s√©lectionner 1080p lui-m√™me lors de la visualisation.  Nous ne l'avons pas ajout√© dans le script, car  il n'utilise pas de transcodage - il y a un transfert direct des donn√©es de l'entr√©e √† la sortie.  Ce sc√©nario est optimis√© dans Nimble et en conditions r√©elles, il augmentera la consommation de m√©moire relativement l√©g√®rement. <br>  Audio dans les flux g√©n√©r√©s - non.  L'ajout d'audio au script ne causera pas de charges CPU importantes, mais pour la puret√© de l'exp√©rience, nous avons exclu le son. <br><br><h3>  Test CPU, pas de GPU </h3><br>  Pour commencer, nous avons lanc√© le transcodage des scripts sans utiliser de GPU, en sp√©cifiant le d√©codeur logiciel et l'encodeur dans les scripts. <br><br>  En cons√©quence, il n'a √©t√© possible de traiter que 16 flux d'entr√©e avec l'√©mission de 80 flux de toutes les autorisations de sortie. <br><br>  Charge CPU - 4600%, soit  46 c≈ìurs ont √©t√© impliqu√©s.  Consommation de RAM - environ 15 Go. <br><br><h3>  Test CPU + GPU </h3><br>  Le cache de contexte au d√©marrage est configur√© comme 0: 30: 15.1: 30: 15 - c'est-√†-dire  30 contextes pour l'encodage, 15 pour le d√©codage, chaque GPU. <br><br>  Permettez-moi de vous rappeler que sur le GPU, nous avons deux c≈ìurs, ce qui nous permet de parall√©liser les t√¢ches - cela nous est utile. <br><br>  La charge maximale a √©t√© obtenue avec la configuration de d√©bit suivante. <br><br>  Le d√©codeur d'entr√©e GPU0 et GPU1 - 15 flux.  Ainsi, nous obtenons 30 flux d√©cod√©s, pr√™ts pour une utilisation ult√©rieure.  Chaque flux n'est d√©cod√© qu'une seule fois, quel que soit le nombre de sc√©narios utilis√©s √† l'avenir. <br><br>  Les encodeurs GPU0 et GPU1 ont re√ßu 15 flux chacun pour obtenir 720p, c'est-√†-dire  30 flux de 720p sur une sortie se sont av√©r√©s. <br><br>  En outre, les encodeurs GPU0 et GPU1 ont chacun fourni 15 flux pour 480p - et 30 flux de 480p ont √©galement √©t√© √©mis. <br><br>  Les contextes d'encodeur √©tant √©puis√©s, l'encodage des autorisations restantes a √©t√© d√©fini sur le CPU.  Il s'est av√©r√© ce qui suit: <br><br><ol><li>  30 flux 360p </li><li>  30 flux 240p </li><li>  30 flux 160p </li></ol><br>  La charge s'est av√©r√©e √™tre 2600% CPU, 75% d√©codeur, 32% encodeur.  Ensuite, le CPU a √©t√© charg√© avec 6 flux pour le d√©codage, pour chaque 5 r√©solutions similaires ont √©t√© configur√©es, pour un total de 30 threads par sortie. <br><br>  Au total, <b>36 flux</b> ont √©t√© re√ßus <b>en entr√©e, 180 ont √©t√© √©mis en sortie</b> .  La charge finale est fix√©e comme suit: <b>4400% CPU, 75% d√©codeur de carte, 32% encodeur de carte, 30 Go de RAM</b> . <br><br><h3>  Quelques d√©tails </h3><br>  Nous avons d√©cid√© de v√©rifier l'option dans laquelle nous traitons les t√¢ches les plus difficiles sur le GPU - d√©codage 1080 et codage 720 et 480, et laisser le reste √™tre trait√© via le CPU. <br><br>  Tout d'abord, nous avons v√©rifi√© la limite du d√©codeur.  Avec 22 threads, le d√©codage √©tait affect√© par le probl√®me des contextes, ils ne pouvaient tout simplement pas √™tre cr√©√©s.  Diminu√© √† 21 - des contextes ont √©t√© cr√©√©s, mais la charge est devenue √† 100% et des artefacts ont commenc√© √† √™tre observ√©s dans le cours d'eau.  Nous nous sommes arr√™t√©s √† 20 flux - nous faisons le d√©codage de 20 flux, l'encodage √† 160p - tout fonctionne bien. <br><br>  De plus, il s'est av√©r√© empiriquement que cette carte avec 16 Go de RAM √† bord peut fonctionner en toute confiance avec 47 contextes - et il n'y a pas de diff√©rence, ce sont les contextes d'un encodeur ou d'un d√©codeur.  Je r√©p√®te - il s'agit sp√©cifiquement de ce GPU Tesla M60, sur d'autres cartes, ce nombre peut √™tre diff√©rent.  Nous pensons que si la carte avait 24 Go de RAM, le nombre de contextes pourrait √™tre diff√©rent, mais cela doit √™tre test√©. <br><br>  En cons√©quence, nous avons choisi la formule de cr√©ation de cache "15 contextes du d√©codeur et 30 contextes de l'encodeur" - qui donne 30 flux √† l'entr√©e et pour chacun vous permet de cr√©er 2 autorisations.  Ainsi, les r√©solutions sup√©rieures - 720 et 480 - ont √©t√© lanc√©es sur le GPU, et les autres - 360, 240 et 160 - ont √©t√© envoy√©es au CPU.  Et puisque le CPU √©tait encore libre apr√®s cela, nous avons ¬´termin√©¬ª les c≈ìurs gratuits avec de nouveaux threads, laissant 4 c≈ìurs pour les t√¢ches utilitaires. <br><br><h2>  3. Transcodage de flux HD 720p </h2><br>  Sc√©nario de charge typique  La plupart du contenu est d√©sormais cr√©√© en HD.  M√™me le r√©cent SuperBowl LI - l'√©mission la mieux not√©e sur le march√© am√©ricain - a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">diffus√© en HD</a> , laissant FullHD pour l'avenir. <br><br>  Pour g√©n√©rer les flux source, un fichier a √©t√© pris en <b>HD</b> (1280 * 720) dans un <b>profil √©lev√©</b> .  Le contenu est la s√©rie pr√©f√©r√©e de notre ing√©nieur ¬´The Good Wife¬ª, c'est-√†-dire  Il s'agit d'une vid√©o avec un taux de changement d'image moyen. <br><br>  √Ä l'entr√©e du Nimble Streamer, 70 flux identiques ont √©t√© aliment√©s, qui ont ensuite √©t√© utilis√©s dans le transcodeur dans diff√©rents sc√©narios. <br><br>  Le sc√©nario de transcodage suivant est utilis√© - le flux entrant est un profil haut <b>720p,</b> un profil <b>principal 480p, 360p</b> , puis <b>des</b> flux de profil de <b>base 240p, 160p</b> sont cr√©√©s √† partir de celui-ci.  Total, √† l'entr√©e 1, √† la sortie 4. La transmission du flux d'origine, comme dans le sc√©nario pr√©c√©dent, n'a pas √©t√© effectu√©e.  L'audio dans les flux g√©n√©r√©s ne l'est pas non plus. <br><br><h3>  Test CPU, pas de GPU </h3><br>  Comme dans la section pr√©c√©dente, nous avons essay√© de transcoder les flux uniquement sur le CPU.  En cons√©quence, il n'a √©t√© possible de traiter que 22 flux d'entr√©e avec l'√©mission de 88 flux de toutes les autorisations de sortie.  Charge CPU - 4700%, soit  47 c≈ìurs ont √©t√© impliqu√©s.  Consommation de RAM - environ 20 Go. <br><br><h3>  Test CPU + GPU </h3><br>  Le cache de contexte au d√©marrage est configur√© comme 0: 23: 23.1: 23: 23 - c'est-√†-dire  23 contextes pour l'encodage, 23 pour le d√©codage pour chaque GPU. <br><br>  En utilisant le GPU, 46 flux 720p ont √©t√© d√©cod√©s.  L√†, sur le GPU, 46 flux de 480p ont √©t√© encod√©s.  Ensuite, l'encodage 360p, 240p et 160p a √©t√© effectu√© sur le CPU - 46 flux chacun. <br>  Charge fixe de 2100% CPU, 61% du d√©codeur, 16% de l'encodeur. <br><br>  De plus, l'encodage et le d√©codage de 24 threads vers le CPU ont √©t√© lanc√©s, pour chaque 1 thread - 4 sorties, comme pour le GPU. <br><br>  Au total, <b>70 flux ont √©t√© entr√©s, 280 flux ont √©t√© sortis</b> . <br>  Charge: <b>4600%, 61% du d√©codeur, 16% de l'encodeur, 30 Go de RAM</b> . <br><br>  Comme pour le test pr√©c√©dent, peut-√™tre qu'un GPU RAM plus grand donnerait plus de contextes et nous pourrions g√©rer plus de threads.  Mais ce n'est qu'en th√©orie, il faut v√©rifier. <br><br><h2>  4. Le probl√®me avec la cr√©ation de contextes dans le GPU NVidia </h2><br>  Quelques mots sur le probl√®me qui ne nous a pas permis de traiter plus de threads sur le GPU. <br><br>  √Ä la fin de l'ann√©e derni√®re, nous avons effectu√© des tests avec l'√©quipe de NVidia, avec plusieurs cartes.  Lorsque vous travaillez avec plusieurs GPU, il s'est av√©r√© que la cr√©ation de contextes ralentit consid√©rablement le serveur - la cr√©ation de chaque nouveau contexte prenait de plus en plus de temps de la carte.  Si le premier contexte a √©t√© cr√©√© de l'ordre de 300 ms, alors chacun des suivants a ajout√© 200 √† 300 ms et d√©j√† dans les troisi√®mes dix contextes, la cr√©ation d'un nouveau a pris 3-4 secondes chacun.  Lorsqu'un utilisateur cr√©e un script de transcodage, il est suppos√© qu'il commence √† travailler imm√©diatement et sans retards, et cette nouvelle circonstance annule tous les avantages de la vitesse Nimbl et retarde la cr√©ation de contextes qui entra√Ænent des retards dans le d√©marrage de l'encodage. <br><br>  Au d√©but, les soup√ßons √©taient tomb√©s sur Nimble, mais ensuite nous avons fait des tests en utilisant ffmpeg, que NVidia lui-m√™me fournit aux clients et le r√©sultat s'est av√©r√© √™tre exactement le m√™me - le GPU passe de plus en plus de temps √† cr√©er chaque nouveau contexte.  Dans des conditions o√π le serveur est d√©j√† en train de transcoder et que vous devez d√©marrer de nouveaux threads pour le traitement, cela affecte les performances globales et rend le serveur tout simplement inutilisable. <br><br>  Le probl√®me a √©t√© d√©crit en d√©tail par l'√©quipe NVidia, mais jusqu'√† pr√©sent aucune solution √† temps plein n'a √©t√© fournie.  Par cons√©quent, nous avons jusqu'√† pr√©sent impl√©ment√© un m√©canisme de mise en cache de contexte dans notre serveur, avec la cr√©ation pr√©liminaire de contextes au d√©marrage du serveur.  Cela a r√©solu le probl√®me du point de vue du travail de l'utilisateur final, mais le d√©marrage du Nimbl peut prendre un certain temps.  La configuration de Nimbl pour un travail efficace avec les contextes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est d√©crite dans notre blog</a> . <br><br>  De plus, les contextes ne sont pas faciles √† cr√©er.  Avec un grand nombre de contextes lors de l'inclusion d'un script de transcodage, l'API NVENC commence √† g√©n√©rer des erreurs: ¬´L'appel d'API a √©chou√© car il n'a pas pu allouer suffisamment de m√©moire pour effectuer l'op√©ration demand√©e.¬ª <br><br>  Empiriquement, il s'est av√©r√© qu'un GPU peut d√©marrer et fonctionner en toute confiance avec 47 contextes - et il n'y a pas de diff√©rence, ce sont les contextes d'un encodeur ou d'un d√©codeur.  On supposait que cela √©tait d√ª √† la quantit√© de m√©moire sur le GPU.  Maintenant, il y a 16 Go, si vous mettez une carte avec 24 Go, il est probable que plus de contextes puissent √™tre cr√©√©s.  Mais ce n'est qu'une th√©orie, il faut v√©rifier, comme mentionn√© pr√©c√©demment.  Les donn√©es obtenues sont valables pour un mod√®le de GPU sp√©cifique, les autres cartes doivent √™tre test√©es s√©par√©ment. <br><br>  C'est la restriction du nombre de contextes qui fait l'obstacle principal lorsque l'on travaille avec des charges importantes. <br><br><h2>  5. Conclusions </h2><br>  Ainsi, le but du test √©tait d'√©tudier l'efficacit√© du GPU pour la gamme de t√¢ches indiqu√©e et de d√©velopper des recettes pour son utilisation appropri√©e.  Quel est le r√©sultat? <br><br><h3>  Effet √©conomique </h3><br>  Ci-dessus, nous avons vu comment le nombre de threads pouvant √™tre trait√©s sur le CPU et sur le tandem CPU + GPU est diff√©rent.  Voyons ce que cela signifie en termes d'argent.  Comme base, nous prenons tous les m√™mes Softlayer et leurs prix de location d'√©quipement. <br><br><ul><li>  La configuration sans GPU co√ªtera <b>819 $ par mois</b> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici, vous pouvez r√©cup√©rer une</a> voiture. </li><li>  La configuration avec le GPU co√ªtera <b>1729 $ par mois</b> pour le centre de donn√©es d'Amsterdam, les prix peuvent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trouv√©s ici</a> .  Lorsque vous utilisez un GPU, le prix de location du serveur augmente l√©g√®rement, car le plus grand facteur de forme de bo√Ætier 2U est utilis√©.  L'effet √©conomique sera probablement plus important lors de l'achat d'√©quipement (mais cela n√©cessite une analyse s√©rieuse du TCO, compte tenu de la mise √† jour constante de la gamme GPU NVidia). </li></ul><br>  Voyons maintenant les r√©sultats du test: <br><br>  Pour FullHD 1080p <br><br><ul><li>  CPU sans GPU: 16 threads par entr√©e + 80 threads par sortie </li><li>  CPU + GPU: 36 threads par entr√©e + 180 par sortie </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avantage GPU: 2,25x. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avantages</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de l'utilisation du GPU: 819 $ * 2,25 - 1729 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = </font><b><font style="vertical-align: inherit;">113 $ par mois</font></b><font style="vertical-align: inherit;"> lors de la location d'un serveur avec un GPU. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour HD 720p</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU sans GPU: 22 threads par entr√©e + 88 threads par sortie </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU + GPU: 70 threads par entr√©e + 280 par sortie </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avantage GPU: 3,18x. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√©n√©ficiez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de l'utilisation du GPU: 819 $ * 3,18 - 1729 $ = </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">875 $ par mois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors de la location de 1 serveur avec un GPU </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autrement dit, avec l'option de location, les √©conomies sont assez importantes. Cela ne tient pas compte des rabais - au bureau russe d'IBM, ils promettent des rabais sur la location de ressources dans le cloud par rapport aux prix pr√©sent√©s ici. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'avons pas abord√© les options avec l'achat, car ici, le TCO d√©pend fortement du choix du fournisseur, du co√ªt du service dans le centre de donn√©es et d'autres facteurs familiers √† ceux qui travaillent avec du m√©tal nu. Cependant, les chiffres pr√©liminaires parlent √©galement en faveur d'une solution bas√©e sur GPU.</font></font><br><br>         ‚Äî         ,         ,    ,     .. <br><br><h3>  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'option avec une carte graphique par serveur nous semble plus rentable que l'option avec deux cartes ou plus. Comme nous pouvons le voir, le d√©codeur GPU a toujours charg√© plus que l'encodeur, mais m√™me il est rest√© sous-charg√© en raison de probl√®mes avec l'utilisation des contextes. Si vous ajoutez une deuxi√®me carte, le d√©codeur sera encore moins utilis√©, les encodeurs que nous ne pourrons pas charger √† pleine capacit√©, et tout le travail sur l'encodage devra encore √™tre d√©plac√© vers le CPU, ce qui ne sera pas justifi√© pour l'argent. Nous avons √©galement test√© l'option avec deux GPU gr√¢ce au support de Softlayer, mais en raison du faible effet √©conomique, nous ne donnons pas de d√©tails dans l'article. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, pour faire √©voluer la charge, il est pr√©f√©rable d'ajouter de nouveaux serveurs avec une carte graphique plut√¥t que d'ajouter des cartes aux machines existantes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le nombre de flux entrants et sortants pour votre projet est relativement faible - disons, une douzaine de flux HD avec un petit nombre d'autorisations de sortie, avec une quantit√© de filtrage relativement faible, il serait plus judicieux d'utiliser un serveur sans GPU. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient √©galement de noter que la quantit√© de RAM pour la t√¢che de conversion des threads n'est pas aussi importante que la puissance de traitement. Ainsi, dans certains cas, vous pouvez √©galement √©conomiser en r√©duisant la quantit√© de m√©moire.</font></font><br><br><h3>  Conclusion </h3><br>    ‚Äî  CPU  GPU Tesla M60 ‚Äî         . GPU       ‚Äî         ,          CPU. <br><br>   -             ,       ‚Äî   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr401539/">https://habr.com/ru/post/fr401539/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr401527/index.html">Comment les lecteurs optiques se d√©gradent</a></li>
<li><a href="../fr401529/index.html">Demandez √† Ethan: l'univers peut-il √™tre consid√©r√© comme vivant?</a></li>
<li><a href="../fr401531/index.html">Dans le cadre du projet ¬´La science n'est pas de la farine¬ª, une discussion aura lieu sur le th√®me: ¬´Sexe, drogue, rock and roll: addiction ou vie?¬ª</a></li>
<li><a href="../fr401533/index.html">Difficult√©s √† choisir une carte vid√©o √©conomique sur l'exemple du RX 460</a></li>
<li><a href="../fr401535/index.html">Colonie. Chapitre 4: l'ancienne base militaire</a></li>
<li><a href="../fr401541/index.html">50 nuances de moignon * R√©ception mat√©rielle des signaux encod√©s PWM par les microcontr√¥leurs Microchip</a></li>
<li><a href="../fr401543/index.html">Utilisation des ensembles de donn√©es du portail russe de donn√©es ouvertes data.gov.ru</a></li>
<li><a href="../fr401545/index.html">Chef, je vous vois. Intel Unite - Outil de communication professionnel</a></li>
<li><a href="../fr401549/index.html">√âtats exotiques de la mati√®re, √©crans LCD et avenir de l'eau</a></li>
<li><a href="../fr401551/index.html">Valve d√©veloppe trois jeux VR en m√™me temps et esp√®re un d√©veloppement technologique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>