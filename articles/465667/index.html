<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèª ü¶ä üò™ Spring Cache: desde el almacenamiento en cach√© de conexi√≥n en 1 minuto hasta la configuraci√≥n flexible del administrador de cach√© ü§∑ üëåüèø üíá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sol√≠a ‚Äã‚Äãtener miedo al almacenamiento en cach√©. Realmente no quer√≠a escalar y descubrir qu√© era, inmediatamente me imagin√© algunas cosas de la empresa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spring Cache: desde el almacenamiento en cach√© de conexi√≥n en 1 minuto hasta la configuraci√≥n flexible del administrador de cach√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465667/"> Sol√≠a ‚Äã‚Äãtener miedo al almacenamiento en cach√©.  Realmente no quer√≠a escalar y descubrir qu√© era, inmediatamente me imagin√© algunas cosas de la empresa luto del compartimento del motor que solo el ganador de la olimpiada matem√°tica podr√≠a resolver.  Result√≥ que esto no es as√≠.  El almacenamiento en cach√© result√≥ ser muy simple, comprensible e incre√≠blemente f√°cil de implementar en cualquier proyecto. <br><br><img src="https://habrastorage.org/webt/1f/my/g2/1fmyg2ofjbgqmyf3lorqqkan85u.jpeg"><br><br>  En esta publicaci√≥n, intentar√© explicar sobre el almacenamiento en cach√© tan simple como ahora entiendo.  Aprender√° c√≥mo implementar el almacenamiento en cach√© en 1 minuto, c√≥mo almacenar en cach√© por clave, establecer la vida √∫til de la memoria cach√© y muchas otras cosas que debe saber si se le indic√≥ que almacenara algo en su proyecto de trabajo y no desea confundirse cara <br><a name="habracut"></a><br>  ¬øPor qu√© digo "encomendado"?  Debido a que el almacenamiento en cach√©, por regla general, tiene sentido aplicar en proyectos grandes y altamente cargados, con decenas de miles de solicitudes por minuto.  En tales proyectos, para no sobrecargar la base de datos, generalmente almacenan en cach√© las llamadas al repositorio.  Especialmente si se sabe que los datos de alg√∫n sistema maestro se actualizan con cierta frecuencia.  Nosotros mismos no escribimos tales proyectos, trabajamos en ellos.  Si el proyecto es peque√±o y no amenaza las sobrecargas, entonces, por supuesto, es mejor no almacenar en cach√© nada; siempre los datos actualizados siempre son mejores que los actualizados peri√≥dicamente. <br><br>  Por lo general, en las publicaciones de capacitaci√≥n, el orador primero se arrastra debajo del cap√≥, comienza a profundizar en las entra√±as de la tecnolog√≠a, lo que molesta mucho al lector, y solo entonces, cuando hoje√≥ una buena mitad del art√≠culo y no entendi√≥ nada, cuenta c√≥mo funciona.  Todo ser√° diferente con nosotros.  Primero, lo hacemos funcionar, y preferiblemente, con el menor esfuerzo, y luego, si est√° interesado, puede mirar debajo del cap√≥ de la cach√©, mirar dentro del contenedor y ajustar el almacenamiento en cach√©.  Pero incluso si no lo hace (y esto comienza con el punto 6), su almacenamiento en cach√© funcionar√° as√≠. <br><br>  Crearemos un proyecto en el que analizaremos todos los aspectos del almacenamiento en cach√© que promet√≠.  Al final, como de costumbre, habr√° un enlace al proyecto en s√≠. <br><br><h2>  0. Crear un proyecto </h2><br>  Crearemos un proyecto muy simple en el que podamos tomar la entidad de la base de datos.  Agregu√© Lombok, Spring Cache, Spring Data JPA y H2 al proyecto.  Aunque, solo se puede prescindir de Spring Cache. <br><br><pre><code class="java hljs">plugins { id <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.1.7.RELEASE'</span></span> id <span class="hljs-string"><span class="hljs-string">'io.spring.dependency-management'</span></span> version <span class="hljs-string"><span class="hljs-string">'1.0.8.RELEASE'</span></span> id <span class="hljs-string"><span class="hljs-string">'java'</span></span> } group = <span class="hljs-string"><span class="hljs-string">'ru.xpendence'</span></span> version = <span class="hljs-string"><span class="hljs-string">'0.0.1-SNAPSHOT'</span></span> sourceCompatibility = <span class="hljs-string"><span class="hljs-string">'1.8'</span></span> configurations { compileOnly { extendsFrom annotationProcessor } } repositories { mavenCentral() } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-cache'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-data-jpa'</span></span> compileOnly <span class="hljs-string"><span class="hljs-string">'org.projectlombok:lombok'</span></span> runtimeOnly <span class="hljs-string"><span class="hljs-string">'com.h2database:h2'</span></span> annotationProcessor <span class="hljs-string"><span class="hljs-string">'org.projectlombok:lombok'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework.boot:spring-boot-starter-test'</span></span> }</code> </pre> <br>  Tendremos solo una entidad, llam√©mosla Usuario. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@ToString</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"name"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"email"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String email; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.email = email; } }</code> </pre> <br>  Agregue el repositorio y el servicio: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserRepository repository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository repository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = repository; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"getting user by id: {}"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.findById(id) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityNotFoundException(<span class="hljs-string"><span class="hljs-string">"User not found by id "</span></span> + id)); } }</code> </pre> <br>  Cuando ingresamos el m√©todo de servicio get (), lo escribimos en el registro. <br><br>  Con√©ctese al proyecto Spring Cache. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableCaching</span></span> <span class="hljs-comment"><span class="hljs-comment">// Spring Cache public class CacheApplication { public static void main(String[] args) { SpringApplication.run(CacheApplication.class, args); } }</span></span></code> </pre> <br>  El proyecto esta listo. <br><br><h2>  1. Almacenamiento en cach√© del resultado devuelto </h2><br>  ¬øQu√© hace Spring Cache?  Spring Cache simplemente almacena en cach√© el resultado de retorno para par√°metros de entrada espec√≠ficos.  Vamos a verlo  Pondremos la anotaci√≥n @Cacheable sobre el m√©todo de servicio get () para almacenar en cach√© los datos devueltos.  Damos a esta anotaci√≥n el nombre de "usuarios" (analizaremos m√°s a fondo por qu√© esto se hace por separado). <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"getting user by id: {}"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.findById(id) .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityNotFoundException(<span class="hljs-string"><span class="hljs-string">"User not found by id "</span></span> + id)); }</code> </pre> <br>  Para comprobar c√≥mo funciona esto, escribiremos una prueba simple. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractTest</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserServiceTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserService service; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); User user2 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Kolya"</span></span>, <span class="hljs-string"><span class="hljs-string">"kolya@mail.ru"</span></span>)); getAndPrint(user1.getId()); getAndPrint(user2.getId()); getAndPrint(user1.getId()); getAndPrint(user2.getId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAndPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"user found: {}"</span></span>, service.get(id)); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Una peque√±a digresi√≥n, por qu√© suelo escribir AbstractTest y heredar todas las pruebas.</b> <div class="spoiler_text">  Si la clase tiene su propia anotaci√≥n @SpringBootTest, el contexto se vuelve a generar para dicha clase cada vez.  Dado que el contexto puede aumentar durante 5 segundos, o tal vez 40 segundos, esto en cualquier caso inhibe en gran medida el proceso de prueba.  Al mismo tiempo, generalmente no hay diferencia en el contexto, y cuando ejecuta cada grupo de pruebas dentro de la misma clase, no es necesario reiniciar el contexto.  Si ponemos solo una anotaci√≥n, por ejemplo, sobre una clase abstracta, como en nuestro caso, esto nos permite plantear el contexto solo una vez. <br><br>  Por lo tanto, prefiero reducir el n√∫mero de contextos planteados durante la prueba / ensamblaje, si es posible. <br></div></div><br>  ¬øQu√© hace nuestra prueba?  Crea dos usuarios y luego los saca de la base de datos 2 veces.  Como recordamos, colocamos la anotaci√≥n @Cacheable, que almacenar√° en cach√© los valores devueltos.  Despu√©s de recibir el objeto del m√©todo get (), enviamos el objeto al registro.  Adem√°s, registramos informaci√≥n sobre cada visita de la aplicaci√≥n al m√©todo get (). <br><br>  Ejecute la prueba  Esto es lo que tenemos en la consola. <br><br><pre> <code class="java hljs">getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> user found: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> user found: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Kolya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) user found: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) user found: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Kolya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br>  Como vemos, las dos primeras veces fuimos al m√©todo get () y obtuvimos al usuario de la base de datos.  En todos los dem√°s casos, no hubo una llamada real al m√©todo, la aplicaci√≥n tom√≥ datos en cach√© por clave (en este caso, esto es id). <br><br><h2>  2. Declaraci√≥n de clave de almacenamiento en cach√© </h2><br>  Hay situaciones en las que varios par√°metros llegan al m√©todo en cach√©.  En este caso, puede ser necesario determinar el par√°metro por el cual ocurrir√° el almacenamiento en cach√©.  Agregamos un ejemplo a un m√©todo que guardar√° una entidad ensamblada por par√°metros en la base de datos, pero si ya existe una entidad con el mismo nombre, no la guardaremos.  Para hacer esto, definiremos el par√°metro de nombre como la clave para el almacenamiento en cach√©.  Se ver√° as√≠: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user with parameters: {}, {}"</span></span>, name, email); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(name, email)); }</code> </pre> <br>  Escribamos la prueba correspondiente: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan1122@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Sergey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); log.info(<span class="hljs-string"><span class="hljs-string">"all entries are below:"</span></span>); service.getAll().forEach(u -&gt; log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, u.toString())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, String email)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"created user: {}"</span></span>, service.create(name, email)); }</code> </pre> <br>  Intentaremos crear tres usuarios, para dos de los cuales el nombre ser√° el mismo. <br><br><pre> <code class="java hljs"> createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan1122@mail.ru"</span></span>);</code> </pre> <br>  y para dos de los cuales el correo electr√≥nico coincidir√° <br><br><pre> <code class="java hljs"> createAndPrint(<span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>); createAndPrint(<span class="hljs-string"><span class="hljs-string">"Sergey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ivan@mail.ru"</span></span>);</code> </pre> <br>  En el m√©todo de creaci√≥n, registramos cada hecho que se llama al m√©todo, y tambi√©n registramos todas las entidades que este m√©todo nos devolvi√≥.  El resultado ser√° as√≠: <br><br><pre> <code class="java hljs">creating user with parameters: Ivan, ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru created user: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user with parameters: Sergey, ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru created user: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Sergey, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) all entries are below: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Ivan, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Sergey, email=ivan<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br>  Vemos que, de hecho, la aplicaci√≥n llam√≥ al m√©todo 3 veces, y entr√≥ en √©l solo dos veces.  Una vez que una clave coincide con un m√©todo, y simplemente devuelve un valor en cach√©. <br><br><h2>  3. Almacenamiento en cach√© forzado.  @CachePut </h2><br>  Hay situaciones en las que queremos almacenar en cach√© el valor de retorno para alguna entidad, pero al mismo tiempo, necesitamos actualizar la memoria cach√©.  Para tales necesidades, existe la anotaci√≥n @CachePut.  Pasa la aplicaci√≥n al m√©todo, mientras actualiza la memoria cach√© para el valor de retorno, incluso si ya est√° en cach√©. <br><br>  Agregue un par de m√©todos en los que salvaremos al usuario.  Marcamos uno de ellos con la habitual anotaci√≥n @Cacheable, el segundo con @CachePut. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrReturnCached</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user: {}"</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(value = <span class="hljs-string"><span class="hljs-string">"users"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> User </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndRefreshCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"creating user: {}"</span></span>, user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repository.save(user); }</code> </pre> <br>  El primer m√©todo simplemente devolver√° los valores almacenados en cach√©, el segundo forzar√° la actualizaci√≥n de la memoria cach√©.  El almacenamiento en cach√© se realizar√° con la clave # user.name.  Escribiremos la prueba correspondiente. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAndRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user1: {}"</span></span>, user1); User user2 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"misha@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user2: {}"</span></span>, user2); User user3 = service.createAndRefreshCache(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"kolya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user3: {}"</span></span>, user3); User user4 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"petya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"created user4: {}"</span></span>, user4); }</code> </pre> <br>  De acuerdo con la l√≥gica que ya se ha descrito, la primera vez que un usuario con el nombre "Vasya" se guarda a trav√©s del m√©todo createOrReturnCached (), recibiremos una entidad en cach√© y la aplicaci√≥n no entrar√° en el m√©todo en s√≠.  Si llamamos al m√©todo createAndRefreshCache (), la entidad en cach√© para la clave llamada "Vasya" se sobrescribir√° en la memoria cach√©.  Ejecutemos la prueba y veamos qu√© se mostrar√° en la consola. <br><br><pre> <code class="java hljs">creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user1: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user2: User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user3: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) created user4: User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=kolya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br>  Vemos que user1 ha escrito con √©xito en la base de datos y en la memoria cach√©.  Cuando intentamos grabar al usuario con el mismo nombre nuevamente, obtenemos el resultado en cach√© de la primera llamada (usuario2, para el cual la identificaci√≥n es la misma que usuario1, lo que nos dice que el usuario no fue escrito, y esto es solo un cach√©).  A continuaci√≥n, escribimos al tercer usuario a trav√©s del segundo m√©todo, que, incluso con el resultado en cach√©, todav√≠a llam√≥ al m√©todo y escribi√≥ un nuevo resultado en el cach√©.  Este es el usuario3.  Como podemos ver, √©l ya tiene una nueva identificaci√≥n.  Despu√©s de lo cual, llamamos al primer m√©todo, que toma la nueva cach√© agregada por el usuario3. <br><br><h2>  4. Eliminaci√≥n del cach√©.  @CacheEvict </h2><br>  A veces se hace necesario actualizar algunos datos en la memoria cach√©.  Por ejemplo, una entidad ya se ha eliminado de la base de datos, pero a√∫n se puede acceder desde la memoria cach√©.  Para mantener la consistencia de los datos, necesitamos al menos no almacenar los datos eliminados en la memoria cach√©. <br><br>  Agregue un par de m√©todos m√°s al servicio. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"deleting user by id: {}"</span></span>, id); repository.deleteById(id); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAndEvict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"deleting user by id: {}"</span></span>, id); repository.deleteById(id); }</code> </pre> <br>  El primero simplemente eliminar√° al usuario, el segundo tambi√©n lo eliminar√°, pero lo marcaremos con la anotaci√≥n @CacheEvict.  Agregue una prueba que crear√° dos usuarios, despu√©s de lo cual se eliminar√° uno mediante un m√©todo simple y el segundo mediante un m√©todo anotado.  Despu√©s de eso, conseguiremos estos usuarios a trav√©s del m√©todo get (). <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User user1 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); User user2 = service.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); service.delete(user1.getId()); service.deleteAndEvict(user2.getId()); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); }</code> </pre> <br>  Es l√≥gico que dado que nuestro usuario ya est√° en cach√©, la eliminaci√≥n no nos impedir√° obtenerlo, ya que est√° en cach√©.  Veamos los registros. <br><br><pre> <code class="java hljs">getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) deleting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> deleting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> javax.persistence.EntityNotFoundException: User not found by id <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Vemos que la aplicaci√≥n fue segura en ambas ocasiones al m√©todo get () y Spring almacen√≥ en cach√© estas entidades.  A continuaci√≥n, los eliminamos a trav√©s de diferentes m√©todos.  Eliminamos el primero de la forma habitual, y el valor almacenado en cach√© se mantuvo, por lo que cuando intentamos obtener el usuario con la ID 1, lo logramos.  Cuando intentamos obtener el usuario 2, el m√©todo devolvi√≥ una EntityNotFoundException; no hab√≠a dicho usuario en la memoria cach√©. <br><br><h2>  5. Configuraci√≥n de agrupamiento.  @Caching </h2><br>  A veces, un solo m√©todo requiere varias configuraciones de almacenamiento en cach√©.  La anotaci√≥n @Caching se utiliza para estos fines.  Puede verse m√°s o menos as√≠: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Caching</span></span>( cacheable = { <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@Cacheable</span></span>(<span class="hljs-string"><span class="hljs-string">"contacts"</span></span>) }, put = { <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(<span class="hljs-string"><span class="hljs-string">"tables"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(<span class="hljs-string"><span class="hljs-string">"chairs"</span></span>), <span class="hljs-meta"><span class="hljs-meta">@CachePut</span></span>(value = <span class="hljs-string"><span class="hljs-string">"meals"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.email"</span></span>) }, evict = { <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(value = <span class="hljs-string"><span class="hljs-string">"services"</span></span>, key = <span class="hljs-string"><span class="hljs-string">"#user.name"</span></span>) } ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br>  Esta es la √∫nica forma de agrupar anotaciones.  Si intentas apilar algo como <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"meals"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"contacts"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@CacheEvict</span></span>(<span class="hljs-string"><span class="hljs-string">"tables"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br>  entonces IDEA le dir√° que este no es el caso. <br><br><h2>  6. Configuraci√≥n flexible.  Cachemanager </h2><br>  Finalmente, descubrimos el cach√©, y dej√≥ de ser algo incomprensible y aterrador para nosotros.  Ahora veamos debajo del cap√≥ y veamos c√≥mo podemos configurar el almacenamiento en cach√© en general. <br><br>  Para tales tareas, hay un CacheManager.  Existe donde sea que est√© Spring Cache.  Cuando agregamos la anotaci√≥n @EnableCache, Spring crear√° autom√°ticamente dicho administrador de cach√©.  Podemos verificar esto si ajustamos autom√°ticamente el ApplicationContext y lo abrimos en el punto de interrupci√≥n.  Entre otros contenedores, habr√° un bean cacheManager. <br><br><img src="https://habrastorage.org/webt/nc/bn/vp/ncbnvpwm57vw-2i9t7xpaiwr29s.png"><br><br>  Detuve la aplicaci√≥n en el momento en que dos usuarios ya hab√≠an sido creados y puestos en el cach√©.  Si llamamos al bean que necesitamos a trav√©s de Evaluate Expression, veremos que realmente existe dicho bean, que tiene un ConcurentMapCache con la clave "users" y el valor ConcurrentHashMap, que ya contiene usuarios en cach√©. <br><br><img src="https://habrastorage.org/webt/7-/xt/s9/7-xts9jrjipidhtsls1nv4gr2o0.png"><br><br>  Nosotros, a su vez, podemos crear nuestro administrador de cach√©, con Habr y programadores, y luego ajustarlo a nuestro gusto. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  Solo queda elegir qu√© administrador de cach√© usaremos, porque hay muchos de ellos.  No enumerar√© todos los administradores de cach√©, ser√° suficiente saber que existen: <br><br><ul><li>  <i><b>SimpleCacheManager</b></i> es el administrador de cach√© m√°s simple, conveniente para aprender y probar. </li><li>  <i><b>ConcurrentMapCacheManager</b></i> - Inicializa perezosamente las instancias devueltas para cada solicitud.  Tambi√©n se recomienda para probar y aprender a trabajar con el cach√©, as√≠ como para algunas acciones simples como la nuestra.  Para un trabajo serio con el cach√©, se recomienda la implementaci√≥n a continuaci√≥n. </li><li>  <i><b>JCacheCacheManager</b></i> , <i><b>EhCacheCacheManager</b></i> , <i><b>CaffeineCacheManager</b></i> son administradores de cach√© serios "socios socios" que son personalizables de manera flexible y realizan tareas de una amplia gama de acciones. </li></ul><br>  Como parte de mi humilde publicaci√≥n, no describir√© los administradores de cach√© de los √∫ltimos tres.  En su lugar, veremos varios aspectos de la configuraci√≥n de un administrador de cach√© utilizando el ConcurrentMapCacheManager como ejemplo. <br><br>  Entonces, recrearemos nuestro administrador de cach√©. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCacheManager(); }</code> </pre> <br>  Nuestro administrador de cach√© est√° listo. <br><br><h2>  7. Configuraci√≥n de cach√©.  Tiempo de vida, tama√±o m√°ximo, etc. </h2><br>  Para hacer esto, necesitamos una biblioteca Google Guava bastante popular.  Tom√© el √∫ltimo. <br><br><pre> <code class="java hljs">compile group: <span class="hljs-string"><span class="hljs-string">'com.google.guava'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'guava'</span></span>, version: <span class="hljs-string"><span class="hljs-string">'28.1-jre'</span></span></code> </pre> <br>  Al crear el administrador de cach√©, redefinimos el m√©todo createConcurrentMapCache, en el que llamaremos a CacheBuilder desde Guava.  En el proceso, se nos pedir√° que configuremos el administrador de cach√© inicializando los siguientes m√©todos: <br><br><ul><li>  maximumSize: el tama√±o m√°ximo de los valores que puede contener el cach√©.  Con este par√°metro, puede encontrar un intento de encontrar un compromiso entre la carga en la base de datos y la RAM JVM. </li><li>  refreshAfterWrite: tiempo despu√©s de escribir el valor en el cach√©, despu√©s del cual se actualizar√° autom√°ticamente. </li><li>  expireAfterAccess: la duraci√≥n del valor despu√©s de la √∫ltima llamada. </li><li>  expireAfterWrite: duraci√≥n del valor despu√©s de escribir en la memoria cach√©.  Este es el par√°metro que definiremos. </li></ul><br>  y otros <br><br>  Definimos en el administrador la vida √∫til del registro.  Para no esperar mucho, configure 1 segundo. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"habrCacheManager"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCacheManager() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Cache </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConcurrentMapCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentMapCache( name, CacheBuilder.newBuilder() .expireAfterWrite(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeUnit.SECONDS) .build().asMap(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } }; }</code> </pre> <br>  Escribimos una prueba correspondiente a este caso. <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ User user1 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user1.getId())); User user2 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user2.getId())); Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000L</span></span>); User user3 = service.createOrReturnCached(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-string"><span class="hljs-string">"Vasya"</span></span>, <span class="hljs-string"><span class="hljs-string">"vasya@mail.ru"</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, service.get(user3.getId())); }</code> </pre> <br>  Guardamos varios valores en la base de datos, y si los datos se almacenan en cach√©, no guardamos nada.  Primero, guardamos dos valores, luego esperamos 1 segundo hasta que el cach√© se agote, despu√©s de lo cual guardamos otro valor. <br><br><pre> <code class="java hljs">creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">1</span></span> User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) User(id=<span class="hljs-number"><span class="hljs-number">1</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) creating user: User(id=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru) getting user by id: <span class="hljs-number"><span class="hljs-number">2</span></span> User(id=<span class="hljs-number"><span class="hljs-number">2</span></span>, name=Vasya, email=vasya<span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru)</code> </pre> <br>  Los registros muestran que primero creamos un usuario, luego probamos otro, pero como los datos se almacenaron en cach√©, los obtuvimos del cach√© (en ambos casos, al guardar y al obtener de la base de datos).  Luego, el cach√© se estrope√≥, ya que un registro nos informa sobre el ahorro real y la recepci√≥n real del usuario. <br><br><h2>  8. Para resumir </h2><br>  Tarde o temprano, el desarrollador se enfrenta a la necesidad de implementar el almacenamiento en cach√© en el proyecto.  Espero que este art√≠culo te ayude a entender el tema y a mirar los problemas de almacenamiento en cach√© con mayor audacia. <br><br>  Github del proyecto aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/promoscow/cache</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465667/">https://habr.com/ru/post/465667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465655/index.html">Noticias del mundo de OpenStreetMap No. 474 (13/08/2019 - 08/08/2019)</a></li>
<li><a href="../465657/index.html">Ley de Parkinson: puedes vencerla</a></li>
<li><a href="../465659/index.html">Respuesta al art√≠culo "La conquista de Siberia por el moscovita", o veinte a√±os despu√©s</a></li>
<li><a href="../465661/index.html">¬øTambi√©n tienes un amigo as√≠? O tal vez eres t√∫?</a></li>
<li><a href="../465663/index.html">Preguntas frecuentes de Superjob API (Publicaci√≥n de trabajos)</a></li>
<li><a href="../465669/index.html">Contando la velocidad de descarga en su aplicaci√≥n</a></li>
<li><a href="../465673/index.html">Hedi Lamarr: inventor de Hollywood</a></li>
<li><a href="../465675/index.html">C√≥mo se preocupa la NASA por la seguridad e inteligencia de sus astronautas</a></li>
<li><a href="../465677/index.html">Olv√≠date del Walkman: se trata de los auriculares</a></li>
<li><a href="../465679/index.html">¬øQu√© puede hacer un reloj adem√°s de mostrar la hora y c√≥mo elegir su primer reloj?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>