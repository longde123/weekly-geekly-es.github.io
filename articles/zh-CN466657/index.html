<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™ŒğŸ¼ â™ï¸ ğŸ’¨ åŠ¨æ€ç»†èŠ‚ï¼šç¼–è¯‘å™¨ç§˜å¯†æ¸¸æˆï¼Œå†…å­˜æ³„æ¼ï¼Œæ€§èƒ½å·®å¼‚ ğŸš¤ ğŸ¯ ğŸ¤½ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰æˆ 

 è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š 



//Any native COM object var comType = Type.GetTypeFromCLSID(new Guid("E13B6688-3F39-11D0-96F6-00A0C9191601")); while (true) { dynami...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åŠ¨æ€ç»†èŠ‚ï¼šç¼–è¯‘å™¨ç§˜å¯†æ¸¸æˆï¼Œå†…å­˜æ³„æ¼ï¼Œæ€§èƒ½å·®å¼‚</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466657/"><h2> å‰æˆ </h2><br><br> è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Any native COM object var comType = Type.GetTypeFromCLSID(new Guid("E13B6688-3F39-11D0-96F6-00A0C9191601")); while (true) { dynamic com = Activator.CreateInstance(comType); //do some work Marshal.FinalReleaseComObject(com); }</span></span></code> </pre> <br><br>  <i>Marshal.FinalReleaseComObject</i>æ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinalReleaseComObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Object o</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><br> æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„COMå¯¹è±¡ï¼Œåšä¸€äº›å·¥ä½œï¼Œç„¶åç«‹å³é‡Šæ”¾å®ƒã€‚ çœ‹æ¥å¯èƒ½å‡ºä»€ä¹ˆé—®é¢˜äº†ï¼Ÿ æ˜¯çš„ï¼Œåœ¨æ— é™å¾ªç¯å†…åˆ›å»ºå¯¹è±¡ä¸æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œä½†æ˜¯<i>GC</i>å°†æ‰¿æ‹…æ‰€æœ‰è‚®è„çš„å·¥ä½œã€‚ å®é™…æƒ…å†µç•¥æœ‰ä¸åŒï¼š <br><br><img src="https://habrastorage.org/webt/mt/xo/rx/mtxorxomorvksyskqgtn3b3z7_g.png"><br><br> è¦äº†è§£å†…å­˜æ³„æ¼çš„åŸå› ï¼Œæ‚¨éœ€è¦äº†è§£<i>åŠ¨æ€çš„</i>å·¥ä½œåŸç†ã€‚ åœ¨HabrÃ©ä¸Šå·²ç»æœ‰å…³äºæ­¤ä¸»é¢˜çš„å‡ ç¯‡æ–‡ç« ï¼Œä¾‹å¦‚ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™ç¯‡æ–‡ç« </a> ï¼Œä½†æ˜¯å®ƒä»¬æ²¡æœ‰è¯¦ç»†ä»‹ç»å®ç°çš„ç»†èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿›è¡Œè‡ªå·±çš„ç ”ç©¶ã€‚ <br><br><a name="habracut"></a><br><br> é¦–å…ˆï¼Œæˆ‘ä»¬å°†è¯¦ç»†ç ”ç©¶<i>åŠ¨æ€</i>å·¥ä½œæœºåˆ¶ï¼Œç„¶åå°†è·å¾—çš„çŸ¥è¯†ç®€åŒ–ä¸ºä¸€å¼ å›¾ç‰‡ï¼Œæœ€åï¼Œæˆ‘ä»¬å°†è®¨è®ºé€ æˆè¿™ç§æ³„æ¼çš„åŸå› ä»¥åŠå¦‚ä½•é¿å…è¿™ç§æ³„æ¼ã€‚ åœ¨æ·±å…¥ç ”ç©¶ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¾„æ¸…ä¸€ä¸‹æºæ•°æ®ï¼šå“ªäº›å› ç´ å¯¼è‡´æ³„æ¼ï¼Ÿ <br><br><h2> å®éªŒ </h2><br><br> ä¹Ÿè®¸åˆ›å»ºè®¸å¤š<i>æœ¬æœºCOM</i>å¯¹è±¡æœ¬èº«<i>å¹¶ä¸æ˜¯</i>ä¸€ä¸ªå¥½ä¸»æ„ï¼Ÿ è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Any native COM object var comType = Type.GetTypeFromCLSID(new Guid("E13B6688-3F39-11D0-96F6-00A0C9191601")); while (true) { dynamic com = Activator.CreateInstance(comType); }</span></span></code> </pre> <br><br> è¿™æ¬¡ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼š <br><br><img src="https://habrastorage.org/webt/l2/x4/01/l2x401f_4vsbrysnx1zctwoyfjk.png"><br><br> è®©æˆ‘ä»¬å›åˆ°ä»£ç çš„åŸå§‹ç‰ˆæœ¬ï¼Œä½†æ˜¯æ›´æ”¹å¯¹è±¡çš„ç±»å‹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Any managed type include managed COM var type = typeof(int); while (true) { dynamic com = Activator.CreateInstance(type); //do some work Marshal.FinalReleaseComObject(com); }</span></span></code> </pre> <br><br> å†ä¸€æ¬¡ï¼Œä¸å‡ºæ„å¤–ï¼š <br><br><img src="https://habrastorage.org/webt/09/lm/bv/09lmbvpiklt9lo43b1fv9wzhdhu.png"><br><br> è®©æˆ‘ä»¬å°è¯•ç¬¬ä¸‰ä¸ªé€‰é¡¹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Simple COM object var comType = Type.GetTypeFromCLSID(new Guid("435356F9-F33F-403D-B475-1E4AB512FF95")); while (true) { dynamic com = Activator.CreateInstance(comType); //do some work Marshal.FinalReleaseComObject((object) com); }</span></span></code> </pre> <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬ç»å¯¹åº”è¯¥å¾—åˆ°ç›¸åŒçš„è¡Œä¸ºï¼  ?ï¼Ÿ å¦:( <br><br><img src="https://habrastorage.org/webt/uu/2p/l1/uu2pl1_xtrmpc4kuuy3mwdh_7la.png"><br><br> å¦‚æœæ‚¨å°†comå£°æ˜ä¸º<i>å¯¹è±¡</i>æˆ–ä½¿ç”¨<i>Managed COMï¼Œ</i>åˆ™æƒ…å†µç±»ä¼¼ã€‚ æ€»ç»“å®éªŒç»“æœï¼š <br><br><ol><li> æœ¬èº«å®ä¾‹åŒ–<i>æœ¬æœºCOM</i>å¯¹è±¡ä¸ä¼šå¯¼è‡´æ³„æ¼<i>-GC</i>æˆåŠŸå¤„ç†äº†æ¸…é™¤å†…å­˜çš„é—®é¢˜ </li><li> ä½¿ç”¨ä»»ä½•<i>æ‰˜ç®¡</i>ç±»æ—¶ï¼Œéƒ½ä¸ä¼šå‘ç”Ÿæ³„æ¼ </li><li> å½“å°†å¯¹è±¡æ˜¾å¼è½¬æ¢ä¸º<i>å¯¹è±¡æ—¶</i> ï¼Œä¸€åˆ‡éƒ½å¾ˆå¥½ </li></ol><br><br> å±•æœ›æœªæ¥ï¼Œç¬¬ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªäº‹å®ï¼Œå³å•ç‹¬ä½¿ç”¨<i>åŠ¨æ€</i>å¯¹è±¡ï¼ˆè°ƒç”¨æ–¹æ³•æˆ–ä½¿ç”¨å±æ€§ï¼‰ä¹Ÿä¸ä¼šå¯¼è‡´æ³„æ¼ã€‚ ç»“è®ºæœ¬èº«è¡¨æ˜ï¼šå½“æˆ‘ä»¬ä¼ é€’åŒ…å«<i>æœ¬æœºCOM</i>ä½œä¸ºæ–¹æ³•å‚æ•°çš„<i>åŠ¨æ€</i>å¯¹è±¡ï¼ˆä¸è¿›è¡Œâ€œæ‰‹åŠ¨â€ç±»å‹è½¬æ¢ï¼‰æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ <br><br><h2> æˆ‘ä»¬éœ€è¦æ›´æ·±å…¥ </h2><br><br> ç°åœ¨è¯¥è®°ä½è¿™ç§<i>åŠ¨æ€</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„æ„ä¹‰äº†</a> ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">å¿«é€Ÿå‚è€ƒ</b> <div class="spoiler_text"><blockquote>  Cï¼ƒ4.0æä¾›äº†ä¸€ç§æ–°å‹çš„<b>dynamic</b> ã€‚ æ­¤ç±»å‹é¿å…äº†ç¼–è¯‘å™¨è¿›è¡Œçš„é™æ€ç±»å‹æ£€æŸ¥ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒç”¨ä½œ<b>å¯¹è±¡</b>ç±»å‹ã€‚ åœ¨ç¼–è¯‘æ—¶ï¼Œå‡å®šå£°æ˜ä¸º<b>åŠ¨æ€</b>çš„å…ƒç´ æ”¯æŒä»»ä½•æ“ä½œã€‚ è¿™æ„å‘³ç€æ‚¨ä¸å¿…è€ƒè™‘å¯¹è±¡çš„æ¥æº-COM APIï¼ŒIronPythonä¹‹ç±»çš„åŠ¨æ€è¯­è¨€ï¼Œä½¿ç”¨åå°„æˆ–å…¶ä»–åœ°æ–¹ã€‚ è€Œä¸”ï¼Œå¦‚æœä»£ç æ— æ•ˆï¼Œåˆ™ä¼šåœ¨è¿è¡Œæ—¶å¼•å‘é”™è¯¯ã€‚ <br><br> ä¾‹å¦‚ï¼Œå¦‚æœä»¥ä¸‹ä»£ç ä¸­çš„<b>exampleMethod1</b>æ–¹æ³•ä»…å…·æœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šè¯†åˆ«åˆ°å¯¹<b>ec.exampleMethod1ï¼ˆ10ï¼Œ4ï¼‰</b>æ–¹æ³•çš„ç¬¬ä¸€æ¬¡è°ƒç”¨æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºå®ƒåŒ…å«ä¸¤ä¸ªå‚æ•°ã€‚ è¿™å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚ ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥ç¬¬äºŒä¸ªæ–¹æ³•è°ƒç”¨<b>dynamic_ec.exampleMethod1ï¼ˆ10ï¼Œ4ï¼‰</b> ï¼Œå› ä¸º<b>dynamic_ecè¢«</b>å£°æ˜ä¸º<b>dynamic</b> ã€‚ ä¸ä¼šæœ‰ç¼–è¯‘é”™è¯¯ã€‚ ä½†æ˜¯ï¼Œè¯¥é”™è¯¯ä¸ä¼šæ°¸è¿œä¸ä¼šè¢«å¿½ç•¥-å°†åœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { ExampleClass ec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExampleClass(); <span class="hljs-comment"><span class="hljs-comment">//      ,  exampleMethod1    . //ec.exampleMethod1(10, 4); dynamic dynamic_ec = new ExampleClass(); //      ,  //      dynamic_ec.exampleMethod1(10, 4); //        ,  //  ,      dynamic_ec.someMethod("some argument", 7, null); dynamic_ec.nonexistentMethod(); }</span></span></code> </pre> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExampleClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExampleClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exampleMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exampleMethod2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> str</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre> <br></blockquote><br></div></div><br><br> ä½¿ç”¨<i>åŠ¨æ€</i>å˜é‡çš„ä»£ç åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé‡å¤§å˜åŒ–ã€‚ è¿™æ®µä»£ç ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> com = Activator.CreateInstance(comType); Marshal.FinalReleaseComObject(com);</code> </pre> <br><br> å˜æˆä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> instance = Activator.CreateInstance(typeFromClsid); <span class="hljs-comment"><span class="hljs-comment">// ISSUE: reference to a compiler-generated field if (Foo.o__0.p__0 == null) { // ISSUE: reference to a compiler-generated field Foo.o__0.p__0 = CallSite&lt;Action&lt;CallSite, Type, object&gt;&gt;.Create(Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, "FinalReleaseComObject", (IEnumerable&lt;Type&gt;) null, typeof (Foo), (IEnumerable&lt;CSharpArgumentInfo&gt;) new CSharpArgumentInfo[2] { CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType | CSharpArgumentInfoFlags.IsStaticType, (string) null), CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, (string) null) })); } // ISSUE: reference to a compiler-generated field // ISSUE: reference to a compiler-generated field Foo.o__0.p__0.Target((CallSite) Foo.o__0.p__0, typeof (Marshal), instance);</span></span></code> </pre> <br><br> å…¶ä¸­<b>o__0</b>æ˜¯ç”Ÿæˆçš„é™æ€ç±»ï¼Œè€Œ<b>p__0</b>æ˜¯å…¶ä¸­çš„é™æ€å­—æ®µï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">o__0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> CallSite&lt;Action&lt;CallSite, Type, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt; p__0; }</code> </pre> <br><br>  <i>æ³¨æ„ï¼šå¯¹äºæ¯æ¬¡ä¸<i>dynamicçš„</i>äº¤äº’ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªCallSiteå­—æ®µã€‚</i>  <i>ç¨åå°†çœ‹åˆ°ï¼Œè¿™å¯¹äºä¼˜åŒ–æ€§èƒ½æ˜¯å¿…éœ€çš„ã€‚</i> <br><br> è¯·æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰æåˆ°<i>åŠ¨æ€</i> -æˆ‘ä»¬çš„å¯¹è±¡ç°åœ¨å­˜å‚¨åœ¨ç±»å‹ä¸º<i>object</i>çš„å˜é‡ä¸­ã€‚ è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„ä»£ç ã€‚ é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç»‘å®šï¼Œè¯¥ç»‘å®šæè¿°äº†æˆ‘ä»¬æ­£åœ¨åšä»€ä¹ˆä»¥åŠæ­£åœ¨åšä»€ä¹ˆï¼š <br><br><pre> <code class="cs hljs">Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, <span class="hljs-string"><span class="hljs-string">"FinalReleaseComObject"</span></span>, (IEnumerable&lt;Type&gt;) <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (Foo), (IEnumerable&lt;CSharpArgumentInfo&gt;) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CSharpArgumentInfo[<span class="hljs-number"><span class="hljs-number">2</span></span>] { CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType | CSharpArgumentInfoFlags.IsStaticType, (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-literal"><span class="hljs-literal">null</span></span>), CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-literal"><span class="hljs-literal">null</span></span>) })</code> </pre> <br><br> è¿™æ˜¯å¯¹æˆ‘ä»¬åŠ¨æ€æ“ä½œçš„æè¿°ã€‚ è®©æˆ‘æé†’æ‚¨ï¼Œæˆ‘ä»¬å°†<i>åŠ¨æ€</i>å˜é‡ä¼ é€’ç»™<i>FinalReleaseComObject</i>æ–¹æ³•ã€‚ <br><br><ul><li>  CSharpBinderFlags.ResultDiscarded-å°†æ¥ä¸å†ä½¿ç”¨æ–¹æ³•æ‰§è¡Œçš„ç»“æœ </li><li>  â€œ FinalReleaseComObjectâ€-è°ƒç”¨æ–¹æ³•çš„åç§° </li><li>  typeofï¼ˆFooï¼‰-æ“ä½œä¸Šä¸‹æ–‡ï¼› é€šè¯ç±»å‹ </li></ul><br><br>  <b>CSharpArgumentInfo-</b>ç»‘å®šå‚æ•°çš„æè¿°ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼š <br><br><ul><li>  CSharpArgumentInfo.Createï¼ˆCSharpArgumentInfoFlags.UseCompileTimeType | CSharpArgumentInfoFlags.IsStaticTypeï¼Œï¼ˆå­—ç¬¦ä¸²ï¼‰nullï¼‰-ç¬¬ä¸€ä¸ªå‚æ•°çš„è¯´æ˜-å…ƒå¸…ç±»ï¼šå®ƒæ˜¯é™æ€çš„ï¼Œç»‘å®šæ—¶åº”è€ƒè™‘å…¶ç±»å‹ </li><li>  CSharpArgumentInfo.Createï¼ˆCSharpArgumentInfoFlags.Noneï¼Œï¼ˆstringï¼‰nullï¼‰-æ–¹æ³•å‚æ•°çš„æè¿°ï¼Œé€šå¸¸æ²¡æœ‰é™„åŠ ä¿¡æ¯ã€‚ </li></ul><br><br> å¦‚æœä¸æ˜¯è°ƒç”¨æ–¹æ³•çš„é—®é¢˜ï¼Œè€Œæ˜¯ä¾‹å¦‚ä»<i>åŠ¨æ€</i>å¯¹è±¡è°ƒç”¨å±æ€§çš„é—®é¢˜ï¼Œé‚£ä¹ˆå°†åªæœ‰ä¸€ä¸ª<b>CSharpArgumentInfo</b>æè¿°<i>åŠ¨æ€</i>å¯¹è±¡æœ¬èº«ã€‚ <br><br>  <b>CallSite</b>æ˜¯åŠ¨æ€è¡¨è¾¾å¼çš„åŒ…è£…ã€‚ å®ƒå¯¹æˆ‘ä»¬åŒ…å«ä¸¤ä¸ªé‡è¦é¢†åŸŸï¼š <br><br><ul><li> å…¬å¼€Tæ›´æ–° </li><li> å…¬ä¼—ç›®æ ‡ </li></ul><br><br> ä»ç”Ÿæˆçš„ä»£ç ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œå½“æ‰§è¡Œä»»ä½•æ“ä½œæ—¶ï¼Œéƒ½ä¼šä½¿ç”¨æè¿°å®ƒçš„å‚æ•°è°ƒç”¨<b>Target</b> ï¼š <br><br><pre> <code class="cs hljs">Foo.o__0.p__0.Target((CallSite) Foo.o__0.p__0, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (Marshal), instance);</code> </pre> <br><br> ä¸ä¸Šè¿°<b>CSharpArgumentInfo</b>ç»“åˆä½¿ç”¨<b>ï¼Œ</b>æ­¤ä»£ç æ„å‘³ç€ä»¥ä¸‹å«ä¹‰ï¼šæ‚¨éœ€è¦ä½¿ç”¨å®ä¾‹å‚æ•°åœ¨é™æ€Marshalç±»ä¸Šè°ƒç”¨FinalReleaseComObjectæ–¹æ³•ã€‚ åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œä¸<b>Updateä¸­</b>ç›¸åŒçš„å§”æ‰˜å­˜å‚¨åœ¨<b>Target</b>ä¸­ã€‚  <b>æ›´æ–°</b>å§”æ‰˜è´Ÿè´£ä¸¤é¡¹é‡è¦ä»»åŠ¡ï¼š <br><br><ol><li> å°†åŠ¨æ€æ“ä½œç»‘å®šåˆ°é™æ€æ“ä½œï¼ˆå‡ºä»·æœºåˆ¶æœ¬èº«ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ï¼‰ </li><li> ç¼“å­˜å½¢æˆ </li></ol><br><br> æˆ‘ä»¬å¯¹ç¬¬äºŒç‚¹æ„Ÿå…´è¶£ã€‚ è¿™é‡Œåº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œå½“ä½¿ç”¨åŠ¨æ€å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ¯æ¬¡æ£€æŸ¥æ“ä½œçš„æœ‰æ•ˆæ€§ã€‚ è¿™æ˜¯ä¸€é¡¹ç›¸å½“è€—è´¹èµ„æºçš„ä»»åŠ¡ï¼Œå› æ­¤æˆ‘æƒ³ç¼“å­˜æ­¤ç±»æ£€æŸ¥çš„ç»“æœã€‚ å…³äºè°ƒç”¨å¸¦æœ‰å‚æ•°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š <br><br><ol><li> è°ƒç”¨æ–¹æ³•çš„ç±»å‹ </li><li> å‚æ•°ä¼ é€’çš„å¯¹è±¡çš„ç±»å‹ï¼ˆç¡®ä¿å¯ä»¥å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸ºå‚æ•°çš„ç±»å‹ï¼‰ </li><li> æ“ä½œæœ‰æ•ˆå— </li></ol><br><br> ç„¶åï¼Œå½“å†æ¬¡è°ƒç”¨<b>Target</b>æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰§è¡Œç›¸å¯¹æ˜‚è´µçš„ç»‘å®šï¼šåªéœ€æ¯”è¾ƒç±»å‹ï¼Œå¦‚æœåŒ¹é…ï¼Œå°±è°ƒç”¨ç›®æ ‡å‡½æ•°ã€‚ ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œä¸ºæ¯ä¸ªåŠ¨æ€æ“ä½œåˆ›å»ºä¸€ä¸ª<i>ExpressionTree</i> ï¼Œè¯¥æ ‘å­˜å‚¨åŠ¨æ€è¡¨è¾¾å¼ç»‘å®šåˆ°çš„<i>çº¦æŸ</i>å’Œ<i>ç›®æ ‡å‡½æ•°</i> ã€‚ <br><br> æ­¤å‡½æ•°å¯ä»¥æœ‰ä¸¤ç§ç±»å‹ï¼š <br><br><ul><li>  <i>ç»‘å®šé”™è¯¯</i> ï¼šä¾‹å¦‚ï¼Œåœ¨ä¸å­˜åœ¨çš„<i>åŠ¨æ€</i>å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œæˆ–è€…æ— æ³•å°†<i>åŠ¨æ€</i>å¯¹è±¡è½¬æ¢ä¸ºä¼ é€’ç»™å®ƒçš„å‚æ•°çš„ç±»å‹ï¼šç„¶åï¼Œæ‚¨éœ€è¦å¼•å‘ç±»ä¼¼<i>Microsoft.CSharp.RuntimeBinderException</i>çš„å¼‚å¸¸<i>ï¼š'NoSuchMember'</i> </li><li> æŒ‘æˆ˜æ˜¯åˆæ³•çš„ï¼šç„¶åæ‰§è¡Œæ‰€éœ€çš„æ“ä½œ </li></ul><br><br> è¯¥<i>ExpressionTree</i>åœ¨<b>Update</b>å§”æ‰˜æ‰§è¡ŒæœŸé—´å½¢æˆï¼Œå¹¶å­˜å‚¨åœ¨<b>Targetä¸­</b> ã€‚  <b>ç›®æ ‡</b> <i>-L0</i>ç¼“å­˜ï¼Œç¨åæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºç¼“å­˜ã€‚ <br><br> å› æ­¤ï¼Œ <b>Target</b>å­˜å‚¨é€šè¿‡<b>Update</b>å§”æ‰˜ç”Ÿæˆçš„æœ€åä¸€ä¸ª<i>ExpressionTree</i> ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª<i>è§„åˆ™</i>çœ‹èµ·æ¥åƒä¸€ä¸ªä¼ é€’ç»™<i>Boo</i>æ–¹æ³•çš„<i>Managed</i>ç±»å‹çš„ç¤ºä¾‹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Foo</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> instance = Activator.CreateInstance(type); Boo(instance); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Boo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> o</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre> <br><br><pre> <code class="cs hljs">.Lambda CallSite.Target&lt;System.Action`<span class="hljs-number"><span class="hljs-number">3</span></span>[Actionsss.CallSite,ConsoleApp12.Foo,System.Object]&gt;( Actionsss.CallSite $$site, ConsoleApp12.Foo $$arg0, System.Object $$arg1) { .Block() { .If ($$arg0 .TypeEqual ConsoleApp12.Foo &amp;&amp; $$arg1 .TypeEqual System.Int32) { .Return <span class="hljs-meta"><span class="hljs-meta">#Label1 { .Block() { .Call $$arg0.Boo((System.Object)((System.Int32)$$arg1)); .Default(System.Object) } } } .Else { .Default(System.Void) }; .Block() { .Constant&lt;Actionsss.Ast.Expression&gt;(IIF((($arg0 TypeEqual Foo) AndAlso ($arg1 TypeEqual Int32)), returnUnamedLabel_0 ({ ... }) , default(Void))); .Label .LabelTarget CallSiteBinder.UpdateLabel: }; .Label .If ( .Call Actionsss.CallSiteOps.SetNotMatched($$site) ) { .Default(System.Void) } .Else { .Invoke (((Actionsss.CallSite`1[System.Action`3[Actionsss.CallSite,ConsoleApp12.Foo,System.Object]])$$site).Update)( $$site, $$arg0, $$arg1) } .LabelTarget #Label1: } }</span></span></code> </pre> <br><br> å¯¹æˆ‘ä»¬æ¥è¯´æœ€é‡è¦çš„éšœç¢ï¼š <br><br><pre> <code class="cs hljs">.If ($$arg0 .TypeEqual ConsoleApp12.Foo &amp;&amp; $$arg1 .TypeEqual System.Int32)</code> </pre> <br><br>  <i>$$ arg0</i>å’Œ<i>$$ arg1</i>æ˜¯ç”¨äºè°ƒç”¨<b>Target</b>çš„å‚æ•°ï¼š <br><pre> <code class="cs hljs">Foo.o__0.p__0.Target((CallSite) Foo.o__0.p__0, &lt;b&gt;<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>&lt;/b&gt;, &lt;b&gt;instance&lt;/b&gt;);</code> </pre> <br><br> ç¿»è¯‘æˆäººç±»ï¼Œè¿™æ„å‘³ç€ï¼š <br><br> æˆ‘ä»¬å·²ç»éªŒè¯äº†ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ä¸º<i>Foo</i> ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ä¸º<i>Int32</i> ï¼Œåˆ™å¯ä»¥å®‰å…¨åœ°è°ƒç”¨<i>Booï¼ˆï¼ˆobjectï¼‰$$ arg1ï¼‰</i> ã€‚ <br><br><pre> <code class="cs hljs">.Return <span class="hljs-meta"><span class="hljs-meta">#Label1 { .Block() { .Call $$arg0.Boo((System.Object)((System.Int32)$$arg1)); .Default(System.Object) }</span></span></code> </pre> <br><br>  <i>æ³¨æ„ï¼šå¦‚æœå‘ç”Ÿç»‘å®šé”™è¯¯ï¼ŒLabel1å—å¦‚ä¸‹æ‰€ç¤ºï¼š</i> <br><pre> <code class="cs hljs">.Return <span class="hljs-meta"><span class="hljs-meta">#Label1 { .Throw .New Microsoft.CSharp.RuntimeBinderException("NoSuchMember")</span></span></code> </pre> <br><br> è¿™äº›æ£€æŸ¥ç§°ä¸º<b>çº¦æŸ</b> ã€‚  <b>é™åˆ¶</b>æœ‰ä¸¤ç§ç±»å‹ï¼šæŒ‰å¯¹è±¡çš„ç±»å‹å’ŒæŒ‰å¯¹è±¡çš„ç‰¹å®šå®ä¾‹ï¼ˆå¯¹è±¡å¿…é¡»å®Œå…¨ç›¸åŒï¼‰ã€‚ å¦‚æœè‡³å°‘ä¸€é¡¹é™åˆ¶å¤±è´¥ï¼Œæˆ‘ä»¬å°†å¿…é¡»é‡æ–°æ£€æŸ¥åŠ¨æ€è¡¨è¾¾å¼çš„æœ‰æ•ˆæ€§ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†è°ƒç”¨<b>Update</b>å§”æ‰˜ã€‚ æ ¹æ®æˆ‘ä»¬å·²çŸ¥çš„æ–¹æ¡ˆï¼Œä»–å°†æ‰§è¡Œä¸æ–°ç±»å‹çš„ç»‘å®šï¼Œå¹¶å°†æ–°çš„<i>ExpressionTree</i>ä¿å­˜åœ¨<b>Targetä¸­</b> ã€‚ <br><br><h2> å¿«å– </h2><br><br> æˆ‘ä»¬å·²ç»å‘ç°<b>Target</b>æ˜¯<b>L0ç¼“å­˜</b> ã€‚ æ¯æ¬¡è°ƒç”¨<b>Targetæ—¶</b> ï¼Œæˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯éå†å·²ç»å­˜å‚¨åœ¨å…¶ä¸­çš„é™åˆ¶ã€‚ å¦‚æœé™åˆ¶å¤±è´¥å¹¶ä¸”ç”Ÿæˆäº†æ–°çš„ç»‘å®šï¼Œé‚£ä¹ˆæ—§è§„åˆ™å°†åŒæ—¶è¿›å…¥<b>L1</b>å’Œ<b>L2</b> ã€‚ å°†æ¥ï¼Œå½“æ‚¨é”™è¿‡<i>L0</i>ç¼“å­˜æ—¶ï¼Œå°†æœç´¢<i>L1</i>å’Œ<i>L2ä¸­</i>çš„è§„åˆ™ï¼Œç›´åˆ°æ‰¾åˆ°åˆé€‚çš„è§„åˆ™ä¸ºæ­¢ã€‚ <br><br><ul><li>  <i>L1</i> ï¼šå‰©ä¸‹<i>L0</i>çš„æœ€ååæ¡è§„åˆ™ï¼ˆç›´æ¥å­˜å‚¨åœ¨<i>CallSiteä¸­</i> ï¼‰ </li><li>  <i>L2</i> ï¼šä½¿ç”¨ç‰¹å®šçš„ç»‘å®šç¨‹åºå®ä¾‹ï¼ˆæ¯ä¸ª<i>CallSite</i>å”¯ä¸€çš„<i>CallSiteBinder</i> ï¼‰åˆ›å»ºçš„æœ€å128æ¡è§„åˆ™ </li></ul><br><br> ç°åœ¨ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å°†è¿™äº›è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°ä¸€ä¸ªæ•´ä½“ä¸­ï¼Œå¹¶ä»¥ç®—æ³•çš„å½¢å¼æè¿°<i>è°ƒç”¨Foo.Barï¼ˆsomeDynamicObjectï¼‰</i>æ—¶å‘ç”Ÿçš„æƒ…å†µï¼š <br><br>  1.åˆ›å»ºä¸€ä¸ªæ´»é¡µå¤¹ï¼Œè¯¥æ´»é¡µå¤¹åœ¨å…¶ç­¾åçº§åˆ«è®°ä½ä¸Šä¸‹æ–‡å’Œè¢«è°ƒç”¨çš„æ–¹æ³• <br><br>  2.é¦–æ¬¡è°ƒç”¨è¯¥æ“ä½œæ—¶ï¼Œå°†åˆ›å»º<i>ExpressionTree</i> ï¼Œè¯¥å­˜å‚¨ä»¥ä¸‹å†…å®¹ï¼š <br>  2.1 <b>å±€é™æ€§</b> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™å°†æ˜¯å½“å‰ç»‘å®šå‚æ•°ç±»å‹çš„ä¸¤ä¸ªé™åˆ¶ <br>  2.2 <b>ç›®æ ‡å‡½æ•°</b> ï¼š <i>æŠ›å‡ºä¸€äº›å¼‚å¸¸</i> ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä»»ä½•<i>åŠ¨æ€</i>éƒ½ä¼šæˆåŠŸå¯¼è‡´å¯¹è±¡ï¼‰æˆ–è°ƒç”¨<i>Bar</i>æ–¹æ³• <br><br>  3.ç¼–è¯‘å¹¶æ‰§è¡Œç”Ÿæˆçš„ExpressionTree <br><br>  4.è°ƒç”¨è¯¥æ“ä½œæ—¶ï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š <br>  4.1 <b>å·¥ä½œé™åˆ¶</b> ï¼šåªéœ€è‡´ç”µ<i>Bar</i> <br>  4.2 <b>é™åˆ¶æ— æ•ˆ</b> ï¼šå¯¹æ–°çš„ç»‘å®šå‚æ•°é‡å¤æ­¥éª¤2 <br><br> å› æ­¤ï¼Œä»¥<i>Managed</i>ç±»å‹çš„ç¤ºä¾‹ä¸ºä¾‹ï¼Œå‡ ä¹å¯ä»¥æ¸…æ¥šåœ°çœ‹å‡º<i>åŠ¨æ€</i>æ˜¯å¦‚ä½•ä»å†…éƒ¨å·¥ä½œçš„ã€‚ åœ¨æè¿°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šé”™è¿‡ç¼“å­˜ï¼Œå› ä¸ºç±»å‹å§‹ç»ˆç›¸åŒ*ï¼Œå› æ­¤ï¼Œåœ¨åˆå§‹åŒ–<i>CallSite</i>æ—¶ï¼Œ <b>Updateå°†è¢«</b>å®Œå…¨è°ƒç”¨ä¸€æ¬¡ã€‚ ç„¶åï¼Œå¯¹äºæ¯æ¬¡è°ƒç”¨ï¼Œå°†ä»…æ£€æŸ¥é™åˆ¶ï¼Œå¹¶ä¸”å°†ç«‹å³è°ƒç”¨ç›®æ ‡å‡½æ•°ã€‚ è¿™ä¸æˆ‘ä»¬å¯¹å†…å­˜çš„è§‚å¯Ÿéå¸¸å»åˆï¼šæ²¡æœ‰è®¡ç®—-æ²¡æœ‰æ³„æ¼ã€‚ <br><br>  <i>*å› æ­¤ï¼Œç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªç”Ÿæˆå…¶CallSitesï¼šä¸¢å¤±L0ç¼“å­˜çš„å¯èƒ½æ€§å¤§å¤§é™ä½</i> <br><br> ç°åœ¨æ˜¯æ—¶å€™æ‰¾å‡ºè¿™ç§æ–¹æ¡ˆä¸<i>æœ¬åœ°COM</i>å¯¹è±¡çš„ä¸åŒä¹‹å¤„äº†ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<i>ExpressionTree</i> ï¼š <br><br><pre> <code class="cs hljs">.Lambda CallSite.Target&lt;System.Action`<span class="hljs-number"><span class="hljs-number">3</span></span>[Actionsss.CallSite,ConsoleApp12.Foo,System.Object]&gt;( Actionsss.CallSite $$site, ConsoleApp12.Foo $$arg0, System.Object $$arg1) { .Block() { .If ($$arg0 .TypeEqual ConsoleApp12.Foo &amp;&amp; .Block(System.Object $var1) { $var1 = .Constant&lt;System.WeakReference&gt;(System.WeakReference).Target; $var1 != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (System.Object)$$arg1 == $var1 }) { .Return <span class="hljs-meta"><span class="hljs-meta">#Label1 { .Block() { .Call $$arg0.Boo((System.__ComObject)$$arg1); .Default(System.Object) } } } .Else { .Default(System.Void) }; .Block() { .Constant&lt;Actionsss.Ast.Expression&gt;(IIF((($arg0 TypeEqual Foo) AndAlso {var Param_0; ... }), returnUnamedLabel_1 ({ ... }) , default(Void))); .Label .LabelTarget CallSiteBinder.UpdateLabel: }; .Label .If ( .Call Actionsss.CallSiteOps.SetNotMatched($$site) ) { .Default(System.Void) } .Else { .Invoke (((Actionsss.CallSite`1[System.Action`3[Actionsss.CallSite,ConsoleApp12.Foo,System.Object]])$$site).Update)( $$site, $$arg0, $$arg1) } .LabelTarget #Label1: } }</span></span></code> </pre> <br><br> å¯ä»¥çœ‹å‡ºï¼ŒåŒºåˆ«ä»…åœ¨äºç¬¬äºŒä¸ªé™åˆ¶ï¼š <br><br><pre> <code class="cs hljs">.If ($$arg0 .TypeEqual ConsoleApp12.Foo &amp;&amp; .Block(System.Object $var1) { $var1 = .Constant&lt;System.WeakReference&gt;(System.WeakReference).Target; $var1 != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (System.Object)$$arg1 == $var1 })</code> </pre> <br><br> å¦‚æœåœ¨<i>æ‰˜ç®¡</i>ä»£ç çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯¹å¯¹è±¡çš„ç±»å‹æœ‰ä¸¤ä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒä¸ªé™åˆ¶é€šè¿‡<i>WeakReference</i>æ£€æŸ¥å®ä¾‹çš„ç­‰æ•ˆæ€§ã€‚ <br><br>  <i>æ³¨æ„ï¼šé™¤COMå¯¹è±¡å¤–ï¼Œå®ä¾‹é™åˆ¶ä¹Ÿç”¨äºTransparentProxy</i> <br><br> å®é™…ä¸Šï¼Œæ ¹æ®æˆ‘ä»¬å¯¹ç¼“å­˜æ“ä½œçš„äº†è§£ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æˆ‘ä»¬åœ¨å¾ªç¯ä¸­é‡æ–°åˆ›å»º<i>COM</i>å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šé”™è¿‡<i>L0</i>ç¼“å­˜ï¼ˆä»¥åŠ<i>L1 / L2</i> ï¼Œå› ä¸ºå¸¦æœ‰é“¾æ¥çš„æ—§è§„åˆ™å°†å­˜å‚¨åœ¨æ­¤å¤„ï¼‰åˆ°æ—§å®ä¾‹ï¼‰ã€‚ é¦–å…ˆè¦é—®æ‚¨çš„æ˜¯è§„åˆ™ç¼“å­˜æ­£åœ¨æµåŠ¨ã€‚ ä½†æ˜¯é‚£é‡Œçš„ä»£ç éå¸¸ç®€å•ï¼Œé‚£é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼šæ­£ç¡®åˆ é™¤äº†æ—§è§„åˆ™ã€‚ åŒæ—¶ï¼Œåœ¨<i>ExpressionTree</i>ä¸­ä½¿ç”¨<i>WeakReference</i>ä¸ä¼šé˜»æ­¢<i>GC</i>æ”¶é›†ä¸å¿…è¦çš„å¯¹è±¡ã€‚ <br><br>  <i>åœ¨L1ç¼“å­˜ä¸­ä¿å­˜è§„åˆ™çš„æœºåˆ¶ï¼š</i> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MaxRules = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRule</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T newRule</span></span></span><span class="hljs-function">)</span></span> { T[] rules = Rules; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rules == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Rules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { newRule }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } T[] temp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rules.Length &lt; (MaxRules - <span class="hljs-number"><span class="hljs-number">1</span></span>)) { temp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T[rules.Length + <span class="hljs-number"><span class="hljs-number">1</span></span>]; Array.Copy(rules, <span class="hljs-number"><span class="hljs-number">0</span></span>, temp, <span class="hljs-number"><span class="hljs-number">1</span></span>, rules.Length); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { temp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T[MaxRules]; Array.Copy(rules, <span class="hljs-number"><span class="hljs-number">0</span></span>, temp, <span class="hljs-number"><span class="hljs-number">1</span></span>, MaxRules - <span class="hljs-number"><span class="hljs-number">1</span></span>); } temp[<span class="hljs-number"><span class="hljs-number">0</span></span>] = newRule; Rules = temp; }</code> </pre> <br><br> é‚£æ€ä¹ˆåŠï¼Ÿ è®©æˆ‘ä»¬å°è¯•é˜æ˜è¿™ä¸ªå‡è®¾ï¼šç»‘å®š<i>COM</i>å¯¹è±¡æ—¶æŸå¤„å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ <br><br><h2> å®éªŒï¼Œç¬¬2éƒ¨åˆ† </h2><br><br> åŒæ ·ï¼Œè®©æˆ‘ä»¬â€‹â€‹ä»æ¨æµ‹æ€§ç»“è®ºè½¬å‘å®éªŒã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬é‡å¤ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬åšçš„äº‹æƒ…ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Simple COM object var comType = Type.GetTypeFromCLSID(new Guid("435356F9-F33F-403D-B475-1E4AB512FF95")); var autogeneratedBinder = Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, "Boo", null, typeof(Foo), new CSharpArgumentInfo[2] { CSharpArgumentInfo.Create( CSharpArgumentInfoFlags.UseCompileTimeType, null), CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, null) }); var callSite = CallSite&lt;Action&lt;CallSite, Foo, object&gt;&gt;.Create(autogeneratedBinder); while (true) { object instance = Activator.CreateInstance(comType); callSite.Target(callSite, this, instance); }</span></span></code> </pre> <br><br> æˆ‘ä»¬æ£€æŸ¥ï¼š <br><br><img src="https://habrastorage.org/webt/bf/-u/k6/bf-uk6jtzrfh8_pyzaagi0p8cr4.png"><br><br> æ³„æ¼å·²ä¿ç•™ã€‚ å…¬å¹³ã€‚ ä½†æ˜¯æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ åœ¨ç ”ç©¶äº†æ´»é¡µå¤¹çš„ä»£ç ï¼ˆæˆ‘ä»¬æ”¾åœ¨æ–¹æ‹¬å·ä¹‹åï¼‰ä¹‹åï¼Œå¾ˆæ˜æ˜¾ï¼Œå”¯ä¸€å½±å“æˆ‘ä»¬å¯¹è±¡ç±»å‹çš„æ˜¯çº¦æŸé€‰é¡¹ã€‚ ä¹Ÿè®¸è¿™ä¸æ˜¯<i>COM</i>å¯¹è±¡çš„é—®é¢˜ï¼Œè€Œæ˜¯ç»‘å®šå™¨çš„é—®é¢˜ï¼Ÿ æ²¡æœ‰å¤ªå¤šé€‰æ‹©ï¼Œè®©æˆ‘ä»¬ä¸º<i>æ‰˜ç®¡</i>ç±»å‹å¼•å‘å¤šä¸ªç»‘å®šï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> instance = Activator.CreateInstance(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> autogeneratedBinder = Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, <span class="hljs-string"><span class="hljs-string">"Boo"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Foo), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CSharpArgumentInfo[<span class="hljs-number"><span class="hljs-number">2</span></span>] { CSharpArgumentInfo.Create( CSharpArgumentInfoFlags.UseCompileTimeType, <span class="hljs-literal"><span class="hljs-literal">null</span></span>), CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal"><span class="hljs-literal">null</span></span>) }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> callSite = CallSite&lt;Action&lt;CallSite, Foo, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt;.Create(autogeneratedBinder); callSite.Target(callSite, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, instance); }</code> </pre> <br><br><img src="https://habrastorage.org/webt/-y/an/hj/-yanhjj9jkmqr8bl2adf9rvjsvs.png"><br><br> å“‡ï¼ çœ‹æ¥æˆ‘ä»¬æŠ“åˆ°äº†ä»–ã€‚ è¿™ä¸ªé—®é¢˜æ ¹æœ¬å°±ä¸åƒæœ€åˆåœ¨æˆ‘ä»¬çœ‹æ¥çš„<i>COMå¯¹è±¡</i>é‚£æ ·ï¼Œåªæ˜¯ç”±äºå®ä¾‹çš„é™åˆ¶ï¼Œè¿™æ˜¯å”¯ä¸€çš„ç»‘å®šåœ¨å¾ªç¯å†…å‘ç”Ÿå¤šæ¬¡çš„æƒ…å†µã€‚ åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œæˆ‘éƒ½å»ºç«‹äº†<i>L0ç¼“å­˜</i>å¹¶ç»‘å®šäº†ä¸€æ¬¡ã€‚ <br><br><h2> ç»“è®º </h2><br><br><h3> å†…å­˜æ³„æ¼ </h3><br><br> å¦‚æœæ‚¨ä½¿ç”¨åŒ…å«<i>æœ¬æœºCOM</i>æˆ–<i>TransparentProxyçš„</i> <i>åŠ¨æ€</i>å˜é‡ï¼Œè¯·ä¸è¦å°†å®ƒä»¬ä½œä¸ºæ–¹æ³•å‚æ•°ä¼ é€’ã€‚ å¦‚æœä»ç„¶éœ€è¦æ‰§è¡Œæ­¤æ“ä½œï¼Œè¯·ä½¿ç”¨æ˜¾å¼å¼ºåˆ¶è½¬æ¢ä¸º<i>å¯¹è±¡</i> ï¼Œç„¶åç¼–è¯‘å™¨å°†è½åäºæ‚¨ <br><br>  <b>é”™è¯¯çš„</b> ï¼š <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> com = Activator.CreateInstance(comType); <span class="hljs-comment"><span class="hljs-comment">//do some work Marshal.FinalReleaseComObject(com);</span></span></code> </pre> <br><br>  <b>æ­£ç¡®åœ°</b> ï¼š <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> com = Activator.CreateInstance(comType); <span class="hljs-comment"><span class="hljs-comment">//do some work Marshal.FinalReleaseComObject((object) com);</span></span></code> </pre><br><br> ä½œä¸ºé¢å¤–çš„é¢„é˜²æªæ–½ï¼Œè¯·å°è¯•å°½å¯èƒ½å°‘åœ°å®ä¾‹åŒ–æ­¤ç±»å¯¹è±¡ã€‚ é€‚ç”¨äº<i>.NET Frameworkçš„</i>æ‰€æœ‰ç‰ˆæœ¬ã€‚  ï¼ˆç›®å‰ï¼‰ä¸æ˜¯å¾ˆç›¸å…³ã€‚  <i>NET Core</i> ï¼Œå› ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸æ”¯æŒ</a> <i>åŠ¨æ€COM</i>å¯¹è±¡ã€‚ <br><br><h3> æ€§èƒ½è¡¨ç° </h3><br><br> æ‚¨çš„åˆ©ç›Šæ˜¯å°½å¯èƒ½å°‘åœ°å‘ç”Ÿé«˜é€Ÿç¼“å­˜æœªå‘½ä¸­ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ— éœ€åœ¨é«˜çº§é«˜é€Ÿç¼“å­˜ä¸­æ‰¾åˆ°åˆé€‚çš„è§„åˆ™ã€‚  <i>L0</i>é«˜é€Ÿç¼“å­˜ä¸­çš„æœªå‘½ä¸­ä¸»è¦æ˜¯åœ¨<i>åŠ¨æ€</i>å¯¹è±¡çš„ç±»å‹ä¸ä¿ç•™çš„é™åˆ¶ä¸åŒ¹é…çš„æƒ…å†µä¸‹å‘ç”Ÿçš„ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> com = GetSomeObject(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSomeObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//:      //:         }</span></span></code> </pre> <br><br> ä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œé™¤éå¯¹è¯¥å‡½æ•°çš„è°ƒç”¨æ•°ä»¥ç™¾ä¸‡è®¡ï¼Œæˆ–è€…ç±»å‹çš„å¯å˜æ€§ä¸æ˜¯å¼‚å¸¸å¤§ï¼Œå¦åˆ™æ‚¨å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°æ€§èƒ½çš„å·®å¼‚ã€‚  <i>L0</i>é«˜é€Ÿç¼“å­˜æœªå‘½ä¸­æ—¶çš„å¼€é”€æ˜¯è¿™æ ·çš„ï¼Œ <i>N</i>æ˜¯ç±»å‹æ•°ï¼š <br><br><ul><li>  <i>N</i> &lt;10ã€‚ å¦‚æœé”™è¿‡äº†ï¼Œè¯·ä»…è¿­ä»£ç°æœ‰çš„<i>L1</i>ç¼“å­˜è§„åˆ™ </li><li>  10 &lt; <i>N &lt;128</i> ã€‚  <i>L1</i>å’Œ<i>L2</i>ç¼“å­˜çš„æšä¸¾ï¼ˆæœ€å¤š10æ¬¡å’Œ<i>N</i>æ¬¡è¿­ä»£ï¼‰ã€‚ åˆ›å»ºå¹¶å¡«å……10ä¸ªå…ƒç´ çš„æ•°ç»„ </li><li>  <i>N</i> &gt; 128ã€‚ éå†<i>L1</i>å’Œ<i>L2</i>ç¼“å­˜ã€‚ åˆ›å»ºå¹¶å¡«å……10å’Œ128ä¸ªå…ƒç´ çš„æ•°ç»„ã€‚ å¦‚æœæ‚¨é”™è¿‡äº†<i>L2</i>ç¼“å­˜ï¼Œè¯·é‡æ–°ç»‘å®š </li></ul><br><br> åœ¨ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æƒ…å†µä¸‹ï¼ŒGCçš„è´Ÿè½½å°†å¢åŠ ã€‚ <br><br><h2> ç»“è®º </h2><br><br> ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°å¯¼è‡´å†…å­˜æ³„æ¼çš„çœŸæ­£åŸå› ï¼Œè¿™éœ€è¦å¯¹ç»‘å®šå™¨è¿›è¡Œå•ç‹¬ç ”ç©¶ã€‚ å¹¸è¿çš„æ˜¯ï¼Œ <i>WinDbg</i>ä¸ºè¿›ä¸€æ­¥ç ”ç©¶æä¾›äº†æç¤ºï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DLRä¸­</a>å‘ç”Ÿäº†ä¸€äº›ä¸å¥½çš„äº‹æƒ…ã€‚ ç¬¬ä¸€åˆ—æ˜¯å¯¹è±¡æ•° <br><br><img src="https://habrastorage.org/webt/n_/6g/xf/n_6gxf7etpsj2fg17odfa0varvy.png"><br><br><h2> çº¢åˆ© </h2><br><br>  <b>ä¸ºä»€ä¹ˆå¼ºåˆ¶è½¬æ¢ä¸º<i>å¯¹è±¡å¯ä»¥</i>é˜²æ­¢æ³„æ¼ï¼Ÿ</b> <br> å¯ä»¥å°†ä»»ä½•ç±»å‹å¼ºåˆ¶è½¬æ¢ä¸º<i>object</i> ï¼Œå› æ­¤æ“ä½œä¸å†æ˜¯åŠ¨æ€çš„ã€‚ <br><br>  <b>åœ¨ä½¿ç”¨COMå¯¹è±¡çš„å­—æ®µå’Œæ–¹æ³•æ—¶ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰æ³„æ¼ï¼Ÿ</b> <br> è¿™æ˜¯<i>ExpressionTree</i>ç”¨äºå­—æ®µè®¿é—®çš„å¤–è§‚ï¼š <br><br><pre> <code class="cs hljs">.If ( .Call System.Dynamic.ComObject.IsComObject($$arg0) ) { .Return <span class="hljs-meta"><span class="hljs-meta">#Label1 { .Dynamic GetMember ComMarks(.Call System.Dynamic2.ComObject.ObjectToComObject($$arg0)) } }</span></span></code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN466657/">https://habr.com/ru/post/zh-CN466657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN466643/index.html">ï¼ƒ314ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ9æœˆ2æ—¥è‡³8æ—¥ï¼‰</a></li>
<li><a href="../zh-CN466647/index.html">æ²¡æœ‰é’¢ç´å®¶çš„é©¬å’Œä¹å›¢çš„ç”µè¯ã€‚ å¦‚ä½•åœ¨å‰ç«¯æå‡ºè¿åŠ¨ä»»åŠ¡</a></li>
<li><a href="../zh-CN466649/index.html">å‘¨æœ«ç”µåŠ¨è½¦</a></li>
<li><a href="../zh-CN466651/index.html">ä»¥Java / Spring / H2ä¸ºä¾‹ï¼Œåœ¨XMLå’ŒSQLä¹‹é—´è¿›è¡Œé€‰æ‹©ä»¥æ»šåŠ¨LiquiBaseè„šæœ¬</a></li>
<li><a href="../zh-CN466653/index.html">ä¸ºNESè°ƒè¯•æ¸¸æˆï¼šä»Šå¤©å¦‚ä½•å‘ç”Ÿ</a></li>
<li><a href="../zh-CN466659/index.html">Kubecostå®¡æŸ¥å¯åœ¨äº‘ç«¯çš„Kubernetesä¸Šçœé’±</a></li>
<li><a href="../zh-CN466661/index.html">å›½å¤–è¿œç¨‹ç¡•å£«å­¦ä½ï¼šè®ºæ–‡å‘è¡¨å‰çš„æ³¨æ„äº‹é¡¹</a></li>
<li><a href="../zh-CN466663/index.html">ä½¿ç”¨STM32F103å¾®æ§åˆ¶å™¨ï¼ˆBlue Tabletï¼‰è¿›è¡Œçš„ç®€å•å®éªŒ</a></li>
<li><a href="../zh-CN466665/index.html">CSSæº¢å‡ºå’Œæ•°æ®ä¸¢å¤±</a></li>
<li><a href="../zh-CN466667/index.html">ä¸Šå‘¨ç¬¬379æœŸï¼ˆ2019å¹´9æœˆ2æ—¥è‡³8æ—¥ï¼‰æ¥è‡ªå‰ç«¯ä¸–ç•Œçš„æ–°é²œææ–™æ‘˜è¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>