<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ä ‚èèÔ∏è üê® An√∫ncios em banner no aplicativo iOS üìà üôá üê∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje estamos abrindo uma s√©rie de artigos sobre o que geralmente n√£o √© falado em confer√™ncias e reuni√µes t√©cnicas. Esta e as postagens subsequentes mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√∫ncios em banner no aplicativo iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/426553/"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Hoje estamos abrindo uma s√©rie de artigos sobre o que geralmente n√£o √© falado em confer√™ncias e reuni√µes t√©cnicas.  Esta e as postagens subsequentes mostrar√£o como o mecanismo de monetiza√ß√£o funciona no aplicativo de entretenimento iFunny iOS, popular nos EUA, que estamos desenvolvendo. <br><a name="habracut"></a><br>  A publicidade √© uma das principais maneiras de monetizar aplicativos gratuitos.  Mas agora, quais eram as op√ß√µes em 2011 quando o iFunny apareceu?  O servi√ßo foi originalmente constru√≠do como um neg√≥cio forte e sustent√°vel; portanto, desde o primeiro dia, a empresa decidiu n√£o flertar com os usu√°rios e n√£o se envolver em jogos com capitaliza√ß√£o condicional. <br><br>  Naquela √©poca, a principal op√ß√£o para monetiza√ß√£o era criar uma vers√£o simplificada gratuita do servi√ßo e tentar vender a funcionalidade principal.  O consumidor era jovem, inexperiente e n√£o estava pronto para participar de valores superiores a um d√≥lar. <br><br>  A matem√°tica simples mostrou que, com uma convers√£o de 10%, obter um ARPU de mais de 10 centavos √© uma tarefa quase imposs√≠vel. <br><br>  Ent√£o eu tive que pensar em como mais voc√™ pode monetizar o produto.  O modelo de publicidade j√° funcionou muito bem na web e pode-se supor que em breve tamb√©m florescer√° nos telefones. <br>  Em geral, o in√≠cio do modelo de monetiza√ß√£o de publicidade para celular pode ser considerado o aparecimento do AdWhirl - um servi√ßo que permite integrar o SDK das redes de publicidade e altern√°-las.  Sua apar√™ncia nos permitiu aumentar o FillRate para uma m√©dia de 50% no mercado e tornar a receita do modelo de publicidade pelo menos compar√°vel √†s vendas de um d√≥lar.  O pr√≥prio princ√≠pio da implementa√ß√£o de todas as fontes poss√≠veis de demanda e a organiza√ß√£o da concorr√™ncia entre elas se tornaram o principal motor do crescimento na ind√∫stria da publicidade e continuam sendo exploradas at√© hoje. <br><br>  Por√©m, quanto mais complexo o sistema, menos est√°vel ele se torna, o que √© absolutamente inaceit√°vel para grandes servi√ßos do n√≠vel iFunny.  Come√ßando a avan√ßar nessa dire√ß√£o em 2011, a empresa criou um dos mecanismos mais eficazes para trabalhar com banners m√≥veis e publicidade nativa e aumentou sua receita por usu√°rio em 40 vezes, o que permitiu desenvolver n√£o apenas projetos internos, mas tamb√©m investir em outras empresas. <br><br><h2>  MoPub e empresa </h2><br>  Desde 2012, passamos do AdWhirl para o MoPub. <br><br>  O MoPub √© uma plataforma de publicidade m√≥vel com a capacidade de adicionar seus pr√≥prios m√≥dulos, que incluem v√°rias √≥timas ferramentas: <br><br><ul><li>  Mercado MoPub - troca de publicidade pr√≥pria; </li><li>  mediador de redes de publicidade para trabalhar com redes externas; </li><li>  um mecanismo de pedidos que permite que voc√™ coloque banners independentemente em seu pr√≥prio aplicativo e personalize as exibi√ß√µes. </li></ul><br>  As principais vantagens do MoPub: <br><br><ul><li>  capaz de trabalhar com a maioria das redes de publicidade; </li><li>  mecanismo claro para conectar novas redes de terceiros; </li><li>  c√≥digo aberto </li><li>  um grande n√∫mero de configura√ß√µes b√°sicas e segmenta√ß√£o; </li><li>  uma grande comunidade em torno da rede, h√° at√© uma confer√™ncia pr√≥pria. </li></ul><br>  O MoPub tamb√©m tem desvantagens: <br><br><ul><li>  solicita√ß√µes de pool no GitHub n√£o s√£o aceitas e n√£o h√° nenhuma rea√ß√£o a elas; </li><li> o painel de controle √© muito complexo e, para o desenvolvedor, durante a depura√ß√£o, leva algum tempo para aprofundar sua estrutura. </li></ul><br><h2>  O poder da verdade </h2><br>  Como disse o her√≥i de um filme russo: "A for√ßa est√° na verdade".  Nesta parte, falarei sobre as dificuldades que n√≥s, como desenvolvedores de aplicativos, tivemos que enfrentar ap√≥s o primeiro milh√£o de downloads do iFunny, o crescimento do p√∫blico e o tr√°fego de publicidade de mais de 100 parceiros. <br><br><h3>  Conte√∫do </h3><br>  O mercado de publicidade √© uma ‚Äúcasta‚Äù muito fechada de empresas de tecnologia, mas, ao mesmo tempo, os agregadores t√™m uma grande rede de parceiros: de grandes empresas que trabalham com milh√µes de or√ßamentos a pequenas empresas adaptadas a p√∫blicos-alvo espec√≠ficos. <br><br>  Essa proximidade e fragmenta√ß√£o dos parceiros, apesar da pr√©-modera√ß√£o do banner e das regras bastante r√≠gidas sobre o conte√∫do da publicidade, n√£o permite que os vendedores de publicidade mais honestos publiquem criativos proibidos ou prejudicam a experi√™ncia do usu√°rio no aplicativo. <br><br>  Existem v√°rias categorias principais de conte√∫do "obsceno" em banners publicit√°rios: <br><br><ul><li>  conte√∫do porn√¥.  Recentemente, parece cada vez menos, mas mesmo assim acontece.  N√£o podemos publicar este conte√∫do no artigo, ent√£o a imagem n√£o estar√° aqui </li><li>  alertas do sistema em banners, um exemplo pode ser visto em um dos usu√°rios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">twitter.com/IfunnyStates/status/1029393804749668352</a> </li><li>  conte√∫do com som.  Os sons n√£o s√£o proibidos pelas redes de an√∫ncios, nem pelas anima√ß√µes, mas se o som tocar sem interagir com a interface, isso ser√° percebido pelos usu√°rios como um bug do aplicativo e afetar√° negativamente a experi√™ncia do usu√°rio. </li><li>  aten√ß√£o chamando.  Um bom banner deve atrair a aten√ß√£o do usu√°rio, mas isso nem sempre acontece de maneira honesta: √†s vezes, v√≠deos tremeluzentes caem nos banners.  Outra maneira desonesta de fazer com que o usu√°rio toque no banner √© simular a interface do aplicativo, por exemplo: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  A prop√≥sito, na R√∫ssia, um simples toque nesse banner pode emitir uma assinatura paga para algumas operadoras de celular, e voc√™ nem saber√° disso at√© ver os detalhes.  Essa tamb√©m √© uma maneira desonesta de trabalhar com publicidade, mas as operadoras nos Estados Unidos n√£o t√™m essa oportunidade. <br><br><h3>  Cliques autom√°ticos </h3><br>  Como mostra minha experi√™ncia, esse √© um caso extremamente negativo para os usu√°rios.  Usando os recursos de JavaScript, WKWebView ou UIWebView, al√©m de brechas na implementa√ß√£o de bibliotecas de publicidade, voc√™ pode criar an√∫ncios que abrir√£o o pr√≥prio conte√∫do do banner e levar√£o o usu√°rio para fora do aplicativo. <br><br>  Para repetir esse problema usando o exemplo do MoPub, basta adicionar o c√≥digo javascript do seguinte conte√∫do ao banner: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Isso funcionou por muito tempo em muitas vers√µes do MoPub, at√© a vers√£o 4.13. <br><br>  Ao explorar a implementa√ß√£o do MoPub, foi poss√≠vel gerar links mais complexos que permitiriam n√£o apenas abrir an√∫ncios em tela cheia, mas tamb√©m enviar o usu√°rio √† AppStore para um aplicativo espec√≠fico e nem levar em considera√ß√£o a exibi√ß√£o do banner. <br><br>  A prop√≥sito, nas notas de lan√ßamento da vers√£o 4.13.0 do MoPub SDK para iOS, n√£o h√° informa√ß√µes sobre essa corre√ß√£o, pois foi um buraco bastante s√©rio no SDK, e os parceiros desonestos do MoPub a exploraram bastante ativamente.  Como mostram os logs, que discutirei mais adiante, todos os dias eu tinha que bloquear at√© 2 milh√µes de tentativas de abrir o banner sem a intera√ß√£o do usu√°rio. <br><br>  No caso do MoPub, ficou f√°cil encontrar e repetir o problema, mas outras redes com as quais o iFunny trabalha t√™m um c√≥digo fechado e voc√™ precisa lidar com os cliques autom√°ticos emergentes bloqueando banners ou at√© desconectando as redes por um tempo. <br>  O iFunny trabalha em estreita colabora√ß√£o com todos os parceiros de publicidade e informa esses banners.  Como o p√∫blico jovem do iFunny √© interessante para os anunciantes, os parceiros desejam conhec√™-los e remover essa publicidade da rota√ß√£o. <br><br><h3>  Crash </h3><br>  Bater sempre √© ruim.  Pior ainda, quando eles ocorrem devido a uma depend√™ncia de c√≥digo fechado, e voc√™ pode influenci√°-los apenas indiretamente.  Ao longo dos anos de trabalho com publicidade no iFunnu, v√°rios tipos de falhas foram identificados por eles mesmos, que podem ser divididos em v√°rios grupos. <br><br><ul><li>  Sistema </li></ul><br>  Isso inclui exce√ß√µes na biblioteca de rede, WKWebView (UIWebView), OpenGL. <br>  √â muito dif√≠cil afetar diretamente esse tipo de falha, mas ainda era poss√≠vel afetar algumas delas, tendo estudado anteriormente a opera√ß√£o do componente WebView com o WebGL. <br><br>  √â assim que o stackrace de tais falhas se parece: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  Al√©m disso, eles ocorrem exclusivamente ao sair em segundo plano.  Isso ocorre porque o mecanismo OpenGL n√£o deve funcionar quando o aplicativo est√° em segundo plano. <br><br>  A corre√ß√£o aqui acabou sendo bastante simples: <br><br>  Ao sair em segundo plano, √© necess√°rio tirar uma captura de tela do banner. <br><br>  Remova a exibi√ß√£o de publicidade da tela para que o componente WebView pare de usar o OpenGL. <br>  Quando voc√™ sair do plano de fundo, retorne tudo como estava. <br><br>  No c√≥digo Objective-C, fica assim: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Integra√ß√£o </li></ul><br>  Esses s√£o os problemas que ocorrem na jun√ß√£o do iFunny, Mopub e o provedor de publicidade. <br>  Como regra, eles surgem ap√≥s a atualiza√ß√£o da biblioteca do provedor e devido a novas maneiras de interagir com eles. <br><br>  O √∫ltimo caso foi em junho deste ano, ap√≥s a pr√≥xima atualiza√ß√£o de uma das bibliotecas utilizadas.  Uma nova maneira de inicializar a biblioteca sugerida usando o singleton para definir as configura√ß√µes de rede. <br><br>  Voltando a ele duas vezes, como aconteceu na implementa√ß√£o, periodicamente causou um friso no encadeamento principal, ent√£o tive que envolver a inicializa√ß√£o em dispatch_once. <br><br>  O departamento de controle de qualidade do iFunny pode testar bem as bibliotecas de publicidade. Portanto, esse problema foi encontrado durante o teste da atualiza√ß√£o. <br><br><ul><li>  Inesperado </li></ul><br>  Esse tipo de falha n√£o pode ser controlado, pois ocorre sem nenhuma altera√ß√£o no cliente. <br><br>  Eles est√£o associados √† atualiza√ß√£o do back-end dos parceiros e √† falta de compatibilidade com vers√µes anteriores.  Essas falhas geralmente ocorrem em grandes fornecedores de publicidade, mas s√£o rapidamente corrigidas, pois afetam um grande n√∫mero de aplicativos ao mesmo tempo. <br><br>  Houve casos em que o iFunny sem falhas por dia caiu do padr√£o de 99,8% para 80%, e o n√∫mero de coment√°rios irritados na hist√≥ria ficou em dezenas. <br><br><h4>  Desempenho </h4><br>  A publicidade em banner, como regra, usa componentes do WebView para exibir publicidade; portanto, cada banner mostrado √© uma inicializa√ß√£o de um novo WebView com todas as suas depend√™ncias. <br><br>  Al√©m disso, alguns parceiros tamb√©m usam o WebView para se comunicar com seu pr√≥prio back-end, pois a publicidade em banner em dispositivos m√≥veis √© descendente de publicidade na web. <br><br>  Acontece que ap√≥s a atualiza√ß√£o, h√° vazamentos de mem√≥ria dentro da nova biblioteca.  Ap√≥s o aparecimento da ferramenta Memory Graph no Xcode, ficou muito mais f√°cil encontrar vazamentos em bibliotecas de terceiros, para que os parceiros possam ser rapidamente informados sobre eles. <br><br>  Abaixo est√° o GIF do iFunny ocioso quando n√£o h√° publicidade para o usu√°rio: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  Solu√ß√µes </h2><br>  Mas, apesar de todos os problemas descritos acima, o iFunny √© est√°vel e todos os dias causa sorrisos entre milh√µes de usu√°rios. <br><br>  Ao longo dos anos de trabalho ativo com publicidade, a equipe de desenvolvimento possui v√°rias ferramentas que podem monitorar com √™xito os problemas de publicidade e responder a eles a tempo. <br><br><h3>  Sistema de registro </h3><br>  Agora, o sistema de registro de exce√ß√µes no iFunny se espalhou por todo o aplicativo: para isso, usamos nosso pr√≥prio back-end com base no ClickHouse e exibimos no Grafana. <br><br>  Mas a primeira tarefa para trabalhar com logs no aplicativo foi precisamente o log de situa√ß√µes excepcionais na publicidade. <br><br>  Existem v√°rios componentes relacionados para determinar se uma chamada √© encaminhada para o iFunny.  Vou lhe contar mais sobre cada um deles. <br><br><h4>  IFAdView </h4><br>  Esse √© o descendente da classe MPAdView (√© respons√°vel por exibir an√∫ncios no MoPub). <br><br>  O m√©todo hitTest: withEvent √© substitu√≠do nesta classe: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Assim, acionamos o fato de o usu√°rio interagir com o an√∫ncio. <br><br><h4>  IFURLProtocol </h4><br>  Herdamos de NSURLProtocol e descrevemos o m√©todo: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  Este √© um gatilho para abrir a AppStore a partir do aplicativo. Listamos todos os URLs dispon√≠veis para isso. <br><br><h4>  IFAdsExceptionManager </h4><br>  Uma classe que coleta gatilhos e gera um registro de exce√ß√£o no log. <br><br>  Para deixar claro que tipo de gatilhos s√£o, descreverei cada m√©todo da interface desta classe. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  Um gatilho que determina se um redirecionamento ocorre no iTunes. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  Um gatilho para determinar a perda de atividade por um aplicativo.  Ele compara os dois gatilhos anteriores. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Redefinir gatilhos.  N√≥s o chamamos quando sa√≠mos de segundo plano ou quando abrimos a AppStore, por exemplo, quando enviamos o usu√°rio para avaliar em vers√µes mais antigas do iOS. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Propriedades para registrar os √∫ltimos an√∫ncios solicitados e baixados com ou sem √™xito.  Necess√°rio para formar uma mensagem no log. <br><br>  Pode-se ver que o algoritmo acabou sendo bastante simples, mas eficaz.  Ele nos permite rastrear n√£o apenas as descobertas autom√°ticas do MoPub, mas tamb√©m de outras redes. <br><br>  Recentemente, os an√∫ncios com abertura autom√°tica geralmente abrem o SKStoreProductViewController, ent√£o agora estamos trabalhando na defini√ß√£o de abertura autom√°tica desse controlador.  O algoritmo para definir essa exce√ß√£o ser√° um pouco mais complicado, mas o Objective-C Runtime nos ajudar√° aqui. <br><br><h2>  Suporte local </h2><br>  Com base no sistema de registro, o iFunny tamb√©m come√ßou a desenvolver um estande local para receber e depurar an√∫ncios que os usu√°rios veem em tempo real. <br><br>  O suporte consiste em: <br><br><ul><li>  agente de constru√ß√£o </li><li>  dispositivos </li><li>  su√≠te de teste para cada provedor </li></ul><br>  Uma das solu√ß√µes interessantes que s√£o usadas no estande √© o IDFA de reclama√ß√µes de usu√°rios para publicidade real. <br><br>  Desde cerca de 2016, paramos de receber an√∫ncios reais segmentados para os EUA usando apenas VPNs, ent√£o precisamos substituir dispositivos IDFA por IDFAs para usu√°rios reais. <br><br>  Isso √© feito com bastante facilidade usando o Objective-C Runtime e swizzling. <br>  Voc√™ precisa substituir o m√©todo advertisingIdentifier da classe ASIdentifierManager. <br><br>  Aqui fazemos isso atrav√©s da categoria: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  O m√©todo descrito no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo √©</a> usado para transferir o IDFA do usu√°rio para a constru√ß√£o do agente de constru√ß√£o. <br><br>  Concluindo, quero dizer que a publicidade em banner funciona muito bem nos Estados Unidos e, durante sete anos de seu uso ativo como o principal m√©todo de monetiza√ß√£o, o iFunny aprendeu a trabalhar bem com ela. <br><br>  Mas, apesar de os banners trazerem 75% da receita da empresa, ainda est√£o em andamento m√©todos alternativos de monetiza√ß√£o e j√° foi adquirida alguma experi√™ncia em publicidade nativa e no uso de leil√µes de publicidade no mercado americano. <br><br>  Em geral, h√° algo a dizer. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426553/">https://habr.com/ru/post/pt426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426543/index.html">Backups com estado em Kubernetes</a></li>
<li><a href="../pt426545/index.html">B√¥nus do Coringa 2018: streaming online gratuito, bofs, festa e mesa</a></li>
<li><a href="../pt426547/index.html">Como o criador do Android est√° tentando lan√ßar o primeiro "anti-smartphone"</a></li>
<li><a href="../pt426549/index.html">Um novo tipo de software para gerentes de produto</a></li>
<li><a href="../pt426551/index.html">Trekz Air - como os fones de ouvido com condu√ß√£o √≥ssea realmente soam</a></li>
<li><a href="../pt426555/index.html">PC, mas n√£o PC: Entrevista com o Comit√™ do Programa Joker</a></li>
<li><a href="../pt426557/index.html">As habilidades mais procuradas em ci√™ncia de dados</a></li>
<li><a href="../pt426559/index.html">Redes neurais para processamento de imagens. Diz Alexander Savsunenko da Skylum Software</a></li>
<li><a href="../pt426561/index.html">Os Cinco Grandes: deve ter ferramentas para acelerar o desenvolvimento</a></li>
<li><a href="../pt426563/index.html">Cat√°logo de endere√ßos hier√°rquico, altera√ß√£o de email principal e outras inova√ß√µes no Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>