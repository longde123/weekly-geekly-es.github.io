<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë± üçÖ üèÇüèø Moteur, langage de script et roman visuel - en 45 heures ‚ÄºÔ∏è ü§öüèª ‚ùì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations. Il se trouve que pendant trois ann√©es cons√©cutives, comme cadeau pour la nouvelle ann√©e √† certaines personnes, j'ai cr√©√© un jeu. En 2018,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Moteur, langage de script et roman visuel - en 45 heures</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483818/"><p><img src="https://habrastorage.org/webt/k-/q6/7j/k-q67jnxvm1knkh3qfvqjyhbira.png" alt="roman visuel, moteur et langage de script pendant 45 heures"></p><br><p>  Salutations.  Il se trouve que pendant trois ann√©es cons√©cutives, comme cadeau pour la nouvelle ann√©e √† certaines personnes, j'ai cr√©√© un jeu.  En 2018, c'√©tait un jeu de plateforme avec des √©l√©ments de puzzle, √† propos duquel j'ai <a href="https://habr.com/ru/post/345958/">√©crit</a> sur un hub  En 2019 - un r√©seau RTS pour deux joueurs, sur lequel je n'ai rien √©crit.  Et enfin, dans le 2020e - une courte histoire visuelle, qui sera discut√©e plus tard, cr√©√©e dans un temps tr√®s limit√©. </p><br><p>  Dans cet article: </p><br><ul><li>  conception et impl√©mentation du moteur de nouvelles visuelles, </li><li>  un jeu avec un trac√© non lin√©aire en 8 heures, </li><li>  suppression de la logique du jeu dans des scripts dans leur propre langue. </li></ul><br><p>  Int√©ressant?  Alors bienvenue au chat. </p><br><p>  <em>Attention: il y a beaucoup de texte et ~ 3,5 Mo d'images</em> </p><a name="habracut"></a><br><p>  Contenu: </p><br><p>  0. Justification du d√©veloppement du moteur. </p><br><ol><li>  Le choix de la plateforme. </li><li>  Architecture du moteur et sa mise en ≈ìuvre: <br>  2.1.  √ânonc√© du probl√®me. <br>  2.2.  Architecture et impl√©mentation. </li><li>  Langage de script: <br>  3.1.  Langue. <br>  3.2.  Interpr√®te </li><li>  D√©veloppement de jeux: <br>  4.1.  L'histoire et le d√©veloppement de la logique du jeu. <br>  4.2.  Graphisme </li><li>  Statistiques et r√©sultats. </li></ol><br><p>  <em>Remarque: Si, pour une raison quelconque, vous n'√™tes pas int√©ress√© par les d√©tails techniques, vous pouvez passer directement √† l'√©tape 4 "D√©veloppement de jeu", mais vous ignorerez la majeure partie du contenu.</em> </p><br><h2 id="0-obosnovanie-razrabotki-dvizhka">  0. Justification du d√©veloppement du moteur </h2><br><p>  Bien s√ªr, il existe un grand nombre de moteurs pr√™ts √† l'emploi pour les histoires visuelles, qui, sans aucun doute, sont meilleurs que la solution d√©crite ci-dessous.  Cependant, peu importe le genre de programmeur que j'√©tais, si je n'en avais pas √©crit un autre.  Imaginons donc que son d√©veloppement soit justifi√©. </p><br><h2 id="1-vybor-platformy">  1. S√©lection de la plateforme </h2><br><p>  En fait, le choix √©tait restreint: Java ou C ++.  Sans y r√©fl√©chir √† deux fois, j'ai d√©cid√© de mettre en ≈ìuvre mon plan en Java, car  pour un d√©veloppement rapide, il offre toutes les possibilit√©s (√† savoir, la gestion automatique de la m√©moire et une plus grande simplicit√© par rapport au C ++, qui cache beaucoup de d√©tails de bas niveau et, par cons√©quent, permet de moins mettre l'accent sur le langage lui-m√™me et de ne penser qu'√† la logique m√©tier), et prend √©galement en charge les fen√™tres, les graphiques et l'audio pr√™ts √† l'emploi. </p><br><p>  Swing a √©t√© choisi pour impl√©menter l'interface graphique, car j'ai utilis√© Java 13, o√π JavaFX ne fait plus partie de la biblioth√®que, et ajouter des dizaines de m√©gaoctets d'OpenJFX en fonction de cela √©tait trop paresseux.  Ce n'√©tait peut-√™tre pas la meilleure solution, mais n√©anmoins. </p><br><p>  <em>La question se pose probablement: de quel type de moteur de jeu s'agit-il, mais sans acc√©l√©ration mat√©rielle?</em>  <em>La r√©ponse r√©side dans le manque de temps pour faire face √† OpenGL, ainsi que son absence de sens absolu: le FPS n'est pas important pour un roman visuel (en tout cas, avec autant d'animation et de graphisme que dans ce cas).</em> </p><br><h2 id="2-arhitektura-dvizhka-i-ego-realizaciya">  2. L'architecture du moteur et sa mise en ≈ìuvre </h2><br><h3 id="21-postanovka-zadachi">  2.1 √©nonc√© du probl√®me </h3><br><p>  Pour d√©cider comment faire quelque chose, vous devez d√©cider pourquoi.  C'est moi sur l'√©nonc√© du probl√®me, car  l'architecture n'est pas universelle, mais un moteur "sp√©cifique au domaine", par d√©finition, d√©pend directement du jeu envisag√©. </p><br><p>  Par moteur universel, je comprends le moteur qui prend en charge des concepts de relativement bas niveau, tels que "Game Object", "Scene", "Component".  Il a √©t√© d√©cid√© de ne pas en faire un moteur universel, car cela r√©duirait consid√©rablement le temps de d√©veloppement. </p><br><p>  Comme pr√©vu, le jeu devrait comprendre les parties suivantes: </p><br><p><img src="https://habrastorage.org/webt/w9/fh/l5/w9fhl5dhsu2tiua2kd9d8n5lfdq.png" alt="structure du jeu de roman visuel"></p><br><p>  Autrement dit, il y a un arri√®re-plan pour chaque sc√®ne, le texte principal, ainsi qu'un champ de texte pour la saisie utilisateur (le roman visuel a √©t√© pens√© pr√©cis√©ment avec une saisie utilisateur arbitraire, et pas un choix parmi les options propos√©es, comme c'est souvent le cas. Plus tard, je vais vous expliquer pourquoi il √©tait mauvais d√©cision).  Le diagramme montre √©galement qu'il peut y avoir plusieurs sc√®nes dans le jeu et, par cons√©quent, des transitions peuvent √™tre effectu√©es entre elles. </p><br><p>  <em>Remarque: Par sc√®ne, je veux dire la partie logique du jeu.</em>  <em>Le crit√®re de la sc√®ne peut √™tre le m√™me arri√®re-plan tout au long de cette partie.</em> </p><br><p>  Parmi les exigences du moteur figurait √©galement la possibilit√© de lire des messages audio et d'affichage (avec la fonction d'entr√©e utilisateur en option). </p><br><p>  Le d√©sir le plus important √©tait peut-√™tre le d√©sir d'√©crire la logique du jeu non pas en Java, mais dans un langage d√©claratif simple. </p><br><p>  Il y avait √©galement un d√©sir de r√©aliser la possibilit√© d'une animation proc√©durale, √† savoir le mouvement √©l√©mentaire des images, de sorte qu'au niveau Java, il serait possible de d√©terminer la fonction par laquelle la vitesse actuelle du mouvement est prise en compte (par exemple, pour que le graphique de vitesse soit droit, ou sinuso√Øde, ou autre). </p><br><p>  Comme pr√©vu, toutes les interactions avec les utilisateurs devaient se faire par le biais d'un syst√®me de dialogues.  Dans ce cas, le dialogue n'√©tait pas n√©cessairement consid√©r√© comme un dialogue avec le NPC ou quelque chose de similaire, mais g√©n√©ralement comme une r√©action √† toute entr√©e utilisateur pour laquelle le gestionnaire correspondant √©tait enregistr√©.  Pas clair  Cela deviendra plus clair bient√¥t. </p><br><h3 id="22-arhitektura-i-realizaciya">  2.2.  Architecture et impl√©mentation </h3><br><p>  Compte tenu de tout ce qui pr√©c√®de, vous pouvez diviser le moteur en trois parties relativement grandes qui correspondent aux m√™mes packages java: </p><br><ol><li> <code>display</code> - contient tout ce qui concerne la sortie √† l'utilisateur de toute information (graphique, texte et son), ainsi que la r√©ception de donn√©es de sa part.  Une sorte de (Voir), si on parle de MVC / MVP / etc. </li><li>  <code>initializer</code> - contient les classes dans lesquelles le moteur est initialis√© et lanc√©. </li><li>  <code>sl</code> - contient des outils pour travailler avec le langage de script (ci-apr√®s - SL). </li></ol><br><p>  Dans ce paragraphe, je consid√©rerai les deux premi√®res parties.  Je vais commencer par le second. </p><br><p>  La classe d'initialisation a deux m√©thodes principales: <code>initialize()</code> et <code>run()</code> .  Initialement, le contr√¥le vient de la classe du lanceur, d'o√π <code>initialize()</code> appel√© <code>initialize()</code> .  Apr√®s l'appel, l'initialiseur analyse les param√®tres pass√©s au programme (le chemin d'acc√®s au r√©pertoire avec les qu√™tes et le nom de la qu√™te √† ex√©cuter), charge le manifeste de la qu√™te s√©lectionn√©e (√† ce sujet un peu plus tard), initialise l'affichage, v√©rifie si la version linguistique (SL) requise par la qu√™te est prise en charge par les donn√©es interpr√®te, et enfin, lance un thread s√©par√© pour la console du d√©veloppeur. </p><br><p>  Imm√©diatement apr√®s cela, si tout s'est bien pass√©, le lanceur appelle la m√©thode <code>run()</code> , qui d√©clenche le chargement r√©el de la qu√™te.  Tout d'abord, il y a tous les scripts li√©s √† la qu√™te t√©l√©charg√©e (√† propos de la structure du fichier de qu√™te - ci-dessous), ils sont fournis √† l'analyseur, dont le r√©sultat est donn√© √† l'interpr√©teur.  Ensuite, l'initialisation de toutes les sc√®nes est lanc√©e et l'initialiseur termine l'ex√©cution de son flux, pour finalement suspendre le gestionnaire de touches Entr√©e √† l'√©cran.  Et donc, lorsque l'utilisateur appuie sur Entr√©e, la premi√®re sc√®ne est charg√©e, mais plus sur cela plus tard. </p><br><p>  La structure des fichiers de la qu√™te est la suivante: </p><br><p><img src="https://habrastorage.org/webt/3l/xo/nr/3lxonrfkeik_hwids4tire50dge.png" alt="structure des fichiers de qu√™te"></p><br><p>  Il y a un dossier s√©par√© pour la qu√™te, √† la racine duquel se trouve le manifeste, ainsi que trois dossiers suppl√©mentaires: <code>audio</code> - pour le son, <code>graphics</code> - pour la partie visuelle et les <code>scenes</code> - pour les scripts qui d√©crivent les sc√®nes. </p><br><p>  Je voudrais d√©crire bri√®vement le manifeste.  Il contient les champs suivants: </p><br><ul><li>  <code>sl_version_req</code> - Version SL n√©cessaire pour d√©marrer la qu√™te, </li><li>  <code>init_scene</code> - le nom de la sc√®ne √† partir de laquelle la qu√™te commence, </li><li>  <code>quest_name</code> - un beau nom de qu√™te qui appara√Æt dans le titre de la fen√™tre, </li><li>  <code>resolution</code> - la r√©solution de l'√©cran auquel la qu√™te est destin√©e (quelques mots √† ce sujet plus tard), </li><li>  <code>font_size</code> - taille de police pour tout le texte, </li><li>  <code>font_name</code> est le nom de la police pour tout le texte. </li></ul><br><p>  Il convient de noter que lors de l'initialisation de l'affichage, entre autres choses, le calcul de la r√©solution de rendu a √©t√© effectu√©: c'est-√†-dire que la r√©solution requise a √©t√© prise du manifeste et ins√©r√©e dans l'espace disponible pour la fen√™tre afin que: </p><br><ul><li>  le rapport d'aspect est rest√© le m√™me que dans la r√©solution du manifeste, </li><li>  tout l'espace disponible √©tait occup√© en largeur ou en hauteur. <br>  Gr√¢ce √† cela, le d√©veloppeur de la qu√™te peut √™tre s√ªr que ses images, par exemple 16: 9, seront affich√©es sur n'importe quel √©cran dans ce rapport. </li></ul><br><p>  De plus, lorsque l'affichage est initialis√©, le curseur est masqu√©, car il n'est pas impliqu√© dans le gameplay. </p><br><p>  En bref sur la console d√©veloppeur.  Il a √©t√© d√©velopp√© pour les raisons suivantes: </p><br><ol><li>  Pour le d√©bogage. </li><li>  Si quelque chose ne va pas pendant le jeu, il peut √™tre corrig√© via la console du d√©veloppeur. <br>  Il n'a impl√©ment√© que quelques commandes, √† savoir: la sortie des descripteurs d'un type sp√©cifique et de leur √©tat, la sortie des threads de travail, le red√©marrage de l'affichage et la commande la plus importante - <code>exec</code> , qui a permis d'ex√©cuter n'importe quel code SL dans la sc√®ne actuelle. </li></ol><br><p>  Ceci termine la description de l'initialiseur et des choses connexes, et nous pouvons passer √† la description de l'affichage. </p><br><p>  Sa structure finale est la suivante: </p><br><p><img src="https://habrastorage.org/webt/zz/qb/-1/zzqb-15nrxzhechuggvxgzoo-hg.png" alt="structure d'affichage"></p><br><p>  De l'√©nonc√© du probl√®me, nous pouvons conclure que tout ce qui devra √™tre fait est de dessiner des images, dessiner du texte, lire du son. </p><br><p>  Comment le texte / l'image est-il g√©n√©ralement dessin√© dans les moteurs universels et au-del√†?  Il existe une m√©thode de type <code>update()</code> , appel√©e chaque tick / step / frame / render / frame / etc et dans laquelle il y a un appel √† une m√©thode de type <code>drawText()</code> / <code>drawImage()</code> - cela garantit l'apparence du texte / image dans ce cadre.  Cependant, d√®s que l'appel √† de telles m√©thodes s'arr√™te, le rendu des choses correspondantes s'arr√™te. </p><br><p>  Dans mon cas, il a √©t√© d√©cid√© de faire un peu diff√©rent.  √âtant donn√© que pour les romans visuels, le texte et les images sont relativement permanents et sont presque tout ce que l'utilisateur voit (c'est-√†-dire qu'ils sont suffisamment importants), ils ont √©t√© cr√©√©s comme des objets de jeu - c'est-√†-dire des choses que vous avez juste besoin d'appara√Ætre et elles ne dispara√Ætront pas jusqu'√† ce que vous leur demandiez.  De plus, cette solution a simplifi√© la mise en ≈ìuvre. </p><br><p>  Un objet (du point de vue de la POO) qui d√©crit le texte / l'image est appel√© un descripteur.  Autrement dit, pour l'utilisateur du moteur d'API, seuls des descripteurs peuvent √™tre ajout√©s √† l'√©tat d'affichage et supprim√©s de celui-ci.  Ainsi, dans la version finale de l'affichage, il y a les descripteurs suivants (ils correspondent aux classes du m√™me nom): </p><br><div class="scrollable-table"><table><thead><tr><th>  Nom du descripteur: </th><th>  Description du descripteur: </th></tr></thead><tbody><tr><td> <code>ImageDescriptor</code> </td> <td>  Descripteur d'image: contient l'image ( <code>BufferedImage</code> ), position sur l'√©cran et largeur avec hauteur.  Cependant, lors de la cr√©ation, seule la largeur est d√©finie - la hauteur est calcul√©e proportionnellement √† la hauteur d'origine (et il n'y a aucun moyen d'√©tirer / compresser manuellement l'image de mani√®re disproportionn√©e, donc c'√©tait une mauvaise d√©cision). </td></tr><tr><td> <code>TextDescriptor</code> </td> <td>  Descripteur de texte: contient le texte, sa position et sa taille.  De plus, le texte n'est pas mis √† l'√©chelle en largeur et en hauteur, mais est coup√© lorsque vous allez au-del√† des bordures.  Le texte peut √™tre transf√©r√© par syllabes et simplement par des espaces, et d√©filer √©galement par les lignes. </td></tr><tr><td> <code>AudioDescriptor</code> </td> <td>  Un descripteur audio qui peut lire l'audio (une fois ou en boucle), le mettre en pause et le supprimer. </td></tr><tr><td> <code>AnimationDescriptor</code> </td> <td>  Une poign√©e d'animation qui, comme l'audio, peut √™tre boucl√©e.  Contient un objet qui impl√©mente l'animation et un descripteur d'image pour lequel l'animation est lue.  La m√©thode principale est <code>update(long)</code> , qui prend le nombre de millisecondes qui se sont √©coul√©es depuis le dernier appel <code>update(long)</code> .  Leur nombre est utilis√© pour calculer l'√©tat actuel de l'animation. </td></tr><tr><td> <code>InputDescriptor</code> </td> <td>  Descripteur d'entr√©e: est un champ de texte dans lequel le curseur est toujours √† la fin du texte.  Il convient √©galement de noter que le stockage et le rendu du texte √† partir du descripteur d'entr√©e sont effectu√©s via un descripteur de texte cr√©√© implicitement, afin de ne pas dupliquer la logique.  <em>Le plus dr√¥le, c'est que j'ai pris en compte la possibilit√© d'appuyer sur Retour arri√®re, mais je n'ai pas pris en compte Supprimer;</em>  <em>et lorsque Supprimer √©tait toujours enfonc√© pendant le jeu, ‚ñØ‚ñØ‚ñØ apparaissait dans le champ, car aucun traitement n'avait √©t√© effectu√© pour Supprimer et le personnage tentait de s'afficher sous forme de texte.</em> </td></tr><tr><td> <code>KeyAwaitDescriptor</code> </td> <td>  Un handle vers lequel la touche n√©cessaire est pass√©e (depuis <code>KeyEvent</code> ) et un rappel avec une certaine logique qui sera lanc√©e lorsque la touche correspondante sera enfonc√©e. </td></tr><tr><td> <code>PostWorkDescriptor</code> </td> <td>  Un handle qui accepte un rappel qui sera appel√© apr√®s le traitement de chaque tick. </td></tr></tbody></table></div><br><p>  L'affichage contient √©galement des champs pour le r√©cepteur d'entr√©e actuel (descripteur d'entr√©e) et un champ indiquant quel descripteur de texte a maintenant le focus et dont le texte d√©filera sous les actions correspondantes de la part de l'utilisateur. </p><br><p>  Le cycle de jeu ressemble √† ceci: </p><br><ol><li>  Traitement audio - appel de la m√©thode <code>update()</code> sur les descripteurs audio, qui v√©rifie l'√©tat actuel de l'audio, lib√®re de la m√©moire (si n√©cessaire) et effectue d'autres travaux techniques. </li><li>  Traitement des frappes - transf√©rez les caract√®res saisis vers un descripteur pour la r√©ception de l'entr√©e, le traitement des frappes pour les touches de d√©filement (fl√®ches haut et bas) et Retour arri√®re. </li><li>  Traitement d'animation. </li><li>  Effacement de l'arri√®re-plan dans le tampon de rendu ( <code>BufferedImage</code> servi de tampon). </li><li>  Dessiner des images. </li><li>  Rendu de texte. </li><li>  Dessiner des champs pour la saisie. </li><li>  La sortie du tampon √† l'√©cran. </li><li>  Gestion des <code>PostWorkDescriptor</code> . </li><li>  Certains travaux sur le remplacement des √©tats d'affichage, dont je parlerai plus tard (dans la section sur l'interpr√©teur SL). </li><li>  Arr√™tez le flux pendant une dur√©e calcul√©e dynamiquement afin que le FPS soit √©gal √† la valeur sp√©cifi√©e (30 par d√©faut). </li></ol><br><p>  <em>Remarque: Peut-√™tre que la question se pose: "Pourquoi rendre les champs de saisie si des descripteurs de texte appropri√©s ont √©t√© cr√©√©s pour eux et seront rendus une √©tape plus t√¥t?"</em>  <em>En fait, le rendu du paragraphe 7 ne se produit pas - seuls les <code>InputDescriptor</code> de <code>InputDescriptor</code> sont synchronis√©s avec les <code>InputDescriptor</code> de <code>InputDescriptor</code> - tels que la visibilit√© √† l'√©cran, la position, la taille et autres.</em>  <em>Cela a √©t√© fait, comme indiqu√© ci-dessus, parce que l'utilisateur ne contr√¥le pas directement le descripteur d'entr√©e correspondant avec un descripteur de texte et ne sait g√©n√©ralement rien √† ce sujet.</em> </p><br><p>  Il convient de noter que la taille et la position des √©l√©ments sur l'√©cran sont d√©finies non pas en pixels, mais en tailles relatives - des nombres de 0 √† 1 (diagramme ci-dessous).  Autrement dit, toute la largeur pour le rendu est 1, et toute la hauteur est 1 (et ils ne sont pas √©gaux, ce que j'ai oubli√© plusieurs fois et regrett√© plus tard).  Il serait √©galement int√©ressant de faire de (0,0) le centre, et la largeur / hauteur devrait √™tre √©gale √† deux, mais pour une raison quelconque, j'ai oubli√© / n'y ai pas pens√©.  Cependant, m√™me l'option avec une largeur / hauteur √©gale √† 1 a simplifi√© la vie du d√©veloppeur de qu√™te. </p><br><p><img src="https://habrastorage.org/webt/ay/ay/zy/ayayzykqpewkfcggqoxxz3mtcse.png" alt="syst√®me de coordonn√©es relatif"></p><br><p>  Quelques mots sur le syst√®me de lib√©ration de m√©moire. </p><br><p>  Chaque descripteur avait une <code>setDoFree(boolean)</code> , que l'utilisateur devait appeler s'il voulait d√©truire le descripteur donn√©.  La r√©cup√©ration de place pour les descripteurs d'un certain type s'est produite imm√©diatement apr√®s le traitement de tous les descripteurs de ce type.  De plus, l'audio qui a √©t√© lu une fois a √©t√© automatiquement supprim√© une fois la lecture termin√©e.  Exactement la m√™me chose que l'animation sans boucle. </p><br><p>  Ainsi, pour le moment, vous pouvez dessiner tout ce que vous voulez, mais ce n'est pas l'image ci-dessus, sur laquelle il n'y a qu'un arri√®re-plan, le texte principal et un champ de saisie.  Et voici le wrapper sur l'affichage, qui correspond √† la classe <code>DefaultDisplayToolkit</code> . </p><br><p>  Lorsqu'il est initialis√©, il ajoute simplement des descripteurs pour l'arri√®re-plan, le texte, etc. √† l'affichage. Il sait √©galement comment afficher les messages avec l'ic√¥ne facultative, le champ de saisie et le rappel. </p><br><p>  <em>Puis un petit bug est apparu, dont une correction compl√®te n√©cessiterait de refaire la moiti√© du syst√®me de rendu: si vous regardez l'ordre de rendu dans la boucle de jeu, vous pouvez voir que les images sont dessin√©es en premier et seulement ensuite le texte.</em>  <em>En m√™me temps, lorsque la bo√Æte √† outils affiche l'image, elle la place au milieu de l'√©cran en largeur et en <strong>hauteur</strong> .</em>  <em>Et s'il y a beaucoup de texte dans le message, il doit chevaucher partiellement le texte principal de la sc√®ne.</em>  <em>Cependant, √©tant donn√© que l'arri√®re-plan du message est une image (compl√®tement noire, mais n√©anmoins) et que les images sont dessin√©es avant le texte, un texte est superpos√© √† un autre (capture d'√©cran ci-dessous).</em>  <em>Le probl√®me a √©t√© partiellement r√©solu par un centrage vertical non pas sur l'√©cran, mais dans la zone <strong>au-dessus du</strong> texte principal.</em>  <em>Une solution compl√®te consisterait √† introduire un param√®tre de profondeur et √† refaire les rendus √† partir du mot ¬´compl√®tement¬ª.</em> </p><br><div class="spoiler">  <b class="spoiler_title">D√©monstration de superposition</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/la/t1/yn/lat1ynb6f3ivjxdvnhi4bsbjfvc.png" alt="chevauchement de texte"></p></div></div><br><p>  Peut-√™tre s'agit-il de l'affichage, enfin, de tout.  Vous pouvez passer √† la langue, l'int√©gralit√© de l'API pour travailler avec qui est contenue dans le package <code>sl</code> . </p><br><h2 id="3-skriptovyy-yazyk">  3. Langage de script </h2><br><p>  <em>Remarque: Si le respect√©% USERNAME% le lit ici, il a bien fait, et je lui demanderais de ne pas arr√™ter de le faire: maintenant ce sera beaucoup plus int√©ressant qu'auparavant.</em> </p><br><h3 id="31-yazyk">  3.1.  La langue </h3><br><p>  Au d√©part, je voulais faire un langage d√©claratif dans lequel il suffirait d‚Äôindiquer tous les param√®tres n√©cessaires √† la sc√®ne, et c‚Äôest tout.  Le moteur prendrait toute la logique.  Cependant, √† la fin, je suis arriv√© au langage proc√©dural, m√™me avec des √©l√©ments OOP (√† peine distinguables), et c'√©tait une bonne solution, car, par rapport √† l'option d√©clarative, cela permettait beaucoup plus de flexibilit√© dans la logique du jeu. </p><br><p>  La syntaxe du langage a √©t√© pens√©e de mani√®re √† √™tre aussi simple que possible pour l'analyse, ce qui est logique, compte tenu du temps disponible. </p><br><p>  Ainsi, le code est stock√© dans des fichiers texte avec l'extension SSF;  chaque fichier contient une description d'une ou plusieurs sc√®nes;  chaque sc√®ne contient z√©ro ou plusieurs actions;  chaque action contient z√©ro ou plusieurs op√©rateurs. </p><br><p>  Une petite explication sur les termes.  Une action n'est qu'une proc√©dure sans possibilit√© de passer des arguments (en aucun cas emp√™ch√© le d√©veloppement du jeu).  L'op√©rateur n'est apparemment pas tout √† fait ce que ce mot signifie dans les langues ordinaires (+, -, /, *), mais la forme est la m√™me: l'op√©rateur est la totalit√© de son nom et de tous ses arguments. </p><br><p>  Peut-√™tre que vous avez h√¢te de voir enfin le code source de SL, le voici: </p><br><pre> <code class="plaintext hljs">scene dungeon { action init { load_image "background" "dungeon/background.png" load_image "key" "dungeon/key.png" load_audio "background" "dungeon/background.wav" load_audio "got_key" "dungeon/got_key.wav" } action first_come { play "background" loop set_background "background" set_text "some text" add_dialog "(||(|) (||-))" "dial_look_around" dial_look_around on } //some comment action dial_look_around { play "got_key" once show "some text 2" "key" none tag "key" switch_dialog "dial_look_around" off } }</code> </pre> <br><p>  Maintenant, il devient clair ce qu'est l'op√©rateur.  On voit √©galement que chaque action est un bloc d'instructions (une instruction peut √™tre un bloc d'instructions), ainsi que le fait que les commentaires sur une seule ligne sont pris en charge (cela n'avait pas de sens de saisir des commentaires sur plusieurs lignes, d'ailleurs, je n'ai pas utilis√© ceux sur une seule ligne). </p><br><p>  Par souci de simplification, un concept de ¬´variable¬ª n'a pas √©t√© introduit dans le langage;  par cons√©quent, toutes les valeurs utilis√©es dans le code sont des litt√©raux.  Selon le type, les litt√©raux suivants sont distingu√©s: </p><br><div class="scrollable-table"><table><thead><tr><th>  Nom litt√©ral: </th><th>  Remarque: </th></tr></thead><tbody><tr><td>  Litt√©ral de cha√Æne </td><td>  La possibilit√© d'√©chapper les guillemets et les barres obliques (\\) est incluse, il est √©galement possible d'ins√©rer un trait d'union dans le texte </td></tr><tr><td>  Entier litt√©ral </td><td>  Prend en charge les nombres n√©gatifs </td></tr><tr><td>  Litt√©ral en virgule flottante </td><td>  Prend en charge les nombres n√©gatifs </td></tr><tr><td>  Aucun litt√©ral </td><td>  Le code est repr√©sent√© comme <code>none</code> </td></tr><tr><td>  Litt√©ral bool√©en </td><td>  Dans le code - <code>on</code> / <code>off</code> pour vrai / faux, respectivement </td></tr><tr><td>  Litt√©ral g√©n√©ral </td><td>  Si un litt√©ral n'appartient √† aucun des types ci-dessus et se compose des lettres de l'alphabet anglais, des chiffres et du trait de soulignement, il s'agit d'un litt√©ral g√©n√©ral. </td></tr></tbody></table></div><br><p>  Quelques mots sur l'analyse de la langue.  Il existe plusieurs niveaux de "chargement" du code (sch√©ma ci-dessous): </p><br><ol><li>  Un tokenizer est une classe modulaire pour diviser le code source en jetons (les unit√©s s√©mantiques minimales du langage).  Chaque type de jeton est associ√© √† un num√©ro - son type.  Pourquoi modulaire?  Parce que les parties du tokenizer qui v√©rifient si une partie du code source est un token d'un certain type sont isol√©es du tokenizer et t√©l√©charg√©es de l'ext√©rieur (√† partir du deuxi√®me paragraphe). </li><li>  Le module compl√©mentaire tokenizer est une classe qui d√©finit l'apparence de chaque type de jeton dans SL;  au niveau inf√©rieur utilise un tokenizer.  Voici √©galement le filtrage des jetons spatiaux et l'omission des commentaires sur une seule ligne.  La sortie donne un flux propre de jetons, qui est utilis√© dans ... </li><li>  ... un analyseur (il est √©galement modulaire), qui produit un arbre de syntaxe abstrait √† la sortie.  Modulaire - car en soi, il ne peut analyser que les sc√®nes et les actions, mais il ne sait pas comment analyser les op√©rateurs.  Par cons√©quent, des modules y sont charg√©s (en fait, il les charge lui-m√™me dans le constructeur, ce qui n'est pas tr√®s bon), ce qui permet d'analyser chacun de ses op√©rateurs. </li></ol><br><p><img src="https://habrastorage.org/webt/3c/vz/u-/3cvzu-qk5wgwwtgpn_dndl3aan8.png" alt="pipeline d'analyse du langage de script"></p><br><p>  Maintenant, bri√®vement sur les op√©rateurs, afin qu'une id√©e de la fonctionnalit√© du langage apparaisse.  Au d√©part, il y avait 11 op√©rateurs, puis en train de r√©fl√©chir au jeu, certains d'entre eux ont fusionn√© en un seul, certains ont chang√© et 9 autres ont √©t√© ajout√©s.  Voici le tableau r√©capitulatif: </p><br><div class="scrollable-table"><table><thead><tr><th>  Nom de l'op√©rateur: </th><th>  Remarque: </th></tr></thead><tbody><tr><td> <code>load_image</code> </td> <td>  Charge une image en m√©moire </td></tr><tr><td> <code>load_audio</code> </td> <td>  Charge l'audio en m√©moire </td></tr><tr><td> <code>set_text</code> </td> <td>  D√©finit le texte principal de la sc√®ne. </td></tr><tr><td> <code>set_background</code> </td> <td>  D√©finit l'arri√®re-plan de la sc√®ne. </td></tr><tr><td> <code>play</code> </td> <td>  Lit l'audio (peut jouer une fois ou une lecture en boucle) </td></tr><tr><td> <code>show</code> </td> <td>  Affiche un message avec un rappel (en SL) et une image facultative (appel√©e apr√®s que l'utilisateur a ferm√© le message) </td></tr><tr><td> <code>tag</code> </td> <td>  D√©finit une balise (√©tiquette).  Elle peut √™tre consid√©r√©e comme une variable globale avec le nom sp√©cifi√©, qui ne stocke aucune valeur.  Ceci est utile dans diff√©rents cas: par exemple, vous pouvez marquer de cette mani√®re si le joueur a trouv√© la cl√© de la porte, s'il √©tait d√©j√† √† cet endroit, etc. </td></tr><tr><td>  <code>if_tag</code> / <code>if_tag_n</code> </td><td>  Op√©rateurs de branchement qui vous permettent de faire quelque chose selon que la balise correspondante est install√©e.  <code>else</code> branche est prise en charge.  <code>if_tag</code> est ex√©cut√© si la balise est d√©finie, <code>if_tag_n</code> - vice versa </td></tr><tr><td> <code>add_dialog</code> </td> <td>  Vous permet d'ajouter un dialogue √† la sc√®ne.  √Ä leur sujet un peu plus tard </td></tr><tr><td> <code>goto</code> </td> <td>  Transition vers une autre sc√®ne </td></tr><tr><td> <code>call</code> </td> <td>  Appel d'action personnalis√© </td></tr><tr><td> <code>call_extern</code> </td> <td>  Invoquer une action d'une autre sc√®ne. </td></tr><tr><td> <code>stop_all</code> </td> <td>  Arr√™tez de jouer tous les sons / musique </td></tr><tr><td> <code>show_motion</code> </td> <td>  Affiche et d√©place l'image d'un point √† un autre dans le temps sp√©cifi√© (dur√©e) (avec un rappel facultatif qui est appel√© √† la fin du mouvement) </td></tr><tr><td> <code>animate</code> </td> <td>  Anime une image pr√©c√©demment affich√©e via <code>show_motion</code> .  A partir des options: vous pouvez sp√©cifier le type d'animation - <code>v_motion</code> / <code>h_motion</code> (mouvement vertical / horizontal par fonction <math></math><img src="https://habrastorage.org/getpro/habr/formulas/777/e54/b66/777e54b662d4cedf5c0fcf0f9c34f54a.svg" alt="2t ^ 3-3t ^ 2 $" data-tex="inline">  ), la possibilit√© de bouclage, une indication de la dur√©e (dur√©e) pendant laquelle l'animation doit √™tre jou√©e.  Il est possible de transmettre une valeur num√©rique (une, car il n'y a aucun moyen de passer un nombre variable d'arguments, donc c'est en partie une b√©quille) √† une animation (pour chaque animation cela signifie des choses diff√©rentes) et un rappel optionnel (appel√© lorsque l'animation est jou√©e). </td></tr></tbody></table></div><br><p>  Op√©rateurs pour travailler avec des compteurs - variables enti√®res sp√©cifiques √† la sc√®ne. </p><br><div class="scrollable-table"><table><thead><tr><th>  Nom de l'op√©rateur: </th><th>  Remarque: </th></tr></thead><tbody><tr><td> <code>counter_set</code> </td> <td>  Cr√©er un compteur et l'initialiser avec une certaine valeur </td></tr><tr><td> <code>counter_add</code> </td> <td>  Ajout d'une valeur √† un compteur </td></tr><tr><td> <code>if_counter &lt;modifier&gt;</code> </td> <td>  Capable de comparer les valeurs de deux compteurs / nombres / nombres et d'un compteur.  <code>&lt;modifier&gt;</code> est un litt√©ral g√©n√©ral et a la forme <code>eq/gr/ls[_n]</code> , o√π <code>eq</code> sont √©gaux, <code>gr</code> est sup√©rieur √†, <code>ls</code> est inf√©rieur √†, <code>_n</code> est la n√©gation (par exemple, <code>gr_n</code> n'est pas sup√©rieur).  Comme vous pouvez le voir, tout a √©t√© simplifi√© autant que possible. </td></tr></tbody></table></div><br><p>  Il y avait aussi l'id√©e d'introduire une <code>return</code> (la fonctionnalit√© correspondante a m√™me √©t√© ajout√©e au niveau de base de l'interpr√©teur), mais j'ai oubli√©, et ce n'√©tait pas utile. </p><br><p>           ,      ,     :  <code>show_motion</code>      (, , 0.01)         <code>duration</code> . </p><br><p>          ,   (lookup)  (  ):      ///,        <code>load_audio</code> / <code>load_image</code> / <code>counter_set</code> / <code>add_dialog</code> .   ,       ,   ,    , ‚Äî . .        ,     . , : " <code>scene_coast.dialog_1</code> " ‚Äî  <code>dialog_1</code>   <code>scene_coast</code> . </p><br><p>           SL-,   . , ,       , ‚Äî       .     :       (-, ),   ,       <code>lookup</code> ', ,  ,  .      ,            <code>goto</code>  <code>lookup</code> ',        . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p>    -      ‚Äî - ,        ,       <code>n</code>  ( )    .             ,     ,       <code>n</code>   .   ,  . </p></div></div><br><p>   .     : </p><br><pre> <code class="plaintext hljs">add_dialog "regexp" "dialog_name" callback on/off</code> </pre> <br><p>     ,                  . ,     :     ,   ,      ,     ( ). </p><br><p>  ,    ,        ( )    ( )   ,    ( ).         :         ,    ,     , ""   "". </p><br><p><img src="https://habrastorage.org/webt/qw/nk/y6/qwnky6dhlw8amlkbhcnb3ex4tvs.png" alt="dialogs system work"></p><br><p> <em>,       ( ,  )</em> </p><br><p>     ,  "": </p><br><pre> <code class="plaintext hljs">(||((|||) ( )?(||)?)|(||)( )?|  )</code> </pre> <br><p>  *** </p><br><p>   ,     :  ‚Äî ,      ,   ‚Äî . </p><br><p> <em>,       :      </em> </p><br><h3 id="32-interpretator">  3.2.  </h3><br><p>      :   ,  ‚Äî  ""  (   ).  <em></em>           . </p><br><p>   SL    ,     - .  : </p><br><ol><li> <code>init</code> ‚Äî           ,    (  ,      , ,     ). </li><li> <code>first_come</code> ‚Äî ,      .     ,  ,     . </li><li>       ,     : <code>come</code> ‚Äî    ,     ( ). </li></ol><br><p> <em>: <code>init</code>  <code>first_come</code> ‚Äî     ,          .</em> </p><br><p>         .     :      ,    ,    <strong></strong>  <code>init</code> -.  ,  <strong></strong>    (   )    . </p><br><p>  ,     <code>n</code> ,        <code>first_come</code> - (  -       -     ).       .  ,   :       ,        ,  <code>first_come</code>  <code>come</code> ,   <code>come</code> ( ).    :        ,             ,         ,       . </p><br><p>          (,    "", " ", "  "  . .).  ,      ,   -    - .    ,             ( ),          . </p><br><p>              (, ,    ).   :        ?       ,        ,      .      <code>provideState</code>  ,        ;  <strong></strong>           ,      . </p><br><p> <em>      ,  ,     ,     ,    (    ,    ),         (, ,      ,    ).</em> </p><br><h2 id="4-razrabotka-igry"> 4.   </h2><br><p>          .   2019-  2018-,      ,  ,    . </p><br><h3 id="41-istoriya-i-razrabotka-logiki-igry">  4.1.      </h3><br><p>     ,  ,    , ‚Äî  .             ,      .      (  ),      , <del>  </del>     - , 9  (),      -  (   ,     ( , , )  . </p><br><p>  ,   :     ,       ,   ,     .           ,       ,     . </p><br><p>  ,        25% (5)  ,  :  ,   ;   ( <code>animate</code> ),      ( <code>call_extern</code> ). </p><br><p>   ,     -     ( ),      (,   ,   ‚Äî  ,  "You won"). </p><br><p><img src="https://habrastorage.org/webt/0g/la/gv/0glagv3q6tcjirb_qezojplz8tc.png" alt="demo visual novel"></p><br><h3 id="42-grafika">  4.2.  Graphisme </h3><br><p>          ,     : </p><br><p><img src="https://habrastorage.org/webt/pz/fw/qi/pzfwqi8pkcr7le0xjkjmkd8w-h8.png" alt="stubs for graphics"></p><br><p>      ,    ,    -   -    " ".     : </p><br><ul><li>      (4x2.23''),         . </li><li>       : ,    , ‚Äî     . </li><li>            ////etc. </li></ul><br><p><img src="https://habrastorage.org/webt/e9/ry/rv/e9ryrv-13waaticfbp04vhwq5tu.png" alt="usage of art brushes"></p><br><ul><li>    ,    ,     . </li></ul><br><p><img src="https://habrastorage.org/webt/th/hj/jm/thhjjmkujbdjdo4eqvksclai7pq.png" alt="a character from the visual novel"></p><br><ul><li> ,        .      ,     , ,       .     . </li></ul><br><h2 id="5-statistika-i-itogi"> 5.    </h2><br><p>        ( 11 )    30  40 .    9    4  55 .     (  )  7  41 .   ‚Äî ~4-6  (    45   ). </p><br><p> <em>:      "Darkyen's Time Tracker"   JetBrains (  ).</em> <br> <em>:       2    ,    ‚Äî     .   45        8 .</em> </p><br><p>      : 4777,   ( ) ‚Äî 637. </p><br><p> <em>:     <code>cloc</code> .</em> </p><br><p>    30   .    (  ) :  ‚Äî ~8 ,      ‚Äî ~24 ,   (     ) ‚Äî ~8 .     . </p><br><p>   ‚Äî 232  (  - ,   WAV). </p><br><div class="spoiler"> <b class="spoiler_title"> WAV?</b> <div class="spoiler_text"><p>       <code>javax.sound.sampled.AudioSystem</code> ,    WAV  AU ,    WAV. </p></div></div><br><p>   28  (  3  ).          ‚Äî           17  /. </p><br><p>         -  :        ,        .  , ,   "   ",     " ".     (,   ),          (     ""/""  - ). </p><br><div class="spoiler"> <b class="spoiler_title">      ?</b> <div class="spoiler_text"><p>   ‚Äî      ,    .      :        . . ,       ,       ""    :        NPC,      ,       (,    ‚Äî    ..). </p></div></div><br><p>   ,      :  ,      . </p><br><p>    ‚Äî  .     ,  :  ,  ,  ,   .              . ,        ,     , , , . </p><br><p>   .       (        ),    : </p><br><ul><li>  .  Pas du tout.  . </li><li>     .              ,    . </li><li>   ,       . </li></ul><br><p> <em>,             ,  .</em> </p><br><p>           <a href="https://github.com/wcobalt/stepper" rel="nofollow">GitHub</a> . </p><br><p>        (assets)  <a href="https://github.com/wcobalt/stepper/releases" rel="nofollow"> "Releases"</a>   "v1.0"  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483818/">https://habr.com/ru/post/fr483818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483798/index.html">Comment automatiser la composition d'annonces dans Google Ads</a></li>
<li><a href="../fr483800/index.html">Ne dors pas! Comment nous avons appris √† publier 12 000 offres de billets par nuit</a></li>
<li><a href="../fr483802/index.html">Comment lancer un produit seul si vous √™tes d√©veloppeur: conseils du cr√©ateur de Laravel, Taylor Otvel. Partie 1: Public</a></li>
<li><a href="../fr483804/index.html">Richard Hamming "Chapitre inexistant": Comme nous savons ce que nous savons (11-20 minutes sur 40)</a></li>
<li><a href="../fr483814/index.html">Abraham Flexner: l'utilit√© des connaissances inutiles (1939)</a></li>
<li><a href="../fr483820/index.html">Ce qui affecte l'√©mission de cr√©dit. Aper√ßu de la concurrence pour le risque de d√©faut de cr√©dit</a></li>
<li><a href="../fr483822/index.html">5 fonctionnalit√©s JavaScript sans lesquelles je ne pouvais pas √©crire de code</a></li>
<li><a href="../fr483826/index.html">Connexion d'un capteur de CO2 mod√®le MH-Z19B √† l'aide de la sortie analogique Vo</a></li>
<li><a href="../fr483828/index.html">√âchanges atomiques de brillance et de pauvret√©</a></li>
<li><a href="../fr483832/index.html">RxJava √† Coroutines: migration des fonctionnalit√©s de bout en bout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>