<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòæ ü§∂üèΩ üßëüèø‚Äçü§ù‚Äçüßëüèº Salir de tu zona de confort: de nodejs a dlang üßöüèª ‚òòÔ∏è üíø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2017, comenc√© a escribir un proyecto en nodejs, una implementaci√≥n del protocolo Weinzierl ObjectServer para acceder a los valores KNX. Durante el ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Salir de tu zona de confort: de nodejs a dlang</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459014/"><p>  En 2017, comenc√© a escribir un proyecto en nodejs, una implementaci√≥n del protocolo Weinzierl ObjectServer para acceder a los valores KNX.  Durante el proceso de escritura, estudiamos: trabajar con protocolos binarios, presentar datos, trabajar con sockets (sockets unix en particular), trabajar con la base de datos redis y canales pub / sub. </p><br><p>  El proyecto ha alcanzado una versi√≥n estable.  En este momento, lentamente elijo otros idiomas, en particular Dart and Flutter como su aplicaci√≥n.  En el estante espolvoreado sin acci√≥n comprada en el momento del manual del estudiante G. Schildt. </p><br><p>  Un pensamiento persistente para reescribir el proyecto en C se instal√≥ en mi cabeza.  Considero las opciones Go, Rust, repeler otras construcciones sint√°cticas.  No hay forma de comenzar, la idea se pospone por un tiempo. </p><a name="habracut"></a><br><p>  En mayo de este a√±o, decid√≠ mirar el lenguaje D, por alguna raz√≥n convencido de que la letra D significa din√°mico.  Durante mucho tiempo me pregunt√© d√≥nde y por qu√© este pensamiento estaba en mi cabeza, as√≠ que no encontr√© una respuesta.  PERO esto ya no es importante, ya que me dej√© llevar por la transcripci√≥n durante todo el verano. </p><br><h2 id="sut-proekta">  La esencia del proyecto. </h2><br><p> Los m√≥dulos KNX BAOS 830/832/838 est√°n conectados a trav√©s de UART a una computadora, el protocolo ObjectServer est√° envuelto en FT1.2.  La aplicaci√≥n establece una conexi√≥n con <code>/dev/ttyXXX</code> , procesa los datos entrantes, env√≠a los bytes de la solicitud del usuario convertidos al canal PUB / SUB a la misma cola desde mensajes JSON, o a la cola de trabajos basada en listas Redis (para nodejs, las colas se implementan usando el paquete de cola de abejas ) </p><br><pre> <code class="javascript hljs">queue.on(<span class="hljs-string"><span class="hljs-string">"job"</span></span>, data =&gt; { <span class="hljs-comment"><span class="hljs-comment">//   : //  ,     //  ,      }); baos.on("data", data =&gt; { // ,  :    //  ,      //   -     pub/sub });</span></span></code> </pre> <br><h2 id="dinamichnost">  Dinamismo </h2><br><p>  JSON en js es una cosa nativa; no ten√≠a idea de c√≥mo ocurre el procesamiento en lenguajes est√°ticamente escritos.  Al final result√≥ que, una peque√±a diferencia.  Por ejemplo, tome el m√©todo <code>get value</code> .  Como argumentos, toma un n√∫mero: el n√∫mero de punto de fecha o una matriz de n√∫meros. </p><br><p>  En js, se realizan verificaciones: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.isArray(payload)) { <span class="hljs-comment"><span class="hljs-comment">//     return values; } if (typeof id === "number") { //     return value; } throw new Error(" id");</span></span></code> </pre> <br><p>  Esencialmente lo mismo en D: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.type() == JSONType.integer) { <span class="hljs-comment"><span class="hljs-comment">//    } else if (payload.type() === JSONType.array) { //    } else { throw Errors.wrong_payload_type; }</span></span></code> </pre> <br><p>  Por alguna raz√≥n, en el momento de Rust, una consideraci√≥n, fue la falta de comprensi√≥n de trabajar con JSON lo que me retras√≥.  Otro punto relacionado con el dinamismo: las matrices.  En js, te acostumbras al hecho de que es suficiente llamar al m√©todo <code>push</code> para agregar un elemento.  En C, el dinamismo se implementa mediante la asignaci√≥n manual de memoria, pero realmente no quer√≠a escalar all√≠.  Dlang, como result√≥, admite matrices din√°micas. </p><br><pre> <code class="cpp hljs">ubyte[] res; <span class="hljs-comment"><span class="hljs-comment">//   -     res.length = 1000; //        res.length = count; //        1</span></span></code> </pre> <br><p>  Los datos UART entrantes en js se convirtieron a <code>Object</code> .  Para estos fines, las estructuras, las enumeraciones con valores y las uniones son excelentes en D. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OS_Services { unknown, GetServerItemReq = <span class="hljs-number"><span class="hljs-number">0x01</span></span>, GetServerItemRes = <span class="hljs-number"><span class="hljs-number">0x81</span></span>, SetServerItemReq = <span class="hljs-number"><span class="hljs-number">0x02</span></span>, SetServerItemRes = <span class="hljs-number"><span class="hljs-number">0x82</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ... } // ... struct OS_Message { OS_Services service; OS_MessageDirection direction; bool success; union { // union of possible service returned structs // DatapointDescriptions/DatapointValues/ServerItems/ParameterBytes OS_DatapointDescription[] datapoint_descriptions; OS_DatapointValue[] datapoint_values; OS_ServerItem[] server_items; Exception error; }; }</span></span></code> </pre> <br><p>  Con un mensaje entrante: </p><br><pre> <code class="cpp hljs">ubyte mainService = data.read!ubyte(); ubyte subService = data.read!ubyte(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mainService == OS_MainService) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(subService) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OS_Services.GetServerItemRes: result.direction = OS_MessageDirection.response; result.service= OS_Services.GetServerItemRes; result.success = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; result.server_items = _processServerItemRes(data); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OS_Services.SetServerItemRes: result.direction = OS_MessageDirection.response; <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  En js, almacen√© los valores de bytes en una matriz, con los datos entrantes hice una b√∫squeda y devolv√≠ una cadena con el nombre del servicio.  Las estructuras, enumeraciones y asociaciones se ven m√°s estrictas. </p><br><h2 id="rabota-s-massivami-baytovyh-dannyh">  Trabajar con conjuntos de datos de bytes </h2><br><p>  Node.js Me gusta la abstracci√≥n de <code>Buffer</code> .  Por ejemplo: es conveniente realizar la conversi√≥n de dos bytes a un entero sin signo utilizando el <code>readUInt16BE(offset)</code> , para escribir - <code>writeUInt16BE(value, offset)</code> , buffers utilizados activamente para trabajar con el protocolo binario.  Para dlang, inicialmente comenc√© paquetes de repositorio lanudo a algo similar.  La respuesta se encontr√≥ en la biblioteca est√°ndar <code>std.bitmanip</code> .  Para enteros sin signo de 2 bytes de longitud: <code>ushort start = data.read!ushort()</code> , para escribir: <code>result.write!ushort(start, 2);</code>  donde el segundo argumento es el desplazamiento. </p><br><h2 id="ee-promises-asyncawait">  EE, promesas, as√≠ncrono / espera. </h2><br><p>  La peor parte fue programar sin un <code>EventEmitter</code> .  En node.js, las funciones de escucha simplemente se registran y, en un evento, se llaman.  Por lo tanto, uno no tiene que pensar mucho.  Los paquetes dlang tinylis y <code>serialport</code> (dependencias de mi aplicaci√≥n) tienen m√©todos sin bloqueo para procesar mensajes.  La soluci√≥n es simple: por ahora, es cierto recibir mensajes de puerto serie y pub / subcanal a su vez.  En el caso de una solicitud de usuario entrante al canal pub / sub, el programa debe enviar un mensaje al puerto serie, obtener el resultado y enviar al usuario nuevamente a pub / sub.  Se decidi√≥ realizar los m√©todos para el bloqueo de solicitudes en serie. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!(_responseReceived || _resetInd || _interrupted)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { processIncomingData(); processIncomingInterrupts(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_resetInd || _interrupted) { _response.success = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _response.service = OS_Services.unknown; _response.error = Errors.interrupted; _responseReceived = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _ackReceived = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ... // ... return _response;</span></span></code> </pre> <br><p>  En un ciclo while, los datos se sondean mediante el m√©todo sin bloqueo <code>processIncomingData()</code> .  Tambi√©n se proporciona la probabilidad de que el m√≥dulo KNX se pueda reiniciar (desconectado y reconectado al bus o software KNX).  Adem√°s, el controlador <code>processIncomingInterrupts()</code> comprueba el servicio pub / sub channel para una solicitud de <code>reset</code> .  Sin promesas ni funciones asincr√≥nicas, a diferencia de las implementaciones js anteriores.  Tuve que pensar en la estructura del programa (es decir, la secuencia de llamadas a funciones), pero, debido a la ausencia de abstracciones innecesarias, se hizo m√°s f√°cil programar.  De hecho, cuando <code>await someAsyncMethod</code> se llama a <code>await someAsyncMethod</code> en el c√≥digo js, ‚Äã‚Äãla funci√≥n asincr√≥nica se llama bloqueo y pasa por el bucle de eventos.  La posibilidad misma del lenguaje es buena, pero puedes prescindir de ella. </p><br><h2 id="otlichiya">  Las diferencias </h2><br><p>  Cola de trabajo  La implementaci√≥n de node.js utiliza el paquete <code>bee-queue</code> para este prop√≥sito.  En una implementaci√≥n en D, las solicitudes se env√≠an solo a trav√©s de pub / sub. <br>  De lo contrario, todo es casi id√©ntico. </p><br><p>  La versi√≥n compilada consume 10 veces menos RAM, lo que puede ser importante para las computadoras de una sola placa. </p><br><h2 id="kompilyaciya">  Compilaci√≥n </h2><br><p>  La compilaci√≥n se realiz√≥ usando ldc en la plataforma aarch64. </p><br><p>  Para instalar ldc: </p><br><pre> <code class="plaintext hljs">curl -fsS https://dlang.org/install.sh | bash -s ldc</code> </pre> <br><p>  Se ensambl√≥ una placa base, que constaba de tres componentes principales: NanoPi Neo Core2 como computadora, el m√≥dulo KNX BAOS 830 para la comunicaci√≥n con el bus KNX y Silvertel Ag9205 para alimentaci√≥n PoE, en la que se realiz√≥ la programaci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Apariencia del tablero</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/zc/1n/0f/zc1n0f_fs3uyx8pbk02-54_l9dm.jpeg"></p></div></div><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  No juzgar√© qu√© idioma es mejor o peor.  Para cada uno lo suyo: js es ideal para estudiar, el nivel de abstracciones (promesas, emisores) le permite construir f√°cil y r√°pidamente la estructura de la aplicaci√≥n.  Me acerqu√© a la implementaci√≥n de dlang con un plan claro y memorizado para un a√±o y medio, qu√© hacer.  Cuando sabe qu√© datos deben procesarse y c√≥mo, la escritura est√°tica no da miedo.  Los m√©todos sin bloqueo le permiten organizar un ciclo de trabajo.  Este fue mi primer trabajo en D, un trabajo fascinante e informativo. </p><br><p>  En cuanto a salir de la zona de confort (como se indica en el t√≠tulo): en mi caso, el miedo ten√≠a grandes ojos, lo que durante mucho tiempo me impidi√≥ intentar algo diferente a nodejs. </p><br><p>  Los c√≥digos fuente est√°n abiertos y se pueden encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/dobaos/dobaos</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/459014/">https://habr.com/ru/post/459014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458996/index.html">User Inyerface: c√≥mo no atormentar al usuario</a></li>
<li><a href="../459000/index.html">C√≥mo intent√© mejorar Halo 2, pero casi lo arruin√©</a></li>
<li><a href="../459002/index.html">C√≥mo configurar HTTPS - SSL Configuration Generator ayudar√°</a></li>
<li><a href="../459004/index.html">Algoritmo criptogr√°fico Grasshopper: casi el complejo</a></li>
<li><a href="../459012/index.html">Crear una aplicaci√≥n para Bitrix24 desde cero</a></li>
<li><a href="../459018/index.html">T√°cticas de rol de escritorio</a></li>
<li><a href="../459020/index.html">Por qu√© DFSR no replica algunos archivos y c√≥mo lidiar con ellos</a></li>
<li><a href="../459022/index.html">Comunicaci√≥n de video ojo a ojo: intenta resolver el problema de la falta de contacto visual</a></li>
<li><a href="../459024/index.html">C√≥mo atravesamos el Gran Cortafuegos chino (parte 3)</a></li>
<li><a href="../459028/index.html">Asignaci√≥n de memoria est√°tica en microcontroladores.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>