<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ¨ üè° üåö Herstellen einer Verbindung zu einem Unternehmens-VPN unter Linux mithilfe von openconnect und vpn-slice üßëüèΩ‚Äçü§ù‚Äçüßëüèª üîâ üë©üèø‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sie m√∂chten Linux bei der Arbeit verwenden, ein Unternehmens-VPN jedoch nicht? Dann kann dieser Artikel helfen, obwohl dies nicht korrekt ist. Ich m√∂c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Herstellen einer Verbindung zu einem Unternehmens-VPN unter Linux mithilfe von openconnect und vpn-slice</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479034/"><p>  Sie m√∂chten Linux bei der Arbeit verwenden, ein Unternehmens-VPN jedoch nicht?  Dann kann dieser Artikel helfen, obwohl dies nicht korrekt ist.  Ich m√∂chte im Voraus warnen, dass ich die Probleme der Netzwerkadministration schlecht verstehe, sodass es m√∂glich ist, dass ich alles falsch gemacht habe.  Andererseits ist es m√∂glich, dass ich das Handbuch so schreibe, dass es f√ºr normale Menschen verst√§ndlich ist. Daher rate ich Ihnen, es auszuprobieren. </p><br><p>  Der Artikel enth√§lt viele zus√§tzliche Informationen, aber ohne dieses Wissen w√§re ich nicht in der Lage, die Probleme zu l√∂sen, die ich pl√∂tzlich mit der VPN-Einstellung hatte.  Ich denke, dass jeder, der versucht, dieses Handbuch anzuwenden, Probleme hat, die ich nicht hatte, und ich hoffe, dass diese zus√§tzlichen Informationen dazu beitragen, diese Probleme auf eigene Faust zu l√∂sen. </p><br><p>  Die meisten im Handbuch verwendeten Befehle m√ºssen √ºber sudo ausgef√ºhrt werden, das der K√ºrze halber entfernt wurde.  Denken Sie daran. </p><br><p>  Die meisten IP-Adressen waren stark verschleiert. Wenn Sie also eine Adresse wie 435.435.435.435 sehen, sollte es f√ºr Ihren Fall eine normale IP-Adresse geben. </p><br><p>  Ich habe Ubuntu 18.04, aber ich denke, mit ein paar √Ñnderungen kann der Leitfaden auf andere Distributionen angewendet werden.  In diesem Text ist jedoch Linux == Ubuntu. </p><br><h2>  Cisco verbinden </h2><br><p>  Benutzer unter Windows oder MacOS k√∂nnen √ºber Cisco Connect eine Verbindung zu unserem Unternehmens-VPN herstellen. Cisco Connect muss die Gateway-Adresse angeben und bei jeder Verbindung ein Kennwort eingeben, das aus einem festen Teil und einem von Google Authenticator generierten Code besteht. </p><a name="habracut"></a><br><p>  Im Falle von Linux war es nicht m√∂glich, Cisco Connect zu erhalten, aber es stellte sich heraus, dass Google die Empfehlung zur Verwendung von openconnect aussprach, die speziell als Ersatz f√ºr Cisco Connect gedacht war. </p><br><h2>  Openconnect </h2><br><p>  Theoretisch gibt es in Ubunt eine spezielle grafische Oberfl√§che f√ºr OpenConnect, die aber bei mir nicht funktioniert hat.  Vielleicht ist es das Beste. </p><br><p>  In Ubunt wird openconnect vom Paketmanager aus installiert. </p><br><pre><code class="plaintext hljs">apt install openconnect</code> </pre> <br><p>  Unmittelbar nach der Installation k√∂nnen Sie versuchen, eine Verbindung zum VPN herzustellen </p><br><pre> <code class="plaintext hljs">openconnect --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  vpn.evilcorp.com ist die fiktive VPN-Adresse \ <br>  poxvuibr - fiktiver Benutzername </p><br><p>  openconnect fordert Sie auf, ein Passwort einzugeben, das, wie ich mich erinnere, aus einem festen Teil und Code von Google Authenticator besteht, und versucht dann, eine Verbindung zu VPN herzustellen.  Wenn es sich herausstellte, k√∂nnen Sie, herzlichen Gl√ºckwunsch, die schmerzhafte Mitte sicher √ºberspringen und im Hintergrund auf den Punkt √ºber OpenConnect gehen.  Wenn es nicht funktioniert, k√∂nnen Sie fortfahren.  Obwohl es sich herausstellte, wenn Sie sich beispielsweise von einem Gast aus √ºber WLAN bei der Arbeit verbinden, ist es m√∂glich, sich zu freuen, und Sie sollten versuchen, den Vorgang von zu Hause aus zu wiederholen. </p><br><h2>  Zertifikat </h2><br><p>  Mit hoher Wahrscheinlichkeit startet nichts und der OpenConnect-Auspuff sieht ungef√§hr so ‚Äã‚Äãaus: </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Certificate from VPN server "vpn.evilcorp.com" failed verification. Reason: signer not found To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Dies ist zum einen unangenehm, da keine Verbindung zum VPN bestand, zum anderen ist es grunds√§tzlich nachvollziehbar, wie dieses Problem behoben werden kann. </p><br><p>  Der Server hat uns dann ein Zertifikat gesendet, anhand dessen festgestellt werden kann, dass die Verbindung zum Server des einheimischen Unternehmens und nicht zum b√∂swilligen Betr√ºger hergestellt wurde und dieses Zertifikat dem System unbekannt ist.  Und so kann sie nicht √ºberpr√ºfen, ob der reale Server ist oder nicht.  Und f√ºr alle F√§lle funktioniert es nicht mehr. </p><br><p>  Damit openconnect weiterhin eine Verbindung zum Server herstellen kann, m√ºssen Sie ihm mithilfe des Schl√ºssels --servercert explizit mitteilen, welches Zertifikat vom VPN-Server stammen soll </p><br><p>  Und Sie k√∂nnen herausfinden, welches Zertifikat der Server direkt von welchem ‚Äã‚Äãopenconnect an uns gesendet hat.  Hier von diesem St√ºck: </p><br><pre> <code class="plaintext hljs">To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Mit diesem Befehl k√∂nnen Sie erneut versuchen, eine Verbindung herzustellen </p><br><pre> <code class="plaintext hljs">openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  Vielleicht funktioniert es jetzt, dann k√∂nnen Sie bis zum Ende gehen.  Aber Ubunta hat mir pers√∂nlich eine Feige in dieser Form gezeigt </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Connected to HTTPS on vpn.evilcorp.com XML POST enabled Please enter your username and password. POST https://vpn.evilcorp.com/ Got CONNECT response: HTTP/1.1 200 OK CSTP connected. DPD 300, Keepalive 30 Set up DTLS failed; using SSL instead Connected as 192.168.333.222, using SSL NOSSSSSHHHHHHHDDDDD 3 NOSSSSSHHHHHHHDDDDD 3 RTNETLINK answers: File exists /etc/resolvconf/update.d/libc: Warning: /etc/resolv.conf is not a symbolic link to /run/resolvconf/resolv.conf</code> </pre> <br><p>  /etc/resolv.conf </p><br><pre> <code class="plaintext hljs"># Generated by NetworkManager search gst.evilcorpguest.com nameserver 127.0.0.53</code> </pre> <br><p>  /run/resolvconf/resolv.conf </p><br><pre> <code class="plaintext hljs"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run "systemd-resolve --status" to see details about the actual nameservers. nameserver 192.168.430.534 nameserver 127.0.0.53 search evilcorp.com gst.publicevilcorp.com</code> </pre> <br><p>  habr.com wird aufgel√∂st, aber es ist nicht m√∂glich, dort einzutreten.  Adressen wie jira.evilcorp.com werden √ºberhaupt nicht aufgel√∂st. </p><br><p>  Was hier passiert ist, ist mir nicht klar.  Das Experiment zeigt jedoch, dass, wenn Sie die Zeile zu /etc/resolv.conf hinzuf√ºgen </p><br><pre> <code class="plaintext hljs">nameserver 192.168.430.534</code> </pre> <br><p>  Dann werden die Adressen im VPN auf magische Weise aufgel√∂st und es wird m√∂glich sein, sie zu durchlaufen, dh nach was DNS sucht, um Adressen aufzul√∂sen, wird in /etc/resolv.conf gesucht und nicht woanders. </p><br><p>  Damit eine Verbindung zum VPN besteht und es funktioniert, k√∂nnen Sie ohne √Ñnderungen in /etc/resolv.conf sicherstellen, dass Sie im Browser nur den symbolischen Namen der Ressource von vpn und deren IP-Adresse eingeben </p><br><p>  Das Ergebnis sind zwei Probleme </p><br><ul><li>  bei verbindung zu VPN wird seine dns nicht abgeholt </li><li>  Der gesamte Datenverkehr wird √ºber VPN abgewickelt, sodass Sie nicht ins Internet gelangen k√∂nnen </li></ul><br><p>  Was ich jetzt tun werde, werde ich Ihnen sagen, aber zuerst ein wenig Automatisierung. </p><br><h2>  Automatische Eingabe des festen Teils des Passworts </h2><br><p>  Bis zum jetzigen Zeitpunkt haben Sie das Passwort h√∂chstwahrscheinlich bereits mindestens f√ºnf Mal eingegeben, und dieser Vorgang hat Sie bereits ziemlich m√ºde gemacht.  Erstens, weil das Passwort lang ist, und zweitens, weil Sie bei der Eingabe einen festgelegten Zeitraum einhalten m√ºssen </p><br><p>  Die endg√ºltige L√∂sung des Problems war nicht im Artikel enthalten, kann jedoch so vorgenommen werden, dass der feste Teil des Kennworts nicht mehrmals eingegeben werden muss. </p><br><p>  Angenommen, der feste Teil des Kennworts ist fixedPassword und ein Teil des Google Authenticator 567 987. Das gesamte Kennwort von openconnect kann √ºber die Standardeingabe mit dem Argument --passwd-on-stdin √ºbergeben werden. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com --passwd-on-stdin</code> </pre> <br><p>  Jetzt k√∂nnen Sie st√§ndig zum zuletzt eingegebenen Befehl zur√ºckkehren und dort nur einen Teil von Google Authenticator √§ndern. </p><br><h2>  Das Unternehmens-VPN erlaubt keinen Internetzugang. </h2><br><p>  Im Allgemeinen ist es nicht sehr unpraktisch, wenn Sie einen separaten Computer verwenden m√ºssen, um zu einem Hub zu gelangen.  Das Fehlen der F√§higkeit, mit Stackoverfow zu kopieren und einzuf√ºgen, kann die Arbeit im Allgemeinen lahm legen, sodass etwas getan werden muss. </p><br><p>  Es ist notwendig, sich irgendwie zu organisieren, damit Linux, wenn Sie vom internen Netzwerk auf die Ressource zugreifen m√ºssen, auf vpn wechselt und wenn Sie auf den Hub zugreifen m√ºssen, auf das Internet. </p><br><p>  openconnect f√ºhrt nach dem Starten und Herstellen einer Verbindung mit vpn ein spezielles Skript aus, das sich in / usr / share / vpnc-scripts / vpnc-script befindet.  Einige Variablen werden an das Eingabeskript √ºbergeben, und es f√ºhrt die VPN-Konfiguration durch.  Leider konnte ich nicht herausfinden, wie ich den Datenverkehr mithilfe eines nativen Skripts zwischen Unternehmens-VPN und dem Rest des Internets aufteilen kann. </p><br><p>  Scheinbar speziell f√ºr Leute wie mich wurde das Dienstprogramm vpn-slice entwickelt, mit dem Sie den Datenverkehr auf zwei Kan√§len leiten k√∂nnen, ohne mit einem Tamburin zu tanzen.  Nun, das hei√üt, Sie m√ºssen tanzen, aber ein Schamane ist nicht erforderlich. </p><br><h2>  Split Verkehr mit VPN-Slice </h2><br><p>  Zun√§chst muss vpn-slice installiert werden, das m√ºssen Sie selbst herausfinden.  Wenn es Fragen in den Kommentaren gibt, werde ich einen separaten Beitrag dazu schreiben.  Dies ist jedoch ein regul√§res Python-Programm, daher sollte es keine Schwierigkeiten geben.  Ich setze mit virtualenv. </p><br><p>  Und dann m√ºssen Sie das Dienstprogramm verwenden und den --script-Schl√ºssel verwenden, der openconnect anzeigt, dass Sie anstelle des Standardskripts vpn-slice verwenden m√ºssen </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 " vpn.evilcorp.com</code> </pre> <br><p>  In --script wird eine Zeile mit dem Befehl √ºbergeben, der anstelle des Skripts aufgerufen werden muss.  ./bin/vpn-slice - Pfad zur ausf√ºhrbaren vpn-slice-Datei 192.168.430.0/24 - Maske der in vpn zu besuchenden Adressen.  Hiermit meine ich, dass, wenn die Adresse mit 192.168.430 beginnt, die Ressource mit dieser Adresse in VPN gesucht werden muss </p><br><p>  Jetzt sollte die Situation fast normal sein.  Fast.  Jetzt k√∂nnen Sie sich am Hub anmelden und Sie k√∂nnen sich √ºber die IP-Adresse bei der internen Unternehmensressource anmelden, aber Sie k√∂nnen sich nicht √ºber den symbolischen Namen bei der internen Unternehmensressource anmelden.  Wenn Sie die Entsprechung des symbolischen Namens und der Adresse in Hosts registrieren, sollte alles funktionieren.  Und arbeiten, bis sich die IP √§ndert.  Linux kann nun abh√§ngig von der IP-Adresse auf das Internet oder das Unternehmensnetzwerk zugreifen.  F√ºr die Ermittlung der Adresse wird jedoch weiterhin DNS von Drittanbietern verwendet. </p><br><p>  Das Problem kann sich immer noch in dieser Form manifestieren - bei der Arbeit ist alles in Ordnung, und zu Hause k√∂nnen Sie nur √ºber IP auf interne Unternehmensressourcen zugreifen.  Dies liegt daran, dass, wenn Sie mit dem Firmen-WLAN verbunden sind, auch der Firmen-DNS verwendet wird und darin die symbolischen Adressen aus dem VPN aufgel√∂st werden, obwohl es immer noch unm√∂glich ist, ohne Verwendung eines VPN zu einer solchen Adresse zu gelangen. </p><br><h2>  Automatische √Ñnderung der Hosts-Datei </h2><br><p>  Wenn Sie h√∂flich nach vpn-slice fragen, kann das VPN nach dem Erh√∂hen zu seinem DNS gehen, die IP-Adressen der erforderlichen Ressourcen dort anhand ihrer symbolischen Namen finden und sie in Hosts eingeben.  Nach dem Deaktivieren von VPN werden diese Adressen von den Hosts entfernt.  √úbergeben Sie dazu symbolische Namen als Argumente an vpn-slice.  So. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Jetzt sollte alles sowohl im B√ºro als auch am Strand funktionieren. </p><br><h2>  Suchen Sie nach Adressen aller Subdomains im DNS, das das VPN angegeben hat </h2><br><p>  Wenn es nur wenige Adressen im Netzwerk gibt, funktioniert der Ansatz, die Hosts-Datei automatisch zu √§ndern, einwandfrei.  Wenn sich jedoch viele Ressourcen im Netzwerk befinden, m√ºssen Sie st√§ndig Zeilen wie zoidberg.test.evilcorp.com zum Skript zoidberg hinzuf√ºgen. Dies ist der Name eines der Testst√§nde. </p><br><p>  Aber jetzt haben wir ein wenig Verst√§ndnis daf√ºr, warum dieses Bed√ºrfnis beseitigt werden kann. </p><br><p>  Wenn Sie nach dem Erh√∂hen des VPN nach / etc / hosts suchen, sehen Sie, dass hier eine Zeile steht </p><br><blockquote>  192.168.430.534 dns0.tun0 # vpn-slice-tun0 AUTOCREATED </blockquote><p>  Ja, und eine neue Zeile wurde zu resolv.conf hinzugef√ºgt.  Kurz gesagt, vpn-slice hat irgendwie festgestellt, wo sich der DNS-Server f√ºr vpn befindet. </p><br><p>  Jetzt m√ºssen wir sicherstellen, dass Linux zur Ermittlung der IP-Adresse des Domainnamens, der auf evilcorp.com endet, zu Unternehmens-DNS gewechselt ist. Wenn etwas anderes ben√∂tigt wird, wird standardm√§√üig verwendet. </p><br><p>  Ich habe lange gegoogelt und festgestellt, dass solche Funktionen sofort verf√ºgbar sind.  Dies bezieht sich auf die F√§higkeit, den lokalen DNS-DNSMASQ-Server zum Aufl√∂sen von Namen zu verwenden. </p><br><p>  Das hei√üt, Sie k√∂nnen Linux veranlassen, immer auf den lokalen DNS-Server nach IP-Adressen zu suchen, die wiederum abh√§ngig vom Dom√§nennamen auf dem entsprechenden externen DNS-Server nach IP suchen. </p><br><p>  Um alles zu verwalten, was mit Netzwerken und Netzwerkverbindungen zu tun hat, verwendet Ubunt den NetworkManager und die grafische Benutzeroberfl√§che, √ºber die beispielsweise eine Wi-Fi-Verbindung ausgew√§hlt werden kann, ist genau das Richtige. </p><br><p>  Wir m√ºssen in seiner Konfiguration klettern. </p><br><ol><li>  Erstellen Sie eine Datei in /etc/NetworkManager/dnsmasq.d/evilcorp </li></ol><br><blockquote>  address = /. evilcorp.com/192.168.430.534 </blockquote><p>  Achte auf den Punkt vor evilcorp.  Es signalisiert dnsmasq, dass alle evilcorp.com-Subdomains im Unternehmens-DNS gesucht werden m√ºssen. </p><br><ol><li>  Weisen Sie NetworkManager an, dnsmasq zum Aufl√∂sen von Namen zu verwenden </li></ol><br><p>  Die Konfiguration des Netzwerkmanagers befindet sich in /etc/NetworkManager/NetworkManager.conf. Sie m√ºssen dort Folgendes hinzuf√ºgen: </p><br><blockquote>  [main] <br>  dns = dnsmasq </blockquote><br><ol><li>  Starten Sie NetworkManager neu </li></ol><br><pre> <code class="plaintext hljs">service network-manager restart</code> </pre> <br><p>  Nach dem Herstellen einer VPN-Verbindung mit einer Reihe von openconnect- und vpn-slice-Elementen wird ip nun normalerweise erkannt, auch wenn Sie den Argumenten f√ºr vpnslice keine symbolischen Adressen hinzuf√ºgen. </p><br><h2>  So gehen Sie √ºber VPN zu separaten Diensten </h2><br><p>  Nachdem sich herausstellte, dass eine Verbindung zu VPN hergestellt werden sollte, war ich zwei Tage lang sehr zufrieden. Dann stellte sich heraus, dass E-Mail nicht funktioniert, wenn Sie eine Verbindung zu VPN herstellen, die nicht √ºber das B√ºronetzwerk erfolgt.  Ein bekanntes Symptom, nicht wahr? </p><br><p>  Unsere Mail befindet sich in mail.publicevilcorp.com, was bedeutet, dass sie nicht unter die Regel in dnsmasq f√§llt und die Adresse des Mailservers √ºber √∂ffentliches DNS durchsucht wird. </p><br><p>  Nun, das B√ºro verwendet immer noch den DNS, in dem sich diese Adresse befindet.  Das dachte ich mir.  Nach dem Hinzuf√ºgen einer Zeile zu dnsmasq </p><br><blockquote>  address = / mail.publicevilcorp.com / 192.168.430.534 </blockquote><p>  Die Situation hat sich nicht ge√§ndert.  ip ist gleich geblieben.  Ich musste zur Arbeit gehen. </p><br><p>  Und erst dann, als ich mich mit der Situation befasst und das Problem ein wenig gekl√§rt hatte, sagte mir eine kluge Person, wie ich es l√∂sen sollte.  Die Verbindung zum Mailserver musste nicht einfach so, sondern √ºber VPN hergestellt werden </p><br><p>  Ich verwende vpn-slice, um √ºber das VPN zu Adressen zu gelangen, die mit 192.168.430 beginnen.  Und auf dem Mailserver ist nicht nur die symbolische Adresse keine Unterdom√§ne von evilcorp, sondern auch eine IP-Adresse, die nicht mit 192.168.430 beginnt.  Und nat√ºrlich l√§sst er niemanden aus dem allgemeinen Netzwerk heraus. </p><br><p>  Damit Linux √ºber das VPN auf den Mailserver zugreifen kann, m√ºssen Sie ihn zu vpn-slice hinzuf√ºgen.  Angenommen, die Adresse des Mailers lautet 555.555.555.555 </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 555.555.555.555 192.168.430.0/24" vpn.evilcorp.com</code> </pre> <br><h2>  Skript zum Ausl√∂sen eines VPN mit einem Argument </h2><br><p>  All dies ist nat√ºrlich nicht sehr bequem.  Ja, Sie k√∂nnen den Text in einer Datei speichern und in die Konsole kopieren, anstatt mit den H√§nden zu tippen, aber es ist immer noch nicht angenehm genug.  Um den Vorgang zu vereinfachen, k√∂nnen Sie den Befehl in ein Skript einbinden, das sich in PATH befindet.  Und dann m√ºssen Sie nur noch den Code eingeben, den Sie von Google Authenticator erhalten haben </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Wenn Sie das Skript in connect ~ evilcorp ~ einf√ºgen, k√∂nnen Sie einfach in die Konsole schreiben </p><br><pre> <code class="plaintext hljs">connect_evil_corp 567987</code> </pre> <br><p>  Aber aus irgendeinem Grund m√ºssen Sie jetzt die Konsole, in der openconnect ausgef√ºhrt wird, ge√∂ffnet lassen </p><br><h2>  Openconnect-Start im Hintergrund </h2><br><p>  Gl√ºcklicherweise haben sich die Autoren von openconnect um uns gek√ºmmert und dem Programm einen speziellen Key - Background hinzugef√ºgt, der das Programm nach dem Start im Hintergrund laufen l√§sst.  Wenn Sie es so ausf√ºhren, k√∂nnen Sie die Konsole nach dem Start schlie√üen </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Jetzt ist nicht klar, wohin die Protokolle gehen.  Protokolle werden f√ºr uns in der Regel nicht wirklich ben√∂tigt, aber Sie wissen es nie.  openconnect kann sie an syslog weiterleiten, wo sie intakt bleiben.  Sie m√ºssen den --syslog-Schl√ºssel zum Befehl hinzuf√ºgen </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \</code> </pre> <br><p>  Und so stellt sich heraus, dass openconnect irgendwo im Hintergrund arbeitet und niemanden st√∂rt, aber es ist nicht klar, wie man es stoppen kann.  Das hei√üt, Sie k√∂nnen den ps-Auspuff nat√ºrlich mit einem Grep herausfiltern und nach einem Prozess suchen, in dessen Namen openconnect steht, der aber irgendwie trostlos ist.  Vielen Dank an die Autoren, die dar√ºber nachgedacht haben.  Openconnect verf√ºgt √ºber den Schl√ºssel --pid-file, mit dem Sie openconnect anweisen k√∂nnen, seine Prozess-ID in eine Datei zu schreiben. </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Jetzt k√∂nnen Sie den Vorgang jederzeit mit dem Befehl ausf√ºhren </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid)</code> </pre> <br><p>  Wenn es keinen Prozess gibt, wird kill schw√∂ren, aber keinen Fehler ausl√∂sen.  Wenn keine Datei vorhanden ist, geschieht auch nichts Schlimmes, sodass Sie den Prozess in der ersten Zeile des Skripts sicher beenden k√∂nnen. </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid) #!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Jetzt k√∂nnen Sie den Computer einschalten, die Konsole √∂ffnen und den Befehl ausf√ºhren, indem Sie den Code von Google Authenticator √ºbergeben.  Die Konsole kann dann genagelt werden. </p><br><h1>  Ohne VPN-Slice.  Anstelle eines Nachwortes </h1><br><p>  Es war sehr schwer zu verstehen, wie man ohne vpn-slice lebt.  Ich musste viel lesen und googeln.  Zum Gl√ºck, wenn ich so viel Zeit mit dem Problem verbracht habe, lesen sich technische Handb√ºcher und sogar man openconnect wie aufregende Romane. </p><br><p>  Als Ergebnis fand ich heraus, dass vpn-slice wie das native Skript die Routing-Tabelle so √§ndert, dass sie Netzwerke trennt. </p><br><h2>  Routing-Tabelle </h2><br><p>  In einfachen Worten, eine solche Tabelle in der ersten Spalte enth√§lt, wo die Adresse beginnen soll, zu der Linux wechseln m√∂chte, und in der zweiten Spalte, √ºber welche Netzwerkkarte diese Adresse aufgerufen werden soll.  Tats√§chlich gibt es mehr Spalten, aber dies √§ndert nichts an der Essenz. </p><br><p>  Um die Routing-Tabelle anzuzeigen, m√ºssen Sie den Befehl ip route ausf√ºhren </p><br><pre> <code class="plaintext hljs">default via 192.168.1.1 dev wlp3s0 proto dhcp metric 600 192.168.430.0/24 dev tun0 scope link 192.168.1.0/24 dev wlp3s0 proto kernel scope link src 192.168.1.534 metric 600 192.168.430.534 dev tun0 scope link</code> </pre> <br><p>  Hier ist jede Zeile daf√ºr verantwortlich, wohin sie gehen soll, um eine Nachricht an eine Adresse zu senden.  Die erste ist eine Beschreibung, wo die Adresse beginnen soll.  Um zu verstehen, wie man feststellt, dass 192.168.0.0/16 bedeutet, dass die Adresse mit 192.168 beginnen muss, m√ºssen Sie googeln, wie die Maske der IP-Adresse lautet.  Nach dev steht der Name des Adapters, an den die Nachricht gesendet werden soll. </p><br><p>  F√ºr VPN hat Linux einen virtuellen Adapter erstellt - tun0.  Damit der Datenverkehr f√ºr alle Adressen, die mit 192.168 beginnen, durchl√§uft, antwortet die Leitung </p><br><pre> <code class="plaintext hljs">192.168.0.0/16 dev tun0 scope link</code> </pre> <br><p>  Sie k√∂nnen den aktuellen Status der Routingtabelle auch mit dem Befehl <strong>route -n</strong> abrufen (IP-Adressen sind anonym talentiert). Dieser Befehl f√ºhrt zu einer anderen Form und ist im Allgemeinen veraltet. Die Ausgabe st√∂√üt jedoch h√§ufig auf Online-Handb√ºcher und muss gelesen werden k√∂nnen. </p><br><p>  Wo die IP-Adresse f√ºr die Route beginnen soll, ist aus der Kombination der Spalten Destination und Genmask ersichtlich.  Die Teile der IP-Adresse, denen die Nummern 255 in Genmask entsprechen, werden ber√ºcksichtigt, die Teile, denen 0 nicht entspricht.  Das hei√üt, die Kombination aus Ziel 192.168.0.0 und Genmask 255.255.255.0 bedeutet, dass, wenn die Adresse mit 192.168.0 beginnt, eine Anforderung an diese Route erfolgt.  Wenn das Ziel 192.168.0.0 ist, Genmask jedoch 255.255.0.0, werden Anforderungen an Adressen, die mit 192.168 beginnen, auf dieser Route ausgef√ºhrt </p><br><p>  Um herauszufinden, was vpn-slice tats√§chlich macht, habe ich mich vorher und nachher mit dem Zustand der Tabellen befasst </p><br><h2>  Vor der Aktivierung von VPN war es so </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0</code> </pre> <br><h2>  Nach dem Aufruf von openconnect ohne vpn-slice wurde es so </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><h2>  Und nach dem Aufruf von openconnect in Kombination mit vpn-slice wie diesem </h2><br><pre> <code class="plaintext hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><p>  Es ist zu sehen, dass openconnect, wenn Sie nicht vpn-slice verwenden, explizit schreibt, dass Sie vpn an alle Adressen senden m√ºssen, mit Ausnahme der separat angegebenen Adressen. </p><br><p>  Hier: </p><br><pre> <code class="plaintext hljs">0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0</code> </pre> <br><p>  In der N√§he wurde sofort ein anderer Pfad angegeben, der verwendet werden sollte, wenn die Adresse, die Linux zu durchlaufen versucht, keiner Maske aus der Tabelle entspricht. </p><br><pre> <code class="plaintext hljs">0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0</code> </pre> <br><p>  Hier wurde bereits geschrieben, dass Sie in diesem Fall den Standard-WLAN-Adapter verwenden m√ºssen. </p><br><p>  Ich glaube, dass der Pfad f√ºr das VPN verwendet wird, weil es das erste in der Routingtabelle ist. </p><br><p>  Und theoretisch sollte, wenn Sie diesen Standardpfad aus der Routingtabelle entfernen, in Verbindung mit dnsmasq openconnect den normalen Betrieb sicherstellen. </p><br><p>  Ich habe es versucht </p><br><pre> <code class="plaintext hljs">route del default</code> </pre> <br><p>  Und es hat funktioniert. </p><br><h2>  Weiterleiten von Anforderungen an einen Mailserver ohne VPN-Slice </h2><br><p>  Aber ich habe auch einen Mail-Server mit der Adresse 555.555.555.555, den Sie auch √ºber VPN gehen m√ºssen.  Der Weg dorthin muss ebenfalls von Hand hinzugef√ºgt werden. </p><br><pre> <code class="plaintext hljs">ip route add 555.555.555.555 via dev tun0</code> </pre> <br><p>  Und jetzt alle Regeln.  Sie k√∂nnen also auf vpn-slice verzichten, aber Sie m√ºssen bereits genau wissen, was Sie tun.  Ich denke jetzt dar√ºber nach, die Entfernung der Standardroute und die Route f√ºr den Mailer nach dem Herstellen einer Verbindung zu vpn in der letzten Zeile des nativen openconnect-Skripts hinzuzuf√ºgen, um die Anzahl der beweglichen Teile in meinem Fahrrad zu verringern. </p><br><p>  Wahrscheinlich w√ºrde jemand, um zu verstehen, wie man ein VPN konfiguriert, genug von diesem Nachwort haben.  Aber w√§hrend ich versuchte zu verstehen, was und wie ich es tun sollte, las ich eine Menge solcher Handb√ºcher, die f√ºr den Autor funktionieren, aber aus irgendeinem Grund nicht f√ºr mich funktionieren, und beschloss, alle gefundenen St√ºcke hier hinzuzuf√ºgen.  Ich w√ºrde mich sehr √ºber so etwas freuen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de479034/">https://habr.com/ru/post/de479034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de479016/index.html">5 Schritte zum Schutz von Gesch√§ftsgeheimnissen</a></li>
<li><a href="../de479018/index.html">Docker f√ºr das Frontend. Teil 2. Was bist du?</a></li>
<li><a href="../de479020/index.html">Die Geschichte, wie Google Play in einer Stunde zehn Jahre meiner Arbeit gekreuzt hat</a></li>
<li><a href="../de479022/index.html">Smart-Fernseher Samsung, LG, Vizio und TCL nehmen jede Sekunde "Fingerabdr√ºcke" vom Bildschirm und senden sie an den Server</a></li>
<li><a href="../de479026/index.html">Echte Summe der Internetkan√§le - OpenMPTCPRouter</a></li>
<li><a href="../de479036/index.html">Intel kann die Nachfrage nach Prozessoren nicht befriedigen. HP und Dell leiden darunter</a></li>
<li><a href="../de479038/index.html">Digitale Transformation Leroy Merlin: Entwerfen einer Schnittstelle f√ºr die Arbeit mit Kundenanrufen</a></li>
<li><a href="../de479040/index.html">Visuelle Regressionstests. Starten Sie neu</a></li>
<li><a href="../de479042/index.html">Mit der Y-Methode k√∂nnen Sie ganz einfach einen Rubik's Cube erstellen</a></li>
<li><a href="../de479044/index.html">Meine Ringpuffer-Implementierung in NOR-Flash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>