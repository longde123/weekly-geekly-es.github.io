<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèùÔ∏è üóùÔ∏è üñáÔ∏è Experiencia en el desarrollo del servicio de herramienta de reembolso con una API as√≠ncrona en Kafka üöú ‚õÑÔ∏è üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© puede hacer que una gran empresa como Lamoda con un proceso simplificado y docenas de servicios interconectados cambie significativamente el enfo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experiencia en el desarrollo del servicio de herramienta de reembolso con una API as√≠ncrona en Kafka</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/445424/">  ¬øQu√© puede hacer que una gran empresa como Lamoda con un proceso simplificado y docenas de servicios interconectados cambie significativamente el enfoque?  La motivaci√≥n puede ser completamente diferente: desde el legislativo hasta el deseo inherente a todos los programadores de experimentar. <br><br>  Pero esto no significa en absoluto que uno no pueda contar con beneficios adicionales.  Sergey Zaika ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">fewald</a> ) dir√° qu√© se puede ganar exactamente si implementa la API basada en eventos en Kafka.  Sobre golpes y descubrimientos interesantes, tambi√©n habr√°, sin duda, un experimento no puede prescindir de ellos. <br><br><img src="https://habrastorage.org/webt/kq/o2/ye/kqo2yemmmu-wiqi9vtpcrbolroq.png"><br><br>  <em>Descargo de responsabilidad: este art√≠culo se basa en los materiales del mitap que Sergey realiz√≥ en noviembre de 2018 en HighLoad ++.</em>  <em>La experiencia en vivo de Lamoda con Kafka atrajo a los oyentes no menos que otros informes de horarios.</em>  <em>Nos parece que este es un gran ejemplo del hecho de que siempre es posible y necesario encontrar personas con ideas afines, y los organizadores de HighLoad ++ continuar√°n tratando de crear una atm√≥sfera propicia para esto.</em> <br><a name="habracut"></a><br><h2>  Sobre el proceso </h2><br>  Lamoda es una gran plataforma de comercio electr√≥nico que tiene su propio centro de contacto, servicio de entrega (y muchos afiliados), un estudio fotogr√°fico, un gran almac√©n y todo funciona en su software.  Hay docenas de m√©todos de pago, socios B2B que pueden usar parte o la totalidad de estos servicios y desean conocer la informaci√≥n m√°s reciente sobre sus productos.  Adem√°s, Lamoda opera en tres pa√≠ses adem√°s de la Federaci√≥n de Rusia y all√≠ todo es un poco diferente.  En total, probablemente haya m√°s de cien formas de configurar un nuevo pedido, que deben procesarse a su manera.  Todo esto funciona con la ayuda de docenas de servicios que a veces se comunican de manera no obvia.  Tambi√©n hay un sistema central cuya responsabilidad principal es el estado de los pedidos.  La llamamos BOB, yo trabajo con ella. <br><br><h2>  Herramienta de reembolso con API controlada por eventos </h2><br>  La palabra impulsada por eventos es bastante trillada, un poco m√°s adelante definiremos con m√°s detalle lo que significa esto.  Comenzar√© con el contexto en el que decidimos probar el enfoque de API basado en eventos de Kafka. <br><br><img src="https://habrastorage.org/webt/8y/0i/kp/8y0ikp8ebxzglwhw1s-dhrubivw.png"><br><br>  En cualquier tienda, adem√°s de los pedidos por los que pagan los clientes, hay ocasiones en que la tienda debe devolver el dinero, porque el producto no se ajusta al cliente.  Este proceso relativamente corto: aclaramos la informaci√≥n, si es necesario, y transferimos el dinero. <br><br>  Pero el retorno fue complicado debido a cambios en la legislaci√≥n, y tuvimos que implementar un microservicio separado para ello. <br><br><img src="https://habrastorage.org/webt/nn/_x/xr/nn_xxr2xlqfpn-kmgc5y4rzj9a8.png"><br><br>  Nuestra motivaci√≥n: <br><br><ol><li>  <strong>Ley FZ-54</strong> : brevemente, la ley requiere que informe a la oficina de impuestos sobre cada transacci√≥n monetaria, ya sea un reembolso o recibo, en un SLA bastante corto en unos minutos.  Nosotros, como comercio electr√≥nico, llevamos a cabo bastantes operaciones.  T√©cnicamente, esto significa una nueva responsabilidad (y, por lo tanto, un nuevo servicio) y mejoras en todos los sistemas involucrados. </li><li>  <strong>Divisi√≥n de BOB</strong> : el proyecto interno de la compa√±√≠a para librar a BOB de una gran cantidad de responsabilidades no esenciales y reducir su complejidad general. </li></ol><br><img src="https://habrastorage.org/webt/u7/k8/7x/u7k87xo4jzxcjmoeanxdzhy_yag.png"><br><br>  Este diagrama representa los principales sistemas de Lamoda.  Ahora la mayor√≠a de ellos son m√°s como una <strong>constelaci√≥n de 5-10 microservicios alrededor de un monolito decreciente</strong> .  Est√°n creciendo lentamente, pero estamos tratando de hacerlos m√°s peque√±os, porque da miedo desplegar el fragmento resaltado en el medio; no se puede permitir que caiga.  Todos los intercambios (flechas) nos obligan a reservar y basarnos en el hecho de que alguno de ellos puede no estar disponible. <br><br>  Tambi√©n hay bastantes intercambios en BOB: pago, entrega, sistemas de notificaci√≥n, etc. <br><br>  T√©cnicamente, BOB es: <br><br><ul><li>  ~ 150k l√≠neas de c√≥digo + ~ 100k l√≠neas de pruebas; </li><li>  php7.2 + Zend 1 y Symfony Components 3; </li><li>  &gt; 100 API y ~ 50 integraciones salientes; </li><li>  4 pa√≠ses con su propia l√≥gica de negocios. </li></ul><br>  La implementaci√≥n de BOB es costosa y dolorosa, la cantidad de c√≥digo y las tareas que resuelve es tal que nadie puede pensarlo.  En general, hay muchas razones para simplificarlo. <br><br><h2>  Proceso de devoluci√≥n </h2><br>  Inicialmente, hay dos sistemas involucrados en el proceso: BOB y Pago.  Ahora aparecen dos m√°s: <br><br><ul><li>  Servicio de Fiscalizaci√≥n, que se ocupar√° de los problemas de fiscalizaci√≥n y comunicaci√≥n con servicios externos. </li><li>  Herramienta de reembolso, en la que simplemente se toman nuevos intercambios para no inflar el BOB. </li></ul><br>  Ahora el proceso se ve as√≠: <br><br><img src="https://habrastorage.org/webt/pe/e6/0q/pee60qj1tdefewqgdaw22bww-ag.png"><br><br><ol><li>  BOB recibe una solicitud de reembolso. </li><li>  BOB habla sobre esta herramienta de reembolso. </li><li>  La herramienta de reembolso dice Pago: "Recupere el dinero". </li><li>  El pago devuelve el dinero. </li><li>  La herramienta de reembolso y BOB sincronizan los estados entre s√≠, porque por ahora ambos lo necesitan.  Todav√≠a no estamos listos para cambiar por completo a la Herramienta de reembolso, ya que BOB tiene una interfaz de usuario, informes para contabilidad y, en general, una gran cantidad de datos que no puede transferir f√°cilmente.  Tenemos que sentarnos en dos sillas. </li><li>  La solicitud de fiscalizaci√≥n se va. </li></ol><br>  Como resultado, hicimos una especie de autob√∫s de eventos en Kafka, un autob√∫s de eventos, en el que todo comenz√≥.  Hurra, ahora tenemos un √∫nico punto de falla (sarcasmo). <br><br><img src="https://habrastorage.org/webt/8k/zg/qc/8kzgqcfju7ybv8imzajjjykpz10.png"><br><br>  Los pros y los contras son bastante obvios.  Hicimos un autob√∫s, por lo que ahora todos los servicios dependen de √©l.  Esto simplifica el dise√±o, pero introduce un √∫nico punto de falla en el sistema.  Kafka caer√°, el proceso se levantar√°. <br><br><h2>  ¬øQu√© es una API controlada por eventos? </h2><br>  Una buena respuesta a esta pregunta est√° en el informe de Martin Fowler (GOTO 2017) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Los muchos significados de la arquitectura dirigida por eventos"</a> . <br><br>  Brevemente, lo que hicimos: <br><br><ol><li>  Envuelto todos los intercambios asincr√≥nicos a trav√©s del <strong>almacenamiento de eventos</strong> .  En lugar de informar a cada consumidor interesado sobre el cambio de estado a trav√©s de la red, escribimos un evento de cambio de estado en el repositorio centralizado, y los consumidores interesados ‚Äã‚Äãen el tema leen todo lo que aparece a partir de ah√≠. </li><li>  Un evento en este caso es una notificaci√≥n ( <strong>notificaciones</strong> ) de que algo ha cambiado en alguna parte.  Por ejemplo, el estado del pedido ha cambiado.  Un consumidor que est√© interesado en alg√∫n tipo de informaci√≥n que acompa√±e el cambio de estado y que no est√© en la notificaci√≥n puede averiguarlo por s√≠ mismo. </li><li>  La opci√≥n m√°xima es un abastecimiento de eventos completo, <strong>transferencia de estado</strong> , en cuyo evento contiene toda la informaci√≥n necesaria para el procesamiento: desde d√≥nde y a qu√© estado cambi√≥, c√≥mo cambiaron exactamente los datos, etc. La √∫nica pregunta es si vale la pena y cu√°nta informaci√≥n puede permitirse almacenar. </li></ol><br>  Como parte del lanzamiento de la herramienta de reembolso, utilizamos la tercera opci√≥n.  Esto simplific√≥ el procesamiento de eventos, ya que no era necesario obtener informaci√≥n detallada, adem√°s excluy√≥ el escenario cuando cada nuevo evento genera una oleada de aclaraci√≥n de las solicitudes de obtenci√≥n de los consumidores. <br><br>  El servicio de la herramienta de reembolso <strong>no</strong> est√° <strong>cargado</strong> , por lo que Kafka es m√°s una prueba de l√°piz que una necesidad.  No creo que si el servicio de reembolso se convirtiera en un proyecto de gran carga, la empresa estar√≠a feliz. <br><br><h4>  Intercambio as√≠ncrono TAL CUAL </h4><br>  Para los intercambios asincr√≥nicos, el departamento de PHP generalmente usa RabbitMQ.  Recopilamos los datos para la solicitud, los pusimos en la cola y el consumidor del mismo servicio los ley√≥ y los envi√≥ (o no los envi√≥).  Para la API en s√≠, Lamoda usa Swagger activamente.  Dise√±amos la API, la describimos en Swagger, generamos c√≥digo de cliente y servidor.  Tambi√©n utilizamos un JSON RPC 2.0 ligeramente avanzado. <br><br>  Aqu√≠ y all√°, se utilizan autobuses esb, alguien vive en activeMQ, pero, en general, <strong>RabbitMQ es el est√°ndar</strong> . <br><br><h4>  Intercambio asincr√≥nico SER </h4><br>  Al dise√±ar un intercambio a trav√©s del bus de eventos, se rastrea una analog√≠a.  De manera similar, describimos el intercambio futuro de datos a trav√©s de descripciones de estructura de eventos.  El formato yaml, la generaci√≥n del c√≥digo ten√≠a que ser realizada por nosotros mismos, el generador crea el DTO de acuerdo con las especificaciones y ense√±a a los clientes y servidores c√≥mo trabajar con ellos.  La generaci√≥n va a dos idiomas: <strong>golang y php</strong> .  Esto mantiene las bibliotecas consistentes.  El generador est√° escrito en golang, por lo que recibi√≥ el nombre de gogi. <br><br>  El abastecimiento de eventos en Kafka es algo t√≠pico.  Hay una soluci√≥n de la versi√≥n empresarial principal de Kafka Confluent, hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nakadi</a> , una soluci√≥n de nuestros "hermanos" en el √°rea de dominio de Zalando.  Nuestra <strong>motivaci√≥n para comenzar con Kafka vainilla</strong> es dejar la soluci√≥n libre hasta que finalmente decidamos si usarla en todas partes, y tambi√©n dejar espacio para maniobras y mejoras: queremos soporte para nuestro <strong>JSON RPC 2.0</strong> , generadores para dos idiomas, y ver qu√© m√°s. <br><br>  Es ir√≥nico que incluso en un caso tan feliz, cuando hay un negocio similar a Zalando, que tom√≥ una decisi√≥n similar, no podemos usarlo de manera efectiva. <br><br>  Arquitect√≥nicamente, en el inicio, el patr√≥n es el siguiente: lee directamente de Kafka, pero escribe solo a trav√©s del bus de eventos.  Hay muchas cosas listas para leer en Kafka: corredores, equilibradores y est√° m√°s o menos listo para el escalado horizontal, quer√≠a mantenerlo.  El registro, quer√≠amos pasar a trav√©s de un Gateway, tambi√©n conocido como Events-bus, y es por eso. <br><br><h3>  Bus de eventos </h3><br>  O un autob√∫s de eventos.  Esta es solo una puerta de enlace http sin estado que asume varios roles importantes: <br><br><ul><li>  <strong>Validaci√≥n de la producci√≥n</strong> : verificamos que los eventos cumplan con nuestras especificaciones. </li><li>  <strong>Un sistema maestro de eventos</strong> , es decir, es el sistema principal y √∫nico en la empresa que responde a la pregunta de qu√© eventos con qu√© estructuras se consideran v√°lidas.  La validaci√≥n simplemente incluye tipos de datos y enumeraciones para una especificaci√≥n estricta del contenido. </li><li>  <strong>La funci√≥n</strong> hash para fragmentar: la estructura del mensaje de Kafka es clave-valor, y aqu√≠ se calcula mediante la clave hash desde donde colocarla. </li></ul><br><h3>  Porque </h3><br>  Trabajamos en una gran empresa con un proceso simplificado.  ¬øPor qu√© cambiar algo?  <strong>Este es un experimento</strong> y esperamos obtener varios beneficios. <br><br><h4>  1: n + 1 intercambios (uno a muchos) </h4><br>  Con Kafka, es muy f√°cil conectar nuevos consumidores a la API. <br><br>  Suponga que tiene un directorio que debe mantenerse actualizado en varios sistemas a la vez (y en algunos nuevos).  Anteriormente, inventamos un paquete que implementaba un conjunto de API, y las direcciones de los consumidores se informaban al sistema maestro.  Ahora el sistema maestro env√≠a actualizaciones al tema y a todos los que est√©n interesados ‚Äã‚Äãen leer.  Ha aparecido un nuevo sistema: lo firmaron sobre el tema.  S√≠, tambi√©n paquete, pero m√°s simple. <br><br>  En el caso de la herramienta de reembolso, que es una pieza de BOB, nos conviene mantenerlos sincronizados a trav√©s de Kafka.  El pago dice que devolvieron el dinero: BOB, RT lo descubrieron, cambiaron su estado, el Servicio de Fiscalizaci√≥n lo descubri√≥ y noque√≥ un cheque. <br><br><img src="https://habrastorage.org/webt/x1/rs/gx/x1rsgx9mbceqzstdmcsg_hapnbs.png"><br><br>  Tenemos planes de hacer un √∫nico Servicio de notificaciones, que notificar√≠a al cliente sobre las novedades en su pedido / devoluciones.  Ahora esta responsabilidad se reparte entre los sistemas.  Ser√° suficiente para nosotros ense√±arle al Servicio de Notificaciones a capturar y responder a la informaci√≥n relevante de Kafka (y deshabilitar estas notificaciones en otros sistemas).  No se requerir√°n nuevos intercambios directos. <br><br><h4>  Datos impulsados </h4><br>  La informaci√≥n entre sistemas se vuelve transparente, no importa cu√°n sangrienta empresa tenga y cu√°n hinchada sea su cartera de pedidos.  Lamoda tiene un departamento de an√°lisis de datos que recopila datos en sistemas y los pone en una forma reutilizable, tanto para negocios como para sistemas inteligentes.  Kafka le permite darles r√°pidamente una gran cantidad de datos y mantener esta informaci√≥n actualizada. <br><br><h4>  Registro de replicaci√≥n </h4><br>  Los mensajes no desaparecen despu√©s de leer, como en RabbitMQ.  Cuando el evento contiene suficiente informaci√≥n para procesar, tenemos un historial de cambios recientes en el objeto y, si lo desea, la capacidad de aplicar estos cambios. <br><br>  El per√≠odo de almacenamiento del registro de replicaci√≥n depende de la intensidad de la escritura de este tema. Kafka le permite establecer l√≠mites flexibles en el tiempo de almacenamiento y el volumen de datos.  Para temas intensivos, es importante que todos los consumidores tengan tiempo de leer la informaci√≥n antes de que desaparezca, incluso en el caso de inoperancia a corto plazo.  Por lo general, resulta almacenar datos para <strong>unidades de d√≠as</strong> , lo cual es suficiente para el soporte. <br><br><img src="https://habrastorage.org/webt/xz/6-/59/xz6-59a1z7vrszrmoowvswxauqc.png"><br><br>  Luego un peque√±o recuento de la documentaci√≥n, para aquellos que no est√°n familiarizados con Kafka (la imagen tambi√©n es de la documentaci√≥n) <br><br>  Hay colas en AMQP: escribimos mensajes en la cola para el consumidor.  Como regla, una cola es procesada por un sistema con la misma l√≥gica de negocios.  Si necesita notificar a varios sistemas, puede ense√±ar a la aplicaci√≥n a escribir en varias colas o configurar el intercambio con el mecanismo de despliegue, que a su vez los clona. <br><br>  Kafka tiene un <em>tema de</em> abstracci√≥n similar en el que escribes mensajes, pero no desaparecen despu√©s de leer.  De manera predeterminada, cuando se conecta a Kafka, recibe todos los mensajes y, al mismo tiempo, existe la oportunidad de guardar el lugar donde lo dej√≥.  Es decir, si lee de forma secuencial, no puede marcar el mensaje como le√≠do, pero guarda la identificaci√≥n, de la que luego contin√∫a leyendo.  La identificaci√≥n en la que se est√° deteniendo se llama desplazamiento, y el mecanismo es confirmaci√≥n de desplazamiento. <br><br>  En consecuencia, se puede implementar una l√≥gica diferente.  Por ejemplo, tenemos BOB en 4 instancias para diferentes pa√≠ses: Lamoda est√° en Rusia, Kazajst√°n, Ucrania, Bielorrusia.  Como se implementan por separado, tienen un poco sus propias configuraciones y su propia l√≥gica de negocios.  En el mensaje indicamos a qu√© pa√≠s se refiere.  Cada consumidor de BOB en cada pa√≠s lee con un ID de grupo diferente, y si el mensaje no se aplica a √©l, om√≠talo, es decir  comprometer inmediatamente el desplazamiento +1.  Si nuestro Servicio de pagos lee el mismo tema, lo hace con un grupo separado y, por lo tanto, la compensaci√≥n no se superpone. <br><br>  <b>Requisitos del evento:</b> <br><br><ul><li>  <strong>Integridad de los datos.</strong>  Desear√≠a que hubiera suficientes datos en el evento para que pudieran procesarse. </li></ul><br><ul><li>  <strong>Integridad</strong>  Delegamos el bus de eventos para verificar que el evento sea consistente y que pueda manejarlo. </li><li>  <strong>El orden es importante.</strong>  En el caso de un retorno, nos vemos obligados a trabajar con la historia.  Con las notificaciones, el orden no es importante, si son notificaciones homog√©neas, el correo electr√≥nico ser√° el mismo sin importar qu√© orden lleg√≥ primero.  En el caso de una devoluci√≥n, hay un proceso claro, si cambia el pedido, habr√° excepciones, el reembolso no se crear√° ni procesar√°; terminaremos en un estado diferente. </li><li>  <strong>Coherencia</strong>  Tenemos un repositorio y ahora, en lugar de la API, creamos eventos.  Necesitamos una forma de transferir de manera r√°pida y econ√≥mica informaci√≥n sobre nuevos eventos y cambios a los existentes a nuestros servicios.  Esto se logra utilizando una especificaci√≥n com√∫n en un repositorio git separado y generadores de c√≥digo.  Por lo tanto, los clientes y servidores en diferentes servicios est√°n coordinados con nosotros. </li></ul><br><h2>  Kafka en Lamoda </h2><br>  Tenemos tres instalaciones de Kafka: <br><br><ol><li>  Registros </li><li>  I + D; </li><li>  Eventos-bus. </li></ol><br>  Hoy solo estamos hablando del √∫ltimo punto.  En eventos-bus, no tenemos instalaciones muy grandes: 3 corredores (servidores) y un total de 27 temas.  Como regla general, un tema es un proceso.  Pero este es un momento delicado, y ahora lo tocaremos. <br><br><img src="https://habrastorage.org/webt/1v/5s/nj/1v5snjoqmrg2sb1grok5snkzowu.png"><br><br>  Arriba est√° el gr√°fico rps.  El proceso de reembolso est√° marcado con una l√≠nea turquesa (s√≠, la que se encuentra en el eje X), y rosa es el proceso de actualizaci√≥n de contenido. <br><br>  El cat√°logo de Lamoda contiene millones de productos, con datos que se actualizan todo el tiempo.  Algunas colecciones pasan de moda, se lanzan nuevas en lugar de ellas, constantemente aparecen nuevos modelos en el cat√°logo.  Intentamos predecir lo que ser√° interesante para nuestros clientes ma√±ana, por lo que constantemente compramos cosas nuevas, las fotografiamos y actualizamos la ventana. <br><br>  Los picos rosados ‚Äã‚Äãson una actualizaci√≥n del producto, es decir, cambios en los productos.  Se puede ver que los chicos tomaron fotos, tomaron fotos, ¬°y luego otra vez!  - Descarg√≥ un paquete de eventos. <br><br><h2>  Casos de uso de Lamoda Events </h2><br>  Utilizamos la arquitectura construida para tales operaciones: <br><br><ul><li>  <strong>Seguimiento de estados de retorno</strong> : llamado a la acci√≥n y seguimiento de estados de todos los sistemas involucrados.  Pago, estados, fiscalizaci√≥n, notificaciones.  Aqu√≠ probamos el enfoque, creamos las herramientas, recopilamos todos los errores, escribimos la documentaci√≥n y les dijimos a los colegas c√≥mo usarla. </li><li>  <strong>Actualizaci√≥n de tarjetas de producto:</strong> configuraci√≥n, metadatos, caracter√≠sticas.  Un sistema lee (que se muestra) y varios escriben. </li><li>  <strong>Correo electr√≥nico, push y sms</strong> : el pedido se recoge, el pedido ha llegado, la devoluci√≥n ha sido aceptada, etc., muchos de ellos. </li><li>  <strong>Stock, actualizaci√≥n de almac√©n</strong> : una actualizaci√≥n cuantitativa de los art√≠culos, solo n√∫meros: recibo en el almac√©n, devoluci√≥n.  Es necesario que todos los sistemas relacionados con la reserva de bienes operen con los datos m√°s relevantes.  Ahora el sistema de actualizaci√≥n de drenaje es bastante complicado, Kafka lo simplificar√°. </li><li>  <strong>An√°lisis de datos</strong> (departamento de I + D), herramientas ML, an√°lisis, estad√≠sticas.  Queremos que la informaci√≥n sea transparente, para esto Kafka es muy adecuado. </li></ul><br>  Ahora, la parte m√°s interesante es sobre conos rellenos y descubrimientos interesantes que tuvieron lugar durante seis meses. <br><br><h2>  Problemas de dise√±o </h2><br>  Supongamos que queremos hacer algo nuevo, por ejemplo, transferir todo el proceso de entrega a Kafka.  Parte del proceso ahora se est√° implementando en el procesamiento de pedidos en BOB.  Detr√°s de la transferencia del pedido al servicio de entrega, la transferencia a un almac√©n intermedio, etc., hay un modelo de estado.  Hay un monolito completo, incluso dos, m√°s un mont√≥n de API de entrega.  Saben mucho m√°s sobre la entrega. <br><br>  Estas parecen ser √°reas similares, pero para el procesamiento de pedidos en el BOB y para el sistema de entrega, los estados son diferentes.  Por ejemplo, algunos servicios de mensajer√≠a no env√≠an estados intermedios, sino solo estados finales: "entregados" o "perdidos".  Otros, por el contrario, informan sobre el movimiento de mercanc√≠as con gran detalle.  Todos tienen sus propias reglas de validaci√≥n: para alguien, el correo electr√≥nico es v√°lido, por lo que se procesar√°;  para otros, no es v√°lido, pero el pedido a√∫n se procesar√° porque hay un tel√©fono para la comunicaci√≥n y alguien dir√° que dicho pedido no se procesar√° en absoluto. <br><br><h3>  Flujo de datos </h3><br>  En el caso de Kafka, surge la cuesti√≥n de organizar el flujo de datos.  Esta tarea est√° relacionada con la elecci√≥n de la estrategia para varios puntos, los revisaremos todos. <br><br><h4>  En un tema o en diferente? </h4><br>  Tenemos una especificaci√≥n de evento.  En BOB, escribimos que dicho pedido debe entregarse e indicamos: el n√∫mero de pedido, su composici√≥n, algunos c√≥digos de barras y SKU, etc.  Cuando los productos lleguen al almac√©n, la entrega podr√° recibir estados, marcas de tiempo y todo lo que se necesita.  Pero adem√°s queremos recibir actualizaciones sobre estos datos en BOB.  Nos enfrentamos al proceso inverso de obtener datos de la entrega.  ¬øEs este el mismo evento?  ¬øO es un intercambio separado que merece un tema separado? <br><br>  ,    ,      ,     ‚Äî   ,  ,    .   . <br><br><h4>     ? </h4><br>      ,    . ,        DTO,    BOB.    id,     ,      ,       event-bus   . <br><br>     event-bus ,    ,    BOB         .      ‚Äî    . <br><br>    ‚Äî    .  ,   -   , ,  ,   ,      .       ‚Äî   .   ‚Äî    ,    .        JSON      . <br><br>   refunds        .     -,   refund update,     type, ,     update .      ¬´¬ª   ,  ,        type. <br><br><h4>   </h4><br>     Kafka   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Avro</a> ,          Confluent.        .        replication log,    ¬´¬ª.  ,    ,     : ,    .    ,     ,   ,    . <br><br><h4>    partitions </h4><br>   Kafka   partitions.          ,  ,  ,     . <br><br>       Kafka  .     partition,        .       . , ,    ,      .  , ,  ,    Kafka   partition,  Kafka       ‚Äî  ,  . <br><br>  Kafka  ?      (    JSON)   key.      -,   ,   partition  . <br><br>     refunds  ,     partition,   ,           . - ,            partition. <br><br><h4> Events vs commands </h4><br>    ,    . Event ‚Äî   :  ,  - -  (something_happened), , item    refund.    - ,   ¬´item ¬ª  refund  ,  ¬´ refund¬ª  -  . <br><br>  ,    ,        ‚Äî    ,   -  .     something_happened (item_canceled, refund_refunded),  something_should_be_done. , item   . <br><br>   ,  ,    .   ,        .   ,      do_something.     ,    - ;   ,   ;    ,   -,   -  .   ,    do_something,    ,   . <br><br><img src="https://habrastorage.org/webt/gy/xo/vm/gyxovmgvxv3wbwkv_k7mzluobls.png"><br><br>     RabbitMQ,    ,   http,    response ‚Äî  ,    .     Kafka,  ,     Kafka,   ,   ,    . <br><br>             ,    - ,  -       .    ,  , -   . ,     ¬´item_ready_to_refund¬ª,  ,  refund ,   ,    ¬´money_refunded¬ª.    ,   . <br><br><h3>  Matices </h3><br>    :      ,    -  ,  ,     .   <strong>  </strong> ,  offset ,   . <br><br>    ,   ,     .    ,        events-bus,        ,         PostgreSQL,        MySQL  UNSIGNED INT,      PostgreSQL   INT.     ,  Id  . Symfony   . , ,  ,     ,     offset,       ,     .        ,  Symfony     ,          offset. <br><br> -    ‚Äî  ,  Kafka    ,    .       .  . <br><br>  Kafka    tooling   offset.    ,     ‚Äî      ,     , redeployments.   Kafka  tooling   offset,   . <br><br>   ‚Äî <strong>replication log vs rdkafka.so</strong> ‚Äî     .   PHP,   PHP,  ,  ,   Kafka   rdkafka.so,    - .  ,    ,  ,        - .  ,   . <br><br>      partitions,     <strong>consumers &gt;= topic partitions</strong> .       ,   .        ,      partitions.  ,      partition,    20  ,    ,     . ,     ,    partitions. <br><br><h2>  Monitoreo </h2><br> ,  ,   ,   ,      . <br><br> , ,       , , ,       ,        .   Kafka    ,       . ,         . <br><br><img src="https://habrastorage.org/webt/il/on/va/ilonvaqqf3tkfcv9reuyezxpgoq.png"><br><br>  ,  ,    ,   events-bus ,     . ,     Refund Tool  ,   BOB  -  ( ). <br><br><img src="https://habrastorage.org/webt/i4/9b/jf/i49bjfsr_lrypwz0_1qfkhhmcjq.png"><br><br>    consumer-group lag.  ,    .       ,     0,      . Kafka    ,     . <br><br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Burrow</a> ,       Kafka.    API  consumer-group  ,     .    Failed   warning,    ,         ‚Äî    ,  .   ,   . <br><br><img src="https://habrastorage.org/webt/4j/ht/go/4jhtgoqjn_0kdgvagxkg3flceng.png"><br><br>     API.   bob-live-fifa, partition refund.update.v1,  , lag 0 ‚Äî   offset -. <br><br><img src="https://habrastorage.org/webt/mh/gn/aq/mhgnaq2qcxamaejf1fkdkkkqnwu.png"><br><br>  <strong>updated_at SLA (stuck)</strong>   . ,    ,     .   Cron,  ,    5       refund (       ),  -    ,      .    Cron,    ,     0,   . <br><br> <b> ,   , </b> : <br><br><ul><li>    ; </li><li>    ; </li><li>     . </li></ul><blockquote>  ,      ‚Äî  API  Kafka,          . <br> -,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HighLoad++</a>     ,       ,         . <br> -,               <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">KnowledgeConf</a> .  ,  26 ,      . <br>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">++</a> ( DevOpsConf  ) ‚Äî      ,          . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445424/">https://habr.com/ru/post/445424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445414/index.html">C√≥mo los libros de ciencia sovi√©ticos se convirtieron en un artefacto entre f√≠sicos e ingenieros en India</a></li>
<li><a href="../445416/index.html">¬øPor qu√© los discos de vinilo sobreviven a la era digital?</a></li>
<li><a href="../445418/index.html">Homo sapiens? Ya no</a></li>
<li><a href="../445420/index.html">Hay 17 mil millones de computadoras en la corteza cerebral</a></li>
<li><a href="../445422/index.html">¬øQu√© lenguajes de programaci√≥n son los menos seguros?</a></li>
<li><a href="../445426/index.html">Optimizaci√≥n para PostgreSQL que sirve la aplicaci√≥n Rails</a></li>
<li><a href="../445428/index.html">Wi-Fi de alta calidad: la base de la hospitalidad moderna y el motor de los negocios</a></li>
<li><a href="../445432/index.html">Administrador de paquetes de Unity</a></li>
<li><a href="../445434/index.html">Mejor trabajo peor del mundo: buscando un Habraautor</a></li>
<li><a href="../445436/index.html">Reentrenamiento en DevOps: para qu√© prepararse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>