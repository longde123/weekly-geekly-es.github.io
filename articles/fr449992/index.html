<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêß üë©üèæ‚Äçüöí üí™üèø Pr√©sentation du mod√®le de pilote simple (SDM) NodeMCU: interface utilisateur dynamique üë®üèΩ‚Äç‚öñÔ∏è üóÑÔ∏è üàØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="NodeMCU est un firmware interactif , qui permet d'ex√©cuter l'interpr√©teur Lua sur le microcontr√¥leur ESP8266 (le support ESP32 est en cours de d√©velop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√©sentation du mod√®le de pilote simple (SDM) NodeMCU: interface utilisateur dynamique</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449992/"><p><img src="https://habrastorage.org/webt/45/dq/e8/45dqe8yvyxvpg_kcien-88xslei.jpeg" alt="image"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NodeMCU</a> est un <em>firmware interactif</em> , qui permet d'ex√©cuter l'interpr√©teur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua</a> sur le microcontr√¥leur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP8266</a> (le support <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP32</a> est en cours de d√©veloppement).  En plus de toutes les interfaces mat√©rielles habituelles, il dispose d'un module WiFi et d'un syst√®me de fichiers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SPIFFS</a> . </p><br><p>  Cet article d√©crit le nouveau module pour le NodeMCU - sdm.  SDM signifie mod√®le de pilote simple et fournit une abstraction de mod√®le de pilote de p√©riph√©rique pour le syst√®me.  Dans la premi√®re partie de cet article, nous discuterons du mod√®le lui-m√™me et dans la deuxi√®me partie, nous pr√©senterons une interface utilisateur Web cr√©√©e dynamiquement √† l'aide de sdm avec quelques commentaires. </p><a name="habracut"></a><br><h1 id="driver-model-basics">  Principes de base du mod√®le de pilote </h1><br><p>  Les deux principaux composants du mod√®le sont les <em>p√©riph√©riques</em> et les <em>pilotes</em> .  Le p√©riph√©rique est une repr√©sentation abstraite d'un mat√©riel ou d'un p√©riph√©rique virtuel.  Il est logique de placer les appareils dans une hi√©rarchie arborescente, avec le microcontr√¥leur en haut, les bus au milieu et les capteurs en feuilles. </p><br><pre><code class="plaintext hljs">DEVICES + DRIVERS | +-----+ | +-----+ |1WIRE&lt;----------------------+1WIRE| ++-+-++ | +-----+ | | | | +---------+ | +--------+ | +------+ | | | +------+DS1820| +---v----+ +---v----+ +---v----+ | | +------+ |DS1820|0| |DS1820|1| |DS1822|0| | | +---^----+ +---^----+ +---^----+ | | +------+ | | +--------------+DS1822| | | | | +------+ +-----------+------------------+ +</code> </pre> <br><p>  Le pilote de p√©riph√©rique est un √©l√©ment logique associ√© au p√©riph√©rique donn√©.  Les fonctions fournies par le pilote sont appel√©es <em>m√©thodes</em> , les conteneurs de donn√©es associ√©s au pilote sont appel√©s <em>attributs</em> .  Les m√©thodes et les attributs vivent dans le pilote. </p><br><p>  Les attributs ont deux fonctions qui leur sont associ√©es: les crochets <em>getter</em> et <em>setter</em> .  Attribue donc des fonctionnalit√©s de m√©thode de sur-ensemble, mais elles prennent √©galement plus de m√©moire (la m√©moire du microcontr√¥leur est rare, vous vous souvenez?). </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-comment"><span class="hljs-comment">-- device handle "ref", -- attribute name "Reference voltage", -- attribute description 5, function(dev) -- this is a getter function return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) -- this is a setter function sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end )</span></span></code> </pre> <br><h2 id="device-binding">  Liaison de p√©riph√©rique </h2><br><p>  La partie d√©licate du mod√®le de pilote est la liaison de pilote de p√©riph√©rique.  Le processus lui-m√™me est assez simple: nous adaptons le p√©riph√©rique √† chaque pilote disponible jusqu'√† ce qu'il corresponde.  Il ne manque que deux parties: la logique de correspondance et certaines donn√©es auxquelles correspondre. </p><br><p>  Dans sdm, la logique de correspondance r√©side dans les pilotes sous le nom <code>_poll()</code> .  Il s'agit d'une m√©thode r√©guli√®re qui est appel√©e avec le descripteur de p√©riph√©rique en tant que param√®tre et renvoie <code>true</code> ou <code>false</code> si le p√©riph√©rique peut ou ne peut pas √™tre attach√© au pilote respectivement. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- get device attribute "id" if attr == nil then return false end -- if it does not have one, driver does not match -- parent name must be "ESP8266_1W" and first byte of "id" must be "0x28" return (sdm.device_name(par) == "ESP8266_1W") and (attr:byte(1) == 0x28) end )</span></span></code> </pre> <br><p>  Comme vu dans l'exemple ci-dessus, le pilote fait correspondre le p√©riph√©rique √† l'aide de l'attribut.  Mais comme indiqu√© ci-dessus, les attributs ne s'associent qu'au pilote.  En g√©n√©ral, c'est vrai, mais certains attributs ne peuvent pas √™tre r√©cup√©r√©s via un logiciel.  Ce sont des identifiants de puce, des broches utilis√©es, etc.  Pour ceux-ci, un type d'attribut sp√©cial a √©t√© ajout√© √† l'attribut sdm- <em>local</em> .  Cet attribut est associ√© √† une instance de l'appareil et g√©n√©ralement immuable. </p><br><p>  La seule chose qui reste √† dire sur la liaison du pilote.  Habituellement, les appareils n√©cessitent une sorte d'initialisation au d√©marrage et au nettoyage apr√®s utilisation.  √Ä cette fin, sdm utilise les <code>_init()</code> et <code>_free()</code> . <br>  Si le pilote a la m√©thode <code>_init()</code> , il sera appel√© automatiquement apr√®s la liaison du p√©riph√©rique.  M√™me chose avec <code>_free()</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> sdm.device_rename(dev, sdm.request_name(<span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- rename device sdm.attr_copy(dev, "temp") -- copy attribute sdm.attr_copy(dev, "precision") -- copy attribute local met = sdm.method_dev_handle(par, "setup") -- get 1Wire bus pin init function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end ) sdm.method_add(drv, "_free", nil, function(dev, drv, par) local met = sdm.method_dev_handle(par, "free") -- get 1Wire bus pin free function .. local func = sdm.method_func(met) -- .. and .. func(par, dev) -- .. call it end )</span></span></code> </pre> <br><p>  Un lecteur attentif demanderait probablement: que signifie ¬´copier l'attribut¬ª dans l'exemple ci-dessus?  Et il aurait raison, car cela a √† voir avec le troisi√®me type d'attribut dont nous n'avons pas encore discut√© - <em>l'attribut priv√©</em> .  Il n'est pas tr√®s logique de partager toutes les donn√©es d'attribut entre toutes les instances de p√©riph√©rique.  √Ä cet effet, sdm fournit un m√©canisme de copie d'attribut du pilote et de l'associer √† l'appareil.  Cela fait que le pilote attribue un prototype ou un mod√®le. </p><br><p>  Un r√©sum√© rapide: </p><br><ul><li>  <em>les attributs locaux</em> sont utilis√©s pour les donn√©es qui ne peuvent pas √™tre r√©cup√©r√©es par le logiciel.  Comme les ID d'appareil, les broches connect√©es, etc. </li><li>  <em>les attributs de pilote</em> sont utilis√©s pour les donn√©es partag√©es entre toutes les instances de p√©riph√©riques connect√©s √† ce pilote. </li><li>  <em>les attributs priv√©s</em> sont copi√©s √† partir des attributs du pilote et contiennent des donn√©es associ√©es √† une seule instance de p√©riph√©rique.  Ce type est le plus courant. </li></ul><br><div class="scrollable-table"><table><thead><tr><th>  Biens </th><th>  Attribut local </th><th>  Attribut priv√© </th><th>  Attribut de pilote (public) </th></tr></thead><tbody><tr><td>  Stock√© dans </td><td>  appareil </td><td>  appareil </td><td>  chauffeur </td></tr><tr><td>  Accessible √† l'aide de la poign√©e du conducteur </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Accessible √† l'aide de la poign√©e de l'appareil </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Partag√© entre les appareils </td><td>  - </td><td>  - </td><td>  + </td></tr><tr><td>  Persister √† d√©tacher le conducteur </td><td>  + </td><td>  - </td><td>  + </td></tr></tbody></table></div><br><h1 id="web-user-interface-implementation">  Impl√©mentation de l'interface utilisateur Web </h1><br><h2 id="server-code">  Code serveur </h2><br><p>  Il y a un joli projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/marcoskirsch/nodemcu-">nodemcu-httpserver</a> qui impl√©mente le code serveur pour NudeMCU.  Malheureusement, il semble √™tre mort.  Il a √©t√© utilis√© comme base pour le serveur.  Tout d'abord, les fonctions du serveur ont √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">d√©plac√©es vers LFS</a> puis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitlab.com/matsievskiysv/nodemcu-pseudo">l√©g√®rement modifi√©es</a> pour servir une page statique pour chaque appel.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vue.js</a> est un choix parfait pour les pages Web bas√©es sur des mod√®les.  Il a donc √©t√© utilis√© pour le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">frontend</a> .  Il convient de noter que NodeMCU n'est peut-√™tre pas connect√© √† Internet.  Pour cette raison, la biblioth√®que <code>vue.js</code> doit √™tre pr√©sente localement et servie par le serveur NodeMCU. </p><br><p>  √âtant donn√© que tous les p√©riph√©riques sont organis√©s en arborescence, ils sont accessibles comme un r√©pertoire: <code>/ESP8266/ESP8266_1W/DS18S20-0</code> .  Ici <code>/ESP8266</code> est une page NodeMCU, <code>/ESP8266/ESP8266_1W</code> est une page de bus <em>1Wire</em> et enfin <code>/ESP8266/ESP8266_1W/DS18S20-0</code> est un capteur de temp√©rature. </p><br><p>  Comme mentionn√© pr√©c√©demment, toutes les pages de l'appareil sont construites √† partir d'une page de mod√®le qui est servie √† chaque appel.  <em>Le</em> code <em>JS √† l'</em> int√©rieur de cette page fait ensuite la demande √† la m√™me URL, pr√©c√©d√©e de <code>/api</code> .  Pour l'exemple ci-dessus, l'URL d'appel serait <code>/api/ESP8266/ESP8266_1W/DS18S20-0</code> .  Sur ces demandes, le serveur r√©pond avec des donn√©es sp√©cifiques au p√©riph√©rique encod√©es <em>JSON, qui</em> remplissent la page.  Bien s√ªr, la demande de page <em>HTML</em> peut √™tre ignor√©e si seules des donn√©es brutes sont n√©cessaires. </p><br><h2 id="device-tree">  Arborescence des appareils </h2><br><p>  La configuration initiale du p√©riph√©rique est effectu√©e √† l'aide d' <em>une</em> structure <em>arborescente de p√©riph√©rique simple</em> .  C'est comme l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arborescence des appareils</a> , mais plus simple.  Il d√©crit la configuration du mat√©riel, y compris les attributs locaux du p√©riph√©rique. </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> root={ <span class="hljs-comment"><span class="hljs-comment">-- local_attributes={}, children={ { name="ESP8266_1W", -- local_attributes={}, children = { { name="DS18S20-0", -- static declaration alternative to 1Wire poll method local_attributes={ { name="id", desc=nil, -- empty description to save space data=string.char(16) .. string.char(221) .. string.char(109) .. string.char(104) .. string.char(3) .. string.char(8) .. string.char(0) .. string.char(150) -- ugly way to create byte array }, { datapin=2 } } }, } }, { name="ESP8266_SPI", -- local_attributes={}, children = { { name="MCP3208-0" }, } }, } }</span></span></code> </pre> <br><h2 id="hardware-setup">  Configuration mat√©rielle </h2><br><p>  Ici commence la vitrine.  √Ä cet effet, un tas de capteurs ont √©t√© connect√©s au NodeMCU: </p><br><ul><li>  Capteur de temp√©rature <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DS18B20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Capteur de</a> temp√©rature <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DS18S20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MCP3208</a> ADC </li></ul><br><p>  <em>1Les</em> capteurs √† <em>fil</em> sont connect√©s √† la m√™me broche. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fb/sw/zi/fbswzi7xav_pj4waz6g19hktrso.jpeg"></a> </p><br><h2 id="web-pages-and-drivers">  Pages Web et pilotes </h2><br><h3 id="root-device">  p√©riph√©rique racine </h3><br><p>  Le principal objectif du p√©riph√©rique racine (alias ESP8266) est de fournir un espace de connexion √† ses enfants.  Cependant, il n'est pas limit√© d'avoir des m√©thodes ou des attributs qui lui sont associ√©s. </p><br><p>  Cet extrait de code est d' <a href="">ici</a> : </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_init"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- get device "id" attribute sdm.attr_set(attr, node.chipid()) -- set "id" value attr = sdm.attr_handle(dev, "float") -- get device "float" attribute sdm.attr_set(attr, 3 / 2 ~= 1) -- set to true if firmware supports floating point instructions end ) sdm.attr_add(drv, "float", "Floating point build", false, function(drv) -- attribute value is set inside "_init" function local attr = sdm.attr_drv_handle(drv, "float") return sdm.attr_data(attr) -- just return stored value end, nil )</span></span></code> </pre> <br><p>  Ce code ajoute un attribut <code>float</code> qui est utilis√© pour contenir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">type de construction du</a> firmware.  Sa valeur est initialis√©e dans le <code>_init()</code> qui est une fonction sp√©ciale, qui s'ex√©cute une fois lorsque le pilote se connecte au p√©riph√©rique. </p><br><p>  Il s'agit de la page g√©n√©r√©e pour le p√©riph√©rique racine. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/mg/5q/lo/mg5qlog3-nwjkl6itrfw6ynyvuo.png"></a> </p><br><p>  Ici, nous pouvons voir que le p√©riph√©rique racine a un <code>heap</code> m√©thode, deux attributs de pilote <code>float</code> et <code>id</code> .  Enfin, il est connect√© √† deux appareils <em>: les</em> bus <em>SPI</em> et <em>1Wire</em> . </p><br><h3 id="spi">  SPI </h3><br><p>  <a href=""><em>Le</em> pilote <em>SPI</em></a> n'est pas tr√®s int√©ressant.  Il mappe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">simplement les</a> fonctions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NodeMCU SPI</a> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qx/mx/g8/qxmxg8mnkmnl5aglfq7q5zhpnv0.png"></a> </p><br><h3 id="mcp3208">  Mcp3208 </h3><br><p>  <em>Le MCP3208</em> est une puce <em>ADC</em> .  Il mesure les tensions de z√©ro √† <em>ref</em> et renvoie du code 12 bits.  Ce qui est int√©ressant dans cette impl√©mentation de <a href="">pilote,</a> c'est que l'attribut <code>ref</code> ne serait pr√©sent que si le micrologiciel prend en charge l'arithm√©tique √† virgule flottante.  S'il n'est pas pris en charge, au lieu de la tension absolue, le code de tension est renvoy√© par <code>differential</code> m√©thodes <code>single</code> et <code>differential</code> . </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"single"</span></span>, <span class="hljs-string"><span class="hljs-string">"Single ended measure 0|1|2|3|4|5|6|7"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, channel)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... if ref ~= nil then -- this part is executed only if floating point arithmetic is enabled rv = ref * rv / 4096 end return rv end ) if 3/2~=1 then -- other alternative is to access ESP8266 "float" method sdm.attr_add(drv, "ref", "Reference voltage", 5, function(dev) return sdm.attr_data(sdm.attr_handle(dev, "ref")) end, function(dev, value) sdm.attr_set(sdm.attr_handle(dev, "ref"), value) end ) end</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/m_/_l/cc/m__lccntxwsrorrujvky3opbm0s.png"></a> </p><br><p>  Notez √©galement que cet appareil a l'attribut <code>ref</code> marqu√© comme <em>priv√©</em> .  Il est d√©fini par p√©riph√©rique. </p><br><h3 id="1wire">  1 fil </h3><br><p>  <a href=""><em>1 Le</em> pilote pilote</a> impl√©mente la m√©thode d' <code>poll</code> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recherche dynamique de p√©riph√©riques</a> . </p><br><p>  Juste apr√®s la d√©couverte de l'appareil, son type n'est pas connu.  Ainsi, son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adresse unique</a> <em>1Wire</em> est utilis√©e comme nouveau nom de p√©riph√©rique (octets repr√©sent√©s par des nombres s√©par√©s par un caract√®re <code>_</code> ). </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"poll"</span></span>, <span class="hljs-string"><span class="hljs-string">"Poll for devices"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bus, pin)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> children = sdm.device_children(bus) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> {} <span class="hljs-comment"><span class="hljs-comment">-- already attached local ids = {} -- get IDs of attached devices for name, handle in pairs(children) do local dpin = sdm.attr_data(sdm.local_attr_handle(handle, "pin")) if dpin == pin then ids[sdm.attr_data(sdm.local_attr_handle(handle, "id"))] = true end end ow.reset_search(pin) -- reset previous search while true do -- for all found devices local id = ow.search(pin) if id == nil then break end if ids[id] == nil then -- if not already present local name = "" for i=1,#id do name = name .. tostring(id:byte(i)) .. "_" end name = name:sub(1,-2) -- add to system with their ID used as name local device = sdm.device_add(name, bus) -- add "pin" attribute local rv = sdm.local_attr_add(device, "datapin", nil, pin, nil, nil) -- add "id" attribute local rv = sdm.local_attr_add(device, "id", nil, id, nil, nil) -- poll for driver local rv = sdm.device_poll(device) end end end )</span></span></code> </pre> <br><p>  Ceci est la page initiale du pilote <em>1Wire</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/j2/uq/ax/j2uqaxkhqilv0k1fmwaq2hn0iwq.png"></a> </p><br><p>  Apr√®s avoir √©mis un <code>poll</code> avec l'argument <code>2</code> et une page rafra√Æchissante, la section enfants appara√Æt.  Notez que les noms d'enfants sont lisibles par l'homme.  En effet, la fonction <code>device_rename()</code> √©t√© appel√©e lors de leur <code>_init</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_z/2x/na/_z2xnadqlt_qgyokfxomwivtwkq.png"></a> </p><br><h3 id="ds18s20">  DS18S20 </h3><br><p>  Lors de l'initialisation, le <a href="">pilote DS18S20</a> v√©rifie que l' <em>ID de</em> p√©riph√©rique commence par <code>0x10</code> , qui est un code de famille de p√©riph√©riques.  Lorsque le p√©riph√©rique est connect√© au pilote, il est renomm√© <code>DS18S20-X</code> , o√π <code>DS18S20</code> est un nom de base et <code>X</code> est un num√©ro d'instance. </p><br><pre> <code class="lua hljs">sdm.method_add(drv, <span class="hljs-string"><span class="hljs-string">"_poll"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, drv, par)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_data(sdm.local_attr_handle(dev, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> attr == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sdm.device_name(par) == <span class="hljs-string"><span class="hljs-string">"ESP8266_1W"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (attr:<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0x10</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- check family ID end ) sdm.method_add(drv, "_init", nil, function(dev, drv, par) sdm.device_rename(dev, sdm.request_name("DS18S20")) -- rename device sdm.attr_copy(dev, "temp") -- copy attribute to device local met = sdm.method_dev_handle(par, "setup") local func = sdm.method_func(met) -- use parent "setup" method on the device func(par, dev) end )</span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/bm/pk/41/bmpk419dphexm-xlvnxq7hw2jxc.png"></a> </p><br><p>  Les attributs locaux <code>id</code> et <code>datapin</code> n'ont pas de crochets <code>getter</code> et <code>setter</code> , donc seuls leurs noms sont visibles. </p><br><h3 id="ds18b20">  DS18B20 </h3><br><p>  <a href="">Le pilote DS18B20</a> est presque le m√™me que le <a href="">pilote DS18S20</a> .  La seule diff√©rence est la m√©thode de <code>precision</code> .  Les deux pilotes <em>DS18? 20</em> supposent une construction enti√®re et n'utilisent pas la division en virgule flottante. </p><br><pre> <code class="lua hljs">sdm.attr_add(drv, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>, <span class="hljs-string"><span class="hljs-string">"Precision (9|10|11|12)"</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sdm.attr_data(attr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dev, precision)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> par = sdm.device_parent(dev) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> attr = sdm.attr_dev_handle(dev, <span class="hljs-string"><span class="hljs-string">"precision"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ex = sdm.method_func(sdm.method_dev_handle(par, <span class="hljs-string"><span class="hljs-string">"exchange"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> modes = {[<span class="hljs-number"><span class="hljs-number">9</span></span>]=<span class="hljs-number"><span class="hljs-number">0x1f</span></span>, [<span class="hljs-number"><span class="hljs-number">10</span></span>]=<span class="hljs-number"><span class="hljs-number">0x3f</span></span>, [<span class="hljs-number"><span class="hljs-number">11</span></span>]=<span class="hljs-number"><span class="hljs-number">0x5f</span></span>, [<span class="hljs-number"><span class="hljs-number">12</span></span>]=<span class="hljs-number"><span class="hljs-number">0x7f</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> modes[precision] ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ex(par, dev, {<span class="hljs-number"><span class="hljs-number">0x4e</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, modes[precision]}) sdm.attr_set(attr, precision) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> )</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/er/lj/gb/erljgbs9zby8767izkmsunyhdd8.png"></a> </p><br><h2 id="memory-usage">  Utilisation de la m√©moire </h2><br><p>  <em>La</em> m√©moire libre de l' <em>ESP8266</em> est d'environ <em>40k</em> .  Le code du serveur est d√©plac√© vers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitlab.com/matsievskiysv/nodemcu-">LFS</a> , il ne prend donc pas d'espace RAM au moment de l'initialisation ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/marcoskirsch/nodemcu-">le code d'origine</a> prenait environ <em>10k</em> ). </p><br><p>  <em>SDM</em> prend environ <em>10k</em> pour 5 pilotes de p√©riph√©rique et 5 p√©riph√©riques.  L√©g√®rement moindre pour la construction de firmware non flottant.  Il est donc pr√©f√©rable de ne s√©lectionner dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">manifeste du pilote</a> que les pilotes n√©cessaires √† la t√¢che √† accomplir.  La t√¢che la plus consommatrice de m√©moire consiste √† servir la biblioth√®que <code>vue.js</code> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/u-/_i/yyu-_idkp2osapmg3-jy5z2r8ly.png"></a> </p><br><p>  En cas de demande de donn√©es brutes cod√©es <em>JSON</em> (en utilisant <code>curl</code> ), la consommation de m√©moire de pointe peut √™tre consid√©rablement r√©duite. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/w_/hu/xx/w_huxxzt4w2wszdqq04bgbonbt0.png"></a> </p><br><h2 id="instead-of-an-epilogue">  Au lieu d'un √©pilogue </h2><br><p>  L'une des premi√®res m√©thodes que j'ai impl√©ment√©es avec sdm a √©t√© la liaison pour <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>node.restart()</code></a> . <br>  L'essayer en utilisant l'interface utilisateur Web a produit un r√©sultat curieux.  Juste apr√®s que le navigateur Web ait √©mis la demande, la puce a red√©marr√© comme pr√©vu.  Mais parce que NodeMCU n'a pas r√©pondu correctement √† la demande HTTP, le navigateur Web a r√©essay√© la m√™me demande.  Lorsque le serveur NodeMCU a red√©marr√© et √©tait de nouveau op√©rationnel, le navigateur s'y est connect√©, r√©initialise le compteur de <code>node.restart()</code> interne et a appel√© la m√©thode <code>node.restart()</code> , commen√ßant ainsi une boucle infinie de red√©marrage de NodeMCU. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449992/">https://habr.com/ru/post/fr449992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449976/index.html">Conteneurs associatifs multithread en C ++. Rapport Yandex</a></li>
<li><a href="../fr449978/index.html">Igor Antarov de Moscou Tesla Club se d√©bat avec 20 mythes sur Tesla et les voitures √©lectriques</a></li>
<li><a href="../fr449984/index.html">Google Actualit√©s et Leo Tolstoy: visualisation des incorporations de mots Word2Vec √† l'aide de t-SNE</a></li>
<li><a href="../fr449986/index.html">Blockchain: que devons-nous construire un bo√Ætier?</a></li>
<li><a href="../fr449990/index.html">Comment se faire des amis latex, formules et Habr?</a></li>
<li><a href="../fr449994/index.html">Les huit r√®gles d'or de Schneiderman vous aideront √† cr√©er une meilleure interface</a></li>
<li><a href="../fr449996/index.html">Comprendre l'algorithme FFT</a></li>
<li><a href="../fr449998/index.html">FAQ: ce qu'un voyageur connaisseur doit savoir sur les vaccinations avant de voyager</a></li>
<li><a href="../fr450000/index.html">(De droite √† gauche (√Ä travers le miroir)</a></li>
<li><a href="../fr450002/index.html">Recherche de bogues dans LLVM 8 avec PVS-Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>