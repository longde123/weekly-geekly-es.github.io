<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèø üç¥ üíΩ Como fazemos a automa√ß√£o de uma grande rede herdada üíÉüèø ‚õπüèø üçà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Temos mais de 15.260 objetos e 38.000 dispositivos de rede que precisam ser configurados, atualizados e verificados para estarem operacionais. A ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fazemos a automa√ß√£o de uma grande rede herdada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/468197/">  Oi  Temos mais de 15.260 objetos e 38.000 dispositivos de rede que precisam ser configurados, atualizados e verificados para estarem operacionais.  A manuten√ß√£o dessa frota de equipamentos √© bastante dif√≠cil e requer muito tempo, esfor√ßo e pessoas.  Portanto, precis√°vamos automatizar o trabalho com equipamentos de rede e decidimos adaptar o conceito de Rede como um c√≥digo para gerenciar a rede em nossa empresa.  Leia o hist√≥rico de automa√ß√£o, os erros cometidos e um plano adicional para a constru√ß√£o de sistemas. <br><br><img src="https://habrastorage.org/webt/tq/6w/po/tq6wposkryjnbyoqfcpv6qgj-q8.png"><br><a name="habracut"></a><br><h2>  Para encurtar a hist√≥ria, queremos automatizar a rede </h2><br>  Oi  Meu nome √© Alexander Prokhorov e, junto com a equipe de engenheiros de rede de nosso departamento, estamos <b>trabalhando</b> em uma rede no <b>#IT</b> <b><font color="#FFA500">X5</font></b> .  Nosso departamento desenvolve infraestrutura de rede, monitoramento, automa√ß√£o de rede e a dire√ß√£o moderna da Rede como um C√≥digo. <br><br>  Inicialmente, eu realmente n√£o acreditava em nenhuma automa√ß√£o em nossa rede em princ√≠pio.  Havia muitos erros legados e de configura√ß√£o - nem em todos os lugares havia autoriza√ß√£o central, nem todo o hardware era compat√≠vel com SSH, nem em todo lugar em que o <abbr title="Protocolo de gerenciamento de rede simples">SNMP</abbr> estava configurado.  Tudo isso minou muito a cren√ßa na automa√ß√£o.  Portanto, em primeiro lugar, colocamos em ordem o necess√°rio para iniciar a automa√ß√£o, a saber: padroniza√ß√£o da conex√£o SSH, perfis de autoriza√ß√£o √∫nica ( <abbr title="Autentica√ß√£o, Autoriza√ß√£o, Contabilidade">AAA</abbr> ) e SNMP.  Toda essa base permite que voc√™ escreva uma ferramenta para entrega em massa de configura√ß√µes para um dispositivo, mas surge a pergunta: posso obter mais?  Ent√£o chegamos √† necessidade de elaborar um plano para o desenvolvimento da automa√ß√£o e, em particular, o conceito de Rede como C√≥digo. <br><br>  O conceito de rede como c√≥digo, de acordo com a Cisco, significa os seguintes princ√≠pios: <br><br><ul><li>  Armazenar configura√ß√µes de destino no reposit√≥rio, Controle de Origem </li><li>  As altera√ß√µes de configura√ß√£o passam pelo reposit√≥rio, Fonte √önica da Verdade </li><li>  Incorporando configura√ß√µes atrav√©s da <abbr title="Interface de programa√ß√£o de aplicativos">API</abbr> </li></ul><br><img src="https://habrastorage.org/webt/bw/wi/6u/bwwi6us89ipickqukqdgd1zkvk0.jpeg" align="right" width="240"><br><br>  Os dois primeiros pontos permitem aplicar a abordagem DevOps ou NetDevOps para gerenciar sua infraestrutura de rede.  Com o terceiro par√°grafo, h√° dificuldades, por exemplo, o que fazer se n√£o houver API?  Claro, SSH e CLI, somos networkers! <br><br><div class="spoiler">  <b class="spoiler_title">E isso √© tudo o que precisamos?</b> <div class="spoiler_text">  A aplica√ß√£o desses princ√≠pios por si s√≥ n√£o resolve todos os problemas da infraestrutura de rede, assim como a aplica√ß√£o deles requer uma certa base com os dados da rede. <br><br>  Perguntas que surgiram quando pensamos sobre isso: <br><br><ul><li>  OK, eu guardo a configura√ß√£o como c√≥digo, como devo aplic√°-la em um objeto espec√≠fico? </li><li>  Ok, eu tenho um modelo de configura√ß√£o no reposit√≥rio, mas como posso configurar automaticamente uma configura√ß√£o para um objeto com base nele? </li><li>  Como descobrir qual modelo e qual fornecedor deve estar nesse objeto?  Posso fazer isso automaticamente? </li><li>  Como posso verificar se as configura√ß√µes atuais do objeto correspondem aos par√¢metros no reposit√≥rio? </li><li>  Como trabalhar com altera√ß√µes no reposit√≥rio e replic√°-las em uma rede produtiva? </li><li>  Que conjunto de dados e sistemas eu preciso pensar sobre o Zero Touch Provisioning? </li><li>  E as diferen√ßas de fornecedores e at√© modelos do mesmo fornecedor? </li><li>  Como armazenar sub-redes para configura√ß√£o autom√°tica? </li></ul><br>  Com base em todas as perguntas acima, ficou claro que precisamos de um conjunto de sistemas que resolvam v√°rios problemas, trabalhem em conjunto e nos forne√ßam informa√ß√µes completas sobre a infraestrutura de rede. <br><br><img src="https://habrastorage.org/webt/iz/us/cx/izuscxapcn5-6ync8yexgqlxs0u.jpeg"><br></div></div><br>  Al√©m de tentar aplicar novas abordagens ao gerenciamento de rede, quer√≠amos resolver alguns problemas mais agudos na infraestrutura de rede, como integridade dos dados, atualiza√ß√£o e, √© claro, automa√ß√£o.  Por automa√ß√£o, entendemos n√£o apenas a entrega em massa de configura√ß√µes para o equipamento, mas tamb√©m a configura√ß√£o autom√°tica, a coleta autom√°tica de dados de invent√°rio de equipamentos de rede e a integra√ß√£o com sistemas de monitoramento.  Mas as primeiras coisas primeiro. <br><br>  A funcionalidade que visamos √©: <br><br><ul><li>  Banco de dados de equipamentos de rede (+ descoberta, + atualiza√ß√£o autom√°tica) </li><li>  Endere√ßos de rede base (verifica√ß√µes de valida√ß√£o IPAM +) </li><li>  Integra√ß√£o de sistemas de monitoramento com dados de invent√°rio </li><li>  Armazenamento de padr√µes de configura√ß√£o no sistema de controle de vers√£o </li><li>  Forma√ß√£o autom√°tica de configura√ß√µes de destino para um objeto </li><li>  Entrega em massa de configura√ß√µes para equipamentos de rede </li><li>  Implemente um processo de CI / CD para gerenciar altera√ß√µes na configura√ß√£o da rede </li><li>  Testando configura√ß√µes de rede com CI / CD </li><li>  ZTP (Zero Touch Provisioning) - configura√ß√£o autom√°tica de equipamento para um objeto </li></ul><br><div class="spoiler">  <b class="spoiler_title">Longa hist√≥ria, tentamos automatizar</b> <div class="spoiler_text">  Come√ßamos a tentar automatizar o trabalho de configura√ß√£o de rede h√° 2 anos.  Por que agora essa pergunta surgiu novamente e precisa de aten√ß√£o? <br><br>  √â cansativo e chato configurar mais de algumas dezenas de dispositivos com as m√£os.  √Äs vezes, a m√£o do engenheiro se contrai e ele comete erros.  Para v√°rias dezenas, geralmente √© suficiente um script escrito por um engenheiro, que lan√ßa as configura√ß√µes atualizadas no equipamento de rede. <br><br>  Por que n√£o parar por a√≠?  De fato, muitos engenheiros de rede j√° sabem como fazer todos os tipos de pit√µes, e aqueles que n√£o sabem como poder√£o faz√™-lo muito em breve (Natalya Samoilenko, no entanto, publicou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um excelente trabalho em Python</a> , especialmente para redes).  Qualquer pessoa encarregada de configurar os roteadores n + 1 pode escrever um script e implementar as configura√ß√µes muito rapidamente.  Muito mais r√°pido do que ent√£o capaz de trazer tudo de volta.  De acordo com a experi√™ncia da automa√ß√£o ‚Äútodo homem por si‚Äù, ocorrem erros quando voc√™ pode restaurar a comunica√ß√£o apenas com as m√£os e apenas com grande sofrimento de toda a equipe. <br><br><img src="https://habrastorage.org/webt/rp/ts/ie/rptsiexeli86bdhhumak_d1z7eo.jpeg"><br><br><h5>  Exemplo </h5><br><img src="https://habrastorage.org/webt/ow/q8/tk/owq8tkmg8p5xeorxn0ypbwqudw0.png" align="right" width="240">  Uma vez, um dos engenheiros decidiu executar uma tarefa importante - restaurar a ordem nas configura√ß√µes dos roteadores.  Como resultado da auditoria em v√°rios objetos, foi encontrada uma <i><font color="#008080">lista de prefixos</font></i> obsoleta com sub-redes espec√≠ficas, das quais n√£o precisamos mais.  Anteriormente, era usado para filtrar os endere√ßos de <i><font color="#008080">loopback</font></i> dos sites centrais para que eles passassem por apenas um canal, e pod√≠amos testar a conex√£o nesse canal.  Mas o mecanismo foi otimizado e eles pararam de usar esse esquema de teste de canal.  O funcion√°rio decidiu remover essa <i><font color="#008080">lista de prefixos</font></i> para n√£o aparecer na configura√ß√£o e causar confus√£o no futuro.  Todos concordaram em excluir a <i><font color="#008080">lista de prefixos</font></i> n√£o utilizados, a tarefa √© simples, eles se esqueceram imediatamente.  Mas remover a mesma <i><font color="#008080">lista de prefixos</font></i> com as m√£os em dezenas de objetos √© muito chato e demorado.  E o engenheiro escreveu um script que passar√° rapidamente pelo equipamento, n√£o far√° <i><font color="#008080">"lista de prefixos pl-cisco-primer"</font></i> e salvar√° solenemente a configura√ß√£o. <br><br>  Algum tempo depois da discuss√£o, algumas horas ou um dia, n√£o me lembro, um objeto caiu.  Depois de alguns minutos, outro, semelhante.  O n√∫mero de objetos inacess√≠veis continuou a crescer, em meia hora para 10 e a cada 2-3 minutos, um novo foi adicionado.  Todos os engenheiros foram conectados para o diagn√≥stico.  40 a 50 minutos ap√≥s o in√≠cio do acidente, todos foram questionados sobre as altera√ß√µes e o funcion√°rio interrompeu o script.  Naquela √©poca, j√° havia cerca de 20 objetos com canais quebrados.  Uma restaura√ß√£o completa levou sete engenheiros por v√°rias horas. <br><br><h5>  Lado t√©cnico </h5><br>  <i><font color="#008080">A lista de prefixos foi</font></i> usada para filtrar os <i><font color="#008080">loopbacks</font></i> - um foi filtrado em um canal e o segundo no backup.  Isso foi usado para testar a comunica√ß√£o sem alternar o tr√°fego produtivo entre os canais.  Portanto, a primeira regra de um <i><font color="#008080">mapa de rota de</font></i> entrada em um vizinho <i><font color="#008080">BGP</font></i> foi <i><font color="#008080">DENY</font></i> com <i><font color="#008080">"lista de prefixos de endere√ßos IP correspondentes"</font></i> .  O restante das regras no <i><font color="#008080">mapa de rotas</font></i> foram todas <i><font color="#008080">permitidas</font></i> . <br><br>  Existem v√°rias nuances que podem ser dignas de nota: <br><br><ul><li>  A regra do <i><font color="#008080">mapa de rotas</font></i> na qual n√£o h√° <i><font color="#008080">correspond√™ncia</font></i> - ignora tudo </li><li>  No final da <i><font color="#008080">lista de prefixos est√°</font></i> <i><font color="#008080">negado impl√≠cito</font></i> , mas apenas se n√£o estiver vazio </li><li>  Uma <i><font color="#008080">lista de prefixos</font></i> vazia √© uma <i><font color="#008080">permiss√£o impl√≠cita</font></i> </li></ul><br>  Todas as alternativas acima s√£o verdadeiras para o <b>Cisco IOS</b> .  Uma <i><font color="#008080">lista de prefixos</font></i> vazia pode aparecer quando voc√™ declarar um <i><font color="#008080">mapa de rotas</font></i> , fa√ßa com que <i><font color="#008080">‚Äúcorresponda √† lista de prefixos de endere√ßos IP pl-test-cisco‚Äù</font></i> .  Esta <i><font color="#008080">lista de prefixos</font></i> n√£o ser√° declarada explicitamente na configura√ß√£o (al√©m da linha com <i><font color="#008080">correspond√™ncia</font></i> ), mas pode ser encontrada na <i><font color="#008080">lista de prefixos IP da mostra</font></i> . <br><br><pre><code class="plaintext hljs">2901-NOC-4.2(config)#route-map rm-test-in 2901-NOC-4.2(config-route-map)#match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh run | i prefix match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh ip prefix ip prefix-list pl-test-in: 0 entries 2901-NOC-4.2(config-route-map)#</code> </pre> <br>  Voltando ao que aconteceu, quando a <i><font color="#008080">lista de prefixos</font></i> foi exclu√≠da pelo script, ela ficou vazia, porque ainda estava na primeira regra <i><font color="#008080">DENY</font></i> no <i><font color="#008080">mapa de rotas</font></i> .  Uma <i><font color="#008080">lista de prefixos</font></i> vazia permite todas as sub-redes; portanto, tudo o que um par de <i><font color="#008080">BGP</font></i> nos passou passou para a primeira regra <i><font color="#008080">DENY</font></i> . <br>  Por que o engenheiro n√£o notou imediatamente que ele havia quebrado a conex√£o?  Aqui desempenhou o papel de temporizadores <i><font color="#008080">BGP</font></i> na Cisco. <br>  <i><font color="#008080">O</font></i> pr√≥prio <i><font color="#008080">BGP</font></i> n√£o troca rotas de acordo com o cronograma e, se voc√™ atualizou a pol√≠tica de roteamento do <i><font color="#008080">BGP</font></i> , √© necess√°rio redefinir a sess√£o do BGP para aplicar as altera√ß√µes, <i><font color="#008080">"clear ip bgp &lt;peer-ip&gt;"</font></i> √† Cisco. <br><br>  Para n√£o redefinir a sess√£o, existem dois mecanismos: <br><br><ul><li>  <b>Reconfigura√ß√£o suave da</b> Cisco </li><li>  <b>Atualiza√ß√£o de rota</b> como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RFC2918</a> </li></ul><br>  <b>A reconfigura√ß√£o suave</b> ret√©m as informa√ß√µes recebidas em <i><font color="#008080">UPDATE</font></i> do vizinho sobre as rotas at√© que as pol√≠ticas sejam aplicadas <i><font color="#008080">na</font></i> tabela local <i><font color="#008080">adj-RIB-in</font></i> .  Ao atualizar pol√≠ticas, torna-se poss√≠vel emular <i><font color="#008080">UPDATE</font></i> de um vizinho. <br>  <b>A atualiza√ß√£o de rota</b> √© a "capacidade" dos pares de enviar <i><font color="#008080">UPDATE</font></i> mediante solicita√ß√£o.  A disponibilidade desta oportunidade √© acordada ao estabelecer um bairro.  Pr√≥s - N√£o h√° necessidade de armazenar uma c√≥pia do <i><font color="#008080">UPDATE</font></i> localmente.  Contras - na pr√°tica, ap√≥s uma solicita√ß√£o <i><font color="#008080">UPDATE</font></i> de um vizinho, voc√™ precisa esperar at√© que ele a envie.  A prop√≥sito, voc√™ pode desativar o recurso na Cisco com um comando oculto: <br><br><pre> <code class="plaintext hljs">neighbor &lt;peer-ip&gt; dont-capability-negotiate</code> </pre><br>  H√° um recurso n√£o documentado da Cisco - um temporizador de 30 segundos, que √© acionado por uma altera√ß√£o nas pol√≠ticas de <i><font color="#008080">BGP</font></i> .  Depois de alterar as pol√≠ticas, em 30 segundos o processo de atualiza√ß√£o de rotas usando uma das tecnologias acima ser√° iniciado.  N√£o foi poss√≠vel encontrar uma descri√ß√£o documentada desse timer, mas h√° uma men√ß√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BUG CSCvi91270</a> .  Voc√™ pode aprender sobre sua disponibilidade na pr√°tica, <img src="https://habrastorage.org/webt/mk/tm/7s/mktm7sjydraauxoeajhyzkm9lyc.png" align="right" width="400">  depois de fazer altera√ß√µes no laborat√≥rio e procurar <i><font color="#008080">depurar</font></i> solicita√ß√µes <i><font color="#008080">UPDATE</font></i> para o vizinho ou o <i><font color="#008080">processo de reconfigura√ß√£o suave</font></i> .  (Se houver informa√ß√µes adicionais sobre o t√≥pico - voc√™ pode deixar nos coment√°rios) <br><br>  Para <b>a reconfigura√ß√£o suave</b> , o cron√¥metro funciona da seguinte maneira: <br><br><pre> <code class="plaintext hljs">2901-NOC-4.2(config)#no ip prefix-list pl-test seq 10 permit 10.5.5.0/26 2901-NOC-4.2(config)#do sh clock 16:53:31.117 Tue Sep 24 2019 Sep 24 16:53:59.396: BGP(0): start inbound soft reconfiguration for Sep 24 16:53:59.396: BGP(0): process 10.5.5.0/26, next hop 10.0.0.1, metric 0 from 10.0.0.1 Sep 24 16:53:59.396: BGP(0): Prefix 10.5.5.0/26 rejected by inbound route-map. Sep 24 16:53:59.396: BGP(0): update denied, previous used path deleted Sep 24 16:53:59.396: BGP(0): no valid path for 10.5.5.0/26 Sep 24 16:53:59.396: BGP(0): complete inbound soft reconfiguration, ran for 0ms Sep 24 16:53:59.396: BGP: topo global:IPv4 Unicast:base Remove_fwdroute for 10.5.5.0/26 2901-NOC-4.2(config)#</code> </pre><br>  Para <b>atualiza√ß√£o</b> de <b>rota</b> do lado do vizinho, assim: <br><br><pre> <code class="plaintext hljs">2801-RTR (config-router)# *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 rcv REFRESH_REQ for afi/sfai: 1/1 *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 start outbound soft reconfig for afi/safi: 1/1</code> </pre><br>  Se <i><font color="#008080">a Atualiza√ß√£o de rota</font></i> n√£o <i><font color="#008080">for</font></i> suportada por um dos pares e <i><font color="#008080">a entrada de reconfigura√ß√£o suave</font></i> n√£o estiver ativada, a atualiza√ß√£o de rotas pela nova pol√≠tica n√£o ocorrer√° automaticamente. <br><br>  Assim, <i><font color="#008080">a lista de prefixos</font></i> foi exclu√≠da, a conex√£o permaneceu, ap√≥s 30 segundos desapareceu.  O script conseguiu alterar a configura√ß√£o, verificar a conex√£o e salvar a configura√ß√£o.  A queda do script n√£o foi conectada imediatamente, no contexto de um grande n√∫mero de objetos. <br><br>  Tudo isso poderia ser facilmente evitado atrav√©s de testes, replica√ß√£o parcial de configura√ß√µes.H√° um entendimento de que a automa√ß√£o deve ser centralizada e controlada. <br><br><img src="https://habrastorage.org/webt/du/ew/zc/duewzcojsasaegoufuir8jymcz0.jpeg"><br></div></div><br><h2>  Os sistemas que precisamos e suas conex√µes </h2><br>  Uma breve conclus√£o do spoiler - √© melhor sistematizar e controlar o processo de entrega em massa de configura√ß√µes para n√£o chegar √† entrega em massa de erros nas configura√ß√µes. <br><br><pre> <code class="plaintext hljs">- DevOps:    50ms     4    -     : ", !@#$%"</code> </pre><br>  O esquema a que chegamos consiste em blocos de dados mestre de "neg√≥cios", blocos de dados mestre de "rede", sistemas de monitoramento de infraestrutura de rede, sistemas de entrega de configura√ß√£o, sistemas de controle de vers√£o com uma unidade de teste. <br><br><img src="https://habrastorage.org/webt/ft/sc/wl/ftscwlfa_zs4afvfwkeybwo7et0.jpeg"><br><br><h3>  Tudo o que precisamos √© de dados </h3><br>  Primeiro, precisamos saber quais objetos est√£o na empresa. <br><br>  Sistema da empresa <b>SAP</b> - <abbr title="Planejamento de recursos empresariais">ERP</abbr> .  Os dados sobre quase todas as instala√ß√µes est√£o l√°, e mais precisamente em todas as lojas e centros de distribui√ß√£o.  Assim como existem dados sobre equipamentos que passaram por um armaz√©m de TI com n√∫meros de estoque, que tamb√©m ser√£o √∫teis para n√≥s no futuro.  Apenas faltam escrit√≥rios, eles n√£o s√£o iniciados no sistema.  Estamos tentando resolver esse problema em um processo separado. A partir do momento da abertura, precisamos de uma conex√£o em cada objeto e selecionamos as configura√ß√µes de comunica√ß√£o; portanto, em algum momento, neste momento, precisamos criar dados mestre.  Mas a insufici√™ncia de dados √© um t√≥pico separado; √© melhor colocar essa descri√ß√£o em um artigo separado, se houver interesse nisso. <br><br>  <b><abbr title="Gerenciador de servi√ßos HP">HPSM</abbr></b> - um sistema que cont√©m um <abbr title="DataBase de gerenciamento de configura√ß√£o">CMDB</abbr> comum para TI, gerenciamento de incidentes, gerenciamento de mudan√ßas.  Como o sistema √© comum a toda a TI, ele deve ter todo o equipamento de TI, incluindo o equipamento de rede.  Este √© o local onde adicionaremos todos os dados finais na rede.  Com o gerenciamento de incidentes e mudan√ßas, planejamos interagir a partir de sistemas de monitoramento no futuro. <br><br>  Sabemos quais objetos temos e os enriquecemos com dados na rede.  Para esse fim, temos dois sistemas - <abbr title="Gerenciamento de endere√ßo IP">IPAM</abbr> da <i>SolarWinds</i> e nosso pr√≥prio sistema CMDB.noc. <br><br>  <b>IPAM</b> - armazenamento de sub-redes IP, os dados mais corretos e corretos sobre a propriedade do endere√ßo IP na empresa devem estar aqui. <br><br>  <b>CMDB.noc</b> - um banco de dados com uma interface WEB na qual os dados est√°ticos dos equipamentos de rede s√£o armazenados - roteadores, comutadores, pontos de acesso, al√©m de provedores e suas caracter√≠sticas.  Sob est√°tica, significa que sua mudan√ßa √© realizada apenas com a participa√ß√£o do homem.  Em outras palavras, a descoberta autom√°tica n√£o faz altera√ß√µes nesse banco de dados; precisamos entender o que "deve" ser instalado no objeto.  Sua base √© necess√°ria como um amortecedor entre os sistemas produtivos com os quais toda a empresa trabalha e as ferramentas de rede internas.  Acelera o desenvolvimento, adicionando os campos necess√°rios, novos relacionamentos, ajustando par√¢metros, etc.  Al√©m disso, esta solu√ß√£o n√£o est√° apenas na velocidade do desenvolvimento, mas tamb√©m na presen√ßa desses relacionamentos entre os dados de que precisamos, sem compromisso.  Como um mini-exemplo, usamos v√°rios <abbr title="ID externo">exid</abbr> no banco de dados para comunica√ß√£o entre IPAM, SAP e HPSM. <br><br>  Como resultado, recebemos dados completos sobre todos os objetos, com equipamentos de rede e endere√ßos IP conectados.  Agora precisamos de modelos de configura√ß√£o ou servi√ßos de rede que fornecemos nesses sites. <br><br><img src="https://habrastorage.org/webt/uy/qp/7f/uyqp7fxlkyf4rluokbotmtg5wvy.jpeg"><br><br><h3>  Fonte √∫nica da verdade </h3><br>  Aqui, chegamos √† aplica√ß√£o do primeiro princ√≠pio NaaC - armazenando configura√ß√µes de destino no reposit√≥rio.  No nosso caso, este √© o Gitlab.  A escolha para n√≥s foi simples: <br><br><ul><li>  Em primeiro lugar, j√° temos essa ferramenta em nossa empresa, n√£o precisamos implant√°-la do zero </li><li>  Em segundo lugar, √© bastante adequado para todas as nossas tarefas atuais e futuras na infraestrutura de rede </li></ul><br>  A principal parte interessante da automa√ß√£o acontecer√° no Gitlab - o processo de alterar o padr√£o de configura√ß√£o ou, mais simplesmente, o modelo. <br><br><h5>  Exemplo de processo de mudan√ßa padr√£o </h5>  Um dos tipos de objetos que temos √© a loja Pyaterochka.  L√°, uma topologia t√≠pica consiste em um roteador e um / dois comutadores.  O arquivo de configura√ß√£o do modelo √© armazenado no Gitlab, nesta parte tudo √© simples.  Mas isso n√£o √© exatamente NaaC. <br><br>  Agora, digamos que um novo projeto chegue at√© n√≥s.  As tarefas do novo projeto de TI s√£o fazer um piloto em um determinado volume de lojas.  De acordo com os resultados do piloto - se for bem-sucedido, fa√ßa uma replica√ß√£o para todos os objetos desse tipo;  caso contr√°rio, retire o piloto sem executar uma replica√ß√£o. <br><br>  Esse processo se encaixa muito bem na l√≥gica do Git: <br><br><ol><li>  Para um novo projeto, criamos um Branch, onde fazemos altera√ß√µes nas configura√ß√µes. </li><li>  No Branch, tamb√©m mantemos uma lista de objetos nos quais este projeto est√° sendo testado. </li><li>  Se for bem-sucedido, fazemos uma solicita√ß√£o de mesclagem na ramifica√ß√£o principal, que precisar√° ser replicada para a rede de produtos </li><li>  Em caso de falha, deixe o Branch para o hist√≥rico ou simplesmente exclua </li></ol><br><img src="https://habrastorage.org/webt/lx/o1/hu/lxo1hulupq0mzqe37qcodnutxno.png" align="right" width="240"><br>  Em uma primeira aproxima√ß√£o - mesmo sem automa√ß√£o, √© uma ferramenta muito conveniente para trabalhar juntos em uma configura√ß√£o de rede.  Especialmente se voc√™ imaginar que tr√™s ou mais projetos surgiram ao mesmo tempo.  Quando chegar a hora do lan√ßamento dos projetos no prod, voc√™ precisar√° resolver todos os conflitos de configura√ß√£o nas solicita√ß√µes de mesclagem e verificar se as altera√ß√µes nas configura√ß√µes n√£o s√£o mutuamente exclusivas.  E isso √© muito conveniente para fazer no git. <br><br>  Al√©m disso, essa abordagem nos adiciona a flexibilidade de usar as ferramentas de CI / CD do Gitlab para testar virtualmente as configura√ß√µes, para automatizar a entrega de configura√ß√µes para uma bancada de testes ou um grupo piloto de objetos.  // E mesmo em prod, se voc√™ quiser. <br><br><h3>  Implantando a configura√ß√£o em qualquer ambiente </h3><br>  Inicialmente, o objetivo principal era precisamente a entrega em massa de configura√ß√µes, como uma ferramenta que claramente permite economizar tempo dos engenheiros e acelerar a execu√ß√£o das tarefas de configura√ß√£o.  Para fazer isso, mesmo antes do in√≠cio da grande atividade ‚ÄúRede como um c√≥digo‚Äù, escrevemos uma solu√ß√£o em <i>python</i> para conectar-se a equipamentos para coletar configura√ß√µes de equipamentos ou para configur√°-las.  Isto √© <i>netmiko</i> , isto √© <i>pysnmp</i> , isto √© <i>jinja2</i> , etc. <br><br>  Mas √© hora de dividirmos a configura√ß√£o em massa em v√°rias subesp√©cies: <br><br><ol><li><div class="spoiler">  <b class="spoiler_title">Entrega de configura√ß√µes para zonas de teste e piloto</b> <div class="spoiler_text">  Esse item √© baseado no Gitlab CI, que permite ativar a entrega da configura√ß√£o nas zonas piloto e de teste no pipeline. <br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Duplica√ß√£o de configura√ß√µes no prod</b> <div class="spoiler_text"><ul><li>  Um item separado, geralmente a replica√ß√£o para dispositivos de 38k, ocorre em v√°rias ondas - aumentando o volume - para monitorar a situa√ß√£o no prod.  Al√©m disso, um trabalho dessa magnitude requer coordena√ß√£o do trabalho, portanto, √© melhor iniciar esse processo manualmente.  Para isso, √© conveniente usar o Ansible + -AWX e fixar a compila√ß√£o din√¢mica de invent√°rio dos nossos sistemas de dados mestre. </li><li>  Al√©m disso, √© uma solu√ß√£o conveniente quando voc√™ precisa fornecer √† segunda linha o lan√ßamento de playbooks pr√©-configurados que executam opera√ß√µes complexas e importantes, como a troca de tr√°fego entre sites. </li></ul></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Coleta de dados</b> <div class="spoiler_text"><ul><li>  Descoberta autom√°tica de dispositivos de rede </li><li>  Configura√ß√µes de backup </li><li>  Verifique a conectividade </li></ul><br>  Alocamos essa tarefa em um bloco separado, pois h√° momentos em que algu√©m desmantela um switch de repente ou instala um novo dispositivo, mas n√£o sab√≠amos disso com anteced√™ncia.  Consequentemente, este dispositivo n√£o estar√° em nossos dados mestre e ficar√° fora do processo de entrega da configura√ß√£o, monitoramento e, em geral, trabalho operacional.  Acontece que o equipamento foi instalado legitimamente, mas a configura√ß√£o foi "vazada" incorretamente e, por algum motivo, <i>ssh</i> , <i>snmp</i> , <i>aaa</i> ou senhas n√£o padr√£o para acesso n√£o funcionam l√°.  Para fazer isso, temos o python para tentar todos os m√©todos de conex√£o <i>herdados</i> poss√≠veis que poder√≠amos ter na empresa, criar for√ßa bruta para todas as senhas antigas e tudo para chegar ao peda√ßo de ferro e prepar√°-lo para trabalhar com monitoramento e monitoramento. . <br><br>  Existe uma maneira simples: tornar v√°rios arquivos de <i>invent√°rio</i> ansible, onde descrever todos os dados poss√≠veis para conex√µes (todos os tipos de fornecedores com todos os pares poss√≠veis de nome de usu√°rio / senha) e executar um <i>manual</i> para cada variante de <i>invent√°rio</i> .  Esper√°vamos uma solu√ß√£o melhor, mas na confer√™ncia RedHat, o arquiteto Ansible aconselhou da mesma maneira.  Geralmente, sup√µe-se que voc√™ saiba antecipadamente com o que est√° se conectando. <br>  Quer√≠amos uma solu√ß√£o universal - ao remover um backup, procure novos equipamentos e, se encontrado, adicione-os a todos os sistemas necess√°rios.  Portanto, escolhemos uma solu√ß√£o em python - saiba o que poderia ser mais bonito do que um programa que pode detectar um hardware de rede para conectar-se a ele, independentemente do que estiver configurado nele (dentro de limites razo√°veis, √© claro), configure conforme necess√°rio, remova a configura√ß√£o e, ao mesmo tempo, Adicione dados da API aos sistemas necess√°rios. <br></div></div></li></ol><br><h3>  Verifica√ß√£o como monitoramento </h3><br>  Uma das tarefas da automa√ß√£o √©, obviamente, descobrir o que aconteceu com essa automa√ß√£o.  Nem todos os 38k est√£o configurados perfeitamente na primeira vez, at√© acontece que algu√©m configura o equipamento com as m√£os.  E √© necess√°rio rastrear essas altera√ß√µes e restaurar a <s>justi√ßa na</s> configura√ß√£o de destino. <br><br>  Existem tr√™s abordagens para verificar a conformidade da configura√ß√£o com o padr√£o: <br><br><ul><li>  Fa√ßa uma verifica√ß√£o uma vez por per√≠odo - descarregue o estado atual, verifique o alvo e corrija as defici√™ncias identificadas. </li><li>  Sem verificar nada, uma vez por per√≠odo - implante as configura√ß√µes de destino.  √â verdade que existe o risco de quebrar algo - talvez n√£o houvesse tudo na configura√ß√£o de destino. </li><li>  Uma abordagem conveniente √© quando as diferen√ßas da configura√ß√£o de destino na <i>Fonte √önica da Verdade</i> s√£o consideradas alertas e s√£o monitoradas pelo sistema de monitoramento.  Isso inclui: uma incompatibilidade com o padr√£o de configura√ß√£o atual, uma diferen√ßa entre o hardware e o especificado nos dados mestre, uma incompatibilidade com os dados no <i>IPAM</i> . </li></ul><br>  No terceiro caso, uma op√ß√£o parece transferir esse trabalho para o gerenciamento de incidentes (SO), para que as inconsist√™ncias sejam eliminadas em pequenas por√ß√µes durante todo o tempo do que uma vez por emerg√™ncia. <br><br>  <b>O Zabbix</b> , sobre o qual escrevi anteriormente no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúComo monitoramos 14.000 objetos‚Äù,</a> √© o nosso sistema de monitoramento de objetos distribu√≠dos, onde podemos fazer disparos e alertas em que podemos pensar.  Desde que escrevemos o √∫ltimo artigo, atualizamos para o Zabbix 4.0 <abbr title="Suporte a longo prazo">LTS</abbr> . <br><br>  Com base no <i>Web Zabbix,</i> fizemos uma atualiza√ß√£o em nosso portal de suporte de rede, onde agora voc√™ pode encontrar todas as informa√ß√µes sobre um objeto em todos os nossos sistemas em uma √∫nica tela, al√©m de executar scripts para verificar se h√° problemas frequentes. <br><br><img src="https://habrastorage.org/webt/o_/65/ha/o_65haiskiyx5jvmofs1wwmy9a8.png"><br><br>  Tamb√©m introduzimos um novo recurso - para n√≥s, o Zabbix se tornou, de alguma forma, um <i>CRON</i> para o lan√ßamento de scripts agendados, como scripts de integra√ß√£o de sistemas, scripts de descoberta autom√°tica.  Isso √© realmente conveniente quando voc√™ precisa examinar os scripts atuais e quando e onde eles s√£o executados sem verificar todos os servidores.  √â verdade que, para scripts que s√£o executados por mais de 30 segundos, voc√™ precisar√° de um <i>iniciador</i> que os inicie sem esperar pelo fim.  Felizmente, √© simples: <br><br><div class="spoiler">  <b class="spoiler_title">launcher.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash nohup $* &gt; /dev/null 2&gt;/dev/null &amp; echo $(date) Started job for $*</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/gu/vp/ww/guvpwwbg0scnt8ngqkhuy7keey8.png"><br><br>  <b>Splunk</b> √© uma solu√ß√£o que permite coletar logs de eventos de equipamentos de rede e tamb√©m pode ser usada para monitorar a automa√ß√£o.  Por exemplo, coletando um backup de configura√ß√£o, um script <i>python</i> gera uma mensagem de <i>LOG</i> <i>CFG-5-BACKUP</i> , um roteador ou switch envia uma mensagem para o Splunk, na qual contamos o n√∫mero de mensagens desse tipo nos equipamentos de rede.  Isso nos permite rastrear a quantidade de equipamento que o script detectou.  E vemos quantas pe√ßas de ferro foram capazes de reportar isso ao <i>Splunk</i> e verificamos se as mensagens de todas as pe√ßas de ferro chegaram. <br>  <b>O Spectrum</b> √© um sistema abrangente que usamos para monitorar objetos cr√≠ticos, uma ferramenta bastante poderosa que nos ajuda muito na solu√ß√£o de incidentes cr√≠ticos de rede.  Na automa√ß√£o, usamos apenas os dados extra√≠dos, n√£o √© <i>de c√≥digo aberto</i> , portanto as possibilidades s√£o um pouco limitadas. <br><br><h3>  A cereja no bolo </h3><br><img src="https://habrastorage.org/webt/-a/g_/qk/-ag_qktnw97gq5edbpbswa1h_xa.png" align="right" width="240">  Usando sistemas com dados mestres no equipamento, podemos pensar em criar ZTP, ou Zero Touch Provisioning.  Como um bot√£o "auto-tuning", mas apenas sem um bot√£o. <br><br>  Temos todos os dados necess√°rios dos blocos anteriores - sabemos o objeto, seu tipo, que equipamento existe (fornecedor e modelo), quais s√£o os endere√ßos (IPAM), qual √© o padr√£o de configura√ß√£o atual (Git).  Ao reunir todos eles, podemos pelo menos preparar um modelo de configura√ß√£o para fazer o upload para o dispositivo, ser√° mais parecido com o One Touch Provisioning, mas √†s vezes n√£o √© necess√°rio mais. <br><br>  O True Zero Touch precisa de uma maneira de entregar automaticamente a configura√ß√£o ao hardware n√£o configurado.  Al√©m disso, √© desej√°vel, independentemente do fornecedor.  Existem v√°rias op√ß√µes de trabalho - um servidor de console, se todo o equipamento passar pelo armaz√©m central, solu√ß√µes de console m√≥vel, se o equipamento chegar imediatamente.  Estamos apenas trabalhando nessas solu√ß√µes, mas assim que houver uma op√ß√£o de trabalho, podemos compartilh√°-la. <br><br><h3>  Conclus√£o </h3><br>  No total, em nosso conceito de <b>rede como c√≥digo</b> , havia cinco marcos principais: <br><br><ul><li>  Dados mestres (comunica√ß√£o de sistemas e dados entre si, API de sistemas, sufici√™ncia de dados para suporte e lan√ßamento) </li><li>  Monitoramento de dados e configura√ß√µes (descoberta autom√°tica de dispositivos de rede, verifica√ß√£o da relev√¢ncia da configura√ß√£o na instala√ß√£o) </li><li>  Controle de vers√£o, configura√ß√µes de teste e pilotagem (Gitlab CI / CD conforme aplicado √† rede, ferramentas de teste de configura√ß√£o de rede) </li><li>  Entrega de configura√ß√£o (scripts Ansible, AWX, python para conectar) </li><li>  Zero Touch Provisioning (que dados s√£o necess√°rios, como criar um processo, como conectar-se a uma pe√ßa de hardware n√£o configurada) </li></ul><br>  N√£o funcionou para encaixar tudo em um artigo, cada item √© digno de uma discuss√£o separada, podemos falar sobre algo agora, sobre algo quando verificamos as solu√ß√µes na pr√°tica.  Se voc√™ estiver interessado em algum dos t√≥picos - no final, haver√° uma pesquisa na qual voc√™ poder√° votar no pr√≥ximo artigo.  Se o t√≥pico n√£o estiver inclu√≠do na lista, mas for interessante ler sobre ele, deixe um coment√°rio o mais r√°pido poss√≠vel, compartilhe nossa experi√™ncia. <br><br><hr><br>  Agradecimentos especiais a Virilin Alexander ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">xscrew</a> ) e Sibgatulin Marat ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">eucariot</a> ) pela visita de refer√™ncia no outono de 2018 √† nuvem yandex e √† hist√≥ria sobre a automa√ß√£o na infraestrutura de rede em nuvem.  Depois dele, tivemos inspira√ß√£o e muitas id√©ias sobre o uso da automa√ß√£o e do NetDevOps na infraestrutura do X5 Retail Group. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468197/">https://habr.com/ru/post/pt468197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468185/index.html">Servi√ßo AWS EC2 e trabalhe com ele</a></li>
<li><a href="../pt468189/index.html">Aumente as habilidades de depura√ß√£o de JavaScript usando truques de console</a></li>
<li><a href="../pt468191/index.html">RubyRussia 2019: Nikolay Sverchkov sobre sem servidor</a></li>
<li><a href="../pt468193/index.html">JVM Internals, Parte 1 - Carregador de classe</a></li>
<li><a href="../pt468195/index.html">Por que minhas finan√ßas dependem da Beeline?</a></li>
<li><a href="../pt468205/index.html">GIT por dentro: introdu√ß√£o (tradu√ß√£o)</a></li>
<li><a href="../pt468207/index.html">Como atualizamos o Zabbix</a></li>
<li><a href="../pt468211/index.html">‚ÄúEu s√≥ queria fazer uma piada, mas ningu√©m entendeu‚Äù ou como n√£o me enterrar na apresenta√ß√£o do projeto</a></li>
<li><a href="../pt468213/index.html">tinc-boot - rede de malha completa sem dor</a></li>
<li><a href="../pt468217/index.html">Dr. Jekyll e Sr. Hyde Cultura Corporativa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>