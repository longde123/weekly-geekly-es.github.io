<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😳 👵🏽 👉🏼 Introduction à la programmation: un jeu de tir 3D simple à partir du sol pendant le week-end, partie 2 ✍🏿 👨🏻‍🔬 👩🏼‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous poursuivons la conversation sur le jeu de tir 3D ce week-end. Si quoi que ce soit, je vous rappelle que c'est la seconde moitié: 



- Première p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introduction à la programmation: un jeu de tir 3D simple à partir du sol pendant le week-end, partie 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439720/">  Nous poursuivons la conversation sur le jeu de tir 3D ce week-end.  Si quoi que ce soit, je vous rappelle que c'est la seconde moitié: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Première partie: dessiner des murs</a> </li><li>  <b>Deuxième partie: habiter notre interface monde + fenêtre</b> </li></ul><br>  Comme je l'ai dit, je fais de mon mieux pour soutenir le désir des élèves de faire quelque chose de leurs propres mains.  En particulier, lorsque je donne un cours sur l'introduction à la programmation, puis comme exercices pratiques je leur laisse une liberté presque totale.  Il n'y a que deux limitations: le langage de programmation (C ++) et le thème du projet, ce devrait être un jeu vidéo.  Voici un exemple de l'un des centaines de jeux créés par mes étudiants de première année: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Ekomnk1eNFU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Malheureusement, la plupart des étudiants choisissent des jeux simples tels que des jeux de plateforme 2D.  J'écris cet article pour montrer que créer l'illusion d'un monde en trois dimensions n'est pas plus difficile que de cloner mario broz. <br><a name="habracut"></a><br>  Je vous rappelle que nous nous sommes arrêtés à une étape qui vous permet de texturer les murs: <br><br><img src="https://raw.githubusercontent.com/ssloy/tinyraycaster/master/doc/012.gif"><br><br><hr><br><h1>  Étape 13: dessinez des monstres sur la carte </h1><br>  Qu'est-ce qu'un monstre dans notre jeu?  Ce sont ses coordonnées et son numéro de texture: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sprite</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> tex_id; }; [..] <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Sprite&gt; sprites{ {<span class="hljs-number"><span class="hljs-number">1.834</span></span>, <span class="hljs-number"><span class="hljs-number">8.765</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">5.323</span></span>, <span class="hljs-number"><span class="hljs-number">5.365</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">4.123</span></span>, <span class="hljs-number"><span class="hljs-number">10.265</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>} };</code> </pre> <br>  Après avoir défini plusieurs monstres, pour commencer nous les dessinons simplement sur la carte: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/60f/15a/824/60f15a824cec0e8a93ff42f4d7a2722b.png"><br><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> . <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><hr><br><h1>  Étape 14: des carrés noirs au lieu de monstres en 3D </h1><br>  Nous allons maintenant dessiner des sprites dans la fenêtre 3D.  Pour ce faire, nous devons déterminer deux choses: la position du sprite sur l'écran et sa taille.  Voici la fonction qui dessine un carré noir à la place de chaque sprite: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_sprite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sprite &amp;sprite, FrameBuffer &amp;fb, Player &amp;player, Texture &amp;tex_sprites)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// absolute direction from the player to the sprite (in radians) float sprite_dir = atan2(sprite.y - player.y, sprite.x - player.x); // remove unnecessary periods from the relative direction while (sprite_dir - player.a &gt; M_PI) sprite_dir -= 2*M_PI; while (sprite_dir - player.a &lt; -M_PI) sprite_dir += 2*M_PI; // distance from the player to the sprite float sprite_dist = std::sqrt(pow(player.x - sprite.x, 2) + pow(player.y - sprite.y, 2)); size_t sprite_screen_size = std::min(2000, static_cast&lt;int&gt;(fb.h/sprite_dist)); // do not forget the 3D view takes only a half of the framebuffer, thus fb.w/2 for the screen width int h_offset = (sprite_dir - player.a)*(fb.w/2)/(player.fov) + (fb.w/2)/2 - sprite_screen_size/2; int v_offset = fb.h/2 - sprite_screen_size/2; for (size_t i=0; i&lt;sprite_screen_size; i++) { if (h_offset+int(i)&lt;0 || h_offset+i&gt;=fb.w/2) continue; for (size_t j=0; j&lt;sprite_screen_size; j++) { if (v_offset+int(j)&lt;0 || v_offset+j&gt;=fb.h) continue; fb.set_pixel(fb.w/2 + h_offset+i, v_offset+j, pack_color(0,0,0)); } } }</span></span></code> </pre><br>  Voyons comment cela fonctionne.  Voici le schéma: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/472/062/e0d/472062e0d02a32186987ee94f7364cdd.png"><br><br>  Dans la première ligne, nous considérons l'angle absolu sprite_dir (l'angle entre la direction du joueur au sprite et l'abscisse).  L'angle relatif entre le sprite et la direction du regard est évidemment obtenu en soustrayant simplement deux angles absolus: sprite_dir - player.a.  La distance du joueur au sprite est triviale à calculer, et la taille du sprite est une simple division de la taille de l'écran par la distance.  Eh bien, juste au cas où, j'en couperais deux mille du haut pour ne pas avoir de carrés géants (au fait, ce code peut facilement être divisé par zéro).  h_offset et v_offset donnent les coordonnées du coin supérieur gauche du sprite sur l'écran;  puis une simple double boucle remplit notre carré de noir.  Vérifiez avec un stylo et un morceau de papier que h_offset et v_offset sont correctement calculés, dans mon commit il y a une erreur (non critique), croyez le code dans l'article :) Eh bien, le code le plus récent dans le référentiel a également été corrigé. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/03a/795/77c/03a79577c9c0781121b529494b1dafe1.png"><br><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><hr><br><h1>  Étape 15: Carte de profondeur </h1><br>  Nos carrés sont miraculeusement bons, mais il n'y a qu'un seul problème: le monstre lointain jette un coup d'œil au coin et le carré est entièrement dessiné.  Comment être  Très simple.  Nous dessinons des sprites <b>après</b> le dessin des murs.  Par conséquent, pour chaque colonne de notre écran, nous connaissons la distance au mur le plus proche.  Nous enregistrons ces distances dans un tableau de 512 valeurs et passons le tableau à la fonction de rendu de sprite.  Les sprites sont également dessinés colonne par colonne, donc pour chaque colonne du sprite, nous comparerons la distance à celle-ci avec la valeur de notre tableau de profondeur. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec8/1c3/71f/ec81c371f35f7ddff4086a8e1a51268b.png"><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><hr><br><h1>  Étape 16: problème avec les sprites </h1><br>  Ils sont devenus de grands monstres, non?  Mais à ce stade je n'ajouterai aucune fonctionnalité, au contraire, je vais tout casser en ajoutant un autre monstre: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/28f/5a8/9b8/28f5a89b8ea84373d9812c3e3a66d61d.png"><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><hr><br><h1>  Étape 17: tri des sprites </h1><br>  Quel était le problème?  Le problème est que je peux avoir un ordre arbitraire de dessin de sprites, et pour chacun d'eux je compare sa distance avec les murs, mais pas avec d'autres sprites, de sorte que la créature éloignée rampait sur la plus proche.  Est-il possible d'adapter une solution avec une carte de profondeur pour dessiner des sprites? <br><br><div class="spoiler">  <b class="spoiler_title">Texte masqué</b> <div class="spoiler_text">  La bonne réponse est «vous pouvez».  Mais comment?  Écrivez dans les commentaires. <br></div></div><br>  J'irai dans l'autre sens, en résolvant le problème bêtement dans le front.  Je vais simplement dessiner tous les sprites du plus éloigné au plus éloigné.  Autrement dit, je vais trier les sprites par ordre décroissant de distance et les dessiner dans cet ordre. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73c/820/c20/73c820c20c220093733774e6a1553a50.png"><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><hr><br><h1>  Étape 18: Heure SDL </h1><br>  Le temps est venu pour SDL.  Il existe de nombreuses bibliothèques de fenêtres multiplateformes différentes, et je ne les comprends pas du tout.  Personnellement, j'aime <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">imgui</a> , mais pour une raison quelconque mes étudiants préfèrent SDL, donc je fais le lien avec lui.  La tâche de cette étape est très simple: créez une fenêtre et affichez l'image de l'étape précédente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ce/63a/9b5/7ce63a9b5ea3ca1c608fcdcf207d482e.png"><br><br>  Les changements que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir ici</a> .  Je ne donne plus de lien vers le gitpod, car  SDL dans le navigateur n'a pas encore appris à démarrer :( <br><br>  <b>Mise à jour: APPRIS!</b>  <b>Vous pouvez exécuter le code en un clic dans le navigateur!</b> <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://gitpod.io/&amp;usg=ALkJrhg0eCkGWdTvY1OuLIgIbPSqGQeStg#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="Ouvrir dans gitpod"></a> <br><br><h1>  Étape 19: Traitement et nettoyage des événements </h1><br>  Ajouter une réaction aux frappes n'est même pas drôle, je ne décrirai pas.  Lors de l'ajout de SDL, j'ai supprimé la dépendance sur stb_image.h.  C'est beau, mais ça prend trop de temps à compiler. <br><br>  Pour ceux qui ne comprennent pas, les sources de la dix-neuvième étape <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sont ici</a> .  Eh bien, voici une performance typique: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zPIVTqVilCM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1>  Conclusion </h1><br>  Mon code ne contient pour le moment que 486 lignes, et en même temps je ne les ai pas économisées du tout: <br><br><pre> <code class="bash hljs">haqreu@daffodil:~/tinyraycaster$ cat *.cpp *.h | wc -l 486</code> </pre><br>  Je n'ai pas léché mon code, jetant intentionnellement du linge sale.  Oui, j'écris comme ça (et pas seulement moi).  Un samedi matin, je me suis juste assis et j'ai écrit ceci :) <br><br>  Je n'ai pas fait le jeu fini, ma tâche est seulement de donner une impulsion initiale au vol de votre imagination.  Écrivez votre propre code, il sera probablement meilleur que le mien.  Partagez votre code, partagez vos idées, envoyez des demandes de tirage. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439720/">https://habr.com/ru/post/fr439720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439710/index.html">Caractéristiques de la création de produits pour le marché américain</a></li>
<li><a href="../fr439712/index.html">Marchés publics: l'équilibre entre la grève italienne et le criminel russe</a></li>
<li><a href="../fr439714/index.html">Les Russes chez Apple: comment le nôtre a obtenu un contrat de plusieurs millions avec les Beatles et des chansons de «certains Jerry»</a></li>
<li><a href="../fr439716/index.html">Tails OS ou comment vous protéger en ligne</a></li>
<li><a href="../fr439718/index.html">Développement d'applications sur Elixir / Phoenix avec Docker</a></li>
<li><a href="../fr439722/index.html">Effets des filtres SVG. Partie 2. Décrire le texte avec feMorphology</a></li>
<li><a href="../fr439724/index.html">Aperçu des solutions AI et ML en 2018 et prévisions pour 2019: Partie 2 - Outils et bibliothèques, AutoML, RL, éthique en IA</a></li>
<li><a href="../fr439726/index.html">Lock-in: vrai ou fiction?</a></li>
<li><a href="../fr439728/index.html">Configurer la sauvegarde et la restauration Zimbra OSE complètes et séparées sans utiliser Zextras</a></li>
<li><a href="../fr439730/index.html">Organisation du réducteur à travers une classe standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>