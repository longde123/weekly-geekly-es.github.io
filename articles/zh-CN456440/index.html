<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤸🏿 🔑 🎄 难以捉摸的马尔瓦里历险记，第一部分 👐 👗 👩‍❤️‍👨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="从本文开始，我们开始一系列有关难以捉摸的马尔瓦里河的出版物。 不会留下任何攻击痕迹的黑客程序（也称为无文件）通常在Windows系统上使用PowerShell秘密执行命令以查找和提取有价值的内容。 在没有恶意文件的情况下检测黑客活动是一项艰巨的任务，因为 防病毒软件和许多其他检测系统均基于特征分析。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>难以捉摸的马尔瓦里历险记，第一部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/456440/"><img src="https://habrastorage.org/webt/t5/7j/ep/t57jepsiopn5j3zbxlikd2ago-e.jpeg"><br><br> 从本文开始，我们开始一系列有关难以捉摸的马尔瓦里河的出版物。 不会留下任何攻击痕迹的黑客程序（也称为无文件）通常在Windows系统上使用PowerShell秘密执行命令以查找和提取有价值的内容。 在没有恶意文件的情况下检测黑客活动是一项艰巨的任务，因为 防病毒软件和许多其他检测系统均基于特征分析。 但是，好消息是这种软件确实存在。 例如，可以检测文件系统中恶意活动的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">UBA</a>系统。 <br><a name="habracut"></a><br> 当我第一次开始研究酷黑客的主题时，他们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">并不使用传统的感染方法</a> ，而只使用受害者计算机上可用的工具和软件，因此我并不怀疑这很快就会成为流行的攻击方法。 安全专家<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说，</a>这正在成为一种趋势， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">令人恐惧的文章标题</a>就是证明。 因此，我决定就此主题进行一系列出版物。 <br><br><h2> 强大而强大的PowerShell </h2><br> 我在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PowerShell混淆系列中</a>早些时候就谈到了其中一些想法，但在理论上却更多。 后来，我遇到了一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">进行混合分析</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">站点</a> ，您可以在其中找到野外“捕获”的马尔瓦尔样本。 我决定尝试使用此站点搜索无文件恶意软件样本。 而我做到了。 顺便说一句，如果您想自己进行探险以寻找恶意软件，则必须在此站点上进行检查，以便他们知道您是白帽专家。 作为写有关安全性的博客作者，我毫无疑问地经历了它。 我相信你也可以。 <br><br> 除了样本本身之外，您还可以在网站上看到这些程序的功能。 混合分析在其自己的沙箱中启动恶意软件，并跟踪系统调用，网络上正在运行的进程和操作，还提取可疑文本字符串。 对于二进制文件和其他可执行文件，即 在您甚至看不到实际的高级代码的地方，混合分析都会根据运行时的活动来确定软件是恶意软件还是可疑软件。 之后，样本已被评估。 <br><br> 对于PowerShell和其他示例脚本（Visual Basic，JavaScript等），我能够看到代码本身。 例如，我遇到了这样的PowerShell实例： <br><br><img src="https://habrastorage.org/webt/6l/vo/9a/6lvo9a-5fjn2damwm8vivmh2goc.jpeg"><br><br><p>  <i>您也可以运行base64编码的PowerShell以避免检测。</i>  <i>注意非交互式和隐藏参数的使用。</i> </p><br> 如果您阅读了我的混淆条目，那么您将知道-e选项表明该内容是使用base64编码的。 顺便说一句，混合分析也可以帮助您解码所有内容。 如果要尝试自行解码base64 PowerShell（以下简称PS），则需要运行以下命令： <br><br><pre><code class="plaintext hljs">[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))</code> </pre> <br><h2> 更深入 </h2><br> 我使用这种方法解码了PS脚本，下面显示了程序的文本，尽管我对此做了一些修改： <br><br><img src="https://habrastorage.org/webt/ro/ef/zi/roefzis_uwim8flbumkfqsvrvlu.jpeg"><br><p>  <i>请注意，该吱吱声绑定到日期为2017年9月4日，并传递了会话Cookie。</i> </p><br> 我在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PS混淆系列</a>文章中介绍了这种攻击方式，其中base64编码脚本本身使用.Net Framework库中的WebClient对象从另一个站点下载<i>丢失的</i>恶意软件，以完成所有艰苦的工作。 <br><br> 这是为了什么 <br><br> 对于扫描Windows事件日志或防火墙的安全软件，base64编码可通过简单的文本模式阻止检测WebClient字符串，以防止此类Web请求。 而且由于所有“邪恶的”恶意软件都已下载并转移到我们的PowerShell中，因此这种方法使您可以完全避免检测。 相反，我起初是这么认为的。 <br><br> 事实证明，通过包含Windows PowerShell日志的高级日志记录（请参阅我的文章），您可以在事件日志中看到加载的行。 我（和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">其他人</a>一样）认为Microsoft默认情况下应启用此级别的日志记录。 因此，打开扩展日志记录后，我们将在Windows事件日志中看到一个完整的请求，该请求将根据我们上面检查的示例从PS脚本加载。 因此，激活它很有意义，同意吗？ <br><br><h2> 添加其他脚本 </h2><br> 黑客巧妙地用Visual Basic和其他脚本语言编写的Microsoft Office宏隐藏了PowerShell攻击。 这个想法是受害人例如从传递服务接收到一条消息，并带有.doc格式的附加报告。 您打开包含宏的文档，最终它会启动恶意PowerShell本身。 <br><br> 通常，Visual Basic脚本本身会被混淆，因此它可以自由规避防病毒和其他恶意软件扫描程序。 本着上述精神，我决定将上述PowerShell编码为JavaScript。 以下是我的工作结果： <br><br><img src="https://habrastorage.org/webt/z6/4f/ek/z64fekt9zmny-mmfxihe8qgyfy8.jpeg"><br><p>  <i>混淆了JavaScript，隐藏了我们的PowerShell。</i>  <i>真正的黑客只做一两次。</i> </p><br> 这是我在网上遇到的另一种技术：使用Wscript.Shell运行编码的PowerShell。 顺便说一下，JavaScript本身就是一种传播恶意软件的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">手段</a> 。  Windows的许多版本都有内置的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Windows Script Host</a> ，它本身可以运行JS。 <br> 在我们的案例中，恶意JS脚本以扩展名为.doc.js的文件形式附加。  Windows通常仅显示第一个后缀，因此对于受害者来说它将显示为Word文档。 <br><br><img src="https://habrastorage.org/webt/ge/jy/pt/gejyptu4-xcxc87lweigj9yckqq.jpeg"><br><p>  <i>JS图标仅显示在滚动图标中。</i>  <i>毫不奇怪的是，许多人会以为这是Word文档来打开此附件。</i> </p><br> 在我的示例中，我修改了上面的PowerShell以从我的网站下载脚本。 远程PS脚本仅打印Evil恶意软件。 如您所见，他一点也不邪恶。 当然，真正的黑客有兴趣通过命令外壳访问笔记本电脑或服务器。 在下一篇文章中，我将展示如何使用PowerShell Empire来执行此操作。 <br><br> 我希望对于第一篇介绍性文章，我们不要对这个话题太深入。 现在让我喘口气，下一次我们将开始分析使用无文件恶意变量的实际攻击示例，而无需额外的介绍性文字和准备。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN456440/">https://habr.com/ru/post/zh-CN456440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN456424/index.html">Utreexo：压缩很多UTXO比特币</a></li>
<li><a href="../zh-CN456426/index.html">BASS-自动合成防病毒签名的框架</a></li>
<li><a href="../zh-CN456428/index.html">如何实施BI方法进行数据分析：实用建议</a></li>
<li><a href="../zh-CN456430/index.html">技术债务的永恒问题</a></li>
<li><a href="../zh-CN456436/index.html">星期一的简短JS任务</a></li>
<li><a href="../zh-CN456442/index.html">在Yandex和JetBrains的支持下进入圣彼得堡国立大学的本科课程</a></li>
<li><a href="../zh-CN456446/index.html">Ceph-从“膝盖”到“生产”</a></li>
<li><a href="../zh-CN456448/index.html">选择JS框架的规则</a></li>
<li><a href="../zh-CN456450/index.html">DO-RA.Avia用于监控航空宇宙辐射</a></li>
<li><a href="../zh-CN456452/index.html">Ranges之前和之后的C ++代码示例</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>