<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüöí üëêüèª üëèüèº Implementando um Recarregamento Quente de C√≥digo C ++ no Linux ü§≥üèΩ üëçüèº ‚òÆÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* Link para a biblioteca no final do artigo. O pr√≥prio artigo descreve os mecanismos implementados na biblioteca, com detalhes m√©dios. A implementa√ß√£o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementando um Recarregamento Quente de C√≥digo C ++ no Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435260/"><p><img src="https://alexpolt.github.io/images/stroustrup-didnt-plan-for-this.png" alt="imagem"></p><br><p>  * Link para a biblioteca no final do artigo.  O pr√≥prio artigo descreve os mecanismos implementados na biblioteca, com detalhes m√©dios.  A implementa√ß√£o para o macOS ainda n√£o est√° conclu√≠da, mas n√£o √© muito diferente da implementa√ß√£o para Linux.  Isso √© principalmente uma implementa√ß√£o para Linux. </p><br><p>  Andando no github em uma tarde de s√°bado, deparei-me com uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> que implementa a atualiza√ß√£o do c√≥digo c ++ rapidamente para o windows.  Eu mesmo desci do Windows h√° alguns anos, n√£o me arrependi nem um pouco, e agora toda a programa√ß√£o √© feita no Linux (em casa) ou no macOS (no trabalho).  Pesquisando um pouco no Google, descobri que a abordagem da biblioteca acima √© bastante popular e o msvc usa a mesma t√©cnica para a fun√ß√£o "Editar e continuar" no Visual Studio.  O √∫nico problema √© que eu n√£o encontrei nenhuma implementa√ß√£o em n√£o-janelas (eu estava mal?).  Para a pergunta ao autor da biblioteca acima, se ele far√° uma porta para outras plataformas, a resposta foi n√£o. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Devo dizer imediatamente</a> que estava interessado apenas na op√ß√£o em que n√£o precisaria alterar o c√≥digo do projeto existente (como, por exemplo, no caso do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RCCPP</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cr</a> , onde todo o c√≥digo potencialmente recarregado deve estar em uma biblioteca separada carregada dinamicamente). </p><br><p>  "Como assim?"  - pensei, e comecei a acender incenso. </p><a name="habracut"></a><br><h2 id="zachem">  Porque </h2><br><p>  Eu principalmente gamedev.  Passo a maior parte do tempo trabalhando escrevendo a l√≥gica do jogo e o layout de qualquer visual.  Eu tamb√©m uso o imgui para utilit√°rios auxiliares.  Meu ciclo de trabalho com o c√≥digo, como voc√™ provavelmente adivinhou, √© Write -&gt; Compile -&gt; Run -&gt; Repeat.  Tudo acontece muito rapidamente (constru√ß√£o incremental, todos os tipos de ccache, etc.).  O problema aqui √© que esse ciclo precisa ser repetido com frequ√™ncia suficiente.  Por exemplo, estou escrevendo uma nova mec√¢nica de jogo, seja "Jump", um salto v√°lido e controlado: </p><br><p>  1. Escreveu um rascunho de implementa√ß√£o com base no momento, montado, lan√ßado.  Vi que apliquei um pulso acidentalmente em cada quadro, e n√£o uma vez. </p><br><p>  2. Fixo, montado, lan√ßado, agora normal.  Mas seria necess√°rio levar mais o valor absoluto do impulso. </p><br><p>  3. Fixo, montado, lan√ßado, funcionando.  Mas de alguma forma parece errado.  √â necess√°rio tentar com base na for√ßa para fazer. </p><br><p>  4. Escreveu um rascunho de implementa√ß√£o com base em trabalhos robustos, montados, lan√ßados,.  Seria necess√°rio apenas mudar a velocidade instant√¢nea no momento do salto. <br>  ... </p><br><p> 10. Fixo, montado, lan√ßado, funcionando.  Mas ainda n√£o √© isso.  Provavelmente precisa tentar uma implementa√ß√£o baseada em uma altera√ß√£o no <code>gravityScale</code> . <br>  ... </p><br><p>  20. √ìtimo, parece super!  Agora, retiramos todos os par√¢metros no editor para gamediz, test e fill. <br>  ... </p><br><p>  30. O salto est√° pronto. </p><br><p>  E a cada itera√ß√£o, voc√™ precisa coletar o c√≥digo e, no aplicativo iniciado, chegar ao local onde eu posso pular.  Isso geralmente leva pelo menos 10 segundos.  E se eu puder pular em uma √°rea aberta, que ainda precisa ser alcan√ßada?  E se eu precisar pular em blocos com uma altura de N unidades?  Aqui eu j√° preciso coletar uma cena de teste, que tamb√©m precisa ser depurada e que tamb√©m precisa gastar tempo.  √â para essas itera√ß√µes que uma recarga quente de c√≥digo seria ideal.  Obviamente, isso n√£o √© uma panac√©ia, n√£o √© adequado para tudo e, ap√≥s a reinicializa√ß√£o, √†s vezes voc√™ precisa recriar parte do mundo do jogo, e isso deve ser levado em considera√ß√£o.  Mas, em muitas coisas, isso pode ser √∫til e poupar aten√ß√£o e muito tempo. </p><br><h2 id="trebovaniya-i-postanovka-zadachi">  Requisitos e declara√ß√£o do problema </h2><br><ul><li>  Ao alterar o c√≥digo, a nova vers√£o de todas as fun√ß√µes deve substituir as vers√µes antigas das mesmas fun√ß√µes </li><li>  Isso deve funcionar no Linux e macOS </li><li>  Isso n√£o deve exigir altera√ß√µes no c√≥digo do aplicativo existente. </li><li>  Idealmente, essa deve ser uma biblioteca, estaticamente ou dinamicamente vinculada ao aplicativo, sem utilit√°rios de terceiros </li><li>  √â desej√°vel que essa biblioteca n√£o afete muito o desempenho do aplicativo. </li><li>  Suficiente se isso funcionar com cmake + make / ninja </li><li>  Basta que funcione com as compila√ß√µes da debazine (sem otimiza√ß√µes, sem aparar caracteres etc.) </li></ul><br><p>  Esse √© o conjunto m√≠nimo de requisitos que uma implementa√ß√£o deve atender.  No futuro, descreverei brevemente o que foi implementado adicionalmente: </p><br><ul><li>  Transferindo valores de vari√°veis ‚Äã‚Äãest√°ticas para um novo c√≥digo (consulte a se√ß√£o "Transferindo vari√°veis ‚Äã‚Äãest√°ticas" para descobrir por que isso √© importante) </li><li>  Recarregando com base em depend√™ncias (cabe√ßalho alterado -&gt; reconstru√≠do <del>  meio projeto </del>  todos os arquivos dependentes) </li><li>  Recarregando c√≥digo de bibliotecas din√¢micas </li></ul><br><h2 id="realizaciya">  Implementa√ß√£o </h2><br><p>  At√© aquele momento, eu estava completamente longe da √°rea de assunto, ent√£o tive que coletar e assimilar informa√ß√µes do zero. </p><br><p>  Em um n√≠vel alto, o mecanismo fica assim: </p><br><ul><li>  Monitoramos o sistema de arquivos em busca de altera√ß√µes na fonte </li><li>  Quando a fonte √© alterada, a biblioteca a reconstr√≥i usando o comando de compila√ß√£o que este arquivo j√° foi compilado </li><li>  Todos os objetos coletados s√£o vinculados a uma biblioteca carregada dinamicamente </li><li>  A biblioteca √© carregada no espa√ßo de endere√ßo do processo </li><li>  Todas as fun√ß√µes da biblioteca substituem as mesmas fun√ß√µes no aplicativo. </li><li>  Os valores das vari√°veis ‚Äã‚Äãest√°ticas s√£o transferidos do aplicativo para a biblioteca </li></ul><br><p>  Vamos come√ßar com o mais interessante - o mecanismo de recarregamento de fun√ß√µes. </p><br><h4 id="perezagruzka-funkciy">  Recarregando fun√ß√µes </h4><br><p>  Aqui est√£o tr√™s maneiras mais ou menos populares de substituir fun√ß√µes no (ou quase) tempo de execu√ß√£o: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Truque com LD_PRELOAD</a> - permite criar uma biblioteca carregada dinamicamente com, por exemplo, a fun√ß√£o <code>strcpy</code> , e fazer com que, quando voc√™ iniciar o aplicativo, <code>strcpy</code> minha vers√£o do <code>strcpy</code> vez da biblioteca </li><li>  Alterar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tabelas PLT e GOT</a> - permite sobrecarregar as fun√ß√µes exportadas </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hooking de fun√ß√£o</a> - permite redirecionar o thread de execu√ß√£o de uma fun√ß√£o para outra </li></ul><br><p>  As 2 primeiras op√ß√µes, obviamente, n√£o s√£o adequadas, pois funcionam apenas com fun√ß√µes exportadas e n√£o queremos marcar todas as fun√ß√µes de nossa aplica√ß√£o com nenhum atributo.  Portanto, a fun√ß√£o de enganchar √© a nossa op√ß√£o! </p><br><p>  Em resumo, ligar funciona assim: </p><br><ul><li>  O endere√ßo da fun√ß√£o foi encontrado </li><li>  Os primeiros bytes da fun√ß√£o s√£o substitu√≠dos por uma transi√ß√£o incondicional para o corpo de outra fun√ß√£o </li><li>  ... </li><li>  Lucro! <br>  No msvc, existem 2 sinalizadores para este - <code>/hotpatch</code> e <code>/FUNCTIONPADMIN</code> .  O primeiro no in√≠cio de cada fun√ß√£o grava 2 bytes, que n√£o fazem nada, para sua reescrita subsequente com um "salto curto".  O segundo permite que voc√™ deixe um espa√ßo vazio na frente do corpo de cada fun√ß√£o na forma de instru√ß√µes <code>nop</code> para um "salto em dist√¢ncia" para o local desejado; portanto, em 2 saltos, voc√™ pode alternar da fun√ß√£o antiga para a nova.  Voc√™ pode ler mais sobre como isso √© implementado no Windows e no MSVC, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </li></ul><br><p>  Infelizmente, n√£o h√° nada semelhante no clang e no gcc (pelo menos no Linux e no macOS).  Na verdade, esse n√£o √© um problema t√£o grande que vamos escrever diretamente sobre a fun√ß√£o antiga.  Nesse caso, corremos o risco de ter problemas se nosso aplicativo for multithread.  Se geralmente em um ambiente multithread, restringimos o acesso aos dados por um thread enquanto outro thread os modifica, precisamos limitar a capacidade de executar o c√≥digo em um thread enquanto outro thread modifica esse c√≥digo.  Como eu n√£o descobri como fazer isso, a implementa√ß√£o se comportar√° de maneira imprevis√≠vel em um ambiente multithread. </p><br><p>  H√° um ponto sutil.  Em um sistema de 32 bits, 5 bytes s√£o suficientes para "pularmos" para qualquer lugar.  Em um sistema de 64 bits, se n√£o queremos estragar os registros, precisamos de 14 bytes.  A linha inferior √© que 14 bytes na escala de c√≥digo de m√°quina s√£o bastante, e se o c√≥digo tiver alguma fun√ß√£o de stub com um corpo vazio, √© prov√°vel que tenha menos de 14 bytes de comprimento.  N√£o sei a verdade, mas passei algum tempo atr√°s do desmontador enquanto pensava, escrevia e depurava o c√≥digo, e notei que todas as fun√ß√µes est√£o alinhadas em um limite de 16 bytes (compila√ß√£o de depura√ß√£o sem otimiza√ß√µes, n√£o tenho certeza sobre o c√≥digo otimizado).  E isso significa que, entre o in√≠cio de quaisquer duas fun√ß√µes, haver√° pelo menos 16 bytes, o que √© suficiente para "atol√°-los".  O Google pesquisou superficialmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , no entanto, n√£o tenho certeza, tive sorte ou hoje todos os compiladores fazem isso.  Em qualquer caso, em caso de d√∫vida, apenas declare algumas vari√°veis ‚Äã‚Äãno in√≠cio da fun√ß√£o stub para que ela se torne grande o suficiente. </p><br><p>  Portanto, temos o primeiro gr√£o - um mecanismo para redirecionar fun√ß√µes da vers√£o antiga para a nova. </p><br><h4 id="poisk-funkciy-v-skopmilirovannoy-programme">  Procurar fun√ß√µes em um programa copiado </h4><br><p>  Agora, precisamos obter de alguma forma os endere√ßos de todas as fun√ß√µes (n√£o apenas exportadas) do nosso programa ou de uma biblioteca din√¢mica arbitr√°ria.  Isso pode ser feito simplesmente usando a API do sistema se os caracteres n√£o forem cortados do seu aplicativo.  No Linux, essas s√£o api de <code>elf.h</code> <code>link.h</code> , no macOS, <code>loader.h</code> <code>nlist.h</code> . </p><br><ul><li>  Usando <code>dl_iterate_phdr</code> , percorremos todas as bibliotecas carregadas e, de fato, o programa </li><li>  Encontre o endere√ßo em que a biblioteca est√° carregada </li><li>  Na se√ß√£o <code>.symtab</code> , obtemos todas as informa√ß√µes sobre os caracteres, como nome, tipo, √≠ndice da se√ß√£o em que ele se encontra, tamanho e tamb√©m calculamos seu endere√ßo "real" com base no endere√ßo virtual e no endere√ßo de carregamento da biblioteca </li></ul><br><p>  H√° uma sutileza.  Ao baixar um arquivo elf, o sistema n√£o carrega a se√ß√£o <code>.symtab</code> (corrija se estiver incorreta) e a se√ß√£o <code>.dynsym</code> n√£o √© adequada para n√≥s, pois n√£o podemos extrair caracteres com a visibilidade <code>STV_INTERNAL</code> e <code>STV_HIDDEN</code> .  Simplificando, n√£o veremos essas fun√ß√µes: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// some_file.cpp namespace { int someUsefulFunction(int value) // &lt;----- { return value * 2; } }</span></span></code> </pre> <br><p>  e tais vari√°veis: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// some_file.cpp void someDefaultFunction() { static int someVariable = 0; // &lt;----- ... }</span></span></code> </pre> <br><p>  Portanto, no par√°grafo 3, n√£o estamos trabalhando com o programa que o <code>dl_iterate_phdr</code> forneceu, mas com o arquivo que <code>dl_iterate_phdr</code> do disco e analisamos por algum analisador de elf (ou na API nua).  Ent√£o n√£o perdemos nada.  No macOS, o procedimento √© semelhante, apenas os nomes das fun√ß√µes da API do sistema s√£o diferentes. </p><br><p>  Depois disso, filtramos todos os caracteres e salvamos apenas: </p><br><ul><li>  Fun√ß√µes que podem ser recarregadas s√£o caracteres do tipo <code>STT_FUNC</code> localizados na se√ß√£o <code>.text</code> , com tamanho diferente de zero.  Esse filtro ignora apenas as fun√ß√µes cujo c√≥digo est√° realmente contido neste programa ou biblioteca </li><li>  Vari√°veis ‚Äã‚Äãest√°ticas cujos valores voc√™ deseja transferir s√£o caracteres do tipo <code>STT_OBJECT</code> localizados na se√ß√£o <code>.bss</code> </li></ul><br><h2 id="edinicy-translyacii">  Unidades de transmiss√£o </h2><br><p>  Para recarregar o c√≥digo, precisamos saber onde obter os arquivos de c√≥digo-fonte e como compil√°-los. </p><br><p>  Na primeira implementa√ß√£o, li essas informa√ß√µes na se√ß√£o <code>.debug_info</code> , que cont√©m informa√ß√µes de depura√ß√£o no formato DWARF.  Para que cada unidade de compila√ß√£o (ET) no DWARF obtenha uma linha de compila√ß√£o para esse ET, voc√™ deve passar <code>-grecord-gcc-switches</code> durante a compila√ß√£o.  DWARF, analisei a biblioteca libdwarf, que vem junto com o <code>libelf</code> .  Al√©m do comando de compila√ß√£o do DWARF, voc√™ pode obter informa√ß√µes sobre as depend√™ncias de nossos ETs em outros arquivos.  Mas eu recusei essa implementa√ß√£o por v√°rios motivos: </p><br><ul><li>  Bibliotecas s√£o bastante pesadas </li><li>  A an√°lise de um aplicativo DWARF compilado a partir de ~ 500 ET, com an√°lise de depend√™ncia, levou um pouco mais de 10 segundos </li></ul><br><p>  10 segundos para iniciar o aplicativo √© demais.  Ap√≥s algumas reflex√µes, reescrevi a l√≥gica de analisar DWARF para analisar <code>compile_commands.json</code> .  Esse arquivo pode ser gerado simplesmente adicionando <code>set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</code> ao seu CMakeLists.txt.  Assim, obtemos todas as informa√ß√µes que precisamos. </p><br><h2 id="obrabotka-zavisimostey">  Manipula√ß√£o de Depend√™ncias </h2><br><p>  Desde que abandonamos o DWARF, precisamos encontrar outra op√ß√£o, como lidar com depend√™ncias entre arquivos.  Eu realmente n√£o queria analisar arquivos com minhas m√£os e procurar <code>include</code> neles, e quem sabe mais sobre depend√™ncias do que o pr√≥prio compilador? </p><br><p>  Existem v√°rias op√ß√µes no clang e no gcc que geram os chamados depfiles quase de gra√ßa.  Esses arquivos usam os sistemas de cria√ß√£o make e ninja para resolver depend√™ncias entre arquivos.  Depfiles t√™m um formato muito simples: </p><br><pre> <code class="plaintext hljs">CMakeFiles/lib_efsw.dir/libs/efsw/src/efsw/DirectorySnapshot.cpp.o: \ /home/ddovod/_private/_projects/jet/live/libs/efsw/src/efsw/base.hpp \ /home/ddovod/_private/_projects/jet/live/libs/efsw/src/efsw/sophist.h \ /home/ddovod/_private/_projects/jet/live/libs/efsw/include/efsw/efsw.hpp \ /usr/bin/../lib/gcc/x86_64-linux-gnu/7.3.0/../../../../include/c++/7.3.0/string \ /usr/bin/../lib/gcc/x86_64-linux-gnu/7.3.0/../../../../include/x86_64-linux-gnu/c++/7.3.0/bits/c++config.h \ /usr/bin/../lib/gcc/x86_64-linux-gnu/7.3.0/../../../../include/x86_64-linux-gnu/c++/7.3.0/bits/os_defines.h \ ...</code> </pre> <br><p>  O compilador coloca esses arquivos ao lado dos arquivos de objeto para cada ET, resta analis√°-los e coloc√°-los em um hashmap.  A an√°lise total de <code>compile_commands.json</code> + depfiles para os mesmos 500 ET leva um pouco mais de 1 segundo.  Para que tudo funcione, precisamos adicionar o sinalizador <code>-MD</code> globalmente para todos os arquivos de projeto na op√ß√£o de compila√ß√£o. </p><br><p>  H√° uma sutileza associada ao ninja.  Esse sistema de constru√ß√£o gera depfiles, independentemente da presen√ßa do sinalizador <code>-MD</code> para suas necessidades.  Mas, depois que s√£o gerados, ele os converte em seu formato bin√°rio e exclui os arquivos de origem.  Portanto, ao iniciar o ninja, voc√™ deve passar o sinalizador <code>-d keepdepfile</code> .  Al√©m disso, por motivos desconhecidos para mim, no caso do make (com a op√ß√£o <code>some_file.cpp.d</code> ), o arquivo √© chamado <code>some_file.cpp.d</code> , enquanto no ninja √© chamado <code>some_file.cpp.od</code> .  Portanto, voc√™ precisa verificar as duas vers√µes. </p><br><h2 id="perenos-staticheskih-peremennyh">  Transfer√™ncia vari√°vel est√°tica </h2><br><p>  Suponha que tenhamos esse c√≥digo (um exemplo muito sint√©tico): </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Singleton.hpp class Singletor { public: static Singleton&amp; instance(); }; int veryUsefulFunction(int value); // Singleton.cpp Singleton&amp; Singletor::instance() { static Singleton ins; return ins; } int veryUsefulFunction(int value) { return value * 2; }</span></span></code> </pre> <br><p>  Queremos alterar a fun√ß√£o <code>veryUsefulFunction</code> para isso: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">veryUsefulFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value * <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br><p>  Ao recarregar, na biblioteca din√¢mica com novo c√≥digo, al√©m de <code>veryUsefulFunction</code> , a vari√°vel <code>static Singleton ins;</code>  e o m√©todo <code>Singletor::instance</code> .  Como resultado, o programa come√ßar√° a chamar novas vers√µes de ambas as fun√ß√µes.  Mas o est√°tico est√°tico nesta biblioteca ainda n√£o foi inicializado e, portanto, na primeira vez em que for acessado, o construtor da classe <code>Singleton</code> ser√° chamado.  Claro, n√£o queremos isso.  Portanto, a implementa√ß√£o transfere os valores de todas essas vari√°veis ‚Äã‚Äãque encontra na biblioteca din√¢mica montada do c√≥digo antigo para essa biblioteca muito din√¢mica com o novo c√≥digo junto com suas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vari√°veis ‚Äã‚Äãde guarda</a> . </p><br><p>  H√° um momento sutil e geralmente insol√∫vel. <br>  Suponha que tenhamos uma classe: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calledEachUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_someVar1++; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_someVar1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br><p>  O m√©todo <code>calledEachUpdate</code> chamado 60 vezes por segundo.  N√≥s o alteramos adicionando um novo campo: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calledEachUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_someVar1++; m_someVar2++; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_someVar1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_someVar2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br><p>  Se uma inst√¢ncia dessa classe estiver localizada na mem√≥ria din√¢mica ou na pilha, ap√≥s recarregar o c√≥digo, √© prov√°vel que o aplicativo falhe.  A inst√¢ncia alocada cont√©m apenas a vari√°vel <code>m_someVar1</code> , mas ap√≥s a reinicializa√ß√£o, o m√©todo <code>calledEachUpdate</code> tentar√° alterar <code>m_someVar2</code> , alterando o que realmente n√£o pertence a esta inst√¢ncia, o que leva a consequ√™ncias imprevis√≠veis.  Nesse caso, a l√≥gica de transfer√™ncia de estado √© transferida para o programador, que deve, de alguma forma, salvar o estado do objeto e excluir o pr√≥prio objeto antes que o c√≥digo seja recarregado, e criar um novo objeto ap√≥s a reinicializa√ß√£o.  A biblioteca fornece eventos nos m√©todos delegados <code>onCodePostLoad</code> e <code>onCodePostLoad</code> que o aplicativo pode processar. </p><br><p>  N√£o sei como (e se) √© poss√≠vel resolver essa situa√ß√£o de uma maneira geral, pensarei.  Agora, este caso "mais ou menos normal" funcionar√° apenas para vari√°veis ‚Äã‚Äãest√°ticas, ele usa a seguinte l√≥gica: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* oldVarPtr = ...; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* newVarPtr = ...; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> oldVarSize = ...; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> newVarSize = ...; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(newVarPtr, oldVarPtr, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::min(oldVarSize, newVarSize));</code> </pre> <br><p>  Isso n√£o est√° muito correto, mas √© o melhor que eu criei. </p><br><p>  Como resultado, o c√≥digo se comportar√° de forma imprevis√≠vel se o tempo de execu√ß√£o alterar o conjunto e o layout dos campos nas estruturas de dados.  O mesmo se aplica aos tipos polim√≥rficos. </p><br><h2 id="sobiraem-vse-vmeste">  Juntando tudo </h2><br><p>  Como tudo funciona juntos. </p><br><ul><li>  A biblioteca itera sobre os cabe√ßalhos de todas as bibliotecas carregadas dinamicamente no processo e, de fato, o pr√≥prio programa analisa e filtra caracteres. </li><li>  Em seguida, a biblioteca tenta localizar o arquivo <code>compile_commands.json</code> no diret√≥rio do aplicativo e nos diret√≥rios pai recursivamente e extrai de l√° todas as informa√ß√µes necess√°rias sobre o ET. </li><li>  Conhecendo o caminho para arquivos de objetos, a biblioteca carrega e analisa depfiles. </li><li>  Depois disso, o diret√≥rio mais comum para todos os arquivos de c√≥digo fonte do programa √© calculado e o monitoramento desse diret√≥rio come√ßa recursivamente. </li><li>  Quando um arquivo √© alterado, a biblioteca verifica se est√° no hashmap de depend√™ncias e, se houver, inicia v√°rios processos de compila√ß√£o dos arquivos alterados e suas depend√™ncias em segundo plano, usando os comandos de compila√ß√£o de <code>compile_commands.json</code> . </li><li>  Quando o programa solicita que voc√™ recarregue o c√≥digo (no meu aplicativo, a combina√ß√£o <code>Ctrl+r</code> √© atribu√≠da a isso), a biblioteca aguarda a conclus√£o dos processos de compila√ß√£o e vincula todos os novos objetos √† biblioteca din√¢mica. </li><li>  Essa biblioteca √© ent√£o carregada no espa√ßo de endere√ßo do processo <code>dlopen</code> fun√ß√£o <code>dlopen</code> . </li><li>  As informa√ß√µes sobre s√≠mbolos s√£o carregadas nesta biblioteca e toda a interse√ß√£o do conjunto de s√≠mbolos dessa biblioteca e dos s√≠mbolos que j√° vivem no processo √© recarregada (se for uma fun√ß√£o) ou transferida (se for uma vari√°vel est√°tica). </li></ul><br><p>  Isso funciona muito bem, especialmente quando voc√™ sabe o que est√° por tr√°s e o que esperar, pelo menos em um n√≠vel alto. </p><br><p>  Pessoalmente, fiquei muito surpreso com a falta dessa solu√ß√£o para Linux, algu√©m est√° realmente interessado nisso? </p><br><p>  Ficarei feliz em qualquer cr√≠tica, obrigado! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Link para implementa√ß√£o</strong></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435260/">https://habr.com/ru/post/pt435260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435250/index.html">Como a ITMO University funciona: um tour pelo nosso laborat√≥rio ciberf√≠sico</a></li>
<li><a href="../pt435252/index.html">Jessica Livingston: ‚ÄúComo criamos o Y Combinator. O componente emocional "</a></li>
<li><a href="../pt435254/index.html">Tratamento de erros funcionais no Kotlin usando Arrow</a></li>
<li><a href="../pt435256/index.html">Classificamos os recrutadores em letras frias</a></li>
<li><a href="../pt435258/index.html">Escrevemos nossa linguagem de programa√ß√£o, parte 2: representa√ß√£o intermedi√°ria de programas</a></li>
<li><a href="../pt435262/index.html">Li-Fi: O futuro da Internet</a></li>
<li><a href="../pt435264/index.html">Edi√ß√£o de pre√ßos em RMK. 1C: Gest√£o do Com√©rcio 11</a></li>
<li><a href="../pt435268/index.html">N√£o me trate m√©dico</a></li>
<li><a href="../pt435270/index.html">Mantenha as chaves SSH seguras</a></li>
<li><a href="../pt435272/index.html">Ciclofobia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>