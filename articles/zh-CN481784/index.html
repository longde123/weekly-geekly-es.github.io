<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💆🏾 ⬆️ 😣 卡夫卡如何实现 🤙🏾 🧜🏾 🍂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！ 


 我在Tinkoff团队工作，该团队正在开发自己的通知中心。 在大多数情况下，我使用Spring boot在Java中进行开发，并解决了该项目中出现的各种技术问题。 


 我们的大多数微服务都通过消息代理彼此异步交互。 以前，我们使用IBM MQ作为代理，该代理停止应付负载，但同时...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>卡夫卡如何实现</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/481784/"><p><img src="https://habrastorage.org/webt/d1/z0/m1/d1z0m1b3kvl5hobn4_4nnxuxc3o.png"></p><br><p> 哈Ha！ </p><br><p> 我在Tinkoff团队工作，该团队正在开发自己的通知中心。 在大多数情况下，我使用Spring boot在Java中进行开发，并解决了该项目中出现的各种技术问题。 </p><br><p> 我们的大多数微服务都通过消息代理彼此异步交互。 以前，我们使用IBM MQ作为代理，该代理停止应付负载，但同时具有很高的交付保证。 </p><br><p> 作为替代，我们提供了具有高可伸缩性的Apache Kafka，但不幸的是，它需要针对不同场景的几乎单独的配置方法。 另外，默认情况下，默认情况下，Kafka至少有一次传递机制不允许立即保持所需的一致性级别。 接下来，我将分享我们在配置Kafka方面的经验，特别是，我将告诉您如何配置并在交付后立即使用。 </p><a name="habracut"></a><br><h2 id="garantirovannaya-dostavka-i-ne-tolko"> 保证交货等 </h2><br><p> 稍后将讨论的参数将有助于防止默认连接设置出现许多问题。 但是首先，我要注意一个参数，它有助于进行可能的调试。 </p><br><p> 生产者和消费者的<strong>Client.id</strong>将对此提供帮助。 乍一看，您可以将应用程序的名称用作值，并且在大多数情况下，这是可行的。 尽管在应用程序中使用了多个使用者并给他们提供相同的client.id时，会导致以下警告： </p><br><pre><code class="java hljs">org.apache.kafka.common.utils.AppInfoParser — Error registering AppInfo mbean javax.management.InstanceAlreadyExistsException: kafka.consumer:type=app-info,id=kafka.test-<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p> 如果要在具有Kafka的应用程序中使用JMX，则可能会出现问题。 在这种情况下，最好使用应用程序名称和主题名称的组合作为client.id的值。 从Confluent的实用程序的<strong>kafka-consumer-groups</strong>命令的输出中可以看到我们配置的结果： </p><br><p><img src="https://habrastorage.org/webt/1e/qh/1z/1eqh1zw485osmsizmx6gu9_d8ne.png"></p><br><p> 现在，我们将分析保证消息传递的场景。  Kafka Producer有一个<strong>acks</strong>参数，通过该参数，您可以配置在确认集群领导者需要考虑成功记录的消息的确认数量之后。 此参数可以采用以下值： </p><br><ul><li>  0-不考虑确认。 </li><li>  1-默认参数，仅1个副本需要确认。 </li><li>  -1-所有同步副本都需要确认（ <strong>min.insync.replicas</strong>集群<strong>配置</strong> ）。 </li></ul><br><p> 从上述值可以看出，等于-1的acks提供了最强的保证，即消息不会丢失。 </p><br><p> 众所周知，分布式系统是不可靠的。 为了防止出现临时故障，Kafka Producer提供了一个<strong>重试</strong>参数，该参数允许您设置<strong>delivery.timeout.ms</strong>期间的重试次数。 由于retries参数默认为Integer.MAX_VALUE（2147483647），因此可以通过仅更改delivery.timeout.ms来控制消息的重传次数。 </p><br><h2 id="dvizhemsya-k-exactly-once-delivery"> 朝着正好一次交货的方向发展 </h2><br><p> 这些设置使我们的生产者可以高度保证地传递消息。 现在让我们谈谈如何确保在Kafka主题中仅记录一条消息的副本？ 在最简单的情况下，要在Producer上执行此操作，请将<strong>enable.idempotence</strong>参数设置为true。 幂等保证在一个主题的特定分区中仅记录一条消息。 启用幂等性的先决条件是<strong>acks = all，重试&gt; 0，最大in.flight.requests.per.connection≤5</strong> 。 如果开发人员未设置这些参数，则将自动设置以上值。 </p><br><p> 设置幂等时，必须确保每次都将相同的消息放入相同的分区中。 这可以通过在Producer上配置键和partitioner.class参数来完成。 让我们从钥匙开始。 对于每次装运，必须相同。 使用原始消息中的任何业务标识符可以轻松实现这一点。  partitioner.class参数的默认值为<a href="">DefaultPartitioner</a> 。 使用此分区策略，默认行为如下： </p><br><ul><li> 如果在发送消息时明确指定了分区，那么我们将使用它。 </li><li> 如果未指定分区，但指定了键，请从键中通过哈希选择分区。 </li><li> 如果未指定分区和键，则依次选择分区（循环轮询）。 </li></ul><br><p> 此外，通过使用参数<strong>max.in.flight.requests.per.connection = 1</strong>的键和幂等发送，可以有序地处理Consumer上的消息。 另外，值得记住的是，如果在群集上配置了访问控制，那么您将需要有权写入该主题的权限。 </p><br><p> 如果突然之间没有足够的可能性来通过密钥进行幂等发送，或者生产者端的逻辑要求保持不同分区之间的数据一致性，那么事务就可以解决。 此外，使用链式交易，您可以有条件地将Kafka中的记录与数据库中的记录进行同步。 为了使事务发送到Producer，必须具有幂等性，并可以选择设置<strong>transactional.id</strong> 。 如果在您的Kafka集群上配置了访问控制，则对于事务记录以及幂等，您将需要写许可权，可以通过mask使用transactional.id中存储的值来授予写许可权。 </p><br><p> 正式地，您可以使用任何字符串（例如，应用程序的名称）作为事务标识符。 但是，如果您使用相同的transactional.id运行同一应用程序的多个实例，则第一个启动的实例将因错误而停止，因为Kafka会将其视为僵尸进程。 </p><br><pre> <code class="java hljs">org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer<span class="hljs-string"><span class="hljs-string">'s transaction has been expired by the broker.</span></span></code> </pre> <br><p> 为了解决此问题，我们以主机名的形式向应用程序名称添加后缀，该后缀是从环境变量获取的。 </p><br><p> 配置了生产者，但是Kafka上的事务仅控制消息范围。 无论事务状态如何，该消息都会立即成为主题，但是具有其他系统属性。 </p><br><p> 为了防止消费者提前读取此类消息，他需要将<strong>isolation.level</strong>参数设置为read_committed。 这样的使用者将能够像以前一样读取非事务性消息，并且仅在提交之后才能读取事务性消息。 <br> 如果您安装了上面列出的所有设置，则只需配置一次交付即可。 恭喜你！ </p><br><p> 但是还有一点细微差别。 我们在上面配置的Transactional.id实际上是交易前缀。 在事务管理器上，向其添加序列号。 接收的标识符在<strong>transactional.id.expiration.ms</strong>上发布，该标识符在Kafka集群上配置，默认值为“ 7 days”。 如果在这段时间内应用程序没有收到任何消息，那么当您尝试下一次事务发送时，您将收到<strong>InvalidPidMappingException</strong> 。 此后，事务协调器将为下一个事务发布新的序列号。 但是，如果未正确处理InvalidPidMappingException，则该消息可能会丢失。 </p><br><h2 id="vmesto-itogov"> 代替总数 </h2><br><p> 如您所见，仅向Kafka发送消息是不够的。 您需要选择参数的组合，并准备进行快速更改。 在本文中，我试图详细显示一次传递设置，并描述了我们遇到的几个client.id和transactional.id配置问题。 生产者和消费者设置摘要如下。 </p><br><p> 制片人： </p><br><ol><li> 臀部=全部 </li><li> 重试&gt; 0 </li><li>  enable.idempotence = true </li><li> 最大飞行请求连接数≤5（1-有序发送） </li><li>  transactional.id = $ {应用程序名称}-$ {主机名} </li></ol><br><p> 消费者： </p><br><ol><li>  isolated.level = read_committed </li></ol><br><p> 为了使将来的应用程序中的错误最小化，我们对spring配置进行了包装，其中已设置了某些列出的参数的值。 </p><br><p> 以下是一些可供独立学习的材料： </p><br><ul><li>  <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98%2B-%2BExactly%2BOnce%2BDelivery%2Band%2BTransactional%2BMessaging">KIP-98-恰好一次传递和事务消息传递</a> </li><li>  <a href="https://kafka.apache.org/documentation/">设定说明</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481784/">https://habr.com/ru/post/zh-CN481784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481774/index.html">安全备忘单：虚拟补丁程序</a></li>
<li><a href="../zh-CN481776/index.html">5G和云游戏服务-测试其在莫斯科的工作方式</a></li>
<li><a href="../zh-CN481778/index.html">万能钥匙恶意软件分析</a></li>
<li><a href="../zh-CN481780/index.html">MyOffice具有200多种新功能</a></li>
<li><a href="../zh-CN481782/index.html">关于Python转换器问题和语言重新思考</a></li>
<li><a href="../zh-CN481786/index.html">谷歌掩埋PHP IMAP扩展</a></li>
<li><a href="../zh-CN481788/index.html">分析解决实际行业问题（拯救仔猪等）</a></li>
<li><a href="../zh-CN481790/index.html">作弊如何改变Speedrunner社区</a></li>
<li><a href="../zh-CN481792/index.html">PVS-Studio如何举行2019年下半年会议</a></li>
<li><a href="../zh-CN481794/index.html">Beckender-心理治疗师：心理调试器</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>