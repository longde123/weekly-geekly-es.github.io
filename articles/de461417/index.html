<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé≤ üåã üë≥üèø Wie ich db4o in einem industriellen System abgelehnt habe üçÖ ü•õ ü•Ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir sind eine gro√üe Unternehmensabteilung, die ein wichtiges Java SE / MS SQL / db4o-System entwickelt. F√ºr einige Jahre wechselte das Projekt von ein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich db4o in einem industriellen System abgelehnt habe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461417/"><p><img src="https://habrastorage.org/webt/ql/p2/ye/qlp2yevkdo5rbywpveackt_fm7s.jpeg" alt="Bild"></p><br><p>  Wir sind eine gro√üe Unternehmensabteilung, die ein wichtiges Java SE / MS SQL / db4o-System entwickelt.  F√ºr einige Jahre wechselte das Projekt von einem Prototyp zu einem industriellen Betrieb und db4o wurde zu einer Berechnungsbremse. Ich wollte von db4o zu moderner noSQL-Technologie wechseln.  Versuch und Irrtum f√ºhrten weit vom urspr√ºnglichen Plan weg - db4o wurde erfolgreich aufgegeben, jedoch auf Kosten eines Kompromisses.  Unter der Katze Reflexionen und Implementierungsdetails. </p><a name="habracut"></a><br><h2 id="tehnologiya-db4o-umerla">  Ist die db4o-Technologie tot? </h2><br><p>  Auf Habr√© finden sich nicht so viele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Publikationen</a> zu db4o.  Bei Stackoverflow ist eine Art Restaktivit√§t wie ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">neuer Kommentar zu einer alten Frage</a> oder eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">neue unbeantwortete Frage</a> .  Wiki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">glaubt</a> allgemein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">,</a> dass die aktuelle stabile Version von 2011 ist. </p><br><p>  Dies bildet einen allgemeinen Eindruck: Die Technologie ist irrelevant.  Es gab sogar eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offizielle Best√§tigung</a> : Actian beschloss, das kommerzielle db4o-Produktangebot f√ºr Neukunden nicht mehr aktiv zu verfolgen und zu bewerben. </p><br><h2 id="kak-db4o-popala-v-raschet">  Wie wurde db4o berechnet? </h2><br><p>  Der Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einf√ºhrung in objektorientierte Datenbanken befasst sich</a> mit dem Hauptmerkmal von db4o - dem v√∂lligen Fehlen eines Datenschemas.  Sie k√∂nnen jedes Objekt erstellen </p><br><pre><code class="plaintext hljs">User user1 = new User("Vasya", "123456", 25);</code> </pre> <br><p>  und dann schreiben Sie es einfach in die Datenbankdatei </p><br><pre> <code class="plaintext hljs">db.Store(user1)</code> </pre> <br><p>  Das aufgezeichnete Objekt kann dann mit der Methode Query.execute () in der Form abgerufen werden, in der es gespeichert wurde. </p><br><p>  Dies erm√∂glichte es zu Beginn des Projekts, die Anzeige des Audit-Trails mit allen √ºbermittelten Daten schnell sicherzustellen, ohne sich um die Struktur relationaler Tabellen zu k√ºmmern.  Dies half dem Projekt zu √ºberleben.  Dann befanden sich nur wenige Ressourcen in der Sandbox, und unmittelbar nach dem Ende der heutigen Berechnung wurden Daten f√ºr morgen in MS SQL geladen.  Alles √§nderte sich st√§ndig - finden Sie heraus, was genau nachts automatisch serviert wurde.  Auf die db4o-Datei kann zugegriffen werden <br>  Extrahieren Sie beim Debuggen einen Schnappschuss des gew√ºnschten Tages und beantworten Sie die Frage "Wir haben alle Daten √ºbermittelt, aber Sie haben nichts bestellt." </p><br><p>  Im Laufe der Zeit verschwand das √úberlebensproblem, das Projekt startete, die Arbeit mit Benutzeranfragen hat sich ge√§ndert.  √ñffnen Sie eine db4o-Datei beim Debuggen und analysieren Sie eine schwierige Frage eines Entwicklers, der immer besch√§ftigt ist.  Stattdessen gibt es eine Menge von Analysten, die mit einer Beschreibung der Auftragslogik ausgestattet sind und nur den vom Benutzer sichtbaren Teil der Daten verwenden k√∂nnen.  Bald wurde db4o nur noch verwendet, um den Verlauf der Berechnung anzuzeigen.  Genau wie bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pareto</a> liefert ein kleiner Teil der Funktionen die Hauptlast. </p><br><p>  Im Kampfbetrieb dauert die Verlaufsdatei ~ 35 GB / Tag, das Entladen dauert etwa eine Stunde.  Die Datei selbst wird gut komprimiert (1:10), aber aus irgendeinem Grund f√ºhrt die Bibliothek com.db4o.ObjectContainer keine Komprimierung durch.  Im Norden von CentOS schreibt / liest die Bibliothek com.db4o.query.Query eine Datei ausschlie√ülich in einen Stream.  Geschwindigkeit ist ein Engpass. </p><br><h1 id="principialnaya-shema-ustroystva">  Schematische Darstellung des Ger√§tes </h1><br><p>  Das Informationsmodell des Systems ist die Hierarchie der Objekte A, B, C und D. Die Hierarchie ist kein Baum, f√ºr den Betrieb sind Verkn√ºpfungen C1 -&gt; B1 erforderlich. </p><br><pre> <code class="plaintext hljs">ROOT || | ==&gt;A1 | || | | ==&gt; B1 &lt;------ | | || | | | | ======&gt; C1 | | | | | | | ===&gt; C1.$D | | =======&gt; C2 | | | | ==&gt; B2 ==&gt; C2.$D | | ===&gt;A2 =======&gt; C3 | | ==&gt; B3 ===&gt; C3.$D | ======&gt; C4 | ===&gt; C4.$D</code> </pre> <br><p>  Der Benutzer interagiert mit dem Server √ºber die Benutzeroberfl√§che (GUI), die von com.sun.net.httpserver.HttpsServer bereitgestellt wird. Der Client und der Server tauschen XML-Dokumente aus.  Bei der ersten Anzeige weist der Server der Benutzerebene eine Kennung zu, die sich nicht weiter √§ndert.  Wenn der Benutzer einen Verlauf einer bestimmten Ebene ben√∂tigt, sendet die GUI dem Server eine XML-umschlossene Kennung.  Der Server ermittelt die Werte der Schl√ºssel zum Durchsuchen der Datenbank, durchsucht die db4o-Datei nach dem gew√ºnschten Tag und ruft das angeforderte Objekt im Speicher sowie alle Objekte ab, auf die er verweist.  Erstellt eine XML-Pr√§sentation der extrahierten Ebene und gibt sie an den Client zur√ºck. </p><br><p>  Beim Scannen einer Datei liest db40 standardm√§√üig alle untergeordneten Objekte bis zu einer bestimmten Tiefe und extrahiert eine ziemlich gro√üe Hierarchie zusammen mit dem gew√ºnschten Objekt.  Die Lesezeit kann reduziert werden, indem die minimale Aktivierungstiefe f√ºr die unn√∂tige Foo-Klasse mit conf.common (). ObjectClass (Foo.class) .maximumActivationDepth (1) festgelegt wird. </p><br><p>  Die Verwendung anonymer Klassen f√ºhrt zur Erstellung impliziter Verweise auf die einschlie√üende Klasse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">this $ 0</a> .  Db4o verarbeitet und stellt solche Links korrekt (aber langsam) wieder her. </p><br><h1 id="0-ideya">  0. Idee </h1><br><p>  Administratoren haben also einen seltsamen Gesichtsausdruck, wenn es darum geht, db4o zu unterst√ºtzen oder zu verwalten.  Die Datenextraktion ist langsam, die Technologie nicht sehr lebendig.  Aufgabe: Wenden Sie anstelle von db4o die aktuelle NoSQL-Technologie an.  Ein Paar Spring Data + MongoDB fiel mir auf. </p><br><h1 id="1-lobovoy-podhod">  1. Frontaler Ansatz </h1><br><p>  Mein erster <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gedanke</a> war, org.springframework.data.mongodb.core.MongoOperations und die save () -Methode zu verwenden, da sie wie com.db4o.ObjectContainer.db.Store (user1) aussieht.  Die MongoDB-Dokumentation besagt, dass Dokumente in Sammlungen gespeichert sind. Es ist logisch, die erforderlichen Systemobjekte als Dokumente der entsprechenden Sammlungen darzustellen.  Es gibt auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@ DBRef-Annotationen</a> , mit denen Sie Beziehungen zwischen Dokumenten im Allgemeinen im Sinne von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3NF</a> implementieren k√∂nnen.  Lass uns gehen. </p><br><h2 id="11-vygruzka-ssylochnyy-tip-klyucha">  1.1.  Entladen.  Schl√ºsselreferenztyp </h2><br><p>  Das System besteht aus POJO-Klassen, die vor langer Zeit und ohne Ber√ºcksichtigung all dieser neuen Technologien entwickelt wurden.  Felder vom Typ Map &lt;POJO, POJO&gt; werden verwendet, es gibt eine verzweigte Logik, mit ihnen zu arbeiten.  Ich speichere dieses Feld, ich erhalte eine Fehlermeldung </p><br><pre> <code class="plaintext hljs">org.springframework.data.mapping.MappingException: Cannot use a complex object as a key value.</code> </pre> <br><p>  Bei dieser Gelegenheit wurde nur die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Korrespondenz von 2011 gefunden</a> , in der vorgeschlagen wurde, einen nicht standardm√§√üigen MappingMongoConverter zu entwickeln.  Bisher habe ich die Problemfelder @ Transient notiert.  Es stellte sich heraus, zu sparen und das Ergebnis zu studieren. </p><br><p>  Das Speichern erfolgt in der Sammlung, deren Name mit dem Namen der gespeicherten Klasse √ºbereinstimmt.  Ich habe noch keine @ DBRef-Anmerkungen verwendet, daher gibt es nur eine Sammlung. JSON-Dokumente sind ziemlich gro√ü und verzweigt.  Ich stelle fest, dass MongoOperations beim Speichern des Objekts alle (einschlie√ülich geerbten) nicht leeren Links durchl√§uft und sie als angeh√§ngtes Dokument schreibt. </p><br><h2 id="12-vygruzka-imenovannoe-pole-ili-massiv">  1.2.  Entladen.  Benanntes Feld oder Array? </h2><br><p>  Das Systemmodell ist so, dass die Klasse C mehrmals einen Verweis auf dieselbe Klasse D enthalten kann.  In einem separaten defaultMode-Feld und unter anderen Links in ArrayList, so etwas <br></p><pre> <code class="plaintext hljs">public class C { private D defaultMode; private List&lt;D&gt; listOfD = new ArrayList&lt;D&gt;(); public class D { .. } public C(){ this.defaultMode = new D(); listOfD.add(defaultMode); } }</code> </pre> <br><p>  Nach dem Entladen verf√ºgt das JSON-Dokument √ºber zwei Kopien: ein angeh√§ngtes Dokument mit dem Namen defaultMode und ein unbenanntes Element des Dokumentarrays.  Im ersten Fall kann auf das Dokument √ºber den Namen zugegriffen werden, im zweiten √ºber den Namen des Arrays mit einem Index.  In beiden F√§llen k√∂nnen Sie MongoDB-Sammlungen durchsuchen.  Ich habe nur mit Spring Data und MongoDB gearbeitet und bin zu dem Schluss gekommen, dass Sie ArrayList verwenden k√∂nnen, wenn Sie es sorgf√§ltig verwenden.  Ich habe die Einschr√§nkungen bei der Verwendung von Arrays nicht bemerkt  Funktionen wurden sp√§ter auf der Ebene von MongoDB Connector for BI angezeigt. </p><br><h2 id="13-zagruzka-argumenty-konstruktora">  1.3.  Herunterladen  Konstruktorargumente </h2><br><p>  Ich versuche, ein gespeichertes Dokument mit der Methode MongoOperations.findOne () zu lesen.  Das Laden von Objekt A aus der Datenbank l√∂st eine Ausnahme aus </p><br><pre> <code class="plaintext hljs">"No property name found on entity class A to bind constructor parameter to!"</code> </pre> <br><p>  Es stellte sich heraus, dass die Klasse ein corpName-Feld und der Konstruktor einen String name-Parameter hat und this.corpName = name im Konstruktork√∂rper zugewiesen ist.  MongoOperations erfordert, dass die Feldnamen in den Klassen mit den Namen der Konstruktorargumente √ºbereinstimmen.  Wenn mehrere Konstruktoren vorhanden sind, m√ºssen Sie einen mit der Annotation @PersistenceConstructor ausw√§hlen.  Ich bringe die Namen der Felder und Parameter in √úbereinstimmung. </p><br><h2 id="14-zagruzka-sd-i-this0">  1.4.  Herunterladen  Mit $ D und diesem $ 0 </h2><br><p>  Die inner verschachtelte Klasse D kapselt das Standardverhalten der Klasse C und ist getrennt von Klasse C nicht sinnvoll.  F√ºr jede Instanz von C wird eine Instanz von D erstellt und umgekehrt. F√ºr jede Instanz von D gibt es eine Instanz von C, die sie generiert hat. Die Klasse D verf√ºgt weiterhin √ºber Nachkommen, die alternative Verhaltensweisen implementieren und in listOfD gespeichert werden k√∂nnen.  Der Konstruktor der Nachkommenklassen von D ben√∂tigt das Vorhandensein eines bereits vorhandenen Objekts C. </p><br><p>  Zus√§tzlich zu verschachtelten inneren Klassen verwendet das System <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">anonyme</a> innere Klassen.  Wie Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wissen</a> , enthalten beide einen impliziten Verweis auf eine Instanz einer einschlie√üenden Klasse.  Das hei√üt, als Teil jeder Instanz des CD-Objekts erstellt der Compiler einen Link mit diesem Wert von $ 0, der auf das √ºbergeordnete Objekt C verweist. </p><br><p>  Ich versuche erneut, das gespeicherte Dokument aus der Sammlung zu lesen und eine Ausnahme zu erhalten </p><br><pre> <code class="plaintext hljs">"No property this$0 found on entity class $D to bind constructor parameter to!"</code> </pre> <br><p>  Ich erinnere mich, dass die Methoden der Klasse D die volle Kraft der C.this.fieldOfClassC-Referenzen verwenden und die Nachkommen der Klasse D erfordern, dass der Konstruktor C als Argument instanziiert.  Das hei√üt, ich muss eine bestimmte Reihenfolge zum Erstellen von Objekten in MongoOperations angeben, damit das √ºbergeordnete Objekt C im D-Konstruktor angegeben werden kann. Wieder der nicht standardm√§√üige MappingMongoConverter? </p><br><p>  Vielleicht keine anonymen Klassen verwenden und innere Klassen normalisieren?  Die Architektur eines bereits implementierten Systems zu verfeinern oder vielmehr zu verfeinern, ist eine Wow-Aufgabe ... </p><br><h1 id="2-podhod-so-storony-3nfdbref">  2. Ann√§herung von 3NF / @ DBRef </h1><br><p>  Ich versuche andererseits, jede Klasse in meiner Sammlung zu speichern und im Geiste von 3NF Verbindungen zwischen ihnen herzustellen. </p><br><h2 id="21-vygruzka-dbref---eto-krasivo">  2.1.  Entladen.  @DBRef ist wundersch√∂n </h2><br><p>  Klasse C enth√§lt mehrere Verweise auf D. Wenn die Links defaultMode und ArrayList als @DBRef markiert sind, verringert sich die Dokumentgr√∂√üe, anstatt gro√üer angeh√§ngter Dokumente werden saubere Links angezeigt.  Im Feld json Dokument der Sammlung C wird das Feld angezeigt <br></p><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  In der MongoDB-Datenbank wird automatisch eine Sammlung D und ein Dokument mit einem Feld darin erstellt </p><br><pre> <code class="plaintext hljs">"_id" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  Alles ist einfach und sch√∂n. </p><br><h2 id="22-zagruzka-konstuktor-klassa-d">  2.2.  Herunterladen  Klasse-D-Konstruktor </h2><br><p>  Bei der Arbeit mit Links wei√ü das C-Objekt, dass das Standard-D-Objekt genau einmal erstellt wird.  Wenn Sie alle D-Objekte au√üer dem Standardobjekt umgehen m√ºssen, vergleichen Sie einfach die Links: </p><br><pre> <code class="plaintext hljs">private D defaultMode; private ArrayList&lt;D&gt; listOfD; for (D currentD: listOfD){ if (currentD == defaultMode) continue; doSomething(currentD); }</code> </pre> <br><p>  Ich rufe findOne () auf, lerne meine Klasse C. Es stellt sich heraus, dass MongoOperations ein JSON-Dokument liest und den D-Konstruktor f√ºr jede @ DBRef-Annotation aufruft, auf die es st√∂√üt, jedes Mal, wenn ein neues Objekt erstellt wird.  Ich erhalte ein seltsames Konstrukt - zwei verschiedene Verweise auf D im Feld defaultMode und im Array listOfD, wobei der Link identisch sein sollte. </p><br><p>  Von der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Community</a> lernen: "Dbref sollte meiner Meinung nach bei der Arbeit mit Mongodb vermieden werden."  Eine weitere <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√úberlegung</a> in der gleichen Weise wie in der offiziellen Dokumentation: Das denormalisierte Datenmodell, in dem verwandte Daten in einem einzelnen Dokument gespeichert sind, ist optimal, um DBRefs aufzul√∂sen. Ihre Anwendung muss zus√§tzliche Abfragen ausf√ºhren, um die referenzierten Dokumente zur√ºckzugeben. </p><br><p>  Auf der erw√§hnten Dokumentationsseite steht ganz am Anfang: "F√ºr viele Anwendungsf√§lle in MongoDB ist das denormalisierte Datenmodell, bei dem verwandte Daten in einem einzigen Dokument gespeichert sind, optimal."  Ist es f√ºr mich geschrieben? </p><br><p>  Wenn Sie sich auf den Designer konzentrieren, m√ºssen Sie nicht wie in einem relationalen DBMS denken.  Die Wahl ist: </p><br><ul><li>  Wenn Sie @DBRef angeben: <br><ul><li>  Der Konstruktor f√ºr jede Annotation wird aufgerufen und mehrere identische Objekte werden erstellt. </li><li>  MongoOperations findet und liest alle Dokumente aus allen zugeh√∂rigen Sammlungen.  ObjectId fordert den Index an und liest dann aus vielen Sammlungen einer (gro√üen) Datenbank. </li></ul></li><li>  Wenn Sie nichts angeben, wird der "abnormalisierte" JSON mit Wiederholungen derselben Daten gespeichert. </li></ul><br><p>  Ich stelle f√ºr mich selbst fest: Sie k√∂nnen sich nicht auf @DBRef verlassen, sondern ein Feld vom Typ ObjectId verwenden und es manuell ausf√ºllen.  In diesem Fall anstelle von </p><br><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  JSON-Dokument enth√§lt </p><br><pre> <code class="plaintext hljs">"defaultMode" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  Es wird nicht automatisch geladen - MongoOperations wei√ü nicht, in welcher Sammlung nach einem Dokument gesucht werden soll.  Das Dokument muss in eine separate (verz√∂gerte) Anforderung geladen werden, die die Sammlung und die Objekt-ID angibt.  Eine einzelne Abfrage sollte das Ergebnis schnell zur√ºckgeben. Au√üerdem wird f√ºr jede Sammlung von ObjectId ein automatischer Index erstellt. </p><br><h2 id="23-nu-i-chto-teper">  2.3.  Also was jetzt? </h2><br><p>  Zwischensummen.  Es war nicht m√∂glich, die db4o-Funktionalit√§t schnell und einfach in MongoDB zu implementieren: </p><br><ul><li>  Es ist unklar, wie ein benutzerdefiniertes POJO als Schl√ºssel - Wert - Listenschl√ºssel verwendet wird. </li><li>  Es ist unklar, wie die Reihenfolge festgelegt wird, in der Objekte in MappingMongoConverter erstellt werden. </li><li>  Es ist unklar, ob ein "nicht normalisiertes" Dokument ohne DBRef hochgeladen werden soll und ob ein eigener Mechanismus f√ºr die verz√∂gerte Initialisierung erforderlich ist. </li></ul><br><p>  Sie k√∂nnen Lazy Loading hinzuf√ºgen.  Sie k√∂nnen versuchen, MappingMongoConverter auszuf√ºhren.  Sie k√∂nnen vorhandene Konstruktoren / Felder / Listen √§ndern.  Aber es gibt viele Jahre der √úberlagerung von Gesch√§ftslogik - keine schwache √Ñnderung und das Risiko, niemals getestet zu werden. </p><br><p>  Kompromissl√∂sung: Erstellen eines neuen Mechanismus zum Speichern von Daten f√ºr das zu l√∂sende Problem unter Beibehaltung des Mechanismus f√ºr die Interaktion mit der GUI. </p><br><h1 id="3-popytka-tretya-opyt-pervyh-dvuh">  3. Der dritte Versuch, die Erfahrung der ersten beiden </h1><br><p>  Pareto schl√§gt vor, dass das L√∂sen von Problemen mit der Geschwindigkeit der Benutzer den Erfolg der gesamten Aufgabe bedeuten wird.  Die Aufgabe lautet wie folgt: Sie m√ºssen lernen, wie Sie Benutzerpr√§sentationsdaten ohne db4o schnell speichern und wiederherstellen k√∂nnen. </p><br><p>  Dadurch wird die M√∂glichkeit verloren, das gespeicherte Objekt beim Debuggen zu untersuchen.  Einerseits ist das schlecht.  Auf der anderen Seite treten solche Aufgaben selten auf, und in git sind alle Kampflieferungen markiert.  Aus Gr√ºnden der Fehlertoleranz serialisiert das System die Berechnung jedes Mal vor dem Entladen in eine Datei.  Wenn Sie ein Objekt beim Debuggen untersuchen m√ºssen, k√∂nnen Sie die Serialisierung durchf√ºhren, die entsprechende Systemassembly klonen und die Berechnung wiederherstellen. </p><br><h2 id="31-dannye-polzovatelskih-prezentaciy">  3.1.  Benutzerdefinierte Pr√§sentationsdaten </h2><br><p>  Um Pr√§sentationen von Benutzerebenen zu erstellen, verf√ºgt das System √ºber eine spezielle Viewer-Klasse.  Die Viewer.getXML () -Methode empf√§ngt eine Ebene als Eingabe, extrahiert die erforderlichen numerischen Werte und Zeichenfolgenwerte daraus und generiert XML. </p><br><p>  Wenn der Benutzer aufgefordert hat, die Ebene der heutigen Berechnung anzuzeigen, wird die Ebene im RAM gefunden.  Um eine Berechnung aus der Vergangenheit anzuzeigen, findet die Methode com.db4o.query.Query.execute () die Ebene in der Datei.  Die Ebene aus der Datei unterscheidet sich fast nicht von der gerade erstellten Ebene, und Viewer erstellt die Pr√§sentation, ohne die Ersetzung zu bemerken. </p><br><p>  Um mein Problem zu l√∂sen, ben√∂tige ich einen Vermittler zwischen der Berechnungsebene und ihrer Pr√§sentation - das Pr√§sentationsframework (Frame), das Daten speichert und auf den verf√ºgbaren XML-Daten aufbaut.  Die Aktionskette zum Erstellen der Pr√§sentation wird jedes Mal l√§nger, wenn ein Frame generiert wird und der Frame XML generiert: </p><br><pre> <code class="plaintext hljs"> : &lt; &gt; -&gt; Viewer.getXML() : &lt; &gt; -&gt; Viewer.getFrame() -&gt; Frame.getXML()</code> </pre> <br><p>  Wenn Sie die Story speichern, m√ºssen Sie Frames aller Ebenen erstellen und in die Datenbank schreiben. </p><br><h2 id="32-vygruzka">  3.2.  Entladen </h2><br><p>  Die Aufgabe war relativ einfach und es gab keine Probleme damit.  Der Frame wiederholte die Struktur der XML-Pr√§sentation und erhielt ein rekursives Ger√§t in Form einer Hierarchie von Elementen mit den Feldern String, Integer und Double.  Der Frame fordert getXML () von allen seinen Elementen an, sammelt es in einem einzigen Dokument und gibt es zur√ºck.  MongoOperations hat mit der rekursiven Natur des Frames gro√üartige Arbeit geleistet und im weiteren Verlauf keine neuen Fragen gestellt. </p><br><p>  Endlich ging alles los!  Die WiredTiger-Engine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">komprimiert</a> standardm√§√üig MongoDB-Dokumentensammlungen. Im Dateisystem dauerte das Entladen ca. 3,5 GB pro Tag.  Ein zehnfacher R√ºckgang gegen√ºber db4o ist nicht schlecht. </p><br><p>  Zun√§chst wurde das Entladen einfach angeordnet - eine rekursive Durchquerung des Ebenenbaums MongoOperations.save () f√ºr jeden.  Das Entladen dauerte 5,5 Stunden, und dies trotz der Tatsache, dass beim Erstellen von Pr√§sentationen nur Objekte gelesen werden.  Ich f√ºge Multithreading hinzu: Durchlaufe rekursiv den Ebenenbaum, teile alle verf√ºgbaren Ebenen in Pakete einer bestimmten Gr√∂√üe auf, erstelle Callable.call () -Implementierungen entsprechend der Anzahl der Pakete, √ºbertrage jedes Paket in unser eigenes Paket und erledige alles √ºber ExecutorService.invokeAll (). </p><br><p>  MongoOperations stellte erneut keine Fragen und leistete im Multithread-Modus hervorragende Arbeit.  W√§hlen Sie die Gr√∂√üe des Pakets empirisch aus, um die beste Entladegeschwindigkeit zu erzielen.  Es stellte sich heraus, 15 Minuten f√ºr ein Paket von 1000 Ebenen. </p><br><h2 id="33-mongo-bi-connector-ili-kak-lyudyam-s-etim-rabotat">  3.3.  Mongo BI Connector oder wie Leute damit arbeiten </h2><br><p>  Die MongoDB- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Abfragesprache</a> ist gro√ü und leistungsstark. Ich habe unweigerlich Erfahrungen damit gesammelt und diesen Ort erreicht.  Die Konsole <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unterst√ºtzt</a> JavaScript, Sie k√∂nnen sch√∂ne und leistungsstarke Designs schreiben.  Das ist eine Seite.  Auf der anderen Seite kann ich einer guten H√§lfte der Analystenkollegen mit einer Anfrage das Gehirn brechen </p><br><pre> <code class="plaintext hljs">db.users.find( { numbers: { $in: [ 390, 754, 454 ] } } );</code> </pre> <br><p>  statt des √ºblichen </p><br><pre> <code class="plaintext hljs">SELECT * FROM users WHERE numbers IN (390, 754, 454)</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MongoDB Connector f√ºr BI hilft</a> Ihnen dabei, Sammlungsdokumente in tabellarischer Form darzustellen.  Die MongoDB-Datenbank wird als dokumentbasierte Datenbank bezeichnet. Sie kann keine Hierarchie von Feldern / Dokumenten in tabellarischer Form darstellen.  Damit der Connector funktioniert, muss die Struktur der zuk√ºnftigen Tabelle in einer separaten DRDL-Datei beschrieben werden, deren Format yaml sehr √§hnlich ist.  In der Datei m√ºssen Sie die Entsprechung zwischen dem Feld der relationalen Tabelle an der Ausgabe und dem Pfad zum Feld des JSON-Dokuments an der Eingabe angeben. </p><br><h2 id="34--osobennosti-ispolzovanie-massivov">  3.4.  Funktionen mit Arrays </h2><br><p>  Es wurde oben gesagt, dass es f√ºr MongoDB selbst keinen besonderen Unterschied zwischen einem Array und einem Feld gibt.  Aus Connector-Sicht unterscheidet sich ein Array stark von einem benannten Feld.  Ich musste sogar die fertige Frame-Klasse umgestalten.  Ein Array von Dokumenten sollte nur verwendet werden, wenn ein Teil der Informationen in eine verkn√ºpfte Tabelle eingef√ºgt werden muss. </p><br><p>  Wenn das JSON-Dokument eine Hierarchie benannter Felder ist, kann auf jedes Feld zugegriffen werden, indem der Pfad vom Dokumentstamm durch einen Punkt angegeben wird, z. B. xy. Wenn die Entsprechung xy =&gt; fieldXY in der DRDL-Datei angegeben ist, enth√§lt die Ausgabetabelle so viele Zeilen, wie Dokumente in der Sammlung vorhanden sind am Eingang.  Wenn in einem Dokument kein xy-Feld vorhanden ist, befindet sich NULL in der entsprechenden Zeile der Tabelle. </p><br><p>  Angenommen, wir haben eine MongoDB-Datenbank namens Frames, die Datenbank enth√§lt eine Sammlung A, und MongoOperations hat zwei Instanzen der Klasse A in diese Sammlung geschrieben. Dies sind die Dokumente: erstens </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd456"), "x": { "y": "xy string value 1"}, "days": [{ "k": "0", "v": 0.0 }, { "k": "1", "v": 0.1 }], "_class": "A" }</code> </pre> <br><p>  und zweitens (ObjectId unterscheidet sich durch die letzte Ziffer): </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd457"), "x": { "y": "xy string value 2"}, "days": [{ "k": "0", "v": 0.3 }, { "k": "1", "v": 0.4 }], "_class": "A" }</code> </pre> <br><p>  Der BI-Connector kann nicht √ºber den Index auf die Elemente des Arrays zugreifen, und es ist einfach unm√∂glich, beispielsweise das Feld days [1] .v aus dem Array in die Tabelle zu extrahieren.  Stattdessen kann der Connector jedes Element des Days-Arrays mit dem Operator <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">$ unwind</a> als Zeile in einer separaten Tabelle darstellen.  Diese separate Tabelle wird √ºber die Zeilen-ID der urspr√ºnglichen Eins-zu-Viele-Beziehung zugeordnet.  In unserem Beispiel sind die Tabellen tableA f√ºr Sammlungsdokumente und tableA_days f√ºr Dokumente des Tagesarrays definiert.  Die DRDL-Datei sieht folgenderma√üen aus: </p><br><pre> <code class="plaintext hljs">schema: - db: Frames tables: - table: tableA collection: A pipeline: [] columns: - Name: _id MongoType: bson.ObjectId SqlName: _id SqlType: objectid - Name: xy MongoType: string SqlName: fieldXY SqlType: varchar - table: tableA_days collection: A pipeline: - $unwind: path: $days columns: - Name: _id #   MongoType: bson.ObjectId SqlName: tableA_id SqlType: objectid - Name: days.k MongoType: string SqlName: tableA_dayNo SqlType: varchar - Name: days.v MongoType: string SqlName: tableA_dayVal SqlType: varchar</code> </pre> <br><p>  Der Inhalt der Tabellen lautet: table tableA </p><br><div class="scrollable-table"><table><thead><tr><th>  _id </th><th>  fieldXY </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  xy String Wert 1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  xy String Wert 2 </td></tr></tbody></table></div><br><p>  und Tabelle tableA_days </p><br><div class="scrollable-table"><table><thead><tr><th>  tableA_id </th><th>  tableA_dayNo </th><th>  tableA_dayVal </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  0 </td><td>  0.0 </td></tr><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  1 </td><td>  0,1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  0 </td><td>  0,3 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  1 </td><td>  0,4 </td></tr></tbody></table></div><br><h1 id="itogo">  Insgesamt </h1><br><p>  Es war nicht m√∂glich, die Aufgabe in der urspr√ºnglichen Formulierung zu implementieren. Sie k√∂nnen db4o nicht einfach durch MongoDB ersetzen.  MongoOperations kann kein Objekt wie db4o automatisch wiederherstellen.  Sie k√∂nnen dies wahrscheinlich tun, aber die Arbeitskosten sind nicht mit dem Aufrufen der Speicher- / Abfragemethoden der db4o-Bibliothek vergleichbar. </p><br><p>  Audit Trail.  Db4o ist ein sehr n√ºtzliches Werkzeug zu Beginn eines Projekts.  Sie k√∂nnen das Objekt einfach schreiben, dann wiederherstellen und gleichzeitig keine Sorgen und Tabellen machen.  All dies mit einer wichtigen Einschr√§nkung: Wenn Sie die Hierarchie der Klassen √§ndern m√ºssen (Klasse E zwischen A und B hinzuf√ºgen), werden alle zuvor gespeicherten Informationen unlesbar.  F√ºr das Starten eines Projekts ist dies jedoch nicht sehr wichtig, solange keine gro√üe Anzahl alter Dateien vorhanden ist. </p><br><p>  Wenn gen√ºgend Erfahrung mit MongoOperations vorhanden war, verursachte das Schreiben des Uploads keine Probleme.  Das Schreiben eines neuen Codes f√ºr das Framework ist viel einfacher als das Wiederherstellen des alten Codes, der ebenfalls in Produktion geht. </p><p></p><p></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461417/">https://habr.com/ru/post/de461417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461401/index.html">Was bist du, Event Loop? Oder wie die Ereignisschleife im Chrome-Browser funktioniert</a></li>
<li><a href="../de461403/index.html">Wie schreibe ich Musik mit OOP</a></li>
<li><a href="../de461405/index.html">Wie ich CFA Level 1 genommen habe</a></li>
<li><a href="../de461407/index.html">Aus der Geschichte des Urlaubs - AdminFest 2011 in Rostow am Don</a></li>
<li><a href="../de461413/index.html">Nicht nur Wi-Fi 6: Wie Huawei Netzwerktechnologien entwickeln wird</a></li>
<li><a href="../de461421/index.html">So versichern Sie sich gegen m√∂gliche Verluste bei einer Investition an der B√∂rse: Strukturprodukte</a></li>
<li><a href="../de461423/index.html">11 Tipps: Pr√§sentieren von UI / UX-Arbeiten f√ºr ‚ÄûNicht-Designer‚Äú</a></li>
<li><a href="../de461425/index.html">Wie man ein Produktmanager wird und weiter w√§chst</a></li>
<li><a href="../de461431/index.html">"Liebt und mag nicht": DNS √ºber HTTPS</a></li>
<li><a href="../de461433/index.html">Verwenden von Identity Server 4 in Net Core 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>