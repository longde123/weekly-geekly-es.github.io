<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ŒğŸ½ ğŸ˜‡ â›¹ğŸ» åœ¨Springä¸­è‡ªå®šä¹‰ä¾èµ–é¡¹è§£æ ğŸ§œğŸ¾ ğŸ•ºğŸ½ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä½ å¥½ æˆ‘å«Andrey Nevedomskyï¼Œæˆ‘æ˜¯SberTekhçš„é¦–å¸­å·¥ç¨‹å¸ˆã€‚ æˆ‘åœ¨ä¸€ä¸ªå›¢é˜Ÿä¸­å·¥ä½œï¼Œè¯¥å›¢é˜Ÿå¼€å‘ESFï¼ˆç»Ÿä¸€æ­£é¢ç³»ç»Ÿï¼‰çš„ç³»ç»ŸæœåŠ¡ä¹‹ä¸€ã€‚ åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç§¯æä½¿ç”¨Springæ¡†æ¶ï¼Œå°¤å…¶æ˜¯å®ƒçš„DIï¼Œå¹¶ä¸”ä¸æ—¶é‡åˆ°è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³è§£å†³Springä¸­çš„ä¾èµ–å…³ç³»å¯¹æˆ‘ä»¬æ¥è¯´ä¸å¤Ÿèªæ˜ã€‚ æœ¬æ–‡æ˜¯æˆ‘...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Springä¸­è‡ªå®šä¹‰ä¾èµ–é¡¹è§£æ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/435364/"> ä½ å¥½ æˆ‘å«Andrey Nevedomskyï¼Œæˆ‘æ˜¯SberTekhçš„é¦–å¸­å·¥ç¨‹å¸ˆã€‚ æˆ‘åœ¨ä¸€ä¸ªå›¢é˜Ÿä¸­å·¥ä½œï¼Œè¯¥å›¢é˜Ÿå¼€å‘ESFï¼ˆç»Ÿä¸€æ­£é¢ç³»ç»Ÿï¼‰çš„ç³»ç»ŸæœåŠ¡ä¹‹ä¸€ã€‚ åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç§¯æä½¿ç”¨Springæ¡†æ¶ï¼Œå°¤å…¶æ˜¯å®ƒçš„DIï¼Œå¹¶ä¸”ä¸æ—¶é‡åˆ°è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³è§£å†³Springä¸­çš„ä¾èµ–å…³ç³»å¯¹æˆ‘ä»¬æ¥è¯´ä¸å¤Ÿèªæ˜ã€‚ æœ¬æ–‡æ˜¯æˆ‘å°è¯•ä½¿å…¶å˜å¾—æ›´æ™ºèƒ½å¹¶å¤§ä½“ä¸Šäº†è§£å…¶å·¥ä½œåŸç†çš„ç»“æœã€‚ å¸Œæœ›æ‚¨å¯ä»¥ä»ä¸­å­¦ä¹ æœ‰å…³å¼¹ç°§è£…ç½®çš„æ–°çŸ¥è¯†ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ea/bbf/f4c/0eabbff4c25bb87806837c487f847fcc.png"><br><a name="habracut"></a><br> åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œæˆ‘å¼ºçƒˆå»ºè®®æ‚¨é˜…è¯»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Boris</a> Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">EvgenyBorisovçš„</a>æŠ¥å‘Šï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Spring Ripperï¼Œç¬¬1éƒ¨åˆ†</a> ï¼›  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼¹ç°§æ¾åœŸå™¨ï¼Œç¬¬2éƒ¨åˆ†</a> ã€‚ ä»ç„¶æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ’­æ”¾åˆ—è¡¨</a> ã€‚ <br><br><h2> å¼•è¨€ </h2><br> å‡è®¾æˆ‘ä»¬è¢«è¦æ±‚å¼€å‘ä¸€ç§ç”¨äºé¢„æµ‹å‘½è¿å’Œæ˜Ÿåº§çš„æœåŠ¡ã€‚ æˆ‘ä»¬çš„æœåŠ¡æœ‰å‡ ä¸ªç»„æˆéƒ¨åˆ†ï¼Œä½†å¯¹æˆ‘ä»¬æ¥è¯´ä¸»è¦æ˜¯ä¸¤ä¸ªï¼š <br><br><ul><li>  Globaï¼Œå°†å®ç°FortuneTellerç•Œé¢å¹¶é¢„æµ‹å‘½è¿ï¼› <br><br><img src="https://habrastorage.org/getpro/habr/post_images/301/c90/6f1/301c906f1584237b8bab4f8627484ff2.png" width="365" height="450"><br><br></li></ul><br><ul><li> å‰æ™®èµ›äººï¼Œå®ƒå°†å®ç°HoroscopeTellerç•Œé¢å¹¶åˆ›å»ºæ˜Ÿåº§ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9f/520/3ad/d9f5203ad3b823ea61d5322655d2164d.png" width="365" height="450"><br><br></li></ul><br> åŒæ ·ï¼Œåœ¨æˆ‘ä»¬çš„æœåŠ¡ä¸­ï¼Œå®é™…ä¸Šå°†æœ‰å¤šä¸ªç«¯ç‚¹ï¼ˆæ§åˆ¶å™¨ï¼‰ç”¨äºè·å¾—ç®—å‘½å’Œæ˜Ÿåº§ã€‚ è€Œä¸”ï¼Œæˆ‘ä»¬è¿˜å°†ä½¿ç”¨å°†åº”ç”¨äºæ§åˆ¶å™¨æ–¹æ³•çš„æ–¹é¢æ¥æ§åˆ¶IPå¯¹åº”ç”¨ç¨‹åºçš„è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">RestrictionAspect.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aspect</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestrictionAspect</span></span></span><span class="hljs-class"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Predicate&lt;String&gt; ipIsAllowed;    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RestrictionAspect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Predicate&lt;String&gt; ipIsAllowed)</span></span></span><span class="hljs-function"> </span></span>{        <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ipIsAllowed = ipIsAllowed;    }    <span class="hljs-meta"><span class="hljs-meta">@Before</span></span>(<span class="hljs-string"><span class="hljs-string">"execution(public * com.github.monosoul.fortuneteller.web.*.*(..))"</span></span>)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{        val ip = getRequestSourceIp();       log.debug(<span class="hljs-string"><span class="hljs-string">"Source IP: {}"</span></span>, ip);        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ipIsAllowed.test(ip)) {            <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessDeniedException(format(<span class="hljs-string"><span class="hljs-string">"Access for IP [%s] is denied"</span></span>, ip));        }    }    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequestSourceIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{        val requestAttributes = currentRequestAttributes();        Assert.state(requestAttributes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ServletRequestAttributes,                <span class="hljs-string"><span class="hljs-string">"RequestAttributes needs to be a ServletRequestAttributes"</span></span>);        val request = ((ServletRequestAttributes) requestAttributes).getRequest();        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.getRemoteAddr();    } }</code> </pre> <br></div></div><br> ä¸ºäº†éªŒè¯æ˜¯å¦å…è®¸ä»è¿™æ ·çš„IPè®¿é—®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>ipIsAllowed</code>è°“è¯çš„æŸäº›å®ç°ã€‚ é€šå¸¸ï¼Œåœ¨æ­¤æ–¹é¢çš„ç«™ç‚¹ä¸Šï¼Œå¯èƒ½ä¼šæœ‰å…¶ä»–ä¸€äº›æˆæƒã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å¼€å‘äº†è¯¥åº”ç”¨ç¨‹åºï¼Œä¸€åˆ‡å¯¹æˆ‘ä»¬æ¥è¯´éƒ½å¾ˆå¥½ã€‚ ä½†æ˜¯ï¼Œè®©æˆ‘ä»¬ç°åœ¨è°ˆè®ºæµ‹è¯•ã€‚ <br><br><h2> æ€ä¹ˆæµ‹è¯•å‘¢ï¼Ÿ </h2><br> è®©æˆ‘ä»¬è°ˆè°ˆå¦‚ä½•æµ‹è¯•æ–¹é¢çš„åº”ç”¨ã€‚ æˆ‘ä»¬æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ <br><br> æ‚¨å¯ä»¥ä¸ºæ–¹é¢å’Œæ§åˆ¶å™¨ç¼–å†™å•ç‹¬çš„æµ‹è¯•ï¼Œè€Œæ— éœ€æé«˜springä¸Šä¸‹æ–‡ï¼ˆè¿™åªä¼šä¸ºæ§åˆ¶å™¨æä¾›æ–¹é¢çš„ä»£ç†ï¼Œæ‚¨å¯ä»¥åœ¨å®˜æ–¹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ä¸­</a>é˜…è¯»æ›´å¤šæœ‰å…³æ­¤å†…å®¹çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¿¡æ¯</a> ï¼‰ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†<u>æ— æ³•å‡†ç¡®æµ‹è¯•</u>å°†<u>å“ªäº›æ–¹é¢æ­£ç¡®åº”ç”¨äºæ§åˆ¶å™¨å’Œå·¥ä½œå®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›</u> ; <br><br> æ‚¨å¯ä»¥ç¼–å†™æµ‹è¯•ä»¥æé«˜åº”ç”¨ç¨‹åºçš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š <br><br><ul><li> è¿è¡Œæµ‹è¯•å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå› ä¸º æ‰€æœ‰åƒåœ¾ç®±éƒ½å°†å‡èµ·ï¼› </li><li> æˆ‘ä»¬å°†éœ€è¦å‡†å¤‡æœ‰æ•ˆçš„æµ‹è¯•æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥é€šè¿‡å®¹å™¨ä¹‹é—´çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œè€Œä¸ä¼šåŒæ—¶æŠ›å‡ºNPEã€‚ </li></ul><br> ä½†æ˜¯ï¼Œæˆ‘ä»¬æƒ³å‡†ç¡®æµ‹è¯•æ–¹é¢å·²åº”ç”¨å¹¶æ­£åœ¨æ‰§è¡Œçš„å·¥ä½œã€‚ æˆ‘ä»¬ä¸æƒ³æµ‹è¯•ç”±æ§åˆ¶å™¨è°ƒç”¨çš„æœåŠ¡ï¼Œå› æ­¤ä¸æƒ³è¢«æµ‹è¯•æ•°æ®æ‰€å›°æ‰°å¹¶ç‰ºç‰²å¯åŠ¨æ—¶é—´ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†ç¼–å†™æµ‹è¯•ï¼Œä»…åœ¨å…¶ä¸­æå‡ºéƒ¨åˆ†ä¸Šä¸‹æ–‡ã€‚ å³ åœ¨æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå°†æœ‰ä¸€ä¸ªçœŸæ­£çš„Aspect Beanå’Œä¸€ä¸ªçœŸæ­£çš„Controller Beanï¼Œå…¶ä»–æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯mokamiã€‚ <br><br><h2> å¦‚ä½•åˆ¶ä½œæ‘©å¡è±†ï¼Ÿ </h2><br> æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åœ¨æ˜¥å­£åˆ¶ä½œæ‘©å¡è±†ã€‚ ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œä»¥ä¸€ä¸ªç¤ºä¾‹ä¸ºä¾‹ï¼Œæˆ‘ä»¬é‡‡ç”¨æœåŠ¡çš„ä¸€ä¸ªæ§åˆ¶å™¨<code>PersonalizedHoroscopeTellController</code> ï¼Œå…¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">PersonalizedHoroscopeTellController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>( value = <span class="hljs-string"><span class="hljs-string">"/horoscope"</span></span>, produces = APPLICATION_JSON_UTF8_VALUE ) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.horoscopeTeller = horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.zodiacSignConverter = zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameNormalizer = nameNormalizer; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"/tell/personal/{name}/{sign}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PersonalizedHoroscope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name, @PathVariable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String sign)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Received name: {}; sign: {}"</span></span>, name, sign); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PersonalizedHoroscope.builder() .name( nameNormalizer.apply(name) ) .horoscope( horoscopeTeller.tell( zodiacSignConverter.apply(sign) ) ) .build(); } }</code> </pre> <br></div></div><br><h3> åœ¨æ¯ä¸ªæµ‹è¯•ä¸­å…·æœ‰ä¾èµ–é¡¹çš„Java Config </h3><br> å¯¹äºæ¯ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç¼–å†™Java Configï¼Œå…¶ä¸­æè¿°æ§åˆ¶å™¨å’Œæ–¹é¢Beanä»¥åŠå…·æœ‰æ§åˆ¶å™¨ä¾èµ–é¡¹Moksçš„Beanã€‚ è¿™ç§æè¿°beançš„æ–¹æ³•åŠ¿åœ¨å¿…è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å°†æ˜ç¡®åœ°å‘Šè¯‰springæˆ‘ä»¬éœ€è¦å¦‚ä½•åˆ›å»ºbeanã€‚ <br><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé’ˆå¯¹æˆ‘ä»¬æ§åˆ¶å™¨çš„æµ‹è¯•å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">javaconfig / PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(AspectConfiguration.class) <span class="hljs-meta"><span class="hljs-meta">@EnableAspectJAutoProxy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PersonalizedHoroscopeTellController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">personalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonalizedHoroscopeTellController(horoscopeTeller, zodiacSignConverter, nameNormalizer); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HoroscopeTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(HoroscopeTeller.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Function&lt;String, ZodiacSign&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zodiacSignConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(Function.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Function&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameNormalizer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(Function.class); } } }</code> </pre> <br></div></div><br> è¿™æ ·çš„æµ‹è¯•çœ‹èµ·æ¥å¾ˆéº»çƒ¦ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å¿…é¡»ä¸ºæ¯ä¸ªæ§åˆ¶å™¨ç¼–å†™Java Configã€‚ å°½ç®¡å…¶å†…å®¹å°†æœ‰æ‰€ä¸åŒï¼Œä½†å…¶å«ä¹‰å°†ç›¸åŒï¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨beanå’Œmokiä½œä¸ºå…¶ä¾èµ–é¡¹ã€‚ å› æ­¤ï¼Œä»æœ¬è´¨ä¸Šè®²ï¼Œæ‰€æœ‰æ§åˆ¶å™¨éƒ½æ˜¯ç›¸åŒçš„ã€‚ æˆ‘å’Œä»»ä½•ç¨‹åºå‘˜ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ‡’æƒ°çš„äººï¼Œå› æ­¤æˆ‘ç«‹å³æ‹’ç»äº†æ­¤é€‰é¡¹ã€‚ <br><br><h3>  @MockBeanåœ¨æ¯ä¸ªå…·æœ‰ä¾èµ–é¡¹çš„å­—æ®µä¸Šçš„æ³¨é‡Š </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@MockBeanæ‰¹æ³¨</a>å‡ºç°åœ¨Spring Boot Testç‰ˆæœ¬1.4.0ä¸­ã€‚ å®ƒç±»ä¼¼äºMockitoä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@Mock</a> ï¼ˆäº‹å®ä¸Šâ€‹â€‹ï¼Œå®ƒç”šè‡³åœ¨å†…éƒ¨ä½¿ç”¨å®ƒï¼‰ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œå½“ä½¿ç”¨<code>@MockBean</code> ï¼Œåˆ›å»ºçš„æ¨¡æ‹Ÿå°†è‡ªåŠ¨æ”¾ç½®åœ¨springä¸Šä¸‹æ–‡ä¸­ã€‚ è¿™ç§å£°æ˜mokçš„æ–¹æ³•å°†æ˜¯å£°æ˜æ€§çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¿…ç¡®åˆ‡åœ°å‘Šè¯‰springå¦‚ä½•åˆ›å»ºè¿™äº›mokã€‚ <br><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµ‹è¯•å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æ¨¡æ‹Ÿbean / PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>({PersonalizedHoroscopeTellController.class, RestrictionAspect.class, RequestContextHolderConfigurer.class}) <span class="hljs-meta"><span class="hljs-meta">@EnableAspectJAutoProxy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>{ } }</code> </pre> <br></div></div><br> æ­¤é€‰é¡¹ä»å…·æœ‰Java Configï¼Œä½†æ›´åŠ ç´§å‡‘ã€‚ ç¼ºç‚¹ä¸­-æˆ‘å¿…é¡»å£°æ˜å…·æœ‰æ§åˆ¶å™¨ä¾èµ–æ€§çš„å­—æ®µï¼ˆå¸¦æœ‰<code>@MockBean</code>æ‰¹æ³¨çš„å­—æ®µï¼‰ï¼Œå³ä½¿åœ¨æµ‹è¯•ä¸­ä¸å†ä½¿ç”¨å®ƒä»¬ã€‚ å¥½å§ï¼Œå¦‚æœç”±äºæŸç§åŸå› æ‚¨ä½¿ç”¨çš„Spring Bootç‰ˆæœ¬ä½äº1.4.0ï¼Œé‚£ä¹ˆæ‚¨å°†æ— æ³•ä½¿ç”¨æ­¤æ³¨é‡Šã€‚ <br><br> å› æ­¤ï¼Œæˆ‘æƒ³åˆ°äº†å¦ä¸€ç§æ›¿ä»£æ–¹æ¡ˆã€‚ æˆ‘å¸Œæœ›å®ƒä»¥è¿™ç§æ–¹å¼å·¥ä½œ... <br><br><h3> é€šè¿‡@Automockedæ³¨é‡Šä¾èµ–ç»„ä»¶ </h3><br> æˆ‘å¸Œæœ›æˆ‘ä»¬æ‹¥æœ‰<code>@Automocked</code>æ‰¹æ³¨ï¼Œè¯¥æ‰¹æ³¨åªèƒ½ä¸æ§åˆ¶å™¨ä¸€èµ·æ”¾åœ¨å­—æ®µä¸Šæ–¹ï¼Œç„¶åä¼šè‡ªåŠ¨ä¸ºè¯¥æ§åˆ¶å™¨åˆ›å»ºmokiå¹¶å°†å…¶æ”¾ç½®åœ¨ä¸Šä¸‹æ–‡ä¸­ã€‚ <br><br> è¿™ç§æƒ…å†µä¸‹çš„æµ‹è¯•å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">è‡ªåŠ¨æ¨¡æ‹Ÿ/ PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(classes = AspectConfiguration.class) <span class="hljs-meta"><span class="hljs-meta">@TestExecutionListeners</span></span>(listeners = AutomockTestExecutionListener.class, mergeMode = MERGE_WITH_DEFAULTS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Automocked</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } }</code> </pre> <br></div></div><br> å¦‚æ‚¨æ‰€è§ï¼Œæ­¤é€‰é¡¹æ˜¯æ‰€æä¾›é€‰é¡¹ä¸­æœ€ç´§å‡‘çš„é€‰é¡¹ï¼Œåªæœ‰ä¸€ä¸ªæ§åˆ¶å™¨beanï¼ˆå¤–åŠ ä¸€ä¸ªæ–¹é¢çš„è°“è¯ï¼‰ï¼Œ <code>@Automocked</code>æ˜¯<code>@Automocked</code>æ³¨è§£<u>ï¼Œåˆ›å»ºbeanå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨ä¸Šä¸‹æ–‡ä¸­çš„</u>æ‰€æœ‰<u>é­”åŠ›éƒ½è¢«ç¼–å†™äº†ä¸€æ¬¡</u> ï¼Œå¯ä»¥åœ¨æ‰€æœ‰æ–¹æ³•ä¸­ä½¿ç”¨æµ‹è¯•ã€‚ <br><br><h2> å¦‚ä½•è¿ä½œï¼Ÿ </h2><br> è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ä»¥åŠæˆ‘ä»¬éœ€è¦ä»€ä¹ˆã€‚ <br><br><h3>  TestExecutionListener </h3><br> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">spring</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TestExecutionListenerä¸­</a>æœ‰è¿™æ ·çš„æ¥å£ã€‚ å®ƒæä¾›äº†ä¸€ä¸ªAPIï¼Œç”¨äºåœ¨å„ä¸ªé˜¶æ®µåµŒå…¥åˆ°æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾‹å¦‚ï¼Œåœ¨åˆ›å»ºæµ‹è¯•ç±»çš„å®ä¾‹æ—¶ï¼Œè°ƒç”¨æµ‹è¯•æ–¹æ³•ä¹‹å‰æˆ–ä¹‹åç­‰ã€‚ ä»–æœ‰å‡ ç§å¼€ç®±å³ç”¨çš„å®ç°ã€‚ ä¾‹å¦‚ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DirtiesContextTestExecutionListener</a> ï¼Œå¦‚æœæ”¾ç½®äº†é€‚å½“çš„æ³¨é‡Šï¼Œå®ƒå°†æ¸…ç†ä¸Šä¸‹æ–‡ï¼›  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DependencyInjectionTestExecutionListener-</a>åœ¨æµ‹è¯•ç­‰ä¸­æ‰§è¡Œä¾èµ–é¡¹æ³¨å…¥ã€‚ è¦å°†è‡ªå®šä¹‰ä¾¦å¬å™¨åº”ç”¨äºæµ‹è¯•ï¼Œæ‚¨éœ€è¦åœ¨å…¶ä¸Šæ–¹æ”¾ç½®<code>@TestExecutionListeners</code>æ‰¹æ³¨å¹¶æŒ‡ç¤ºæ‚¨çš„å®ç°ã€‚ <br><br><h3> å·²è®¢è´­ </h3><br> å¼¹ç°§ä¸­è¿˜æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®¢è´­</a>æ¥å£ã€‚ å®ƒç”¨äºæŒ‡ç¤ºåº”è¯¥ä»¥æŸç§æ–¹å¼å¯¹å¯¹è±¡è¿›è¡Œæ’åºã€‚ ä¾‹å¦‚ï¼Œå½“æ‚¨å…·æœ‰åŒä¸€ä¸ªæ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¹¶ä¸”æƒ³è¦å°†å®ƒä»¬æ³¨å…¥åˆ°ä¸€ä¸ªé›†åˆä¸­æ—¶ï¼Œåˆ™å°†åœ¨æ­¤é›†åˆä¸­æ ¹æ®Orderedå¯¹å…¶è¿›è¡Œæ’åºã€‚ å°±TestExecutionListenerè€Œè¨€ï¼Œæ­¤æ³¨é‡ŠæŒ‡ç¤ºåº”æŒ‰é¡ºåºåº”ç”¨å®ƒä»¬ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›‘å¬å™¨å°†å®ç°2ä¸ªæ¥å£ï¼š <b>TestExecutionListener</b>å’Œ<b>Ordered</b> ã€‚ æˆ‘ä»¬ç§°å…¶ä¸º<b>AutomockTestExecutionListener</b> ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">AutomockTestExecutionListener.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutomockTestExecutionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestExecutionListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ordered</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1900</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareTestInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TestContext testContext)</span></span></span><span class="hljs-function"> </span></span>{ val beanFactory = ((DefaultListableBeanFactory) testContext.getApplicationContext().getAutowireCapableBeanFactory()); setByNameCandidateResolver(beanFactory); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val field : testContext.getTestClass().getDeclaredFields()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field.getAnnotation(Automocked.class) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } log.debug(<span class="hljs-string"><span class="hljs-string">"Performing automocking for the field: {}"</span></span>, field.getName()); makeAccessible(field); setField( field, testContext.getTestInstance(), createBeanWithMocks(findConstructorToAutomock(field.getType()), beanFactory) ); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setByNameCandidateResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((beanFactory.getAutowireCandidateResolver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> AutomockedBeanByNameAutowireCandidateResolver)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } beanFactory.setAutowireCandidateResolver( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutomockedBeanByNameAutowireCandidateResolver(beanFactory.getAutowireCandidateResolver()) ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Constructor&lt;?&gt; findConstructorToAutomock(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; clazz) { log.debug(<span class="hljs-string"><span class="hljs-string">"Looking for suitable constructor of {}"</span></span>, clazz.getCanonicalName()); Constructor&lt;?&gt; fallBackConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val constructor : clazz.getDeclaredConstructors()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constructor.getParameterTypes().length &gt; fallBackConstructor.getParameterTypes().length) { fallBackConstructor = constructor; } val autowired = getAnnotation(constructor, Autowired.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autowired != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constructor; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallBackConstructor; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBeanWithMocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Constructor&lt;T&gt; constructor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ createMocksForParameters(constructor, beanFactory); val clazz = constructor.getDeclaringClass(); val beanName = forClass(clazz).toString(); log.debug(<span class="hljs-string"><span class="hljs-string">"Creating bean {}"</span></span>, beanName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { val bean = beanFactory.createBean(clazz); beanFactory.registerSingleton(beanName, bean); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> beanFactory.getBean(beanName, clazz); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMocksForParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Constructor&lt;T&gt; constructor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ log.debug(<span class="hljs-string"><span class="hljs-string">"{} is going to be used for auto mocking"</span></span>, constructor); val constructorArgsAmount = constructor.getParameterTypes().length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorArgsAmount; i++) { val parameterType = forConstructorParameter(constructor, i); val beanName = parameterType.toString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { beanFactory.registerSingleton( beanName, mock(parameterType.resolve(), withSettings().stubOnly()) ); } log.debug(<span class="hljs-string"><span class="hljs-string">"Mocked {}"</span></span>, beanName); } } }</code> </pre> <br></div></div><br> è¿™æ˜¯æ€ä¹ˆå›äº‹ é¦–å…ˆï¼Œåœ¨<code>prepareTestInstance()</code>æ–¹æ³•ä¸­ï¼Œå®ƒæ‰¾åˆ°å¸¦æœ‰<code>@Automocked</code>æ‰¹æ³¨çš„æ‰€æœ‰å­—æ®µï¼š <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val field : testContext.getTestClass().getDeclaredFields()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field.getAnnotation(Automocked.class) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br> ç„¶åä½¿è¿™äº›å­—æ®µå¯å†™ï¼š <br><br><pre> <code class="java hljs">makeAccessible(field);</code> </pre> <br> ç„¶åï¼Œåœ¨<code>findConstructorToAutomock()</code>æ–¹æ³•ä¸­ï¼Œæ‰¾åˆ°åˆé€‚çš„æ„é€ å‡½æ•°ï¼š <br><br><pre> <code class="java hljs">Constructor&lt;?&gt; fallBackConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val constructor : clazz.getDeclaredConstructors()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constructor.getParameterTypes().length &gt; fallBackConstructor.getParameterTypes().length) { fallBackConstructor = constructor; } val autowired = getAnnotation(constructor, Autowired.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autowired != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constructor; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallBackConstructor;</code> </pre> <br> åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œåˆé€‚çš„æ„é€ å‡½æ•°æ˜¯å¸¦æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@Autowired</a>æ‰¹æ³¨çš„æ„é€ å‡½æ•°æˆ–å¸¦æœ‰æœ€å¤šå‚æ•°çš„æ„é€ å‡½æ•°ã€‚ <br><br> ç„¶åï¼Œå°†æ‰¾åˆ°çš„æ„é€ å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>createBeanWithMocks()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆè°ƒç”¨<code>createMocksForParameters()</code>æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå°†ä¸ºæ„é€ å‡½æ•°å‚æ•°åˆ›å»º<code>createBeanWithMocks()</code>å¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œï¼š <br><br><pre> <code class="java hljs">val constructorArgsAmount = constructor.getParameterTypes().length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorArgsAmount; i++) { val parameterType = forConstructorParameter(constructor, i); val beanName = parameterType.toString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { beanFactory.registerSingleton( beanName, mock(parameterType.resolve(), withSettings().stubOnly()) ); } }</code> </pre> <br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œå‚æ•°ç±»å‹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼ˆä»¥åŠæ³›å‹ï¼‰å°†ç”¨ä½œbinçš„åç§°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºç±»å‹ä¸º<u><code>packages.Function&lt;String, String&gt;</code>å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼å°†ä¸ºå­—ç¬¦ä¸²<code>"packages.Function&lt;java.lang.String, java.lang.String&gt;"</code></u> ã€‚ è¿™å¾ˆé‡è¦ï¼Œæˆ‘ä»¬å°†å›åˆ°è¿™ä¸€ç‚¹ã€‚ <br><br> åœ¨ä¸ºæ‰€æœ‰å‚æ•°åˆ›å»ºæ¨¡æ‹Ÿå¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œå®ƒä»¬ä¹‹åï¼Œæˆ‘ä»¬è¿”å›åˆ›å»ºä¾èµ–ç±»çš„Beanï¼ˆå³æœ¬ä¾‹ä¸­çš„æ§åˆ¶å™¨ï¼‰ï¼š <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { val bean = beanFactory.createBean(clazz); beanFactory.registerSingleton(beanName, bean); }</code> </pre> <br> æ‚¨è¿˜åº”è¯¥æ³¨æ„æˆ‘ä»¬ä½¿ç”¨<u>Order 1900</u>çš„äº‹å®ã€‚ è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå¿…é¡»åœ¨æ¸…é™¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DirtiesContextBeforeModesTestExecutionListener'ohm</a>ä¸Šä¸‹æ–‡ï¼ˆorder = 1500ï¼‰ä¹‹åå¹¶åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DependencyInjectionTestExExcutionListener</a> 'ä¾èµ–é¡¹æ³¨å…¥ï¼ˆorder = 2000ï¼‰ä¹‹å‰è°ƒç”¨æˆ‘ä»¬çš„ä¾¦å¬å™¨ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¾¦å¬å™¨ä¼šåˆ›å»ºæ–°çš„binã€‚ <br><br><h2>  AutowireCandidateResolver </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AutowireCandidateResolver</a>ç”¨äºç¡®å®š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BeanDefinitionæ˜¯å¦ä¸</a>ä¾èµ–é¡¹æè¿°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŒ¹é…</a> ã€‚ ä»–å…·æœ‰â€œå¼€ç®±å³ç”¨â€çš„å‡ ç§å®ç°ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">QualifierAnnotationAutowireCandidateResolver-</a>æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Qualifier</a>ç¡®å®šä¾èµ–é¡¹æ˜¯å¦åˆé€‚ï¼› </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GenericTypeAwareAutowireCandidateResolver-</a>åŸºäºæ³›å‹ç¡®å®šä¾èµ–é¡¹æ˜¯å¦åˆé€‚ï¼› </li><li> å’Œå…¶ä»–ã€‚ </li></ul><br> åŒæ—¶ï¼Œâ€œå¼€ç®±å³ç”¨â€çš„å®ç°æ˜¯ä»ç»§æ‰¿çš„ä¿„ç½—æ–¯å¨ƒå¨ƒï¼Œå³ ä»–ä»¬å½¼æ­¤æ‰©å¤§ã€‚ æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªè£…é¥°å™¨ï¼Œå› ä¸º å®ƒæ›´åŠ çµæ´»ã€‚ <br><br> è§£æå™¨çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š <br><br><ol><li>  Springéœ€è¦ä¸€ä¸ªä¾èµ–é¡¹æè¿°ç¬¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-DependencyDescriptor</a> ; <br></li><li> ç„¶åï¼Œå®ƒé‡‡ç”¨é€‚å½“ç±»çš„æ‰€æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BeanDefinition</a> ï¼› <br></li><li> è¿­ä»£æ¥æ”¶åˆ°çš„BeanDefinitionsï¼Œè°ƒç”¨è§£æå™¨çš„<code>isAutowireCandidate()</code>æ–¹æ³•ã€‚ <br></li><li> æ ¹æ®binçš„æè¿°æ˜¯å¦ä¸ä¾èµ–é¡¹çš„æè¿°åŒ¹é…ï¼Œè¯¥æ–¹æ³•è¿”å›trueæˆ–falseã€‚ <br></li></ol><br><h2> ä¸ºä»€ä¹ˆéœ€è¦æ‚¨çš„è§£æå™¨ï¼Ÿ </h2><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸ºä»€ä¹ˆåœ¨æ§åˆ¶å™¨çš„ç¤ºä¾‹ä¸­éœ€è¦è§£æå™¨ã€‚ <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.horoscopeTeller = horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.zodiacSignConverter = zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameNormalizer = nameNormalizer; }</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œå®ƒå…·æœ‰ä¸¤ä¸ªç›¸åŒç±»å‹çš„ä¾èµ–é¡¹<b>-Function</b> ï¼Œä½†å…·æœ‰ä¸åŒçš„æ³›å‹ã€‚ åœ¨ä¸€ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨<b>String</b>å’Œ<b>ZodiacSign</b> ï¼Œåœ¨å¦ä¸€ç§æƒ…å†µä¸‹ä½¿ç”¨<b>String</b>å’Œ<b>String</b> ã€‚ è€Œä¸”é—®é¢˜åœ¨äºï¼Œ <u>Mockitoæ— æ³•è€ƒè™‘æ³›å‹æ¥åˆ›å»ºmoks</u> ã€‚ å³ å¦‚æœæˆ‘ä»¬ä¸ºè¿™äº›ä¾èµ–å…³ç³»åˆ›å»ºmokaså¹¶å°†å®ƒä»¬æ”¾åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œé‚£ä¹ˆSpringå°†æ— æ³•å°†å®ƒä»¬æ³¨å…¥åˆ°æ­¤ç±»ä¸­ï¼Œå› ä¸ºå®ƒä»¬å°†ä¸åŒ…å«æœ‰å…³æ³›å‹çš„ä¿¡æ¯ã€‚ æˆ‘ä»¬å°†çœ‹åˆ°ä¸€ä¸ªä¾‹å¤–ï¼Œå³ä¸Šä¸‹æ–‡ä¸­æœ‰å¤šä¸ª<b>Function</b>ç±»beanã€‚ æ­£æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†åœ¨è§£æå™¨çš„å¸®åŠ©ä¸‹è§£å†³ã€‚ æ¯•ç«Ÿï¼Œæ‚¨è¿˜è®°å¾—ï¼Œåœ¨ä¾¦å¬å™¨çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å…·æœ‰æ³›å‹çš„ç±»å‹ä½œä¸ºbinçš„åç§°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯æ•™å¯¼springå°†ä¾èµ–ç±»å‹ä¸binçš„åç§°è¿›è¡Œæ¯”è¾ƒã€‚ <br><br><h2>  AutomockedBeanByNameAutowireCandidateResolver </h2><br> å› æ­¤ï¼Œæˆ‘ä»¬çš„è§£æå™¨å°†å®Œå…¨æŒ‰ç…§æˆ‘åœ¨ä¸Šæ–‡ä¸­çš„æè¿°è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”<code>isAutowireCandidate()</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">AutowireCandidateResolver.isAutowireCandidateï¼ˆï¼‰</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAutowireCandidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BeanDefinitionHolder beanDefinitionHolder, DependencyDescriptor descriptor)</span></span></span><span class="hljs-function"> </span></span>{ val dependencyType = descriptor.getResolvableType().resolve(); val dependencyTypeName = descriptor.getResolvableType().toString(); val candidateBeanDefinition = (AbstractBeanDefinition) beanDefinitionHolder.getBeanDefinition(); val candidateTypeName = beanDefinitionHolder.getBeanName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateTypeName.equals(dependencyTypeName) &amp;&amp; candidateBeanDefinition.getBeanClass() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> candidateResolver.isAutowireCandidate(beanDefinitionHolder, descriptor); }</code> </pre> <br></div></div><br> åœ¨è¿™é‡Œï¼Œä»–ä»ä¾èµ–é¡¹æè¿°ä¸­è·å–ä¾èµ–é¡¹ç±»å‹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œä»BeanDefinitionï¼ˆå·²ç»åŒ…å«Beanç±»å‹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼‰ä¸­è·å–Beanåç§°ï¼Œç„¶åå¯¹å…¶è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è¿”å›trueã€‚ å¦‚æœå®ƒä»¬ä¸åŒ¹é…ï¼Œå®ƒå°†å§”æ´¾ç»™å†…éƒ¨è§£æå™¨ã€‚ <br><br><h2> æµ‹è¯•ç®±æ¶¦æ¹¿é€‰é¡¹ </h2><br> æ€»ä½“è€Œè¨€ï¼Œåœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹è¿›è¡Œç®±å¼æ¶¦æ¹¿ï¼š <br><br><ul><li>  Java Config-å¿…ä¸å¯å°‘çš„ï¼Œå¾ˆç¹ççš„ï¼Œå¸¦æœ‰æ ·æ¿ï¼Œä½†ä¹Ÿè®¸ä¿¡æ¯é‡å°½å¯èƒ½å¤§ï¼› <br></li><li>  <code>@MockBean</code>æ˜¯å£°æ˜æ€§çš„ï¼Œä¸å¦‚Java Configç¬¨é‡ï¼Œä½†æ˜¯ä»ç„¶ä¼šä»¥å­—æ®µå½¢å¼å‡ºç°ä¸€äº›å°çš„æ ·æ¿ï¼Œè¿™äº›å­—æ®µå…·æœ‰æµ‹è¯•æœ¬èº«æœªä½¿ç”¨çš„ä¾èµ–é¡¹ï¼› <br></li><li>  <code>@Automocked</code> +è‡ªå®šä¹‰è§£æå™¨-æµ‹è¯•å’Œæ ·æ¿ä¸­çš„æœ€å°‘ä»£ç ï¼Œä½†èŒƒå›´å¯èƒ½å¾ˆçª„ï¼Œä»ç„¶éœ€è¦ç¼–å†™ã€‚ ä½†æ˜¯ï¼Œå¦‚æœè¦ç¡®ä¿å¼¹ç°§æ­£ç¡®åœ°åˆ›å»ºä»£ç†ï¼Œå¯èƒ½ä¼šéå¸¸æ–¹ä¾¿ã€‚ <br></li></ul><br><h2> æ·»åŠ è£…é¥°å™¨ </h2><br> æˆ‘ä»¬çš„å›¢é˜Ÿ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å–œæ¬¢Decorator</a>è®¾è®¡æ¨¡æ¿çš„çµæ´»æ€§ã€‚ å®é™…ä¸Šï¼Œå„ä¸ªæ–¹é¢éƒ½å®ç°äº†è¿™ç§ç‰¹å®šæ¨¡å¼ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æ‰¹æ³¨é…ç½®springä¸Šä¸‹æ–‡å¹¶ä½¿ç”¨ç¨‹åºåŒ…æ‰«æï¼Œåˆ™ä¼šé‡åˆ°é—®é¢˜ã€‚ å¦‚æœæ‚¨åœ¨ä¸Šä¸‹æ–‡ä¸­å…·æœ‰åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œåˆ™åœ¨åº”ç”¨ç¨‹åº<b>å¯åŠ¨æ—¶</b> ï¼Œå°†å‘ç”Ÿ<b>NoUniqueBeanDefinitionExceptionå¼‚å¸¸</b> ï¼Œå³ æ˜¥å¤©å°†æ— æ³•å¼„æ¸…æ¥šåº”è¯¥æ³¨å…¥å“ªç§è±†ã€‚ è¿™ä¸ªé—®é¢˜æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼Œç„¶åæˆ‘ä»¬å°†ç ”ç©¶å®ƒä»¬ï¼Œä½†æ˜¯é¦–å…ˆè®©æˆ‘ä»¬å¼„æ¸…æ¥šæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†å¦‚ä½•å˜åŒ–ã€‚ <br><br> ç°åœ¨ï¼Œ <b>FortuneTeller</b>å’Œ<b>HoroscopeTeller</b>æ¥å£å…·æœ‰ä¸€ä¸ªå®ç°ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªæ¥å£æ·»åŠ 2ä¸ªå®ç°ï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1b/efb/01b/f1befb01b6356587cfe2c1728c7f2b0f.png"><br><br><ul><li> ç¼“å­˜...-ç¼“å­˜è£…é¥°å™¨ï¼› <br></li><li>  Logging ...æ˜¯æ—¥å¿—è£…é¥°å™¨ã€‚ <br></li></ul><br> é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³ç¡®å®šè±†ç±»é¡ºåºçš„é—®é¢˜å‘¢ï¼Ÿ <br><br><h2> å¸¦æœ‰é¡¶çº§è£…é¥°å™¨çš„Java Config </h2><br> æ‚¨å¯ä»¥å†æ¬¡ä½¿ç”¨Java Configã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æŠŠbeanæè¿°ä¸ºconfigç±»çš„æ–¹æ³•ï¼Œå¹¶ä¸”å¿…é¡»æŒ‡å®šè°ƒç”¨beançš„æ„é€ å‡½æ•°æ‰€éœ€çš„å‚æ•°ä½œä¸ºè¯¥æ–¹æ³•çš„å‚æ•°ã€‚ ç”±æ­¤å¯ä»¥å¾—å‡ºï¼Œå¦‚æœbinçš„æ„é€ å‡½æ•°å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ›´æ”¹é…ç½®ï¼Œè¿™ä¸æ˜¯å¾ˆé…·ã€‚ æ­¤é€‰é¡¹çš„ä¼˜ç‚¹ï¼š <br><br><ul><li> è£…é¥°å™¨ä¹‹é—´çš„è¿æ¥æ€§å°†è¾ƒä½ï¼Œå› ä¸º å®ƒä»¬ä¹‹é—´çš„è¿æ¥å°†åœ¨é…ç½®ä¸­è¿›è¡Œæè¿°ï¼Œå³ ä»–ä»¬å¯¹å½¼æ­¤ä¸€æ— æ‰€çŸ¥ï¼› <br></li><li> è£…é¥°å™¨é¡ºåºçš„æ‰€æœ‰æ›´æ”¹éƒ½å°†é›†ä¸­åœ¨ä¸€ä¸ªä½ç½®-é…ç½®ã€‚ <br></li></ul><br> åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒJava Configå°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">DomainConfig.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FortuneTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Map&lt;FortuneRequest, FortuneResponse&gt; cache, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FortuneResponseRepository fortuneResponseRepository, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;FortuneRequest, PersonalData&gt; personalDataExtractor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PersonalDataRepository personalDataRepository )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingFortuneTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingFortuneTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Globa(fortuneResponseRepository, personalDataExtractor, personalDataRepository), cache ) ); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HoroscopeTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Map&lt;ZodiacSign, Horoscope&gt; cache, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeRepository horoscopeRepository )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingHoroscopeTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingHoroscopeTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gypsy(horoscopeRepository), cache ) ); } }</code> </pre> <br></div></div><br> å¦‚æ‚¨æ‰€è§ï¼Œå¯¹äºæ¯ä¸ªæ¥å£ï¼Œè¿™é‡Œä»…å£°æ˜ä¸€ä¸ªbeanï¼Œå¹¶ä¸”æ–¹æ³•åœ¨å‚æ•°ä¸­åŒ…å«å†…éƒ¨åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡çš„ä¾èµ–å…³ç³»ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ›å»ºbeançš„é€»è¾‘éå¸¸æ˜æ˜¾ã€‚ <br><br><h2> é¢„é€‰èµ› </h2><br> æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@Qualifier</a>æ‰¹æ³¨ã€‚ è¿™å°†æ¯”Java Configæ›´å…·å£°æ˜æ€§ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦æ˜¾å¼æŒ‡å®šå½“å‰Beanæ‰€ä¾èµ–çš„Beançš„åç§°ã€‚ ç¼ºç‚¹æ„å‘³ç€ï¼šå¢åŠ åƒåœ¾ç®±ä¹‹é—´çš„è¿æ¥æ€§ã€‚ å¹¶ä¸”ç”±äºè¿æ¥æ€§å¢åŠ ï¼Œå³ä½¿åœ¨è£…é¥°å™¨é¡ºåºå‘ç”Ÿæ›´æ”¹çš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹ä¹Ÿä¼šåœ¨ä»£ç ä¸Šå¹³å‡æ¶‚æŠ¹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¾‹å¦‚ï¼Œå¦‚æœåœ¨é“¾çš„ä¸­é—´æ·»åŠ äº†æ–°çš„è£…é¥°å™¨ï¼Œåˆ™æ›´æ”¹å°†å½±å“è‡³å°‘2ä¸ªç±»ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">LoggingFortuneTeller.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Primary</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFortuneTeller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FortuneTeller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FortuneTeller internal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoggingFortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Qualifier(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cachingFortuneTeller"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @NonNull </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> FortuneTeller internal ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internal = internal; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = getLogger(internal.getClass()); }</code> </pre> <br></div></div><br>        , ,       (      ,  <b>FortuneTeller</b> ,   ),      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@Primary</a> .     <b>internal</b>   <code>@Qualifier</code>    ,     â€” <b>cachingFortuneTeller</b> .         . <br><br><h2> Custom qualifier </h2><br>    2.5       Qualifier',    .     . <br><br>     enum   : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> DecoratorType { LOGGING, CACHING, NOT_DECORATOR }</code> </pre> <br>    ,    qualifier': <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Decorator { <span class="hljs-function"><span class="hljs-function">DecoratorType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> NOT_DECORATOR</span></span>; }</code> </pre> <br>  :    ,       <code>@Qualifier</code> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CustomAutowireConfigurer</a> ,        . <br><br>         Qualifier'   : <br><br><div class="spoiler"> <b class="spoiler_title">CachingFortuneTeller.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Decorator</span></span>(CACHING) <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachingFortuneTeller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FortuneTeller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FortuneTeller internal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;FortuneRequest, FortuneResponse&gt; cache; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CachingFortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Decorator(NOT_DECORATOR)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> FortuneTeller internal, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> Map&lt;FortuneRequest, FortuneResponse&gt; cache ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internal = internal; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cache = cache; }</code> </pre> <br></div></div><br>   â€“    ,      <code>@Decorator</code>   ,   ,     â€“      ,      <u> </u> ,     <b>FortuneTeller</b> ',    â€“ <b>Globa</b> . <br><br>       Qualifier' - , - . ,          ,     . ,      -    â€“      ,     ,      . <br><br><h2> DecoratorAutowireCandidateResolver </h2><br>   â€“   !      ! :)   ,     -     ,   Java Config',        . ,   -    ,     .     : <br><br><div class="spoiler"> <b class="spoiler_title">DomainConfig.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OrderConfig&lt;FortuneTeller&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fortuneTellerOrderConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; asList( LoggingFortuneTeller.class, CachingFortuneTeller.class, Globa.class ); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OrderConfig&lt;HoroscopeTeller&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTellerOrderConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; asList( LoggingHoroscopeTeller.class, CachingHoroscopeTeller.class, Gypsy.class ); } }</code> </pre> <br></div></div><br>     â€“    Java Config'       ,       â€“ . ,     ! <br><br>     -   .   , ,    ,      .    : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FunctionalInterface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderConfig</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ List&lt;Class&lt;? extends T&gt;&gt; getClasses(); }</code> </pre> <br><h3> BeanDefinitionRegistryPostProcessor </h3><br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BeanDefinitionRegistryPostProcessor</a> ,   BeanFactoryPostProcessor,   , ,  ,      BeanDefinition'.  ,      BeanFactoryPostProcessor,    . <br><br>    : <br><br><ul><li>   BeanDefinition'; <br></li><li>  BeanDefinition' ,   <b>OrderConfig</b> '.  , ..              BeanDefinition'   ; <br></li><li>   ,   <b>OrderConfig</b> ',  BeanDefinition',    ,     () . <br></li></ul><br><h3> BeanFactoryPostProcessor </h3><br>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BeanFactoryPostProcessor</a> ,      BeanDefinition'  ,    . ,      Â« Spring-Â». <br><br><img src="https://habrastorage.org/getpro/habr/post_images/459/cac/4c5/459cac4c50791a09e9195d53fe51b9e0.png"><br><br> ,      , â€“       AutowireCandidateResolver': <br><br><div class="spoiler"> <b class="spoiler_title">DecoratorAutowireCandidateResolverConfigurer.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorAutowireCandidateResolverConfigurer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeanFactoryPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessBeanFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ConfigurableListableBeanFactory configurableListableBeanFactory)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ Assert.state(configurableListableBeanFactory <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> DefaultListableBeanFactory, <span class="hljs-string"><span class="hljs-string">"BeanFactory needs to be a DefaultListableBeanFactory"</span></span>); val beanFactory = (DefaultListableBeanFactory) configurableListableBeanFactory; beanFactory.setAutowireCandidateResolver( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecoratorAutowireCandidateResolver(beanFactory.getAutowireCandidateResolver()) ); } }</code> </pre> <br></div></div><br><br><h3> DecoratorAutowireCandidateResolver </h3><br>       : <br><div class="spoiler"> <b class="spoiler_title">DecoratorAutowireCandidateResolver.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorAutowireCandidateResolver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutowireCandidateResolver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AutowireCandidateResolver resolver; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAutowireCandidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> BeanDefinitionHolder bdHolder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DependencyDescriptor descriptor)</span></span></span><span class="hljs-function"> </span></span>{ val dependentType = descriptor.getMember().getDeclaringClass(); val dependencyType = descriptor.getDependencyType(); val candidateBeanDefinition = (AbstractBeanDefinition) bdHolder.getBeanDefinition(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dependencyType.isAssignableFrom(dependentType)) { val candidateQualifier = candidateBeanDefinition.getQualifier(OrderQualifier.class.getTypeName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateQualifier != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependentType.getTypeName().equals(candidateQualifier.getAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolver.isAutowireCandidate(bdHolder, descriptor); }</code> </pre> <br></div></div><br>    descriptor'   (dependencyType)     (dependentType): <br><br><pre> <code class="java hljs">val dependentType = descriptor.getMember().getDeclaringClass(); val dependencyType = descriptor.getDependencyType();</code> </pre> <br>    bdHolder' BeanDefinition: <br><br><pre> <code class="java hljs">val candidateBeanDefinition = (AbstractBeanDefinition) bdHolder.getBeanDefinition();</code> </pre> <br>       .    ,     : <br><br><pre> <code class="java hljs">dependencyType.isAssignableFrom(dependentType)</code> </pre> <br>    ,      , ..      . <br><br>   BeanDefinition'       : <br><br><pre> <code class="java hljs">val candidateQualifier = candidateBeanDefinition.getQualifier(OrderQualifier.class.getTypeName());</code> </pre> <br>    ,         : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateQualifier != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependentType.getTypeName().equals(candidateQualifier.getAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>)); }</code> </pre> <br>    â€“     (),   â€“  false. <br><br><h3>    </h3><br><ul><li> ,           <a href="">ConfigurationClassBeanDefinitionReader</a> '; <br></li><li>              ,   BeanDefintion'    Qualifier'.                 ,      . <br></li></ul><br><h2>     </h2><br> ,          : <br><br><ul><li> Java Config â€“   ,  ,      ,        ; <br></li><li> <code>@Qualifier</code> â€“  ,      -       ; <br></li><li> Custom qualifier â€“   ,     Qualifier',   ; <br></li><li>     - â€“ ,  ,     ,     . <br></li></ul><br><h2> ç»“è®º </h2><br>  ,          ,     .           â€“ :   .    ,               , ,  .    â€“   ,            JRE.     ,      ,   . <br><br>   ,      â€“  ,   ,        - . æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼ <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€æœ‰èµ„æºå‡å¯åœ¨ä»¥ä¸‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç½‘å€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å¾—ï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;">ï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">//github.com/monosoul/spring-di-customization</font></a><font style="vertical-align: inherit;">ã€‚</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435364/">https://habr.com/ru/post/zh-CN435364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435352/index.html">DEFCON Conference 18.ä½¿ç”¨æ‰‹æœºè¿›è¡Œçš„é—´è°æ´»åŠ¨ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN435354/index.html">DEFCON Conference 18.ä½¿ç”¨æ‰‹æœºè¿›è¡Œçš„é—´è°æ´»åŠ¨ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN435358/index.html">ä¸Šå¤ï¼šiPodæ—¶ä»£çš„å¾®å‹ç£ç›˜</a></li>
<li><a href="../zh-CN435360/index.html">ç‰‡æ®µvsä¸‰å¶è‰-å‡»è´¥æœ€å—æ¬¢è¿çš„å®æ—¶æµ‹éªŒ</a></li>
<li><a href="../zh-CN435362/index.html">é€Ÿåº¦å“ˆå¸Œ</a></li>
<li><a href="../zh-CN435368/index.html">å·¥ä½œåœºæ‰€çš„ç—…ç†è§£å‰–</a></li>
<li><a href="../zh-CN435372/index.html">å…³äºMikroTikçš„FastPathå’ŒFastTrackçš„å‡ å¥è¯</a></li>
<li><a href="../zh-CN435374/index.html">Gamedevä¸­çš„æ•°å­¦å¾ˆç®€å•ã€‚ Unityä¸­çš„Triangulationå’ŒTriangle.Net</a></li>
<li><a href="../zh-CN435376/index.html">2019å¹´å¤ªç©ºï¼šè½½äººé£èˆ¹ï¼Œæ–°ç«ç®­å’Œæœˆçƒæ¢æµ‹å™¨</a></li>
<li><a href="../zh-CN435380/index.html">GitHubä¸Šçš„å…è´¹å¸æˆ·å°†èƒ½å¤Ÿ[å‡ ä¹]ä¸å—é™åˆ¶åœ°ä¸ç§æœ‰å­˜å‚¨åº“ä¸€èµ·ä½¿ç”¨</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>