<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∂ üñäÔ∏è üòÜ Propre courrier temporaire: t√©l√©gramme bot üõÉ üíÇ ü§©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Souvent avec de nouveaux outils et capacit√©s, il y a un d√©sir d'exp√©rimenter et d'impl√©menter quelque chose de pas tout √† fait ordinaire, ce que je n'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Propre courrier temporaire: t√©l√©gramme bot</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445988/"> Souvent avec de nouveaux outils et capacit√©s, il y a un d√©sir d'exp√©rimenter et d'impl√©menter quelque chose de pas tout √† fait ordinaire, ce que je n'ai jamais fait auparavant.  L'id√©e de cr√©er mon service de courrier temporaire sous forme de t√©l√©gramme bot m'a paru assez int√©ressante. <a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Un peu de fond</b> <div class="spoiler_text">  Il n'y a pas si longtemps, je suis pass√© d'un h√©bergement r√©gulier √† VPS et il s'est av√©r√© qu'apr√®s un mois ou un peu plus, j'ai d√ª √† nouveau passer √† un autre VPS.  Dans les deux cas, j'avais le plan tarifaire le moins cher et Ubuntu 16.04.  Depuis la derni√®re fois √† cette √©poque, je suis tomb√© sur un terminal √† l'universit√©, ce qui √©quivalait √† un manque total d'exp√©rience, j'ai utilis√© les excellentes instructions √©tape par √©tape de DigitalOcean pour configurer mon VPS (certaines d'entre elles ont √©t√© traduites en russe pour ceux qui, comme moi, ne suffisent pas conna√Æt l'anglais).  Et oui, mon premier VPS √©tait sur DO, et j'ai d√ª d√©m√©nager √† nouveau principalement parce qu'une partie de ses adresses IP tombait sous la distribution d'ILV.  Apr√®s avoir r√©p√©t√© la proc√©dure de configuration de LAMP √† quelques reprises, je me suis un peu habitu√© au terminal VPS et, dans le cadre de son d√©veloppement, j'ai d√©cid√© de passer √† des exp√©riences inhabituelles - pour cr√©er mon propre service de courrier temporaire, par exemple. <br></div></div><br>  J'avais d√©j√† de l'exp√©rience dans le backend, en particulier dans la cr√©ation de bots de t√©l√©grammes en PHP MySQL, mais recevoir des e-mails ¬´moi-m√™me¬ª - cela semblait loin et incompr√©hensible.  Apr√®s avoir ouvert plusieurs onglets avec divers articles sur le sujet, j'ai r√©alis√© que je ne comprenais rien.  Partout, il a √©t√© propos√© d'utiliser une tonne d'outils diff√©rents, ce qui, √† mon avis, √©tait plus adapt√© √† un service de messagerie √©lectronique √† part enti√®re qu'√† la t√¢che de r√©ception de messages √©lectroniques entrants sur VPS. <br><br><h3>  Recevoir la bo√Æte de r√©ception </h3><br>  Pour la premi√®re √©tape, un article du bac √† sable m'a beaucoup aid√©: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/en/post/260429</a> .  J'ai attir√© l'attention sur sa note n√©gative, mais elle d√©crit exactement ce qui m'a int√©ress√©.  Je voulais obtenir un r√©sultat que je pourrais "ressentir" d√®s que possible, et avec les pens√©es "√† l'avenir, je le ferai bien", je suis all√© configurer sendmail. <br><br>  Ensuite, j'ai configur√© le domaine.  Enregistrements DNS: <br><br> <code>example.com IN MX 5 mail.example.com</code> <br>  <code>mail.example.com IN A XXX.XX.XXX.XXX</code> (adresse IP VPS) <br><br>  Sur le serveur, a ajout√© la ligne <code>@example.com vasya</code> <code>/etc/mail/virtusertable</code> , d√©terminant ainsi que tout le courrier destin√© √† toutes les adresses sur ****@example.com est adress√© √† Vasya. <br><br>  Pour traiter le courrier entrant avec un script php, a ajout√© la ligne <code>vasya: "|php -q /home/vasya/mail.php"</code> au fichier <code>/etc/aliases</code> <code>vasya: "|php -q /home/vasya/mail.php"</code> . <br><br>  Apr√®s avoir effectu√© plusieurs tests et m'√™tre assur√© que le courrier entrant est transmis au script php, j'ai pu m'occuper de son traitement. <br><br>  La r√©ception du courrier entrant brut envoy√© √† php de la mani√®re d√©crite ci-dessus est impl√©ment√©e dans le code de mani√®re extr√™mement simple: <br><br><pre> <code class="php hljs">$msg = file_get_contents(<span class="hljs-string"><span class="hljs-string">"php://stdin"</span></span>);</code> </pre> <br>  Une question compl√®tement diff√©rente est l'analyse du format du courrier et la pr√©sentation des donn√©es d'une mani√®re compr√©hensible et accessible.  Google m'a propos√© plusieurs options sur la fa√ßon d'analyser le format de courrier √† l'aide de PHP.  Toutes les biblioth√®ques que j'ai trouv√©es ont tra√Æn√© sur l'installation de composants suppl√©mentaires, mais l'une d'entre elles m'a sembl√© moins lourde: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/zbateson/mail-mime-parser</a> .  La seule chose que j'avais besoin d'installer en plus √©tait le gestionnaire de paquets populaire pour PHP - Composer.  Bien s√ªr, je ne l'ai pas rencontr√© sur l'h√©bergement habituel, mais l'installer et connecter davantage la biblioth√®que pour analyser le courrier n'√©tait pas du tout difficile. <br><br>  Le d√©but d'un script php pour le traitement du courrier entrant √† l'aide de la biblioth√®que zbateson / mail-mime-parser ressemble √† ceci: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">"vendor/autoload.php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZBateson</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZBateson</span></span>\<span class="hljs-title"><span class="hljs-title">MailMimeParser</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>; $msg = file_get_contents(<span class="hljs-string"><span class="hljs-string">"php://stdin"</span></span>); $parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailMimeParser(); $message = Message::from($msg);</code> </pre><br>  Le courrier temporaire n'impliquant pas √† mon avis plusieurs destinataires, il suffit de n'en prendre que le premier possible: <br><br><pre> <code class="php hljs">$to = $message-&gt;getHeader(<span class="hljs-string"><span class="hljs-string">'To'</span></span>); $email = $to-&gt;getAddresses()[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;getEmail();</code> </pre><br>  Dans la variable $ email, nous avons l'adresse du destinataire du formulaire vasyaorpetya@example.com. <br><br>  Pour recevoir le contenu des lettres entrantes dans la biblioth√®que, il existe des m√©thodes appropri√©es: <br><br><pre> <code class="php hljs">$from = $message-&gt;getHeader(<span class="hljs-string"><span class="hljs-string">'From'</span></span>)-&gt;getEmail(); $subject = $message-&gt;getHeaderValue(<span class="hljs-string"><span class="hljs-string">'Subject'</span></span>); $msg_text = $message-&gt;getTextContent(); $msg_html = $message-&gt;getHtmlContent();</code> </pre> <br><h3>  T√©l√©gramme bot </h3><br>  Qu'est-ce qu'un bot de messagerie temporaire de t√©l√©gramme devrait √™tre capable de faire en premier? <br><br><ol><li>  √âmettre une nouvelle adresse e-mail temporaire sur demande </li><li>  Envoyer des messages de bo√Æte de r√©ception pour cet e-mail pendant que l'adresse e-mail est valide </li><li>  Renouveler l'adresse e-mail </li></ol><br>  Un moyen tout √† fait appropri√© dans ce cas et dans bien d'autres cas pour recevoir des mises √† jour de Telegram est d'utiliser Webhook.  Seule l'adresse de script avec https est n√©cessaire.  L'utilisation de Certbot pour configurer le certificat de domaine SSL est d√©crite en d√©tail dans les instructions DO. <br><br>  Pour interagir avec l'API Telegram Bot, j'utilise mes propres meilleures pratiques.  Quelqu'un pr√©f√®re utiliser les biblioth√®ques populaires.  L'envoi de messages avec des boutons aux t√©l√©grammes est depuis longtemps devenu une chose famili√®re, car de nombreux articles ont √©t√© √©crits √† ce sujet. <br><br>  La g√©n√©ration d'adresses √©lectroniques temporaires est essentiellement la sortie de la prochaine adresse dans l'ordre.  J'ai cr√©√© une table pour les adresses e-mail dans la base de donn√©es, o√π un identifiant de type int avec incr√©mentation automatique identifie de mani√®re unique le destinataire.  La conversion d'un identifiant num√©rique en une adresse de cha√Æne est effectu√©e comme un nombre est traduit dans un autre syst√®me num√©rique, o√π l'alphabet latin entier est disponible sous forme de "nombres".  26 lettres par rapport aux chiffres permettent une bonne r√©duction de la longueur de l'identifiant.  Probablement, je pourrais √©galement utiliser des majuscules, des chiffres et certains caract√®res sans probl√®me pour r√©duire davantage la longueur des adresses √©mises, mais je n'ai laiss√© que de petites lettres latines. <br><br>  Fonctions de traduction d'un identifiant num√©rique en cha√Æne et vice versa: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// $alphabet = explode(",", "a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z"); //   @grayfolk: $alphabet = range('a', 'z'); function num2str($n, $a) { // $a -  $b = count($a); $r = 0; $x = ""; while ($n) { $r = $n%$b; $n = ($n-$r)/$b; $x .= $a[$r]; } return strrev($x); } function str2num($s, $a) { $n = 0; $b = count($a); $s = strrev($s); for ($i = 0; $i &lt; strlen($s); $i++) { $n += array_search($s[$i], $a) * pow($b, $i); } return $n; }</span></span></code> </pre><br>  L'un des principaux avantages de l'utilisation du service de courrier temporaire est l'absence de spam.  Mais si les adresses sont en ordre, vous pouvez faire une liste des adresses les plus proches qui seront √©mises et r√©ussir l'envoi.  Pour r√©soudre ce probl√®me, j'ai ajout√© une cha√Æne al√©atoire √† l'ID du destinataire.  Pour faire la distinction entre id et le composant al√©atoire dans l'adresse, j'ai d√©cid√© de toujours d√©marrer le composant al√©atoire avec un chiffre. <br><br>  Nous √©crivons une ligne al√©atoire de l'adresse e-mail √©mise dans la base de donn√©es avec l'ID du destinataire, l'ID utilisateur dans le t√©l√©gramme et l'heure d'√©mission de la bo√Æte aux lettres. <br><br>  Il semblerait que vous n‚Äôayez m√™me pas √† stocker le courrier entrant - ils l‚Äôont envoy√© par t√©l√©gramme et c‚Äôest tout.  Mais qu'en est-il des lettres html?  Ils ne peuvent pas √™tre affich√©s dans un message de discussion.  Il reste √† enregistrer les messages html entrants dans la base de donn√©es et √† les afficher sur le site, et √† envoyer √† l'utilisateur un lien qui inclut l'identifiant du message et le prochain mot de passe g√©n√©r√©.  Pour nettoyer la base de donn√©es avec la couronne dans les d√©lais, un script php est lanc√© qui supprime les messages html entrants re√ßus il y a plus d'une heure. <br><br>  Plus tard, dans les t√©l√©grammes du bot, j'ai ajout√© des boutons qui prolongent la validit√© de la bo√Æte aux lettres de 10 ou 60 minutes, ainsi qu'un bouton qui vous permet de savoir combien, apr√®s tout, il doit vivre avant d'arr√™ter la r√©ception des messages entrants. <br><br>  √âtant donn√© que nous traitons des utilisateurs enregistr√©s dans un t√©l√©gramme, vous pouvez fournir la possibilit√© d'activer vos anciennes bo√Ætes aux lettres, par exemple, pour restaurer un mot de passe oubli√© sur un site Web ou pour toute autre op√©ration n√©cessitant une confirmation par e-mail.  La bo√Æte aux lettres √©mise ¬´n'accepte¬ª les messages entrants que lorsque l'utilisateur en a besoin, le reste du temps, le spam potentiel est ignor√©. <br><br><img src="https://habrastorage.org/webt/wg/lo/bj/wglobjdwkrbucatdge9zirxftxg.png"><br><br>  Liste de souhaits pour l'avenir: <br><br><ul><li>  Cr√©er une version Web [termin√©] </li><li>  Configurer un changement rapide du domaine de messagerie en quelques clics / commandes (comment?) </li></ul><br><h3>  Les r√©f√©rences </h3><br>  Bot t√©l√©gramme: @tmpmailbot <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un article d√©crivant la configuration de sendmail</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Biblioth√®que PHP pour l'analyse des e-mails</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445988/">https://habr.com/ru/post/fr445988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445974/index.html">Comment promouvoir un d√©butant et ne rien casser</a></li>
<li><a href="../fr445978/index.html">Traverser un h√©risson avec un h√©risson: OpenJDK-11 + GraalVM</a></li>
<li><a href="../fr445980/index.html">Nous programmons le contr√¥le vocal d'un h√©licopt√®re en utilisant Node.js et ARDrone</a></li>
<li><a href="../fr445984/index.html">Pacsafe Pickpocket Orage</a></li>
<li><a href="../fr445986/index.html">Le d√©veloppement client comme philosophie de vie</a></li>
<li><a href="../fr445992/index.html">Nauchpop au minimum: illusions d'optique</a></li>
<li><a href="../fr445998/index.html">Comment se faire des amis Progress OpenEdge et Oracle DBMS</a></li>
<li><a href="../fr446000/index.html">Quel est le probl√®me avec Yandex.Music? Analyse UX / UI</a></li>
<li><a href="../fr446006/index.html">Intel - un son nouveau</a></li>
<li><a href="../fr446008/index.html">Outil open source pour la validation de la qualit√© de la recherche bas√©e sur l'intention</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>