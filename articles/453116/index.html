<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüè≠ üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ üâë PHP sin servidor en AWS Lambda ü§òüèº ‚ú≥Ô∏è üë®üèº‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos El lunes, la primera lecci√≥n se llevar√° a cabo en el nuevo grupo del curso Backend PHP Developer . En este sentido, continuamos publicand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP sin servidor en AWS Lambda</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/453116/">  Hola a todos  El lunes, la primera lecci√≥n se llevar√° a cabo en el nuevo grupo del curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Backend PHP Developer</a> .  En este sentido, continuamos publicando material √∫til sobre el tema.  Empecemos <br><br><img src="https://habrastorage.org/webt/_d/a5/ms/_da5ms7x5zhr34schrl4ghoxf0e.png"><br><br>  Al igual que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Simon Wordley</a> , creo que la inform√°tica sin servidor es un √°rea extremadamente interesante, principalmente debido al sistema de pago granular (pague solo cuando se ejecuta su c√≥digo), y no necesita preocuparse por el servicio y la preparaci√≥n de servidores y contenedores.  Tanto es as√≠ que trabajo con el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP Runtime</a> abierto para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apache OpenWhisk</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cuya</a> versi√≥n comercial est√° disponible como una de las caracter√≠sticas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">IBM Cloud</a> . <a name="habracut"></a><br><br>  Hay otros proveedores sin servidor, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AWS Lambda</a> es el l√≠der del mercado, pero hasta hace poco, el soporte de PHP era extremadamente engorroso y sin pretensiones.  Esto cambi√≥ a finales de 2018 con la nueva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API de</a> Lambda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">runtime</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compatibilidad con capas</a> . <br><br>  Echemos un vistazo a los aspectos pr√°cticos de PHP sin servidor en Lambda con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serverless Framework</a> . <br><br><h2>  TL; DR </h2><br>  El c√≥digo fuente de un simple Hello World est√° en mi repositorio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lambda-php</a> en Github.  Vaya a la secci√≥n de <i>Notas</i> y podemos continuar. <br><br><h2>  Tiempo de ejecuci√≥n de php </h2><br>  La API de tiempo de ejecuci√≥n le permite utilizar cualquier tiempo de ejecuci√≥n con Lambda.  En cierto modo, esto es similar a OpenWhisk, ya que existe una API HTTP entre la plataforma sin servidor y el tiempo de ejecuci√≥n.  Hay una gran diferencia que con Lambda, el tiempo de ejecuci√≥n env√≠a una solicitud a la plataforma para recibir los datos de la llamada, mientras que OpenWhisk llama al punto final que debe proporcionar el tiempo de ejecuci√≥n.  Para obtener m√°s informaci√≥n, consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">blog AWS de</a> Michael Moussa que me inspir√≥ a hacer el trabajo. <br><br>  Para comenzar, necesitamos el tiempo de ejecuci√≥n de PHP para Lambda.  Consistir√° en un ejecutable PHP, un c√≥digo PHP para llamar a una funci√≥n sin servidor y un archivo de <code>bootstrap</code> , seg√∫n lo requiera la plataforma.  De estas tres cosas recogemos una capa.  Las capas se pueden reutilizar en diferentes cuentas, por lo que me sorprende que AWS no nos proporcione una cuenta PHP.  Incre√≠ble, pero cierto, no usan PHP 7.3, por lo que tendremos que construir el nuestro. <br>  Todos los archivos que ponemos en el directorio <code>layer/php</code> de nuestro proyecto. <br><br><h2>  Construyendo un ejecutable PHP </h2><br>  Necesitamos un ejecutable PHP que se ejecute dentro de los contenedores Lambda.  La forma m√°s f√°cil de hacerlo es compilarlo en la misma plataforma que Lambda, por lo que utilizaremos EC2.  El art√≠culo de Michael explica c√≥mo hacer esto, y envolv√≠ estos comandos en el script <a href="">compile_php.sh</a> , luego para copiarlo en una instancia de EC2, ejecutar y copiar el archivo ejecutable en mi computadora: <br><br><pre> <code class="php hljs">$ export AWS_IP=ec2-user@{ipaddress} $ export SSH_KEY_FILE=~/.ssh/aws-key.rsa $ scp -i $SSH_KEY_FILE compile_php.sh $AWS_IP:doc/compile_php.sh $ ssh -i $SSH_KEY_FILE -t $AWS_IP <span class="hljs-string"><span class="hljs-string">"chmod a+x compile_php.sh &amp;&amp; ./compile_php.sh 7.3.0"</span></span> $ scp -i $SSH_KEY_FILE $AWS_IP:php<span class="hljs-number"><span class="hljs-number">-7</span></span>-bin/bin/php layer/php/php</code> </pre> <br><br>  Este enfoque lo har√° bien reproducible y, con suerte, solo se actualizar√° a nuevas versiones de PHP. <br><br><h2>  Bootstrapping </h2><br>  Como usamos la API de tiempo de ejecuci√≥n, necesitamos un archivo de <code>bootstrap</code> .  Lambda requiere un nombre para especificar el archivo; responde a una llamada de funci√≥n que coincide con las im√°genes llamando a la API en un bucle. <br><br>  En esencia, debemos estar en un bucle y llamar al punto final <code>/next</code> para comprender qu√© llamar a continuaci√≥n, llamarlo y luego enviar la respuesta al punto final <code>/response</code> . <br>  AWS proporciona un ejemplo en BASH <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usando curl</a> : <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> HEADERS=<span class="hljs-string"><span class="hljs-string">"$(mktemp)"</span></span> <span class="hljs-comment"><span class="hljs-comment"># Get an event EVENT_DATA=$(curl -sS -LD "$HEADERS" -X GET "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/next") REQUEST_ID=$(grep -Fi Lambda-Runtime-Aws-Request-Id "$HEADERS" | tr -d '[:space:]' | cut -d: -f2) # Execute the handler function from the script RESPONSE=$($(echo "$_HANDLER" | cut -d. -f2) "$EVENT_DATA") # Send the response curl -X POST "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/$REQUEST_ID/response" -d "$RESPONSE" done</span></span></code> </pre> <br><br>  Queremos hacer lo mismo en PHP, y aunque podr√≠a escribirlo yo mismo, Pariksit Agnihotri ya est√° por delante de m√≠ en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP-Lambda-Runtime / runtime.php</a> , as√≠ que simplemente copiamos esto en <code>layer/php/runtime.php</code> .  En mi versi√≥n, hice varios cambios, agregu√© json_encoding y mejor√© el controlador de errores. <br>  La <code>layer/php/bootstrap</code> archivo <code>layer/php/bootstrap</code> muy simple, y todo lo que se requiere de ella es ejecutar el ejecutable PHP con este archivo: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cd $LAMBDA_TASK_ROOT /opt/php /opt/runtime.php</span></span></code> </pre> <br><br>  Eso es todo  Ahora tenemos tres archivos en capa / php: <br><br><ul><li>  <code>php</code> : archivo ejecutable de <code>php</code> ; </li><li>  <code>runtime.php</code> - archivo de trabajo de API de tiempo de ejecuci√≥n; </li><li>  <code>bootstrap</code> es el archivo Lambda requerido. </li></ul><br><br>  Como resultado, todo esto se convertir√° en una Capa PHP (capa) en nuestra aplicaci√≥n Lambda. <br><br><h2>  Configurar el marco sin servidor </h2><br>  Serverless Framework proporciona configuraci√≥n e implementaci√≥n repetibles de una aplicaci√≥n sin servidor.  Soy un fan√°tico de este concepto y quiero usar m√°s herramientas de este tipo.  Usaremos el Framework Serverless para nuestro PHP Hello World. <br>  Dado que no hay una plantilla conveniente para aplicaciones en PHP en Serverless Framework, simplemente creamos el archivo <code>serverless.yml</code> en el directorio con nuestro proyecto. <br>  Para empezar, lo m√°s b√°sico: <br><br><pre> <code class="php hljs">service: php-hello-world provider: name: aws runtime: provided region: eu-west<span class="hljs-number"><span class="hljs-number">-2</span></span> memorySize: <span class="hljs-number"><span class="hljs-number">128</span></span></code> </pre> <br><br>  Llamaremos a nuestra aplicaci√≥n <code>php-hello-world</code> y utilizaremos AWS como proveedor.  Desde que estoy en el Reino Unido, he establecido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la regi√≥n de Londres</a> .  No necesitamos mucha memoria, por lo que 128 MB ser√°n suficientes. <br>  El tiempo de ejecuci√≥n suele ser el idioma en el que desea que se ejecute su funci√≥n.  Para utilizar la <code>runtime API</code> que ejecutar√° nuestro archivo <code>bootstrap</code> , establezca este campo como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proporcionado</a> . <br>  Y necesitar√° un archivo <code>.gitignore</code> que contenga: <br><br><pre> <code class="php hljs">.serverless</code> </pre> <br><br>  Como en <code>git</code> no necesitamos este directorio. <br>  A continuaci√≥n, agreguemos nuestra capa a <code>serverless.yml</code> agregando: <br><br><pre> <code class="php hljs">layers: php: path: layer/php</code> </pre> <br><br>  Esto crear√° una capa de AWS y le dar√° el nombre de <code>PhpLambdaLayer</code> , al que podemos hacer referencia en nuestra funci√≥n. <br><br>  Escribamos la funci√≥n <code>Hello World</code> <br>  Ahora podemos escribir nuestra funci√≥n PHP sin servidor.  Esto debe ingresarse en el archivo <code>handler.php</code> : <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($eventData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">"msg"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"hello from PHP "</span></span> . PHP_VERSION]; }</code> </pre> <br><br>  La funci√≥n toma informaci√≥n sobre el evento y devuelve una matriz asociativa. <br>  Para informar a Serverless Framework sobre la implementaci√≥n de nuestra funci√≥n, debe agregar lo siguiente al archivo <code>serverless.yml</code> : <br><br><pre> <code class="php hljs">functions: hello: handler: handler.hello layers: - {Ref: PhpLambdaLayer}</code> </pre> <br><br>  Serverless Framework admite varias funciones para una aplicaci√≥n.  Cada uno de ellos tiene un nombre, en este caso <code>hello</code> , y, en nuestro caso, un controlador, que es un nombre de archivo sin extensi√≥n, seguido de un punto, y luego el nombre de la funci√≥n en este archivo.  Por lo tanto, el controlador <code>handler.hello</code> significa que ejecutaremos la funci√≥n <code>hello()</code> en <code>handler.php</code> . <br>  Finalmente, tambi√©n informamos funciones a nuestra capa PHP para que pueda ejecutar c√≥digo PHP. <br><br><h2>  Despliegue en Lambda </h2><br>  Para expandir nuestra funci√≥n con su capa, ejecutamos el siguiente comando: <br><br><pre> <code class="php hljs">$ sls deploy</code> </pre> <br><br>  Si el comando se ejecuta el mayor tiempo posible, se obtendr√° una salida similar a esta: <br><br><img src="https://habrastorage.org/webt/ug/tp/yc/ugtpycgq4z_-_4w2gjfcgp8bsrs.png"><br><br><h2>  Cumplimiento de nuestra funci√≥n. </h2><br>  Despu√©s de la implementaci√≥n, podemos llamar a la funci√≥n usando el comando: <br><br><pre> <code class="php hljs">$ sls invoke -f hello -l</code> </pre> <br><br><img src="https://habrastorage.org/webt/r6/bw/dd/r6bwddsehfdsltvezx7-abrrwfy.png"><br><br>  Y ya terminaste! <br><br><h2>  Para resumir </h2><br>  Con nuevas capas y API de tiempo de ejecuci√≥n, ahora puede ejecutar f√°cilmente funciones sin servidor PHP en Lambda.  Esta es una buena noticia para los desarrolladores de PHP vinculados a AWS. <br><br>  Esperando sus comentarios, amigos! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453116/">https://habr.com/ru/post/453116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453106/index.html">El camino hacia el bot√≥n "bot√≠n" en el camino desde el rastrillo</a></li>
<li><a href="../453108/index.html">Revisi√≥n breve de HolyJS 2019 Piter y enlaces de transmisi√≥n en l√≠nea</a></li>
<li><a href="../453110/index.html">Elastic libera caracter√≠sticas de seguridad problem√°ticas lanzadas previamente en c√≥digo abierto</a></li>
<li><a href="../453112/index.html">Conversaciones'19: IA conversacional para aquellos que se est√°n desarrollando y que a√∫n tienen dudas</a></li>
<li><a href="../453114/index.html">Las interfaces 3D suelen ser peores que las interfaces 2D</a></li>
<li><a href="../453118/index.html">¬°El mapeo de video es espectacular! Recopilaci√≥n de instalaciones interesantes y pensamientos sobre c√≥mo hacer que un proyector sea un medio de ganar</a></li>
<li><a href="../453120/index.html">C√≥mo proteger 5G del pirateo: explorando la arquitectura de seguridad</a></li>
<li><a href="../453122/index.html">Concurso de programaci√≥n de h√©roes Kotlin</a></li>
<li><a href="../453126/index.html">La apariencia de UIA no fue tan simple</a></li>
<li><a href="../453128/index.html">Resumen de telecomunicaciones: 15 materiales expertos sobre IPv6, IS, est√°ndares y legislaci√≥n en TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>