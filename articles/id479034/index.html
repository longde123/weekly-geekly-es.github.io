<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•° üéõÔ∏è ü¶é Bagaimana menghubungkan ke VPN perusahaan di Linux menggunakan openconnect dan vpn-slice üê≠ üëºüèø üò∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ingin menggunakan Linux di tempat kerja, tetapi VPN perusahaan tidak? Maka artikel ini dapat membantu, meskipun ini tidak akurat. Saya ingin mempering...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana menghubungkan ke VPN perusahaan di Linux menggunakan openconnect dan vpn-slice</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479034/"><p>  Ingin menggunakan Linux di tempat kerja, tetapi VPN perusahaan tidak?  Maka artikel ini dapat membantu, meskipun ini tidak akurat.  Saya ingin memperingatkan sebelumnya bahwa saya memahami masalah administrasi jaringan dengan buruk, jadi mungkin saja saya melakukan semua yang salah.  Di sisi lain, ada kemungkinan bahwa saya dapat menulis manual sedemikian rupa sehingga dapat dimengerti oleh orang awam, jadi saya menyarankan Anda untuk mencobanya. </p><br><p>  Artikel ini memiliki banyak informasi tambahan, tetapi tanpa pengetahuan ini saya tidak akan bisa menyelesaikan masalah yang tiba-tiba saya miliki dengan pengaturan vpn.  Saya pikir siapa pun yang mencoba menerapkan manual ini akan memiliki masalah yang tidak saya miliki, dan saya berharap informasi tambahan ini akan membantu menyelesaikan masalah ini sendiri. </p><br><p>  Sebagian besar perintah yang digunakan dalam manual harus dijalankan melalui sudo, yang dihapus karena singkatnya.  Ingatlah selalu. </p><br><p>  Sebagian besar alamat ip sangat dikaburkan, jadi jika Anda melihat alamat seperti 435.435.435.435, harus ada beberapa ip normal khusus untuk kasing Anda. </p><br><p>  Saya memiliki Ubuntu 18,04, tetapi saya pikir dengan beberapa perubahan panduan ini dapat diterapkan ke distribusi lain.  Namun, dalam teks ini, Linux == Ubuntu. </p><br><h2>  Cisco terhubung </h2><br><p>  Mereka yang menggunakan Windows atau MacOS dapat terhubung ke VPN perusahaan kami melalui Cisco Connect, yang perlu menentukan alamat gateway dan memasukkan kata sandi setiap kali terhubung, yang terdiri dari bagian tetap dan kode yang dihasilkan oleh Google Authenticator. </p><a name="habracut"></a><br><p>  Dalam kasus Linux, tidak mungkin untuk mendapatkan Cisco Connect, tetapi ternyata Google merekomendasikan untuk menggunakan openconnect, yang dibuat khusus untuk menggantikan Cisco Connect. </p><br><h2>  Buka koneksi </h2><br><p>  Secara teori, di ubunt ada antarmuka grafis khusus untuk openconnect tetapi tidak berfungsi untuk saya.  Mungkin itu yang terbaik. </p><br><p>  Di ubunt openconnect diinstal dari manajer paket. </p><br><pre><code class="plaintext hljs">apt install openconnect</code> </pre> <br><p>  Segera setelah instalasi, Anda dapat mencoba terhubung ke VPN </p><br><pre> <code class="plaintext hljs">openconnect --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  vpn.evilcorp.com adalah alamat VPN fiktif \ <br>  poxvuibr - nama pengguna fiktif </p><br><p>  openconnect akan meminta Anda untuk memasukkan kata sandi, yang saya ingat, terdiri dari bagian dan kode tetap dari Google Authenticator, dan kemudian mencoba untuk terhubung ke vpn.  Jika ternyata, selamat, Anda dapat dengan aman melewati bagian tengahnya, yang sangat menyusahkan dan langsung membahas tentang pembuka koneksi di latar belakang.  Jika tidak berhasil, maka Anda dapat melanjutkan.  Meskipun jika ternyata ketika menghubungkan, misalnya, dari Wi-Fi tamu di tempat kerja, dimungkinkan untuk bersukacita dan lebih awal, Anda harus mencoba mengulangi prosedur dari rumah. </p><br><h2>  Sertifikat </h2><br><p>  Dengan probabilitas tinggi, tidak ada yang akan mulai, dan knalpot openconnect akan terlihat seperti ini: </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Certificate from VPN server "vpn.evilcorp.com" failed verification. Reason: signer not found To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Di satu sisi, ini tidak menyenangkan, karena tidak ada koneksi ke VPN, tetapi di sisi lain, cara memperbaiki masalah ini dapat dipahami secara prinsip. </p><br><p>  Kemudian server mengirimi kami sertifikat, yang menurutnya dapat ditentukan bahwa koneksi dilakukan ke server perusahaan asli, dan bukan ke penipu yang jahat, dan sertifikat ini tidak diketahui oleh sistem.  Jadi dia tidak bisa memeriksa apakah server sebenarnya atau tidak.  Jadi, untuk berjaga-jaga, itu berhenti bekerja. </p><br><p>  Agar openconnect masih terhubung ke server, Anda perlu secara eksplisit memberi tahu sertifikat mana yang harus berasal dari server VPN menggunakan kunci --servercert </p><br><p>  Dan Anda dapat mengetahui sertifikat mana yang dikirim server kepada kami langsung dari openconnect yang dicetak.  Di sini dari bagian ini: </p><br><pre> <code class="plaintext hljs">To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Dengan perintah ini Anda dapat mencoba menghubungkan lagi </p><br><pre> <code class="plaintext hljs">openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  Mungkin itu berfungsi sekarang, maka Anda bisa pergi ke akhir.  Tapi Ubunta secara pribadi menunjukkan ara dalam bentuk ini </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Connected to HTTPS on vpn.evilcorp.com XML POST enabled Please enter your username and password. POST https://vpn.evilcorp.com/ Got CONNECT response: HTTP/1.1 200 OK CSTP connected. DPD 300, Keepalive 30 Set up DTLS failed; using SSL instead Connected as 192.168.333.222, using SSL NOSSSSSHHHHHHHDDDDD 3 NOSSSSSHHHHHHHDDDDD 3 RTNETLINK answers: File exists /etc/resolvconf/update.d/libc: Warning: /etc/resolv.conf is not a symbolic link to /run/resolvconf/resolv.conf</code> </pre> <br><p>  /etc/resolv.conf </p><br><pre> <code class="plaintext hljs"># Generated by NetworkManager search gst.evilcorpguest.com nameserver 127.0.0.53</code> </pre> <br><p>  /run/resolvconf/resolv.conf </p><br><pre> <code class="plaintext hljs"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run "systemd-resolve --status" to see details about the actual nameservers. nameserver 192.168.430.534 nameserver 127.0.0.53 search evilcorp.com gst.publicevilcorp.com</code> </pre> <br><p>  habr.com akan diselesaikan, tetapi tidak mungkin untuk masuk ke sana.  Alamat seperti jira.evilcorp.com tidak menyelesaikan sama sekali. </p><br><p>  Apa yang terjadi di sini tidak jelas bagi saya.  Tetapi percobaan menunjukkan bahwa jika Anda menambahkan baris ke /etc/resolv.conf </p><br><pre> <code class="plaintext hljs">nameserver 192.168.430.534</code> </pre> <br><p>  maka alamat di dalam VPN akan secara ajaib teratasi dan akan mungkin untuk memutarnya, yaitu mencari alamat DNS yang harus diselesaikan, mencari di /etc/resolv.conf, dan tidak ke tempat lain. </p><br><p>  Jika ada koneksi ke VPN dan berfungsi, Anda dapat memastikan tanpa perubahan di /etc/resolv.conf, untuk ini cukup masuk ke browser bukan nama simbolis sumber daya dari vpn, tetapi alamat ip-nya </p><br><p>  Hasilnya adalah dua masalah </p><br><ul><li>  pada koneksi ke VPN, dns tidak diambil </li><li>  semua lalu lintas melewati vpn, yang tidak memungkinkan Anda untuk pergi ke Internet </li></ul><br><p>  Apa yang akan saya lakukan sekarang akan saya katakan, tetapi pertama-tama otomatisasi kecil. </p><br><h2>  Entri otomatis dari kata sandi yang diperbaiki </h2><br><p>  Pada saat ini, Anda kemungkinan besar telah memasukkan kata sandi setidaknya lima kali dan prosedur ini sudah cukup membuat Anda lelah.  Pertama, karena kata sandi panjang, dan kedua, karena saat memasukkan, Anda harus menyimpan dalam jangka waktu yang tetap </p><br><p>  Solusi akhir untuk masalah ini tidak termasuk dalam artikel, tetapi dapat dilakukan agar bagian kata sandi tetap tidak harus dimasukkan berkali-kali. </p><br><p>  Misalkan bagian tetap dari kata sandi adalah fixedPassword, dan bagian dari Google Authenticator 567 987. Seluruh kata sandi openconnect dapat dilewatkan melalui input standar menggunakan argumen --passwd-on-stdin. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com --passwd-on-stdin</code> </pre> <br><p>  Sekarang Anda dapat terus-menerus kembali ke perintah yang dimasukkan terakhir dan hanya mengubah sebagian dari Google Authenticator di sana. </p><br><h2>  VPN Perusahaan tidak mengizinkan akses Internet. </h2><br><p>  Secara umum, itu tidak terlalu merepotkan ketika untuk pergi ke hub Anda harus menggunakan komputer terpisah.  Kurangnya kemampuan untuk menyalin dan menempel dengan stackoverfow umumnya dapat melumpuhkan pekerjaan, sehingga sesuatu harus dilakukan. </p><br><p>  Hal ini diperlukan untuk mengatur, sehingga ketika Anda perlu pergi ke sumber daya dari jaringan internal, Linux pergi ke vpn, dan ketika Anda perlu pergi ke hub, ia pergi ke Internet. </p><br><p>  openconnect setelah memulai dan membangun koneksi dengan vpn, mengeksekusi skrip khusus, yang terletak di / usr / share / vpnc-scripts / vpnc-script.  Beberapa variabel ditransfer ke skrip input, dan itu melakukan konfigurasi vpn.  Sayangnya, saya tidak dapat menemukan cara untuk membagi arus lalu lintas antara vpn perusahaan dan seluruh internet menggunakan skrip asli. </p><br><p>  Rupanya khusus untuk orang-orang seperti saya, utilitas vpn-slice dikembangkan, yang memungkinkan Anda untuk mengarahkan lalu lintas melalui dua saluran tanpa menari dengan rebana.  Ya, itu artinya, Anda harus menari, tetapi dukun tidak perlu. </p><br><h2>  Membagi traffic dengan vpn-slice </h2><br><p>  Pertama, vpn-slice harus diinstal, Anda harus mengetahuinya sendiri.  Jika ada pertanyaan di komentar, saya akan menulis posting terpisah tentang ini.  Tapi ini adalah program python biasa, jadi seharusnya tidak ada kesulitan.  Saya mengatur menggunakan virtualenv. </p><br><p>  Dan kemudian Anda perlu menggunakan utilitas, menggunakan kunci --script yang menunjukkan openconnect bahwa alih-alih skrip standar Anda perlu menggunakan vpn-slice </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 " vpn.evilcorp.com</code> </pre> <br><p>  Dalam --script, sebuah baris dilewatkan dengan perintah yang perlu dipanggil, bukan script.  ./bin/vpn-slice - path ke file executable vpn-slice 192.168.430.0/24 - mask dari alamat yang akan dikunjungi di vpn.  Di sini, maksud saya bahwa jika alamat dimulai dengan 192.168.430, maka sumber daya dengan alamat ini harus dicari di dalam vpn </p><br><p>  Sekarang situasinya hampir normal.  Hampir.  Sekarang Anda dapat masuk ke hub dan Anda dapat masuk ke sumber daya perusahaan internal dengan ip, tetapi Anda tidak bisa masuk ke sumber daya perusahaan internal dengan nama simbolik.  Jika Anda mendaftarkan korespondensi nama simbolis dan alamat di host, semuanya akan berfungsi.  Dan bekerja sampai perubahan ip.  Linux sekarang dapat pergi ke Internet atau ke jaringan perusahaan, tergantung pada ip.  Tetapi DNS non-perusahaan masih digunakan untuk menentukan alamat. </p><br><p>  Masalahnya masih dapat terwujud dalam bentuk ini - semuanya baik-baik saja di tempat kerja, dan di rumah Anda dapat mengakses sumber daya internal perusahaan hanya dengan ip.  Ini karena ketika Anda terhubung ke Wi-Fi perusahaan, DNS perusahaan juga digunakan, dan di dalamnya alamat simbolis dari tekad VPN, meskipun masih tidak mungkin untuk pergi ke alamat seperti itu tanpa menggunakan VPN. </p><br><h2>  Modifikasi otomatis dari file host </h2><br><p>  Jika Anda dengan sopan meminta vpn-slice, maka setelah menaikkan VPN, ia dapat pergi ke DNS-nya, menemukan alamat IP sumber daya yang diperlukan di sana dengan nama simbolisnya dan memasukkannya di host.  Setelah VPN dimatikan, alamat ini akan dihapus dari host.  Untuk melakukan ini, berikan nama simbolis ke vpn-slice sebagai argumen.  Itu dia. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Sekarang semuanya harus bekerja baik di kantor maupun di pantai. </p><br><h2>  Cari alamat semua subdomain di DNS yang diberikan VPN </h2><br><p>  Jika ada beberapa alamat dalam jaringan, maka pendekatan dengan secara otomatis memodifikasi file host cukup berhasil.  Tetapi jika ada banyak sumber daya di jaringan, maka Anda akan terus-menerus perlu menambahkan baris seperti zoidberg.test.evilcorp.com ke skrip zoidberg ini adalah nama dari salah satu tempat uji. </p><br><p>  Tetapi sekarang kita memiliki sedikit pemahaman tentang mengapa kebutuhan ini dapat dihilangkan. </p><br><p>  Jika, setelah menaikkan VPN, lihat di / etc / hosts, Anda dapat melihat, ini adalah baris </p><br><blockquote>  192.168.430.534 dns0.tun0 # vpn-slice-tun0 AUTOCREATED </blockquote><p>  Ya, dan baris baru ditambahkan ke resolv.conf.  Singkatnya, vpn-slice entah bagaimana menentukan di mana server dns untuk vpn berada. </p><br><p>  Sekarang kita perlu memastikan bahwa untuk mengetahui alamat ip dari nama domain yang berakhir dengan evilcorp.com, Linux pergi ke dns perusahaan, dan jika ada hal lain yang diperlukan, maka ke default. </p><br><p>  Saya mencari Google untuk waktu yang lama dan menemukan bahwa fungsi seperti itu ada di luar kotak.  Ini merujuk pada kemampuan untuk menggunakan server dns dnsmasq lokal untuk menyelesaikan nama. </p><br><p>  Artinya, Anda dapat membuat Linux selalu pergi ke server dns lokal untuk alamat ip, yang pada gilirannya, tergantung pada nama domain, akan mencari ip pada server dns eksternal yang sesuai. </p><br><p>  Untuk mengelola segala sesuatu yang berkaitan dengan jaringan dan koneksi jaringan, Ubunt menggunakan NetworkManager, dan antarmuka grafis untuk memilih, misalnya, koneksi Wi-Fi hanya bagian depannya. </p><br><p>  Kita perlu menaiki konfigurasinya. </p><br><ol><li>  Buat file di /etc/NetworkManager/dnsmasq.d/evilcorp </li></ol><br><blockquote>  address = /. evilcorp.com/192.168.430.534 </blockquote><p>  Perhatikan poin sebelum evilcorp.  Ini menandakan dnsmasq bahwa semua subdomain evilcorp.com harus dicari di dns perusahaan. </p><br><ol><li>  Beri tahu NetworkManager untuk menggunakan dnsmasq untuk menyelesaikan nama </li></ol><br><p>  Konfigurasi manajer jaringan terletak di /etc/NetworkManager/NetworkManager.conf Anda perlu menambahkan di sana: </p><br><blockquote>  [utama] <br>  dns = dnsmasq </blockquote><br><ol><li>  Mulai kembali NetworkManager </li></ol><br><pre> <code class="plaintext hljs">service network-manager restart</code> </pre> <br><p>  Sekarang, setelah terhubung ke VPN menggunakan sekelompok openconnect dan vpn-slice, ip akan terdeteksi secara normal bahkan jika Anda tidak menambahkan alamat simbolis ke argumen ke vpnslice. </p><br><h2>  Cara masuk melalui VPN ke layanan terpisah </h2><br><p>  Setelah ternyata terhubung ke vpn, saya sangat senang selama dua hari, dan kemudian ternyata jika Anda terhubung ke VPN bukan dari jaringan kantor, surat tidak berfungsi.  Gejala yang akrab, bukan? </p><br><p>  Email kami ada di mail.publicevilcorp.com, yang berarti tidak masuk dalam aturan dnsmasq dan alamat server email dicari melalui DNS publik. </p><br><p>  Yah, kantor masih menggunakan DNS di mana alamat ini berada.  Ya, saya pikir begitu.  Bahkan, setelah menambahkan baris ke dnsmasq </p><br><blockquote>  address = / mail.publicevilcorp.com / 192.168.430.534 </blockquote><p>  situasinya belum berubah.  ip tetap sama.  Saya harus pergi bekerja. </p><br><p>  Dan hanya kemudian, ketika saya menyelidiki situasi dan sedikit menyelesaikan masalah, satu orang pintar mengatakan kepada saya bagaimana menyelesaikannya.  Itu perlu untuk terhubung ke server surat tidak hanya seperti itu, tetapi melalui vpn </p><br><p>  Saya menggunakan vpn-slice untuk mengakses VPN ke alamat yang dimulai dengan 192.168.430.  Dan di server surat, bukan hanya alamat simbolis bukan subdomain dari evilcorp, ia juga memiliki alamat IP yang tidak dimulai dengan 192.168.430.  Dan tentu saja dia tidak membiarkan siapa pun keluar dari jaringan umum. </p><br><p>  Agar Linux dapat melalui VPN dan ke server mail, Anda perlu menambahkannya ke vpn-slice.  Misalkan alamat pengirim adalah 555.555.555.555 </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 555.555.555.555 192.168.430.0/24" vpn.evilcorp.com</code> </pre> <br><h2>  Script untuk menaikkan VPN dengan satu argumen </h2><br><p>  Semua ini, tentu saja, sangat tidak nyaman.  Ya, Anda dapat menyimpan teks ke file dan menyalin-menempelnya ke konsol, daripada mengetik dengan tangan Anda, tetapi itu masih tidak cukup menyenangkan.  Untuk memudahkan proses, Anda bisa membungkus perintah dalam skrip yang akan berlokasi di PATH.  Dan kemudian Anda hanya perlu memasukkan kode yang diperoleh dari Google Authenticator </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Jika Anda memasukkan skrip ke connect ~ evilcorp ~ Anda bisa menulis di konsol </p><br><pre> <code class="plaintext hljs">connect_evil_corp 567987</code> </pre> <br><p>  Tapi sekarang, bagaimanapun, untuk beberapa alasan Anda harus menjaga konsol tempat openconnect terbuka </p><br><h2>  Buka peluncuran di latar belakang </h2><br><p>  Untungnya, penulis openconnect merawat kami dan menambahkan kunci khusus - latar belakang ke program, yang membuat program bekerja di latar belakang setelah diluncurkan.  Jika Anda menjalankannya seperti ini, maka setelah peluncuran Anda dapat menutup konsol </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Sekarang tidak jelas ke mana log itu pergi.  Log umumnya tidak benar-benar diperlukan bagi kami, tetapi Anda tidak pernah tahu.  openconnect dapat mengarahkan mereka ke syslog, di mana mereka akan tetap utuh.  Anda perlu menambahkan kunci --syslog ke perintah </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \</code> </pre> <br><p>  Jadi, ternyata openconnect bekerja di suatu tempat di latar belakang dan tidak mengganggu siapa pun, tetapi cara menghentikannya tidak jelas.  Yaitu, Anda bisa, tentu saja, menyaring knalpot ps dengan grep dan mencari proses dengan nama yang openconnect, tetapi entah bagaimana suram.  Terima kasih kepada penulis yang memikirkan hal ini.  Openconnect memiliki kunci --pid-file, yang dengannya Anda dapat menginstruksikan openconnect untuk menulis ID prosesnya ke sebuah file. </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Sekarang Anda selalu dapat memakukan proses dengan perintah </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid)</code> </pre> <br><p>  Jika tidak ada proses, kill akan bersumpah, tetapi itu tidak akan menimbulkan kesalahan.  Jika tidak ada file, maka tidak ada hal buruk yang akan terjadi, sehingga Anda dapat dengan aman mematikan proses di baris pertama skrip. </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid) #!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Sekarang Anda dapat menyalakan komputer, buka konsol dan jalankan perintah, berikan kode dari Google Authenticator.  Konsol kemudian dapat dipaku. </p><br><h1>  Tanpa vpn-slice.  Alih-alih kata penutup </h1><br><p>  Sangat sulit untuk memahami bagaimana hidup tanpa vpn-slice.  Saya harus banyak membaca dan google.  Untungnya, ketika saya menghabiskan begitu banyak waktu dengan masalah ini, manual teknis dan bahkan openconnect man membaca seperti novel yang menarik. </p><br><p>  Sebagai hasilnya, saya menemukan bahwa vpn-slice, seperti skrip asli, memodifikasi tabel routing ke jaringan yang terpisah. </p><br><h2>  Tabel perutean </h2><br><p>  Secara sederhana, tabel seperti itu di kolom pertama yang berisi di mana alamat tempat Linux ingin pergi harus dimulai, dan yang kedua melalui adaptor jaringan yang pergi ke alamat ini.  Sebenarnya, ada lebih banyak kolom, tetapi ini tidak mengubah esensi. </p><br><p>  Untuk melihat tabel routing, Anda perlu menjalankan perintah ip route </p><br><pre> <code class="plaintext hljs">default via 192.168.1.1 dev wlp3s0 proto dhcp metric 600 192.168.430.0/24 dev tun0 scope link 192.168.1.0/24 dev wlp3s0 proto kernel scope link src 192.168.1.534 metric 600 192.168.430.534 dev tun0 scope link</code> </pre> <br><p>  Di sini, setiap baris bertanggung jawab ke mana harus pergi untuk mengirim pesan ke beberapa alamat.  Yang pertama adalah deskripsi di mana alamat harus dimulai.  Untuk memahami cara menentukan bahwa 192.168.0.0/16 berarti bahwa alamat tersebut harus dimulai dengan 192.168, Anda perlu mencari google apa penutup alamat IP itu.  After dev adalah nama adaptor tempat pesan harus dikirim. </p><br><p>  Untuk VPN, Linux membuat adaptor virtual - tun0.  Untuk lalu lintas untuk semua alamat yang dimulai dengan 192.168 untuk menjalaninya, baris menjawab </p><br><pre> <code class="plaintext hljs">192.168.0.0/16 dev tun0 scope link</code> </pre> <br><p>  Anda juga dapat melihat kondisi tabel perutean saat ini menggunakan perintah <strong>route -n</strong> (alamat ip sangat berbakat secara anonim) Perintah ini menghasilkan hasil dalam bentuk yang berbeda dan umumnya tidak digunakan lagi, tetapi knalpotnya sering ditemukan di manual online dan Anda harus dapat membacanya. </p><br><p>  Di mana alamat ip untuk rute harus dimulai dapat dipahami dari kombinasi kolom Destination dan Genmask.  Bagian-bagian dari alamat ip yang nomor 255 sesuai dalam Genmask diperhitungkan, dan yang mana 0 tidak.  Yaitu, kombinasi dari Destination 192.168.0.0 dan Genmask 255.255.255.0 berarti bahwa jika alamat dimulai dengan 192.168.0, maka permintaan untuk itu akan mengikuti rute ini.  Dan jika Tujuan 192.168.0.0 tetapi Genmask adalah 255.255.0.0, maka permintaan ke alamat yang dimulai dengan 192.168 akan mengikuti rute ini </p><br><p>  Untuk mengetahui apa yang sebenarnya dilakukan vpn-slice, saya memutuskan untuk melihat kondisi tabel sebelum dan sesudah </p><br><h2>  Sebelum menyalakan VPN, sudah seperti ini </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0</code> </pre> <br><h2>  Setelah memanggil openconnect tanpa vpn-slice, itu menjadi demikian </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><h2>  Dan setelah memanggil openconnect dalam kombinasi dengan vpn-slice seperti ini </h2><br><pre> <code class="plaintext hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><p>  Dapat dilihat bahwa jika Anda tidak menggunakan vpn-slice, maka openconnect secara eksplisit menulis bahwa Anda harus melalui vpn ke semua alamat kecuali ditunjukkan secara terpisah. </p><br><p>  Di sini: </p><br><pre> <code class="plaintext hljs">0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0</code> </pre> <br><p>  Di dekat sana segera ditunjukkan jalur lain yang harus digunakan jika alamat yang dicoba Linux tidak cocok dengan topeng apa pun dari tabel. </p><br><pre> <code class="plaintext hljs">0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0</code> </pre> <br><p>  Sudah ditulis di sini bahwa dalam hal ini Anda harus melalui adaptor Wi-Fi standar. </p><br><p>  Saya percaya bahwa jalur untuk VPN digunakan karena ini adalah yang pertama di tabel routing. </p><br><p>  Dan secara teoritis, jika Anda menghapus jalur default ini dari tabel routing, maka dalam hubungannya dengan openconnect dnsmasq harus memastikan operasi normal. </p><br><p>  Saya mencoba </p><br><pre> <code class="plaintext hljs">route del default</code> </pre> <br><p>  Dan itu berhasil. </p><br><h2>  Mengalihkan permintaan ke server email tanpa vpn-slice </h2><br><p>  Tapi saya juga punya mail server dengan alamat 555.555.555.555, yang mana Anda juga harus melalui vpn.  Rute ke sana juga harus ditambahkan dengan tangan. </p><br><pre> <code class="plaintext hljs">ip route add 555.555.555.555 via dev tun0</code> </pre> <br><p>  Dan sekarang semua aturannya.  Jadi Anda bisa melakukannya tanpa vpn-slice, tetapi Anda harus tahu apa yang Anda lakukan.  Saya sekarang berpikir untuk menambahkan penghapusan rute default dan menambahkan rute untuk mailer setelah terhubung ke vpn ke baris terakhir skrip asli openconnect, hanya untuk membuat jumlah komponen yang bergerak di sepeda saya lebih kecil. </p><br><p>  Mungkin, seseorang untuk memahami cara mengkonfigurasi VPN akan merasa cukup dengan kata penutup ini.  Tetapi ketika saya mencoba untuk memahami apa dan bagaimana melakukannya, saya membaca banyak manual yang berfungsi untuk penulis, tetapi untuk beberapa alasan tidak bekerja untuk saya dan memutuskan untuk menambahkan di sini semua bagian yang saya temukan.  Saya akan sangat senang dengan hal seperti itu. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id479034/">https://habr.com/ru/post/id479034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id479016/index.html">5 langkah untuk melindungi rahasia dagang</a></li>
<li><a href="../id479018/index.html">Docker untuk front-end. Bagian 2. Apa kamu?</a></li>
<li><a href="../id479020/index.html">Kisah bagaimana Google Play mencoret sepuluh tahun pekerjaan saya dalam satu jam</a></li>
<li><a href="../id479022/index.html">Smart TV Samsung, LG, Vizio dan TCL setiap detik mengambil "sidik jari" layar dan mengirim ke server</a></li>
<li><a href="../id479026/index.html">Penjumlahan Sejati Saluran Internet - OpenMPTCPRouter</a></li>
<li><a href="../id479036/index.html">Intel tidak dapat mengatasi permintaan akan prosesor. Akibatnya, HP dan Dell menderita</a></li>
<li><a href="../id479038/index.html">Transformasi Digital Leroy Merlin: Merancang Antarmuka untuk Bekerja dengan Panggilan Pelanggan</a></li>
<li><a href="../id479040/index.html">Tes regresi visual. Mulai ulang</a></li>
<li><a href="../id479042/index.html">Metode Y adalah cara yang sangat mudah untuk membangun Rubik's Cube</a></li>
<li><a href="../id479044/index.html">Implementasi ring ring saya di NOR flash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>