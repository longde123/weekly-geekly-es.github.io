<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖 ♂️ 👨🏿‍🎨 Boot dirimu, Spring akan datang (Bagian 2) 😝 👩🏿‍🎨 👫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) dan Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) terus berbicara tentang penggunaan Spring Boot u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Boot dirimu, Spring akan datang (Bagian 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) dan Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">tolkkv</a> Tolkachev (Cyan.Finance, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Twitter</a> ) terus berbicara tentang penggunaan Spring Boot untuk menyelesaikan masalah Iron Bank Braavos yang imajiner.  Pada bagian kedua, kita akan fokus pada profil dan seluk beluk dari meluncurkan aplikasi. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Bagian pertama artikel dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </p><br><p>  Jadi, sampai saat ini, pelanggan datang dan hanya meminta untuk mengirim gagak.  Sekarang situasinya telah berubah.  Musim dingin telah tiba, tembok telah runtuh. </p><br><p> Pertama, prinsip pemberian pinjaman berubah.  Jika sebelumnya dengan probabilitas 50% yang mereka berikan kepada semua orang kecuali Starks, sekarang mereka hanya memberikan kepada mereka yang membayar utang.  Oleh karena itu, kami mengubah aturan untuk mengeluarkan pinjaman dalam logika bisnis kami.  Tetapi hanya untuk cabang-cabang bank, yang terletak di mana musim dingin telah tiba, semuanya tetap seperti sebelumnya.  Saya mengingatkan Anda bahwa ini adalah layanan yang memutuskan apakah akan memberikan pinjaman atau tidak.  Kami hanya akan melakukan layanan lain yang hanya akan bekerja di musim dingin. </p><br><p>  Kami pergi ke logika bisnis kami: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  Kami sudah memiliki daftar orang-orang yang membayar utang. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  Dan ada kelas yang sudah dikaitkan dengan properti - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  Seperti di waktu sebelumnya, kami cukup menyuntikkannya di sini: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Ingat tentang injeksi konstruktor (tentang anotasi ajaib): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Hampir selesai. </p><br><p>  Sekarang kita harus memberikan hanya kepada mereka yang membayar hutang: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Tapi di sini kita punya masalah kecil.  Sekarang kami memiliki dua implementasi: layanan lama dan layanan baru. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend… - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper… - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  Adalah logis untuk membagi kacang ini menjadi profil yang berbeda.  Profil <code></code> <code></code> dan profil <code></code> .  Biarkan layanan baru kami berjalan hanya di profil <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Dan layanan lama di <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  Tapi musim dingin datang perlahan.  Di kerajaan di sebelah tembok yang rusak, itu sudah musim dingin.  Tetapi di suatu tempat di selatan - belum.  Yaitu  Aplikasi yang berlokasi di berbagai cabang dan zona waktu harus bekerja secara berbeda.  Menurut kondisi tugas kami, kami tidak dapat menghapus implementasi lama di mana musim dingin telah datang dan menggunakan kelas baru.  Kami ingin karyawan bank tidak melakukan apa pun: kami akan mengirimkan mereka aplikasi yang akan bekerja dalam mode musim panas hingga musim dingin tiba.  Dan ketika musim dingin tiba, mereka hanya memulai kembali dan hanya itu.  Mereka tidak perlu mengubah kode, menghapus kelas apa pun.  Oleh karena itu, kami awalnya memiliki dua profil: bagian dari tempat sampah dibuat saat musim panas, dan bagian tempat sampah dibuat saat musim dingin. </p><br><p>  Tetapi masalah lain muncul: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Sekarang kami tidak memiliki satu kacang, karena kami menetapkan dua profil, dan aplikasi dimulai pada profil default. </p><br><p>  Jadi kami memiliki persyaratan baru dari pelanggan. </p><br><h2>  Hukum Besi 2. Tidak ada profil yang diizinkan </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  Kami tidak ingin meningkatkan konteks jika profil tidak diaktifkan, karena musim dingin telah tiba, semuanya menjadi sangat buruk.  Ada hal-hal tertentu yang harus terjadi atau tidak, tergantung pada apakah <code></code> atau <code></code> .  Juga, lihat pengecualian, teks yang diberikan di atas.  Dia tidak menjelaskan apa pun.  Profil tidak ditentukan, oleh karena itu tidak ada implementasi layanan <code>ProphetService</code> .  Pada saat yang sama, tidak ada yang mengatakan bahwa perlu menetapkan profil. </p><br><p>  Oleh karena itu, kami sekarang ingin memasukkan potongan tambahan ke starter kami, yang, ketika membangun konteks, akan memeriksa apakah beberapa profil sudah diatur.  Jika tidak disetel, kami tidak akan naik dan melempar hanya pengecualian seperti itu (dan bukan pengecualian tentang kurangnya tempat sampah). </p><br><p>  Bisakah kita melakukan ini dengan pendengar aplikasi kita?  Tidak.  Dan ada tiga alasan untuk ini: </p><br><ul><li>  Pendengar tanggung jawab tunggal bertanggung jawab untuk membuat gagak terbang.  Pendengar tidak boleh memeriksa apakah profil telah diaktifkan karena mengaktifkan profil tidak hanya memengaruhi pendengar itu sendiri, tetapi juga lebih banyak lagi. </li><li>  Ketika sebuah konteks dibangun, hal-hal yang berbeda terjadi.  Dan kami tidak ingin mereka mulai terjadi jika profil belum ditetapkan. </li><li>  Pendengar bekerja di bagian paling akhir ketika konteks diselesaikan.  Dan fakta bahwa tidak ada profil, kita tahu jauh sebelumnya.  Mengapa menunggu ini bersyarat lima menit sampai layanan hampir naik, dan kemudian semuanya jatuh. </li></ul><br><p>  Selain itu, saya masih tidak tahu bug apa yang akan muncul karena fakta bahwa kami mulai naik tanpa profil (misalkan saya tidak tahu logika bisnis).  Karena itu, dengan tidak adanya profil, Anda perlu menurunkan konteks pada tahap yang sangat awal.  Omong-omong, jika Anda menggunakan Spring Cloud apa pun, ini menjadi lebih relevan bagi Anda, karena aplikasi melakukan banyak hal pada tahap awal. </p><br><p>  Untuk menerapkan persyaratan baru, ada <code>ApplicationContextInitializer</code> .  Ini adalah antarmuka lain yang memungkinkan kita untuk memperluas beberapa titik Spring dengan menetapkannya di spring.factories. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  Kami mengimplementasikan antarmuka ini, dan kami memiliki Context Initializer, yang memiliki <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Dengan itu, kita bisa mendapatkan lingkungan - hal yang disiapkan SpringApplication untuk kita.  Semua properti yang kami berikan kepadanya tiba di sana.  Antara lain, mereka juga mengandung profil. </p><br><p>  Jika tidak ada profil di sana, maka kami harus mengeluarkan pengecualian yang mengatakan bahwa Anda tidak dapat bekerja seperti itu. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Sekarang Anda perlu mendaftarkan barang ini di spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  Dari penjelasan di atas, Anda dapat menebak bahwa <code>ApplicationContextInitializer</code> adalah titik ekstensi.  <code>ApplicationContextInitializer</code> berfungsi ketika konteksnya baru mulai dibangun, belum ada nampan. </p><br><p>  Timbul pertanyaan: jika kita menulis <code>ApplicationContextInitializer</code> , mengapa tidak, sebagai pendengar, ditulis dalam konfigurasi yang membentang?  Jawabannya sederhana: karena harus bekerja jauh lebih awal ketika tidak ada konteks dan tidak ada konfigurasi.  Yaitu  itu belum bisa disuntikkan.  Karena itu, kami meresepkannya sebagai bagian terpisah. </p><br><p>  Upaya untuk meluncurkan menunjukkan bahwa semuanya telah jatuh cukup cepat dan melaporkan bahwa kami mulai tanpa profil.  Sekarang mari kita coba untuk menentukan beberapa profil, dan semuanya berfungsi - gagak dikirim. </p><br><p>  <code>ApplicationContextInitializer</code> - memenuhi ketika konteks telah dibuat, tetapi tidak ada yang lain di dalamnya selain lingkungan. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Siapa yang menciptakan lingkungan?  Carlson - <code>SpringBootApplication</code> .  Dia mengisinya dengan berbagai meta-informasi, yang kemudian dapat ditarik keluar dari konteks.  Sebagian besar hal dapat disuntikkan melalui <code>@value</code> , sesuatu dapat diperoleh dari lingkungan, karena kami baru saja mendapatkan profil. </p><br><p>  Misalnya, berbagai properti datang ke sini: </p><br><ul><li>  Spring Boot mana yang bisa dibangun; </li><li>  yang pada saat startup ditransmisikan melalui baris perintah; </li><li>  sistemik; </li><li>  dijabarkan sebagai variabel lingkungan; </li><li>  ditentukan dalam properti aplikasi; </li><li>  terdaftar di beberapa file properti lainnya. </li></ul><br><p>  Semua ini dikumpulkan dan diatur menjadi objek lingkungan.  Ini juga berisi informasi tentang profil mana yang aktif.  Objek lingkungan adalah satu-satunya hal yang ada pada saat Boot Musim Semi mulai membangun konteks. </p><br><p>  Saya ingin menebak secara otomatis profil apa yang akan terjadi jika orang lupa bertanya dengan tangan mereka (kami melakukan segalanya sehingga karyawan bank yang tidak berdaya tanpa programmer dapat meluncurkan aplikasi sehingga semuanya bekerja untuk mereka, tidak peduli apa).  Untuk melakukan ini, kami akan menambah starter kami hal yang akan menebak profil - <code></code> atau tidak - tergantung pada suhu di jalan.  Dan antarmuka sihir baru lainnya akan membantu kita semua dengan ini - <code>EnvironmentPostProcessor</code> , karena kita perlu melakukan ini sebelum <code>ApplicationContextInitializer</code> berfungsi.  Dan sebelum <code>ApplicationContextInitializer</code> hanya ada <code>EnvironmentPostProcessor</code> . </p><br><p>  Kami sekali lagi menerapkan antarmuka baru.  Hanya ada satu metode, yang dengan cara yang sama <code>ConfigurableEnvironment</code> melempar di <code>SpringApplication</code> , karena kita belum memiliki <code>ConfigurableContext</code> (itu sudah ada di <code>SpringInitializer</code> tidak ada di sini; hanya ada lingkungan). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Di lingkungan ini, kita dapat mengatur profil.  Tetapi pertama-tama Anda perlu memeriksa bahwa belum ada yang menginstalnya sebelumnya.  Karena itu, kita <code>getActiveProfiles</code> perlu memeriksa <code>getActiveProfiles</code> .  Jika orang tahu apa yang mereka lakukan dan mereka membuat profil, maka kami tidak akan mencoba menebaknya.  Tetapi jika tidak ada profil, maka kami akan mencoba memahami cuaca. </p><br><p>  Dan yang kedua - kita harus mengerti jika kita memiliki cuaca musim dingin atau musim panas sekarang.  Kami akan mengembalikan suhu <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Dalam kondisi ini, kami mengalami musim dingin, dan kami dapat membuat profil baru.  Kami ingat bahwa profil ini disebut <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Sekarang kita perlu menentukan <code>EnvironmentPostProcessor</code> di spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  Akibatnya, aplikasi dimulai tanpa profil, kami mengatakan itu adalah produksi, dan memeriksa di mana profil itu dimulai dengan kami.  Secara ajaib, kami menyadari bahwa profil kami adalah <code></code> .  Dan aplikasi tidak jatuh, karena <code>ApplicationContextInitializer</code> , yang memeriksa apakah ada profil, datang berikutnya. <br>  Hasilnya: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Kami berbicara tentang <code>EnvironmentPostProcessor</code> , yang berjalan sebelum <code>ApplicationContextInitializer</code> .  Tapi siapa yang menjalankannya? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  Orang aneh ini memulainya, yang, tampaknya, adalah anak tidak sah dari <code>ApplicationListener</code> dan <code>EnvironmentPostProcessor</code> , karena ia diwarisi dari <code>ApplicationListener</code> dan <code>EnvironmentPostProcessor</code> .  Ini disebut <code>ConfigFileApplicationListener</code> (mengapa "ConfigFile" - tidak ada yang tahu). </p><br><p>  Dia adalah Carlson kita, mis.  Aplikasi Musim Semi menyediakan lingkungan yang disiapkan untuk mendengarkan dua acara: <code>ApplicationPreparedEvent</code> dan <code>ApplicationEnvironmentPreparedEvent</code> .  Kami tidak akan menganalisis siapa yang melempar peristiwa ini sekarang.  Ada satu lapisan lagi (menurut saya itu sudah benar-benar berlebihan, setidaknya pada tahap pengembangan Spring), yang melempar peristiwa bahwa lingkungan mulai dibangun (Application.yml, properti, variabel lingkungan diurai, dll. ) <br>  Setelah menerima <code>ApplicationEnvironmentPreparedEvent</code> , pendengar mengerti bahwa Anda perlu mengonfigurasi lingkungan - temukan semua <code>EnvironmentPostProcessor</code> dan biarkan mereka bekerja. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  Setelah itu, ia memberi tahu <code>SpringFactoriesLoader</code> untuk mengirimkan semua yang Anda pesan, yaitu semua <code>EnvironmentPostProcessor</code> , ke spring.factories.  Kemudian memasukkan seluruh <code>EnvironmentPostProcessor</code> ke dalam satu Daftar. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  dan mengerti bahwa dia juga adalah Proposor <code>EnvironmentPostProcessor</code> (bersamaan), oleh karena itu dia mendorong dirinya sendiri ke sana, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  pada saat yang sama memilah mereka, naik dengan mereka dan memanggil <code>postProcessEnvironment</code> masing-masing metode. </p><br><p>  Dengan cara ini, semua <code>postProcessEnvironment</code> dimulai pada tahap awal sebelum <code>SpringApplicationInitializer</code> .  Dalam hal ini, <code>EnvironmentPostProcessor</code> tidak dapat dipahami yang disebut <code>ConfigFileApplicationListener</code> juga dimulai. </p><br><p>  Ketika lingkungan diatur, semuanya kembali ke Carlson lagi. </p><br><p>  Jika lingkungan sudah siap, Anda dapat membangun konteks.  Dan Carlson mulai membangun konteks dengan <code>ApplicationInitializer</code> .  Di sini kita memiliki karya kita sendiri, yang memeriksa bahwa dalam konteksnya ada lingkungan di mana ada profil aktif.  Jika tidak, kita jatuh, karena kalau tidak kita masih akan memiliki masalah nanti.  Kemudian starter bekerja, dengan semua konfigurasi yang sudah biasa. </p><br><p>  Gambar di atas mencerminkan bahwa Spring juga tidak bekerja dengan baik.  Alien seperti itu bertemu secara berkala di sana, tanggung jawab tunggal tidak dihormati dan Anda perlu naik dengan hati-hati. </p><br><p>  Sekarang kita ingin berbicara sedikit tentang sisi lain makhluk aneh ini, yaitu pendengar di satu sisi dan <code>EnvironmentPostProcessor</code> di sisi lain. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  Seperti <code>EnvironmentPostProcessor</code> ia dapat memuat application.yml, properti aplikasi, semua jenis variabel lingkungan, argumen perintah, dll.  Dan sebagai pendengar, dia dapat mendengarkan dua acara: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  Pertanyaannya adalah: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  Semua peristiwa ini terjadi di musim semi yang lama.  Dan yang kami bicarakan di atas adalah acara dari Spring Boot (acara khusus yang ia tambahkan untuk siklus hidupnya).  Dan ada banyak dari mereka.  Ini adalah yang utama: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  Daftar ini jauh dari semua.  Tetapi penting bahwa beberapa dari mereka berhubungan dengan Spring Boot, dan sebagian lagi ke Spring ( <code>ContextRefreshedEvent</code> , dll.) Yang baik. </p><br><p>  Peringatannya adalah bahwa tidak semua peristiwa ini dapat diterima dalam aplikasi (manusia biasa - nenek yang berbeda - tidak bisa hanya mendengarkan peristiwa kompleks yang dilemparkan Spring Boot).  Tetapi jika Anda tahu tentang mekanisme rahasia spring.factories dan menentukan Pendengar Aplikasi Anda di level spring.factories, maka peristiwa-peristiwa ini dari tahap permulaan aplikasi yang paling awal menghampiri Anda. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  Sebagai hasilnya, Anda dapat memengaruhi awal aplikasi Anda pada tahap yang agak awal.  Leluconnya, bagaimanapun, adalah bagian dari pekerjaan ini dilakukan di entitas lain - seperti <code>EnvironmentPostProcessor</code> dan <code>ApplicationContextInitializer</code> . </p><br><p>  Anda bisa melakukan segalanya dengan pendengar, tetapi itu akan merepotkan dan jelek.  Jika Anda ingin mendengarkan semua acara yang dilemparkan oleh Spring, dan bukan hanya <code>ContextRefreshedEvent</code> dan <code>ContextStartedEvent</code> , maka Anda tidak perlu mendaftarkan pendengar, seperti kacang, dengan cara biasa (jika tidak dibuat terlambat).  Itu juga harus didaftarkan melalui spring.factories, maka itu akan dibuat lebih awal. </p><br><p>  Ngomong-ngomong, ketika kami melihat daftar ini, tidak jelas bagi kami kapan <code>ContextStartedEvent</code> dan <code>ContextStoppedEvent</code> menyala sama sekali? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  Ternyata peristiwa ini tidak pernah berhasil sama sekali.  Kami telah lama bingung tentang peristiwa apa yang harus ditangkap untuk memahami bahwa aplikasi benar-benar dimulai.  Dan ternyata peristiwa yang kita bicarakan sekarang muncul ketika Anda secara paksa menarik metode dari konteks: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  Yaitu  <code>SpringApplication.run</code> hanya akan datang jika kita menjalankan <code>SpringApplication.run</code> , dapatkan konteksnya, tarik <code>ctx.start();</code> darinya <code>ctx.start();</code>  atau <code>ctx.stop();</code>  .  Tidak terlalu jelas mengapa ini perlu.  Tapi, sekali lagi, mereka memberi Anda titik perpanjangan. </p><br><p>  Apakah Spring ada hubungannya dengan ini?  Jika demikian, di suatu tempat harus ada pengecualian: </p><br><ul><li> <code>ctx.stop();</code>  (1) </li><li> <code>ctx.start();</code>  (2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  (4) </li></ul><br><p>  Bahkan, itu akan berada di baris terakhir, karena setelah <code>ctx.close();</code>  tidak ada yang bisa dilakukan dengan konteks.  Tetapi hubungi <code>ctx.stop();</code>  sebelum <code>ctx.start();</code>  - Anda bisa (Spring mengabaikan acara-acara ini - itu hanya untuk Anda). </p><br><p>  Tulis pendengar Anda, dengarkan diri Anda sendiri, buat hukum Anda, apa yang harus dilakukan di <code>ctx.stop();</code>  , dan apa yang harus dilakukan di <code>ctx.start();</code>  . </p><br><p>  Secara total, diagram siklus interaksi dan aplikasi terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  Warna-warna di sini menunjukkan periode kehidupan yang berbeda. </p><br><ul><li>  Biru adalah Spring Boot, aplikasi sudah dimulai.  Ini berarti bahwa permintaan layanan Tomcat yang datang kepadanya dari klien diproses, seluruh konteks pasti dinaikkan, semua kacang berfungsi, basis data terhubung, dll. </li><li>  Hijau - acara <code>ContextRefreshedEvent</code> tiba dan konteksnya dibangun.  Mulai saat ini, misalnya, pendengar aplikasi mulai berfungsi, yang Anda terapkan baik dengan mengatur anotasi ApplicationListener, atau melalui antarmuka eponymous dengan generik yang mendengarkan peristiwa tertentu.  Jika Anda ingin menerima lebih banyak acara, Anda perlu menulis ApplicationListener yang sama di spring.factories (Spring yang biasanya berfungsi di sini).  Bilah menunjukkan di mana laporan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Spring Ripper</a> dimulai. </li><li>  Pada tahap sebelumnya, SpringApplication berfungsi, yang menyiapkan konteks untuk kita.  Ini adalah tugas mempersiapkan aplikasi yang kami lakukan ketika kami adalah pengembang Spring biasa.  Misalnya, mengkonfigurasi WebXML. </li><li>  Tetapi bahkan ada tahapan sebelumnya.  Ini menunjukkan siapa, di mana, dan untuk siapa ia bekerja. </li><li>  Masih ada tahap abu-abu di mana tidak mungkin untuk mengganjal dengan cara apa pun.  Ini adalah tahap di mana SpringApplication kehabisan kotak (hanya masuk ke dalam kode). </li></ul><br><p>  Jika Anda perhatikan, selama laporan dua bagian, kami bergerak dari kanan ke kiri: kami mulai dari awal, mengacaukan konfigurasi yang terbang dari starter, lalu menambahkan yang berikut, dll.  Sekarang mari kita segera berbicara seluruh rantai di arah yang berlawanan. <br>  Anda menulis di <code>SpringApplication.run</code> utama Anda.  Dia menemukan pendengar yang berbeda, melemparkan mereka sebuah acara yang mulai dia bangun.  Setelah itu, pendengar menemukan <code>EnvironmentPostProcessor</code> , biarkan mereka mengkonfigurasi lingkungan.  Setelah lingkungan diatur, kita mulai membangun konteks (Carlson masuk).  Carlson membangun konteks dan memungkinkan semua Penginisialisasi Aplikasi untuk melakukan sesuatu dengan konteks ini.  Kami memiliki titik ekstensi.  Setelah ini, konteksnya sudah dikonfigurasikan dan kemudian hal yang sama mulai terjadi seperti pada aplikasi Musim Semi yang biasa, ketika konteksnya dibangun - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , bean dikonfigurasi.  Inilah yang biasa dilakukan Spring. </p><br><h2>  Bagaimana cara menjalankannya </h2><br><p>  Kami telah selesai membahas proses penulisan aplikasi. </p><br><p>  Tapi kami punya satu hal lagi yang tidak disukai pengembang.  Mereka tidak suka berpikir bagaimana, pada akhirnya, aplikasi mereka akan mulai.  Apakah admin menjalankannya di Tomcat, JBoss atau di WebLogic?  Itu hanya harus bekerja.  Jika tidak berhasil, dalam kasus terburuk, pengembang harus mengkonfigurasi sesuatu lagi </p><br><p>  Jadi apa metode peluncuran kami? </p><br><ul><li>  perang tomcat; </li><li>  ide; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  Tomcat bukan tren massal, kami tidak akan membicarakannya secara rinci. </p><br><p>  Ide pada prinsipnya juga tidak terlalu menarik.  Hanya sedikit lebih rumit daripada yang akan saya katakan di bawah ini.  Namun dalam Idea, pada prinsipnya, seharusnya tidak ada masalah.  Dia melihat ketergantungan seperti apa yang akan dibawa oleh starter. <br>  Jika kita melakukan <code>java -jar</code> , masalah utamanya adalah membangun classpath sebelum kita meluncurkan aplikasi. </p><br><p>  Apa yang dilakukan orang pada tahun 2001?  Mereka menulis <code>java -jar</code> yang jar harus dijalankan, lalu spasi, <code>classpath=...</code> dan skrip ditunjukkan di sana.  Dalam kasus kami, ada 150 MB berbagai dependensi yang ditambahkan permulaan.  Dan semua ini harus dilakukan secara manual.  Tentu, tidak ada yang melakukan itu.  Kami hanya menulis: <code>java -jar</code> , stoples mana yang harus dijalankan dan hanya itu.  Entah bagaimana classpath masih dibangun.  Kami akan membicarakan ini sekarang. </p><br><p>  Mari kita mulai dengan persiapan file jar sehingga bahkan dapat diluncurkan tanpa Tomcat.  Sebelum Anda membuat <code>java -jar</code> , Anda harus membuat toples.  Stoples ini seharusnya tidak biasa, semacam analog perang, di mana semuanya akan berada di dalam, termasuk Tomcat yang tertanam. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  Ketika kami mengunduh proyek, seseorang sudah mendaftarkan plug-in di POM kami.  Di sini, omong-omong, Anda bisa melempar konfigurasi, tetapi lebih lanjut tentang itu nanti.     jar,   Maven  Gradle  ,   jar .      : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>     : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>     war-. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , —    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  Yaitu     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property — <code>Start-class</code> . </p><br><p>  Yaitu       .     class path  jar. ,    — <code>org.springframework.boot</code> —   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     —  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> —   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> —   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   –  mainClass: </p><br><ul><li>     –    .     —     main class; </li><li>    – ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    —  exception   ,    main class,  ,     jar-  .  Yaitu    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  —   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Kamu bisa.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar —  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     — <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  —      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    — <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     —     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   —     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  Kesimpulan </h2><br><p>         ,  Spring Boot —   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring —      Spring Boot.    ,         ,        — , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   —   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Menit periklanan. 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">«          [Joker Edition]»</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">«Micronaut vs Spring Boot,     ?»</a>  .  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id425333/">https://habr.com/ru/post/id425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id425323/index.html">"Lubang kelinci." Desainer UX dalam tim produk</a></li>
<li><a href="../id425325/index.html">Penerjemah Bytecode DIY</a></li>
<li><a href="../id425327/index.html">Pemrograman fungsional: mengukur tujuh kali, potong sekali</a></li>
<li><a href="../id425329/index.html">Beberapa saran untuk generasi milenium dari "oldies." Cara sukses di dunia digital kita</a></li>
<li><a href="../id425331/index.html">Alice akan membantu pengembang menemukan objek dalam permintaan pengguna. NER dalam Dialog</a></li>
<li><a href="../id425335/index.html">Armada Garmin yang tak terkalahkan</a></li>
<li><a href="../id425337/index.html">Bagaimana skala Scrum - beberapa kata tentang kerangka pengembangan gesit Nexus</a></li>
<li><a href="../id425339/index.html">Arsitektur Informasi Internet Bagian 2</a></li>
<li><a href="../id425341/index.html">Tinjauan tentang "Top 3D Expo. Pendidikan Digital 2018 »</a></li>
<li><a href="../id425343/index.html">25 alat Kubernet yang berguna: penyebaran dan manajemen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>