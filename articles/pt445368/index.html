<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôÇÔ∏è üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë© üë®üèº‚Äç‚úàÔ∏è Carregar testando um jogo com algumas centenas de milhares de usu√°rios virtuais üëäüèø üë®üèø‚Äçü§ù‚Äçüë®üèΩ üë®üèø‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 

 Eu trabalho para uma empresa de jogos que desenvolve jogos online. Atualmente, todos os nossos jogos est√£o divididos em muitos "mercados"...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Carregar testando um jogo com algumas centenas de milhares de usu√°rios virtuais</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445368/">  Ol√° Habr! <br><br>  Eu trabalho para uma empresa de jogos que desenvolve jogos online.  Atualmente, todos os nossos jogos est√£o divididos em muitos "mercados" (um "mercado" por pa√≠s) e em cada "mercado" h√° uma d√∫zia de mundos entre os quais os jogadores s√£o distribu√≠dos durante o registro (bem, ou √†s vezes eles mesmos podem escolher).  Cada mundo possui um banco de dados e um ou mais servidores de aplicativos / web.  Assim, a carga √© dividida e distribu√≠da pelos mundos / servidores quase uniformemente e, como resultado, obtemos o m√°ximo on-line de jogadores de 6K-8K (esse √© o m√°ximo, geralmente v√°rias vezes menos) e 200 a 300 solicita√ß√µes por hor√°rio nobre por mundo. <br><br>  Essa estrutura com a divis√£o de players em mercados e mundos est√° se tornando obsoleta; os jogadores querem algo global.  Nos √∫ltimos jogos, paramos de dividir as pessoas por pa√≠s e deixamos apenas um / dois mercados (Am√©rica e Europa), mas ainda com muitos mundos em cada um.  O pr√≥ximo passo ser√° o desenvolvimento de jogos com uma nova arquitetura e a unifica√ß√£o de todos os jogadores em um √∫nico mundo com <b>um banco de dados</b> . <br><br>  Hoje, eu queria falar um pouco sobre como me encarregaram de verificar o que acontece se todo o online (e s√£o de 50 a 200 mil usu√°rios de cada vez) de um de nossos jogos populares "enviar" para jogar o pr√≥ximo jogo baseado na nova arquitetura e se todo o sistema, especialmente o banco de dados ( <b>PostgreSQL 11</b> ), pode suportar praticamente essa carga e, se n√£o puder, descobrir onde est√° o m√°ximo.  Vou falar um pouco sobre os problemas que surgiram e as decis√µes de se preparar para testar tantos usu√°rios, o pr√≥prio processo e um pouco sobre os resultados. <br><a name="habracut"></a><br><h2>  Introdu√ß√£o </h2><br>  No passado, na <b>InnoGames GmbH,</b> cada equipe de jogo criava um projeto de jogo de acordo com o seu gosto e cor, geralmente usando diferentes tecnologias, linguagens de programa√ß√£o e bancos de dados.  Al√©m disso, temos muitos sistemas externos respons√°veis ‚Äã‚Äãpor pagamentos, enviando notifica√ß√µes push, marketing e muito mais.  Para trabalhar com esses sistemas, os desenvolvedores tamb√©m criaram suas interfaces exclusivas da melhor maneira poss√≠vel. <br><br>  Atualmente, no neg√≥cio de jogos para celular, muito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dinheiro</a> e, consequentemente, muita concorr√™ncia.  Aqui √© muito importante recuperar o valor de cada d√≥lar gasto em marketing e um pouco mais acima, portanto, todas as empresas de jogos costumam "fechar" os jogos, mesmo na fase de testes fechados, se n√£o atenderem √†s expectativas anal√≠ticas.  Consequentemente, perder tempo com a inven√ß√£o da pr√≥xima roda n√£o √© rent√°vel, por isso foi decidido criar uma plataforma unificada que fornecer√° aos desenvolvedores uma solu√ß√£o pronta para integra√ß√£o com todos os sistemas externos, um banco de dados com replica√ß√£o e todas as melhores pr√°ticas.  Tudo o que os desenvolvedores precisam √© desenvolver e "colocar" um bom jogo em cima disso e n√£o perder tempo com desenvolvimento n√£o relacionado ao jogo em si. <br><br>  Essa plataforma √© chamada <b>GameStarter</b> : <br><br><img src="https://habrastorage.org/webt/fz/go/g3/fzgog3jsz4rzjqi0zvbwzysz-po.jpeg" alt="imagem"><br><br>  Ent√£o, direto ao ponto.  Todos os futuros jogos da InnoGames ser√£o constru√≠dos nesta plataforma, que possui dois bancos de dados - mestre e jogo (PostgreSQL 11).  O Master armazena informa√ß√µes b√°sicas sobre os jogadores (login, senha, etc.) e participa, principalmente, apenas do processo de login / registro no pr√≥prio jogo.  Jogo - o banco de dados do pr√≥prio jogo, onde, consequentemente, todos os dados e entidades do jogo s√£o armazenados, que √© o n√∫cleo do jogo, para onde toda a carga ir√°. <br>  Assim, surgiu a quest√£o de saber se toda essa estrutura poderia suportar um n√∫mero t√£o potencial de usu√°rios igual ao m√°ximo on-line de um de nossos jogos mais populares. <br><br><h2>  Desafio </h2><br>  A tarefa em si era a seguinte: verificar se o banco de dados (PostgreSQL 11), com a replica√ß√£o ativada, pode suportar toda a carga que atualmente temos no jogo mais carregado, tendo √† sua disposi√ß√£o todo o hipervisor PowerEdge M630 (HV). <br>  Esclarecerei que a tarefa no momento era <b>apenas verificar</b> , usando as configura√ß√µes de banco de dados existentes, que formamos, levando em considera√ß√£o as pr√°ticas recomendadas e nossa pr√≥pria experi√™ncia. <br><br>  Eu direi imediatamente o banco de dados e todo o sistema se mostrou bem, com exce√ß√£o de alguns pontos.  Mas esse projeto de jogo em particular estava no est√°gio de prot√≥tipo e, no futuro, com a complica√ß√£o da mec√¢nica do jogo, as solicita√ß√µes ao banco de dados se tornar√£o mais complicadas e a carga em si poder√° aumentar significativamente e sua natureza poder√° mudar.  Para evitar isso, √© necess√°rio testar iterativamente o projeto com cada marco mais ou menos significativo.  Automatizar a capacidade de executar esses tipos de testes com algumas centenas de milhares de usu√°rios tornou-se a principal tarefa neste est√°gio. <br><br><h2>  Perfil </h2><br>  Como qualquer teste de carga, tudo come√ßa com um perfil de carga. <br>  Nosso valor potencial CCU60 (CCU √© o n√∫mero m√°ximo de usu√°rios por um determinado per√≠odo de tempo, neste caso 60 minutos) √© considerado <b>250.000</b> usu√°rios.  O n√∫mero de usu√°rios virtuais competitivos (VUs) √© menor que o CCU60 e os analistas sugeriram que ele pode ser dividido com seguran√ßa em dois.  Arredonde e aceite <b>150.000</b> VUs competitivas. <br><br>  O n√∫mero total de solicita√ß√µes por segundo foi obtido de um jogo bastante carregado: <br><br><img src="https://habrastorage.org/webt/lv/te/69/lvte69rifceelurn7r3t7trbgs4.png"><br><br>  Assim, nossa carga alvo √© de ~ <b>20.000 solicita√ß√µes / s</b> a <b>150.000</b> VU. <br><br><h2>  Estrutura </h2><br><h3>  Caracter√≠sticas do ‚Äústand‚Äù </h3><br>  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> anterior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">,</a> eu j√° falei sobre como automatizar todo o processo de teste de carga.  Al√©m disso, posso me repetir um pouco, mas vou lhe contar alguns pontos com mais detalhes. <br><br><img src="https://habrastorage.org/webt/zh/hz/eo/zhhzeorw5_gboyuocu9ajmb3ulo.png"><br><br>  No diagrama, os quadrados azuis s√£o nossos hipervisores (HV), uma nuvem composta por muitos servidores (Dell M620 - M640).  Em cada HV, uma d√∫zia de m√°quinas virtuais (VMs) √© lan√ßada via KVM (web / app e db no mix).  Ao criar qualquer nova VM, ocorre o balanceamento e a pesquisa atrav√©s do conjunto de par√¢metros de uma HV adequada, e ainda n√£o se sabe em qual servidor ele estar√°. <br><br><h4>  Banco de Dados (DB do Jogo): </h4><br>  Mas, para nosso prop√≥sito db1, reservamos um <b>targer_hypervisor</b> HV separado <b>com</b> base no M630. <br><br>  Breves caracter√≠sticas do targer_hypervisor: <br><br>  Dell M_630 <br>  Nome do modelo: CPU Intel¬Æ Xeon¬Æ E5-2680 v3 a 2.50GHz <br>  CPU (s): 48 <br>  T√≥pico (s) por n√∫cleo: 2 <br>  N√∫cleo (s) por soquete: 12 <br>  Soquete (s): 2 <br>  RAM: 128 GB <br>  Debian GNU / Linux 9 (esticamento) <br>  4.9.0-8-amd64 # 1 SMP Debian 4.9.130-2 (2018-10-27) <br><br><div class="spoiler">  <b class="spoiler_title">Especifica√ß√µes detalhadas</b> <div class="spoiler_text">  Debian GNU / Linux 9 (esticamento) <br>  4.9.0-8-amd64 # 1 SMP Debian 4.9.130-2 (2018-10-27) <br>  lscpu <br>  Arquitetura: x86_64 <br>  Modo (s) operacional (s) da CPU: 32 bits, 64 bits <br>  Ordem de bytes: Little Endian <br>  CPU (s): 48 <br>  Lista (s) de CPU (s) on-line: 0-47 <br>  T√≥pico (s) por n√∫cleo: 2 <br>  N√∫cleo (s) por soquete: 12 <br>  Soquete (s): 2 <br>  N√≥ (s) NUMA: 2 <br>  ID do fornecedor: GenuineIntel <br>  Fam√≠lia de CPUs: 6 <br>  Modelo: 63 <br>  Nome do modelo: CPU Intel¬Æ Xeon¬Æ E5-2680 v3 a 2.50GHz <br>  Passo: 2 <br>  CPU MHz: 1309.356 <br>  CPU max MHz: 3300.0000 <br>  CPU min MHz: 1200.0000 <br>  BogoMIPS: 4988.42 <br>  Virtualiza√ß√£o: VT-x <br>  Cache L1d: 32K <br>  Cache L1i: 32K <br>  Cache L2: 256K <br>  Cache L3: 30720K <br>  NUMA N√≥0 CPU (s): 0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42 44,46 <br>  CPU (s) NUMA node1: 1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43 , 45,47 <br>  Sinalizadores: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constante qtsopmopcopoptsoptsoptsoptsoptsoptsopts SMX est tm2 SSSE3 sdbg fma CX16 xtpr PDCM PCID dca sse4_1 sse4_2 x2apic movbe POPCNT tsc_deadline_timer aes xsave AVX F16C rdrand lahf_lm ABM EPB invpcid_single SSBD ibrs ibpb stibp Kaiser tpr_shadow vnmi FlexPriority ept VPID fsgsbase tsc_adjust bmi1 AVX2 SMEP bmi2 erms invpcid CQM xsaveopt cqm_llc cqm_occup_llc dtherm IDA arat pln pts flush_l1d <br><br>  / usr / bin / qemu-system-x86_64 --version <br>  Emulador QEMU vers√£o 2.8.1 (Debian 1: 2.8 + dfsg-6 + deb9u5) <br>  Copyright ¬© 2003-2016 Fabrice Bellard e os desenvolvedores do Projeto QEMU <br></div></div><br>  Breves caracter√≠sticas do db1: <br>  Arquitetura: x86_64 <br>  CPU (s): 48 <br>  RAM: 64 GB <br>  4.9.0-8-amd64 # 1 SMP Debian 4.9.144-3.1 (19/02/2019) x86_64 GNU / Linux <br>  Debian GNU / Linux 9 (esticamento) <br>  psql (PostgreSQL) 11.2 (Debian 11.2-1.pgdg90 + 1) <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o do PostgreSQL com algumas explica√ß√µes</b> <div class="spoiler_text">  seq_page_cost = 1.0 <br>  random_page_cost = 1.1 # Temos SSD <br>  inclua '/etc/postgresql/11/main/extension.conf' <br>  log_line_prefix = '% t [% p-% l]% q% u @% h' <br>  log_checkpoints = ativado <br>  log_lock_waits = ativado <br>  log_statement = ddl <br>  log_min_duration_statement = 100 <br>  log_temp_files = 0 <br>  autovacuum_max_workers = 5 <br>  autovacuum_naptime = 10s <br>  autovacuum_vacuum_cost_delay = 20ms <br>  vacuum_cost_limit = 2000 <br>  maintenance_work_mem = 128MB <br>  synchronous_commit = desativado <br>  checkpoint_timeout = 30min <br>  listen_addresses = '*' <br>  work_mem = 32MB <br>  effective_cache_size = 26214MB # 50% de mem√≥ria dispon√≠vel <br>  shared_buffers = 16384MB # 25% de mem√≥ria dispon√≠vel <br>  max_wal_size = 15 GB <br>  min_wal_size = 80MB <br>  wal_level = hot_standby <br>  max_wal_senders = 10 <br>  wal_compression = on <br>  archive_mode = ativado <br>  archive_command = '/ bin / true' <br>  archive_timeout = 1800 <br>  hot_standby = ativado <br>  wal_log_hints = on <br>  hot_standby_feedback = ativado <br></div></div><br>  <b>O</b> padr√£o <b>hot_standby_feedback</b> √© desativado, n√≥s o <b>ativamos</b> , mas mais tarde ele teve que ser desativado para realizar um teste bem-sucedido.  Vou explicar mais tarde o porqu√™. <br><br>  As principais tabelas ativas no banco de dados (constru√ß√£o, produ√ß√£o, game_entity, building, core_inventory_player_resource, survivor) s√£o pr√©-preenchidas com dados (aproximadamente 80 GB) usando um script bash. <br><br><div class="spoiler">  <b class="spoiler_title">db-fill-script.sh</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash --clean TRUNCATE TABLE production CASCADE; TRUNCATE TABLE construction CASCADE; TRUNCATE TABLE building CASCADE; TRUNCATE TABLE grid CASCADE; TRUNCATE TABLE core_inventory_player_resource CASCADE; TRUNCATE TABLE survivor CASCADE; TRUNCATE TABLE city CASCADE; TRUNCATE TABLE game_entity CASCADE; TRUNCATE TABLE player CASCADE; TRUNCATE TABLE core_player CASCADE; TRUNCATE TABLE core_client_device CASCADE; --core_client_device INSERT INTO core_client_device (id, creation_date, modification_date, device_model, device_name, locale, platform, user_agent, os_type, os_version, network_type, device_type) SELECT (1000000000+generate_series(0,999999)) AS id, now(), now(), 'device model', 'device name', 'en_DK', 'ios', 'ios user agent', 'android', '8.1', 'wlan', 'browser'; --core_player INSERT INTO core_player (id, guest, name, nickname, premium_points, soft_deleted, session_id, tracking_device_data_id) SELECT (1000000000+generate_series(0,999999)) AS id, true, 'guest0000000000000000000', null, 100, false, '00000000-0000-0000-0000-000000000000', (1000000000+generate_series(0,999999)) ; --player INSERT INTO player (id, creation_date, modification_date, core_player_id) SELECT (1000000000+generate_series(0,999999)) , now(), now(), (1000000000+generate_series(0,999999)) ; --city INSERT INTO game_entity (id, type, creation_date, modification_date) SELECT (1000000000+generate_series(0,999999)) , 'city', now(), now(); INSERT INTO city (id, game_design, player_id) SELECT (1000000000+generate_series(0,999999)) , 'city.default', (1000000000+generate_series(0,999999)) ; --survivor INSERT INTO game_entity (id, type, creation_date, modification_date) SELECT (1001000000+generate_series(0,999999)) , 'survivor', now(), now(); INSERT INTO survivor (id, game_design, owning_entity_id, type) SELECT (1001000000+generate_series(0,999999)) , 'survivor.prod_1', (1000000000+generate_series(0,999999)) , 'survivor'; --core_inventory_player_resource INSERT INTO core_inventory_player_resource (id, creation_date, modification_date, amount, player_id, resource_key) SELECT (1000000000+generate_series(0,1999999)) , NOW(), NOW(), 1000, (1000000000+generate_series(0,1999999)/2) , CONCAT('resource_', (1000000000+generate_series(0,1999999)) % 2); --grid DROP INDEX grid_area_idx; INSERT INTO grid (id, creation_date, modification_date, area, city_id) SELECT (1000000000+generate_series(0,19999999)) , NOW(), NOW(), BOX '0,0,4,4', (1000000000+generate_series(0,19999999)/20) ; create index on grid using gist (area box_ops); --building INSERT INTO game_entity (id, type, creation_date, modification_date) SELECT (1002000000+generate_series(0,99999999)) , 'building', now(), now(); INSERT INTO building (id, game_design, owning_entity_id, x, y, rotation, type) SELECT (1002000000+generate_series(0,99999999)) , 'building.building_prod_1', (1000000000+generate_series(0,99999999)/100) , 0, 0, 'DEGREES_0', 'building'; --construction INSERT INTO construction (id, creation_date, modification_date, definition, entity_id, start) SELECT (1000000000+generate_series(0,1999999)) , NOW(), NOW(), 'construction.building_prod_1-construction', (1002000000+generate_series(0,1999999)*50) , NOW(); --production INSERT INTO production (id, creation_date, modification_date, active, definition, entity_id, start_time) SELECT (1000000000+generate_series(0,49999999)) , NOW(), NOW(), true, 'production.building_prod_1_production_1', (1002000000+generate_series(0,49999999)*2) , NOW();</span></span></code> </pre> <br></div></div><br>  Replica√ß√£o: <br><br><pre> <code class="plaintext hljs">SELECT * FROM pg_stat_replication; pid | usesysid | usename | application_name | client_addr | client_hostname | client_port | backend_start | backend_xmin | state | sent_lsn | write_lsn | flush_lsn | replay_lsn | write_lag | flush_lag | replay_lag | sync_priority | sync_state -----+----------+---------+---------------------+--------------+---------------------+-------------+-------------------------------+--------------+-----------+------------+------------+------------+------------+-----------------+-----------------+-----------------+---------------+------------ 759 | 17035 | repmgr | xl1db2 | xxxx | xl1db2 | 51142 | 2019-01-27 08:56:44.581758+00 | | streaming | 18/424A9F0 | 18/424A9F0 | 18/424A9F0 | 18/424A9F0 | 00:00:00.000393 | 00:00:00.001159 | 00:00:00.001313 | 0 | async 977 | 17035 | repmgr | xl1db3 |xxxxx | xl1db3 | 42888 | 2019-01-27 08:57:03.232969+00 | | streaming | 18/424A9F0 | 18/424A9F0 | 18/424A9F0 | 18/424A9F0 | 00:00:00.000373 | 00:00:00.000798 | 00:00:00.000919 | 0 | async</code> </pre><br><h4>  Servidor de aplicativos </h4><br>  Em seguida, em HV produtivo (prod_hypervisors) de v√°rias configura√ß√µes e capacidades, foram lan√ßados 15 servidores de aplicativos: 8 n√∫cleos, 4 GB.  A principal coisa a ser dita: openjdk 11.0.1 16/10/2018, primavera, intera√ß√£o com o banco de dados via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hikari</a> (hikari.maximum-pool-size: 50) <br><br><h4>  Ambiente de teste de estresse </h4><br>  Todo o ambiente de teste de carga consiste em um servidor principal <b>admin.loadtest</b> e em v√°rios servidores <b>generatorN.loadtest</b> (nesse caso, havia 14). <br><br>  <b>generatorN.loadtest</b> - VM "bare" Debian Linux 9, com Java 8. instalado 32 kernels / 32 gigabytes.  Eles est√£o localizados no HV "n√£o produtivo", para n√£o prejudicar acidentalmente o desempenho de VMs importantes. <br><br>  <b>admin.loadtest</b> - A <b>m√°quina virtual</b> Debian Linux 9, 16 n√∫cleos / 16 GB, Jenkins, JLTC e outros softwares sem import√¢ncia adicionais trabalham nela. <br><br>  JLTC - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">centro de teste de carga do jmeter</a> .  Um sistema em Py / Django que controla e automatiza o lan√ßamento de testes, bem como a an√°lise de resultados. <br><br><h3>  Esquema de Lan√ßamento de Teste </h3><br><img src="https://habrastorage.org/webt/pb/f_/th/pbf_thx7mwuois96bffvbeehtxk.png"><br><br>  O processo de execu√ß√£o do teste √© assim: <br><br><ul><li>  O teste √© lan√ßado pela <b>Jenkins</b> .  Selecione o trabalho necess√°rio e, em seguida, voc√™ precisar√° inserir os par√¢metros de teste desejados: <ul><li>  <b>DURATION</b> - dura√ß√£o do teste </li><li>  <b>RAMPUP</b> - tempo de aquecimento </li><li>  <b>THREAD_COUNT_TOTAL</b> - o n√∫mero desejado de usu√°rios virtuais (VU) ou threads </li><li>  <b>TARGET_RESPONSE_TIME</b> √© um par√¢metro importante, para n√£o sobrecarregar todo o sistema, definimos o tempo de resposta desejado, para que o teste mantenha a carga em um n√≠vel no qual o tempo de resposta de todo o sistema n√£o exceda o especificado. </li></ul></li><li>  Lan√ßamento </li><li>  Jenkins clona o plano de teste do Gitlab e envia para o JLTC. </li><li>  O JLTC trabalha um pouco com um plano de teste (por exemplo, insere um gravador simples de CSV). </li><li>  O JLTC calcula o n√∫mero necess√°rio de servidores Jmeter para executar o n√∫mero desejado de VUs (THREAD_COUNT_TOTAL). </li><li>  O JLTC se conecta a cada gerador loadgeneratorN e inicia o servidor jmeter. </li></ul><br>  Durante o teste, o <b>cliente JMeter</b> gera um arquivo CSV com os resultados.  Portanto, durante o teste, a quantidade de dados e o tamanho desse arquivo aumentam em um ritmo <b>insano</b> , e n√£o podem ser usados ‚Äã‚Äãpara an√°lise ap√≥s o teste - o <b>Daemon foi</b> inventado (como um experimento), que o analisa <i>"em tempo real"</i> . <br><br><h3>  Plano de teste </h3><br>  Voc√™ pode baixar o plano de teste <a href="">aqui</a> . <br><br>  Ap√≥s o registro / login, os usu√°rios trabalham no m√≥dulo <b>Comportamento</b> , que consiste em v√°rios <b>controladores de taxa</b> de <b>transfer√™ncia</b> que especificam a probabilidade de uma fun√ß√£o espec√≠fica do jogo.  Em cada controlador de taxa de transfer√™ncia, h√° um <b>controlador de m√≥dulo</b> , que se refere ao m√≥dulo correspondente que implementa a fun√ß√£o. <br><br><img src="https://habrastorage.org/webt/t0/ws/qp/t0wsqpbkgo-w6dt55gvxd6aw9pm.png"><br><br><h4>  Fora do t√≥pico </h4><br>  Durante o desenvolvimento do script, tentamos usar o Groovy ao m√°ximo e, gra√ßas ao nosso programador Java, descobri alguns truques para mim (talvez seja √∫til para algu√©m): <br><br><ul><li>  Voc√™ pode declarar uma fun√ß√£o em algum lugar no in√≠cio do plano de teste e us√°-la em outros pr√©, p√≥s-processadores e samplers.  Mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bondade Groovy: Transforme M√©todos em Fechos</a> : <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//     - def sum(Integer x, Integer y) { return x + y } vars.putObject('sum', this.&amp;sum) //      closure.   . //     sampler`       def sum= vars.getObject('sum'); println sum(2, 2);</span></span></code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">groovy.json.JsonSlurper</a> √© um √≥timo analisador JSON r√°pido.  Juntamente com o groovy, ele permite analisar com eleg√¢ncia os dados e process√°-los: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper def canBuild = vars.getObject(canBuild); <span class="hljs-comment"><span class="hljs-comment">// ""       def content = jsonSlurper.parseText(response).content def buildings = content[0].buildings //         //               def constructableBuildingDefs = buildings .collect { k,v -&gt; v } .grep{ it.definitions .grep { it2 -&gt; it2['@type'] == 'type.googleapis.com/ConstructionDefinitionDTO'} .grep { it2 -&gt; canBuild(it2) } //   .size() &gt; 0 } if (!constructableBuildingDefs) { return; } Collections.shuffle(constructableBuildingDefs) //       </span></span></code> </pre></li></ul><br><h3>  VU / Threads </h3><br>  Quando um usu√°rio digita o n√∫mero desejado de VUs usando o par√¢metro THREAD_COUNT_TOTAL ao configurar o trabalho no Jenkins, √© necess√°rio iniciar de alguma forma o n√∫mero necess√°rio de servidores Jmeter e distribuir o n√∫mero final de VUs entre eles.  Esta parte est√° com o JLTC na parte chamada <b>controlador / provis√£o</b> . <br><br>  Em ess√™ncia, o algoritmo √© o seguinte: <br><br><ul><li>  <b>Dividimos</b> o n√∫mero desejado de <b>threads</b> da VU em 200-300 threads e, com base no tamanho mais ou menos adequado <b>-Xmsm -Xmxm,</b> determinamos o valor de mem√≥ria necess√°rio por <i>jmeter-server</i> <b>required_memory_for_jri</b> (JRI - eu chamo a inst√¢ncia remota de Jmeter, em vez de Jmeter-server). </li><li>  Em threads_num e required_memory_for_jri, encontramos o n√∫mero total de jmeter-server: <b>target_amount_jri</b> e o valor total da mem√≥ria <b>necess√°ria</b> : <b>required_memory_total</b> . </li><li>  Classificamos todos os geradores loadgeneratorN um por um e iniciamos o n√∫mero m√°ximo de servidores jmeter com base na mem√≥ria dispon√≠vel nele.  Contanto que o n√∫mero de inst√¢ncias current_amount_jri em execu√ß√£o <b>n√£o</b> seja <b>igual a</b> target_amount_jri. </li><li>  (Se o n√∫mero de geradores e a mem√≥ria total n√£o forem suficientes, adicione um novo ao pool) </li><li>  N√≥s nos conectamos a cada gerador, usando <b>netstat,</b> lembramos de todas as portas ocupadas e executamos em portas aleat√≥rias (desocupadas) o n√∫mero necess√°rio de servidores jmeter: <br><br><pre> <code class="python hljs"> netstat_cmd= <span class="hljs-string"><span class="hljs-string">'netstat -tulpn | grep LISTEN'</span></span> stdin, stdout, stderr = ssh.exec_command(cmd1) used_ports = [] netstat_output = str(stdout.readlines()) ports = re.findall(<span class="hljs-string"><span class="hljs-string">'\d+\.\d+\.\d+\.\d+\:(\d+)'</span></span>, netstat_output) ports_ipv6 = re.findall(<span class="hljs-string"><span class="hljs-string">'\:\:\:(\d+)'</span></span>, netstat_output) p.wait() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ports: used_ports.append(int(port)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ports_ipv6: used_ports.append(int(port)) ssh.close() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, possible_jris_on_host + <span class="hljs-number"><span class="hljs-number">1</span></span>): port = int(random.randint(<span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">20000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> used_ports: port = int(random.randint(<span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">20000</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># ...  Jmeter-    </span></span></code> </pre></li><li>  Coletamos todos os servidores jmeter em execu√ß√£o ao mesmo tempo no endere√ßo de formato: port, por exemplo <b>generator13: 15576, generator9: 14015, generator11: 19152, generator14: 12125, generator2: 17602</b> </li><li>  A lista resultante e threads_per_host s√£o enviados ao cliente JMeter quando o teste √© iniciado: <br><br><pre> <code class="bash hljs">REMOTE_TESTING_FLAG=<span class="hljs-string"><span class="hljs-string">" -R </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$REMOTE_HOSTS_STRING</span></span></span><span class="hljs-string">"</span></span> java -jar -Xms7g -Xmx7g -Xss228k <span class="hljs-variable"><span class="hljs-variable">$JMETER_DIR</span></span>/bin/ApacheJMeter.jar -Jserver.rmi.ssl.disable=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -n -t <span class="hljs-variable"><span class="hljs-variable">$TEST_PLAN</span></span> -j <span class="hljs-variable"><span class="hljs-variable">$WORKSPACE</span></span>/loadtest.log -GTHREAD_COUNT=<span class="hljs-variable"><span class="hljs-variable">$THREADS_PER_HOST</span></span> <span class="hljs-variable"><span class="hljs-variable">$OTHER_VARS</span></span> <span class="hljs-variable"><span class="hljs-variable">$REMOTE_TESTING_FLAG</span></span> -Jjmeter.save.saveservice.default_delimiter=,</code> </pre></li></ul><br>  No nosso caso, o teste foi realizado simultaneamente a partir de 300 servidores Jmeter, 500 threads cada, o formato de inicializa√ß√£o de um servidor Jmeter com par√¢metros Java ficou assim: <br><br><pre> <code class="bash hljs">nohup java -server -Xms1200m -Xmx1200m -Xss228k -XX:+DisableExplicitGC -XX:+CMSClassUnloadingEnabled -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ScavengeBeforeFullGC -XX:+CMSScavengeBeforeRemark -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -Djava.net.preferIPv6Addresses=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -Djava.net.preferIPv4Stack=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -jar <span class="hljs-string"><span class="hljs-string">"/tmp/jmeter-JwKse5nY/bin/ApacheJMeter.jar"</span></span> -Jserver.rmi.ssl.disable=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-string"><span class="hljs-string">"-Djava.rmi.server.hostname=generator12.loadtest.ig.local"</span></span> -Duser.dir=/tmp/jmeter-JwKse5nY/bin/ -Dserver_port=13114 -s -Jpoll=49 &gt; /dev/null 2&gt;&amp;1</code> </pre> <br><h3>  50ms </h3><br>  A tarefa √© determinar o quanto o nosso banco de dados pode suportar, em vez de sobrecarreg√°-lo e todo o sistema como um todo para um estado cr√≠tico.  Com tantos servidores Jmeter, voc√™ precisa, de alguma forma, manter a carga em um determinado n√≠vel e n√£o matar o sistema inteiro.  O par√¢metro <b>TARGET_RESPONSE_TIME</b> especificado ao iniciar o teste √© respons√°vel por isso.  Concordamos que 50 <b>ms</b> √© o tempo de resposta ideal pelo qual o sistema deve ser respons√°vel. <br><br>  No JMeter, por padr√£o, existem muitos timers diferentes que permitem controlar a taxa de transfer√™ncia, mas n√£o se sabe onde obt√™-la no nosso caso.  Mas existe o <b>JSR223-Timer</b> com o qual voc√™ pode criar algo usando o <b>tempo de resposta atual do</b> sistema.  O cron√¥metro est√° no bloco principal de <b>comportamentos</b> : <br><br><img src="https://habrastorage.org/webt/uv/o8/rb/uvo8rb9ph7mr1xhxkzxccsfa06a.png"><br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//      = 0 vars.put('samples', '20'); vars.putObject('respAvg', ${TARGET_RESPONSE_TIME}.0); vars.putObject('sleep', 0.0); //  JSR223-Timer           "" double sleep = vars.getObject('sleep'); double respAvg = vars.getObject('respAvg'); double previous = sleep; double target = ${TARGET_RESPONSE_TIME}; if (respAvg &lt; target) { sleep /= 1.5; } if (respAvg &gt; target) { sleep *= 1.1; } sleep = Math.max(10, sleep); //      sleep = Math.min(20000, sleep); vars.putObject('sleep', sleep); return (int)sleep;</span></span></code> </pre><br><h3>  An√°lise dos resultados (daemon) </h3><br>  Al√©m dos gr√°ficos em Grafana, tamb√©m √© necess√°rio ter resultados de teste agregados para que os testes possam ser comparados posteriormente no JLTC. <br><br>  Um desses testes gera solicita√ß√µes de 16 a 20k por segundo, √© f√°cil calcular que em 4 horas gera um arquivo CSV com algumas centenas de GB de tamanho, por isso foi necess√°rio criar um trabalho que analise dados a cada minuto, envie-o para o banco de dados e limpe o arquivo principal. <br><br><img src="https://habrastorage.org/webt/pb/mj/kc/pbmjkcwgjcxupnihgzpzmqd0nvq.png"><br><br>  O algoritmo √© o seguinte: <br><br><ul><li>  Lemos os dados do arquivo CSV <b>result.jtl</b> gerado pelo jmeter-client, salvamos e limpamos o arquivo (voc√™ precisa limp√°-lo corretamente, caso contr√°rio, o arquivo vazio se parecer√° com o FD antigo do mesmo tamanho): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(jmeter_results_file, <span class="hljs-string"><span class="hljs-string">'r+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: rows = f.readlines() f.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>) f.truncate(<span class="hljs-number"><span class="hljs-number">0</span></span>) f.writelines(rows[<span class="hljs-number"><span class="hljs-number">-1</span></span>])</code> </pre></li><li>  Escrevemos os dados lidos no arquivo tempor√°rio <b>temp_result.jtl</b> : <br><br><pre> <code class="python hljs">rows_num = len(rows) open(temp_result_filename, <span class="hljs-string"><span class="hljs-string">'w'</span></span>).writelines(rows[<span class="hljs-number"><span class="hljs-number">0</span></span>:rows_num]) <span class="hljs-comment"><span class="hljs-comment"># avoid last line</span></span></code> </pre> </li><li>  Lemos o arquivo <b>temp_result.jtl</b> .  Distribu√≠mos os dados lidos "em minutos": <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> f.readlines(): row = r.split(<span class="hljs-string"><span class="hljs-string">','</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(row[<span class="hljs-number"><span class="hljs-number">0</span></span>]) == <span class="hljs-number"><span class="hljs-number">13</span></span>: ts_c = int(row[<span class="hljs-number"><span class="hljs-number">0</span></span>]) dt_c = datetime.datetime.fromtimestamp(ts_c/<span class="hljs-number"><span class="hljs-number">1000</span></span>) minutes_data.setdefault(dt_c.strftime(<span class="hljs-string"><span class="hljs-string">'%Y_%m_%d_%H_%M'</span></span>), []).append(r)</code> </pre></li><li>  Os dados para cada minuto de <b>minutes_data s√£o</b> gravados no arquivo correspondente na pasta <b>to_parse /</b> .  (assim, no momento, cada minuto do teste tem seu pr√≥prio arquivo de dados, durante a agrega√ß√£o <b>,</b> n√£o importa em que ordem os dados foram inseridos em cada arquivo): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> minutes_data.iteritems(): <span class="hljs-comment"><span class="hljs-comment">#      timestamp (key) temp_ts_file = os.path.join(temp_to_parse_path, key) open(temp_ts_file, 'a+').writelines(value)</span></span></code> </pre></li><li>  Ao longo do caminho, analisamos os arquivos na pasta to_parse e, se algum deles n√£o foi alterado em um minuto, esse arquivo √© candidato √† an√°lise, agrega√ß√£o e envio de dados ao banco de dados JLTC: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> filename <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(temp_to_parse_path): data_file = os.path.join(temp_to_parse_path, filename) file_mod_time = os.stat(data_file).st_mtime last_time = (time.time() - file_mod_time) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> last_time &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>: logger.info(<span class="hljs-string"><span class="hljs-string">'[DAEMON] File {} was not modified since 1min, adding to parse list.'</span></span>.format(data_file)) files_to_parse.append(data_file)</code> </pre></li><li>  Se houver esses arquivos (um ou v√°rios), ent√£o os enviaremos analisados ‚Äã‚Äãpara a fun√ß√£o <b>parse_csv_data</b> (cada arquivo em paralelo): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> files_to_parse: logger.info(<span class="hljs-string"><span class="hljs-string">'[DAEMON THREAD] Parse {}.'</span></span>.format(f)) t = threading.Thread( target=parse_csv_data, args=( f, jmeter_results_file_fields, test, data_resolution)) t.start() threads.append(t) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> threads: t.join()</code> </pre></li></ul><br>  O pr√≥prio daemon no cron.d √© iniciado a cada minuto: <br><br>  daemon inicia a cada minuto com cron.d: <br><br><pre> <code class="bash hljs">* * * * * root sleep 21 &amp;&amp; /usr/bin/python /var/lib/jltc/manage.py daemon</code> </pre> <br>  Assim, o arquivo com os resultados n√£o aumenta para tamanhos inconceb√≠veis, mas √© analisado <i>em tempo real</i> e limpo. <br><br><h2>  Resultados </h2><br><h3>  O aplicativo </h3><br>  Nossos 150.000 jogadores virtuais: <br><br><img src="https://habrastorage.org/webt/sv/ex/ep/svexepi9ikzy0unpxur96mty5q8.png"><br><br>  O teste tenta "igualar" o tempo de resposta de 50ms, para que a pr√≥pria carga salte constantemente na regi√£o entre 16k-18k solicita√ß√µes / c: <br><br><img src="https://habrastorage.org/webt/-z/98/oi/-z98oi-_8a41hkqbrmz2rvzmryk.png"><br><br>  Carga do servidor de aplicativos (15 app).  Dois servidores s√£o ‚Äúazarados‚Äù por estarem no M620 mais lento: <br><br><img src="https://habrastorage.org/webt/nc/xy/et/ncxyetqyk_a8mbhjocndd-yxgkm.png"><br><br>  Tempo de resposta do banco de dados (para servidores de aplicativos): <br><br><img src="https://habrastorage.org/webt/zr/a-/gw/zra-gwtq_vqhtfhlrjzzy1osisg.png"><br><br><h3>  Banco de Dados </h3><br>  Utilit√°rio de CPU no db1 (VM): <br><br><img src="https://habrastorage.org/webt/ej/hn/in/ejhnin0jo_7rrzhlj7pqko6udnq.png"><br><br>  Utilit√°rio de CPU no hipervisor: <br><br><img src="https://habrastorage.org/webt/uw/ik/tz/uwiktzvcdzydlsjaoexqfbr3tay.png"><br><br>  A carga na m√°quina virtual √© menor, pois acredita que possui 48 n√∫cleos reais √† sua disposi√ß√£o; na verdade, existem 24 n√∫cleos de <b>hyperthreading</b> no hypervisor. <br><br>  Um <b>m√°ximo de ~ 250K consultas / s</b> vai para o banco de dados, consistindo em (83% seleciona, 3% - inser√ß√µes, 11,6% - atualiza√ß√µes (90% HOT), 1,6% exclui): <br><br><img src="https://habrastorage.org/webt/lx/lu/bl/lxlublobhm4nm3c45g9jikcstc4.png"><br><br><img src="https://habrastorage.org/webt/18/jw/gp/18jwgpmebrkyot3ngvarsl_3ysu.png"><br><br>  Com um valor padr√£o de <b>autovacuum_vacuum_scale_factor</b> = 0.2, o n√∫mero de tuplas mortas cresceu muito rapidamente com o teste (com tamanhos de tabela cada vez maiores), o que levou v√°rias vezes a problemas curtos de desempenho do banco de dados que arruinaram o teste inteiro v√°rias vezes.  Eu tive que "domesticar" esse crescimento para algumas tabelas atribuindo valores pessoais a esse par√¢metro autovacuum_vacuum_scale_factor: <br><br><div class="spoiler">  <b class="spoiler_title">ALTER TABLE ... SET (autovacuum_vacuum_scale_factor = ...)</b> <div class="spoiler_text">  Constru√ß√£o ALTER TABLE SET (autovacuum_vacuum_scale_factor = 0.10); <br>  ALTER TABLE produ√ß√£o SET (autovacuum_vacuum_scale_factor = 0.01); <br>  ALTER TABLE game_entity SET (autovacuum_vacuum_scale_factor = 0.01); <br>  ALTER TABLE game_entity SET (autovacuum_analyze_scale_factor = 0.01); <br>  ALTER TABLE criando SET (autovacuum_vacuum_scale_factor = 0.01); <br>  ALTER TABLE criando SET (autovacuum_analyze_scale_factor = 0.01); <br>  ALTER TABLE SET core_inventory_player_resource SET (autovacuum_vacuum_scale_factor = 0.10); <br>  ALTER TABLE sobrevivente SET (autovacuum_vacuum_scale_factor = 0,01); <br>  ALTER TABLE sobrevivente SET (autovacuum_analyze_scale_factor = 0,01); <br></div></div><br><img src="https://habrastorage.org/webt/0s/ja/1e/0sja1e1m3-2gitbmhh8j24t2ktu.png"><br><br>  Idealmente, o n√∫mero de linhas_fetch deve estar pr√≥ximo do n√∫mero de linhas_retornado, o que felizmente observamos: <br><br><img src="https://habrastorage.org/webt/e4/k6/zo/e4k6zobp25h5asrmxhmficoea3a.png"><br><br><h4>  hot_standby_feedback </h4><br>  O problema estava no par√¢metro <b>hot_standby_feedback</b> , que pode afetar bastante o desempenho do servidor <b>principal</b> se os servidores em <b>espera</b> n√£o tiverem tempo para aplicar altera√ß√µes nos arquivos WAL.  A documenta√ß√£o (https://postgrespro.ru/docs/postgrespro/11/runtime-config-replication) afirma que "determina se o servidor de espera ativa notificar√° o mestre ou escravo superior sobre as solicita√ß√µes que est√° executando atualmente".  Por padr√£o, est√° desativado, mas foi ativado em nossa configura√ß√£o.  O que levou a consequ√™ncias tristes: se houver dois servidores em espera e o atraso na replica√ß√£o durante o carregamento for diferente de zero (por v√°rios motivos), voc√™ poder√° observar uma imagem como essa, que pode levar ao colapso de todo o teste: <br><br><img src="https://habrastorage.org/webt/vl/1l/jd/vl1ljdockxrjlfsoiybq751vo9y.png"><br><br><img src="https://habrastorage.org/webt/qh/4s/m_/qh4sm_hpnunb2w0axzhk90lmf6u.png"><br><br>  Isso ocorre porque quando hot_standby_feedback est√° ativado, o VACUUM n√£o deseja excluir tuplas mortas se os servidores em espera estiverem atrasados ‚Äã‚Äãem seu ID de transa√ß√£o, a fim de evitar conflitos de replica√ß√£o.  Artigo detalhado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que hot_standby_feedback no PostgreSQL realmente faz</a> : <br><br><pre> <code class="plaintext hljs">xl1_game=# VACUUM VERBOSE core_inventory_player_resource; INFO: vacuuming "public.core_inventory_player_resource" INFO: scanned index "core_inventory_player_resource_pkey" to remove 62869 row versions DETAIL: CPU: user: 1.37 s, system: 0.58 s, elapsed: 4.20 s ‚Ä¶‚Ä¶‚Ä¶... INFO: "core_inventory_player_resource": found 13682 removable, 7257082 nonremovable row versions in 71842 out of 650753 pages &lt;b&gt;DETAIL: 3427824 dead row versions cannot be removed yet, oldest xmin: 3810193429&lt;/b&gt; There were 1920498 unused item pointers. Skipped 8 pages due to buffer pins, 520953 frozen pages. 0 pages are entirely empty. CPU: user: 4.55 s, system: 1.46 s, elapsed: 11.74 s.</code> </pre><br>  Um n√∫mero t√£o grande de tuplas mortas leva √† imagem mostrada acima.  Aqui est√£o dois testes, com hot_standby_feedback ativado e desativado: <br><br><img src="https://habrastorage.org/webt/8f/od/n6/8fodn60lohgzsu-twheqysldjzy.png"><br><br>  E este √© o nosso atraso de replica√ß√£o durante o teste, com o qual ser√° necess√°rio fazer algo no futuro: <br><br><img src="https://habrastorage.org/webt/et/s0/7h/ets07hkl8skkv5wexxjrgi-3x7m.png"><br><br><h2>  Conclus√£o </h2><br>  Felizmente, este teste (ou infelizmente para o conte√∫do do artigo) mostrou que, nesta fase do prot√≥tipo do jogo, √© poss√≠vel sobrecarregar a carga desejada por parte dos usu√°rios, o que √© suficiente para dar luz verde para prototipagem e desenvolvimento adicionais.  Nos est√°gios subseq√ºentes do desenvolvimento, √© necess√°rio seguir as regras b√°sicas (para manter a simplicidade das consultas executadas, evitar uma superabund√¢ncia de √≠ndices, al√©m de leituras n√£o indexadas etc.) e, o mais importante, testar o projeto em cada est√°gio significativo do desenvolvimento para encontrar e corrigir problemas. pode ser mais cedo.  Talvez em breve escreverei um artigo, pois j√° resolvemos problemas espec√≠ficos. <br><br>  Boa sorte a todos! <br><br>  Nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> apenas no caso;) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445368/">https://habr.com/ru/post/pt445368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445356/index.html">Vis√£o geral da se√ß√£o M√≥vel no DUMP-2019: m√°ximo aplicado e √∫til no trabalho di√°rio</a></li>
<li><a href="../pt445358/index.html">Organiza√ß√£o do sistema de eventos no Unity - atrav√©s dos olhos de um designer de jogos</a></li>
<li><a href="../pt445360/index.html">5 tarefas t√≠picas para entrevistas em JavaScript: an√°lise e solu√ß√µes</a></li>
<li><a href="../pt445362/index.html">O livro "Sistemas Distribu√≠dos. Padr√µes de Design</a></li>
<li><a href="../pt445366/index.html">Como acelerar a criptografia de acordo com GOST 28147-89 no processador Baikal-T1 devido ao bloco SIMD</a></li>
<li><a href="../pt445370/index.html">An√°lise TSDB em Prometheus 2</a></li>
<li><a href="../pt445372/index.html">Vis√£o de m√°quina versus intui√ß√£o humana: algoritmos para interromper a opera√ß√£o de programas de reconhecimento de objetos</a></li>
<li><a href="../pt445378/index.html">Labirintos: classifica√ß√£o, gera√ß√£o, busca de solu√ß√µes</a></li>
<li><a href="../pt445380/index.html">PHP moderno √© bonito e produtivo</a></li>
<li><a href="../pt445384/index.html">Miss√£o Chang'e-4 - equipamento cient√≠fico no m√≥dulo de aterragem e no sat√©lite repetidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>