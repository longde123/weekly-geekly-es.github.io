<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµüèª üë®üèª‚Äçüíª üë©üèº‚Äçüè≠ Python3. Automatisation de la configuration des √©quipements r√©seau multi-fournisseurs üìò üé∂ üë®üèæ‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Bonne journ√©e √† tous! 

 Je travaille en tant qu'ing√©nieur r√©seau pour un grand op√©rateur de t√©l√©communications, et sous mon contr√¥le il y a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python3. Automatisation de la configuration des √©quipements r√©seau multi-fournisseurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415453/"><h4>  Pr√©face </h4><br>  Bonne journ√©e √† tous! <br><br>  Je travaille en tant qu'ing√©nieur r√©seau pour un grand op√©rateur de t√©l√©communications, et sous mon contr√¥le il y a tout un zoo de divers √©quipements r√©seau, mais nous parlerons de commutateurs d'acc√®s. <br><br>  Cet article n'est pas un guide d'action, ce n'est pas la seule solution et ne pr√©tend clairement pas √™tre un sc√©nario de la nomination de l'ann√©e, mais je veux partager cette cr√©ation, et peut-√™tre qu'elle sera utile √† quelqu'un. <br><br>  L'article fournira un bloc de code sous le spoiler, et ci-dessous sera une description avec des coupures et des explications sur la raison pour laquelle il en est ainsi et √† quoi il sert. <br><br><h4>  D√©fi </h4><br>  Utilisez python3 sp√©cifiquement.  Le script doit pouvoir acc√©der aux commutateurs √† partir de la liste, d√©terminer le type de fournisseur, donner la commande requise, enregistrer. <br><br><h4>  En fait, comment je suis arriv√© √† cela </h4><br>  Face √† un petit probl√®me de changement de configuration sur un grand nombre de commutateurs, je vais tout de suite faire une r√©serve sur le syst√®me d'administration centralis√©e des √©quipements r√©seau dont nous disposons, de nombreux d√©veloppements de mes coll√®gues sous forme de scripts pour faciliter le travail manuel sont √©galement disponibles, principalement bash, perl. <br><br>  Mais pour moi, il √©tait important de faire quelque chose de diff√©rent, car  J'ai commenc√© √† apprendre le python r√©cemment et je dois am√©liorer mes comp√©tences en programmation, et mon outil devrait ressembler √† un marteau (facile √† utiliser et facile √† entretenir).  Si l'int√©r√™t persiste, je demande un chat. <br><a name="habracut"></a><br>  Googler et ne pas trouver la bonne solution (comme si sur les forums cette question √©tait pos√©e, mais tout allait mal l√†-bas), j'ai d√©cid√© de commencer √† √©crire mon propre script. <br><br>  Nous avons les commutateurs suivants: <br><br><ul><li>  Raisecom </li><li>  Qtech rev.  1.0 </li><li>  Qtech rev.  2.0 (diff√©rence de syntaxe) </li><li>  Eltex </li><li>  Lien D </li><li>  Spawn Frankenstein switch avec un museau de Qtech rev 1.0, et du fer de Raisecom nous l'appellerons ROS </li></ul><br>  Tout d'abord, importez les biblioth√®ques requises: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pexpect <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telnet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess</code> </pre> <br>  Dans un premier temps, nous d√©crivons la fonction de d√©finition du fournisseur, car  a d√©cid√© d'utiliser deux m√©thodes: <br><br>  1) Supposons de quel type de fournisseur il s'agit (√† l'invitation √† entrer la connexion) car j'ai remarqu√© que c'est diff√©rent pour tout le monde: Qtech (connexion :), Raisecom et ROS (Connexion :), Eltex (Nom d'utilisateur :), D-link (Nom d'utilisateur). <br><br>  2) apr√®s la connexion - assurez-vous que le premier √©l√©ment a √©t√© effectu√© sans erreur et pour une meilleure identification de l'interrupteur sur lequel nous sommes. <br><br><div class="spoiler">  <b class="spoiler_title">Fonction</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">who_is</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' #  a = 'Serial No.:1405' # #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') #  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus</span></span></code> </pre> <br></div></div><br>  Toute la fonction est sous le spoiler.  Nous d√©clarons des variables globales qui seront visibles par l'ensemble du script: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> ver_status <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> sab_versus <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> versus</code> </pre> <br>  les variables a, d, f, h, j, k, n stockent les mots-cl√©s par lesquels nous d√©terminerons par la suite le mod√®le du commutateur. <br><br><pre> <code class="python hljs">a = <span class="hljs-string"><span class="hljs-string">'Serial No.:1405'</span></span> <span class="hljs-comment"><span class="hljs-comment"># #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0</span></span></code> </pre> <br>  Apr√®s avoir ouvert le fichier ver.txt, nous le lisons ligne par ligne et v√©rifions l'entr√©e par mots-cl√©s, car  la fonction find () renvoie -1 si ce r√©sultat est n√©gatif, et nous allons construire des branches. <br><br><pre> <code class="python hljs">parser=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/ver.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0'</span></span></code> </pre> <br>  ... <br><br>  Je donne un exemple de partie du code, le reste sous le spoiler ci-dessus. <br><br>  Le contenu de ce fichier sera d√©crit ci-dessous.  Apr√®s toutes les manipulations et la d√©finition du fournisseur, supprimez le fichier ver.txt. <br><br><div class="spoiler">  <b class="spoiler_title">D√©claration des variables principales, corps de la boucle principale</b> <div class="spoiler_text"><pre> <code class="python hljs">user=<span class="hljs-string"><span class="hljs-string">'user'</span></span> password=<span class="hljs-string"><span class="hljs-string">'password'</span></span> komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>) <span class="hljs-comment"><span class="hljs-comment">######### counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 counter_qtech1_0=0 counter_qtech2_0=0 ########## for host in komm.readlines(): print('connect....',host) vend = '' response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ######################################################### if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ...</span></span></code> </pre> <br></div></div><br>  J'ai d√©cid√© de ne pas d√©ranger et de d√©finir les variables avec le nom d'utilisateur et le mot de passe dans le corps, je sais que ce n'est pas de la s√©curit√©, je travaille dessus. <br><br>  Ouvrez le fichier pour les journaux et la liste des commutateurs <br><br><pre> <code class="python hljs">komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>)</code> </pre> <br>  Apr√®s avoir utilis√© la boucle for, lisez la ligne avec l'adresse IP du commutateur <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komm.readlines(): print(<span class="hljs-string"><span class="hljs-string">'connect....'</span></span>,host) vend = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br>  Nous v√©rifions sa disponibilit√© <br><br><pre> <code class="python hljs">response = os.system(<span class="hljs-string"><span class="hljs-string">'ping -c 1 '</span></span> + host)</code> </pre> <br>  S'il est accessible √† l'aide de la biblioth√®que pexpect, nous essayons de nous connecter via telnet ici √† cette it√©ration et la premi√®re v√©rification √† l'invitation a lieu, dont j'ai parl√© au d√©but. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response == <span class="hljs-number"><span class="hljs-number">0</span></span>: telnet = pexpect.spawn(<span class="hljs-string"><span class="hljs-string">'telnet '</span></span> + host,timeout=<span class="hljs-number"><span class="hljs-number">40</span></span>) vend = telnet.expect([<span class="hljs-string"><span class="hljs-string">'login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'User Name:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Username'</span></span>]) telnet.close() tn = Telnet(host.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre><br>  La variable vend obtiendra une valeur de 0 √† 3 inclus, et en fonction de l'invite de connexion qu'elle voit, une autre branche sera form√©e. <br><br>  √Ä partir de ce morceau de code, un lecteur attentif peut remarquer que je fais une connexion au commutateur et ferme imm√©diatement la connexion, et ce n'est pas sans raison.  J'ai essay√© d'utiliser uniquement la biblioth√®que telnetlib, mais lors du premier test, le script se bloquait et tombait p√©riodiquement par timeout, et cette b√©quille m'aide beaucoup. <br><br>  Apr√®s avoir ferm√© la connexion, nous ne nous reconnectons qu'en utilisant d√©j√† la biblioth√®que telnetlib. <br><br>  Afin d'√©viter de tomber des erreurs, nous avons d√©j√† v√©rifi√© ci-dessus que le commutateur est accessible, et excluons l'interruption du script pendant le fonctionnement en raison d'un commutateur inactif, enveloppez tout dans un essai sauf le bloc. <br><br>  Il y a eu des cas r√©p√©t√©s o√π sur 100 commutateurs, un ne s'est pas laiss√© entrer. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Ok'</span></span>+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: print(<span class="hljs-string"><span class="hljs-string">'connection refused'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) f = open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>) print(host, <span class="hljs-string"><span class="hljs-string">'connection refused'</span></span>, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, host, file=log)</code> </pre> <br>  ... <br>  Si tout va bien et que nous sommes connect√©s, nous devons saisir un nom d'utilisateur et un mot de passe, <br>  nous savons avec certitude que toute invite de deux points utilise un deux-points. <br><br>  Nous l'attendons donc <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br>  Apr√®s avoir entr√© la connexion <br><br><pre> <code class="python hljs">tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  En attente de deux points du mot de passe <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br>  Entrez le mot de passe <br><br><pre> <code class="python hljs">tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Et nous attendons 3 secondes (r√©pit, sinon nous avons fait tellement de travail) <br><br><pre> <code class="python hljs">time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br>  Apr√®s avoir attendu l'invitation <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br>  Ici, √† ce stade, nous passons au deuxi√®me niveau pour v√©rifier le fournisseur. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-comment"><span class="hljs-comment">#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre> <br>  Parce que  nous avons suppos√© que nous sommes arriv√©s √† Qtech, et si vous lisez attentivement, alors dans notre zoo, il existe deux versions de qtech qui diff√®rent dans la syntaxe, nous devons encore nous r√©concilier. <br><br>  Par cons√©quent, nous donnons la commande show ver, mettons toute la sortie dans le fichier ver.txt <br>  et appelez la proc√©dure who_is (), que j'ai d√©crite ci-dessus.  L'√©quipe show ver est universelle pour tous les Qtech, Raisecom, Eltex, <br><br>  Malheureusement, D-link ne comprend pas et il doit dire montrer swich, mais nous sommes intelligents et n'avons pas vainement introduit une it√©ration avec la d√©finition suppos√©e d'un fournisseur. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-comment"><span class="hljs-comment">#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre><br>  Donc, imm√©diatement, une petite remarque apr√®s avoir entr√© show swich, le commutateur affiche des informations incompl√®tes et attend que l'utilisateur appuie sur n'importe quelle touche pour une sortie suppl√©mentaire, et donc nous envoyons ensuite le caract√®re "a" pour afficher des informations compl√®tes. <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'a'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Pour √©viter cela, vous pouvez d√©sactiver le clipadding <br><br>  C'est l√† que la v√©rification du fournisseur se termine et avec une probabilit√© de 99%, nous pouvons supposer que nous avons correctement identifi√© le mod√®le du commutateur et que nous pouvons proc√©der √† la configuration. <br><br>  Pour chaque commutateur, nous avons un fichier s√©par√© avec un ensemble de commandes. <br><br><div class="spoiler">  <b class="spoiler_title">Bloc de configuration</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> ver_status == <span class="hljs-string"><span class="hljs-string">'qtech_rev_1.0'</span></span>: tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log) counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span> komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.write((<span class="hljs-string"><span class="hljs-string">'exit'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print(tn.read_all().decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), file=log) print(<span class="hljs-string"><span class="hljs-string">'   qtech1.0'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Qtech rev1.0 '</span></span> + host, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, file=log) <span class="hljs-comment"><span class="hljs-comment">################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') print('   qtech2.0') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ...</span></span></code> </pre><br></div></div><br>  Une fois que la fonction a fonctionn√© et renvoy√© la variable ver_status, nous pouvons continuer √† travailler avec la branche, car  nous savons exactement quel commutateur est actuellement en ligne. <br>  Tout d'abord, nous donnons au commutateur la commande show ver et √©crivons la sortie dans le journal (√† propos de d-link, rappelez-vous que nous lui donnons la commande sh sw) <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log)</code> </pre> <br>  Assurez-vous de garder des compteurs pour identifier les non-conformit√©s. <br><pre> <code class="python hljs">counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Nous ouvrons un fichier avec des commandes <br><pre> <code class="python hljs">komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>)</code> </pre> <br>  L'ordre des commandes dans le fichier doit √™tre le m√™me que l'administrateur les saisirait manuellement <br><br>  Un exemple: <br><br> <code>conf <br> vlan 2525 <br> name SPD <br> int ethe 1/1 <br> sw mode access <br> sw acc vl 2525 <br> exit <br> exit <br> save <br> y <br></code> <br>  Ensuite, tout est conforme au sc√©nario - nous lisons le fichier jusqu'√† la fin des lignes et nous les ex√©cutons <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Apr√®s avoir quitt√© la boucle, nous indiquons la sortie du commutateur et lisons toutes les sorties dans un fichier, et donc nous ne le faisons qu'avec qtech1.0, car  parfois un script colle en pr√©vision de quelque chose et c'est avec ce switch, pour ne pas faire d'histoires, cette solution me paraissait plus √©l√©gante. <br><br>  Une fois le commutateur configur√©, nous augmentons le compteur total d'une unit√©. <br><br><pre> <code class="python hljs">counter_komm+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Et nous recommen√ßons, lisons la ligne suivante du fichier avec les commutateurs, d√©terminons le mod√®le et r√©alisons la configuration. <br><br>  Apr√®s avoir quitt√© le cycle principal, vous devez faire un r√©sum√© du travail effectu√©, <br>  √† la fin du journal, nous entrons tous les mod√®les que nous avons trait√©s et la date est obligatoire, eh bien, comment pourrait-il en √™tre sans. <br><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">'\n\n\n : '</span></span>, counter_komm,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n\nD-link:'</span></span>, counter_dlink,<span class="hljs-string"><span class="hljs-string">'\nQtech ver1.0:'</span></span>, counter_qtech1_0,<span class="hljs-string"><span class="hljs-string">'\nROS:'</span></span>, counter_ROS,<span class="hljs-string"><span class="hljs-string">'\nRaisecom:'</span></span>,counter_raisecom,<span class="hljs-string"><span class="hljs-string">'\nEltex:'</span></span>, counter_eltex,<span class="hljs-string"><span class="hljs-string">'\nQtech ver2.0 :'</span></span>, counter_qtech2_0,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n: '</span></span>, datetime.datetime.now().isoformat(),<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'#'</span></span>*<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-string"><span class="hljs-string">'\n\n\n\n\n'</span></span>,file=log) verinfo.close() log.close()</code> </pre> <br>  Ce script a √©t√© trait√© √† plusieurs reprises et le processus ne s'arr√™tera pas l√†. <br>  Merci √† tous pour votre attention.  La critique constructive est la bienvenue. <br><br>  Tout le code sous le spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Code source</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 #22/06/2017 17:17 import telnetlib import time import os import sys import getpass import pexpect from telnetlib import Telnet import datetime import subprocess def who_is(): #     ,      . global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' a = 'Serial No.:1405' # #qtech rev1 #b = 'Serial No.:3922' # #qtech rev2 #c = 'Serial No.:5436' # #qtech rev2 #l = 'Serial No.:16101' # #qtech rev2 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') for line in parser.readlines(): line1 = line.find(a) #line2 = line.find(b) #line3 = line.find(c) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) #line9 = line.find(l) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' #if line2 != -1 or line3 != -1 or line9 !=-1: #ver_status='qtech_rev_2.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus user='user' password='password' komm=open('servers_&amp;_log/komm.txt') log=open('servers_&amp;_log/log.txt','a') counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 # counter_qtech1_0=0 counter_qtech2_0=0 for host in komm.readlines(): print('connect....',host) vend = '' #tn = Telnet(host.replace('\n', ''), 23, 20) response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ################################################################################ if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 1: #   Raisecom,Raisecom-Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 2:#   Eltex tn.write(('show system' + '\n').encode('ascii')) tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 3:#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() # ###  # ################################################################################ if ver_status == 'd-link': tn.read_until(b'#', timeout=20) tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('D-link ' + host,file=log) print('#'*100,file=log) counter_dlink+=1 ################################################################################ elif ver_status == 'qtech_rev_1.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech1_0+=1 komand_qtech1_0=open('servers_&amp;_log/komand_qtech_ver1.0.txt') for kommand in komand_qtech1_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) #print((tn.read_until(b'#').decode('ascii')), file=log) tn.write(('exit' + '\n').encode('ascii')) print(tn.read_all().decode('ascii'), file=log) print('Qtech rev1.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) time.sleep(1) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'raisecom-qtech': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('ROS '+ host,file=log) print('#'*100,file=log) counter_ROS+=1 ################################################################################ elif ver_status == 'raisecom': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_raisecom+=1 raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print(host, ':', 'RAISECOM', file=log) print('#' * 100, host, file=log) ################################################################################ elif ver_status == 'eltex': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) eltex_command=open('servers_&amp;_log/komand_eltex.txt') for komand in eltex_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Eltex ' + host, file=log) print('#' * 100, file=log) counter_eltex+=1 else: print('no ping') counter_komm+=1 print('\n\n\n : ', counter_komm,file=log) print('\n\nD-link:', counter_dlink,'\nQtech ver1.0:', counter_qtech1_0,'\nROS:', counter_ROS,'\nRaisecom:',counter_raisecom,'\nEltex:', counter_eltex,'\nQtech ver2.0 :', counter_qtech2_0,file=log) print('\n: ', datetime.datetime.now().isoformat(),'\n', '#'*100,'\n\n\n\n\n',file=log) verinfo.close() log.close()</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415453/">https://habr.com/ru/post/fr415453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415441/index.html">Aux √âtats-Unis, les attaques de ransomwares contre les agences gouvernementales se multiplient</a></li>
<li><a href="../fr415443/index.html">MDG et ITMO University invitent √† l'√©cole d'√©t√© d'apprentissage automatique</a></li>
<li><a href="../fr415445/index.html">Le condens√© des √©v√©nements pour les professionnels des RH dans le domaine des TI pour juillet 2018</a></li>
<li><a href="../fr415447/index.html">La sortie du jeton utilitaire est une impasse</a></li>
<li><a href="../fr415451/index.html">Biostar Racing P1: de facile √† complexe</a></li>
<li><a href="../fr415455/index.html">Demandez √† Ethan: pouvons-nous faire un √©cran solaire pour lutter contre le changement climatique?</a></li>
<li><a href="../fr415457/index.html">Preuve trouv√©e de l'existence d'une nouvelle particule fondamentale</a></li>
<li><a href="../fr415459/index.html">Les chinois ont-ils des superstitions?</a></li>
<li><a href="../fr415461/index.html">OpenAI progresse dans Dota 2: d√©faite d'√©quipes semi-professionnelles</a></li>
<li><a href="../fr415463/index.html">HPE Superdome Flex: un nouveau niveau de performances et de mise √† l'√©chelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>