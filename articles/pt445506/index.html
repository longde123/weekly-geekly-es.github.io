<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèæ üì® üëêüèª OS1: kernel primitivo no Rust para x86 ü§ù üí≥ ‚òùüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Decidi escrever um artigo e, se poss√≠vel, uma s√©rie de artigos para compartilhar minha experi√™ncia de pesquisa independente do dispositivo Bare Bone x...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OS1: kernel primitivo no Rust para x86</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445506/"><p>  Decidi escrever um artigo e, se poss√≠vel, uma s√©rie de artigos para compartilhar minha experi√™ncia de pesquisa independente do dispositivo Bare Bone x86 e da organiza√ß√£o de sistemas operacionais.  No momento, meu hack n√£o pode nem ser chamado de sistema operacional - √© um pequeno kernel que pode inicializar a partir do Multiboot (GRUB), gerenciar mem√≥ria real e virtual e tamb√©m executar v√°rias fun√ß√µes in√∫teis no modo multitarefa em um √∫nico processador. </p><br><p>  Durante o desenvolvimento, eu n√£o me propus a escrever um novo Linux (embora, admito, tenha sonhado com isso h√° 5 anos) ou impressionar algu√©m, por isso pe√ßo que voc√™ n√£o pare√ßa mais particularmente impressionado.  O que eu realmente queria fazer era descobrir como a arquitetura i386 funciona no n√≠vel mais b√°sico, e como exatamente os sistemas operacionais fazem sua m√°gica, e desenterrar o hype Rust. </p><br><p> Nas minhas anota√ß√µes, tentarei compartilhar n√£o apenas os textos de origem (eles podem ser encontrados no GitLab) e a teoria b√°sica (pode ser encontrada em muitos recursos), mas tamb√©m o caminho que percorri para encontrar respostas n√£o √≥bvias.  Especificamente, neste artigo, falarei sobre como <strong>criar um arquivo do kernel, carreg√°-lo e inicializ√°-lo</strong> . </p><br><p>  Meus objetivos s√£o estruturar as informa√ß√µes na minha cabe√ßa e ajudar aqueles que seguem um caminho semelhante.  Entendo que materiais e blogs semelhantes j√° est√£o na rede, mas, para chegar √† minha situa√ß√£o atual, tive que reuni-los por um longo tempo.  Todas as fontes (de qualquer forma, das quais me lembro), compartilharei agora. </p><a name="habracut"></a><br><h1 id="literatura-i-istochniki">  Literatura e Fontes </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Obviamente</a> , obtive a maior parte do excelente recurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OSDev</a> , tanto no wiki quanto no f√≥rum.  Em segundo lugar, vou nomear Philip Opperman com seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog</a> - muitas informa√ß√µes sobre o monte de ferrugem e ferro. </p><br><p>  Alguns pontos s√£o espionados no kernel do Linux, o Minix n√£o est√° sem a ajuda de literatura especial, como o livro de Tanenbaum, ‚Äú <em>Sistemas Operacionais.</em>  <em>Design e implementa√ß√£o</em> ‚Äù <em>,</em> livro de Robert Love‚Äú <em>O Linux Kernel.</em>  <em>Descri√ß√£o do processo de desenvolvimento</em> . ‚Äù  Quest√µes dif√≠ceis sobre a organiza√ß√£o da arquitetura x86 foram resolvidas usando o manual ‚Äú <em>Manual do desenvolvedor de software das arquiteturas Intel 64 e IA-32, Volume 3 (3A, 3B, 3C e 3D): Guia de programa√ß√£o do sistema</em> ‚Äù.  No entendimento do formato dos bin√°rios, os layouts s√£o guias para ld, llvm, nm, nasm, make. <br>  UPD  Agrade√ßo ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">CoreTeamTech</a> por me lembrar do maravilhoso sistema Redox OS.  Eu n√£o sa√≠ de sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fonte</a> .  Infelizmente, o sistema oficial do GitLab n√£o est√° dispon√≠vel no IP russo, para que voc√™ possa ver o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . </p><br><h1 id="esche-odno-predislovie">  Outro Pref√°cio </h1><br><p>  Sei que n√£o sou um bom programador em Rust, al√©m disso, este √© o meu primeiro projeto nesse idioma (n√£o √© a melhor maneira de come√ßar a namorar, certo?).  Portanto, a implementa√ß√£o pode parecer completamente incorreta para voc√™ - com anteced√™ncia, quero pedir clem√™ncia ao meu c√≥digo e ficarei feliz em comentar e sugest√µes.  Se um leitor respeitado puder me dizer onde e como seguir em frente, tamb√©m ficarei muito agradecido.  Alguns fragmentos de c√≥digo podem ser copiados dos tutoriais como est√£o e levemente modificados, mas tentarei dar explica√ß√µes t√£o claras quanto poss√≠vel a essas se√ß√µes, para que voc√™ n√£o tenha as mesmas perguntas que eu tinha ao analis√°-las.  Tamb√©m n√£o pretendo usar as abordagens corretas no design; portanto, se meu gerenciador de mem√≥ria faz com que voc√™ queira escrever coment√°rios irritados, entendo o porqu√™. </p><br><h1 id="instrumentariy">  Toolkit </h1><br><p>  Ent√£o, vou come√ßar mergulhando nas ferramentas de desenvolvimento que usei.  Como ambiente, escolhi um bom e conveniente editor de c√≥digo VS com plug-ins para Rust e um depurador GDB.  √Äs vezes, o c√≥digo VS n√£o √© muito bom com o RLS, especialmente ao redefini-lo em um diret√≥rio espec√≠fico; portanto, ap√≥s cada atualiza√ß√£o noturna do Rust, era necess√°rio reinstalar o RLS. </p><br><p>  A ferrugem foi escolhida por v√°rias raz√µes.  Em primeiro lugar, sua crescente popularidade e filosofia agrad√°vel.  Em segundo lugar, sua capacidade de trabalhar com um n√≠vel baixo, mas com uma menor probabilidade de "dar um tiro no pr√≥prio p√©".  Em terceiro lugar, como um amante de Java e Maven, sou muito viciado em criar sistemas e gerenciamento de depend√™ncias, e a carga j√° est√° incorporada na linguagem de ferramentas.  Quarto, eu s√≥ queria algo novo, n√£o como C. </p><br><p>  Para c√≥digo de baixo n√≠vel, usei o NASM, como  Sinto-me confiante na sintaxe da Intel e tamb√©m me sinto √† vontade trabalhando com suas diretrizes.  Eu deliberadamente abandonei as inser√ß√µes do assembler no Rust para separar explicitamente o trabalho com ferro e l√≥gica de alto n√≠vel. <br>  A Make e o vinculador do suprimento LLVM LLD (como vinculador mais r√°pido e melhor) foram usados ‚Äã‚Äãcomo montagem e layout geral - isso √© uma quest√£o de gosto.  Era poss√≠vel fazer scripts de constru√ß√£o para carga. </p><br><p>  O Qemu foi usado para iniciar - eu gosto da velocidade, do modo interativo e da capacidade de conectar o GDB.  Para inicializar e ter imediatamente todas as informa√ß√µes de hardware - √© claro que o GRUB (Legacy √© mais f√°cil de organizar o cabe√ßalho, ent√£o pegue). </p><br><h1 id="linkovka-i-komponovka">  Link e layout </h1><br><p>  Curiosamente, para mim, esse acabou sendo um dos t√≥picos mais dif√≠ceis.  Ap√≥s um longo per√≠odo de teste com registros de segmento x86, ficou extremamente dif√≠cil perceber que segmentos e se√ß√µes n√£o s√£o a mesma coisa.  Na programa√ß√£o para o ambiente existente, n√£o h√° necessidade de pensar em como colocar o programa na mem√≥ria - para cada plataforma e formato, o vinculador j√° possui uma receita pronta, portanto, n√£o h√° necessidade de escrever um script de vinculador. </p><br><p>  Para o ferro nu, pelo contr√°rio, √© necess√°rio indicar como colocar e endere√ßar o c√≥digo do programa na mem√≥ria.  Aqui, quero enfatizar que estamos falando de um endere√ßo linear (virtual) usando o mecanismo de p√°gina.  O OS1 usa um mecanismo de p√°gina, mas vou me debru√ßar sobre ele separadamente na se√ß√£o correspondente do artigo. </p><br><div class="spoiler">  <b class="spoiler_title">L√≥gico, linear, virtual, f√≠sico ...</b> <div class="spoiler_text"><p>  Endere√ßos l√≥gicos, lineares, virtuais e f√≠sicos.  Eu quebrei minha cabe√ßa nessa quest√£o, ent√£o, pelos detalhes que quero abordar neste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">excelente artigo</a> </p></div></div><br><p>  Para sistemas operacionais que usam pagina√ß√£o, em um ambiente de 32 bits, cada tarefa possui 4 GB de espa√ßo de mem√≥ria endere√ß√°vel, mesmo se voc√™ tiver 128 MB de RAM instalados.  Isso acontece apenas devido √† organiza√ß√£o de pagina√ß√£o da mem√≥ria; a aus√™ncia de p√°ginas na mem√≥ria principal √© tratada de acordo. </p><br><p>  No entanto, na realidade, os aplicativos geralmente est√£o dispon√≠veis um pouco menos que 4 GB.  Isso ocorre porque o sistema operacional deve lidar com interrup√ß√µes, chamadas do sistema, o que significa que pelo menos seus manipuladores devem estar nesse espa√ßo de endere√ßo.  Estamos diante da pergunta: onde exatamente nesses 4 GB os endere√ßos do kernel devem ser colocados para que os programas funcionem corretamente? </p><br><p>  No mundo moderno dos programas, esse conceito √© usado: cada tarefa acredita que reina supremamente sobre o processador e √© o √∫nico programa em execu√ß√£o no computador (neste est√°gio, n√£o estamos falando de comunica√ß√£o entre processos).  Se voc√™ observar exatamente como os compiladores coletam programas no est√°gio de vincula√ß√£o, acontece que eles come√ßam com um endere√ßo linear de zero ou quase zero.  Isso significa que, se a imagem do kernel ocupar um espa√ßo de mem√≥ria pr√≥ximo de zero, os programas montados dessa maneira n√£o podem ser executados, qualquer instru√ß√£o jmp no programa levar√° √† entrada na mem√≥ria protegida do kernel e a um erro de prote√ß√£o.  Portanto, se quisermos usar n√£o apenas programas auto-escritos no futuro, √© razo√°vel fornecer ao aplicativo o m√°ximo de mem√≥ria poss√≠vel perto de zero e colocar a imagem do kernel mais alta. </p><br><p>  Esse conceito √© chamado de metade superior do kernel (aqui eu o refiro ao osdev.org, se voc√™ quiser informa√ß√µes relacionadas).  Qual peda√ßo de mem√≥ria escolher depende apenas do seu apetite.  512 MB √© suficiente para algu√©m, mas eu decidi comprar 1 GB, ent√£o meu kernel est√° localizado em 3 GB + 1 MB (√© necess√°rio + 1 MB para atender aos limites de mem√≥ria mais altos, o GRUB nos carrega na mem√≥ria f√≠sica ap√≥s 1 MB) . <br>  Tamb√©m √© importante especificar o ponto de entrada para o nosso arquivo execut√°vel.  Para o meu execut√°vel, essa ser√° a fun√ß√£o _loader escrita em assembler, na qual abordarei mais detalhadamente na pr√≥xima se√ß√£o. </p><br><div class="spoiler">  <b class="spoiler_title">Sobre ponto de entrada</b> <div class="spoiler_text"><p>  Voc√™ sabia que mentiu a vida toda sobre o fato de que main () √© o ponto de entrada para o programa?  De fato, main () √© uma conven√ß√£o da linguagem C e das linguagens geradas por ela.  Se voc√™ cavar, acontece algo como o seguinte. </p><br><p>  Primeiramente, cada plataforma possui sua pr√≥pria especifica√ß√£o e nome de ponto de entrada: para linux, geralmente √© _start, para Windows, √© mainCRTStartup.  Em segundo lugar, esses pontos podem ser redefinidos, mas n√£o funcionar√£o para usar as del√≠cias da libc.  Terceiro, o compilador fornece esses pontos de entrada por padr√£o e eles est√£o nos arquivos crt0..crtN (CRT-C RunTime, N - n√∫mero de argumentos principais). </p><br><p>  Na verdade, o que compiladores como gcc ou vc fazem - eles selecionam um script de link espec√≠fico da plataforma que define um ponto de entrada padr√£o, selecionam o arquivo de objeto desejado com a fun√ß√£o de inicializa√ß√£o de inicializa√ß√£o C pronta e chamam a fun√ß√£o principal e vinculam a sa√≠da na forma de um arquivo do formato desejado com um ponto de entrada padr√£o. </p><br><p>  Portanto, para nossos prop√≥sitos, o ponto de entrada padr√£o e a inicializa√ß√£o do CRT devem ser desativados, pois n√£o temos absolutamente nada al√©m de ferro puro. </p></div></div><br><p>  O que mais voc√™ precisa saber para vincular?  Como ser√£o localizadas as se√ß√µes de dados (.rodata, .data), vari√°veis ‚Äã‚Äãn√£o inicializadas (.bss, comum) e tamb√©m lembre-se de que o GRUB exige a localiza√ß√£o de cabe√ßalhos de inicializa√ß√£o m√∫ltipla nos primeiros 8 KB do bin√°rio. </p><br><p>  Ent√£o agora podemos escrever um script vinculador! </p><br><pre><code class="plaintext hljs">ENTRY(_loader) OUTPUT_FORMAT(elf32-i386) SECTIONS { . = 0xC0100000; .text ALIGN(4K) : AT(ADDR(.text) - 0xC0000000) { *(.multiboot1) *(.multiboot2) *(.text) } .rodata ALIGN(4K) : AT(ADDR(.rodata) - 0xC0000000) { *(.rodata*) } .data ALIGN (4K) : AT(ADDR(.data) - 0xC0000000) { *(.data) } .bss : AT(ADDR(.bss) - 0xC0000000) { _sbss = .; *(COMMON) *(.bss) _ebss = .; } }</code> </pre> <br><h1 id="zagruzka-posle-grub">  Download ap√≥s o GRUB </h1><br><p>  Como mencionado acima, a especifica√ß√£o de inicializa√ß√£o m√∫ltipla exige que o cabe√ßalho esteja nos primeiros 8 KB da imagem de inicializa√ß√£o.  A especifica√ß√£o completa pode ser vista <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , mas vou me concentrar apenas nos detalhes de interesse. </p><br><ul><li>  O alinhamento de 32 bits (4 bytes) deve ser respeitado </li><li>  Deve haver um n√∫mero m√°gico 0x1BADB002 </li><li>  √â necess√°rio informar ao multibooter quais informa√ß√µes queremos receber e como colocar os m√≥dulos (no meu caso, quero que o m√≥dulo do kernel seja alinhado em uma p√°gina de 4 KB e tamb√©m receba um cart√£o de mem√≥ria para economizar tempo e esfor√ßo) </li><li>  Forne√ßa uma soma de verifica√ß√£o (soma de verifica√ß√£o + n√∫mero m√°gico + sinalizadores devem dar zero) </li></ul><br><pre> <code class="plaintext hljs">MB1_MODULEALIGN equ 1&lt;&lt;0 MB1_MEMINFO equ 1&lt;&lt;1 MB1_FLAGS equ MB1_MODULEALIGN | MB1_MEMINFO MB1_MAGIC equ 0x1BADB002 MB1_CHECKSUM equ -(MB1_MAGIC + MB1_FLAGS) section .multiboot1 align 4 dd MB1_MAGIC dd MB1_FLAGS dd MB1_CHECKSUM</code> </pre> <br><p>  Ap√≥s a inicializa√ß√£o, o Multiboot garante algumas condi√ß√µes que devemos considerar. </p><br><ul><li>  O registro EAX cont√©m o n√∫mero m√°gico 0x2BADB002, que indica que o download foi bem-sucedido </li><li>  O registro EBX cont√©m o endere√ßo f√≠sico da estrutura com informa√ß√µes sobre os resultados do carregamento (falaremos sobre isso mais adiante) </li><li>  O processador est√° no modo protegido, a mem√≥ria da p√°gina √© desativada, os registradores de segmento e a pilha est√£o em um estado indefinido (para n√≥s), o GRUB os usou para suas necessidades e precisa ser redefinido o mais r√°pido poss√≠vel. </li></ul><br><p>  A primeira coisa que precisamos fazer √© ativar a pagina√ß√£o, ajustar a pilha e, finalmente, transferir o controle para o c√≥digo Rust de alto n√≠vel. <br>  N√£o vou me deter em detalhes na organiza√ß√£o das p√°ginas da mem√≥ria, no Diret√≥rio de p√°ginas e na Tabela de p√°ginas, porque excelentes artigos foram escritos sobre isso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um deles</a> ).  A principal coisa que quero compartilhar √© que as p√°ginas n√£o s√£o segmentos!  Por favor, n√£o repita meu erro e n√£o carregue o endere√ßo da tabela de p√°ginas no GDTR!  Para a tabela de p√°ginas √© CR3!  A p√°gina pode ter um tamanho diferente em arquiteturas diferentes. Para simplificar o trabalho (para ter apenas uma tabela de p√°ginas), escolhi um tamanho de 4 MB devido √† inclus√£o do PSE. </p><br><p>  Ent√£o, queremos ativar a mem√≥ria da p√°gina virtual.  Para fazer isso, precisamos de uma tabela de p√°ginas e seu endere√ßo f√≠sico carregados no CR3.  Ao mesmo tempo, nosso arquivo bin√°rio foi vinculado para funcionar em um espa√ßo de endere√ßo virtual com um deslocamento de 3 GB.  Isso significa que todos os endere√ßos e r√≥tulos vari√°veis ‚Äã‚Äãt√™m um deslocamento de 3 GB.  A tabela de p√°ginas √© apenas uma matriz na qual o endere√ßo da p√°gina cont√©m seu endere√ßo real, alinhado ao tamanho da p√°gina, bem como sinalizadores de acesso e status.  Como uso p√°ginas de 4 MB, preciso apenas de uma tabela de p√°ginas PD com 1024 entradas: </p><br><pre> <code class="plaintext hljs">section .data align 0x1000 BootPageDirectory: dd 0x00000083 times (KERNEL_PAGE_NUMBER - 1) dd 0 dd 0x00000083 times (1024 - KERNEL_PAGE_NUMBER - 1) dd 0</code> </pre> <br><p>  O que h√° na mesa? </p><br><ol><li>  A primeira p√°gina deve levar √† se√ß√£o atual do c√≥digo (0 a 4 MB de mem√≥ria f√≠sica), pois todos os endere√ßos no processador s√£o f√≠sicos e a convers√£o para virtual ainda n√£o foi realizada.  A aus√™ncia deste descritor de p√°gina levar√° a uma falha imediata, pois o processador n√£o poder√° seguir as pr√≥ximas instru√ß√µes depois de ativar as p√°ginas.  Sinalizadores: bit 0 - a tabela est√° presente, bit 1 - a p√°gina est√° escrita, bit 7 - tamanho da p√°gina 4 MB.  Depois de ligar as p√°ginas, o registro √© redefinido. </li><li>  Pule at√© 3 GB - zeros garantem que a p√°gina n√£o esteja na mem√≥ria </li><li>  A marca de 3 GB √© o nosso n√∫cleo na mem√≥ria virtual, referenciando 0 na mem√≥ria f√≠sica.  Depois de virar as p√°ginas, trabalharemos aqui.  Os sinalizadores s√£o semelhantes ao primeiro registro. </li><li>  Pule at√© 4 GB. </li></ol><br><p>  Ent√£o, declaramos a tabela e agora queremos carregar seu endere√ßo f√≠sico no CR3.  N√£o se esque√ßa do deslocamento de endere√ßo de 3 GB no est√°gio de vincula√ß√£o.  Tentar carregar o endere√ßo como ele est√° nos enviar√° para o endere√ßo real de 3 GB + deslocamento vari√°vel e levar√° a uma falha imediata.  Portanto, pegamos o endere√ßo do BootPageDirectory e subtra√≠mos 3 GB dele, colocando-o no CR3.  Ativamos o PSE no registro CR4, ativamos o trabalho com as p√°ginas no registro CR0: </p><br><pre> <code class="plaintext hljs"> mov ecx, (BootPageDirectory - KERNEL_VIRTUAL_BASE) mov cr3, ecx mov ecx, cr4 or ecx, 0x00000010 mov cr4, ecx mov ecx, cr0 or ecx, 0x80000000 mov cr0, ecx</code> </pre> <br><p>  At√© agora, tudo est√° indo bem, mas assim que redefinirmos a primeira p√°gina para finalmente chegar √† metade superior de 3 GB, tudo entrar√° em colapso, porque o registro EIP ainda tem um endere√ßo f√≠sico na regi√£o do primeiro megabyte.  Para consertar isso, realizamos uma manipula√ß√£o simples: coloque uma marca no local mais pr√≥ximo, carregue seu endere√ßo (ele j√° est√° com um deslocamento de 3 GB, lembre-se disso) e fa√ßa um salto incondicional por ele.  Depois disso, uma p√°gina desnecess√°ria pode ser redefinida para aplicativos futuros. </p><br><pre> <code class="plaintext hljs"> lea ecx, [StartInHigherHalf] jmp ecx StartInHigherHalf: mov dword [BootPageDirectory], 0 invlpg [0]</code> </pre> <br><p>  Agora √© tudo muito pequeno: inicialize a pilha, passe a estrutura do GRUB e o montador √© suficiente! </p><br><pre> <code class="plaintext hljs"> mov esp, stack+STACKSIZE push eax push ebx lea ecx, [BootPageDirectory] push ecx call kmain hlt section .bss align 32 stack: resb STACKSIZE</code> </pre> <br><p>  O que voc√™ precisa saber sobre esse trecho de c√≥digo: </p><br><ol><li>  De acordo com a conven√ß√£o C de chamadas (tamb√©m √© aplic√°vel ao Rust), as vari√°veis ‚Äã‚Äãs√£o transferidas para a fun√ß√£o atrav√©s da pilha na ordem inversa.  Todas as vari√°veis ‚Äã‚Äãs√£o alinhadas por 4 bytes em x86. </li><li>  A pilha cresce a partir do final, portanto, o ponteiro para a pilha deve levar ao final da pilha (adicione STACKSIZE ao endere√ßo).  O tamanho da pilha que peguei foi de 16 KB, deve ser suficiente. </li><li>  O seguinte √© transferido para o kernel: o n√∫mero m√°gico da inicializa√ß√£o m√∫ltipla, o endere√ßo f√≠sico da estrutura do gerenciador de inicializa√ß√£o (existe um cart√£o de mem√≥ria valioso para n√≥s), o endere√ßo virtual da tabela de p√°ginas (em um espa√ßo de 3 GB) </li></ol><br><p>  Al√©m disso, n√£o se esque√ßa de declarar que o kmain √© externo e o _loader √© global. </p><br><h1 id="dalneyshie-shagi">  Passos adicionais </h1><br><p>  Nas notas a seguir, falarei sobre a configura√ß√£o de registros de segmentos, examinarei brevemente a sa√≠da de informa√ß√µes atrav√©s de um buffer VGA, mostrarei como organizei o trabalho com interrup√ß√µes, gerenciamento de p√°ginas e a coisa mais doce - multitarefa - que deixarei para a sobremesa. </p><br><p>  O c√≥digo completo do projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° dispon√≠vel no GitLab</a> . </p><br><p>  Obrigado pela aten√ß√£o! </p><br><p>  UPD2: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2</a> <br>  UPD2: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445506/">https://habr.com/ru/post/pt445506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445488/index.html">M√¥nadas do ponto de vista dos programadores (e um pouco da teoria das categorias)</a></li>
<li><a href="../pt445494/index.html">Como o fragmento de marca√ß√£o CSS quebrou o compilador C ++</a></li>
<li><a href="../pt445496/index.html">Como o fragmento de marca√ß√£o CSS quebrou o compilador C ++</a></li>
<li><a href="../pt445500/index.html">Sobre distribui√ß√µes abertas, c√≥digo-fonte aberto e el√°stico</a></li>
<li><a href="../pt445504/index.html">Gerenciamento de servi√ßos de TI (ITSM) tornado mais eficiente com as ferramentas de aprendizado de m√°quina</a></li>
<li><a href="../pt445510/index.html">Gerenciando expectativas ou dizendo n√£o</a></li>
<li><a href="../pt445512/index.html">Como criamos o PHP 7 duas vezes mais r√°pido que o PHP 5. Parte 2: otimizando o bytecode no PHP 7.1</a></li>
<li><a href="../pt445514/index.html">O mais interessante na exposi√ß√£o Securika Moscow 2019</a></li>
<li><a href="../pt445516/index.html">Estados Qu√¢nticos Neurais - Representa√ß√£o de uma fun√ß√£o de onda por uma rede neural</a></li>
<li><a href="../pt445518/index.html">Ferro velho: ferramentas eletr√¥nicas perdidas nas profundezas da hist√≥ria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>