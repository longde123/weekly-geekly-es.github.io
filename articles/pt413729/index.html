<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ß üèöÔ∏è üë©üèæ‚Äç‚úàÔ∏è Como e por que escrevemos nosso ECS üçç üë®üèΩ‚Äçüöí üåÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em um artigo anterior, descrevi as tecnologias e abordagens que usamos ao desenvolver um novo jogo de tiro em dispositivos m√≥veis. Porque foi uma revi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como e por que escrevemos nosso ECS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/413729/">  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior,</a> descrevi as tecnologias e abordagens que usamos ao desenvolver um novo jogo de tiro em dispositivos m√≥veis.  Porque  foi uma revis√£o e at√© um artigo superficial - hoje vou aprofundar e explicar detalhadamente por que decidimos escrever nossa pr√≥pria estrutura de ECS e n√£o usamos as existentes.  Haver√° exemplos de c√≥digo e um pequeno b√¥nus no final. <br><img src="https://habrastorage.org/webt/qn/lg/zw/qnlgzwthwpjkkzzeeilv257iiga.png"><br><a name="habracut"></a><br><h3>  O que √© o ECS como exemplo </h3><br>  Eu j√° descrevi brevemente o que √© o Sistema de Componentes de Entidades e existem artigos no Habr√© sobre o ECS (basicamente, no entanto, tradu√ß√µes de artigos - veja minha revis√£o dos mais interessantes no final do artigo, como um b√¥nus).  E hoje vou falar sobre como usamos o ECS - usando nosso exemplo de c√≥digo. <br><br>  O diagrama acima descreve a ess√™ncia do <i>Player</i> , seus componentes e seus dados, e os sistemas que funcionam com o Player e seus componentes.  O principal objeto do diagrama √© o player: <br><br><ul><li>  pode se mover no espa√ßo - Componentes de <i>transforma√ß√£o</i> e <i>movimento</i> , <i>MoveSystem</i> ; </li><li>  tem alguma sa√∫de e pode morrer - componente <i>Health</i> , <i>Damage</i> , <i>DamageSystem</i> ; </li><li>  ap√≥s a morte aparecer no ponto de respawn - o componente <i>Transform</i> da posi√ß√£o, o <i>RespawnSystem</i> ; </li><li>  pode ser invulner√°vel - componente <i>invenc√≠vel</i> . </li></ul><br>  N√≥s descrevemos isso com um c√≥digo.  Primeiro, vamos obter interfaces para componentes e sistemas.  Os componentes podem ter m√©todos auxiliares comuns, o sistema possui apenas um m√©todo <i>Execute</i> , que recebe o estado do mundo na entrada para processamento: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-comment"><span class="hljs-comment">// &lt; &gt; } public interface ISystem { void Execute(GameState gs); }</span></span></code> </pre> <br>  Para componentes, criamos classes stub usadas pelo nosso gerador de c√≥digo para convert√™-las em c√≥digo de componente realmente usado.  Vamos pegar alguns espa√ßos em branco para <i>Sa√∫de</i> , <i>Dano</i> e <i>Invenc√≠vel</i> (para o restante dos componentes ser√° semelhante). <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> { [Max(<span class="hljs-number"><span class="hljs-number">1000</span></span>)] <span class="hljs-comment"><span class="hljs-comment">//  -  1000 public int Hp; // -   public Health(int hp) {} } [Component] public class Damage { [DontSend] //      ,      public uint Amount; // -  public Entity Victim; //    public Entity Source; //    public Damage(uint amount, Entity victim, Entity source) {} } [Component] public class Invincible //   ,  ,    { }</span></span></code> </pre> <br>  Os componentes determinam o estado do mundo, portanto, eles cont√™m apenas dados, sem m√©todos.  Ao mesmo tempo, n√£o h√° dados no <i>Invincible</i> , eles s√£o usados ‚Äã‚Äãna l√≥gica como um sinal de invulnerabilidade - se a ess√™ncia do jogador tiver esse componente, ele ser√° invulner√°vel. <br><br>  O atributo <i>Component</i> √© usado pelo gerador para encontrar as classes em branco para os componentes.  Os <i>atributos</i> <i>Max</i> e <i>DontSend</i> s√£o necess√°rios como dicas ao serializar e reduzir o tamanho do estado do mundo transmitido pela rede ou salvo no disco.  Nesse caso, o servidor n√£o serializa o campo <i>Valor</i> e o envia pela rede (porque os clientes n√£o usam esse par√¢metro, ele √© necess√°rio apenas no servidor).  E o campo <i>Hp</i> pode ser bem empacotado em v√°rios bits, considerando o valor m√°ximo de integridade. <br><br>  Tamb√©m temos uma classe <i>pr√©-fabricada de Entidade</i> , na qual adicionamos informa√ß√µes sobre todos os componentes poss√≠veis de qualquer entidade, e o gerador j√° criar√° uma classe real a partir dela: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Health Health; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Damage Damage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Invincible Invincible; <span class="hljs-comment"><span class="hljs-comment">// ... &lt; &gt; }</span></span></code> </pre> <br>  Depois disso, nosso gerador criar√° o c√≥digo das classes de componente <i>Health</i> , <i>Damage</i> e <i>Invincible</i> , que j√° ser√£o usadas na l√≥gica do jogo: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> : <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Hp; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Hp = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ... &lt;  &gt; } public sealed class Damage : IComponent { public int Amount; public Entity Victim; public Entity Source; public void Reset() { Amount = default(int); Victim = default(Entity); Source = default(Entity); } // ... &lt;  &gt; } public sealed class Invincible : IComponent { }</span></span></code> </pre> <br>  Como voc√™ pode ver, os dados permaneceram nas classes e os m√©todos foram adicionados, por exemplo, <i>Redefinir</i> .  √â necess√°rio otimizar e reutilizar componentes em conjuntos.  Outros m√©todos auxiliares n√£o cont√™m l√≥gica de neg√≥cios - n√£o os darei por brevidade. <br><br>  Tamb√©m ser√° gerada uma classe para o estado do mundo, que cont√©m uma lista de todos os componentes e entidades: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GameState</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  public Table&lt;Movement&gt; Movements; public Table&lt;Health&gt; Healths; public Table&lt;Damage&gt; Damages; public Table&lt;Transform&gt; Transforms; public Table&lt;Invincible&gt; Invincibles; //   public Entity CreateEntity() { /* &lt;&gt; */ } public void Copy(GameState gs2) { /* &lt;&gt; */ } public Entity this[uint id] { /* &lt;&gt; */ } // ... &lt;   &gt; }</span></span></code> </pre> <br>  E, finalmente, o c√≥digo gerado para a <i>Entidade</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Id; <span class="hljs-comment"><span class="hljs-comment">//   public GameState GameState; //     //     : public Health Health { get { return GameState.Healths[Id]; } } public Damage Damage { get { return GameState.Damages[Id]; } } public Invincible Invincible { get { return GameState.Invincibles[Id]; } } // ‚Ä¶     public Damage AddDamage() { return GameState.Damages.Insert(Id); } public Damage AddDamage(int total, Entity victim, Entity source) { var c = GameState.Damages.Insert(Id); c.Amount = total; c.Victim = victim; c.Source = source; return c; } public void DelDamage() { GameState.Damages.Delete(Id); } // ‚Ä¶ &lt;     &gt; }</span></span></code> </pre> <br>  A classe <i>Entity</i> √© essencialmente apenas um identificador de componente.  A refer√™ncia aos objetos do mundo <i>GameState</i> √© usada apenas em m√©todos auxiliares para a conveni√™ncia de escrever c√≥digo de l√≥gica de neg√≥cios.  Conhecendo o identificador de um componente, podemos us√°-lo para serializar relacionamentos entre entidades, implementar links em componentes para outras entidades.  Por exemplo, o componente <i>Dano</i> cont√©m uma refer√™ncia √† entidade <i>V√≠tima</i> para determinar quem foi danificado. <br><br>  Isso termina o c√≥digo gerado.  Em geral, precisamos de um gerador para n√£o escrever m√©todos auxiliares todas as vezes.  N√≥s apenas descrevemos os componentes como dados, ent√£o o gerador faz todo o trabalho.  Exemplos de m√©todos auxiliares: <br><br><ul><li>  cria√ß√£o / exclus√£o de entidades; </li><li>  adicione / remova / copie um componente, acesse-o, se existir; </li><li>  compare dois estados do mundo; </li><li>  serializar o estado do mundo; </li><li>  compress√£o delta; </li><li>  c√≥digo de uma p√°gina da web ou janela do Unity para exibir o estado do mundo, entidades, componentes (veja detalhes abaixo); </li><li>  e outros </li></ul><br>  Vamos seguir para o c√≥digo do sistema.  Eles definem a l√≥gica de neg√≥cios.  Por exemplo, vamos escrever o c√≥digo de um sistema que calcula o dano a um jogador: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DamageSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ISystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ISystem.Execute(GameState gs) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> damage <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.Damages) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invincible = damage.Victim.Invincible; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (invincible != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> health = damage.Victim.Health; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (health == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; health.Hp -= damage.Amount; } } }</code> </pre> <br>  O sistema passa por todos os componentes de <i>Dano</i> no mundo e procura ver se h√° um componente <i>Invenc√≠vel</i> em um jogador potencialmente danificado ( <i>V√≠tima</i> ).  Se ele √©, o jogador √© invulner√°vel, o dano n√£o √© acumulado.  Em seguida, obtemos o componente de <i>sa√∫de</i> da v√≠tima e reduzimos a sa√∫de do jogador pelo tamanho do dano. <br><br>  Considere os principais recursos dos sistemas: <br><br><ol><li>  Um sistema geralmente √© uma classe sem estado, n√£o cont√©m dados internos, n√£o tenta salv√°-lo em algum lugar, exceto dados sobre o mundo transmitido de fora. </li><li>  Os sistemas geralmente passam por todos os componentes de um determinado tipo e trabalham com eles.  Eles geralmente s√£o chamados pelo tipo de componente ( <i>Damage</i> ‚Üí <i>DamageSystem</i> ) ou pela a√ß√£o que eles executam ( <i>RespawnSystem</i> ). </li><li>  O sistema implementa funcionalidade m√≠nima.  Por exemplo, se formos al√©m, depois que o <i>DamageSystem for executado,</i> outro <i>RemoveDamageSystem</i> remover√° todos os componentes do <i>Damage</i> .  No pr√≥ximo tick, outro <i>ApplyDamageSystem</i> baseado no disparo do jogador pode novamente pendurar o componente <i>Damage</i> com novos danos.  E o <i>PlayerDeathSystem</i> verificar√° a sa√∫de do jogador ( <i>Health.Hp</i> ) e, se for menor ou igual a 0, destruir√° todos os componentes do jogador, exceto <i>Transform</i> e adicionar√° o componente <i>Dead</i> flag. </li></ol><br>  No total, obtemos as seguintes classes e os relacionamentos entre elas: <br><img src="https://habrastorage.org/webt/g7/59/mq/g759mq06qfqqjymhz8ympcwejro.png"><br><br><h3>  Alguns fatos sobre ECS </h3><br>  A ECS tem seus pr√≥s e contras como uma abordagem ao desenvolvimento e uma maneira de representar o mundo do jogo, para que todos decidam por si mesmos se devem us√°-lo ou n√£o.  Vamos come√ßar com os profissionais: <br><br><ul><li>  <b>Composi√ß√£o versus heran√ßa m√∫ltipla.</b>  No caso de heran√ßa m√∫ltipla, v√°rias funcionalidades desnecess√°rias podem ser herdadas.  No caso do ECS, a funcionalidade aparece / desaparece quando um componente √© adicionado / removido. </li><li>  <b>Separa√ß√£o de l√≥gica e dados.</b>  A capacidade de alterar a l√≥gica (alterar sistemas, remover / adicionar componentes) sem interromper os dados.  I.e.  voc√™ pode desativar o grupo de sistemas respons√°veis ‚Äã‚Äãpor uma certa funcionalidade a qualquer momento, todo o resto continuar√° funcionando e isso n√£o afetar√° os dados. </li><li>  <b>O ciclo do jogo √© simplificado.</b>  Uma <i>atualiza√ß√£o</i> aparece e todo o ciclo √© dividido em sistemas.  Os dados s√£o processados ‚Äã‚Äãpelo "fluxo" no sistema, independentemente do mecanismo (n√£o h√° milh√µes de chamadas de <i>atualiza√ß√£o</i> , como no Unity). </li><li>  <b>Uma entidade n√£o sabe quais classes o afetam</b> (e n√£o deveria saber). </li><li>  <b>Uso eficiente de mem√≥ria</b> .  Depende da implementa√ß√£o do ECS.  Voc√™ pode reutilizar objetos e componentes de entidade criados usando conjuntos;  voc√™ pode usar tipos de valor para dados e armazen√°-los na mem√≥ria lado a lado ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">localidade dos dados</a> ). </li><li>  <b>√â mais f√°cil testar</b> quando os dados s√£o separados da l√≥gica.  Especialmente quando voc√™ considera que a l√≥gica √© um sistema pequeno com v√°rias linhas de c√≥digo. </li><li>  <b>Veja e edite o estado do mundo em tempo real</b> .  Porque  como o estado do mundo √© apenas dados, escrevemos uma ferramenta que exibe na p√°gina da web todo o estado do mundo em uma correspond√™ncia no servidor (assim como a cena da correspond√™ncia em 3D).  Qualquer componente de qualquer entidade pode ser visualizado, modificado e exclu√≠do.  O mesmo pode ser feito no editor do Unity para o cliente. </li></ul><br><img src="https://habrastorage.org/webt/zd/rz/a-/zdrza-80yltaqp8g3dqwd59zgqw.jpeg"><br><br>  E agora os contras: <br><br><ul><li>  <b>Voc√™ precisa aprender a pensar, projetar e escrever c√≥digo de maneira diferente</b> .  Pense em termos de entidades, componentes e sistemas.  Muitos padr√µes de design no ECS s√£o implementados de uma maneira completamente diferente (veja um exemplo de implementa√ß√£o do padr√£o <i>State</i> em um dos artigos de revis√£o no final). </li><li>  <b>Mais c√≥digo</b> .  Discut√≠vel.  Por um lado, devido ao fato de dividirmos a l√≥gica em pequenos sistemas, em vez de descrever toda a funcionalidade em uma classe, h√° mais classes, mas n√£o h√° muito mais c√≥digo. </li><li>  <b>A ordem na qual os sistemas s√£o chamados afeta a opera√ß√£o de todo o jogo</b> .  Geralmente, os sistemas s√£o dependentes um do outro, a ordem de sua execu√ß√£o √© definida pela lista e eles s√£o executados nessa ordem.  Por exemplo, primeiro o <i>DamageSystem</i> considera o dano e o <i>RemoveDamageSystem</i> remove o componente <i>Damage</i> .  Se voc√™ acidentalmente alterar a ordem, tudo funcionar√° de maneira diferente.  Em geral, isso tamb√©m se aplica ao caso usual de POO, se voc√™ alterar a ordem das chamadas de m√©todo, mas no ECS √© mais f√°cil cometer um erro.  Por exemplo, se parte da l√≥gica for executada no cliente para previs√£o, o pedido dever√° ser o mesmo que no servidor. </li><li>  <b>De alguma forma, precisamos conectar os dados e eventos da l√≥gica √† visualiza√ß√£o</b> .  No caso do Unity, temos o MVP: <br><br>  - Modelo - <i>GameState</i> da ECS; <br>  - Veja - conosco, estas s√£o exclusivamente classes <i>MonoBehavior</i> Unity padr√£o ( <i>Renderer</i> , <i>Texto</i> etc.) e pr√©-fabricadas; <br>  - O Presenter usa o <i>GameState</i> para determinar os eventos de apar√™ncia / desaparecimento de entidades, componentes etc., cria objetos do Unity a partir de pr√©-fabricados e os altera de acordo com as mudan√ßas no estado do mundo. </li></ul><br>  <i>Voc√™ sabia que:</i> <br><br><ul><li>  <b>O ECS n√£o se refere apenas √† localidade dos dados</b> .  Para mim, isso √© mais um paradigma de programa√ß√£o, um padr√£o, outra maneira de projetar o mundo do jogo - chame como quiser.  A localidade dos dados √© apenas uma otimiza√ß√£o. </li><li>  <b>A unidade n√£o tem ECS!</b>  Muitas vezes voc√™ pergunta aos candidatos em uma entrevista em equipe - o que voc√™ sabe sobre ECS?  Se voc√™ n√£o ouviu, diga a eles e eles responderam: "Ah, √© como no Unity, ent√£o eu sei!".  Mas n√£o, n√£o √© como no mecanismo do Unity.  L√°, dados e l√≥gica s√£o combinados no componente <i>MonoBehaviour</i> , e o <i>GameObject</i> (se comparado com uma entidade no ECS) possui dados adicionais - um nome, um local na hierarquia etc. Os desenvolvedores da unidade est√£o atualmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">trabalhando</a> em uma implementa√ß√£o normal do ECS no mecanismo, e at√© agora parece que ser√° bom.  Eles contrataram especialistas nesse campo - espero que seja legal. </li></ul><br><h3>  Nossos crit√©rios de sele√ß√£o para a estrutura ECS </h3><br>  Quando decidimos criar um jogo no ECS, come√ßamos a procurar uma solu√ß√£o pronta e anotamos os requisitos com base na experi√™ncia de um dos desenvolvedores.  E eles pintaram como as solu√ß√µes existentes atendem aos nossos requisitos.  Foi h√° um ano, no momento, algo poderia ter mudado.  Como solu√ß√µes, consideramos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Entitas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artemis C #</a> </li><li>  <a href="">Ash.net</a> </li><li>  O ECS √© nossa pr√≥pria solu√ß√£o no momento em que o concebemos.  I.e.  nossas suposi√ß√µes e desejos, o que podemos fazer por n√≥s mesmos. </li></ul><br>  Compilamos uma tabela para compara√ß√£o, onde tamb√©m inclu√≠ nossa solu√ß√£o atual (designada como <i>ECS (agora)</i> ): <br><br><img src="https://habrastorage.org/webt/0p/eh/hk/0pehhk27fihkyp-qmuhlpu0m5m4.png"><br>  <i>Cor vermelha - a solu√ß√£o n√£o atende aos nossos requisitos, laranja - suporta parcialmente, verde - suporta totalmente.</i> <br><br>  Para n√≥s, a analogia das opera√ß√µes para acessar componentes e procurar entidades no ECS eram opera√ß√µes em um banco de dados sql.  Portanto, usamos conceitos como tabela (tabela), jun√ß√£o (opera√ß√£o de jun√ß√£o), √≠ndices (√≠ndices) etc. <br><br>  Descreveremos nossos requisitos e em que medida as bibliotecas e estruturas de terceiros corresponderam a eles: <br><br><ul><li>  <b>conjuntos de dados separados (hist√≥rico, atual, visual, est√°tico)</b> - a capacidade de obter e armazenar separadamente estados mundiais (por exemplo, o estado atual para processamento, renderiza√ß√£o, hist√≥rico de estado etc.).  <i>Todas as decis√µes consideradas apoiaram esse requisito</i> . </li><li>  <b>ID da entidade como n√∫mero inteiro</b> - suporte para representar uma entidade por seu n√∫mero identificador.  √â necess√°rio para a transmiss√£o pela rede e a capacidade de conectar entidades na hist√≥ria dos estados.  <i>Nenhuma das solu√ß√µes consideradas suportadas.</i>  <i>Por exemplo, no Entitas, uma entidade √© representada por um objeto completo (como um GameObject no Unity).</i> </li><li>  <b>jun√ß√£o por ID O (N + M)</b> - suporte para amostragem relativamente r√°pida de dois tipos de componentes.  Por exemplo, quando voc√™ precisa obter todas as entidades com componentes do tipo Dano (por exemplo, suas pe√ßas N) e Sa√∫de (pe√ßas M) para calcular e causar danos.  <i>Havia suporte total em Artemis;</i>  <i>no Entitas e no Ash.NET, √© mais r√°pido que O (N¬≤), mas mais lento que O (N + M).</i>  <i>N√£o me lembro da avalia√ß√£o agora.</i> </li><li>  <b>jun√ß√£o pela refer√™ncia de identifica√ß√£o O (N + M)</b> - o mesmo que acima, somente quando o componente de uma entidade possui um link para outro, e o √∫ltimo precisa obter outro componente (no nosso exemplo, o componente <i>Dano</i> na entidade auxiliar refere-se √† entidade jogador <i>V√≠tima</i> e a partir da√≠ voc√™ precisa obter o componente <i>Sa√∫de</i> ).  <i>N√£o √© suportado por nenhuma das solu√ß√µes consideradas.</i> </li><li>  <b>sem</b> aloca√ß√£o de consulta - sem aloca√ß√µes de mem√≥ria extra ao consultar componentes e entidades do estado do mundo.  Na Entitas, foi em certos casos, mas insignificante para n√≥s. </li><li>  <b>tabelas de pool</b> - armazenamento de dados mundiais em pools, capacidade de reutilizar mem√≥ria, aloca√ß√£o apenas quando o pool estiver vazio.  <i>Havia "algum" suporte no Entitas e Artemis, uma aus√™ncia completa no Ash.NET.</i> </li><li>  <b>compare by ID (add, del)</b> - suporte interno para eventos de cria√ß√£o / destrui√ß√£o de entidades e componentes por ID.  √â necess√°rio que o n√≠vel de exibi√ß√£o (Exibir) mostre / oculte objetos, reproduza anima√ß√µes, efeitos.  <i>N√£o √© suportado por nenhuma das solu√ß√µes consideradas.</i> </li><li>  <b>Œî serializa√ß√£o (quantiza√ß√£o, pular)</b> - compacta√ß√£o delta integrada para serializar o estado do mundo (por exemplo, para reduzir o tamanho dos dados enviados pela rede).  <i>O Out of the Box n√£o foi suportado em nenhuma das solu√ß√µes.</i> </li><li>  <b>A interpola√ß√£o</b> √© um mecanismo interno de interpola√ß√£o entre estados do mundo.  <i>Nenhuma das solu√ß√µes suportadas.</i> </li><li>  <b>reutilizar o tipo de componente</b> - a capacidade de usar o tipo de componente escrito uma vez em diferentes tipos de entidades.  <i>Somente Entitas suportado</i> . </li><li>  <b>ordem expl√≠cita de sistemas</b> - a capacidade de definir seus pr√≥prios sistemas de ordem de chamada.  <i>Todas as decis√µes s√£o suportadas.</i> </li><li>  <b>editor (unidade / servidor)</b> - suporte para visualizar e editar entidades em tempo real, tanto para o cliente quanto para o servidor.  <i>Entitas suportou apenas a capacidade de visualizar e editar entidades e componentes no editor do Unity.</i> </li><li>  <b>c√≥pia / substitui√ß√£o r√°pida</b> - a capacidade de copiar / substituir dados de maneira barata.  <i>Nenhuma das solu√ß√µes suportadas.</i> </li><li>  <b>componente como tipo de valor (struct)</b> - componentes como tipos de valor.  Em princ√≠pio, eu queria alcan√ßar um bom desempenho com base nisso.  <i>Nenhum sistema era suportado; as classes de componentes estavam por toda parte.</i> </li></ul><br>  Requisitos opcionais ( <i>nenhuma das solu√ß√µes da √©poca os suportava</i> ): <br><br><ul><li>  <b>√≠ndices</b> - indexando dados como em um banco de dados. </li><li>  <b>chaves compostas</b> - <b>chaves</b> complexas para acesso r√°pido aos dados (como no banco de dados). </li><li>  <b>verifica√ß√£o de integridade</b> - a capacidade de verificar a integridade dos dados em um estado do mundo.  √ötil para depura√ß√£o. </li><li>  <b>A compacta√ß√£o com reconhecimento de conte√∫do</b> √© a melhor compacta√ß√£o de dados com base no conhecimento da natureza dos dados.  Por exemplo, se soubermos o tamanho m√°ximo do mapa ou o n√∫mero m√°ximo de objetos no mundo. </li><li>  <b>limite de tipos / sistemas</b> - restri√ß√£o ao n√∫mero de tipos de componentes ou sistemas.  <i>Na Artemis naquela √©poca, era imposs√≠vel criar mais de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">32 ou 64 tipos de componentes e sistemas</a></i> . </li></ul><br>  Como pode ser visto na tabela, n√≥s mesmos quer√≠amos implementar todos os requisitos, exceto os opcionais.  De fato, no momento <i>n√£o</i> fizemos: <br><br><ul><li>  <i>jun√ß√£o pelo ID O (N + M)</i> e <i>jun√ß√£o pela refer√™ncia de ID O (N + M)</i> - a sele√ß√£o para dois componentes diferentes ainda ocupa O (N¬≤) (na verdade, um loop <i>for</i> aninhado).  Por outro lado, n√£o existem muitas entidades e componentes para uma correspond√™ncia. </li><li>  <i>comparar por ID (adicionar, del)</i> - n√£o √© necess√°rio no n√≠vel da estrutura.  Implementamos isso em um n√≠vel mais alto no MVP. </li><li>  <i>c√≥pia / substitui√ß√£o r√°pida</i> e <i>componente como tipo de valor (struct)</i> - em algum momento, percebemos que trabalhar com estruturas n√£o seria t√£o conveniente quanto com as classes, e decidimos por classes - preferimos a conveni√™ncia do desenvolvimento em vez do melhor desempenho.  A prop√≥sito, os desenvolvedores do Entitas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fizeram o mesmo no final</a> . </li></ul><br>  Ao mesmo tempo, percebemos um dos requisitos inicialmente opcionais em nossa opini√£o: <br><br><ul><li>  <i>compacta√ß√£o com reconhecimento de conte√∫do</i> - por isso conseguimos reduzir (dezenas de vezes) significativamente o tamanho do pacote transmitido pela rede.  Para redes de dados m√≥veis, √© muito importante ajustar o tamanho do pacote na MTU para que n√£o seja "dividido" em pequenas partes que podem se perder, ser executadas em uma ordem diferente e depois serem montadas em partes.  Por exemplo, no Photon, se o tamanho dos dados n√£o couber na biblioteca MTU, os dados ser√£o divididos em pacotes e os ser√£o enviados como confi√°veis ‚Äã‚Äã(com entrega garantida), mesmo se voc√™ os enviar como "n√£o confi√°veis" de cima.  Testado com dor em primeira m√£o. </li></ul><br><h3>  Caracter√≠sticas do nosso desenvolvimento na ECS </h3><br><ul><li>  <b>Na ECS, escrevemos exclusivamente a l√≥gica de neg√≥cios</b> .  Nenhum trabalho com recursos, visualiza√ß√µes etc.  Como o c√≥digo l√≥gico do ECS √© executado simultaneamente no cliente no Unity e no servidor, ele deve ser o mais independente poss√≠vel de outros n√≠veis e m√≥dulos. </li><li>  <b>Tentamos minimizar componentes e sistemas</b> .  Geralmente, para cada nova tarefa, iniciamos novos componentes e sistemas.  √Äs vezes, por√©m, modificamos os antigos, adicionamos novos dados aos componentes e "inflamos" os sistemas. </li><li>  <b>Em nossa implementa√ß√£o do ECS, voc√™ n√£o pode adicionar v√°rios componentes do mesmo tipo a uma entidade</b> .  Portanto, se um jogador foi atingido v√°rias vezes em um tick (por exemplo, v√°rios oponentes), geralmente criamos uma nova entidade para cada dano e adicionamos um componente de <i>dano</i> a ele. </li><li>  <b>√Äs vezes, a apresenta√ß√£o n√£o √© suficiente das informa√ß√µes que est√£o no <i>GameState</i></b> .  √â necess√°rio adicionar componentes especiais ou dados adicionais que n√£o est√£o envolvidos na l√≥gica, mas que a visualiza√ß√£o precisa.  Por exemplo, o instant√¢neo √© instant√¢neo no servidor, um tick fica vivo e, visualmente, √© mais demorado no cliente.  Portanto, para o cliente, a inje√ß√£o √© adicionada ao par√¢metro "vida √∫til da inje√ß√£o". </li><li>  <b>Implementamos eventos / solicita√ß√µes criando componentes especiais</b> .  Por exemplo, se um jogador morreu, penduramos nele um componente sem dados <i>mortos</i> , que √© um evento para outros sistemas e o n√≠vel de exibi√ß√£o em que o jogador morreu.  Ou, se precisarmos reviver o jogador novamente, criaremos uma entidade separada com o componente <i>Respawn</i> com informa√ß√µes adicionais sobre quem reviver.  Um <i>RespawnSystem</i> separado no in√≠cio do ciclo do jogo passa por esses componentes e j√° cria a ess√™ncia do jogador.  I.e.  de fato, a primeira entidade √© uma solicita√ß√£o para criar a segunda. </li><li>  <b>Temos componentes / entidades "singleton" especiais</b> .  Por exemplo, temos uma entidade com ID = 1, na qual componentes especiais dependem - as configura√ß√µes do jogo. </li></ul><br><h3>  B√¥nus </h3><br>    ‚Äî       ECS ‚Äî    .     ,        ,   ,   : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Unity, ECS  --</a> ‚Äî       ECS   .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mopsicus</a>  ,   ECS,  .        :  Unity  ECS   ,   .    .   ¬´¬ª ECS    Unity.    ECS-,      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LeoECS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BrokenBricksECS</a> , <a href="">Svelto.ECS</a> . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Unity3D ECS  Job System</a> ‚Äî   ,      ECS  Unity.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fstleo</a>   ,   Unity ECS,     ,         -      ,    JobSystem. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  Entity System Framework      ?</a> ‚Äî    Ash-  ActionScript.  ,   ,        OOP-  ECS-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    Ash Entity System </a> ‚Äî   ,    FSM  State  ECS ‚Äî      ,       . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  Entity-Component-System ‚Äî    </a> ‚Äî     ECS  C++. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413729/">https://habr.com/ru/post/pt413729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413717/index.html">GraphQL para plataformas InterSystems</a></li>
<li><a href="../pt413719/index.html">C ++ 20 a caminho! Encontro no Rapperswil Yona</a></li>
<li><a href="../pt413721/index.html">Time Check: Timejacking vs Bitcoin</a></li>
<li><a href="../pt413723/index.html">Saga de servi√ßos eletr√¥nicos e suas localiza√ß√µes. Parte 2. Arm√°rio Eletr√¥nico</a></li>
<li><a href="../pt413725/index.html">Trabalhando com matrizes no bash</a></li>
<li><a href="../pt413731/index.html">Pesquisa de Mercado de Trabalho BA / SA</a></li>
<li><a href="../pt413733/index.html">Mikrosh, Krista, Apogee, Lviv - os primeiros computadores take-away sovi√©ticos</a></li>
<li><a href="../pt413739/index.html">Como digitalizamos toda a Internet e o que aprendemos</a></li>
<li><a href="../pt413741/index.html">O que era e como: impress√µes da equipe WWDC Redmadrobot</a></li>
<li><a href="../pt413743/index.html">Inicie o LAMP e centenas de outros aplicativos da web em apenas alguns cliques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>