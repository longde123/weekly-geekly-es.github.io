<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍸 🏝️ 🤳🏻 编程简介：整个周末从头开始的简单3D射击游戏，第2部分 📄 💅 🦒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们将在周末继续进行有关3D射击游戏的讨论。 如果有的话，我想提醒您，这是下半年： 



- 第一部分：墙体绘图 
- 第二部分：居住在我们的世界+窗口界面 
 正如我所说，我尽最大努力支持学生渴望用自己的双手做某事。 尤其是，当我讲授关于编程入门的课程时，作为实际练习，我几乎给了他们完全的自由。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>编程简介：整个周末从头开始的简单3D射击游戏，第2部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439720/"> 我们将在周末继续进行有关3D射击游戏的讨论。 如果有的话，我想提醒您，这是下半年： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分：墙体绘图</a> </li><li>  <b>第二部分：居住在我们的世界+窗口界面</b> </li></ul><br> 正如我所说，我尽最大努力支持学生渴望用自己的双手做某事。 尤其是，当我讲授关于编程入门的课程时，作为实际练习，我几乎给了他们完全的自由。 只有两个限制：编程语言（C ++）和项目主题，这应该是电子游戏。 这是我的新生制作的数百种游戏之一的示例： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Ekomnk1eNFU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> 不幸的是，大多数学生选择诸如2D平台游戏之类的简单游戏。 我写这篇文章的目的是表明，创造一个三维世界的错觉并不比克隆马里奥·布鲁斯困难。 <br><a name="habracut"></a><br> 我提醒您，我们在一个允许您对墙壁进行纹理化的阶段停止了工作： <br><br><img src="https://raw.githubusercontent.com/ssloy/tinyraycaster/master/doc/012.gif"><br><br><hr><br><h1> 阶段13：在地图上绘制怪物 </h1><br> 我们游戏中的怪物是什么？ 这些是其坐标和纹理编号： <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sprite</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> tex_id; }; [..] <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Sprite&gt; sprites{ {<span class="hljs-number"><span class="hljs-number">1.834</span></span>, <span class="hljs-number"><span class="hljs-number">8.765</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">5.323</span></span>, <span class="hljs-number"><span class="hljs-number">5.365</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">4.123</span></span>, <span class="hljs-number"><span class="hljs-number">10.265</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>} };</code> </pre> <br> 定义了几个怪物之后，我们首先将它们绘制在地图上： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/60f/15a/824/60f15a824cec0e8a93ff42f4d7a2722b.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><hr><br><h1> 阶段14：用黑色方块代替3D怪物 </h1><br> 现在我们将在3D窗口中绘制精灵。 为此，我们需要确定两件事：精灵在屏幕上的位置及其大小。 这是代替每个子画面绘制一个黑色正方形的函数： <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_sprite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sprite &amp;sprite, FrameBuffer &amp;fb, Player &amp;player, Texture &amp;tex_sprites)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// absolute direction from the player to the sprite (in radians) float sprite_dir = atan2(sprite.y - player.y, sprite.x - player.x); // remove unnecessary periods from the relative direction while (sprite_dir - player.a &gt; M_PI) sprite_dir -= 2*M_PI; while (sprite_dir - player.a &lt; -M_PI) sprite_dir += 2*M_PI; // distance from the player to the sprite float sprite_dist = std::sqrt(pow(player.x - sprite.x, 2) + pow(player.y - sprite.y, 2)); size_t sprite_screen_size = std::min(2000, static_cast&lt;int&gt;(fb.h/sprite_dist)); // do not forget the 3D view takes only a half of the framebuffer, thus fb.w/2 for the screen width int h_offset = (sprite_dir - player.a)*(fb.w/2)/(player.fov) + (fb.w/2)/2 - sprite_screen_size/2; int v_offset = fb.h/2 - sprite_screen_size/2; for (size_t i=0; i&lt;sprite_screen_size; i++) { if (h_offset+int(i)&lt;0 || h_offset+i&gt;=fb.w/2) continue; for (size_t j=0; j&lt;sprite_screen_size; j++) { if (v_offset+int(j)&lt;0 || v_offset+j&gt;=fb.h) continue; fb.set_pixel(fb.w/2 + h_offset+i, v_offset+j, pack_color(0,0,0)); } } }</span></span></code> </pre><br> 让我们弄清楚它是如何工作的。 这是图表： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/472/062/e0d/472062e0d02a32186987ee94f7364cdd.png"><br><br> 在第一行中，我们考虑sprite_dir的绝对角度（从播放器到Sprite的方向与横坐标之间的角度）。 精灵与注视方向之间的相对角度显然可以通过简单地减去两个绝对角度来获得：sprite_dir-player.a。 从播放器到子画面的距离很难计算，子画面的大小是屏幕大小除以距离的简单划分。 好吧，以防万一，我从顶部切了两千个，以免得到巨大的正方形（顺便说一下，这段代码很容易被零除）。  h_offset和v_offset给出屏幕上精灵的左上角的坐标； 然后一个简单的双循环用黑色填充我们的正方形。 用笔和一张纸检查是否正确计算了h_offset和v_offset，在我的提交中有一个（非严重）错误，请相信本文中的代码：）好吧，存储库中的最新代码也已修复。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/03a/795/77c/03a79577c9c0781121b529494b1dafe1.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><hr><br><h1> 第15步：深度图 </h1><br> 我们的正方形奇迹般地好，但是只有一个问题：遥远的怪物在拐角处偷看，并且正方形被完全绘制。 如何成为 很简单 绘制墙壁<b>后</b> ，我们绘制精灵。 因此，对于屏幕的每一列，我们都知道到最近的墙的距离。 我们将这些距离保存到512个值的数组中，并将该数组传递给sprite渲染函数。 精灵也会逐列绘制，因此对于精灵的每一列，我们都将其距离与深度数组中的值进行比较。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec8/1c3/71f/ec81c371f35f7ddff4086a8e1a51268b.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><hr><br><h1> 阶段16：精灵问题 </h1><br> 他们变成了伟大的怪物，不是吗？ 但是在此阶段，我将不添加任何功能，相反，我将通过添加另一个怪物来破坏一切： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/28f/5a8/9b8/28f5a89b8ea84373d9812c3e3a66d61d.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><hr><br><h1> 阶段17：对精灵进行排序 </h1><br> 怎么了 问题是我可以随意绘制绘画精灵，对于每个精灵，我都将其与墙的距离进行比较，但与其他精灵进行比较，因此远处的生物爬到了最近的生物上。 是否可以使用深度图适应解决方案来绘制精灵？ <br><br><div class="spoiler">  <b class="spoiler_title">隐藏文字</b> <div class="spoiler_text"> 正确的答案是“可以”。 但是如何？ 在评论中写。 <br></div></div><br> 我将采取另一种方式，在额头上愚蠢地解决问题。 我将绘制从最远到最远的所有精灵。 也就是说，我将按距离的降序对精灵进行排序，并按该顺序绘制它们。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73c/820/c20/73c820c20c220093733774e6a1553a50.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><hr><br><h1> 步骤18：SDL时间 </h1><br>  SDL的时机已到。 有很多不同的跨平台窗口库，我完全不了解它们。 就个人而言，我喜欢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">imgui</a> ，但是由于某种原因，我的学生更喜欢SDL，因此我将其链接。 此阶段的任务非常简单：创建一个窗口并显示上一阶段的图像： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ce/63a/9b5/7ce63a9b5ea3ca1c608fcdcf207d482e.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">您可以在此处看到</a>更改。 我不再提供指向gitpod的链接，因为 浏览器中的SDL尚未学会启动:( <br><br>  <b>更新：学习！</b>  <b>您可以在浏览器中一键运行代码！</b> <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gitpod.io/&amp;usg=ALkJrhi73BZNubeM_wHTI4LgWtilH69G_A#"><img src="https://habrastorage.org/getpro/habr/post_images/212/d5a/2a2/212d5a2a20d3071af82393c33309f62c.svg" alt="在gitpod中打开"></a> <br><br><h1> 步骤19：事件处理和清理 </h1><br> 我不会描述对按键的反应甚至不好笑。 添加SDL时，我删除了对stb_image.h的依赖。 它很漂亮，但是编译时间太长。 <br><br> 对于那些不了解的人， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>是第十九阶段的来源。 好吧，这是一个典型的表现： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zPIVTqVilCM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1> 结论 </h1><br> 目前，我的代码仅包含486行，但同时我根本没有保存它们： <br><br><pre> <code class="bash hljs">haqreu@daffodil:~/tinyraycaster$ cat *.cpp *.h | wc -l 486</code> </pre><br> 我没有舔我的代码，故意扔了脏衣服。 是的，我这样写（而不仅仅是我）。 一个星期六早上，我刚坐下来写下了这个:) <br><br> 我没有完成游戏，我的任务只是为您发挥想象力提供初步动力。 编写自己的代码，可能会比我的代码更好。 共享您的代码，共享您的想法，发送请求请求。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN439720/">https://habr.com/ru/post/zh-CN439720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN439710/index.html">为美国市场生产产品的功能</a></li>
<li><a href="../zh-CN439712/index.html">公共采购：意大利罢工与俄罗斯罪犯之间的平衡</a></li>
<li><a href="../zh-CN439714/index.html">苹果公司的俄罗斯人：我们如何与披头士乐队和“一些杰里”歌曲获得数百万美元的合约</a></li>
<li><a href="../zh-CN439716/index.html">跟踪操作系统或如何在线保护自己</a></li>
<li><a href="../zh-CN439718/index.html">Docker在Elixir / Phoenix上的应用程序开发</a></li>
<li><a href="../zh-CN439722/index.html">SVG滤镜的效果。 第2部分。用词形学概述文本</a></li>
<li><a href="../zh-CN439724/index.html">2018年AI和ML解决方案概述以及2019年预测：第2部分-工具和库，AutoML，RL，人工智能伦理</a></li>
<li><a href="../zh-CN439726/index.html">锁定：真实还是虚构？</a></li>
<li><a href="../zh-CN439728/index.html">在不使用Zextras的情况下配置完整和单独的Zimbra OSE备份和恢复</a></li>
<li><a href="../zh-CN439730/index.html">通过标准班级组织减速机</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>