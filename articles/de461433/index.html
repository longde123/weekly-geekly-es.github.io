<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèº üöÄ üï¶ Verwenden von Identity Server 4 in Net Core 3.0 üëµüèº üë©üèæ‚Äçüé§ üóùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einf√ºhrung 


 Eines meiner unterst√ºtzten Projekte stand k√ºrzlich vor der Aufgabe, die M√∂glichkeit einer Migration von .NET Framework 4.5 auf .Net Cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verwenden von Identity Server 4 in Net Core 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie">  Einf√ºhrung </h2><br><p>  Eines meiner unterst√ºtzten Projekte stand k√ºrzlich vor der Aufgabe, die M√∂glichkeit einer Migration von .NET Framework 4.5 auf .Net Core zu analysieren, falls eine gro√üe Menge akkumulierter technischer Schulden umgestaltet und aufgebraucht werden muss.  Die Wahl fiel auf die Zielplattform .NET Core 3.0, da laut den Entwicklern von Microsoft mit der Ver√∂ffentlichung von Version 3.0 die erforderlichen Schritte f√ºr die Migration von Legacy-Code um ein Vielfaches verringert werden.  Besonders die Exit-Pl√§ne f√ºr EntityFramework 6.3 f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">.Net Core,</a> d.h.  Der gr√∂√üte Teil des auf EF 6.2 basierenden Codes kann in einem migrierten Projekt auf Net Core unver√§ndert gelassen werden. </p><br><p>  Bei der Datenebene wurde anscheinend klar, dass ein weiterer wichtiger Teil der Code-Portierung die Sicherheitsstufe war, die Sie nach einer schnellen Pr√ºfung leider fast vollst√§ndig wegwerfen und von Grund auf neu schreiben m√ºssen.  Gl√ºcklicherweise verwendete das Projekt bereits einen Teil von ASP NET Identity in Form der Aufbewahrung von Benutzern und anderen seitlich angebrachten ‚ÄûFahrr√§dern‚Äú. </p><br><p>  Dies wirft die logische Frage auf: Wenn der Sicherheitsteil viele √Ñnderungen vornehmen muss, warum nicht sofort die in Form von Industriestandards empfohlenen Ans√§tze implementieren, n√§mlich: Bringen Sie die Anwendung dazu, Open Id Connect und OAuth √ºber das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">IdentityServer4-</a> Framework zu verwenden. </p><a name="habracut"></a><br><h2 id="problemy-i-puti-resheniya">  Probleme und L√∂sungen </h2><br><p>  Wir haben also Folgendes erhalten: Es gibt eine JavaScript-Anwendung in Angular (Client in IS4-Begriffen), sie verwendet eine bestimmte Teilmenge von WebAPI (Ressourcen), es gibt auch eine Datenbank mit veralteter ASP NET-Identit√§t mit Benutzeranmeldungen, die nach dem Update wiederverwendet werden m√ºssen (um nicht alle anderen zu starten) In einigen F√§llen muss die M√∂glichkeit bestehen, sich √ºber die Windows-Authentifizierung auf der Seite von IdentityServer4 beim System anzumelden.  Das hei√üt,  Es gibt Zeiten, in denen Benutzer √ºber ein lokales Netzwerk in einer ActiveDirectory-Dom√§ne arbeiten. </p><br><p>  Die Hauptl√∂sung f√ºr die Migration von Benutzerdaten besteht darin, manuell (oder mithilfe automatisierter Tools) ein Migrationsskript zwischen dem alten und dem neuen Identit√§tsdatenschema zu schreiben.  Wir haben wiederum die Anwendung zum automatischen Vergleich von Datenschemata verwendet und ein SQL-Skript generiert. Abh√§ngig von der Identit√§tsversion enth√§lt das Zielmigrationsskript unterschiedliche Anweisungen zum Aktualisieren.  Die Hauptsache hier ist, nicht zu vergessen, die EFMigrationsHistory-Tabelle zu koordinieren, wenn EF zuvor verwendet wurde und es in Zukunft geplant ist, beispielsweise die IdentityUser-Entit√§t auf zus√§tzliche Felder zu erweitern. </p><br><p>  Im Folgenden wird jedoch beschrieben, wie Sie IdentityServer4 richtig konfigurieren und zusammen mit Windows-Konten konfigurieren. </p><br><h2 id="plan-realizacii">  Umsetzungsplan </h2><br><p>  Aus NDA-Gr√ºnden werde ich nicht beschreiben, wie wir IS4 in unserem Projekt implementiert haben. In diesem Artikel zeige ich Ihnen jedoch auf einer einfachen ASP.NET Core-Site, die von Grund auf neu erstellt wurde, welche Schritte Sie ausf√ºhren m√ºssen, um eine vollst√§ndig konfigurierte und funktionsf√§hige Anwendung zu erhalten das IdentityServer4 f√ºr Autorisierungs- und Authentifizierungszwecke verwendet. <br>  Um das gew√ºnschte Verhalten zu realisieren, m√ºssen wir die folgenden Schritte ausf√ºhren: </p><br><ul><li>  Erstellen Sie ein leeres ASP.Net Core-Projekt und konfigurieren Sie die Verwendung von IdentityServer4. </li><li>  F√ºgen Sie einen Client als Angular-Anwendung hinzu. </li><li>  Melden Sie sich √ºber Open-ID-Connect Google an </li><li>  Windows-Authentifizierungsoption hinzuf√ºgen </li></ul><br><p>  Aus Gr√ºnden der K√ºrze befinden sich alle drei Komponenten (IdentityServer, WebAPI, Angular Client) im selben Projekt.  Die ausgew√§hlte Art der Interaktion zwischen dem Client und IdentityServer (GrantType) ist der implizite Fluss, wenn das access_token im Browser an die Anwendungsseite √ºbergeben und dann f√ºr die Interaktion mit der WebAPI verwendet wird.  <em>Nach den √Ñnderungen im ASP.NET Core-Repository wird der implizite Datenfluss durch den Autorisierungscode + PKCE ersetzt.)</em> </p><br><p>  Beim Erstellen und √Ñndern der Anwendung wird die .NET Core-Befehlszeilenschnittstelle h√§ufig verwendet. Sie muss auf dem System an der Stelle mit der neuesten Version von Preview Core 3.0 installiert sein (zum Zeitpunkt des Schreibens von Artikel 3.0.100-Preview7-012821). </p><br><h2 id="sozdanie-i-konfigurirovanie-web-proekta">  Erstellung und Konfiguration eines Webprojekts </h2><br><p>  Die Ver√∂ffentlichung von IdentityServer Version 4 war durch das vollst√§ndige Ausschneiden der Benutzeroberfl√§che aus diesem Framework gekennzeichnet.  Jetzt haben Entwickler das volle Recht, die Hauptschnittstelle des Autorisierungsservers selbst zu bestimmen.  Es gibt verschiedene M√∂glichkeiten.  Eine der beliebtesten ist die Verwendung der Benutzeroberfl√§che aus dem QuickStart-Benutzeroberfl√§chenpaket, das sich im offiziellen <a href="">Github-</a> Repository befindet. </p><br><p>  Eine andere, nicht weniger bequeme M√∂glichkeit ist die Integration in die Benutzeroberfl√§che von ASP NET Core Identity. In diesem Fall muss der Entwickler die entsprechende Middleware im Projekt korrekt konfigurieren.  Diese Methode wird sp√§ter beschrieben. </p><br><p>  Beginnen wir mit der Erstellung eines einfachen Webprojekts. F√ºhren Sie dazu die folgende Anweisung in der Befehlszeile aus: </p><br><pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code> </pre> <br><p>  Nach der Ausf√ºhrung wird die Ausgabe ein Webanwendungsframework sein, das schrittweise in den von uns ben√∂tigten Zustand gebracht wird.  Hier m√ºssen Sie reservieren, dass .Net Core 3.0 for Identity im Gegensatz zur schwergewichtigen MVC leichtere RazorPages verwendet. <br>  Jetzt m√ºssen Sie unserem Projekt IdentityServer-Unterst√ºtzung hinzuf√ºgen.  Installieren Sie dazu die erforderlichen Pakete: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6 dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code> </pre> <br><p>  Zus√§tzlich zu Links zu Autorisierungsserverpaketen haben wir hier die Entity Framework-Unterst√ºtzung zum Speichern von Benutzerinformationen im Identity-√ñkosystem hinzugef√ºgt.  Der Einfachheit halber verwenden wir die SQLite-Datenbank. </p><br><p>  Um die Datenbank zu initialisieren, erstellen Sie unser Benutzermodell und unseren Datenbankkontext. Dazu deklarieren wir zwei ApplicationUser-Klassen, die von <em>IdentityUser</em> im Ordner Models und <em>ApplicationDbContext</em> geerbt wurden, geerbt von: <em>ApiAuthorizationDbContext im Ordner Data.</em> <br></p><p>  Als N√§chstes m√ºssen Sie die Verwendung des EntityFramework-Kontexts konfigurieren und die Datenbank erstellen.  Dazu schreiben wir den Kontext in die <em>ConfigureServices-</em> Methode der Startup-Klasse: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddRazorPages(); }</code> </pre> <br><p>  <em>F√ºgen</em> Sie die Verbindungszeichenfolge zu <em>appsettings.json hinzu</em> </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data Source=data.db"</span></span> },</code> </pre><br><p>  Jetzt k√∂nnen Sie die anf√§ngliche Migration erstellen und das Datenbankschema initialisieren.  Es ist zu beachten, dass das installierte Tool f√ºr ef core erforderlich ist (f√ºr die betreffende Vorschau wird Version 3.0.0-Preview7.19362.6 ben√∂tigt). </p><br><pre> <code class="plaintext hljs">dotnet ef migrations add Init dotnet ef database update</code> </pre> <br><p>  Wenn alle vorherigen Schritte fehlerfrei ausgef√ºhrt wurden, sollte die SQLite-Datendatei data.db in Ihrem Projekt angezeigt werden. </p><br><p>  In dieser Phase k√∂nnen wir die vollwertige F√§higkeit zur Verwendung von Asp.Net Core Identity vollst√§ndig konfigurieren und testen.  Nehmen Sie dazu √Ñnderungen an den Startmethoden vor <em>.</em>  <em>Configure</em> and <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddDefaultIdentity&lt;ApplicationUser&gt;() .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); //Startup. Configure: app.UseAuthentication(); app.UseAuthorization(); app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); });</span></span></code> </pre> <br><p>  Mit diesen Zeilen integrieren wir die M√∂glichkeit der Authentifizierung und Autorisierung in die Anforderungsverarbeitungspipeline.  F√ºgen Sie au√üerdem die Standardbenutzeroberfl√§che f√ºr Identit√§t hinzu. <br>  Es bleibt nur, um die Benutzeroberfl√§che zu reparieren und den Seiten \ Shared eine neue Razor-Ansicht mit dem Namen <em>_LoginPartial.cshtml</em> und den folgenden Inhalten <em>hinzuzuf√ºgen</em> : </p><br><pre> <code class="html hljs xml">@using IdentityServer4WebApp.Models @using Microsoft.AspNetCore.Identity @inject SignInManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> SignInManager @inject UserManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> UserManager <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (SignInManager.IsSignedIn(User)) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Manage/Index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Manage"</span></span></span><span class="hljs-tag">&gt;</span></span>Hello @User.Identity.Name!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Logout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-route-returnUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link btn btn-link text-dark"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } else { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Register"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Der obige Pr√§sentationscode sollte Links zum Identit√§tsschnittstellenbereich mit integrierten Benutzersteuerelementen im Navigationsbereich hinzuf√ºgen (Login und Passwort, Registrierung usw.). </p><br><p>  Um das Rendern neuer <em>Men√ºelemente</em> zu erreichen, <em>√§ndern</em> wir einfach <em>die</em> Datei <em>_Layout.cshtml</em> , indem wir das Rendern dieser Teilansicht hinzuf√ºgen. </p><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Index"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Privacy"</span></span></span><span class="hljs-tag">&gt;</span></span>Privacy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">partial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_LoginPartial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!‚Äì‚Äì‚Äì‚Äì</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Und jetzt versuchen wir, unsere Anwendung auszuf√ºhren und auf die Links zu klicken, die im Kopf erscheinen <br>  Men√º sollte der Benutzer eine Seite mit einer Begr√º√üung und Anfrage sehen <br>  Login und Passwort eingeben.  In diesem Fall k√∂nnen Sie sich registrieren und anmelden - alles <br>  sollte funktionieren. </p><br><p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br><p>  Die Entwickler von IdentityServer4 haben die Integration von ASP.NET Identity und dem Server-Framework selbst hervorragend verbessert.  Um die M√∂glichkeit zur Verwendung von OAuth2-Token hinzuzuf√ºgen, m√ºssen Sie unser Projekt durch einige neue Anweisungen im Code erg√§nzen. </p><br><p>  F√ºgen Sie in der vorletzten Zeile der <em>Startup.ConfigureServices-</em> Methode die Konfiguration von IS4-Konventionen √ºber ASP.NET Core Identity hinzu: </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code> </pre> <br><p>  Die AddApiAuthorization-Methode weist das Framework an, eine bestimmte unterst√ºtzte Konfiguration zu verwenden, haupts√§chlich √ºber die Datei appsettings.json.  Derzeit sind die integrierten IS4-Verwaltungsfunktionen nicht so flexibel und sollten als Ausgangspunkt f√ºr die Erstellung Ihrer Anwendungen angesehen werden.  In jedem Fall k√∂nnen Sie die √ºberladene Version dieser Methode verwenden und die Parameter durch R√ºckruf detaillierter konfigurieren. </p><br><p>  Als N√§chstes rufen wir die Hilfsmethode auf, mit der die Anwendung so konfiguriert wird, dass die vom Framework ausgegebenen JWT-Token √ºberpr√ºft werden. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddIdentityServerJwt();</code> </pre> <br><p>  <em>F√ºgen Sie</em> schlie√ülich in der <em>Startup.Configure-</em> Methode Middleware f√ºr hinzu <br>  Bereitstellen von Open ID Connect-Endpunkten </p><br><pre> <code class="cs hljs">app.UseAuthentication(); app.UseAuthorization(); app.UseIdentityServer();<span class="hljs-comment"><span class="hljs-comment">//&lt;-</span></span></code> </pre> <br><p>  Wie oben erw√§hnt, lesen die verwendeten Hilfsmethoden die Konfiguration in <br>  Anwendungseinstellungsdatei <em>appsettings.json</em> , in der wir eine neue hinzuf√ºgen m√ºssen <br>  Abschnitt <em>IdentityServer</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Clients"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"TestIdentityAngular"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Profile"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServerSPA"</span></span> } } }</code> </pre> <br><p>  In diesem Abschnitt wird ein Client mit dem Namen TestIdentityAngular definiert, den wir dem zuk√ºnftigen Browser-Client und einem bestimmten Konfigurationsprofil zuweisen. </p><br><p>  Application Profiles ist ein neues IdentityServer-Konfigurationstool, das mehrere vordefinierte Konfigurationen mit der M√∂glichkeit bietet, bestimmte Parameter zu verfeinern.  Wir werden das <em>IdentityServerSPA-</em> Profil verwenden, das f√ºr F√§lle entwickelt wurde, in denen sich der Browser-Client und das Framework im selben Projekt befinden und die folgenden Parameter haben: </p><br><ul><li>  Die Ressource redirect_uri ist auf <em>/ authentication / login-callback festgelegt</em> . </li><li>  Ressource post_logout_redirect_uri, gesetzt auf <em>/ authentication / logout-callback.</em> </li><li>  Der Bereichssatz enth√§lt openid, profile f√ºr jede Anwendungs-API-Ressource. </li><li>  Satz zul√§ssiger OIDC-Antworttypen - id_token-Token </li><li>  GrantType f√ºr den Client - Implizit </li></ul><br><p>  Andere m√∂gliche Profile sind <em>SPA</em> (Anwendung ohne IS4), <em>IdentityServerJwt</em> (mit IS4 gemeinsam genutzte <em>API</em> ), <em>API</em> (separate API). </p><br><p>  Dar√ºber hinaus registriert die Konfiguration Ressourcen: </p><br><ul><li>  ApiResources: Eine API-Ressource mit dem Namen &lt;&lt; appname &gt;&gt; API mit Eigenschaften f√ºr alle Clients (*). </li><li>  IdentityServerResources: <em>IdentityResources.OpenId ()</em> und <em>IdentityResources.Profile ()</em> </li></ul><br><p>  Wie Sie wissen, verwendet IdentityServer Zertifikate zum Signieren von Token. Ihre Parameter k√∂nnen auch in der Konfigurationsdatei festgelegt werden, sodass wir sie zum Zeitpunkt des Tests verwenden k√∂nnen <br>  x509-Testzertifikat, dazu m√ºssen Sie es im Abschnitt "Schl√ºssel" der Datei <em>appsettings.Development.json angeben</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }</code> </pre> <br><p>  Jetzt k√∂nnen wir sagen, dass das Backend, mit dem Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">IdentityServer verwenden k√∂nnen, bereit ist</a> und Sie mit der Implementierung der Browseranwendung beginnen k√∂nnen. </p><br><h2 id="realizaciya-klienta-na-angular">  Angular Client-Implementierung </h2><br><p>  Unser browserbasiertes SPA wird auf der Angular-Plattform geschrieben.  Die Anwendung enth√§lt zwei Seiten, eine f√ºr nicht autorisierte Benutzer und eine f√ºr authentifizierte Benutzer.  Die Beispiele verwenden Version 8.1.2 </p><br><p>  Erstellen Sie zun√§chst den zuk√ºnftigen Rahmen: </p><br><pre> <code class="plaintext hljs">ng new ClientApp</code> </pre> <br><p>  Beim Erstellen m√ºssen Sie den Vorschlag zur Verwendung des Routings mit "Ja" beantworten.  Und ein wenig stilisieren Sie die Seite durch die Bootstrap-Bibliothek: </p><br><pre> <code class="plaintext hljs">cd ClientApp ng add bootstrap</code> </pre> <br><p>  Als N√§chstes m√ºssen Sie unserer Hauptanwendung SPA-Hosting-Unterst√ºtzung hinzuf√ºgen.  Zuerst m√ºssen Sie das csproj-Projekt reparieren - f√ºgen Sie Informationen zu unserer Browseranwendung hinzu. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span>Latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span>ClientApp\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Exclude</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)node_modules\**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DebugEnsureNodeEnv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node --version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContinueOnError</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExitCode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorCode"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ErrorCode)' != '0'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WorkingDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"npm install"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Installieren Sie anschlie√üend das spezielle Nuget-Paket, um Browseranwendungen zu unterst√ºtzen. </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Und wir verwenden seine Hilfsmethoden: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup. ConfigureServices: services.AddSpaStaticFiles(configuration =&gt; { configuration.RootPath = "ClientApp/dist"; }); //Startup. Configure: app.UseSpa(spa =&gt; { spa.Options.SourcePath = "ClientApp"; if (env.IsDevelopment()) { spa.UseAngularCliServer(npmScript: "start"); } });</span></span></code> </pre><br><p>  Zus√§tzlich zum Aufrufen neuer Methoden m√ºssen Sie die <em>Seiten</em> Razor <em>Index.chtml</em> und <em>_ViewStart.chtml</em> l√∂schen, damit die SPA-Dienste jetzt den Inhalt bereitstellen. </p><br><p>  Wenn alles gem√§√ü den Anweisungen ausgef√ºhrt wurde, wird beim Start der Anwendung die Standardseite auf dem Bildschirm angezeigt. </p><br><p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br><p>  Jetzt m√ºssen Sie das Routing konfigurieren, dazu f√ºgen wir dem Projekt 2 hinzu <br>  Komponente: </p><br><pre> <code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true ng generate component Data -t=true -s=true --skipTests=true</code> </pre> <br><p>  Wir schreiben sie in die Routing-Tabelle: </p><br><pre> <code class="plaintext hljs">const routes: Routes = [ { path: '', component: HomeComponent, pathMatch: 'full' }, { path: 'data', component: DataComponent } ];</code> </pre> <br><p>  Und wir √§ndern die Datei app.component.html, um die Men√ºelemente korrekt anzuzeigen. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Client App<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ngClass</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{"show": isExpanded}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActiveOptions</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{ exact: true }'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/data"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Web api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align:center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"router-outlet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In diesem Schritt k√∂nnen Sie die grundlegende Vorbereitung des Anwendungsframeworks f√ºr die Implementierung der Interaktion √ºber von IdentityServer ausgegebene Token abschlie√üen. </p><br><p>  Die aktuelle Phase der Vorbereitung des Frameworks unseres SPA kann als abgeschlossen bezeichnet werden. Jetzt sollten wir mit der Implementierung des Moduls beginnen, das f√ºr die Interaktion mit dem Serverteil mithilfe der OpenID Connect- und OAuth-Protokolle verantwortlich ist.  Gl√ºcklicherweise haben die Entwickler von Microsoft diesen Code bereits implementiert, und jetzt k√∂nnen Sie dieses Modul einfach von ihnen ausleihen.  Da mein Artikel auf ASP.NET Core 3.0 Pre-Release 7 basiert, nehmen wir den gesamten Code mit dem Release-Tag ‚Äûv3.0.0-Preview7.19365.7‚Äú auf <a href="">Github</a> . </p><br><p>  Vor dem Importieren des Codes m√ºssen Sie die <em>oidc-client-</em> Bibliothek installieren <br>  bietet viele Schnittstellen f√ºr Browser-Anwendungen sowie <br>  unterst√ºtzt die Verwaltung von Benutzersitzungen und Zugriffstoken.  F√ºr <br>  Um damit arbeiten zu k√∂nnen, m√ºssen Sie das entsprechende Paket installieren. </p><br><pre> <code class="plaintext hljs">npm install oidc-client@1.8.0</code> </pre> <br><p>  Jetzt ist es in unserem SPA erforderlich, ein Modul zu implementieren, das die vollst√§ndige Interaktion gem√§√ü den erforderlichen Protokollen kapselt.  Dazu m√ºssen Sie das gesamte ApiAuthorizationModule-Modul aus der obigen ASP.NET Core-Repository-Bezeichnung entnehmen und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">alle</a> zugeh√∂rigen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dateien</a> zur Anwendung hinzuf√ºgen. </p><br><p>  Au√üerdem m√ºssen Sie es in das Hauptmodul der AppModule-Anwendung importieren: </p><br><pre> <code class="plaintext hljs">@NgModule({ declarations: [ AppComponent, HomeComponent, DataComponent ], imports: [ BrowserModule, HttpClientModule, ApiAuthorizationModule,//&lt;- AppRoutingModule ], providers: [], bootstrap: [AppComponent] }) export class AppModule { }</code> </pre> <br><p>  Um neue Men√ºelemente im importierten Modul anzuzeigen, gibt es eine <em>App-Login-Men√ºkomponente</em> : <br>  es kann komplett ge√§ndert werden, um Ihren Bed√ºrfnissen zu entsprechen und hinzuzuf√ºgen <br>  einen Link dazu im Navigationsbereich der <em>Ansicht app.component.html</em> . </p><br><p>  Das API-Autorisierungsmodul zum Konfigurieren der OpenID-Verbindung des SPA-Clients muss f√ºr die Implementierung einen speziellen Endpunkt im Anwendungs-Backend verwenden <br>  muss diese Schritte befolgen: </p><br><ol><li>  Korrigieren Sie die Client-ID gem√§√ü den Angaben in der Konfigurationsdatei appsettings.json im Abschnitt IdentityServer: Clients. In unserem Fall handelt es sich um TestIdentityAngular. Sie wird in die erste Zeile des Konstantensatzes api-authorisation.constants.ts geschrieben. </li><li>  F√ºgen Sie einen OidcConfigurationController-Controller hinzu, der die Konfiguration direkt an die Browseranwendung zur√ºckgibt </li></ol><br><p>  Der Code des erstellten Controllers wird unten dargestellt: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OidcConfigurationController</span></span>: <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IClientRequestParametersProvider _clientRequestParametersProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OidcConfigurationController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span></span></span><span class="hljs-function">)</span></span> { _clientRequestParametersProvider = clientRequestParametersProvider; } [HttpGet(<span class="hljs-string"><span class="hljs-string">"_configuration/{clientId}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientRequestParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromRoute]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(parameters); } }</code> </pre> <br><p>  Sie m√ºssen auch die Punkt-API-Unterst√ºtzung f√ºr die Backend-Anwendung konfigurieren. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddControllers();//&lt;-  services.AddRazorPages(); //Startup. Configure: app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); endpoints.MapControllers(); });</span></span></code> </pre><br><p>  Jetzt ist es Zeit, die Anwendung zu starten.  Auf der Hauptseite im oberen Men√º sollten zwei Elemente angezeigt werden: <em>Anmelden</em> und <em>Registrieren</em> .  Au√üerdem fordert das importierte Autorisierungsmodul beim Start von der Serverseite die Client-Konfiguration an, die anschlie√üend im Protokoll ber√ºcksichtigt wird.  Eine beispielhafte Konfigurationsausgabe ist unten dargestellt: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authority"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"TestIdentityAngular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"post_logout_redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"response_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_token token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span></span> }</code> </pre> <br><p>  Wie Sie sehen k√∂nnen, erwartet der Client w√§hrend der Interaktion, dass er das ID-Token und das Zugriffstoken erh√§lt, und es ist auch f√ºr den Zugriffsbereich auf unsere API konfiguriert. </p><br><p>  Wenn wir nun den Men√ºpunkt Anmelden ausw√§hlen, sollten wir zur Seite unseres IdentityServers4 weitergeleitet werden. Hier k√∂nnen wir den Login und das Passwort eingeben. Wenn diese korrekt sind, werden wir sofort zur√ºck zur Browseranwendung weitergeleitet, die wiederum <em>id_token</em> und <em>access_token erh√§lt</em> .  Wie Sie unten sehen k√∂nnen, hat die App-Login-Men√º-Komponente selbst festgestellt, dass die Autorisierung erfolgreich abgeschlossen wurde, und eine ‚ÄûBegr√º√üung‚Äú sowie eine Schaltfl√§che zum <em>Abmelden</em> angezeigt. </p><br><p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br><p>  Wenn Sie die "Entwicklertools" im Browser √∂ffnen, k√∂nnen Sie im Hintergrund die gesamte Interaktion mithilfe des OIDC / OAuth-Protokolls anzeigen.  Dadurch werden Informationen zum Autorisierungsserver abgerufen <br>  √ºber den Endpunkt <em>.well-bekannte / openid-Konfiguration</em> und Pooling-Sitzungsaktivit√§t √ºber den Connect / Checksession-Zugangspunkt.  Dar√ºber hinaus ist das Autorisierungsmodul f√ºr den Mechanismus "Stille Aktualisierung von Token" konfiguriert. Wenn das Zugriffstoken abl√§uft, √ºbergibt das System die Autorisierungsschritte unabh√§ngig in einem versteckten Iframe.  Sie k√∂nnen die automatische <em>Tokenaktualisierung</em> deaktivieren, indem Sie den Wert des Parameters <em>includeIdTokenInSilentRenew</em> in der Datei <em>authorize.service.ts</em> auf "false" setzen. </p><br><p>  Jetzt k√∂nnen Sie den Zugriff auf nicht autorisierte Benutzer √ºber die Komponenten der SPA-Anwendung sowie einige API-Controller auf der R√ºckseite einschr√§nken.  Um einige APIs zu demonstrieren, erstellen wir eine <em>ExchangeRateItem-</em> Klasse im Ordner "Models" sowie einen Controller im Ordner "Controller", der einige zuf√§llige Daten zur√ºckgibt. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Controller: [ApiController] public class ExchangeRateController { private static readonly string[] Currencies = new[] { "EUR", "USD", "BGN", "AUD", "CNY", "TWD", "NZD", "TND", "UAH", "UYU", "MAD" }; [HttpGet("api/rates")] public IEnumerable&lt;ExchangeRateItem&gt; Get() { var rng = new Random(); return Enumerable.Range(1, 5).Select(index =&gt; new ExchangeRateItem { FromCurrency = "RUR", ToCurrency = Currencies[rng.Next(Currencies.Length)], Value = Math.Round(1.0+ 1.0/rng.Next(1, 100),2) }) .ToArray(); } } //Models: public class ExchangeRateItem { public string FromCurrency { get; set; } public string ToCurrency { get; set; } public double Value { get; set; } }</span></span></code> </pre><br><p>  Erstellen Sie als N√§chstes auf der Front-End-Seite eine neue Komponente, die empfangen wird <br>  und Daten zu Wechselkursen des gerade erstellten Controllers anzeigen. </p><br><pre> <code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code> </pre> <br><p>  Der Inhalt der Komponente sollte folgenderma√üen aussehen: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core'; import { HttpClient } from '@angular/common/http'; import { Observable, of, Subject } from 'rxjs'; import { catchError } from 'rxjs/operators'; @Component({ selector: 'app-exchange-rate', template: ` &lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt; {{msg}} &lt;/div&gt; &lt;table class='table table-striped'&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;From currency&lt;/th&gt; &lt;th&gt;To currency&lt;/th&gt; &lt;th&gt;Rate&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr *ngFor="let rate of rates | async"&gt; &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt; &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt; &lt;td&gt;{{ rate.value }}&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/table&gt; `, styles: [] }) export class ExchangeRateComponent implements OnInit { public rates: Observable&lt;ExchangeRateItem[]&gt;; public errorMessage: Subject&lt;string&gt;; @Input() public apiUrl: string; constructor(private http: HttpClient) { this.errorMessage = new Subject&lt;string&gt;(); } ngOnInit() { this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) ); } private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; { return (error) =&gt; { let message = ''; if (error.error instanceof ErrorEvent) { message = `Error: ${error.error.message}`; } else { message = `Error Code: ${error.status}\nMessage: ${error.message}`; } subject.next(message); let emptyResult: ExchangeRateItem[] = []; return of(emptyResult); } } } interface ExchangeRateItem { fromCurrency: string; toCurrency: string; value: number; }</code> </pre> </div></div><br><p>  Jetzt muss es auf der App-Datenseite einfach in der Vorlage verwendet werden, indem die Zeile &lt;app-exchange-rate apiUrl = "Rates"&gt; &lt;/ app-EXchange-Rate&gt; geschrieben wird, und Sie k√∂nnen das Projekt erneut starten.  Wenn wir entlang des Zielpfads navigieren, sehen wir, dass die Komponente die Daten empfangen und in Form einer Tabelle angezeigt hat. </p><br><p>  Als N√§chstes werden wir versuchen, eine Anforderung zur Autorisierung des Zugriffs auf die API des Controllers hinzuzuf√ºgen. <em>F√ºgen Sie dazu das</em> Attribut <em>[Authorize]</em> in der <em>ExchangeRateController-</em> Klasse hinzu und f√ºhren Sie SPA erneut aus. Nachdem wir jedoch zu der Komponente zur√ºckgekehrt sind, die unsere API aufruft, wird ein Fehler angezeigt Autorisierungsheader. </p><br><p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br><p>  Sie k√∂nnen ausgehenden Anforderungen ein Autorisierungstoken korrekt hinzuf√ºgen <br>  Aktivieren Sie den Angular Interceptors Interceptor-Mechanismus.  Gl√ºcklicherweise enth√§lt das importierte Modul bereits den erforderlichen Typ, wir m√ºssen ihn nur im Basismodul der Anwendung registrieren. </p><br><pre> <code class="plaintext hljs">providers: [ { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true } ],</code> </pre> <br><p>  Nach diesen Schritten sollte alles richtig funktionieren.  Wenn Sie sich die Entwicklertools noch einmal ansehen, wird im Browser der neue Berechtigungsheader f√ºr Bearer access_token angezeigt.  Im Backend wird dieses Token von IdentityServer √ºberpr√ºft und es wird auch die Berechtigung zum Aufrufen eines sicheren API-Punkts erteilt. </p><br><p>  Am Ende des Beispiels f√ºr die Integration mit dem Autorisierungsserver k√∂nnen Sie den Aktivierungsschutz mit den Wechselkursdaten im SPA auf die Route setzen. Dadurch wird verhindert, dass Benutzer zur Seite wechseln, wenn sie derzeit nicht autorisiert sind.  Dieser Protektor wird auch im zuvor importierten Modul vorgestellt. Sie m√ºssen ihn nur an die Zielroute h√§ngen. </p><br><pre> <code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard] }</code> </pre> <br><p>  Wenn sich der Benutzer nicht bei der Anwendung angemeldet und einen Link zu unserer gesch√ºtzten Komponente ausgew√§hlt hat, wird er sofort mit der Aufforderung zur Eingabe eines Logins und eines Passworts auf die Autorisierungsseite weitergeleitet.  Der resultierende Code ist auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github</a> verf√ºgbar. </p><br><h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google">  Verbinden eines externen Logins √ºber einen Google-Anbieter </h2><br><p>  Es gibt ein separates Microsoft.AspNetCore.Authentication.Google Nuget-Paket f√ºr die Verbindung der Anmeldung √ºber Google-Konten f√ºr ASP.NET Core 1.1 / 2.0 +. Aufgrund von √Ñnderungen in den Richtlinien des Unternehmens selbst hat Microsoft jedoch Pl√§ne f√ºr ASP.NET Core 3.0+ erkenne es als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">veraltet</a> .  Und jetzt wird empfohlen, eine Verbindung √ºber die <em>Hilfsmethoden OpenIdConnectExtensions</em> und <em>AddOpenIdConnect herzustellen</em> , die wir in diesem Artikel verwenden werden. </p><br><p>  Installieren Sie die OpenIdConnect-Erweiterung: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Um zu beginnen, m√ºssen wir zwei Schl√ºsselwerte von Google abrufen - Id Client und Client Secret. Dazu wird vorgeschlagen, die folgenden Schritte auszuf√ºhren: </p><br><ul><li>  Folgen Sie dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> und w√§hlen Sie die Schaltfl√§che ‚ÄûPROJEKT KONFIGURIEREN‚Äú. </li><li>  Geben Sie im angezeigten Dialogfeld den Webserver an. </li><li>     ¬´Authorized redirect URI¬ª           Google (..      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://localhost:44301/</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://localhost:44301/signin-google</a> ) </li><li>      ClientID  Client Secret. </li><li>         ,   ,   URL    . </li></ul><br><p>         <a href="">Secret Manager</a> .       ,    . </p><br><pre> <code class="plaintext hljs">dotnet user-secrets init dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID" dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code> </pre> <br><p>           Google. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddOpenIdConnect(<span class="hljs-string"><span class="hljs-string">"Google"</span></span>, <span class="hljs-string"><span class="hljs-string">"Google"</span></span>, o =&gt; { IConfigurationSection googleAuthNSection = Configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"Authentication:Google"</span></span>); o.ClientId = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientId"</span></span>]; o.ClientSecret = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientSecret"</span></span>]; o.Authority = <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com"</span></span>; o.ResponseType = OpenIdConnectResponseType.Code; o.CallbackPath = <span class="hljs-string"><span class="hljs-string">"/signin-google"</span></span>; }) .AddIdentityServerJwt();</code> </pre> <br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>     ,    <br>      Google.     ,    ,       SPA          . </p><br><p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br><p>  ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . </p><br><h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">      Windows </h2><br><p>   ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em> .  ,  IS4    ,        ,    <br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github</a> . ,             ASP.NET Core Identity 3.0. </p><br><p>          Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ): </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code> </pre> <br><p>    ,     Area   <em>Identity</em>    ,          . </p><br><p>         ,       .   ,  Identity      I <em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   : </p><br><pre> <code class="cs hljs">ExternalLogins = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList(); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt; &gt;&gt; ExternalLogins =(await _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != null ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</span></span></code> </pre> <br><p>         <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em> .    View         <em>Login.cshtml</em> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @provider.DisplayName account"</span></span></span><span class="hljs-tag">&gt;</span></span>@provider.DisplayName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;&lt; &gt;</span></span>&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span></span></span><span class="hljs-tag">&gt;</span></span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  ,  windows      <em>launchSettings.json</em> <br> (   IIS,       <em>web.config</em> ). </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:15479"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">44301</span></span> } },</code> </pre> <br><p>        ¬´Windows¬ª    . </p><br><p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br><p>     SPA      IdentityServer     .    ¬´¬ª    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em> ,     ,       WindowsIdentity. </p><br><p>    <em>ExternalLogin</em> ,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em> . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWindowsLoginAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnUrl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Principal <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WindowsPrincipal wp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redirectUrl = Url.Page(<span class="hljs-string"><span class="hljs-string">"./ExternalLogin"</span></span>, pageHandler: <span class="hljs-string"><span class="hljs-string">"Callback"</span></span>, values: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { returnUrl }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl); props.Items[<span class="hljs-string"><span class="hljs-string">"scheme"</span></span>] = IISDefaults.AuthenticationScheme; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(IISDefaults.AuthenticationScheme); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Name, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wi = wp.Identity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> WindowsIdentity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groups = wi.Groups.Translate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(NTAccount)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string"><span class="hljs-string">@"BUILTIN\Users"</span></span>, StringComparison.OrdinalIgnoreCase)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>, hasUsersGroup.ToString())); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsPrincipal(id), props); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect(props.RedirectUri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Challenge(IISDefaults.AuthenticationScheme); }</code> </pre> </div></div><br><p>       ,             . </p><br><p>    <em>ExternalLoginModel.OnPost</em>          : </p><br><pre> <code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider) { return await ProcessWindowsLoginAsync(returnUrl); }</code> </pre> <br><p>    Claim  Windows      Claim ¬´hasUsersGroup¬ª,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateClaims</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] claimTypes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claimTypes == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimTypesHash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(claimTypes); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.RemoveClaimsAsync(user, claims); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> claimTypes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.Principal.HasClaim(c =&gt; c.Type == claimType)) { claims = info.Principal.FindAll(claimType).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddClaimsAsync(user, claims); } } }</code> </pre> <br><p>       <em>OnPostConfirmationAsync</em> (    <br>     ). </p><br><pre> <code class="cs hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddLoginAsync(user, info); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"User created an account using {Name} provider."</span></span>, info.LoginProvider); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">// return LocalRedirect(returnUrl); }</span></span></code> </pre> <br><p>    <em>OnGetCallbackAsync</em> ,      . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, bypassTwoFactor : <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//</span></span></code> </pre> <br><p>  ,        WebAPI   <br>  ¬´hasUsersGroup¬ª.      ¬´ShouldHasUsersGroup¬ª </p><br><pre> <code class="cs hljs">services.AddAuthorization(options =&gt; { options.AddPolicy(<span class="hljs-string"><span class="hljs-string">"ShouldHasUsersGroup"</span></span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);}); });</code> </pre> <br><p>    <em>ExchangeRateController</em>       <br>     Policy. </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Authorize(Policy = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ShouldHasUsersGroup"</span></span></span><span class="hljs-meta">)</span></span>] [HttpGet(<span class="hljs-string"><span class="hljs-string">"api/internalrates"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;ExchangeRateItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalRates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number"><span class="hljs-number">-0.02</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;}); }</code> </pre> <br><p>   view    . </p><br><pre> <code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code> </pre> <br><p>    template          . </p><br><pre> <code class="html hljs xml">//internal-data.component.ts: template: `<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"internalrates"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag">&gt;</span></span> `, //app-routing.module.ts: { path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard] } //app.component.html: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/internaldata"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Internal api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>             <br> , ,    .   ,  accsee_token    <br>   claim   <em>hasUsersGroup</em> ,       <br>     ApiResources  .  ,    ,        <em>appsettings.json</em> ,           <em>Startup. ConfigureServices</em> . </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResource = options.ApiResources.First(); apiResource.UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }; });</code> </pre> <br><p> ,     ,    windows      ,         . </p><br><p>       ,   ‚Äì  Guard    claim   ¬´hasUsersGroup¬ª     ¬´  ¬ª.    Guard  : </p><br><pre> <code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code> </pre> <br><p>      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Injectable } from '@angular/core'; import { Observable } from 'rxjs'; import { map,tap} from 'rxjs/operators'; import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router'; import { AuthorizeService } from "./authorize.service"; import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants'; @Injectable({ providedIn: 'root' }) export class AuthorizeWindowsGroupGuardGuard implements CanActivate{ constructor(private authorize: AuthorizeService, private router: Router) {} canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree { return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));; } private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) { if (!isAuthenticated) { window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/"; } } }</code> </pre> </div></div><br><p> , ,         . </p><br><pre> <code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]</code> </pre> <br><p>     IdentityServer,      claims ( <em>sub</em> , <em>profile</em> ),     ¬´hasUsersGroup¬ª.      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identityResource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityResource { Name = <span class="hljs-string"><span class="hljs-string">"customprofile"</span></span>, DisplayName = <span class="hljs-string"><span class="hljs-string">"Custom profile"</span></span>, UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }, }; identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); options.IdentityResources.Add(identityResource);</code> </pre> <br><p> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>   ,         windows    ¬´ ¬ª   SPA ‚Äì   ,     ,    Guard    . </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p> ,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github</a>   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461433/">https://habr.com/ru/post/de461433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461417/index.html">Wie ich db4o in einem industriellen System abgelehnt habe</a></li>
<li><a href="../de461421/index.html">So versichern Sie sich gegen m√∂gliche Verluste bei einer Investition an der B√∂rse: Strukturprodukte</a></li>
<li><a href="../de461423/index.html">11 Tipps: Pr√§sentieren von UI / UX-Arbeiten f√ºr ‚ÄûNicht-Designer‚Äú</a></li>
<li><a href="../de461425/index.html">Wie man ein Produktmanager wird und weiter w√§chst</a></li>
<li><a href="../de461431/index.html">"Liebt und mag nicht": DNS √ºber HTTPS</a></li>
<li><a href="../de461435/index.html">Emotionserkennung unter Verwendung eines Faltungs-Neuronalen Netzwerks</a></li>
<li><a href="../de461437/index.html">370 Gl√ºhbirnen</a></li>
<li><a href="../de461439/index.html">Starten der React- und TypeScript-Komponentenbibliothek</a></li>
<li><a href="../de461441/index.html">Berichte √ºber den Speicherstatus mithilfe von R. Parallel Computing, Grafiken, XLSX, E-Mail und all dies</a></li>
<li><a href="../de461443/index.html">Nachanalyse: Was ist √ºber den j√ºngsten Angriff auf das SKS Keyserver-Kryptoschl√ºsselservernetzwerk bekannt?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>