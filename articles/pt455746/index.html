<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèº üßû üÜô Celesta 7.x: ORM, migra√ß√£o e teste ‚Äúem um pacote‚Äù üëÅÔ∏è üå¥ üçñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Talvez voc√™ j√° saiba algo sobre a biblioteca Celesta de c√≥digo aberto. Caso contr√°rio, n√£o importa, agora contaremos tudo. Mais um ano se passou, a ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Celesta 7.x: ORM, migra√ß√£o e teste ‚Äúem um pacote‚Äù</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455746/"><p>  Talvez voc√™ j√° saiba algo sobre a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Celesta de</a> c√≥digo aberto.  Caso contr√°rio, n√£o importa, agora contaremos tudo.  Mais um ano se passou, a vers√£o 7.x foi lan√ßada, muitas coisas mudaram e chegou a hora de resumir as mudan√ßas e, ao mesmo tempo, lembrar o que √© Celesta em geral. </p><br><div style="text-align:center;"><img width="350" src="https://habrastorage.org/webt/jj/7z/jt/jj7zjthmrh2dhdo4v0ueefqj6uq.png"></div><a name="habracut"></a><br><p> Se voc√™ ainda n√£o ouviu nada sobre o Celesta e, ao ler este artigo, deseja saber para quais tarefas de neg√≥cios seu aplicativo √© mais eficaz, recomendo a primeira parte da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">postagem antiga</a> ou este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo de meia hora</a> (exceto palavras sobre o uso da linguagem Python).  Mas melhor ainda, leia este artigo primeiro.  Come√ßarei com as altera√ß√µes que ocorreram na vers√£o 7 e, em seguida, examinarei um exemplo t√©cnico completo do uso da vers√£o moderna do Celesta para escrever um pequeno servi√ßo de back-end para um aplicativo Java usando o Spring Boot. </p><br><h2 id="chto-izmenilos-v-versii-7x">  O que mudou na vers√£o 7.x? </h2><br><ol><li>  N√≥s nos recusamos a usar o Jython como uma linguagem incorporada ao Celesta.  Se anteriormente come√ßamos a falar sobre o Celesta com o fato de que a l√≥gica de neg√≥cios √© escrita em Python, agora ... qualquer linguagem Java pode servir como a linguagem da l√≥gica de neg√≥cios: Java, Groovy, JRuby ou o mesmo Jython.  Agora, o Celesta n√£o chama o c√≥digo de l√≥gica de neg√≥cios, mas o c√≥digo de l√≥gica de neg√≥cios usa o Celesta e suas classes de acesso a dados como a biblioteca Java mais comum.  Sim, a compatibilidade com vers√µes anteriores foi violada por causa disso, mas esse √© o pre√ßo que est√°vamos dispostos a pagar.  Infelizmente, nossa aposta no Jython perdeu.  Quando come√ßamos a usar o Jython, h√° alguns anos, era um projeto animado e promissor, mas, com o passar dos anos, seu desenvolvimento desacelerou, o registro acumulado da especifica√ß√£o de linguagem se acumulou, os problemas de compatibilidade para a maioria das bibliotecas de pip n√£o foram resolvidos.  A √∫ltima gota foram os novos bugs nas vers√µes mais recentes do idioma, que se manifestaram ao trabalhar em uma carga de produ√ß√£o.  N√≥s mesmos n√£o temos os recursos para apoiar o projeto Jython, e decidimos participar dele.  O Celesta n√£o √© mais dependente do Jython. </li><li>  As classes de acesso a dados agora s√£o geradas por c√≥digo na linguagem Java (e n√£o em Python, como antes) usando o plug-in Maven.  E como passamos da digita√ß√£o din√¢mica para a est√°tica por causa disso, havia mais oportunidades de refatora√ß√£o e ficou mais f√°cil escrever c√≥digo subjetivamente correto. </li><li>  Apareceu a extens√£o para o JUnit5, tornando-se muito conveniente escrever testes de l√≥gica que funcionem com o banco de dados no JUnit5 (que ser√° discutido mais adiante). </li><li>  Um projeto separado apareceu - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">spring-boot-starter-celesta</a> , que, como o nome indica, √© o iniciador do Celesta no Spring Boot.  A capacidade de compactar aplicativos Celesta em servi√ßos Spring Boot facilmente implant√°veis ‚Äã‚Äãcompensou a perda da capacidade de atualizar o aplicativo no servidor, simplesmente alterando a pasta com scripts Python. </li><li>  Transferimos toda a documenta√ß√£o do Wiki para o formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AsciiDoctor</a> , colocamos no controle de vers√£o junto com o c√≥digo e agora temos documenta√ß√£o atualizada para cada vers√£o do Celesta.  Para a vers√£o mais recente, a documenta√ß√£o on-line est√° dispon√≠vel aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://courseorchestra.github.io/celesta/</a> </li><li>  Muitas vezes nos perguntam se √© poss√≠vel usar a migra√ß√£o de banco de dados por meio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DDL idempotente</a> separadamente do Celesta.  Agora, existe uma oportunidade usando a ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2bass</a> . </li></ol><br><h2 id="chto-takoe-selesta-i-chto-ona-umeet">  O que √© Celesta e o que ela pode fazer? </h2><br><p>  Em poucas palavras, Celesta √©: </p><br><ul><li>  uma camada intermedi√°ria entre o banco de dados relacional e o c√≥digo da l√≥gica de neg√≥cios, com base na abordagem de design do <em>banco de dados primeiro</em> , </li><li>  mecanismo de migra√ß√£o da estrutura do banco de dados, </li><li>  estrutura para testar c√≥digo que funciona com dados. </li></ul><br><p>  Suportamos quatro tipos de bancos de dados relacionais: PostgreSQL, MS SQL Server, Oracle e H2. </p><br><p>  Principais recursos do Celesta: </p><br><ol><li>  Um princ√≠pio muito semelhante ao princ√≠pio b√°sico do Java: "Escreva uma vez, execute em todos os RDBMS suportados".  O c√≥digo da l√≥gica de neg√≥cios n√£o sabe em que tipo de banco de dados ele ser√° executado.  Voc√™ pode escrever o c√≥digo da l√≥gica de neg√≥cios e execut√°-lo no MS SQL Server, depois alternar para PostgreSQL, e isso acontecer√° sem complica√ß√µes (bem, quase :) </li><li>  Reestrutura√ß√£o autom√°tica em um banco de dados ativo.  A maior parte do ciclo de vida dos projetos Celesta ocorre quando o banco de dados de trabalho j√° est√° l√° e √© preenchido com dados que precisam ser salvos, mas tamb√©m √© necess√°rio alterar constantemente sua estrutura.  Um dos principais recursos do Celesta √© a capacidade de "ajustar" automaticamente a estrutura do banco de dados ao seu modelo de dados. </li><li>  Teste.  √â prestada muita aten√ß√£o para garantir que o c√≥digo do Celesta seja test√°vel, para que possamos testar automaticamente m√©todos que modificam dados no banco de dados, fazendo isso de maneira f√°cil, r√°pida e elegante, sem usar ferramentas externas, como DbUnit e cont√™ineres. </li></ol><br><h2 id="dlya-chego-nuzhna-nezavisimost-ot-tipa-subd">  Por que voc√™ precisa de independ√™ncia do tipo de DBMS? </h2><br><p>  A independ√™ncia do c√≥digo da l√≥gica de neg√≥cios em rela√ß√£o ao tipo de DBMS n√£o foi o primeiro ponto que colocamos: o c√≥digo escrito para o Celesta n√£o sabe em qual DBMS ele est√° sendo executado.  Porque </p><br><p>  Em primeiro lugar, devido ao fato de a escolha de um tipo de SGBD n√£o ser uma quest√£o tecnol√≥gica, mas pol√≠tica.  Chegando a um novo cliente comercial, geralmente descobrimos que ele j√° possui um tipo de DBMS favorito no qual os fundos s√£o investidos e o cliente deseja ver outras solu√ß√µes na infraestrutura existente.  O cen√°rio tecnol√≥gico est√° mudando: o PostgreSQL √© cada vez mais encontrado em ag√™ncias governamentais e empresas privadas, embora o MS SQL Server tenha prevalecido em nossa pr√°tica h√° alguns anos.  O Celesta suporta os DBMSs mais comuns e n√£o estamos preocupados com essas mudan√ßas. </p><br><p>  Em segundo lugar, gostaria de transferir o c√≥digo j√° criado para solucionar problemas padr√£o de um projeto para outro, para criar uma biblioteca reutiliz√°vel.  Coisas como diret√≥rios hier√°rquicos ou m√≥dulos de distribui√ß√£o de notifica√ß√µes por email s√£o inerentemente padr√£o e por que precisamos oferecer suporte a v√°rias vers√µes para clientes com rela√ß√µes diferentes? </p><br><p>  Em terceiro lugar, por √∫ltimo, mas n√£o menos importante, a capacidade de executar testes de unidade sem usar o DbUnit e cont√™ineres usando um banco de dados H2 na mem√≥ria.  Nesse modo, a base H2 inicia instantaneamente.  O Celesta cria rapidamente um esquema de dados, ap√≥s o qual voc√™ pode realizar os testes necess√°rios e "esquecer" o banco de dados.  Como o c√≥digo da l√≥gica de neg√≥cios realmente n√£o sabe em que base ele √© executado, portanto, se funciona sem erros no H2, sem erros funcionar√° no PostgreSQL.  Obviamente, a tarefa dos desenvolvedores do pr√≥prio sistema Celesta √© fazer todos os testes usando DBMSs reais para garantir que nossa plataforma execute igualmente sua API em diferentes rela√ß√µes.  E n√≥s fazemos isso.  Mas o desenvolvedor da l√≥gica de neg√≥cios n√£o √© mais necess√°rio. </p><br><h2 id="celestasql">  CelestaSQL </h2><br><p>  Como √© alcan√ßado o basementismo cruzado?  Obviamente, ao custo de trabalhar com dados apenas por meio de uma API especial que isola a l√≥gica de quaisquer detalhes espec√≠ficos do banco de dados.  O Celesta gera classes Java para acessar dados, por um lado, e c√≥digo SQL e alguns objetos auxiliares dentro do banco de dados, por outro. </p><br><p>  O Celesta n√£o fornece mapeamento objeto-relacional em sua forma mais pura, porque ao projetar um modelo de dados, n√£o provemos de classes, mas da estrutura do banco de dados.  Ou seja, primeiro constru√≠mos um modelo ER de tabelas e, depois, com base nesse modelo, o pr√≥prio Celesta gera classes de cursor para acessar dados. </p><br><p>  Voc√™ pode realizar o mesmo trabalho em todos os DBMSs suportados apenas para a funcionalidade que √© aproximadamente igualmente implementada em cada um deles.  Se retratamos condicionalmente o conjunto de recursos funcionais de cada uma das bases suportadas por n√≥s na forma de ‚Äúc√≠rculos de Euler‚Äù, obtemos a seguinte imagem: </p><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/getpro/habr/post_images/7d9/2ad/1e1/7d92ad1e1a3bc0bb83b5c4bcc511ec66.png"></div><br><p>  Se fornecermos total independ√™ncia do tipo de banco de dados, a funcionalidade que abrimos para os programadores de l√≥gica de neg√≥cios deve estar dentro da interse√ß√£o de todas as bases.  √Ä primeira vista, parece que essa √© uma limita√ß√£o significativa.  Sim: alguns recursos espec√≠ficos, por exemplo, n√£o podemos usar o SQL Server.  Mas, sem exce√ß√£o, os bancos de dados relacionais suportam tabelas, chaves estrangeiras, visualiza√ß√µes, sequ√™ncias, consultas SQL com JOIN e GROUP BY.  Assim, podemos dar essas oportunidades aos desenvolvedores.  Fornecemos aos desenvolvedores "SQL despersonalizado", que chamamos de "CelestaSQL", e no processo geramos consultas SQL para dialetos dos bancos de dados correspondentes. </p><br><p>  A linguagem CelestaSQL inclui DDL para definir objetos de banco de dados e consultas SELECT para visualiza√ß√µes e filtros, mas n√£o cont√©m comandos DML: cursores s√£o usados ‚Äã‚Äãpara modificar os dados, que ainda ser√£o discutidos. </p><br><p>  Cada banco de dados possui seu pr√≥prio conjunto de tipos de dados.  O CelestaSQL tamb√©m possui seu pr√≥prio conjunto de tipos.  No momento da reda√ß√£o deste artigo, havia nove deles, e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esta tabela os</a> compara com tipos reais em v√°rios bancos de dados e tipos de dados Java. </p><br><p>  Pode parecer que nove tipos n√£o s√£o suficientes (em compara√ß√£o com o que o PostgreSQL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suporta</a> , por exemplo), mas, na realidade, esses s√£o os tipos suficientes para armazenar informa√ß√µes financeiras, comerciais e log√≠sticas: strings, inteiros, fracion√°rios , datas, valores booleanos e blobs s√£o sempre suficientes para representar esses dados. </p><br><p>  A pr√≥pria linguagem CelestaSQL √© descrita na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> com um grande n√∫mero de diagramas de sintaxe. </p><br><h2 id="modifikaciya-struktury-bazy-dannyh-idempotentnyy-ddl">  Modifica√ß√£o da estrutura do banco de dados.  DDL idempotente </h2><br><p>  Outra caracter√≠stica importante do Celesta √© sua abordagem para migrar a estrutura do banco de dados em funcionamento √† medida que o projeto se desenvolve.  Para fazer isso, √© utilizada a abordagem incorporada ao Celesta usando DDL idempotente. </p><br><p>  Em poucas palavras, quando escrevemos no CelestaSQL o seguinte texto: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) );</code> </pre> <br><p>  - este texto n√£o √© interpretado por Celesta como "crie uma tabela, mas se j√° houver uma tabela, d√™ um erro", mas "traga a tabela para a estrutura desejada".  Ou seja: ‚Äúse n√£o houver tabela, crie-a, se houver uma tabela, veja quais campos est√£o nela, com quais tipos, quais √≠ndices, quais chaves estrangeiras, quais valores padr√£o etc., e se √© necess√°rio alterar algo em esta tabela para traz√™-lo para o tipo certo ". </p><br><p>  Com essa abordagem, implementamos a capacidade de refatorar e controlar scripts de vers√£o para determinar a estrutura do banco de dados: </p><br><ul><li>  vemos no script a "imagem desejada" atual da estrutura, </li><li>  o qu√™, por quem e por que na estrutura mudou ao longo do tempo, podemos analisar o sistema de controle de vers√£o, </li><li>  quanto aos comandos ALTER, o Celesta os gera e executa automaticamente "sob o cap√¥", conforme necess√°rio. </li></ul><br><p>  Obviamente, essa abordagem tem suas limita√ß√µes.  A Celesta faz todos os esfor√ßos para garantir que a migra√ß√£o autom√°tica seja indolor e cont√≠nua, mas isso n√£o √© poss√≠vel em todos os casos.  A motiva√ß√£o, as possibilidades e as limita√ß√µes dessa abordagem foram descritas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste post</a> (sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o em ingl√™s</a> tamb√©m est√° dispon√≠vel). </p><br><p>  Para acelerar o processo de verifica√ß√£o / atualiza√ß√£o da estrutura do banco de dados, o Celesta aplica o armazenamento de somas de verifica√ß√£o de script DDL no banco de dados (at√© que a soma de verifica√ß√£o seja alterada, o processo de verifica√ß√£o e atualiza√ß√£o da estrutura do banco de dados n√£o inicia).  Para que o processo de atualiza√ß√£o prossiga sem problemas relacionados √† ordem de mudan√ßa de objetos dependentes um do outro, √© aplicada a classifica√ß√£o topol√≥gica de depend√™ncias entre esquemas por chaves estrangeiras.  O processo de migra√ß√£o autom√°tica √© descrito em mais detalhes na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> . </p><br><h2 id="sozdanie-proekta-celesta-i-modeli-dannyh">  Criando um projeto e modelo de dados Celesta </h2><br><p>  O projeto de demonstra√ß√£o, que consideraremos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° dispon√≠vel no github</a> .  Vamos ver como voc√™ pode usar o Celesta ao escrever um aplicativo Spring Boot.  Aqui est√£o as depend√™ncias do Maven que voc√™ precisa: </p><br><ul><li>  <code>org.springframework.boot:spring-boot-starter-web</code> e <code>ru.curs:spring-boot-starter-celesta</code> (para obter mais detalhes, <code>ru.curs:spring-boot-starter-celesta</code> documenta√ß√£o). </li><li>  Se voc√™ n√£o estiver usando o Spring Boot, poder√° conectar <code>ru.curs:celesta-system-services</code> a <code>ru.curs:celesta-system-services</code> do <code>ru.curs:celesta-system-services</code> . </li><li>  Para gera√ß√£o de c√≥digo de classes de acesso a dados baseadas em scripts Celesta-SQL, <code>ru.curs:celesta-maven-plugin</code> necess√°rio o <code>ru.curs:celesta-maven-plugin</code> - o c√≥digo-fonte para um exemplo de demonstra√ß√£o ou documenta√ß√£o descreve como conect√°-lo. </li><li>  Para tirar proveito da capacidade de gravar testes de unidade JUnit5 para m√©todos que modificam dados, voc√™ deve conectar <code>ru.curs:celesta-unit</code> no escopo do teste. </li></ul><br><p>  Agora crie um modelo de dados e compile classes de acesso a dados. </p><br><p>  Digamos que estamos desenvolvendo um projeto para uma empresa de com√©rcio eletr√¥nico que recentemente se fundiu com outra empresa.  Cada um tem seu pr√≥prio banco de dados.  Eles coletam pedidos, mas at√© mesclar seus bancos de dados, precisam de um √∫nico ponto de entrada para coletar pedidos de fora. </p><br><p>  A implementa√ß√£o desse "ponto de entrada" deve ser bastante tradicional: um servi√ßo HTTP com opera√ß√µes CRUD que armazena dados em um banco de dados relacional. </p><br><p>  Devido ao fato de o Celesta implementar a abordagem de design do banco de dados, primeiro precisamos criar uma estrutura de tabela que armazene pedidos.  Um pedido, como voc√™ sabe, √© uma entidade composta: consiste em um cabe√ßalho no qual s√£o armazenadas informa√ß√µes sobre o cliente, data do pedido e outros atributos do pedido, al√©m de v√°rias linhas (itens de mercadorias). </p><br><p>  Ent√£o, para o trabalho: crie </p><br><ul><li>  <code>src/main/celestasql</code> - por padr√£o, esse √© o caminho para os scripts do projeto CelestaSQL </li><li>  cont√©m subpastas que repetem a estrutura de pastas dos pacotes java ( <code>ru/curs/demo</code> no nosso caso). </li><li>  na pasta package, crie um arquivo <code>.sql</code> com o seguinte conte√∫do: </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span> demo <span class="hljs-keyword"><span class="hljs-keyword">VERSION</span></span> <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderHeader( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> DATETIME, customer_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> customer_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), manager_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Pk_OrderHeader PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> fk_OrderLine <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> OrderHeader(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> item_id;</code> </pre> <br><p>  Aqui, descrevemos duas tabelas conectadas por uma chave estrangeira e uma exibi√ß√£o que retornar√° uma quantidade resumida para as mercadorias presentes em todos os pedidos.  Como voc√™ pode ver, isso n√£o √© diferente do SQL regular, com exce√ß√£o do comando <code>CREATE SCHEMA</code> , no qual declaramos a vers√£o do esquema <code>demo</code> (para saber como o n√∫mero da vers√£o afeta a migra√ß√£o autom√°tica, consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> ).  Mas tamb√©m h√° recursos.  Por exemplo, todos os nomes das tabelas e campos que usamos apenas podem ser convertidos em nomes v√°lidos de classe e vari√°vel na linguagem Java.  Portanto, espa√ßos, caracteres especiais s√£o exclu√≠dos.  Voc√™ tamb√©m pode observar que, nos coment√°rios que colocamos sobre os nomes das tabelas e alguns dos campos, n√£o come√ßamos com / *, como de costume, mas com / **, como os coment√°rios do JavaDoc come√ßam - e isso n√£o √© por acaso!  Um coment√°rio definido sobre uma entidade come√ßando com / ** estar√° dispon√≠vel em tempo de execu√ß√£o na propriedade <code>.getCelestaDoc()</code> dessa entidade.  Isso √© √∫til quando queremos fornecer aos elementos do banco de dados meta-informa√ß√µes adicionais: por exemplo, nomes de campos leg√≠veis por humanos, informa√ß√µes sobre como representar campos na interface do usu√°rio etc. </p><br><p>  O script CelestaSQL serve duas tarefas igualmente importantes: primeiro, para a implanta√ß√£o / modifica√ß√£o da estrutura de um banco de dados relacional e, segundo, para a gera√ß√£o de c√≥digo das classes de acesso a dados. </p><br><p>  Agora podemos gerar classes de acesso a dados, basta executar o comando <code>mvn generate-sources</code> ou, se voc√™ estiver trabalhando no IDEA, clique no bot√£o 'Gerar fontes e atualizar pastas' no painel de controle do Maven.  No segundo caso, o IDEA ‚Äú <code>target/generated-sources/celesta</code> pasta criada em <code>target/generated-sources/celesta</code> e disponibiliza seu conte√∫do para importa√ß√£o nos c√≥digos-fonte do projeto.  O resultado da gera√ß√£o de c√≥digo ter√° a seguinte apar√™ncia - uma classe para cada objeto no banco de dados: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/3q/cs/2x3qcsydsu3y5vplbyh7oz15z-s.png"></div><br><p>  A conex√£o com o banco de dados √© especificada nas configura√ß√µes do aplicativo, no nosso caso, no arquivo <code>src/main/resources/application.yml</code> .  Ao usar o spring-boot-starter-celesta, o IDEA informar√° as op√ß√µes de c√≥digo dispon√≠veis na conclus√£o do c√≥digo. </p><br><p>  Se n√£o queremos nos preocupar com o RDBMS "real" para fins de demonstra√ß√£o, podemos fazer com que o Celesta trabalhe com o banco de dados H2 embutido no modo de mem√≥ria usando a seguinte configura√ß√£o: </p><br><pre> <code class="plaintext hljs">celesta: h2: inMemory: true</code> </pre> <br><p>  Para conectar um banco de dados "real", altere a configura√ß√£o para algo como </p><br><pre> <code class="plaintext hljs">celesta: jdbc: url: jdbc:postgresql://127.0.0.1:5432/celesta username: &lt;your_username&gt; password: &lt;your_password&gt;</code> </pre> <br><p>  (nesse caso, voc√™ tamb√©m precisar√° adicionar um driver JDBC do PostgreSQL ao seu aplicativo atrav√©s da depend√™ncia do Maven). </p><br><p>  Ao iniciar um aplicativo Celesta com uma conex√£o com um servidor de banco de dados, √© poss√≠vel observar que as tabelas, visualiza√ß√µes, √≠ndices, etc. necess√°rios s√£o criados para um banco de dados vazio e, para um n√£o vazio, s√£o atualizados para as estruturas especificadas na DDL. </p><br><h2 id="sozdanie-metodov-rabotayuschih-s-dannymi">  Criando m√©todos de manipula√ß√£o de dados </h2><br><p>  Depois de descobrir como criar uma estrutura de banco de dados, voc√™ pode come√ßar a escrever a l√≥gica de neg√≥cios. </p><br><p>  Para poder implementar os requisitos para a distribui√ß√£o de direitos de acesso e a√ß√µes de registro, qualquer opera√ß√£o com dados no Celesta √© realizada em nome de um usu√°rio, n√£o h√° opera√ß√µes "an√¥nimas".  Portanto, qualquer c√≥digo Celesta √© executado no <em>contexto da chamada</em> descrita na classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CallContext</a> . </p><br><ul><li>  Antes de iniciar uma opera√ß√£o que pode modificar dados no banco de dados, o <code>CallContext</code> ativado. </li><li>  No momento da ativa√ß√£o, uma conex√£o com o banco de dados √© obtida do pool de conex√µes e a transa√ß√£o √© iniciada. </li><li>  Ap√≥s a conclus√£o da opera√ß√£o <code>CallContext</code> executa <code>commit()</code> se a opera√ß√£o foi bem-sucedida ou <code>rollback()</code> se uma exce√ß√£o n√£o tratada ocorreu durante a execu√ß√£o, o <code>CallContext</code> fecha e a conex√£o com o banco de dados √© retornada ao pool. </li></ul><br><p>  Se usarmos spring-boot-starter-celesta, essas a√ß√µes ser√£o executadas automaticamente para todos os m√©todos anotados por <code>@CelestaTransaction</code> . </p><br><p>  Suponha que desejemos escrever um manipulador que salve o documento no banco de dados.  Seu c√≥digo no n√≠vel do controlador pode ser assim: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/api"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DocumentService srv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DocumentService srv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.srv = srv; } <span class="hljs-meta"><span class="hljs-meta">@PutMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/save"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody OrderDto order)</span></span></span><span class="hljs-function"> </span></span>{ CallContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CallContext(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//new SystemCallContext(); srv.postOrder(ctx, order); }</span></span></code> </pre> <br><p>  Como regra, no n√≠vel do m√©todo do controlador (ou seja, quando a autentica√ß√£o j√° passou), conhecemos o ID do usu√°rio e podemos us√°-lo ao criar o <code>CallContext</code> .  A liga√ß√£o de um usu√°rio a um contexto determina as permiss√µes para acessar tabelas e tamb√©m fornece a capacidade de registrar altera√ß√µes feitas em seu nome.  √â verdade que, neste caso, para a operacionalidade do c√≥digo interagindo com o banco de dados, os direitos do usu√°rio "usu√°rio1" devem ser indicados nas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tabelas</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sistema</a> .  Se voc√™ n√£o deseja usar o sistema de distribui√ß√£o de acesso Celesta e conceder √† contexto da sess√£o todos os direitos sobre quaisquer tabelas, √© poss√≠vel criar um objeto <code>SystemCallContext</code> . </p><br><p>  O m√©todo de salvar a fatura no n√≠vel de servi√ßo pode ser assim: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context, OrderDto doc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); OrderLineCursor line = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderLineCursor(context)) { header.setId(doc.getId()); header.setDate(Date.from(doc.getDate().atStartOfDay(ZoneId.systemDefault()).toInstant())); header.setCustomer_id(doc.getCustomerId()); header.setCustomer_name(doc.getCustomerName()); header.insert(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lineNo = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderLineDto docLine : doc.getLines()) { lineNo++; line.setLine_no(lineNo); line.setOrder_id(doc.getId()); line.setItem_id(docLine.getItemId()); line.setQty(docLine.getQty()); line.insert(); } } }</code> </pre> <br><p>  Observe a anota√ß√£o <code>@CelestaTransaction</code> .  Gra√ßas a ele, o objeto proxy <code>DocumentService</code> executar√° todas essas a√ß√µes de servi√ßo com o par√¢metro <code>CallContext ctx</code> descrito acima.  Ou seja, no in√≠cio da execu√ß√£o do m√©todo, ele j√° estar√° vinculado √† conex√£o com o banco de dados e a transa√ß√£o estar√° pronta para come√ßar.  Podemos nos concentrar em escrever a l√≥gica de neg√≥cios.  No nosso caso, lendo o objeto <code>OrderDto</code> e salvando-o no banco de dados. </p><br><p>  Para fazer isso, usamos os chamados cursores - classes geradas usando o <code>celesta-maven-plugin</code> .  J√° vimos o que s√£o.  Uma classe √© criada para cada um dos objetos de esquema - duas tabelas e uma visualiza√ß√£o.  E agora podemos usar essas classes para acessar objetos de banco de dados em nossa l√≥gica de neg√≥cios. </p><br><p>  Para criar um cursor na tabela de pedidos e selecionar o primeiro registro, voc√™ precisa escrever o seguinte c√≥digo: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.tryFirst();</code> </pre> <br><p>  Ap√≥s criar o objeto de cabe√ßalho, podemos acessar os campos da entrada da tabela por meio de getters e setters: </p><br><div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/_8/gl/9i/_8gl9ikjbprpjano2dbvj0reme8.png"></div><br><p>  Ao criar um cursor, devemos usar o contexto de chamada ativo - esta √© a √∫nica maneira de criar um cursor.  O contexto da chamada carrega informa√ß√µes sobre o usu√°rio atual e seus direitos de acesso. </p><br><p>  Com o objeto cursor, podemos fazer coisas diferentes: filtrar, percorrer os registros e tamb√©m, naturalmente, inserir, excluir e atualizar registros.  Toda a API do cursor √© descrita em detalhes na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> . </p><br><p>  Por exemplo, o c√≥digo do nosso exemplo pode ser desenvolvido da seguinte maneira: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.setRange(<span class="hljs-string"><span class="hljs-string">"manager_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"manager1"</span></span>); header.tryFirst(); header.setCounter(header.getCounter() + <span class="hljs-number"><span class="hljs-number">1</span></span>); header.update();</code> </pre> <br><p>  Neste exemplo, configuramos o filtro pelo campo manager_id e, em seguida, encontramos o primeiro registro usando o m√©todo tryFirst. </p><br><div class="spoiler">  <b class="spoiler_title">(por que "tentar")</b> <div class="spoiler_text"><p>  Os m√©todos <code>get</code> , <code>first</code> , <code>insert</code> , <code>update</code> t√™m duas op√ß√µes: sem o prefixo try (apenas <code>get(...)</code> , etc.) e com o prefixo try ( <code>tryGet(...)</code> , <code>tryFirst()</code> , etc.) .  M√©todos sem o prefixo try lan√ßam uma exce√ß√£o se o banco de dados n√£o tiver os dados apropriados para executar a a√ß√£o.  Por exemplo, first () lan√ßar√° uma exce√ß√£o se nenhum registro entrar no conjunto de filtros no cursor.  Ao mesmo tempo, os m√©todos com o prefixo try n√£o lan√ßam uma exce√ß√£o, mas retornam um valor booleano que sinaliza o sucesso ou a falha da opera√ß√£o correspondente.  A pr√°tica recomendada √© usar m√©todos sem o prefixo try sempre que poss√≠vel.  Dessa maneira, o c√≥digo de "autoteste" √© criado, sinalizando erros no tempo nos dados l√≥gicos e / ou do banco de dados. </p></div></div><br><p>  Quando o <code>tryFirst</code> acionado, as vari√°veis ‚Äã‚Äãdo <code>tryFirst</code> s√£o preenchidas com os dados de um registro, podemos ler e atribuir valores a elas.  E quando os dados no cursor est√£o totalmente preparados, executamos <code>update()</code> e ele armazena o conte√∫do do cursor no banco de dados. </p><br><p>  Qual problema esse c√≥digo pode ser afetado?  Claro, o surgimento da condi√ß√£o de corrida / atualiza√ß√£o perdida!  Porque entre o momento em que recebemos os dados na linha com "tryFirst" e o momento em que tentamos atualizar esses dados no ponto "update", algu√©m j√° pode receber, modificar e atualizar esses dados no banco de dados.  Ap√≥s a leitura dos dados, o cursor n√£o bloqueia seu uso por outros usu√°rios!  Para se proteger contra atualiza√ß√µes perdidas, o Celesta usa o princ√≠pio de bloqueio otimista.  Em cada tabela, por padr√£o, o Celesta cria um campo de <code>recversion</code> e, no n√≠vel ON do UPDATE, aumenta o n√∫mero da vers√£o e verifica se os dados atualizados t√™m a mesma vers√£o da tabela.  Se ocorrer um problema, lan√ßa uma exce√ß√£o.  Voc√™ pode ler mais sobre isso no artigo ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Prote√ß√£o contra atualiza√ß√µes perdidas</a> ‚Äù. </p><br><p>  Lembre-se novamente de que uma transa√ß√£o est√° associada ao objeto CallContext.  Se o procedimento Celesta for bem-sucedido, ocorrer√° uma confirma√ß√£o.  Se o m√©todo Celesta terminar com uma exce√ß√£o n√£o tratada, ocorre revers√£o.  Portanto, se ocorrer um erro em algum procedimento complicado, toda a transa√ß√£o relacionada ao contexto da chamada ser√° revertida, como se n√£o tiv√©ssemos come√ßado a fazer nada com os dados, os dados n√£o ser√£o corrompidos.  Se, por algum motivo, voc√™ precisar de um commit no meio de, digamos, algum tipo de procedimento grande, um commit expl√≠cito poder√° ser executado chamando <code>context.commit()</code> . </p><br><h2 id="testirovanie-metodov-rabotayuschih-s-dannymi">  Testando m√©todos de dados </h2><br><p>  Vamos criar um teste de unidade que verifique a corre√ß√£o do m√©todo de servi√ßo que armazena <code>OrderDto</code> no banco de dados. </p><br><p>  Ao usar o JUnit5 e a extens√£o do JUnit5 dispon√≠vel no m√≥dulo <code>celesta-unit</code> , isso √© muito f√°cil.  A estrutura do teste √© a seguinte: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentServiceTest</span></span></span><span class="hljs-class"> </span></span>{ DocumentService srv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentService(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">documentIsPutToDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ OrderDto doc =... srv.postOrder(context, doc); <span class="hljs-comment"><span class="hljs-comment">//Check the fact that records are in the database OrderHeaderCursor header = new OrderHeaderCursor(context); header.tryFirst(); assertEquals(doc.getId(), header.getId()); OrderLineCursor line = new OrderLineCursor(context); line.setRange("order_id", doc.getId()); assertEquals(2, line.count()); } }</span></span></code> </pre> <br><p>  Gra√ßas √† anota√ß√£o <code>@CelestaTest</code> , que √© uma extens√£o do JUnit5, podemos declarar o par√¢metro de <code>CallContext context</code> nos m√©todos de teste.  Esse contexto j√° est√° ativado e vinculado ao banco de dados (na mem√≥ria H2) e, portanto, n√£o precisamos agrupar a classe de servi√ßo em um proxy - n√≥s a criamos usando <code>new</code> , e n√£o usando Spring.  No entanto, se necess√°rio, injete o servi√ßo no teste usando as ferramentas Spring, n√£o h√° obst√°culos para isso. </p><br><p>  Criamos testes de unidade com o pressuposto de que, no momento da execu√ß√£o, o banco de dados estar√° completamente vazio, mas com a estrutura necess√°ria e, ap√≥s a execu√ß√£o, n√£o podemos nos preocupar com o fato de termos deixado ‚Äúlixo‚Äù no banco de dados.  Esses testes s√£o realizados em uma velocidade muito alta. </p><br><p>  Vamos criar um segundo procedimento que retorna JSON com valores agregados, mostrando quantos produtos encomendamos. </p><br><p>  O teste grava dois pedidos no banco de dados, ap√≥s o qual verifica o valor total retornado pelo novo m√©todo <code>getAggregateReport</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportReturnsAggregatedQuantities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ srv.postOrder(context, . . .); srv.postOrder(context, . . .); Map&lt;String, Integer&gt; result = srv.getAggregateReport(context); assertEquals(<span class="hljs-number"><span class="hljs-number">5</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"A"</span></span>).intValue()); assertEquals(<span class="hljs-number"><span class="hljs-number">7</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"B"</span></span>).intValue()); }</code> </pre> <br><p>  Para implementar o m√©todo <code>getAggregateReport</code> usaremos a visualiza√ß√£o OrderedQty, que, lembro-me, no arquivo CelestaSQL √© assim: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  A solicita√ß√£o √© padr√£o: resumimos as linhas de pedido por quantidade e agrupamos por c√≥digo de produto.  Um cursor OrderedQtyCursor j√° foi criado para a exibi√ß√£o, que podemos usar.  Declaramos esse cursor, iteramos sobre ele e coletamos o <code>Map&lt;String, Integer&gt;</code> desejado: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, Integer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAggregateReport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Integer&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderedQtyCursor ordered_qty = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderedQtyCursor(context)) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderedQtyCursor line : ordered_qty) { result.put(ordered_qty.getItem_id(), ordered_qty.getQty()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h2 id="materializovannye-predstavleniya-celesta">  Visualiza√ß√µes Celesta materializadas </h2><br><p>  Por que usar uma exibi√ß√£o ruim para obter dados agregados?  Essa abordagem √© bastante vi√°vel, mas, na realidade, coloca uma bomba-rel√≥gio em todo o sistema: afinal, uma vis√£o, que √© uma consulta SQL, √© cada vez mais lenta √† medida que os dados se acumulam no sistema.  Ele ter√° que resumir e agrupar mais e mais linhas.  Como evitar isso? </p><br><p>  O Celesta tenta implementar todas as tarefas padr√£o com as quais os programadores de l√≥gica de neg√≥cios s√£o constantemente confrontados no n√≠vel da plataforma. </p><br><p>  O MS SQL Server tem o conceito de visualiza√ß√µes materializadas (indexadas), que s√£o armazenadas como tabelas e s√£o atualizadas rapidamente √† medida que os dados nas tabelas de origem s√£o alterados.  Se estiv√©ssemos trabalhando em um MS SQL Server ‚Äúlimpo‚Äù, no nosso caso, a substitui√ß√£o da exibi√ß√£o por uma exibi√ß√£o indexada seria exatamente o que precis√°vamos: recuperar o relat√≥rio agregado n√£o diminuiria √† medida que os dados se acumulassem e o trabalho para atualizar o relat√≥rio agregado seria executado no momento inserir dados na tabela de linhas de pedidos e tamb√©m n√£o aumentaria muito com um aumento no n√∫mero de linhas. </p><br><p>  Mas, caso trabalhemos com o PostgreSQL atrav√©s do Celesta, o que podemos fazer?  Redefina a visualiza√ß√£o adicionando a palavra materializada: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  Vamos iniciar o sistema e ver o que aconteceu com o banco de dados. </p><br><p>  <code>OrderedQty</code> que a <code>OrderedQty</code> desapareceu e a tabela <code>OrderedQty</code> apareceu.  Al√©m disso, como a tabela OrderLine √© preenchida com dados, as informa√ß√µes na tabela OrderedQty ser√£o "magicamente" atualizadas, como se OrderedQty fosse uma visualiza√ß√£o. </p><br><p>  N√£o h√° m√°gica aqui se olharmos para os gatilhos criados na tabela <code>OrderLine</code> .  Celesta, tendo recebido a tarefa de criar uma "exibi√ß√£o materializada", analisou a consulta e criou gatilhos na tabela <code>OrderLine</code> que atualizam <code>OrderedQty</code> .  Ao inserir uma √∫nica palavra-chave - <code>materialized</code> - no arquivo CelestaSQL, resolvemos o problema de degrada√ß√£o do desempenho e o c√≥digo da l√≥gica de neg√≥cios nem precisava ser alterado! </p><br><p> ,    ,   , . ¬´¬ª  Celesta    ,    ,  JOIN-,    GROUP BY.     ,  , ,     ,      . .     . </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>       Celesta.     ‚Äî    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455746/">https://habr.com/ru/post/pt455746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455736/index.html">Consenso em criptomoedas com minera√ß√£o h√≠brida e Multi-PoW</a></li>
<li><a href="../pt455738/index.html">Como ganhar um bilh√£o monetizando seus dados?</a></li>
<li><a href="../pt455740/index.html">Aprendizado de m√°quina em uma empresa de investimento: classificamos chamadas de suporte t√©cnico</a></li>
<li><a href="../pt455742/index.html">Fazendo m√∫sica: quando solu√ß√µes simples superam o aprendizado profundo</a></li>
<li><a href="../pt455744/index.html">Sistema de gera√ß√£o de paisagem de labirinto com realismo visual aprimorado [tradu√ß√£o do artigo de Jinmo Kim]</a></li>
<li><a href="../pt455754/index.html">Testes de um estratostato √† deriva. Lan√ßamento de Rogozin e LoRa na estratosfera</a></li>
<li><a href="../pt455756/index.html">√â a favor</a></li>
<li><a href="../pt455758/index.html">Hacking de crescimento no foguete de varejo: da pesquisa de hip√≥teses √†s t√©cnicas de teste</a></li>
<li><a href="../pt455760/index.html">A m√°gica do SwiftUI ou sobre os construtores de fun√ß√µes</a></li>
<li><a href="../pt455762/index.html">Uma breve introdu√ß√£o √†s cadeias de Markov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>