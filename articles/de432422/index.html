<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø üî§ üè° Offline-Modus unter iOS und Funktionen seiner Implementierung unter Realm ‚õàÔ∏è üë©üèΩ‚ÄçüöÄ üë®‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gepostet von Ekaterina Semashko, Starke Junior iOS-Entwicklerin, DataArt 

 Ein wenig √ºber das Projekt: eine mobile Anwendung f√ºr die iOS-Plattform, g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Offline-Modus unter iOS und Funktionen seiner Implementierung unter Realm</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataart/blog/432422/"><img src="https://habrastorage.org/webt/mz/rf/z2/mzrfz2k1ntkzycx5hxev_211qrc.jpeg"><br><br>  <i>Gepostet von Ekaterina Semashko, Starke Junior iOS-Entwicklerin, DataArt</i> <br><br>  Ein wenig √ºber das Projekt: eine mobile Anwendung f√ºr die iOS-Plattform, geschrieben in Swift.  Der Zweck der Anwendung ist die M√∂glichkeit, Rabattkarten zwischen Mitarbeitern des Unternehmens und ihren Freunden zu teilen. <br><br>  Eines der Ziele des Projekts war es, beliebte Technologien und Bibliotheken zu lernen und zu √ºben.  Realm wurde zum Speichern lokaler Daten ausgew√§hlt, Alamofire wurde f√ºr die Arbeit mit dem Server verwendet, Google Sign-In wurde zur Authentifizierung verwendet, PINRemoteImage wurde zum Hochladen von Bildern verwendet. <br><br>  Die Hauptfunktionen der Anwendung: <br><br><ul><li>  Hinzuf√ºgen einer Karte, Bearbeiten und L√∂schen; </li><li>  Anzeigen der Karten anderer Personen; </li><li>  Suche nach Karten nach Gesch√§ftsname / Benutzername; </li><li>  F√ºgen Sie Ihren Favoriten Karten f√ºr den schnellen Zugriff hinzu. </li></ul><br>  Die M√∂glichkeit, die Anwendung ohne Verbindung zum Netzwerk zu verwenden, wurde von Anfang an vorausgesetzt, jedoch nur im Lesemodus.  Das hei√üt,  Wir konnten Informationen √ºber Karten anzeigen, aber ohne das Internet nicht √§ndern.  Zu diesem Zweck verf√ºgte die Anwendung immer √ºber eine Kopie aller Karten und Marken der Datenbank vom Server sowie √ºber eine Liste der Favoriten f√ºr den aktuellen Benutzer.  Die Suche wurde auch lokal implementiert. <br><br>  Sp√§ter beschlossen wir, offline durch Hinzuf√ºgen eines Aufnahmemodus zu erweitern.  Informationen zu vom Benutzer vorgenommenen √Ñnderungen wurden gespeichert und synchronisiert, als eine Internetverbindung hergestellt wurde.  Die Implementierung eines solchen Lese- / Schreib-Offline-Modus wird diskutiert. <a name="habracut"></a><br><br><hr><br>  Was ist f√ºr einen vollst√§ndigen Offline-Modus in einer mobilen Anwendung erforderlich?  Wir m√ºssen die Abh√§ngigkeit des Benutzers von der Qualit√§t der Internetverbindung beseitigen, insbesondere: <br><br><ol><li>  Entfernen Sie die Abh√§ngigkeit der Antworten des Benutzers von seinen Aktionen in der Benutzeroberfl√§che vom Server.  Zun√§chst wird die Anforderung mit dem lokalen Speicher interagiert und dann an den Server gesendet. </li><li>  Lokale √Ñnderungen markieren und speichern. </li><li>  Implementieren eines Synchronisationsmechanismus - Wenn eine Internetverbindung angezeigt wird, m√ºssen Sie √Ñnderungen an den Server senden. </li><li>  Zeigen Sie dem Benutzer, welche √Ñnderungen synchronisiert sind, welche nicht. </li></ol><br><h2>  Offline-First-Ansatz </h2><br>  Zun√§chst musste ich den vorhandenen Mechanismus f√ºr die Interaktion mit dem Server und der Datenbank √§ndern.  Ziel war es, den Benutzer daran zu hindern, von der Anwesenheit oder Abwesenheit des Internets abh√§ngig zu sein.  Zun√§chst sollte es mit dem lokalen Data Warehouse interagieren und Serveranforderungen sollten im Hintergrund stehen. <br><br>  In der vorherigen Version bestand eine starke Verbindung zwischen der Datenspeicherschicht und der Netzwerkschicht.  Der Mechanismus f√ºr die Arbeit mit Daten war wie folgt: Zuerst wurde √ºber die NetworkManager-Klasse eine Anforderung an den Server gestellt, wir haben auf das Ergebnis gewartet, danach wurden die Daten √ºber die Repository-Klasse in der Datenbank gespeichert.  Dann wurde das Ergebnis an die Benutzeroberfl√§che √ºbergeben, wie im Diagramm gezeigt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tw/n9/8d/twn98dmriqa0uuzej10hjhntw78.png"></div><br>  Um den Offline-First-Ansatz zu implementieren, habe ich die Datenspeicherschicht und die Netzwerkschicht getrennt und eine neue Flow-Klasse eingef√ºhrt, die die Reihenfolge steuert, in der NetworkManager und Repository aufgerufen wurden.  Jetzt werden die Daten zuerst √ºber die Repository-Klasse in der Datenbank gespeichert, dann wird das Ergebnis an die Benutzeroberfl√§che gesendet und der Benutzer arbeitet weiterhin mit der Anwendung.  Im Hintergrund wird eine Anforderung an den Server gesendet. Nach der Antwort werden die Informationen in der Datenbank und der Benutzeroberfl√§che aktualisiert. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wi/ru/yd/wiruyd-reybblt8x0zp1lzcgd14.png"></div><br><h2>  Arbeiten Sie mit Objektkennungen </h2><br>  Mit der neuen Architektur wurden mehrere neue Aufgaben angezeigt, von denen eine mit ID-Objekten arbeitet.  Zuvor haben wir sie beim Erstellen des Objekts vom Server erhalten.  Jetzt wurde das Objekt lokal erstellt. Dementsprechend musste eine ID generiert und nach der Synchronisierung auf die aktuellen aktualisiert werden.  Hier bin ich auf die erste Einschr√§nkung von Realm gesto√üen: Nach dem Erstellen eines Objekts k√∂nnen Sie dessen Prim√§rschl√ºssel nicht mehr √§ndern. <br><br>  Die erste Option bestand darin, den Prim√§rschl√ºssel im Objekt aufzugeben und id zu einem regul√§ren Feld zu machen.  Gleichzeitig gingen jedoch die Vorteile der Verwendung des Prim√§rschl√ºssels verloren: Realm-Indizierung, die das Abrufen des Objekts beschleunigt, die M√∂glichkeit, das Objekt mit dem Flag create zu aktualisieren (ein Objekt erstellen, falls es nicht vorhanden ist) und die Einhaltung der Eindeutigkeit des Objekts. <br><br>  Ich wollte den Prim√§rschl√ºssel speichern, aber es konnte nicht die ID des Objekts vom Server sein.  Infolgedessen bestand die funktionierende L√∂sung darin, zwei Bezeichner zu haben, einen Server, ein optionales Feld und den zweiten lokalen Bezeichner, der der Prim√§rschl√ºssel sein w√ºrde. <br><br>  Infolgedessen wird beim lokalen Erstellen des Objekts auf dem Client eine lokale ID generiert. Wenn das Objekt vom Server stammt, entspricht es der Server-ID.  Da es in der einzigen Quelle der Wahrheitsanwendung eine Datenbank gibt, wird das Objekt beim Empfang von Daten vom Server mit der aktuellen lokalen Kennung aktualisiert und arbeitet nur damit.  Beim Senden von Daten an den Server wird die Server-ID √ºbertragen. <br><br><h2>  Speicherung nicht synchronisierter √Ñnderungen </h2><br>  √Ñnderungen an Objekten, die noch nicht an den Server gesendet wurden, m√ºssen lokal gespeichert werden.  Dies kann auf folgende Arten implementiert werden: <br><br><ol><li>  Hinzuf√ºgen von Feldern zu vorhandenen Objekten </li><li>  Speichern nicht synchronisierter Objekte in separaten Tabellen; </li><li>  Speichern einzelner Feld√§nderungen in einem bestimmten Format. </li></ol><br><br>  Ich verwende Realm-Objekte nicht direkt in meinen Klassen, sondern mache ihre Zuordnung selbst, um Probleme mit Multithreading zu vermeiden.  Die automatische Aktualisierung der Benutzeroberfl√§che erfolgt anhand von Beispielen f√ºr die automatische Aktualisierung der Ergebnisse, bei denen ich Aktualisierungsanforderungen abonniere.  Nur der erste Ansatz funktionierte mit meiner aktuellen Architektur, daher fiel die Wahl auf das Hinzuf√ºgen von Feldern zu vorhandenen Objekten. <br><br>  Das Kartenobjekt hat die meisten √Ñnderungen erfahren: <br><br><ul><li>  synchronisiert - Gibt es Daten auf dem Server? </li><li>  gel√∂scht - true, wenn die Karte nur lokal gel√∂scht wird, ist eine Synchronisierung erforderlich. </li></ul><br>  Bezeichner, die im vorherigen Teil besprochen wurden: <br><br><ul><li>  localId - der Prim√§rschl√ºssel der Entit√§t in der Anwendung, entweder gleich der Server-ID oder lokal generiert; </li><li>  serverId - ID vom Server. </li></ul><br>  Besonders erw√§hnenswert ist die Speicherung von Bildern.  Im Wesentlichen wurde das Anhangsfeld diskURL zum serverURL-Feld des Images auf dem Server hinzugef√ºgt, in dem die Adresse des lokalen nicht synchronisierten Images gespeichert ist.  Bei der Synchronisierung des Bildes wurde das lokale Bild gel√∂scht, um den Speicher des Ger√§ts nicht zu verstopfen. <br><br><h2>  Serversynchronisierung </h2><br>  Um mit dem Server zu synchronisieren, wurde die Arbeit mit Erreichbarkeit hinzugef√ºgt, sodass der Synchronisierungsmechanismus gestartet wird, wenn das Internet angezeigt wird. <br><br>  Zun√§chst wird gepr√ºft, ob √Ñnderungen an der Datenbank vorliegen, die √ºbermittelt werden m√ºssen.  Anschlie√üend wird eine Anforderung an den Server f√ºr eine tats√§chliche Daten√ºbertragung gesendet. Infolgedessen werden √Ñnderungen, die nicht an den Client gesendet werden m√ºssen, herausgefiltert (z. B. eine √Ñnderung an einem Objekt, das bereits auf dem Server gel√∂scht wurde).  Die verbleibenden √Ñnderungen stellen Anforderungen an den Server in die Warteschlange. <br><br>  Um √Ñnderungen zu senden, war es m√∂glich, Massenaktualisierungen zu implementieren, die √Ñnderungen in einem Array zu senden oder eine gro√üe Anforderung zum Synchronisieren aller Daten zu stellen.  Zu diesem Zeitpunkt war der Backend-Entwickler jedoch bereits mit einem anderen Projekt besch√§ftigt und half uns nur in unserer Freizeit. Daher erstellen wir eine Anfrage f√ºr jede Art von √Ñnderung. <br><br>  Ich habe die Warteschlange √ºber OperationQueue implementiert und jede Anforderung in eine asynchrone Operation eingeschlossen.  Einige Operationen h√§ngen voneinander ab. Beispielsweise k√∂nnen wir das Kartenbild vor dem Erstellen der Karte nicht laden. Daher habe ich die Abh√§ngigkeit der Bildoperation zur Kartenoperation hinzugef√ºgt.  Au√üerdem hatte das Hochladen von Bildern auf den Server eine niedrigere Priorit√§t als alle anderen, und ich habe sie aufgrund ihrer Schwere auch zuletzt in die Warteschlange aufgenommen. <br><br>  Bei der Planung des Offline-Modus bestand die gro√üe Frage darin, Konflikte mit dem Server w√§hrend der Synchronisierung zu l√∂sen.  Als wir jedoch w√§hrend der Implementierung an diesen Punkt kamen, stellten wir fest, dass der Fall, dass ein Benutzer dieselben Daten auf verschiedenen Ger√§ten √§ndert, sehr selten ist.  Es reicht uns also, den Mechanismus f√ºr die letzten Writer-Gewinne zu implementieren.  W√§hrend der Synchronisierung haben nicht gesendete √Ñnderungen auf dem Client immer Vorrang, sie werden nicht gerieben. <br><br>  Die Fehlerbehandlung steckt noch in den Kinderschuhen. Wenn die Synchronisierung fehlschl√§gt, wird das Objekt beim n√§chsten Erscheinen des Internets zur √Ñnderungswarteschlange hinzugef√ºgt.  Und wenn es nach dem Zusammenf√ºhren immer noch nicht synchron ist, entscheidet der Benutzer, ob er es verlassen oder l√∂schen m√∂chte. <br><br><h2>  Zus√§tzliche Problemumgehung bei der Arbeit mit Realm </h2><br>  Bei der Arbeit mit Realm gab es einige weitere Probleme.  Vielleicht ist diese Erfahrung auch f√ºr jemanden n√ºtzlich. <br><br>  Bei der Sortierung nach Zeichenfolge richtet sich die Reihenfolge nach der Zeichenreihenfolge in UTF-8. Es gibt keine Unterst√ºtzung f√ºr die Suche zwischen Gro√ü- und Kleinschreibung.  Wir sind mit einer Situation konfrontiert, in der die Namen in Kleinbuchstaben nach den Namen in Gro√übuchstaben stehen, zum Beispiel: Magnet, Pyaterochka, Ribbon.  Wenn die Liste sehr gro√ü ist, werden alle Namen in Kleinbuchstaben unten angezeigt, was sehr unangenehm ist. <br><br>  Um die Sortierreihenfolge unabh√§ngig von der Gro√ü- und Kleinschreibung beizubehalten, mussten wir ein neues Feld f√ºr den Namen mit niedrigerem Fall einf√ºhren, es beim Aktualisieren des Namens aktualisieren und danach sortieren. <br><br>  Au√üerdem wurde ein neues Feld zum Sortieren nach dem Vorhandensein einer Karte in den Favoriten hinzugef√ºgt, da dies im Wesentlichen eine Unterabfrage f√ºr die Beziehungen des Objekts erfordert. <br><br>  Bei der Suche in Realm gibt es die CONTAINS [c]% @ -Methode f√ºr Suchvorg√§nge ohne Ber√ºcksichtigung der Gro√ü- und Kleinschreibung.  Aber leider funktioniert es nur mit dem lateinischen Alphabet.  F√ºr russische Marken mussten wir auch separate Felder erstellen und danach suchen.  Sp√§ter stellte sich heraus, dass es in unseren H√§nden lag, Sonderzeichen bei der Suche auszuschlie√üen. <br><br><hr><br>  Wie Sie sehen k√∂nnen, ist es f√ºr mobile Anwendungen durchaus m√∂glich, einen Offline-Modus zu implementieren, in dem √Ñnderungen gespeichert und mit wenig Blut synchronisiert werden, manchmal sogar mit minimalen √Ñnderungen im Backend. <br><br>  Trotz einiger Schwierigkeiten k√∂nnen Sie Realm verwenden, um es zu implementieren, und gleichzeitig alle Vorteile in Form von Live-Updates, einer Nullkopie-Architektur und einer praktischen API erhalten. <br><br>  Es gibt also keinen Grund, Ihren Benutzern jederzeit den Zugriff auf Daten zu verweigern, unabh√§ngig von der Qualit√§t der Verbindung. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de432422/">https://habr.com/ru/post/de432422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de432412/index.html">Highload ++: So helfen Sie dem ERP-System, 500.000 Anfragen pro Sekunde zu bew√§ltigen</a></li>
<li><a href="../de432414/index.html">Alte Geheimnisse f√ºr schnelles Debuggen: Animieren des Quellcodes</a></li>
<li><a href="../de432416/index.html">Abh√§ngige Typen - Die Zukunft der Programmiersprachen</a></li>
<li><a href="../de432418/index.html">Analysieren von Lambda-Ausdr√ºcken in Java</a></li>
<li><a href="../de432420/index.html">Einf√ºhrung in Git Merge und Git Rebase: Warum und wann sie verwendet werden sollen</a></li>
<li><a href="../de432424/index.html">HyperFlex Certified Infrastructure f√ºr SAP HANA</a></li>
<li><a href="../de432426/index.html">Debuggen eines Fehlers, der nicht abgespielt wird</a></li>
<li><a href="../de432428/index.html">Zentraler Bus gegen Service Mesh: Wie man einen Mitap in eine Schlacht verwandelt</a></li>
<li><a href="../de432432/index.html">Die neue Technologie der Oc√© ColorWave-Serie verbessert den Druck</a></li>
<li><a href="../de432434/index.html">Rover-Entwickler der n√§chsten Generation verwenden KI, um die Rover-Effizienz zu steigern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>