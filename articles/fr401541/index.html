<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåì ü§∑üèΩ üßëüèº‚Äçü§ù‚Äçüßëüèº 50 nuances de moignon * R√©ception mat√©rielle des signaux encod√©s PWM par les microcontr√¥leurs Microchip üëé üë©üèø‚Äçüåæ üöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* NIP - Core Independent Peripherals dans les microcontr√¥leurs Microchip, √©galement connu sous le nom de CIP - Core Independent Peripheral. 

 Partie ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>50 nuances de moignon * R√©ception mat√©rielle des signaux encod√©s PWM par les microcontr√¥leurs Microchip</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401541/"><div style="text-align:center;"><img src="https://habrastorage.org/files/344/eea/f79/344eeaf79b9a424fb5c5272f4506a24f.JPG" width="300"></div><br>  * NIP - Core Independent Peripherals dans les microcontr√¥leurs Microchip, √©galement connu sous le nom de CIP - Core Independent Peripheral. <br><br><h1>  Partie 4 </h1><br>  Les articles pr√©c√©dents [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1</a> ], [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2</a> ] et [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3</a> ] √©taient consacr√©s aux microcontr√¥leurs Microchip de p√©riph√©riques ind√©pendants du noyau (NEV): cellules logiques configurables, ports d'entr√©e / sortie avec fonction de limitation de courant et ADC avec un ordinateur; certaines caract√©ristiques de ces p√©riph√©riques ont √©t√© pr√©sent√©es.  Permettez-moi de vous rappeler que l'ind√©pendance ne d√©coule pas du type de c≈ìur PIC des microcontr√¥leurs (BaseLine, milieu de gamme, milieu de gamme am√©lior√©, PIC18, 16, 32 bits), mais du fonctionnement du c≈ìur, c'est-√†-dire  ex√©cution ind√©pendante des t√¢ches affect√©es √† la p√©riph√©rie de l'√©tat de la CPU.  De tels p√©riph√©riques, et en particulier la possibilit√© de le configurer pour la collaboration et la synth√®se des fonctions mat√©rielles, sont con√ßus pour d√©charger la partie logicielle et r√©duire la consommation d'√©nergie. <br><br>  Dans ce court article, je veux montrer des exemples de la mise en ≈ìuvre de la r√©ception d'interfaces de communication ¬´personnalis√©es¬ª non standard utilisant les p√©riph√©riques ind√©pendants du noyau. <br><a name="habracut"></a><br>  Le codage PWM des informations est tr√®s courant lorsque des signaux discrets, log.1 et log.0, sont cod√©s par la largeur d'impulsion.  Envisagez la possibilit√© de recevoir et de d√©coder de tels signaux √† l'aide des contr√¥leurs PIC ind√©pendants du noyau p√©riph√©rique. <br><br><h2>  D√©codage PWM du signal du capteur AM2302 </h2><br>  Dans les projets de bricolage, le capteur de temp√©rature et d'humidit√© DHT22 (AM2302) est souvent utilis√©.  Le capteur dispose de 3 sorties, les informations sont transmises via un seul fil.  En r√©ponse √† une demande (niveau bas d'une dur√©e d'environ 1 ms), le capteur r√©pond par un bit de d√©part, puis une s√©quence de 40 bits, o√π les informations sont cod√©es dans la dur√©e d'impulsion: log.  "0" - impulsion 30mk sec, log.  "1" - 70 mk sec (valeurs typiques).  La r√©ponse du capteur contient 5 octets: 2 octets de donn√©es d'humidit√©, 2 octets de temp√©rature et 1 octet de contr√¥le. <br><br><img src="https://habrastorage.org/files/d89/ab5/d3a/d89ab5d3a7204c46aeb299ace4023003.png"><br>  <i>Fig.1.</i>  <i>Explications du principe de g√©n√©ration du signal du capteur DHT22.</i> <br><br>  Le r√©seau a de nombreux exemples de travail avec de tels capteurs sur Arduino.  Certaines impl√©mentations de biblioth√®que utilisent des constructions telles que: <br><br><pre><code class="hljs ruby">loopCnt = TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(PIN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(--loopCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ErrorTimeout; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loopCnt &lt; cntOne) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">1</span></span> ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">0</span></span> ‚Ä¶ }</code> </pre> <br>  Dans ces impl√©mentations, je vois les probl√®mes suivants: <br><br>  - le programme pour tout le temps de mesure (&gt; 5 ms) ¬´se bloque¬ª dans le code de mesure; <br>  - l'apparition d'une interruption suffisamment longue perturbe la lecture des donn√©es du capteur; <br>  - probl√®mes potentiels de travail √† une fr√©quence d'horloge basse du microcontr√¥leur; <br><br>  L'algorithme du programme de telles solutions a approximativement la forme suivante (voir Fig.2) <br><br><img src="https://habrastorage.org/files/c97/8c0/d3f/c978c0d3f5444843aa4caa67c2d62f14.png"><br>  <i>Fig.</i>  <i>2. Un algorithme pour recevoir et d√©coder par programmation les signaux des capteurs.</i> <br><br>  Ci-dessous est consid√©r√©e une variante de la r√©ception / d√©codage mat√©riel du protocole avec un minimum de surcharge logicielle. <br><br>  L'id√©e est d'isoler les impulsions d'horloge du flux binaire, suivies de la direction du signal d'origine et des impulsions d'horloge vers le module mat√©riel SPI.  Dans ce cas, le programme du microcontr√¥leur ne peut prendre s√©quentiellement que 5 octets de donn√©es du SPI. <br><br>  Une partie du CIP est un temporisateur avec la possibilit√© de d√©clencher des √©v√©nements (changements d'√©tat de l'entr√©e ou d'autres p√©riph√©riques).  C'est-√†-dire  la modification de l'√©tat d'entr√©e peut d√©clencher une minuterie, voir signal TMR6 sur la figure 3.  Lorsque le temporisateur atteint la valeur d√©finie, son comptage s'arr√™te et le temporisateur est dans l'√©tat TMR6 = PR6 (PR - registre de p√©riode).  L'√©tat du temporisateur peut √™tre une entr√©e pour une cellule logique configurable (CLC, voir partie 1). <br><br>  Ainsi, en utilisant un temporisateur et des cellules logiques, nous pouvons g√©n√©rer un signal appropri√© pour √™tre appliqu√© √† l'entr√©e d'horloge du SCK du module SPI.  Pour extraire des informations, la dur√©e d'un tel bloc doit avoir une valeur moyenne entre la dur√©e de z√©ro et un.  SPI peut alors fixer le bit en fonction de la d√©croissance du bloc (voir Fig. 3 signal SCK). <br><br>  Le signal du capteur aura de fausses impulsions g√©n√©r√©es √† partir de la demande et des impulsions de d√©marrage.  Pour que ces impulsions n'interf√®rent pas avec le fonctionnement, vous devez activer SPI uniquement pendant la dur√©e des impulsions d'information, ou couper les impulsions inutiles.  Nous pouvons √©galement r√©soudre ce probl√®me en utilisant CIP. <br><br>  Un autre temporisateur agit comme un compteur d'impulsions avec commutation sur la r√©cession: √©crivez le nombre 2 dans le registre de p√©riode, le temporisateur compte les 2 premi√®res impulsions (voir le signal TMR4 sur la figure 3) et arr√™te le comptage (voir le signal EN sur la figure 3), qui √† travers le bloc de cellules logiques permet l'√©mission des impulsions restantes √† l'entr√©e SPI. <br><br><img src="https://habrastorage.org/files/063/871/47f/06387147f53f4a24b875feee752b271b.png"><br>  <i>Fig.3.</i>  <i>Diagrammes expliquant la r√©ception du signal du capteur DHT22.</i> <br><br>  La fonction logique de g√©n√©ration de signal SCK est impl√©ment√©e sur une cellule logique (CLC), le circuit complet dans la configuration ET-OU est repr√©sent√© sur la figure 4. <br><br>  La sortie de la cellule logique est connect√©e √† l'entr√©e SCK et le signal du capteur DHT22 est connect√© √† la MOSI du module SPI.  Toutes les connexions sont effectu√©es √† l'int√©rieur du microcontr√¥leur (Fig. 5).  Pour la surveillance et le d√©bogage, des signaux peuvent √™tre √©mis vers les ports du microcontr√¥leur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f99/2ab/63f/f992ab63fbc048a1ae5b6dad31748263.png"></div><br>  <i>Fig.4.</i>  <i>Configuration des cellules logiques CLC dans le microcontr√¥leur PIC.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b27/d35/f60/b27d35f60fc04de9890ed357bb84309d.png"></div><br>  <i>Fig.</i>  <i>5. La structure compl√®te de la configuration de la p√©riph√©rie.</i> <br><br>  S'il semble que 2 minuteries pour la t√¢che de d√©codage du protocole du capteur soient une perte de ressources, alors un compteur jusqu'√† deux peut √™tre ¬´collect√©¬ª sur des cellules logiques CLC libres. <br><br>  Au total, la t√¢che de d√©codage se r√©sume √† un algorithme tr√®s simple: le microcontr√¥leur et ses p√©riph√©riques sont initialis√©s, si n√©cessaire, le module SPI est allum√© et une demande de mesure est g√©n√©r√©e (log. "0" pendant ~ 1ms). <br><br>  Il reste √† lire les donn√©es du tampon lorsqu'une interruption de SPI se produit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/434/536/fef/434536fef59a4b569a45aa334d9df535.png"></div><br>  <i>Fig.6.</i>  <i>L'algorithme pour travailler avec le capteur DHT22 lors de l'utilisation du moignon.</i> <br><br><img src="https://habrastorage.org/files/966/2d4/798/9662d4798e9f4d289957d2c6ff619898.png"><br>  <i>Fig.7.</i>  <i>Signaux des ports du microcontr√¥leur.</i>  <i>Signal SSP1IF - interruptions √† la r√©ception d'un octet par le module SPI.</i> <br><br>  La figure 7 montre les diagrammes de signaux, o√π: <br><blockquote>  DHT (dat) - signal sur la ligne de signal du capteur - alimente l'entr√©e du module MOSI SPI; <br>  TMR6! = RP6 - horloge d√©di√©e - envoi au SCK du module SPI; <br>  SSP1IF - signal d'interruption (disponibilit√© des donn√©es dans le tampon SPI) - en fait, ce signal indique la charge du c≈ìur du microcontr√¥leur - lecture des donn√©es de r√©sultat. </blockquote><br><h2>  D√©codage d'autres protocoles PWM </h2><br>  Des protocoles PWM "unifilaires" similaires sont utilis√©s dans les t√©l√©commandes IR pour les appareils √©lectrom√©nagers.  Souvent pendant la transmission IR, le codage par la position de l'impulsion est utilis√© lorsque la dur√©e est constante et la pause est variable.  Cette option est √©galement appel√©e ¬´Encodage √† pause variable¬ª.  En fait, c'est le m√™me encodage PWM, mais avec un signal invers√©.  En pr√©sence de cellules logiques, l'inversion n'est pas un probl√®me, de plus, les r√©cepteurs IR inversent le signal re√ßu.  Dans la fig.  La figure 8 montre les signaux re√ßus par le r√©cepteur de deux consoles diff√©rentes. <br><br><img src="https://habrastorage.org/files/6a8/6ca/62e/6a86ca62ec704b029650cfc4cb1d70a8.png"><br><img src="https://habrastorage.org/files/739/1a1/4bb/7391a14bb1764eef9a3d36d4f19c40c9.png"><br>  <i>Fig.8.</i>  <i>Options de codage pour les t√©l√©commandes IR.</i> <br><br>  Les deux t√©l√©commandes ont des protocoles diff√©rents, mais ces protocoles sont facilement d√©cod√©s de la mani√®re d√©crite ci-dessus, la seule chose est qu'il est n√©cessaire de d√©terminer le d√©but de l'envoi pour synchroniser l'inclusion de SPI, car le r√©cepteur IR peut intercepter les interf√©rences. <br><br><img src="https://habrastorage.org/files/205/4b6/99a/2054b699a4244346990f8748f65733df.png"><br><img src="https://habrastorage.org/files/c3b/4f0/49c/c3b4f049ce3b408b9ff8715cdf017579.png"><br>  <i>Fig.</i>  <i>9. Signaux d√©cod√©s √† l'aide de SPI.</i> <br><br>  Toutes les t√©l√©commandes IR n'ont pas d'encodage PWM.  Certains protocoles, par exemple RC5, ont un codage de phase (le code de Manchester, ¬´0¬ª est transmis comme 10 et ¬´1¬ª comme 01) [4].  Le d√©codage du code de Manchester en utilisant la p√©riph√©rie d'un noyau ind√©pendant que nous avons d√©j√† envisag√© pr√©c√©demment dans la premi√®re partie [1]. <br><br><h2>  R√©sum√© </h2><br>  Au lieu de presque 100% de la charge CPU du microcontr√¥leur pour la t√¢che de d√©codage du protocole PWM dans la version Arduino (oui, je sais, le probl√®me peut √™tre r√©solu plus efficacement en utilisant des modules de capture ou d'autres p√©riph√©riques), nous avons transf√©r√© la r√©ception du paquet d'informations au mat√©riel.  L'avant du signal d'entr√©e d√©marre le temporisateur, l'√©tat du temporisateur d√©termine la sortie du bloc de cellules logiques, la sortie de la cellule logique est envoy√©e au SPI. <br><br>  L'utilisation de p√©riph√©riques ind√©pendants du c≈ìur permet d'optimiser l'utilisation des ressources, de transf√©rer certaines t√¢ches vers le mat√©riel, de simplifier le code et de r√©duire la consommation. <br><br><h2>  Litt√©rature </h2><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cellules logiques configurables dans les contr√¥leurs PIC.</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">50 nuances de moignon.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ports d'entr√©e / sortie</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">50 nuances de moignon.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ADC et ADC avec ordinateur √† microcontr√¥leur Microchip</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sbprojects.com/knowledge/ir/rc5.php</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr401541/">https://habr.com/ru/post/fr401541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr401529/index.html">Demandez √† Ethan: l'univers peut-il √™tre consid√©r√© comme vivant?</a></li>
<li><a href="../fr401531/index.html">Dans le cadre du projet ¬´La science n'est pas de la farine¬ª, une discussion aura lieu sur le th√®me: ¬´Sexe, drogue, rock and roll: addiction ou vie?¬ª</a></li>
<li><a href="../fr401533/index.html">Difficult√©s √† choisir une carte vid√©o √©conomique sur l'exemple du RX 460</a></li>
<li><a href="../fr401535/index.html">Colonie. Chapitre 4: l'ancienne base militaire</a></li>
<li><a href="../fr401539/index.html">Test d'effort NVidia GPU sur le transcodage en direct</a></li>
<li><a href="../fr401543/index.html">Utilisation des ensembles de donn√©es du portail russe de donn√©es ouvertes data.gov.ru</a></li>
<li><a href="../fr401545/index.html">Chef, je vous vois. Intel Unite - Outil de communication professionnel</a></li>
<li><a href="../fr401549/index.html">√âtats exotiques de la mati√®re, √©crans LCD et avenir de l'eau</a></li>
<li><a href="../fr401551/index.html">Valve d√©veloppe trois jeux VR en m√™me temps et esp√®re un d√©veloppement technologique</a></li>
<li><a href="../fr401555/index.html">Les robots domestiques les plus utiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>